[{"categories":["vue"],"contents":" è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬æ–‡æ¶‰åŠçš„æºç åŒ…ï¼š compiler-sfc, runtime-domï¼Œè®²è¿°äº† style ä¸­ v-deep, v-slotted, ç­‰æŒ‡ä»¤çš„ä½¿ç”¨åŠåŸç†ã€‚\n ","permalink":"https://www.cheng92.com/vue/vue-teardown-13-v-deep-in-style/","tags":["vue3,","vue-next"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘¬ style v-deep, v-slotted"},{"categories":["web"],"contents":" Marquee å·²ç»åºŸå¼ƒçš„å…ƒç´ ã€‚\n èƒ½ç”¨ transition å’Œ anmiationï¼Œè¯·å°½é‡ä¸è¦ä½¿ç”¨è¿™ä¸ªã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  interface HTMLMarqueeElement : HTMLElement { attribute DOMString behavior; attribute DOMString bgColor; attribute DOMString direction; attribute DOMString height; attribute unsigned long hspace; attribute long loop; attribute unsigned long scrollAmount; attribute unsigned long scrollDelay; attribute DOMString trueSpeed; attribute unsigned long vspace; attribute DOMString width; attribute Function onbounce; attribute Function onfinish; attribute Function onstart; void start(); void stop(); };     marquee å¯ä»¥é€šè¿‡è‡ªèº«çš„ api å¼€å¯/å¼€å§‹( start() )å’Œå…³é—­/æš‚åœ( stop() )ï¼Ÿ\n å¦‚ä¸‹æµ‹è¯•ï¼š\n-- start \u0026 stop æ§åˆ¶æš‚åœå’Œå¼€å§‹ marquee test start \u0026 stop start() stop() var m1= document.getElementById('m1') window.m1start = () = { console.log('m1 start'); m1.start()} window.m1stop = () = { console.log('m1 start'); m1.stop() }  -- behavior: scroll, slide, alternate marquee behavior scroll(default) marquee behavior slide marquee behavior alternate  -- direction: left, right, up, down marquee direction left(default) marquee direction right marquee direction up marquee direction down  -- scroll interval(default: 85 ms) scroll interval(default: 85) scroll interval: 200   -- treespeed: å½±å“ scrolldelay å±æ€§ï¼Œé»˜è®¤ï¼šfalse -- 1. å½“ treespeed = false, scrolldelay -- 2. å½“ treespeed = true, scrolldelay å–è®¾ç½®çš„å€¼ï¼Œç­‰äºæ˜¯ false çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒæ•´ scrolldelay -- å¦‚ä¸‹ç°è±¡ï¼Œ å¥½åƒæ²¡å•¥ç”¨ï¼Œ m1 å’Œ m4 é€Ÿåº¦æ˜¯åŒæ­¥çš„ m1: scroll interval + treespeed(false): 30 m2: scroll interval + treespeed(false): 60 m3: scroll interval + treespeed(false): 120 m4: scroll interval + treespeed(true ): 30 m5: scroll interval + treespeed(true ): 60 m6: scroll interval + treespeed(true ): 120   -- scrollamount: marquee scroll distance, æ¯æ¬¡ç§»åŠ¨çš„è·ç¦»ï¼Œé»˜è®¤ï¼š6px/ms scrollamount(default: 6px) scrollamount: 12px   -- loop: marquee loop count, å¦‚æœ -- loop index: å®Œæˆä¸€æ¬¡ï¼Œè‡ªåŠ¨ +1 å½“ = loop count æ—¶å€™æ»šåŠ¨åœæ­¢ï¼Œå¹¶è§¦å‘ onfinish -- å¦‚æœ loop index = loop count æ—¶å€™æ»šåŠ¨åœæ­¢ï¼Œå¹¶è§¦å‘ onfinish -- å¦‚æœ behavior=alternateï¼Œloop index = loop count æ—¶è§¦å‘ onbounce äº‹ä»¶ -- å¦åˆ™è§¦å‘ onstart äº‹ä»¶(loop index -- start,bounce,finish åœ¨ chrome ä¸Šéƒ½è§¦å‘ä¸äº† -- stackover ä¸Šè¯´æ˜¯æœ€æ–°çš„ç‰ˆä¸å†ç»´æŠ¤è¿™ä¸ªæ ‡ç­¾çš„åŸå›  -- ä½†æ˜¯ Firefox ä¸Šæµ‹è¯•äº†ä¸‹ï¼Œä¸‰ä¸ªäº‹ä»¶éƒ½å¯ä»¥æ­£å¸¸è§¦å‘ ml1, loop: -1, behavior: alternate, onbounce æ²¡ç”¨ï¼Ÿ ml1, loop: -1 info-ml1: \nml2, loop: 0 info-ml2: \nml3, loop: 1 info-ml3: \nml4, loop: 2 info-ml4: \nloop index = 0\n  listenEvents(ml0, info1, 'ml0') listenEvents(ml1, info1, 'ml1') listenEvents(ml2, info2, 'ml2') listenEvents(ml3, info3, 'ml3') listenEvents(ml4, info4, 'ml4') function listenEvents(ml, info, text) { ml.addEventListener('start', function(e) { info.textContent = text + ' start' }) ml.addEventListener('finish', function(e) { info.textContent = text + ' finish' }) ml.addEventListener('bounce', function(e) { info.textContent = text +' bounce' }) }   ä¸‹è¡¨çš„å±æ€§ä¸DOMå±æ€§å¯¹åº”å…³ç³»ï¼š\n   marquee attribute DOM attribute     behavior behavior   direction direction   height height   width width   hspace hspace   vspace vspace   bgcolor bgColor   scrollamount scrollAmount   scrolldelay scrollDelay   truespeed trueSpeed    -- vspace: å‚ç›´è·ç¦»ï¼Œhspace: æ°´å¹³è·ç¦» vspace: 20px  hspace: 50px   ","permalink":"https://www.cheng92.com/web/html-marquee-tag/","tags":["web,","html"],"title":"HTML Marquee æ ‡ç­¾"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       vue3 ä¸­ expose çš„åŸç†åŠä½¿ç”¨ã€‚\n  æœ¬æ–‡æ¶‰åŠçš„æºç åŒ…ï¼š runtime-coreã€‚\nexpose in options   ç»„ä»¶ä¸­çš„æ‰€æœ‰é€‰é¡¹å¤„ç†(methods, data, â€¦)éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ expose:\n componentOptions.ts:applyOptions(instance: ComponentInternalInstance)\n options åˆå§‹åŒ–é¡ºåºï¼š\n  props\n  inject\n  methods\n  data, å»¶è¿Ÿå¤„ç†ï¼Œå› ä¸ºå®ƒä¾èµ– this\n  computed\n  watch, å»¶è¿Ÿå¤„ç†ï¼Œå› ä¸ºå®ƒä¾èµ– this\n   \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  export function applyOptions(instance: ComponentInternalInstance) { const options = resolveMergedOptions(instance) const publicThis = instance.proxy! as any const ctx = instance.ctx shouldCacheAccess = false const { // ...  // public API  expose, // ...  } = options // ...  if (isArray(expose)) { if (expose.length) { const exposed = instance.exposed || (instance.exposed = {}) expose.forEach(key =\u0026gt; { Object.defineProperty(exposed, key, { get: () =\u0026gt; publicThis[key], set: val =\u0026gt; (publicThis[key] = val) }) }) } else if (!instance.exposed) { instance.exposed = {} } } // ... }     expose å±æ€§çš„è®¿é—®è·¯å¾„:\n expose[] -\u0026gt; instance.exposed -\u0026gt; publicThis -\u0026gt; instance.proxy\n  instance.proxy   å¯¹ç»„ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ã€‚\n instance.proxy åˆ›å»ºè‡ªï¼š\n runtime-core/src/component.ts:setupStatefulComponent\n1 2 3  // 1. create public instance / render proxy  // also mark it raw so it\u0026#39;s never observed  instance.proxy = markRaw(new Proxy(instance.ctx, PublicInstanceProxyHandlers))     æ˜¯å¯¹ instance.ctx çš„ä»£ç†ï¼Œå½“ä½ åœ¨å®ä¾‹ä¸­é€šè¿‡ this.xxx æˆ– ctx.xxx å»è®¿é—®å±æ€§çš„æ—¶å€™å®é™…èµ°çš„æ˜¯ä¸‹ é¢è¿™ä¸ªä»£ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80  export const PublicInstanceProxyHandlers: ProxyHandler\u0026lt;any\u0026gt; = { // get proxy  get({ _: instance }: ComponentRenderContext, key: string) { const { ctx, setupState, data, props, accessCache, type, appContext } = instance let normalizedProps if (key[0] !== \u0026#39;$\u0026#39;) { // 1. é $xx çš„å±æ€§è®¿é—®é¡ºåº: setupState -\u0026gt; data -\u0026gt; ctx -\u0026gt; props  // setupState æ˜¯ setup() è¿”å›å¯¹è±¡æ—¶çš„å€¼ï¼Œæˆ– \u0026lt;script setup\u0026gt; æ ‡ç­¾ä¸­çš„çŠ¶æ€  // å¹¶ä¸”è¿™ä¸ªä¼šè®°å½•æ¯æ¬¡è®¿é—®æ—¶çš„ key å¯¹åº”åœ¨å“ªä¸ªå¯¹è±¡ä¸Šï¼Œè¿™æ ·ä¸‹æ¬¡å°±ä¸ç”¨å†è¿‡ä¸€ç¯‡è¿™  // é‡Œç¹ççš„é€»è¾‘äº†  // ...  } // 2. ä¸‹é¢æ˜¯é’ˆå¯¹ this.$xxx çš„è®¿é—®ï¼Œé¡ºåºæ˜¯ï¼š  // publicPropertiesMap -\u0026gt; cssModule -\u0026gt; ctx -\u0026gt; globalProperties  // æ‰¾åˆ°å¯¹åº” key çš„ get æ–¹æ³•, æ³¨æ„ç‚¹  // 1) this.$attrs çš„è®¿é—®ä¼šè§¦å‘ track  // 2) globalProperties å‚è¿‡ app.config.globalProperties æ³¨å†Œçš„å…¨å±€å±æ€§  const publicGetter = publicPropertiesMap[key] let cssModule, globalProperties // public $xxx properties  // ...  }, // set proxy  set( { _: instance }: ComponentRenderContext, key: string, value: any ): boolean { const { data, setupState, ctx } = instance // è®¾ç½®ä¼˜å…ˆçº§ï¼š setupState -\u0026gt; options data  if (setupState !== EMPTY_OBJ \u0026amp;\u0026amp; hasOwn(setupState, key)) { setupState[key] = value } else if (data !== EMPTY_OBJ \u0026amp;\u0026amp; hasOwn(data, key)) { data[key] = value } else if (hasOwn(instance.props, key)) { // ...ä¸å…è®¸ç›´æ¥ä¿®æ”¹ props  return false } if (key[0] === \u0026#39;$\u0026#39; \u0026amp;\u0026amp; key.slice(1) in instance) { // ...ä¸å…è®¸ç›´æ¥ä¿®æ”¹ $xxx ä¸Šçš„å±æ€§  return false } else { // å¼€å‘æ—¶ï¼Œå¯ä»¥ä¿®æ”¹ app.config.globalProperties ä¸Šå±æ€§çš„å€¼  if (__DEV__ \u0026amp;\u0026amp; key in instance.appContext.config.globalProperties) { Object.defineProperty(ctx, key, { enumerable: true, configurable: true, value }) } else { ctx[key] = value } } return true }, has( { _: { data, setupState, accessCache, ctx, appContext, propsOptions } }: ComponentRenderContext, key: string ) { let normalizedProps // æ£€æµ‹å±æ€§æœ‰æ— æ—¶çš„ä»£ç†ï¼š  // ç¼“å­˜(å–å€¼æ—¶ç¼“å­˜çš„) -\u0026gt; data -\u0026gt; setup state -\u0026gt; props -\u0026gt; ctx -\u0026gt; $xxx -\u0026gt; globalProperties  return ( accessCache![key] !== undefined || (data !== EMPTY_OBJ \u0026amp;\u0026amp; hasOwn(data, key)) || (setupState !== EMPTY_OBJ \u0026amp;\u0026amp; hasOwn(setupState, key)) || ((normalizedProps = propsOptions[0]) \u0026amp;\u0026amp; hasOwn(normalizedProps, key)) || hasOwn(ctx, key) || hasOwn(publicPropertiesMap, key) || hasOwn(appContext.config.globalProperties, key) ) } }    å±æ€§ä»£ç†\n  å–å€¼æ“ä½œå¯èƒ½ç»è¿‡çš„è·¯å¾„(ä¾ä¼˜å…ˆçº§ä»å·¦åˆ°å³)ï¼š\n é $xxx çš„å±æ€§ï¼š setup state \u0026gt; data \u0026gt; ctx \u0026gt; props\n $xxx çš„å±æ€§ï¼š publicPropertiesMap -\u0026gt; cssModule -\u0026gt; ctx -\u0026gt; globalProperties\n å®é™…ä¸Š $xxx çš„å±æ€§åªæ˜¯ ctx.xxx çš„åˆ«åã€‚\n  è®¾å€¼ï¼Œåªèƒ½è®¾ç½® setup state \u0026gt; options data\n æœ‰ä¸€ç§æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼šå½“è¦è®¾ç½®çš„ key åœ¨ setup state, options data, props, $xxx, globalProperties ä¸Šéƒ½æ²¡æœ‰çš„æ—¶å€™ï¼Œæœ€åä¼šç›´æ¥è¢«æ·»åŠ çš„ ctx ä¸Šå»ï¼š\n ctx[key] = value\n  has å±æ€§æ£€æŸ¥çš„é¡ºåºï¼š cache ä¸­ \u0026gt; data \u0026gt; setup state \u0026gt; props \u0026gt; ctx \u0026gt; publicPropertiesMap \u0026gt; globalProperties\n    publicPropertiesMap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  export const publicPropertiesMap: PublicPropertiesMap = extend( Object.create(null), { $: i =\u0026gt; i, $el: i =\u0026gt; i.vnode.el, $data: i =\u0026gt; i.data, $props: i =\u0026gt; (__DEV__ ? shallowReadonly(i.props) : i.props), $attrs: i =\u0026gt; (__DEV__ ? shallowReadonly(i.attrs) : i.attrs), $slots: i =\u0026gt; (__DEV__ ? shallowReadonly(i.slots) : i.slots), $refs: i =\u0026gt; (__DEV__ ? shallowReadonly(i.refs) : i.refs), $parent: i =\u0026gt; getPublicInstance(i.parent), $root: i =\u0026gt; getPublicInstance(i.root), $emit: i =\u0026gt; i.emit, $options: i =\u0026gt; (__FEATURE_OPTIONS_API__ ? resolveMergedOptions(i) : i.type), $forceUpdate: i =\u0026gt; () =\u0026gt; queueJob(i.update), $nextTick: i =\u0026gt; nextTick.bind(i.proxy!), $watch: i =\u0026gt; (__FEATURE_OPTIONS_API__ ? instanceWatch.bind(i) : NOOP) } as PublicPropertiesMap )     ä»ä¸Šé¢çš„ ä»£ç æµç¨‹ æ¥çœ‹ï¼Œå¥½åƒå’Œ props, data æ²¡ä»€ä¹ˆåŒºåˆ«å§â“\n æœ€ç»ˆä¸éƒ½æ˜¯èµ°äº† proxy get é‚£ä¸€å¥—â“\n ä»è¿™é‡Œå¥½åƒçœ‹ä¸å‡ºä»€ä¹ˆâ€¦\n  ref \u0026amp; setRef   æ¥çœ‹ä¸‹é¢å®˜æ–¹(runtime-core/__tests__/apiExpose.spec.ts)çš„ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  const url = process.env.VNEXT_PKG_RC +\u0026#39;/../runtime-test/dist/runtime-test.cjs.js\u0026#39; const value = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { nodeOps, render, h, serializeInner: s, ref, defineComponent, toRaw } = value const Child = defineComponent({ render() {}, expose: [\u0026#39;fox\u0026#39;, \u0026#39;foo\u0026#39;], setup(_, { expose }) { expose({ foo: 1, bar: ref(2) }) return { bar: ref(3), baz: ref(4) } } }) const childRef = ref() const Parent = { setup() { return () =\u0026gt; h(Child, { ref: childRef }) } } const root = nodeOps.createElement(\u0026#39;div\u0026#39;) render(h(Parent), root) console.log(\u0026#39;childRef.value = \u0026#39;, childRef.value); console.log(\u0026#39;childRef.value.foo = \u0026#39;, childRef.value.foo); console.log(\u0026#39;childRef.value.bar = \u0026#39;, childRef.value.bar); console.log(\u0026#39;childRef.value.baz = \u0026#39;, childRef.value.baz); console.log(\u0026#39;childRef.value.fox = \u0026#39;, childRef.value.fox);    key = __v_raw key = __v_isReadonly key = __v_raw key = __v_skip childRef.value = { foo: [Getter/Setter], bar: RefImpl { _rawValue: 2, _shallow: false, __v_isRef: true, _value: 2 } } key = foo childRef.value.foo = undefined key = bar childRef.value.bar = 2 key = baz childRef.value.baz = undefined key = fox childRef.value.fox = undefined undefined  \n ä»æµ‹è¯•ç”¨ä¾‹æ¥çœ‹ï¼Œè¿™ä¸ª expose ç”¨é€”æ˜¯å°†ç»„ä»¶æœ¬èº«çš„å±æ€§æš´éœ²å‡ºå»ï¼Œå¯ä»¥åœ¨çˆ¶ç»„ä»¶ä¸­é€šè¿‡ ref å–åˆ°è¯¥ç»„ä»¶å…ƒç´ çš„å¼•ç”¨ childRef (ä¸¥æ ¼æ¥è¯´å½“æœ‰ expose æ—¶å°±ä¸å†æ˜¯æŒ‡å‘ vnode.eläº†)ï¼Œ ç„¶åå°±å¯ä»¥é€šè¿‡è¿™ä¸ªå¼•ç”¨æ¥ç›´æ¥è®¿é—® expose å‡ºæ¥çš„å±æ€§ã€‚\n é‚£è¿™ä¸ªæ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ\n æ—¢ç„¶å’Œ ref å…ƒç´ æœ¬èº«æœ‰å…³ç³»ï¼Œé‚£å°±å¾—ä»è¿™ä¸ª ref å»ä¸‹æ‰‹çœ‹çœ‹äº†ã€‚\n ref å€¼è®¾ç½®çš„åœ°æ–¹(setRef(...))ï¼šåœ¨ç»„ä»¶æ¸²æŸ“å®Œæˆä¹‹åæ‰ä¼šæœ‰å®é™…çš„DOMå…ƒç´ ï¼Œæ‰€ä»¥è¿™ä¸ªè‚¯å®šæ˜¯å‘ç”Ÿåœ¨ mounted ä¹‹åã€‚\n è°ƒç”¨ setRef() çš„åœ°æ–¹æœ‰ï¼š\n  patch(n1, n2, â€¦) å‡½æ•°çš„æœ€å\n1 2 3 4  // set ref  if (ref != null \u0026amp;\u0026amp; parentComponent) { setRef(ref, n1 \u0026amp;\u0026amp; n1.ref, parentSuspense, n2 || n1, !n2) }      unmount(vnode, â€¦) çš„æ—¶å€™å–æ¶ˆå¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼\n1 2 3  if (ref != null) { setRef(ref, null, parentSuspense, vnode, true) }      TIP\n å¦å¤–ï¼Œç»„ä»¶å®é™…çš„ DOM å…ƒç´ çš„å¼•ç”¨æ˜¯åœ¨ vnode.el ä¸Šï¼Œè¿™ä¸ªå€¼æ˜¯åœ¨ mountElement(vnode) ä¸­åˆ›å»ºçœŸå® DOM å…ƒç´ çš„æ—¶å€™è¢«èµ‹å€¼çš„ï¼Œè€Œ setRef() æ˜¯åœ¨ patch() æœ€åæ‰§è¡Œï¼Œæ‰€ä»¥åœ¨è¿™ä¸ª æ—¶å€™ vnode.el ä¸Šå°±å·²ç»æœ‰äº†è¯¥ç»„ä»¶çœŸå® DOM å…ƒç´ çš„å¼•ç”¨ï¼Œå› ä¸ºæ‰€æœ‰çš„ç»„ä»¶æµç¨‹ä¸€å¼€å§‹éƒ½ æ˜¯ç»è¿‡çš„ patch() å‡½æ•°(ç»„ä»¶æ¸²æŸ“å®Œæ•´æµç¨‹å›¾)ã€‚\n Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(3) - render component\n  ä¸Šé¢åªæ˜¯çŸ¥é“äº†è®¾ç½®ï¼Œä½†å®é™…è¿™é‡Œæ˜¯éœ€è¦çŸ¥é“æ˜¯å¯¹ childRef.value.foo çš„å–å€¼ä¼šå‘ç”Ÿäº›ä»€ ä¹ˆï¼Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Œæœ€ç»ˆåˆæ˜¯æ€ä¹ˆå’Œ expose å‘ç”Ÿå…³è”çš„ï¼Ÿ\n ä¸‹é¢æ¥ä»”ç»†çœ‹ä¸‹ setRef é‡Œé¢åˆå‘ç”Ÿäº†ä»€ä¹ˆï¼Œè®¾æƒ³åº”è¯¥æ˜¯å¯¹ ref çš„å¼•ç”¨æ˜¯ä¸æ˜¯åšäº†ä»£ç†â“\n runtime-core/src/renderer.ts:setRef\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  export const setRef = ( rawRef: VNodeNormalizedRef, oldRawRef: VNodeNormalizedRef | null, parentSuspense: SuspenseBoundary | null, vnode: VNode, isUnmount = false ) =\u0026gt; { // ... rawRef æ˜¯æ•°ç»„å¤„ç†  // å¼‚æ­¥ç»„ä»¶åˆ¤æ–­ï¼Œå¦‚æœæ˜¯å¼‚æ­¥çš„éœ€è¦ç­‰å¼‚æ­¥ç»„ä»¶å®Œæˆæ¸²æŸ“æ‰å¯ä»¥  // isAsyncWrapper:  // export const isAsyncWrapper = (i: ComponentInternalInstance | VNode): boolean =\u0026gt;  // !!(i.type as ComponentOptions).__asyncLoader  // æœ‰çŠ¶æ€çš„ç»„ä»¶ï¼šå¯¹è±¡ç»„ä»¶, vnode.ts:createVNode é‡Œé¢çš„æ£€æµ‹  // isObject(type) ? ShapeFlags.STATEFUL_COMPONENT : ...  // é‡ç‚¹å°±åœ¨è¿™ï¼šå…ˆå– expose proxy ç„¶åå– component.proxy  const refValue = vnode.shapeFlag \u0026amp; ShapeFlags.STATEFUL_COMPONENT ? getExposeProxy(vnode.component!) || vnode.component!.proxy : vnode.el const value = isUnmount ? null : refValue // ...  // \u0026lt;div ref=\u0026#34;formRef\u0026#34; /\u0026gt; -\u0026gt; this.$refs.formRef  if (isString(ref)) { // refs[ref] = value ...  } else if (isRef(ref)) { // è¿™ä¸ªæ­£æ˜¯è¿™é‡Œä½¿ç”¨çš„æ¡ˆä¾‹æ‰€æ‰§è¡Œçš„åˆ†æ”¯  } // ... }     åœ¨ setRef ä¸­æ£€æµ‹åˆ°å¦‚æœæ˜¯æœ‰çŠ¶æ€çš„ç»„ä»¶ï¼Œä¼šå…ˆæ‰§è¡Œ getExposeProxy(instance) å» instance.exposed ä¸­å–å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™å†å»ç»„ä»¶å®ä¾‹çš„ä»£ ç†(ä¹Ÿå°±æ˜¯æœ€å¼€å§‹åˆ†æçš„instance.proxy)ä¸­å»å– expose proxy:\n \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  export function getExposeProxy(instance: ComponentInternalInstance) { if (instance.exposed) { return ( instance.exposeProxy || (instance.exposeProxy = new Proxy(proxyRefs(markRaw(instance.exposed)), { get(target, key: string) { console.log(\u0026#39;key = \u0026#39; + key); if (key in target) { return target[key] } else if (key in publicPropertiesMap) { return publicPropertiesMap[key](instance) } } })) ) } }     ä¸Šé¢ä»£ç åŠ äº†æ‰“å°å¯ä»¥ä» ğŸ”—ä¸Šé¢çš„ä¾‹å­ ä¸­çœ‹åˆ° key çš„å€¼ã€‚\n ä»¥ä¸Šå°±æ˜¯ expose + ref çš„ä½¿ç”¨åŠåŸç†ï¼Œä¸‹é¢è¿˜ä¼šå¯¹ä¸€äº›å…¶å®ƒç»†èŠ‚è¿›è¡Œå›é¡¾ã€‚\n  $root and $parent   åœ¨ Child ä¸­å¯ä»¥é€šè¿‡ this.$root å’Œ this.$parent å»å–åˆ° parent ä¸­ expose å‡º æ¥çš„å±æ€§ï¼Œè¿™ä¸ªåˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢â“â“â“\n å…ˆçœ‹ä¸‹æµ‹è¯•ç”¨ä¾‹(runtime-core/__tests__/apiExpose.spec.ts)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  const url = process.env.VNEXT_PKG_RC +\u0026#39;/../runtime-test/dist/runtime-test.cjs.js\u0026#39; const value = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { nodeOps, render, h, serializeInner: s, defineComponent } = value let Root const Child = defineComponent( { render() { console.log(\u0026#34;this.$parent.foo = \u0026#34; + this.$parent.foo); console.log(\u0026#34;this.$parent.bar = \u0026#34; + this.$parent.bar); console.log(\u0026#34;this.$root.foo = \u0026#34; + this.$root.foo); console.log(\u0026#34;this.$root.bar = \u0026#34; + this.$root.bar); console.log(\u0026#34;$root: \u0026#34;, this.$root); console.log(\u0026#34;Root:\u0026#34;, Root); } } ) const Parent = defineComponent({ expose: [], setup(_, { expose }) { expose({ foo: 1 }) return { bar: 2 } }, render() { return h(Child) } }) // #1 console.log(\u0026#39;\u0026gt; root = parent\u0026#39;); const root1 = nodeOps.createElement(\u0026#39;div\u0026#39;) render(h(Parent), root1) Root = defineComponent({ render () { return h(Parent) } }) // #2 console.log(\u0026#39;\u0026gt; root = parent.$parent\u0026#39;); const root2 = nodeOps.createElement(\u0026#39;div\u0026#39;) render(h(Root), root2) return 0    \u0026gt; root = parent this.$parent.foo = 1 this.$parent.bar = undefined this.$root.foo = 1 this.$root.bar = undefined $root: { foo: 1 } Root: undefined \u0026gt; root = parent.$parent this.$parent.foo = 1 this.$parent.bar = undefined this.$root.foo = undefined this.$root.bar = undefined $root: {} Root: { render: [Function: render] } 0   ç»“æœæ˜¾ç¤ºï¼Œ åœ¨ Child ä¸­éƒ½å¯ä»¥æ­£ç¡®å–åˆ° foo ï¼Œè€Œå–ä¸åˆ° barã€‚\n é‚£ä¹ˆä¸ºä»€ä¹ˆå‘¢â“\n å¯ä»¥ä» publicPropertiesMap ä¸­æ‰¾åˆ° $parent å’Œ $root çš„å¼•ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11  export const publicPropertiesMap: PublicPropertiesMap = extend( Object.create(null), { // ...  $el: i =\u0026gt; i.vnode.el, // ...  $parent: i =\u0026gt; getPublicInstance(i.parent), $root: i =\u0026gt; getPublicInstance(i.root), // ...  } as PublicPropertiesMap )     ä¸¤è€…éƒ½æ˜¯æ˜ å°„åˆ°äº† getPublicInstance é‚£ä»€ä¹ˆæ˜¯ public instanceâ“\n ä»£ç ä½äºï¼š runtime-core/src/componentPublicInstance.ts:getPublicInstance\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  /** ,* #2437 In Vue 3, functional components do not have a public instance proxy but ,* they exist in the internal parent chain. For code that relies on traversing ,* public $parent chains, skip functional ones and go to the parent instead. ,*/ const getPublicInstance = ( i: ComponentInternalInstance | null ): ComponentPublicInstance | ComponentInternalInstance[\u0026#39;exposed\u0026#39;] | null =\u0026gt; { if (!i) return null // å¯¹è±¡ç»„ä»¶ï¼Œè·³è¿‡å‡½æ•°ç»„ä»¶ï¼Œå¦‚ä¸Šé¢çš„æ³¨é‡Šï¼Œå‡½æ•°ç»„ä»¶å¹¶æ²¡æœ‰å…¬å…±çš„å®ä¾‹ï¼Œä½†æ˜¯å®ƒä»¬  // ä¾æ—§åœ¨ parent é“¾ä¸Š  if (isStatefulComponent(i)) return i.exposed ? i.exposed : i.proxy // é€’å½’å–çˆ¶çº§ç»„ä»¶å®ä¾‹ï¼Œè¿™ä¸ªä¸€ç›´ä¼šæ‰¾åˆ° root  return getPublicInstance(i.parent) }     this.$parent.foo å€’æ˜¯å¥½ç†è§£ï¼Œ $parent è¢«æ˜ å°„åˆ° getPublicInstance(i.parent) æ‰¾è‡ª å·±çš„çˆ¶çº§ç»„ä»¶ï¼Œå¦‚æœæœ‰ exposed çº§è¿”å›è¿™ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°±ç­‰äºæ˜¯ instance.exposed.foo\n ç„¶è€Œå¯¹äº this.$root.foo ä¸ºä»€ä¹ˆä¹Ÿèƒ½å–åˆ° expose é‡Œé¢çš„ 1 â“\nå› ä¸ºåœ¨ root1 çš„æ—¶å€™ Parent å°±æ˜¯ root ç»„ä»¶ï¼Œæ‰€ä»¥ instance.root == parent\n  æ¯ä¸ªç»„ä»¶éƒ½ä¼šæŒæœ‰ä¸€ä»½å¯¹ root ç»„ä»¶çš„å¼•ç”¨ï¼Œinstance.rootï¼Œè¿™ä¸ªå¼•ç”¨çš„è®¾ç½®å‘ç”Ÿåœ¨åˆ›å»º ç»„ä»¶å®ä¾‹çš„æ—¶å€™:\n1 2  // createComponentInstance(vnode, parent, suspense) -\u0026gt; instance.root = parent ? parent.root : instance     æ‰€ä»¥ #1 å’Œ #2 çš„ç»“æœä¸ä¸€æ ·(1 å’Œ undefined)ã€‚\n  expose()   é™¤äº†èƒ½ä½¿ç”¨ options api expose ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡åœ¨ setup() ä¸­è°ƒç”¨ expose({...}) æ¥ æš´éœ²éƒ¨åˆ†å±æ€§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  const url = process.env.VNEXT_PKG_RC +\u0026#39;/../runtime-test/dist/runtime-test.cjs.js\u0026#39; const value = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { nodeOps, render, h, serializeInner: s, defineComponent, ref } = value const Child = { render() { return h(\u0026#39;div\u0026#39;) }, setup(_, { expose }) { expose() return {} } } const childRef = ref() const Parent = { setup() { return () =\u0026gt; h(Child, { ref: childRef }) } } const root = nodeOps.createElement(\u0026#39;div\u0026#39;) render(h(Parent), root) console.log(\u0026#39;childRef.value.$el.tag = \u0026#39; + childRef.value.$el.tag); return 0    key = __v_raw key = __v_isReadonly key = __v_raw key = __v_skip key = $el childRef.value.$el.tag = div 0   expose() å‡½æ•°åˆåšäº†ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™ä¸ªä¸ä¼ å‚æ•°å‘¢ï¼Ÿ\nWARNING\n expose() åªèƒ½åœ¨ setup() ä¸­æ‰§è¡Œï¼Œä¸”åªèƒ½æ‰§è¡Œä¸€æ¬¡(éå¼ºåˆ¶ï¼Œå¤šæ¬¡ä¹Ÿæ— æ„ä¹‰ï¼Œä¼šè¦†ç›–)ã€‚\n  æœ‰å…³ setup ctx å‚æ•°çš„è¯´æ˜è§: setup(_, ctx) çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Ÿ\n expose å‡½æ•°å…¶å®å¾ˆç®€å•ï¼Œèµ‹å€¼åŠåˆå§‹åŒ–ï¼Œä¸èƒ½é‡å¤è°ƒç”¨ä¹Ÿåªæ˜¯ç»™å‡ºäº†è­¦å‘Šï¼š\n1 2 3 4 5 6  const expose: SetupContext[\u0026#39;expose\u0026#39;] = exposed =\u0026gt; { if (__DEV__ \u0026amp;\u0026amp; instance.exposed) { warn(`expose() should be called only once per setup().`) } instance.exposed = exposed || {} }     getExposeProxy(instance)\n è®¾ç½®äº† instance.exposed çš„ä»£ç†ï¼Œå¹¶ä¸”å¦‚æœè¦è®¿é—®çš„å±æ€§è¿™ä¸ªå¯¹è±¡æœ¬èº«æ²¡æœ‰çš„æ—¶å€™ä¼šå» publicPropertiesMap ä¸­å»æ‰¾ï¼Œæ‰€ä»¥è¿™ä¸ªå»è®¿é—® childRef.value.$el çš„æ—¶å€™åœ¨ instance.exposed ä¸Šé¢æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œæœ€åæ‰¾åˆ°çš„æ˜¯ $el: i =\u0026gt; i.vnode.el ã€‚\n  æ€»ç»“    æ”¯æŒ options api expose: [...]\n  æ”¯æŒ setup context expose({...})\n  åŒæ—¶æ”¯æŒ option api å’Œ setup context\n  empty expose ç­‰äºæ²¡æœ‰\n  this.$parent åœ¨å­ç»„ä»¶ä¸­ä½¿ç”¨å¯ä»¥å–åˆ°çˆ¶ç»„ä»¶ expose çš„å±æ€§\n  this.$root å–åˆ°æ ¹èŠ‚ç‚¹ä¸Š expose çš„å±æ€§\n  setup() ä¸­è°ƒç”¨ expose() ä¸ä¼ å‚ï¼Œæœ€åå±æ€§è®¿é—®ä¼šè¢«ä»£ç†åˆ° publicPropertiesMap ä¸Š\n    ","permalink":"https://www.cheng92.com/vue/vue-teardown-11-expose/","tags":["vue3,","vue-next,"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘ª expose options\u0026api"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬æ–‡ä¸»è¦æ˜¯åˆ†æ applyOptions å‡½æ•°ã€‚\n  æœ¬æ–‡æ¶‰åŠçš„æºç åŒ…ï¼š runtime-core/src/componentOptions.ts:applyOptions(instance: ComponentInternalInstance)ã€‚\nTODO   ","permalink":"https://www.cheng92.com/vue/vue-teardown-12-options/","tags":["vue3,","vue-next,"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘« ç»„ä»¶é€‰é¡¹å¤„ç† options(å¦‚ï¼šmethods, data, ...)"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");     æœ¬ç³»åˆ—ä¸º vue-next æºç åˆ†æç³»åˆ—çš„æ—ç³»åˆ†æ”¯ï¼Œä¸»è¦ç›®çš„åœ¨äºå¯¹ vue3 æºç ä¸­çš„ä¸€äº›ç»†èŠ‚è¿› è¡Œåˆ†æã€‚æœ¬æ–‡è®²è¿°çš„æ˜¯ Transition ç»„ä»¶ä½¿ç”¨ï¼ŒåŸç†ï¼Œæºç åˆ†æã€‚\n TODO   ","permalink":"https://www.cheng92.com/vue/vue-teardown-9-transition/","tags":["vue3,","vue-next,","Transition"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘¨ Transition ç»„ä»¶æœºåˆ¶"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬ç³»åˆ—ä¸º vue-next æºç åˆ†æç³»åˆ—çš„æ—ç³»åˆ†æ”¯ï¼Œä¸»è¦ç›®çš„åœ¨äºå¯¹ vue3 æºç ä¸­çš„ä¸€äº›ç»†èŠ‚è¿› è¡Œåˆ†æã€‚æœ¬æ–‡è®²è¿°çš„æ˜¯ SFC ä¸­ style çš„è§£æï¼Œæ¯”å¦‚ï¼š v-deep çš„ä½¿ç”¨åŠåŸç†ã€‚\n TODO   ","permalink":"https://www.cheng92.com/vue/vue-teardown-10-sfc-style/","tags":["vue3,","vue-next,","Transition"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘© SFC style"},{"categories":["awesome"],"contents":" APIs   åŸºäº org-verb-mode.\nTODO online-convert åœ¨çº¿è½¬æ¢æ¥å£   https://www.api2convert.com/ è¿™é‡Œè·å– API Key.\n  TODO èšåˆæ•°æ®\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   gnu.org\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://www.gnu.org\nPDF   get /licenses/quick-guide-gplv3.pdf\n  Images   template /graphics\nPNG image   get /gnu-head.png\n      openlibrary.org\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://openlibrary.org User-Agent: Verb/Emacs Emacs/{{emacs-version}} Accept: application/json\nSeach  template /search.json\n  Sbujects  get /subjects/{{(read-string \u0026#34;Subject: \u0026#34;)}}.json\n  books  :properties: :Verb-Store: book ğŸ”š\nget /api/books?bibkeys=ISBN:{{(verb-var isbn)}}\u0026amp;format=json\n CLOSED: [2020-08-27 Thu 00:07]\n  State \u0026#34;DONE\u0026#34; from [2020-08-27 Thu 00:07]\n  template https://reqres.in\nAccept: application/json\nAuthentication: {{(verb-var token)}}\n    User\u0026#xa0;\u0026#xa0;\u0026#xa0;verb  User management  get Content-Language: de-DE\n  Get users list  get /api/users Content-Language: de-DE\n  create a user   post /api/users Content-Type: application/json; charset=utf-8\n1 2 3 4  { \u0026#34;name\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;age\u0026#34;: 42 }     post /api/users\n1 2 3 4 5  { \u0026#34;name\u0026#34;: \u0026#34;{{(user-full-name)}}\u0026#34;, \u0026#34;age\u0026#34;: \u0026#34;{{(read-string \u0026#34;Age: \u0026#34;)}}\u0026#34; }    Cloud Servers    ä¸‰ä¸°äº‘, ä¸‰åå¤©çš„å…è´¹ï¼Œåˆ°æœŸç›´æ¥ç»­è´¹ä½¿ç”¨ï¼Œè®°å¾—è®¾ç½®é—¹é’Ÿå“¦~~\n æœåŠ¡å™¨åªèƒ½ç”¨ä¸€å¤©ï¼Œå®Œäº†ä¹‹åéœ€è¦æ¯äº”å¤©ç»­è´¹ä¸€æ¬¡ã€‚ã€‚ã€‚\n          Development   Awesome Web Development(WEBå¼€å‘èµ„æº)\n  ","permalink":"https://www.cheng92.com/post/awesome/","tags":["awesome"],"title":"My Awesome Everything"},{"categories":["golang"],"contents":" é—®é¢˜  go get i/o timeout ?  1 2 3 4 5  go env -w GO111MODULE=on go env -w GOPROXY=https://goproxy.io,direct # è®¾ç½®ä¸èµ° proxy çš„ç§æœ‰ä»“åº“ï¼Œå¤šä¸ªç”¨é€—å·ç›¸éš”ï¼ˆå¯é€‰ï¼‰ go env -w GOPRIVATE=*.gitlab.com        ","permalink":"https://www.cheng92.com/post/golang/","tags":["golang"],"title":"Golang Go Go Go..."},{"categories":["web"],"contents":" TODO\n","permalink":"https://www.cheng92.com/web/web-component/","tags":["web,","component"],"title":"Web Component å­¦ä¹ è®°å½•"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬æ–‡å°†ä»æºç ï¼Œç¼–è¯‘å‰åè®©ä½ æ˜ç™½ \u0026lt;script setup\u0026gt; æ ‡ç­¾å†…å¦‚ä½•æ­£ç¡®çš„ä¹¦å†™ä»£ç ï¼ŒåŠæ¯ä¸ªè¯­ æ³•èƒŒåçš„åŸç†åˆæ˜¯ä»€ä¹ˆï¼Ÿ\n  æœ¬æ–‡æ¶‰åŠçš„æºç åŒ…ï¼š compiler-sfc, compiler-coreã€‚\n SFC \u0026lt;script setup\u0026gt; çš„ç¼–è¯‘ç›¸å…³ä»£ç åœ¨ packages/compiler-sfc/src/compileScript.ts\n ä½¿ç”¨åˆ°çš„ç¬¬ä¸‰æ–¹æ’ä»¶ ï¼š @babel/parser-\u0026gt;parse, magic-string, estree-walker\nscript setup   æ’ä»¶ä½¿ç”¨æµ‹è¯•  @babel/parser:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const { parse } = require(\u0026#39;/usr/local/lib/node_modules/@babel/parser/lib/index\u0026#39;) const ast = parse(` const foo = 100, bar = 200; function baz() { console.log(foo + bar) } `) const program = ast.program console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; foo å˜é‡å£°æ˜ AST\\n\u0026#39;, program.body[0].declarations[0]); // console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; bar å˜é‡å£°æ˜ AST\\n\u0026#39;, program.body[0].declarations[1]); console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; baz å‡½æ•°å£°æ˜ AST\\n\u0026#39;, program.body[1]); // console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; ä»£ç ä½“ AST\\n\u0026#39;, program.body); // console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; ä»£ç  AST\\n\u0026#39;, program); // console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; å®Œæ•´çš„ AST ç»“æ„\\n\u0026#39;, ast); return 0    \u0026gt;\u0026gt;\u0026gt; foo å˜é‡å£°æ˜ AST Node { type: \u0026#39;VariableDeclarator\u0026#39;, start: 7, end: 16, loc: SourceLocation { start: Position { line: 2, column: 6 }, end: Position { line: 2, column: 15 }, filename: undefined, identifierName: undefined }, range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: undefined, id: Node { type: \u0026#39;Identifier\u0026#39;, start: 7, end: 10, loc: SourceLocation { start: [Position], end: [Position], filename: undefined, identifierName: \u0026#39;foo\u0026#39; }, range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: undefined, name: \u0026#39;foo\u0026#39; }, init: Node { type: \u0026#39;NumericLiteral\u0026#39;, start: 13, end: 16, loc: SourceLocation { start: [Position], end: [Position], filename: undefined, identifierName: undefined }, range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: { rawValue: 100, raw: \u0026#39;100\u0026#39; }, value: 100 } } \u0026gt;\u0026gt;\u0026gt; baz å‡½æ•°å£°æ˜ AST Node { type: \u0026#39;FunctionDeclaration\u0026#39;, start: 29, end: 72, loc: SourceLocation { start: Position { line: 3, column: 0 }, end: Position { line: 5, column: 1 }, filename: undefined, identifierName: undefined }, range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: undefined, id: Node { type: \u0026#39;Identifier\u0026#39;, start: 38, end: 41, loc: SourceLocation { start: [Position], end: [Position], filename: undefined, identifierName: \u0026#39;baz\u0026#39; }, range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: undefined, name: \u0026#39;baz\u0026#39; }, generator: false, async: false, params: [], body: Node { type: \u0026#39;BlockStatement\u0026#39;, start: 44, end: 72, loc: SourceLocation { start: [Position], end: [Position], filename: undefined, identifierName: undefined }, range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: undefined, body: [ [Node] ], directives: [] } } 0    magic-string   å¯¹å­—ç¬¦ä¸²è¿›è¡Œå¢åˆ æ”¹æŸ¥çš„å„ç§æ“ä½œï¼Œ vue3 ä¸­ä½¿ç”¨è¯¥æ’ä»¶æ¥æ›¿æ¢ç¼–è¯‘ä¹‹åçš„ ast codeã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const MagicString = require(\u0026#39;/usr/local/lib/node_modules/magic-string/dist/magic-string.cjs.js\u0026#39;) const log = console.log const s = new MagicString(\u0026#39;problems = 99\u0026#39;) log(\u0026#39;æ›¿æ¢å˜é‡å -\u0026gt; \u0026#39;, s.overwrite(0, 8, \u0026#39;answer\u0026#39;).toString()) log(\u0026#39;æ›¿æ¢å˜é‡å€¼ -\u0026gt; \u0026#39;, s.overwrite(11, 13, \u0026#39;42\u0026#39;).toString()) log(\u0026#39;å‰ååŠ å†…å®¹ -\u0026gt; \u0026#39;, s.prepend(\u0026#39;var \u0026#39;).append(\u0026#39;;\u0026#39;).toString()) const map = s.generateMap({ source: \u0026#39;source.js\u0026#39;, file: \u0026#39;converted.js.map\u0026#39;, includeContent: true }) // generates a v3 sourcemap  log(\u0026#39;ç”Ÿäº§ source map -\u0026gt; \u0026#39;, map.toString())    æ›¿æ¢å˜é‡å -\u0026gt; answer = 99 æ›¿æ¢å˜é‡å€¼ -\u0026gt; answer = 42 å‰ååŠ å†…å®¹ -\u0026gt; var answer = 42; ç”Ÿäº§ source map -\u0026gt; {\u0026#34;version\u0026#34;:3,\u0026#34;file\u0026#34;:\u0026#34;converted.js.map\u0026#34;,\u0026#34;sources\u0026#34;:[\u0026#34;source.js\u0026#34;],\u0026#34;sourcesContent\u0026#34;:[\u0026#34;problems = 99\u0026#34;],\u0026#34;names\u0026#34;:[],\u0026#34;mappings\u0026#34;:\u0026#34;IAAA,MAAQ,GAAG\u0026#34;} undefined    estree-walker   ä¸€ä¸ªéå† ast çš„æ’ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  const walk = require(\u0026#39;/usr/local/lib/node_modules/estree-walker/src/index.js\u0026#39;).walk const acorn = require(\u0026#39;/usr/local/lib/node_modules/acorn/dist/acorn.js\u0026#39;) const ast = acorn.parse(`const foo = 100`) walk(ast, { enter(node, parent, prop, index) { console.log(\u0026#39;enter\u0026gt;\u0026gt;\u0026gt;\u0026#39;, node, parent, prop, index); }, leave(node, parent, prop, index) { console.log(\u0026#39;leave\u0026gt;\u0026gt;\u0026gt;\u0026#39;, node, parent, prop, index); } })    #+RESULTS:\n    ","permalink":"https://www.cheng92.com/vue/vue-teardown-8-script-setup/","tags":["vue3,","vue-next,","script.setup"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘§ script setup æ¥é¾™å»è„‰"},{"categories":["vue"],"contents":" è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  æœ¬æ–‡çº¯ç²¹çš„é“¾æ¥ï¼Œåˆ—å‡ºæºç å­¦ä¹ è¿‡ç¨‹ä¸­é‡è¦çŸ¥è¯†ç‚¹å’ŒåŠŸèƒ½ç‰¹æ€§æœ‰å…³çš„åˆ†æé“¾æ¥ï¼Œè¿™äº›é“¾æ¥ä¸» è¦é“¾æ¥åˆ°æœ¬ç½‘ç«™å†…æ–‡ç« ï¼Œä¸æ’é™¤æœ‰å¤–é“¾å…¶ä»–ç½‘ç«™ã€‚\n   h(\u0026#39;div\u0026#39;, { ref: childRef }) ref å±æ€§ä»€ä¹ˆæ—¶å€™ä¸ä¼šæŒ‡å‘ vnode.el â“\n  setup(_, ctx) çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Ÿ \n runtime-core/src/component.ts:createSetupContext()\n æœ€åè¿”å›çš„å¯¹è±¡ï¼š\n1 2 3 4 5 6  { attrs: instance.attrs, slots: instance.slots, emit: instance.emit, expose }     setup() å‡½æ•°è¢«è°ƒç”¨çš„åœ°æ–¹ï¼š component.ts:setupStatefulComponent\n è°ƒç”¨æµç¨‹ï¼š\n renderer.ts:mountComponent -\u0026gt; setupComponent()\n component.ts:setupComponent() -\u0026gt; setupStatefulComponent() -\u0026gt; setup(instance.props, setupContenxt)\n expose å‡½æ•°ï¼š\n1 2 3 4 5 6  const expose: SetupContext[\u0026#39;expose\u0026#39;] = exposed =\u0026gt; { if (__DEV__ \u0026amp;\u0026amp; instance.exposed) { warn(`expose() should be called only once per setup().`) } instance.exposed = exposed || {} }     æ›´è¯¦ç»†çš„è¿‡ç¨‹-\u0026gt;\n  trasition ç»„ä»¶åŸç†åˆ†æï¼Ÿ\n  æ¨¡æ¿ä¸­çš„èµ„æº URL æ˜¯å¦‚ä½•è¯†åˆ«çš„ï¼Œæœ€ååˆæ˜¯è¢«ç¼–è¯‘æˆå•¥äº†ï¼Ÿ(å¦‚ï¼š \u0026lt;img src=\u0026#34;@img/vue/test.png\u0026#34; /\u0026gt;)\n  TODO component render å‡½æ•°åœ¨å“ªé‡Œæ‰§è¡Œï¼Ÿ\n  \u0026lt;script setup\u0026gt; åŸç†å’Œç¼–è¯‘è¿‡ç¨‹åŠç»“æœï¼Ÿ\n  setup å‡½æ•°å¦‚ä½•è§£æï¼Ÿåˆæ˜¯å¦‚ä½•æ‰§è¡Œï¼Ÿ\n render -\u0026gt; patch -\u0026gt; processComponent -\u0026gt; mountComponent -\u0026gt; createComponentInstance -\u0026gt; åˆ›å»ºç»„ä»¶å®ä¾‹ï¼Œåˆå§‹åŒ–ç»„ä»¶ç»“æ„ -\u0026gt;\n setupComponent -\u0026gt; åˆå§‹åŒ– props å’Œ slotsï¼Œæœ‰çŠ¶æ€ç»„ä»¶å¤„ç†\n setupStatefulComponent -\u0026gt; ç»™ instance.ctx å¢åŠ ä»£ç†ï¼Œæ‰§è¡Œ setup() å‡½æ•°\n ä¹Ÿå°±æ˜¯è¯´åœ¨ setup æ‰§è¡Œä¹‹å‰ props, emits, slots éƒ½å·²ç»å¯ä»¥è®¿é—®äº†ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•° åœ¨ç»„ ä»¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå› ä¸ºåé¢ç»„ä»¶çš„æ›´æ–°æ—¶ç›´æ¥è°ƒç”¨ instance.update æ¥å®Œæˆï¼Œä¸ä¼šè¿›å…¥ mountComponent ã€‚\n  props ? attrs ? å½“ç»™å­ç»„ä»¶ä¼ é€’å±æ€§çš„æ—¶å€™ï¼Œå“ªäº›åœ¨ props ä¸­ï¼Œå“ªäº›åœ¨ attrsä¸­ï¼Ÿ\n æ¯”å¦‚ï¼š\n1  \u0026lt;Child name=\u0026#34;child\u0026#34; foo=1 bar=true/\u0026gt;     name, foo, bar åœ¨ Child ç»„ä»¶ä¸­å­˜åœ¨å“ªé‡Œäº†ï¼Ÿ\n æ˜¯ props ? attrs ?\n  vue3 ä¸­å’Œ scheduler ä»»åŠ¡è°ƒåº¦æœ‰å…³çš„ä»£ç ï¼\n è®²è¿°äº† runtime-core/src/scheduler.ts ä¸­ api åœ¨å“ªäº›åœ°æ–¹æœ‰ç”¨åˆ°ï¼Œè¿™äº›ä½¿ç”¨çš„åœ°æ–¹ ä»»åŠ¡æ‰§è¡Œé¡ºåºåˆæ˜¯ä»€ä¹ˆâ“\n  vue3 äº‹ä»¶ç»‘å®šæ˜¯å¦‚ä½•å®ç°çš„(stopImmediatePropagation åˆæ˜¯å•¥?)ï¼Ÿ\n ç®€è¿°ï¼šä¸€ä¸ªå…ƒç´ ä¸€ä¸ªäº‹ä»¶åå¯¹åº”çš„äº‹ä»¶åªä¼šç»‘å®šä¸€ä¸ª listener åŠ å°è£…ä¹‹åçš„ invokerï¼Œæ­¤æ—¶ä¸ºäº†å®ç°åŸç”Ÿäº‹ä»¶çš„ stopImmediatePropagation åŠŸèƒ½ï¼Œå¯¹ invoker.value å³äº‹ä»¶å¥æŸ„åˆ—è¡¨é‡Œé¢çš„æ‰€æœ‰äº‹ä»¶å¥æŸ„(å‡½æ•°)è¿›è¡Œäº†é‡å†™ã€‚\n  vue3 å¼‚æ­¥ä»»åŠ¡è°ƒåº¦æœºåˆ¶ runtime-core-\u0026gt;scheduler æ˜¯å¦‚ä½•å®ç°çš„?\n vue3 ä¸­çš„å¼‚æ­¥æ›´æ–°ä»»åŠ¡åˆ†ä¸ºä¸‰ç§ï¼š pre cbs/queue jobs/post cbsï¼Œä»–ä»¬çš„æ‰§è¡Œéƒ½æœ‰ä¸€ å®šçš„å…ˆåé¡ºåºï¼Œç‚¹å‡»é“¾æ¥äº†è§£æ›´å¤šåˆ†æå†…å®¹ã€‚\n  vue3 diff åŸç†ï¼Ÿ\n   old new æ›´æ–°åŸåˆ™     [1] [1,2,3] appendï¼Œæ–°å¢   [4,5] [1,2,3,4,5] appendï¼Œæ–°å¢   [2,3,4] [1,2,3,4,5] æ–°å¢+æ’å…¥   [1,2,3,4] [2,3,1,4] ä¸€æ¬¡ç§»åŠ¨   [1,2,3,4] [1,4,2,3] ä¸€æ¬¡ç§»åŠ¨   [1,2,3] [2,3,1] ä¸€æ¬¡ç§»åŠ¨   [1,2,3,4] [4,2,3,1] ä¸€æ¬¡ç§»åŠ¨     è¯¸å¦‚ä¸Šé¢çš„å®ä¾‹æ˜¯å¦‚ä½•å®ç°æ’å…¥ï¼Œæ–°å¢ï¼Œåˆ é™¤å’Œç§»åŠ¨çš„ï¼Ÿ\n è¿™é‡Œåˆæ˜¯å¦‚ä½•åˆ©ç”¨â€œæœ€é•¿å¢é•¿åºåˆ—â€æ¥è¿‡æ»¤æ‰ä¸éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹çš„ï¼Ÿ\n ç®€è¿°ï¼š ä¸¤ä¸ª while + ifâ€¦else ifâ€¦else\n while1 æ£€æµ‹ patch å¤´éƒ¨ç›¸åŒèŠ‚ç‚¹\n while2 æ£€æµ‹ patch å°¾éƒ¨ç›¸åŒèŠ‚ç‚¹\n ç»è¿‡ä¸¤ä¸ª while å¤„ç†ä¹‹åå‰©ä¸‹çš„åªæœ‰ä¸è§„åˆ™çš„ä¸¤ç»„(new \u0026amp; old)åºåˆ—ã€‚\n if æ‰§è¡Œæ–°å¢\n else if æ‰§è¡Œåˆ é™¤\n else ä¾ç…§ã€æœ€é•¿å¢é•¿åºåˆ—ã€ç®—æ³•è¿›è¡Œåˆ†æï¼Œå†³å®šæ˜¯åˆ é™¤è¿˜æ˜¯æ–°å¢æˆ–æ’å…¥ã€‚\n æœ€é•¿å¢é•¿åºåˆ—ï¼šæ‰¾åˆ°ä¸€ç»„åºåˆ—ä¸­è·¯å¾„æœ€é•¿çš„é€’å¢åºåˆ—ï¼Œæ¯”å¦‚ï¼š\n 2,3,1,4 æœ€é•¿å¢é•¿åºåˆ—å°±æ˜¯ 2,3,4\n å‰©ä¸‹çš„å…ƒç´ åªå¯èƒ½æ¯”è¿™ä¸ªåºåˆ—ä¸­çš„å…ƒç´ å€¼å°(å¦‚ï¼š 1)\n å¯¹äºä¸è§„åˆ™çš„åºåˆ—å¯¹æ¯”è¿‡ç¨‹ä¸­ï¼Œä¼šä¼˜å…ˆæŸ¥æ‰¾æœ‰ key çš„ child, æ ¹æ® old child key å» new children ä¸­æ‰¾åˆ°ç›¸åŒ key çš„ new child æ¥æ›¿æ¢è¿™ä¸ª old childã€‚\n å¦‚æœæ²¡æ‰¾åˆ°ç›¸åŒ key çš„ new child é‚£è¿™ä¸ª old child å°†é¢ä¸´è¢«åˆ é™¤çš„å‘½è¿ã€‚\n å¦‚æœ old child ä¹Ÿæ˜¯ unkeyed é‚£ä¼šä» new children ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ª unkeyed çš„ new child æ¥æ›¿æ¢ã€‚\n æ‰€ä»¥æ€»ç»“ä¸‹æ¥ï¼š\n  while1 åŒåŒ–å¤´éƒ¨\n  while2 åŒåŒ–å°¾éƒ¨\n  if æ–°å¢\n  else if åˆ é™¤\n  else ä¸è§„åˆ™åºåˆ—\n  keyed old child æ‰¾ keyed new childï¼Œæ²¡æœ‰ unmount old\n  unkeyed old child æ‰¾ unkeyed new child, æ²¡æœ‰ unmount old\n  å‰©ä½™çš„ new child æ–°å¢\n  æœ€åæ ¹æ®æœ€é•¿é€’å¢åºåˆ—ç®—æ³•è¿›è¡Œç§»åŠ¨ï¼Œå‰ææ˜¯éœ€è¦ç§»åŠ¨\n      keep-alive ç»„ä»¶å®ç°åŸç†ï¼Ÿ\n activate å’Œ deactivate çŠ¶æ€åˆ‡æ¢çš„å®é™…åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ\n â‰ é€šè¿‡åˆ›å»ºä¸€ä¸ª off-dom div æ¥æ‰¿æ¥ deactivate çŠ¶æ€ä¸‹çš„ DOM ğŸŒ²ã€‚\n   ","permalink":"https://www.cheng92.com/vue/vue-core-code-link/","tags":["vue,","vue3"],"title":"Vue3 è‡ªé—®è‡ªç­”ç³»åˆ—â“â“â“"},{"categories":["vue"],"contents":" è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬æ–‡ä»æºç è§’åº¦è®²è§£äº† vue3 ä¸­æ˜¯å¦‚ä½•å¯¹ assets url è¿›è¡Œè½¬æ¢çš„ï¼Œæ¯”å¦‚ \u0026lt;img src=\u0026#34;@img/vue/test.png\u0026#34;\u0026gt; åœ¨ç¼–è¯‘ä¹‹åæ˜¯æ€ä¹ˆæ ·ï¼Ÿ è¿™ç¯‡æ–‡ç« å°†è¯¦å°½çš„æ¥æ™“ã€‚\n  æœ¬æ–‡æ¶‰åŠçš„æºç åŒ…ï¼š compiler-sfc, compiler-coreã€‚\n assets url åœ¨æ¨¡æ¿ä¸­çš„ä½¿ç”¨æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8  const template = ` \u0026lt;img src=\u0026#34;./logo.png\u0026#34;/\u0026gt; \u0026lt;img src=\u0026#34;~fixtures/logo.png\u0026#34;/\u0026gt; \u0026lt;img src=\u0026#34;~/fixtures/logo.png\u0026#34;/\u0026gt; \u0026lt;img src=\u0026#34;http://example.com/fixtures/logo.png\u0026#34;/\u0026gt; \u0026lt;img src=\u0026#34;/fixtures/logo.png\u0026#34;/\u0026gt; \u0026lt;img src=\u0026#34;data:image/png;base64,i\u0026#34;/\u0026gt; `     ä¸‹é¢ä¼šä»æºç è§’åº¦å–åˆ†æå„ç§æƒ…å†µæœ€åè¢«è§£æçš„ç»“æœã€‚\n è¯¥è§£æè¿‡æˆåœ¨ SFC æ¨¡æ¿è§£ææ¨¡å— compiler-sfc è§¦å‘ä¸­ï¼Œä½†æ˜¯æœ€ç»ˆè§£æçš„æ˜¯ compiler-core æ¨¡å—ã€‚\n ç›¸å…³å‡½æ•°ï¼š packages/compiler-sfc/src/templateTransofrmAssetUrl.ts ä¸­çš„ transformAssetUrlï¼Œè¿™ä¸ªå‡½æ•°å¹¶éç›´æ¥åœ¨å“ªé‡Œè°ƒç”¨ï¼Œè€Œæ˜¯åšä¸ºé€‰é¡¹ï¼Œè½¬æ¢å™¨ä¼ é€’ç»™äº† compiler-core ï¼Œåœ¨ transform ä»‹æ®µå¤„ç†ï¼Œå…·ä½“ä»£ç ç®€è¦æµç¨‹ã€‚\n compiler-sfc:src/compileTemplate.ts\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  function compileTemplate(options) { // ... ä¸€äº›é¢„å¤„ç†  return doCompileTemplate(options) // ... å’Œé”™è¯¯å¤„ç† } function doCompileTemplate({/* SFCTemplateCompileOptions ... */}) { // ...  let nodeTransforms: NodeTransform[] = [] if (isObject(transformAssetUrls)) { const assetOptions = normalizeOptions(transformAssetUrls) // å› ä¸º compiler-core:transform é˜¶æ®µ traverseNode ä¸­è°ƒç”¨  // nodeTransform çš„æ—¶å€™åªæœ‰ (node, context) =\u0026gt; ...  // æ‰€ä»¥è¿™é‡Œéœ€è¦è¿›è¡Œä¸€æ¬¡å°è£…ï¼Œå°† options ä¼ é€’ç»™ transformAssetUrl  nodeTransforms = [ createAssetUrlTransformWithOptions(assetOptions), createSrcsetTransformWithOptions(assetOptions) ] } else if (transformAssetUrls !== false) { nodeTransforms = [transformAssetUrl, transformSrcset] } // ...  let { code, ast, preamble, map } = compiler.compile(source, { // ... ä¸€ç³»åˆ—é€‰é¡¹  ...compilerOptions, // âš  è¿™æ˜¯æœ¬èŠ‚å…³æ³¨çš„é‡ç‚¹  nodeTransforms: nodeTransforms.concat(compilerOptions.nodeTransforms || []), // ...  }) // ... }     çœç•¥ä¸€äº›æ— å…³ç´§è¦çš„ä»£ç ï¼Œè¿™é‡Œé‡ç‚¹å…³æ³¨ transformAssetUrl å’Œ transformSrcset ä¸¤ ä¸ªï¼Œå°¤å…¶æ˜¯å‰è€…ã€‚\n ä¸Šé¢æ˜¯ compiler-sfc é˜¶æ®µçš„å¤§è‡´é€»è¾‘ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œä¸¤ä¸ª transformXxx çš„åœ°æ–¹å‘ç”Ÿåœ¨\n compiler-core:src/transform.ts(æ›´è¯¦å°½çš„åˆ†æåœ¨è¿™é‡Œ ã€‚)\n transform() -\u0026gt; traverseNode() ä» root èŠ‚ç‚¹å¼€å§‹é€’å½’å¤„ç† astï¼Œæ¥è‡ª ast.ts è§£æåçš„ AST ç»“æ„ã€‚\n traverseNode() å‡½æ•°åˆ†ä¸‰ä¸ªé˜¶æ®µå®ç°\n  æ”¶é›† node transform å‡½æ•°ï¼Œå¹¶ä¼šæå‰å¤„ç†ä¸€äº›èŠ‚ç‚¹\n  æ ¹æ®èŠ‚ç‚¹ç±»å‹ NodeTypesï¼Œåšç›¸åº”çš„åˆ†æ”¯å¤„ç†ï¼Œæ¯”å¦‚ï¼š children\n  æœ€åä¸€ä¸ª while åæ–¹å‘æ‰§è¡Œæ”¶é›†åˆ°çš„ node transform å®Œæˆè½¬æ¢\n   è¿™äº›æ­¥éª¤ä¸å±•å¼€è®²äº†ï¼Œæ›´è¯¦ç»†çš„è¿˜æ˜¯è¿™ç¯‡æ–‡ç« : Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform + codegen\n å†å›å¤´çœ‹ transformAssetUrl å†…çš„æ¡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83  export const transformAssetUrl: NodeTransform = ( node, context, options: AssetURLOptions = defaultAssetUrlOptions ) =\u0026gt; { // æ¡ä»¶1:  if (node.type === NodeTypes.ELEMENT) { if (!node.props.length) { return } } // æ¡ä»¶2:  const tags = options.tags || defaultAssetUrlOptions.tags const attrs = tags[node.tag] const wildCardAttrs = tags[\u0026#39;*\u0026#39;] if (!attrs \u0026amp;\u0026amp; !wildCardAttrs) { return } // å¼€å§‹å¤„ç† node.props  node.props.forEach((attr, index) =\u0026gt; { // 1. props è¿‡æ»¤  if ( attr.type !== NodeTypes.ATTRIBUTE || !assetAttrs.includes(attr.name) || !attr.value || isExternalUrl(attr.value.content) || isDataUrl(attr.value.content) || attr.value.content[0] === \u0026#39;#\u0026#39; || (!options.includeAbsolute \u0026amp;\u0026amp; !isRelativeUrl(attr.value.content)) ) { return } // ... æ’é™¤äº†ä¸Šé¢çš„æƒ…å†µ  // 2. ç›¸å¯¹è·¯å¾„è½¬æ¢ï¼ŒåŒ…æ‹¬æ–°å¢çš„ options.base é€‰é¡¹(db786b1)  // https://github.com/vuejs/vue-next/issues/2477  const url = parseUrl(attr.value.content) if (options.base \u0026amp;\u0026amp; attr.value.content[0] === \u0026#39;.\u0026#39;) { // parseUrl å¤„ç†ç»“æœ  // ~assets/images/ =\u0026gt; assets/images  // æˆ–è€…  // /assets/images/ =\u0026gt; assets/images  // æœ€åä½¿ç”¨ url å°† base è½¬æˆ URL å¯¹è±¡(åŒ…å«ï¼š path,hash,host,...)ã€‚  const base = parseUrl(options.base) const protocol = base.protocol || \u0026#39;\u0026#39; const host = base.host ? protocol + \u0026#39;//\u0026#39; + base.host : \u0026#39;\u0026#39; const basePath = base.path || \u0026#39;/\u0026#39; // ç»è¿‡ä¸¤æ¬¡ parseUrl åˆ†åˆ«å¯¹ attr.value å’Œ base çš„å¤„ç†  // æœ€ç»ˆå¾—åˆ°ä¸‹é¢çš„ç»„åˆ  // å‡è®¾ base = \u0026#34;https://www.cheng92.com/img/vue\u0026#34;  // \u0026lt;img src=\u0026#34;./vue/test.png\u0026#34; /\u0026gt;  // base = { protocol: \u0026#34;https://\u0026#34;, host: \u0026#34;www.cheng92.com\u0026#34;, path: \u0026#34;/img/vue\u0026#34; }  // url = { path: \u0026#34;vue/test.png\u0026#34;, hash: \u0026#39;\u0026#39; }  // æœ€ç»ˆç»„åˆç»“æœï¼š base.host + base.path + url.path + url.hash  // = https://www.cheng92.com/img/vue/test.png  // ç»¼åˆä¸Šé¢çš„åˆ†æ  // ~vue/test.png =\u0026gt; import ... from \u0026#39;vue/test.png\u0026#39;  // @vue/test.png =\u0026gt; import ... from \u0026#39;@vue/test.png\u0026#39;  // ./test.png =\u0026gt; https://www.cheng92.com/img/vue/test.png  // å› ä¸ºåªæœ‰ . å¼€å¤´çš„å½“åšç›¸å¯¹è·¯å¾„ç»“åˆ base æ¥æ‹¼æ¥  attr.value.content = host + (path.posix || path).join(basePath, url.path + (url.hash || \u0026#39;\u0026#39;)) return } // 3. æ¥ä¸‹æ¥æ˜¯æ²¡æœ‰ options.base çš„æƒ…å†µå¤„ç†ï¼Œå¯¹äºèµ„æºå¤„ç†æ˜¯  const exp = getImportsExpressionExp(url.path, url.hash, attr.loc, context) node.props[index] = { type: NodeTypes.DIRECTIVE, name: \u0026#39;bind\u0026#39;, arg: createSimpleExpression(attr.name, true, attr.loc), exp, modifiers: [], loc: attr.loc } }) }     æ¡ä»¶1: é¦–å…ˆæ˜¯ ELEMENT ç±»å‹èŠ‚ç‚¹ä¸”æœ‰ props çš„æƒ…å†µä¸‹è¿™ä¸ªå‡½æ•°å½©ç»˜è¢«æ”¶é›†è¿›å½“å‰ç»„ä»¶ çš„ transform é˜Ÿåˆ—ä¸­ã€‚\n æ¡ä»¶2: å¿…éœ€æ˜¯æŒ‡å®šç±»å‹çš„æ ‡ç­¾ï¼Œè¿™é‡Œæœ‰é»˜è®¤çš„æ ‡ç­¾åˆ—è¡¨\n1 2 3 4 5 6 7 8 9 10 11 12 13  export const defaultAssetUrlOptions: Required\u0026lt;AssetURLOptions\u0026gt; = { base: null, includeAbsolute: false, tags: { video: [\u0026#39;src\u0026#39;, \u0026#39;poster\u0026#39;], source: [\u0026#39;src\u0026#39;], img: [\u0026#39;src\u0026#39;], image: [\u0026#39;xlink:href\u0026#39;, \u0026#39;href\u0026#39;], use: [\u0026#39;xlink:href\u0026#39;, \u0026#39;href\u0026#39;] } } // é»˜è®¤æƒ…å†µåªæœ‰ video, source, img, image, use æ ‡ç­¾ // æ»¡è¶³æƒ…å†µ      æ»¡è¶³æ¡ä»¶åä¼šé’ˆå¯¹æ¯ä¸ª prop è¿›è¡Œå•ç‹¬å¤„ç†:\n  è¿‡æ»¤æ‰ä¸æ»¡è¶³å¤„ç†æ¡ä»¶çš„\n  é ATTRIBUTE ç±»å‹ï¼Œå¯èƒ½æ˜¯æŒ‡ä»¤\n  æ£€æŸ¥æ ‡ç­¾å±æ€§åæ˜¯å¦åœ¨ options.tags å¯¹åº”çš„ tag çš„èŒƒå›´å€¼å†…, æ¯”å¦‚ï¼š \u0026lt;img\u0026gt; æ˜¯ srcï¼Œ \u0026lt;video\u0026gt; æ˜¯ src æˆ– poster ç­‰ç­‰â€¦\n  å·²ç»æ˜¯ http(s):// æ‰“å¤´çš„å®Œæ•´é“¾æ¥\n  data:xxx å¼€å¤´çš„ url ï¼Œæ¯”å¦‚ï¼š base64 ä¹‹åçš„ url\n  #xx å¼€å¤´çš„å€¼ï¼Œæ¯”å¦‚ï¼š \u0026lt;a href=\u0026#34;#\u0026#34;/\u0026gt;\n  æœ€åä¸€ä¸ªæ¡ä»¶å°±æ˜¯è¿‡æ»¤æ‰éç›¸å¯¹è·¯å¾„çš„æƒ…å†µ(ç›¸å¯¹è·¯å¾„ï¼š .,~,@ ä¸‰ä¸ªå­—ç¬¦å¼€å¤´çš„è·¯å¾„ è¢«è§†ä¸ºç›¸å¯¹è·¯å¾„, æ¯”å¦‚ï¼š \u0026#34;./path/to\u0026#34;, \u0026#34;~/path/to\u0026#34;, \u0026#34;@dir/path/to\u0026#34;)\n    ç›¸å¯¹è·¯å¾„è½¬æ¢ï¼ŒåŒ…æ‹¬æ–°å¢çš„ options.base é€‰é¡¹(db786b1, #2477)\n const url = parseUrl(attr.value.content)\n parseUrl è½¬æ¢ï¼Œé¦–å…ˆå°† ~img/vue/test.png è½¬æˆ img/vue/test.png ç„¶åäº¤ç»™ url è§£æå‡º URL å¯¹è±¡ï¼š {path, hash, href, host, ...} å¦‚ï¼š parseUrl å®ç°\n  æ¥ä¸‹æ¥æ˜¯æ²¡æœ‰ options.base æˆ–è€…éç›¸å¯¹è·¯å¾„çš„æƒ…å†µå¤„ç†ï¼Œå¦‚ï¼š ~/img/vue/test.png æˆ– @img/vue/test.png çš„å¤„ç†\n è½¬å˜æˆ import imgUrl from \u0026#39;â€¦./â€¦./x.png\u0026#39; çš„å¼•å…¥è¯­æ³•ã€‚\n const exp = getImportsExpressionExp(url.path, url.hash, attr.loc, context)\n è¿™ä¸ªå‡½æ•°æ‰€å®Œæˆçš„å·¥ä½œ:\n  ä» context.imports ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å­˜åœ¨\n  åˆ›å»º import exp å¯¹è±¡æœ€åä¼šå¾„ç”± codegen é˜¶æ®µç”Ÿæˆ import â€¦ from â€¦ ä»£ç (SIMPLE_EXPRESSION)\n  ç¼“å­˜åˆ° context.imports.push({ exp, path })\n  hash å’Œ path åŒæ—¶å­˜åœ¨çš„æƒ…å†µ\n å¯¹ url å€¼è¿›è¡Œæå‡å¤„ç† context.hoist(â€¦) æ¯”å¦‚ä¸‹é¢æµ‹è¯•ä¸­çš„:\n \u0026lt;use href=\u0026#34;~@svg/file.svg#fragment\u0026#34;\u0026gt;\u0026lt;/use\u0026gt;\n ç¼–è¯‘åï¼š\n const _hoisted_1 = _imports_2 + \u0026#39;#fragment\u0026#39; const _hoisted_8 = /*#__PURE__*/_createVNode(\u0026#34;use\u0026#34;, { href: _hoisted_1 }, null, -1 /* HOISTED */)\n é¦–å…ˆæ˜¯ \u0026lt;use\u0026gt; å…ƒç´ æœ¬èº«è¿›è¡Œäº†æå‡ï¼Œå› ä¸ºæ˜¯æ™®é€šæ ‡ç­¾ï¼Œæ²¡æœ‰åŠ¨æ€å±æ€§æˆ–æŒ‡ä»¤ï¼Œä¹Ÿæ²¡ æœ‰åŠ¨æ€çš„ children æ‰€ä»¥æ˜¯é™æ€èŠ‚ç‚¹ç»™æå‡ï¼ŒåŒæ—¶å› ä¸º href å€¼æœ‰ hash æœ‰ path æ‰€ä»¥è¯¥å€¼ä¹Ÿåšäº†æå‡å¤„ç†ï¼Œå½“åšé™æ€æ¥å¤„ç†ã€‚\n    æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const url = process.env.VNEXT_PKG_SFC +\u0026#39;/dist/compiler-sfc.cjs.js\u0026#39; const sfc = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { compileTemplate: compile } = sfc const source = ` \u0026lt;img src=\u0026#34;/vue/logo.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;./vue/logo.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;@vue/logo.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;~vue/logo.png\u0026#34;/\u0026gt; \u0026lt;img src=\u0026#34;https://www.cheng92.com/img/vue/logo.png\u0026#34;/\u0026gt; \u0026lt;img src=\u0026#34;data:image/png;base64,i\u0026#34;/\u0026gt; \u0026lt;use href=\u0026#34;~@svg/file.svg#fragment\u0026#34;\u0026gt;\u0026lt;/use\u0026gt; ` const opt = {} const run = () =\u0026gt; compile({ source, transformAssetUrls: opt }) let result = run() console.log(\u0026#39;\\n\u0026gt;\u0026gt;\u0026gt; æ²¡æœ‰ options.base \\n\u0026#39;, result.code); opt.base = \u0026#39;https://www.cheng92.com/img\u0026#39; result = compile({ source, transformAssetUrls: opt }) console.log(\u0026#39;\\n\u0026gt;\u0026gt;\u0026gt; æœ‰ options.base \\n\u0026#39;, result.code); return 0    \u0026gt;\u0026gt;\u0026gt; æ²¡æœ‰ options.base import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from \u0026#34;vue\u0026#34; import _imports_0 from \u0026#39;./vue/logo.png\u0026#39; import _imports_1 from \u0026#39;@vue/logo.png\u0026#39; import _imports_2 from \u0026#39;vue/logo.png\u0026#39; import _imports_3 from \u0026#39;@svg/file.svg\u0026#39; const _hoisted_1 = _imports_3 + \u0026#39;#fragment\u0026#39; const _hoisted_2 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/vue/logo.png\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_3 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_0 }, null, -1 /* HOISTED */) const _hoisted_4 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_1 }, null, -1 /* HOISTED */) const _hoisted_5 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_2 }, null, -1 /* HOISTED */) const _hoisted_6 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;https://www.cheng92.com/img/vue/logo.png\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_7 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;data:image/png;base64,i\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_8 = /*#__PURE__*/_createVNode(\u0026#34;use\u0026#34;, { href: _hoisted_1 }, null, -1 /* HOISTED */) export function render(_ctx, _cache) { return (_openBlock(), _createBlock(_Fragment, null, [ _hoisted_2, _hoisted_3, _hoisted_4, _hoisted_5, _hoisted_6, _hoisted_7, _hoisted_8 ], 64 /* STABLE_FRAGMENT */)) } \u0026gt;\u0026gt;\u0026gt; æœ‰ options.base import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from \u0026#34;vue\u0026#34; import _imports_0 from \u0026#39;@vue/logo.png\u0026#39; import _imports_1 from \u0026#39;vue/logo.png\u0026#39; import _imports_2 from \u0026#39;@svg/file.svg\u0026#39; const _hoisted_1 = _imports_2 + \u0026#39;#fragment\u0026#39; const _hoisted_2 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/vue/logo.png\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_3 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;https://www.cheng92.com/img/vue/logo.png\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_4 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_0 }, null, -1 /* HOISTED */) const _hoisted_5 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_1 }, null, -1 /* HOISTED */) const _hoisted_6 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;https://www.cheng92.com/img/vue/logo.png\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_7 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;data:image/png;base64,i\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_8 = /*#__PURE__*/_createVNode(\u0026#34;use\u0026#34;, { href: _hoisted_1 }, null, -1 /* HOISTED */) export function render(_ctx, _cache) { return (_openBlock(), _createBlock(_Fragment, null, [ _hoisted_2, _hoisted_3, _hoisted_4, _hoisted_5, _hoisted_6, _hoisted_7, _hoisted_8 ], 64 /* STABLE_FRAGMENT */)) } 0     å°ç»“ï¼š\n   base é€‰é¡¹ä¼ é€’ç»™ compileTemplate æ˜¯ä»¥ { transformAssetUrls: { base: \u0026#39;...\u0026#39; }} å±æ€§\n  æ²¡æœ‰ base æƒ…å†µï¼Œ ./path/to =\u0026gt; import ... from \u0026#39;./path/to\u0026#39; å½“åšç›¸å¯¹è·¯å¾„å¤„ ç†\n  æœ‰ base æƒ…å†µ, ./path/to =\u0026gt; src: \u0026#39;https://www.cheng92.com/path/to ä¼šå°† base è§£æåä¸è§£æåçš„ src è¿›è¡Œæ‹¼æ¥ï¼Œæ²¡æœ‰ import\n  ~ è¯­æ³•æƒ…å†µï¼Œ ~/path/to =\u0026gt; import ... from \u0026#39;path/to\u0026#39;\n  @ è¯­æ³•æƒ…å†µï¼Œ @path/to =\u0026gt; import ... from \u0026#39;@path/to\u0026#39;\n  ~@ æœ‰ path åˆæœ‰ hash çš„æƒ…å†µï¼Œ url å€¼ä¼šè¿›è¡Œæå‡ï¼Œå¦‚:\n \u0026lt;use href=\u0026#34;~@svg/file.svg#fragment\u0026#34;\u0026gt;\u0026lt;/use\u0026gt;\n   ","permalink":"https://www.cheng92.com/vue/vue-teardown-7-asset-transform/","tags":["vue3,","vue-next,","assets","transform"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘¦ assets url è½¬æ¢è§„åˆ™"},{"categories":["basis"],"contents":" è·¯çº¿å›¾ï¼š\n  MOOC å¤§å­¦ç½‘æ•™ç¨‹ï¼š https://www.icourse163.org/learn/ZJU-93001?tid=1464647442#/learn/announce\n","permalink":"https://www.cheng92.com/post/data-structure-algorithm/","tags":["æ•°æ®ç»“æ„,","ç®—æ³•"],"title":"æ•°æ®ç»“æ„ä¸ç®—æ³• - å­¦ä¹ è®°å½•"},{"categories":["emacs"],"contents":" æŠ˜è…¾ï¼ŒæŠ˜è…¾ã€‚ã€‚ã€‚\n ç”¨çš„æ˜¯ 2015 ç‰ˆçš„ macos åœ¨ä½¿ç”¨å¤–éƒ¨è¾“å…¥æ³•çš„æ—¶å€™ emacs å°¤å…¶çš„å¡é¡¿ï¼Œæ— å¥ˆåªèƒ½æŠ˜è…¾å†…éƒ¨ è¾“å…¥æ³•ã€‚\n æˆ‘çš„ doom emacs é…ç½®ï¼š gcclll/.doom.d: private doom-emacs configuration\n ä¸‹é¢æ˜¯ç»è¿‡ä¸€ç•ªæŠ˜è…¾æ•´çš„ä¸€ä¸ªå®‰è£…è„šæœ¬ï¼š\n é…ç½®å®‰è£…ç›¸å…³é“¾æ¥ï¼š\n .doom.d/config.el at main Â· eggcaker/.doom.d\n maomiui/rime: Rime é¼ é¡»ç®¡ï¼ˆSquirrelï¼‰æœ™æœˆæ‹¼éŸ³ï½œå°é¹¤åŒæ‹¼ï½œè‡ªç„¶ç åŒæ‹¼é…ç½®\n rime/plum: æ±é¢¨ç ´ plum: Rime configuration manager and input schema repository\n åœ¨Macç‰ˆçš„Emacsä¸­ä½¿ç”¨RIMEè¾“å…¥æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82  #!/usr/bin/env bash set -euo pipefail DOOM=\u0026#34;$HOME/.doom.d\u0026#34; DYLIB=\u0026#34;/Library/Input Methods/Squirrel.app/Contents/Frameworks/librime.1.dylib\u0026#34; if [ ! -d $DOOM ]; then echo \u0026#34;\u0026gt; æ²¡æœ‰ doom-emacs é…ç½®\u0026#34; echo \u0026#34;\u0026gt; æ‰§è¡Œ git clone git@github.com:gcclll/.doom.d.git ~/.emacs.d\u0026#34; echo \u0026#34;\u0026gt; æ‰§è¡Œ ~/.emacs.d/bin/doom sync\u0026#34; exit -1 fi if [[ ! -e ${DYLIB} ]]; then echo \u0026#34;\u0026gt; Rime æ²¡æœ‰å®‰è£…, å‡†å¤‡å®‰è£… Rime è¾“å…¥æ³• https://rime.im/download/\u0026#34; echo \u0026#34;\u0026gt; å¦‚æœä¸‹è¼‰é€Ÿåº¦å¤ªæ…¢ï¼Œå»ºè­°é€šéç¶²ç«™ä¸‹è¼‰å®‰è£ï¼šhttps://rime.im/download/\u0026#34; echo \u0026#34;\u0026gt; -------- F4 å‘¼å‡ºé…ç½®ï¼Œå¯é€²è¡Œç®€ä½“å’Œç¹ä½“åˆ‡æ¢ --------\u0026#34; brew install --cask squirrel echo \u0026#34;\u0026gt; rime installed, link lib into /usr/local/lib\u0026#34; sudo cp \u0026#34;${DYLIB}\u0026#34; /usr/local/lib echo \u0026#34;\u0026gt; -------- Rime å®‰è£…å®Œæˆ --------\u0026#34; echo \u0026#34;\u0026#34; else echo \u0026#34;\u0026gt; Rime å·²ç»å­˜åœ¨ï¼Œæ— éœ€é‡å¤å®‰è£…ã€‚\u0026#34; fi echo \u0026#34;\u0026gt; -------- å¼€å§‹å®‰è£… rime-install å‘½ä»¤ --------\u0026#34; PLUM=\u0026#34;$DOOM/extensions/plum\u0026#34; if [ ! -d $PLUM ]; then cd $DOOM git submodule add --depth 1 https://github.com/rime/plum.git extensions/plum fi cd $PLUM bash rime-install :preset echo \u0026#34;\u0026gt; -------- rime-install å®‰è£…å®Œæˆ --------\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;\u0026gt; -------- å¼€å§‹å®‰è£… Rime äº”ç¬” --------\u0026#34; bash rime-install wubi pinyin-simp echo \u0026#34;\u0026gt; -------- Rime äº”ç¬”å®‰è£…å®Œæˆ --------\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;\u0026gt; -------- å¼€å§‹æ„å»º librime.so --------\u0026#34; echo \u0026#34;\u0026gt; 1. installing cmake \u0026amp; git dependencies...\u0026#34; brew install cmake git LIB=\u0026#34;$DOOM/extensions/librime\u0026#34; if [ ! -d $LIB ]; then echo \u0026#34;\u0026gt; clone librime -\u0026gt; $LIB\u0026#34; cd $DOOM # [[https://rime.im/download/][ä¸‹è¼‰åŠå®‰è£ | RIME | ä¸­å·éŸ»è¼¸å…¥æ³•å¼•æ“]] git submodule add --depth=1 https://github.com/rime/librime.git extensions/librime fi echo \u0026#39;\u0026gt; export RIME_PATH=\u0026#34;$LIB\u0026#34;\u0026#39; export RIME_PATH=\u0026#34;$LIB\u0026#34; cd $LIB echo \u0026#34;\u0026gt; 2. begin make -\u0026gt; xcode/thirdparty/boost\u0026#34; make xcode/thirdparty/boost echo \u0026#39;\u0026gt; export BOOST_ROOT=\u0026#34;$(pwd)/thirdparty/src/boost_1_75_0\u0026#34;\u0026#39; export BOOST_ROOT=\u0026#34;$(pwd)/thirdparty/src/boost_1_75_0\u0026#34; echo \u0026#34;\u0026gt; 3. building 3rd parth libraries...\u0026#34; git submodule update --init make xcode/thirdparty echo \u0026#34;\u0026gt; 4. building librime ...\u0026#34; make xcode make xcode/debug echo \u0026#34;\u0026gt; done.\u0026#34; echo \u0026#34;\u0026gt; 5. running unit tests...\u0026#34; make xcode/test echo \u0026#34;\u0026gt; 6. try it ...\u0026#34; cd debug/bin echo \u0026#34;congmingdeRime{space}shurufa\u0026#34; | Debug/rime_api_console     å…¶ä»–ï¼š\n maomiui/rime: Rime é¼ é¡»ç®¡ï¼ˆSquirrelï¼‰æœ™æœˆæ‹¼éŸ³ï½œå°é¹¤åŒæ‹¼ï½œè‡ªç„¶ç åŒæ‹¼é…ç½®\n å®‰è£…ç”Ÿå­—å­—ä½“ï¼š rime/èŠ±å›­æ˜æœå­—ä½“ at master Â· maomiui/rime\n å› ä¸ºä¸­æ–‡è„šæœ¬é—®é¢˜ï¼Œæ‰€ä»¥ fork äº†ä¸€ä»½å‡ºæ¥ï¼Œç›®å½•éƒ½æ”¹æˆäº†è‹±æ–‡åã€‚\n gcclll/rime: Rime é¼ é¡»ç®¡ï¼ˆSquirrelï¼‰æœ™æœˆæ‹¼éŸ³ï½œå°é¹¤åŒæ‹¼ï½œè‡ªç„¶ç åŒæ‹¼é…ç½®\n","permalink":"https://www.cheng92.com/emacs/emacs-rime-pyim/","tags":["emacs,","doomemacs,","rime,","pyim"],"title":"Doom Emacs ä¸Šé…ç½®Rime + Pyim"},{"categories":["macos"],"contents":" ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ MacOS ç³»ç»Ÿç›¸å…³çš„ä¸œè¥¿ ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€ğŸ˜€     insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\"); insertCssLink(\"/js/vue/css/awesome.css\");    CLI  bcal, å­—èŠ‚è®¡ç®—ï¼Œè½¬æ¢   bcal è¿›å…¥æˆ–ç›´æ¥ä½¿ç”¨ $ bcal \u0026lt;expr\u0026gt; ... :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  â•­â”€simon at gcl in ~/.doom.d on nativeâœ˜âœ˜âœ˜ 21-07-22 - 15:24:39 â•°â”€â  â µ bcal ~/.doom.d q/double Enter -\u0026gt; quit, ? -\u0026gt; help bcal\u0026gt; \u0026#34;(5kb+10mb)\u0026#34; 10005000 B IEC standard (base 2) 9.7705078125e+03 KiB 9.5415115356e+00 MiB 9.3178823590e-03 GiB 9.0994944912e-06 TiB SI standard (base 10) 10005 kB 1.0005000000e+01 MB 1.0005000000e-02 GB 1.0005000000e-05 TB ADDRESS (d) 10005000 (h) 0x98aa08 bcal\u0026gt;     ä½¿ç”¨æ–¹å¼ï¼Œé‡‡ç”¨å„ç§è¡¨è¾¾å¼æ–¹å¼ï¼š\n  æ”¯æŒæ•°å­¦è®¡ç®—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  $ bcal \u0026#34;(5kb+2mb)/3\u0026#34; $ bcal \u0026#34;5 tb / 12\u0026#34; $ bcal \u0026#34;2.5mb*3\u0026#34; â•°â”€â  â µ bcal \u0026#34;2.5mb*3\u0026#34; ~/.doom.d RESULT 7500000 B IEC standard (base 2) 7.3242187500e+03 KiB 7.1525573730e+00 MiB 6.9849193096e-03 GiB 6.8212102633e-06 TiB SI standard (base 10) 7500 kB 7.5000000000e+00 MB 7.5000000000e-03 GB 7.5000000000e-06 TB ADDRESS (d) 7500000 (h) 0x7270e0 $ bcal \u0026#34;(2giB * 2) / (2kib \u0026gt;\u0026gt; 2)\u0026#34; â•°â”€â  â µ bcal \u0026#34;(2giB * 2) / (2kib \u0026gt;\u0026gt; 2)\u0026#34; ~/.doom.d 8388608      è½¬æˆå…¶å®ƒæ ¼å¼ï¼Œå•ä½å¤§å°å†™æ•æ„Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  $ bcal 20140115 b $ bcal 0x1335053 B $ bcal 0xaabbcc kb $ bcal 0xdef Gib â•­â”€simon at gcl in ~/.doom.d on nativeâœ” 21-07-22 - 15:39:04 â•°â”€â  â µ bcal 20140115 b ~/.doom.d UNIT CONVERSION 20140115 B IEC standard (base 2) 1.9668081055e+04 KiB 1.9207110405e+01 MiB 1.8756943755e-02 GiB 1.8317327886e-05 TiB SI standard (base 10) 2.0140115000e+04 kB 2.0140115000e+01 MB 2.0140115000e-02 GB 2.0140115000e-05 TB ADDRESS (d) 20140115 (h) 0x1335053 LBA:OFFSET (sector size: 0x200) (d) 39336:83 (h) 0x99a8:0x53      æŒ‡å®šåŒºå—å¤§å°\n1  $ bcal 0xaabbcc kb -s 4096      LBA è½¬æˆ CHS:\n1 2 3 4 5 6 7 8 9 10  $ bcal -f l500 $ bcal -f l0x600-18-0x7e $ bcal -f l0x300-0x12-0x7e # result: â•­â”€simon at gcl in ~/.doom.d on nativeâœ” 21-07-22 - 15:32:44 â•°â”€â  â µ bcal -f l500 ~/.doom.d LBA2CHS LBA:500 MAX_HEAD:16 MAX_SECTOR:63 CHS: (d) 0 7 60, (h) 0x0 0x7 0x3c      CHS è½¬æˆ LBA\n1 2 3 4 5 6 7 8 9 10  $ bcal -f l500 $ bcal -f l0x600-18-0x7e $ bcal -f l0x300-0x12-0x7e # result: â•­â”€simon at gcl in ~/.doom.d on nativeâœ” 21-07-22 - 15:40:28 â•°â”€â  â µ bcal -f l0x300-0x12-0x7e ~/.doom.d LBA2CHS LBA:768 MAX_HEAD:18 MAX_SECTOR:126 CHS: (d) 0 6 13, (h) 0x0 0x6 0xd      æ˜¾ç¤ºä¸€ä¸ªæ•°æ®çš„2è¿›åˆ¶ï¼Œ10 è¿›åˆ¶å’Œ 16 è¿›åˆ¶è¡¨ç¤ºå½¢å¼\n b (2è¿›åˆ¶), d (åè¿›åˆ¶), h (16è¿›åˆ¶)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  $ bcal -c 20140115 â•­â”€simon at gcl in ~/.doom.d on nativeâœ” 21-07-22 - 15:44:32 â•°â”€â  â µ bcal -c 20140115 ~/.doom.d (b) 0b1001100110101000001010011 (d) 20140115 (h) 0x1335053 $ bcal -c 0b1001100110101000001010011 â•­â”€simon at gcl in ~/.doom.d on nativeâœ” 21-07-22 - 15:44:14 â•°â”€â  â µ bcal -c 0b1001100110101000001010011 ~/.doom.d (b) 0b1001100110101000001010011 (d) 20140115 (h) 0x1335053 $ bcal -c 0x1335053 â•­â”€simon at gcl in ~/.doom.d on nativeâœ” 21-07-22 - 15:42:10 â•°â”€â  â µ bcal -c 0x1335053 ~/.doom.d (b) 0b1001100110101000001010011 (d) 20140115 (h) 0x1335053     äº¤äº’æ¨¡å¼ï¼š\n1 2  q/double Enter -\u0026gt; quit, ? -\u0026gt; help bcal\u0026gt; c 20140115 # ç›´æ¥ä½¿ç”¨å¯¹åº”çš„é€‰é¡¹      æ‰§è¡Œ bc, åœ¨äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥ b\n1 2 3 4  $ bcal -b \u0026#39;3.5 * 2.1 + 5.7\u0026#39; bcal\u0026gt; b bc vars: scale = 10, ibase = 10, last = r bc\u0026gt; 3.5 * 2.1 + 5.7      ç®¡é“è¾“å…¥ï¼Œç»“æœç»™ bcal å¤„ç†\n1 2  $ printf \u0026#39;15 kib + 15 gib \\n r / 5\u0026#39; | bcal -m $ printf \u0026#39;15 + 15 + 2\u0026#39; | bcal -bm      ä»æ–‡ä»¶è·å–è¾“å…¥ç»™ bcal\n1 2 3 4  $ cat expr 15 gib + 15 kib r / 5 $ bcal -m \u0026lt; expr          Nix   install:\n NixOS - NixOS Linux\n Nix on macOS, Made Easy - çŸ¥ä¹\n MacOS Nix Setup (an alternative to Homebrew)\n $ curl -L https://nixos.org/nix/install | sh\n æ–°ç³»ç»Ÿä¸èƒ½å®‰è£…é—®é¢˜ï¼Œæ— æƒé™åˆ›å»º /nix\n $ sh \u0026lt;(curl -L https://nixos.org/nix/install) --darwin-use-unencrypted-nix-store-volume\nCreating volume and mountpoint /nix. ------------------------------------------------------------------ | This installer will create a volume for the nix store and | | configure it to mount at /nix. Follow these steps to uninstall. | ------------------------------------------------------------------ 1. Remove the entry from fstab using \u0026#39;sudo vifs\u0026#39; 2. Destroy the data volume using \u0026#39;diskutil apfs deleteVolume\u0026#39; 3. Remove the \u0026#39;nix\u0026#39; line from /etc/synthetic.conf or the file ... Installation finished! To ensure that the necessary environment variables are set, either log in again, or type . /Users/simon/.nix-profile/etc/profile.d/nix.sh in your shell.   å®Œæˆä¹‹åï¼š\n# simon @ gcl in ~ [20:18:32] $ nix Usage: nix \u0026lt;COMMAND\u0026gt; \u0026lt;FLAGS\u0026gt;... \u0026lt;ARGS\u0026gt;... Common flags: --debug enable debug output --help show usage information --help-config show configuration options --no-net disable substituters and consider all previously downloaded files up-to-date --option \u0026lt;NAME\u0026gt; \u0026lt;VALUE\u0026gt; set a Nix configuration option (overriding nix.conf) -L, --print-build-logs print full build logs on stderr --quiet decrease verbosity level -v, --verbose increase verbosity level --version show version information In addition, most configuration settings can be overriden using \u0026#39;--\u0026lt;name\u0026gt; \u0026lt;value\u0026gt;\u0026#39;. Boolean settings can be overriden using \u0026#39;--\u0026lt;name\u0026gt;\u0026#39; or \u0026#39;--no-\u0026lt;name\u0026gt;\u0026#39;. See \u0026#39;nix --help-config\u0026#39; for a list of configuration settings. Available commands: add-to-store add a path to the Nix store build build a derivation or fetch a store path cat-nar print the contents of a file inside a NAR file cat-store print the contents of a store file on stdout copy copy paths between Nix stores copy-sigs copy path signatures from substituters (like binary caches) doctor check your system for potential problems dump-path dump a store path to stdout (in NAR format) edit open the Nix expression of a Nix package in $EDITOR eval evaluate a Nix expression hash-file print cryptographic hash of a regular file hash-path print cryptographic hash of the NAR serialisation of a path log show the build log of the specified packages or paths, if available ls-nar show information about the contents of a NAR file ls-store show information about a store path optimise-store replace identical files in the store by hard links path-info query information about store paths ping-store test whether a store can be opened repl start an interactive environment for evaluating Nix expressions run run a shell in which the specified packages are available search query available packages show-config show the Nix configuration show-derivation show the contents of a store derivation sign-paths sign the specified paths to-base16 convert a hash to base-16 representation to-base32 convert a hash to base-32 representation to-base64 convert a hash to base-64 representation to-sri convert a hash to SRI representation upgrade-nix upgrade Nix to the latest stable version verify verify the integrity of store paths why-depends show why a package has another package in its closure Note: this program is EXPERIMENTAL and subject to change.   å®‰è£… nix-darwin:\n1 2  nix-build https://github.com/LnL7/nix-darwin/archive/master.tar.gz -A installer ./result/bin/darwin-installer     é…ç½®ï¼š /Users/simon/.nixpkgs/darwin-configuration.nix\n{ config, pkgs, ... }: { # List packages installed in system profile. To search by name, run: $ nix-env -qaP | grep wget environment.systemPackages = [ pkgs.vim ]; # Use a custom configuration.nix location. $ darwin-rebuild switch -I # darwin-config=$HOME/.config/nixpkgs/darwin/configuration.nix environment.darwinConfig = # \u0026#34;$HOME/.config/nixpkgs/darwin/configuration.nix\u0026#34;; # Auto upgrade nix package and the daemon service. services.nix-daemon.enable = true; # nix.package = pkgs.nix; # Create /etc/bashrc that loads the nix-darwin environment. programs.zsh.enable = true; # default shell on catalina # programs.fish.enable = true; # Used for backwards compatibility, please read the changelog before changing. $ darwin-rebuild # changelog system.stateVersion = 4; }   é…ç½®æ–‡ä»¶æ¯æ¬¡ä¿®æ”¹ä¹‹åè¦æ‰§è¡Œ darwin-rebuild switch ç”Ÿæ•ˆã€‚\n æ›´æ–°åŒ…: nix-channel --update\n  awesome tools   https://github.com/jaywcjlove/awesome-mac/blob/master/README-zh.md\n example:\n1 2  \u0026lt;div id=\u0026#34;test\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;script src=\u0026#34;/path/to/test.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt;    Share VPN   Parallel Desktop - Ubuntu share the VPN of host computer.\n Ubuntu -\u0026gt; è®¾ç½® -\u0026gt; ç½‘ç»œ -\u0026gt; VPN: Network Proxy, ç½‘ç»œä»£ç†ï¼š\n http/https, socks proxy:\n IP: å®¿ä¸»æœºçš„ IPï¼Œæ¨èé…ç½®æˆé™æ€IPã€‚\n PORT: ä»£ç†å·¥å…·çš„ç«¯å£å·ï¼Œæ¯”å¦‚ï¼š clashX çš„ 7890/7891\n å®Œäº†ä¹‹åè¿˜è¦åœ¨ä»£ç å·¥å…·é‚£å…è®¸ä¸‹å±€åŸŸç½‘è¿æ¥ï¼š\n   çª—å£ç®¡ç†        ubuntu  ä¿®æ”¹å®¶ç›®å½•å’Œä¸»æœºå   å‡è®¾å½“å‰åå­—ä¸º parallels (å®‰è£…è™šæ‹Ÿæœºçš„æ—¶å€™é»˜è®¤æ˜¯è¿™ä¸ª), å°†åŸºä¿®æ”¹ä¸ºï¼š simon\n  $ su , åˆ‡æ¢ root\n  $ passwd \u0026lt;user\u0026gt;, ä¿®æ”¹å¯†ç \n  $ reboot, é‡å¯\n  $ su\n  $ vim /etc/passwd, æ‰¾åˆ° parallels é‚£ä¸€è¡Œï¼Œ åªä¿®æ”¹ç”¨æˆ·åä¸º simonï¼Œå…¶å®ƒä¸è¦åŠ¨\n  $ vim /etc/shadow, æ‰¾åˆ° parallels é‚£ä¸€è¡Œï¼ŒåŒæ ·åªä¿®æ”¹ç”¨æˆ·åä¸º simon\n  $ vim /etc/group, æ‰¾åˆ°æ‰€æœ‰çš„ parallels, ä½¿ç”¨ :%s/parallels/simon/g å…¨å±€æ›¿æ¢\n  $ reboot, é‡å¯\n  $ vim /etc/hostname ä¿®æ”¹æˆæƒ³è¦çš„ä¸»æœºå\n  $ vim /etc/passwd æ‰¾åˆ° simon é‚£ä¸€è¡Œ(è¿™é‡Œç”¨æˆ·åå·²ç»ç»è¿‡ä¸Šé¢çš„ä¿®æ”¹æˆäº† simon)ï¼Œ ä¿®æ”¹ç›®å½•å\n  $ cd /home\n  $ mv parallels simon, ä¿®æ”¹å®¶ç›®å½•åå­—\n  $ reboot, OK.\n   å¯èƒ½çš„é—®é¢˜ï¼ˆæˆ‘æ²¡é‡åˆ°ï¼‰ï¼šä¿®æ”¹ä¸»ç›®å½•åæ—¶å€™ï¼Œåªä¿®æ”¹äº† /etc/password è€Œæ²¡æœ‰ç»™ /home/parallels é‡å‘½åï¼Œå¯¼è‡´å¼€æœºåä¸€ç›´ç™»é™†è›¤é¢å¾ªç¯ã€‚\n è§£ ï¼š Ctrl+Alt+[F1~F6] ç™»é™†åç›´æ¥ä¿®æ”¹ /home/parallels, é‡å¯ã€‚\n Ctrl+Alt+F7 è¿›å…¥å›¾å½¢æ¨¡å¼ã€‚\n    ","permalink":"https://www.cheng92.com/post/macos/","tags":["macos"],"title":"My MacOS"},{"categories":["vue"],"contents":" è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬æ–‡ä»æºç è§’åº¦è®²è§£äº†vueä¸­çš„äº‹ä»¶æ³¨å†Œæœºåˆ¶(v-on æŒ‡ä»¤)ã€‚\n  è¯¥æ–‡åˆ†æçš„ç›¸å…³ä»£ç åœ¨ packages/runtime-dom åŒ…ä¸­ï¼Œä¸»è¦é’ˆå¯¹ v-on çš„äº‹ä»¶æ³¨å†Œæœºåˆ¶åŸç† è¿›è¡Œåˆ†æä¸€ç¯‡æ–‡ç« ï¼Œç›¸å…³ä»£ç å¹¶ä¸å¤šï¼Œç†è§£èµ·æ¥ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆå›°éš¾ã€‚\n props å±æ€§ patch å…¥å£ï¼š runtime-dom/src/patchProp.ts\n é’ˆå¯¹ v-on å¤„ç†çš„ä»£ç åˆ†æ”¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  export const patchProp: DOMRendererOptions[\u0026#39;patchProp\u0026#39;] = ( el, key, prevValue, nextValue, isSVG = false, prevChildren, parentComponent, parentSuspense, unmountChildren ) =\u0026gt; { switch (key) { // ... class, style å±æ€§çš„å¤„ç†ï¼Œä¸»è¦æ˜¯è¿›è¡Œåˆå¹¶æ“ä½œ  default: if (isOn(key)) { // ignore v-model listeners  // v-on äº‹ä»¶å±æ€§å¤„ç†é€»è¾‘  if (!isModelListener(key)) { patchEvent(el, key, prevValue, nextValue, parentComponent) } } else if (shouldSetAsProp(el, key, nextValue, isSVG)) { // ... dom åŸç”Ÿå±æ€§å¤„ç†  } else { // ...  } break } }     æ‰€ä»¥é‡ç‚¹ä»£ç åœ¨\n patchEvent(el, key, prevValue, nextValue, parentComponent)\n ä¹Ÿå°±æ˜¯ runtime-dom/src/modules/events.ts ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  export function patchEvent( el: Element \u0026amp; { _vei?: Record\u0026lt;string, Invoker | undefined\u0026gt; }, rawName: string, prevValue: EventValue | null, nextValue: EventValue | null, instance: ComponentInternalInstance | null = null ) { // vei = vue event invokers  const invokers = el._vei || (el._vei = {}) const existingInvoker = invokers[rawName] if (nextValue \u0026amp;\u0026amp; existingInvoker) { // patch  existingInvoker.value = nextValue } else { const [name, options] = parseName(rawName) if (nextValue) { // add  const invoker = (invokers[rawName] = createInvoker(nextValue, instance)) addEventListener(el, name, invoker, options) } else if (existingInvoker) { // remove  removeEventListener(el, name, existingInvoker, options) invokers[rawName] = undefined } } }     å¯ä»¥çœ‹åˆ°è¿™é‡Œå®ç°æ˜¯ä¸€ç§ç‰¹æ®Šå¤„ç†æ–¹å¼ï¼Œè€Œä¸æ˜¯ç®€å•çš„ç›´æ¥è°ƒç”¨ addEventListener å’Œ removeEventListener ç›´æ¥å°†æ‰€æœ‰äº‹ä»¶å¥æŸ„æ³¨å†Œåˆ° element ä¸Šã€‚\n1 2  const invokers = el._vei || (el._vei = {}) const existingInvoker = invokers[rawName]     el._vei =\u0026gt; vue event invokers\n å‚æ•°è¯´æ˜ï¼š\n   name desc     el äº‹ä»¶çš„ç›®æ ‡å…ƒç´    rawName äº‹ä»¶åç§°   prevValue ç»‘å®šåœ¨ el ä¸Š rawName å¯¹åº”äº‹ä»¶çš„è€å¥æŸ„   nextValue ç»‘å®šåœ¨ el ä¸Š rawName å¯¹åº”äº‹ä»¶çš„æ–°å¥æŸ„   instance å½“å‰ç»„ä»¶çš„å®ä¾‹     å‚æ•°é‡ç‚¹åœ¨äº prevValue \u0026amp; nextValue è¿™ä¸¤ä¸ªåˆ†åˆ«å¯¹åº”äº†äº‹ä»¶çš„å¤„ç†æ–°æ—§å‡½æ•°ã€‚\n å¯¹äºæ‰€æœ‰çš„ prevValue \u0026amp; nextValue å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°éƒ½ä¸ä¼šæ˜¯ç›´æ¥è¢«æ³¨å†Œï¼Œè€Œæ˜¯ä¼šè¢« å°è£…æˆä¸€ä¸ª Invoker å½¢å¼å­˜åœ¨ã€‚\n è€Œ Invoker æ¥è‡ª createInvoker(nextValue):\n ä¸€ä¸ªäºŒæ¬¡å°è£…å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  function createInvoker( initialValue: EventValue, instance: ComponentInternalInstance | null ) { const invoker: Invoker = (e: Event) =\u0026gt; { // async edge case #6566: inner click event triggers patch, event handler  // attached to outer element during patch, and triggered again. This  // happens because browsers fire microtask ticks between event propagation.  // the solution is simple: we save the timestamp when a handler is attached,  // and the handler would only fire if the event passed to it was fired  // AFTER it was attached.  const timeStamp = e.timeStamp || _getNow() if (timeStamp \u0026gt;= invoker.attached - 1) { callWithAsyncErrorHandling( patchStopImmediatePropagation(e, invoker.value), instance, ErrorCodes.NATIVE_EVENT_HANDLER, [e] ) } } invoker.value = initialValue invoker.attached = getNow() return invoker }     è¿”å›ä¸€ä¸ª\n1 2 3 4  interface Invoker extends EventListener { value: EventValue attached: number }     å°è£…è¿‡ç¨‹é‡ç‚¹åšäº†å‡ ä»¶äº‹æƒ…ï¼š\n  invoker é‡Œé¢ callWithAsyncErrorHandling() æ–¹å¼æ‰§è¡Œäº†äº‹ä»¶å¥æŸ„å‡½æ•°\n æ‹¦æˆªäº‹ä»¶å¤„ç†å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­å·®ç”Ÿçš„é”™è¯¯å¼‚å¸¸ï¼Œè¿™äº›å¼‚å¸¸å¯ä»¥é€šè¿‡ vue çš„å…¨å±€é…ç½®æ¥æ• è·ï¼š\n1 2 3 4  const instance = createApp(App) instance.config.errorHandler = function(err, vm, info) { // å¤„ç†é”™è¯¯å¼‚å¸¸ }      æ‰§è¡Œå‰ææ˜¯ timeStamp \u0026gt;= invoker.attached - 1\n æ³¨é‡Šå†…å®¹ï¼š\n async edge case #6566: inner click event triggers patch, event handler attached to outer element during patch, and triggered again. This happens because browsers fire microtask ticks between event propagation. the solution is simple: we save the timestamp when a handler is attached, and the handler would only fire if the event passed to it was fired AFTER it was attached.\n  ä¸ªäººç¿»è¯‘ç†è§£ï¼š äº‹ä»¶æ³¨å†ŒæœŸé—´ä¼šåŒæ—¶æ³¨å†Œåˆ° outer element ä¸Šï¼Œè¿™æ˜¯å› ä¸ºæµè§ˆå™¨ä¼šåœ¨ äº‹ä»¶å†’æ³¡æœŸé—´è§¦å‘å¾®ä»»åŠ¡ ticksï¼Œä»è€Œå¯¼è‡´ä¼šè¢«é‡å¤è§¦å‘äº‹ä»¶ã€‚\n è§£å†³æ–¹æ¡ˆå°±æ˜¯è®°å½•äº‹ä»¶æ³¨å†Œå®Œæˆæ—¶çš„æ—¶é—´æˆ³ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™æ£€æµ‹æ˜¯ä¸æ˜¯è¿‡äº†è¯¥æ—¶é—´ï¼Œåª æœ‰è¿‡äº†è¯¥æ—¶é—´è§¦å‘çš„æ‰ä¼šå»æ‰§è¡Œã€‚\n  è®°å½•æ—¶é—´æˆ³\n1 2  invoker.value = initialValue invoker.attached = getNow()      TIP\n æ³¨æ„åœ¨ invoker å‡½æ•°ä¸­æœ‰ä¸ªç‰¹æ®Šæ­¥éª¤ï¼š\n patchStopImmediatePropagation(e, invoker.value) è¿™æ˜¯åšä»€ä¹ˆçš„ï¼Ÿï¼Ÿï¼Ÿ\n ç¨åå†è®²~~\n  å›å¤´åœ¨çœ‹ patchProp()\n el._vei ä¸Šä¿å­˜äº†æ‰€æœ‰çš„ \u0026lt;eventName, fns\u0026gt; äº‹ä»¶å’Œäº‹ä»¶å¥æŸ„çš„æ˜ å°„å…³ç³»ã€‚\n å½“å‘ç°æ–°äº‹ä»¶æ¥åˆ°æ—¶ï¼Œé¦–å…ˆæ£€æµ‹çš„æ˜¯å½“å‰äº‹ä»¶åæ˜¯ä¸æ˜¯æ›¾ç»æ³¨å†Œè¿‡äº‹ä»¶å¥æŸ„ï¼Œå¦‚æœæ³¨å†Œè¿‡å°± ç»§ç»­å¤ç”¨å¹¶ä¸”ç›´æ¥è¦†ç›–ä¹‹å‰çš„æ³¨å†Œçš„äº‹ä»¶å¥æŸ„:\n1 2 3 4  if (nextValue \u0026amp;\u0026amp; existingInvoker) { // patch  existingInvoker.value = nextValue }     ä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„è¦†ç›–å¹¶éæ˜¯ç›´æ¥å°±å°† element ä¸Šçš„ listener åˆ é™¤äº†å†èµ‹å€¼ (addEventListener)çš„æ“ä½œã€‚\nWARNING\n æ—¶åˆ»æ³¨æ„ï¼Œç»‘å®šåˆ° element ä¸Šçš„ event listener æ°¸è¿œéƒ½æ˜¯ä¸€ä¸ª Invokerï¼Œä¸”ä¸€æ—¦ç¬¬ä¸€æ¬¡ æ³¨å†Œäº†ä¹‹åè¿™ä¸ª Invoker å°±ä¼šä¸€ç›´ä½œä¸ºè¯¥ element ä¸Š event name å¯¹åº”çš„ event listener å­˜åœ¨ã€‚ä¹‹åçš„æ‰€æœ‰å˜æ›´éƒ½æ˜¯å‘ç”Ÿåœ¨å°è£…ä¹‹åçš„ Invoker ä¸Šçš„ï¼Œå¦‚ä¸Šé¢çš„èµ‹å€¼æ“ä½œï¼Œæ”¹å˜çš„ åªæ˜¯ invoker.value ã€‚\n  è€Œå¯¹äºè¿™ä¸ª value å€¼æ˜¯ä¸ª type EventValue = Function | Function[] ç±»å‹ï¼Œè¿™ä¸ªå€¼ çš„å¤„ç†å‘ç”Ÿåœ¨ compiler-core å’Œ compiler-dom é˜¶æ®µçš„ vOn.ts ä¸­ï¼Œè¿™é‡Œå°±ä¸å¤šåšèµ˜è¿°äº†ï¼Œ æœ‰å…´è¶£çš„å¯ä»¥é€šè¿‡é“¾æ¥æŸ¥çœ‹ä¹‹å‰ç›¸å…³çš„åˆ†æ(compiler-core é‡ç‚¹åœ¨äºæ¨¡æŒ‡ä»¤çš„è§£æï¼Œ compiler-dom é˜¶æ®µé‡ç‚¹åœ¨äºä¿®é¥°ç¬¦çš„å¤„ç†ä¸Š)ã€‚\n ç»§ç»­çœ‹ patchEvent :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  if (nextValue \u0026amp;\u0026amp; existingInvoker) { // patch  existingInvoker.value = nextValue } else { const [name, options] = parseName(rawName) if (nextValue) { // add  const invoker = (invokers[rawName] = createInvoker(nextValue, instance)) addEventListener(el, name, invoker, options) } else if (existingInvoker) { // remove  removeEventListener(el, name, existingInvoker, options) invokers[rawName] = undefined } }     ä¸¤ä¸ª ifâ€¦elseï¼Œè¿™æ®µä»£ç å¾ˆå®¹æ˜“ç†è§£ä¸æ˜¯ï¼ï¼ï¼\n éœ€è¦æ³¨æ„çš„æ˜¯æœ€åçš„ä¸€ä¸ª else if (existingInvoker) åˆ°è¿™é‡Œçš„æ—¶å€™ä¼šå°†äº‹ä»¶å¥æŸ„ç»™ç§» é™¤ã€‚\n æ¯”å¦‚ï¼š\n \u0026lt;div @click=\u0026#34;null\u0026#34; /\u0026gt; \u0026lt;div @click=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;div @click=\u0026#34;false\u0026#34; /\u0026gt;\n ç­‰ç­‰ï¼Œäº‹ä»¶å¥æŸ„æ˜¯ä¸€äº›ç©ºå€¼çš„æ—¶å€™ä¼šå½“ä½œæ˜¯ç§»é™¤æ“ä½œã€‚\n é‚£ä¹ˆåˆ°è¿™é‡ŒåŸºæœ¬ä¹Ÿå®Œæˆäº†äº‹ä»¶çš„ã€å°è£…-æ³¨å†Œ-ç§»é™¤ã€éƒ¨åˆ†ä»£ç ã€‚\n  å°è£…ï¼š Invoker è®°å½• attach æ—¶é—´æˆ³é˜²æ­¢é‡å¤è§¦å‘ï¼Œæ•è·å¼‚å¸¸\n  æ³¨å†Œï¼šä¸€ä¸ªäº‹ä»¶ååªä¼šæ³¨å†Œä¸€ä¸ª Invoker åç»­æ“ä½œéƒ½æ˜¯é’ˆå¯¹è¿™ä¸ª invoker è€Œè¨€\n  ç§»é™¤ï¼šä½¿ç”¨ v-on æœ€åè§£æå¾—åˆ°çš„å€¼å¦‚æœæ˜¯ç©ºå€¼æ—¶ä¼šè¢«è§†ä¸ºç§»é™¤æ“ä½œ\n  é‚£ä¹ˆä¹‹å‰è¯´åˆ°çš„ patchStopImmediatePropagation(e, invoker.value) åˆæ˜¯ä»€ä¹ˆæ“ä½œï¼Ÿ\n å¯¹äºåŸç”Ÿçš„äº‹ä»¶æœ‰ä¸ªåŸç”Ÿçš„å‡½æ•° event.stopImmediatePropagation() è¿™ä¸ªå‡½æ•°çš„å«ä¹‰ï¼š å®ƒå¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªäº‹ä»¶å¥æŸ„å‡½æ•°ä¸­è°ƒç”¨ï¼Œæ¥é˜»æ­¢åé¢çš„äº‹ä»¶è¢«è°ƒç”¨ã€‚\n æ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const a = () =\u0026gt; { // log a } const b = (e) =\u0026gt; { // log b  e.stopImmediatePropagation() } const c = () =\u0026gt; { // log c } const d = () =\u0026gt; { // log d } el.addEventListener(\u0026#39;click\u0026#39;, a) el.addEventListener(\u0026#39;click\u0026#39;, b) el.addEventListener(\u0026#39;click\u0026#39;, c) el.addEventListener(\u0026#39;click\u0026#39;, d) // å®Œäº†ä¹‹åè§¦å‘ click ä¼šå¾—åˆ°ç»“æœ // log a // log b  // c/d ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™å°±æ˜¯ stopImmediatePropagation çš„ä½œç”¨ã€‚      å› æ­¤ vue events.ts ä¸­çš„ patchStopImmediatePropagation(e: Event, value: EventValue) å°±æ˜¯ä¸ºäº†æ¨¡æ‹Ÿè¿™ä¸ªä½œç”¨ï¼Œæ¥è®©è¿™ä¸ªåŸç”ŸåŠŸèƒ½ç”Ÿæ•ˆï¼Œå› ä¸º events.ts ä¸­å¯¹äº‹ä»¶ çš„ç»‘å®šä¸Šé¢è¯´è¿‡äº†ï¼Œé’ˆå¯¹elementä¸ŠåŒä¸€äº‹ä»¶åçš„äº‹ä»¶åªä¼šæœ‰ä¸€ä¸ªå¥æŸ„ Invoker å‡½æ•°ï¼Œæ‰€ä»¥ åŸç”Ÿçš„ stopImmediatePropagation åŠŸèƒ½å°±ä¼šå¤±æ•ˆã€‚\n åŠŸèƒ½æ¨¡æ‹Ÿï¼šåªæœ‰ invoker.value æ˜¯ä¸ªæ•°ç»„æ—¶æ‰ä¼šç”Ÿæ•ˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function patchStopImmediatePropagation( e: Event, value: EventValue ): EventValue { if (isArray(value)) { const originalStop = e.stopImmediatePropagation e.stopImmediatePropagation = () =\u0026gt; { originalStop.call(e) ;(e as any)._stopped = true } return value.map(fn =\u0026gt; (e: Event) =\u0026gt; !(e as any)._stopped \u0026amp;\u0026amp; fn(e)) } else { return value } }     å…¶å®å°±æ˜¯é‡å†™äº† e.stopImmediatePropagation ç»™äº‹ä»¶æ³¨å†Œä¸€ä¸ª _stopped å±æ€§ï¼Œç„¶åå°† value ä¸­æ‰€æœ‰çš„ fn è¿›ä¸€æ­¥è¿›è¡Œå°è£…è¿”å›ä¸€ä¸ªå…¨æ–°çš„ fn:\n (e: Event) =\u0026gt; !(e as any)._stopped \u0026amp;\u0026amp; fn(e)\n é€šè¿‡æ£€æµ‹ _stoppped æ ‡è®°æ¥è¾¾åˆ°é˜»æ­¢åç»­å‡½æ•°çš„æ‰§è¡Œçš„ç›®çš„ã€‚\n æœ€åï¼Œè¿™é‡Œè¿˜æœ‰ä¸ªé’ˆå¯¹ä¸‰ä¸ªä¿®é¥°ç¬¦çš„å¤„ç†(/(?:Once|Passive|Capture)$/)ï¼Œå› ä¸ºåœ¨ compiler-dom é˜¶æ®µï¼Œè¿™ä¸‰ä¸ªä¿®é¥°ç¬¦ä¼šè¢«å•ç‹¬è§£æï¼Œæ¯”å¦‚ï¼š\n \u0026lt;div @click.once=.../\u0026gt;\n æœ€åè¢«è§£ææˆ onClickOnce ä¾æ­¤ç±»æ¨ï¼š onClickPassive, onClickCapture æ‰€ä»¥è¿™ é‡Œè¦è¿›è¡Œæ‹†åˆ†ä¸€ä¸‹ï¼Œç­‰äºæ˜¯æ‹†åˆ†å‡ºï¼š\n {once: true, passive: true, capture: true} çš„ç»“æ„ã€‚\n æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const optionsModifierRE = /(?:Once|Passive|Capture)$/ function parseName(name: string): [string, EventListenerOptions | undefined] { let options: EventListenerOptions | undefined if (optionsModifierRE.test(name)) { options = {} let m while ((m = name.match(optionsModifierRE))) { name = name.slice(0, name.length - m[0].length) ;(options as any)[m[0].toLowerCase()] = true options } } // return [name.slice(2).toLowerCase(), options]  // #b302cbb, fooBar -\u0026gt; foo-bar  return [hyphenate(name.slice(2)), options] }    WARNING\n *å°ç»“*ï¼š\n æœ‰ç‚¹æ¹Šç¯‡å¹…çš„å«Œç–‘ ğŸ˜ª\n å†…å®¹å…¶å®å¾ˆç®€å•ï¼Œå››ä¸ªå‡½æ•°ï¼Œä¸¤æ¬¡å°è£…ã€‚\n  createInvoker å°è£…äº‹ä»¶å¥æŸ„å‡½æ•° Invoker\n  patchEvent æ£€æµ‹ el._vei æ³¨å†Œ invoker.value\n  patchStopImmediatePropagation é€šè¿‡æ·»åŠ  event._stopped æ¨¡æ‹ŸåŸç”ŸåŠŸèƒ½ï¼Œæ‹¦æˆªåé¢ çš„å‡½æ•°æ‰§è¡Œ\n  parseName ä¸‰ä¸ªä¿®é¥°ç¬¦çš„å¤„ç†å·¥ä½œ once/passive/capture\n   ","permalink":"https://www.cheng92.com/vue/vue-teardown-6-event-listen/","tags":["vue3,","vue-next,","component,","directives"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘¥ directives äº‹ä»¶ç»‘å®šæœºåˆ¶"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md\nå‰è¨€  TIP\n æœ¬ç³»åˆ—æ–‡è¯´æ˜ï¼šä¼šä¸å®šæœŸçš„æ›´æ–°æœ¬åœ°çš„ vue-next ä»“åº“ï¼Œæœ¬ç³»åˆ—æ–‡ç« åˆ™æ˜¯é’ˆå¯¹ git pull å çš„æ›´æ–°å†…å®¹çš„åˆ†æå’Œè®°å½•ï¼Œ ã€‚\n å¯å‚è¿‡é“¾æ¥è·³è½¬åˆ°å¯¹åº”çš„åˆ†ææ–‡ç« \n  æ›´æ–°å†…å®¹ï¼š\n å¾ˆä¹…æ²¡æ›´æ–°äº†ï¼Œæƒ¨~~~~~~~~~\n æ¡ç‚¹é‡è¦çš„æ¥çœ‹ä¸‹å§ï¼Œä»¥åè¿˜æ˜¯è¦ä¿æŒæ¯å‘¨æ‹‰ä¸€æ¬¡ä»£ç æ¯”è¾ƒå¥½ï¼ï¼ï¼\n æœ€åˆåˆ†ææ‹‰å–çš„ä»£ç æ˜¯ï¼š 3.0.4, ç°åœ¨éƒ½ 3.1.2 äº† å°´å°¬ï¼ï¼!\n  3.0.8 (2021-03-26)  Important    IMP: SFC style ä¸­çš„ ::v-slotted å’Œ :slotted ğŸ”— \n    TODO Bug Fixes [0/44]   compiler: properly bail stringfication for nested slot elements (f74b16c)\n compiler-core: allow unicode to appear in identifiers (#3443) (ebedccc), closes #3440\n compiler-core: avoid generating useless createVNode helper (#2938) (7715c49), closes #2739\n compiler-core: detect v-if branch root with comment as dev fragment (#2785) (4bf7ba1), closes #2780\n compiler-core: fix the detection of forwarded slots with v-if or v-for (#3353) (602b58e), closes #3347\n compiler-core: should not condense whitespace in RCDATA text mode (#3482) (b4b8215), closes #3479\n compiler-dom: stringifyStatic should remove attribute bindings with null value (#3477) (ca6aa01), closes #3475\n compiler-sfc: scope Id should not be attached to @keyframe breakpoint rules (#3308) (6cb9475), closes #3304\n compiler-sfc: should not rewrite scope variable (#3449) (bbc5fe6), closes #3445\n compiler-ssr: keep the order of imports expression for the fallback branch of SSR (#3448) (49f4072), closes #3447\n component: prioritize registered component over implicit self-reference via filename (abd129d), closes #2827\n hydration: handle camel-case tag name when performing match assertion (#3247) (9036f88), closes #3243\n KeepAlive: adapt keepalive for ssr (#3259) (e8e9b00), closes #3255\n reactivity: ensure computed can be wrapped by readonly (41e02f0), closes #3376\n reactivity: ensure that shallow and normal proxies are tracked seperately (close #2843) (#2851) (22cc4a7)\n reactivity: fix shallow readonly behavior for collections (#3003) (68de9f4), closes #3007\n rumtime-core: custom dom props should be cloned when cloning a hoisted DOM (#3080) (5dbe834), closes #3072\n runtime-core: cache props default values to avoid unnecessary watcher trigger (#3474) (44166b4), closes #3471\n runtime-core: ensure only skip unflushed job (#3406) (bf34e33)\n runtime-core: fix async component ref handling (#3191) (7562e72), closes #3188\n runtime-core: fix erraneous emits warnings w/ mixins (60d777d), closes #2651\n runtime-core: fix warning for absent props (#3363) (86ceef4), closes #3362\n runtime-core: handle error in async setup (#2881) (d668d48)\n runtime-core: handle error in async watchEffect (#3129) (eb1fae6)\n runtime-core: should call chained mixins and extends (#3040) (b58bb16), closes #3038\n runtime-core: should not cache property access during data() invocation (#3299) (6e88156), closes #3297\n runtime-core: should not track deps in pre flush watcher callbacks (d5824b9), closes #2728\n runtime-core: the select tag\u0026#39;s multiple prop should be set before the children mounting (#3202) (2451dd8), closes #3199\n runtime-dom: support mounting app to svg container (#2929) (8ffcde2), closes #2926\n ssr: ensure async setup error handling work with suspense during ssr (2e71f07)\n ssr: fix memory leak when vnode component render throws error (da944cb), closes #3100\n ssr: properly update currentRenderingInstance state during ssr (8c3c14a), closes #2863\n ssr: respect render function from extends/mixins in ssr (#3006) (0a583d5), closes #3004\n ssr: watchEffect onInvalidate runner initialization (#3323) (e4b5fcc), closes #3322\n ssr/hydration: handle ending empty text node (#3246) (420c8f4), closes #3245\n teleport: targetAnchor should also be removed when unmounted (#2870) (21d1288)\n Teleport: component with multi roots should be removed when unmounted (#3157) (7769513), closes #3156\n Teleport: fallback to non-optimized mode when HRM performing updates (#3311) (9cb21d0), closes #3302\n transition: toggling branches with in-out mode should be transitioned correctly (#3109) (67a0290), closes #3104\n types: allow style to be an array in JSX (#2947) (13c9d2c)\n types: union function prop (#3119) (3755e60), closes #3357\n types: unwrap refs on public instance data (#3319) (2b588cf), closes #3315\n types/jsx: llow tabindex to be a string (#3476) (e4a5712)\n add display name for suspense component (#3312) (3b3a9a1)\n    DONE Performance Improvements [1/1]  CLOSED: [2021-08-09 Mon 21:23]\n support only attaching slot scope ids when necessary (02cbbb7) \n SFC style ä¸­ä½¿ç”¨\n :slotted(h1) { color: blue; }\n æˆ–\n ::v-slotted(h1) { color: blue; }\n å¯ä»¥åœ¨å½“å‰ç»„ä»¶ä¸­æ§åˆ¶ slot ç»„ä»¶çš„æ ·å¼ã€‚\n https://codesandbox.io/s/damp-cdn-k9eed?file=/src/main.js\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const url = process.env.VNEXT_PKG_RC + \u0026#34;/../compiler-sfc/dist/compiler-sfc.cjs.js\u0026#34;; const value = require(url.replace(\u0026#34;stb-\u0026#34;, \u0026#34;\u0026#34;)); const { compileScript, parse, compileStyle } = value; function compileScoped(source, options) { const res = compileStyle({ source, filename: \u0026#39;test.css\u0026#39;, id: \u0026#39;data-v-test\u0026#39;, scoped: true, ...options }) return res.code } const src = `::v-slotted(h1) { color: red; } :slotted(h1) {font-size:12px;}` const code = compileScoped(src) console.log(code) return 0;    h1[data-v-test-s] { color: red; } h1[data-v-test-s] {font-size:12px;} 0   ä¸‹é¢ä¼šæ£€æŸ¥ style ä¸­æ˜¯ä¸æ˜¯å« ::v-slotted(...) {...} æˆ– :slotted(...) {..} æŒ‡ä»¤\n1 2 3 4  // packages/compiler-sfc/src/parse.ts // check if the SFC uses :slotted const slottedRE = /(?:::v-|:)slotted\\(/ descriptor.slotted = descriptor.styles.some(s =\u0026gt; slottedRE.test(s.content))     æ ¹æ®ä¸Šé¢çš„ç»“æœï¼Œåœ¨ parse SFC template é˜¶æ®µç»™ç»„ä»¶åŠ ä¸Š scope-id-s å±æ€§ï¼Œ å¦‚ï¼š\n \u0026lt;div scope-id-s /\u0026gt;\n1 2 3 4 5  // packages/compiler-ssr/src/transforms/ssrTransformSlotOutlet.ts // inject slot scope id if current template uses :slotted if (context.scopeId \u0026amp;\u0026amp; context.slotted !== false) { args.push(`\u0026#34;${context.scopeId}-s\u0026#34;`) }          3.0.7 (2021-08-08)  Important    FIX: \u0026lt;script setup\u0026gt; ä¸­ export default å’Œ class è¯­æ³• ğŸ”—\n  FIX: v-show çš„ä¼˜å…ˆçº§æ¯” {style: { display: \u0026#39;block\u0026#39; }} æ›´é«˜ ğŸ”—\n  FIX: scheduler ä¸­ ç»„ä»¶æ›´æ–°ä»»åŠ¡æ€»æ˜¯ä¿æŒä»¥ job.id çš„å¢åºæ‰§è¡Œï¼Œåœ¨æ’å…¥çš„æ—¶å€™æ‰¾åˆ° å¯¹åº”çš„ç´¢å¼•æ’å…¥ ğŸ”— \n    DONE Bug Fixes [6/6]  CLOSED: [2021-08-09 Mon 15:23]\n âœ… compiler-sfc: handle more edge cases in default rewrite (1dedc19) \n å¤„ç† setup script ä¸­æ›´å¤šè¯­æ³•æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const url = process.env.VNEXT_PKG_RC + \u0026#34;/../compiler-sfc/dist/compiler-sfc.cjs.js\u0026#34;; const value = require(url.replace(\u0026#34;stb-\u0026#34;, \u0026#34;\u0026#34;)); const { rewriteDefault } = value; const test = (hint, code) =\u0026gt; { console.log(\u0026#39;\u0026gt; \u0026#39; + hint + \u0026#39;\\n\u0026#39;); console.log(rewriteDefault(code, \u0026#39;script\u0026#39;)) } test(\u0026#39;1. comments\u0026#39;, `// export default\\nexport default {}`) test(\u0026#39;2. export default class\u0026#39;, `export default class Foo {}`) test(\u0026#39;3. export default class + commons\u0026#39;, `// export default\\nexport default class Foo {}`) test(\u0026#39;4. export default class + comments 2\u0026#39;, `export default {}\\n` + `// export default class Foo {}`) test(\u0026#39;5. export default class + comments 3\u0026#39;, `/*\\nexport default class Foo {}*/\\n` + `export default class Bar {}`) console.log(\u0026#39;------ end ------ \u0026#39;); return 0;    \u0026gt; 1. comments // export default const script = {} \u0026gt; 2. export default class class Foo {} const script = Foo \u0026gt; 3. export default class + commons // export default class Foo {} const script = Foo \u0026gt; 4. export default class + comments 2 const script = {} // export default class Foo {} \u0026gt; 5. export default class + comments 3 /* export default class Foo {}*/ const script = class Bar {} ------ end ------ 0   âœ… deps: pin Rollup to 2.38 (34f354b), closes #3332\n âœ… runtime-core: properties in methods should be writable and enumerable in DEV (#3301) (e3568ba), closes #3300\n1 2 3 4 5 6 7 8 9 10 11  3 packages/runtime-core/src/componentOptions.ts @@ -610,7 +610,8 @@ export function applyOptions(  Object.defineProperty(ctx, key, { value: methodHandler.bind(publicThis), configurable: true, - enumerable: false + enumerable: true, + writable: true  }) } else { ctx[key] = methodHandler.bind(publicThis)      âœ… scheduler: ensure updates are always inserted in ascending id order (#3184) (45fae9d), closes #2768 #2829 \n View isn\u0026#39;t updated in a weird case (combination of many factors, transition, injection \u0026amp; computed)\n ç¡®ä¿ updates æ€»æ˜¯ä»¥å‡åºè¢«æ’å…¥ï¼Œé‚£ä¹ˆåœ¨æ’å…¥ä¹‹å‰å°±å¾—æ‰¾åˆ°é€‚å½“çš„ job ç´¢å¼•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // #2768 // Use binary-search to find a suitable position in the queue, // so that the queue maintains the increasing order of job\u0026#39;s id, // which can prevent the job from being skipped and also can avoid repeated patching. function findInsertionIndex(job: SchedulerJob) { // the start index should be `flushIndex + 1` let start = flushIndex + 1 let end = queue.length const jobId = getId(job) while (start \u0026lt; end) { const middle = (start + end) \u0026gt;\u0026gt;\u0026gt; 1 const middleJobId = getId(queue[middle]) middleJobId \u0026lt; jobId ? (start = middle + 1) : (end = middle) } return start }     åœ¨ update è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—çš„æ—¶å€™ä¿è¯æ‰€æœ‰ jobs æ˜¯ä»¥å‡åºæ’åˆ—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  export function queueJob(job: SchedulerJob) { // the dedupe search uses the startIndex argument of Array.includes() // by default the search index includes the current job that is being run @@ -72,7 +91,12 @@ export function queueJob(job: SchedulerJob) {  )) \u0026amp;\u0026amp; job !== currentPreFlushParentJob ) { - queue.push(job) + const pos = findInsertionIndex(job) + if (pos \u0026gt; -1) { + queue.splice(pos, 0, job) + } else { + queue.push(job) + }  queueFlush() } }      âœ… v-show: v-show takes higher priority than style attribute (#3230) (5ad4036), closes #2757 \nv-show ä¹Ÿæ˜¯é€šè¿‡ el.style.display æ¥å®ç°çš„ï¼Œè¿™é‡Œæ„æ€æ˜¯å¦‚æœ style å±æ€§ä¸­ä¹Ÿæœ‰ display çš„è¯ï¼Œåœ¨ runtime-dom/src/modules/style.ts ä¸­ patch çš„æ—¶å€™åº”è¯¥ v-show çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚\n  âœ… init devtools after feature flag checks (d0ea745)\n    DONE Performance Improvements [1/1]  CLOSED: [2021-08-09 Mon 15:22]\n âœ… reactivity: only call Set.add if doesn\u0026#39;t already have value (#3307) (9cd9883)\n å¯¹äº Set key-value éƒ½æ˜¯å€¼ï¼Œæ‰€ä»¥å½“æœ‰è¿™ä¸ª value çš„æ—¶å€™å†æ·»åŠ å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†ï¼Œ Set åˆæ˜¯ä¸é‡å¤é›†åˆã€‚\n1 2 3 4 5 6 7 8 9 10 11  packages/reactivity/src/collectionHandlers.ts @@ -76,8 +76,8 @@ function add(this: SetTypes, value: unknown) { const target = toRaw(this) const proto = getProto(target) const hadKey = proto.has.call(target, value) - target.add(value) if (!hadKey) { + target.add(value)  trigger(target, TriggerOpTypes.ADD, value, value) } return this           3.0.6 (2021-02-24)  Important   æ­¤æ¬¡æ›´æ–°é‡ç‚¹å†…å®¹(å€¼å¾—å…³æ³¨çš„ç‚¹)ï¼š\n  ADD: BigInt ç±»å‹å’Œ SFC æ”¯æŒ ğŸ”—\n  FIX: ä¿®å¤ class: [\u0026#39;foo\u0026#39;, false, undefined, \u0026#39;bar\u0026#39;] è¢«è§£ææˆ \u0026lt;div class=\u0026#34;foo bar\u0026#34;/\u0026gt; é—®é¢˜ ğŸ”—ã€‚\n  FIX: ä¿®å¤ foo-bar äº‹ä»¶åæ— æ³•è§¦å‘é—®é¢˜ ğŸ”— ã€‚\n  FIX: this.$watch(fn, callback) çš„ fn ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ instance.proxy ğŸ”—\n    DONE Bug Fixes [25/25]  CLOSED: [2021-08-05 Thu 23:42]\n âœ… compiler-core: do not mark v-for as stable on const bindings (734c65b), closes vitejs/vite#1956\n âœ… compiler-dom: ensure global build filename matches the one defined in package.json (close #3181) (#3185) (96b6433)\n âœ… compiler-dom: fix cdn entries (fcb6c89), closes #3181 #3185\n âœ… compiler-sfc: compiler blank srcset (#3005) (9dc816d)\n å…è®¸ \u0026lt;img src=\u0026#34;./logo.png\u0026#34; srcset=\u0026#34;\u0026#34;/\u0026gt; çš„ srcset æ˜¯ä¸ªç©ºå€¼ï¼Œç¼–è¯‘åï¼š\n1 2 3 4  _createVNode(\\\\\u0026#34;img\\\\\u0026#34;, { src: \\\\\u0026#34;./logo.png\\\\\u0026#34;, srcset: \\\\\u0026#34;\\\\\u0026#34; }),     âœ… compiler-sfc: removeSpecifier issue when removing initial imports (script-setup) (#2729) (6d762a8)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  const url = process.env.VNEXT_PKG_RC + \u0026#34;/../compiler-sfc/dist/compiler-sfc.cjs.js\u0026#34;; const value = require(url.replace(\u0026#34;stb-\u0026#34;, \u0026#34;\u0026#34;)); const parser = \u0026#39;/usr/local/lib/node_modules/@babel/parser/lib\u0026#39; const { parse: babelParse } = require(parser) const { compileScript, parse } = value; const src = `\u0026lt;script setup\u0026gt; import { defineProps, defineEmits, ref } from \u0026#39;vue\u0026#39; defineProps([\u0026#39;foo\u0026#39;]) defineEmits([\u0026#39;bar\u0026#39;]) const r = ref(0) \u0026lt;/script\u0026gt;` const { descriptor } = parse(src) const code = compileScript(descriptor, { id: \u0026#39;xxxxx\u0026#39; }).content console.log(\u0026#39;before babel \u0026gt; \\n\u0026#39;, code); babelParse(code, { sourceType: \u0026#39;module\u0026#39;, plugins: [\u0026#39;bigInt\u0026#39;, \u0026#39;optionalChaining\u0026#39;, \u0026#39;nullishCoalescingOperator\u0026#39;, \u0026#39;typescript\u0026#39;] }) console.log(\u0026#39;after babel \u0026gt; \\n\u0026#39;, code); return 0;    before babel \u0026gt; import { ref } from \u0026#39;vue\u0026#39; export default { props: [\u0026#39;foo\u0026#39;], emits: [\u0026#39;bar\u0026#39;], setup(__props, { expose }) { expose() const r = ref(0) return { r, ref, __isScriptSetup: true } } } after babel \u0026gt; import { ref } from \u0026#39;vue\u0026#39; export default { props: [\u0026#39;foo\u0026#39;], emits: [\u0026#39;bar\u0026#39;], setup(__props, { expose }) { expose() const r = ref(0) return { r, ref, __isScriptSetup: true } } } 0   âœ… compiler-sfc: the empty lang attribute should be treated as no lang specified (#3051) (6d5b623)\n âœ… compiler-sfc: transformAssetUrls.base should not affect known module requests (2ea9867)\n âœ… compiler-sfc: treat const reactive() bindings as mutable (03360ce) const obj = reactive({}) ç¼–è¯‘æˆ let å˜é‡ã€‚\n âœ… compiler-ssr: avoid duplicated asset imports merged from component slot client branch (c69f4ea), closes vitejs/vite#2034\n root.imports Set æ”¹æˆäº† Arrayï¼Œå…è®¸é‡å¤äº†.\n âœ… devtools: init devtools in production (#2906) (4d9bcb7)\n âœ… devtools: send instance to devtools when it\u0026#39;s mounted instead of created (4fecb27)\n âœ… docs: change reference to passed deadline (#2930) (de7f9d1)\n âœ… hmr: deep clone reused hoisted trees during dev (5a7a1b8), closes vitejs/vite#2022\n å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯¹é™æ€æå‡çš„ç»„ä»¶æ ‘è¿›è¡Œæ·±æ‹·è´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  packages/runtime-core/src/vnode.ts @@ -459,7 +459,7 @@ export function cloneVNode\u0026lt;T, U\u0026gt;( ): VNode\u0026lt;T, U\u0026gt; { // This is intentionally NOT using spread or extend to avoid the runtime // key enumeration cost. - const { props, ref, patchFlag } = vnode + const { props, ref, patchFlag, children } = vnode const mergedProps = extraProps ? mergeProps(props || {}, extraProps) : props return { __v_isVNode: true, @@ -479,7 +479,10 @@ export function cloneVNode\u0026lt;T, U\u0026gt;(  : normalizeRef(extraProps) : ref, scopeId: vnode.scopeId, - children: vnode.children, + children: + __DEV__ \u0026amp;\u0026amp; patchFlag === PatchFlags.HOISTED \u0026amp;\u0026amp; isArray(children) + ? (children as VNode[]).map(deepCloneVNode) + : children,  target: vnode.target, targetAnchor: vnode.targetAnchor, staticCount: vnode.staticCount, @@ -513,6 +516,18 @@ export function cloneVNode\u0026lt;T, U\u0026gt;( } }      deep clone å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11  /** * Dev only, for HMR of hoisted vnodes reused in v-for * https://github.com/vitejs/vite/issues/2022 */ function deepCloneVNode(vnode: VNode): VNode { const cloned = cloneVNode(vnode) if (isArray(vnode.children)) { cloned.children = (vnode.children as VNode[]).map(deepCloneVNode) } return cloned }     âœ… runtime-core: align $parent/$root with the template ref when using expose (#3158) (f43a3b0)\n expose ç‰¹æ€§è¯¦è§£ï¼šVue3 åŠŸèƒ½æ‹†è§£â‘ª expose options\u0026amp;api\n âœ… runtime-core: allow overriding properties other than props (#3105) (73117f6)\n å…è®¸é‡å†™éç»„ä»¶ props çš„å±æ€§ï¼Œæ¯”å¦‚ï¼šåŸç”Ÿ API hasOwnProperty\n1 2 3 4 5 6 7 8 9 10  packages/runtime-core/src/componentPublicInstance.ts @@ -368,7 +368,7 @@ export const PublicInstanceProxyHandlers: ProxyHandler\u0026lt;any\u0026gt; = {  setupState[key] = value } else if (data !== EMPTY_OBJ \u0026amp;\u0026amp; hasOwn(data, key)) { data[key] = value - } else if (key in instance.props) { + } else if (hasOwn(instance.props, key)) {  __DEV__ \u0026amp;\u0026amp; warn( `Attempting to mutate prop \u0026#34;${key}\u0026#34;. Props are readonly.`,      æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10  packages/runtime-core/__tests__/componentProps.spec.ts @@ -295,6 +295,10 @@ describe(\u0026#39;component props\u0026#39;, () =\u0026gt; {  ;(instance!.proxy as any).foo = 2 }).toThrow(TypeError) expect(`Attempting to mutate prop \u0026#34;foo\u0026#34;`).toHaveBeenWarned() // should not throw when overriding properties other than props + expect(() =\u0026gt; { + ;(instance!.proxy as any).hasOwnProperty = () =\u0026gt; {} + }).not.toThrow(TypeError) })      âœ… runtime-core: check the DEV_ROOT_FRAGMENT flag correctly in the dev environment (#2750) (347a879)\n1 2 3 4 5 6 7 8 9 10 11  // to have comments along side the root element which makes it a fragment let root = result let setRoot: ((root: VNode) =\u0026gt; void) | undefined = undefined - if (__DEV__ \u0026amp;\u0026amp; result.patchFlag \u0026amp; PatchFlags.DEV_ROOT_FRAGMENT) { + if ( + __DEV__ \u0026amp;\u0026amp; + result.patchFlag \u0026gt; 0 \u0026amp;\u0026amp; + result.patchFlag \u0026amp; PatchFlags.DEV_ROOT_FRAGMENT + ) {  ;[root, setRoot] = getChildRoot(result) }      âœ… runtime-core: component methods should override global properties in DEV (#3074) (2587f36)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  packages/runtime-core/src/componentOptions.ts @@ -604,7 +604,17 @@ export function applyOptions(  for (const key in methods) { const methodHandler = (methods as MethodOptions)[key] if (isFunction(methodHandler)) { - ctx[key] = methodHandler.bind(publicThis) + // In dev mode, we use the `createRenderContext` function to define methods to the proxy target, + // and those are read-only but reconfigurable, so it needs to be redefined here + if (__DEV__) { + Object.defineProperty(ctx, key, { + value: methodHandler.bind(publicThis), + configurable: true, + enumerable: false + }) + } else { + ctx[key] = methodHandler.bind(publicThis) + }  if (__DEV__) { checkDuplicateProperties!(OptionTypes.METHODS, key) }      æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  const url = process.env.VNEXT_PKG_RC +\u0026#39;/../runtime-test/dist/runtime-test.cjs.js\u0026#39; const value = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { nodeOps, render, h, serializeInner: s, createApp } = value const Comp = { methods: { foo() { return \u0026#39;foo\u0026#39; } }, render() { return this.foo() } } const app = createApp(Comp) app.config.globalProperties.foo = () =\u0026gt; \u0026#39;bar\u0026#39; const root = nodeOps.createElement(\u0026#39;div\u0026#39;) app.mount(root) console.log(s(root)) return 0    foo 0   âœ… runtime-core: ensure app instance can be garbage collected after unmount (close #2907) (#2909) (60e05ef)\n1 2 3 4 5 6 7 8 9  packages/runtime-core/src/apiCreateApp.ts @@ -272,6 +272,7 @@ export function createAppAPI\u0026lt;HostElement\u0026gt;(  if (__DEV__ || __FEATURE_PROD_DEVTOOLS__) { devtoolsUnmountApp(app) } + delete app._container.__vue_app__  } else if (__DEV__) { warn(`Cannot unmount an app that is not mounted.`) }      å–æ¶ˆå¼•ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function unmount() { if (isMounted) { render(null, app._container) if (__DEV__ || __FEATURE_PROD_DEVTOOLS__) { app._instance = null devtoolsUnmountApp(app) } delete app._container.__vue_app__ } else if (__DEV__) { warn(`Cannot unmount an app that is not mounted.`) } }     mount é‡Œé¢ä¿å­˜çš„ __vue_ap__\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  function mount( rootContainer: HostElement, isHydrate?: boolean, isSVG?: boolean ): any { if (!isMounted) { // ...  vnode.appContext = context // HMR root reload ...  if (isHydrate \u0026amp;\u0026amp; hydrate) { hydrate(vnode as VNode\u0026lt;Node, Element\u0026gt;, rootContainer as any) } else { render(vnode, rootContainer, isSVG) } isMounted = true app._container = rootContainer // for devtools and telemetry  ;(rootContainer as any).__vue_app__ = app if (__DEV__ || __FEATURE_PROD_DEVTOOLS__) { app._instance = vnode.component devtoolsInitApp(app, version) } return vnode.component!.proxy } // ... }     âœ… runtime-core: instanceWatch should pass this.proxy to source as the first argument (#2753) (ec8fd10) \n å½“ watch ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå°† instance.proxy åšä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ ç»™è¿™ä¸ªå‡½æ•°ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const url = process.env.VNEXT_PKG_RC +\u0026#39;/../runtime-test/dist/runtime-test.cjs.js\u0026#39; const value = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { nodeOps, render, h, serializeInner: s, createApp } = value let instance = null const source = (proxy) =\u0026gt; console.log(instance \u0026amp;\u0026amp; ( proxy === instance.proxy )) const Comp = { created() { instance = this this.$watch(source, () =\u0026gt; {}) }, render() {} } const root = nodeOps.createElement(\u0026#39;div\u0026#39;) createApp(Comp).mount(root) return 0    false 0   ä¿®å¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  packages/runtime-core/src/apiWatch.ts @@ -181,7 +181,9 @@ function doWatch(  } else if (isReactive(s)) { return traverse(s) } else if (isFunction(s)) { - return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER) + return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER, [ + instance \u0026amp;\u0026amp; (instance.proxy as any) + ])  } else { __DEV__ \u0026amp;\u0026amp; warnInvalidSource(s) } @@ -190,7 +192,9 @@ function doWatch(  if (cb) { // getter with cb getter = () =\u0026gt; - callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER) + callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER, [ + instance \u0026amp;\u0026amp; (instance.proxy as any) + ])  } else { // no cb -\u0026gt; simple effect getter = () =\u0026gt; {      âœ… types: extract the correct props type for the DateConstructor (#2676) (48f0d29)\n âœ… ensure all published packages contan a LICENCE file (close #2650) (#2857) (6a48d23)\n âœ… remove superfluous spaces when normalizing class (#3083) (4b55142) \n é—®é¢˜å¦‚ä¸‹ä»£ç ï¼Œæ­£å¸¸åº”è¯¥å¿½ç•¥ undefind, false ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const url = process.env.VNEXT_PKG_RC +\u0026#39;/../runtime-test/dist/runtime-test.cjs.js\u0026#39; const value = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { nodeOps, render, h, serializeInner: s } = value const Comp = { props: { foo: BigInt }, render() { return h(\u0026#39;div\u0026#39;, { class: [\u0026#39;foo\u0026#39;, undefined, false, \u0026#39;bar\u0026#39;] }, [this.foo]) } } const root = nodeOps.createElement(\u0026#39;div\u0026#39;) render(h(Comp, { foo: BigInt(BigInt(100000111)) + BigInt(2000000000) * BigInt(30000000) }), root) console.log(s(root)) return 0    \u0026lt;div class=\u0026#34;foo bar\u0026#34;\u0026gt;60000000100000111\u0026lt;/div\u0026gt; 0   ä¿®å¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  packages/shared/src/normalizeProp.ts @@ -62,7 +62,10 @@ export function normalizeClass(value: unknown): string {  res = value } else if (isArray(value)) { for (let i = 0; i \u0026lt; value.length; i++) { - res += normalizeClass(value[i]) + \u0026#39; \u0026#39; + const normalized = normalizeClass(value[i]) + if (normalized) { + res += normalized + \u0026#39; \u0026#39; + }  } } else if (isObject(value)) { for (const name in value) {      âœ… runtime-dom: enable set form attr to null on form-elements (#2840) (#2849) (f262438)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  packages/runtime-dom/src/patchProp.ts @@ -3,7 +3,13 @@ import { patchStyle } from \u0026#39;./modules/style\u0026#39; - // #1787 form as an attribute must be a string, while it accepts an Element as - // a prop - if (key === \u0026#39;form\u0026#39; \u0026amp;\u0026amp; typeof value === \u0026#39;string\u0026#39;) { + // #1787, #2840 the form property is readonly and can only be set as an + // attribute using a string value + if (key === \u0026#39;form\u0026#39; \u0026amp;\u0026amp; isFormTag(el.tagName)) {  return false } packages/shared/src/domTagConfig.ts @@ -30,6 +30,11 @@ const SVG_TAGS = const VOID_TAGS = \u0026#39;area,base,br,col,embed,hr,img,input,link,meta,param,source,track,wbr\u0026#39; + const FORM_TAGS = + \u0026#39;button,datalist,fieldset,input,keygen,label,legend,meter,optgroup,option,\u0026#39; + + \u0026#39;output,progress,select,textarea\u0026#39;  export const isHTMLTag = /*#__PURE__*/ makeMap(HTML_TAGS) export const isSVGTag = /*#__PURE__*/ makeMap(SVG_TAGS) export const isVoidTag = /*#__PURE__*/ makeMap(VOID_TAGS) export const isFormTag = /*#__PURE__*/ makeMap(FORM_TAGS, true)      âœ… toRef: ref created from union typed prop can\u0026#39;t be used in watch (#3048) (4ca4666)\n âœ… should prefix ShadowRoot with window. (#2943) (97d6f1a)\n é€šè¿‡ window å»ä½¿ç”¨ ShadowRootï¼Œå› ä¸ºå®ƒä¸æ˜¯ window ä¸Šå¯æšä¸¾çš„å±æ€§ã€‚\n1 2 3 4 5 6 7 8 9  packages/runtime-dom/src/index.ts @@ -119,7 +119,7 @@ function normalizeContainer( } if ( __DEV__ \u0026amp;\u0026amp; - container instanceof ShadowRoot \u0026amp;\u0026amp; + container instanceof window.ShadowRoot \u0026amp;\u0026amp;  container.mode === \u0026#39;closed\u0026#39; ) {         DONE Features [5/5]  CLOSED: [2021-08-05 Thu 23:42]\n âœ… remove useless option in KeepAlive (#3170) (bd1240c)\n åˆ é™¤äº† KeepAlive çš„ inheritRef: true é€‰é¡¹ã€‚\n âœ… compiler-core: support BigInt in template (#2900) (c9f94fa)\n å°† BigInt æ ‡è®°ä¸ºå…¨å±€å˜é‡ã€‚\n1 2 3 4 5 6 7 8 9  packages/shared/src/globalsWhitelist.ts @@ -3,6 +3,6 @@ import { makeMap } from \u0026#39;./makeMap\u0026#39; const GLOBALS_WHITE_LISTED = \u0026#39;Infinity,undefined,NaN,isFinite,isNaN,parseFloat,parseInt,decodeURI,\u0026#39; + \u0026#39;decodeURIComponent,encodeURI,encodeURIComponent,Math,Number,Date,Array,\u0026#39; + - \u0026#39;Object,Boolean,String,RegExp,Map,Set,JSON,Intl\u0026#39; + \u0026#39;Object,Boolean,String,RegExp,Map,Set,JSON,Intl,BigInt\u0026#39;  export const isGloballyWhitelisted = /*#__PURE__*/ makeMap(GLOBALS_WHITE_LISTED)      æµ‹è¯•ç»“æœï¼š\n const app = Vue.createApp({ template: ` {{ BigInt(BigInt(100000111)) + BigInt(2000000000n) * 30000000n }} æŸ¥çœ‹æµ‹è¯•æºç  {{code}} `, setup() { const showCode = Vue.ref(false) return { showCode, code: Vue.computed(() = document.querySelector('script.ZA4bDx').textContent), click: () = ( showCode.value = !showCode.value ) } } }) const root = document.getElementById('ZA4bDx') app.use(ElementPlus).mount(root)   âœ… compiler-sfc: upgrade to postcss 8 (#2710) (49bc2e4)\n âœ… runtime-core: improve render context warning (#2496) (288ae0a)\n é—®é¢˜ï¼š ç»„ä»¶æ¸²æŸ“æœŸé—´å»è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§æ—¶å€™ï¼ŒæŠ¥é”™ä¿¡æ¯ï¼š\nProperty ${JSON.stringify(key)} was accessed during render but is not defined on instance.\n 1 2 3 4 5 6 7 8 9 10  packages/runtime-core/src/componentPublicInstance.ts @@ -349,7 +349,7 @@ export const PublicInstanceProxyHandlers: ProxyHandler\u0026lt;any\u0026gt; = {  )} must be accessed via $data because it starts with a reserved ` + `character (\u0026#34;$\u0026#34; or \u0026#34;_\u0026#34;) and is not proxied on the render context.` ) - } else { + } else if (instance === currentRenderingInstance) {  warn( `Property ${JSON.stringify(key)} was accessed during render ` + `but is not defined on instance.`      âœ… runtime-core: props type support BigInt (#2891) (ffd5288) \n ä¿®æ”¹ä»£ç ï¼š\n1 2 3 4  const isSimpleType = /*#__PURE__*/ makeMap( - \u0026#39;String,Number,Boolean,Function,Symbol\u0026#39; + \u0026#39;String,Number,Boolean,Function,Symbol,BigInt\u0026#39; )      æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const url = process.env.VNEXT_PKG_RC +\u0026#39;/../runtime-test/dist/runtime-test.cjs.js\u0026#39; const value = require(url.replace(\u0026#39;stb-\u0026#39;, \u0026#39;\u0026#39;)) const { nodeOps, render, h, serializeInner: s } = value const Comp = { props: { foo: BigInt }, render() { return h(\u0026#39;div\u0026#39;, [this.foo]) } } const root = nodeOps.createElement(\u0026#39;div\u0026#39;) render(h(Comp, { foo: BigInt(BigInt(100000111)) + BigInt(2000000000) * BigInt(30000000) }), root) console.log(s(root)) return 0    \u0026lt;div\u0026gt;60000000100000111\u0026lt;/div\u0026gt; 0      DONE Performance Improvements [1/1]  CLOSED: [2021-08-05 Thu 23:42]\n âœ… reactivity: should not track __isVue (#2940) (dd02cf3)\n @@ -93,7 +96,7 @@ function createGetter(isReadonly = false, shallow = false) {\n1 2 3 4 5 6 7 8 9 10 11 12  + const isNonTrackableKeys = /*#__PURE__*/ makeMap(`__proto__,__v_isRef,__isVue`)  if ( isSymbol(key) ? builtInSymbols.has(key as symbol) - : key === `__proto__` || key === `__v_isRef` + : isNonTrackableKeys(key)  ) { return res } // é‡åˆ° __isVue ä¹Ÿç›´æ¥è¿”å› Reflect.get çš„ç»“æœï¼Œä¸å¾€ä¸‹ track äº†ã€‚           3.0.5 (2020-12-30)   vue-next/CHANGELOG.md at master Â· vuejs/vue-next\nTIP\n Note: this release contains a type-only change that requires TypeScript 4.0+, which may cause build issues in projects still using TS 3.x.\n  åªåŒ…å«ä¸€äº›ç±»å‹çš„å˜æ›´ã€‚\nDONE Bug Fixes [9/9]  CLOSED: [2021-08-05 Thu 23:44]\n âœ… compiler-core: fix missing createVNode import on nested v-for (ad4d391), closes #2718\n âœ… compiler-sfc: should keep template nodes with no content (#2468) (5b9b37f), closes #2463\n1 2 3 4 5 6 7 8 9 10  -\u0026gt; packages/compiler-sfc/src/parse.ts if (node.type !== NodeTypes.ELEMENT) { return } - if (!node.children.length \u0026amp;\u0026amp; !hasSrc(node)) { + if (!node.children.length \u0026amp;\u0026amp; !hasSrc(node) \u0026amp;\u0026amp; node.tag !== \u0026#39;template\u0026#39;) {  return } switch (node.tag) {      âœ… compiler-sfc: support transforming asset urls with full base url. (#2477) (db786b1)\n é’ˆå¯¹ç›¸å¯¹è·¯å¾„è€Œè¨€ï¼Œå½“æä¾›äº† base é€‰é¡¹çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨è¿™ä¸ªå€¼å»æ‹¼æ¥ï¼Œå¦‚ï¼š\n { transformAssetUrls: { base: \u0026#39;https://www.cheng92.com\u0026#39; } }\n \u0026lt;img src=\u0026#34;./vue/img/test.png\u0026#34; /\u0026gt; ä¼šè¢«ç¼–è¯‘æˆï¼š\n createVNode(\u0026#39;img\u0026#39;, { src: \u0026#39;https://www.cheng92.com/vue/img/test.png\u0026#39; })\n âœ… runtime-core: component mount anchor memory leak (#2459) (3867bb4), closes #2458\n  âœ… runtime-core: skip patchBlockChildren if n1.dynamicChildren is null (#2717) (c59897c), closes #2715 #2485\n    è¿™ä¸ªé—®é¢˜åŸå› æ˜¯ï¼Œä¸€å¼€å§‹ HelloWorld çš„ dynamicChildren æ˜¯ nullã€‚\n å½“ç‚¹å‡» ADD æŒ‰é’®çš„æ—¶å€™å¢åŠ äº†ä¸€é¡¹æ•°æ®ï¼Œä¼šè¿›å…¥ mountChildren -\u0026gt; patchBlockChildren\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const patchBlockChildren: PatchBlockChildrenFn = ( oldChildren, newChildren, fallbackContainer, parentComponent, parentSuspense, isSVG, slotScopeIds ) =\u0026gt; { for (let i = 0; i \u0026lt; newChildren.length; i++) { const oldVNode = oldChildren[i] // dynamicChildren  const newVNode = newChildren[i] // ...  } }     è€Œ dynamicChildren åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ˜¯ä¸ª null å€¼, ä¸€å¼€å§‹å°±è®¿é—®äº† dynamicChildren[i] æ‰€ä»¥å¯¼è‡´æŠ¥é”™ã€‚\n ä¿®å¤ä»£ç (c59897c)ï¼ŒåŠ ä¸ªåˆ¤æ–­æ¡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  if ( patchFlag \u0026gt; 0 \u0026amp;\u0026amp; patchFlag \u0026amp; PatchFlags.STABLE_FRAGMENT \u0026amp;\u0026amp; - dynamicChildren \u0026amp;\u0026amp; + dynamicChildren \u0026amp;\u0026amp; + n1.dynamicChildren  ) { // a stable fragment (template root or \u0026lt;template v-for\u0026gt;) doesn\u0026#39;t need to // patch children order, but it may contain dynamicChildren. patchBlockChildren( - n1.dynamicChildren!, + n1.dynamicChildren,  dynamicChildren, container, parentComponent, parentSuspense, isSVG, slotScopeIds )      âŒ runtime-dom: support mounting app on ShadowRoot (#2447) (b2189ba), closes #2399\n \u0026gt;3.2 ä¸­å·²ç»æ²¡æœ‰ __isShadowRoot ç›¸å…³çš„ä»£ç äº†ã€‚\n âœ… ssr: properly handle ssr empty slot and fallback (88f6b33)\n âœ… transition: ensure manual style manipulation in transition leave hooks work (cbaa380), closes #2720\n åœ¨ onLeave hook ä¸­å¢åŠ \n1 2  forceReflow() addTransitionClass(el, leaveActiveClass)     å»å¼ºåˆ¶æ¸²æŸ“ï¼Œè§¦å‘ leaveActiveClass ã€‚\n âœ… transition: ensure styles from *-leave-active trigger transition (#2716) (3f8f9b6), closes #2712\n    DONE Features [1/1]  CLOSED: [2021-08-05 Thu 23:44]\n âœ… devtools: send instance (3626ff0)\n å°†ç»„ä»¶å®ä¾‹ç»™å¼€å‘å·¥å…·ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  function createDevtoolsComponentHook(hook: DevtoolsHooks) { return (component: ComponentInternalInstance) =\u0026gt; { if (!devtools) return devtools.emit( hook, component.appContext.app, component.uid, - component.parent ? component.parent.uid : undefined + component.parent ? component.parent.uid : undefined, + component  ) } }           tests  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const url = process.env.VNEXT_PKG_RC + \u0026#34;/../compiler-sfc/dist/compiler-sfc.cjs.js\u0026#34;; const value = require(url.replace(\u0026#34;stb-\u0026#34;, \u0026#34;\u0026#34;)); const { compileScript, parse, compileStyle } = value; function compileScoped(source, options) { const res = compileStyle({ source, filename: \u0026#39;test.css\u0026#39;, id: \u0026#39;data-v-test\u0026#39;, scoped: true, ...options }) return res.code } const src = `::v-slotted(h1) { color: red; }` const code = compileScoped(src) console.log(code) return 0;    h1[data-v-test-s] { color: red; } 0    ","permalink":"https://www.cheng92.com/vue/vue-update-log-01/","tags":["vue,","vue3"],"title":"Vue3 æ›´æ–°æ—¥å¿— 01(3.0.5 ~ 3.2.0-beta.1)"},{"categories":["react,","preact"],"contents":"  å»ºè®®å­¦ä¹  preact ä¹‹å‰ï¼Œå…ˆçœ‹ Build Your Own React - è‹¥å¶çŸ¥ç§‹ æˆ– Build your own React\n é¡¹ç›®åˆå§‹åŒ–   preact src ä¸‹æœ€åŸºç¡€çš„ç›®å½•ç»“æ„\n/Users/simon/github/react/stb-preact/src: total used in directory 80K available 4.3 GiB drwxr-xr-x 4 simon staff 128 Jun 20 17:32 diff -rw-r--r-- 1 simon staff 56 Jun 20 17:29 clone-element.js -rw-r--r-- 1 simon staff 45 Jun 20 17:29 component.js -rw-r--r-- 1 simon staff 58 Jun 20 17:30 create-context.js -rw-r--r-- 1 simon staff 373 Jun 20 17:28 create-element.js -rw-r--r-- 1 simon staff 8.2K Jun 20 17:21 index.d.ts -rw-r--r-- 1 simon staff 391 Jun 20 17:28 index.js -rw-r--r-- 1 simon staff 4.9K Jun 20 17:32 internal.d.ts -rw-r--r-- 1 simon staff 31K Jun 20 17:21 jsx.d.ts -rw-r--r-- 1 simon staff 587 Jun 20 17:32 options.js -rw-r--r-- 1 simon staff 103 Jun 20 17:27 render.js   é‡ç‚¹ä»£ç ï¼š\n  diff èŠ‚ç‚¹æ¯”è¾ƒç®—æ³•æ ¸å¿ƒä»£ç \n  component.js Component ç»„ä»¶ç±»\n  render.js render å‡½æ•°\n    åŸºæœ¬ä½¿ç”¨   å®˜æ–¹çš„æ —å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  import { h, render } from \u0026#39;preact\u0026#39;; // Tells babel to use h for JSX. It\u0026#39;s better to configure this globally. // See https://babeljs.io/docs/en/babel-plugin-transform-react-jsx#usage // In tsconfig you can specify this with the jsxFactory /** @jsx h */ // create our tree and append it to document.body: render(\u0026lt;main\u0026gt;\u0026lt;h1\u0026gt;Hello\u0026lt;/h1\u0026gt;\u0026lt;/main\u0026gt;, document.body); // update the tree in-place: render(\u0026lt;main\u0026gt;\u0026lt;h1\u0026gt;Hello World!\u0026lt;/h1\u0026gt;\u0026lt;/main\u0026gt;, document.body); // ^ this second invocation of render(...) will use a single DOM call to update the text of the \u0026lt;h1\u0026gt;      å‡½æ•°ç»„ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  import { render, h } from \u0026#39;preact\u0026#39; import { useState } from \u0026#39;preact/hooks\u0026#39; /** @jsx h*/ const App = () =\u0026gt; { const [input, setInput] = useState(\u0026#39;\u0026#39;) return ( \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;some thing....\u0026lt;/p\u0026gt; \u0026lt;input value={input} onChange={e =\u0026gt; setInput(e.target.value)}/\u0026gt; \u0026lt;/div\u0026gt; ) } render(\u0026lt;App/\u0026gt;, document.body)     æ‰€ä»¥ï¼Œé¦–å…ˆéœ€è¦å®ç°çš„æ˜¯ h/createElement å’Œ render, å‰è€…æ„é€  VNode æ ‘ï¼Œåè€…åˆ© ç”¨ VNode tree å®æ–½æ¸²æŸ“ï¼ŒåŠ å…¥ DOM ã€‚\n  h/createElement å‡½æ•°   feat: h -\u0026gt; createElement Â· gcclll/stb-preact@efb88ce\n src/create-element.js å†…å®¹ï¼š\n   name å‚æ•° brief     createElement type, props, children h å‡½æ•°ï¼Œæ„é€  VNode   createVNode type,props,key,ref,original createElementè°ƒç”¨   createRef - {current: null}   Fragment props -   isValidElement vnode -     createElement(type, props, children):\n  props å¤„ç†ï¼Œè¿‡æ»¤å‡º key,ref å±æ€§ï¼Œè¿™ä¸¤ä¸ªéå…ƒç´ åŸç”Ÿå±æ€§\n  æ£€æµ‹ children åˆå¹¶æˆæ•°ç»„ï¼Œå½“ä½œæ”¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹\n  å¦‚æœ type æ˜¯ä¸ªå‡½æ•°ï¼Œè€ƒè™‘æ˜¯å¦æœ‰åˆå§‹åŒ–é»˜è®¤çš„ props\n  æœ€åè°ƒç”¨ createVNode æ„é€ è™šæ‹ŸèŠ‚ç‚¹\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  export function createElement(type, props, children) { let normalizedProps = {}, key, ref, i; for (i in props) { if (i == \u0026#39;key\u0026#39;) key = props[i]; else if (i == \u0026#39;ref\u0026#39;) ref = props[i]; else normalizedProps[i] = props[i]; } // æœ‰ children äº‹çš„å¤„ç†, \t// h(\u0026#39;div\u0026#39;, { ref: \u0026#39;xxx\u0026#39; }, children[]) \t// h(\u0026#39;div\u0026#39;, { ref: \u0026#39;xxx\u0026#39; }, child1, child2, child3, ...) \tif (arguments.length \u0026gt; 2) { normalizedProps.children = arguments.length \u0026gt; 3 ? slice.call(arguments, 2) : children; } // å‡½æ•°ç»„ä»¶ï¼Ÿ \t// If a Component VNode, check for and apply defaultProps \t// Note: type may be undefined in development, must never error here. \tif (typeof type === \u0026#39;function\u0026#39; \u0026amp;\u0026amp; type.defaultProps != null) { for (i in type.defaultProps) { if (normalizedProps[i] === undefined) { normalizedProps[i] = type.defaultProps[i]; } } } return createVNode(type, normalizedProps, key, ref, null); }     createVNode(type, props, key, ref, original):\n å•çº¯åˆå§‹åŒ–è™šæ‹ŸèŠ‚ç‚¹çš„ç»“æ„ã€‚\n  _nextDom ç”¨æ¥é“¾æ¥ä¸‹ä¸€ä¸ªè¢«æ¸²æŸ“çš„èŠ‚ç‚¹\n è¿™è·Ÿ react çš„ fiber è²Œä¼¼æœ‰ç‚¹å…³è”ï¼Œä¸çŸ¥é“è¿™é‡Œæœ‰æ²¡ç”¨åˆ° fiber. æ ¹æ® fiber ç»“æ„åŸ ç†ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ‰§è¡Œå•å…ƒçš„ä¼˜å…ˆçº§æ˜¯ï¼š first child -\u0026gt; sibling -\u0026gt; parent sibling\n  constructor è¿™é‡Œèµ‹å€¼ä¸º undefined ç›®çš„æ˜¯ä¸ºäº†è¯†åˆ« VNode(vue çš„ __v_isVNode ???) ?\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  // æ„é€ è™šæ‹ŸèŠ‚ç‚¹ export function createVNode(type, props, key, ref, original) { const vnode = { type, props, key, ref, _children: null, _parent: null, _depth: 0, _dom: null, // å¿…é¡»åˆå§‹åŒ–æˆ `undefined`, æœ€ç»ˆå›è¢«è®¾ç½®æˆ dom.nextSibling çš„å€¼ \t// react fiber ç»“æ„æŸ¥æ‰¾ä¼˜å…ˆçº§ï¼š first child -\u0026gt; sibling -\u0026gt; parent sibling \t_nextDom: undefined, _component: null, _hydrating: null, constructor: undefined, // ç”¨æ¥æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰æ•ˆçš„å…ƒç´ ï¼Ÿ \t_original: original == null ? ++vnodeId : original }; // ï¼Ÿï¼Ÿï¼Ÿ å¯ä»¥åŠ å·¥å¤„ç†ï¼Ÿï¼Ÿï¼Ÿ \tif (options.vnode != null) options.vnode(vnode); return vnode; }     æœ€åæœ‰ä¸ª if (options.vnode != null) options.vnode(vnode); åˆ¤æ–­ï¼Œè¿™ä¸ªä¸çŸ¥é“æ˜¯ä¸ æ˜¯æä¾›ç»™å¼€å‘è€…å¯¹ vnode è¿›è¡ŒåŠ å·¥å¤„ç†çš„èƒ½åŠ›ï¼Ÿ\n1 2  const react = require(process.env.HOME + \u0026#39;/github/react/stb-preact/dist/preact.js\u0026#39;); console.log(react);    { render: [Function (anonymous)], hydrate: [Function (anonymous)], createElement: [Function: u], h: [Function: u], Fragment: [Function (anonymous)], createRef: [Function (anonymous)], isValidElement: [Function: o], Component: [Function (anonymous)], cloneElement: [Function (anonymous)], createContext: [Function (anonymous)], toChildArray: [Function (anonymous)], options: { __e: [Function: __e] } } undefined   è™šæ‹ŸèŠ‚ç‚¹ï¼š\n1 2 3  const { h } = require(process.env.HOME + \u0026#39;/github/react/stb-preact/dist/preact.js\u0026#39;); console.log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; h(\u0026#39;div\u0026#39;, { key: 1 })\u0026#34;); console.log(h(\u0026#39;div\u0026#39;, { key: 1 }));    \u0026gt;\u0026gt;\u0026gt; h(\u0026#39;div\u0026#39;, { key: 1 }) { type: \u0026#39;div\u0026#39;, props: {}, key: 1, ref: undefined, __k: null, __: null, __b: 0, __e: null, __d: undefined, __c: null, __h: null, constructor: undefined, __v: 1 } undefined   ä¸Šé¢è¾“å‡ºç»“æœï¼Œè¢«åˆ«ååŒ–äº†ï¼Œè¿™è·Ÿ preact ç”¨çš„æ‰“åŒ…æ–¹å¼æœ‰å…³ç³»ï¼Œå¯¹åº”å…³ç³»åœ¨ mangle.json ä¸­ã€‚\n   key value     __k _children   __ _list   __b _depth   __e _force   __d _nextDom   __c _cleanup   __h _pendingEffects   __v _original      render()   render(vnode, parentDom, replaceNode)\n feat: render Â· gcclll/stb-preact@dcd5b41\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  export function render(vnode, parentDom, replaceNode) { if (options._root) options._root(vnode, parentDom); let isHydrating = typeof replaceNode === \u0026#39;function\u0026#39;; // ä¸ºäº†æ”¯æŒåœ¨åŒä¸€ä¸ª DOM node ä¸Šå¤šæ¬¡è°ƒç”¨ `render()`, é‚£ä¹ˆå°±éœ€è¦æœ‰ä¸ª \t// å¼•ç”¨èƒ½ä¹‹å‰ä¸Šä¸€æ¬¡æ¸²æŸ“çš„æ ‘ç»“æ„ã€‚é»˜è®¤æ²¡æœ‰è¯¥å±æ€§ï¼ŒåŒæ—¶ä¹Ÿä»£è¡¨æ˜¯è¯¥æ ‘ç¬¬ä¸€æ¬¡ \t// åŠ è½½ \tlet oldVNode = isHydrating ? null : (replaceNode \u0026amp;\u0026amp; replaceNode._children) || parentDom._children; // è®©çˆ¶èŠ‚ç‚¹æŒæœ‰å­èŠ‚ç‚¹å¼•ç”¨ \tvnode = ( (!isHydrating \u0026amp;\u0026amp; replaceNode) || parentDom )._children = createElement(Fragment, null, [vnode]); // 1. diff()  // 2. commitRoot(commitQueue, vnode) }     Fragment å®ç°ï¼š\n1 2 3  export function Fragment(props) { return props.children; }     å¾ˆå¥‡æ€ªå—ï¼Ÿ\n createElement(Fragment, null, [vnode]) ç­‰ä»·äº\n createElement(props.children, null, [vnode])\n Fragment æ˜¯ä¸ªå‡½æ•°ï¼Œè€Œ createElement å¯¹ type çš„åˆ¤æ–­ä¸ºå‡½æ•°æ—¶çš„å¤„ç†æ˜¯å¯¹ default props çš„æ£€æµ‹å’Œåˆå¹¶æ“ä½œã€‚\n æ ¹æ® å‡½æ•°ç»„ä»¶å¤„ç† å¯çŸ¥è¿™ä¸ªå¤„ç†ä¼šåœ¨ commit é˜¶æ®µå®Œæˆï¼Œå…ˆä¸ç®¡è¿™ä¸ªã€‚\n ç»§ç»­å¾€ä¸‹ï¼Œå°†æ¶‰åŠåˆ°ä¸¤ä¸ªæ ¸å¿ƒå†…å®¹ï¼š\n  diff, è¿›è¡Œå¯¹æ¯”æ›´æ–° VNode\n  work unit commit, æäº¤æ¸²æŸ“ä»»åŠ¡\n  ä¸¤ä¸ªéƒ½æ˜¯é‡ç‚¹ä¸”æ ¸å¿ƒçš„å†…å®¹ã€‚\n  Component   åœ¨é˜…è¯» diff æºç ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹ Component æ˜¯å¦‚ä½•å®ç°çš„ï¼Œé‡Œé¢åˆåŒ…å«å“ªäº›å†…å®¹ï¼Ÿ\n  diff()   feat: diff init Â· gcclll/stb-preact@0ec1eaa\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  function render() { // 1. create element -\u0026gt; vnode  // 2. diff  // List of effects that need to be called after diffing. \tlet commitQueue = []; diff( parentDom, // Determine the new vnode tree and store it on the DOM element on \t// our custom `_children` property. \tvnode, // new vnode \toldVNode || EMPTY_OBJ, // old vnode \tEMPTY_OBJ, parentDom.ownerSVGElement !== undefined, !isHydrating \u0026amp;\u0026amp; replaceNode ? [replaceNode] : oldVNode ? null : parentDom.firstChild ? slice.call(parentDom.childNodes) : null, commitQueue, !isHydrating \u0026amp;\u0026amp; replaceNode ? replaceNode : oldVNode ? oldVNode._dom : parentDom.firstChild, isHydrating ); // 3. commit }     diff å‡½æ•°ç›®çš„ï¼šæ¯”è¾ƒ vnode æ›´æ–°ï¼Œæ¸²æŸ“æ›´æ–°åçš„èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11  export function diff( parentDom, newVNode, oldVNode, globalContext, isSvg, excessDomChildren, commitQueue, oldDom, isHydrating ) { /*...*/ }      ç–‘éš¾ç‚¹  TODO ä¸ºä½•ç”¨ Fragment å°† vnode åŒ…ä¸€å±‚ï¼Ÿ     ","permalink":"https://www.cheng92.com/react/preact-zero/","tags":["preact,","react"],"title":"Preact æºç å­¦ä¹ ï¼ˆä¸€ï¼‰"},{"categories":["javascript,","web"],"contents":" TODO\n Array.prototype.reduce()\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  function deepFindFirstChild( parent, path, ) { if (path \u0026amp;\u0026amp; Array.isArray(path)) { path.push(parent.id) } if (!parent?.children?.length) { return path ? [parent, path] : parent } return deepFindFirstChild(parent.children[0], path) } var obj = { id: 0, children: [{ id: 1, children: [{ id: 2, children: [{ id: 3, children: [{ id: 4 }] }] }] }] } try { const res = deepFindFirstChild(obj, []) console.log(res); } catch(e) { console.log(e.message); }    [{ id: 4 } (\\, [0 (\\, 1) (\\, 2) (\\, 3) (\\, 4)])]  ","permalink":"https://www.cheng92.com/web/apis/js-api-array-reduce/","tags":["javascript,","api,","reduce"],"title":"JavaScript Api - Array.prototype.reduce"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");    vue-i18n-next  1 2 3 4  alias: { \u0026#39;/@\u0026#39;: pathResolve(\u0026#39;src\u0026#39;), + \u0026#39;vue-i18n\u0026#39;: \u0026#39;vue-i18n/dist/vue-i18n.cjs.js\u0026#39; },       ","permalink":"https://www.cheng92.com/vue/how-to-build-a-vite-vue3-project/","tags":["vue3,","vite"],"title":"å¦‚ä½•å¼€å§‹ä¸€ä¸ª vite + vue3 + ... é¡¹ç›®"},{"categories":["huawei"],"contents":" Harmony   Huawei Developers - Building a Better Connected World with Developers\n OpenHarmony: OpenHarmonyæ˜¯å¼€æ”¾åŸå­å¼€æºåŸºé‡‘ä¼šï¼ˆOpenAtom Foundationï¼‰æ——ä¸‹å¼€æºé¡¹ç›®ï¼Œå®šä½æ˜¯ä¸€æ¬¾é¢å‘å…¨åœºæ™¯çš„å¼€æºåˆ†å¸ƒå¼æ“ä½œç³»ç»Ÿï¼Œç¬¬ä¸€ä¸ªç‰ˆæœ¬æ”¯æŒ128K-128Mè®¾å¤‡ä¸Šè¿è¡Œã€‚\n docs: OpenHarmony documentation | OpenHarmonyå¼€å‘è€…æ–‡æ¡£\n  å‰ç«¯ç›¸å…³   ace_engine_lite: ACE JS lite framework | è½»é‡çº§JSæ ¸å¿ƒå¼€å‘æ¡†æ¶\n JS APIå‚è€ƒ-æ–‡ä»¶ç»„ç»‡\n JS APIå‚è€ƒ-æ¦‚è¿°\n  é—®é¢˜    HarmonyOS Launch: The Huawei Lite Wearable Simulator supports only ?\n Tools -\u0026gt; HVD Manager  ä¸‹é¢æŒ‰ç…§éœ€è¦é€‰ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼š     ","permalink":"https://www.cheng92.com/post/huawei-harmony/","tags":["huawei,","harmony"],"title":"åä¸ºé¸¿è’™(Huawei Harmony) - èµ„æºæ”¶é›†"},{"categories":["javascript,","web"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");      ==, === è¿ç®—ç¬¦è¯¦è§£ã€‚\n ECMAScriptÂ® 2022 LanguageÂ Specification - Equality Comparison\n  ä¸€èˆ¬æ¨èä½¿ç”¨ç›¸ç­‰æ¯”è¾ƒçš„æ—¶å€™ä½¿ç”¨ === æ˜¯ä¸ºäº†é¿å…ç±»å‹å¼ºè½¬å¸¦æ¥æœªçŸ¥é—®é¢˜ï¼Œä½†æœ‰æ—¶å€™å ç«¯è¿”å›çš„æ•°æ®ç»“æ„å¦‚æœä¸è§„èŒƒå°±ç»å¸¸ä¼šå‡ºç°æ’ç­‰ä¸åˆç†æƒ…å†µï¼Œè¿™ç¯‡æ–‡ç« ä¼šä» ECMA æ ‡å‡†çš„å® ç°æ­¥éª¤ï¼Œé€šè¿‡ä¼ªç å½¢å¼æ¥å®ç°å’Œå±•ç¤ºç›¸ç­‰å’Œæ’ç­‰çš„åŸç†ã€‚\n åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¦åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚ã€‚ã€‚\n  ä¸¥æ ¼ç›¸ç­‰ === ï¼š\n1 2 3 4  function strictEqual(x, y) { // TODO  return x === y; }     å°†å­—ç¬¦ä¸²è½¬æˆ BigInt ç±»å‹:\n æ ‡å‡†é‡Œçš„æè¿°ï¼š 7.1.14 StringToBigInt ( argument ) Apply the algorithm in 7.1.4.1 with the following changes:\n Replace the StrUnsignedDecimalLiteral production with DecimalDigits to not allow Infinity, decimal points, or exponents. If the MV is NaN, return NaN, otherwise return the BigInt which exactly corresponds to the MV, rather than rounding to a Number.\n å®ç°ï¼š é€šè¿‡æµ‹è¯•ï¼Œåªè¦å­—ç¬¦ä¸²é‡ŒåŒ…å«éæ•°å­—çš„ç¬¦å·å°±ä¼šæŠ¥é”™ï¼Œè¿™é‡Œæå‰æ‹¦æˆªæ¨¡æ‹ŸæŠ¥é”™ï¼Œå® é™…æœ€åè¿˜æ˜¯é€šè¿‡ BigInt() æ¥è¿›è¡Œè½¬æ¢ï¼Œè€Œå¯¹äºéå­—ç¬¦ä¸²ç±»å‹æœ€ç»ˆä¼šè½¬æˆå­—ç¬¦ä¸²ä¹‹åå† å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  function StringToBigInt(v) { if (typeof v !== \u0026#34;string\u0026#34;) v = \u0026#34;\u0026#34; + v; if (isNaN(v)) return NaN; if (/[^\\d]/g.test(v)) { // åŒ…å«éæ•°å­—çš„éƒ½ä¸åˆæ³•æŠ¥é”™  throw new SyntaxError(`ä¸èƒ½å°† ${v}è½¬æˆ BigIntã€‚`); } return MyBigInt(v); // è¿™é‡Œç›´æ¥ä½¿ç”¨ BigInt } function MyBigInt(v) { if (this instanceof MyBigInt) { throw new TypeError(\u0026#34; ä¸æ”¯æŒ new æ“ä½œã€‚\u0026#34;); } let prim = toPrimitive(v, \u0026#34;number\u0026#34;); if (typeof prim === \u0026#39;number\u0026#39;) { return NumberToBigInt(prim); } return BigInt(v); } function NumberToBigInt(v) { return BigInt(v); } function toPrimitive(v) { return +v } // æµ‹è¯•ï¼š let val = StringToBigInt(\u0026#34;100\u0026#34;) console.log(val); try { val = StringToBigInt(\u0026#39;100.00\u0026#39;) } catch(e) { console.log(e.message) }    100n ä¸èƒ½å°† 100.00 è½¬æˆ BigIntã€‚ undefined   toPrimitive å°†å¯¹è±¡è½¬æˆåŸå§‹ç±»å‹ï¼Œæ ‡å‡†çš„å®ç°æœ‰ç‚¹å¤æ‚ï¼Œä¸»è¦åŸç†è¿˜æ˜¯å®ç°ç±»å‹çš„ Symbol.toPrimitive\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  // ç®€åŒ–ç‰ˆï¼šå°† x è½¬æˆåŸå§‹ç±»å‹ function toPrimitive(x, ref) { if (!isRef(x)) return x; if (isString(ref)) { return \u0026#34;\u0026#34; + x; } else if (isNum(ref)) { return +x; } else if (isBigInt(ref)) { if (isNum(x)) { throw new TypeError(\u0026#34;BigInt ä¸èƒ½è½¬æˆ number\u0026#34;); } else if (isString(x)) { return \u0026#34;\u0026#34; + x; } } else if (isSymbol(ref)) { return Symbol(x); } } // Symbol.toPrimitive // å®ç°å¦‚ï¼š obj = { [Symbol.toPrimitive](hint) { ... } } // è¿™é‡Œæ¶‰åŠåˆ°å„ç§å¯¹è±¡ç±»å‹è½¬æˆåŸå§‹ç±»å‹çš„ï¼Œæ¶‰åŠå†…å®¹å¤ªå¤šè¿™é‡Œå°±ä¸å±•å¼€å»å®ç°äº† function _ToPrimitive(input, preferredType) { let hint; if (isRef(input)) { let exoticToPrim = GetMethod(input, \u0026#34;@@toPrimitive\u0026#34;); if (exoticToPrim !== undefined) { if (!preferredType) { hint = \u0026#34;default\u0026#34;; } else if (preferredType === \u0026#34;string\u0026#34;) { hint = \u0026#34;string\u0026#34;; } else { hint = \u0026#34;number\u0026#34;; } let result = exoticToPrim(input, hint); if (typeof result !== \u0026#34;object\u0026#34;) { return result; } else { throw TypeError(\u0026#34;ç±»å‹ä¸èƒ½è½¬æˆåŸå§‹ç±»å‹\u0026#34;); } } else { if (!preferredType) { preferredType = \u0026#34;number\u0026#34;; } } return OrdinaryToPrimitive(input, preferredType); } return input; }     æ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  const obj = { [Symbol.toPrimitive](hint) { if (hint === \u0026#34;number\u0026#34;) { return 100; } else if (hint === \u0026#34;string\u0026#34;) { return \u0026#34;foo\u0026#34;; } return null; }, }; console.log(Number(obj)); console.log(+obj); console.log(String(obj));    100 100 foo undefined   è½¬æˆæ•°å­—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  // è½¬æˆæ•°å­— function ToNumber(v) { if (v === undefined) { return NaN; } else if (v === null) { return +0; } else if (v === true) { return 1; } else if (v === false) { return +0; } else if (typeof v === \u0026#34;number\u0026#34;) { return v; } else if (typeof v === \u0026#34;string\u0026#34;) { return v; // TODO  } else if (Array.isArray(v)) { return Number(v.toString()); } else if (typeof v === \u0026#34;symbol\u0026#34;) { throw new TypeError(\u0026#34;Symbol ä¸èƒ½è½¬æˆ number.\u0026#34;); } else if (typeof v === \u0026#34;bigint\u0026#34;) { throw Number(v); } else if (typeof v === \u0026#34;object\u0026#34;) { return Number(v); } return v; } function tryCatch(fn) { let val; try { val = fn(); } catch (e) { console.log(e.message); } return val; } // æµ‹è¯• console.log(\u0026#34;null: \u0026#34; + ToNumber(null)); console.log(\u0026#34;unefined: \u0026#34; + ToNumber(undefined)); console.log(\u0026#34;{}: \u0026#34; + ToNumber({})); console.log(\u0026#34;[]: \u0026#34; + ToNumber([])); console.log(\u0026#34;Symbol(\u0026#39;xx\u0026#39;): \u0026#34; + tryCatch(() =\u0026gt; ToNumber(Symbol(\u0026#34;xx\u0026#34;)))); console.log(\u0026#34;BigInt(100): \u0026#34; + tryCatch(() =\u0026gt; ToNumber(BigInt(100))));     è½¬æ¢è§„åˆ™ï¼š\n   ç±»å‹ ç»“æœ -     null 0    undefined NaN å…ˆè½¬æˆ \u0026#34;undefined\u0026#34;   [] 0 å…ˆ String([]) -\u0026gt; \u0026#39;\u0026#39;   {} NaN å…ˆ String({}) -\u0026gt; [object Object]   \u0026#34;xx\u0026#34; NaN -   100n 100 BigInt å¯ä»¥è½¬æˆ Number   Symbol TypeError ä¸èƒ½è½¬    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78  // éä¸¥æ ¼ç›¸ç­‰ï¼Œ == çš„å®ç° function equal(x, y) { // ç±»å‹ä¸€æ ·å°±ç›´æ¥è¿”å› x === y çš„ç»“æœ  if (Type(x) === Type(y)) { return strictEqual(x, y); } // 1. å³ null == undefined =\u0026gt; true  if ((x === null \u0026amp;\u0026amp; y === undefined) || (x === undefined \u0026amp;\u0026amp; y === null)) { return true; } // 2. å†…éƒ¨å±æ€§æ— æ³•ç›´æ¥è·å–ï¼Œè¿™é‡Œåˆ°æ—¶å€™ä½¿ç”¨å¯¹è±¡æ™®é€šå±æ€§æ¨¡æ‹Ÿ  if (isObject(x) \u0026amp;\u0026amp; hasOwn(x, \u0026#34;[[IsHTMLDDA]]\u0026#34;)) { if (y === null || y === undefined) { return true; } } if (isObject(y) \u0026amp;\u0026amp; hasOwn(y, \u0026#34;[[IsHTMLDDA]]\u0026#34;)) { if (x === null || x === undefined) { return true; } } // 3. å¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²ï¼Œå°†å­—ç¬¦ä¸²è½¬æˆæ•°å­—ä¹‹åè¿›è¡Œæ¯”è¾ƒ  if (isNum(x) \u0026amp;\u0026amp; isString(y)) { return strictEqual(x, ToNumber(y)); } if (isString(x) \u0026amp;\u0026amp; isNum(y)) { return strictEqual(ToNumber(x), y); } // 4. BigInt ç±»å‹å’Œå­—ç¬¦ä¸²æ¯”è¾ƒï¼Œå°†å­—ç¬¦ä¸²è½¬æˆ BigInt ç±»å‹  if (isBigInt(x) \u0026amp;\u0026amp; isString(y)) { let n = StringToBigInt(y); if (isNaN(n)) { return false; } return equal(x, n); } if (isString(x) \u0026amp;\u0026amp; isBigInt(y)) { return equal(y, x); } // 5. å¦‚æœæ˜¯å¸ƒå°”ç±»å‹è½¬æˆæ•°å­—å†è¿›è¡Œæ¯”è¾ƒ  if (isBool(x)) { return equal(ToNumber(x), y); } if (isBool(y)) { return equal(x, ToNumber(y)); } // 6. å¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å¼•ç”¨ç±»å‹ï¼Œå°†å…¶è½¬æˆåŸå§‹ç±»å‹å†æ¯”è¾ƒ  if (isRef(y) \u0026amp;\u0026amp; (isString(x) || isNum(x) || isBigInt(x) || isSymbol(x))) { return equal(x, ToPrimitive(y)); } if (isRef(x) \u0026amp;\u0026amp; (isString(y) || isNum(y) || isBigInt(y) || isSymbol(y))) { return equal(ToPrimitive(x), y); } // 7. BigInt å’Œ Number ç±»å‹  if (isBigInt(x) \u0026amp;\u0026amp; isNum(y)) { if (isNaN(x) || strictEqual(x, +Infinity) || strictEqual(x === -Infinity)) { return false; } if (isNaN(y) || strictEqual(y, +Infinity) || strictEqual(y === -Infinity)) { return false; } return equal(R(x), R(y)); } return false; }     è¿™é‡Œä¸»è¦æœ‰ 8 ç§æƒ…å†µ(equal(x, y)):\n  å¦‚æœ x, y ç±»å‹ä¸€æ ·ï¼Œç›´æ¥è¿”å› x === y ç»“æœï¼Œä¸éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢\n  å¦‚æœ null == undefined æˆ– undefined == null è¿›è¡Œæ¯”è¾ƒï¼Œç›´æ¥è¿”å› true\n  å¦‚æœ x æ˜¯å¯¹è±¡ä¸”æœ‰ [[IsHTMLDDA]] å†…éƒ¨å±æ€§ï¼Œä¸” y æ˜¯ null æˆ– undefined ç›´æ¥è¿” å› true, åä¹‹äº¦ç„¶ã€‚\n  å¦‚æœ x number, y string åˆ™å°†å…¶ä¸­å­—ç¬¦ä¸²è½¬æˆ number å†è¿›è¡Œ x === y æ¯”è¾ƒï¼Œåä¹‹ äº¦ç„¶ã€‚\n  å¦‚æœ x BigInt, y string åˆ™å°†å…¶ä¸­å­—ç¬¦ä¸²è½¬æˆ BigInt å†è¿›è¡Œ x === y æ¯”è¾ƒï¼Œåä¹‹ äº¦ç„¶ã€‚\n  å¦‚æœ x boolean å°† x è½¬æˆ number å† equal(number(x), y) é‡æ–°æ¯”è¾ƒï¼Œåä¹‹äº¦ç„¶ã€‚\n  å¦‚æœ x æ˜¯å¼•ç”¨ç±»å‹(å³ typeof x === \u0026#39;object\u0026#39;)ï¼Œè€Œ y æ˜¯æ™®é€šç±»å‹(String, Number, BigInt, Symbol)ï¼Œé‚£ä¹ˆå°† x è½¬æˆåŸå§‹ç±»å‹å†æ¯”è¾ƒï¼Œå³ equal(toPrimitive(x), y), åä¹‹äº¦ç„¶\n  å¦‚æœ x BigInt, y number åˆåŒºåˆ†å‡ ç§æƒ…å†µ\n  å¦‚æœ x: NaN è¿”å› NaN\n  å¦‚æœ x: +Infinity è¿”å› false\n  å¦‚æœ x: -Infinity è¿”å› false\n  å¦åˆ™è¿”å› equal(R(x), R(y)) R ä¸å¤ªæ¸…æ¥šå•¥æ„æ€ï¼Ÿ\n     æµ‹è¯•ï¼šå¯ä»¥é€šè¿‡è¡¨æ ¼ä¸‹é¢çš„è¾“å…¥æ¡†è¾“å…¥å·¦å³å€¼ç‚¹å‡»æäº¤ä¼šæ›´æ–°è¡¨æ ¼ï¼Œæœ‰ä¸¤ä¸ªç»“æœï¼Œä¸€ä¸ªæ˜¯ equal(x,y) æ˜¯è¯¥æ–‡æ ¹æ® ECMA æ ‡å‡†å®ç°çš„ç›¸ç­‰æ¯”è¾ƒï¼Œ x==y æ˜¯ç›´æ¥ä½¿ç”¨ == ç¬¦å·å¾— åˆ°çš„ç»“æœä¸ºäº†å½¢æˆå¯¹æ¯”ï¼Œæœ€åä¸€åˆ—ä¿¡æ¯æ˜¯æ¯ä¸€è¡Œçš„æ•°æ®åœ¨æ‰§è¡Œ equal(x,y) è¿‡ç¨‹ä¸­æ ‡è¯†äº† å“ªä¸ªå€¼è¿›è¡Œäº†ç±»å‹è½¬æ¢(/js/tests/web/equal.js), è¡¨æ ¼é‡‡ç”¨ Vue + ElementPlus ç”Ÿæˆï¼Œ æºç æ–‡ä»¶ï¼š /js/tests/X6j10iPkmj.jsã€‚\n     æœ€ç»ˆæ€»ç»“(ç±»å‹æ¯”è¾ƒ)ï¼š\n   ç±»å‹1 ç±»å‹2 éœ€è¦å¼ºè½¬ç±»å‹     number string string -\u0026gt; number   null undefined ç›´æ¥è¿”å› true   bigint string string -\u0026gt; bigint   boolean number boolean -\u0026gt; number, false-0, true-1   object æ™®é€šç±»å‹ object -\u0026gt; æ™®é€šç±»å‹     æ ¹æ®ä¸Šè¡¨çš„ç±»å‹è½¬æ¢ï¼Œå¯ä»¥è½»æ¾åˆ¤æ–­å‡ºä¸€äº›è¯¡å¼‚çš„ç°è±¡ï¼Œæ¯”å¦‚ï¼š\n 0 == [0] : [0] å…ˆè½¬å­—ç¬¦ä¸²å³ \u0026#34;0\u0026#34; ç„¶åå†è½¬æˆæ•°å­— 0 ç»“æœ: true\n 10 == [\u0026#34;10\u0026#34;] =\u0026gt; [\u0026#34;10\u0026#34;] =\u0026gt; \u0026#34;10\u0026#34; =\u0026gt; 10\n false == 0, true == 1 ç»“æœéƒ½æ˜¯ true éƒ½æ˜¯å› ä¸º boolean è½¬æˆäº† 0 æˆ– 1\nTODO IsHTMLDDA é—®é¢˜   How does this interact with [[IsHTMLDDA]â€‹] Â· Issue #108 Â· tc39/proposal-optional-chaining\n  ","permalink":"https://www.cheng92.com/web/apis/js-api-equality-comparison/","tags":["javascript"],"title":"JavaScript Equality Comparison, ç­‰å·è¿ç®—ç¬¦"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬æ–‡ä»æºç è§’åº¦è®²è§£äº†ç»„ä»¶çš„æŒ‡ä»¤ç³»ç»Ÿï¼ŒåŒ…å«å„ç§å†…ç½®æŒ‡ä»¤ä»¥åŠè‡ªå®šä¹‰æŒ‡ä»¤åŸç†ã€‚\n  æŒ‡ä»¤åˆ—è¡¨\n   æŒ‡ä»¤åç§° ç”¨é€”     v-text æ›¿æ¢å…ƒç´  textContext   v-html æ›¿æ¢å…ƒç´  innerHTML   v-show æ˜¾ç¤ºéšè—å…ƒç´  display å±æ€§   v-if[else/else-if]â€‹ æ¡ä»¶æ¸²æŸ“ï¼Œoff-dom æ“ä½œ   v-for åˆ—è¡¨æ¸²æŸ“ï¼Œå¾ªç¯æ“ä½œ   v-on äº‹ä»¶ç»‘å®š   v-bind çŠ¶æ€ç»‘å®š   v-model åŒå‘ç»‘å®š   v-slot æ’æ§½æŒ‡ä»¤, v-slot:name=\u0026#34;scope\u0026#34;   v-pre ä»£ç æŒ‡ä»¤   v-cloak ç»„ä»¶æ¸²æŸ“å®Œæˆä¹‹å‰å…ƒç´ ä¸€ç›´æ˜¯ display:none   v-once åªæ¸²æŸ“ä¸€æ¬¡ï¼Œç¼“å­˜æœºåˆ¶å®ç°   v-is ?    TODO v-text   TODO v-html   TODO v-show   TODO v-if   TODO v-for   TODO v-on   TODO v-bind   TODO v-model   TODO v-slot   TODO v-pre   TODO v-cloak   TODO v-once   TODO v-is   ","permalink":"https://www.cheng92.com/vue/vue-teardown-5-directives/","tags":["vue3,","vue-next,","component,","directives"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘¤ directives æŒ‡ä»¤ç³»ç»Ÿ"},{"categories":["vue"],"contents":" è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       æœ¬æ–‡ä»æºç è§’åº¦è®²è§£äº†ï¼Œç»„ä»¶çš„å±æ€§å½’ç±»é—®é¢˜ï¼Œå½“ç»™ä¸€ä¸ªç»„ä»¶ä¼ é€’ä¸ªå±æ€§æ—¶ï¼Œåœ¨è¯¥ç»„ä»¶å†…éƒ¨ å®ƒå±äºprops è¿˜æ˜¯ attrs ã€‚\n  è¿™ä¸¤ä¸ªå±æ€§åœ¨ç»„ä»¶ä¸Šæ˜¯å¦‚ä½•åŒºåˆ†çš„ï¼Ÿ\n å½“çˆ¶ç»„ä»¶ç»™å­ç»„ä»¶ä¼ é€’å±æ€§çš„æ—¶å€™ï¼Œæœ€ç»ˆéƒ½åˆ’åˆ†åˆ°é‚£ä¸ªå¯¹è±¡ä¸Šäº†ï¼Ÿ\n å…ˆä¸Šå®ä¾‹ï¼Œç‚¹å‡»æŒ‰é’®å¯æŸ¥çœ‹å¯¹åº”ç»“æœåˆ†æ(/js/vue/tests/7jAWzTeF1O.js):\n    é¦–å…ˆï¼Œåœ¨ compiler é˜¶æ®µæ‰€æœ‰å±æ€§éƒ½ä¼šè¢«ç¼–è¯‘åˆ° vnode.props ä¸Šï¼Œåœ¨ runtime-core patch é˜¶æ®µæ‰ä¼šåŒºåˆ† props å’Œ attrsï¼Œé‚£è¿™äº›å±æ€§åˆæ˜¯å¦‚ä½•åšçš„åŒºåˆ†ï¼Œå½“å¼€å‘çš„æ—¶å€™ç»™å­ç»„ä»¶ä¼  é€’çš„å±æ€§æœ€ç»ˆéƒ½æ”¾åˆ°å“ªä¸ªé‡Œé¢äº†ï¼Ÿ\n è¿™é‡Œé¢å°±å¾—å¥½å¥½æ°æ‰¯æ°æ‰¯äº†ï¼ï¼ï¼\n æ ¹æ®ä¹‹å‰çš„æºç åˆ†æï¼Œç»„ä»¶ patch æµç¨‹: processComponent -\u0026gt; mountComponent æˆ– updateComponent è¿™é‡Œæˆ‘ä»¬ä»¥ç»„ä»¶é¦–æ¬¡æ¸²æŸ“è¿›å…¥ mountComponent ä¸ºä¾‹ã€‚\n mountComopnent ç®€åŒ–ä¹‹åå…¶å®å°±ä¸¤ä¸ªéƒ¨åˆ†ï¼š\n  setupComponent() åˆå§‹åŒ– props, slots æ‰§è¡Œ setup ç­‰å¾…\n  setupRenderEffect() ç»™å½“å‰ç»„ä»¶å®ä¾‹æ³¨å†Œ instance.update ç»„ä»¶æ›´æ–°æ—¶è°ƒç”¨çš„ effect å‡½æ•°ã€‚\n   æ‰€ä»¥è¿™é‡Œå…ˆå¿½ç•¥ç¬¬ 2 ç‚¹ï¼Œåªè®²è®² mount é˜¶æ®µ setupComopnent() ä¸­å±æ€§åˆå§‹åŒ–å¤„ç† (setupComponent: initProps())ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  export function setupComponent( instance: ComponentInternalInstance, isSSR = false ) { isInSSRComponentSetup = isSSR const { props, children, shapeFlag } = instance.vnode // è¿™é‡ŒåŒºåˆ†æœ‰æ— çŠ¶æ€ç»„ä»¶ï¼Œæ— çŠ¶æ€ç»„ä»¶å°±æ˜¯å‡½æ•°ç»„ä»¶ï¼Œå¯¹è±¡ç»„ä»¶æ˜¯æœ‰çŠ¶æ€ç»„ä»¶  const isStateful = shapeFlag \u0026amp; ShapeFlags.STATEFUL_COMPONENT // è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œ isSSR æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„é—®é¢˜è¿™é‡Œæš‚ä¸è®¨è®º  initProps(instance, props, isStateful, isSSR) initSlots(instance, children) const setupResult = isStateful ? setupStatefulComponent(instance, isSSR) : undefined isInSSRComponentSetup = false return setupResult }     props åˆå§‹åŒ–æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  export function initProps( instance: ComponentInternalInstance, rawProps: Data | null, isStateful: number, // result of bitwise flag comparison  isSSR = false ) { const props: Data = {} const attrs: Data = {} def(attrs, InternalObjectKey, 1) setFullProps(instance, rawProps, props, attrs) // validation  if (__DEV__) { validateProps(props, instance) } if (isStateful) { // stateful  instance.props = isSSR ? props : shallowReactive(props) } else { if (!instance.type.props) { // functional w/ optional props, props === attrs  instance.props = attrs } else { // functional w/ declared props  instance.props = props } } instance.attrs = attrs }     def(attrs, InternalObjectKey, 1)\n å¢åŠ : attrs.__vInterval = true å±æ€§\n å‡½æ•°æœ€åçš„ isStateful åˆ¤æ–­æ˜¯æ£€æµ‹å‡½æ•°ç»„ä»¶æˆ–å¯¹è±¡ç»„ä»¶çš„ï¼Œå¦‚æœæ˜¯å‡½æ•°ç»„ä»¶ï¼Œä¸€èˆ¬æ²¡æœ‰ props å±æ€§ï¼Œé™¤éæ‰‹åŠ¨ç»™å‡½æ•°å¢åŠ ä¸€ä¸ª props ï¼Œä¸è¿‡ä¸€èˆ¬ä¸è¿™ä¹ˆç”¨ï¼Œå¦‚æœæœ‰ props å»ºè®®è¿˜ æ˜¯ç”¨å¯¹è±¡ç»„ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œç­‰äºè¯´å‡½æ•°çš„ props å³ attrsï¼Œ attrs å³ propsã€‚\n setFullProps(instance, rawProps, props, attrs) è¿™ä¸ªæ˜¯é‡ç‚¹éƒ¨åˆ†ï¼Œå› ä¸ºåœ¨è¿™é‡Œå¼€å§‹ åŒºåˆ† props å’Œ attrsã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  function setFullProps( instance: ComponentInternalInstance, rawProps: Data | null, props: Data, attrs: Data ) { const [options, needCastKeys] = instance.propsOptions; if (rawProps) { for (const key in rawProps) { const value = rawProps[key]; // key, ref are reserved and never passed down  if (isReservedProp(key)) { continue; } // prop option names are camelized during normalization, so to support  // kebab -\u0026gt; camel conversion here we need to camelize the key.  let camelKey; if (options \u0026amp;\u0026amp; hasOwn(options, (camelKey = camelize(key)))) { props[camelKey] = value; } else if (!isEmitListener(instance.emitsOptions, key)) { // Any non-declared (either as a prop or an emitted event) props are put  // into a separate `attrs` object for spreading. Make sure to preserve  // original key casing  attrs[key] = value; } } } if (needCastKeys) { const rawCurrentProps = toRaw(props); for (let i = 0; i \u0026lt; needCastKeys.length; i++) { const key = needCastKeys[i]; props[key] = resolvePropValue( options!, rawCurrentProps, key, rawCurrentProps[key], instance ); } } }     ä¸¤æ®µå¤„ç†ä»£ç \n  rawProps å¤„ç†ï¼Œæ¥è‡ª compiler é˜¶æ®µç¼–è¯‘åçš„ vnode.props\n  key, ref ä¿ç•™å±æ€§ï¼Œå³ä¸ä¼šå¾€ä¸‹ä¼ é€’çš„å±æ€§ï¼Œç­‰äºæ˜¯ä½œç”¨äºè¯¥å…ƒç´ è‡ªèº«çš„\n  å…¶æ¬¡ï¼Œoptions -\u0026gt; instanceOptions ä¸­å­˜åœ¨çš„ key çš„å±æ€§å±äº props\n  æœ€åï¼Œé emits é€‰é¡¹ä¸­çš„å±æ€§å±äº attrs\n    needCastKeys ä¸€äº›éœ€è¦åˆå§‹åŒ–å€¼çš„å±æ€§çš„ keyï¼Œæ¯”å¦‚ï¼š Boolean ç±»å‹å€¼éœ€è¦åˆå§‹åŒ–æˆ false ã€‚\n   è¿™é‡Œæ¶‰åŠ options é‡Œçš„å±æ€§ instance.propsOptions è¿™ä¸ªåœ¨åˆå§‹åŒ–ç»„ä»¶å®ä¾‹çš„æ—¶å€™é¡ºå¸¦ åˆå§‹åŒ–äº†\n propsOptions: normalizePropsOptions(type, appContext)\n è¿™ä¸ªå€¼æ˜¯ä¸ªæ•°ç»„ï¼š [normalized, needCastKeys]\n normalized æ˜¯æ£€æµ‹ç±»å‹å®šä¹‰ä¹‹åçš„ propsï¼Œæ¯”å¦‚ï¼š\n {foo: [Boolean, String]} =\u0026gt; normalized.foo = {type: [Boolean, String]}\n è¡¨ç¤º foo å¯ä»¥æ˜¯å¸ƒå°”ç±»å‹æˆ–è€…å­—ç¬¦ä¸²ç±»å‹ã€‚\n {foo: Function} =\u0026gt; normalized.foo = { type: Function}\n needCastKeys è¡¨ç¤ºæ˜¯éœ€è¦å¯¹å±æ€§å€¼è¿›è¡Œå¤„ç†æˆ–è€…å«åˆå§‹åŒ–çš„keysï¼Œæ¯”å¦‚ï¼š { foo: Boolean, bar: { default: 1 } } é‚£ä¹ˆ foo çš„å€¼è¦åœ¨ setFullProps() é‡Œé¢è½¬æˆ false å€¼ï¼Œä»¥åŠ bar=1 ï¼Œæ‰€ä»¥æœ€åè¿™ä¸ª props å®é™…ç­‰äº {foo: false, bar: 1} è½¬æ¢è§„åˆ™åœ¨ setFullProps() -\u0026gt; resolvePropValue() ä¸­å®Œæˆã€‚\n è§„åˆ™å¦‚ä¸‹ï¼š\n  {foo: { default: function() {/*...*/} }}\n ç±»å‹ä¸æ˜¯ Function ä½†æ˜¯ default å€¼æ˜¯ä¸ªå‡½æ•°ï¼Œåˆ™éœ€è¦æ‰§è¡Œè¿™ä¸ªå‡½æ•°å¾—åˆ°è¯¥å±æ€§æœ€ç»ˆçš„ é»˜è®¤å€¼ {foo: default(props) } ä¼ ç»™è¿™ä¸ªå‡½æ•°æ˜¯æ•´ä¸ª props å¯¹è±¡ã€‚\n  {foo: { default: function() {/*...*/}, type: Function }} ç±»å‹æ˜¯å‡½æ•°ï¼Œè¡¨ç¤ºè¿™ä¸ªå±æ€§æœ¬èº«å°±æ˜¯å‡½æ•°ï¼Œä¸éœ€è¦åšä»€ä¹ˆå¤„ç†ï¼Œç›´æ¥å°†è¿™ä¸ªå‡½æ•°å½“åšé»˜ è®¤å€¼å¤„ç† {foo: default}\n  {foo: {default: 100}} ç­‰ä»·äº {foo: 100} default æ˜¯æ™®é€šç±»å‹çš„å…·ä½“å€¼çš„å¤„ç†\n  BooleanFlags.shouldCast è¡¨ç¤ºç±»å‹å®šä¹‰ä¸­æœ‰ Boolean ç±»å‹\n BooleanFlags.shouldCastTrue æ—¶å¯èƒ½æƒ…å†µ {foo: [Boolean, String]}, {foo: [Boolean]} è¦ä¹ˆåªæœ‰ Boolean è¦ä¹ˆ Boolean åœ¨ String å‰é¢ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§æ›´ é«˜ã€‚\n å‡ ç§æƒ…å†µï¼š\n  \u0026lt;Child/\u0026gt;, {foo: Boolean}, ç»“æœ: {foo: false}\n  \u0026lt;Child/ foo=true\u0026gt;, {foo: Boolean}, ç»“æœï¼š {foo: true}\n  \u0026lt;Child foo=\u0026#34;\u0026#34;/\u0026gt;, {foo: [Boolean, String]}, ç»“æœ: {foo: true}\n è¿™ç§æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œvue çš„å¤„ç†æ˜¯å½“ä¸¤ç§ç±»å‹éƒ½å­˜åœ¨ï¼Œä¸” Boolean åœ¨ String å‰é¢çš„ æ—¶å€™ï¼Œä¼šå°†å€¼ä¸º \u0026#34;\u0026#34; çš„ç©ºä¸²ï¼Œè½¬æˆ true ï¼Œä½œä¸º foo çš„é»˜è®¤å€¼ã€‚\n     æœ€åçš„ç»“æœä¼šåœ¨ comp.__props = [normalized, needCastKeys] ä¿å­˜ä¸€ä»½ã€‚\n normalizePropsOptions() å‡½æ•°å°±ä¸å±•å¼€åˆ†æäº†ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ needCastKeys æ˜¯ åšä»€ä¹ˆçš„ã€‚\n æ‰€ä»¥ï¼š\n props: option api props é‡Œé¢çš„å­˜åœ¨çš„ key å½’ç»“ä¸º props\n attrs: å…¶ä»–æƒ…å†µï¼Œé™¤äº† emits ä¸­å­˜åœ¨çš„ key ä¹‹å¤–éƒ½å½’ç»“ä¸º attrs\n    å®ä¾‹ defined? props, é»˜è®¤å€¼ attrs     \u0026lt;Child name=\u0026#34;child\u0026#34;/\u0026gt; no no yes   \u0026lt;Child name=\u0026#34;child\u0026#34;/\u0026gt; yes yes no   \u0026lt;Child name=\u0026#39;\u0026#39; /\u0026gt; yes, Boolean yes, false no   \u0026lt;Child name=\u0026#39;\u0026#39; /\u0026gt; yes, [Boolean,String] yes, true no   \u0026lt;Child name=\u0026#34;child\u0026#34; /\u0026gt; yes, [String], default: fn yes, fn() no   \u0026lt;Child onClick=\u0026#34;fn\u0026#34;/\u0026gt; no yes no    ","permalink":"https://www.cheng92.com/vue/vue-teardown-4-props-attrs/","tags":["vue3,","vue-next,","component,","props,","attrs"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘£ ç»„ä»¶ props \u0026 attrs"},{"categories":["javascript,","web"],"contents":" Number::toString ( x )\n åœ¨è¿›è¡Œä¼ªç ä¹‹å‰ï¼Œè¿™é‡Œå…ˆè¦å¼„æ¸…æ¥šå‡ ç‚¹ï¼š\n  æ ‡å‡†ä¸­çš„ n, k, s åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆæ„æ€ï¼Ÿ\n n: è¿™ä¸ªæ•°æœ‰ç‚¹è¿·æƒ‘ï¼Œæ¯”å¦‚ï¼š 100, n = 3; 0.01, n = -2ï¼Œå¦‚æœæ˜¯æ•´æ•°è¡¨ç¤ºæ­£æ•°ä½æ•°ï¼Œ å¦‚æœæ˜¯æµ®ç‚¹æ•°å°±è¡¨ç¤ºå°æ•°ç‚¹çš„ä½æ•°\n s: è¡¨ç¤ºä¸€ä¸ªå€¼çš„èŒƒå›´\n k: åº”è¯¥è¡¨ç¤ºæ•´æ•°éƒ¨åˆ†\n  æ ‡å‡†ä¸­ä¸ºä»€ä¹ˆ n çš„ä¸Šé™æ˜¯ 21 ?\n ä¸Šé™æ˜¯ 21 æ˜¯å› ä¸ºè¶…è¿‡21ä½çš„æ•°å­—ä¼šè½¬æˆæŒ‡æ•°è¡¨ç¤ºå½¢å¼ï¼Œå¦‚ä¸‹ï¼š\n  æ‰€ä»¥è¿™é‡Œå°† n ä¸Šé™è®¾ç½®ä¸º 21 ä¸€æ—¦è¶…å‡ºå°±ä¼šè½¬æˆæŒ‡æ•°æ¥è¡¨ç¤ºï¼Œè¿™ä¸ªæ—¶å€™å­—ç¬¦ä¸²åŒ–å°±æ˜¯å¦ ä¸€ç§å¤„ç†æ–¹å¼äº†ã€‚\n  æ ‡å‡†æ­¥éª¤ä¸­ä½¿ç”¨åˆ°çš„ä¸€äº›16è¿›åˆ¶è¡¨ç¤ºçš„ç¬¦å·éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ\n1  ;[0x002E, 0x0030, 0x0065, 0x002b, 0x002D /**/].forEach(n =\u0026gt; console.log(String.fromCharCode(n)))    . 0 e + - undefined     code char     0x002E .   0x0030 0   0x0065 e   0x002B +   0x002D -        å¼„æ¸…æ¥šäº†ä¸Šé¢çš„ä¸‰ç‚¹ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥é€æ­¥å»å®ç°æ•°å­—è½¬å­—ç¬¦ä¸²æ“ä½œäº†ï¼š\n ä¼ªç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71  function floatn(n) { // å°æ•°ç‚¹åé¢æ•°ä¸ªæ•°  let c = 0; while ((n *= 10) % 10) { console.log(\u0026#34;n =\u0026#34; + n); c++; } return c; } function intn(n) { let c = 0; while (n) { c++; n = Math.floor(n / 10); } return c; } function bit(m) { let c = 0, k = 0, n = 0; if (m \u0026gt; 0 \u0026amp;\u0026amp; m \u0026lt; 10) { // 1 ~ 10 ä¹‹é—´çš„æ•°åŒ…æ‹¬æµ®ç‚¹æ•°  k = 1; } } function /*Number::*/ toString(x) { if (isNaN(x)) return NaN; if (x === +0 || x === -0) return \u0026#34;0\u0026#34;; if (x \u0026lt; +0) { // è´Ÿæ•°  return; /*Numbr::*/ toString(-x); } if (x === +Infinity) { return \u0026#34;Infinity\u0026#34;; } const nx = Math.floor(x); let n = bit(x), // æ•´ä¸ªæ•°å­—çš„æ•°å­—éƒ¨åˆ†é•¿åº¦ï¼Œä¸å«å°æ•°ç‚¹  k = bit(nx), // æ•´æ•°éƒ¨åˆ†é•¿åº¦  s; // å–å€¼èŒƒå›´ï¼šk \u0026gt;= 1, Math.pow(10, k-1) \u0026lt;= s \u0026lt;= Math.pow(10, k)  // s x Math.pow(10, n - k)  if (k \u0026lt;= n \u0026lt;= 21) { return \u0026#34;\u0026#34; + x; // ç›´æ¥è½¬æˆå­—ç¬¦ä¸²å°±å¯ä»¥äº†  } else if (0 \u0026lt; n \u0026lt;= 21) { // TODO  } else if (-6 \u0026lt; n \u0026lt;= 0) { return \u0026#34;\u0026#34; + x; // 0.000005  } else if (k === 1) { return s + \u0026#34;e\u0026#34; + (n - 1 \u0026lt; 0 ? \u0026#34;-\u0026#34; : \u0026#34;+\u0026#34;) + Math.abs(n - 1); // 1e+5 or 1e-5  } else { return ( s[0] + \u0026#34;.\u0026#34; + s.slice(1, k) + \u0026#34;e\u0026#34; + (n - 1 \u0026lt; 0 ? \u0026#34;-\u0026#34; : \u0026#34;+\u0026#34;) + Math.abs(n - 1) ); } return x; } console.log(floatn(0.1001), intn(100.12));    n =1.001 n =10.009999999999998 n =100.09999999999998 n =1000.9999999999998 n =10009.999999999998 n =100099.99999999999 n =1000999.9999999999 n =10009999.999999998 n =100099999.99999999 n =1000999999.9999999 n =10009999999.999998 n =100099999999.99998 n =1000999999999.9999 n =10009999999999.998 n =100099999999999.98 n =1000999999999999.9 n =10009999999999998 n =100099999999999980 n =1000999999999999900 n =10009999999999998000 n =100099999999999980000 n =1.0009999999999999e+21 n =1.001e+22 n =1.0009999999999999e+23 n =1.0009999999999999e+24 n =1.0009999999999998e+25 n =1.0009999999999997e+26 n =1.0009999999999998e+27 28 3 undefined  6 undefined  ","permalink":"https://www.cheng92.com/web/apis/js-api-number-tostring/","tags":["javascript,","api,","Number"],"title":"JavaScript Api - Number::toString ( x ) - TODO"},{"categories":["vue"],"contents":" è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");      æœ¬ç³»åˆ—ä¸º vue-next æºç åˆ†æç³»åˆ—çš„æ—ç³»åˆ†æ”¯ï¼Œä¸»è¦ç›®çš„åœ¨äºå¯¹ vue3 æºç ä¸­çš„ä¸€äº›ç»†èŠ‚è¿› è¡Œåˆ†æã€‚æœ¬æ–‡è®²è¿°çš„æ˜¯ vue3 ä¸­ç»„ä»¶çš„æ›´æ–°æœºåˆ¶ï¼Œæ¯”å¦‚ï¼šå±æ€§å˜æ›´çˆ¶å­ç»„ä»¶æ›´æ–°é¡ºåºæ˜¯å¦‚ ä½•ï¼Ÿã€‚\n  æ ¹æ®ç»„ä»¶çš„æ¸²æŸ“æµç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“ç»„ä»¶çš„æ›´æ–°å®é™…æ˜¯é€šè¿‡ effect å°è£…äº†ä¸€ä¸ª instance.update å‡½æ•°ï¼Œå½“ç»„ä»¶çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ä¼šè‡ªåŠ¨è§¦å‘è¿™ä¸ª update å‡½æ•°æ‰§è¡Œï¼Œå› ä¸ºè¿™ çŠ¶æ€ä»£ç†å±æ€§æœ‰æ”¶é›†åˆ°è¿™ä¸ª update å‡½æ•°ã€‚\n instance.update:\n instance.update = effect(function componentEffect() {/*...*/})\n åœ¨ vue-package-reactivity ä¸€èŠ‚ä¸­æœ‰æ›´è¯¦ç»†çš„ effect æºç åˆ†æã€‚\n ç»„ä»¶ç®€è¦æ¸²æŸ“ï¼Œå‡½æ•°æ‰§è¡Œæµç¨‹:\n  ç²¾ç®€ä¹‹åçš„ instance.update å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  function componentEffect() { if (!instance.isMounted) { // mount component  // invoke beforeMount(bm) hook  // invoke vnode before mount hook  const subTree = (instance.subTree = renderComponentRoot(instance)); patch(null, subTree, container, anchor, instance, parentSuspense, isSVG); initialVNode.el = subTree.el; // queue post - mounted(m) hook  // queue post - vnode mounted hook  // queue post - activated(a) hook  instance.isMounted = true; // #2458: deference mount-only object parameters to prevent memleaks  initialVNode = container = anchor = null as any; } else { // updateComponent  if (next) { next.el = vnode.el; updateComponentPreRender(instance, next, optimized); } else { next = vnode; } // invoke beforeUpdate(bu) hook  // invoke onVnodeBeforeUpdate hook  const nextTree = renderComponentRoot(instance); const prevTree = instance.subTree; instance.subTree = nextTree; // patch  patch( prevTree, nextTree, // parent may have changed if it\u0026#39;s in a teleport  hostParentNode(prevTree.el!)!, // anchor may have changed if it\u0026#39;s in a fragment  getNextHostNode(prevTree), instance, parentSuspense, isSVG ); next.el = nextTree.el; // queue post - updated(u) hook  // queue post - onVnodeUpdated  } }     ä¸»è¦åˆ†ä¸º mount å’Œ update ä¸¤éƒ¨åˆ†(ifâ€¦else)\n mount: beforeMount hook -\u0026gt; onVnodeBefoureMount -\u0026gt; renderComponentRoot subTree -\u0026gt; patch subTree -\u0026gt; mounted hook -\u0026gt; onVnodeMounted -\u0026gt; [ activated hook ]\n update: next ? -\u0026gt; beforeUpdate hook -\u0026gt; onVnodeBeforeUpdate -\u0026gt; renderComponentRoot nextTree -\u0026gt; patch -\u0026gt; updated hook -\u0026gt; onVnodeUpdated\n ä¸¤ä¸ªé˜¶æ®µä¸­ï¼Œæœ‰ä¸€ä¸ªç›¸å…³è”çš„éƒ¨åˆ†ï¼Œ subTree \u0026lt;-\u0026gt; nextTree ç­‰äºä¸€ä¸ªæ˜¯ old tree ä¸€ä¸ªæ˜¯ new treeï¼Œ mount é˜¶æ®µ patch(null, subTree) update é˜¶æ®µ patch(subTree, nextTree)\n tree çš„äº§ç”Ÿä¸€æ ·æ¥è‡ªåŒä¸€ä¸ªå‡½æ•°ï¼š\n mount: renderComponentRoot(instance)\n update: renderComponentRoot(instance)\n è¿™ä¸ªå‡½æ•°é‡Œé¢ä¼šå»æ‰§è¡Œ instance çš„ render å‡½æ•°å¾—åˆ°æœ€æ–°çš„ vnode tree ï¼Œç­‰äºæ˜¯çŠ¶æ€æ›´ æ–°è§¦å‘è¿™ä¸ªå‡½æ•°å»æ‰§è¡Œ render å¾—åˆ°æœ€æ–°çš„ç»„ä»¶ vnode trueeã€‚\n render å‡½æ•°æ¥æºï¼šå¦‚æœæ˜¯å‡½æ•°ç»„ä»¶å°±æ˜¯è¯¥å‡½æ•°æœ¬èº«(instance.type)ï¼Œå¦‚æœæ˜¯å¯¹è±¡ç»„ä»¶åˆ™ æ˜¯å¯¹è±¡å†…éƒ¨çš„ instance.render å‡½æ•°(å¯èƒ½æ¥è‡ª setup è¿”å›çš„å‡½æ•°)ã€‚\n æµ‹è¯•(/js/vue/tests/L3jBmxJfNN.js)ï¼šçˆ¶å­ç»„ä»¶æ›´æ–°é¡ºåº\n   ä¸Šé¢é“¾æ¥å¯ä»¥æŸ¥çœ‹æµ‹è¯•æºç ã€‚\n è¿™é‡Œæˆ‘ä»¬åœ¨çˆ¶å­ç»„ä»¶ä¸­å‡å¢åŠ ç»„ä»¶æ›´æ–° hook:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const Child = defineComponent({ setup() { onUpdated(() =\u0026gt; log(\u0026#34;child updated\u0026#34;)); onBeforeUpdate(() =\u0026gt; log(\u0026#34;child before update\u0026#34;)); }, // ... }); const Parent = defineComponent({ setup() { onUpdated(() =\u0026gt; log(\u0026#34;parent updated\u0026#34;)); onBeforeUpdate(() =\u0026gt; log(\u0026#34;parent before update\u0026#34;)); }, // ... });     ç‚¹å‡»æŒ‰é’®å¯ä»¥æ”¹å˜çˆ¶å­ç»„ä»¶é¢œè‰²ï¼ŒæŸ¥çœ‹è¾“å‡ºç»“æœï¼Œä¼šå‘ç°\n  åªæ›´æ–°çˆ¶ç»„ä»¶èƒŒæ™¯è‰²ï¼Œåªä¼šè§¦å‘ parent log\n  åªæ›´æ–°å­ç»„ä»¶èƒŒæ™¯è‰²ï¼Œåªä¼šè§¦å‘ child log\n  æ›´æ–°çˆ¶ç»„ä»¶èƒŒæ™¯è‰²ï¼ŒåŒæ—¶æ”¹å˜çˆ¶ç»„ä»¶ä¸­ä¼ é€’ç»™å­ç»„ä»¶çš„å±æ€§\n å­ç»„ä»¶ style.backgroud å±æ€§ç»‘å®š bgcolorï¼Œè¯¥å€¼æ¥è‡ª parent ä¼ é€’è¿›æ¥çš„ attrsï¼Œè¿™ é‡Œä¸ºä½•æ˜¯ attrs è€Œä¸æ˜¯ props ?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  function changeParentColorWithProp() { changeParentColor(); bgcolor.value = bgcolor.value === \u0026#34;black\u0026#34; ? \u0026#34;coral\u0026#34; : \u0026#34;black\u0026#34;; } const Child = defineComponent({ setup() { onUpdated(() =\u0026gt; log(\u0026#34;child updated\u0026#34;)); onBeforeUpdate(() =\u0026gt; log(\u0026#34;child before update\u0026#34;)); }, render() { const { bgcolor } = this.$attrs; return h( \u0026#34;p\u0026#34;, { style: { background: bgcolor.value || childBgColor.value, }, onVnodeUpdated(newVnode, oldVnode) { log( \u0026#34;child vnode updated, new: \u0026#34; + newVnode.props.style.background + \u0026#34;, old: \u0026#34; + oldVnode.props.style.background ); }, }, \u0026#34;æˆ‘æ˜¯å­ç»„ä»¶\u0026#34; ); }, });      ","permalink":"https://www.cheng92.com/vue/vue-teardown-3-update-flow/","tags":["vue3,","vue-next,","component"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘¢ ç»„ä»¶æ›´æ–°æœºåˆ¶"},{"categories":["react"],"contents":"  è¯—å·ï¼šåŠç¥åŠåœ£äº¦åŠä»™ï¼Œå…¨å„’å…¨é“æ˜¯å…¨è´¤ï¼Œè„‘ä¸­çœŸä¹¦è—ä¸‡å·ï¼ŒæŒæ¡æ–‡æ­¦åŠè¾¹å¤©ã€‚  \n  è¯¥æ–‡ä»£ç å‡æ¥è‡ªï¼šBuild your own Reactï¼Œ æ‰€ä»¥æ–‡ä¸­ä»£ç ä¼šä¿æŒå’ŒåŸä½œè€…å®šä¹‰ä¸€è‡´ã€‚\n ä»£ç è„‘å›¾  1 2 3  const element = \u0026lt;h1 title=\u0026#34;foo\u0026#34;\u0026gt;Hello\u0026lt;/h1\u0026gt;; const container = document.getElementById(\u0026#34;root\u0026#34;); ReactDOM.render(element, container);      å®ç°ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤\n  createElement å‡½æ•°å®ç°\n  render å‡½æ•°å®ç°\n  å¹¶å‘æ¨¡å¼ï¼Œæ¸²æŸ“ä»»åŠ¡çš„æ‰§è¡Œ workLoop() å‡½æ•°\n  Fibers react ä¸­é€šè¿‡ fiber ç»“æ„æ¥é“¾æ¥ parent, first child, sibling ä»¥åŠä½œä¸ºèŠ‚ ç‚¹çš„ç»“æ„ï¼Œç±»ä¼¼ vue çš„ VNode\n  æ¸²æŸ“å’Œ commit é˜¶æ®µï¼Œä¸ºäº†è§£å†³æ¸²æŸ“è¿›ç¨‹å¯èƒ½è¢«æµè§ˆå™¨ä¸­æ–­çš„é—®é¢˜ï¼Œé‡‡å–çš„æ˜¯å»¶è¿Ÿæ¸²æŸ“ï¼Œ å³åœ¨æ‰€æœ‰çš„ fiber å¤„ç†å®Œä¹‹åï¼Œåœ¨æœ€åæ‰§è¡Œæ¸²æŸ“æ“ä½œã€‚\n  æ›´æ–°ï¼Œæ–°å¢ï¼Œåˆ é™¤æ“ä½œ\n  å‡½æ•°å¼ç»„ä»¶å®ç°\n  é’©å­å‡½æ•°çš„å®ç° useState\n    é¢„è§ˆ   react ä½¿ç”¨å®ä¾‹ï¼š\n1 2 3  const element = \u0026lt;h1 title=\u0026#34;foo\u0026#34;\u0026gt;Hello\u0026lt;/h1\u0026gt;; const container = document.getElementById(\u0026#39;root\u0026#39;); ReactDOM.render(element, container)     é¦–å…ˆ const element = \u0026lt;h1 title=\u0026#34;foo\u0026#34;\u0026gt;Hello\u0026lt;/h1\u0026gt;; å±äº JSX ä¹¦å†™é£æ ¼ï¼Œè¿™ä¸ªä¼šè¢«è½¬ æ¢æˆ JS ä»£ç :\n1 2 3 4 5  // å‚æ•°ï¼š // 1. type: \u0026#39;h1\u0026#39; æ ‡ç­¾å // 2. props: {title: \u0026#39;foo\u0026#39;} ä¸ºå…ƒç´ çš„å±æ€§å¯¹è±¡ // 3. children: \u0026#39;Hello\u0026#39; ä¸ºå­å…ƒç´  const element = React.createElement(\u0026#34;h1\u0026#34;, { title: \u0026#34;foo\u0026#34; }, \u0026#34;Hello\u0026#34;);     å…¶æ¬¡æ˜¯ ReactDOM.render(element, container) è¿›è¡Œæ¸²æŸ“åˆ°çœŸå®DOMçš„æ“ä½œï¼Œè¿™ä¸ªå‡½æ•°çš„ åŠŸèƒ½ç®€è¿°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  // 1. æ ¹æ® element.type å»åˆ›å»º off-dom å…ƒç´  const node = document.createElement(element.type); // 2. è®¾ç½®å±æ€§ props node[\u0026#39;title\u0026#39;] = element.props.title // 3. å¤„ç† children å­å…ƒç´  const text = document.createTextNode(\u0026#39;\u0026#39;) text[\u0026#39;nodeValue\u0026#39;] = element.props.children // 4. æœ€åæ›´æ–°åˆ°çœŸå®DOMæ ‘ node.appendChild(text) container.appendChild(node)     æ‰€ä»¥ render å‡½æ•°çš„åŠŸèƒ½æ€»ç»“ä¸‹æ¥å°±åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š\n  æ‹¿åˆ°èŠ‚ç‚¹çš„ fiber ç»“æ„ï¼Œåˆ›å»º off-dom å…ƒç´ \n  å¤„ç† element.props å±æ€§(å¯èƒ½æ˜¯åŠ¨æ€ï¼Œé™æ€ï¼Œä¹Ÿå¯èƒ½æ˜¯äº‹ä»¶å±æ€§)\n  å¤„ç† element.children å­å…ƒç´ \n  æ›´æ–°åˆ°çœŸå®çš„ DOM æ ‘\n   å…·ä½“çš„å®ç°éƒ½æ˜¯å›´ç»•è¿™ä¸ªç‚¹å»å®Œæˆçš„ï¼Œ\n æ¯”å¦‚ 1 ä¼šä½¿ç”¨ fiber ç»“æ„æ¥ç»„ç»‡æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹ç»“æ„ä¸€èˆ¬ä¼šæœ‰ä¸‰ä¸ªå¼•ç”¨ï¼š parentã€first childã€sibling è¿™ä¸‰ä¸ªé“¾æ¥è¿™ä¸ªæ•´ä¸ªfiber æ ‘çš„ï¼Œè¿™ä¹Ÿä¸ºäº†åé¢èŠ‚ç‚¹æ“ä½œ æ—¶æ–¹ä¾¿æŸ¥æ‰¾ã€‚\n åˆæ¯”å¦‚ 2 ä¸­å¯¹ props çš„å¤„ç†ï¼Œä¼šè€ƒè™‘æ˜¯ä¸æ˜¯äº‹ä»¶å±æ€§ onXxx ã€‚\n ä»¥åŠæœ€åæ›´æ–°çœŸå®DOMçš„æ—¶æœºç­‰å¾…ã€‚\n nodeValue: HTML DOM nodeValue Property\n   å®Œæ•´ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // createElement: jsx -\u0026gt; js vnode ç»“æ„ const element = { type: \u0026#39;h1\u0026#39;, props: { title: \u0026#39;foo\u0026#39;, children: \u0026#39;Hello\u0026#39; } } const container = document.getElementById(\u0026#39;root\u0026#39;) // åˆ›å»ºèŠ‚ç‚¹ const node = document.createElement(element.type) node[\u0026#39;title\u0026#39;] = element.props.title // åˆ›å»ºå­èŠ‚ç‚¹ const text = document.createTextNode(\u0026#39;\u0026#39;) text[\u0026#39;nodeValue\u0026#39;] = element.props.children node.appendChild(text) container.appendChild(node)    æµ‹è¯•ï¼š   // createElement: jsx - js vnode ç»“æ„ const element = { type: 'h1', props: { title: 'foo', children: 'Hello' } } const container = document.getElementById('c07Rp8') // åˆ›å»ºèŠ‚ç‚¹ const node = document.createElement(element.type) node['title'] = element.props.title // åˆ›å»ºå­èŠ‚ç‚¹ const text = document.createTextNode('') text['nodeValue'] = element.props.children node.appendChild(text) container.appendChild(node)     createElement   JSX å®ä¾‹:\n1 2 3 4 5 6  const element = ( \u0026lt;div id=\u0026#34;foo\u0026#34;\u0026gt; \u0026lt;a\u0026gt;bar\u0026lt;/a\u0026gt; \u0026lt;b /\u0026gt; \u0026lt;/div\u0026gt; )     è½¬æˆ JS åè°ƒç”¨ createElement:\n1 2 3 4 5 6 7 8  React.createElement( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, }, React.createElement(\u0026#34;a\u0026#34;, null, \u0026#34;bar\u0026#34;), React.createElement(\u0026#34;b\u0026#34;) );     ä¸€ä¸ªèŠ‚ç‚¹åœ¨æ¸²æŸ“åˆ° DOM ä¹‹å‰éƒ½ä¼šæ˜¯ä»¥ä¸€ä¸ªVNode å½¢å¼å­˜åœ¨ï¼Œå…¶ä¸­å°±åŒ…å«æœ€åŸºæœ¬çš„ type, props å±æ€§ã€‚\n {type: \u0026#39;div\u0026#39;, props: { id: \u0026#39;foo\u0026#39;, children: ... } }\n è¿™å’Œ vue vnode ç»“æ„æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡ vue vnode çš„ children ä¸æ˜¯åœ¨ props é‡Œé¢ï¼š\n {type: \u0026#39;div\u0026#39;, props: {id: \u0026#39;foo\u0026#39;}, children: [...] }\n è¿™é‡Œåªè¦çŸ¥é“ createElement ç›®çš„æ˜¯è§£æèŠ‚ç‚¹ï¼Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹ç»“æ„å¯¹è±¡ï¼Œä¸‹é¢å°±å¯ä»¥å¼€å§‹å° è¯•å®ç° createElement äº†\n æœ€ç®€å•çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  // ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹éƒ½å½“åšå­å…ƒç´  function createElement(type, props, ...children) { return { type, props: { ...props, children, }, }; } // æ‰€ä»¥ï¼Œä¸Šé¢çš„å®ä¾‹ä¼šæœ‰å¦‚ä¸‹ç»“æ„ï¼š var div = { type: \u0026#34;div\u0026#34;, props: { id: \u0026#34;foo\u0026#34;, children: [a, b] }, }; var a = { type: \u0026#34;a\u0026#34;, props: { children: [\u0026#34;bar\u0026#34;], }, }; var b = { type: \u0026#34;b\u0026#34;, props: { children: [], // æ²¡æœ‰çš„æ—¶å€™é»˜è®¤è¿”å›ç©ºæ•°ç»„  }, };     è¿™é‡Œé¢å¯¹äº children æœ‰ä¸¤ç§ç±»å‹\n  \u0026lt;a\u0026gt;bar\u0026lt;/a\u0026gt; çš„ children åªæœ‰ \u0026#34;bar\u0026#34; æ˜¯ä¸ªçº¯æ–‡æœ¬ç±»å‹\n  \u0026lt;div\u0026gt;...\u0026lt;/div\u0026gt; çš„ children æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ a å’Œ b ï¼Œä»–ä»¬ç»è¿‡ createElement ä¹‹å éƒ½æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ä¸‹ï¼Œçº¯æ–‡æœ¬å»åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  function createElement(type, props, ...children) { return { type, props: { ...props, // è¿™é‡Œå¯¹äºæ–‡æœ¬å†…å®¹ï¼Œå»åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹  children: children.map((child) =\u0026gt; typeof child === \u0026#34;object\u0026#34; ? child : createTextElement(child) ), }, }; } function createTextElement(text) { return { type: \u0026#34;TEXT_ELEMENT\u0026#34;, // æ ‡è®°ç±»å‹  props: { // node.nodeValue å±æ€§å¯ä»¥è®¾ç½®æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹ï¼Œç±»ä¼¼ textContent  nodeValue: text, children: [], }, }; } // æµ‹è¯• const element = createElement( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34; }, createElement(\u0026#34;a\u0026#34;, null, \u0026#34;bar\u0026#34;), createElement(\u0026#34;b\u0026#34;) ); console.log( \u0026#34;è¾“å‡ºç»“æ„\u0026gt;\u0026gt;\u0026gt; \\n\u0026#34;, element, \u0026#34;\\n \u0026gt; element children: \\n\u0026#34;, element.props.children, \u0026#34;\\n \u0026gt; a children: \\n\u0026#34;, element.props.children[0].props.children ); // ä¸ºäº†åŒºåˆ« Reactï¼Œè¿™é‡Œé‡‡ç”¨æ–‡å­—ä½œè€…çš„å‘½åç©ºé—´ï¼š Didact const Didact = { createElement }    è¾“å‡ºç»“æ„\u0026gt;\u0026gt;\u0026gt; { type: \u0026#39;div\u0026#39;, props: { id: \u0026#39;foo\u0026#39;, children: [ [Object], [Object] ] } } \u0026gt; element children: [ { type: \u0026#39;a\u0026#39;, props: { children: [Array] } }, { type: \u0026#39;b\u0026#39;, props: { children: [] } } ] \u0026gt; a children: [ { type: \u0026#39;TEXT_ELEMENT\u0026#39;, props: { nodeValue: \u0026#39;bar\u0026#39;, children: [] } } ] undefined   ä¸ºäº†æ–¹ä¾¿åé¢çš„æµ‹è¯•ï¼Œè€ƒè™‘åˆ°ä»£ç ä¼šæ…¢æ…¢å˜é•¿é—®é¢˜ï¼Œåé¢çš„ä»£ç ä¼šç§»åˆ° /js/react/didact.js ä¸­å»ã€‚\n ä¹‹åæµ‹è¯•æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11  import(process.env.BLOG_JS + \u0026#34;/react/didact.js\u0026#34;).then(({ default: Didact }) =\u0026gt; { console.log(Didact); // è¿™æ ·ç…§æ ·å¯ä»¥å®Œæˆä¸Šé¢çš„æµ‹è¯•  const element = Didact.createElement( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34; }, Didact.createElement(\u0026#34;a\u0026#34;, null, \u0026#34;bar\u0026#34;), Didact.createElement(\u0026#34;b\u0026#34;) ); console.log(element); });    undefined { createElement: [Function: createElement] } { type: \u0026#39;div\u0026#39;, props: { id: \u0026#39;foo\u0026#39;, children: [ [Object], [Object] ] } }    render   å¢åŠ  render å‡½æ•°ï¼Œå®ƒçš„ç›®çš„åœ¨ä¸€å¼€å§‹ä¹Ÿè¯´äº†ï¼Œå°±æ˜¯å°† vnode æ¸²æŸ“åˆ°çœŸå®DOMï¼Œè‡³äºæ€ä¹ˆæ¸² æŸ“ï¼Œç»“æ„åˆæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œè¿™ä¹‹åä¼šæ…¢æ…¢çš„å»å®Œæˆã€‚\n1 2 3 4 5 6 7 8 9  const Didact = { createElement, render } // ReactDOM.render function render(element, container) { // TODO }     æ¸²æŸ“å½“å‰æ ‘æ ¹èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹å…ƒç´ æ¸²æŸ“å·¥ä½œï¼š\n1 2 3 4 5 6 7 8 9 10  // ReactDOM.render function render(element, container) { // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´   const dom = document.createElement(element.type) // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´   element.props.children.forEach(child =\u0026gt; render(child, dom /*parent*/)) container.appendChild(dom) }     ä½†æ˜¯èŠ‚ç‚¹ç±»å‹æœ‰å¯èƒ½æ˜¯çº¯æ–‡æœ¬çš„ï¼Œæ¯”å¦‚ createElement ä¸€èŠ‚ ä¸­çš„ä¾‹å­é‡Œé¢çš„ \u0026lt;a\u0026gt;bar\u0026lt;/a\u0026gt; å°±æœ‰ä¸€ä¸ªçº¯æ–‡æœ¬çš„ \u0026#34;bar\u0026#34; èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ç»è¿‡ createElement ä¹‹åç»“æ„ æ˜¯ï¼š {type: \u0026#39;TEXT_ELEMENT\u0026#39;, props: {...}} ï¼Œæ‰€ä»¥è¿™é‡Œé¢åªéœ€è¦é’ˆå¯¹ TEXT_ELEMENT åšä¸‹ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœæ˜¯æ–‡æœ¬å°±åˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡æœ¬èŠ‚ç‚¹æ¥å®¹ä¹ƒè¯¥æ–‡æœ¬å†…å®¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // ReactDOM.render function render(element, container) { // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´  - const dom = document.createElement(element.type) + const dom = + element.type === \u0026#34;TEXT_ELEMENT\u0026#34; + ? document.createTextNode(\u0026#34;\u0026#34;) + : document.createElement(element.type);  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´  element.props.children.forEach((child) =\u0026gt; render(child, dom /*parent*/)); container.appendChild(dom); }      æœ€åæ˜¯ props çš„å¤„ç†ï¼Œè¿™é‡Œè®°å¾—è¦æ’é™¤ props.children\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // ReactDOM.render function render(element, container) { // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´  const dom = element.type === \u0026#34;TEXT_ELEMENT\u0026#34; ? document.createTextNode(\u0026#34;\u0026#34;) : document.createElement(element.type); + const isProperty = (key) =\u0026gt; key !== \u0026#34;children\u0026#34;; + Object.keys(element.props) + .filter(isProperty) + .forEach((name) =\u0026gt; (dom[name] = element.props[name]));  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´  element.props.children.forEach((child) =\u0026gt; render(child, dom /*parent*/)); container.appendChild(dom); }      æœ€åè¯¥é˜¶æ®µå®Œæ•´çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  console.log(\u0026#34;\\n\u0026#34;); const Didact = { createElement, render, }; // ReactDOM.render function render(element, container) { // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´   const dom = element.type === \u0026#34;TEXT_ELEMENT\u0026#34; ? document.createTextNode(\u0026#34;\u0026#34;) : document.createElement(element.type); const isProperty = (key) =\u0026gt; key !== \u0026#34;children\u0026#34;; Object.keys(element.props) .filter(isProperty) .forEach((name) =\u0026gt; (dom[name] = element.props[name])); // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´   element.props.children.forEach((child) =\u0026gt; render(child, dom /*parent*/)); container.appendChild(dom); } // React.createElement function createElement(type, props, ...children) { return { type, props: { ...props, children: children.map((child) =\u0026gt; typeof child === \u0026#34;object\u0026#34; ? child : createTextElement(child) ), }, }; } function createTextElement(text) { return { type: \u0026#34;TEXT_ELEMENT\u0026#34;, props: { nodeValue: text, // ç±»ä¼¼ textContent å¯ä»¥ä¿®æ”¹èŠ‚ç‚¹æ–‡æœ¬å†…å®¹çš„å±æ€§  children: [], }, }; }     æµ‹è¯•:\n  (function() { console.log(Didact) const container = document.getElementById('qoCIUr') const element = Didact.createElement('div', { id: 'foo', }, Didact.createElement('a', null, 'bar'), Didact.createElement('b')) Didact.render(element, container) }());   æµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  console.log(Didact); const container = document.getElementById(\u0026#34;qoCIUr\u0026#34;); const element = Didact.createElement( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, }, Didact.createElement(\u0026#34;a\u0026#34;, null, \u0026#34;bar\u0026#34;), Didact.createElement(\u0026#34;b\u0026#34;) ); Didact.render(element, container);      å¹¶å‘æ¨¡å¼(workLoop())   æ³¨æ„çœ‹ä¸Šä¸€èŠ‚æœ€åçš„ä»£ç ï¼Œåœ¨ render ä¸­ä¼šé€’å½’è°ƒç”¨æ¥å®Œæˆ children çš„æ¸²æŸ“å·¥ä½œï¼Œè¿™é‡Œå°± ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåªè¦ render ä¸€æ—¦æ‰§è¡Œï¼Œåœ¨æ¸²æŸ“å®Œæ•´æ£µæ ‘ä¹‹å‰æ˜¯ä¸èƒ½åœæ­¢çš„ï¼Œå¦åˆ™å°†å¯¼è‡´ é¡µé¢ä¸å®Œæ•´ã€‚\n æ˜¨å¤©å¾®ä¿¡é‡Œé¢çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼š\n Event Loop å’Œ JS å¼•æ“ã€æ¸²æŸ“å¼•æ“çš„å…³ç³»\n è¿™é‡Œé¢å¤§æ¦‚è®²è¿°äº†ä¸€äº›JS å’Œ æ¸²æŸ“ä¹‹é—´çš„ä¸€äº›å…³ç³»ï¼Œè€Œè¿™é‡Œçš„å®ç°å’Œè¿™æ–‡ç« é‡Œè®²è¿°çš„ä¸€äº›åŸ ç†æ˜¯ç›¸é€šçš„ã€‚\n  è¦è§£å†³ render é€’å½’çš„é—®é¢˜ï¼Œå¤§è‡´çš„æ€æƒ³æ˜¯é€šè¿‡ Fiber å°†æ¸²æŸ“ä»»åŠ¡å°è£…ï¼Œåœ¨æŸä¸€ä¸ªç©ºé—²çš„ æ—¶åˆ»å»æ‰§è¡Œè¿™äº› Fibers è¿›è¡Œå®é™…çš„æ¸²æŸ“ï¼Œè¿™æ ·ä¸è‡³äºé˜»å¡ä¸»ä»»åŠ¡çš„æ‰§è¡Œã€‚\n è¿™é‡Œçš„æ¯ä¸ª Fiber ä¹Ÿè¢«ç§°ä½œ work unitï¼Œå½“ä¸€ä¸ª work unit å®Œæˆä¼šè‡ªåŠ¨æ‰¾åˆ°ä¸‹ä¸€ä¸ªåº”è¯¥æ‰§ è¡Œçš„ work unit ä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ª Fiberï¼Œä¸ºä»€ä¹ˆå«åº”è¯¥å‘¢ï¼Œå› ä¸ºæ¯ä¸ª Fiber ä¸Šé¢ä¸æ­¢æœ‰ä¸€ä¸ª å¼•ç”¨æŒ‡å‘ä¸‹ä¸€ä¸ª Fiberï¼Œç„¶åå¦‚ä½•å†³å®šä¸‹ä¸€ä¸ª work unit è·Ÿæ¸²æŸ“çš„ä¼˜å…ˆçº§æœ‰å…³ç³»ã€‚\n æ¯ä¸ª Fiber ä¸Šé¢æœ€å¤šæœ‰ä¸‰ä¸ªå¼•ç”¨ parent, first child, parent sibling ä¸‰ä¸ªèŠ‚ç‚¹ã€‚\n ä¼˜å…ˆçº§æ˜¯: first child \u0026gt; parent sibling \u0026gt; parentã€‚\n å¦‚ä½•æ‰§è¡Œ work unit ?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  let nextUnitOfWork = null function workLoop(deadline) { let shouldYield = false while (nextUnitOfWork \u0026amp;\u0026amp; !shouldYield) { // æ‰§è¡Œå½“å‰çš„ work unit è¿”å›ä¸‹ä¸€ä¸ªå°†è¦æ‰§è¡Œçš„ work unit  nextUnitOfWork = performUnitOfWork(nextUnitOfWork) // æ²¡æœ‰ç©ºé—²çš„æ—¶é—´äº†  shouldYield = deadline.timeRemaining() \u0026lt; 1 } // ä¸‹ä¸ªç©ºé—²æ—¶é—´å»æ‰§è¡Œä¸‹ä¸€æ¬¡ work unit loop  requestIdleCallback(workLoop) } function performUnitOfWork(nextUnitOfWork) { // TODO }      è¿™é‡Œä½¿ç”¨ requestIdleCallback è¿™ä¸ªå‡½æ•°ä¼šåœ¨æ¸²æŸ“ä¹‹å‰æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰ç©ºé—²çš„æ—¶é—´ï¼Œå¦‚æœ æœ‰åˆ™æ‰§è¡Œå›è°ƒï¼Œæˆ–è€…è¶…æ—¶äº†å¼ºåˆ¶æ‰§è¡Œå›è°ƒã€‚\n React å·²ç»ä¸ç”¨è¿™ä¸ªäº†ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº† react/packages/scheduler at master Â· facebook/react æ¥ç®¡ç† fiber çš„æ‰§è¡Œæ—¶æœºã€‚\n   Fibers   ä¸Šä¸€èŠ‚åœ¨å®ç° workLoop() æåˆ°äº† work unit å³ fiberã€‚\n ä¸ºäº†æ–¹ä¾¿ç®¡ç†ä¸€ä¸ª work unit ï¼Œéœ€è¦ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„ç»“æ„ï¼Œé‡Œé¢èƒ½ä¿å­˜ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ï¼Œ æ¯”å¦‚ parent, first child, parent sibling å¼•ç”¨ï¼Œ VNode èŠ‚ç‚¹ä¿¡æ¯ï¼Œç­‰å¾…ã€‚\n è¿™ä¸ªç»“æœå°±æ˜¯: Fiber tree ç”±ä¸€ä¸ªä¸ª fiber ç»“æ„é€šè¿‡é“¾æ¥ç»„æˆçš„æ ‘ï¼Œå…¶å®å°±æ˜¯ç±»ä¼¼ Vue ä¸­çš„ VNode èŠ‚ç‚¹æ ‘ã€‚\n ä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10  Didact.render( \u0026lt;div\u0026gt; \u0026lt;h1\u0026gt; \u0026lt;p /\u0026gt; \u0026lt;a /\u0026gt; \u0026lt;/h1\u0026gt; \u0026lt;h2 /\u0026gt; \u0026lt;/div\u0026gt;, container )     æœ‰å¦‚ä¸‹çš„ç»“æ„ï¼Œè¯¥ç»“æ„è®©æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ€å¤šæŒæœ‰ä¸‰ä¸ªå¼•ç”¨ï¼Œä»è€Œæ›´æ–¹ä¾¿çš„æ‰¾åˆ°ä¸‹ä¸€ä¸ª work unit:\n  render æŸ¥æ‰¾æ­¥éª¤æ‹†è§£ï¼š\n root -\u0026gt; \u0026lt;div\u0026gt; -\u0026gt; \u0026lt;h1\u0026gt; -\u0026gt; \u0026lt;p\u0026gt; è¿™æ˜¯éµå¾ª first child ä¼˜å…ˆçº§æœ€é«˜æŸ¥æ‰¾çš„ç»“æœï¼Œä¸€æ—¦è¿™ä¸ª è¿‡ç¨‹æ¸²æŸ“å®Œæˆï¼Œæ¥ä¸‹æ¥åº”è¯¥æ‰¾ \u0026lt;p\u0026gt; çš„ sibling(å› ä¸º sibling ä¼˜å…ˆçº§é«˜äº parent ä½äº first child):\n \u0026lt;a\u0026gt; -\u0026gt; \u0026lt;h2\u0026gt; å› ä¸º \u0026lt;a\u0026gt; æ—¢æ²¡æœ‰ first child ä¹Ÿæ²¡æœ‰ sibling æ‰€ä»¥æ‰¾ parent sibling å³ \u0026lt;h2\u0026gt; ç„¶åç»§ç»­æ‰¾å‘ç° \u0026lt;div\u0026gt; å¹¶æ²¡æœ‰ siblingï¼Œä¸€ç›´å¦‚æ­¤çŸ¥é“æ ¹èŠ‚ç‚¹ã€‚\n æ›´æ–° render å‡½æ•°ï¼Œå°† DOM å…ƒç´ çš„åˆ›å»ºä» render ä¸­æŠ½ç¦»å‡ºæ¥æˆ createDom å‡½æ•°ï¼Œè¿™é‡Œå¼€å§‹ä½¿ç”¨ fiber:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  function createDom(fiber) { // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´   const dom = fiber.type === \u0026#34;TEXT_ELEMENT\u0026#34; ? document.createTextNode(\u0026#34;\u0026#34;) : document.createElement(fiber.type); const isProperty = (key) =\u0026gt; key !== \u0026#34;children\u0026#34;; Object.keys(fiber.props) .filter(isProperty) .forEach((name) =\u0026gt; (fiber[name] = fiber.props[name])); return dom; } let nextUnitOfWork = null function render(element, container) { // æ„å»º root fiber ä½œä¸ºç¬¬ä¸€ä¸ª nextUnitOfWork  nextUnitOfWork = { dom: container, props: { children: [element] } } }     åœ¨ render ä¸€å¼€å§‹ä¼šåˆ›å»ºä¸€ä¸ª root fiber å¹¶ä¸”å°†å®ƒä½œä¸ºç¬¬ä¸€ä¸ª nextUnitOfWork ï¼Œè€Œå é¢åˆ™æ˜¯æ‰§è¡Œ performUnitOfWork è¿™é‡Œé¢ä¸»è¦å®Œæˆä¸‰éƒ¨åˆ†ä»»åŠ¡ï¼š\n  å°† fiber å¯¹åº”çš„ element æ·»åŠ åˆ° DOM\n  ä¸º 1 ä¸­çš„ element.children åˆ›å»º fibers\n  æ‰¾åˆ°åˆé€‚çš„ä¸‹ä¸€ä¸ª work unit è¿”å›\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  function performUnitOfWork(fiber) { // 1. åˆ›å»º fiber dom å…ƒç´   if (!fiber.dom) { fiber.dom = createDom(fiber); } // 2. å°† fiber dom æ·»åŠ åˆ° parent DOM æ ‘ä¸­å»  if (fiber.parent) { fiber.parent.dom.appendChild(fiber.dom); } // 3. å¤„ç† children  const elements = fiber.props.children; let index = 0; let prevSibling = null; while (index \u0026lt; elements.length) { const element = elements[index]; // ä¸ºæ¯ä¸ª child æ„å»º fiber ç»“æ„  const newFiber = { type: element.type, props: element.props, parent: fiber, // æŒ‡å‘çˆ¶çº§ fiber çš„å¼•ç”¨  dom: null, // æŒ‡å‘çœŸå®DOMå…ƒç´ çš„å¼•ç”¨  }; if (indx === 0) { // è¡¨ç¤ºæ˜¯ parent çš„ç¬¬ä¸€ä¸ª childï¼Œæ ‡è®°ä¸º first child  firber.child = newFiber; // ç¬¬ä¸€ä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§æœ€é«˜  } else { // éç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œç­‰äºæ˜¯èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹  // ç¬¬äºŒä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§ä½äº first child  prevSibling.sibling = newFiber; } prevSibling = newFiber; index++; } // åˆ°è¿™é‡Œ fiber ç»“æ„åˆå§‹åŒ–å®Œæˆï¼Œæ­¤æ—¶æ¯ä¸ª fiber ä¹Ÿæœ‰äº†è‡ªå·±çš„  // ä¸‰ä¸ªå¼•ç”¨ fiber.child, fiber.parent, fiber.sibling  // ä¸‹é¢å°†è¦å»æ‰¾åˆ°å½“å‰ Fiber çš„ä¸‹ä¸€ä¸ª work unitï¼ŒæŸ¥æ‰¾éµå¾ªä¼˜å…ˆçº§:  // fiber.child \u0026gt; fiber.sibling \u0026gt; fiber.parent.sibling  if (fiber.child) { return fiber.child; } let nextFiber = fiber; while (nextFiber) { if (nextFiber.sibling) { // ç¬¬ä¸€æ¬¡è¿™é‡Œæ‰¾çš„æ˜¯å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æ‰¾åˆ°  // ä¾ç€ fiber æ ‘å¾€ä¸Šæ‰¾ parent çš„ sibling  return nextFiber.sibling; } nextFiber = fiber.parent; } }      Render and Commit é˜¶æ®µ   åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå‰é¢éƒ½åªæ˜¯åœ¨ fiber tree åŸºç¡€ä¸Šå»åšäº†å¤„ç†ï¼ˆåˆ›å»º DOM å…ƒç´ ï¼Œé“¾æ¥ fiber treeï¼Œæ‰¾ä¸‹ä¸€ä¸ª work unitï¼‰ï¼Œä½†å®é™…å¹¶æ²¡æœ‰å¼€å§‹æ¸²æŸ“ã€‚\n å¹¶ä¸”è¿™é‡Œ performUnitOfWork å®ç°ä¸­æœ‰ä¸ªé—®é¢˜ï¼š\n1 2 3  if (fiber.parent) { fiber.parent.dom.appendChild(fiber.dom); }     å³è¿™é‡Œæ¯æ¬¡æ‰§è¡Œ work unit çš„æ—¶å€™éƒ½ä¼šç«‹å³å°† fiber.dom æ·»åŠ åˆ° parent çš„ DOM ğŸŒ²ä¸­å»ï¼Œ ç„¶åè¿™ä¸ªæ“ä½œå¾ˆæœ‰å¯èƒ½åœ¨å®Œæˆæ•´æ£µæ ‘çš„æ¸²æŸ“ä¹‹å‰è¢«æµè§ˆå™¨ç»™ç»ˆæ­¢äº†ã€‚\n æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ\n ä»æ ¹ä¸Šå»è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³åœ¨ render ä¸­ä¸ç”¨ä¸€å¼€å§‹å°±å»è¿›è¡Œ append æ“ä½œï¼Œè€Œæ˜¯ä» root å¼€å§‹å»è·Ÿè¸ªæ•´ä¸ªæ ‘çš„ç»“æ„å˜åŒ–ï¼Œå°† root ä¹Ÿå°è£…æˆ fiberã€‚\n1 2 3 4 5 6 7 8 9 10 11  let wipRoot = null function render(element, container) { wipRoot = { dom: container, props: { children: [element] } } nextUnitOfWork = wipRoot }     ç„¶åï¼Œä¸€æ—¦ wookLoop() çš„ä¸€æ¬¡å¾ªç¯ç»“æŸäº†å°±è¿›è¡Œä¸€æ¬¡æäº¤ï¼Œå»ä¸€æ¬¡æ€§å®Œæˆæ¸²æŸ“ä»»åŠ¡ã€‚\n é‚£æ€ä¹ˆåˆ¤æ–­è¯´ä¸€æ¬¡å¾ªç¯ç»“æŸäº†ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  function commitRoot() { // æ‰§è¡Œ DOM æ¸²æŸ“  commitWork(wipRoot.child); // æäº¤å®Œæˆä¹‹åè¦é‡ç½®ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ›´æ–°çš„ä»»åŠ¡  wipRoot = null; } function commitWork(fiber) { if (!fiber) return; // è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -\u0026gt; fiber.child -\u0026gt; fiber.sibling  const domParent = fiber.parent.dom; domParent.appendChild(fiber.dom); commitWork(fiber.child); commitWork(fiber.sibling); } function workLoop(deadline) { let shouldYield = false; while (nextUnitOfWork \u0026amp;\u0026amp; !shouldYield) { // æ‰§è¡Œå½“å‰çš„ work unit è¿”å›ä¸‹ä¸€ä¸ªå°†è¦æ‰§è¡Œçš„ work unit  nextUnitOfWork = performUnitOfWork(nextUnitOfWork); // æ²¡æœ‰ç©ºé—²çš„æ—¶é—´äº†  shouldYield = deadline.timeRemaining() \u0026lt; 1; } // è¿™é‡Œæ£€æµ‹æ²¡æœ‰ä¸‹ä¸€ä¸ª work unit äº†ï¼Œè¯´æ˜æ•´ä¸ªæ ‘éå†å®Œæˆäº†  if (!nextUnitOfWork \u0026amp;\u0026amp; wipRoot) { commitRoot(); } // ä¸‹ä¸ªç©ºé—²æ—¶é—´å»æ‰§è¡Œä¸‹ä¸€æ¬¡ work unit loop  requestIdleCallback(workLoop); }      updating and deleting æ›´æ–°å’Œåˆ é™¤   è¿™ä¸€èŠ‚å°†è®²è¿°å¦‚ä½•å°† old fiber å’Œ new fiber è¿›è¡Œæ¯”è¾ƒæ¥åˆ¤æ–­æ˜¯è¿›è¡Œ update è¿˜æ˜¯ delete æ“ä½œã€‚\n æ‰€ä»¥ Fiber é‡Œé¢éœ€è¦å¯¹ä¸Šä¸€æ¬¡çš„æäº¤çš„ fiber tree è¿›è¡Œå¤‡ä»½ã€‚\n è¿™é‡Œç”¨ currentRoot è¡¨ç¤º new fiber ç”¨ fiber.alternate æ¥ä¿å­˜ old fiberã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  + let currentRoot = null function commitRoot() { commitWork(wipRoot.child) + // å½“å‰æ¸²æŸ“çš„æ ‘è¿›è¡Œå¤‡ä»½ + currentRoot = wipRoot  wipRoot = null } function render(element, container) { wipRoot = { dom: container, props: { children: [element] }, + // ä¿å­˜ä¸€ä»½è€æ ‘ + alternate: currentRoot  } nextUnitOfWork = wipRoot }      å°† performUnitOfWork ä¸­åˆ›å»º Fiber çš„æŠ½ç¦»åˆ° reconcileChildren ä¸­å»æ–¹ä¾¿æ·»åŠ æ›´ æ–°å’Œåˆ é™¤æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70  function reconcileChildren(wipFiber, elements) { let index = 0; let oldFiber = wipFiber.alternate \u0026amp;\u0026amp; wipFiber.alternate.child let prevSibling = null; while (index \u0026lt; elements.length) { // è¿™ä¸ª element æ˜¯å°†è¦æ›´æ–°åˆ°DOMä¸­çš„èŠ‚ç‚¹  const element = elements[index]; let newFiber = null // æ¯”è¾ƒ oldFiber å’Œ element  // ç±»å‹ä¸€æ ·ï¼Œå±äºæ›´æ–°  const sameType = oldFiber \u0026amp;\u0026amp; element \u0026amp;\u0026amp; oldFiber.type === element.type // ä¸‹é¢çš„æ›´æ–°å¹¶éæ˜¯ç›´æ¥ç«‹å³æ›´æ–°ï¼Œè€Œæ˜¯ä¸º Fiber èµ‹äºˆæ–°çš„å±æ€§æ¥æ ‡è¯†è¯¥èŠ‚ç‚¹  // åœ¨ commit é˜¶æ®µåº”è¯¥æ‰§è¡Œä»€ä¹ˆæ“ä½œ  if (sameType) { // æ›´æ–°èŠ‚ç‚¹  newFiber = { type: oldFiber.type, props: element.props, dom: oldFiber.dom, parent: wipFiber, alternate: oldFiber, effectTag: \u0026#39;UPDATE\u0026#39; } } if (element \u0026amp;\u0026amp; !sameType) { // æ·»åŠ èŠ‚ç‚¹  newFiber = { type: element.type, props: element.props, dom: null, parent: wipFiber, alternate: null, effectTag: \u0026#39;PLACEMENT\u0026#39; } } if (oldFiber \u0026amp;\u0026amp; !sameType) { // åˆ é™¤èŠ‚ç‚¹  oldFiber.effecTag = \u0026#39;DELETION\u0026#39; // å› ä¸º commit æ˜¯ä» root ä»ä¸Šå¾€ä¸‹æäº¤çš„ï¼Œä¸”åœ¨æäº¤é˜¶æ®µ  // å·²ç»ä¸¢å¤±äº† old fiberï¼Œå› ä¸ºä¸Šé¢ç»“æ„å·²ç»æ›´æ–°äº†ï¼Œå› æ­¤è¿™é‡Œéœ€è¦è®°å½•  // å“ªäº›èŠ‚ç‚¹éœ€è¦åˆ é™¤  deletion.push(oldFiber) } // ä¸ºæ¯ä¸ª child æ„å»º fiber ç»“æ„  newFiber = { type: element.type, props: element.props, parent: fiber, // æŒ‡å‘çˆ¶çº§ fiber çš„å¼•ç”¨  dom: null, // æŒ‡å‘çœŸå®DOMå…ƒç´ çš„å¼•ç”¨  }; if (indx === 0) { // è¡¨ç¤ºæ˜¯ parent çš„ç¬¬ä¸€ä¸ª childï¼Œæ ‡è®°ä¸º first child  firber.child = newFiber; // ç¬¬ä¸€ä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§æœ€é«˜  } else { // éç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œç­‰äºæ˜¯èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹  // ç¬¬äºŒä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§ä½äº first child  prevSibling.sibling = newFiber; } prevSibling = newFiber; index++; } }     ç„¶åä¿®æ”¹ render ï¼Œåˆå§‹åŒ–æˆ–é‡ç½® deletion:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  let deletion = null // ReactDOM.render function render(element, container) { wipRoot = { dom: container, props: { children: [element], }, alternate: currentRoot, }; // åˆå§‹åŒ–æˆ–é‡ç½®å¾…åˆ é™¤çš„èŠ‚ç‚¹ï¼Œå› ä¸º fiber tree æ›´æ–°å‘ç”Ÿåœ¨ commit ä¹‹å‰  // å› æ­¤åœ¨ commit é˜¶æ®µ old fiber å·²ç»è¢«æ›¿æ¢äº†ï¼Œæ‰€ä»¥åœ¨ fiber tree æ›´æ–°çš„  // æ—¶å€™å°±è¦å°†è¦åˆ é™¤çš„ old fiber ç¼“å­˜èµ·æ¥  deletion = []; nextUnitOfWork = wipRoot; }     ç„¶ååœ¨æäº¤é˜¶æ®µ commitRoot ä¸­æ‰§è¡Œåˆ é™¤\n1 2 3 4 5 6  function commitRoot() { deletion.forEach(commitWork) // æ‰§è¡ŒèŠ‚ç‚¹åˆ é™¤  commitWork(wipRoot.child) currentRoot = wipRoot wipRoot = null }     æœ€åä¿®æ”¹ commitWork å»å¤„ç†æ–°å¢çš„ fiber.effectTag æ ¹æ®ä¸åŒç±»å‹æ‰§è¡Œç›¸åº”çš„å¢åŠ ã€åˆ  é™¤ã€æ›´æ–°æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function commitWork(fiber) { if (!fiber) return; // è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -\u0026gt; fiber.child -\u0026gt; fiber.sibling  const domParent = fiber.parent.dom; if (fiber.effectTag === \u0026#34;PLACEMENT\u0026#34; \u0026amp;\u0026amp; fiber.dom != null) { // æ·»åŠ æ–°èŠ‚ç‚¹  domParent.appendChild(fiber.dom); } else if (fiber.effectTag === \u0026#34;DELETION\u0026#34;) { domParent.removeChild(fiber.dom); } else if (fiber.effectTag === \u0026#34;UPDATE\u0026#34; \u0026amp;\u0026amp; fiber.dom != null) { // æ›´æ–°èŠ‚ç‚¹  updateDom(fiber.dom, fiber.alternate.props, fiber.props); } commitWork(fiber.child); commitWork(fiber.sibling); }     æ›´æ–°èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹çŠ¶æ€è¿›è¡Œå¯¹æ¯”ï¼Œè¿›è¡Œæ›´æ–°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const isProperty = (key) =\u0026gt; key !== \u0026#34;children\u0026#34;; // æ–°å±æ€§ const isNew = (prev, next) =\u0026gt; (key) =\u0026gt; prev[key] !== next[key]; // è¦åˆ é™¤çš„å±æ€§ const isGone = (prev, next) =\u0026gt; (key) =\u0026gt; !key in next; function updateDom(dom, prevProps, nextProps) { // åˆ é™¤  Object.keys(prevProps) .filter(isProperty) .filter(isGone(prevProps, nextProps)) .forEach((name) =\u0026gt; (dom[name] = \u0026#34;\u0026#34;)); // æ›´æ–°æ–°å¢  Object.keys(nextProps) .filter(isProperty) .filter(isNew(prevProps, nextProps)) .forEach(name =\u0026gt; (dom[name] = nextProps[name])) }     å¤„ç†ç‰¹æ®Šå±æ€§ï¼šäº‹ä»¶å±æ€§çš„å¤„ç†ï¼Œéœ€è¦å°†åŸæ¥çš„ handler å…ˆç§»é™¤å†æ·»åŠ æ–°çš„ handlerã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  const isEvent = (key) =\u0026gt; key.startsWith(\u0026#34;on\u0026#34;); const isProperty = (key) =\u0026gt; key !== \u0026#34;children\u0026#34; \u0026amp;\u0026amp; !isEvent(key); // æ–°å±æ€§ const isNew = (prev, next) =\u0026gt; (key) =\u0026gt; prev[key] !== next[key]; // è¦åˆ é™¤çš„å±æ€§ const isGone = (prev, next) =\u0026gt; (key) =\u0026gt; !key in next; function updateDom(dom, prevProps, nextProps) { // ç§»é™¤æˆ–æ›´æ–° event listeners  Object.keys(prevProps) .filter(isEvent) .filter((key) =\u0026gt; !(key in nextProps) || isNew(prevProps, nextProps)(key)) .forEach((name) =\u0026gt; { const eventType = name.toLowerCase().substring(2); dom.removeEventListener(eventType, prevProps[name]); }); // åˆ é™¤  Object.keys(prevProps) .filter(isProperty) .filter(isGone(prevProps, nextProps)) .forEach((name) =\u0026gt; (dom[name] = \u0026#34;\u0026#34;)); // æ›´æ–°æ–°å¢  Object.keys(nextProps) .filter(isProperty) .filter(isNew(prevProps, nextProps)) .forEach((name) =\u0026gt; (dom[name] = nextProps[name])); // æ–°å¢äº‹ä»¶å±æ€§  Object.keys(nextProps) .filter(isEvent) .filter(isNew(prevProps, nextProps)) .forEach((name) =\u0026gt; { const eventType = name.toLowerCase().substring(2); dom.addEventListener(eventType, nextProps[name]); }); }     ä¿®æ”¹ createDom åˆåˆ›å»º DOM å…ƒç´ çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ updateDom(dom, {}, fiber.props)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function createDom(fiber) { const dom = fiber.type === \u0026#39;TEXT_ELEMENT\u0026#39; ? document.createTextNode(\u0026#39;\u0026#39;) : document.createElement(fiber.type) - const isProperty = (key) =\u0026gt; key !== \u0026#34;children\u0026#34;; - Object.keys(fiber.props) - .filter(isProperty) - .forEach((name) =\u0026gt; (fiber[name] = fiber.props[name]));  + updateDom(dom, {}, fiber.props)  return dom }       å‡½æ•°ç»„ä»¶   å¦‚å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11  function App(props) { return \u0026lt;h1\u0026gt;Hi {props.name}\u0026lt;/h1\u0026gt; } const element = \u0026lt;App name=\u0026#34;foo\u0026#34;/\u0026gt; // jsx -\u0026gt; js function App(props) { return Didact.createElement(\u0026#39;h1\u0026#39;, null, \u0026#34;Hi \u0026#34;, props.name) } const element = Didact.createElement(App, { name: \u0026#39;foo\u0026#39; })     å‡½æ•°ç»„ä»¶ä¸æ™®é€šç»„ä»¶ä¸åŒç‚¹:\n  æ¥è‡ªå‡½æ•°ç»„ä»¶çš„ Fiber æ²¡æœ‰ DOM èŠ‚ç‚¹\n  fiber.children æ¥è‡ªå‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œè€Œä¸æ˜¯ç›´æ¥ä» props ä¸­å–\n   ä¿®æ”¹ performUnitOfWork å¢åŠ å‡½æ•°ç»„ä»¶åˆ¤æ–­:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  function performUnitOfWork(fiber) { const isFunctionComponent = fiber.type instanceof Function if (isFunctionComponent) { updateFunctionComponent(fiber) } else { updateHostComponent(fiber) } // åˆ°è¿™é‡Œ fiber ç»“æ„åˆå§‹åŒ–å®Œæˆï¼Œæ­¤æ—¶æ¯ä¸ª fiber ä¹Ÿæœ‰äº†è‡ªå·±çš„  // ä¸‰ä¸ªå¼•ç”¨ fiber.child, fiber.parent, fiber.sibling  // ä¸‹é¢å°†è¦å»æ‰¾åˆ°å½“å‰ Fiber çš„ä¸‹ä¸€ä¸ª work unitï¼ŒæŸ¥æ‰¾éµå¾ªä¼˜å…ˆçº§:  // fiber.child \u0026gt; fiber.sibling \u0026gt; fiber.parent.sibling  if (fiber.child) { return fiber.child; } let nextFiber = fiber; while (nextFiber) { if (nextFiber.sibling) { // ç¬¬ä¸€æ¬¡è¿™é‡Œæ‰¾çš„æ˜¯å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æ‰¾åˆ°  // ä¾ç€ fiber æ ‘å¾€ä¸Šæ‰¾ parent çš„ sibling  return nextFiber.sibling; } nextFiber = nextFiber.parent; } }     æ›´æ–°å‡½æ•°ç»„ä»¶ updateFunctionComponent(fiber) :\n1 2 3 4 5  function updateFunctionComponent(fiber) { // æ‰§è¡Œå‡½æ•°ç»„ä»¶å¾—åˆ° children  const children = [fiber.type(fiber.props)] reconcileChildren(fiber, children) }     æ›´æ–°æ™®é€šç»„ä»¶ updateHostComponent(fiber) ç›´æ¥æŠŠ performUnitOfWork ä¸­åŸæ¥çš„å¤„ç† æŒªè¿›æ¥å°± OK:\n1 2 3 4 5 6 7 8  function updateHostComponent(fiber) { // 1. åˆ›å»º fiber dom å…ƒç´   if (!fiber.dom) { fiber.dom = createDom(fiber); } reconcileChildren(fiber, fiber.props.children); }     å› ä¸ºå‡½æ•°ç»„ä»¶å¹¶æ²¡æœ‰ DOM å…ƒç´ ï¼Œæ‰€ä»¥ commit é˜¶æ®µéœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰å°±å¾€ä¸Šæ‰¾çˆ¶çº§ çš„ dom å…ƒç´ ä½œä¸º parent ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  function commitWork(fiber) { if (!fiber) return; // è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -\u0026gt; fiber.child -\u0026gt; fiber.sibling  const domParentFiber = fiber.parent; // å¦‚æœæ˜¯å‡½æ•°ç»„ä»¶æ˜¯æ²¡æœ‰ dom çš„ï¼Œé‚£ä¹ˆéœ€è¦æ‰¾åˆ°å®ƒçš„çˆ¶çº§ä½œä¸ºç›®æ ‡ parent  while (!domParentFiber.dom) { domParentFiber = domParentFiber.parent; } const domParent = domParentFiber.dom; if (fiber.effectTag === \u0026#34;PLACEMENT\u0026#34; \u0026amp;\u0026amp; fiber.dom != null) { // æ·»åŠ æ–°èŠ‚ç‚¹  domParent.appendChild(fiber.dom); } else if (fiber.effectTag === \u0026#34;UPDATE\u0026#34; \u0026amp;\u0026amp; fiber.dom != null) { // æ›´æ–°èŠ‚ç‚¹  updateDom(fiber.dom, fiber.alternate.props, fiber.props); } else if (fiber.effectTag === \u0026#34;DELETION\u0026#34;) { commitDeletion(fiber, domParent); } commitWork(fiber.child); commitWork(fiber.sibling); }     åˆ é™¤çš„æ—¶å€™ä¹Ÿå¿…é¡»æ‰¾åˆ°æœ‰ child çš„ fiber, commitDeletion ï¼š\n1 2 3 4 5 6 7  function commitDeletion(fiber, domParent) { if (fiber.dom) { domParent.removeChild(fiber.dom) } else { commitDeletion(fiber.child, domParent) } }      hooks   æ·»åŠ çŠ¶æ€å’Œ hooksã€‚\n åœ¨å‡½æ•°ç»„ä»¶ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ useState hook æ¥è·å–çŠ¶æ€ä»¥åŠæ”¹å˜çŠ¶æ€çš„å‡½æ•° setState è®©æˆ‘ä»¬èƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­æ¥æ›´æ–°çŠ¶æ€ï¼Œä»è€Œæ¥æ›´æ–°UIã€‚\n å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9  function Counter() { const [state, setState] = useState(1) return ( \u0026lt;h1 onClick={() =\u0026gt; setState(c =\u0026gt; c+1)}\u0026gt; Count: { state } \u0026lt;/h1\u0026gt; ) } const elment = \u0026lt;Counter/\u0026gt;     å®ç° useState å¹¶ä¸”ä¿®æ”¹å‡½æ•°ç»„ä»¶çš„æ›´æ–°å‡½æ•° updateFunctionComponent è®©çŠ¶æ€çš„ä¿®æ”¹èƒ½ è§¦å‘è¯¥å‡½æ•°æ‰§è¡Œ:\n1 2 3 4 5 6 7 8 9 10 11 12 13  function useState(initial) { } let wipFiber = null let hookIndex = null function updateFunctionComponent(fiber) { wipFiber = fiber hookIndex = 0 wipFiber.hooks = [] const children = [fiber.type(fiber.props)] reconcileChildren(fiber, children) }     æ–°å¢ fiber.hooks ç›®çš„æ˜¯ä¸ºäº†åœ¨åŒä¸€ä¸ªç»„ä»¶å†…å¯ä»¥å¤šæ¬¡è°ƒç”¨ useState, å¹¶ä¸”è®°å½•æ¯ä¸ª hook æ‰€åœ¨çš„ç´¢å¼• hookIndex ã€‚\n å½“ç»„ä»¶è°ƒç”¨ useState æ—¶å€™ï¼Œåœ¨é‡Œé¢è¦å»æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ old hookï¼Œä» fiber.alternate æ ¹æ® hookIndex å»æ‰¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  function useState(initial) { const oldHook = wipFiber.alternate \u0026amp;\u0026amp; wipFiber.alternate.hooks \u0026amp;\u0026amp; wipFiber.alternate.hooks[hookIndex]; // å¦‚æœæœ‰è€çš„ hook ï¼Œè¦å°†è€çš„ hook state æ›´æ–°è¿‡æ¥  const hook = { state: oldHook ? oldHook.state : initial, // ç¼“å­˜çŠ¶æ€æ›´æ–°çš„ action  queue: [], }; // æ›´æ–°ä¹‹å‰å…ˆæ‰§è¡Œ actions æ›´æ–°çŠ¶æ€ï¼Œå› æ­¤åœ¨çŠ¶æ€è¿”å›ä¹‹å‰æ˜¯æœ€æ–°çš„  const actions = oldHook ? oldHook.queue : []; actions.forEach((action) =\u0026gt; (hook.state = action(hook.state))); const setState = (action) =\u0026gt; { hook.queue.push(action); wipRoot = { dom: currentRoot.dom, props: currentRoot.props, alternate: currentRoot, }; // çŠ¶æ€æ›´æ–°ï¼Œæ’å…¥æ–°çš„ work unit  nextUnitOfWork = wipRoot; deletion = []; }; wipFiber.hooks.push(hook); hookIndex++; return [hook.state, setState]; }      æœ€ç»ˆæºç æµç¨‹å›¾     æµ‹è¯•     diff è¿˜æ²¡æœ‰æ·±å…¥å®ç°ï¼Œæ²¡åšåˆ° setState åªæ›´æ–°ç›¸åº”çš„æ–‡æœ¬ count = 0 ç»„ä»¶ã€‚\n è¿˜æœ‰å¾…ç»§ç»­ç ”ç©¶ï¼ï¼ï¼\n  æ€»ç»“   é€šè¿‡ä½œè€…çš„è¿™ä¸ªå®ç°ï¼Œå¯¹ react çš„éƒ¨åˆ†ä¸»è¦åŠŸèƒ½æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ï¼Œæ–‡å†…æ¶‰åŠçš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼š\n  createElement å®ç°\n  render å‡½æ•°çš„å®ç°\n  fiber tree çš„å¤„ç†(åˆå§‹åŒ–ï¼Œæ›´æ–°ï¼Œåˆ é™¤ï¼Œæ–°å¢ç­‰)\n  commit é˜¶æ®µå¤„ç†ï¼Œå®é™…æ¸²æŸ“DOMå’Œ fiber tree çš„éå†æ˜¯åˆ†å¼€çš„\n  useState hook å‡½æ•°å®ç°çš„åŸºç¡€åŸç†ï¼Œé€šè¿‡ wipFiber + hookIndex æ¥å®ç°å‡½æ•°ç»„ä»¶å’Œ useState çš„è¿æ¥ï¼Œä»è€Œäº’ç›¸å½±å“ã€‚\n    ","permalink":"https://www.cheng92.com/react/react-zero/","tags":["react,","mini-react"],"title":"Build Your Own React"},{"categories":["react"],"contents":"   æŒ‡å—é’ˆï¼š è€å°‘çš†å®œçš„Reactæºç é€šå…³æŒ‡å— - äº‘+ç¤¾åŒº - è…¾è®¯äº‘\n  Build your own React\n   ","permalink":"https://www.cheng92.com/react/react-study-roadmap/","tags":["react"],"title":"React Eco-System(React ç”Ÿæ€å­¦ä¹ èµ„æº)"},{"categories":["react"],"contents":"  react/packages/scheduler at master Â· facebook/react\nTODO   ","permalink":"https://www.cheng92.com/react/react-package-scheduler/","tags":["react,","scheduler"],"title":"React Package Scheduler åˆ†æ"},{"categories":["vue"],"contents":"  å®˜æ–¹ä»“åº“ï¼š championswimmer/vuex-persist: A Vuex plugin to persist the store. (Fully Typescript enabled)\n  VuexPersistence   åŸç†å°±ä¸€å¥è¯ï¼šé€šè¿‡ vuex.subscribe è®¢é˜…ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æ¯æ¬¡ commit mutation çš„æ—¶å€™æ‰§ è¡Œå»æ›´æ–° persist storeã€‚\n  æ„é€ å‡½æ•°:\n1 2 3  function VuexPersistence(options) { // ... }    å­˜å‚¨æº   åˆå§‹åŒ–ï¼Œå¹¶ä¸”å†³å®šç”¨å“ªç§æ–¹å¼å­˜å‚¨æ•°æ®ï¼Œä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š\n  ç”¨æˆ·å®šä¹‰å­˜åˆ°å“ªé‡Œ options.storage\n  H5 çš„ storage api localStorage æœ¬åœ°å­˜å‚¨\n  MockStorage åº“å†…éƒ¨çš„ä¸€ä¸ªå°è£…ï¼Œå†…å­˜å­˜å‚¨æ–¹æ¡ˆ\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  function VuexPersistence(options = {}) { // åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ç®¡ç†å™¨å®ä¾‹  const _mutex = new SimplePromiseQueue() this.key = options.key ?? \u0026#39;vuex\u0026#39; this.subscribed = false this.mergeOption = options.mergeOption || \u0026#39;replaceArrays\u0026#39; let localStorateLitmus = true // æ”¯ä¸æ”¯æŒ H5 storage api  try { window.localStorage.getItem(\u0026#39;\u0026#39;) } catch (err) { localStorageLitmus = false } // å‡ ç§ storage å­˜å‚¨æœºåˆ¶  // 1. ç”¨æˆ·å®šä¹‰çš„  // 2. H5 storage api localStorage  // 3. mock storage å†…å­˜é‡Œçš„ä¸€ä¸ªå…¨å±€å˜é‡  // 4. éƒ½ä¸æ˜¯åº”è¯¥æŠ¥é”™  if (options.storage) { this.storage = options.storage } }      [save|restore]State   è¿™ä¸¤ä¸ªå‡½æ•°ç›´æ¥æ“ä½œ store å­˜å‚¨æºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  // æ¸…ç©ºæ•°æ® this.restoreState = (key, storage) =\u0026gt; { const value = storage.getItem(key); if (typeof value === \u0026#34;string\u0026#34;) { return JSON.parse(value || \u0026#34;{}\u0026#34;); } else { return value || {}; } }; this.saveState = (key, state, storage) =\u0026gt; { storage.setItem(key, JSON.stringify(state)); };      plugin(store)   ç»™ vuex ä½¿ç”¨çš„ä¸€ä¸ªå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13  const vuexLocal = new VuexPersistence({ storage: window.localStorage, modules: [\u0026#34;permission\u0026#34;, \u0026#34;film\u0026#34;, \u0026#34;settings\u0026#34;], }); createStore({ // ...  plugins: [vuexLocal.plugin], }); // vuex Store: constructor \u0026gt; å®‰è£…æ’ä»¶ // apply plugins plugins.forEach((plugin) =\u0026gt; plugin(this));     å®ç°:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  // vuex å®‰è£…æ¥å£ this.plugin = (store) =\u0026gt; { const savedState = this.restoreState(this.key, this.storage); // TODO strict mode  store.replaceState(merge(store.state, savedState || {})); this.subscriber(store)((mutation, state) =\u0026gt; { if (this.filter(mutation)) { this.saveState(this.key, this.reducer(state), this.storage); } }); this.subscribed = true; }; // vuex replaceStateï¼Œç›´æ¥ç†è§£ä¸ºæ›¿æ¢ state å°±è¡Œäº† function replaceState(state) { this._withCommit(() =\u0026gt; { this._state.data = state; }); } // è®¢é˜…å•¥ï¼Ÿ this.subscriber(store)((mutation: MutationPayload, state: S) =\u0026gt; { if (this.filter(mutation)) { this.saveState(this.key, this.reducer(state), this.storage); } });      subscriber(store)  1 2 3  const subscriber = (store: Store\u0026lt;S\u0026gt;) =\u0026gt; ( handler: (mutation: MutationPayload, state: S) =\u0026gt; any ) =\u0026gt; store.subscribe(handler);     vuex subscribe:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  function subscribe(fn, options) { return genericSubscribe(fn, this._subscribers, options); } function genericSubscribe(fn, subs, options) { if (subs.indexOf(fn) \u0026lt; 0) { options \u0026amp;\u0026amp; options.prepend ? subs.unshift(fn) : subs.push(fn); } return () =\u0026gt; { const i = subs.indexOf(fn); if (i \u0026gt; -1) { subs.splice(i, 1); } }; } // commit function commit(_type, _payload, _options) { // ... çœç•¥ commit mutation æ“ä½œ  // æ³¨æ„çœ‹è¿™é‡Œï¼Œè¯´æ˜æ¯æ¬¡ commit mutation æ“ä½œ  // æ›´æ–° state çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œ  this._subscribers .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe  .forEach((sub) =\u0026gt; sub(mutation, this.state)); // ... warn }     æœ‰äº†ä¸Šé¢çš„ vuex æºç éƒ¨åˆ†ï¼Œå†æ¥çœ‹è¿™ vuex-persist çš„ subscribe å¹²äº†å•¥\n1 2 3 4 5 6  // è®¢é˜…å•¥ï¼Ÿ this.subscriber(store)((mutation: MutationPayload, state: S) =\u0026gt; { if (this.filter(mutation)) { this.saveState(this.key, this.reducer(state), this.storage); } });     è¿™é‡Œç­‰äºæ˜¯ç»™ vuex this._subscribers æ³¨å…¥äº†ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨æ¯æ¬¡ vuex commit mutation çš„æ—¶å€™å»æ‰§è¡Œæ¥æ›´æ–° store é‡Œé¢çš„ stateã€‚\n1 2 3  this.saveState = (key, state, storage) =\u0026gt; { storage.setItem(key, JSON.stringify(state)); };      modules   æ”¯æŒå¤šæ¨¡å— - å¯¹åº”äº† vuex çš„ modulesã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  this.reducer = options.reducer != null ? options.reducer : options.modules == null ? (state: S) =\u0026gt; state : (state: any) =\u0026gt; (options!.modules as string[]).reduce( (a, i) =\u0026gt; merge(a, { [i]: state[i] }, this.mergeOption), { /* start empty accumulator*/ } ); // ä½¿ç”¨ï¼šå½“ commit mutation çŠ¶æ€æ›´æ–°ï¼Œæ ¹æ®æ˜¯ä¸æ˜¯æœ‰ modules // è°ƒç”¨ recuder å†³å®šå¦‚ä½•å­˜å‚¨ï¼Œæ¯”å¦‚ï¼š modules [a, b] // å­˜å‚¨çš„æ—¶å€™ localStorage = { a: xxx, b: xxx } // å¦‚æœæ²¡æœ‰ modules ï¼Œé»˜è®¤ç”¨çš„æ˜¯ key : \u0026#39;vuex\u0026#39; // æ‰€ä»¥ localStorage = { vuex: xxx } this.subscriber(store)((mutation: MutationPayload, state: S) =\u0026gt; { if (this.filter(mutation)) { this._mutex.enqueue( this.saveState(this.key, this.reducer(state), this.storage) as Promise\u0026lt; void \u0026gt; ); } });        queue é˜Ÿåˆ—   ä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—åˆ·æ–°ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  function SimplePromiseQueue() { this._queue = [] this._flushing = false } const SPQ = SimplePromiseQueue const SPGP = SimplePromiseQueue.prototype // å…¥åˆ—ï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œç«‹å³ flush SPGP.enqueue = function enqueue(promise) { this._queue.push(promise) if (!this._flushing) return this.flushQueue() return Promise.resolve() } SPGP.flushQueue = function flushQueue() { this._flushing = true const chain = () =\u0026gt; { const nextTask = this._queue.shift() // å…ˆè¿›å…ˆå‡º  if (nextTask) { // é€’å½’ï¼Œflush æ‰€æœ‰ä»»åŠ¡  return nextTask.then(chain) } this._flushing = false } return Promise.resolve(chain()) }     ä»»åŠ¡å…¥åˆ—çš„æ—¶å€™ï¼Œä¼šæ£€æµ‹é˜Ÿåˆ—æ˜¯ä¸æ˜¯æ­£åœ¨åˆ·æ–°ï¼Œå¦‚æœæ˜¯åªæ‰§è¡Œå…¥åˆ—æ“ä½œï¼Œè¿™é‡Œè¿”å›ä¸€ä¸ª Promise.resolve() æ–¹ä¾¿åé¢ä»»åŠ¡çš„ä¾æ¬¡è¿›è¡Œã€‚\n flushQueue() å°†å‡ºåˆ—è¡Œä¸ºå°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œæ¥è¾¾åˆ°æ‰€æœ‰ä»»åŠ¡æŒ‰å…¥åˆ—é¡ºåºæ‰§è¡Œã€‚\n  ","permalink":"https://www.cheng92.com/vue/vue-vuex-persist/","tags":["vue,","vuex,","store,","persist"],"title":"Vue Vuex Persist Store(æ•°æ®æŒä¹…åŒ–) - ç®€åŒ–ç‰ˆ"},{"categories":["web"],"contents":"    insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\"); insertCssLink(\"/js/vue/css/awesome.css\");     æ­¤æ–‡åˆè¡·ï¼Œæœ‰æ—¶å€™å»æ‰¾ä¸€äº›åº“çš„æ—¶å€™ï¼Œç¬¬ä¸€ååº”å°±æ˜¯ awesome-xxx~ï¼Œ æ¯”å¦‚ï¼š ~awesome-emacs, awesome-nodejs â€¦ ï¼Œä½†æ˜¯è¿™äº›é¡¹ç›®åŸºæœ¬å°±åªæœ‰ä¸€ä¸ªé“¾æ¥ï¼Œå½“æƒ³å†³å®š ä½¿ç”¨å“ªä¸ªçš„æ—¶å€™å¾€å¾€éœ€è¦ä¸€ä¸ªä¸ªç‚¹å¼€å»å¯¹æ¯”ä¸‹æ˜Ÿçº§å’Œæäº¤è®°å½•ã€‚\n  æ­¤æ–‡å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹åº“çš„æ˜Ÿçº§å’Œ build status è€Œäº§ç”Ÿã€‚\n  æ–‡ä¸­è¡¨æ ¼çš„å®ç°åŸºäº vue-next + element-plus\n  é¼ æ ‡æ”¾åœ¨è‹±æ–‡ç®€ä»‹ä¸Šé¢ä¼šå‡ºç°ä¸­æ–‡ç¿»è¯‘ï¼ˆè‡ªå·±+googleç¿»è¯‘çš„ä»…ä¾›å‚è€ƒï¼‰ã€‚\n  é¼ æ ‡æ”¾åˆ°è¡¨ä¸­åç§°é“¾æ¥ä¸Šé¢ä¼šå±•ç¤ºé¢„è§ˆå›¾æˆ–GIFåŠ¨ç”»(éƒ¨åˆ†æœ‰)\n  æè¿°å‰é¢å¦‚æœæœ‰ä¸€ä¸ªé“¾æ¥è¯´æ˜è¿™ä¸ªåº“æœ‰è‡ªå·±çš„æ–‡æ¡£ç½‘ç«™\n   Tools    Shields.io: Quality metadata badges for open source projects\n ç”Ÿæˆ github å›¾æ ‡çš„.\n    React Native      JavaScript   JavaScript ç›¸å…³çš„åº“(æ¯”å¦‚ï¼šæ•°å­—ï¼Œæ—¥æœŸï¼Œå­—ç¬¦ä¸²ï¼Œè´§å¸è½¬æ¢æ“ä½œç­‰)ã€‚\nURL      Number        Node.js  Logging æ—¥å¿—åŠŸèƒ½      Command-line utilities å‘½ä»¤è¡Œå·¥å…·        stylelint      ","permalink":"https://www.cheng92.com/web/awesome-web/","tags":["nodejs,","web,","javascript,","typescript"],"title":"Awesome Web Development(WEBå¼€å‘èµ„æº)"},{"categories":["vscode"],"contents":"  å½“å‰ä½¿ç”¨çš„ Doom-Emacsï¼Œä½†æ˜¯åœ¨è¿›è¡Œ vue å¼€å‘è¿‡ç¨‹ä¸­æ€»ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œç”¨èµ·æ¥å¹¶ä¸æ˜¯å¾ˆ ä¸æ»‘ï¼ï¼ï¼ æ•…ã€‚ã€‚ã€‚ã€‚ã€‚\n [2021-04-25 20:58:16] ä¹ æƒ¯è¿™ä¸œè¥¿çœŸå®éš¾æ”¹ï¼Œè¿˜æ˜¯ç»§ç»­ Emacs å§ï¼Œ è™½ç„¶ vscode ä¹Ÿæ•´çš„ å·®ä¸å¤šäº†(\u0026#34;sync.gist\u0026#34;: \u0026#34;26eb4c3f161740254c0f21de867adf87\u0026#34;)ã€‚\n Settings Sync   é…ç½®ä¸Šä¼ å’Œä¸‹è½½ï¼Œç»‘å®š Github \u0026amp; Gistã€‚\n  key bindings(LeaderMode)   ç¬¬ä¸€æ­¥å…ˆå°†æŒ‰é”®ç»‘å®šæèµ·æ¥ã€‚\nSPC     key function     bookmark -   SPC b m è®¾ç½®æ ‡ç­¾   SPC \u0026lt;RET\u0026gt; åˆ—å‡ºæ ‡ç­¾      Command(âŒ˜)     key function     \u0026lt;Command\u0026gt;    S-0 æ‰“å¼€ä¾§è¾¹æ å¹¶èšç„¦   S-b æ‰“å¼€/éšè—ä¾§è¾¹æ    S-F1 æ‰“å¼€é¡¹ç›®Dashboard   S-\u0026#39; å¼•å·åˆ‡æ¢(\u0026#34;\u0026#39;`)   S-shift-\\ è·³è½¬åˆ°åŒ¹é…æ‹¬å·     S-k Quokka, å®æ—¶è°ƒè¯• js/Ts   S-k j javascript   S-k t typescript   S-k q åœ¨å½“å‰æ–‡ä»¶å¯åŠ¨ Quokka      Emacs style     key function     C-c f åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶   C-c F åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºç›®å½•      vim æŒ‰é”®     key function     f/F ace jumpï¼Œå­—ç¬¦/å•è¯   yw å¤åˆ¶å…‰æ ‡åé¢çš„å•è¯å†…å®¹   dw åˆ é™¤å…‰æ ‡åé¢çš„å•è¯å†…å®¹        ","permalink":"https://www.cheng92.com/post/vscode-to-emacs/","tags":["vscode,","emacs"],"title":"å°† VSCode æ‰“é€ æˆ Emacs"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");     è¯¥æ–‡è®°å½•ç€å®é™…å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„ vue3 åŠå…¶ç”Ÿæ€ä¸­ç›¸å…³çš„æ¡†æ¶æˆ–åº“é‡åˆ°çš„å„ç§é—®é¢˜ï¼Œå’Œ å…¶ä»–æ”¶é›†ã€‚\n ç›¸å…³é¡¹ç›®   xiaoxian521/vue-pure-admin: âœ¨ ğŸš€Vue3.0+TypeScript+Vite2.0+Element-Plusç¼–å†™çš„ä¸€ å¥—åå°ç®¡ç†ç³»ç»Ÿ\n  vue3 + tsx   vue3+tsxç¯å¢ƒåˆ›å»ºåŠä½¿ç”¨è·³å‘é¡¹-ä¹‹é—´çš„ä¸ªäººåšå®¢\n æ’ä»¶ï¼š @vitejs/plugin-vue-jsx\n vuejs/jsx-next: JSX for Vue 3\n  vue-next  template ref ä½¿ç”¨   runtime-core ref å±æ€§è§£æ\u0026amp;åˆ†æ\n æ¨¡æ¿ï¼š attrs å½¢å¼ä½¿ç”¨ ref å°†ä¼šç»‘å®š elForm ã€‚\n1 2 3  \u0026lt;templet\u0026gt; \u0026lt;el-form ref=\u0026#34;elForm\u0026#34;/\u0026gt; \u0026lt;/templet\u0026gt;     setup:\n1 2 3 4 5 6 7 8 9 10 11 12 13  defineComponent({ setup(props, ctx) { // å£°æ˜ element ref å˜é‡  const elForm = ref(null) // ä½¿ç”¨  onMounted(() =\u0026gt; { elForm.value.validate(/* bala bala... */) }) return { elForm } } })     æ³¨æ„ç‚¹ï¼š\n  ref=\u0026#34;elForm\u0026#34; ä¸èƒ½ä½¿ç”¨ v-bind:ref åªèƒ½æ˜¯ attrs\n  ä½¿ç”¨æ—¶ elForm.value å› ä¸ºå®ƒæ˜¯ä¸ª Ref ç±»å‹\n      vue-router-next   vuejs/vue-router-next: The Vue 3 official router\n  vuex   vuejs/vuex at 4.0\n Installation | Vuex\nä½¿ç”¨   creation:\n1 2 3 4 5 6 7 8 9 10  import { createStore } from \u0026#34;vuex\u0026#34;; import permission from \u0026#34;./modules/permission\u0026#34;; const store = createStore({ modules: { permission, }, }); export default store;     æ¨¡å—ï¼š æƒé™èœå• (permission)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  // \u0026#39;./modules/permission\u0026#39; // State const state: PermissionState = { asyncMenus: [] as MenuItem[], minorRoutes: [] as RouteConfigRecord[], get mountedRoutes(): RouteConfigRecord[] { // TODO æ ¹æ®å½“å‰ç”¨æˆ·ä»æœåŠ¡å™¨è·å–æƒé™èœå•ï¼Œè·Ÿæ–°åˆ° asyncMenus ä¸­  // æ ¹æ®è¿‡æ»¤åçš„ç»“æœè¿›è¡Œæ¸²æŸ“  return toBeMounted; }, }; // mutation ä¸å¯ç›´æ¥è°ƒç”¨çš„ï¼Œå¿…é¡»é€šè¿‡ commit(SET_MENUS) æ¥è°ƒç”¨ // æ›´æ–°çŠ¶æ€ const mutations = { [SET_MENUS](state: PermissionState, menus: MenuItem[]): void { state.asyncMenus = menus; }, [SET_MINOR_ROUTES](state: PermissionState, routes: RouteConfigRecord[]) { state.minorRoutes = routes; }, }; // action ç»„ä»¶ä¸­å¯é€šè¿‡ store.dispatch(\u0026#39;permission/getMenus\u0026#39;) æ¥è§¦å‘ // å¯¹åº”çš„ action, æ³¨æ„è¿™é‡Œå¦‚æœæ˜¯æ¨¡å—åŒ–éœ€è¦åŠ ä¸Š \u0026#39;permission/\u0026#39; const actions = { async getMenus({ commit }: ActionContext) { if (state.asyncMenus.length) { return state.asyncMenus; } const res = await getMenuList(); commit(SET_MENUS, res.data); return res.data; }, }; // æœ€åå°†ç»“æœå¯¼å‡ºï¼Œå½¢æˆä¸€ä¸ª store æ¨¡å— permission export default { state, mutations, actions, namespaced: true, };      æ•°æ®æŒä¹…åŒ–   vuex-persist æ•°æ®æŒä¹…åŒ–ï¼Œæºç ç®€æ\n  ç–‘éš¾æ‚ç—‡  state: get mountedRoutes æ²¡æœ‰è§¦å‘ï¼Ÿ   é—®é¢˜ç¼˜ç”±:\n  getMenus ä»æœåŠ¡ç«¯è¯·æ±‚æƒæ§èœå•\n1 2 3 4 5 6 7 8 9 10 11 12  const actions: ActionTree\u0026lt;PermissionState, RootState\u0026gt; = { async getMenus({ commit, state }: ActionContext\u0026lt;PermissionState, RootState\u0026gt;) { if (state.asyncMenus.length) { return state.asyncMenus; } const res = await getMenuList(); commit(SET_MENUS, res.data); console.log(state.mountedRoutes, \u0026#34;xxx\u0026#34;); return res.data; }, };      state: get mountedRoutes()\n ç„¶åï¼Œå¸Œæœ›åœ¨ä¹‹åå– mountedRoutes çš„æ—¶å€™èƒ½ä» asyncMenus ä¸­è¿‡æ»¤å‡ºç‰¹å®šæƒé™çš„è·¯ç”±ï¼Œ ä½†æ˜¯è²Œä¼¼è¿™ä¸ª getter æ€ä¹ˆéƒ½æ²¡æ‰§è¡Œï¼Œå› ä¸ºé‡Œé¢çš„ console.log å¹¶æ²¡æœ‰æ‰“å°å‡ºæ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const state = { get mountedRoutes(): RouteConfigRecord[] { console.log(this.asyncMenus, asyncRoutes, \u0026#34;0000\u0026#34;); const toBeMounted = filterRoutesByMenu(asyncRoutes, this.asyncMenus); toBeMounted.forEach((r: RouteConfigRecord) =\u0026gt; { if (r.children \u0026amp;\u0026amp; r.children.length \u0026amp;\u0026amp; r.meta!.showInMenu) { const menuRoutes = r.children.filter((child) =\u0026gt; child.meta!.showInMenu); if (menuRoutes.length) { r.redirect = menuRoutes[0].path; } } }); return toBeMounted; }, };       â— åœ¨ vue3 ä¸­å“åº”å¼é€šè¿‡ Proxy + Reflect æ¥å®ç°çš„ï¼Œå» get mountedRoutes æœ€åæ‰§è¡Œçš„æ˜¯ Reflect.get(state, \u0026#39;mountedRoutes\u0026#39;, ...) è¿™åº•å±‚ä¼°è®¡ä¸ä¼šå»è®¿é—® getter è®¿é—®å™¨ï¼Œ æ‰å¯¼è‡´ä¸ç”Ÿæ•ˆã€‚\n  è§£å†³æ–¹æ¡ˆ(æŠ˜ä¸­æ–¹æ¡ˆ)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  const state: PermissionState = { asyncMenus: [] as MenuItem[], minorRoutes: [] as RouteConfigRecord[], // ADD1 ä¸ä½¿ç”¨ getter  mountedRoutes: [] as RouteConfigRecord[] } const mutations: MutationTree\u0026lt;PermissionState\u0026gt; = { // ADD2 å¢åŠ ä¸€ä¸ª mutation å»æ›´æ–°è·¯ç”±åˆ—è¡¨  [SET_MOUNTED_ROUTES](state: PermissionState) { const menus: MenuItem[] = state.asyncMenus const toBeMounted = filterRoutesByMenu(asyncRoutes, menus) toBeMounted.forEach((r: RouteConfigRecord) =\u0026gt; { if (r.children?.length \u0026amp;\u0026amp; r.meta?.showInMenu) { const menuRoutes = r.children.filter((child) =\u0026gt; child.meta!.showInMenu) if (menuRoutes.length) { r.redirect = menuRoutes[0].path } } }) state.mountedRoutes = toBeMounted } } const actions: ActionTree\u0026lt;PermissionState, RootState\u0026gt; = { async getMenus({ commit, state }: ActionContext\u0026lt;PermissionState, RootState\u0026gt;) { if (state.asyncMenus.length) { return state.asyncMenus } const res = await getMenuList() commit(SET_MENUS, res.data) // ADD3 è¿™é‡Œå½“æ›´æ–°èœå•çš„æ—¶å€™åŒæ­¥è¿‡æ»¤å‡ºæœ‰æ•ˆè·¯ç”±  commit(SET_MOUNTED_ROUTES) return res.data }, }     ç»“æœï¼š\n1 2 3 4  [[Target]]: Object asyncMenus: (4) [{â€¦}, {â€¦}, {â€¦}, {â€¦}] minorRoutes: [] mountedRoutes: (4) [{â€¦}, {â€¦}, {â€¦}, {â€¦}]          vue-i18n-next   intlify/vue-i18n-next: Vue I18n for Vue 3\n Docs: Installation | Vue I18n\n Usageï¼š Vue i18n: Building a multi-lingual app - Lokalise Blog\n  vue-i18n esm-bundler è­¦å‘Š\n You are running the esm-bundler build of vue-i18n. It is recommended to configure your bundler to explicitly replace feature flag globals with boolean literals to get proper tree-shaking in the final bundle.\n  fixï¼šè§£å†³vue-i18nåœ¨å¼€å‘ç¯å¢ƒä¸‹çš„å‘Šè­¦ Â· xiaoxian521/vue-pure-admin@f2db3ac\n1 2 3 4  alias: { \u0026#34;@\u0026#34;: path.resolve(__dirname, \u0026#34;./src\u0026#34;), + \u0026#34;vue-i18n\u0026#34;: \u0026#34;vue-i18n/dist/vue-i18n.cjs.js\u0026#34;, };         element-plus  el-upload   ä½¿ç”¨(ä¸è‡ªåŠ¨ä¸Šä¼ )ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  export function GlUpload(props, { slots }) { return h( E.ElUpload, _.extend( { class: \u0026#34;upload\u0026#34;, action: \u0026#34;#\u0026#34;, \u0026#34;list-type\u0026#34;: \u0026#34;picture-card\u0026#34;, \u0026#34;auto-upload\u0026#34;: false, onChange(file, fileList) { console.log(file, fileList, \u0026#34;xx\u0026#34;); }, }, props ), { default: () =\u0026gt; h(\u0026#34;i\u0026#34;, { class: \u0026#34;el-icon-plus\u0026#34;, }), ...slots, } ); }    TIP\n ä¸ä½¿ç”¨è‡ªåŠ¨ä¸Šä¼ åŠŸèƒ½çš„æ—¶å€™ï¼Œå¦‚æœè¦å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œéœ€è¦è‡ªå·±å°†æ•°æ®å˜æˆè¡¨å• (FormData)æ•°æ®ï¼Œæœ‰ç‚¹ç»•ã€‚\n  è¿™é‡Œæœ‰ä¸ªæ’ä»¶å¯ä»¥ä½¿ç”¨ï¼Œå°† json è½¬æˆ FormData: hyperatom/json-form-data: A library to convert javascript objects into form data.\n çœ‹äº†ä¸‹æºç (140l) å®ç°åŸç†ä¸­å°±æ˜¯æ·±åº¦éå† json æ•°æ®ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¯¹è±¡ç±»å‹çš„è½¬æ¢ã€‚\n1 2 3 4 5 6 7 8 9  å¦‚ï¼š{a:{b:1},{c:{d:2}}} -\u0026gt; a[b]: 1 -\u0026gt; a[c][d]:2 å¦‚ï¼š {a: [1,2,3,4]} -\u0026gt; a[0]:1 -\u0026gt; a[1]:2 -\u0026gt; a[2]:3 -\u0026gt; a[3]:4     å®ä¾‹ï¼š\npageId: 17 name: test5 status: 1 isDefault: 0 startTime: 2021-11-10 10:10 endTime: 2021-11-11 10:10 isPermanent: 0 targetType: 1 templateType: epg21 target[0]: 1001 target[1]: 1002 target[2]: 1003 target[3]: 1004 target[4]: 1005 target[5]: 1006 target[6]: 1007 target[7]: 1010 target[8]: 121 target[9]: 188 target[10]: 2001 target[11]: 2308 target[12]: 666 target[13]: 833 target[14]: 8513 hasBgPic: 1 hasBgMedia: 0 hasLogo: 0 hasSmallPic: 0 hasPicList: 1 hasWifi: 0 hasWeather: 0 hasWelcomeText: 1 welcomeText: [] IsPermanent: 0   å³éœ€è¦è¿›è¡Œæ‰å¹³åŒ–å¤„ç†ï¼Œå°†æ‰€æœ‰çš„åµŒå¥—è½¬æˆè·¯å¾„æ–¹å¼ a[b][c][d][e]:1 ç­‰äºæ˜¯ï¼š\n { a: { b: { c: { d: { e:1 } } } } }\n  el-table index å…¨éƒ¨ä¸º 0 é—®é¢˜   [bug report] El table column type = \u0026#34;index\u0026#34; error after using row key attribute in El table Â· Issue #2143 Â· element-plus/element-plus\n    ","permalink":"https://www.cheng92.com/vue/vue-project-ecosystem/","tags":["vue,","vue3,","vue-router,","vuex,","i18n"],"title":"Vue3 å¼€å‘ç”Ÿæ€é“¾(vuex, vue-router, ...)"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");     buffer  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  export function createBuffer() { let appendable = false const buffer: SSRBuffer = [] return { getBuffer(): SSRBuffer { // Return static buffer and await on items during unroll stage  return buffer }, push(item: SSRBufferItem) { const isStringItem = isString(item) if (appendable \u0026amp;\u0026amp; isStringItem) { buffer[buffer.length - 1] += item as string } else { buffer.push(item) } appendable = isStringItem if (isPromise(item) || (isArray(item) \u0026amp;\u0026amp; item.hasAsync)) { // promise, or child buffer with async, mark as async.  // this allows skipping unnecessary await ticks during unroll stage  // æ ‡è®°ä¸ºå¼‚æ­¥ buffer  buffer.hasAsync = true } } } }      ","permalink":"https://www.cheng92.com/vue/vue-mind-map-server-renderer/","tags":["vue,","vue3,","server-renderer,","ssr"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 9 â˜ server-renderer"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");       stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n è¿è¡Œæ—¶çš„ DOM æ“ä½œã€‚\n patch props  class  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  export const patchProp: DOMRendererOptions[\u0026#39;patchProp\u0026#39;] = ( el, key, prevValue, nextValue, isSVG = false, prevChildren, parentComponent, parentSuspense, unmountChildren ) =\u0026gt; { switch (key) { // ç‰¹æ®Šå±æ€§  case \u0026#39;class\u0026#39;: patchClass(el, nextValue, isSVG) break case \u0026#39;style\u0026#39;: break default: break } }     class patch æ“ä½œ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  export function patchClass(el: Element, value: string | null, isSVG: boolean) { if (value == null) { value = \u0026#34;\u0026#34;; } if (isSVG) { el.setAttribute(\u0026#34;class\u0026#34;, value); } else { const transitionClasses = (el as any) /* TODO ElementWithTransition */._vtc; if (transitionClasses) { // åˆå¹¶ç±»å  value = (value ? [value, ...transitionClasses] : [...transitionClasses] ).join(\u0026#34;\u0026#34;); } el.className = value; } }    (function() { const { render, h, patchProp } = VueRuntimeDOM const el = document.createElement('div') patchProp(el, 'class', null, 'foo') console.log(el.className, el.outerHTML, '\\nafter') patchProp(el, 'class', null, null) console.log(el.className, el.outerHTML) }())   insertPreCode('x6c22Ir')   è¾“å‡ºç»“æœï¼š\nfoo \u0026lt;div class=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; after \u0026lt;div class=\u0026#34;\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;    style   feat(add): runtime-dom, patch props style Â· gcclll/stb-vue-next@50468d8\n æºç :\n  åˆ é™¤æ“ä½œ(next ä¸ºç©ºçš„æ—¶å€™)\n  å¦‚æœæ˜¯å­—ç¬¦ä¸²ç›´æ¥æ›¿æ¢ cssText\n  å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°†éå†æ‰€æœ‰å±æ€§é‡æ–°è®¾å€¼ï¼Œæ–°æœ‰æ—§æ²¡æœ‰æ‰§è¡Œåˆ é™¤\n æ¯”å¦‚ï¼š\n old = { color: \u0026#39;red\u0026#39;, \u0026#39;font-size\u0026#39;: \u0026#39;32px\u0026#39; }\n next = { color: \u0026#39;blue\u0026#39; }\n é‚£ä¹ˆæœ€ç»ˆå­—ä½“é¢œè‰²ä¼šå˜æˆ blue ï¼Œå­—ä½“å¤§å°è¢«é‡ç½®ä¸ºé»˜è®¤å¤§å°ã€‚\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  export function patchStyle(el: Element, prev: Style, next: Style) { const style = (el as HTMLElement).style if (!next) { // åˆ é™¤æ“ä½œ  el.removeAttribute(\u0026#39;style\u0026#39;) } else if (isString(next)) { // æ›´æ–°æ“ä½œï¼Œå…¨æ›¿æ¢æ“ä½œ  if (prev !== next) { style.cssText = next } } else { // å¦‚æœæ˜¯å¯¹è±¡ï¼Œæ ¹æ®å¯¹è±¡å†…çš„å±æ€§é€ä¸ªè¿›è¡Œæ›´æ–°  for (const key in next) { // æ›´æ–°å•ä¸ªå€¼  setStyle(style, key, next[key]) } if (prev \u0026amp;\u0026amp; !isString(prev)) { // åˆ é™¤è€çš„ä¸åœ¨ next ä¸­çš„å€¼  for (const key in prev) { if (next[key] == null) { setStyle(style, key, \u0026#39;\u0026#39;) } } } } }     setStyle ä»£ç ï¼š\n  æ”¯æŒå¯¹åŒä¸€ä¸ªå±æ€§è®¾ç½®ä¸åŒçš„å€¼ï¼Œç­‰äºæ˜¯å–æœ€åçš„é‚£ä¸ªå€¼\n å¦‚ï¼š color:red è®¾å€¼ [\u0026#39;blue\u0026#39;, \u0026#39;black\u0026#39;, \u0026#39;red\u0026#39;] æœ€åè¿˜æ˜¯ red\n  æ”¯æŒ --webkit-xxx å‰ç¼€è®¾ç½®\n  è‡ªåŠ¨æ·»åŠ  webkit, moz, ms å‰ç¼€\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  function setStyle( style: CSSStyleDeclaration, name: string, val: string | string[] ) { if (isArray(val)) { // åŒä¸€ä¸ªå±æ€§è®¾ç½®å¤šä¸ªå€¼ï¼Ÿå–æœ€åä¸€ä¸ªæœ‰æ•ˆå€¼  val.forEach(v =\u0026gt; setStyle(style, name, v)) } else { // å¤šæµè§ˆå™¨çš„å…¼å®¹å¤„ç†ï¼Œå¦‚ï¼š --webkit-...  if (name.startsWith(\u0026#39;--\u0026#39;)) { // custom property definition  style.setProperty(name, val) } else { // è‡ªåŠ¨æ·»åŠ å‰ç¼€  const prefixed = autoPrefix(style, name) if (importantRE.test(val)) { // ä¼˜å…ˆçº§æœ€é«˜çš„å¤„ç†  // !important  style.setProperty( hyphenate(prefixed), val.replace(importantRE, \u0026#39;\u0026#39;), \u0026#39;important\u0026#39; ) } else { style[prefixed as any] = val } } } }     æ·»åŠ å‰ç¼€(WebKit, Mox, ms)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  const prefixes = [\u0026#39;Webkit\u0026#39;, \u0026#39;Moz\u0026#39;, \u0026#39;ms\u0026#39;] const prefixCache: Record\u0026lt;string, string\u0026gt; = {} // è‡ªåŠ¨æ·»åŠ å‰ç¼€å¤„ç† function autoPrefix(style: CSSStyleDeclaration, rawName: string): string { const cached = prefixCache[rawName] if (cached) { return cached } let name = camelize(rawName) if (name !== \u0026#39;filter\u0026#39; \u0026amp;\u0026amp; name in style) { return (prefixCache[rawName] = name) } name = capitalize(name) for (let i = 0; i \u0026lt; prefixes.length; i++) { const prefixed = prefixes[i] + name if (prefixed in style) { return (prefixCache[rawName] = prefixed) } } return rawName }     æµ‹è¯•ä»£ç å’Œç»“æœï¼š\n  ç‚¹å‡»æŸ¥çœ‹æµ‹è¯•æºç    onXxx   feat(add): runtime-dom event prop Â· gcclll/stb-vue-next@3402f03\n æºç ï¼š\n  prevValue å·²ç»ç»‘å®šåˆ° el ä¸Šçš„ä¸€ä¸ªäº‹ä»¶å¥æŸ„\n  nextValue æ–°çš„äº‹ä»¶å¥æŸ„ï¼Œå¦‚æœä¸¤è€…åŒæ—¶å­˜åœ¨æ˜¯ä¼šè¿›è¡Œæ›¿æ¢\n  rawName äº‹ä»¶åç§°ï¼Œå¦‚ï¼š onClick\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  export function patchEvent( el: Element \u0026amp; { _vei?: Record\u0026lt;string, Invoker | undefined\u0026gt; }, rawName: string, prevValue: EventValue | null, nextValue: EventValue | null, instance: ComponentInternalInstance | null = null ) { // vue event invokers  const invokers = el._vei || (el._vei = {}) const existingInvoker = invokers[rawName] if (nextValue \u0026amp;\u0026amp; existingInvoker) { // patch  existingInvoker.value = nextValue } else { const [name, options] = parseName(rawName) if (nextValue) { // add æ·»åŠ äº‹ä»¶  const invoker = (invokers[rawName] = createInvoker(nextValue, instance)) addEventListener(el, name, invoker, options) } else if (existingInvoker) { // remove åˆ é™¤äº‹ä»¶  removeEventListener(el, name, existingInvoker, options) invokers[rawName] = undefined } } }     ä¸Šé¢ä¸»è¦æœ‰å‡ ä¸ªæ­¥éª¤:\n  å¦‚æœå·²ç»å­˜åœ¨çš„äº‹ä»¶å¥æŸ„ç›´æ¥æ›´æ–° exisitingInvoker.value çš„å€¼\n  è§£æäº‹ä»¶åç§°ä¸»è¦æ˜¯è§£æå‡º Once|Passive|Capture ä¸‰ä¸ªäº‹ä»¶ä¿®é¥°ç¬¦\n å¦‚ï¼š\n onClick =\u0026gt; [\u0026#39;click\u0026#39;, {}]\n onClickOnce =\u0026gt; [\u0026#39;click\u0026#39;, {once: true}]\n onClickOnceCapture =\u0026gt; [\u0026#39;click\u0026#39;, {once: true, capture: true}]\n  æ·»åŠ äº‹ä»¶ patchProp(el, \u0026#39;onClick\u0026#39;, null, fn)\n  åˆ é™¤äº‹ä»¶ patchProp(el, \u0026#39;onClick\u0026#39;, oldFn|null, null)\n å½“ newFn ä¼ ç©ºå€¼æ—¶ï¼Œç­‰äºæ˜¯åˆ é™¤è¯¥å…ƒç´ ä¸Šç»‘å®šçš„ \u0026#39;onclick\u0026#39; äº‹ä»¶å¥æŸ„ã€‚\n   äº‹ä»¶åè§£æ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // è§£æäº‹ä»¶å onClick -\u0026gt; [\u0026#39;click\u0026#39;] // onClickOnce -\u0026gt; [\u0026#39;click\u0026#39;, { once: true }] // onClickOncePassive -\u0026gt; [\u0026#39;click\u0026#39;, { once: true, passive: true }] function parseName(name: string): [string, EventListenerOptions | undefined] { let options: EventListenerOptions | undefined if (optionsModifierRE.test(name)) { options = {} let m while ((m = name.match(optionsModifierRE))) { name = name.slice(0, name.length - m[0].length) ;(options as any)[m[0].toLowerCase()] = true options } } return [name.slice(2).toLowerCase(), options] }     invoker: è¿™ä¸ªå°è£…çš„é‡ç‚¹åœ¨äºå½“ç»‘å®šäº‹ä»¶çš„æ—¶å€™ï¼Œè®°å½•ç»‘å®šæ—¶çš„æ—¶é—´æˆ³ï¼Œç„¶ååœ¨æ‰§è¡Œçš„æ—¶ å€™å»æ¯”è¾ƒâ€œå½“å‰è§¦å‘çš„äº‹ä»¶çš„äº‹ä»¶æˆ³(e.timeStamp)â€ å’Œ â€œäº‹ä»¶å¥æŸ„ç»‘å®šæ—¶çš„æ—¶é—´æˆ³â€ï¼Œåªè¦ å‰è€…æ¯”åè€…å¤§å°±è¯´æ˜å¯ä»¥æ‰§è¡Œäº‹ä»¶å¥æŸ„äº†(è¯´å®è¯ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å¾ˆæ‡‚ï¼ï¼ï¼)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  function createInvoker( initialValue: EventValue, instance: ComponentInternalInstance | null ) { const invoker: Invoker = (e: Event) =\u0026gt; { // å¼‚æ­¥è¾¹ç¼˜æƒ…å†µï¼šå†…éƒ¨ç‚¹å‡»äº‹ä»¶è§¦å‘ patch ï¼Œäº‹ä»¶  // å¥æŸ„åœ¨ patch é˜¶æ®µç»‘å®šåœ¨ outer element ä¸Šï¼Œ  // ç„¶åä¼šè¢«å†æ¬¡è§¦å‘ï¼Œè¿™ç§æƒ…å†µçš„å‘ç”ŸåŸå› æ˜¯æµè§ˆå™¨åœ¨äº‹ä»¶  // å†’æ³¡æœŸé—´è§¦å‘äº†å¾®ä»»åŠ¡æ—¶é’Ÿ(microtask ticks)  // è§£å†³æ–¹æ¡ˆï¼šä¿å­˜äº‹ä»¶å¥æŸ„è¢«ç»‘å®šç¬é—´çš„æ—¶é—´æˆ³(timestamp)  // ç„¶åäº‹ä»¶å¥æŸ„åªæœ‰åœ¨â€œå·²ä¿å­˜çš„æ—¶é—´æˆ³ä¹‹åè§¦å‘çš„äº‹ä»¶â€ä¸Šå»æ‰§è¡Œ  const timeStamp = e.timeStamp || _getNow() if (timeStamp \u0026gt;= invoker.attached - 1) { callWithAsyncErrorHandling( patchStopImmediatePropagation(e, invoker.value), instance, ErrorCodes.NATIVE_EVENT_HANDLER, [e] ) } } invoker.value = initialValue invoker.attached = getNow() return invoker }     å¦å¤–äº‹ä»¶å¥æŸ„æ‰§è¡Œåˆæ˜¯è¿›è¡Œäº†ä¸€æ¬¡å°è£…çš„(patchStopImmediatePropagation())ï¼Œé‚£è¿™ä¸ª å‡½æ•°æ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ\n æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªå…ƒç´ æ˜¯å¯ä»¥åœ¨ä¸€ä¸ªäº‹ä»¶åä¸‹ç»‘å®šå¤šä¸ªäº‹ä»¶å¥æŸ„çš„ï¼Œå½“è¿™ä¸ªäº‹ä»¶è§¦å‘çš„æ—¶å€™ä¼š è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ç»‘å®šçš„äº‹ä»¶å¥æŸ„ã€‚\n Event.stopImmediatePropagation() - Web APIs | MDN\n Event.stopImmediatePropagation() The stopImmediatePropagation() method of the Event interface prevents other listeners of the same event from being called.\n è¿™æ®µæ„æ€æ˜¯è¯´ stopImmediatePropagation() ä¼šé˜»æ­¢å…¶ä»– listeners ç»§ç»­æ‰§è¡Œã€‚\n If several listeners are attached to the same element for the same event type, they are called in the order in which they were added. If stopImmediatePropagation() is invoked during one such call, no remaining listeners will be called. å¦‚æœæœ‰å¤šä¸ª listeners ç»‘å®šåˆ°åŒä¸€å…ƒç´ çš„åŒä¸€äº‹ä»¶ç±»å‹ä¸Šï¼Œä»–ä»¬ä¼šæŒ‰ç…§æ·»åŠ çš„é¡ºåºä¾æ¬¡è¢« æ‰§è¡Œã€‚å¦‚æœ stopImmediatePropagation() åœ¨ä»»æ„ä¸€ä¸ª listener æ‰§è¡ŒæœŸé—´è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå‰© ä½™çš„ listeners å°±ä¸ä¼šå†è¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä»»æ„ä¸€ä¸ª listener å†…å¯ä»¥æ§åˆ¶åç»­çš„ listeners æ˜¯å¦ä¼šè¢«æ‰§è¡Œã€‚\n  å†æ¥çœ‹ patchStopImmediatePropagation() æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  function patchStopImmediatePropagation( e: Event, value: EventValue ): EventValue { if (isArray(value)) { const originalStop = e.stopImmediatePropagation; // è¿™é‡Œå¯¹äº‹ä»¶çš„ stopImmediatePropagation è¿›è¡Œäº†äºŒæ¬¡å°è£…  e.stopImmediatePropagation = () =\u0026gt; { originalStop.call(e); // åŠ å…¥äº†ä¸€ä¸ªæ ‡è¯†  (e as any)._stopped = true; }; // è¿™é‡Œåˆå¯¹æ‰€æœ‰çš„ listeners è¿›è¡Œäº†äºŒæ¬¡å°è£…  // å³å¦‚æœ _stopped æ˜¯å‡å€¼çš„æƒ…å†µä¸‹æ‰è°ƒç”¨ listener  // æ„æ€å°±æ˜¯ç»“åˆ stopImmediatePropagation è¿™é‡Œåšäº†æ‰‹åŠ¨ç®¡ç†  return value.map((fn) =\u0026gt; (e: Event) =\u0026gt; !(e as any)._stopped \u0026amp;\u0026amp; fn(e)); } else { return value; } }     â“ åˆæƒ³ä¼šä¸ä¼šè§‰å¾—å¤šæ­¤ä¸€ä¸¾ â“\n  é‚£ä¹ˆæˆ‘ä»¬å°†å…³é”®çš„ä»£ç æ”¾ä¸€èµ·æ¥çœ‹çœ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // patchEvent const invokers = el._vei || (el._vei = {}); const existingInvoker = invokers[rawName]; if (nextValue \u0026amp;\u0026amp; existingInvoker) { // patch  existingInvoker.value = nextValue; } // createInvoker -\u0026gt; invoker if (timeStamp \u0026gt;= invoker.attached - 1) { callWithAsyncErrorHandling( patchStopImmediatePropagation(e, invoker.value), instance, ErrorCodes.NATIVE_EVENT_HANDLER, [e] ); }     ä¸€ä¸ªå…ƒç´ ä¸Šä¸åŒ name çš„äº‹ä»¶éƒ½ä¼šä¿å­˜åˆ° DOM å…ƒç´ çš„ el._veiä¸Šé¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸‹æ¬¡æ³¨å†Œäº‹ ä»¶çš„æ—¶å€™ä¼šç›´æ¥ä»è¿™é‡Œå–å‡º invokerï¼Œç›´æ¥æ›´æ–°invoker.value è€Œä¸æ˜¯é‡æ–°åˆ›å»ºäº†ä¸€ä¸ªå‡½æ•° æ¥æ¥å—è¿™ä¸ªäº‹ä»¶å¥æŸ„\n æ¯”å¦‚ï¼š\n æ™®é€šä½¿ç”¨æƒ…å†µ:\n el.addEventListener(\u0026#39;click\u0026#39;, fn1)\n el.addEventListener(\u0026#39;click\u0026#39;, fn2)\n é‚£ä¹ˆåœ¨ el ä¸Šä¼šæœ‰ä¸¤ä¸ªå¥æŸ„ fn1, fn2\n ä½¿ç”¨patchEvent:\n patchEvent(el, \u0026#39;click\u0026#39;, null, fn1)\n patchEvent(el, \u0026#39;click\u0026#39;, null,fn2)\n è¿™é‡Œå®é™…ä¸Šå¹¶æ²¡æœ‰æ·»åŠ ä¸¤ä¸ªå¥æŸ„ fn1, fn2 è€Œæ˜¯ç­‰äº fn1 = fn2 è¦†ç›–äº†æ­¤æ—¶ fn1 å…¶å® å·²ç»ä¸å­˜åœ¨äº†ï¼Œå¹¶ä¸”æ­¤æ—¶ç»‘å®šåœ¨ el ä¸Šçš„ click äº‹ä»¶çš„å¥æŸ„å°±æ°¸è¿œæ˜¯ç¬¬ä¸€æ¬¡æ³¨å†Œ fn1 æ—¶åˆ› å»ºçš„é‚£ä¸ª invoker (é™¤éæ‰§è¡Œ patchEvent(el, \u0026#39;click\u0026#39;, null, null) åˆ é™¤äº†è¿™ä¸ª invoker)\n é‚£å¦‚ä½•å®ç°ä¸€ä¸ªå…ƒç´ ä¸€ä¸ªäº‹ä»¶ç»‘å®šå¤šä¸ªå¥æŸ„å‘¢ï¼Ÿ\n è¿™æ ·: patchEvent(el, \u0026#39;click\u0026#39;, null, [fn1, fn2])\n å› ä¸ºåœ¨ vue ä¸­ç»‘å®šçš„äº‹ä»¶å¥æŸ„æœ€åéƒ½ä¼šè¢«è§£æåˆ°ä¸€ä¸ªæ•°ç»„ä¸­ã€‚\n æ­£å¦‚ä¸Šé¢åˆ†æçš„ç»“æœï¼Œä¹Ÿå°±æ˜¯è¯´ patchEvent() æ°¸è¿œåªä¼šåœ¨ el ä¸Šå¯¹äºåŒåäº‹ä»¶æ³¨å†Œä¸€ä¸ª å¥æŸ„ invokerï¼Œé‚£ä¹ˆ event.stopImmediatePropagation() åœ¨è¿™é‡Œå®é™…æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Œå®ƒ å®é™…å¹¶ä¸èƒ½æ§åˆ¶ invoker.value ä¸­çœŸæ­£çš„äº‹ä»¶å¥æŸ„æ‰§è¡Œã€‚\n æ‰€ä»¥å°±æœ‰äº† patchStopImmediatePropagation() å‡½æ•°çš„å°è£…ï¼Œæ¥å˜ç›¸å®ç° stopImmediatePropagation å¯¹çœŸæ­£äº‹ä»¶å¥æŸ„çš„æ§åˆ¶ã€‚\n æµ‹è¯•ï¼š\n  ç‚¹å‡»æŸ¥çœ‹æµ‹è¯•æºç    props   ä¸€ä¸ªå‡½æ•°å¤„ç†å‡ ç§æƒ…å†µï¼Œä¸»è¦å¤„ç†çš„æ˜¯DOMå…ƒç´ ä¸Šçš„ä¸€äº›å†…ç½®å±æ€§\n  innerHTML æˆ– textContent\n ç›´æ¥å¤åˆ¶æ“ä½œï¼Œ el[key] = value || \u0026#39;\u0026#39; , å¦‚æœæœ‰ children å…¨éƒ¨å¸è½½æ‰ã€‚\n  key=value ä¸”æ ‡ç­¾é PROGRESS\n el._value = value ä¿å­˜åŸå§‹å€¼ï¼Œè¿™ç§é’ˆå¯¹æœ‰ value çš„å…ƒç´ ï¼Œæ¯”å¦‚ï¼š \u0026lt;input/\u0026gt;\n  ç©ºå€¼å¤„ç†æˆ–çœŸå€¼å¤„ç†(å¦‚ï¼š \u0026lt;select multiple\u0026gt;)\n boolean å¤„ç†æˆ true, string å¤„ç†æˆ \u0026#39;\u0026#39;, number å¤„ç†æˆ 0 ã€‚\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  // functions. The user is responsible for using them with only trusted content. export function patchDOMProp( el: any, key: string, value: any, // the following args are passed only due to potential innerHTML/textContent  // overriding existing VNodes, in which case the old tree must be properly  // unmounted.  prevChildren: any, parentComponent: any, parentSuspense: any, unmountChildren: any ) { if (key === \u0026#34;innerHTML\u0026#34; || key === \u0026#34;textContent\u0026#34;) { if (prevChildren) { unmountChildren(prevChildren, parentComponent, parentSuspense); } el[key] = value == null ? \u0026#34;\u0026#34; : value; return; } if (key === \u0026#34;value\u0026#34; \u0026amp;\u0026amp; el.tagName !== \u0026#34;PROGRESS\u0026#34;) { // store value as _value as well since  // non-string values will be stringified.  el._value = value; const newValue = value == null ? \u0026#34;\u0026#34; : value; if (el.value !== newValue) { el.value = newValue; } return; } // ç©ºå€¼å¤„ç†  if (value === \u0026#34;\u0026#34; || value == null) { const type = typeof el[key]; if (value === \u0026#34;\u0026#34; \u0026amp;\u0026amp; type === \u0026#34;boolean\u0026#34;) { // æ¯”å¦‚ï¼š \u0026lt;select multiple\u0026gt; ç¼–è¯‘æˆï¼š { multiple: \u0026#39;\u0026#39; }  el[key] = true; return; } else if (value == null \u0026amp;\u0026amp; type === \u0026#34;string\u0026#34;) { // å¦‚ï¼š \u0026lt;div :id=\u0026#34;null\u0026#34;\u0026gt;  el[key] = \u0026#34;\u0026#34;; el.removeAttribute(key); return; } else if (type === \u0026#34;number\u0026#34;) { // å¦‚ï¼š \u0026lt;img :width=\u0026#34;null\u0026#34;\u0026gt;  el[key] = 0; el.removeAttribute(key); return; } } // some properties perform value validation and throw  try { el[key] = value; } catch (e) { if (__DEV__) { warn( `Failed setting prop \u0026#34;${key}\u0026#34; on \u0026lt;${el.tagName.toLowerCase()}\u0026gt;: ` + `value ${value}is invalid.`, e ); } } }     æµ‹è¯•ï¼š\n  ç‚¹å‡»æŸ¥çœ‹æµ‹è¯•æºç    true/false-value   feat(add): runtime-dom patch v-model Â· gcclll/stb-vue-next@580b0f3\n true-value \u0026amp; false-value å±æ€§åœ¨ compiler-ssr ä¸­æœ‰è¯¦ç»†åˆ†æï¼Œä¸»è¦ç”¨äº SSR ä¸‹çš„ \u0026lt;input type=\u0026#34;checkbox\u0026#34;\u0026gt; çš„æ—¶å€™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  // patchProp.ts // special case for \u0026lt;input v-model type=\u0026#34;checkbox\u0026#34;\u0026gt; with // :true-value \u0026amp; :false-value // store value as dom properties since non-string values will be // stringified. if (key === \u0026#34;true-value\u0026#34;) { (el as any)._trueValue = nextValue; } else if (key === \u0026#34;false-value\u0026#34;) { (el as any)._falseValue = nextValue; } patchAttr(el, key, nextValue, isSVG); // modules/attrs.ts export const xlinkNS = \u0026#34;http://www.w3.org/1999/xlink\u0026#34;; export function patchAttr( el: Element, key: string, value: any, isSVG: boolean ) { if (isSVG \u0026amp;\u0026amp; key.startsWith(\u0026#34;xlink:\u0026#34;)) { if (value == null) { el.removeAttributeNS(xlinkNS, key.slice(6, key.length)); } else { el.setAttributeNS(xlinkNS, key, value); } } else { // note we are only checking boolean attributes that don\u0026#39;t have a  // corresponding dom prop of the same name here.  const isBoolean = isSpecialBooleanAttr(key); if (value == null || (isBoolean \u0026amp;\u0026amp; value === false)) { el.removeAttribute(key); } else { el.setAttribute(key, isBoolean ? \u0026#34;\u0026#34; : value); } } } // shared/src/domAttrConfig.ts const specialBooleanAttrs = `itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly`; export const isSpecialBooleanAttr = /*#__PURE__*/ makeMap(specialBooleanAttrs);     æµ‹è¯•ï¼š\n  ç‚¹å‡»æŸ¥çœ‹æµ‹è¯•æºç      nodeOps   DOM æ“ä½œæ¥å£ã€‚\n feat(add): nodeOps Â· gcclll/stb-vue-next@88b8bda\n   æ¥å£å æè¿° åŸç”Ÿæ¥å£     insert(child, parent, anchor) åœ¨ anchor å‰é¢æ’å…¥ child parent.insertBefore(child, anchor)   remove(child) åˆ é™¤æŸä¸ªå­å…ƒç´  child.parentNode.removeChild(child)   createElement(tag, isSVG, is) åˆ›å»ºå…ƒç´ (svgæˆ–æ™®é€šå…ƒç´ ) document.createElement   createText(text) åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ document.createTextNode(text)   createComment(text) åˆ›å»ºæ³¨é‡ŠèŠ‚ç‚¹ document.createComment(text)   setText(node, text) è®¾ç½®èŠ‚ç‚¹æ–‡æœ¬å†…å®¹ node.nodeValue = text   setElementText(el, text) è®¾ç½® textContent el.textContent   parentNode(node) å–çˆ¶å…ƒç´  node.parentNode   nextSibling(node) å–åé¢çš„å…„å¼ŸèŠ‚ç‚¹ node.nextSibling   querySelector(selector) é€‰æ‹©å™¨æŸ¥è¯¢ document.querySelector(selector)   setScopeId(el, id) ç»™å…ƒç´ å¢åŠ  id å±æ€§ el.setAttribute(id, \u0026#39;\u0026#39;)   cloneNode(el) æ·±åº¦å…‹éš†å…ƒç´  el.cloneNode(true)   insertStaticContent(content, parent, anchor, isSVG) æ’å…¥é™æ€å†…å®¹ï¼Ÿ -     è¿™ä¸ªæ–‡ä»¶ä¸­å°±æ˜¯ä¸€äº›å¯¹åŸç”ŸDOMå¢åˆ æ”¹æŸ¥æ¥å£çš„å°è£…ã€‚\n  TODO Transition\u0026amp;Group   feat(add): Transition\u0026amp;Group Â· gcclll/stb-vue-next@444b0bb\n  v-on äº‹ä»¶   è¿™é‡Œé¢ä¸»è¦å¤„ç†çš„æ˜¯ä¸€äº›ä¿®é¥°ç¬¦å¤„ç†ã€‚\n feat(add): v-on event Â· gcclll/stb-vue-next@9280816\n ç³»ç»Ÿä¿®é¥°ç¬¦(å‡ ä¸ªç³»ç»ŸæŒ‰é”®)ï¼š\n const systemModifiers = [\u0026#39;ctrl\u0026#39;, \u0026#39;shift\u0026#39;, \u0026#39;alt\u0026#39;, \u0026#39;meta\u0026#39;]\n æ”¯æŒçš„äº‹ä»¶ç±»å‹(é”®ç›˜ã€é¼ æ ‡ã€è§¦æ§)ï¼š\n type KeyedEvent = KeyboardEvent | MouseEvent | TouchEvent\n ä¿®é¥°ç¬¦å¯¹åº”åœ¨äº‹ä»¶ä¸Šçš„ä¸€äº›æ“ä½œï¼Œå› ä¸ºä¿®é¥°ç¬¦æœ€ç»ˆçš„å€¼ä½“ç°æ˜¯ boolean å€¼ï¼Œå› æ­¤è¿™äº›å¸ƒå°” å€¼éœ€è¦å¯¹åº”åœ¨å…·ä½“çš„äº‹ä»¶ä¸Šï¼Œå°±éœ€è¦æ‰¾åˆ°äº‹ä»¶ä¸Šçš„å¯¹æ–¹æ–¹æ³•å»å¤„ç†ï¼Œæ¯”å¦‚ @click.stop è§£æåçš„ä¿®é¥°ç¬¦ {stop: true} å¯¹åº”äº‹ä»¶ä¸Šçš„ e.stopPropagation() è°ƒç”¨ï¼Œé˜»æ­¢äº‹ä»¶ ç½‘ä¸Šå†’æ³¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const modifierGuards: Record\u0026lt; string, (e: Event, modifiers: string[]) =\u0026gt; void | boolean \u0026gt; = { stop: (e) =\u0026gt; e.stopPropagation(), prevent: (e) =\u0026gt; e.preventDefault(), self: (e) =\u0026gt; e.target !== e.currentTarget, ctrl: (e) =\u0026gt; !(e as KeyedEvent).ctrlKey, shift: (e) =\u0026gt; !(e as KeyedEvent).shiftKey, alt: (e) =\u0026gt; !(e as KeyedEvent).altKey, meta: (e) =\u0026gt; !(e as KeyedEvent).metaKey, left: (e) =\u0026gt; \u0026#34;button\u0026#34; in e \u0026amp;\u0026amp; (e as MouseEvent).button !== 0, middle: (e) =\u0026gt; \u0026#34;button\u0026#34; in e \u0026amp;\u0026amp; (e as MouseEvent).button !== 1, right: (e) =\u0026gt; \u0026#34;button\u0026#34; in e \u0026amp;\u0026amp; (e as MouseEvent).button !== 2, exact: (e, modifiers) =\u0026gt; systemModifiers.some( (m) =\u0026gt; (e as any)[`${m}Key`] \u0026amp;\u0026amp; !modifiers.includes(m) ), };     æœ€åæ ¹æ®ä¿®é¥°ç¬¦å®ˆå«ï¼Œå°†äº‹ä»¶å‡½æ•°è¿›ä¸€æ­¥å°è£…ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä¹‹å‰æ‰§è¡Œä¿®é¥°ç¬¦å¯¹åº”çš„äº‹ä»¶ å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  /** * @private */ export const withModifiers = (fn: Function, modifiers: string[]) =\u0026gt; { return (event: Event, ...args: unknown[]) =\u0026gt; { for (let i = 0; i \u0026lt; modifiers.length; i++) { const guard = modifierGuards[modifiers[i]] if (guard \u0026amp;\u0026amp; guard(event, modifiers)) return } return fn(event, ...args) } }     vue2.x ä¸Šçš„ä¸€äº›å…¼å®¹æŒ‰é”®ï¼š\n1 2 3 4 5 6 7 8 9 10 11  // Kept for 2.x compat. // Note: IE11 compat for `spacebar` and `del` is removed for now. const keyNames: Record\u0026lt;string, string | string[]\u0026gt; = { esc: \u0026#39;escape\u0026#39;, space: \u0026#39; \u0026#39;, up: \u0026#39;arrow-up\u0026#39;, left: \u0026#39;arrow-left\u0026#39;, right: \u0026#39;arrow-right\u0026#39;, down: \u0026#39;arrow-down\u0026#39;, delete: \u0026#39;backspace\u0026#39; }     ä»¥åŠå¯¹åº”çš„å°è£…å‡½æ•°:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  /** * @private */ export const withKeys = (fn: Function, modifiers: string[]) =\u0026gt; { return (event: KeyboardEvent) =\u0026gt; { if (!(\u0026#39;key\u0026#39; in event)) return const eventKey = hyphenate(event.key) if ( // None of the provided key modifiers match the current event key  !modifiers.some(k =\u0026gt; k === eventKey || keyNames[k] === eventKey) ) { return } return fn(event) } }      v-show å¤„ç†   è¿™é‡Œå¤„ç†ä¹Ÿå¾ˆç®€å•ï¼Œä¸€ä¸ªæ˜¯æ£€æµ‹æœ‰æ²¡ \u0026lt;transition\u0026gt; æ²¡æœ‰ç›´æ¥ä½¿ç”¨åŸç”Ÿçš„ display å± æ€§ã€‚\n feat(add): v-show Â· gcclll/stb-vue-next@be2fd29\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  // ç”Ÿå‘½å‘¨æœŸå¤„ç† export const vShow: ObjectDirective\u0026lt;VShowElement\u0026gt; = { beforeMount(el, { value }, { transition }) { // åœ¨åŠ è½½ä¹‹å‰æ£€æµ‹æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ transition åŠ¨ç”»  el._vod = el.style.display === \u0026#39;none\u0026#39; ? \u0026#39;\u0026#39; : el.style.display if (transition \u0026amp;\u0026amp; value) { transition.beforeEnter(el) } else { setDisplay(el, value) } }, mounted(el, { value }, { transition }) { if (transition \u0026amp;\u0026amp; value) { transition.enter(el) } }, updated(el, { value, oldValue }, { transition }) { if (transition \u0026amp;\u0026amp; value !== oldValue) { if (value) { transition.beforeEnter(el) setDisplay(el, true) transition.enter(el) } else { transition.leave(el, () =\u0026gt; { setDisplay(el, false) }) } } else { setDisplay(el, value) } }, beforeUnmount(el, { value }) { setDisplay(el, value) } } if (__NODE_JS__) { vShow.getSSRProps = ({ value }) =\u0026gt; { if (!value) { return { style: { display: \u0026#39;none\u0026#39; } } } } }     å®ç°éšè—å’Œæ˜¾ç¤º:\n1 2 3 4 5  // å› ä¸ºå¯èƒ½æ˜¯ block æˆ–è€… inline-block æ‰€ä»¥ç”¨ _vod æ¥è®°å½• // éšè—ä¹‹å‰çš„ display å€¼ï¼Œæ–¹ä¾¿åé¢å¤åŸ function setDisplay(el: VShowElement, value: unknown): void { el.style.display = value ? el._vod : \u0026#34;none\u0026#34;; }      v-model å¤„ç†   feat(add): v-model Â· gcclll/stb-vue-next@5597055\n å››ç§ç±»å‹ + åŠ¨æ€ç±»å‹ï¼š\n  vModelText, \u0026lt;input type=\u0026#34;text\u0026#34; /\u0026gt;, æ–‡æœ¬è¾“å…¥æ¡†\n created(), ç›‘å¬äº‹ä»¶ change(lazy?) æˆ– input\n mounted(), ä¿®æ”¹ el.value å€¼ï¼Œè®©ç»“æœä½“ç°å‡ºæ¥\n beforeUpdate(), åœ¨æ›´æ–°ä¹‹å‰å¯¹å€¼è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ï¼š trim ä¿®é¥°ç¬¦å»æ‰å‰åç©ºæ ¼\n  vModelCheckbox, \u0026lt;input type=\u0026#34;checkbox\u0026#34; checked/\u0026gt;, å¤é€‰æ¡†\n created(), ç›‘å¬ change äº‹ä»¶ï¼Œåˆå§‹å…ƒç´ å€¼\n mounted(), setChecked, æ›´æ–°å€¼ï¼Œ value å¯ä»¥æ˜¯æ•°ç»„ï¼Œé›†åˆï¼Œå•ä¸ªå€¼\n beforeUpdate(), setChecked, åŒä¸Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function setChecked( el: HTMLInputElement, { value, oldValue }: DirectiveBinding, vnode: VNode ) { // store the v-model value on the element so it can be accessed by the  // change listener.  (el as any)._modelValue = value; if (isArray(value)) { el.checked = looseIndexOf(value, vnode.props!.value) \u0026gt; -1; } else if (isSet(value)) { el.checked = value.has(vnode.props!.value); } else if (value !== oldValue) { el.checked = looseEqual(value, getCheckboxValue(el, true)); } }     æ³¨æ„è¿™é‡Œï¼Œåœ¨ compiler é˜¶æ®µï¼Œ checkbox å¯ä»¥é€šè¿‡ true-value å’Œ false-value æ¥ç»‘ å®šä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯é€‰ä¸­æ—¶ç»‘å®šçš„å˜é‡ï¼Œä¸€ä¸ªæ˜¯æœªé€‰ä¸­æ—¶ç»‘å®šçš„å˜é‡\n1 2 3 4 5 6 7 8  // retrieve raw value for true-value and false-value set via :true-value or :false-value bindings function getCheckboxValue( el: HTMLInputElement \u0026amp; { _trueValue?: any; _falseValue?: any }, checked: boolean ) { const key = checked ? \u0026#34;_trueValue\u0026#34; : \u0026#34;_falseValue\u0026#34;; return key in el ? el[key] : checked; }      vModelRadio, \u0026lt;input type=\u0026#34;radio\u0026#34;\u0026gt;, å•é€‰æ¡†\n created(), ç›‘å¬ change\n beforeUpdate(), ç”¨æ¯”è¾ƒåçš„ boolean å€¼æ›´æ–° el.checked å€¼\n  vModelSelect, \u0026lt;select\u0026gt;\u0026lt;option :value=\u0026#34;value\u0026#34;/\u0026gt;\u0026lt;/select\u0026gt;\n created(), ç›‘å¬ change äº‹ä»¶ï¼Œéå† el.options(\u0026lt;option/\u0026gt;)ï¼Œå¾—åˆ°æ‰€æœ‰ \u0026lt;option selected\u0026gt; ç»„ä»¶çš„ selected å±æ€§å€¼ï¼Œå°†å€¼èµ‹ç»™å®é™…çš„ option DOM å…ƒç´ ï¼Œ è¿™é‡Œä¼šæ£€æµ‹ el.multiple æ¥åŒºåˆ†æ˜¯å¯ä»¥å¤šé€‰è¿˜æ˜¯å•é€‰ï¼Œå•é€‰åªå–ç¬¬ä¸€ä¸ªå€¼ã€‚\n mounted(), setSelected()\n beforeUpdate(), æ›´æ–°ä¹‹å‰æ›´æ–° el._assign\n updated(), å®é™…æ›´æ–° DOM option selected å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  function setSelected(el: HTMLSelectElement, value: any) { const isMultiple = el.multiple; for (let i = 0, l = el.options.length; i \u0026lt; l; i++) { const option = el.options[i]; const optionValue = getValue(option); if (isMultiple) { if (isArray(value)) { option.selected = looseIndexOf(value, optionValue) \u0026gt; -1; } else { option.selected = value.has(optionValue); } } else { if (looseEqual(getValue(option), value)) { el.selectedIndex = i; return; } } } if (!isMultiple) { el.selectedIndex = -1; } }      vModelDynamic, æ ‡ç­¾åæ˜¯åŠ¨æ€çš„ï¼Œåªæœ‰è¿è¡ŒæœŸé—´æ‰èƒ½å†³å®šæ˜¯ä»€ä¹ˆæ ‡ç­¾\n æœ‰ï¼š \u0026lt;select\u0026gt;, \u0026lt;textarea\u0026gt;, \u0026lt;input type=\u0026#34;checkbox\u0026#34;\u0026gt;, \u0026lt;input type=\u0026#34;radio\u0026#34;\u0026gt; æœ€åé»˜è®¤ä¸º \u0026lt;input type=\u0026#34;text\u0026#34;\u0026gt;\n æœ€åæ ¹æ®å…·ä½“æƒ…å†µå»ä½¿ç”¨ 1~4 ä¸­å¯¹åº”ç±»å‹æŒ‡ä»¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  export const vModelDynamic: ObjectDirective\u0026lt; HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement \u0026gt; = { created(el, binding, vnode) { callModelHook(el, binding, vnode, null, \u0026#34;created\u0026#34;); }, mounted(el, binding, vnode) { callModelHook(el, binding, vnode, null, \u0026#34;mounted\u0026#34;); }, beforeUpdate(el, binding, vnode, prevVNode) { callModelHook(el, binding, vnode, prevVNode, \u0026#34;beforeUpdate\u0026#34;); }, updated(el, binding, vnode, prevVNode) { callModelHook(el, binding, vnode, prevVNode, \u0026#34;updated\u0026#34;); }, };     åŠ¨æ€å†³å®šç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  function callModelHook( el: HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement, binding: DirectiveBinding, vnode: VNode, prevVNode: VNode | null, hook: keyof ObjectDirective ) { let modelToUse: ObjectDirective; switch (el.tagName) { case \u0026#34;SELECT\u0026#34;: modelToUse = vModelSelect; break; case \u0026#34;TEXTAREA\u0026#34;: modelToUse = vModelText; break; default: switch (vnode.props \u0026amp;\u0026amp; vnode.props.type) { case \u0026#34;checkbox\u0026#34;: modelToUse = vModelCheckbox; break; case \u0026#34;radio\u0026#34;: modelToUse = vModelRadio; break; default: modelToUse = vModelText; } } const fn = modelToUse[hook] as DirectiveHook; fn \u0026amp;\u0026amp; fn(el, binding, vnode, prevVNode); }        useCssVars   vue SFC æ–‡ä»¶ä¸­çš„ \u0026lt;style\u0026gt; ä¸­çš„ v-bind(varName) å¤„ç†ã€‚\n feat(add): use css vars Â· gcclll/stb-vue-next@06b2291\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  /** * Runtime helper for SFC\u0026#39;s CSS variable injection feature. * vue æ–‡ä»¶ä¸­çš„æ ·å¼ï¼ŒCSSå˜é‡æ³¨å…¥ç‰¹æ€§ï¼Œ color: v-bind(fontColor) * @private */ export function useCssVars(getter: (ctx: any) =\u0026gt; Record\u0026lt;string, string\u0026gt;) { if (!__BROWSER__ \u0026amp;\u0026amp; !__TEST__) return const instance = getCurrentInstance() if (!instance) { __DEV__ \u0026amp;\u0026amp; warn(`useCssVars is called without current active component instance.`) return } const setVars = () =\u0026gt; setVarsOnVNode(instance.subTree, getter(instance.proxy!)) onMounted(() =\u0026gt; watchEffect(setVars, { flush: \u0026#39;post\u0026#39; })) onUpdated(setVars) }     ç»™ vnode.el.style è®¾ç½®è‡ªå®šä¹‰å±æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  function setVarsOnVNode(vnode: VNode, vars: Record\u0026lt;string, string\u0026gt;) { if (__FEATURE_SUSPENSE__ \u0026amp;\u0026amp; vnode.shapeFlag \u0026amp; ShapeFlags.SUSPENSE) { const suspense = vnode.suspense! vnode = suspense.activeBranch! if (suspense.pendingBranch \u0026amp;\u0026amp; !suspense.isHydrating) { // åœ¨ runtime-dom ä¸­åˆ†æè¿‡ effects ä¼šç­‰åˆ°  // å¼‚æ­¥è¯·æ±‚å®Œæˆä¹‹åå¹¶ä¸”æ˜¯åœ¨ parent.effects æ²¡æœ‰ä»»åŠ¡çš„æƒ…å†µä¸‹æ‰ä¼š  // æ‰§è¡Œï¼Œè¿™é‡Œå°† CSS çš„å¤„ç†åŠ å…¥åˆ°ç»„ä»¶ effect é˜Ÿåˆ—ç­‰å¾…æ‰€ä»¥  // å¼‚æ­¥ç»“æŸå†å¤„ç†æ ·å¼  suspense.effects.push(() =\u0026gt; { setVarsOnVNode(suspense.activeBranch!, vars) }) } } // drill down HOCs until it\u0026#39;s a non-component vnode  // æ‰¾åˆ°æœ€å†…å±‚çš„éç»„ä»¶çš„å­æ ‘èŠ‚ç‚¹  while (vnode.component) { vnode = vnode.component.subTree } if (vnode.shapeFlag \u0026amp; ShapeFlags.ELEMENT \u0026amp;\u0026amp; vnode.el) { const style = vnode.el.style for (const key in vars) { style.setProperty(`--${key}`, vars[key]) } } else if (vnode.type === Fragment) { // å¦‚æœæ˜¯ä¸ªå ä½ fragment ç›´æ¥ç»™ children è®¾ç½®  ;(vnode.children as VNode[]).forEach(c =\u0026gt; setVarsOnVNode(c, vars)) } }      useCssModule   feat(add): use css module Â· gcclll/stb-vue-next@2d47ce0\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  export function useCssModule(name = \u0026#34;$style\u0026#34;): Record\u0026lt;string, string\u0026gt; { /* istanbul ignore else */ if (!__GLOBAL__) { const instance = getCurrentInstance()!; if (!instance) { __DEV__ \u0026amp;\u0026amp; warn(`useCssModule must be called inside setup()`); return EMPTY_OBJ; } const modules = instance.type.__cssModules; if (!modules) { __DEV__ \u0026amp;\u0026amp; warn(`Current instance does not have CSS modules injected.`); return EMPTY_OBJ; } const mod = modules[name]; if (!mod) { __DEV__ \u0026amp;\u0026amp; warn(`Current instance does not have CSS module named \u0026#34;${name}\u0026#34;.`); return EMPTY_OBJ; } return mod as Record\u0026lt;string, string\u0026gt;; } else { if (__DEV__) { warn(`useCssModule() is not supported in the global build.`); } return EMPTY_OBJ; } }      ","permalink":"https://www.cheng92.com/vue/vue-mind-map-runtime-dom/","tags":["vue,","vue3,","runtime-dom,","patch"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 8 â˜ runtime-dom"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");     æœ¬ç³»åˆ—ä¸º vue-next æºç åˆ†æç³»åˆ—çš„æ—ç³»åˆ†æ”¯ï¼Œä¸»è¦ç›®çš„åœ¨äºå¯¹ vue3 æºç ä¸­çš„ä¸€äº›ç»†èŠ‚è¿› è¡Œåˆ†æã€‚æ¯”å¦‚ï¼š PatchFlags, ShapeFlags, ç­‰ç­‰\n PatchFlags.BAIL   ä½¿ç”¨ï¼š\n1 2 3 4 5 6  // renderer \u0026gt; patch() // transition ç»„ä»¶ä¸­æ ‡è®°ä¸º BAIL ç±»å‹ï¼Œéœ€è¦è¿›è¡Œ full-diff if (n2.patchFlag === PatchFlags.BAIL) { optimized = false; n2.dynamicChildren = null; }     è®¾å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  // components\u0026gt;BaseTranstion.ts \u0026gt; getTransitionRawChildren() // #1126 if a transition children list contains multiple sub fragments, these // fragments will be merged into a flat children array. Since each v-for // fragment may contain different static bindings inside, we need to de-op // these children to force full diffs to ensure correct behavior. if (keyedFragmentCount \u0026gt; 1) { for (let i = 0; i \u0026lt; ret.length; i++) { ret[i].patchFlag = PatchFlags.BAIL; } } // components\u0026gt;TransitionGroup.ts \u0026gt; .... // TODO       ","permalink":"https://www.cheng92.com/vue/vue-teardown-1-patch-flags/","tags":["vue3,","vue-next,","PatchFlags"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘  PatchFlags"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");     æœ¬ç³»åˆ—ä¸º vue-next æºç åˆ†æç³»åˆ—çš„æ—ç³»åˆ†æ”¯ï¼Œä¸»è¦ç›®çš„åœ¨äºå¯¹ vue3 æºç ä¸­çš„ä¸€äº›ç»†èŠ‚è¿› è¡Œåˆ†æã€‚æœ¬æ–‡è®²è¿°çš„æ˜¯ vue3 ä¸­çš„ä¸€äº›ä»»åŠ¡è°ƒåº¦ï¼Œä¸»è¦é›†ä¸­å†…å®¹åœ¨ä»»åŠ¡ç±»åˆ«å’Œè°ƒåº¦é¡ºåºé—®é¢˜ã€‚\n  è¯¥é“¾æ¥æ˜¯ vue3 scheduler çš„æºç åˆ†æï¼š\n Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1) - è‹¥å¶çŸ¥ç§‹ - scheduler ä»»åŠ¡è°ƒåº¦æœºåˆ¶\n è€Œæœ¬æ–‡ä¸»è¦é›†ä¸­ç‚¹åœ¨äº vue3 ä¸­å“ªé‡Œä½¿ç”¨åˆ°äº†è¿™ä¸ªæœºåˆ¶ï¼Œæ‰§è¡Œé¡ºåºåˆæ˜¯æ€ä¹ˆæ ·çš„â“â“â“\nscheduler Apis å›é¡¾   è¿™èŠ‚æ˜¯é’ˆå¯¹ vue3 é‡Œ scheduler api çš„ä¸€äº›å›é¡¾ï¼Œæ›´è¯¦ç»†çš„æºç åˆ†ææŸ¥çœ‹ä¸Šé¢çš„é“¾æ¥ã€‚\n  ä¸‹é¢åˆ—å‡º scheduler.ts è¿™ä¸ªæ–‡ä»¶ç›¸å…³çš„ APIï¼Œåé¢ä¼šæ ¹æ®è¿™äº› api å»æŸ¥æ‰¾å“ªé‡Œç”¨åˆ°è¿™ä¸ª æœºåˆ¶(ä¹‹å‰æºç é˜…è¯»åˆ†æè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰ç‰¹åˆ«å…³æ³¨ï¼Œå› æ­¤ä¹Ÿå¾ˆéš¾å›æƒ³å…·ä½“å“ªäº›åœ°æ–¹æœ‰ç”¨åˆ°ï¼Œ æ‰€ä»¥é€šè¿‡æœç´¢æ›´ç›´æ¥ç‚¹)\n   name brief     nextTick(fn?) ä¸‹ä¸€ä¸ªæ—¶é’Ÿæ‰§è¡Œ fn ååé¢çš„ä»£ç    queueJob(job: SchedulerJob) job å…¥åˆ—   queueFlush() flush æ‰€æœ‰ Jobs   flushJobs(seen?: CountMap) queueFlush ä¸­è°ƒç”¨   queuePreFlushCb(cb: SchedulerCb) pre ç±»å‹çš„ä»»åŠ¡   flushPreFlushCbs(seen, parentJob) flush pre ç±»å‹ä»»åŠ¡   queuePostFlushCb(cb: SchedulerCbs) post ç±»å‹çš„ä»»åŠ¡   flushPostFlushCbs(seen?: CountMap) flush post ç±»å‹ä»»åŠ¡     ä»è¡¨ä¸­å¯çŸ¥è¿™é‡Œæœ‰ä¸‰ç§ç±»å‹çš„ä»»åŠ¡ job | pre | post ã€‚\n æœ¬æ–‡ä¹Ÿå°†æ˜¯å›´ç»•è¿™ä¸‰ç§ç±»å‹å»åˆ†æï¼Œäº†è§£å…·ä½“å“ªäº›æ“ä½œå±äºä¸Šé¢ä¸‰ç§ç±»å‹(æ¯”å¦‚ï¼šç»„ä»¶æ¸² æŸ“ï¼Œæ›´æ–°ï¼Œåˆ é™¤ç­‰å¾…)ã€‚\n ç®€å•å›é¡¾æ¯ä¸ª api åŠŸèƒ½:\n  queueJob ä»»åŠ¡å…¥åˆ—ä¹‹åä¼šç«‹å³è°ƒç”¨ queueFlush å» flush jobs\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  export function queueJob(job: SchedulerJob) { // the dedupe search uses the startIndex argument of Array.includes()  // by default the search index includes the current job that is being run  // so it cannot recursively trigger itself again.  // if the job is a watch() callback, the search will start with a +1 index to  // allow it recursively trigger itself - it is the user\u0026#39;s responsibility to  // ensure it doesn\u0026#39;t end up in an infinite loop.  if ( (!queue.length || !queue.includes( job, isFlushing \u0026amp;\u0026amp; job.allowRecurse ? flushIndex + 1 : flushIndex )) \u0026amp;\u0026amp; job !== currentPreFlushParentJob ) { queue.push(job); queueFlush(); } } function queueFlush() { if (!isFlushing \u0026amp;\u0026amp; !isFlushPending) { isFlushPending = true; currentFlushPromise = resolvedPromise.then(flushJobs); } }      queuePreFlushCb é’ˆå¯¹ pre cbï¼Œè°ƒç”¨ queueCb å»å…¥åˆ—åŒæ—¶ç«‹å³ queueFlush\n1 2 3  export function queuePreFlushCb(cb: SchedulerCb) { queueCb(cb, activePreFlushCbs, pendingPreFlushCbs, preFlushIndex); }     ç›¸å…³çš„å…¨å±€å˜é‡:\n1 2 3 4 5 6 7 8 9  // è¿˜æœªè¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¦‚æœå½“å‰ tick æ­£åœ¨ flush pre cbs çš„æ—¶å€™ // æœ‰æ–°çš„ä»»åŠ¡è¿›æ¥ï¼Œä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªæ•°ç»„ä¸­ const pendingPreFlushCbs: SchedulerCb[] = []; // æ­£åœ¨è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ­¤æ—¶å¦‚æœ pendingPreFlushCbs ä¸­æœ‰æ–°çš„ä»»åŠ¡è¿›æ¥çš„ // æ—¶å€™ï¼Œä¼šè¢«åˆå¹¶åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­è¢«ç»§ç»­æ‰§è¡Œï¼Œå› ä¸º flushPreFlushCbs() å‡½æ•°å®ç° // æœ€åæ˜¯é€’å½’è°ƒç”¨è‡ªèº«ï¼Œè€Œé€’å½’ç»“æŸçš„æ¡ä»¶å°±æ˜¯ pendingPreFlushCbs.length let activePreFlushCbs: SchedulerCb[] | null = null; // flush è¿‡ç¨‹ä¸­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ç´¢å¼• let preFlushIndex = 0;     æ‰€ä»¥ pre cbs åœ¨åŒä¸€ä¸ª tick ä¸‹å¦‚æœæœ‰æ–°çš„ä»»åŠ¡ä¼šåœ¨æ­£åœ¨è¢«æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œæˆä¹‹ åç«‹å³è¢«æ‰§è¡Œã€‚\n  queuePostFlushCb é’ˆå¯¹ post cbï¼Œè°ƒç”¨ queueCb å»å…¥åˆ—åŒæ—¶ç«‹å³æ‰§è¡Œ queueFlush\n  æœ€åæ˜¯ flushCbs å†³å®šäº†ä¸‰ç§ç±»å‹ä»»åŠ¡æ‰§è¡Œä¼˜å…ˆçº§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  function flushJobs(seen?: CountMap) { // ...  // pre cbs å…ˆæ‰§è¡Œ  flushPreFlushCbs(seen); // jobs åæ‰§è¡Œ  try { for (flushIndex = 0; flushIndex \u0026lt; queue.length; flushIndex++) { const job = queue[flushIndex]; if (job) { if (__DEV__) { checkRecursiveUpdates(seen!, job); } callWithErrorHandling(job, null, ErrorCodes.SCHEDULER); } } } finally { // æœ€åå†æ‰§è¡Œ post cbs  flushPostFlushCbs(seen); // è¿™é‡Œæ˜¯ä¸ºäº†ä¿è¯ post cbs å’Œ jobs å…¨éƒ¨æ‰§è¡Œï¼Œå› ä¸º post cbs  // å¹¶æ²¡æœ‰å‘ pre cbs é‚£æ ·é€’å½’è°ƒç”¨è‡ªå·±ï¼Œè€Œåªæ˜¯ä¸ºäº†é˜²æ­¢åµŒå¥—ä½¿ç”¨å¢åŠ   // äº†ä¸ªå¤„ç†æœºåˆ¶ï¼Œå°†æ–°æ¥çš„ pending post cbs åŠ å…¥é˜Ÿåˆ—åç»§ç»­æ‰§è¡Œ  // è€Œè¿™é‡Œçš„æ£€æµ‹æ˜¯ä¸ºäº†åœ¨å‰ä¸€æ¬¡è°ƒç”¨ flushPostFlushCbs å®Œå…¨ç»“æŸä¹‹å  // å†æ¬¡è°ƒç”¨äº† queuePostFlushCb è¿›è¡Œäº†å…¥åˆ—æ“ä½œçš„ä¸€æ¬¡æ¸…ç†æ“ä½œ  if (queue.length || pendingPostFlushCbs.length) { flushJobs(seen); } } }       è¿™é‡Œå€ŸåŠ© pre cbs åšä¸ªç®€å•çš„ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  let pendingPreFlushCbs = []; let activePreFlushCbs = null; let preFlushIndex = 0; let isFlushing = false let resolvedPromise = Promise.resolve() function queuePreFlushCb(cb) { // cb æ²¡æœ‰æ­£åœ¨æ‰§è¡Œæ‰è¿›å…¥ç­‰å¾…é˜Ÿåˆ—  if (!activePreFlushCbs || !activePreFlushCbs.includes(cb)) pendingPreFlushCbs.push(cb); // ç«‹å³åˆ·æ–°é˜Ÿåˆ—  if (!isFlushing) { // è¿™é‡Œéœ€è¦å¼‚æ­¥æ‰§è¡Œï¼Œè®©æ‰€æœ‰ä»»åŠ¡åœ¨åŒä¸€ä¸ª tick é‡Œé¢æ‰§è¡Œ  // ä¸ç„¶è¿›æ¥ä¸€ä¸ªå°±ä¼šç«‹å³æ‰§è¡Œ  resolvedPromise.then(flushPreFlushCbs) } } function flushPreFlushCbs() { isFlushing = true // ä¸€å¼€å§‹å…¥åˆ—çš„æ˜¯ pending æ‰€ä»¥æœ€å¼€å§‹è¿™é‡Œåº”è¯¥æ˜¯æœ‰ä»»åŠ¡çš„  if (pendingPreFlushCbs.length) { // ä¸ºäº†å»é‡ä½¿ç”¨é›†åˆï¼Œå¾—åˆ°ä¸‹é¢å°†æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—  activePreFlushCbs = [...new Set(pendingPreFlushCbs)]; // è¿™é‡Œæƒ…å†µç­‰å¾…é˜Ÿåˆ—ï¼Œå‡†å¤‡æ¥å—æ–°çš„ä»»åŠ¡  pendingPreFlushCbs.length = 0; for ( preFlushIndex = 0; preFlushIndex \u0026lt; activePreFlushCbs.length; preFlushIndex++ ) { // å¼€å§‹æ‰§è¡Œä»»åŠ¡  activePreFlushCbs[preFlushIndex](); } // æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ¸…ç†æ•°æ®  activePreFlushCbs = null; preFlushIndex = 0; // é€’å½’çŸ¥é“æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ  flushPreFlushCbs(); } } const cb1 = () =\u0026gt; console.log(\u0026#34;\\ncb 1\u0026#34;); const cb2 = () =\u0026gt; { console.log(\u0026#34;cb 2\u0026#34;) // è¿™é‡Œåœ¨æ‰§è¡Œä»»åŠ¡æœŸé—´ï¼Œæ’å…¥æ–°çš„ä»»åŠ¡ cb2.1 çœ‹å®ƒä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¢«æ‰§è¡Œ  queuePreFlushCb(() =\u0026gt; console.log(\u0026#39;cb 2.1\u0026#39;)) }; const cb3 = () =\u0026gt; { // åŒç†ï¼Œåªä¸è¿‡è¿™é‡Œæ”¾åœ¨æ‰“å°ä¹‹å‰  queuePreFlushCb(() =\u0026gt; console.log(\u0026#39;cb 3.1\u0026#39;)) console.log(\u0026#34;cb 3\u0026#34;) }; const cb4 = () =\u0026gt; console.log(\u0026#34;cb 4\u0026#34;); console.log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; ç»“æœ\u0026#34;); [cb1, cb2, cb3, cb4].forEach((cb) =\u0026gt; queuePreFlushCb(cb));    \u0026gt;\u0026gt;\u0026gt; ç»“æœ undefined cb 1 cb 2 cb 3 cb 4 cb 2.1 cb 3.1   ç»“æœå¦‚ä¸Šï¼Œ cb1 -\u0026gt; cb2 -\u0026gt; cb3 -\u0026gt; cb4 æŒ‰ç…§æ·»åŠ çš„é¡ºåºæ‰§è¡Œäº†ï¼Œç„¶å cb2.1 å’Œ cb3.1 å‡ åœ¨ 1234 åé¢æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸º for å¾ªç¯çš„ç¼˜æ•…ï¼ŒåŠ¨æ€å–äº† activePreFlushCbs.length è€Œè¿™ä¸ª activePreFlushCbs åœ¨å¾ªç¯æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰©å……äº†ï¼Œæ‰€ä»¥ä¼šç»§ç»­æ‰§è¡Œç›´åˆ°æœ€åä¸€ä¸ª å…ƒç´ ã€‚\n é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° pre cbs ä¼šåœ¨åŒä¸€ä¸ª tick ä¸‹å…ˆæ‰§è¡Œå·²å­˜åœ¨çš„ä»»åŠ¡ï¼Œå½“è¿™äº›ä»» åŠ¡(å³ for å¾ªç¯)è¿˜æ²¡ç»“æŸæ‰§è¡Œåˆæœ‰äº†æ–°çš„ä»»åŠ¡å…¥åˆ—ï¼Œåˆ™ä¼šéšåç«‹å³æ‰§è¡Œã€‚\n è€Œå¯¹äº post cbs åˆ™æœ‰ç‚¹åŒºåˆ«ï¼š\n  å¹¶æ²¡æœ‰é€’å½’ flush\n  åœ¨ä»»åŠ¡åµŒå¥—çš„æ—¶å€™ä¹Ÿå’Œ pre cbs æœ‰ç‚¹ç±»ä¼¼ï¼Œä¼šå°†è¿™äº›åµŒå¥—çš„ä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ—åé¢ç»§ç»­æ‰§è¡Œ\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  let pendingPostFlushCbs = []; let activePostFlushCbs = null; let postFlushIndex = 0; let isFlushing = false; let resolvedPromise = Promise.resolve(); // å…¥åˆ—ï¼Œè¿™ä¸ªè·Ÿ queuePreFlushCb ä¸€æ · function queuePostFlushCb(cb) { if (!activePostFlushCbs || !activePostFlushCbs.includes(cb)) { pendingPostFlushCbs.push(cb); } if (!isFlushing) { resolvedPromise.then(flushPostFlushCbs); } } // å‡ºåˆ— function flushPostFlushCbs() { isFlushing = true; if (pendingPostFlushCbs.length) { const deduped = [...new Set(pendingPostFlushCbs)]; pendingPostFlushCbs.length = 0; if (activePostFlushCbs) { // è¡¨ç¤ºæœ‰ post cbs æ­£åœ¨æ‰§è¡Œäº†ï¼Œæœ‰åµŒå¥—è°ƒç”¨ï¼Œå³ä¹‹å‰è°ƒç”¨ flushPostFlushCbs  // è¿˜æ²¡ç»“æŸï¼Œé‚£ä¹ˆè¿™é‡Œåªéœ€è¦æ‰©å…… activePostFlushCbs é˜Ÿåˆ—å°±è¡Œäº†  activePostFlushCbs.push(...deduped); return; } // é¦–æ¬¡è°ƒç”¨ flushPostFlushCbs æˆ–è€…å‰ä¸€æ¬¡è°ƒç”¨å·²ç»ç»“æŸäº†  activePostFlushCbs = deduped; // æ ¹æ® job.id å‡åºå…ˆå°†ä»»åŠ¡æ’åº  // activePostFlushCbs.sort((a, b) =\u0026gt; getId(a) - getId(b))  for ( postFlushIndex = 0; postFlushIndex \u0026lt; activePostFlushCbs.length; postFlushIndex++ ) { activePostFlushCbs[postFlushIndex](); } activePostFlushCbs = null; postFlushIndex = 0; } } function getId(job) { return job.id == null ? Infinity : job.id; } // æµ‹è¯•: const cb1 = () =\u0026gt; console.log(\u0026#34;\\ncb 1\u0026#34;); const cb2 = () =\u0026gt; { console.log(\u0026#34;cb 2\u0026#34;); queuePostFlushCb(() =\u0026gt; console.log(\u0026#34;cb 2.1\u0026#34;)); }; const cb3 = () =\u0026gt; { queuePostFlushCb(() =\u0026gt; console.log(\u0026#34;cb 3.1\u0026#34;)); console.log(\u0026#34;cb 3\u0026#34;); }; const cb4 = () =\u0026gt; console.log(\u0026#34;cb 4\u0026#34;); console.log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; ç»“æœï¼š\u0026#34;); [cb1, cb2, cb3, cb4].forEach((cb) =\u0026gt; queuePostFlushCb(cb));    \u0026gt;\u0026gt;\u0026gt; ç»“æœï¼š undefined cb 1 cb 2 cb 3 cb 4 cb 2.1 cb 3.1   ç»“æœå’Œ pre cb å®ç°ä¹Ÿä¸€æ ·ï¼Œè€Œè¿™é‡Œåœ¨ vue3 å®ç°ä¸­ post cb æœ‰æ ¹æ® job.id è¿›è¡Œå‡åº æ’åºï¼Œå³ job.id å°çš„ä¼šå…ˆæ‰§è¡Œï¼Œé‚£è¿™ä¸ª job id åˆæ˜¯ä¸ªæ€ä¹ˆå¤§å°æœºåˆ¶çš„ï¼Ÿï¼Ÿï¼Ÿ\n pre, post, job å°ç»“ï¼š\n   ç±»å‹ ä¼˜å…ˆçº§ æ˜¯å¦æ’åº flush æœºåˆ¶     pre 1 ä¸æ’åºï¼ŒæŒ‰ç…§åŠ å…¥é¡ºåº è‡ªåŠ¨è§¦å‘ flush, é€’å½’è‡ªèº«ç›´åˆ°æ‰€æœ‰ä»»åŠ¡ç»“æŸï¼Œåœ¨ä»»åŠ¡æœªå®Œå…¨ç»“æŸä¹‹å‰ä¸ä¼šé‡å¤è°ƒç”¨ flush   post 2 æŒ‰ç…§ job.id æ’åº è‡ªåŠ¨è§¦å‘ flush, ä¸ä¼šé€’å½’ï¼Œä½†æ”¯æŒåµŒå¥—è°ƒç”¨æ¥æ‰©å±•æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—   job 3 æŒ‰ç…§ job.id æ’åº è‡ªåŠ¨è§¦å‘ flushï¼Œä¸ä¼šé€’å½’ï¼Œflush è¿‡ç¨‹ä¸­æ¥å—æ–° job      queueJob(job)    å¦‚ä¸Šå›¾æœç´¢ç»“æœï¼Œä½¿ç”¨ç‚¹ï¼š\n  runtime-core/src/componentPublicInstance.ts æ–‡ä»¶ä¸­å¼ºåˆ¶æ›´æ–° api é‡Œé¢ä½¿ç”¨\n $forceUpdate: i =\u0026gt; () =\u0026gt; queueJob(i.update)\n  runtime-core/src/hmr.ts ä¸­è°ƒç”¨\n queueJob(instance.parent.update)\n å°†å®ä¾‹çˆ¶ç»„ä»¶çš„æ›´æ–°åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—ï¼Œçƒ­æ›´æ–°åŠŸèƒ½ï¼Œå‘ç”Ÿåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå½“é‡æ–°åŠ è½½çš„æ—¶ å€™å¼ºåˆ¶å»æ›´æ–°çˆ¶ç»„ä»¶ã€‚\n    queuePreFlushCb(cb)    runtime-core/src/apiWatch.ts çš„ doWatch() ä¸­è°ƒç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  function doWatch( source: WatchSource | WatchSource[] | WatchEffect | object, cb: WatchCallback | null, { immediate, deep, flush, onTrack, onTrigger }: WatchOptions = EMPTY_OBJ, instance = currentInstance ): WatchStopHandle { // ...  // default: \u0026#39;pre\u0026#39;  scheduler = () =\u0026gt; { if (!instance || instance.isMounted) { queuePreFlushCb(job); } else { // with \u0026#39;pre\u0026#39; option, the first call must happen before  // the component is mounted so it is called synchronously.  job(); } }; // ... }     æ²¡æœ‰å®ä¾‹æˆ–ç»„ä»¶å®ä¾‹è¿˜æ²¡å®Œå…¨åŠ è½½å®Œçš„æ—¶å€™å°† job æ”¾å…¥é˜Ÿåˆ—å»æ‰§è¡Œï¼Œè¿™é‡Œçš„å«ä¹‰å°±å¦‚æºç  çš„æ³¨é‡Šï¼Œ watch çš„ job é¦–æ¬¡æ‰§è¡Œå¿…é¡»å‘ç”Ÿåœ¨å®ä¾‹å·²åˆ›å»ºå®Œæˆç»„ä»¶æœªå®Œæˆæ¸²æŸ“ä¹‹å‰ã€‚\n  queuePostFlushCb(cb)     runtime-core/src/hmr.ts ä¸­ unmark ç»„ä»¶\n  Suspense ç»„ä»¶ä¸­ä½¿ç”¨   runtime-core/src/components/Suspense.ts ä¸­ Suspense ç»„ä»¶ä½¿ç”¨\n ç»„ä»¶æ¨¡æ¿çš„ resolve æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  const suspense: SuspenseBoundary = { resolve(resume = false) { // ...  // flush buffered effects  // check if there is a pending parent suspense  let parent = suspense.parent; let hasUnresolvedAncestor = false; while (parent) { if (parent.pendingBranch) { // found a pending parent suspense, merge buffered post jobs  // into that parent  parent.effects.push(...effects); hasUnresolvedAncestor = true; break; } parent = parent.parent; } // no pending parent suspense, flush all jobs  if (!hasUnresolvedAncestor) { queuePostFlushCb(effects); } suspense.effects = []; // ...  }, };     æ³¨æ„ä»£ç ä¸­è°ƒç”¨çš„å‰ææ˜¯ hasUnresolvedAncestor å³ä¸å­˜åœ¨ç¥–å…ˆç»„ä»¶ä¸­è¿˜æœ‰æœªå®Œæˆçš„ åˆ†æ”¯(parent.pendingBranch)ï¼Œéšåæ‰ä¼šå°†å½“å‰çš„ Suspense çš„ç»„ä»¶çš„ effects æ¨å…¥ post cbs é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œã€‚\n ç¬¬äºŒä¸ªä½¿ç”¨çš„åœ°æ–¹(å°è£…äº†ä¸€ä¸ª Suspense ç»„ä»¶çš„ effects å…¥åˆ—å‡½æ•°)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  export function queueEffectWithSuspense( fn: Function | Function[], suspense: SuspenseBoundary | null ): void { if (suspense \u0026amp;\u0026amp; suspense.pendingBranch) { if (isArray(fn)) { suspense.effects.push(...fn); } else { suspense.effects.push(fn); } } else { queuePostFlushCb(fn); } }     è¿™ä¸ªå‡½æ•°ä½œç”¨æ˜¯å¯ä»¥æ‰‹åŠ¨ç»™ä¸€ä¸ª Suspense ç»„ä»¶å¢åŠ ä¸€ä¸ª effect ï¼Œå°è£…ä¹‹åçš„å‡½æ•°ä½¿ç”¨è½¨ è¿¹ã€‚\n  renderer.ts -\u0026gt; queuePostRenderEffect:\n1 2 3  export const queuePostRenderEffect = __FEATURE_SUSPENSE__ ? queueEffectWithSuspense : queuePostFlushCb;     hydratation.ts ä¸­æ‰§è¡Œ onVnodeMounted é’©å­å‡½æ•°çš„ hooks:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const hydrateElement = ( el: Element, vnode: VNode, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, optimized: boolean ) =\u0026gt; { if (patchFlag !== PatchFlags.HOISTED) { // ...  if ((vnodeHooks = props \u0026amp;\u0026amp; props.onVnodeMounted) || dirs) { queueEffectWithSuspense(() =\u0026gt; { vnodeHooks \u0026amp;\u0026amp; invokeVNodeHook(vnodeHooks, parentComponent, vnode); dirs \u0026amp;\u0026amp; invokeDirectiveHook(vnode, null, parentComponent, \u0026#34;mounted\u0026#34;); }, parentSuspense); } // ...  } return el.nextSibling; };      queuePostRenderEffect() ä½¿ç”¨è½¨è¿¹   è¿™ä¸ªå‡½æ•°æ€»ç»“æ¥è¯´æœ‰ä¸‰ä¸ªåœ°æ–¹ä½¿ç”¨åˆ°ï¼š\n  ç»„ä»¶çš„ ref å±æ€§å€¼å˜æ›´æ—¶çš„å›è°ƒæ‰§è¡Œ\n  ç»„ä»¶çš„å„ä¸ªå‘¨æœŸå‡½æ•°()çš„ hooks æ‰§è¡Œ\n  watch å‡½æ•°ä¸­çš„é€‰é¡¹å¦‚æœæŒ‡å®šä¸º flush: post æ—¶ï¼Œå½“åš post cb æ‰§è¡Œ\n  renderer.ts:  1 2 3  export const queuePostRenderEffect = __FEATURE_SUSPENSE__ ? queueEffectWithSuspense : queuePostFlushCb;       setRef() ä¸­\n è®¾ç½®ç»„ä»¶ ref å±æ€§ï¼ŒæŒ‡å‘æœ€ç»ˆæ¸²æŸ“ä¹‹åDOM æ ‘ä¸­çš„ DOM å…ƒç´ å¼•ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  export const setRef = ( rawRef: VNodeNormalizedRef, oldRawRef: VNodeNormalizedRef | null, parentSuspense: SuspenseBoundary | null, vnode: VNode | null ) =\u0026gt; { // ...  if (isString(ref)) { const doSet = () =\u0026gt; { refs[ref] = value; if (hasOwn(setupState, ref)) { setupState[ref] = value; } }; // #1789: for non-null values, set them after render  // null values means this is unmount and it should not overwrite another  // ref with the same key  if (value) { (doSet as SchedulerCb).id = -1; queuePostRenderEffect(doSet, parentSuspense); } else { doSet(); } } else if (isRef(ref)) { const doSet = () =\u0026gt; { ref.value = value; }; if (value) { (doSet as SchedulerCb).id = -1; queuePostRenderEffect(doSet, parentSuspense); } else { doSet(); } } // ... };     ä¸Šé¢ä¸¤æ¬¡è°ƒç”¨é’ˆå¯¹çš„æ˜¯ä¸¤ç§ç±»å‹ï¼Œå®é™…ä½œç”¨éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç­‰ç»„ä»¶æ¸²æŸ“å®Œæˆä¹‹åå»æ‰§è¡Œï¼š\n1 2 3  (doSet as SchedulerCb).id = -1; // è¿™é‡Œ id è®¾ç½®ä¸º -1 è¡¨æ˜æ‰§è¡Œä¼˜å…ˆçº§æœ€é«˜ // å› ä¸º post å’Œ job ç±»å‹éƒ½æœ‰æ ¹æ® job.id è¿›è¡Œæ’åºï¼Œåœ¨æ‰§è¡Œæ‰€æœ‰ cbs/jobs ä¹‹å‰ queuePostRenderEffect(doSet, parentSuspense);      mountElement() ä¸­\n é¦–æ¬¡åŠ è½½å…ƒç´ æ—¶è°ƒç”¨çš„å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const mountElement = ( vnode: VNode, container: RendererElement, anchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { // ...  hostInsert(el, container, anchor); if ( (vnodeHook = props \u0026amp;\u0026amp; props.onVnodeMounted) || needCallTransitionHooks || dirs ) { queuePostRenderEffect(() =\u0026gt; { vnodeHook \u0026amp;\u0026amp; invokeVNodeHook(vnodeHook, parentComponent, vnode); needCallTransitionHooks \u0026amp;\u0026amp; transition!.enter(el); dirs \u0026amp;\u0026amp; invokeDirectiveHook(vnode, null, parentComponent, \u0026#34;mounted\u0026#34;); }, parentSuspense); } };     æ¸²æŸ“ç»„ä»¶çš„æ—¶å€™ï¼Œ onVnodeMounted hooks æ‰§è¡Œé˜Ÿåˆ—ã€‚\n  patchElement() ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const patchElement = ( n1: VNode, n2: VNode, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { // ...  if ((vnodeHook = newProps.onVnodeUpdated) || dirs) { queuePostRenderEffect(() =\u0026gt; { vnodeHook \u0026amp;\u0026amp; invokeVNodeHook(vnodeHook, parentComponent, n2, n1); dirs \u0026amp;\u0026amp; invokeDirectiveHook(n2, n1, parentComponent, \u0026#34;updated\u0026#34;); }, parentSuspense); } };     onVnodeUpdated hooks æ‰§è¡Œé˜Ÿåˆ—ã€‚\n  setupRenderEffect() å‡½æ•°ä¸­\n å½“ç»„ä»¶çŠ¶æ€æ›´æ–°æ—¶ä¼šè°ƒç”¨ instance.update ï¼Œè¿™é‡Œæ˜¯æ‰§è¡Œ setup() ä¹‹åçš„ä¸€ä¸ªç»„ä»¶æ›´æ–° å‡½æ•°çš„ä¸€ä¸ªå°è£…å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  const setupRenderEffect: SetupRenderEffectFn = ( instance, initialVNode, container, anchor, parentSuspense, isSVG, optimized ) =\u0026gt; { // create reactive effect for rendering  instance.update = effect( function componentEffect() { if (!instance.isMounted) { // ...  // mounted hook  if (m) { queuePostRenderEffect(m, parentSuspense); } // onVnodeMounted  if ((vnodeHook = props \u0026amp;\u0026amp; props.onVnodeMounted)) { const scopedInitialVNode = initialVNode; queuePostRenderEffect(() =\u0026gt; { invokeVNodeHook(vnodeHook!, parent, scopedInitialVNode); }, parentSuspense); } // activated hook for keep-alive roots.  // #1742 activated hook must be accessed after first render  // since the hook may be injected by a child keep-alive  const { a } = instance; if ( a \u0026amp;\u0026amp; initialVNode.shapeFlag \u0026amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE ) { queuePostRenderEffect(a, parentSuspense); } instance.isMounted = true; // #2458: deference mount-only object parameters to prevent memleaks  initialVNode = container = anchor = null as any; } else { // updateComponent  // ...  next.el = nextTree.el; // updated hook  if (u) { queuePostRenderEffect(u, parentSuspense); } // onVnodeUpdated  if ((vnodeHook = next.props \u0026amp;\u0026amp; next.props.onVnodeUpdated)) { queuePostRenderEffect(() =\u0026gt; { invokeVNodeHook(vnodeHook!, parent, next!, vnode); }, parentSuspense); } } }, __DEV__ ? createDevEffectOptions(instance) : prodEffectOptions ); };     è¿™é‡Œæœ‰å››ä¸ªè°ƒç”¨ä¹Ÿå‡å’Œå£°æ˜å‘¨æœŸ hooks æœ‰å…³\n mounted, onVnodeMounted, updated, onVnodeUpdated å››ä¸ªå‘¨æœŸçš„ hooks æ‰§ è¡Œé˜Ÿåˆ—ã€‚\n  move() å‡½æ•°\n èŠ‚ç‚¹ç§»åŠ¨æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const move: MoveFn = ( vnode, container, anchor, moveType, parentSuspense = null ) =\u0026gt; { // ...  if (needTransition) { if (moveType === MoveType.ENTER) { transition!.beforeEnter(el!); hostInsert(el!, container, anchor); queuePostRenderEffect(() =\u0026gt; transition!.enter(el!), parentSuspense); } } else { hostInsert(el!, container, anchor); } };     å½“ä½¿ç”¨äº† transition ç»„ä»¶çš„æ—¶å€™ï¼Œè¿›å…¥åŠ¨ç”»çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚\n  unmount() å‡½æ•°\n å¸è½½ç»„ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const unmount: UnmountFn = ( vnode, parentComponent, parentSuspense, doRemove = false, optimized = false ) =\u0026gt; { // ...  if ((vnodeHook = props \u0026amp;\u0026amp; props.onVnodeUnmounted) || shouldInvokeDirs) { queuePostRenderEffect(() =\u0026gt; { vnodeHook \u0026amp;\u0026amp; invokeVNodeHook(vnodeHook, parentComponent, vnode) shouldInvokeDirs \u0026amp;\u0026amp; invokeDirectiveHook(vnode, null, parentComponent, \u0026#39;unmounted\u0026#39;) }, parentSuspense) } }     ç»„ä»¶å¸è½½çš„ä¸€ä¸ªå‘¨æœŸå‡½æ•° onVnodeUnmounted çš„ hooksã€‚\n  unmountComponent() ç»„ä»¶å¸è½½å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const unmountComponent = ( instance: ComponentInternalInstance, parentSuspense: SuspenseBoundary | null, doRemove?: boolean ) =\u0026gt; { // ...  // unmounted hook  if (um) { queuePostRenderEffect(um, parentSuspense) } queuePostRenderEffect(() =\u0026gt; { instance.isUnmounted = true }, parentSuspense) }     ç»„ä»¶å¸è½½æ—¶çš„é’©å­å‡½æ•° unmounted hooks\n    KeepAlive.ts    activated å‘¨æœŸå‡½æ•°\n  deactiveated å‘¨æœŸå‡½æ•°\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52  const KeepAliveImpl = { setup(props: KeepAliveProps, { slots }: SetupContext) { sharedContext.activate = (vnode, container, anchor, isSVG, optimized) =\u0026gt; { // ...  queuePostRenderEffect(() =\u0026gt; { instance.isDeactivated = false if (instance.a) { invokeArrayFns(instance.a) } const vnodeHook = vnode.props \u0026amp;\u0026amp; vnode.props.onVnodeMounted if (vnodeHook) { invokeVNodeHook(vnodeHook, instance.parent, vnode) } }, parentSuspense) } sharedContext.deactivate = (vnode: VNode) =\u0026gt; { const instance = vnode.component! move(vnode, storageContainer, null, MoveType.LEAVE, parentSuspense) queuePostRenderEffect(() =\u0026gt; { if (instance.da) { invokeArrayFns(instance.da) } const vnodeHook = vnode.props \u0026amp;\u0026amp; vnode.props.onVnodeUnmounted if (vnodeHook) { invokeVNodeHook(vnodeHook, instance.parent, vnode) } instance.isDeactivated = true }, parentSuspense) } // ...  onBeforeUnmount(() =\u0026gt; { cache.forEach(cached =\u0026gt; { const { subTree, suspense } = instance const vnode = getInnerChild(subTree) if (cached.type === vnode.type) { // current instance will be unmounted as part of keep-alive\u0026#39;s unmount  resetShapeFlag(vnode) // but invoke its deactivated hook here  const da = vnode.component!.da da \u0026amp;\u0026amp; queuePostRenderEffect(da, suspense) return } unmount(cached) }) }) return () =\u0026gt; { /* render */ } } }      apiWatch.ts   watch api ä¸­ï¼Œå½“æŒ‡å®šé€‰é¡¹ flush:post æ—¶ï¼Œä¼šå°† Job å½“åš post cb å»æ‰§è¡Œ(é»˜è®¤æ˜¯ pre cb ç±»å‹)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  function doWatch( source: WatchSource | WatchSource[] | WatchEffect | object, cb: WatchCallback | null, { immediate, deep, flush, onTrack, onTrigger }: WatchOptions = EMPTY_OBJ, instance = currentInstance ): WatchStopHandle { // ...  let scheduler: ReactiveEffectOptions[\u0026#39;scheduler\u0026#39;] if (flush === \u0026#39;sync\u0026#39;) { scheduler = job } else if (flush === \u0026#39;post\u0026#39;) { scheduler = () =\u0026gt; queuePostRenderEffect(job, instance \u0026amp;\u0026amp; instance.suspense) } else { // default: \u0026#39;pre\u0026#39;  } // ...  recordInstanceBoundEffect(runner, instance) // initial run  if (cb) { // ...  } else if (flush === \u0026#39;post\u0026#39;) { queuePostRenderEffect(runner, instance \u0026amp;\u0026amp; instance.suspense) } else { runner() } return () =\u0026gt; { /*...*/ }          flushPreFlushCbs(seen, parentJob)    ç»„ä»¶æ›´æ–°å‡½æ•°ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const updateComponentPreRender = ( instance: ComponentInternalInstance, nextVNode: VNode, optimized: boolean ) =\u0026gt; { nextVNode.component = instance; const prevProps = instance.vnode.props; instance.vnode = nextVNode; instance.next = null; updateProps(instance, nextVNode.props, prevProps, optimized); updateSlots(instance, nextVNode.children); // props update may have triggered pre-flush watchers.  // flush them before the render update.  flushPreFlushCbs(undefined, instance.update); };      flushPostFlushCbs(seen)   1 2 3 4 5 6 7 8 9 10 11  const render: RootRenderFunction = (vnode, container) =\u0026gt; { if (vnode == null) { if (container._vnode) { unmount(container._vnode, null, null, true); } } else { patch(container._vnode || null, vnode, container); } flushPostFlushCbs(); container._vnode = vnode; };     hydrate:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const hydrate: RootHydrateFunction = (vnode, container) =\u0026gt; { if (__DEV__ \u0026amp;\u0026amp; !container.hasChildNodes()) { warn( `Attempting to hydrate existing markup but container is empty. ` + `Performing full mount instead.` ); patch(null, vnode, container); return; } hasMismatch = false; hydrateNode(container.firstChild!, vnode, null, null); flushPostFlushCbs(); if (hasMismatch \u0026amp;\u0026amp; !__TEST__) { // this error should show up in production  console.error(`Hydration completed but contains mismatches.`); } };      æ€»ç»“   ä»»åŠ¡è°ƒåº¦å‡å‘ç”Ÿåœ¨ runtime-core é˜¶æ®µï¼Œæ‰€ä»¥ä¸‹é¢çš„æ–‡ä»¶å‡åœ¨ runtime-core/src../ ä¸‹\n   å¦‚ä¸Šè¡¨å¯å¾—å‡ºç»“è®ºï¼š\n  watch api çš„ Job å½’çº³ä¸º pre cb ç±»å‹ï¼Œå…ˆäº post å’Œ job æ‰§è¡Œ\n ç‰¹æ®Šæƒ…å†µï¼š watch api æŒ‡å®šäº† {flush: \u0026#39;post\u0026#39;} æ—¶å€™ä¹Ÿå±äº post cb ç±»å‹\n  ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•° hooks å½’çº³ä¸º post cb ç±»å‹ï¼Œåäº pre å’Œ job æ‰§è¡Œ\n  $forceUpdate ç»„ä»¶å¼ºåˆ¶æ›´æ–°å½’çº³ä¸º job ç±»å‹ï¼Œä¼šåœ¨ pre cb åé¢ï¼Œå…ˆäº post cb æ‰§è¡Œ\n   æ‰€ä»¥: watch job \u0026gt; force update job \u0026gt; å£°æ˜å‘¨æœŸ hooks job\n  æµ‹è¯•(/js/vue/tests/b56ivpbdBF.js)ï¼š\n   é€šè¿‡ä¸Šé¢çš„å‡ ä¸ªæŒ‰é’®å¯ä»¥æµ‹è¯•çœ‹å‡º pre, post, job æ‰§è¡Œé¡ºåºã€‚\n æ¯”å¦‚ï¼šç‚¹å‡» +/- æŒ‰é’®ï¼Œå¦‚ä¸‹è¾“å‡ºï¼š\nwatch pre cb: {\u0026#34;newVal\u0026#34;:-1,\u0026#34;oldVal\u0026#34;:0} watch post cb: {\u0026#34;newVal\u0026#34;:-1,\u0026#34;oldVal\u0026#34;:0} updated hook post cb before updated hook post cb after   ç‚¹å‡» $forceUpdate æŒ‰é’®ï¼Œå¦‚ä¸‹è¾“å‡ºï¼š\njob: from $forceUpdate watch pre cb: {\u0026#34;newVal\u0026#34;:0,\u0026#34;oldVal\u0026#34;:-1} watch post cb: {\u0026#34;newVal\u0026#34;:0,\u0026#34;oldVal\u0026#34;:-1} updated hook post cb before updated hook post cb after   è°ƒæ¢ä¸‹ï¼š watch api è°ƒç”¨é¡ºåºï¼ŒæŠŠ {flush: \u0026#39;post\u0026#39;} æ”¾å‰é¢\n1 2 3 4 5 6 7 8 9 10 11  watch( count, (newVal, oldVal) =\u0026gt; { log(\u0026#34;watch post cb: \u0026#34; + toStr({ newVal, oldVal })); }, { flush: \u0026#34;post\u0026#34; } ); watch(count, (newVal, oldVal) =\u0026gt; { log(\u0026#34;watch pre cb: \u0026#34; + toStr({ newVal, oldVal })); });    watch pre cb: {\u0026#34;newVal\u0026#34;:-1,\u0026#34;oldVal\u0026#34;:0} watch post cb: {\u0026#34;newVal\u0026#34;:-1,\u0026#34;oldVal\u0026#34;:0} updated hook post cb before updated hook post cb after   è¾“å‡ºç»“æœä¾æ—§æ˜¯ pre å…ˆäº post æ‰§è¡Œã€‚\n  ","permalink":"https://www.cheng92.com/vue/vue-teardown-2-sheduler/","tags":["vue3,","vue-next,","PatchFlags"],"title":"Vue3 åŠŸèƒ½æ‹†è§£â‘¡ Scheduler æ¸²æŸ“æœºåˆ¶"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");      stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n æœ¬æ–‡ä¸º runtime-core(2) ç»­é›†ï¼Œä¸Šç¯‡ï¼š Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render\n æµç¨‹å›¾(è„‘å›¾)    è¿™ä¸€èŠ‚æ–°å¢å†…å®¹è¾ƒå¤šï¼Œä¸»è¦æ–°å¢ä»¥ä¸‹å‡ ä¸ªå‡½æ•°\n  processComponent() åœ¨ patch() ä¸­æ‰§è¡Œ switch default åˆ†æ”¯ï¼Œæ»¡è¶³ ShapeFlags.COMPONENT æ¡ä»¶\n  mountComponent(n2,...) é¦–æ¬¡åŠ è½½ç»„ä»¶æ—¶è°ƒç”¨çš„å‡½æ•°\n  setupComponent(instance) å»ºç«‹ç»„ä»¶å®ä¾‹ï¼Œåšä¸€äº›ç»“æ„åˆå§‹åŒ–æ“ä½œ(å¦‚ï¼špropså’Œ slots)ç­‰\n  setupStatefulComponent(instance,isSSR) åˆ›å»ºæœ‰çŠ¶æ€ç»„ä»¶ï¼Œæ‰§è¡Œ setup() å‡½æ•°\n  setupRenderEffect() é€šè¿‡ effect() å‡½æ•°è¿”å› instance.update åˆ›å»ºä¸€ä¸ªç›‘å¬- æ›´æ–°å‡½æ•°ã€‚\n  finishComponentSetup(instance,isSSR) è¿™ä¸ªå‡½æ•°åœ¨ setupStatefulComponent() ä¸­è°ƒç”¨ï¼Œä¸»è¦åšçš„äº‹æƒ…æ˜¯å¤„ç† SSRï¼Œæ²¡æœ‰ render å‡½æ•°æœ‰ template æ—¶è°ƒç”¨ compile ç¼– è¯‘å‡º render å‡½æ•°ï¼Œå…¼å®¹ 2.x çš„ options api\n    processComponent(å¦‚ä½•patchç»„ä»¶çš„ï¼Ÿ)   é—®é¢˜ä¿®å¤ï¼š TypeError: Cannot read property \u0026#39;allowRecurse\u0026#39; of null\n processComponent(n1,n2,...) å‡½æ•°ä¸»è¦åˆ†ä¸‰ç§æƒ…å†µ\n  mount, æ²¡æœ‰ n1 old æ—¶å€™ï¼Œå±äºçº¯ mount æ“ä½œ\n  keep-alive ç±»å‹ï¼Œåªéœ€è¦é‡æ–°æ¿€æ´» activate\n  å¦åˆ™æ‰§è¡Œ mountComponent(n2, â€¦.) é¦–æ¬¡åŠ è½½ç»„ä»¶\n    update, éé¦–æ¬¡åŠ è½½æ‰§è¡Œæ›´æ–°æ“ä½œ\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner, ref }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); const value = ref(true); let parentVnode, childVnode1, childVnode2; const Parent = { render: () =\u0026gt; { // return h(\u0026#34;div\u0026#34;, \u0026#34;æµ‹è¯•...\u0026#34;);  return (parentVnode = h(Child)); }, }; const Child = { render: () =\u0026gt; { return value.value ? (childVnode1 = h(\u0026#34;div\u0026#34;, \u0026#34;child 1\u0026#34;)) : (childVnode2 = h(\u0026#34;span\u0026#34;, \u0026#34;child 2\u0026#34;)); }, }; const p = h(Parent); render(p, root); logRoot(); value.value = false; logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedroot: component stateful ? 4 call setup no setup [Function: render] render mount component normalize vnode patch component component stateful ? 4 call setup no setup [Function: render] render mount component normalize vnode patch component root: \u0026lt;div\u0026gt;child 1\u0026lt;/div\u0026gt; root: \u0026lt;div\u0026gt;child 1\u0026lt;/div\u0026gt; component update   æµç¨‹ç®€å›¾ï¼š\n  è¿™é‡Œæ‰§è¡Œå°±æ˜¯ mountComponent(n2,...) è¡Œä¸ºï¼Œé¦–æ¬¡åŠ è½½ç»„ä»¶ï¼Œå®Œæˆï¼š\n  setupComponent(instance) æ‰§è¡Œ setup å‡½æ•°ï¼Œåˆå§‹åŒ– props\u0026amp;slots ç­‰\n  setupRenderEffect(instance,...) æ³¨å†Œ instance.update effect\n å½“å®ä¾‹çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶æ‰§è¡Œè¿™ä¸ª effect fnï¼Œå¦‚æœæ˜¯é¦–æ¬¡(çˆ¶çº§è°ƒç”¨ processComponent) æ‰§è¡Œ!isMounted åˆ†æ”¯è¿›è¡Œç»„ä»¶é¦–æ¬¡åŠ è½½ï¼Œå¦åˆ™å½“ç»„ä»¶è‡ªèº«çŠ¶æ€æ”¹å˜æ˜¯è§¦å‘çš„ update æ“ ä½œ\n   åœ¨ setupComponent ä¸­ï¼Œä¸»è¦å®Œæˆ\n  initProps\n  initSlots\n  setupStatefulComponent(instance,isSSR) æœ‰çŠ¶æ€ç»„ä»¶(éå‡½æ•°ç»„ä»¶)\n   ç´§æ¥ç€ setupStatefulComponent(instance,isSSR) ä¸­æ£€æµ‹ setup å‡½æ•°ï¼Œå¹¶æ‰§è¡Œå®ƒï¼Œå¦‚ æœæ²¡æœ‰ setup å‡½æ•°å°±è¿›å…¥ finishComponentSetup(instance) æ£€æµ‹ render æˆ– template æœ€ç»ˆç›®çš„æ˜¯è·å¾— render å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ render ä¼šé€šè¿‡ compile(template) ç¼–è¯‘å‡º render å‡½æ•°ï¼Œæœ€ååœ¨ instance.update ä¸­æ‰§è¡Œ render å‡½æ•°(åœ¨è¿™å‰åä¼šè§¦å‘ beforeMount å’Œ mounted å‘¨æœŸå‡½æ•°)ã€‚\n æ‰€ä»¥ï¼Œä¸€å¥—æµç¨‹ä¸‹æ¥å¯ä»¥ç®€å•æè¿°ä¸º\n mount -\u0026gt; props\u0026amp;slots åˆå§‹åŒ– -\u0026gt; setup() -\u0026gt; æœ‰çŠ¶æ€ç»„ä»¶å¤„ç†å¾—åˆ° render å‡½æ•° -\u0026gt; æœ€å é€šè¿‡ instance.update effect æ¥ç›‘å¬å®ä¾‹çŠ¶æ€å˜åŒ–ï¼Œè§¦å‘ mount æˆ–è€… updateã€‚\n åœ¨ effect mount é˜¶æ®µä¼šè§¦å‘ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼š\n  beforeMount + mounted\n  onVnodeBeforeMount + onVnodeMounted(é’ˆå¯¹ vnode ç»“æ„å˜åŒ–è€Œè¨€)\n  activated(å¦‚æœæ˜¯ keep-alive çš„è¯)\n  ç»„ä»¶çš„æ¸²æŸ“å°±å‘ç”Ÿåœ¨ beforeMount ä¹‹å mounted ä¹‹å‰çš„ renderComponentRoot() å¾—åˆ° vnode äº¤ç»™ patch å»è¿›è¡Œæ¸²æŸ“ã€‚\n  ç¤ºä¾‹ä»£ç ä¸­ï¼Œåé¢ä¿®æ”¹äº† value.value=false åé¢ dom å¹¶æ²¡æ”¹å˜ï¼Œä½†æ˜¯è¾“å‡ºäº† component update è¯´æ˜è¿›å…¥äº† instance.update effect çš„ else åˆ†æ”¯ï¼Œå› ä¸ºä¸æ˜¯ç¬¬ ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å®ç°æ›´æ–°ç»„ä»¶éƒ¨åˆ†ã€‚\neffect update component   å› ä¸º instance.update æ˜¯é€šè¿‡ effect() å°è£…çš„å‡½æ•°ï¼Œä¸”è¿™ä¸ªå‡½æ•°ä¸­ä½¿ç”¨åˆ°äº† instance å®ä¾‹è€Œè¿™ä¸ªå®ä¾‹åˆåœ¨ setupComponent ä¸­æœ‰åšè¿‡ä»£ç†ï¼Œå› æ­¤å¯¹å®ƒçš„è®¿é—®ä¼šè§¦å‘ effect trackï¼ŒçŠ¶æ€æ›´æ–°ä¼šè§¦å‘ effect trigger(å“åº”å¼åŸç†)ã€‚\n feat(add): component update Â· gcclll/stb-vue-next@1254465\n æ¶‰åŠçš„ä¿®æ”¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71  instance.update = effect( function componentEffect() { // ç›‘å¬æ›´æ–°  if (!instance.isMounted) { // ...  } else { // updateComponent  // å½“ç»„ä»¶è‡ªèº«çš„çŠ¶æ€æˆ–çˆ¶ç»„ä»¶è°ƒç”¨ processComponent æ—¶è§¦å‘  console.log(\u0026#34;component update\u0026#34;); let { next, bu, u, parent, vnode } = instance; let originNext = next; let vnodeHook: VNodeHook | null | undefined; if (next) { next.el = vnode.el; updateComponentPreRender(instance, next, optimized); } else { next = vnode; } // beforeUpdate hook  if (bu) { invokeArrayFns(bu); } // onVnodeBeforeUpdate  if ((vnodeHook = next.props \u0026amp;\u0026amp; next.props.onVnodeBeforeUpdate)) { invokeVNodeHook(vnodeHook, parent, next, vnode); } //render  const nextTree = renderComponentRoot(instance); const prevTree = instance.subTree; instance.subTree = nextTree; patch( prevTree, nextTree, // å¦‚æœåœ¨ teleport ä¸­ï¼Œparent å¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜  hostParentNode(prevTree.el!)!, // anchor may have changed if it\u0026#39;s in a fragment  getNextHostNode(prevTree), instance, parentSuspense, isSVG ); next.el = nextTree.el; if (originNext === null) { // self-triggered update. In case of HOC, update parent component  // vnode el. HOC is indicated by parent instance\u0026#39;s subTree pointing  // to child component\u0026#39;s vnode  // TODO  } // updated hook  if (u) { queuePostRenderEffect(u, parentSuspense); } // onVnodeUpdated  if ((vnodeHook = next.props \u0026amp;\u0026amp; next.props.onVnodeUpdated)) { queuePostRenderEffect(() =\u0026gt; { invokeVNodeHook(vnodeHook!, parent, next!, vnode); }); } } }, __DEV__ ? // æä¾› onTrack/onTrigger é€‰é¡¹æ‰§è¡Œ rtc\u0026amp;rtg ä¸¤ä¸ªå‘¨æœŸå‡½æ•°  createDevEffectOptions(instance) : prodEffectOptions );     å’Œ updateComponentPreRender å®ç°è¿™ä¸ªå‡½æ•°è®© instance.update åœ¨ nextTick() ä¹‹åæ‰§ è¡Œ pre ä¼˜å…ˆäº post å’Œ job ä»»åŠ¡(è¯¦æƒ…æŸ¥çœ‹ä»»åŠ¡è°ƒåº¦-\u0026gt;)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const updateComponentPreRender = ( instance: ComponentInternalInstance, nextVNode: VNode, optimized: boolean ) =\u0026gt; { nextVNode.component = instance // const prevProps = instance.vnode.props  instance.vnode = nextVNode instance.next = null // TODO update props  // TODO update slots  // props update may have triggered pre-flush watchers.  // flush them before the render update.  flushPreFlushCbs(undefined, instance.update) }     ä¹‹å‰çš„ç”¨ä¾‹å†æµ‹è¯•ä¸€éï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( async ({ h, render, nodeOps, serializeInner: inner, ref, nextTick }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); const value = ref(true); let parentVnode, childVnode1, childVnode2; const idValue = ref(\u0026#34;parent\u0026#34;); const Parent = { render: () =\u0026gt; { console.log(\u0026#34;parent render\u0026#34;); return (parentVnode = h(\u0026#34;div\u0026#34;, { id: idValue.value }, h(Child))); }, }; const Child = { render: () =\u0026gt; { console.log(\u0026#34;child render\u0026#34;); return value.value ? (childVnode1 = h(\u0026#34;div\u0026#34;, \u0026#34;child 1\u0026#34;)) : (childVnode2 = h(\u0026#34;span\u0026#34;, \u0026#34;child 2\u0026#34;)); }, }; const p = h(Parent); render(p, root); logRoot(); console.log(\u0026#34;before change value\u0026#34;); value.value = false; await nextTick(); console.log(\u0026#34;after change value\u0026#34;); logRoot(); console.log(\u0026#39;before id change\u0026#39;); idValue.value = \u0026#39;parent-id\u0026#39; await nextTick() console.log(\u0026#39;after id change\u0026#39;); logRoot() }, (err) =\u0026gt; { console.log(err.message); } );    undefinedroot: component stateful ? 4 call setup no setup [Function: render] render mount component normalize vnode parent render patch component component stateful ? 4 call setup no setup [Function: render] render mount component normalize vnode child render patch component root: \u0026lt;div id=\u0026#34;parent\u0026#34;\u0026gt;\u0026lt;div\u0026gt;child 1\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt; before change value component update normalize vnode child render after change value root: \u0026lt;div id=\u0026#34;parent\u0026#34;\u0026gt;\u0026lt;span\u0026gt;child 2\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; before id change component update normalize vnode parent render after id change root: \u0026lt;div id=\u0026#34;parent\u0026#34;\u0026gt;\u0026lt;span\u0026gt;child 2\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;   è¿™é‡Œè¦è®©è¾“å‡ºè¾¾åˆ°æ•ˆæœï¼Œéœ€è¦å°† resolve æ”¹æˆ async function å¹¶ä¸”è¦åœ¨ nextTick() å è¾“å‡ºæ›´æ–°åçš„ç»“æœï¼Œå› ä¸º instance.update è°ƒç”¨äº† flushPreFlushCbs(null, instane.update) ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå‡½æ•°æ˜¯ä¸ªå¼‚æ­¥æ›´æ–°ï¼Œä¸”ä¼šåœ¨ nextTick() åè§¦å‘ï¼Œè¯¦æƒ… åˆ†ææŸ¥çœ‹â€œä»»åŠ¡è°ƒåº¦æœºåˆ¶åˆ†æâ€\n é—®é¢˜ï¼š å¦‚ä¸Šé¢çš„ç»“æœï¼Œå½“æˆ‘ä»¬æ”¹å˜ idValue.value=\u0026#34;parent-id\u0026#34; çš„æ—¶å€™ï¼Œå®é™…ç»“æœå¹¶æ²¡ æœ‰æ”¹å˜ï¼Ÿ\n ç­”ï¼š å› ä¸ºåœ¨ setupComponent() ä¸­çš„ initProps() ä»¥åŠ updateComponentPreRender() ä¸­çš„ updateProps() è¿˜æ²¡å®ç°ï¼Œä¸‹ä¸€èŠ‚æ­æ™“ã€‚\n   normalize props options   feat(add): normalize props options Â· gcclll/stb-vue-next@7d6ac55\n å¯¹åº”å®˜æ–¹æ–‡æ¡£å†…å®¹ï¼š Props | Vue.js\n è¿™é‡Œä½œç”¨ç®€å•æè¿°å°±æ˜¯ï¼Œå°† props çš„å®šä¹‰åœ¨ç»„ä»¶åŠ è½½åˆå§‹åŒ–æ—¶è§£ææˆå…·ä½“çš„å€¼ï¼Œå¦‚ï¼š props: [\u0026#39;foo\u0026#39;] è§£ææˆ foo={} å› ä¸ºå­—ç¬¦ä¸²æ•°ç»„çš„ props ä¼šç»™æ¯ä¸ªå±æ€§åˆå§‹åŒ–ä¸€ä¸ªç©º å¯¹è±¡ã€‚\n  æ¯”å¦‚ï¼š\n  æ•°ç»„ï¼š props: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;, \u0026#39;foo-bar\u0026#39;]\n è½¬æˆ {foo: {}, bar: {}, fooBar: {}}\n  å¯¹è±¡: props: { foo: [Boolean, String], bar: Function }\n è¡¨ç¤º foo å¯ä»¥æ˜¯å¸ƒå°”å€¼æˆ–å­—ç¬¦ä¸²ï¼Œbar æ˜¯ä¸ªå‡½æ•°\n è½¬æ¢è¿‡ç¨‹(0: BooleanFlags.shouldCast, 1: BooleanFlags.shouldCastTrue)\n foo = { type: [Boolean, String] } -\u0026gt; æ‰¾ Boolean\n foo = { type: [Boolean, String], 0: true } -\u0026gt;\n æ‰¾ String éœ€æ»¡è¶³ stringIndex \u0026lt; 0 || booleanIndex \u0026lt; stringIndex\n foo = { type: [Boolean, String], 0: true, 1: true }\n æœ€åå†³å®š foo æ˜¯ä¸æ˜¯åº”è¯¥è¿›è¡Œ cast ? æ¡ä»¶æ˜¯å¸ƒå°”ç±»å‹æˆ–è€…æœ‰ default é»˜è®¤å€¼ã€‚\n   æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88  export function normalizePropsOptions( comp: ConcreteComponent, appContext: AppContext, asMixin: false ): NormalizedPropsOptions { if (!appContext.deopt \u0026amp;\u0026amp; comp.__props) { return comp.__props } const raw = comp.props const normalized: NormalizedPropsOptions[0] = {} const needCastKeys: NormalizedPropsOptions[1] = [] // mixin/extends props åº”ç”¨  let hasExtends = false // å¿…é¡»å¼€æ”¯ 2.x options api æ”¯æŒï¼Œä¸”ä¸æ˜¯å‡½æ•°å¼ç»„ä»¶  // ç»§æ‰¿æ¥çš„å±æ€§ï¼Œç”¨æ³•ï¼š ~CompA = { extends: CompB, ... }~  // CompA ä¼šç»§æ‰¿ CompB çš„ props  if (__FEATURE_OPTIONS_API__ \u0026amp;\u0026amp; !isFunction(comp)) { const extendProps = (raw: ComponentOptions) =\u0026gt; { hasExtends = true const [props, keys] = normalizePropsOptions(raw, appContext, true) extend(normalized, props) if (keys) { needCastKeys.push(...keys) } } // Comp: { extends: CompA } å¤„ç†  if (comp.extends) { extendProps(comp.extends) } // Comp: { mixins: [mixin] } å¤„ç†  if (!asMixin \u0026amp;\u0026amp; appContext.mixins.length) { appContext.mixins.forEach(extendProps) } } // æ—¢æ²¡æœ‰è‡ªèº«çš„ props ä¹Ÿæ²¡æœ‰ extends ç»§æ‰¿æ¥çš„ props åˆå§‹åŒ–ä¸º []  if (!raw \u0026amp;\u0026amp; !hasExtends) { return (comp.__props = EMPTY_ARR as any) } if (isArray(raw)) { // å½“ props æ˜¯æ•°ç»„çš„æ—¶å€™ï¼Œå¿…é¡»æ˜¯å­—ç¬¦ç±»å‹ï¼Œå¦‚: props: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;, \u0026#39;foo-bar\u0026#39;]  // \u0026#39;foo-bar\u0026#39; ä¼šè½¬æˆ \u0026#39;fooBar\u0026#39;ï¼Œä¸å…è®¸ \u0026#39;$xxx\u0026#39; å½¢å¼çš„å˜é‡å  for (let i = 0; i \u0026lt; raw.length; i++) { const normalizedKey = camelize(raw[i]) // ç»„ä»¶çš„å±æ€§åä¸èƒ½æ˜¯ä»¥ $xx å¼€å¤´çš„åç§°ï¼Œè¿™ä¸ªæ˜¯ä½œä¸ºå†…éƒ¨å±æ€§çš„  if (validatePropName(normalizedKey)) { normalized[normalizedKey] = EMPTY_OBJ } } } else if (raw) { // å¯¹è±¡ç±»å‹ props: { foo: 1, bar: 2, ... }  for (const key in raw) { // \u0026#39;foo-bar\u0026#39; -\u0026gt; \u0026#39;fooBar\u0026#39;  const normalizedKey = camelize(key) // æ£€æŸ¥ $xxx éæ³•å±æ€§  if (validatePropName(normalizedKey)) { const opt = raw[key] // ? å€¼ä¸ºæ•°ç»„æˆ–å‡½æ•°å˜æˆï¼š { type: opt } ?  // è¿™é‡Œå«ä¹‰å…¶å®æ˜¯ï¼š ~props: { foo: [Boolean, Function] }~  // å¯ä»¥ç”¨æ•°ç»„å®šä¹‰è¯¥å±æ€§å¯ä»¥æ˜¯å¤šç§ç±»å‹çš„å…¶ä¸­ä¸€ç§  const prop: NormalizedProp = (normalized[normalizedKey] = isArray(opt) || isFunction(opt) ? { type: opt } : opt) if (prop) { // æ‰¾åˆ° Boolean åœ¨ foo: [Boolean, Function] ä¸­çš„ç´¢å¼•  const booleanIndex = getTypeIndex(Boolean, prop.type) const stringIndex = getTypeIndex(String, prop.type) prop[BooleanFlags.shouldCast] = booleanIndex \u0026gt; -1 // [String, Boolean] ç±»å‹ï¼ŒString åœ¨ Boolean å‰é¢  prop[BooleanFlags.shouldCastTrue] = stringIndex \u0026lt; 0 || booleanIndex \u0026lt; stringIndex // å¦‚æœæ˜¯å¸ƒå°”ç±»å‹çš„å€¼æˆ–è€…æœ‰é»˜è®¤å€¼çš„å±æ€§éœ€è¦è½¬æ¢  // è½¬æ¢æ˜¯æ ¹æ® type å’Œ default å€¼å¤„ç†  // typeéå‡½æ•°ï¼Œdefaultæ˜¯å‡½æ•°ï¼Œæ‰§è¡Œ default() å¾—åˆ°é»˜è®¤å€¼  if (booleanIndex \u0026gt; -1 || hasOwn(prop, \u0026#39;default\u0026#39;)) { needCastKeys.push(normalizedKey) } } } } } return (comp.__props = [normalized, needCastKeys]) }     ç„¶åè¿™ä¸ªå¤„ç†ä¹‹åçš„ propsï¼Œä¼šè¢«ä¿å­˜åˆ°ç»„ä»¶çš„ comp.__props=[normalied, needCastKeys] ä¸Šï¼Œè€Œè¿™ä¸ªä¼šåœ¨ resolvePropValue() ä¸­è¿›ä¸€æ­¥å¤„ç†ï¼Œè¿™é‡Œçš„ needCastKeys éå¸¸é‡è¦ï¼Œå®ƒä¼šå†³å®šæœ€åçš„å€¼åº”è¯¥å¦‚ä½•è¢«å¤„ç†(resolvePropValue ä¸­å¤„ ç†)ã€‚\n æ¯”å¦‚ï¼š { type: String, default: () =\u0026gt; \u0026#39;xxx\u0026#39; } é‚£ä¹ˆæ»¡è¶³ type!==Function \u0026amp;\u0026amp; isFunction(dfault) åˆ™ä¼šç›´æ¥æ‰§è¡Œ default() å¾—åˆ°å±æ€§é»˜è®¤å€¼ã€‚\n å¦‚æœå±æ€§çš„ opt[BooleanFlags.shouldCast] ä¸º true å¦‚æœ€å¼€å§‹çš„è¯´æ˜ï¼Œå…¶å®å°±æ˜¯ prop[\u0026#34;0\u0026#34;] çš„å€¼ï¼Œåªè¦ prop çš„ç±»å‹ä¸­æœ‰ Boolean è¿™ä¸ªå€¼å°±æ˜¯ true ã€‚\n æ­¤æ—¶éœ€è¦å°†å±æ€§çš„å€¼è½¬æˆ\n  true : ç±»å‹å£°æ˜ä¸­æœ‰ Boolean ä¸”æœ‰ String çš„æ—¶å€™ï¼Œå®ƒçš„å€¼å¦‚æœæ˜¯ \u0026#39;\u0026#39; æˆ–è€… key === value æƒ…å†µä¸‹è½¬æˆ true, å› ä¸ºæŒ‡å®šäº†å¯ä»¥æ˜¯ String ç±»å‹ï¼Œæ‰€ä»¥ç©ºå­—ç¬¦ ä¸²æ˜¯å…è®¸çš„ã€‚\n  false : (!hasOwn(props, key) \u0026amp;\u0026amp; !hasDefault), raw props ä¸­æ²¡æœ‰è¿™ä¸ªå±æ€§ä¸” æ²¡æœ‰ default é»˜è®¤å€¼çš„æ—¶å€™è½¬æˆ false, ç­‰äºæ˜¯å‡å€¼ç±»å‹ã€‚\n    component props   feat(add): init component props Â· gcclll/stb-vue-next@9a6aa70\n æ–°å¢ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11  // component.ts \u0026gt; setupComponent() export function setupComponent( instance: ComponentInternalInstance, isSSR = false ) { // ...  // init props \u0026amp; slots  initProps(instance, props, isStateful, isSSR); // ...  return setupResult; }     componentProps.ts \u0026gt; initProps()\n  def -\u0026gt; attrs.__vInterval = 1\n  setFullProps å¤„ç† rawProps å°†ç»“æœåé¦ˆåˆ° props å’Œ attrs\n  æœ‰çŠ¶æ€ç»„ä»¶ï¼Ÿå°† props reactive åŒ–ï¼ŒSSRä¸‹ä¸æ”¯æŒå±æ€§å“åº”å¼å…¶å®å°±æ˜¯æœåŠ¡å™¨è¿”å›çš„å± æ€§éƒ½æ˜¯å¸¦æœ‰æœ€ç»ˆå€¼çš„è€Œä¸æ˜¯åœ¨å®¢æˆ·ç«¯åŠ¨æ€èƒ½æ”¹å˜çš„\n  å‡½æ•°ç»„ä»¶çš„ props å¯é€‰å±æ€§å’Œå¿…é¡»å±æ€§ï¼Ÿå¯é€‰ç”¨ attrs å¦åˆ™ç”¨ props\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  export function initProps( instance: ComponentInternalInstance, rawProps: Data | null, isStateful: number, isSSR = false ) { const props: Data = {}; const attrs: Data = {}; def(attrs, InternalObjectKey, 1); setFullProps(instance, rawProps, props, attrs); // TODO validation  if (isStateful) { instance.props = isSSR ? props : shallowReactive(props); } else { if (!instance.type.props) { // functional optional props, props === attrs  instance.props = attrs; } else { // functional declared props  instance.props = props; } } instance.attrs = attrs; }     componentProps.ts \u0026gt; setFullProps() è¿™ä¸ªå‡½æ•°ç›®çš„æ˜¯å°† rawProps ç»„ä»¶çš„ props è§£æå‡ºæ¥æ ¹æ®å„è‡ªç‰¹æ€§ åˆ†æ´¾åˆ° props æˆ– attrs\n  key, ref å±æ€§ä¸ä¿ç•™ï¼Œå› ä¸ºç»„ä»¶æ›´æ–°æ—¶ key å¯èƒ½å‘ç”Ÿæ”¹å˜ï¼Œrefå¼•ç”¨ä¹Ÿä¼šå˜å¥½æŒ‡å‘æ›´æ–°åçš„ DOM å…ƒç´ \n  options å•¥æ„æ€ï¼Ÿ\n  äº‹ä»¶å±æ€§(onClick)ä¼šå­˜æ”¾åˆ° attrs !\n  needCastKeys ? è¿™æ˜¯åšå•¥å‘¢ resolvePropValueï¼Ÿ\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function setFullProps( instance: ComponentInternalInstance, rawProps: Data | null, props: Data, attrs: Data ) { const [options, needCastKeys] = instance.propsOptions; if (rawProps) { for (const key in rawProps) { const value = rawProps[key]; // key, ref ä¿ç•™ï¼Œä¸å¾€ä¸‹ä¼   // å³è¿™ä¸¤ä¸ªå±æ€§ä¸ä¼šç»§æ‰¿ç»™ child  if (isReservedProp(key)) { continue; } let camelKey; if (options \u0026amp;\u0026amp; hasOwn(options, (camelKey = camelize(key)))) { props[camelKey] = value; } else if (!isEmitListener(instance.emitsOptions, key)) { attrs[key] = value; } } } if (needCastKeys) { const rawCurrentProps = toRaw(props); for (let i = 0; i \u0026lt; needCastKeys.length; i++) { const key = needCastKeys[i]; props[key] = resolvePropValue( options!, rawCurrentProps, key, rawCurrentProps[key], instance ); } } }     componentProps.ts -\u0026gt; resolvePropValue()\n  props:{name: {default: v=\u0026gt; myname }, type: String}\n å½“ type éå‡½æ•°æ—¶ï¼Œè¯´æ˜ name æ˜¯ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œä½†æ˜¯å®ƒçš„ default åˆæ˜¯ä¸ªå‡½æ•°ï¼Ÿ é‚£ä¹ˆè¿™ç§æƒ…å†µä¼šåœ¨è¿™é‡Œè¢«å¤„ç†ï¼Œæœ€åå°† name çš„å€¼èµ‹å€¼ä¸º default(props) æ‰§è¡Œä¹‹åçš„ç»“æœ\n  props:{name: {default: v=\u0026gt; myname }, type: Function}\n è¿™ç§æƒ…å†µï¼Œè¯´æ˜ name æœ¬èº«å°±æ˜¯å‡½æ•°ï¼Œä¸éœ€è¦æ‰§è¡Œ defaultã€‚\n  props:{name: value, type: String|Number} æ™®é€šç±»å‹æƒ…å†µ\n  boolean ç±»å‹çš„å€¼å¤„ç†ï¼Œæœ€åéƒ½ä¼šè½¬æˆ true æˆ– false\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  function resolvePropValue( options: NormalizedProps, props: Data, key: string, value: unknown, instance: ComponentInternalInstance ) { /* * è¿™é‡Œé¢çš„å¤„ç†æ˜¯é’ˆå¯¹ props: { name: { ... } } ç±»å‹è€Œè¨€ * 1. é»˜è®¤å€¼çš„å¤„ç†ï¼Œ default å¯èƒ½æ˜¯å‡½æ•°æˆ–æ™®é€šç±»å‹å€¼ï¼Œå¦‚æœæ˜¯å‡½æ•°åº”è¯¥å¾—åˆ° * å‡½æ•°æ‰§è¡Œçš„ç»“æœä½œä¸ºå®ƒçš„å€¼ï¼Œæ³¨æ„ä¸‹é¢çš„æ£€æµ‹å‡½æ•°æ—¶å‰ç½®æ¡ä»¶æ˜¯è¯¥ç±»å‹ä¸æ˜¯å‡½æ•°ï¼Œ * å¦‚æœç±»å‹ä¹Ÿæ˜¯å‡½æ•°ï¼Œé»˜è®¤å€¼å°±æ˜¯è¯¥å‡½æ•°æœ¬èº«ï¼Œè€Œéæ‰§è¡Œåçš„ç»“æœå€¼ * 2. å¸ƒå°”å€¼çš„å¤„ç†ï¼Œå€¼è½¬æˆ true or false */ const opt = options[key] if (opt != null) { const hasDefault = hasOwn(opt, \u0026#39;default\u0026#39;) // é»˜è®¤å€¼  if (hasDefault \u0026amp;\u0026amp; value === undefined) { const defaultValue = opt.default // props: { name: { default: (props) =\u0026gt; \u0026#39;xxx\u0026#39; } }  // ç±»å‹ä¸æ˜¯å‡½æ•°ï¼Ÿä½†æ˜¯é»˜è®¤å€¼æ˜¯å‡½æ•°ï¼Œæ‰§è¡Œå¾—åˆ°ç»“æœ  if (opt.type !== Function \u0026amp;\u0026amp; isFunction(defaultValue)) { setCurrentInstance(instance) value = defaultValue(props) setCurrentInstance(null) } else { // props: { name: { default: \u0026#39;xxx\u0026#39; } }  value = defaultValue } } // boolean casting  if (opt[BooleanFlags.shouldCast]) { if (!hasOwn(props, key) \u0026amp;\u0026amp; !hasDefault) { value = false } else if ( opt[BooleanFlags.shouldCastTrue] \u0026amp;\u0026amp; (value === \u0026#39;\u0026#39; || value === hyphenate(key)) ) { value = true } } } return value }     â“ ç„¶åä¸ props æœ‰å…³çš„ propsOptions æ˜¯æ¥è‡ªå“ªé‡Œï¼Ÿ\n  å›é¡¾ä¸‹ component render è¿‡ç¨‹ï¼š\n patch -\u0026gt; switch default -\u0026gt; PatchFlags.COMPONENT -\u0026gt;\n processComponent -\u0026gt; mountComponent -\u0026gt;\n createComponentInstance -\u0026gt; setupComponent -\u0026gt; setupRenderEffect\n æœ‰äº†ï¼Ÿ\n æ˜¯çš„ï¼Œå°±æ˜¯å®ƒ -\u0026gt; createComponentInstance åˆ›å»ºç»„ä»¶å®ä¾‹ä¸­ï¼Œè¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå…¶ä¸­ç»„ç»‡ çš„ç»“æ„é‡Œé¢å°±æœ‰ä¸€ä¸ª\n propsOptions: normalizePropsOptions(type, appContext)\n å’Œ\n emitsOptions: normalizeEmitsOptions(type, appContext)\n  component setup    setup å¦‚æœè¿”å›å€¼æ˜¯å‡½æ•°ç›´æ¥æ˜¯ render å‡½æ•°\n  setup è¿”å›å€¼æ˜¯å¯¹è±¡ï¼Œåˆ™å½“åšå’Œ data ä¸€æ ·çš„ç»„ä»¶çŠ¶æ€å¤„ç†\n    æ›´å¤šåˆ†æè§æ³¨é‡Šï¼Œç›¸å…³ä»£ç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117  // å¦‚æœç»„ä»¶æ˜¯ä¸ªå¯¹è±¡ï¼Œè€Œéå‡½æ•°æ˜¯ç»„ä»¶æ˜¯ä¼šç»è¿‡è¿™ä¸ªå‡½æ•° function setupStatefulComponent( instance: ComponentInternalInstance, isSSR: boolean ) { const Component = instance.type as ComponentOptions; // 0. create render proxy property access cache  // è¿™ä¸ªæ˜¯é’ˆå¯¹ instance ä¸Šå±æ€§çš„ get æ“ä½œç±»å‹è¿›è¡Œäº† key å€¼ç¼“å­˜  // æ¯”å¦‚ï¼šå½“ä½ å¯¹ setupState æˆ– dataçš„å±æ€§ è¿›è¡Œäº† get è®¿é—®ï¼Œ  // é‚£ä¹ˆè¯¥å±æ€§çš„keyå€¼ä¼šè®°å½•ä¸ºè¯¥ç±»å‹(accessCache[key]=AccessTypes.SETUP)  // å½“ä½ ä¸‹æ¬¡å†åœ¨ instance ä¸Šè®¿é—®è¿™ä¸ªkey çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¼šçŸ¥é“è¿™ä¸ª key  // æ˜¯åœ¨ setupState ä¸Šï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å› setupState[key] å°±è¡Œäº†  // è€Œä¸ç”¨å»é‡å¤è¿›è¡Œ if...elseif...else å» setupData, data, context  // æˆ– props åˆ¤æ–­ç„¶åå†³å®šå»å“ªä¸ªä¸Šé¢å–å€¼ï¼ŒåŠ å¿«æ±‚å€¼é€Ÿåº¦ã€‚  // å¦‚ï¼š setupState={foo:1}, data={bar:2}  // å–å€¼ï¼š this.foo è§¦å‘ get æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ç¬¬ä¸€æ¬¡å–å€¼çš„æ—¶å€™ä¼šè¿›è¡Œ  // if setupState else if data æ£€æµ‹\u0026#39;foo\u0026#39;åœ¨å“ªä¸ªå¯¹è±¡ä¸Šï¼Œå‘ç°åœ¨  // setupState ä¸Šï¼Œç„¶åå°† \u0026#39;foo\u0026#39; ç¼“å­˜åˆ° accessCache[\u0026#39;foo\u0026#39;] =\u0026#39;setup\u0026#39;  // ä¸‹æ¬¡å†æ¬¡å–å€¼this.fooï¼Œé‚£ä¹ˆæœ¬æ¬¡å°±ä¼šç›´æ¥è¿”å› setupState[\u0026#39;foo\u0026#39;]  instance.accessCache = Object.create(null); // 1. create public instance / render proxy  // also mark it raw so it\u0026#39;s never observed  // ä»£ç†ç›®çš„ï¼šè®©å–å€¼æ“ä½œèƒ½åœ¨ setupState, data, ctx, props åŠ  // appContext.config.globalProperties ä¸Šä¾æ¬¡æŸ¥æ‰¾å¯¹åº”çš„å±æ€§å€¼  // ä¼˜å…ˆçº§ï¼š  // 1. é $xxx å±æ€§ï¼Œ setupState \u0026gt; data \u0026gt; ctx \u0026gt; props  // 2. this.$xxx å–å€¼ï¼Œ public å±æ€§: $,$el,$data,$props,$attrs  // ,$slots,$refs,$parent,$root,$emit,$options,$forceUpdate,  // ,$nextTick,$watch  // \u0026gt; cssModule å±æ€§ vue-loader æ³¨å…¥çš„css å˜é‡  // \u0026gt; instance.ctx  // \u0026gt; appContext.config.globalProperties, å¦‚ï¼š this.$router  instance.proxy = new Proxy(instance.ctx, PublicInstanceProxyHandlers); console.log(\u0026#34;call setup\u0026#34;); // 2. call setup()  const { setup } = Component; if (setup) { // ä¼ é€’ç»™ setup(props, setupContext) çš„ç¬¬äºŒä¸ªå‚æ•°  // setupContext: { attrs, slots, emit, expose }  const setupContext = (instance.setupContext = setup.length \u0026gt; 1 ? createSetupContext(instance) : null); currentInstance = instance; // å®ä¾‹åˆå§‹åŒ–æœŸé—´ï¼Œç¦æ­¢ track æ“ä½œï¼Œget æ”¶é›†ä¾èµ–  pauseTracking(); // æ‰§è¡Œ setup å‡½æ•°  const setupResult = callWithErrorHandling( setup, instance, ErrorCodes.SETUP_FUNCTION, [__DEV__ ? shallowReadonly(instance.props) : instance.props, setupContext] ); resetTracking(); currentInstance = null; // å¯¹setup ç»“æœå¤„ç†ï¼Œè¿”å›å€¼åªèƒ½æ˜¯å¯¹è±¡æˆ–å‡½æ•°  if (isPromise(setupResult)) { if (isSSR) { // return the promise so server-renderer can wait on it  return setupResult.then((resolvedResult: unknown) =\u0026gt; { handleSetupResult(instance, resolvedResult, isSSR); }); } else if (__FEATURE_SUSPENSE__) { // async setup returned Promise.  // bail here and wait for re-entry.  instance.asyncDep = setupResult; } else if (__DEV__) { // TODO warn  } } else { // setup() æ‰§è¡Œç»“æœåªèƒ½æ˜¯å‡½æ•°æˆ–å¯¹è±¡  // 1. å¦‚æœæ˜¯å¯¹è±¡ï¼Œè¿”å›å¯¹è±¡çš„æ‰€æœ‰å±æ€§å½“åšçŠ¶æ€å¤„ç†ï¼Œå’Œ data æ€§è´¨ç›¸åŒ  // 2. å¦‚æœæ˜¯å‡½æ•°ï¼Œè§†ä¸ºç»„ä»¶çš„ render å‡½æ•°  // å³ï¼Œæ”¯æŒåœ¨ setup ä¸­ç›´æ¥æ‰‹å†™ render å‡½æ•°  handleSetupResult(instance, setupResult, isSSR); } } else { // ...  } } // handleSetupResult export function handleSetupResult( instance: ComponentInternalInstance, setupResult: unknown, isSSR: boolean ) { // 1. å¦‚æœæ˜¯å‡½æ•°å½“åšrenderå‡½æ•°å¤„ç†  // 2. å¦‚æœæ˜¯å¯¹è±¡  if (isFunction(setupResult)) { // è¿”å›å†…è” render å‡½æ•°  if (__NODE_JS__ \u0026amp;\u0026amp; (instance.type as ComponentOptions).__ssrInlineRender) { // SSR æœåŠ¡ç«¯æ¸²æŸ“ï¼Œæ›¿æ¢ ssrRender å‡½æ•°  // when the function\u0026#39;s name is `ssrRender` (compiled by SFC inline mode),  // set it as ssrRender instead.  instance.ssrRender = setupResult; } else { instance.render = setupResult as InternalRenderFunction; } } else if (isObject(setupResult)) { // è¿”å› bindingsï¼Œè¿™äº›å˜é‡å¯ä»¥ç›´æ¥åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨  // æ³¨æ„è¿™é‡Œçš„ state æ˜¯ shallow refï¼Œå³éé€’å½’ reactive çš„  instance.setupState = proxyRefs(setupResult); } else { // warn å¿…é¡»è¿”å›å¯¹è±¡  } // æœ€åå®Œæˆrenderå‡½æ•°æ£€æŸ¥  // å¯èƒ½æ˜¯ SFCæƒ…å†µçš„ æ¨¡æ¿è¯­æ³•ï¼Œæ²¡æœ‰ç›´æ¥çš„renderå‡½æ•°ï¼Œéœ€è¦è¿›è¡Œ  // compile æ“ä½œç”Ÿæˆ instance.rendder = Component.renderå‡½æ•°  // render æ‰§è¡Œä¸æ˜¯è¿™é‡Œï¼Œè€Œæ˜¯åœ¨ instance.update çš„ effect å‡½æ•°ä¸­çš„  // renderComponentRoot ä¸­  finishComponentSetup(instance, isSSR); }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( async ({ h, render, nodeOps, serializeInner: inner, ref, nextTick, defineComponent, }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt;component setup return object\u0026#34;); let props, attrs; try { const Comp = defineComponent({ props: [\u0026#34;bar\u0026#34;], setup(_props, { attrs: _attrs }) { console.log(\u0026#34;setup...\u0026#34;); return () =\u0026gt; { props = _props; attrs = _attrs; }; }, }); render(h(Comp, { foo: 1, bar: 2 }), root); log([props, attrs]); render(h(Comp, { fooBar: 2, bar: 3, fooBaz: 4 }), root); log([props, attrs]); render(h(Comp, { qux: 5 }), root); log([props, attrs]); } catch (e) { log(e); } logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedroot: \u0026gt;\u0026gt;\u0026gt;component setup return object component stateful ? 4 call setup setup... [Function (anonymous)] render mount component normalize vnode patch component { bar: 2 } { foo: 1 } { bar: 2 } { foo: 1 } { bar: 2 } { foo: 1 } root:    component update   éœ€è¦ä¿®æ”¹ç‚¹ï¼š\n  åœ¨ processComponent ä¸­å¢åŠ  updateComponent æ›´æ–°ç»„ä»¶\n  åœ¨ instance.update effect å‡½æ•°ä¸­å¢åŠ  updateProps() diff-\u0026gt;update props\n   è¿™é‡Œä¸»è¦åŒ…å«äº† props çš„æ›´æ–°è§„åˆ™ï¼Œå¯¹äº children çš„ diff å’Œ update è§„åˆ™åˆ†æå¯ä»¥æŸ¥ çœ‹ patchKeyedChildren diff å’Œ æ›´æ–°åŸç†åˆ†æï¼\n ç»„ä»¶æ›´æ–°ï¼Œä»£ç æ‰§è¡Œæµç¨‹ï¼š\n çŠ¶æ€å˜æ›´ -\u0026gt; instance.update effect æ‰§è¡Œ -\u0026gt;\n å¦‚æœæœ‰ next vnode è§¦å‘ updateComponentPreRender() æ›´æ–° props å’Œ slots\n æ‰§è¡Œ beforeUpdate hook\n æ‰§è¡Œ onVnodeBeforeUpdate hook\n å¾—åˆ°æ–°æ ‘ğŸŒ² nextTree = renderComponentRoot(instance)\n è€æ ‘ğŸŒ² prevTree = instance.subTree\n è¿›è¡Œ patch(prevTree, nextTree) æ“ä½œ\n æ‰§è¡Œ updated hook å’Œ onVnodeUpdated hook\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( async ({ h, render, nodeOps, serializeInner: inner, ref, nextTick, defineComponent, }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); let oa = { a: 1 }, ob = { b: 1 }, i = 0, j = 0; const defaultFn = () =\u0026gt; (console.log(`fn called ${++i}`), oa); const defaultBaz = () =\u0026gt; (console.log(`baz called ${++j}`), ob); let proxy; logRoot(); try { const Comp = { props: { foo: { default: 1 }, bar: { default: defaultFn }, baz: { type: Function, default: defaultBaz }, }, render() { proxy = this; }, }; const print = (s) =\u0026gt; { log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; \u0026#34; + s); const prevBar = proxy.bar; log(\u0026#34;proxy.foo = \u0026#34; + proxy.foo); // å› ä¸ºæ—  typeï¼Œè€Œ default æ˜¯ä¸ªå‡½æ•°ï¼Œä¼šè¢«æ‰§è¡Œå¾—åˆ°ç»“æœ  log(\u0026#34;prevBar === oa: \u0026#34; + (prevBar === oa)); // å› ä¸º type Function ï¼Œæ‰€ä»¥default æ˜¯ Function çš„è¯ä¸ä¼šè¢«æ‰§è¡Œ  log(\u0026#34;proxy.baz === defaultBaz, \u0026#34; + (proxy.baz === defaultBaz)); log(\u0026#34;proxy.bar === prevBar, \u0026#34; + (proxy.bar === prevBar)); }; render(h(Comp, { foo: 2 }), root); print(\u0026#34;first\u0026#34;); // update  render(h(Comp, { foo: 3 }), root); print(\u0026#34;update\u0026#34;); } catch (e) { log(e.message); } }, (err) =\u0026gt; { console.log(err.message); } );    undefinedroot: { type: { props: { foo: [Object], bar: [Object], baz: [Object] }, render: [Function: render] }, shapeFlag: 4 } fn called 1 component stateful ? 4 call setup no setup [Function: render] render mount component update effect normalize vnode patch component { type: Symbol(Comment), shapeFlag: 0 } \u0026gt;\u0026gt;\u0026gt; first proxy.foo = 2 prevBar === oa: true proxy.baz === defaultBaz, true proxy.bar === prevBar, true { type: { props: { foo: [Object], bar: [Object], baz: [Object] }, render: [Function: render], __props: [ [Object], [Array] ] }, shapeFlag: 4 } update component should update component has changed props should update component.... normal update update effect component update update comp pre render normalize vnode Cannot read property \u0026#39;parentNode\u0026#39; of null   â“ æ²¡æœ‰è§¦å‘ instance.update ?\n fix: props update invalid Â· gcclll/stb-vue-next@3771bfb\n ä¿®å¤åï¼Œå›å»é‡æ–°æµ‹è¯•ã€‚\n  FIX å¢åŠ ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  const updateComponent = (n1: VNode, n2: VNode, optimized: boolean) =\u0026gt; { console.log(\u0026#34;update component\u0026#34;); const instance = (n2.component = n1.component)!; if (shouldUpdateComponent(n1, n2, optimized)) { console.log(\u0026#34;should update component....\u0026#34;); if ( __FEATURE_SUSPENSE__ \u0026amp;\u0026amp; instance.asyncDep \u0026amp;\u0026amp; // async setup  instance.asyncResolved ) { // ...  return; } else { // æ–°å¢ä»£ç ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹  // æ­£å¸¸æ›´æ–°  instance.next = n2; // è€ƒè™‘åˆ° child ç»„ä»¶å¯èƒ½æ­£åœ¨é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œç§»é™¤å®ƒé¿å…  // åœ¨åŒä¸€ä¸ª flush tick é‡å¤æ›´æ–°åŒä¸€ä¸ªå­ç»„ä»¶  // å½“ä¸‹ä¸€æ¬¡æ›´æ–°æ¥åˆ°æ—¶ï¼Œä¹‹å‰çš„ä¸€æ¬¡æ›´æ–°å–æ¶ˆï¼Ÿ  invalidateJob(instance.update); // instance.update æ˜¯åœ¨ setupRenderEffect ä¸­  // å®šä¹‰çš„ä¸€ä¸ª reactive effect runner  // ä¸»åŠ¨è§¦å‘æ›´æ–°  instance.update(); } return; } else { // ...  } };     â“ Cannot read property \u0026#39;parentNode\u0026#39; of null\n è¿™ä¸ªæŠ¥é”™å‘ç”Ÿåœ¨ instance.update effect çš„ else æ›´æ–°ç»„ä»¶ä¸­ï¼Œ\n patch(â€¦ hostParentNode(prevTree.el!)!, â€¦)\n çš„æ—¶å€™ï¼Œå»å–å€¼ prevTree.el å¾—åˆ°çš„æ˜¯ç©ºå€¼ï¼Œè¿›å…¥ hostParentNode è°ƒç”¨ node.parentNode æŠ¥é”™çš„ã€‚\n è¿™é‡Œä¸ºä»€ä¹ˆ prevTree.el æ˜¯ null ? æ›´æ–°çš„è¯ä¹‹å‰çš„ node ä¸åº”è¯¥å·²ç»åŠ è½½å¥½äº†å—ï¼Ÿ\n   component slots   feat(add): init\u0026amp;update slots Â· gcclll/stb-vue-next@a788430\n ä¿®æ”¹ç‚¹ï¼š\n  åˆå§‹åŒ–ï¼Œ setupComponent() ä¸­çš„ initSlots()\n  updateComponent() -\u0026gt; updateComponentPreRender() ä¸­ updateSlots() æ›´æ–° slots\n   å¯¹åº”åŠ¨ä½œï¼š init -\u0026gt; update\n å¯¹åº”ç»„ä»¶é˜¶æ®µï¼š åˆå§‹åŒ–(initSlots()) -\u0026gt; æ›´æ–°(updateSlots())\nåˆå§‹åŒ–(initSlots())ï¼š  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  export const initSlots = ( instance: ComponentInternalInstance, children: VNodeNormalizedChildren ) =\u0026gt; { if (instance.vnode.shapeFlag \u0026amp; ShapeFlags.SLOTS_CHILDREN) { const type = (children as RawSlots)._ if (type) { instance.slots = children as InternalSlots // make compiler marker non-enumerable  def(children as InternalSlots, \u0026#39;_\u0026#39;, type) } else { normalizeObjectSlots(children as RawSlots, (instance.slots = {})) } } else { instance.slots = {} if (children) { normalizeVNodeSlots(instance, children) } } def(instance.slots, InternalObjectKey, 1) }     è¦åˆ†ææ•´ä¸ªï¼Œéœ€è¦å›é¡¾ä¸‹ normalizeChildren(vnode, children) å¤„ç†é€»è¾‘ï¼Œè¦ææ¸…æ¥šä»€ä¹ˆ æƒ…å†µä¸‹ä¼šæ˜¯ SLOTS_CHILDREN ã€‚\n æ ¹æ® normalizeChildren() çš„å®ç°ä¸­ï¼Œå¯çŸ¥éœ€è¦æ»¡è¶³ä¸‹é¢å‡ ä¸ªæ¡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  if (isObject(vnode.children)) { if (isElement(vnode.shapeFlag) || isTELEPORT(vnode.shapeFlag)) { // default slot  } else { // é ELEMENT æˆ– TELEPORT ç±»å‹  // å¦‚ï¼š \u0026lt;Comp\u0026gt;\u0026lt;template v-slot:named\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/template\u0026gt;\u0026lt;/Comp\u0026gt;  // children åªæœ‰ä¸€ä¸ª template ä¼šè¢«è§£ææˆä¸€ä¸ª vnode å¯¹è±¡  // ä¸” vnode type æ˜¯ template  type = ShapeFlags.SLOTS_CHILDREN; } } else if (isFunction(vnode.children)) { // children æ˜¯ä¸ªå‡½æ•°  // å‡½æ•°å¼ç»„ä»¶ Comp = { render() {  // return h(\u0026#39;div\u0026#39;, null, () =\u0026gt; h(\u0026#39;div\u0026#39;) /* slot */)  // }}  type = ShapeFlags.SLOTS_CHILDREN; }      children = { _: ... } å†…éƒ¨æ’æ§½ï¼Ÿ\n  normalizeObjectSlots: children æ˜¯å¯¹è±¡ç±»å‹ï¼š\n {named: slotFn1, default: slotFn2 }\n éå†æ‰€æœ‰ key-value =\u0026gt;\n (æ¨è)å¦‚æœ value æ˜¯å‡½æ•°éœ€è¦å°† slotFn ç”¨ withCtx å°è£…ä¸€å±‚ï¼Œè®©å…¶åœ¨å½“å‰å®ä¾‹çš„ä¸Šä¸‹æ–‡ä¸­æ­£ç¡®âœ…æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9  const normalizeSlot = ( key: string, rawSlot: Function, ctx: ComponentInternalInstance | null | undefined ): Slot =\u0026gt; withCtx((props: any) =\u0026gt; { // warn: åœ¨ Render å‡½æ•°å¤–æ‰§è¡Œäº† slot function  return normalizeSlotValue(rawSlot(props)); }, ctx);     (ä¸æ¨è)å¦‚æœ value ä¸æ˜¯å‡½æ•°ï¼Œç»è¿‡\n1 2 3 4  const normalizeSlotValue = (value: unknown): VNode[] =\u0026gt; isArray(value) ? value.map(normalizeVNode) : [normalizeVNode(value as VNodeChild)]     å¤„ç†ä¹‹åè½¬æˆå‡½æ•°èµ‹å€¼ slots[key] = () =\u0026gt; normalized\n æœ€ç»ˆéƒ½æ˜¯å°† slot value è½¬æˆä¸€ä¸ªå‡½æ•°ä¿å­˜åˆ° instance.slots{} ä¸­\n  é SLOTS_CHILDREN ï¼Œé‚£åªæœ‰ä¸€ç§æƒ…å†µ\n children ä¸­æ²¡æœ‰ \u0026lt;template v-slot:named ...\u0026gt; ï¼Œæ­¤æ—¶å®ƒæ‰€æœ‰çš„ child éƒ½ä¼šè¢«å½“åš é»˜è®¤æ’æ§½æ¥å¤„ç†ã€‚\n1 2 3 4 5 6 7  const normalizeVNodeSlots = ( instance: ComponentInternalInstance, children: VNodeNormalizedChildren ) =\u0026gt; { const normalized = normalizeSlotValue(children); instance.slots.default = () =\u0026gt; normalized; };     å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { log, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( async ({ h, createVNode: c }) =\u0026gt; { log.br(); const Comp = { template: \u0026#34;\u0026lt;div/\u0026gt;\u0026#34; }; const slot = () =\u0026gt; {}; const node = h(Comp, slot); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; å‡½æ•°ä½œä¸º children è§£æä¸ºé»˜è®¤æ’æ§½\u0026#34;); log.f(node, [\u0026#34;children\u0026#34;, \u0026#34;type\u0026#34;]); log(node.children); } );    undefined \u0026gt;\u0026gt;\u0026gt; å‡½æ•°ä½œä¸º children è§£æä¸ºé»˜è®¤æ’æ§½ { type: { template: \u0026#39;\u0026lt;div/\u0026gt;\u0026#39; }, children: { default: [Function: slot], _ctx: null } } { default: [Function: slot], _ctx: null }      æ›´æ–°(updateSlots())   æ›´æ–°æ’æ§½æ­¥éª¤ï¼š\n  åˆå¹¶ instance.slots å’Œ children\n  ç„¶ååˆ é™¤ children ä¸­æ²¡æœ‰çš„æ’æ§½\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59  export const updateSlots = ( instance: ComponentInternalInstance, children: VNodeNormalizedChildren ) =\u0026gt; { const { vnode, slots } = instance; let needDeletionCheck = true; let deletionComparisonTarget = EMPTY_OBJ; console.log(\u0026#34;update slots\u0026#34;); // children æ˜¯ å‡½æ•°æˆ–å¯¹è±¡ç±»å‹(éæ•°ç»„)  if (vnode.shapeFlag \u0026amp; ShapeFlags.SLOTS_CHILDREN) { const type = (children as RawSlots)._; if (type) { console.log(\u0026#34;update slots type\u0026#34;); // compiled slots.  if (__DEV__ \u0026amp;\u0026amp; isHmrUpdating) { // TODO  } else if (type === SlotFlags.STABLE) { // compiled AND stable  // ä¸éœ€è¦æ›´æ–°ï¼Œè·³è¿‡ slots åˆ é™¤æ“ä½œ  needDeletionCheck = false; } else { // compiled but dynamic (v-if/v-for on slots)  // update slots, but skip normalization  extend(slots, children as Slots); } } else { console.log(\u0026#34;update slots no type\u0026#34;); needDeletionCheck = !(children as RawSlots).$stable; normalizeObjectSlots(children as RawSlots, slots); } // å¯¹è±¡ç±»å‹ç›´æ¥åˆå¹¶ï¼Œè¿™é‡Œè®°å½•éœ€è¦è¿›è¡Œåˆ é™¤æ“ä½œçš„å¯¹è±¡ï¼Œchildren  // ä¸Šé¢åªæ˜¯è¿›è¡Œäº†ç®€å•çš„å¯¹è±¡åˆå¹¶æ“ä½œ  // å¦‚ï¼š slots={a,b,d}, children = {a,b,c}  // åˆå¹¶ä¹‹åï¼š slots={a,b,c,d},åé¢éœ€è¦åˆ é™¤çš„æ˜¯ d è¿™ä¸ªæ’æ§½  deletionComparisonTarget = children as RawSlots; } else if (children) { // \u0026lt;Comp\u0026gt;...è¿™é‡Œæ²¡æœ‰ \u0026lt;template #named ...\u0026gt; æƒ…å†µ\u0026lt;/Comp\u0026gt;  // \u0026lt;Comp\u0026gt; é‡Œé¢çš„æ‰€æœ‰å†…å®¹éƒ½ä¼šè¢«å½“åšé»˜è®¤æ’æ§½æ¥è§£æ  console.log(\u0026#34;update slots children\u0026#34;); // non slot object children (direct value)  // passed to a component  // å½“åšé»˜è®¤æ’æ§½æ¥å¤„ç†ï¼Œè§£æåï¼š slots.default = () =\u0026gt; normalized  normalizeVNodeSlots(instance, children); // è¿™é‡Œç›®çš„æ˜¯ä¸ºäº†åªä¿ç•™ default å…¶ä»–éƒ½éœ€è¦åˆ é™¤  deletionComparisonTarget = { default: 1 }; } console.log({ needDeletionCheck }); // delete stale slots  // åˆ é™¤æ—§çš„ slots  if (needDeletionCheck) { for (const key in slots) { // é `_` å†…éƒ¨æ’æ§½ï¼Œä¸”ä¸å†æ–°çš„ children ä¸­çš„  if (!isInternalKey(key) \u0026amp;\u0026amp; !(key in deletionComparisonTarget)) { delete slots[key]; } } } };        props tests   ä¼ å…¥çš„ rawProps å’Œç»„ä»¶è‡ªèº«çš„ props ç»è¿‡å¤„ç†ä¹‹å(setFullProps()) ä¼šå°† rawProps æ ¹ æ®ä¸€å®šè§„åˆ™åˆ†æ´¾åˆ°ç»„ä»¶ props æˆ– attrs ä¸­å»ã€‚\n è¿™é‡Œçš„ rawProps ä»£è¡¨æ˜¯ parent åœ¨æ¸²æŸ“å­ç»„ä»¶çš„æ—¶å€™ä¼ é€’ç»™å®ƒçš„ props ï¼Œå¦‚ï¼š\n render(h(Child, { foo:1, bar:2}),root)\n ä¸­çš„ {foo:1,bar:2} å³ parent propsï¼Œç„¶åç»„ä»¶å¯ä»¥å®šä¹‰è‡ªèº«çš„ props å±æ€§ï¼š\n defineComponent({ props: [\u0026#39;foo\u0026#39;] }) æ„å‘³ç€ï¼Œè¯¥å­ç»„ä»¶åªæ¥å— \u0026#39;foo\u0026#39; ä½œä¸º props è€Œå…¶ä»–çš„ä¼šè¢«è§£ææˆ attrs ã€‚\n component props æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( async ({ h, render, nodeOps, serializeInner: inner, ref, nextTick, defineComponent, }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt;stateful\u0026#34;); let props, attrs, proxy; try { const Comp = defineComponent({ props: [\u0026#34;fooBar\u0026#34;, \u0026#34;barBaz\u0026#34;, \u0026#34;foo-baz\u0026#34;], render() { console.log(\u0026#34;comp render\u0026#34;); props = this.$props; attrs = this.$attrs; proxy = this; }, }); render(h(Comp, { fooBar: 1, bar: 2, fooBaz: 3 }), root); } catch (e) { log(e); } console.log(\u0026#34;proxy.fooBar=\u0026#34; + proxy.fooBar); log([props, attrs]); logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedroot: \u0026gt;\u0026gt;\u0026gt;stateful { type: { props: [ \u0026#39;fooBar\u0026#39;, \u0026#39;barBaz\u0026#39;, \u0026#39;foo-baz\u0026#39; ], render: [Function: render] }, shapeFlag: 4 } component stateful ? 4 call setup no setup [Function: render] render mount component update effect normalize vnode comp render patch component { type: Symbol(Comment), shapeFlag: 0 } proxy.fooBar=1 { fooBar: 1, fooBaz: 3 } { bar: 2 } root:    component unmount   feat(add): add unmount component Â· gcclll/stb-vue-next@79c5061\n ä¸»è¦å·¥ä½œï¼š\n  æ‰§è¡Œ beforeUnmount å‘¨æœŸå‡½æ•°\n  åœæ‰æ‰€æœ‰ effects ä¾èµ–\n  æ£€æŸ¥ update å‡½æ•°ï¼Œå¤„ç†åœ¨å¼‚æ­¥ update ä¹‹å‰æ‰§è¡Œäº† unmount\n  åœ¨ post queue ä¸­æ‰§è¡Œ unmounted å‘¨æœŸå‡½æ•°\n  åœ¨ post queue ä¸­æ ‡è®° instance.isUnmounted=true æ ‡è®°ç»„ä»¶å·²ç»å¸è½½äº†\n   ä¸‰ç§é˜Ÿåˆ—ä»»åŠ¡ï¼Œ pre, post, job æ‰§è¡Œé¡ºåºï¼š pre \u0026gt; job \u0026gt; postï¼Œè¯¦æƒ…æŸ¥çœ‹\n scheduler ä»»åŠ¡è°ƒåº¦æœºåˆ¶\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  const unmountComponent = ( instance: ComponentInternalInstance, parentSuspense: SuspenseBoundary | null, doRemove?: boolean ) =\u0026gt; { const { bum, effects, update, subTree, um } = instance; // beforeUnmount hook  if (bum) { invokeArrayFns(bum); } if (effects) { for (let i = 0; i \u0026lt; effects.length; i++) { stop(effects[i]); } } // update may be null if a component is unmounted before its async  // setup has resolved.  if (update) { stop(update); unmount(subTree, instance, parentSuspense, doRemove); } // unmounted hook  if (um) { queuePostRenderEffect(um, parentSuspense); } queuePostRenderEffect(() =\u0026gt; { instance.isUnmounted = true; }, parentSuspense); // TODO suspense };      normalize emits options   feat(add): props event init Â· gcclll/stb-vue-next@b918dde\n  é—®é¢˜  TypeError: Cannot read property \u0026#39;allowRecurse\u0026#39; of null  TypeError: Cannot read property \u0026#39;allowRecurse\u0026#39; of null at createReactiveEffect (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:251:39) at effect (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:199:22) at setupRenderEffect (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2738:29) at mountComponent (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2733:11) at processComponent (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2724:19) at patch (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2616:23) at render (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:3099:15) at /private/var/folders/1n/xw58p9v90tn42m87q527fvgr0000gn/T/babel-orafVD/js-script-Vmw0ga:29:5   å› ä¸ºå®ç°é—®é¢˜ï¼š\n1 2 3 4 5 6 7 8 9  instance.update = effect(function componentEffect() { // ç›‘å¬æ›´æ–°  if (!instance.isMounted) { // è¿˜æ²¡åŠ è½½å®Œæˆï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡ mount æ“ä½œ  // TODO  } else { // TODO  } }, __DEV__ ? /* TODO */ (null as any) : prodEffectOptions)     æ–‡å­—å†…çš„æµ‹è¯•æ˜¯åŸºäº node development ç¯å¢ƒæµ‹è¯•çš„ï¼Œè¿™é‡Œ effect options æ˜¯ null æ‰€ä»¥ æŠ¥é”™ã€‚\n fix: effect null options Â· gcclll/stb-vue-next@63675a4\n      processText|Comment|Static   feat(add): processText updte Â· gcclll/stb-vue-next@636e870 Â· GitHub\n æœ¬èŠ‚åŒ…å«(ä¸»è¦æºç ï¼Œæ²¡å•¥å¥½åˆ†æçš„)ï¼š\n  æ–‡æœ¬èŠ‚ç‚¹\n  æ³¨é‡ŠèŠ‚ç‚¹\n  é™æ€èŠ‚ç‚¹\n  Text  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const processText: ProcessTextOrCommentFn = (n1, n2, container, anchor) =\u0026gt; { if (n1 == null /* old */) { // æ–°èŠ‚ç‚¹ï¼Œæ’å…¥å¤„ç†  hostInsert( (n2.el = hostCreateText(n2.children as string)), container, anchor ); } else { // has old vnode, need to diff  const el = (n2.el = n1.el!); if (n2.children !== n1.children) { hostSetText(el, n2.children as string); } } };     å› ä¸ºåœ¨ compiler-core parse é˜¶æ®µçš„æ–‡æœ¬å¤„ç†ä¸­ï¼Œå¦‚æœæ˜¯å“é“ƒçš„æ–‡æœ¬èŠ‚ç‚¹ä¼šè¢«åˆå¹¶ï¼Œå¦‚ï¼š\n \u0026lt;div\u0026gt;{{ text1 }} {{ text2 }}\u0026lt;/div\u0026gt; æœ€ç»ˆä¼šåˆå¹¶ï¼š\n \u0026lt;div\u0026gt;{{ text1 + \u0026#39; \u0026#39; + text2 }}\u0026lt;/div\u0026gt; æœ€ç»ˆæ›¿æ¢çš„æ˜¯ \u0026lt;div/\u0026gt; æ•´ä¸ªå†…å®¹ã€‚\n  Comment   feat(add): process comment node Â· gcclll/stb-vue-next@4489366 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const processCommentNode: ProcessTextOrCommentFn = ( n1, n2, container, anchor ) =\u0026gt; { if (n1 == null) { hostInsert( (n2.el = hostCreateComment((n2.children as string) || \u0026#39;\u0026#39;)), container, anchor ) } else { // there\u0026#39;s no support for dynamic comments  n2.el = n1.el } }      Static   patch -\u0026gt; case Static:\n1 2 3 4 5 6 7  // case Static: if (n1 == null) { mountStaticNode(n2, container, anchor, isSVG); } else if (__DEV__) { patchStaticNode(n1, n2, container, isSVG); } // break      æ²¡æœ‰ old vnode -\u0026gt; mount\n æœ‰ old node -\u0026gt; patch\n mount:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const mountStaticNode = ( n2: VNode, container: RendererElement, anchor: RendererNode | null, isSVG: boolean ) =\u0026gt; { // static nodes are only present when used with compiler-dom/runtime-dom  // which guarantees presence of hostInsertStaticContent.  [n2.el, n2.anchor] = hostInsertStaticContent!( n2.children as string, container, anchor, isSVG ); };     mount æ—¶ç”¨åˆ°çš„ hostInsertStaticContent() æ˜¯åœ¨ runtime-dom åŒ…ä¸­å®ç°çš„ï¼Œå…ˆé¢„è§ˆä¸‹ ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function insertStaticContent(content, parent, anchor, isSVG) { const temp = isSVG ? tempSVGContainer || (tempSVGContainer = doc.createElementNS(svgNS, \u0026#34;svg\u0026#34;)) : tempContainer || (tempContainer = doc.createElement(\u0026#34;div\u0026#34;)); temp.innerHTML = content; const first = temp.firstChild as Element; let node: Element | null = first; let last: Element = node; while (node) { last = node; nodeOps.insert(node, parent, anchor); node = temp.firstChild as Element; } return [first, last]; }     å¯ä»¥çœ‹åˆ° temp.innerHTML = content ä¸€ä¸ªç®€å•çš„å†…å®¹å…¨æ›¿æ¢æ“ä½œã€‚\n patchStaticNode: å› ä¸ºé™æ€èŠ‚ç‚¹åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¼šè¢«æå‡ï¼Œé‡ç”¨ï¼Œå› æ­¤ä¸å­˜åœ¨ patch é˜¶æ®µã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  const patchStaticNode = ( n1: VNode, n2: VNode, container: RendererElement, isSVG: boolean ) =\u0026gt; { // static nodes are only patched during dev for HMR  if (n2.children !== n1.children) { const anchor = hostNextSibling(n1.anchor!); // remove existing  removeStaticNode(n1); // insert new  [n2.el, n2.anchor] = hostInsertStaticContent!( n2.children as string, container, anchor, isSVG ); } else { n2.el = n1.el; n2.anchor = n1.anchor; } };     moveStaticNode: åœ¨ diff -\u0026gt; update é˜¶æ®µ move() ä¸­è§¦å‘\n1 2 3 4 5 6 7 8 9 10 11 12 13  const moveStaticNode = ( { el, anchor }: VNode, container: RendererElement, nextSibling: RendererNode | null ) =\u0026gt; { let next; while (el \u0026amp;\u0026amp; el !== anchor) { next = hostNextSibling(el); hostInsert(el, container, nextSibling); el = next; } hostInsert(anchor!, container, nextSibling); };     removeStaticNode: remove() ä¸­è§¦å‘\n1 2 3 4 5 6 7 8 9  const removeStaticNode = ({ el, anchor }: VNode) =\u0026gt; { let next; while (el \u0026amp;\u0026amp; el !== anchor) { next = hostNextSibling(el); hostRemove(el); el = next; } hostRemove(anchor!); };        processFragment   Fragment çš„æƒ…å†µï¼š children æœ‰å¤šä¸ª child çš„æ—¶å€™ï¼Œä¼šç”¨ä¸€ä¸ª fragment äº‹å…ˆåŒ…èµ·æ¥ã€‚\n  STABLE_FRAGMENT æƒ…å†µï¼š\n  v-if\n é¦–å…ˆè¦æ»¡è¶³ children.length !== 1 å³æœ‰ä¸€ä¸ªä»¥ä¸Šçš„ children, å¦‚ï¼š\n \u0026lt;div\u0026gt;\u0026lt;p/\u0026gt;\u0026lt;p/\u0026gt;\u0026lt;/div\u0026gt;\n æˆ–è€…éç¬¬ä¸€ä¸ª child ELEMENT ç±»å‹ï¼Œå¦‚ï¼š\n \u0026lt;div\u0026gt;\u0026lt;Comp/\u0026gt;\u0026lt;/div\u0026gt;\n å…¶è¦æ»¡è¶³ (children.length === 1 \u0026amp;\u0026amp; firstChild.type === NodeTypes.FOR) å¦‚ï¼š\n \u0026lt;div v-for=\u0026#34;item in list\u0026#34;\u0026gt;\u0026lt;p/\u0026gt;\u0026lt;/div\u0026gt;\n æ‰ä¼šè¢«å½“åš PatchFlags.STABLE_FRAGMENT\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // vIf.ts  const needFragmentWrapper = children.length !== 1 || firstChild.type !== NodeTypes.ELEMENT; if (needFragmentWrapper) { if (children.length === 1 \u0026amp;\u0026amp; firstChild.type === NodeTypes.FOR) { // ...  } else { return createVNodeCall( // ...  PatchFlags.STABLE_FRAGMENT + (__DEV__ ? ` /* ${PatchFlagNames[PatchFlags.STABLE_FRAGMENT]}*/` : ``), // ...  ); } }      v-for\n1 2 3 4 5 6 7 8 9  // vFor.ts  const isStableFragment = forNode.source.type === NodeTypes.SIMPLE_EXPRESSION \u0026amp;\u0026amp; forNode.source.constType \u0026gt; 0 const fragmentFlag = isStableFragment ? PatchFlags.STABLE_FRAGMENT : keyProp ? PatchFlags.KEYED_FRAGMENT : PatchFlags.UNKEYED_FRAGMENT       æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88  const processFragment = ( n1: VNode | null, n2: VNode, container: RendererElement, anchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { const fragmentStartAnchor = (n2.el = n1 ? n1.el : hostCreateText(\u0026#39;\u0026#39;))! const fragmentEndAnchor = (n2.anchor = n1 ? n1.anchor : hostCreateText(\u0026#39;\u0026#39;))! let { patchFlag, dynamicChildren } = n2 if (patchFlag \u0026gt; 0) { optimized = true } if (__DEV__ \u0026amp;\u0026amp; isHmrUpdating) { // HMR updated, force full diff  patchFlag = 0 optimized = false dynamicChildren = null } if (n1 == null) { hostInsert(fragmentStartAnchor, container, anchor) hostInsert(fragmentEndAnchor, container, anchor) // fragment çš„ children åªä¼šæ˜¯ array children  // å› ä¸ºä»–ä»¬è¦ä¹ˆæ˜¯é€šè¿‡ compiler ç”Ÿæˆçš„ï¼Œè¦ä¹ˆæ˜¯ç”±æ•°ç»„åˆ›å»ºçš„  mountChildren( n2.children as VNodeArrayChildren, container, fragmentEndAnchor, parentComponent, parentSuspense, isSVG, optimized ) } else { if ( patchFlag \u0026gt; 0 \u0026amp;\u0026amp; patchFlag \u0026amp; PatchFlags.STABLE_FRAGMENT \u0026amp;\u0026amp; dynamicChildren \u0026amp;\u0026amp; // #2715 the previous fragment could\u0026#39;ve been a BAILed one as a result  // of renderSlot() with no valid children  n1.dynamicChildren ) { // a stable fragment (template root or \u0026lt;template v-for\u0026gt;) doesn\u0026#39;t need to  // patch children order, but it may contain dynamicChildren.  patchBlockChildren( n1.dynamicChildren, dynamicChildren, container, parentComponent, parentSuspense, isSVG ) if (__DEV__ \u0026amp;\u0026amp; parentComponent \u0026amp;\u0026amp; parentComponent.type.__hmrId) { traverseStaticChildren(n1, n2) } else if ( // #2080 if the stable fragment has a key, it\u0026#39;s a \u0026lt;template v-for\u0026gt; that may  // get moved around. Make sure all root level vnodes inherit el.  // #2134 or if it\u0026#39;s a component root, it may also get moved around  // as the component is being moved.  n2.key != null || (parentComponent \u0026amp;\u0026amp; n2 === parentComponent.subTree) ) { traverseStaticChildren(n1, n2, true /* shallow */) } } else { // keyed / unkeyed, or manual fragments.  // for keyed \u0026amp; unkeyed, since they are compiler generated from v-for,  // each child is guaranteed to be a block so the fragment will never  // have dynamicChildren.  patchChildren( n1, n2, container, fragmentEndAnchor, parentComponent, parentSuspense, isSVG, optimized ) } } }      TELEPORT   feat(init): Teleport Â· gcclll/stb-vue-next@0fcfa32 Â· GitHub\n æ–°å¢ä»£ç :   TeleportImpl: ç»„ä»¶æ¨¡æ¿\n1 2 3 4 5 6 7  export const TeleportImpl = { __isTeleport: true, process() {}, remove() {}, move: moveTeleport, hydrate: hydrateTeleport }     resolveTarget: æ ¹æ®é€‰æ‹©å™¨æ‰¾åˆ°ç›®æ ‡å…ƒç´ \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const resolveTarget = \u0026lt;T = RendererElement\u0026gt;( props: TeleportProps | null, select: RendererOptions[\u0026#39;querySelector\u0026#39;] ): T | null =\u0026gt; { const targetSelector = props \u0026amp;\u0026amp; props.to if (isString(targetSelector)) { if (!select) { // æ— æ•ˆé€‰æ‹©å™¨  return null } else { const target = select(targetSelector) // Teleport è®¾ç½®å¤±è´¥  return target as any } } else { // æ— æ•ˆçš„ Teleport ç›®æ ‡  return targetSelector as any } }     moveTeleport: æ‰§è¡Œç§»åŠ¨\n1 2 3 4 5 6 7 8 9  function moveTeleport( vnode: VNode, container: RendererElement, parentAnchor: RendererNode | null, { o: { insert }, m: move }: RendererInternals, moveType: TeleportMoveTypes = TeleportMoveTypes.REORDER ) { // TODO }     hydrateTeleport:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function hydrateTeleport( node: Node, vnode: TeleportVNode, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, optimized: boolean, { o: { nextSibling, parentNode, querySelector } }: RendererInternals\u0026lt;Node, Element\u0026gt;, hydrateChildren: ( node: Node | null, vnode: VNode, container: Element, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, optimized: boolean ) =\u0026gt; Node | null ): Node | null { return vnode.anchor \u0026amp;\u0026amp; nextSibling(vnode.anchor as Node) }     å¯¼å‡ºç»„ä»¶ ~Teleport~ï¼š\n1 2 3 4  // Force-casted public typing for h and TSX props inference export const Teleport = (TeleportImpl as any) as { __isTeleport: true new (): { $props: VNodeProps \u0026amp; TeleportProps }      process()  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72  function process(/*çœç•¥å‚æ•°*/) { // ...  const disabled = isTeleportDisabled(n2.props); const { shapeFlag, children } = n2; if (n1 == null) { // insert anchors in the main view  // \u0026lt;container\u0026gt;\u0026lt;placeholder/\u0026gt;\u0026lt;anchor/\u0026gt;\u0026lt;/container\u0026gt;  insert(placeholder, container, anchor); // \u0026lt;container\u0026gt;\u0026lt;main-anchor/\u0026gt;\u0026lt;anchor/\u0026gt;\u0026lt;/container\u0026gt;  insert(mainAnchor, container, anchor); // æ ¹æ®é€‰æ‹©å™¨ \u0026lt;Teleport to=\u0026#34;selector\u0026#34;/\u0026gt; selector  // æ‰¾åˆ°ç›®æ ‡ DOM å…ƒç´   const target = (n2.target = resolveTarget(n2.props, querySelector)); // \u0026lt;target\u0026gt;\u0026lt;!-- \u0026#39;\u0026#39; --\u0026gt;\u0026lt;/target\u0026gt;ï¼Œç”¨æ¥ä½œä¸ºæ’å…¥æ—¶çš„å‚è€ƒèŠ‚ç‚¹  const targetAnchor = (n2.targetAnchor = createText(\u0026#34;\u0026#34;)); if (target) { insert(targetAnchor, target); // #2652 we could be teleporting from a non-SVG tree into an SVG tree  isSVG = isSVG || isTargetSVG(target); } /* else if warn ... */ const mount = (container: RendererElement, anchor: RendererNode) =\u0026gt; { // å°† vnode children æ¸²æŸ“åˆ° target å…ƒç´ å†…  // ä¼šæ’å…¥åˆ° anchor çš„å‰é¢,å¦‚ï¼š ~\u0026lt;target\u0026gt;\u0026lt;children/\u0026gt;\u0026lt;!--\u0026#39;\u0026#39;--\u0026gt;\u0026lt;/target\u0026gt;~  }; if (disabled) { // å¤±æ•ˆçŠ¶æ€ï¼Œä¸ç›´æ¥æ¸²æŸ“åˆ°ç›®æ ‡å…ƒç´ ä¸­ï¼Œè€Œæ˜¯æŒ‚åœ¨äº† #app å†…å¯¹åº”çš„  // èŠ‚ç‚¹é‡Œé¢ï¼Œç­‰å¾…çŠ¶æ€ enable å†æ¸²æŸ“å› target å…ƒç´   mount(container, mainAnchor); } else if (target) { // ç›´æ¥æ¸²æŸ“è¿›ç›®æ ‡å…ƒç´   mount(target, targetAnchor); } } else { // update content  // éé¦–æ¬¡æ¸²æŸ“  n2.el = n1.el; // å·²ç»æ¸²æŸ“åˆ° tar  if (n2.dynamicChildren) { // åŠ¨æ€å­èŠ‚ç‚¹ patch  } else if (!optimized) { // patch n1|n2 children  } if (disabled) { // n2 new teleport disabled -\u0026gt; n1 old target enabled  // n2 ç›´æ¥ç§»åˆ° #app ç»“æ„ä¸­çš„ container ä¸Šï¼Œæš‚æ—¶ä¸ç›´æ¥æ¸²æŸ“åˆ°  // ç›®æ ‡å…ƒç´ ä¸Š  if (!wasDisabled) { // moveTeleport  } } else { // target changed  // teleport çš„ to å±æ€§å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰¾åˆ°æ–°çš„ç›®æ ‡  // è¿›è¡Œç§»åŠ¨  if ((n2.props \u0026amp;\u0026amp; n2.props.to) !== (n1.props \u0026amp;\u0026amp; n1.props.to)) { // 1. æ‰¾æ–°ç›®æ ‡  // 2. å°† n2 ç§»åŠ¨åˆ°æ–°çš„ç›®æ ‡ä¸­  // ...  } else if (wasDisabled) { // çŠ¶æ€å˜æ›´  // disabled -\u0026gt; enabled  // move into teleport target  // ä» container ä¸­å°† n2 ç§»åˆ°ç›®æ ‡å…ƒç´ ä¸­  } } } }     å¯¹äº teleport çš„ mount å’Œ update ä¸¤ä¸ªå…±åŒç‚¹(ä¹Ÿæ˜¯é‡ç‚¹)ï¼š\n  å½“ new teleport æ˜¯ disabled æ—¶ï¼Œä¸ç›´æ¥æ¸²æŸ“åˆ°ç›®æ ‡å…ƒç´ ä¸­ï¼Œè€Œæ˜¯æŒ‚åœ¨å½“å‰ container ä¸­å¾…ç”¨\n  å½“ new teleport çŠ¶æ€ enabled æ—¶ï¼Œä¸è®º old ä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½ä¼šè®²æ–°çš„ teleport children æ¸²æŸ“åˆ°ç›®æ ‡å…ƒç´ ä¸‹é¢ã€‚\n   Teleport çš„ç§»åŠ¨ç±»å‹æœ‰ï¼š\n  TARGET_CHANGE ç›®æ ‡å‘ç”Ÿäº†å˜åŒ–ï¼Œ teleport çš„ to å±æ€§å˜åŒ–\n1 2 3 4  // move target anchor if this is a target change. if (moveType === TeleportMoveTypes.TARGET_CHANGE) { insert(vnode.targetAnchor!, container, parentAnchor); }      TOGGLE çŠ¶æ€å‘ç”Ÿäº†å˜åŒ– enable -\u0026gt; disable æˆ– disable -\u0026gt; enable\n  REORDER ç›®æ ‡å…ƒç´ å†…è¿›è¡Œé‡æ–°æ’åº ?\n1 2 3 4  // move main view anchor if this is a re-order. if (isReorder) { insert(anchor!, container, parentAnchor); }        TODO æµ‹è¯•  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, Teleport, nodeOps, serializeInner: inner, ref }) =\u0026gt; { const target = nodeOps.createElement(\u0026#34;div\u0026#34;); const root = nodeOps.createElement(\u0026#34;div\u0026#34;); try { render( h(() =\u0026gt; [ h(Teleport, { to: target }, h(\u0026#34;div\u0026#34;, \u0026#34;teleported\u0026#34;)), h(\u0026#34;div\u0026#34;, \u0026#34;root\u0026#34;), ]), root ); } catch (e) { console.log(e.message); } log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; root\u0026#34;, inner(root)]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; target\u0026#34;, inner(target)]); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedcomponent stateful ? 0 mount component update effect patch component \u0026gt;\u0026gt;\u0026gt; root \u0026gt;\u0026gt;\u0026gt; target   â“ æ²¡ç»“æœï¼ï¼ï¼ï¼ï¼ï¼\n     SUSPENSE   feat(add): suspense Â· gcclll/stb-vue-next@fd651ab\n Suspense ç»„ä»¶å’Œ Teleport ä¸€æ ·çš„ç»„ç»‡ç»“æ„å’Œä½¿ç”¨æ–¹å¼\n ç»“æ„ï¼š\n1 2 3 4  var Tmpl = { __isSuspense: true, process() {} }     ç„¶ååœ¨ process ä¸­å¤„ç† mount æˆ– patch æµç¨‹ï¼Œè¿™é‡Œé¢å’Œæ™®é€šæ ‡ç­¾æˆ–æ™®é€šç»„ä»¶çš„å¤„ç†æ˜¯ä¸€ æ ·çš„ï¼Œ mount or patchã€‚\n ä¸‹é¢æ¥çœ‹ä¸‹è¿™ä¸ªç»„ä»¶æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒåŠŸèƒ½åˆæ˜¯å¦‚ä½•ï¼Ÿ\n æ–°å¢å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // 1. æ¨¡æ¿ // æ ¹æ®æ³¨é‡Šè¯´æ˜ï¼Œä¹‹æ‰€ä»¥é‡‡ç”¨è¿™ç§ç»“æ„æ˜¯ä¸ºäº†èƒ½è®© Suspense é€‚ç”¨ tree-shaking export const SuspenseImpl = { __isSuspense: true, process(n1: VNode | null, n2: VNode /*...*/) { if (n1 == null) { // mount  } else { // patch  } }, hydrate: hydrateSuspense, create: createSuspenseBoundary, }; // 2. mountSuspense // 3. patchSuspense      åˆ—è¡¨ï¼š\n   åç§° æè¿°     SuspenseImpl -   mountSuspense() -   patchSuspense() -   SuspenseBoundary -   createSuspenseBoundary() -   hydrateSuspense() -     è„‘å›¾ï¼š\n  é‡ç‚¹é€»è¾‘ï¼š\n  Suspense çš„æ¸²æŸ“è½¬æŠ˜ç‚¹å‘ç”Ÿåœ¨ mountComponent ä¸­ï¼Œå°† setupRenderEffect åšäº† ä¸€æ¬¡å°è£…ï¼Œè®©å…¶åœ¨ setup() è¿”å›çš„ Promise çŠ¶æ€å®Œæˆä¹‹åå»æ‰§è¡Œ\n  åœ¨æ•´ä¸ª Suspense mount æˆ– patch è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨äº† suspense.deps æ¥è®°å½•å¼‚æ­¥äº‹ä»¶ï¼Œ åªæœ‰å½“è¿™ä¸ªå€¼ä¸º 0 çš„æ—¶å€™è¯´æ˜å¯ä»¥è¿›è¡Œè§£æå¹¶æŒ‚åœ¨åˆ°çœŸå®DOMä¸Šäº†(æ¯”å¦‚. æœåŠ¡å™¨ç«¯æ•° æ®è¯·æ±‚å®Œæˆ)\n   SuspenseBoundary æ•°æ®ç»“æ„   åªåˆ—å‡ºéƒ¨åˆ†ä¸ Suspense å…³è”æ€§å¼ºçš„å­—æ®µï¼š\n   åç§° æè¿°     vnode VNode ç»“æ„   hiddenContainer -   activeBranch è¯·æ±‚å®Œæˆä¹‹åæ˜¾ç¤ºçš„ç»„ä»¶åˆ†æ”¯ #default   pendingBranch è¯·æ±‚ä¸­æ˜¾ç¤ºçš„åˆ†æ”¯ #fallback   deps ç»„ä»¶ä¾èµ–   timeout è¶…æ—¶æ—¶é—´   isInFallback -   isHydrating -   effects [] ä¾èµ–åˆ—è¡¨   resolve(force) -   fallback() å‚æ•°ï¼š fallbackVnode   move() -   next() -   registerDep() æ³¨å†Œå®ä¾‹ä¾èµ–    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  export interface SuspenseBoundary { vnode: VNode\u0026lt;RendererNode, RendererElement, SuspenseProps\u0026gt;; parent: SuspenseBoundary | null; parentComponent: ComponentInternalInstance | null; isSVG: boolean; container: RendererElement; hiddenContainer: RendererElement; anchor: RendererNode | null; activeBranch: VNode | null; pendingBranch: VNode | null; deps: number; pendingId: number; timeout: number; isInFallback: boolean; isHydrating: boolean; isUnmounted: boolean; effects: Function[]; resolve(force?: boolean): void; fallback(fallbackVNode: VNode): void; move( container: RendererElement, anchor: RendererNode | null, type: MoveType ): void; next(): RendererNode | null; registerDep( instance: ComponentInternalInstance, setupRenderEffect: SetupRenderEffectFn ): void; unmount(parentSuspense: SuspenseBoundary | null, doRemove?: boolean): void; }      mountSuspense()   feat(add): suspense mount Â· gcclll/stb-vue-next@802b9ad\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  function mountSuspense() { const { p: patch, o: { createElement }, } = rendererInternals; const hiddenContainer = createElement(\u0026#34;div\u0026#34;); const suspense = (vnode.suspense = createSuspenseBoundary( vnode, parentSuspense, parentComponent, container, hiddenContainer, anchor, isSVG, optimized, rendererInternals )); // start mounting the content subtree in an off-dom container  patch( null, (suspense.pendingBranch = vnode.ssContent!), hiddenContainer, null, parentComponent, suspense, isSVG ); // now check if we have encountered any async deps  if (suspense.deps \u0026gt; 0) { // has async  // mount the fallback tree  patch( null, vnode.ssFallback!, container, anchor, parentComponent, null, // fallback tree will not have suspense context  isSVG ); setActiveBranch(suspense, vnode.ssFallback!); } else { // Suspense has no async deps. Just resolve.  suspense.resolve(); } } // è®¾ç½®æ¿€æ´»çš„ branch function setActiveBranch(suspense: SuspenseBoundary, branch: VNode) { suspense.activeBranch = branch; const { vnode, parentComponent } = suspense; const el = (vnode.el = branch.el); // in case suspense is the root node of a component,  // recursively update the HOC el  if (parentComponent \u0026amp;\u0026amp; parentComponent.subTree === vnode) { parentComponent.vnode.el = el; updateHOCHostEl(parentComponent, el); } }      åˆ›å»ºä¸€ä¸ª DOM ä¹‹åçš„ divï¼Œå³è¿˜æ²¡æ¸²æŸ“åˆ° DOM ç»“æ„ä¸­çš„\n  æ„å»º Suspense ç»„ä»¶ç»“æ„ï¼Œè¿™ä¸ªç»“æ„é VNode ï¼Œè€Œæ˜¯æŒ‚åœ¨ vnode.suspense ä¸Šçš„ä¸€ä¸ª SuspenseBoundary ç»“æ„\n  å¼€å§‹ mount å†…å®¹é‡Œçš„å­æ ‘\n  æ£€æµ‹ Suspense æœ‰æ²¡å¼‚æ­¥ä¾èµ–ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éœ€è¦å…ˆè§£æè¿™äº›å¼‚æ­¥ä¾èµ–ï¼Œå®Œæˆä¹‹åå†æ¿€æ´» branch\n  æ²¡æœ‰å¼‚æ­¥ä¾èµ–ç›´æ¥æ‹¿åˆ°ç»“æœè§£æå‡ºç»„ä»¶\n   ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œé¢éœ€è¦é‡ç‚¹å…³æ³¨çš„å…¶å®æ˜¯â€œæœ‰æ²¡å¼‚æ­¥ä¾èµ–çš„é—®é¢˜â€ã€‚\n æ²¡æœ‰ä¾èµ–çš„æ—¶å€™ç”¨åˆ°äº† suspense.resolve() è¿™ä¸ªåº”è¯¥æ˜¯å°†åˆ›å»ºçš„ off-dom div æŒ‚åˆ°çœŸ å® DOM ä¸Šå»ã€‚\n  suspense.resolve()  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88  function resolve(resume = false) { const { vnode, activeBranch, pendingBranch, pendingId, effects, parentComponent, container, } = suspense; if (suspense.isHydrating) { suspense.isHydrating = false; } else if (!resume) { // 1. transition æ”¯æŒï¼Œå°† move() æ“ä½œæ³¨å†Œåˆ° afterLeave å›è°ƒ  // 2. å¸è½½å½“å‰çš„ subTree å¯èƒ½æ˜¯ fallback  // 3. ä¸æ˜¯ transition dely enter è¿›è¡Œ move()  // è¿™é‡Œæœ€åæ‰§è¡Œçš„æ“ä½œå°±æ˜¯ move() å¦‚æœæ˜¯ transition delay enter  // åˆ™å°† move() æ³¨å†Œåˆ° afterLeaveï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œ move() å°† suspense  // å†…å®¹æ¸²æŸ“åˆ°çœŸå®DOMä¸Š  const delayEnter = activeBranch \u0026amp;\u0026amp; pendingBranch!.transition \u0026amp;\u0026amp; pendingBranch!.transition.mode === \u0026#34;out-in\u0026#34;; if (delayEnter) { activeBranch!.transition!.afterLeave = () =\u0026gt; { if (pendingId === suspense.pendingId) { move(pendingBranch!, container, anchor, MoveType.ENTER); } }; } // this is initial anchor on mount  let { anchor } = suspense; // unmount current active tree  if (activeBranch) { // if the fallback tree was mounted, it may have been moved  // as part of a parent suspense. get the latest anchor for insertion  anchor = next(activeBranch); unmount(activeBranch, parentComponent, suspense, true); } if (!delayEnter) { // move content from off-dom container to actual container  move(pendingBranch!, container, anchor, MoveType.ENTER); } } // æ ‡è®°å½“å‰æ¿€æ´»çŠ¶æ€çš„åˆ†æ”¯ï¼Œæ­¤æ—¶æ˜¯ #default  setActiveBranch(suspense, pendingBranch!); suspense.pendingBranch = null; suspense.isInFallback = false; // flush buffered effects  // check if there is a pending parent suspense  // æ³¨å†Œçš„ effect å¤„ç†ï¼Œè¿™é‡Œçš„å¤„ç†è¯´æ˜äº† suspense çš„çˆ¶å­ä¾èµ–æ‰§è¡Œ  // çš„é¡ºåºé—®é¢˜ï¼Œ effects æ˜¯æŒ‰ç…§æ•°ç»„åŠ å…¥é¡ºåºæ‰§è¡Œçš„(è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ reactivity æ–‡ç« )  // æ‰€ä»¥ effects çš„ä¼˜å…ˆçº§æ˜¯è‡ªä¸Šè€Œä¸‹çš„ï¼Œå³ parent-parent \u0026gt; parent \u0026gt; children  let parent = suspense.parent; let hasUnresolvedAncestor = false; while (parent) { if (parent.pendingBranch) { // found a pending parent suspense, merge buffered post jobs  // into that parent  parent.effects.push(...effects); hasUnresolvedAncestor = true; break; } parent = parent.parent; } // no pending parent suspense, flush all jobs  // å¦‚æœæ²¡æœ‰æŒ‚èµ·çš„ parent suspense ç›´æ¥ flush æ‰æ‰€æœ‰ä»»åŠ¡  // ç»“åˆä¸Šé¢çš„ while ä¸¾ä¾‹ï¼š  // CompA -\u0026gt; CompB -\u0026gt; CompC  // å½“è§£æåˆ° CompC æ—¶ï¼Œä¸€ç›´å¾€ä¸Šæ£€æµ‹ B å’Œ A å¦‚æœ B æœ‰æŒ‚èµ·çš„ä»»åŠ¡  // C è¿™é‡Œçš„ä»»åŠ¡ä¸ä¼šè¢« flushï¼Œè€Œæ˜¯åŠ å…¥åˆ° B çš„é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ  // ç„¶å C è§£æå®Œæˆï¼Œå›æº¯åˆ° B çš„è§£æï¼Œæ­¤æ—¶åˆéµå¾ªåŒä¸€å¥—è§„åˆ™æ£€æµ‹ A çš„  // æŒ‚èµ·ä»»åŠ¡ï¼Œç›´åˆ°æœ€åè¦ä¹ˆç«‹å³æ‰§è¡Œ B çš„ä»»åŠ¡è¦ä¹ˆ B çš„ä»»åŠ¡ä¹ŸåŠ å…¥åˆ° A  // æœ€åç”± A æ‰§è¡Œæ‰€æœ‰çš„ä»»åŠ¡(åŒ…å«å­ suspense çš„)  if (!hasUnresolvedAncestor) { queuePostFlushCb(effects); } suspense.effects = []; // invoke @resolve event  const onResolve = vnode.props \u0026amp;\u0026amp; vnode.props.onResolve; if (isFunction(onResolve)) { onResolve(); } }     åˆ†æå¦‚ä¸Šé¢çš„æ³¨é‡Šï¼Œ resolve() ä¸»è¦ç›®çš„å°±æ˜¯å°† off-dom div ä¸Šçš„ suspense ç»„ä»¶åœ¨å¼‚ æ­¥äº‹ä»¶å®Œæˆåæ ¹æ®ç»“æœè§£æå‡ºå¯¹åº”çš„åˆ†æ”¯ï¼Œå°†è¿™ä¸ªåˆ†æ”¯æŒ‚è½½åˆ°çœŸå®çš„ DOM ä¸Šå»ï¼ŒåŒæ—¶æ¿€æ´» å®ƒ(æ˜¾ç¤ºå‡ºæ¥)ã€‚\n å…¶ä»–å¤„ç†ï¼š\n  transition çš„å»¶è¿Ÿè¿›å…¥å¤„ç†ï¼Œé€šè¿‡å°† move() æ“ä½œæ³¨å†Œåˆ° afterLeave() å›è°ƒå®ç°\n  effects ä»»åŠ¡å¤„ç†ï¼Œè¿™é‡Œçš„ä»»åŠ¡å¤„ç†æœºåˆ¶æ˜¯ï¼š\n åªæœ‰åœ¨ parent æ²¡æœ‰ä»»ä½•æŒ‚èµ·çš„ä»»åŠ¡æ—¶å€™æ‰ä¼šç«‹å³å¾—åˆ°æ‰§è¡Œï¼Œå¦åˆ™åªä¼šè¿›è¡Œåˆå¹¶æ“ä½œã€‚\n   å› ä¸ºä»£ç æœ€åéœ€è¦æ‰§è¡Œ move() æ“ä½œå°† #default æ›¿æ¢ #fallback ï¼Œæ‰€ä»¥ä¸‹é¢å…ˆå® ç° suspense.move() å†æ¥æµ‹è¯•ã€‚\n  suspense.move()   å®ç°è¿™ä¸ª move æœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦ä¿®æ”¹\n  SuspenseBoundary ä¸­çš„ move()\n1 2 3 4 5 6 7  var foo = { move(container, anchor, type) { suspense.activeBranch \u0026amp;\u0026amp; move(suspense.activeBranch, container, anchor, type); suspense.container = container; }, };      renderer.ts ä¸­çš„ move() å‡½æ•°ï¼Œå®ç° SUSPENSE ç»„ä»¶çš„å¤„ç†\n1 2 3 4 5 6 7 8 9 10  const move = () =\u0026gt; { // ...  // SUSPENSE  if (__FEATURE_SUSPENSE__ \u0026amp;\u0026amp; shapeFlag \u0026amp; ShapeFlags.SUSPENSE) { console.log(\u0026#34;move suspense\u0026#34;); vnode.suspense!.move(container, anchor, moveType); return; } // ... };      å¦å¤– mountComponent ä¸­æ¼äº†å¯¹ SUSPENSE çš„å¤„ç†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  const mountComponent = () =\u0026gt; { // ... create instance  // ... setupComponent  // setup() æ˜¯ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œè¿”å›äº† promise ï¼Œåœ¨ setupComponent  // ä¸­ä¼šå°† setup æ‰§è¡Œç»“æœèµ‹å€¼ç»™ instance.asyncDepï¼Œå³ SUSPENSE å¤„ç†  if (__FEATURE_SUSPENSE__ \u0026amp;\u0026amp; instance.asyncDep) { // å°† setupRenderEffect æ³¨å†Œåˆ° parent deps è¿™é‡Œçš„ deps  // æ‰§è¡Œç”±ä¸€å®šçš„è§„åˆ™, å¦‚æœ parent suspense æ²¡æœ‰ç»“æŸï¼Œchild deps  // ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯å°†å®ƒä»¬åˆå¹¶åˆ° parent suspense deps ä¸­ç­‰å¾… parent çŠ¶æ€å®Œæˆäº†æ‰ä¼šæ‰§è¡Œï¼Œå¯¹äº  // parent deps ä¹Ÿéµå¾ªè¿™ä¸ªè§„åˆ™ï¼Œç›´åˆ°æ²¡æœ‰æœªå®Œæˆçš„ parent suspenseä¸ºæ­¢  parentSuspense \u0026amp;\u0026amp; parentSuspense.registerDep(instance, setupRenderEffect); // è¿™é‡Œç­‰äºæ˜¯è¯´å…ˆç”¨ä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹å ä½ï¼Œç­‰å¼‚æ­¥å®Œæˆä¹‹åæ›¿æ¢  if (!initialVNode.el) { const placeholder = (instance.subTree = createVNode(Comment)); processCommentNode(null, placeholder, container!, anchor); } return; } // ... setupRenderEffect SUSPENSE ä¸ä¼šè¿›å…¥åˆ°è¿™é‡Œ  };       æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( async ({ nextTick, h, render, nodeOps, serializeInner: inner, ref, Suspense, }) =\u0026gt; { log.br() const deps = []; function defineAsyncComponent(comp, delay = 0) { return { setup(props, { slots }) { const p = new Promise((resolve) =\u0026gt; { setTimeout(() =\u0026gt; { resolve(() =\u0026gt; h(comp, props, slots)); }, delay); }); deps.push(p.then(() =\u0026gt; Promise.resolve())); return p; }, }; } const Async = defineAsyncComponent({ render() { return h(\u0026#34;div\u0026#34;, \u0026#34;async\u0026#34;); }, }); const Comp = { setup() { return () =\u0026gt; h(Suspense, null, { default: h(Async), fallback: h(\u0026#34;div\u0026#34;, \u0026#34;fallback\u0026#34;), }); }, }; const root = nodeOps.createElement(\u0026#34;div\u0026#34;); try { render(h(Comp), root); } catch (e) { console.log(e); } console.log(\u0026#34;before\u0026#34;); console.log(inner(root)); await Promise.all(deps); await nextTick(); console.log(\u0026#34;after\u0026#34;); console.log(inner(root)); }, (err) =\u0026gt; { console.log(err); } );    undefined component stateful ? 4 call setup [Function (anonymous)] render mount component update effect normalize vnode patch component component stateful ? 4 call setup mount component process element mount elment { shapeFlag: 9 } before \u0026lt;div\u0026gt;fallback\u0026lt;/div\u0026gt; [Function (anonymous)] render update effect normalize vnode patch component component stateful ? 4 call setup no setup [Function: render] render mount component update effect normalize vnode patch component process element mount elment { shapeFlag: 9 } moving... move component moving... move component moving... move host insert after \u0026lt;div\u0026gt;async\u0026lt;/div\u0026gt;   â“. ç»“æœå‘ç°å¹¶æ²¡å˜åŒ–ï¼Ÿï¼Ÿï¼Ÿ\nbefore \u0026lt;!----\u0026gt; after \u0026lt;!----\u0026gt;   æ—¢æ²¡æœ‰æ¸²æŸ“ fallback ä¹Ÿæ²¡æœ‰æ¸²æŸ“ default çš„ï¼Œä¸ºä½•ï¼Ÿ\n  ä¸Šé¢çš„ç¬¬äºŒç‚¹æœ‰è¯´åˆ°åœ¨ renderer.ts çš„ mountComponent() ä¸­å¢åŠ äº†å¯¹ SUSPENSE çš„å¤„ç†ï¼Œè¿™é‡Œé¢æœ‰ä¸ªæ³¨å†Œä¾èµ–çš„åŠ¨ä½œï¼Œè¿™é‡Œæ³¨å†Œçš„æ˜¯ setupRenderEffect å‡½æ•°ï¼Œè¿™ä¸ªå‡½ æ•°æ­£æ˜¯ç”¨æ¥ mount \u0026amp; update ç»„ä»¶çš„ï¼Œè€Œåœ¨ components/Suspense.ts ä¸­å¹¶æ²¡æœ‰å®ç°ï¼Œæ‰€ ä»¥é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œäº†ï¼ï¼ï¼\n FIXï¼š suspense.registerDep()\n  suspense.registerDep()   feat(add): suspense registerDeps Â· gcclll/stb-vue-next@e0fa81e\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  function registerDep(instance, setupRenderEffect) { const isInPendingSuspense = !!suspense.pendingBranch; if (isInPendingSuspense) { suspense.deps++; } const hydratedEl = instance.vnode.el; // æ•è· setup æ‰§è¡Œçš„å¼‚å¸¸ï¼Œæˆ–æ¥å—æ‰§è¡Œçš„ç»“æœ  instance .asyncDep!.catch((err) =\u0026gt; { handleError(err, instance, ErrorCodes.SETUP_FUNCTION); }) .then((asyncSetupResult) =\u0026gt; { // å½“ setup() çš„ promise çŠ¶æ€å˜æ›´ä¹‹åé‡è¯•  // å› ä¸ºåœ¨è§£æä¹‹å‰ç»„ä»¶å¯èƒ½å·²ç»è¢«å¸è½½äº†  if ( instance.isUnmounted || suspense.isUnmounted || suspense.pendingId !== instance.suspenseId ) { return; } // ä»è¯¥ç»„ä»¶å¼€å§‹é‡è¯•ï¼ŒçŠ¶æ€æ ‡è®°ä¸ºå·²ç»å®Œæˆ  instance.asyncResolved = true; const { vnode } = instance; handleSetupResult(instance, asyncSetupResult, false); if (hydratedEl) { // è™šæ‹ŸèŠ‚ç‚¹å¯èƒ½åœ¨ async dep çŠ¶æ€å®Œæˆä¹‹å‰è¢«æŸä¸ªæ›´æ–°æ›¿æ¢æ‰äº†  vnode.el = hydratedEl; } const placeHolder = !hydratedEl \u0026amp;\u0026amp; instance.subTree.el; setupRenderEffect( instance, vnode, // ç»„ä»¶å¯èƒ½åœ¨ resolve ä¹‹å‰è¢«ç§»é™¤äº†  // å¦‚æœè¿™ä¸ªä¸æ˜¯ä¸€ä¸ª hydrationï¼Œinstance.subTree å°†ä¼šæ˜¯ä¸ªæ³¨é‡Š  // å ä½èŠ‚ç‚¹  parentNode(hydratedEl || instance.subTree.el!), hydratedEl ? null : next(instance.subTree), suspense, isSVG, optimized ); if (placeHolder) { remove(placeHolder); } updateHOCHostEl(instance, vnode.el); // only decrease deps count if suspense is not already resolved  // æ²¡æœ‰ä»»ä½•ä¾èµ–äº†å°±å¼€å§‹è§£æ Suspense  if (isInPendingSuspense \u0026amp;\u0026amp; --suspense.deps === 0) { suspense.resolve(); } }); }     è¿™ä¸ªå‡½æ•°ä¸»è¦å®ç°ç‚¹ï¼š\n  æ¥å— setup() æ‰§è¡Œçš„ç»“æœ(Promise) asyncSetupResult å¹¶æ•è·å¼‚å¸¸ï¼Œå¯¹ç»“æœè¿›è¡Œ åˆ†æå¤„ç†\n  æ£€æµ‹ç»„ä»¶æ˜¯ä¸æ˜¯å·²ç»å¸è½½äº†ï¼Œæˆ–è€… suspense è¢«ç§»é™¤ï¼Œå°±ä¸éœ€è¦ç»§ç»­å¤„ç†äº†ï¼Œé€€å‡ºå³å¯\n1 2 3 4 5 6 7  if ( instance.isUnmounted || suspense.isUnmounted || suspense.pendingId !== instance.suspenseId ) { return; }      ä½¿ç”¨ handleSetupResult(instance, asyncSetupResult, false) å¤„ç† setup æ‰§è¡Œç»“ æœï¼Œåˆ°åº•æ˜¯ render è¿˜æ˜¯çŠ¶æ€ï¼Œéœ€è¦è§£æ\n  ç„¶åæ‰§è¡Œ setupRenderEffect æ‰§è¡Œç»„ä»¶çš„ mount æˆ– update æ“ä½œ\n  ç§»é™¤å ä½çš„æ³¨é‡ŠèŠ‚ç‚¹\n  suspense.deps æ‰§è¡Œå®Œæˆä¹‹åå°±å¯ä»¥å¼€å§‹è§£æ suspense ç»„ä»¶ è¿›è¡Œ move æ“ä½œäº†ã€‚\n    patchSuspense()   suspense.unmount\u0026amp;fallback\u0026amp;å…¶ä»–   feat(add): suspense unmount \u0026amp; fallbackâ€¦ Â· gcclll/stb-vue-next@080898d\n æ–°å¢ï¼š\n  patchSuspense() å’Œå…¶ä»–æ™®é€šç±»å‹çš„å¤„ç†å·®ä¸å¤šï¼Œæ— éå°±æ˜¯æ£€æµ‹ old å’Œ new branch çš„ ç±»å‹ï¼Œè¿›è¡Œ patch()ï¼ŒæœŸé—´è§¦å‘ onPending äº‹ä»¶\n  suspense.fallback() å¤„ç†ï¼Œå½“å¼‚æ­¥äº‹ä»¶æœªå®Œæˆæ—¶æ˜¾ç¤ºçš„ #fallback åˆ†æ”¯å¤„ç†ï¼ŒæœŸé—´ è§¦å‘ onFallback äº‹ä»¶\n  suspense.unmount() æ£€æµ‹ activeBranch å’Œ pendingBranch å…ˆå¸è½½ active éšåå¸è½½ pending åˆ†æ”¯(å‰ææ˜¯å­˜åœ¨çš„æƒ…å†µä¸‹)\n    Suspense ç»„ä»¶æµ‹è¯•  1 2  // `/js/vue/tests/Suspense.js\u0026#39; require(process.env.BLOG_DIR_VUE + \u0026#34;/tests/Suspense.js\u0026#34;);      å°ç»“   SUSPENSE ç»„ä»¶çš„å¤§è‡´æ‰§è¡Œæµç¨‹\n  patch è¿›å…¥ switch default æ£€æµ‹åˆ° shapeFlag æ˜¯ SUSPENSE\n  è°ƒç”¨ type.process(n1,n2,â€¦) å¤„ç† Suspense ç»„ä»¶ï¼Œæ ¹æ® n1 å†³å®šæ˜¯ mountSuspense è¿˜æ˜¯ patchSuspense è¿™é‡Œå’Œå…¶ä»–ç±»å‹ç»„ä»¶å¤„ç†é€»è¾‘ä¸€è‡´\n  é¦–æ¬¡(mount), è¿›è¡Œ mountSuspense åˆ›å»º Suspense ç»„ä»¶ï¼Œå¯¹ pendingBranch è¿›è¡Œ patch æ“ä½œ (æŒ‚åœ¨åˆ°ä¸€ä¸ªéDOMæ ‘ä¸­çš„ \u0026#39;div\u0026#39; å…ƒç´ (off-dom)ï¼Œå¾…ç”¨)ï¼Œå³å¼‚æ­¥æ“ä½œè¿˜æœªå®Œæˆæ—¶æ˜¾ç¤º çš„åˆ†æ”¯ï¼Œå¦‚ï¼š #fallback\n  éé¦–æ¬¡(update)ï¼Œè¿›è¡Œ patchSuspense å¯¹æ¯”æ–°æ—§çš„ branch è¿›è¡Œ patch\n   è¦ç‚¹ï¼šåœ¨ mountComponent() ä¸­ä¸æ˜¯ç›´æ¥è°ƒç”¨ setupRenderEffect() è€Œæ˜¯è°ƒ ç”¨ suspense.registerDep() å»å¤„ç† setup æ‰§è¡Œçš„ç»“æœ(instance.asyncDep)ï¼Œå®ƒæ˜¯ ä¸ªPromise åœ¨å…¶åçš„ then() ä¸­æ¥å— setup æ‰§è¡Œç»“æœï¼Œç„¶åå¼€å§‹è°ƒç”¨ setupRenderEffect mount æˆ– update å­æ ‘èŠ‚ç‚¹ï¼Œå¾… suspense ä¸Šçš„æ‰€æœ‰ä¾èµ–éƒ½å®Œæˆä¹‹åå¼€å§‹ resolve() Suspense ç»„ä»¶å°†å…¶æŒ‚åœ¨åˆ°çœŸå®çš„ DOM ä¸­ã€‚\n åŸç†ï¼š setup() è¿”å› Promiseï¼Œrender è¿‡ç¨‹ä¸­æ³¨å†Œæ¸²æŸ“å‡½æ•°ï¼Œå¾… promise çŠ¶æ€å®Œæˆè°ƒç”¨ then æ¥å—å¼‚æ­¥ç»“æœæ¥æ¸²æŸ“ Suspense ç»„ä»¶(ä»»åŠ¡ä¸º post ç±»å‹)ã€‚\n     KEEP_ALIVE   feat(add): keep-alive render Â· gcclll/stb-vue-next@a192cb4\n KeepAlive ç»„ä»¶çš„ render å…¥å£åœ¨ processComponent() ä¸­ï¼Œå½“ n1 == null æƒ…å†µä¸‹ï¼Œ ä¼šå»æ£€æµ‹è¯¥ç»„ä»¶æ˜¯ä¸æ˜¯ keep-alive ç±»å‹ï¼Œå¦‚æœæ˜¯ç›´æ¥è°ƒç”¨ activate() æ¿€æ´»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // 17. processComponent const processComponent = ( /*...*/) =\u0026gt; { if (n1 == null) { // mount - if (false /* keep alive */) { - // TODO + if (n2.shapeFlag \u0026amp; ShapeFlags.COMPONENT_KEPT_ALIVE) { + ;(parentComponent!.ctx as KeepAliveContext).activate( + n2, + container, + anchor, + isSVG, + optimized + )      unmount æ“ä½œæ—¶ï¼Œå¦‚æœæ˜¯ keep-alive ç›´æ¥è°ƒç”¨ deactivate() å¤±æ•ˆï¼Œè€Œä¸æ˜¯çœŸæ­£çš„ä» DOM ç§»é™¤ã€‚\n feat(add): keep-alive render unmount Â· gcclll/stb-vue-next@024b24b\n1 2 3 4 5 6 7 8 9 10  const unmount: UnmountFn = (...) =\u0026gt; { // ... - // TODO keep-alive - // keep-alive + if (shapeFlag \u0026amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE) { + ;(parentComponent!.ctx as KeepAliveContext).deactivate(vnode) + return + } // ... }      åœ¨ mountComponent() ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11  // 18. mountComponent const mountComponent: MountComponentFn = (...) =\u0026gt; { const instance: ComponentInternalInstance = (initialVNode.component = createComponentInstance( initialVNode, parentComponent, parentSuspense )) + if (isKeepAlive(initialVNode)) { + ;(instance.ctx as KeepAliveContext).renderer = internals + }      è¿™é‡Œå°† keep-alive ç»„ä»¶çš„ setup() å‡½æ•°ä¸­ç”¨åˆ°çš„ä¸€äº› renderer å‡½æ•°ä¿å­˜å¼•ç”¨åˆ° ctx.renderer ä¸Šä¾›åé¢ setup() ä¸­ä½¿ç”¨ã€‚\n1 2 3 4 5 6  instance.ctx.renderer: { p: patch, m: move, um: _unmount, o: { createElement } }     keep-alive ä½œä¸ºå†…éƒ¨ç»„ä»¶ï¼Œå†…ç½®äº† setup() å‡½æ•°çš„å®ç°ï¼Œæ‰€ä»¥åœ¨\n patch -\u0026gt; processComponent -\u0026gt; mountComponent -\u0026gt; setupComponent\n æ—¶è°ƒç”¨çš„å°±æ˜¯è¿™ä¸ªå†…ç½®çš„ setup() å‡½æ•°ã€‚\n setup() å‡½æ•°ä½“å¤§è‡´ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function setup(props: KeepAliveProps, { slots }: SetupContext) { const cache: Cache = new Map(); const keys: Keys = new Set(); let current: VNode | null = null; const instance = getCurrentInstance()!; const parentSuspense = instance.suspense; const sharedContext = instance.ctx as KeepAliveContext; const { renderer: { p: patch, m: move, um: _unmount, o: { createElement }, }, } = sharedContext; const storageContainer = createElement(\u0026#34;div\u0026#34;); sharedContext.activate = (vnode, container, anchor, isSVG, optimized) =\u0026gt; {}; sharedContext.deactivate = (vnode: VNode) =\u0026gt; {}; // å¯¹ renderer unmount çš„ä¸€æ¬¡å°è£…  function unmount(vnode: VNode) {} // è¿‡æ»¤æ‰ç¼“å­˜  function pruneCache(filter?: (name: string) =\u0026gt; boolean) {} function pruneCacheEntry(key: CacheKey) {} // TODO ç›‘å¬ include/exclude å±æ€§å˜åŒ–  // TODO åœ¨ render ä¹‹åç¼“å­˜å­æ ‘(subTree)  // TODO æ³¨å†Œç”Ÿå‘½å‘¨æœŸ  return () =\u0026gt; { // è¯¥å‡½æ•°è§£æå‡ºåŸå§‹ VNode èŠ‚ç‚¹è¿”å›  }; }     ä¸Šé¢ä»£ç æä¾›äº†ä¸€ä¸‹ä¿¡æ¯ï¼š\n  activate \u0026amp; deactivate() å‡½æ•°æ˜¯æŒ‚åœ¨ VNode çš„ ctx ä¸Šçš„ï¼Œå¹¶ä¸”æ˜¯åœ¨ setup() è°ƒ ç”¨æœŸé—´äº§ç”Ÿ\n  ç¼“å­˜æœºåˆ¶\n  åªæ³¨å†Œäº† mounted, unmounted, update å£°æ˜å‘¨æœŸ\n  æœ€åè¿”å›çš„å‡½æ•°å¯ä»¥å¾—åˆ°æœ€åŸå§‹çš„ VNode èŠ‚ç‚¹\n   æ³¨æ„çœ‹ processComponent() ä¸­çš„åˆ¤æ–­:\n if (n2.shapeFlag \u0026amp; ShapeFlags.COMPONENT_KEPT_ALIVE) { activate() }\n è€Œ COMPONENT_KEPT_ALIVE æ ‡è®°çš„èµ‹å€¼åˆæ˜¯å‘ç”Ÿåœ¨ setup() å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äº keep-alive ç»„ä»¶é¦–æ¬¡åŠ è½½ä¸ä¼šè¿›å…¥åˆ° activate() è€Œæ˜¯ç›´æ¥æŒ‰ç…§æ™®é€šç»„ä»¶å¤„ç†è°ƒç”¨ mountComponent() å»è°ƒç”¨ setup() åˆå§‹åŒ–è¯¥ keep-alive ç»„ä»¶çš„ä¸€äº›å‡½æ•°ç­‰(å…¶ä¸­ å°±åŒ…å« activate å’Œ deactivate() å‡½æ•°)\n å½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶æ ¹æ®ç‰¹å®šæ¡ä»¶æœ€åæ‰§è¡Œæ¿€æ´»æ‰ä¼šå»è°ƒç”¨ activate() è€Œä¸æ˜¯è¿›å…¥ mountComponent()\n activate()   feat(add): keep-alive ctx.activate Â· gcclll/stb-vue-next@267fdbd\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  sharedContext.activate = (vnode, container, anchor, isSVG, optimized) =\u0026gt; { const instance = vnode.component!; move(vnode, container, anchor, MoveType.ENTER, parentSuspense); // props å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œè¿™é‡Œæ‰§è¡Œä¸€æ¬¡ patch æ“ä½œ  patch( instance.vnode, vnode, container, anchor, instance, parentSuspense, isSVG, optimized ); queuePostRenderEffect(() =\u0026gt; { instance.isDeactivated = false; if (instance.a) { // activated å‘¨æœŸå‡½æ•°  invokeArrayFns(instance.a); } const vnodeHook = vnode.props \u0026amp;\u0026amp; vnode.props.onVnodeMounted; if (vnodeHook) { invokeVNodeHook(vnodeHook, instance.parent, vnode); } }, parentSuspense); };     æ¿€æ´» keep-alive ç»„ä»¶çš„å‡½æ•°ï¼Œåªæœ‰å½“éé¦–æ¬¡çš„æ—¶å€™ï¼ŒçŠ¶æ€å‘ç”Ÿå˜æ›´æ—¶ä¼šè¢«è°ƒç”¨ï¼Œæ³¨æ„ä¸Š é¢çš„ä»»åŠ¡ç±»å‹ post ï¼Œå‘¨æœŸå‡½æ•°çš„è°ƒç”¨æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œä¼šåœ¨ä¸‹ä¸€ä¸ª tick ä¸­èµ‹å€¼ã€‚\n  deactivate()   feat(add): keep-alive ctx.deactivate Â· gcclll/stb-vue-next@b340d57\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  sharedContext.deactivate = (vnode: VNode) =\u0026gt; { const instance = vnode.component!; move(vnode, storageContainer, null, MoveType.LEAVE, parentSuspense); queuePostRenderEffect(() =\u0026gt; { if (instance.da) { invokeArrayFns(instance.da); } const vnodeHook = vnode.props \u0026amp;\u0026amp; vnode.props.onVnodeUnmounted; if (vnodeHook) { invokeVNodeHook(vnodeHook, instance.parent, vnode); } instance.isDeactivated = true; }, parentSuspense); };     å¦‚æœçœ‹è¿™é‡Œå¤±æ´»çŠ¶æ€ä¸‹ç»„ä»¶æ˜¯å¦‚ä½•è¿›è¡Œæ›´æ–°çš„ï¼Ÿ\n storageContainer æ˜¯åœ¨ setup ä¸­åˆ›å»ºçš„ä¸€ä¸ªç©ºçš„ off-dom div å…ƒç´ ï¼Œè¿™é‡Œç­‰äºæ˜¯å½“ç»„ ä»¶å¤±æ´»æ—¶ä¼šå°† keep-alive å…ˆæŒ‚è½½åˆ°è¿™ä¸ª off-dom div ä¸Šå».\n  unmount()   feat(add): keep-alive unmount Â· gcclll/stb-vue-next@4ce0b9b\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // å¯¹ renderer unmount çš„ä¸€æ¬¡å°è£… function unmount(vnode: VNode) { resetShapeFlag(vnode); _unmount(vnode, instance, parentSuspense); } function resetShapeFlag(vnode: VNode) { let shapeFlag = vnode.shapeFlag; if (shapeFlag \u0026amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE) { shapeFlag -= ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE; } if (shapeFlag \u0026amp; ShapeFlags.COMPONENT_KEPT_ALIVE) { shapeFlag -= ShapeFlags.COMPONENT_KEPT_ALIVE; } vnode.shapeFlag = shapeFlag; }      include \u0026amp; exclude props   feat(add): keep-alive include \u0026amp; exclude props Â· gcclll/stb-vue-next@fdcc306\n ä¸»è¦å¢åŠ ä¸¤ä¸ªå‡½æ•°å®ç°ï¼Œä¸€ä¸ªç›‘å¬åŠ¨ä½œ(watch([include, exclude],...)):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  // è¿‡æ»¤æ‰ç¼“å­˜ function pruneCache(filter?: (name: string) =\u0026gt; boolean) { cache.forEach((vnode, key) =\u0026gt; { const name = getComponentName(vnode.type as ConcreteComponent); if (name \u0026amp;\u0026amp; (!filter || !filter(name))) { pruneCacheEntry(key); } }); } function pruneCacheEntry(key: CacheKey) { const cached = cache.get(key) as VNode; if (!current || cached.type !== current.type) { // æ–°å¢æˆ–èŠ‚ç‚¹ç±»å‹å‘ç”Ÿå˜åŒ–ï¼Œç›´æ¥å¸è½½æ‰è€çš„  unmount(cached); } else if (current) { // é‡ç½®æ ‡è®°å°±å¯ä»¥äº†ï¼Ÿ  // å½“å‰æ¿€æ´»çš„å®ä¾‹ä¸è¯¥å†æ˜¯ kept-alive  // æˆ‘ä»¬ä¸èƒ½ç«‹å³å¸è½½ä½†æ˜¯ç¨åä¼šè¿›è¡Œå¸è½½ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆé‡ç½®å…¶æ ‡è®°  // ä¸èƒ½ç«‹å³å¸è½½ï¼Ÿ  // æ˜¯å› ä¸ºåœ¨ activate å’Œ deactivate ä¸­çš„å‘¨æœŸå‡½æ•°è°ƒç”¨  // æ˜¯é‡‡ç”¨çš„ post ç±»å‹å¼‚æ­¥æ‰§è¡Œçš„ç¼˜æ•…å—ï¼Ÿ  resetShapeFlag(current); } cache.delete(key); keys.delete(key); } // ç›‘å¬ include/exclude å±æ€§å˜åŒ– watch( () =\u0026gt; [props.include, props.exclude], ([include, exclude]) =\u0026gt; { // æ”¯æŒä¸‰ç§ç±»å‹  // 1. å­—ç¬¦ä¸², \u0026#39;a,b,c\u0026#39;  // 2. æ­£åˆ™è¡¨è¾¾å¼ï¼Œ /a|b|c/  // 3. æ•°ç»„ï¼Œ [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;, /d|e/]  include \u0026amp;\u0026amp; pruneCache((name) =\u0026gt; matches(include, name)); exclude \u0026amp;\u0026amp; pruneCache((name) =\u0026gt; !matches(exclude, name)); }, { flush: \u0026#34;post\u0026#34;, deep: true } );     include æŒ‡å®šéœ€è¦ç¼“å­˜çš„ç»„ä»¶åç§°\n exclude æŒ‡å®šä¸éœ€è¦è¿›è¡Œç¼“å­˜çš„ç»„ä»¶åç§°\n ç±»å‹ï¼š String, RegExp, Array\n  cache subtree   feat(add): keep-alive cache subtree Â· gcclll/stb-vue-next@efb7577\n å¯¹ \u0026lt;keep-alive/\u0026gt; çš„å­©å­èŠ‚ç‚¹ğŸŒ²è¿›è¡Œç¼“å­˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  // åœ¨ render ä¹‹åç¼“å­˜å­æ ‘(subTree) let pendingCacheKey: CacheKey | null = null; const cacheSubtree = () =\u0026gt; { if (pendingCacheKey != null) { cache.set(pendingCacheKey, getInnerChild(instance.subTree)); } }; // æ³¨å†Œç”Ÿå‘½å‘¨æœŸ onMounted(cacheSubtree); onUpdated(cacheSubtree); onBeforeUnmount(() =\u0026gt; { cache.forEach((cached) =\u0026gt; { const { subTree, suspense } = instance; const vnode = getInnerChild(subTree); if (cached.type === vnode.type) { // æœ‰ç¼“å­˜çš„èŠ‚ç‚¹  // å½“å‰å®ä¾‹ä¼šæˆä¸º keep-alive çš„ unmount ä¸€éƒ¨åˆ†  resetShapeFlag(vnode); // ä½†æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œå®ƒçš„ deactivated é’©å­å‡½æ•°  const da = vnode.component!.da; da \u0026amp;\u0026amp; queuePostRenderEffect(da, suspense); return; } // æ²¡æœ‰ç¼“å­˜çš„ç›´æ¥ unmount  unmount(cached); }); });     åœ¨ \u0026lt;keep-alive/\u0026gt; å¸è½½ä¹‹å‰å°†å·²ç»ç¼“å­˜ deactivated é’©å­å‡½æ•°æ¨å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œï¼Œæ²¡ æœ‰ç¼“å­˜çš„ç›´æ¥è°ƒç”¨ unmount() å¸è½½æ‰ã€‚\n  setup() -\u0026gt; render å‡½æ•°   feat(add): keep-alive return render function Â· gcclll/stb-vue-next@9b75803\n åœ¨ setupComponent() ä¸­ï¼Œæœ€åè°ƒç”¨ setup() å¾—åˆ° setupResult ï¼Œæœ€åä¼šå°†è¿™ä¸ª setupResult ä¼ é€’ç»™ handleSetupResult() å»å¤„ç†ï¼Œè¿”å›ç»“æœï¼Œè¿™é‡Œé¢å½“æ£€æµ‹åˆ° setupResult æ˜¯ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¼šè¢«å½“åšæ˜¯ instance.render å‡½æ•°å¤„ç†ã€‚\n å³ï¼Œè¿™é‡Œçš„ setupResult æ˜¯ \u0026lt;keep-alive/\u0026gt; ç»„ä»¶ children çš„ render å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103  function setup() { // ...  return () =\u0026gt; { // è¯¥å‡½æ•°è§£æå‡ºåŸå§‹ VNode èŠ‚ç‚¹è¿”å›  // æ ¹æ®ç»„ä»¶çš„æ‰§è¡Œæµç¨‹ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¼šåœ¨ setupComponent() ä¸­  // æ‰§è¡Œ setup() å¾—åˆ° setupResult ï¼Œä¼ é€’ç»™ handleSetupResult()  // å‡½æ•°ï¼Œè¿™é‡Œé¢æ£€æµ‹ setupResult ä¹Ÿå°±æ˜¯è¿™ä¸ªåŒ¿åå‡½æ•°ï¼Œå¦‚æœå®ƒæ˜¯å‡½æ•°  // ä¼šç›´æ¥è¢«å½“åš render å‡½æ•°å¤„ç†(instance.render æˆ– instance.ssrRender)  // ç»“è®ºå°±æ˜¯ï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°æ˜¯ render() å‡½æ•°  pendingCacheKey = null; if (!slots.default) { // ç»„ä»¶æ”¯æŒé»˜è®¤æ’æ§½ä½¿ç”¨æ–¹å¼  return null; } const children = slots.default(); const rawVNode = children[0]; if (children.length \u0026gt; 1) { // KeepAlive ç»„ä»¶åªèƒ½åŒ…å«ä¸€ä¸ªç»„ä»¶ä½œä¸º child  // ä¹Ÿå°±æ˜¯è¯´ ~\u0026lt;keep-alive\u0026gt;\u0026lt;CompA/\u0026gt;\u0026lt;CompB/\u0026gt;\u0026lt;/keep-alive/\u0026gt;~  // æ˜¯ä¸åˆæ³•çš„ä½¿ç”¨  current = null; // warn...  return children; } else if ( !isVNode(rawVNode) || (!(rawVNode.shapeFlag \u0026amp; ShapeFlags.STATEFUL_COMPONENT) \u0026amp;\u0026amp; !(rawVNode.shapeFlag \u0026amp; ShapeFlags.SUSPENSE)) ) { // 1. é VNode ç±»å‹èŠ‚ç‚¹  // 2. æ—¢ä¸æ˜¯æœ‰çŠ¶æ€ç»„ä»¶(å¯¹è±¡ç±»å‹ç»„ä»¶)ä¹Ÿä¸æ˜¯ Suspense çš„æ—¶å€™  // ç›¸åæ„å‘³ç€ï¼ŒèŠ‚ç‚¹å¿…é¡»æ»¡è¶³ä¸‹é¢å‡ ç§æƒ…å†µ  // 1. æ˜¯ VNode ç±»å‹ä¸”æ˜¯æœ‰çŠ¶æ€ç»„ä»¶(éå‡½æ•°å¼ç»„ä»¶)  // 2. æˆ–è€…æ˜¯ VNode ç±»å‹ä¸”æ˜¯Suspense ç»„ä»¶  current = null; return rawVNode; } // ä¹Ÿå°±æ˜¯è¯´ keep-alive åªæ¥å—æœ‰çŠ¶æ€ç»„ä»¶æˆ–è€… Suspense ä½œä¸ºå”¯ä¸€çš„ child  let vnode = getInnerChild(rawVNode); const comp = vnode.type as ConcreteComponent; const name = getComponentName(comp); const { include, exclude, max } = props; if ( // æ— ç¼“å­˜çš„èŠ‚ç‚¹  (include \u0026amp;\u0026amp; (!name || !matches(include, name))) || // åœ¨ä¸ç¼“å­˜çš„èŠ‚ç‚¹ä»¬ä¹‹åˆ—  (exclude \u0026amp;\u0026amp; name \u0026amp;\u0026amp; matches(exclude, name)) ) { current = vnode; return rawVNode; } const key = vnode.key == null ? comp : vnode.key; const cachedVNode = cache.get(key); // å…‹éš†ä¸€ä»½å¦‚æœå®ƒæœ‰è¢«å¤ç”¨çš„è¯ï¼Œå› ä¸ºæˆ‘ä»¬å³å°†ä¿®æ”¹å®ƒ  if (vnode.el) { vnode = cloneVNode(vnode); if (rawVNode.shapeFlag \u0026amp; ShapeFlags.SUSPENSE) { rawVNode.ssContent = vnode; } } pendingCacheKey = key; if (cachedVNode) { vnode.el = cachedVNode.el; vnode.component = cachedVNode.component; if (vnode.transition) { // åœ¨ subTree ä¸Šé€’å½’æ›´æ–° transition é’©å­å‡½æ•°  setTransitionHooks(vnode, vnode.transition!); } // é¿å… vnode æ­£åœ¨é¦–æ¬¡ mount  vnode.shapeFlag |= ShapeFlags.COMPONENT_KEPT_ALIVE; // æ ‡è®° key ä¸ºæœ€æ–°çš„  keys.delete(key); keys.add(key); } else { // æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µ  keys.add(key); // åˆ é™¤æœ€è€çš„ entryï¼Œç¼“å†²æ± å·²ç»æ»¡äº†ï¼Œåˆ é™¤æ‰æœ€è€çš„é‚£ä¸ª  if (max \u0026amp;\u0026amp; keys.size \u0026gt; parseInt(max as string, 10)) { // å› ä¸º Set æ²¡æœ‰ç›´æ¥å–æŒ‡å®šä½ç½®å…ƒç´ çš„å€¼  // è¿™é‡Œçš„ç›®çš„æ˜¯å˜ç›¸çš„å– Set ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå³æœ€æ—© add çš„é‚£ä¸ª key  // å¦‚ï¼š new Set([1,2,3,4]) =\u0026gt; keys.values() =\u0026gt; \u0026lt;1,2,3,4\u0026gt;  // next() å¾—åˆ°è¿­ä»£å™¨ä¸‹ä¸€ä¸ªå€¼ { value: 1, done: false }  // .value å¾—åˆ°ç¬¬ä¸€ä¸ªé›†åˆå…ƒç´ çš„å€¼  pruneCacheEntry(keys.values().next().value); } } // é¿å… vnode æ­£åœ¨è¢«å¸è½½ï¼Œåœ¨renderer unmount ä¸­ä¼šæ£€æµ‹  vnode.shapeFlag |= ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE; current = vnode; return rawVNode; }; }     æœ€åè¿”å›çš„æ˜¯ children[0] èŠ‚ç‚¹ã€‚\n é‡Œé¢æœ‰ä¸ªç½®ä½æ ‡è¯†å€¼å¾—æ³¨æ„ï¼š ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE\n è¿™ä¸ªä½œç”¨æ˜¯å•¥ï¼Ÿ\n  unmount() ä¸­è°ƒç”¨ deactivate() çš„æ¡ä»¶\n1 2 3 4 5  // keep-alive if (shapeFlag \u0026amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE) { (parentComponent!.ctx as KeepAliveContext).deactivate(vnode); return; }      instance.update çš„ effect ä¸­è§¦å‘ activated å‘¨æœŸå‡½æ•°çš„æ¡ä»¶\n1 2 3 4 5 6 7  // activated hook for keep-alive roots. // #1742 activated hook must be accessed after first render // since the hook may be injected by a child keep-alive const { a } = instance; if (a \u0026amp;\u0026amp; initialVNode.shapeFlag \u0026amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE) { queuePostRenderEffect(a, parentSuspense); }        æµ‹è¯•  1 2  // `/js/vue/tests/Suspense.js\u0026#39; require(process.env.BLOG_DIR_VUE + \u0026#34;/tests/KeepAlive.js\u0026#34;);    undefined Cannot read property \u0026#39;_vnode\u0026#39; of undefined   âš  æœ‰é”™è¯¯ï¼Œå¾…å®Œæˆã€‚ã€‚ã€‚vue-next æµ‹è¯•è§æœ€åä¸€ç« èŠ‚ã€Šæµ‹è¯•ã€‹\n     set ref   å®˜æ–¹ä½¿ç”¨æ–‡æ¡£: Special Attributes | Vue.js\n å®˜æ–¹ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8  \u0026lt;!-- vm.$refs.p will be the DOM node --\u0026gt; \u0026lt;p ref=\u0026#34;p\u0026#34;\u0026gt;hello\u0026lt;/p\u0026gt; \u0026lt;!-- vm.$refs.child will be the child component instance --\u0026gt; \u0026lt;child-component ref=\u0026#34;child\u0026#34;\u0026gt;\u0026lt;/child-component\u0026gt; \u0026lt;!-- When bound dynamically, we can define ref as a callback function, passing the element or component instance explicitly --\u0026gt; \u0026lt;child-component :ref=\u0026#34;(el) =\u0026gt; child = el\u0026#34;\u0026gt;\u0026lt;/child-component\u0026gt;     patch() å‡½æ•°ä¸­å¯¹ ref å±æ€§çš„å¤„ç†(set ref)ï¼š\n feat(add): set ref Â· gcclll/stb-vue-next@a0a1344\n æºç å®ç°ä¸»è¦æœ‰å‡ ä¸ªæ­¥éª¤ï¼š\n  ref æ”¯æŒæ•°æ®?\n  æ˜¯ä¸æ˜¯å¼‚æ­¥ç»„ä»¶ value = null\n  æœ‰çŠ¶æ€ç»„ä»¶(STATEFULL_COMPONENT, åˆ†å‡½æ•°ç»„ä»¶)\n value = vnode.component!.exposed || vnode.component!.proxy\n  å…¶ä»–æƒ…å†µä¸‹ value = vnode.el\n å³ 2,3,4 éƒ½æ˜¯ä¸ºäº†è®¾ç½® value æŒ‡å‘å“ªä¸ªå¼•ç”¨ï¼Œæ¯”å¦‚ vnode.el åœ¨æ¸²æŸ“ä¹‹åä¼šè¢«èµ‹å€¼ä¸ºå½“ å‰ vnode å¯¹åº”çš„é‚£ä¸ª DOM å…ƒç´ ã€‚\n  æ–­å¼€ oldRef å¼•ç”¨\n  è®¾ç½® refï¼Œåˆ†ä¸‰ç§æƒ…å†µ\n  ref æ˜¯å­—ç¬¦ä¸²ç›´æ¥ refs[ref] = value å– key è®¾å€¼\n  ref æ˜¯ Ref ç±»å‹ï¼Œ ref.value = value\n  ref æ˜¯å‡½æ•°ç±»å‹ï¼Œ ref(value, refs) è°ƒç”¨\n     åœ¨è®¾å€¼çš„æ—¶å€™ä¼šæ ¹æ® value æ˜¯å¦ä¸ºç©ºå€¼æ¥æ§åˆ¶æ˜¯å¦è¿›è¡Œå¼‚æ­¥è®¾ç½®ï¼Œç­‰ Render æ‰§è¡Œå®Œ æˆä¹‹åå†è®¾ç½®\n1 2 3 4 5 6  if (value) { (doSet as SchedulerCb).id = -1; queuePostRenderEffect(doSet, parentSuspense); } else { doSet(); }     æºç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98  const patch: PatchFn = (/*...*/) =\u0026gt; { // ...  // set ref  setRef(ref, n1 \u0026amp;\u0026amp; n1.ref, parentSuspense, n2); }; export const setRef = ( rawRef: VNodeNormalizedRef, oldRawRef: VNodeNormalizedRef | null, parentSuspense: SuspenseBoundary | null, vnode: VNode | null ) =\u0026gt; { if (isArray(rawRef)) { rawRef.forEach((r, i) =\u0026gt; setRef( r, oldRawRef \u0026amp;\u0026amp; (isArray(oldRawRef) ? oldRawRef[i] : oldRawRef), parentSuspense, vnode ) ); return; } let value: | ComponentPublicInstance | RendererNode | Record\u0026lt;string, any\u0026gt; | null; // async ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡ defineAsyncComponent å£°æ˜çš„ç»„ä»¶  // loader ä¼šèµ‹ç»™ __asyncLoaderï¼Œå¦‚æœæ˜¯å¼‚æ­¥ç»„ä»¶éœ€è¦ç­‰ç»„ä»¶æ¸²æŸ“å®Œæˆä¹‹å  // å†å»è®¾ç½® ref  if (!vnode || isAsyncWrapper(vnode)) { value = null; } else { if (vnode.shapeFlag \u0026amp; ShapeFlags.STATEFUL_COMPONENT) { value = vnode.component!.exposed || vnode.component!.proxy; } else { value = vnode.el; } } const { i: owner, r: ref } = rawRef; if (__DEV__ \u0026amp;\u0026amp; !owner) { // warn ä¸¢å¤± ref owner ä¸Šä¸‹æ–‡  return; } const oldRef = oldRawRef \u0026amp;\u0026amp; (oldRawRef as VNodeNormalizedRefAtom).r; const refs = owner.refs === EMPTY_OBJ ? (owner.refs = {}) : owner.refs; const setupState = owner.setupState; // unset old ref  if (oldRef != null \u0026amp;\u0026amp; oldRef !== ref) { if (isString(oldRef)) { refs[oldRef] = null; if (hasOwn(setupState, oldRef)) { setupState[oldRef] = null; } } else if (isRef(oldRef)) { oldRef.value = null; } } if (isString(ref)) { const doSet = () =\u0026gt; { refs[ref] = value; if (hasOwn(setupState, ref)) { setupState[ref] = value; } }; // #1789: éç©ºå€¼ï¼Œåœ¨ render ç»“æŸåè®¾ç½®  // æ§åˆ¶æ„å‘³ç€æ˜¯ unmountï¼Œå®ƒä¸åº”è¯¥é‡å†™åŒkey çš„å…¶ä»– ref  if (value) { (doSet as SchedulerCb).id = -1; queuePostRenderEffect(doSet, parentSuspense); } else { doSet(); } } else if (isRef(ref)) { const doSet = () =\u0026gt; { ref.value = value; }; if (value) { (doSet as SchedulerCb).id = -1; queuePostRenderEffect(doSet, parentSuspense); } else { doSet(); } } else if (isFunction(ref)) { callWithErrorHandling(ref, owner, ErrorCodes.FUNCTION_REF, [value, refs]); } else if (__DEV__) { // warn ...  } };     è¿™é‡Œå¯ä»¥ç®€å•ç†è§£ä¸ºï¼šå°† ref è®¾å€¼ä¸º vnode.el è¿™æ˜¯ä¸ªå¼•ç”¨ï¼Œå› æ­¤å½“å®ƒæœ‰å€¼çš„æ—¶å€™ä¹Ÿ ç­‰äºæ˜¯ ref æœ‰å€¼äº†ï¼Œç„¶ååˆ†ä¸ºå¼‚æ­¥å’ŒåŒæ­¥ï¼Œå¼‚æ­¥éœ€è¦ç­‰ render å®Œæˆå†å»è®¾ç½®ã€‚\n  direcitve hooks   feat(add): directive hooks Â· gcclll/stb-vue-next@1343be2\n æ‰§è¡ŒæŒ‡ä»¤å£°æ˜å‘¨æœŸé’©å­å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  export function invokeDirectiveHook( vnode: VNode, prevVNode: VNode | null, instance: ComponentInternalInstance | null, name: keyof ObjectDirective ) { const bindings = vnode.dirs! const oldBindings = prevVNode \u0026amp;\u0026amp; prevVNode.dirs! for (let i = 0; i \u0026lt; bindings.length; i++) { const binding = bindings[i] if (oldBindings) { binding.oldValue = oldBindings[i].value } const hook = binding.dir[name] as DirectiveHook | undefined if (hook) { callWithAsyncErrorHandling(hook, instance, ErrorCodes.DIRECTIVE_HOOK, [ vnode.el, binding, vnode, prevVNode ]) } } }     ç»™ç»„ä»¶æ³¨å†ŒæŒ‡ä»¤é›†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  export function withDirectives\u0026lt;T extends VNode\u0026gt;( vnode: T, directives: DirectiveArguments ): T { const internalInstance = currentRenderingInstance if (internalInstance === null) { __DEV__ \u0026amp;\u0026amp; warn(`withDirectives can only be used inside render functions.`) return vnode } const instance = internalInstance.proxy const bindings: DirectiveBinding[] = vnode.dirs || (vnode.dirs = []) for (let i = 0; i \u0026lt; directives.length; i++) { let [dir, value, arg, modifiers = EMPTY_OBJ] = directives[i] if (isFunction(dir)) { dir = { mounted: dir, updated: dir } as ObjectDirective } bindings.push({ dir, instance, value, oldValue: void 0, arg, modifiers }) } return vnode }     created, befoureMounted, mounted å‘ç”Ÿåœ¨ mountElement()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  // å‘ç”Ÿåœ¨ mountChildren ä¹‹å if (dirs) { invokeDirectiveHook(vnode, null, parentComponent, \u0026#34;created\u0026#34;); } // ...  // åœ¨æ’å…¥DOMä¹‹å‰æ‰§è¡Œ if (dirs) { invokeDirectiveHook(vnode, null, parentComponent, \u0026#34;beforeMount\u0026#34;); } // hostInsert(el, container, anchor)  // æ’å…¥DOMä¹‹åæ‰§è¡Œï¼Œæ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ç­‰å¾… render ç»“æŸ if ( (vnodeHook = props \u0026amp;\u0026amp; props.onVnodeMounted) || needCallTransitionHooks || dirs ) { queuePostRenderEffect(() =\u0026gt; { vnodeHook \u0026amp;\u0026amp; invokeVNodeHook(vnodeHook, parentComponent, vnode); needCallTransitionHooks \u0026amp;\u0026amp; transition!.enter(el); dirs \u0026amp;\u0026amp; invokeDirectiveHook(vnode, null, parentComponent, \u0026#34;mounted\u0026#34;); }, parentSuspense); }     beforeUpdate, updated å‘ç”Ÿåœ¨ mountChildren()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  + if ((vnodeHook = newProps.onVnodeBeforeUpdate)) { + invokeVNodeHook(vnodeHook, parentComponent, n2, n1) + }  + if (dirs) { + invokeDirectiveHook(n2, n1, parentComponent, \u0026#39;beforeUpdate\u0026#39;) + }  + if ((vnodeHook = newProps.onVnodeUpdated) || dirs) { + queuePostRenderEffect(() =\u0026gt; { + vnodeHook \u0026amp;\u0026amp; invokeVNodeHook(vnodeHook, parentComponent, n2, n1) + dirs \u0026amp;\u0026amp; invokeDirectiveHook(n2, n1, parentComponent, \u0026#39;updated\u0026#39;) + }, parentSuspense) + }      unmounted å‘ç”Ÿåœ¨ unmount()\n1 2 3 4 5 6 7  + if ((vnodeHook = props \u0026amp;\u0026amp; props.onVnodeUnmounted) || shouldInvokeDirs) { + queuePostRenderEffect(() =\u0026gt; { + vnodeHook \u0026amp;\u0026amp; invokeVNodeHook(vnodeHook, parentComponent, vnode) + shouldInvokeDirs \u0026amp;\u0026amp; + invokeDirectiveHook(vnode, null, parentComponent, \u0026#39;unmounted\u0026#39;) + }, parentSuspense) + }      æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner, ref, currentInstance, withDirectives, }) =\u0026gt; { const count = ref(0); let _vnode = null, _prevVnode; const beforeMount = (el, binding, vnode, prevVnode) =\u0026gt; { log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; before mounted\u0026#34;); log(\u0026#34;el.tag = \u0026#34; + el.tag); log(\u0026#34;el.parentNode = \u0026#34; + el.parentNode); log(\u0026#34;root.children.length = \u0026#34; + root.children.length); log(binding); log(\u0026#34;vnode = _vnode, \u0026#34; + (vnode === _vnode)); log(\u0026#34;prev vnode = \u0026#34; + prevVnode); }; const mounted = (el, binding, vnode, prevVnode) =\u0026gt; { log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; mounted\u0026#34;); log(\u0026#34;el.tag = \u0026#34; + el.tag); log(\u0026#34;el.parentNode = root\u0026#34; + (el.parentNode === root)); log(\u0026#34;root.children[0] = el\u0026#34; + (el.children[0] === el)); log(binding); log(\u0026#34;vnode = _vnode, \u0026#34; + (vnode === _vnode)); log(\u0026#34;prev vnode = \u0026#34; + prevVnode); }; const beforeUpdate = (el, binding, vnode, prevVnode) =\u0026gt; { log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; before update\u0026#34;); log(\u0026#34;el.tag = \u0026#34; + el.tag); log(\u0026#34;el.parentNode = root\u0026#34; + (el.parentNode === root)); log(\u0026#34;root.children[0] = el\u0026#34; + (el.children[0] === el)); log(\u0026#34;èŠ‚ç‚¹åº”è¯¥è¿˜æ²¡æ›´æ–° el.children[0].text = \u0026#34; + (count.value - 1)); log(binding); log(\u0026#34;vnode = _vnode, \u0026#34; + (vnode === _vnode)); log(\u0026#34;prev vnode = _prevVnode\u0026#34; + (prevVNode === _prevVnode)); }; const updated = (el, binding, vnode, prevVnode) =\u0026gt; { log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; updated\u0026#34;); log(\u0026#34;el.tag = \u0026#34; + el.tag); log(\u0026#34;el.parentNode = root\u0026#34; + (el.parentNode === root)); log(\u0026#34;root.children[0] = el\u0026#34; + (el.children[0] === el)); log(\u0026#34;èŠ‚ç‚¹åº”è¯¥å·²ç»æ›´æ–° el.children[0].text = \u0026#34; + count.value); log(binding); log(\u0026#34;vnode = _vnode, \u0026#34; + (vnode === _vnode)); log(\u0026#34;prev vnode = _prevVnode\u0026#34; + (prevVNode === _prevVnode)); }; const beforeUnmount = (el, binding, vnode, prevVnode) =\u0026gt; { log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; before unmount\u0026#34;); log(\u0026#34;el.tag = \u0026#34; + el.tag); log(\u0026#34;el.parentNode = root\u0026#34; + (el.parentNode === root)); log(\u0026#34;root.children[0] = el\u0026#34; + (el.children[0] === el)); log(\u0026#34;èŠ‚ç‚¹åº”è¯¥å·²ç»æ›´æ–° el.children[0].text = \u0026#34; + count.value); log(binding); log(\u0026#34;vnode = _vnode, \u0026#34; + (vnode === _vnode)); log(\u0026#34;prev vnode = \u0026#34; + prevVNode); }; const unmounted = (el, binding, vnode, prevVnode) =\u0026gt; { log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; unmounted\u0026#34;); log(\u0026#34;el.tag = \u0026#34; + el.tag); log(\u0026#34;el.parentNode = \u0026#34; + el.parentNode); log(\u0026#34;root.children.length = \u0026#34; + el.children.length); log(\u0026#34;èŠ‚ç‚¹åº”è¯¥å·²ç»æ›´æ–° el.children[0].text = \u0026#34; + count.value); log(binding); log(\u0026#34;vnode = _vnode, \u0026#34; + (vnode === _vnode)); log(\u0026#34;prev vnode = \u0026#34; + prevVNode); }; const dir = { beforeMount, mounted, beforeUpdate, updated, beforeUnmount, unmounted, }; let _instance = null; const Comp = { setup() { _instance = currentInstance; }, render() { (_prevVnode = _vnode), (_vnode = withDirectives(h(\u0026#34;div\u0026#34;, count.value), [ [ dir, // dir, v-dir  count.value, // value, v-dir:foo.ok=value  \u0026#34;foo\u0026#34;, // argument  { ok: true }, // modifiers  ], ])); return _vnode; }, }; const root = nodeOps.createElement(\u0026#34;div\u0026#34;); render(h(Comp), root); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedcomponent stateful ? 4 call setup [Function: render] render normalize vnode \u0026gt;\u0026gt;\u0026gt; before mounted el.tag = div el.parentNode = null root.children.length = 0 { dir: { beforeMount: [Function: beforeMount], mounted: [Function: mounted], beforeUpdate: [Function: beforeUpdate], updated: [Function: updated], beforeUnmount: [Function: beforeUnmount], unmounted: [Function: unmounted] }, instance: {}, value: 0, oldValue: undefined, arg: \u0026#39;foo\u0026#39;, modifiers: { ok: true } } vnode = _vnode, true prev vnode = null \u0026gt;\u0026gt;\u0026gt; mounted el.tag = div el.parentNode = roottrue root.children[0] = elfalse { dir: { beforeMount: [Function: beforeMount], mounted: [Function: mounted], beforeUpdate: [Function: beforeUpdate], updated: [Function: updated], beforeUnmount: [Function: beforeUnmount], unmounted: [Function: unmounted] }, instance: {}, value: 0, oldValue: undefined, arg: \u0026#39;foo\u0026#39;, modifiers: { ok: true } } vnode = _vnode, true prev vnode = null    TODO component props   feat(add): patch props Â· gcclll/stb-vue-next@6f6a0be\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner, ref, currentInstance, withDirectives, defineComponent, }) =\u0026gt; { let props; let attrs; let proxy; const Comp = defineComponent({ props: [\u0026#34;fooBar\u0026#34;, \u0026#34;barBaz\u0026#34;], render() { props = this.$props; attrs = this.$attrs; proxy = this; }, }); const _log = (title) =\u0026gt; { log([ \u0026#39;\u0026gt;\u0026gt;\u0026gt; \u0026#39; + title, \u0026#39;\\nproxy.fooBar = \u0026#39; + proxy.fooBar, \u0026#39;\\n\u0026gt; props\\n\u0026#39;, props, \u0026#39;\\n\u0026gt; attrs\\n\u0026#39;, attrs ]) } const root = nodeOps.createElement(\u0026#39;div\u0026#39;) render(h(Comp, { fooBar: 1, bar: 2 }), root) _log(\u0026#39;test\u0026#39;) render(h(Comp, { \u0026#39;foo-bar\u0026#39;: 3, bar: 3, baz: 4, barBaz: 5 }), root) _log(\u0026#39;foo-bar ä¼šè½¬æˆ fooBar\u0026#39;) render(h(Comp, { qux: 5 }), root) _log(\u0026#39;åˆ é™¤ camel case\u0026#39;) log(\u0026#39;\\n\u0026gt;\u0026gt;\u0026gt; stateful with setup\u0026#39;) }, (err) =\u0026gt; { console.log(err.message); } );    undefinedcomponent stateful ? 4 call setup no setup [Function: render] render normalize vnode \u0026gt;\u0026gt;\u0026gt; test proxy.fooBar = 1 \u0026gt; props { fooBar: 1 } \u0026gt; attrs { bar: 2 } should update component has changed props normalize vnode \u0026gt;\u0026gt;\u0026gt; foo-bar ä¼šè½¬æˆ fooBar proxy.fooBar = 3 \u0026gt; props { fooBar: 3, barBaz: 5 } \u0026gt; attrs { bar: 3, baz: 4 } should update component has changed props normalize vnode \u0026gt;\u0026gt;\u0026gt; åˆ é™¤ camel case proxy.fooBar = undefined \u0026gt; props { fooBar: undefined, barBaz: undefined } \u0026gt; attrs { qux: 5 }    æµ‹è¯•  Teleport Testing...\n  Suspense Testing...\n  KeepAlive Testing...\n  Directive Testing...\n  è„‘å›¾ \u0026amp; æµ‹è¯•ç»“æœ GIF    keep-alive æµ‹è¯•å˜åŒ– GIF(13M):\n  ç»“åˆæºç \n1 2 3  // deactivate() const storageContainer = createElement(\u0026#34;div\u0026#34;); move(vnode, storageContainer, null, MoveType.LEAVE, parentSuspense);     å³ï¼Œ deactivated çš„ DOM èŠ‚ç‚¹å…¶å®å¹¶éç›´æ¥åˆ é™¤äº†ï¼Œè€Œæ˜¯ç§»åˆ°åˆ°äº†ä¸€ä¸ª off-dom çš„å…ƒç´ ä¸Šäº†ï¼Œå¾…é‡æ–°æ¿€æ´»çš„æ—¶å€™å†ç§»å›æ¥(åœ¨æºç çš„ deactivate å’Œ activate å‡½æ•°ä¸­å¢ åŠ  storageContainer æ‰“å°).\n  æµ‹è¯•è„‘å›¾ï¼š\n       ","permalink":"https://www.cheng92.com/vue/vue-mind-map-runtime-core-3-component/","tags":["vue,","vue3,","runtime-core,","render,","component"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(3) - render component"},{"categories":["vue"],"contents":" è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n    insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\"); // insertCssLink(\"/js/vue/tables/index.css\");      var store = Vuex.createStore({ state() { return { count: 0 }}, mutations: { increment(state) { state.count++ }, decrement(state) { state.count-- } }, actions: { increment: ({ commit }) = commit('increment'), decrement: ({ commit }) = commit('decrement') }, modules: { m1: { state() { return { num: 0 } }, mutations: { incre(state) { state.num++ }, decre(state) { state.num-- } }, actions: { increment: ({ commit }) = commit('incre'), decrement: ({ commit }) = commit('decre'), } } } }) var Counter = { template: ` + - count: {{$store.state.count}}, num: {{$store.state.m1.num}} æ³¨å†Œbefore\u0026after {{this.registered ? \"å·²æ³¨å†Œ\" : \"\"}} `, data() { return { registered: false } }, methods: { ...Vuex.mapActions(['increment', 'decrement']), registerHooks() { if (this.registered) { console.log('registered, do not repeat.') return } this.registered = true store.subscribeAction({ before: (...args) = console.log(args,'before'), after: (...args) = console.log(args,'after'), }) }, } } var app = Vue.createApp(Counter) app.use(store).use(ElementPlus).mount('#tHrYBeArBS') console.log(app.config.globalProperties.$store, 'app.config.globalProperties.$store')    state, æ‰€æœ‰å­æ¨¡å—çš„ state ä¼šä»¥æ¨¡å—åå«æ¥åˆ° rootState ä¸Š\n å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  var root = { state: {count: 0}, actions: {}, mutations: {}, // ...  modules: { m1: { state: { num: 0 } }, m2: { state: { n: 0 } } } } // ç»è¿‡ constructor -\u0026gt; installModule å¤„ç†ä¹‹å root.state = { count: 0, m1: { num: 0 }, m2: { n: 0 } }     å®ç°éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  function installModule(store, rootState, path, module, hot) { const isRoot = !path.length; const namespace = store._modules.getNamespace(path); // ...  // set state å°±è¿™ä¸€éƒ¨åˆ†é’ˆå¯¹ state çš„å¤„ç†  // getNestedState æ˜¯ä¸ª recude -\u0026gt; state å–å‡ºå½“å‰ module çš„ state å¯¹è±¡  if (!isRoot \u0026amp;\u0026amp; !hot) { const parentState = getNestedState(rootState, path.slice(0, -1)); const moduleName = path[path.length - 1]; store._withCommit(() =\u0026gt; { if (__DEV__) { if (moduleName in parentState) { console.warn( `[vuex] state field \u0026#34;${moduleName}\u0026#34; was overridden by a module with the same name at \u0026#34;${path.join( \u0026#34;.\u0026#34; )}\u0026#34;` ); } } parentState[moduleName] = module.state; }); } // ...  }      actions, æ‰€æœ‰å­æ¨¡å—çš„ actions éƒ½ä¼šè¢«å‡»ä¸­åˆ° this.actions ä¸­\n å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  var root = { actions: { decre: ({ commit }) =\u0026gt; commit(\u0026#34;decre\u0026#34;), }, modules: { m1: { actions: { decre: ({ commit }) =\u0026gt; commit(\u0026#34;decrement\u0026#34;), incre: ({ commit }) =\u0026gt; commit(\u0026#34;increment\u0026#34;), }, }, }, }; // ç»è¿‡ constructor -\u0026gt; installModule -\u0026gt; forEachActions ä¹‹å this.actions = { // 0 -\u0026gt; commit decre, 1 -\u0026gt; commit decrement  decre: [decre1, decre2], incre: [incre1], // 0 - commit increment };     æ‰€ä»¥å½“è°ƒç”¨ dispatch decre çš„æ—¶å€™ root å’Œ module m1 çš„ decre actionéƒ½ä¼šè¢«è°ƒç”¨ï¼Œ ä¸”æ‰€æœ‰çš„ action ä¼šè¢«å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ— è®ºå¦‚ä½•éƒ½ä¼šè¿”å›ä¸€ä¸ª Promise å®ä¾‹è€Œ åœ¨è¿™äº› actions è¢«è°ƒç”¨çš„æ—¶å€™æ˜¯é€šè¿‡ Promise.all æ¥è°ƒç”¨çš„ï¼Œå› æ­¤æ— è®ºæ˜¯async action è¿˜æ˜¯ sync action éƒ½ä¼šå½“åšæ˜¯ async æ¥æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  function installModule(store, rootState, path, module, hot) { // ...  // ... actions æ”¶é›†éƒ¨åˆ†  module.forEachAction((action, key) =\u0026gt; { const type = action.root ? key : namespace + key; const handler = action.handler || action; registerAction(store, type, handler, local); }); // ... } // registerAction function registerAction(store, type, handler, local) { const entry = store._actions[type] || (store._actions[type] = []); entry.push(function wrappedActionHandler(payload) { let res = handler.call( store, { dispatch: local.dispatch, commit: local.commit, getters: local.getters, state: local.state, rootGetters: store.getters, rootState: store.state, }, payload ); if (!isPromise(res)) { // è¿™é‡Œç¡®ä¿äº†è¿”å›å€¼ä¸€å®šæ˜¯ä¸ª promise  res = Promise.resolve(res); } if (store._devtoolHook) { return res.catch((err) =\u0026gt; { store._devtoolHook.emit(\u0026#34;vuex:error\u0026#34;, err); throw err; }); } else { return res; } }); } // module.js -\u0026gt; forEachAction function forEachAction(fn) { if (this._rawModule.actions) { forEachValue(this._rawModule.actions, fn); } }      dispatch action\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67  function dispatch(_type, _payload) { // check object-style dispatch  const { type, payload } = unifyObjectStyle(_type, _payload); const action = { type, payload }; // å–å‡ºæ‰€æœ‰æ¨¡å—çš„ type ç±»å‹ actions  const entry = this._actions[type]; if (!entry) { if (__DEV__) { console.error(`[vuex] unknown action type: ${type}`); } return; } // è¿™é‡Œæ‰§è¡Œ before é’©å­å‡½æ•°ï¼Œåœ¨æ‰§è¡Œ actions ä¹‹å‰åšçš„äº‹æƒ…  try { this._actionSubscribers .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe  .filter((sub) =\u0026gt; sub.before) .forEach((sub) =\u0026gt; sub.before(action, this.state)); } catch (e) { if (__DEV__) { console.warn(`[vuex] error in before action subscribers: `); console.error(e); } } // è¿™é‡Œå°†æ‰€æœ‰çš„ actions[type] æ”¾åˆ° Promise.all ä¸­æ‰§è¡Œï¼Œæ„å‘³ç€æ‰€æœ‰çš„  // action æ— è®ºåŒæ­¥å¼‚æ­¥çš„éƒ½æ‰§è¡Œå®Œæˆäº†ä¹‹åæ‰ä¼š settled  const result = entry.length \u0026gt; 1 ? Promise.all(entry.map((handler) =\u0026gt; handler(payload))) : entry[0](payload); // æœ€åè¿”å› promise å®Œæˆ promise combo é“¾ï¼Œæ³¨æ„è¿™é‡Œé¢  // åŒ…å«äº† after å’Œ error ä¸¤ä¸ªé’©å­å‡½æ•°çš„è§¦å‘åŠ¨ä½œ  return new Promise((resolve, reject) =\u0026gt; { result.then( (res) =\u0026gt; { try { this._actionSubscribers .filter((sub) =\u0026gt; sub.after) .forEach((sub) =\u0026gt; sub.after(action, this.state)); } catch (e) { if (__DEV__) { console.warn(`[vuex] error in after action subscribers: `); console.error(e); } } resolve(res); }, (error) =\u0026gt; { try { this._actionSubscribers .filter((sub) =\u0026gt; sub.error) .forEach((sub) =\u0026gt; sub.error(action, this.state, error)); } catch (e) { if (__DEV__) { console.warn(`[vuex] error in error action subscribers: `); console.error(e); } } reject(error); } ); }); }      plugins çš„ç”¨æ³•\n plugins çš„æ³¨å†Œå‘ç”Ÿåœ¨ installModule ä¹‹åï¼Œå› æ­¤åœ¨æ­¤æ—¶å¯ä»¥æ‹¿åˆ°æ‰€æœ‰æ¨¡å—çš„ state æ•°æ®ï¼Œæ ¹æ®ç”¨ä¾‹ modules.spec.js çš„ä½¿ç”¨èŒƒä¾‹ï¼Œåœ¨æ’ä»¶ä¸­å¯ä»¥è¿›è¡Œ actions çš„ before å’Œ after é’©å­æ³¨å†Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // store.js -\u0026gt; constructor -\u0026gt; installModule ä¹‹å -\u0026gt;  // æ‰§è¡Œæ’ä»¶ plugins.forEach((plugin) =\u0026gt; plugin(this)); // ä½¿ç”¨ç¤ºä¾‹ï¼Œ modules.spec.js const store = new Vuex.Store({ actions: { [TEST]: () =\u0026gt; Promise.resolve(), }, plugins: [ (store) =\u0026gt; { store.subscribeAction({ before: beforeSpy, after: afterSpy, }); }, ], });      before \u0026amp; after \u0026amp; error hooks\n æ³¨å†Œï¼š store.subscribeAction({ before: fn, after: fn, error: fn })\n æ‰§è¡Œï¼š\n dispatch(type, payload)\n -\u0026gt; sub.before(action, this.state)\n -\u0026gt; Promise.all action\n -\u0026gt; sub.after(action, this.state)/sub.error(action, this.state, error)\n(2) [{â€¦}, Proxy] 0: {type: \u0026#34;increment\u0026#34;, payload: PointerEvent} 1: Proxy {count: 1, m1: {â€¦}} \u0026#34;before\u0026#34; (2) [{â€¦}, Proxy] 0: {type: \u0026#34;increment\u0026#34;, payload: PointerEvent} 1: Proxy {count: 1, m1: {â€¦}} \u0026#34;after\u0026#34;   æºç è°ƒç”¨æ—¶æœºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  function dispatch(_type, _payload) { // check object-style dispatch  // ...  try { // 1. æ‰§è¡Œ before  this._actionSubscribers .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe  .filter((sub) =\u0026gt; sub.before) .forEach((sub) =\u0026gt; sub.before(action, this.state)); } catch (e) { // ...  } // 2. æ‰§è¡Œ actions  const result = entry.length \u0026gt; 1 ? Promise.all(entry.map((handler) =\u0026gt; handler(payload))) : entry[0](payload); return new Promise((resolve, reject) =\u0026gt; { result.then( (res) =\u0026gt; { try { // 3. after, æ‰€æœ‰ action æ‰§è¡Œå®Œæˆä¸”æ— å¼‚å¸¸æƒ…å†µ  this._actionSubscribers .filter((sub) =\u0026gt; sub.after) .forEach((sub) =\u0026gt; sub.after(action, this.state)); } catch (e) { /*...*/ } resolve(res); }, (error) =\u0026gt; { try { // 4. error, å¦‚æœæœ‰ action rejected ä¼šè§¦å‘ error  this._actionSubscribers .filter((sub) =\u0026gt; sub.error) .forEach((sub) =\u0026gt; sub.error(action, this.state, error)); } catch (e) { /*...*/ } reject(error); } ); }); }       ä»æ³¨å†Œå’Œä½¿ç”¨ä¸¤ç‚¹è¿›è¡Œç®€è¦åˆ†æï¼š\n æ³¨å†Œé˜¶æ®µ:\n æ³¨å†Œæ—¶ä¼šå°† store å¯¹è±¡ç”¨ ModuleCollection ç±»è¿›è¡Œå°è£…ï¼Œè¿™ä¸ªç±»å®Œæˆä¸ Module ç›¸å…³çš„ æ³¨å†Œã€æ³¨é”€ã€å’Œæ›´æ–°æ“ä½œï¼Œè€Œ Module ç±»å®Œæˆå…·ä½“çš„ children ç›¸å…³çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œè€Œ Store ç±»æ˜¯é‡ç‚¹éƒ¨åˆ†ï¼Œé‡Œé¢åŒ…å«çŠ¶æ€ç›¸å…³çš„æ“ä½œæ¯”å¦‚ mutations/actions/getters ç­‰æ“ ä½œçš„å°è£…ï¼Œä»¥åŠæä¾› dispatch,commit ç­‰ä¿®æ”¹çŠ¶æ€çš„å‡½æ•°ã€‚\n æ³¨å†Œæ—¶ï¼Œå…ˆæ³¨å†Œæ ¹æ¨¡å—ï¼Œç„¶åé€’å½’æ£€æµ‹ modules å¯¹å­æ¨¡å—è¿›è¡Œæ³¨å†Œï¼Œåœ¨æ¨¡å—æ³¨å†Œè¿‡ç¨‹ä¸­ä¸» è¦æœ‰å‡ ä¸ªæ­¥éª¤ï¼š æ›´æ–° root state, æ”¶é›† actionsã€mutationsã€getters ï¼Œè¿™é‡Œæ”¶é›†çš„åŸ åˆ™æ‹¿ actions ä¸ºä¾‹ï¼Œä¸ç®¡æ˜¯æ ¹æ¨¡å—è¿˜æ˜¯å­æ¨¡å—ä¹Ÿæ— è®ºæ¨¡å—å±‚çº§åµŒå¥—å¤šæ·±ï¼Œæœ€åæ‰€æœ‰çš„ actions éƒ½å¯ä»¥åœ¨å®ä¾‹çš„ this.actions ä¸­æ‰¾åˆ°ã€‚\n ä½¿ç”¨é˜¶æ®µï¼š\n ä½¿ç”¨æ—¶çš„åŸåˆ™æ˜¯åªèƒ½é€šè¿‡ dispatch(type, payload) æ¥æ´¾å‘ ACTION ï¼Œå†…éƒ¨å®ç°æ‰¾åˆ°å¯¹ åº” actions è§¦å‘æ‰§è¡Œï¼Œè€Œ action çš„æ‰§è¡Œä¹Ÿæ˜¯é€šè¿‡ commit mutation æ¥å®Œæˆï¼Œå› æ­¤ä½¿ç”¨åŸ åˆ™ä¸¥æ ¼éµå®ˆï¼š dispatch -\u0026gt; action -\u0026gt; commit -\u0026gt; mutation -\u0026gt; state ï¼Œè€Œä¸èƒ½ç›´æ¥ä½¿ç”¨ commit æˆ– mutation ã€‚\n åœ¨ä½¿ç”¨æ˜¯ï¼Œæ‰§è¡Œé˜¶æ®µä¼šä¾æ¬¡è§¦å‘ before -\u0026gt; action -\u0026gt; after/error ã€‚\n å¯é€šè¿‡ store.subscribeAction(fn)/* ç­‰äº { before: fn }*/ æˆ–\n store.subscribeAction({before:fn, after:fn1, error: fn2})\n å–æ³¨å†Œé’©å­å‡½æ•°ï¼Œè¿™ä¸ªåŠ¨ä½œå¯ä»¥åœ¨ createStore() ä¹‹åå¾—åˆ°æ—¶å€™ç›´æ¥è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ æ’ä»¶çš„å½¢å¼ plugins: [store =\u0026gt; store.subscribeAction(fn)] å»å®Œæˆï¼Œå› ä¸ºæ’ä»¶ä¼šåœ¨ new Store() æ„é€ å‡½æ•°ä¸­åœ¨ installModule() å®‰è£…æ¨¡å—ä¹‹åå¾—åˆ°æ‰§è¡Œï¼Œæ‰€ä»¥ç›®çš„å’Œç»“ æœæ˜¯ä¸€ æ ·çš„ã€‚\n","permalink":"https://www.cheng92.com/vue/vue-vuex/","tags":["vue,","vue3,","vuex"],"title":"vuex for vue3 æºç åˆ†æ(é™„.è„‘å›¾)"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   æ…å…¥ğŸ˜¢\n vue-router-next æºç åˆ†ææµç¨‹å›¾ï¼Œæ­¤æ–‡é‡ç‚¹åœ¨å›¾ï¼Œé™„å¸¦ä¸€äº›æ€»ç»“æ€§çš„æ–‡å­—åˆ† æå†…å®¹(å›¾ä¸€èˆ¬æ¯”è¾ƒå¤§ï¼Œåªä¿è¯è‡ªå·±èƒ½çœ‹æ‡‚ç³»åˆ—~~~~)ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­ä¸€äº›é›¶ç¢çš„ç¬”è®°ã€‚\n vue-router-next   è„‘å›¾ï¼š  ç®€è¦åˆ†æï¼š\n vue-router å®ç°ä»ä½¿ç”¨ä¸Šæ¥è¯´æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼š\n  è·¯ç”±æ³¨å†Œåˆå§‹åŒ–ï¼Œä»¥ VueRouter.createRoute({history, routes}) ä¸ºæ‰§è¡Œå…¥å£\n  åˆ›å»ºåŒ¹é…å™¨ matcher è·¯ç”±çš„ä¸€äº›åŒ¹é…ã€æ·»åŠ ã€æŸ¥æ‰¾å•Šä»€ä¹ˆçš„æ“ä½œéƒ½æ˜¯æœ‰è¿™ä¸ª matcher æ¥å®ç°çš„\n1 2 3 4 5 6 7 8 9 10 11  export interface RouterMatcher { addRoute: (record: RouteRecordRaw, parent?: RouteRecordMatcher) =\u0026gt; () =\u0026gt; void; removeRoute: { (matcher: RouteRecordMatcher): void; (name: RouteRecordName): void; }; getRoutes: () =\u0026gt; RouteRecordMatcher[]; getRecordMatcher: (name: RouteRecordName) =\u0026gt; RouteRecordMatcher | undefined; resolve; }     è€Œä¸Šé¢çš„æ¥å£æ“ä½œçš„æ— éå°±æ˜¯ä¸¤ä¸ªè·¯ç”±ä»“åº“ï¼š\n1 2 3 4 5  // è¿™ä¸ªæ— è®ºæœ‰æ²¡æœ‰åå­—çš„è·¯ç”±è®°å½•éƒ½ä¼šè¢«å­˜å‚¨åˆ°è¿™ä¸ªæ•°ç»„ä¸­ const matchers: RouteRecordMatcher[] = []; // è¿™ä¸ªå­˜å‚¨çš„æ˜¯å¸¦ name å­—æ®µçš„è·¯ç”± \u0026lt;name, record\u0026gt; ç»“æ„ // æ–¹ä¾¿ç›´æ¥å¯ä»¥é€šè¿‡ map.get(name) å°±å¯ä»¥å»åˆ°è·¯ç”±è®°å½•ï¼Œå‡å°‘æ•°ç»„æŸ¥æ‰¾æ¶ˆè€— const matcherMap = new Map\u0026lt;RouteRecordName, RouteRecordMatcher\u0026gt;();      åˆå§‹åŒ–è·¯ç”±å®ˆå«å­˜å‚¨å™¨ï¼Œå…¶å®å°±æ˜¯ä¸ªåŒ…å« {list,add,result} çš„ä¸€ä¸ªå¯¹è±¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // è¿›å…¥ä¹‹å‰çš„çš„å›è°ƒåˆ—è¡¨  const beforeGuards = useCallbacks\u0026lt;NavigationGuardWithThis\u0026lt;undefined\u0026gt;\u0026gt;(); // è§£æè·¯ç”±ä¹‹å‰çš„å›è°ƒåˆ—è¡¨  const beforeResolveGuards = useCallbacks\u0026lt;NavigationGuardWithThis\u0026lt;undefined\u0026gt;\u0026gt;(); // è¿›å…¥ä¹‹åçš„å›è°ƒåˆ—è¡¨  const afterGuards = useCallbacks\u0026lt;NavigationHookAfter\u0026gt;(); export function useCallbacks\u0026lt;T\u0026gt;() { let handlers: T[] = []; function add(handler: T): () =\u0026gt; void {} function reset() { handlers = []; } return { add, list: () =\u0026gt; handlers, reset, }; }      currentRoute é‡è¦å˜é‡ï¼Œæ˜¯ä¸ª shallow ref å“åº”å¼ç±»å‹çš„å€¼ï¼Œä¸ \u0026lt;router-view/\u0026gt; å½“å‰æ˜¾ç¤ºçš„è·¯ç”±æ¯æ¯ç›¸å…³ï¼Œæˆ–è€…è¯´å°±æ˜¯å®ƒï¼Œå› ä¸º RouterView ç»„ä»¶ä¸­æœ‰é—´æ¥çš„ç›‘å¬è¿™ä¸ªå€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  // RouterView.ts  // å°±æ˜¯è¿™é‡Œçš„ matchedRouteRef  watch( () =\u0026gt; [viewRef.value, matchedRouteRef.value, props.name] as const, ([instance, to, name], [oldInstance, from, oldName]) =\u0026gt; { // ...  } ); // RouterView.ts \u0026gt; ä¸ºä»€ä¹ˆè¯´æ˜¯é—´æ¥å‘¢ï¼Ÿçœ‹ä¸‹é¢ matchedRouteRef çš„ç”±æ¥  const injectedRoute = inject(routerViewLocationKey)!; const routeToDisplay = computed(() =\u0026gt; props.route || injectedRoute.value); const depth = inject(viewDepthKey, 0); const matchedRouteRef = computed\u0026lt;RouteLocationMatched | undefined\u0026gt;( () =\u0026gt; routeToDisplay.value.matched[depth] ); // router.ts \u0026gt; routerViewLocationKey ??? ä¸è®°å¾—äº†å—? router.install... å•Š  app.provide(routerKey, router); app.provide(routeLocationKey, reactive(reactiveRoute)); app.provide(routerViewLocationKey, currentRoute); // çœ‹åˆ°æ²¡ï¼Œå…³è”ä¸Šäº†å§!!!  // app.provide -\u0026gt; currentRoute -\u0026gt;  // injectedRoute -\u0026gt; routeToDisplay -\u0026gt;  // routeToDisplay.value.matched[depth]  /* å¹¶ä¸”æ³¨æ„çœ‹ ~RouterView~ ç»„ä»¶ä¸­ setupæœ€åè¿”å›çš„å€¼æ˜¯ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­æœ‰å¯¹ routeToDisplay, matchedRouteRefè¿›è¡Œå¼•ç”¨ä¹Ÿå°±æ˜¯åœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè§¦å‘ track æ“ ä½œå°†å®ƒæ”¶é›†åˆ°è¿™å†™å€¼çš„ä¾èµ–åˆ—è¡¨ä¸­ï¼Œåªè¦è¿™äº›å€¼å‘ç”Ÿå˜æ›´å°±ä¼š triggerè¿™ä¸ª setup æ‰§è¡Œï¼Œæ¥æ›´æ–° ~\u0026lt;router-view/\u0026gt;~ ,*/      åˆå§‹åŒ– router å®ä¾‹\n åŒ…å«ä¸€äº› api :\n è·¯ç”±çš„å¢åˆ æ”¹æŸ¥ä¸»è¦æ¥æº matcherï¼š {addRoute, currentRoute, removeRoute, hasRoute, getRoutes, resolv}\n è·¯ç”±çš„è·³è½¬è¡Œä¸ºï¼š {push, replace, go, back: () =\u0026gt; go(-1), forward: () =\u0026gt; go(1)}, è¿™é‡Œçš„ push, replace å‡½æ•°æœ€ç»ˆè°ƒç”¨çš„éƒ½æ˜¯ finalizeNavigation() è€Œ è¿™é‡Œé¢ä¸»è¦æœ‰ä¸¤ä¸ªå…³é”®åœ°æ–¹ï¼Œä¸€æ˜¯ routerHistory.push/replace, äºŒæ˜¯æ›´æ–°äº† currentRoute.value è€Œæ­£æ˜¯è¿™ä¸ªæ›´æ–°ä¼šè§¦å‘ \u0026lt;router-view/\u0026gt; ç»„ä»¶çš„æ›´æ–°ã€‚go æ˜¯ç›´æ¥ä½¿ç”¨äº† routerHistory.go(delta) æ¥å£\n å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯ push/replace è¿˜æ˜¯ go æœ€åéƒ½æ˜¯ä½¿ç”¨äº† history çš„ api ã€‚\n  è·¯ç”±æ’ä»¶çš„å®‰è£…å‡½æ•° install(app/* vue app */), è¿™é‡Œéœ€è¦æ³¨æ„å®ƒåšäº†å‡ ä»¶äº‹æƒ…ï¼š\n   æ³¨å†Œ RouterLink, RouterView ä¸¤ä¸ª vue ç»„ä»¶   å®šä¹‰äº†å…¨å±€å±æ€§ $route æŒ‡å‘ currentRoute   provide routerKey -\u0026gt; router å½“å‰ router å®ä¾‹   provide routeLocationKey -\u0026gt; reactiveRoute location ç›¸å…³ä¿¡æ¯   provide routerViewLocationKey -\u0026gt; currentRoute å½“å‰è·¯ç”±è®°å½•   é‡å†™ vue ç»„ä»¶çš„ unmount å‡½æ•°ï¼Œæ‰§è¡Œè·¯ç”±çš„æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚ï¼šç§»é™¤äº‹ä»¶ç›‘å¬ï¼Œé‡ç½®è·¯ç”±å±æ€§ç­‰        \u0026lt;router-view/\u0026gt; ç»„ä»¶çš„å®ç°åŸç†ï¼Œé€šè¿‡ \u0026lt;router-link to/\u0026gt; æˆ– router.push/replace/go api è§¦å‘è·¯ç”±è·³è½¬åŠ¨ä½œå®ç°\n  history çš„å®ç°åŸç†(ç»“åˆ Ref + history hash/H5api)ï¼Œè¿™ä¸ªå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„\n   vue-router ç®€è¦å›¾ï¼š\n   TODO å®ˆå«å‡½æ•°å®Œæ•´æ‰§è¡Œæµç¨‹     HTML5 history api     api æè¿°     pushState(state, title, url) å‘å†å²è®°å½•ä¸­å¢åŠ ä¸€æ¡è®°å½•   replaceState(state, title, url) æ›¿æ¢å½“å‰è®°å½•ï¼Œä¸æ–°å¢è®°å½•   back() è¿”å›ä¸Šä¸€æ¡è®°å½•ï¼Œç­‰ä»·äº go(-1)   go(n) è·³è½¬åˆ°ç¬¬ n æ¡è®°å½•   forward() ç­‰ä»·äº go(1)   onpopstate äº‹ä»¶ï¼Œå½“ä¸”æ‰§è¡Œ history.back() æˆ– history.forward() æˆ– history.go(n) çš„æ—¶å€™è§¦å‘   state è®°å½•å½“å‰é¡µé¢çš„çŠ¶æ€ä¿¡æ¯ï¼Œåœ¨æ‰§è¡Œ pushState æˆ– replaceState ä¹‹å‰ä¸º null ï¼Œä¹‹åä¸ºç¬¬ä¸€ä¸ªä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ onpopstate å›è°ƒä¸­é€šè¿‡ event.state å–åˆ°è¯¥ä¿¡æ¯     changeLocation() æµ‹è¯•ã€‚ã€‚ã€‚ï¼Œ ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®ï¼Œæ³¨æ„è§‚å¯Ÿ location å˜åŒ–å’Œ history.length é•¿åº¦å˜åŒ–ï¼ push ?q=1 push ?p=2 replace ?r=3 clear forward éšæœºè·³è½¬ back      é’ˆå¯¹ onpopstate åªæœ‰åœ¨æ‰§è¡Œå®é™…è·³è½¬åŠ¨ä½œçš„æ—¶å€™æ‰ä¼šè§¦å‘ï¼Œä»€ä¹ˆæ˜¯å®é™…è·³è½¬åŠ¨ä½œï¼Ÿ\n æ¯”å¦‚ï¼šæµè§ˆå™¨çš„åå°å‰è¿›æŒ‰é’®ï¼Œæˆ–è€…ç›´æ¥æ‰‹åŠ¨è°ƒç”¨ history.back(), history.go(n), history.forward() æ–¹æ³•è§¦å‘ã€‚\n  ç„¶å vue-router ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨ history å®ç°è·¯ç”±åŠŸèƒ½çš„ï¼Ÿ\n  createWebHistory   H5 çš„ history api å°è£…ï¼Œè¿”å›çš„ç»“æ„ï¼š RouterHistory åŒ…å«ä»¥ä¸‹æˆå‘˜\n   æˆå‘˜å æè¿° -     base ç«™åŸºåœ°å€ï¼Œä¼šæ·»åŠ åˆ°æ¯ä¸ª url å‰é¢ å¦‚ï¼š a.com/sub é‚£ä¹ˆ base æ˜¯ /sub   loation å½“å‰ history location éåŸç”Ÿçš„ location, å°è£…ä¹‹åçš„ï¼š {value: location}   state å½“å‰çš„ history state éåŸç”Ÿ history state ï¼Œåˆå§‹å€¼æ˜¯è¿™ä¸ªï¼Œä½†åç»­çš„å€¼éœ€è¦å‡½æ•°æ‰‹åŠ¨ç®¡ç†   push(to,data?) å¯¹åº” pushState æ“ä½œ ä¸ä¼šè§¦å‘ popstate   replace(to,data?) å¯¹åº” replaceState æ“ä½œ ä¸ä¼šè§¦å‘ popstate   go(delta, triggerListeners?) è°ƒç”¨ history.go(delta) ä¼šè§¦å‘ popstate äº‹ä»¶   listen(callback) ç”¨æˆ·è°ƒç”¨æ·»åŠ çš„ç›‘å¬å‡½æ•° popstate è§¦å‘æœŸé—´æ‰§è¡Œ   createHref(location) æ„å»º href åœ°å€ -   destory() æ³¨é”€ listen() æ³¨å†Œçš„äº‹ä»¶ -     Router ä¸­çš„ back() å’Œ forward() åˆ†åˆ«æ˜¯è°ƒç”¨è¿™é‡Œçš„ go(-1) å’Œ go(1) å®ç°ã€‚\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  export function createWebHistory(base?: string): RouterHistory { base = normalizeBase(base) const historyNavigation = useHistoryStateNavigation(base) const historyListeners = useHistoryListeners( base, historyNavigation.state, historyNavigation.location, historyNavigation.replace ) function go(delta: number, triggerListeners = true) { if (!triggerListeners) historyListeners.pauseListeners() history.go(delta) } const routerHistory: RouterHistory = assign( { // it\u0026#39;s overridden right after  location: \u0026#39;\u0026#39;, base, go, createHref: createHref.bind(null, base), }, historyNavigation, historyListeners ) Object.defineProperty(routerHistory, \u0026#39;location\u0026#39;, { get: () =\u0026gt; historyNavigation.location.value, }) Object.defineProperty(routerHistory, \u0026#39;state\u0026#39;, { get: () =\u0026gt; historyNavigation.state.value, }) return routerHistory }      base = normalizeBase(base)\n è§£æç½‘ç«™åŸºè·¯å¾„\n !base\n ? æ— è‡ªå®šä¹‰åœ°å€é¦–å…ˆå– \u0026lt;base href=\u0026#34;http://ip:port/path/to\u0026#34; /\u0026gt; çš„ hrefï¼Œ å–å‡º /path/to éƒ¨åˆ†ä½œä¸º base\n \\: æœ‰è‡ªå®šä¹‰çš„æ—¶å€™ï¼ŒåŠ ä¸Šå¼€å¤´ / å’Œå»æ‰å°¾éƒ¨ / ï¼Œå¦‚ï¼š path/to å˜æˆ /path/to , æˆ– /path/to/ å˜æˆ /path/to\n  const historyNavigation = useHistoryStateNavigation(base)\n å°† window.location å’Œ window.history è¿›è¡Œå°è£…ï¼Œè¿”å›\n {location, state, push, replace} å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œé‡ç‚¹å°±æ˜¯è¿™ä¸ªå‡½æ•°ã€‚\n  const historyListeners = useHistoryListeners(...)\n history å˜æ›´ç›‘å¬å™¨ã€‚\n  go(delta, triggerListeners) å‡½æ•°\n åœ¨è°ƒç”¨ history.go(delta) ä¹‹å‰æ£€æµ‹æ˜¯å¦æš‚åœ history listeners\n  ç»„è£… routerHistory\n åˆå¹¶ { location: \u0026#39;\u0026#39;, base, go, createHref } å’Œ historyNavigation, historyListeners\n  åœ¨ routerHistory ä¸Šå®šä¹‰ä¸¤ä¸ª getter å±æ€§ location \u0026amp; state\n  è¿”å› routerHistory è¿™ä¸ªå°†æ¥ä¼šè¢« createRouter({ history }) ç”¨åˆ°\n   insertFrame('', '2.js', '/js/vue/router/')  useHistoryStateNavigation(base: string)   è§£æ„ window.history, window.location ç»„è£… {location, state, push, replace} ç»“ æ„è¿”å›ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  function useHistoryStateNavigation(base: string) { const { history, location } = window; // private variables  let currentLocation: ValueContainer\u0026lt;HistoryLocation\u0026gt; = { value: createCurrentLocation(base, location), }; let historyState: ValueContainer\u0026lt;StateEntry\u0026gt; = { value: history.state }; // build current history entry as this is a fresh navigation  if (!historyState.value) { changeLocation( currentLocation.value, { back: null, current: currentLocation.value, forward: null, // the length is off by one, we need to decrease it  position: history.length - 1, replaced: true, // don\u0026#39;t add a scroll as the user may have an anchor and we want  // scrollBehavior to be triggered without a saved position  scroll: null, }, true ); } function changeLocation( to: HistoryLocation, state: StateEntry, replace: boolean ): void { // ...  } function replace(to: HistoryLocation, data?: HistoryState) { // ...  } function push(to: HistoryLocation, data?: HistoryState) { //...  } return { location: currentLocation, state: historyState, push, replace, }; }      è§£æ location { pathname, search, hash } è¿”å›ä¸å¸¦åŸŸåçš„çš„ path\n å¦‚ï¼š\n http://ip:port/ui/#/a/b/?limit=10\u0026amp;page=1 -\u0026gt; base: /ui/# -\u0026gt; /a/b\n http://ip:port/ui/a/b/?limit=10\u0026amp;page=1 -\u0026gt; base: /ui -\u0026gt; /a/b\n http://ip:port/a/ui/b/?limit=10\u0026amp;page=1 -\u0026gt; base: /ui -\u0026gt; /a/ui/b\n ç»“æ„ï¼š {value: url}\n  historyState = { value: history.state }\n å¦‚æœ historyState.value ä¸ºç©ºï¼Œéœ€è¦è¿›è¡Œåˆå§‹åŒ– -\u0026gt; changeLocation()\n  changeLocation(to, state, replace) å‡½æ•°\n  replace(to, data?) å‡½æ•°\n  push(to, data?) å‡½æ•°\n  æœ€åè¿”å›ç»“æ„ {location: currentLocation, state: historyState, push, replace}\n  createCurrentLocation(base: string,location: Location)   å¯¹ location { pathname, search, hash } åŠ å·¥è¿”å›æ–°çš„ url\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function createCurrentLocation( base: string, location: Location ): HistoryLocation { const { pathname, search, hash } = location // allows hash based url  const hashPos = base.indexOf(\u0026#39;#\u0026#39;) if (hashPos \u0026gt; -1) { // prepend the starting slash to hash so the url starts with /#  let pathFromHash = hash.slice(1) if (pathFromHash[0] !== \u0026#39;/\u0026#39;) pathFromHash = \u0026#39;/\u0026#39; + pathFromHash return stripBase(pathFromHash, \u0026#39;\u0026#39;) } const path = stripBase(pathname, base) return path + search + hash }     å‡½æ•°ä½œç”¨ï¼š base ä¸­å«æœ‰ # æ—¶ï¼Œç›´æ¥ä» location.hash ä¸­è§£æå‡º pathã€‚\n æ¯”å¦‚ï¼š\n base=/ui/#/\n url=https://ip:port/ui/#/base/industry/grouping?limit=10\u0026amp;page=1\u0026amp;tradeId=19\u0026amp;times=1614652347338\n æœ€åè§£æå‡ºæ¥çš„\n path=/base/industry/grouping?limit=10\u0026amp;page=1\u0026amp;tradeId=19\u0026amp;times=1614652347338\n å¦‚æœ base ä¸å« # ç›´æ¥å–å‡º path ä¸­å»æ‰ base éƒ¨åˆ†çš„ urlï¼Œå¦‚ï¼š\n base=/ui/ -\u0026gt; url=http://ip:port/ui/path/to... å¾—åˆ° /path/to\n å¦‚æœ base åœ¨ url pathname çš„ä¸­é—´ï¼Œç›´æ¥è¿”å› pathname å› ä¸ºè¿™ç§æƒ…å†µé base æƒ…å†µ http://ip:port/path/ui/to ç›´æ¥è¿”å› /path/ui/to\n  changeLocation(to,state,replace)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  function changeLocation( to: HistoryLocation, state: StateEntry, replace: boolean ): void { //  const hashIndex = base.indexOf(\u0026#34;#\u0026#34;); // to:list -\u0026gt; /base/#/ui/ -\u0026gt; /ui/list  const url = hashIndex \u0026gt; -1 ? (location.host \u0026amp;\u0026amp; document.querySelector(\u0026#34;base\u0026#34;) ? base : base.slice(hashIndex)) + to // http://ip:port + base + to  : createBaseLocation() + base + to; try { // BROWSER QUIRK  // NOTE: Safari throws a SecurityError when calling this function 100 times in 30 seconds  history[replace ? \u0026#34;replaceState\u0026#34; : \u0026#34;pushState\u0026#34;](state, \u0026#34;\u0026#34;, url); historyState.value = state; } catch (err) { if (__DEV__) { warn(\u0026#34;Error with push/replace State\u0026#34;, err); } else { console.error(err); } // Force the navigation, this also resets the call count  location[replace ? \u0026#34;replace\u0026#34; : \u0026#34;assign\u0026#34;](url); } }     å»æ‰ base hash éƒ¨åˆ†å°† to è·¯ç”±ç»„åˆæˆ url è°ƒç”¨ history.replace|pushState(state, title, url) æ”¹å˜ urlï¼ŒåŒæ—¶ä¿®æ”¹ historyState.value å€¼ã€‚\n  replace(to, data?)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  function replace(to: HistoryLocation, data?: HistoryState) { const state: StateEntry = assign( {}, history.state, buildState( historyState.value.back, // keep back and forward entries but override current position  to, historyState.value.forward, true ), data, // æ›¿æ¢æ“ä½œï¼Œä½¿ç”¨è€çš„ position æ›¿ä»£æ–°çš„  // è¿™ä¸ªä¼šåœ¨ changeLocation ä¸­ç”¨æ¥è®¡ç®— delta åç§»é‡  { position: historyState.value.position } ); // æ‰§è¡Œ replaceState  // å– old historyState ç„¶åè®¾ç½® new historyState  changeLocation(to, state, true); currentLocation.value = to; }      push(to, data?)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  function push(to: HistoryLocation, data?: HistoryState) { // Add to current entry the information of where we are going  // as well as saving the current position  const currentState = assign( {}, // use current history state to gracefully handle a wrong call to  // history.replaceState  // https://github.com/vuejs/vue-router-next/issues/366  historyState.value, history.state as Partial\u0026lt;StateEntry\u0026gt; | null, { forward: to, scroll: computeScrollPosition(), } ); // ...  // æ‰§è¡Œ pushState, è®°å½• old/new historyState  changeLocation(currentState.current, currentState, true); const state: StateEntry = assign( {}, buildState(currentLocation.value, to, null), { position: currentState.position + 1 }, data ); changeLocation(to, state, false); currentLocation.value = to; }        useHistoryListeners()  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function useHistoryListeners( base: string, historyState: ValueContainer\u0026lt;StateEntry\u0026gt;, currentLocation: ValueContainer\u0026lt;HistoryLocation\u0026gt;, replace: RouterHistory[\u0026#34;replace\u0026#34;] ) { // 1. popstate äº‹ä»¶å¤„ç†å¥æŸ„  // 2. pause listeners  // 3. listen(callback)  // 4. beforeUnloadListener()  // 5. destory()  // 6. add event listenner: popstate + beforeunload  // setup the listeners and prepare teardown callbacks  window.addEventListener(\u0026#34;popstate\u0026#34;, popStateHandler); window.addEventListener(\u0026#34;beforeunload\u0026#34;, beforeUnloadListener); // 7. return { pauseListeners, listn, destory } }    popStateHandler({ state })   å› ä¸º history.state ä¿å­˜äº†æ‰§è¡Œè·³è½¬æ˜¯ pushState/replaceState ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å€¼ï¼Œ æ‰€ä»¥å¯ä»¥é€šè¿‡ to/from ä¸Šçš„ state è¿›è¡Œå¯¹æ¯”å¾—åˆ°è·³è½¬çš„æ–¹å‘æ˜¯ forward è¿˜æ˜¯ backã€‚\n ä½†æ˜¯ history.state æ˜¯å®æ—¶çš„ï¼Œæ‰§è¡Œå®Œ push/replace å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œè¿™é‡Œæ€ä¹ˆå¤„ç†è¿™ä¸ª é—®é¢˜å‘¢ï¼Œèƒ½è®© to\u0026amp;from çŠ¶æ€å¾—ä»¥ä¿å­˜ï¼Ÿ\n ç­”. å› ä¸ºä½¿ç”¨ historyState = { value: history.state } åšäº†ä¸ªä¸­ä»‹ï¼Œ è™½ç„¶ history.state å®æ—¶å˜åŒ–ï¼Œä½†æ˜¯è¿™ä¸ª historyState æ˜¯ä¸ä¼šçš„ï¼Œæ‰‹åŠ¨ç”¨å®ƒæ¥ç®¡ç† to \u0026amp; from çš„å‰åçŠ¶æ€ã€‚\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  const popStateHandler: PopStateListener = ({ state, }: { state: StateEntry | null }) =\u0026gt; { const to = createCurrentLocation(base, location) const from: HistoryLocation = currentLocation.value // è¿™é‡Œæ‹¿åˆ°çš„æ˜¯è·³è½¬ä¹‹å‰çš„ state  const fromState: StateEntry = historyState.value let delta = 0 if (state) { currentLocation.value = to // è¿™é‡Œ state æ˜¯æ‰§è¡Œè·¯ç”±è·³è½¬ä¹‹åè§¦å‘äº† popstate äº‹ä»¶  // å»å¾—åˆ°çš„æœ€æ–°çŠ¶æ€ï¼Œå¯¹åº” to æ›´æ–°è€çŠ¶æ€å€¼  historyState.value = state // ignore the popstate and reset the pauseState  // æš‚åœï¼Ÿå¿½ç•¥äº‹ä»¶é‡ç½® pauseState ?  if (pauseState \u0026amp;\u0026amp; pauseState === from) { pauseState = null return } // æ ¹æ® to \u0026amp; from state è®¡ç®—å‡ºè¦æ‰§è¡Œè·³è½¬çš„æ–¹å‘æˆ–åç§»  delta = fromState ? state.position - fromState.position : 0 } else { // æ²¡æœ‰æ–°çŠ¶æ€ï¼Œç›´æ¥æ›¿æ¢å†å²è®°å½•  replace(to) } // console.log({ deltaFromCurrent })  // Here we could also revert the navigation by calling history.go(-delta)  // this listener will have to be adapted to not trigger again and to wait for the url  // to be updated before triggering the listeners. Some kind of validation function would also  // need to be passed to the listeners so the navigation can be accepted  // call all listeners  listeners.forEach(listener =\u0026gt; { listener(currentLocation.value, from, { delta, type: NavigationType.pop, direction: delta ? delta \u0026gt; 0 ? NavigationDirection.forward : NavigationDirection.back : NavigationDirection.unknown, }) }) }      pauseListeners()  1 2 3  function pauseListeners() { pauseState = currentLocation.value; }      listen(callback)   çº¯ç²¹çš„ add æ“ä½œï¼Œæ›´æ–° listeners[] å’Œå¯¹åº”çš„ç§»é™¤å‡½æ•°åˆ—è¡¨ teardowns[]\n1 2 3 4 5 6 7 8 9 10 11 12 13  // æ·»åŠ ç›‘å¬å‡½æ•°ï¼Œè¿”å›å¯¹åº”çš„ teardown å‡½æ•°  function listen(callback: NavigationCallback) { // setup the listener and prepare teardown callbacks  listeners.push(callback) const teardown = () =\u0026gt; { const index = listeners.indexOf(callback) if (index \u0026gt; -1) listeners.splice(index, 1) } teardowns.push(teardown) return teardown }      beforeUnloadListener()   æ•´ä¸ªé¡µé¢æ‰§è¡Œå¸è½½ä¹‹å‰çš„äº‹ä»¶ï¼Œå‘ç”Ÿåœ¨ unload ä¹‹å‰ã€‚\n1 2 3 4 5 6 7 8  function beforeUnloadListener() { const { history } = window if (!history.state) return history.replaceState( assign({}, history.state, { scroll: computeScrollPosition() }), \u0026#39;\u0026#39; ) }      destroy() æ³¨é”€äº‹ä»¶  1 2 3 4 5 6  function destroy() { for (const teardown of teardowns) teardown(); teardowns = []; window.removeEventListener(\u0026#34;popstate\u0026#34;, popStateHandler); window.removeEventListener(\u0026#34;beforeunload\u0026#34;, beforeUnloadListener); }          createWebHashHistory   /vue-router-next/src/history/hash.ts\n ä»æºç å¯ä»¥çœ‹å‡ºï¼Œè¯¥å‡½æ•°æ˜¯åŸºäº createWebHistory(base) å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä¹Ÿæ˜¯åŸº äº history api å®Œæˆï¼Œåªä¸è¿‡åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå¯¹ hash å€¼è¿›è¡Œäº†æƒ…å†µåˆ†æå’Œæ£€æµ‹ï¼Œåšäº†è¿›ä¸€ æ­¥ä¼˜åŒ–å¤„ç†ã€‚\n å‚æ•° baseï¼Œå¯ä»¥å‡½æ•°è°ƒç”¨æ—¶æä¾›ï¼Œå¦‚æœå­˜åœ¨ \u0026lt;base href/\u0026gt; æ ‡ç­¾ä¼šä¼˜å…ˆå–è¿™ä¸ªæ ‡ç­¾çš„ href å€¼è§£æå‡º base å€¼ã€‚\n  å¦‚ï¼Œå‡½æ•°æ³¨é‡Šï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½æƒ…å†µ(å¦‚ï¼š base=https://example.com/folder)\n  createWebHashHistory() æ— å‚æ•°\n ç»“æœï¼š https://example.com/folder#\n  createWebHashHistory(\u0026#39;/folder/\u0026#39;)\n åŒ¹é… /folder æˆåŠŸï¼Œç»“æœï¼š https://example.com/folder/#\n  createWebHashHistory(\u0026#39;/folder/#/app\u0026#39;)\n ä¸­é—´æœ‰ # ç¬¦å·çš„ï¼š\n åŒ¹é… /folder æˆåŠŸï¼Œç»“æœï¼š https://example.com/folder/#/app\n  createWebHashHistory(\u0026#39;other-folder\u0026#39;)\n åŒ¹é…å¤±è´¥ï¼Œä¼šç›´æ¥æ›¿æ¢ï¼Œç»“æœï¼š https://example.com/other-folder/#\n ä¸æ¨èè¿™ç§ï¼Œå› ä¸ºå®ƒä¼šæ”¹å˜æ ¹è·¯å¾„ã€‚\n  æ— ä¸»æœºçš„åœ°å€ï¼Œæ¯”å¦‚æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼š ///usr/etc/folder/index.html\n createWebHashHistory(\u0026#39;/iAmIgnored\u0026#39;)\n ç»“æœï¼š ///usr/etc/folder/index.html#\n æä¾›çš„ base ä¼šè¢«å¿½ç•¥ã€‚\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  export function createWebHashHistory(base?: string): RouterHistory { // Make sure this implementation is fine in terms of encoding, specially for IE11  // for `file://`, directly use the pathname and ignore the base  // location.pathname contains an initial `/` even at the root: `https://example.com`  base = location.host ? base || location.pathname + location.search : \u0026#39;\u0026#39; // allow the user to provide a `#` in the middle: `/base/#/app`  if (base.indexOf(\u0026#39;#\u0026#39;) \u0026lt; 0) base += \u0026#39;#\u0026#39; if (__DEV__ \u0026amp;\u0026amp; !base.endsWith(\u0026#39;#/\u0026#39;) \u0026amp;\u0026amp; !base.endsWith(\u0026#39;#\u0026#39;)) { warn( `A hash base must end with a \u0026#34;#\u0026#34;:\\n\u0026#34;${base}\u0026#34; should be \u0026#34;${base.replace( /#.*$/, \u0026#39;#\u0026#39; )}\u0026#34;.` ) } return createWebHistory(base) }     æ›´å¤šè¯·æŸ¥çœ‹ createWebHistory ã€‚\n  TODO createMemoryHistory   é€šè¿‡ä¸€ä¸ªé˜Ÿåˆ—æ¥ç®¡ç†è·¯ç”±ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83  export function createMemoryHistory(base: string = \u0026#39;\u0026#39;): RouterHistory { let listeners: NavigationCallback[] = [] let queue: HistoryLocation[] = [START] let position: number = 0 function setLocation(location: HistoryLocation) { position++ if (position === queue.length) { // we are at the end, we can simply append a new entry  queue.push(location) } else { // we are in the middle, we remove everything from here in the queue  queue.splice(position) queue.push(location) } } function triggerListeners( to: HistoryLocation, from: HistoryLocation, { direction, delta }: Pick\u0026lt;NavigationInformation, \u0026#39;direction\u0026#39; | \u0026#39;delta\u0026#39;\u0026gt; ): void { const info: NavigationInformation = { direction, delta, type: NavigationType.pop, } for (let callback of listeners) { callback(to, from, info) } } const routerHistory: RouterHistory = { // rewritten by Object.defineProperty  location: START, state: {}, base, createHref: createHref.bind(null, base), replace(to) { // remove current entry and decrement position  queue.splice(position--, 1) setLocation(to) }, push(to, data?: HistoryState) { setLocation(to) }, listen(callback) { listeners.push(callback) return () =\u0026gt; { const index = listeners.indexOf(callback) if (index \u0026gt; -1) listeners.splice(index, 1) } }, destroy() { listeners = [] }, go(delta, shouldTrigger = true) { const from = this.location const direction: NavigationDirection = // we are considering delta === 0 going forward, but in abstract mode  // using 0 for the delta doesn\u0026#39;t make sense like it does in html5 where  // it reloads the page  delta \u0026lt; 0 ? NavigationDirection.back : NavigationDirection.forward position = Math.max(0, Math.min(position + delta, queue.length - 1)) if (shouldTrigger) { triggerListeners(this.location, from, { direction, delta, }) } }, } Object.defineProperty(routerHistory, \u0026#39;location\u0026#39;, { get: () =\u0026gt; queue[position], }) return routerHistory }      ","permalink":"https://www.cheng92.com/vue/vue-router-next/","tags":["vue,","vue3,","vue-router-next"],"title":"vue-router-next for vue3 æºç åˆ†æ(é™„.è„‘å›¾)"},{"categories":["tools"],"contents":"  æ‚ä¸ƒæ‚å…«çš„ä¸€äº›ä¸œè¥¿ï¼Œæ€»è¦å¾€å“ªé‡Œæ”¾ï¼Œä»Šå¤©è§£å†³æ˜å¤©åˆå¿˜è®°äº†ï¼Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼ŒğŸ˜„ğŸ˜„ã€‚\n ä¼˜è´¨åšæ–‡(å« github)    Jerry Qu, HTTP/HTTP2ç›¸å…³å†…å®¹ä¸°å¯Œçš„åšå®¢\n  æµè§ˆå™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼šChrome V8è®©ä½ æ›´æ‡‚JavaScript - SegmentFault æ€å¦\n  ç¨‹åºå‘˜ç»å¸¸çœ‹çš„å¼€æºæœˆåˆŠã€ŠHelloGitHubã€‹ç¬¬ 58 æœŸ - çŸ¥ä¹\n  Troland/how-javascript-works: Knowledge about how javascript works, event loop,service worker,etc.\n é‡Œé¢æœ‰äº›æ–‡ç« ä»‹ç»äº†ï¼Œäº‹ä»¶å¾ªç¯ç­‰ä¸€äº›åŸç†æ€§çš„ä¸œè¥¿ã€‚\n  Openbase: choose the right package every time\n æŠ€æœ¯é€‰å‹ç½‘ç«™ï¼Œå¦‚ vue, react ç­‰å¾…ã€‚\n  (22 å°ç§ä¿¡ / 82 æ¡æ¶ˆæ¯) å›½å†…æœ‰å“ªäº›ç±»ä¼¼äºèšåˆæ•°æ®è¿™æ ·çš„æä¾›å…è´¹æ¥å£apiçš„ æœåŠ¡ä¾›åº”å•†ï¼Ÿ - çŸ¥ä¹\n    æ•°å­¦  æ•°å­¦ç¬¦å·å¤§å…¨   ç¬¦å·å¤§å…¨-ç‰¹æ®Šç¬¦å·-ç‰¹æ®Šç¬¦å·å¤§å…¨\nå¸¸ç”¨ç¬¦å·ï¼š ï¼‹ï¼Ã—Ã·ï¹¢ï¹£Â±ï¼ï¼â‰ˆâ‰¡â‰ âˆ§âˆ¨âˆ‘âˆâˆªâˆ©âˆˆâŠ™âŒ’âŠ¥âˆ¥âˆ âˆ½â‰Œï¼œï¼â‰¤â‰¥â‰®â‰¯âˆ§âˆ¨âˆšï¹™ï¹š[]ï¹›ï¹œâˆ«âˆ®âˆâˆâŠ™âˆÂºÂ¹Â²Â³â´â¿â‚â‚‚â‚ƒâ‚„Â·âˆ¶Â½â…“â…”Â¼Â¾â…›â…œâ…â…âˆ´âˆµâˆ·Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰ï¼…â€°â„…Â°â„ƒâ„‰â€²â€³ï¿ ã€’Â¤â—‹ãããœããã¡ã¥ã„ãmlmolã•Paï¼„ï¿¡ï¿¥ã’ã‘å£¹è´°åè‚†ä¼é™†æŸ’æŒç–æ‹¾å¾®æ¯«å˜åˆ†ç™¾åƒä¸‡äº¿å…†å‰ å‡ ä½•ç¬¦å·ï¼š âŠ¥ â€– âˆ  âŒ’ âŠ™ â‰¡ â‰Œ â–³ ä»£æ•°ç¬¦å·ï¼š âˆ âˆ§ âˆ¨ ï½ âˆ« â‰  â‰¤ â‰¥ â‰ˆ âˆ âˆ¶ è¿ç®—ç¬¦å·ï¼š Ã— Ã· âˆš Â± é›†åˆç¬¦å·ï¼š âˆª âˆ© âˆˆ âŠ† âŠ‚ âŠ‡ âŠƒ ç‰¹æ®Šç¬¦å·ï¼š âˆ‘ Ï€ï¼ˆåœ†å‘¨ç‡ï¼‰ æ¨ç†ç¬¦å·ï¼š |a| âŠ¥ âˆ½ â–³ âˆ  âˆ© âˆª â‰  â‰¡ Â± â‰¥ â‰¤ âˆˆ â† â†‘ â†’ â†“ â†– â†— â†˜ â†™ â€– âˆ§ âˆ¨      ç¨‹åºå‘˜  ReadTheDocs åˆ›å»ºæŠ€æœ¯æ–‡æ¡£   Read the Docs Guides â€” Read the Docs 5.8.0 documentation\n Read the Docs Sphinx Theme â€” Read the Docs Sphinx Theme 0.5.0 documentation\n  go   go get golang.org/x/tools/gopls@latest\n  æ­£åˆ™è¡¨è¾¾å¼    å­¦ä¹ èµ„æ–™\n https://github.com/ziishaned/learn-regex\n  æ­£åˆ™å·¥å…·ï¼š\n https://regexper.com/#â€“%28%5C!%29%3E\n    åˆçº§é˜¶æ®µå­¦ä¹     w3schools åˆå­¦\n  GeeksforGeeksï¼Œå…¨è‹±æ–‡ä¸æ­¢æœ‰ç®—æ³•\n       å‰ç«¯å¼€å‘  ä¸é”™çš„å‰ç«¯å­¦ä¹ è·¯çº¿ç½‘ç«™ï¼šhttps://objtube.github.io/front-end-roadmap/#/ è„‘å›¾æ–¹å¼ å±•ç¤ºã€‚\næ’ä»¶åˆ—è¡¨  jsmind ä¸€æ¬¾ js è„‘å›¾å·¥å…·ã€‚    BFW NEW PAGE  bready(function() { use([\"jsmind\", \"jsmind\"], function() { function load_jsmind() { var mind = { \"meta\": { \"name\": \"demo\", \"author\": \"hizzgdev@163.com\", \"version\": \"0.2\", }, \"format\": \"node_array\", \"data\": [{ \"id\": \"root\", \"isroot\": true, \"topic\": \"jsMind\" }, { \"id\": \"sub1\", \"parentid\": \"root\", \"topic\": \"sub1\", \"background-color\": \"#0000ff\" }, { \"id\": \"sub11\", \"parentid\": \"sub1\", \"topic\": \"sub11\" }, { \"id\": \"sub12\", \"parentid\": \"sub1\", \"topic\": \"sub12\" }, { \"id\": \"sub13\", \"parentid\": \"sub1\", \"topic\": \"sub13\" }, { \"id\": \"sub2\", \"parentid\": \"root\", \"topic\": \"sub2\" }, { \"id\": \"sub21\", \"parentid\": \"sub2\", \"topic\": \"sub21\" }, { \"id\": \"sub22\", \"parentid\": \"sub2\", \"topic\": \"sub22\", \"foreground-color\": \"#33ff33\" }, { \"id\": \"sub3\", \"parentid\": \"root\", \"topic\": \"sub3\" }, ] }; var options = { container: 'jsmind_container', editable: true, theme: 'primary' } var jm = jsMind.show(options, mind); // jm.set_readonly(true); // var mind_data = jm.get_data(); // alert(mind_data); jm.add_node(\"sub2\", \"sub23\", \"new node\", { \"background-color\": \"red\" }); jm.set_node_color('sub21', 'green', '#ccc'); } load_jsmind(); }); });  #jsmind_container { width: 800px; height: 500px; border: solid 1px #ccc; /*background:#f4f4f4;*/ background: #f4f4f4; }         xlsx-to-json  xlsx æ–‡ä»¶è½¬æˆ json æ•°æ®ã€‚\n    anujs   vue  vite(vue-cli)\n1 2 3 4  $ yarn create vite-app \u0026lt;project-name\u0026gt; $ cd \u0026lt;project-name\u0026gt; $ yarn $ yarn dev     æˆ–\n1 2 3 4 5  $ npm install -g @vue/cli $ vue create 01-vue3-cli $ cd 01-vue3-cli $ vue add vue-next $ npm run serve      v3boss(Based on vue3)  é—®é¢˜åˆ—è¡¨    è¯·æ±‚å‡ºç° \u0026lt;font color=\u0026#34;red\u0026#34;\u0026gt;500\u0026lt;/font\u0026gt;ï¼Œå¯¹æ¯”å·®å¼‚åªæœ‰ RemoteAddress æœ‰ç‚¹å¼‚å¸¸???\nç­”ï¼šè¯ä¹¦é—®é¢˜ï¼Œä½¿ç”¨ `secure: false` é…ç½®é€‰é¡¹è·³è¿‡è¯ä¹¦è®¤è¯    assets èµ„æºå¼•å…¥é—®é¢˜\nç­”ï¼šä½¿ç”¨ `alias: {}` é€‰é¡¹é…ç½®åˆ«åï¼Œæ³¨æ„å¿…é¡»æ˜¯ `/@assets/` æ–¹å¼ï¼Œä»¥æ–œæ å¼€å§‹æ–œæ ç»“æŸã€‚  1 2 3 4  alias: { \u0026#39;/@/\u0026#39;: path.resolve(__dirname, \u0026#39;src\u0026#39;), \u0026#39;/@assets/\u0026#39;: path.resolve(__dirname, \u0026#39;src/assets\u0026#39;) }          å·¥å…·    .gitignore ç”Ÿæˆç½‘ç«™ï¼š https://www.toptal.com/developers/gitignore\n      ç¥å™¨???  nnn   author: https://github.com/jarun\n ç»ˆç«¯æ–‡ä»¶ç®¡ç†å·¥å…·   Surfingkeys   chrome/firefox æŒ‰é”®, https://github.com/brookhong/Surfingkeysã€‚\n æŒ‰é”®ï¼š ? æŸ¥çœ‹æŒ‰é”®è¡¨ã€‚\n å¸¸ç”¨æŒ‰é”®è¡¨ï¼š\n   key function     æˆªå±    yg æˆªå–å½“å‰è§†å›¾   yG æˆªå–å½“å‰æ•´ä¸ªé¡µé¢ï¼Œé•¿å›¾   yS capture current scroll target.     Alt/Option s on/off Surfingkeys     å­—ç¬¦æŸ¥æ‰¾    f, ; å‘ä¸‹æŸ¥æ‰¾ï¼Œå‘ä¸‹é‡å¤æŸ¥æ‰¾ç»“æœ   F, , å‘ä¸ŠæŸ¥æ‰¾ï¼Œå‘ä¸Šé‡å¤æŸ¥æ‰¾ç»“æœ     å®šä½/å¯¼èˆª    zz å°†é¼ æ ‡è¡Œå®šä½åˆ°å±å¹•ä¸­é—´   t æœç´¢ä¹¦ç­¾æˆ–å†å²   b æ‰“å¼€ä¹¦ç­¾   og æ‰“å¼€æœç´¢å¼•æ“ï¼Œä¼šå¼¹å‡ºè¾“å…¥æ¡†   ow åŒä¸Š     é…ç½®æ–‡ä»¶ï¼š\n1 2 3  mapkey(\u0026#39;\u0026lt;Ctrl-y\u0026gt;\u0026#39;, \u0026#39;Show me the money\u0026#39;, function() { Front.showPopup(\u0026#39;a well-known phrase uttered by characters in the 1996 film Jerry Maguire (Escape to close).\u0026#39;); });     chrome url æ“ä½œï¼š  æ ‡è®°æ“ä½œï¼Œæ·»åŠ -è·³è½¬  å½“å‰æ ‡ç­¾é¡µURLæ“ä½œï¼š  tab æ“ä½œï¼š  æœç´¢ï¼Œæ‰“å¼€urlæ“ä½œï¼š     Hugo    è®¾ç½®æ–‡ç« åˆ—è¡¨ä»¥ year-month åˆ†ç±»ï¼Œå¦‚å›¾ï¼š  ä¿®æ”¹ï¼š/theme/even/layouts/_default/section.html\n å…¶ä¸­çš„ \u0026#34;2006\u0026#34; ä¿®æ”¹æˆ \u0026#34;2006-01\u0026#34; å³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  {{- range $index, $element := $paginator.Pages -}} {{- $thisYear := $element.Date.Format \u0026#34;2006-01\u0026#34; }} {{- $lastElement := $index | add -1 | index $paginator.Pages }} {{- if or (eq $index 0) ( ne ($lastElement.Date.Format \u0026#34;2006-01\u0026#34;) $thisYear ) }} \u0026lt;div class=\u0026#34;collection-title\u0026#34;\u0026gt; \u0026lt;h2 class=\u0026#34;archive-year\u0026#34;\u0026gt;{{ $thisYear }}\u0026lt;/h2\u0026gt; \u0026lt;/div\u0026gt; {{- end }} \u0026lt;div class=\u0026#34;archive-post\u0026#34;\u0026gt; \u0026lt;span class=\u0026#34;archive-post-time\u0026#34;\u0026gt; {{ $element.Date.Format \u0026#34;01-02\u0026#34; }} \u0026lt;/span\u0026gt; \u0026lt;span class=\u0026#34;archive-post-title\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;{{ $element.RelPermalink }}\u0026#34; class=\u0026#34;archive-post-link\u0026#34;\u0026gt; {{ .Title }} \u0026lt;/a\u0026gt; \u0026lt;/span\u0026gt; \u0026lt;/div\u0026gt; {{- end -}}        api     åç§° ç®€ä»‹ å…¶ä»–     IPTV channels IPTV é¢‘é“æ¥å£ æ‰€æœ‰æ•°æ® json æ–‡ä»¶      è½¯ä»¶\u0026amp;å‘½ä»¤  crontab å®šæ—¶ä»»åŠ¡   OS X æ·»åŠ å®šæ—¶ä»»åŠ¡ | Coding Pub\n  macos é‡è£…ç³»ç»Ÿå¿…å¤‡æ­¥éª¤    å®‰è£… CommandLineTools ï¼Œç›´æ¥å®˜ç½‘ä¸‹è½½å°±è¡Œ-\u0026gt;\u0026gt;\n git ä»£ç†è®¾ç½®ï¼š\ngit ---------- å–æ¶ˆ git config --global --unset http.https://github.com.proxy git config --global --unset https.https://github.com.proxy git config --global --unset http.proxy git config --global --unset https.proxy è®¾ç½® git config --global http.https://github.com.proxysocks5://127.0.0.1:7891 git config --global https.https://github.com.proxysocks5://127.0.0.1:7891 git config --global http.https://github.com.proxyhttps://127.0.0.1:7890 git config --global https.https://github.com.proxyhttps://127.0.0.1:7890 git config --global http.proxy socks5://127.0.0.1:7891 git config --global https.proxy socks5://127.0.0.1:7891    ä¸‹è½½ ssh é…ç½®ï¼š git clone git@code.aliyun.com:wyu/dotdat.git\n è§£å†³æƒé™é—®é¢˜ï¼š chmod 400 ~/.ssh/id_rsa_ali\n  ä¸‹è½½æ–‡æ¡£: git clone git@code.aliyun.com:wyu/documents.git\n  ä¸‹è½½å®‰è£… MacPorts, Node.js , HomeBrew\n è§£å†³å®‰è£…å†²çªé—®é¢˜ï¼š sudo killall -1 installd è§£å†³ npm å®‰è£…æƒé™é—®é¢˜ï¼š sudo chown -R $USER /usr/local/lib/node_modules\n npm ä»£ç†è®¾ç½®å’Œå–æ¶ˆï¼š\n1 2 3 4 5  npm config set proxy=http://127.0.0.1:8087 npm config set registry=http://registry.npmjs.org npm config delete proxy npm config delete https-proxy      ä¸‹è½½ MacOS å·¥å…·ï¼š iTerm, oh-my-zsh, drawer.io drawer.io.pp\n  å®‰è£…å…¶ä»– shell å‘½ä»¤å·¥å…·ï¼š fasd, autojump, n, ag, rg\n å‡å¯ä»¥é€šè¿‡ brew/port å®‰è£…\n brew install fasd/... sudo port install fasd/...\n  å®‰è£… Emacs\n sudo port install emacs-app sudo port install emacs\n  å®‰è£… PicGo æˆªå›¾ï¼Œå›¾åºŠå·¥å…·: brew cask install picgo\n é…ç½®æ–‡ä»¶ ~/Library/Application\\ Support/picgo/data.json\n  ä¸ƒç‰›ç§˜é’¥ï¼šhttps://portal.qiniu.com/user/key\n  hugo\n brew install hugo\n rust: curl --proto \u0026#39;=https\u0026#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh\n  å®‰è£… alfred åŠå…¶ workflows\n  lsp languages\n https://emacs-lsp.github.io/lsp-mode/page/lsp-eslint/\n1 2 3 4 5 6 7 8 9 10 11 12  # js/ts, vue, css/less/scss/... $ npm i -g javascript-typescript-langserver \\  vls \\  vscode-css-languageserver-bin \\  bash-language-server \\  vscode-html-languageserver-bin \\  typescript \\  vscode-json-languageserver \\  yaml-language-server \u0026amp;\u0026amp; \\  pip install \u0026#39;python-language-server[all]\u0026#39; \\  brew install ccls \\  go get golang.org/x/tools/gopls@latest     gopls: ~~\n  ssh/sftp å·¥å…·ï¼š npm i -g electerm\n https://electerm.github.io/electerm/\n  rsync: brew install rsync\n download linux kernel src: git clone git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git\n    å­—ä½“  1 2  $ brew tap homebrew/cask-fonts $ brew cask install font-fira-code      ç½‘ç«™    å›¾ç‰‡/svg è½¬ favicon\n    MacOs å·¥å…·  å…¶ä»–    beyond compare\n ç ´è§£ï¼š https://www.jianshu.com/p/596b4463eacd\n æ­¥éª¤ï¼š\n1 2 3 4 5 6 7  $ cd /Applications/Beyond Compare.app/Contents/MacOS $ mv BCompare BCompare.real $ echo \u0026#39;#!/bin/bash rm \u0026#34;/Users/$(whoami)/Library/Application Support/Beyond Compare/registry.dat\u0026#34; \u0026#34;`dirname \u0026#34;$0\u0026#34;`\u0026#34;/BCompare.real $@ \u0026#39; \u0026gt; BCompare $ chmod a+x ./BCompare        ç³»ç»Ÿæ€§å·¥å…·    setapp\n  Karabiner-Elements A powerful and stable keyboard customizer for macOS.\n  SpaceLauncher è‡ªå®šä¹‰å¿«æ·é”®\n    è½¯ä»¶ç½‘ç«™    xclient.info\n    åˆ†å±    Swish æ‰‹åŠ¿åˆ†å±ï¼Œä»˜è´¹\n ä½¿ç”¨ä¸­æ–‡æ•™ç¨‹ï¼š https://sspai.com/post/55285\n  Melisandreï¼Œä»˜è´¹\n  Moomï¼Œä»˜è´¹\n  Mosaicï¼Œä»˜è´¹\n  Magnetï¼Œä»˜è´¹\n  BetterTouchToolï¼Œä»˜è´¹\n  Hammerspoon\n      Alfred    Text Shourtcut\n å¦‚æœç”¨çš„æ˜¯ Alfred 3 éœ€è¦ä¿®æ”¹ä¸‹ /Users/simon/Library/Application Support/Alfred 3/Alfred.alfredpreferences/workflows/user.workflow.ACE8BAEC-3702-436D-959C-4DBC14DBAFAB/workflows.php\n å°†é‡Œé¢çš„ Alfred-2 æ”¹æˆ Alfred-3 å°±å¯ä»¥ç”¨äº†ï¼Œä¸ç„¶ä¼šæŠ¥æ‰¾ä¸åˆ°è·¯å¾„ã€‚\n å¢åŠ å’Œåˆ é™¤éƒ½æ˜¯é’ˆå¯¹å¢åŠ çš„ abbrev æ–‡ä»¶æ“ä½œã€‚\n 1 å…ˆå¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿\n  ts add [shortcut name] å¢åŠ \n  ts del [shortcut name] åˆ é™¤\n  ts [shortcut name] å–å‡ºå¯¹åº”çš„å†…å®¹ï¼Œå¤åˆ¶åˆ°å½“å‰æ´»è·ƒåº”ç”¨\n       command function     web æŸ¥è¯¢     bd, ç™¾åº¦    w3, w3c    mdn     open æœç´¢æ‰“å¼€   find æŸ¥æ‰¾æ–‡ä»¶   in å†…å®¹æœç´¢   tags æŸ¥æ‰¾è¢«æ ‡è®°é¢œè‰²çš„æ–‡ä»¶å¤¹   j autojump   user can i use   cov è¿›åˆ¶è½¬æ¢   rjs react docs   json json æ ¼å¼åŒ–   twd tailwind css docs   v vuejs docs, âŒ˜Y å¿«é€Ÿé¢„è§ˆ   v routing vuejs router docs   adb TODO   lc leetcode æœç´¢ (-e, -m, -h, å®¹æ˜“ï¼Œä¸­ç­‰ï¼Œé«˜éš¾)   lct leetcode è¯é¢˜æœç´¢   gh github search   b64 å›¾ç‰‡è½¬base64   fa æœç´¢ fontasesome çš„ icons   gicon google icons ä¸Šæœç´¢   qr å°†æ–‡æœ¬ç”ŸæˆäºŒç»´ç (å¥‡æ…¢æ— æ¯”)   giphy æœç´¢åŠ¨æ€å›¾ç‰‡ gif   ip æŸ¥ç”µè„‘å†…å¤–ç½‘ip   gt google ç¿»è¯‘   emoj è¡¨æƒ…æœç´¢   emoji è¡¨æƒ…æœç´¢   ascii/rascii ASCIIç¼–ç äº’è½¬   http http çŠ¶æ€ç    yd æœ‰é“ç¿»è¯‘ï¼Œæ”¯æŒåŒè¯­äº’è½¬,yd zh=\u0026gt;ja æˆ‘çˆ±ä½ ï¼Œä¸­è½¬æ—¥    zh, ja, en, ko, fr,    ru(ä¿„æ–‡), pt(è‘¡è„ç‰™æ–‡), es(è¥¿ç­ç‰™æ–‡), auto   kill æ€è¿›ç¨‹   audiorec, screenrec, webcamred éŸ³é¢‘/å±å¹•/è§†é¢‘å½•åˆ¶(è‡ªå¸¦çš„QuickPlayer)   vd è§†é¢‘ä¸‹è½½(youtube, vimeo,dailymotion,â€¦)   vd-update æ›´æ–°è‡ªèº«   vd video-url ä¸‹è½½åˆ°æ¡Œé¢   vd-audio video-url ä¸‹è½½åŒæ—¶è‡ªåŠ¨åˆ†ç¦»å‡ºéŸ³é¢‘æ–‡ä»¶   vd-info video-url æŸ¥çœ‹è§†é¢‘ä¿¡æ¯      qshell æ‰¹é‡ä¸‹è½½ä¸ƒç‰›  https://github.com/qiniu/qshell\n  $ qshell account \u0026lt;Your AccessKey\u0026gt; \u0026lt;Your SecretKey\u0026gt; \u0026lt;Your Name\u0026gt;\n  $ qshell account -- \u0026lt;Your AccessKey\u0026gt; \u0026lt;Your SecretKey\u0026gt; \u0026lt;Your Name\u0026gt; key å¯èƒ½ ä»¥æ˜¯ä»¥ - å¼€å¤´ï¼Œå°±ç”¨è¿™ä¸ªã€‚\n  é…ç½®æ–‡ä»¶ï¼š~/.qshell.json\n  git å‘½ä»¤   åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼š $ git push origin :test1\n åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼š $ git branch -d test1\n å¼ºåˆ¶åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼š $ git branch -D test1\n æ–°å¢æœ¬åœ°åˆ†æ”¯ï¼š $ git branch test1\n æ¨é€åˆ°è¿œç¨‹åˆ†æ”¯ï¼š $ git push origin test1:test1\n æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯ï¼š $ git branch -r\n æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯ï¼š $ git branch -a\n  htop å¯è§†åŒ–è¿›ç¨‹æŸ¥çœ‹å·¥å…·  $ brew install htop\n  Travis-CI(Blog ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ)    æŒç»­é›†æˆæœåŠ¡ Travis CI æ•™ç¨‹-é˜®ä¸€å³°\n  travis-ci-ssh-token é—®é¢˜\n  1 2 3 4 5 6 7 8 9  $ travis login --pro --github-token xxxx $ ssh-keygen -t rsa -b 4096 -C \u0026#34;gccll.love@gmail.com\u0026#34; $ travis whoami $ ssh-keygen -t rsa $ ls # è¿™é‡Œæ˜¯å…³é”®ï¼Œç™»å½•çš„æ—¶å€™ç”¨çš„ --pro è¿™é‡Œä¹Ÿå¿…é¡»ç”¨ --proï¼Œä¸ç„¶åŠ åˆ° .org ä¸Šå»äº† # å‘é€¼ $ travis encrypt-file deploy_key --add --pro $ ls      PicGo   https://github.com/PicGo\n    git   æ€ä¹ˆåªæ‹‰å–ä»£ç è€Œå¿½ç•¥ .git/ æ–‡ä»¶å¤¹ ?\n  ","permalink":"https://www.cheng92.com/post/cheng/","tags":["soft,","macos,","window"],"title":"æˆ‘çš„ç§äººç©ºé—´"},{"categories":["vue"],"contents":" è¯¥æ–‡ä¸ºæœ¬äººå­¦ä¹ è®¡åˆ’ç­‰ç›¸å…³ä¿¡æ¯ï¼Œè¿™é‡Œå†…å®¹å°†å‡ç”± vue3 + element-plus å®ç°ã€‚\n çŠ¶æ€ï¼šDONE å·²å®Œæˆ DOING è¿›è¡Œä¸­ PENDING æš‚åœä¸­ WAITING è®¡åˆ’ä¸­      insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\"); insertCssLink(\"/js/vue/tables/index.css\");    ","permalink":"https://www.cheng92.com/vue/vue-my-plan/","tags":["vue3"],"title":"Vue3 å‘¨è¾¹æºç å­¦ä¹ è®¡åˆ’è¡¨"},{"categories":["vue"],"contents":"  vue èµ„æº: vuejs/awesome-vue: ğŸ‰ A curated list of awesome things related to Vue.js\n SSR æ¡†æ¶ï¼š Ream - A Vue 3 framework for building amazing apps\n import.meta   ç±»å‹å£°æ˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  interface ImportMeta { url: string readonly hot?: { readonly data: any accept(): void accept(cb: (mod: any) =\u0026gt; void): void accept(dep: string, cb: (mod: any) =\u0026gt; void): void accept(deps: readonly string[], cb: (mods: any[]) =\u0026gt; void): void /** * @deprecated */ acceptDeps(): never dispose(cb: (data: any) =\u0026gt; void): void decline(): void invalidate(): void on(event: string, cb: (...args: any[]) =\u0026gt; void): void } readonly env: ImportMetaEnv glob( pattern: string ): Record\u0026lt; string, () =\u0026gt; Promise\u0026lt;{ [key: string]: any }\u0026gt; \u0026gt; globEager( pattern: string ): Record\u0026lt; string, { [key: string]: any } \u0026gt; } interface ImportMetaEnv { [key: string]: string | boolean | undefined BASE_URL: string MODE: string DEV: boolean PROD: boolean }     å®é™…é¡¹ç›®è¾“å‡ºç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11  // import.meta import.meta.env = { url: \u0026#34;https://localhost:3000/src/main.ts\u0026#34;, env: { BASE_URL: \u0026#34;/\u0026#34;, MODE: \u0026#34;development\u0026#34;, DEV: true, PROD: false, SSR: false, }, };      é—®é¢˜åˆ—è¡¨    vite create-app ä¹‹åå¯åŠ¨é¡¹ç›®ï¼Œåœ¨ import çš„æ—¶å€™æ€»æç¤ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Ÿ\n   ä¿®æ”¹ vite.config.js å¢åŠ é…ç½®é¡¹ optimizeDeps -\u0026gt; exclude -\u0026gt; [\u0026#39;jsuites\u0026#39;]:\n   1 2 3 4 5 6 7 8 9 10  import { defineConfig } from \u0026#34;vite\u0026#34;; import vue from \u0026#34;@vitejs/plugin-vue\u0026#34;; // https://vitejs.dev/config/ export default defineConfig({ plugins: [vue()], optimizeDeps: { exclude: [\u0026#34;jsuites\u0026#34;], }, });      å¯ç”¨çš„ vue3 ui åº“ï¼Ÿ\n Vue 3 UI component library for 2021 - DEV Community\n ElementUI âœ… \u0026gt; Ionic ç§»åŠ¨ç«¯ âœ… \u0026gt; Primevue âœ… \u0026gt; Vuetify âŒ \u0026gt; Quasar âŒ\n  import bgImg from \u0026#39;../assets/bg.jpg\u0026#39; æ€»æ˜¯æŠ¥é”™ï¼Ÿ\n9:21:21 PM [vite] Internal server error: Failed to resolve import \u0026#34;/@/assets/login_bg.jpg\u0026#34;. Does the file exist?   è§ plugin-import-analysis åˆ†æã€‚\n    ","permalink":"https://www.cheng92.com/vue/vue-vite/","tags":["vue3,","vite"],"title":"Vue3 -\u003e Vite è„šæ‰‹æ¶"},{"categories":["issues"],"contents":"  å„ç§ç–‘éš¾æ‚ç—‡é›†åˆã€‚\n golang  go get æ— æ³•ä¸‹è½½é—®é¢˜ï¼Ÿ   Get https://proxy.golang.org/golang.org/x/tools/gopls/@v/list: dial tcp 172.217.160.81:443: i/o timeout\n https://shockerli.net/post/go-get-golang-org-x-solution/\n  export GO111MODULE=on\n  export GOPROXY=https://goproxy.io\n      emacs  lsp ä¸èƒ½è¯†åˆ« webpack/vite åˆ«åï¼Ÿ   Default FAQ js(ts)config for webpack aliases doesn\u0026#39;t work. Â· Issue #890 Â· vuejs/vetur\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  { \u0026#34;compilerOptions\u0026#34;: { \u0026#34;target\u0026#34;: \u0026#34;esnext\u0026#34;, \u0026#34;module\u0026#34;: \u0026#34;esnext\u0026#34;, \u0026#34;moduleResolution\u0026#34;: \u0026#34;node\u0026#34;, \u0026#34;strict\u0026#34;: true, \u0026#34;jsx\u0026#34;: \u0026#34;preserve\u0026#34;, \u0026#34;sourceMap\u0026#34;: true, \u0026#34;resolveJsonModule\u0026#34;: true, \u0026#34;esModuleInterop\u0026#34;: true, \u0026#34;lib\u0026#34;: [\u0026#34;esnext\u0026#34;, \u0026#34;dom\u0026#34;], + \u0026#34;paths\u0026#34;: { + \u0026#34;@/*\u0026#34;: [\u0026#34;src/*\u0026#34;] + }  }, \u0026#34;include\u0026#34;: [\u0026#34;src/**/*.ts\u0026#34;, \u0026#34;src/**/*.d.ts\u0026#34;, \u0026#34;src/**/*.tsx\u0026#34;, \u0026#34;src/**/*.vue\u0026#34;] }      åœ¨ tsconfig.json ä¸­å¢åŠ ä¸€é¡¹é…ç½® paths å‘Šè¯‰ lsp åˆ«åå«ä¹‰ã€‚\n  company-caf error   frontend company-pseudo-tooltip-frontend error - company-mode\nBut, I suppose I can get in ~/.emacs.d/.local/straight/repos/company-mode and git pull Did this but got this warning You are not currently on a branch. Please specify which branch you want to merge with. See git-pull(1) for details. =git pull \u0026lt;remote\u0026gt; \u0026lt;branch\u0026gt;=      web  require.cache ç¼“å­˜é—®é¢˜?   åœ¨å­¦ä¹  vue3.0 ä»£ç ä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ org-src-block ä¸­ require vue package æ–‡ ä»¶ï¼Œåœ¨ä¿®æ”¹è¿™ä¸ª js çš„æ—¶å€™æ‰§è¡Œ org-src-block æœ€åçš„ç»“æœæ€ä¹ˆéƒ½æ˜¯æ²¡ä¿®æ”¹ä¹‹å‰çš„ã€‚\n ç­”ï¼š å› ä¸º require ä¹‹å‰å¼•å…¥è¿‡å¯èƒ½è¢«ç¼“å­˜äº†èµ·æ¥ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‡½æ•°æ¥é¿å…å¼•å…¥å·²ç¼“å­˜çš„ æ¨¡å—ã€‚\n1 2 3 4 5  function requireUncached(module) { delete require.cache[require.resolve(module)]; return require(module); }     å³ã€‚åœ¨ require ä¹‹å‰å…ˆåˆ é™¤ç¼“å­˜ï¼Œç„¶åä½¿ç”¨ requireUncached(path) å»å¼•å…¥æ–‡ä»¶ã€‚\n   æ€ä¹ˆåœ¨ html ä¸­ä½¿ç”¨ .svg æ–‡ä»¶  1 2 3 4 5  \u0026lt;img src=\u0026#34;your.svg\u0026#34;/\u0026gt; \u0026lt;object data=\u0026#34;your.svg\u0026#34;/\u0026gt; \u0026lt;iframe src=\u0026#34;your.svg\u0026#34;/\u0026gt; \u0026lt;embed src=\u0026#34;your.svg\u0026#34;/\u0026gt; \u0026lt;div style=\u0026#34;background:url(your.svg)\u0026#34;\u0026gt;...\u0026lt;/div\u0026gt;      https://vecta.io/blog/best-way-to-embed-svg\n    google fonts åŠ é€Ÿ   ç›´è¿æ›´å¿«â€¦\n   site name ping     http://fonts.useso.com 360 unknown   http://fonts.lug.ustc.edu.cn ä¸­ç§‘å¤§ 66ms   http://fonts.css.network æ·é€Ÿç½‘ç»œ é¦™æ¸¯ 160ms   http://fonts.gmirror.org ä¸ƒç‰› timeout      IE8 è§£å†³ Object.defineProperty å…¼å®¹æ€§é—®é¢˜   http://lpsjj.cn/thread-222-1-1.html\n    typescript  TypeScript error: Property \u0026#39;X\u0026#39; does not exist on type \u0026#39;Window\u0026#39;  1  declare const window: any      TS2307: Cannot find module \u0026#39;X\u0026#39; or its corresponding type declarations.   æ˜¯å› ä¸ºæ‰¾ä¸åˆ° vue æ–‡ä»¶ï¼Œç›´æ¥åŠ ä¸Šåç¼€ x.vue å°±å¥½äº†ã€‚\n    macos   Can\u0026#39;t delete APFS local snapshots | Apple Developer Forums\n $ tmutil thinlocalsnapshots / 999999999999999 4\nLaTeX  basictex   Reference -\u0026gt;\n $ brew install --cask basictex\n å®‰è£…ä¹‹åï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ï¼Œä¸ç„¶æ‰¾ä¸åˆ° pdflatex ï¼š\nâ•­â”€simon@gcl ~ â•°â”€$ pdflatex zsh: command not found: pdflatex   æ‰‹åŠ¨å®‰è£…è¿‡ç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  # simon @ gcl in ~ [10:31:59] C:1 $ bash --login ~ The default interactive shell is now zsh. To update your account to use zsh, please run `chsh -s /bin/zsh`. For more details, please visit https://support.apple.com/kb/HT208050. gcl:~ simon$ which pdflatex /Library/TeX/texbin/pdflatex gcl:~ simon$ cd /usr/local/Caskroom/basictex/ gcl:basictex simon$ ls 2021.0325 gcl:basictex simon$ cd 2021.0325/ gcl:2021.0325 simon$ ls mactex-basictex-20210325.pkg gcl:2021.0325 simon$ open mactex-basictex-20210325.pkg          å…¶ä»–  Pulling without specifying how to reconcile divergent branches is â€¦ ?  WARNING\n hint: Pulling without specifying how to reconcile divergent branches is hint: discouraged. You can squelch this message by running one of the following hint: commands sometime before your next pull: hint: hint: git config pull.rebase false # merge (the default strategy) hint: git config pull.rebase true # rebase hint: git config pull.ff only # fast-forward only hint: hint: You can replace \u0026#34;git config\u0026#34; with \u0026#34;git config â€“global\u0026#34; to set a default hint: preference for all repositories. You can also pass â€“rebase, â€“no-rebase, hint: or â€“ff-only on the command line to override the configured default per hint: invocation.\n  ä¿®å¤:\n1 2  # å…¨å±€è®¾ç½® $ git config --global pull.ff only      kex_exchange_identification: read: Connection reset by peer?  WARNING\n $ git clone git@code.aliyun.com:gccll/cloudboss.git Cloning into \u0026#39;cloudboss\u0026#39;â€¦ kex_exchange_identification: read: Connection reset by peer fatal: Could not read from remote repository.\n Please make sure you have the correct access rights and the repository exists.\n  ç½‘ç»œé—®é¢˜ï¼Œç›´æ¥æ¢ä¸ªç½‘ç»œå°±è¡Œäº†ã€‚\n  hugo even ä¿®æ”¹ scss æ²¡ååº” ?   éœ€è¦ hugo extended ç‰ˆæœ¬ï¼š\n1 2 3 4 5 6 7  #/bin/bash mkdir $HOME/src cd $HOME/src git clone https://github.com/gohugoio/hugo.git cd hugo go install --tags extended     brew:\n1 2 3  $ brew install hugo $ cd /opt/local/bin $ ln -s /usr/local/bin/hugo /opt/local/bin/hugo      æ€ä¹ˆæ›´æ–°é¡¹ç›®ä¸­æ‰€æœ‰çš„ npm åŒ…?   å‚è€ƒé“¾æ¥ã€‚\n1 2 3 4 5  $ npm install -g npm-check-updates $ ncu -u $ npm update $ npm install $ ncu -u \u0026amp;\u0026amp; npm update \u0026amp;\u0026amp; npm install      git ignore æ— æ•ˆ(å¦‚ï¼š .log/)ï¼Ÿ  1 2 3 4 5 6 7  alias git-ignore-logs=\u0026#34;mv .log ~/Desktop \u0026amp;\u0026amp; git rm -r .log \u0026amp;\u0026amp; git commit -m \u0026#39;clear logs\u0026#39; \u0026amp;\u0026amp; git push\u0026#34; # commands $ mv .log ~/Desktop $ git rm -r .log $ git commit -m \u0026#34;clear logs\u0026#34; $ git push      åä¸ºæ‰‹æœºğŸ“±ç°åœ¨å“ªé‡Œå»ç°åœ¨è°·æ­Œå•†åŸ?   -\u0026gt; ä¸‹è½½åœ°å€\n  æ·»åŠ  submodule å¤±è´¥ ?  âœ cheng92.com git:(master) âœ— g-subm-add https://github.com/gcclll/hugo-theme-even.git themes/even A git directory for \u0026#39;themes/even\u0026#39; is found locally with remote(s): origin\thttps://github.com/olOwOlo/hugo-theme-even.git If you want to reuse this local git directory instead of cloning again from https://github.com/gcclll/hugo-theme-even.git use the \u0026#39;--force\u0026#39; option. If the local git directory is not the correct repo or you are unsure what this means choose another name with the \u0026#39;--name\u0026#39; option.   æœ¬æ„å°±æ˜¯ fork themes/even å‡ºæ¥ä¿®æ”¹ï¼Œç»“æœå‡ºç°é—®é¢˜ã€‚\n è§£å†³æ–¹æ¡ˆ 1:\n  $ git ls-files stage themes/even\n  $ git rm --cached themes/even\n  $ git submodule add https://github.com/gcclll/hugo-theme-even.git themes/even\n  è§£å†³æ–¹æ¡ˆ 2:\n  $ cd .git/modules\n  $ rm -rf themes/even\n  $ cd ../..\n  $ git submodule add https://github.com/gcclll/hugo-theme-even.git themes/even\n    ssh ç™»å½•æ¬¡æ•°è¿‡å¤šé—®é¢˜(many authentication)   $ ssh-add -D åˆ é™¤è®¤è¯ç¼“å­˜\n  macos install adb   $ /bin/bash -c \u0026#34;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)\u0026#34;\n $ brew cask install android-platform-tools\n $ adb devices\n  æ‰¹é‡ä¸‹è½½ bilibili è§†é¢‘(you-get å‘½ä»¤)ï¼Ÿ   macos in stall java environment ?   https://mkyong.com/java/how-to-install-java-on-mac-osx/\n $ brew tap adoptopenjdk/openjdk\n $ brew search jdk\n $ brew cask install adoptopenjdk11\n $ /usr/libexec/java_home -V\n $ java -version\n  git merge çš„æ—¶å€™å¿½ç•¥æŒ‡å®šæ–‡ä»¶ï¼Ÿ   https://www.jianshu.com/p/09b546b936a7\n  $ git config --global merge.ours.driver true\n  $ echo \u0026#39;index.php merge=ours\u0026#39; \u0026gt;\u0026gt; .gitattributes\n  $ git add .gitattributes\n  $ git commit -m \u0026#39;chore: Preserve index.php during merges\u0026#39;\n      ","permalink":"https://www.cheng92.com/post/issues/","tags":["issues"],"title":"å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„å„ç§ç–‘éš¾æ‚ç—‡"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n       stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n å£°æ˜ ï¼švue-next runtime-core ä¸­çš„ render å‡½æ•°éƒ¨åˆ†ï¼Œ\næœ¬ç¯‡æ‰€ä½¿ç”¨çš„çš„æµ‹è¯•ä¾‹å­æ˜¯æ™® é€šçš„æ•°å­—æ•°ç»„ï¼Œå®é™…ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ VNode ç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ä¸åŒèŠ‚ ç‚¹å…±äº«åŒä¸€ä¸ªå†…å­˜ç©ºé—´é—®é¢˜ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä½•ç”¨ä¾‹ä¸­æ²¡æœ‰é‡å¤æ•°å­—çš„åŸå› ã€‚(_å°±ç®—æ˜¯é™æ€çš„å¯ å¤ç”¨èŠ‚ç‚¹ä¹Ÿä¼šæ‰§è¡Œ cloneVNode å…‹éš†å‡ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡_)   æ›´æ–°æ—¥å¿—\u0026amp;Todos ï¼š\n  [2021-01-26 14:15:15] åˆ›å»º\n     2229 - 423 = 1806 ğŸ¤¦â€â™€ï¸ ä¸€ä¸ªå‡½æ•°å°±å°†è¿‘ä¸¤åƒè¡Œï¼ŒğŸ˜²ï¼ï¼\n æ·å¾„ğŸ‘£ï¼š\n  å¦‚æœåªæƒ³äº†è§£å¦‚ä½• diff ï¼Ÿ æ›´æ–°ï¼Ÿ\n   è„‘å›¾  runtime-core/src/render.ts è„‘å›¾ï¼š\n  render å‡½æ•°åˆ›å»ºå‡½æ•° baseCreateRender(options, createHydrationFns?)\n   init   feat(init): render function Â· gcclll/stb-vue-next@fb9738c Â· GitHub\n ä¸¤ä¸ª create render å‡½æ•°ï¼š\n  createRenderer(options)\n  createHydrationRenderer(options)\n è¿™ä¸ªè¿˜ä¸æ¸…æ¥šæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œé€šè¿‡ä»£ç è§‚å¯Ÿè²Œä¼¼è·Ÿ SSR æœ‰å…³ï¼Œå…ˆæç½®å…ˆä¸ç®¡ã€‚\n   ä¸¤ä¸ªå‡½æ•°æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„ baseCreateRenderer(options, createHydrationFns)\n å¹¶ä¸”å°±æ˜¯è¿™ä¸ªå‡½æ•°å°†è¿‘ä¸¤åƒè¡Œ~~~~\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  export function createRenderer\u0026lt; HostNode = RendererNode, HostElement = RendererElement \u0026gt;(options: RendererOptions\u0026lt;HostNode, HostElement\u0026gt;) { return baseCreateRenderer\u0026lt;HostNode, HostElement\u0026gt;(options); } export function createHydrationRenderer( options: RendererOptions\u0026lt;Node, Element\u0026gt; ) { return baseCreateRenderer(options, createHydrationFunctions); } // implementation function baseCreateRenderer( options: RendererOptions, createHydrationFns?: typeof createHydrationFunctions ) { // TODO }      function list   feat(init): renderer -\u0026gt; baseCreateRenderer TODOs Â· gcclll/stb-vue-next@b7f55a8 Â· GitHub\n baseCreateRenderer(options, createHydrationFns) ä¹‹æ‰€ä»¥è¿™ä¹ˆé•¿ï¼Œæ˜¯å› ä¸ºè¿™é‡Œé¢åŒ…å« äº†ä¸‰åå‡ ä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œä¸‹é¢å°†ä¸€ä¸ªä¸ªæŒ‰ç…§æµç¨‹é€ä¸€å®ç°ã€‚\n   step what? step what?     options è§£æ„ patch function   processText æ–‡æœ¬å¤„ç† processCommentNode æ³¨é‡ŠèŠ‚ç‚¹   mountStaticNode åŠ è½½é™æ€èŠ‚ç‚¹ patchStaticNode -   moveStaticNode - removeStaticNode åˆ é™¤é™æ€èŠ‚ç‚¹   processElement - mountElement -   setScopeId - mountChildren -   patchElement - patchBlockChildren -   patchProps - processFragment -   processComponent - mountComponent -   updateComponent - setupRenderEffect -   updateComponentPreRender - patchChildren -   patchUnkeyedChildren - patchKeyedChildren -   move  unmount    remove - removeFragment -   unmountComponent - unmountChildren -   getNextHostNode - render -   internals object, ä¸Šè¿°å‡½æ•°åˆ«å createHydrationFns -     æœ€åå‡½æ•°è¿”å› { render, hydrate, createApp }\n  render(vnode, container)   feat(init): baseCreateRender-\u0026gt; render Â· gcclll/stb-vue-next@9f5b40b Â· GitHub\n feat(init): baseCreateRender-\u0026gt; render with unmount Â· gcclll/stb-vue-next@d4e10d4 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13  const render: RootRenderFunction = (vnode, container) =\u0026gt; { // render(h(\u0026#39;div\u0026#39;), root)  if (vnode == null) { if (container._vnode) { unmount(container._vnode, null, null, true); } } else { patch(container._vnode || null, vnode, container); } // æ‰§è¡Œæ‰€æœ‰ post å¼‚æ­¥ä»»åŠ¡  flushPostFlushCbs(); container._vnode = vnode; };      vnode ä¸ºç©ºï¼Œä¸” conatainer ä¸Šæœ‰æ³¨å†Œè¿‡ _vnodeï¼Œç»„è¦è¿›è¡Œå¸è½½\n å¦‚ï¼š render(ref.value ? h(\u0026#39;div\u0026#39;) : null)\n ref.value = true æ—¶å€™è¿›å…¥ else -\u0026gt; patch\n ref.value = false æ—¶å€™è¿›å…¥ if -\u0026gt; unmount\n  å¦åˆ™æ‰§è¡Œ patch()ï¼Œå¹²ä»€ä¹ˆäº†?\n  flushPostFlushCbs() æ­¤æ—¶ç»„ä»¶åº”è¯¥ mounted äº†ï¼Œæ‰‹åŠ¨åˆ·æ‰æ‰€æœ‰ post cbs ã€‚\n  ä¿å­˜ _vnodeï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¿›å…¥æ˜¯æ£€æµ‹\n   æ¥ä¸‹æ¥ï¼Œéœ€è¦ç»§ç»­å®ç° unmount() å’Œ patch()\n  patch(â€¦args)   feat(init): baseCreateRender-\u0026gt; patch -\u0026gt; processElement Â· gcclll/stb-vue-next@eb48eb9 Â· GitHub\n å‚æ•°:\n   å‚æ•°å æè¿°     n1 VNode, è€èŠ‚ç‚¹   n2 VNode, æ–°èŠ‚ç‚¹   container å®¹å™¨   anchor ?   parentComponent çˆ¶çº§ç»„ä»¶   parentSuspense Suspense ?   isSVG ?   optimized æ˜¯å¦ä¼˜åŒ–è¿‡ï¼Ÿ      æ£€æµ‹èŠ‚ç‚¹ç±»å‹æ˜¯ä¸æ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸ä¸€æ ·ç›´æ¥å¸è½½è€çš„\n å› ä¸ºç±»å‹éƒ½ä¸ä¸€æ ·äº†ï¼Œå¯èƒ½æ•´ä¸ªğŸŒ²éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œç›´æ¥å¸è½½è€çš„é‡æ–° patch æ–°çš„(n2)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  export function isSameVNodeType(n1: VNode, n2: VNode): boolean { if ( __DEV__ \u0026amp;\u0026amp; n2.shapeFlag \u0026amp; ShapeFlags.COMPONENT \u0026amp;\u0026amp; hmrDirtyComponents.has(n2.type as ConcreteComponent) ) { // HMR only: if the component has been hot-updated, force a reload.  // ç»„ä»¶è¢«çƒ­æ›´æ–°ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½  return false; } return n1.type === n2.type \u0026amp;\u0026amp; n1.key === n2.key; }      ç»„ä»¶å‘ç”Ÿäº†çƒ­æ›´æ–°(HMRå¯ç”¨æƒ…å†µä¸‹)ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½ç»„ä»¶\n  åŒæ—¶åˆ¤æ–­ type å’Œ keyï¼Œæœ‰å¯èƒ½ type ä¸€æ ·(æ¯”å¦‚ï¼š ul\u0026gt;li åŒç±»å‹å…ƒç´ çš„åˆ é™¤ç§»åŠ¨æ“ä½œ)\n    switch -\u0026gt; n2.type æ ¹æ®ç±»å‹ä¸åŒèµ°ä¸åŒåˆ†æ”¯è¿›è¡Œå¤„ç†\n åªæ”¯æŒçš„ç±»å‹ï¼š Text|Comment|Static èŠ‚ç‚¹ç±»å‹\n ç»„ä»¶ç±»å‹(default åˆ†æ”¯): ELEMENT/TELEPORT/COMPONENT/SUSPENSE\n    patch-\u0026gt;processElement(â€¦args)   feat(init): baseCreateRender-\u0026gt; patch -\u0026gt; processElement imp Â· gcclll/stb-vue-next@761db2b Â· GitHub\n args åŒ patch çš„ args ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  const processElement = ( n1: VNode | null, n2: VNode, container: RendererElement, anchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVB: boolean, isSVG: boolean, optimized: boolean ) =\u0026gt; { isSVG = isSVG || (n2.type as string) === \u0026#34;svg\u0026#34;; if (n1 == null) { // no old  mountElement( n2, container, anchor, parentComponent, parentSuspense, isSVG, optimized ); } else { patchElement(n1, n2, parentComponent, parentSuspense, isSVG, optimized); } };      æ²¡æœ‰ n1 è€èŠ‚ç‚¹ï¼Œç›´æ¥ mount æ–°çš„ n2 èŠ‚ç‚¹\n  å¦åˆ™ï¼Œè¿›è¡Œ patch æ“ä½œ\n   æ¥ä¸‹æ¥æŒ‰ç…§ patchElement -\u0026gt; mountElement é¡ºåºå®ç°ã€‚\n  mountElement(â€¦args)   è¿›è¡Œåˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆæ­¥çš„åˆ¤æ–­ï¼Œ patch å’Œ mount çš„åŒºåˆ«ï¼Œ\n patch: éé¦–æ¬¡åŠ è½½ç»„ä»¶çš„æ—¶å€™ï¼Œç”¨ new å’Œ old vnode èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒç„¶åå¯¹å‘ç”Ÿå˜æ›´çš„ èŠ‚ç‚¹è¿›è¡Œæ›¿æ¢æˆ–æ›´æ–°æ“ä½œã€‚\n mount: å±äºé¦–æ¬¡åŠ è½½ç»„ä»¶çš„æ—¶å€™ï¼Œå±äºé‡æ–°åˆ›å»ºèŠ‚ç‚¹çš„æ“ä½œï¼Œä¸å­˜åœ¨æ¯”è¾ƒä»€ä¹ˆçš„ä¸€äº›æ“ ä½œã€‚\n æ¯”å¦‚ï¼š render é‡Œé¢çš„æ ¹æ® vnode æ¥åˆ¤æ–­æ˜¯ Unmount è¿˜æ˜¯ patchï¼Œä»¥åŠ processElement ä¸­æ ¹æ® old vnode æ¥æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰æ—§çš„èŠ‚ç‚¹(éé¦–æ¬¡)æ¥åˆ¤å®šæ˜¯ç›´æ¥ Mount ç»„ä»¶è¿˜æ˜¯ patch æ¯”è¾ƒæ›´æ–°ç»„ä»¶ã€‚\ndefault ELEMENT   feat(add): patch element Â· gcclll/stb-vue-next@81af385 Â· GitHub\n render å‡½æ•°å®ç°ï¼Œ vnode ä¸ºç©ºä¼šè¿›å…¥å¸è½½ unmount æµç¨‹ï¼Œå¦åˆ™æ‰§è¡Œçš„æ˜¯ patch ï¼Œè¿™ä¸ªåº” è¯¥å°±æ˜¯é€šè¿‡ vnode èŠ‚ç‚¹ç»“æ„æ‰§è¡Œ diff å’Œ dom æ“ä½œçš„å…¥å£äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const render: RootRenderFunction = (vnode, container) =\u0026gt; { console.log(\u0026#39;render.......xxx\u0026#39;) // render(h(\u0026#39;div\u0026#39;), root)  if (vnode == null) { if (container._vnode) { unmount(container._vnode, null, null, true) } } else { patch(container._vnode || null, vnode, container) } // æ‰§è¡Œæ‰€æœ‰ post å¼‚æ­¥ä»»åŠ¡  flushPostFlushCbs() container._vnode = vnode }     æ³¨æ„ä¸Šé¢çš„ flushPostFlushCbs() æ˜¯åœ¨ patch ä¹‹åæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ post cbs ä¼šåœ¨ç»„ ä»¶ mount/unmount å®Œæˆä¹‹åçš„ä¸‹ä¸€ä¸ª tick å»æ‰§è¡Œçš„å›è°ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  const patch: PatchFn = ( n1, n2, container, anchor = null, parentComponent = null, parentSuspense = null, isSVG = false, optimized = false ) =\u0026gt; { console.log(\u0026#39;patching...\u0026#39;) // ä¸åŒç±»å‹èŠ‚ç‚¹ï¼Œç›´æ¥å¸è½½è€çš„ğŸŒ²  if (n1 \u0026amp;\u0026amp; !isSameVNodeType(n1, n2)) { // TODO  } // TODO patch bail, è¿›è¡Œå…¨æ¯”è¾ƒ(full diff)  // æ–°èŠ‚ç‚¹å¤„ç†  const { type, ref, shapeFlag } = n2 switch (type) { default: // ELEMENT/COMPONENT/TELEPORT/SUSPENSE  // é»˜è®¤åªæ”¯æŒè¿™å››ç§ç»„ä»¶  if (shapeFlag \u0026amp; ShapeFlags.ELEMENT) { processElement( n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, optimized ) } break } if (ref != null \u0026amp;\u0026amp; parentComponent) { // TODO set ref  } }     patch å‡½æ•°é‡Œé¢é€šè¿‡ switch åˆ†æ”¯æ ¹æ® ShapeFlags çš„ç±»å‹ç±»è°ƒç”¨å¯¹åº”çš„ processXxx å‡½æ•°è¿›è¡Œå¤„ç† old/new vnode èŠ‚ç‚¹ï¼Œè€Œè¿™é‡Œçš„ ShapeFlags å€¼çš„ä¾æ®æ¥è‡ªå“ªé‡Œï¼Ÿæ˜¯åœ¨å“ª é‡Œèµ‹å€¼çš„ï¼Œç”±ç”±ä»€ä¹ˆä½œç”¨ï¼Ÿ ã€‚\n è¿™é‡Œä»¥æ™®é€šçš„ ELEMENT æ ‡ç­¾ä½œä¸ºåˆ‡å…¥ç‚¹æ¥å®ç°ä¸€ä¸ªå®Œæ•´çš„è¿‡ç¨‹ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ° processElement ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  const processElement = ( n1: VNode | null, n2: VNode, container: RendererElement, anchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { isSVG = isSVG || (n2.type as string) === \u0026#39;svg\u0026#39; if (n1 == null) { // no old  mountElement( n2, container, anchor, parentComponent, parentSuspense, isSVG, optimized ) } else { // è¯¥é˜¶æ®µè¿˜ä¸ä¼šåˆ°è¿™é‡Œ  patchElement(n1, n2, parentComponent, parentSuspense, isSVG, optimized) } }     è¿™é‡Œå°±æ˜¯ä¸ªå¾ˆç®€å• ifâ€¦else åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰æ—§çš„èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ˜¯ mount æœ‰åˆ™æ˜¯ patch æ“ä½œï¼Œ æ‰€ä»¥éœ€è¦å®Œæˆ mountElement\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  const mountElement = ( vnode: VNode, container: RendererElement, anchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { console.log(\u0026#39;mount element...\u0026#39;) let el: RendererElement let vnodeHook: VNodeHook | undefined | null const { type, shapeFlag, patchFlag, props } = vnode if ( !__DEV__ \u0026amp;\u0026amp; vnode.el \u0026amp;\u0026amp; hostCloneNode !== undefined \u0026amp;\u0026amp; patchFlag === PatchFlags.HOISTED ) { // TODO  } else { el = vnode.el = hostCreateElement( vnode.type as string, isSVG, props \u0026amp;\u0026amp; props.is ) } // hostInsert  hostInsert(el, container, anchor) }     mountElement é‡Œé¢ä¸¤ä¸ªæ ¸å¿ƒçš„å‡½æ•° hostCreateElement å’Œ hostInsert åˆ†åˆ«æ¥è‡ª baseCreateRender(option) çš„ option å‚æ•°ã€‚\n è¿™é‡Œå°±éœ€è¦æ·±å…¥äº†è§£ runtime-test è¿™ä¸ªåŒ…ï¼Œå®ƒæ˜¯ä½œç”¨ä¸ºäº†èƒ½æµ‹è¯• runtime-core ç¼–å†™çš„ ä¸€ä¸ªæµ‹è¯•æŠ¥ï¼Œè¿™é‡ŒåŒ…å«äº†ä¸€äº›åˆ—çš„ DOM æ“ä½œå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¹Ÿä¼šåœ¨å°è£… render çš„æ—¶å€™ ä¼ é€’ç»™ baseCreateRender(option) ï¼Œæ‰€ä»¥ä¸Šé¢çš„ hostElement å’Œ hostInsert å°±æ˜¯æ¥ è‡ª runtime-test ï¼Œè¿™é‡Œé“¾æ¥å¯ä»¥è·³è½¬æŸ¥çœ‹è¯¥åŒ…é‡Œé¢å…·ä½“åŒ…å«å“ªäº›å‡½æ•°ï¼Œåˆæ˜¯åšä»€ä¹ˆçš„ï¼Œ è¿™é‡Œå°±ä¸å±•å¼€ç»†è®²ï¼Œä¸»è¦çœ‹ä¸‹ç›¸å…³çš„ä¸¤ä¸ªå‡½æ•°å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function createElement(tag: string): TestElement { const node: TestElement = { id: nodeId++, type: NodeTypes.ELEMENT, tag, children: [], props: {}, parentNode: null, eventListeners: null } // ... log  // avoid test nodes from being observed  markRaw(node) return node } function insert(child: TestNode, parent: TestElement, ref?: TestNode | null) { let refIndex if (ref) { refIndex = parent.children.indexOf(ref) if (refIndex === -1) { console.error(\u0026#39;ref: \u0026#39;, ref) console.error(\u0026#39;parent: \u0026#39;, parent) throw new Error(\u0026#39;ref is not a child of parent\u0026#39;) } } //...log  // remove the node first, but don\u0026#39;t log it as a REMOVE op  remove(child, false) // re-calculate the ref index because the child\u0026#39;s removal may have affected it  refIndex = ref ? parent.children.indexOf(ref) : -1 if (refIndex === -1) { parent.children.push(child) child.parentNode = parent } else { parent.children.splice(refIndex, 0, child) child.parentNode = parent } }     æ‰€ä»¥è¯´ï¼Œæˆªè‡³ç›®å‰è¿˜å¹¶æ²¡æœ‰æ¶‰åŠåˆ°å®é™…çš„ DOM æ“ä½œï¼Œè¿˜åªæ˜¯åœ¨ vnode ç»“æ„ä¸Šè¿›è¡Œæ’å…¥åˆ é™¤ æ“ä½œã€‚\n è¿™é‡Œå¼€å§‹åº”è¯¥å¯ä»¥æµ‹è¯•äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { log, runtime_test } = require(process.env.BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); log(\u0026#34;xx\u0026#34;); runtime_test().then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let root = nodeOps.createElement(\u0026#34;div\u0026#34;); log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; root ast, è¿™é‡Œ children é‡Œé¢åº”è¯¥è¿˜æ²¡æœ‰èŠ‚ç‚¹\u0026#39;) log.f(root, [\u0026#39;type\u0026#39;, \u0026#39;children\u0026#39;]) log.f(h(\u0026#34;div\u0026#34;), [\u0026#34;type\u0026#34;]); log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; begin render...\u0026#39;) render(h(\u0026#34;div\u0026#34;), root); log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; after seririlize inner\u0026#39;) log(inner(root), [\u0026#39;type\u0026#39;, \u0026#39;children\u0026#39;]); }, (e) =\u0026gt; console.log(e.message) );    xx undefinedfalse \u0026gt;\u0026gt;\u0026gt; root ast, è¿™é‡Œ children é‡Œé¢åº”è¯¥è¿˜æ²¡æœ‰èŠ‚ç‚¹ { type: \u0026#39;element\u0026#39;, children: [] } { type: \u0026#39;div\u0026#39; } \u0026gt;\u0026gt;\u0026gt; begin render... render.......xxx patching... mount element... mountElment else... el = vnode.el = hostCreateElement = { id: 1, type: \u0026#39;element\u0026#39;, tag: \u0026#39;div\u0026#39;, children: [], props: {}, parentNode: null, eventListeners: null } \u0026lt;ref *1\u0026gt; { id: 0, type: \u0026#39;element\u0026#39;, tag: \u0026#39;div\u0026#39;, children: [ { id: 1, type: \u0026#39;element\u0026#39;, tag: \u0026#39;div\u0026#39;, children: [], props: {}, parentNode: [Circular *1], eventListeners: null } ], props: {}, parentNode: null, eventListeners: null } \u0026gt;\u0026gt;\u0026gt; after seririlize inner \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;   æ³¨æ„çœ‹ä¸Šé¢çš„ç»“æœï¼Œæœ€å h(\u0026#39;div\u0026#39;) ç”Ÿæˆçš„èŠ‚ç‚¹åˆ« insert è¿›äº† root.children ä¸­ï¼Œ ç„¶åæ³¨æ„ insert æœ€åçš„å®ç°æ’å…¥æ›¿æ¢éƒ¨åˆ†: å½“æ²¡æœ‰æ‰¾åˆ°æ—¶ refIndex = -1ï¼Œç›´æ¥æ‰§è¡Œ å°¾éƒ¨æ’å…¥æ“ä½œ push(...), å¦‚æœæ‰¾åˆ°äº†å°±æ‰§è¡Œ splice(refIndex, 1, child)\n æ‰€ä»¥è¿™é‡Œç›´æ¥æ‰§è¡Œçš„æ˜¯ç›´æ¥å°¾éƒ¨æ’å…¥æ“ä½œã€‚\n æœ€åè¾“å‡ºçš„ \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt; æ˜¯ç”±äºè°ƒç”¨äº† serializeInner(root) ç»“æœï¼Œä¹Ÿæ˜¯ç›¸å½“äº DOM æ“ä½œäº†(serializeInner -\u0026gt; seririlize\u0026gt;children -\u0026gt; serializeElement -\u0026gt; æœ€åæ ¹æ® tag, props, children é€’å½’è§£æç”Ÿæˆå¯¹åº”çš„ DOM å…ƒç´ ç»“æ„)ã€‚\n serializeElement å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  function serializeElement( node: TestElement, indent: number, depth: number ): string { const props = Object.keys(node.props) .map(key =\u0026gt; { const value = node.props[key] return isOn(key) || value == null ? `` : value === `` ? key : `${key}=${JSON.stringify(value)}` }) .filter(Boolean) .join(\u0026#39; \u0026#39;) const padding = indent ? ` `.repeat(indent).repeat(depth) : `` return ( `${padding}\u0026lt;${node.tag}${props ? ` ${props}` : ``}\u0026gt;` + `${serializeInner(node, indent, depth)}` + `${padding}\u0026lt;/${node.tag}\u0026gt;` ) }     æ‰€ä»¥åˆ°æ­¤åº”è¯¥æ˜¯å®Œæˆäº†æœ€æ™®é€šçš„ ELEMENT ç±»å‹å…ƒç´ ä»\n ast -\u0026gt; compiler-dom \u0026gt;\u0026gt; compiler-core \u0026gt;\u0026gt; compiler-sfc vnode -\u0026gt; runtime-core \u0026gt;\u0026gt; runtime-test(æµ‹è¯•ç”¨) render -\u0026gt; runtime-core \u0026gt;\u0026gt; baseCreateRender \u0026gt;\u0026gt; render \u0026gt;\u0026gt; mount/unmount/patch -\u0026gt; ç”Ÿæˆ DOM å…ƒç´ ç»“æ„è¾ƒä¸ºå®Œæ•´çš„ä»£ç ã€‚\n  with props   feat(add): baseRenderer-\u0026gt;element with props Â· gcclll/stb-vue-next@46fc2a0 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11  const { log, f, runtime_test } = require(process.env.BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); render(h(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: \u0026#34;bar\u0026#34; }), root); log(inner(root)); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render....... patching... mount element... mountElment else... \u0026lt;div id=\u0026#34;foo\u0026#34; class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;   æœ€åè¾“å‡ºç»“æœï¼š \u0026lt;div id=\u0026#34;foo\u0026#34; class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\n è¿˜è®°å¾— runtime-core \u0026gt; h function ä¸€èŠ‚æˆ‘ä»¬è¯¦ç»†æè¿°äº† h å‡½æ•°çš„ç”¨æ³•ï¼Œè¿™é‡Œç®€å•å›é¡¾ä¸‹\n   h ç¬¬äºŒä¸ªå‚æ•° æè¿°     æ™®é€šå¯¹è±¡ å½“åš props å¤„ç†   æ•°ç»„ç±»å‹ å½“åš children å¤„ç†   æ˜¯ä¸ª VNode ç±»å‹å¯¹è±¡ å¸¦æœ‰ __v_isVNode = true å±æ€§ï¼Œ [vnode] å½“åš children å¤„ç†     æ‰€ä»¥ä¸Šé¢çš„ { id: \u0026#39;foo\u0026#39;, class: \u0026#39;bar\u0026#39; } è¢«å½“åšå±æ€§ä¼ é€’ç»™ createVNode(type, props, children ...) å‡½æ•°\n æ–°å¢ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  // mountElement å¢åŠ  props å¤„ç†é€»è¾‘ const mountElement = ( vnode: VNode, container: RendererElement, anchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { console.log(\u0026#39;mount element...\u0026#39;) // TODO  let el: RendererElement let vnodeHook: VNodeHook | undefined | null const { type, shapeFlag, patchFlag, props } = vnode if ( !__DEV__ \u0026amp;\u0026amp; vnode.el \u0026amp;\u0026amp; hostCloneNode !== undefined \u0026amp;\u0026amp; patchFlag === PatchFlags.HOISTED ) { // ...  } else { // æ–°å¢ start  if (props) { for (const key in props) { // vue ä¿ç•™å±æ€§ ref/key/onVnodeXxx ç”Ÿå‘½å‘¨æœŸ  if (!isReservedProp(key)) { hostPatchProp( el, key, null, props[key], isSVG, vnode.children as VNode[], parentComponent, parentSuspense, unmountChildren ) } } if ((vnodeHook = props.onVnodeBeforeMount)) { // æ‰§è¡Œ before mount hook  invokeVNodeHook(vnodeHook, parentComponent, vnode) } } // end æ–°å¢  } // ...  }     render -\u0026gt; patch -\u0026gt; case ELEMENT -\u0026gt; processElement -\u0026gt; mountElement\n åœ¨ mountElement ä¸­å¢åŠ  props å¤„ç†é€»è¾‘ï¼Œé’ˆå¯¹æ¯ä¸ª prop æ£€æµ‹æ˜¯ä¸æ˜¯ä¿ç•™åå­—\n key/ref/onVnodeXxx ç­‰ç”Ÿå‘½å‘¨æœŸåï¼Œéä¿ç•™åå­—æ‰éœ€è¦å¤„ç†ï¼Œè°ƒç”¨ hostPatchProp() å¤„ ç†ï¼Œåé¢åŠ ä¸Š BeforeMount ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°è°ƒç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // runtime-test/src/patchProp.ts export function patchProp( el: TestElement, key: string, prevValue: any, nextValue: any ) { logNodeOp({ type: NodeOpTypes.PATCH, targetNode: el, propKey: key, propPrevValue: prevValue, propNextValue: nextValue }) el.props[key] = nextValue if (isOn(key)) { const event = key.slice(2).toLowerCase() ;(el.eventListeners || (el.eventListeners = {}))[event] = nextValue } }     æ™®é€šå±æ€§ç›´æ¥æ›´æ–°åˆ° el.props ä¸­ï¼Œå¦‚æœæ˜¯ onXxx ç±»å‹çš„äº‹ä»¶ï¼Œå–å‡º xxx ä½œä¸º el.eventListeners çš„ key å°†äº‹ä»¶åå’Œå…¶å¤„ç†å¥æŸ„ä¿å­˜èµ·æ¥ã€‚\n è¿™é‡Œçš„ el å®é™…ä¸Šæ˜¯ä¸ª ast ç»“æ„ç±»å‹çš„å¯¹è±¡ï¼Œä¿å­˜è¿™æ¯ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ä¿¡æ¯ã€‚\n  with text children  çº¯æ–‡æœ¬å•èŠ‚ç‚¹ child   å°†çº¯æ–‡æœ¬åšä¸º child ï¼Œå°†ä¼šè¢« h å‡½æ•°è½¬æˆ [child] ä¼ é€’ç»™ createVNode(type, props, children, ...) åšä¸ºå®ƒçš„children å‚æ•°å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { log, f, runtime_test } = require(process.env.BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { const _root = tag =\u0026gt; nodeOps.createElement(tag || \u0026#34;div\u0026#34;) log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; çº¯æ–‡æœ¬ä½œä¸º children\u0026#39;) const r1 = _root() render(h(\u0026#39;div\u0026#39;, \u0026#39;pure test as children\u0026#39;), r1); log(inner(r1)); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse \u0026gt;\u0026gt;\u0026gt; çº¯æ–‡æœ¬ä½œä¸º children render....... patching... mount element... mountElment else... \u0026lt;div\u0026gt;pure test as children\u0026lt;/div\u0026gt;   ä¸Šé¢ç¤ºä¾‹æ˜¯å°†çº¯æ–‡æœ¬ä½œä¸º children å»æ¸²æŸ“è¿› root èŠ‚ç‚¹ï¼Œæ¶‰åŠä»£ç ä¿®æ”¹(mountElement()):\n feat(add): pure text as children to render Â· gcclll/stb-vue-next@43b868e Â· GitHub\n   æ•°ç»„ç±»å‹(å¤šä¸ª) children:   feat(add): render-\u0026gt;array children Â· gcclll/stb-vue-next@e6a5e61 Â· GitHub\n å½“ h(type, propsOrChildren) ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ•°ç»„æ—¶ä¼šè¢«å½“åš children ç»™ createVNode ã€‚\n1 2 3 4 5 6 7 8 9 10 11  const { log, f, runtime_test } = require(process.env.BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); render(h(\u0026#34;div\u0026#34;, [\u0026#34;foo\u0026#34;, \u0026#34; \u0026#34;, \u0026#34;bar\u0026#34;]), root); log(inner(root)); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render....... patching... { type: \u0026#39;div\u0026#39;, shapeFlag: 17 } xxxx case default... process element... mount element... mountElment else... patching... { type: Symbol(Text), shapeFlag: 8 } process text... patching... { type: Symbol(Text), shapeFlag: 8 } process text... patching... { type: Symbol(Text), shapeFlag: 8 } process text... \u0026lt;div\u0026gt;foo bar\u0026lt;/div\u0026gt;   ä»ä¸Šé¢çš„è¾“å‡ºå¯å¾—å‡º render(h(\u0026#39;div\u0026#39;), [\u0026#39;foo\u0026#39;, \u0026#39; \u0026#39;, \u0026#39;bar\u0026#39;]), root) å¤§æ¦‚æ‰§è¡Œæµç¨‹:\n  root-\u0026gt;div\n  render, æ ¹æ® vnode ä¸ºç©ºæ£€æµ‹å†³å®šæ˜¯ unmount è¿˜æ˜¯ patch\n  patch, æ ¹æ® new vnode çš„ type(å››ç§ç±» å‹ Text|Comment|Fragment|Static|default ) å†³ å®šè°ƒç”¨ä»€ä¹ˆ processXxx è¿›è¡Œå¤„ç†\n  case default ç”±äºè¿™é‡Œæ˜¯æ ¹èŠ‚ç‚¹ï¼Œä¸”æ˜¯ \u0026#39;div\u0026#39; æ™®é€šç±»å‹å…ƒç´ ï¼Œè¿›å…¥ processElement\n  processElement, æ ¹æ® old vnode åˆ¤æ–­æ˜¯ mount è¿˜æ˜¯ patch æ“ä½œ\n  æ—  old vnode, æ²¡æœ‰æ—§çš„vnodeè¡¨ç¤ºæ˜¯æ–°èŠ‚ç‚¹ï¼Œéœ€è¦æ‰§è¡Œ mount æ“ä½œ\n  mountElement, éœ€è¦æ£€æµ‹ vnode.el æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯é™æ€æå‡çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯é™æ€èŠ‚ç‚¹ å±äºå¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œéœ€è¦ cloneVNode å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„\n  else: hostCreateElement åˆ›å»ºæ–°çš„å…ƒç´ ï¼Œç„¶åé€šè¿‡ shapeFlag åˆ¤æ–­ children æ˜¯ä»€ä¹ˆç±»å‹è¿›å…¥ä¸åŒåˆ†æ”¯è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œæ˜¯æ•°ç»„(ShapeFlags.ARRAY_CHILDREN) æ‰€ ä»¥ä¼šè°ƒç”¨ mountChildren(vnode.children, el, ...) å¼€å§‹ mount children.\n  mountChldren , ä¼šå¯¹ children è¿›è¡Œéå†ï¼Œå¦‚æœ child.el å­˜åœ¨è¯´æ˜æ˜¯å¯å¤ç”¨èŠ‚ç‚¹ (é™æ€æå‡çš„)ï¼Œåˆ™å°† child clone å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™è¿›è¡Œ normailize å¤„ç†(å…¶å®ä¹Ÿå°± æ˜¯æ ¹æ® child æ•°æ®ç±»å‹ä¸åŒæ‰§è¡Œ createVNode è¿”å›æ–°çš„ vnode ç»™ child)ï¼Œæœ€åå°† child ä¼ å…¥ patch å›åˆ°ç¬¬ äºŒæ­¥è¿›è¡Œé€’å½’ mount children\n    root-\u0026gt;div-\u0026gt;\u0026#39;foo\u0026#39;\n åœ¨ 1 æœ€åè¿›å…¥é€’å½’ä¹‹åï¼Œä¼šè¿›å…¥åˆ° patch æ£€æµ‹åˆ° type æ˜¯ Text ç±»å‹ï¼Œå»è°ƒç”¨ processText() å¤„ç† \u0026#39;foo\u0026#39; å®Œæˆä¹‹åï¼Œå†å›æº¯é€’å½’å¤„ç†ä¸‹ä¸€ä¸ªå…ƒç´  \u0026#39; \u0026#39; ç›´åˆ°ç»“æŸã€‚\n  root-\u0026gt;div-\u0026gt;\u0026#39; \u0026#39; åŒ 2\n  root-\u0026gt;idv-\u0026gt;\u0026#39;bar\u0026#39; åŒ 2\n   æ¶‰åŠä¿®æ”¹å†…å®¹(renderer.ts -\u0026gt; baseCreateRender)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96  // patch() // å¢åŠ  Text ç±»å‹åˆ†æ”¯å¤„ç† children: [\u0026#39;foo\u0026#39;, \u0026#39; \u0026#39;, \u0026#39;bar\u0026#39;] switch (type) { case Text: processText(n1, n2, container, anchor); break; } // æ–°å¢ processText(n1, n2, container, anchor) const processText: ProcessTextOrCommentFn = (n1, n2, container, anchor) =\u0026gt; { console.log(\u0026#34;process text...\u0026#34;); if (n1 == null /* old */) { // æ–°èŠ‚ç‚¹ï¼Œæ’å…¥å¤„ç†  hostInsert( (n2.el = hostCreateText(n2.children as string)), container, anchor ); } else { // has old vnode, need to diff  } }; // hostInert -\u0026gt; å°† child insert åˆ° container.children ä¸­å» // hostCreateText -\u0026gt; åˆ›å»º TEXT ç±»å‹çš„èŠ‚ç‚¹ç»“æ„ // runtime-test/src/nodeOps.ts -\u0026gt; createText const node: TestText = { id: nodeId++, type: NodeTypes.TEXT, text, parentNode: null, }; // processElement -\u0026gt; mountElement å¢åŠ  ARRAY_CHILDREN // åˆ†æ”¯å¤„ç†ï¼Œ mountChildren /* else */ if (shapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { mountChildren( vnode.children as VNodeArrayChildren, el, null, parentComponent, parentSuspense, isSVG \u0026amp;\u0026amp; type !== \u0026#34;foreignObject\u0026#34;, optimized || !!vnode.dynamicChildren ); } // mountChildren éå† vnode.children // é€’å½’è°ƒç”¨ patch() å¤„ç†æ¯ä¸ª child // cloneIfMounted æ˜¯éœ€è¦ä¼˜åŒ–(é™æ€æå‡çš„èŠ‚ç‚¹)ï¼Œå¯å¤ç”¨çš„èŠ‚ç‚¹ // å°†å…¶ clone å‡ºä¸€ä»½æ–°çš„ vnode å‡ºæ¥ä½¿ç”¨ // normailizeVNode æ˜¯æ ¹æ® child çš„æ•°æ®ç±»å‹ä¸åŒæ‰§è¡Œ createVNode è¿”å› // æ–°çš„ vnode æˆ– child æœ¬èº«(vnode.el å­˜åœ¨çš„æƒ…å†µï¼Œè¢«å¤ç”¨äº†) const mountChildren: MountChildrenFn = ( children, container, anchor, parentComponent, parentSuspense, isSVG, optimized, start = 0 ) =\u0026gt; { for (let i = start; i \u0026lt; children.length; i++) { const child = (children[i] = optimized ? // è¿™é‡Œæ˜¯æ£€æµ‹ child.el æ˜¯ä¸æ˜¯å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ˜¯å¯æœç”¨çš„ vnode  // å³éœ€è¦æå‡çš„é™æ€èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦è¿›è¡Œ cloneVNode ä¹‹åè¿”å›  // æ–°çš„ vnode å¯¹è±¡  cloneIfMounted(children[i] as VNode) : // æ ¹æ® child çš„ç±»å‹è¿›è¡Œæ‹†åˆ†å¤„ç†  // 1. boolean, åˆ›å»ºä¸€ä¸ªç©ºçš„ Comment  // 2. array, ä½¿ç”¨ Fragment å°† child åŒ…èµ·æ¥  // 3. object, å¦‚æœæ˜¯å¯¹è±¡ï¼Œchild.el å­˜åœ¨ä¸å¦è¿›è¡Œ clone  // 4. å…¶ä»–æƒ…å†µï¼Œå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œå½“åš Text ç±»å‹å¤„ç†  normalizeVNode(children[i])); // ç„¶åè¿›å…¥ patch é€’å½’å¤„ç† children  patch( null, child, container, anchor, parentComponent, parentSuspense, isSVG, optimized ); } }; // cloneIfMounted æ˜¯æ£€æµ‹ vnode.el æ˜¯ä¸æ˜¯å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨è¯´æ˜æœ‰å¤ç”¨çš„æƒ…å†µ // é’ˆå¯¹ template-compiled render fns åšçš„ä¼˜åŒ– export function cloneIfMounted(child: VNode): VNode { // child.el å¦‚æœå­˜åœ¨çš„è¯ï¼Œchild å±äºé™æ€èŠ‚ç‚¹ä¼šè¢«é™æ€æå‡  // æ‰€ä»¥éœ€è¦ clone ä¸€ä»½å‡ºæ¥ï¼Œå¦åˆ™ç›´æ¥è¿”å› child  return child.el === null ? child : cloneVNode(child); }        children+props æ··åˆæµ‹è¯•  1 2 3 4 5 6 7 8 9 10 11  const { log, f, runtime_test } = require(process.env.BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { const root = nodeOps.createElement(\u0026#34;div\u0026#34;); render(h(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: \u0026#39;baz\u0026#39; }, [\u0026#34;bar\u0026#34;, \u0026#39; \u0026#39;, h(\u0026#39;div\u0026#39;)]), root); log(inner(root)); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render....... patching... { type: \u0026#39;div\u0026#39;, shapeFlag: 17 } xxxx case default... process element... mount element... mountElment else... patching... { type: Symbol(Text), shapeFlag: 8 } process text... patching... { type: Symbol(Text), shapeFlag: 8 } process text... patching... { type: \u0026#39;div\u0026#39;, shapeFlag: 1 } xxxx case default... process element... mount element... mountElment else... \u0026lt;div id=\u0026#34;foo\u0026#34; class=\u0026#34;baz\u0026#34;\u0026gt;bar \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;    å°ç»“   æ‰§è¡Œæµç¨‹ï¼š\n render() -\u0026gt; vnode !== null -\u0026gt; patch() -\u0026gt; switch case -\u0026gt;\n default: processElement() -\u0026gt; ç”±äºæ˜¯é¦–æ¬¡åŠ è½½ old vnode ä¸º null -\u0026gt;\n æ‰€ä»¥æ‰§è¡Œ mountElement() æ–°åˆ›å»ºå…ƒç´ è¿›è¡Œ mount æ“ä½œã€‚\n mountElement() é‡Œé¢åŒºåˆ†æ˜¯å¦æ˜¯å¯å¤ç”¨ç»„ä»¶(HOISTED, é™æ€æå‡çš„ç»„ä»¶)ï¼Œé€šè¿‡æ£€æµ‹ vnode.el æ˜¯å¦æœ‰å€¼ï¼Œå› ä¸ºå¦‚æœæ›¾ç»è¢«ä½¿ç”¨è¿‡å¿…å®šä¼šè¿›å…¥ mountElement -\u0026gt; else å¯¹ vnode.el è¿›è¡Œèµ‹å€¼æ“ä½œã€‚\n å¦‚æœæ˜¯å¯å¤ç”¨çš„ç»„ä»¶ï¼Œç›´æ¥ clone ä¸€ä»½æ–°çš„ vnode å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™è¿›å…¥ else åˆ†æ”¯ createElement åˆ›å»ºæ–°çš„èŠ‚ç‚¹ el = vnode.el = hostCreateElement(...) ã€‚\n åœ¨ mountElement ä¸­ä¼˜å…ˆå¯¹ children è¿›è¡Œ mountï¼Œç„¶åå¤„ç† props ï¼Œå› ä¸ºæœ‰äº›æ—¶å€™ props éœ€è¦ä¾èµ– children æ˜¯ä¸æ˜¯åŠ è½½å®Œæˆäº†ï¼Œæ¯”å¦‚: \u0026lt;option value\u0026gt; å…ƒç´ ï¼Œéœ€è¦æ ¹æ® value æœ€ç»ˆçš„å€¼é€‰æ‹©ä½¿ç”¨å“ªä¸ª child(å‰ææ˜¯è¿™ä¸ª child å¿…é¡»å·²ç»åŠ è½½å®Œæˆäº†) ã€‚\n children çš„å¤„ç†ï¼Œæœ‰ä¸¤ä¸ªç±»å‹åˆ†æ”¯å¤„ç†(TEXT_CHILDREN å’Œ ARRAY_CHILDREN)ï¼Œä¸ºä»€ä¹ˆ åªæœ‰ä¸¤ä¸ªå‘¢ï¼Ÿ\n è¿™æ˜¯å› ä¸ºåœ¨ createVNode() å‡½æ•°ä¸­ä¼šè°ƒç”¨ normalizeChildren() å¯¹ children è¿›è¡Œ æ£€æµ‹ï¼Œåˆ†å‡ ç§æƒ…å†µå¤„ç†ï¼š\n   children ç±»å‹ type(ShapeFlags) æè¿°     Array ARRAY_CHILDREN -   Object SLOTS_CHILDREN åŒºåˆ†æ˜¯ ELEMENT/TELEPORT æˆ–å…¶ä»–ç±»å‹   Function SLOTS_CHILDREN å‡½æ•°ç›´æ¥å½“åšæ’æ§½å¤„ç†   String æˆ– Number TEXT_CHILDREN å½“åšæ–‡æœ¬å¤„ç†     ä¸Šé¢æœ‰ä¸ªæ’æ§½ç±»å‹ï¼Œè¿˜è®°å¾— compiler-core é‡Œé¢å¯¹æ’æ§½çš„ç¼–è¯‘ç»“æœå—ï¼Ÿ\n compiler-core é˜¶æ®µå¯¹ slotæ ‡ç­¾å’Œ v-slot çš„è§£ææºç åˆ†æ -\u0026gt;\n å¤§è‡´è§£æç»“æœå°±æ˜¯ç»„ä»¶å†…çš„æ‰€æœ‰å…ƒç´ æŒ‰ç…§ä¸€å®šçš„è§„åˆ™è§£ææˆæ’æ§½ï¼Œæœ€åç”Ÿæˆçš„ render å‡½æ•° å¤§æ¦‚æ˜¯ï¼š\n1 2 3 4 5 6  return (_openBlock(), _createBlock(\u0026#39;Comp\u0026#39;, null /* props */, { // é»˜è®¤æ’æ§½  defualt: _withCtx(() =\u0026gt; [ /* ...slot children... */ ]), [named]: _withCtx(() =\u0026gt; [/* åŠ¨æ€å…·åæ’æ§½ */]), name: _withCtx(() =\u0026gt; [/* å…·åæ’æ§½ */]), }))     æ‰€ä»¥å½“ children æ˜¯ä¸ªå¯¹è±¡çš„æ—¶å€™åœ¨ createVNode() -\u0026gt; normalizeChildren() ä¸­ä¼šè¢« å½“åšæ’æ§½æ¥å¤„ç†ã€‚\n    patchElement   render() -\u0026gt; patch() -\u0026gt; processElement() -\u0026gt;\n å½“æ£€æµ‹åˆ° old vnode å­˜åœ¨çš„æ—¶å€™ä¼šè¿›å…¥åˆ°è¿™ä¸ªå‡½æ•° patchElement() è¿›è¡Œæ›´æ–°æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  const patchElement = ( n1: VNode, n2: VNode, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { // æ—§çš„ el æ›¿æ¢æ‰æ–°çš„ el ?  // const el = (n2.el = n1.el!)  let { patchFlag, dynamicChildren } = n2 // #1426 take the old vnode\u0026#39;s patch flag into account since user may clone a  // compiler-generated vnode, which de-opts to FULL_PROPS  patchFlag |= n1.patchFlag \u0026amp; PatchFlags.FULL_PROPS // const oldProps = n1.props || EMPTY_OBJ  // const newProps = n2.props || EMPTY_OBJ  // TODO before update hooks  // TODO dirs, æŒ‡ä»¤å¤„ç†  // TODO HRM updating  if (patchFlag \u0026gt; 0) { console.log(`patch flag \u0026gt; 0 ? ${patchFlag}`) } else if (!optimized \u0026amp;\u0026amp; dynamicChildren == null) { console.log({ optimized, patchFlag }) } // const areaChildrenSVG = isSVG \u0026amp;\u0026amp; n2.type !== \u0026#39;foreignObject\u0026#39;  if (dynamicChildren) { console.log(\u0026#39;dynamic children...\u0026#39;) } else if (!optimized) { console.log(\u0026#39;optimized null, éå¯å¤ç”¨èŠ‚ç‚¹\u0026#39;) } // TODO vnode hook or dirs å¤„ç†  }    å…ˆåšä¸ªæµ‹è¯•ï¼Œçœ‹ä¸‹ä»£ç æ‰§è¡Œæµç¨‹(patchElement() é‡Œé¢åŠ äº†ç‚¹æ‰“å°)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { log, f, shuffle, toSpan: _toSpan, runtime_test } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm let root = nodeOps.createElement(\u0026#34;div\u0026#34;); const toSpan = (v) =\u0026gt; _toSpan(v, h); const renderChildren = (arr) =\u0026gt; { // ç»™ root\u0026gt;div ä¸­æ’å…¥ children  // \u0026lt;div\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;...\u0026lt;/div\u0026gt;  render(h(\u0026#34;div\u0026#34;, arr.map(toSpan)), root); return root.children[0]; }; // root ä¸ŠæŒ‚ä¸€ä¸ª \u0026#39;\u0026lt;div id=\u0026#34;1\u0026#34;\u0026gt;hello\u0026lt;/div\u0026gt;\u0026#39;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); // å¢åŠ ä¸€ä¸ª \u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;  elm = renderChildren([1]) log(`elm.children.length = ${elm.children.length}`) }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render()... patch()... processElement()... mountElement()... mountElment else... render()... patch()... processElement()... patchElement()... { optimized: false, patchFlag: 0 } optimized null, éå¯å¤ç”¨èŠ‚ç‚¹ patchChildren()... patchChildren, é text children patchChildren, é text children, é array children... elm.children.length = 1   ä»ä¸Šé¢çš„ç»“æœå¯çŸ¥æˆ‘ä»¬è¯¥é˜¶æ®µéœ€è¦å®ç°çš„éƒ¨åˆ†ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  // patchElement() // è¿™é‡Œæ˜¯ props å¤„ç† /* else */ if (!optimized \u0026amp;\u0026amp; dynamicChildren == null) { console.log({ optimized, patchFlag }); // TODO patchProps } // å’Œ /* else */ if (!optimized) { console.log(\u0026#34;optimized null, éå¯å¤ç”¨èŠ‚ç‚¹\u0026#34;); } // patchChildren() /* else */ { console.log(\u0026#34;patchChildren, old é text children\u0026#34;); /* else */ { console.log( \u0026#34;patchChildren, old é text children, new é array children...\u0026#34; ); // prev children was text or null  // new children is array or null  // è€çš„ children æ˜¯ textï¼Œæ–°çš„åˆæ˜¯æ•°ç»„æƒ…å†µ  if (prevShapeFlag \u0026amp; ShapeFlags.TEXT_CHILDREN) { // å…ˆæ¸…ç©ºï¼Ÿ  hostSetElementText(container, \u0026#34;\u0026#34;); } // ç„¶åç›´æ¥é‡æ–°åŠ è½½æ–°çš„ array children -\u0026gt; c2  // old children æ˜¯ array  if (shapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { mountChildren( c2 as VNodeArrayChildren, container, anchor, parentComponent, parentSuspense, isSVG, optimized ); } } }     é‡æ–°æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { log, f, shuffle, toSpan: _toSpan, runtime_test } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm let root = nodeOps.createElement(\u0026#34;div\u0026#34;); const toSpan = (v) =\u0026gt; _toSpan(v, h); const renderChildren = (arr) =\u0026gt; { // ç»™ root\u0026gt;div ä¸­æ’å…¥ children  // \u0026lt;div\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;...\u0026lt;/div\u0026gt;  render(h(\u0026#34;div\u0026#34;, arr.map(toSpan)), root); return root.children[0]; }; // root ä¸ŠæŒ‚ä¸€ä¸ª \u0026#39;\u0026lt;div id=\u0026#34;1\u0026#34;\u0026gt;hello\u0026lt;/div\u0026gt;\u0026#39;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); // å¢åŠ ä¸€ä¸ª \u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;  elm = renderChildren([1]) log(`elm.children.length = ${elm.children.length}`) }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render()... patch()... processElement()... mountElement()... mountElment else... render()... patch()... processElement()... patchElement()... { optimized: false, patchFlag: 0 } optimized null, éå¯å¤ç”¨èŠ‚ç‚¹ patchChildren()... patchChildren, old é text children patchChildren, old é text children, new é array children... patch()... processElement()... mountElement()... mountElment else... elm.children.length = 1   å› æ­¤åˆ°è¿™é‡Œå°†ä¼šè¿›å…¥ patchChildren(n1, n2, â€¦) å»è§£æ \u0026#34;hello\u0026#34; è¿™ä¸ªæ–‡æœ¬å­©å­èŠ‚ç‚¹ã€‚\n feat(add): patchElement-\u0026gt;patchChildren Â· gcclll/stb-vue-next@26d2bfd\n  patchChildren(n1,n2,â€¦)    ç®€åŒ–ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  const patchChildren: PatchChildrenFn = (n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, optimized = false) { if (patchFlag \u0026gt; 0) { if (patchFlag \u0026amp; PatchFlags.KEYED_FRAGMENT) { // é’ˆå¯¹æœ‰ key å±æ€§è¢« fragment åŒ…è£¹èµ·æ¥çš„å…ƒç´ (ä¾‹å¦‚ï¼š v-for)  // ... patchKeyedChildren(...)  return } else if (patchFlag \u0026amp; PatchFlags.UNKEYED_FRAGMENT) { // ... patchUnkeyedChildren(...)  return } } // children æœ‰ä¸‰ç§å¯èƒ½ï¼Œtext, array, æˆ–æ²¡æœ‰å­©å­èŠ‚ç‚¹  if (shapeFlag \u0026amp; ShapeFlags.TEXT_CHILDREN) { // text children  if (prevShapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { // å¦‚æœæ˜¯æ•°ç»„ï¼Œç›´æ¥ unmount æ‰  // unmountChildren(c1, ...)  } if (c2 !== c1) { // hostSetElementText(container, c2) ç›´æ¥æ›¿æ¢æ–‡æœ¬  } } else { // éæ–‡æœ¬èŠ‚ç‚¹å¤„ç†  if (prevShapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { // ä¹‹å‰çš„ children æ˜¯ æ•°ç»„ç±»å‹  if (shapeFlag \u0026amp; shapeFlag.ARRAY_CHILDREN) { // æ–°çš„ä¹Ÿæ˜¯æ•°ç»„ï¼Œç›´æ¥è¿›è¡Œ full diff  // patchKeyedChildren(...)  } else { // åˆ°è¿™é‡Œè¡¨ç¤ºæ²¡æœ‰æ–°çš„å­©å­èŠ‚ç‚¹ï¼Œç­‰ä»·äºåˆ é™¤æ“ä½œï¼Œç›´æ¥å¸è½½è€çš„å°±è¡Œ  // unmountChildren(c1, ...)  } } else { // è¿™ç§æƒ…å†µï¼Œold æ˜¯ text | null  // æ–°çš„æ˜¯æ•°ç»„æˆ– null  if (prevShapeFlag \u0026amp; ShapeFlags.TEXT_CHILDREN){ // å…ˆæ¸…ç©ºè€çš„æ–‡æœ¬èŠ‚ç‚¹  // hostSetElementText(container, \u0026#39;\u0026#39;)  } // å¦‚æœæ–°çš„æ˜¯æ•°ç»„ï¼Œç›´æ¥ mountï¼Œå› ä¸ºä¹‹å‰çš„å¦‚æœæ˜¯æ–‡æœ¬åœ¨ä¸Šé¢å·²ç»æ¸…ç©ºäº†  if (shapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { // mountChildren(c2, container, ...)  } } } }     æ‰€ä»¥æ€»ç»“ä¸‹æ¥æœ‰å‡ ç§æƒ…å†µçš„ç»„åˆï¼š\n  é¦–å…ˆæ˜¯ patchFlag \u0026gt; 0 æƒ…å†µï¼Œéœ€è¦å±€éƒ¨ diff update(æ¯”å¦‚ï¼š v-for)ï¼Œè¿™é‡Œéœ€è¦åŒºåˆ†æ˜¯ å¦æœ‰ key å±æ€§\n  keyed: patchKeyedChildren(c1, c2, â€¦)\n  unkeyed: patchUnkeyedChildren(c1, c2, â€¦)\n    åˆ°è¿™é‡Œ patchFlag \u0026lt;= 0 ï¼Œéœ€è¦è¿›è¡Œ full diff çš„æƒ…å†µ\n è¿™ç§æƒ…å†µä¸‹åªæœ‰ä¸‰ç§å¯èƒ½çš„ children: text|array|null\n è¿™ä¸‰ç§æƒ…å†µç»“åˆ old + new æœ‰å¤šé‡ç»„åˆéœ€è¦è€ƒè™‘ã€‚\n  new text + old array: ç›´æ¥å¸è½½ old array, å°† parent å†…å®¹è®¾ç½®æˆ new text\n  new array + old array: å½“åš keyed children è°ƒç”¨ patchKeyedChildren(c1, c2, â€¦) å¤„ç†\n  new null + old array: ç›´æ¥å¸è½½ old array(unmountChildren(c1, â€¦))\n  new array + old null: ç›´æ¥ mount new array(mountChildren(c2, â€¦))\n     è¿™é‡Œæ¶‰åŠåˆ°å‡ ä¸ªç›¸å…³å‡½æ•°ï¼š\n patchKeyedChildren(c1, c2, container, parentAnchor, parentComponent, parentSuspense, isSVG, optimized)\n patchUnkeyedChildren(c1, c2, container, parentAnchor, parentComponent, parentSuspense, isSVG, optimized)\n unmountChildren(children, parentComponent, parentSuspense, doRemove, optimized, start)\n mountChildren(children, container, anchor, parentComponent, parentSuspense, isSVG, optimized, start)\n æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œä¼šé€ä¸€å®ç°å„ç§æƒ…å†µã€‚\n1 2 3 4 5 6 7 8 9 10 11  digraph G{ rankdir=LR; node[shape=box, style=filled, color=\u0026#34;.7.3 1.0\u0026#34;];//ä¸€ä¸ªnodeçš„å±æ€§ size = \u0026#34;6, 4\u0026#34;;//å›¾ç‰‡å¤§å° patch-\u0026gt;processElement processElement-\u0026gt;n1[label=\u0026#34;èŠ‚ç‚¹å·²å­˜åœ¨?\u0026#34;] n1[shape=diamond]; n1-\u0026gt;mountElement[label=\u0026#34;no\u0026#34;] n1-\u0026gt;patchElement[label=\u0026#34;yes\u0026#34;] mountElement-\u0026gt;patch[style=dotted, color = red] }    new text + old array   feat(add): new text + old array Â· gcclll/stb-vue-next@7019c9d\n patchChildren: å…ˆ unmountChildren(c1) -\u0026gt; hostSetElementText(container, c2)\n1 2 3 4 5 6 7 8 9 10 11 12  // children æœ‰ä¸‰ç§å¯èƒ½ï¼š text, array, æˆ–æ²¡æœ‰ children if (shapeFlag \u0026amp; ShapeFlags.TEXT_CHILDREN) { console.log(\u0026#34;patchChildren, new text...\u0026#34;); // text children fast path  if (prevShapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { unmountChildren(c1 as VNode[], parentComponent, parentSuspense); } if (c2 !== c1) { hostSetElementText(container, c2 as string); } }     unmountChildren(â€¦) -\u0026gt; éå† children è°ƒç”¨ unmount(children[i], ..)\n unmount(vnode, â€¦) ä¸­é€’å½’è°ƒç”¨ unmountChildren(children, â€¦)\n ä½†æ˜¯è¿™éƒ¨åˆ†é€»è¾‘è‡ªå§‹è‡³ç»ˆ doRemove éƒ½æ˜¯ falseï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ doRemove: remove(vnode)ï¼Œ å› ä¸ºå¦‚ä¸Šé¢çš„ä»£ç ï¼Œåœ¨ c1 !== c2 çš„æ—¶å€™æ‰§è¡Œäº† hostSetElementText(container, c2)è¿™ é‡Œé¢é¦–å…ˆä¼šç›´æ¥æ¸…ç©º container.children ç„¶åé‡æ–°èµ‹å€¼ï¼Œå› æ­¤ remove(vnode) æ²¡æœ‰æ‰§ è¡Œä¹Ÿä¼šå®ç°ç›´æ¥æ›¿æ¢æ“ä½œï¼Œè¿™é‡Œå±äº full diffã€‚\n æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { log, f, shuffle, runtime_test } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // root ä¸ŠæŒ‚ä¸€ä¸ª  // \u0026#39;\u0026lt;div id=\u0026#34;1\u0026#34;\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, [ // #1  h(\u0026#39;span\u0026#39;, \u0026#39;1\u0026#39;), h(\u0026#39;span\u0026#39;, \u0026#39;2\u0026#39;) ]), root); // å¢åŠ ä¸€ä¸ª \u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;  log([\u0026#39;1. div children length = \u0026#39;, root.children[0].children.length]) render(h(\u0026#39;div\u0026#39;, { id: 1 }, \u0026#39;hello\u0026#39;), root) // #2  log([\u0026#39;2. div children length = \u0026#39;, root.children[0].children.length]) }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render()... patch()... processElement()... mountElement()... mountElment else... patch()... processElement()... mountElement()... mountElment else... patch()... processElement()... mountElement()... mountElment else... 1. div children length = 2 render()... patch()... processElement()... patchElement()... { optimized: false, patchFlag: 0 } optimized null, éå¯å¤ç”¨èŠ‚ç‚¹ patchChildren()... patchChildren, new text... 2. div children length = 1   å¦‚ä¸Šç»“æœï¼Œæœ€å¼€å§‹æœ‰ä¸‰ä¸ªé€’å½’ï¼š\n patch() -\u0026gt; processElement() -\u0026gt; mountElement() -\u0026gt; patch()\n1 2 3 4 5 6 7 8  digraph G{ rankdir=LR; size = \u0026#34;6, 4\u0026#34;;//å›¾ç‰‡å¤§å° node[shape = box, style = filled, color = \u0026#34;.7.3 1.0\u0026#34;];//ä¸€ä¸ªnodeçš„å±æ€§ patch-\u0026gt;processElement; processElement-\u0026gt;mountElement; mountElement-\u0026gt;patch[style = dotted, color = red] }     #1 æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œåˆ†åˆ«å¤„ç† div -\u0026gt; span 1 -\u0026gt; span 2 ã€‚\n #2 æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå±äº full diff æ“ä½œï¼Œæ£€æµ‹åˆ° old array, new textï¼Œæ‰€ä»¥ç›´æ¥æ¸…ç©º äº† div.children~ï¼Œç„¶åå¤åˆ¶ ~div.children = [text node]\n  new null + old array   feat(add): patchChildren -\u0026gt; patch new null, old array Â· gcclll/stb-vue-next@3f45ac5\n æ–°å¢ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  if (prevShapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { if (shapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { console.log(\u0026#34;patchChildren, new array, old array...\u0026#34;); // TODO patchKeyedChildren  } else { // new null, old array ç›´æ¥å¸è½½ old  unmountChildren( c1 as VNode[], parentComponent, parentSuspense, true /* doRemove */ ); } }     å¦‚æœ new null ç›´æ¥å¸è½½ old array å°±å¥½äº†ï¼Œæ³¨æ„ç¬¬å››ä¸ªå‚æ•°ä¼ çš„æ˜¯ doRemove:true è¿™ æ · unmount() é‡Œé¢å°±ä¼šå»è°ƒç”¨ remove()\n æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { log, f, shuffle, runtime_test } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // root ä¸ŠæŒ‚ä¸€ä¸ª  // \u0026#39;\u0026lt;div id=\u0026#34;1\u0026#34;\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, [ // #1  h(\u0026#39;span\u0026#39;, \u0026#39;1\u0026#39;), h(\u0026#39;span\u0026#39;, \u0026#39;2\u0026#39;) ]), root); // å¢åŠ ä¸€ä¸ª \u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;  log([\u0026#39;1. div children length = \u0026#39;, root.children[0].children.length]) render(h(\u0026#39;div\u0026#39;, { id: 1 }, null), root) // #2  log([\u0026#39;2. div children length = \u0026#39;, root.children[0].children.length]) }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render()... patch()... processElement()... mountElement()... mountElment else... patch()... processElement()... mountElement()... mountElment else... patch()... processElement()... mountElement()... mountElment else... 1. div children length = 2 render()... patch()... processElement()... patchElement()... { optimized: false, patchFlag: 0 } optimized null, éå¯å¤ç”¨èŠ‚ç‚¹ patchChildren()... patchChildren, new not text... patchChildren, new null, old array... 2. div children length = 0  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  digraph G{ rankdir=LR; size = \u0026#34;6, 4\u0026#34;;//å›¾ç‰‡å¤§å° node[shape = box, style = filled, color = \u0026#34;.7.3 1.0\u0026#34;];//ä¸€ä¸ªnodeçš„å±æ€§ render2,render1[shape=circle,fillcolor=red] render1-\u0026gt;patch[label=\u0026#34;two span\u0026#34;]; patch-\u0026gt;processElement; processElement-\u0026gt;mountElement[label=\u0026#34;èŠ‚ç‚¹ä¸å­˜åœ¨\u0026#34;]; processElement-\u0026gt;patchElement[label=\u0026#34;èŠ‚ç‚¹å­˜åœ¨\u0026#34;,color=\u0026#34;blue\u0026#34;]; mountElement-\u0026gt;patch[style=dotted, color=red] render2-\u0026gt;patch[label=\u0026#34;null\u0026#34;,color=\u0026#34;blue\u0026#34;]; patchElement-\u0026gt;patchChildren[color=\u0026#34;blue\u0026#34;]; patchChildren-\u0026gt;unmountChildren[label=\u0026#34;new null\u0026#34;,color=\u0026#34;blue\u0026#34;] }      new array + old null/text   è¿™ç§æƒ…å†µï¼Œå¦‚æœæ˜¯ old textï¼Œä¼šå…ˆæ‰§è¡Œ\n1 2 3  if (prevShapeFlag \u0026amp; ShapeFlags.TEXT_CHILDREN) { hostSetElementText(container, \u0026#34;\u0026#34;); }     å°† conteiner.children æ¸…ç©ºã€‚\n ç„¶åæ‰§è¡Œ mountChidren(c2) æ’å…¥æ–°çš„ array node ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // prev children was text OR null // new children is array OR null if (prevShapeFlag \u0026amp; ShapeFlags.TEXT_CHILDREN) { hostSetElementText(container, \u0026#34;\u0026#34;); } // mount new if array if (shapeFlag \u0026amp; ShapeFlags.ARRAY_CHILDREN) { mountChildren( c2 as VNodeArrayChildren, container, anchor, parentComponent, parentSuspense, isSVG, optimized ); }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { log, f, shuffle, runtime_test } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // root ä¸ŠæŒ‚ä¸€ä¸ª  // \u0026#39;\u0026lt;div id=\u0026#34;1\u0026#34;\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, null), root); // å¢åŠ ä¸€ä¸ª \u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;  log([\u0026#39;1. div children length = \u0026#39;, root.children[0].children.length]) render(h(\u0026#39;div\u0026#39;, { id: 1 }, [ // #1  h(\u0026#39;span\u0026#39;, \u0026#39;1\u0026#39;), h(\u0026#39;span\u0026#39;, \u0026#39;2\u0026#39;) ]), root) // #2  log([\u0026#39;2. div children length = \u0026#39;, root.children[0].children.length]) }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse render()... patch()... processElement()... mountElement()... mountElment else... 1. div children length = 0 render()... patch()... processElement()... patchElement()... { optimized: false, patchFlag: 0 } optimized null, éå¯å¤ç”¨èŠ‚ç‚¹ patchChildren()... patchChildren, new not text... patchChildren, old text | null... patchChildren, new array... patch()... processElement()... mountElement()... mountElment else... patch()... processElement()... mountElement()... mountElment else... 2. div children length = 2    new array + old array     patchKeyedChildren    feat(add): patchKeyedChildren Â· gcclll/stb-vue-next@4a6a1f2\n ä»£ç ä¸­åˆ—å‡ºäº†å‡ ç§å¯èƒ½çš„æƒ…å†µï¼š\n  old, new nodes å¼€å¤´ç›¸åŒï¼Œä»å·¦åˆ°å³æ–¹å‘ä»¥ä¸åŒä½ç½®ä¸ºèµ·ç‚¹å¼€å§‹æ¯”è¾ƒ\n  old, new nodes ç»“å°¾ç›¸åŒï¼Œä»å³åˆ°å·¦æ–¹å‘ä»¥ä¸åŒä½ç½®ä¸ºèµ·ç‚¹å¼€å§‹æ¯”è¾ƒ\n  old âŠ‚ newï¼Œold ä¸º new çš„çœŸå­é›†ï¼Œè¿™ç§æƒ…å†µè§†ä¸ºæ–°å¢èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹æ–°å¢çš„èŠ‚ç‚¹è¿›è¡Œ mount æ“ä½œ\n  old âŠƒ new , new ä¸º old çš„çœŸå­é›†ï¼Œè¿™ç§æƒ…å†µè§†ä¸ºåˆ é™¤èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹å¤šä½™çš„èŠ‚ç‚¹è¿›è¡Œ unmount æ“ä½œ\n  old,new æ²¡æœ‰ç‰¹åˆ«æ˜æ˜¾çš„è§„å¾‹å¯éµå¾ªçš„ï¼Œå¤„ç†èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  // 24. å¯èƒ½æ‰€æœ‰éƒ½æ˜¯ keyed ä¹Ÿå¯èƒ½éƒ¨åˆ† const patchKeyedChildren = ( c1: VNode[], c2: VNodeArrayChildren, container: RendererElement, parentAnchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { let i = 0; const l2 = c2.length; let e1 = c1.length - 1; // ä¸Šä¸€ä¸ªç»“æŸç´¢å¼•  let e2 = l2 - 1; // ä¸‹ä¸€ä¸ªç»“æŸç´¢å¼•  // 1. sync from start  // (a b) c  // (a b) d e  while (i \u0026lt;= e1 \u0026amp;\u0026amp; i \u0026lt;= e2) { // TODO  } // 2. sync from end  // a (b c)  // d e (b c)  while (i \u0026lt;= e1 \u0026amp;\u0026amp; i \u0026lt;= e2) { // TODO  } // 3. common sequence + mount  // (a b)  // (a b) c  // i = 2, e1 = 1, e2 = 2  // (a b)  // c (a b)  // i = 0, e1 = -1, e2 = 0  if (i \u0026gt; e1) { // TODO  } // 4. common sequence + unmount  // (a b) c  // (a b)  // i = 2, e1 = 2, e2 = 1  // a (b c)  // (b c)  // i = 0, e1 = 0, e2 = -1  else if (i \u0026gt; e2) { // TODO  } // 5. unknown sequence, æœªçŸ¥åºåˆ—  // [i ... e1 + 1]: a b [c d e] f g  // [i ... e2 + 1]: a b [e d c h] f g  // i = 2, e1 = 4, e2 = 5  else { // TODO  } };     ä¸‹é¢æ¥ä¸€ä¸ªä¸ªå®ç°ï¼Œæ­å¼€ diff -\u0026gt; patch çš„ç¥ç§˜é¢çº±ï¼ï¼ï¼\n åœ¨è¿›è¡Œä¹‹å‰å…ˆçœ‹ä¸‹ä¸€ä¸ªå‡½æ•° isSameVNodeType(n1,n2) ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  export function isSameVNodeType(n1: VNode, n2: VNode): boolean { if ( __DEV__ \u0026amp;\u0026amp; n2.shapeFlag \u0026amp; ShapeFlags.COMPONENT \u0026amp;\u0026amp; hmrDirtyComponents.has(n2.type as ConcreteComponent) ) { // HMR only: if the component has been hot-updated, force a reload.  // ç»„ä»¶è¢«çƒ­æ›´æ–°ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½  return false } return n1.type === n2.type \u0026amp;\u0026amp; n1.key === n2.key }     è¿™ä¸ªå‡½æ•°ç”¨æ¥æ£€æµ‹ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯ç±»ä¼¼èŠ‚ç‚¹(éœ€åŒæ—¶æ»¡è¶³ type å’Œ key ç›¸åŒ)ã€‚\n æœ‰ç‚¹å¤æ‚ï¼Œæ•´çš„å¤´ç–¼ğŸ¤•ğŸ¤•ã€‚ã€‚ã€‚ä¼‘æ¯ä¼šğŸ˜´ğŸ˜´ï¼ï¼ï¼\n [2021-02-24 18:16:56] é€šè¿‡ç”»å›¾ç»ˆäºæŠŠè¿™å—é€»è¾‘æå¾—æœ‰ç‚¹æ¸…æ¥šäº†ï¼ï¼ï¼\n  å‰§æƒ…æœ‰ç‚¹å¤æ‚ï¼Œè¿˜æ˜¯æ ¹æ®å®˜æ–¹çš„æµ‹è¯•ç”¨ä¾‹æ¥é€æ­¥ç†Ÿæ‚‰å„ç§æƒ…å†µçš„ diff -\u0026gt; patch å§ã€‚\n å£°æ˜ï¼š\n  æ‰€æœ‰ children [1,2,3] éƒ½å°†è‡ªèº«å€¼ä½œä¸ºèŠ‚ç‚¹çš„å±æ€§ key å€¼\n  ä¸‹é¢çš„æ‰€æœ‰ç”¨ä¾‹éƒ½åŸºäºèŠ‚ç‚¹æœ‰ key å±æ€§ä¸ºå‰æ\n    fix: patchKeydChildren if Â· gcclll/stb-vue-next@b7edc1b\n å¤§è‡´ç§»åŠ¨è§„åˆ™æµç¨‹å›¾ï¼š\n append([1] -\u0026gt; [1,2,3])  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm; let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // \u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); const rc = (arr) =\u0026gt; renderChildren(render, root, h, arr); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); elm = rc([1]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [1] DONE.\u0026#34;); logRoot(); elm = rc([1, 2, 3]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [1,2,3] DONE.\u0026#34;); logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse root: \u0026lt;div id=1\u0026gt;hello\u0026lt;/div\u0026gt; \u0026gt;\u0026gt;\u0026gt; render [1] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; patchKeyedChildren... while 1, sync from start... patch keyed æ–°å¢ ... \u0026gt;\u0026gt;\u0026gt; render [1,2,3] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;   å¦‚ä¸Šç»“æœï¼Œå½“æ‰§è¡Œ patchChildren çš„æ—¶å€™ï¼Œç”±äº old array ï¼Œ new array æ‰€ä»¥ä¼šæ‰§è¡Œ patchKeyedChildren å¯¹ä¸¤ä¸ª array è¿›è¡Œå¯¹æ¯”æ›´æ–°ã€‚\n while 1: ä»å·¦åˆ°å³å¯¹åŒç±»å‹çš„ VNode è¿›è¡Œ patch ï¼Œæ‰€ä»¥è¿™é‡Œ 1 èŠ‚ç‚¹ä¼šåœ¨è¿™é‡Œè¢« patch æ‰ ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  while (i \u0026lt;= e1 \u0026amp;\u0026amp; i \u0026lt;= e2) { console.log(\u0026#34;while 1, sync from start...\u0026#34;); const n1 = c1[i]; const n2 = (c2[i] = optimized // é™æ€èŠ‚ç‚¹  ? cloneIfMounted(c2[i] as VNode) : normalizeVNode(c2[i])); // type \u0026amp; key ç›¸åŒ  if (isSameVNodeType(n1, n2)) { patch( n1, n2, container, null, parentComponent, parentSuspense, isSVG, optimized ); } else { break; } i++; }     ç„¶åï¼š i=1,e1=0,e2=2 æ»¡è¶³ if(i\u0026gt;e1) æ–°å¢èŠ‚ç‚¹æ¡ä»¶ï¼Œå¯¹ [2,3] è¿›å…¥æ–°å¢èŠ‚ç‚¹é€»è¾‘ ä»£ç (if åˆ†æ”¯)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  if (i \u0026gt; e1) { console.log(\u0026#34;patch keyed æ–°å¢ ...\u0026#34;); if (i \u0026lt;= e2) { const nextPos = e2 + 1; const anchor = nextPos \u0026lt; l2 ? (c2[nextPos] as VNode).el : parentAnchor; while (i \u0026lt;= e2) { patch( null, (c2[i] = optimized ? cloneIfMounted(c2[i] as VNode) : normalizeVNode(c2[i])), container, anchor, parentComponent, parentSuspense, isSVG ); i++; } } }     é’ˆå¯¹ [2,3] åˆ†åˆ«æ‰§è¡Œï¼š\n patch(null, c2[i], container, anchor,...)\n æ³¨æ„è¿™é‡Œ anchor æ˜¯ [3] è¿™ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯ç”±äºåœ¨ container.children æ˜¯ä¸å­˜åœ¨çš„ï¼Œ æ‰€ä»¥å¯¹äº [2] ä¼šæ‰§è¡Œ append æ“ä½œ(å…·ä½“è¯·æŸ¥çœ‹ runtime-test/src/nodeOpts.ts:insert å‡½æ•°å®ç°)ã€‚\n ç›´åˆ°å…¨éƒ¨ append åˆ° container.children ç»“æŸã€‚\n old: [1], new: [1,2,3]\n è¿™ç§æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç›´æ¥ append 2,3 å°±è¡Œäº†ã€‚\n   prepend([4,5]-\u0026gt;[1,2,3,4,5])   å®ä¾‹åˆ†æï¼š n1=[4,5], n2=[1,2,3,4,5] ç»è¿‡ while1 ä»€ä¹ˆéƒ½æ²¡åšï¼Œç»è¿‡ while2 åŒåŒ–æ‰ å°¾éƒ¨ [4,5],i=0,e1=-1,e2=2= æ»¡è¶³ if(i\u0026gt;e1)\u0026amp;\u0026amp;if(i\u0026lt;e2) å±äºæ–°å¢èŠ‚ç‚¹æ“ä½œï¼Œæ’å…¥æ—¶ çš„å‚è€ƒèŠ‚ç‚¹ä¸º c2[e2+1] ï¼Œä¹‹å‰åˆ†æè¿‡å¦‚æœéœ€è¦ç»è¿‡å‰ä¸¤ä¸ª while å¤„ç†çš„èŠ‚ç‚¹éƒ½ä¼šåœ¨ patch çš„è¿‡ç¨‹ä¸­ç›´æ¥æ›¿æ¢æ‰ï¼Œæ¯”å¦‚è¿™é‡Œçš„ [4,5] ä¼šåœ¨ while2 ä¸­è¢«æ›¿æ¢æ‰(ä½“ç°åœ¨ container.children ä¸­)ï¼Œæ–°çš„ [4,5] æ›¿æ¢æ‰è€çš„ [4,5] ï¼Œæ‰€ä»¥è¿™é‡Œå‘ç”Ÿæ’å…¥æ—¶çš„ anchor å®é™…æ˜¯å¯¹åº” container.children ä¸­çš„ [4] ä½ç½®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm; let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // \u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); const rc = (arr) =\u0026gt; renderChildren(render, root, h, arr); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); elm = rc([4, 5]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [4,5] DONE.\u0026#34;); logRoot(); elm = rc([1, 2, 3, 4, 5]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5] DONE.\u0026#34;); logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse root: \u0026lt;div id=1\u0026gt;hello\u0026lt;/div\u0026gt; \u0026gt;\u0026gt;\u0026gt; render [4,5] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;5\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; patchKeyedChildren... while 1, sync from start... while 2, sync from end... while 2, sync from end... patch keyed æ–°å¢ ... \u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;5\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;   ä¸Šé¢ä¸¤æ¬¡ while 2 åˆ†åˆ«å¯¹åº”çš„æ˜¯ 5-\u0026gt;4 åŒåŒ–è¿‡ç¨‹ã€‚\n åŒç±»ç”¨ä¾‹ï¼Œä¸åšå¤šä½™åˆ†æäº†ï¼Œç›´æ¥çœ‹ç»“æœå§ï¼\n  [1,2,4,5] å’Œ [1,2,3,4,5] ç»è¿‡ while1(æ›¿æ¢12) å’Œ while2(æ›¿æ¢45) ä¹‹å i=2,e1=1,e2=2 æ»¡è¶³~if(i\u0026gt;e1)\u0026amp;\u0026amp;if(i\u0026lt;=e2)~ æ’å…¥æ“ä½œï¼Œå‚è€ƒèŠ‚ç‚¹: anchor=c2[e2+1]=4 æ‰€ä»¥æ‰§è¡Œ patchæ—¶å€™ä¼šåœ¨ 4(å› ä¸º anchor æœ‰å€¼) ä¹‹å‰æ’å…¥ 3 ã€‚\n     insert begin\u0026amp;end([2,3,4]-\u0026gt;[1,2,3,4,5])  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm; let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // \u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); const rc = (arr) =\u0026gt; renderChildren(render, root, h, arr); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); elm = rc([2,3,4]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [2,3,4] DONE.\u0026#34;); logRoot(); elm = rc([1, 2, 3, 4, 5]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5] DONE.\u0026#34;); logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse root: \u0026lt;div id=1\u0026gt;hello\u0026lt;/div\u0026gt; \u0026gt;\u0026gt;\u0026gt; render [4,5] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; patchKeyedChildren... while 1, sync from start... while 2, sync from end... \u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;5\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;   [2,3,4] å’Œ [1,2,3,4,5] ç»è¿‡ while1 å’Œ while2 ä»€ä¹ˆéƒ½æ²¡åšï¼Œ i=0,e1=2,e2=4 æ—¢ ä¸æ»¡è¶³ if(i\u0026gt;e1) ä¹Ÿä¸æ»¡è¶³ elseif(i\u0026gt;e2) æ‰€ä»¥ä¼šè¿›å…¥ else çš„æ— è§„åˆ™æ¯”è¾ƒé˜¶æ®µã€‚æ ¹ æ®ä¹‹å‰è„‘å›¾åˆ†æç»“æœå¯çŸ¥ï¼Œ else æ‰§è¡Œçš„æ­¥éª¤å¤§è‡´æ˜¯ï¼š\n  éå† old children æ›¿æ¢ [2,3,4]\n ç”¨ old [2,3,4] çš„æ¯ä¸ªå…ƒç´ çš„ key å» new [1,2,3,4,5] é‡Œé¢å»æ‰¾å¯¹åº”çš„ key(type,keyç›¸ç­‰çš„èŠ‚ç‚¹)å»æ›¿æ¢è€çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°†ä¼šæ‰¾åˆ° [2,3,4] ï¼Œæ­¤æ—¶ç»è¿‡ä¸€ä¸ª for old children å¾ªç¯æ‰§è¡Œæ›¿æ¢ï¼Œè¿™é‡Œé‡ç‚¹åœ¨äº newIndexToOldIndexMap ç»“æœä¼šæ›´ æ–°ä¸º [0,1,2,3,0] è¿™é‡Œçš„ 123 åˆ†åˆ«å¯¹åº” [2,3,4] åœ¨ old children ä¸­çš„ç´¢å¼• + 1 çš„ç»“æœã€‚\n  éå† new children æ£€æµ‹ newIndexToOldIndexMap\n è¿™ä¸€æ­¥çš„å¾ªç¯æ˜¯é’ˆå¯¹ new children è€Œè¨€ï¼Œä½œç”¨æ˜¯æ‰¾å‡º newIndexToOldIndexMap ä¸­ä¸ ä¸º 0 çš„å…ƒç´ (ä¹Ÿå°±æ˜¯è¿˜æœªè¢«ä½¿ç”¨çš„å…ƒç´ )ï¼Œæ¥æ‰§è¡Œæ’å…¥æ“ä½œã€‚å¾ªç¯é¡ºåºä»å³åˆ°å·¦æ‰§è¡Œï¼Œ åˆ™æœ‰(i-é€’å‡ç´¢å¼•ï¼Œindex-newchild çš„ç´¢å¼•å€¼,el-newchild,val-ä½¿ç”¨çŠ¶æ€)ï¼š\n i=4,index=4,el=c2[index],val=0,anchor=null:\n æœªä½¿ç”¨ï¼Œæ²¡æœ‰å‚è€ƒèŠ‚ç‚¹ï¼Œå±äºçº¯ append æ“ä½œã€‚\n i=3,2,1,val!==0 å·²ç»è¢«ä½¿ç”¨äº†ï¼Œè·³è¿‡\n i=0,index=0,el=c2[index],val=0,anchor=c2[index+1]=1:\n æœªä½¿ç”¨ï¼Œæ’å…¥èŠ‚ç‚¹ä¸º [1] å‚è€ƒèŠ‚ç‚¹ä¸º [2] å±äºæ’å…¥æ“ä½œï¼Œåœ¨ [1] ä¹‹å‰æ’å…¥ã€‚\n æœ€åå¾—åˆ°ç»“æœï¼š children=[1,2,3,4,5] å®Œæˆã€‚\n   å…¶å®è¿™é‡Œè¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ï¼Œå› ä¸ºè¿˜æ²¡ç”¨åˆ°â€œæœ‰åºé€’å¢åºåˆ—â€ç®—æ³•ï¼Œå› ä¸º for old children ä¸­çš„ key æ˜¯æœ‰åºçš„ä¸”æ˜¯ new children çš„å­é›†ï¼Œæ‰€ä»¥éå†è¿‡ç¨‹ä¸­ newIndex ä¸º 0,1,2 åé¢çš„æ€»æ˜¯æ¯”å‰é¢çš„å¤§ï¼Œå› æ­¤ maxNewIndexSoFar=2 ç›´åˆ°ç»“æŸğŸ”šã€‚\n ç±»ä¼¼ç”¨ä¾‹ï¼š\n  [] å’Œ [1,2,3,4,5] è¿™ç§æƒ…å†µç­‰äºæ˜¯ newIndexToOldIndexMap=[0,0,0,0,0] æ‰€æœ‰ new child å…ƒç´ æ‰§è¡Œçš„éƒ½æ˜¯å°¾éƒ¨ append æ“ä½œã€‚\n  [1,2,3,4,5] å’Œ render(h(\u0026#39;div\u0026#39;), root) ç­‰äºæ˜¯ children=[] ç›´æ¥åˆ é™¤ old children æ“ä½œ\n  [1,2,3,4,5] å’Œ [3,4,5] ç»è¿‡ while2 æ›¿æ¢æ‰ [3,4,5] å‰©ä¸‹ old [1,2] å› åœ¨ new children ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„å…ƒç´ ï¼Œåˆ™ä¼šè¢«åˆ é™¤ã€‚\n  [1,2,3,4,5] å’Œ [1,2,3] ç»è¿‡ while1 æ›¿æ¢æ‰ [1,2,3] å‰©ä¸‹çš„ old [4,5] å›  æ‰¾ä¸åˆ°å¯¹åº”çš„ new child è¢«åˆ é™¤ã€‚\n  [1,2,3,4,5] å’Œ [1,2,4,5] ç»è¿‡ while1 æ›¿æ¢æ‰ [1,2] ç»è¿‡ while2 æ›¿æ¢æ‰ [4,5] å‰©ä¸‹ [3] å› æ‰¾ä¸åˆ° new child è€Œè¢«åˆ é™¤ã€‚\n     move([1,2,3,4]-\u0026gt;[2,3,1,4])   è¿™ç§æƒ…å†µä¼šè§¦å‘â€œæœ€é•¿é€’å¢åºåˆ—â€è§„åˆ™ï¼Œè¿›è¡Œæ›¿æ¢ï¼Œå› ä¸ºå‘ç”Ÿ diff-update çš„åŸåˆ™æ˜¯ï¼šæ›´æ–° ä¹‹åçš„é¡ºåºè¦å’Œ new children é¡ºåºä¸€è‡´ï¼Œå³åŸæ¥æ˜¯ 1234 æ›´æ–°ä¹‹åè¦ä¿æŒ 2314 é¡ºåºã€‚\n æ›´æ–°è¿‡ç¨‹ï¼š\n  ç»è¿‡ while1 ä»€ä¹ˆéƒ½ä¸å‘ç”Ÿï¼Œå› ä¸º [1]-\u0026gt;[2] éåŒç±»èŠ‚ç‚¹\n  ç»è¿‡ while2 æ›¿æ¢æ‰ [4],i=0,e1=2,e2=2\n  if(i\u0026gt;e1) ä¸æ»¡è¶³æ–°å¢æ¡ä»¶\n  elif(i\u0026gt;e2) ä¸æ»¡è¶³åˆ é™¤æ¡ä»¶\n  è¿›å…¥ else æ— è§„åˆ™æ¯”è¾ƒæ›´æ–°\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm; let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // \u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); const rc = (arr) =\u0026gt; renderChildren(render, root, h, arr); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); elm = rc([1,2,3,4]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [1,2,3,4] DONE.\u0026#34;); logRoot(); elm = rc([2,3,1,4]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [2,3,1,4] DONE.\u0026#34;); logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse root: \u0026lt;div id=1\u0026gt;hello\u0026lt;/div\u0026gt; \u0026gt;\u0026gt;\u0026gt; render [1,2,3,4] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; patchKeyedChildren... while 1, sync from start... while 2, sync from end... while 2, sync from end... { arr: [ 2, 3, 1 ] } { result: [ 2, 1 ] } æœ€é•¿å¢é•¿åºåˆ—: 0,1 move äº¤æ¢... \u0026gt;\u0026gt;\u0026gt; render [2,3,1,4] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;   åœ¨ä¸Šé¢æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿›å…¥ else åˆ†æ”¯ï¼Œæ‰§è¡Œï¼š\n  for old children\n æ‰§è¡Œå®Œä¹‹å(i=0,e1=2,e2=2)ï¼Œ newIndexToOldIndexMap=[2,3,1] åˆ†åˆ«å¯¹åº” [1,2,3] åœ¨ [2,3,1] ä¸­çš„ç´¢å¼•å€¼ + 1ï¼Œå› ä¸ºå­˜åœ¨ newIndex \u0026lt; maxNewIndexSoFar æ‰€ä»¥ moved=true åœ¨éšåçš„æµç¨‹ä¸­ç”¨æ¥è§¦å‘â€œæœ€é•¿å¢é•¿åºåˆ—â€æ“ä½œã€‚\n  for new children\n åœ¨æ‰§è¡Œè¿™ä¸ªå¾ªç¯ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° newIndexToOldIndexMap=[2,3,1] å¹¶ä¸”ä»ä¸­æ‰¾ åˆ°æœ€é•¿å¢é•¿åºåˆ—([2,3])ï¼Œç„¶è€Œ getSequence(arr) è¿”å›çš„æ˜¯å®ƒä»¬çš„ç´¢å¼•å€¼ï¼Œæ‰€ä»¥æ˜¯ [0,1] æ‰€ä»¥æœ€å increasingNewIndexSequence=[0,1] ã€‚\n ç„¶ååœ¨ for toBePatched new children é‡Œé¢ï¼Œå› ä¸ºæ£€æµ‹åˆ° moved=true åˆ™ä¼šè¿›å…¥åˆ° ç§»åŠ¨äº¤æ¢æ“ä½œï¼Œè¿™é‡Œæ‰§è¡Œ move() ä¹Ÿæœ‰ä¸ªæ¡ä»¶ï¼š j\u0026lt;0 || i !== increasingNewIndexSequence[j] è¿™ä¸¤ä¸ªæ¡ä»¶ æœ‰åˆ†åˆ«ä»£è¡¨ä¸¤ç§æƒ…å†µ(å‡è®¾ï¼š val=increasingNewIndexSequence[j])ï¼š\n  j\u0026lt;0 ä»£è¡¨ increasingNewIndexSequence å¢é•¿åºåˆ—æ²¡æœ‰å†…å®¹ï¼Œè¿™è¯´æ˜ä»€ä¹ˆï¼Ÿè¯´æ˜ newIndexToOldIndexMap æ˜¯ä¸ªå®Œå…¨é€’å‡æ•°ç»„ï¼Œå¦‚ï¼š [3,2,1] è¿™ç§æƒ…å†µæ¯ä¸ªå…ƒç´ éƒ½ éœ€è¦è¿›è¡Œç§»åŠ¨ï¼Œæœ€åå˜æˆ [1,2,3] ï¼Œ 1ç§»åˆ°3ä½ç½®ï¼Œ2ä¸å˜ï¼Œ3ç§»åŠ¨1çš„ä½ç½®ã€‚\n  i!==val\n æ¯”å¦‚è¿™é‡Œ(newIndexToOldIndexMap=[2,3,1],old=[1,2,3,4],new=[2,3,1,4])\n i=2,val=1,nextchild=[1],anchor=[4] æ„å‘³ç€è¦åœ¨ [4] å‰é¢æ’å…¥ [1] è®°ä½è¿™ é‡Œæ‰§è¡Œçš„ä¾æ—§æ˜¯æ’å…¥æ“ä½œï¼Œåªæ˜¯åœ¨æ’å…¥ä¹‹å‰ä¼šå°†åŸæ¥çš„ [1] ä» container.children ä¸­åˆ é™¤ï¼Œæ‰€ä»¥çœ‹ä¼¼æ˜¯äº¤æ¢å®é™…åªæ˜¯å˜ç›¸æ’å…¥è€Œå·²ã€‚\n i=1,val=1,nextchild=[3],anchor=[1] è¿™é‡Œ i===val æ‰€ä»¥æ‰§è¡Œ j--\n i=0,val=0,nextchild=[2],anchor=[3] è¿™é‡Œ i===val æ‰€ä»¥æ‰§è¡Œ j--\n åˆ°æ­¤ for å¾ªç¯å·²ç»é€€å‡ºäº†ï¼Œä¸Šé¢ä¸¤ä¸ª j-- è¯´æ˜è§¦åŠçš„æ˜¯å¢é•¿åºåˆ—é‡Œé¢çš„å…ƒç´ å³ä¸ éœ€è¦ç§»åŠ¨çš„å…ƒç´ ï¼Œæ‰€ä»¥æœ€å children ç”± [1,2,3,4] å˜æˆ [2,3,1,4], åªæ˜¯ 1 è¿› è¡Œäº†ç§»åŠ¨ã€‚\n     åªéœ€è¦ç§»åŠ¨ä¸€æ¬¡å°±å¯å®Œæˆã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚æˆ‘æ˜¯åˆ†ç•Œç‚¹~~~~~~~~~\n  åŒæ¡ˆä¾‹åˆ†æï¼š\n  [1, 2, 3, 4] å’Œ [1, 4, 2, 3]\n åœ¨ç»è¿‡ while1 ä¹‹åå¼€å§‹è¿›å…¥ else åˆ†æ”¯ï¼Œ newIndexToOldIndexMap=[4,2,3] æœ€åå¾— åˆ°å¢é•¿åºåˆ—ï¼š [2,3]~å¯¹åº”çš„ç´¢å¼• ~[1,2] å³éœ€è¦æ‰§è¡Œæ’å…¥çš„é€»è¾‘æ˜¯ï¼š\n i=2,j=1,val=2,next=[3],anchor=null ï¼š i===val, jâ€“\n i=1,j=0,val=1,next=[2],anchor=[3] : i===val, jâ€“\n i=0,j=-1,val=undefined,next=[4],anchor=[2] : 4 è¦æ’å…¥åˆ° 2 å‰é¢ï¼Œ children=[1,4,2,3]\n i=-1 ç»“æŸã€‚\n æ‰€ä»¥åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ç§»åŠ¨å°±å¯ä»¥äº†ï¼Œåœ¨é€’å¢åºåˆ—å†…çš„å…ƒç´ æ˜¯ä¸éœ€è¦åŠ¨çš„ã€‚\n  [1,2,3] å’Œ [2,3,1]\n ç”±äºå‰åéƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ while1,while2 éƒ½æ²¡å¤„ç†ï¼Œå¹¶ä¸”è¿›å…¥ else ä¹±åºæƒ…å†µå¤„ç†ã€‚\n newIndexToOldIndexMap=[2,4,1] å¢é•¿åºåˆ—= [2,4] ï¼Œç´¢å¼•ï¼š [0,1]\n i=2,j=1,val=1,next=[1],anchor=null ï¼š 1 append åˆ°æœ€åï¼Œå˜æˆ children=[2,3,1]\n i=1,j=1,val=1,next=[3],anchor=[1] : i===val, jâ€“\n i=0,j=0,val=0,next=[2],anchor=[3] : i ===val, jâ€“\n i=-1 ç»“æŸ.\n åªéœ€è¦å°† [1] ç§»åˆ°æœ€åå°±å®Œæˆäº†äº¤æ¢ã€‚\n  [1,2,3,4] å’Œ [4,2,3,1]\n newIndexToOldIndexMap=[4,2,3,1] å¢é•¿åºåˆ—ï¼š [2,3] ï¼Œç´¢å¼•ï¼š [1,2]\n i=3,j=1,val=2,next=[1],anchor=null : [1] append åˆ°æœ€åï¼Œ children=[2,3,4,1]\n i=2,j=1,val=2,next=[3],anchor=[1] : i===val, jâ€“\n i=1,j=0,val=1,next=[2],anchor=[3] : i===val, jâ€“\n i=0,j=-1,val=undefined,next=[4],anchor=[2]: j\u0026lt;0, æ‰§è¡Œç§»åŠ¨ï¼Œ children=[4,2,3,1], å°† 4 ç§»åŠ¨åˆ° 2 å‰é¢ã€‚\n i=-1 ç»“æŸã€‚\n è¿™é‡Œåªéœ€è¦æ‰§è¡Œä¸¤æ¬¡ç§»åŠ¨æ“ä½œï¼Œ 1\u0026lt;-\u0026gt;4 äº¤æ¢ã€‚\n    move\u0026amp;replace([1,2,3,4,5]-\u0026gt;[4,1,2,3,6])   è¿™é‡Œéœ€è¦å®Œæˆçš„åŠ¨ä½œæœ‰ï¼š ç”¨ 6 æ›¿æ¢ 5ï¼Œå°† 4ç§»åˆ° 1 å‰é¢ ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm; let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // \u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt;  render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); const rc = (arr) =\u0026gt; renderChildren(render, root, h, arr); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); elm = rc([1,2,3,4,5]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5] DONE.\u0026#34;); logRoot(); elm = rc([4,1,2,3,6]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [4,1,2,3,6] DONE.\u0026#34;); logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse root: \u0026lt;div id=1\u0026gt;hello\u0026lt;/div\u0026gt; \u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;5\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; patchKeyedChildren... while 1, sync from start... while 2, sync from end... { arr: [ 4, 1, 2, 3, 0 ] } { result: [ 1, 2, 3 ] } { toBePatched: 5 } æœ€é•¿å¢é•¿åºåˆ—: 1,2,3 { val: 3, i: 3, j: 2, toBePatched: 5 } { val: 2, i: 2, j: 1, toBePatched: 5 } { val: 1, i: 1, j: 0, toBePatched: 5 } { val: undefined, i: 0, j: -1, toBePatched: 5 } moving... move äº¤æ¢... \u0026gt;\u0026gt;\u0026gt; render [4,1,2,3,6] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;6\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;   åˆ†æ ï¼š\n ç»è¿‡ while1, while2 å®é™…ä»€ä¹ˆéƒ½æ²¡åšï¼Œå› ä¸ºå‰åå¹¶æ²¡æœ‰å…±é€šèŠ‚ç‚¹ï¼Œä¹Ÿå› æ­¤ä¼šè¿›å…¥ else è¿› è¡Œæ— åºåºåˆ—å¤„ç†ã€‚\n old=[1,2,3,4,5]\n new=[4,1,2,3,6]\n newIndexToOldIndexMap=[0,0,0,0,0] ç»è¿‡ for old ä¹‹å\n newIndexToOldIndexMap=[4,1,2,3,0] æœ€å 5 ç”±äºæ²¡æ‰¾åˆ°å¯¹åº” key çš„ new nodeæˆ–è€…æ—  key çš„ new nodeè€Œ è¢«æ‰§è¡Œåˆ é™¤(unmount())æ“ä½œã€‚\n æ‰¾æœ€é•¿å¢é•¿åºåˆ—ï¼š [1,2,3] å¾—åˆ° newIndexToOldIndexMap ä¸­å¯¹åº”çš„ç´¢å¼• increasingNewIndexSequence=[1,2,3],j=2\n å¼€å§‹ä»å³åˆ°å·¦éå† new children(val=increasingNewIndexSequence[j])ï¼š\n i=4,map=0,newchild=6: ç”±äº index map ä¸­çš„å€¼ä¸º 0ï¼Œè¯´æ˜å¹¶æ²¡æœ‰å¯¹åº”çš„ old child å± äºéœ€è¦æ–°å¢çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œ mount new èŠ‚ç‚¹æ“ä½œ children=[1,2,3,4,6] (æ³¨æ„ ï¼š 5 åœ¨ ä¸Šé¢å·²ç»è¢« unmount æ‰äº†)\n i=3,j=2,val=3,next=3,anchor=6 : i===val, jâ€“\n i=2,j=1,val=2,next=2,anchor=3 : i===val, jâ€“\n i=1,j=0,val=1,next=1,anchor=2 : i===val, jâ€“\n i=0,j=-1,val=undefined,next=4,anchor=1 : j\u0026lt;0, æ‰§è¡Œ move() ï¼Œå°† 4 ç§»åŠ¨åˆ° 1 å‰é¢ï¼Œå˜æˆï¼š children=[4,1,2,3,6]\n i=-1 ç»“æŸã€‚\n è¿™é‡Œå®é™…ä¸Šæœ‰ä¸‰ä¸ªåŠ¨ä½œï¼š\n  5 åœ¨ new children ä¸­æ²¡æ‰¾åˆ° keyed childï¼Œä¹Ÿæ²¡æœ‰ non-keyed child æ‰€ä»¥è¢« unmount åˆ é™¤äº†;\n  6 åœ¨ newIndexToOldIndexMap ä¸­å¯¹åº”çš„å€¼ä¸º 0ï¼Œè¯´æ˜å¹¶æ²¡æœ‰ old child ä¸ä¹‹å¯¹åº”ï¼Œ å±äºæ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œ mount new æ“ä½œ;\n  4 èŠ‚ç‚¹æ»¡è¶³ move æ¡ä»¶ï¼Œå°†å…¶ç§»åŠ¨åˆ° 1 å‰é¢ã€‚\n    åŒæ¡ˆä¾‹åˆ†æ ï¼š\n  [1,4,5] å’Œ [4,6]\n for old æ—¶ 1 å’Œ 5 è¢« unmount æ‰\n newIndexToOldIndexMap=[2,0] å› ä¸ºä¸å­˜åœ¨ newIndex \u0026gt; maxNewIndexSoFar å¯¼è‡´ moved=false éšä¹‹ increasingNewIndexSequence=[]\n for new æ—¶ï¼Œç”±äºå¢é•¿åºåˆ—ä¸ºç©ºï¼Œæ‰€ä»¥åªä¼šè¿›å…¥ newIndexToOldIndexMap æ£€æµ‹æ˜¯å¦ä¸º 0 çš„ if åˆ†æ”¯æ‰§è¡Œ mount new æ“ä½œï¼Œå³æ–°å¢ 6 è¿™ä¸ªèŠ‚ç‚¹ï¼š\n i=1,newIndexToOldIndexMap[i]===0 è¿›å…¥ if mount new 6 node.\n  [2,4,5] å’Œ [4,5,3] åˆ é™¤ 2ï¼Œæ–°å¢ 3\n  [1,2,3,4,5,6,7,8] å’Œ [8,7,6,5,4,3,2,1]\n è¿™åº”è¯¥æ˜¯æœ€ç³Ÿç³•çš„æƒ…å†µäº†\n newIndexToOldIndexMap=[8,7,6,5,4,3,2,1],moved=true\n å¢é•¿åºåˆ—ä¸º [7] ï¼Œæ‰€ä»¥ increasingNewIndexSequence=[1],j=0\n i=7,j=0,val=7,next=1,anchor=undefined, i===val, jâ€“, å³èŠ‚ç‚¹ [1] ä¸éœ€è¦åŠ¨\n i=6,j=-1,next=2,anchor=1 -\u0026gt;2ç§»åˆ°1å‰é¢-\u0026gt; children=[3,4,5,6,7,8,2,1]\n i=5,j=-1,next=3,anchor=2 -\u0026gt;3ç§»åˆ°2å‰é¢-\u0026gt; children=[4,5,6,7,8,3,2,1]\n i=4,j=-1,next=4,anchor=3 -\u0026gt;4ç§»åˆ°3å‰é¢-\u0026gt; children=[5,6,7,8,4,3,2,1]\n i=3,j=-1,next=5,anchor=4 -\u0026gt;5ç§»åˆ°4å‰é¢-\u0026gt; children=[6,7,8,5,4,3,2,1]\n i=2,j=-1,next=6,anchor=5 -\u0026gt;6ç§»åˆ°5å‰é¢-\u0026gt; children=[7,8,6,5,4,3,2,1]\n i=1,j=-1,next=7,anchor=6 -\u0026gt;7ç§»åˆ°6å‰é¢-\u0026gt; children=[8,7,6,5,4,3,2,1]\n i=0,j=-1,next=8,anchor=7 è¿™é‡Œä¹Ÿä¼šæ‰§è¡Œä¸€æ¬¡æ’å…¥å—(å¦‚ä¸‹é¢æµ‹è¯•ç»“æœ)ï¼Ÿ\n i=-1 ç»“æŸï¼Œå…±æ‰§è¡Œäº†ä¸ƒæ¬¡ç§»åŠ¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { log, f, shuffle, runtime_test, renderChildren } = require(process.env .BLOG_DIR_VUE + \u0026#34;/lib.js\u0026#34;); import(process.env.BLOG_DIR_VUE + \u0026#34;/runtime-test.global.js\u0026#34;).then( ({ h, render, nodeOps, serializeInner: inner }) =\u0026gt; { let elm; let root = nodeOps.createElement(\u0026#34;div\u0026#34;); // \u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt; render(h(\u0026#34;div\u0026#34;, { id: 1 }, \u0026#34;hello\u0026#34;), root); const rc = (arr) =\u0026gt; renderChildren(render, root, h, arr); const logRoot = () =\u0026gt; log(\u0026#34;root: \u0026#34; + inner(root)); logRoot(); elm = rc([1,2,3,4,5,6,7,8]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5,6,7,8] DONE.\u0026#34;); logRoot(); elm = rc([1,2,3,4,5,6,7,8].reverse()); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; render [8,7,6,5,4,3,2,1] DONE.\u0026#34;); logRoot(); }, (err) =\u0026gt; { console.log(err.message); } );    undefinedfalse root: \u0026lt;div id=1\u0026gt;hello\u0026lt;/div\u0026gt; \u0026gt;\u0026gt;\u0026gt; render [1,2,3,4,5,6,7,8] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;5\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;6\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;7\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;8\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; patchKeyedChildren... while 1, sync from start... while 2, sync from end... { arr: [ 8, 7, 6, 5, 4, 3, 2, 1 ] } { result: [ 7 ] } { toBePatched: 8 } æœ€é•¿å¢é•¿åºåˆ—: 7 { val: 7, i: 7, j: 0, next: \u0026#39;1\u0026#39;, anchor: null, toBePatched: 8 } { val: undefined, i: 6, j: -1, next: \u0026#39;2\u0026#39;, anchor: \u0026#39;1\u0026#39;, toBePatched: 8 } move äº¤æ¢... { val: undefined, i: 5, j: -1, next: \u0026#39;3\u0026#39;, anchor: \u0026#39;2\u0026#39;, toBePatched: 8 } move äº¤æ¢... { val: undefined, i: 4, j: -1, next: \u0026#39;4\u0026#39;, anchor: \u0026#39;3\u0026#39;, toBePatched: 8 } move äº¤æ¢... { val: undefined, i: 3, j: -1, next: \u0026#39;5\u0026#39;, anchor: \u0026#39;4\u0026#39;, toBePatched: 8 } move äº¤æ¢... { val: undefined, i: 2, j: -1, next: \u0026#39;6\u0026#39;, anchor: \u0026#39;5\u0026#39;, toBePatched: 8 } move äº¤æ¢... { val: undefined, i: 1, j: -1, next: \u0026#39;7\u0026#39;, anchor: \u0026#39;6\u0026#39;, toBePatched: 8 } move äº¤æ¢... { val: undefined, i: 0, j: -1, next: \u0026#39;8\u0026#39;, anchor: \u0026#39;7\u0026#39;, toBePatched: 8 } move äº¤æ¢... \u0026gt;\u0026gt;\u0026gt; render [8,7,6,5,4,3,2,1] DONE. root: \u0026lt;div id=1\u0026gt;\u0026lt;span\u0026gt;8\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;7\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;6\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;5\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;3\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;2\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;1\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;        patchUnkeyedChildren   feat(add): unkeyd children patch Â· gcclll/stb-vue-next@2d06710\n å¯¹äºæ˜ç¡® unkeyed çš„ children å¤„ç†å’Œ keyed å¤„ç†åŒºåˆ«åœ¨äºï¼Œä¼šå°†å‰é¢çš„ children å…ˆè¿› è¡Œ patch, å› ä¸ºåœ¨ patchKeyedChildren ä¸€èŠ‚å·²ç»è¯¦ç»†åˆ†æè¿‡ï¼Œå¦‚æœæ²¡æœ‰ old child æ˜¯ unkeyed ä¼šä» new children ä¸­ä¾åºæ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ unkeyed child å»æ›¿æ¢ã€‚\n æ‰€ä»¥è¿™é‡Œåˆ†ä¸‰æ­¥èµ°ï¼š\n  æ‰¾åˆ°æœ€å°é•¿åº¦ï¼Œé’ˆå¯¹æ­¤é•¿åº¦å†…çš„ child è¿›è¡Œ patchï¼Œå› ä¸ºå¯¹äº unkeyed old child åª éœ€è¦æ‰¾åˆ°å¯¹åº”çš„ unkeyed new child æ›¿æ¢å°±è¡Œ\n  æ–°å¢çš„æƒ…å†µ new child len \u0026gt; old child len\n  å‡å°‘çš„æƒ…å†µ new child len \u0026lt; old child len\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  const patchUnkeyedChildren = ( c1: VNode[], c2: VNodeArrayChildren, container: RendererElement, anchor: RendererNode | null, parentComponent: ComponentInternalInstance | null, parentSuspense: SuspenseBoundary | null, isSVG: boolean, optimized: boolean ) =\u0026gt; { c1 = c1 || EMPTY_ARR; c2 = c2 || EMPTY_ARR; const oldLength = c1.length; const newLength = c2.length; const commonLength = Math.min(oldLength, newLength); let i; for (i = 0; i \u0026lt; commonLength; i++) { const nextChild = (c2[i] = optimized ? cloneIfMounted(c2[i] as VNode) : normalizeVNode(c2[i])); patch( c1[i], nextChild, container, null, parentComponent, parentSuspense, isSVG, optimized ); } if (oldLength \u0026gt; newLength) { // remove old  unmountChildren( c1, parentComponent, parentSuspense, true, false, commonLength ); } else { // mount new  mountChildren( c2, container, anchor, parentComponent, parentSuspense, isSVG, optimized, commonLength ); } };      patch-\u0026gt;processComponent(å¦‚ä½•patchç»„ä»¶çš„ï¼Ÿ)   æµ‹è¯•         ","permalink":"https://www.cheng92.com/vue/vue-mind-map-runtime-core-2-render/","tags":["vue,","vue3,","runtime-core,","render"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render"},{"categories":["javascript,","web"],"contents":" parseInt(string, radix)\n  åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œçœ‹ä¸‹é¢çš„æµ‹è¯•ä»£ç ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  const noop = () =\u0026gt; {} var vals = [ 1, // 0  \u0026#39;1\u0026#39;, // 1  NaN, // 2  null, // 3  {}, // 4  false, // 5  true, // 6  { length: 2, 0: \u0026#39;a\u0026#39;, 1: \u0026#39;b\u0026#39; }, // 7  { a: 1 }, //8  [], // 9  [1, 2], // 10  noop, // 11  undefined, // 12  void 0 // 13 ] // åœ¨æ‰§è¡Œä¹‹å‰ï¼Œä¸Šé¢ç»“æœä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ const result = vals.map(v =\u0026gt; parseInt(v, 10)) console.log(\u0026#39;\\n\u0026#39;, result) console.log(\u0026#39;[1,2] =\u0026gt; \u0026#39;, result[10])    [ 1, 1, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 1, NaN, NaN, NaN ] [1,2] =\u0026gt; 1 undefined   å‘ç°é—®é¢˜æ²¡ï¼Œç–‘æƒ‘ç‚¹å°± parseInt åœ¨ [1,2] // 10 çš„æ—¶å€™ï¼Œç»“æœå±…ç„¶æ˜¯ 1 ?\n parseInt å®ç°ä¼ªç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101  const ToString = (s) =\u0026gt; \u0026#34;\u0026#34; + s; const TrimString = (s) =\u0026gt; (s || \u0026#34;\u0026#34;).trim(); const ToInt32 = (v) =\u0026gt; +v; const log = console.log; function parseInt(string, radix) { let inputString = ToString(string); // ~æ‚è„¸~ï¼Œè¿™ä¸€è¡Œå°±è¯´æ˜é—®é¢˜äº†  let S = TrimString(inputString); let sign = 1; // 0x002D -\u0026gt; \u0026#39;-\u0026#39;, S.codePointAt(0) === 0x002D  if (S) { const ch = S[0]; if (ch === \u0026#34;-\u0026#34;) { sign = -1; // åˆ é™¤ -  S = S.slice(1); } else if (ch === \u0026#34;+\u0026#34;) { sign = 1; // åˆ é™¤ +  S = S.slice(1); } } // è¿›åˆ¶  let R = ToInt32(radix || 0); let stripPrefix = true; if (R !== 0) { // åªæ”¯æŒ 2~36 è¿›åˆ¶  if (R \u0026lt; 2 || R \u0026gt; 36) return NaN; if (R !== 16) { stripPrefix = false; } } else { // ä¸º 0 æ—¶é»˜è®¤ 10 è¿›åˆ¶  R = 10; } if (stripPrefix) { if (S.length \u0026gt; 2 \u0026amp;\u0026amp; S.slice(0, 2).toLowerCase() === \u0026#34;0x\u0026#34;) { S = S.slice(2); // delete \u0026#39;0x\u0026#39; or \u0026#39;0X\u0026#39;  R = 16; } } // å¦‚æœ S ä¸­åŒ…å«éè¿›åˆ¶å†…çš„å­—ç¬¦ï¼Œå°† end é‡ç½®ä¸ºè¯¥å­—ç¬¦çš„ç´¢å¼•å€¼  let len = S.length, end = len - 1; const table = \u0026#34;0123456789abcdefghijklmnopqrstuvwxyz\u0026#34;.slice(0, radix); for (let i = 0; i \u0026lt; len; i++) { const c = S[i].toLowerCase(); // 10 è¿›åˆ¶æ˜¯ 0 - 9  // 2 -\u0026gt; 0, 1  // 3 -\u0026gt; 0, 1, 2  // ...  // 36 -\u0026gt; 0, ..., 9, a, ..., z  if (!table.includes(c)) { // è¿™é‡Œå‡è®¾æ˜¯ 10è¿›åˆ¶  end = i; // ç¬¬ä¸€ä¸ªéè¿›åˆ¶å†…çš„å­—ç¬¦  break; } } let Z = S.slice(0, end \u0026gt; 0 ? end + 1 : 0); if (!Z) return NaN; let mathInt = parseWithRadix(Z, R); // mathInt è½¬æˆå¯¹åº”è¿›åˆ¶çš„æ•°  if (mathInt === 0) { return sign === -1 ? -0 : +0; } return sign * mathInt; } function parseWithRadix(Z, radix = 10) { let mathInt = 0; const zLen = Z.length; const base = \u0026#34;a\u0026#34;.codePointAt(0); for (let i = 0; i \u0026lt; zLen; i++) { let c = Z[i].toLowerCase(); if (c \u0026gt;= \u0026#34;a\u0026#34; \u0026amp;\u0026amp; c \u0026lt;= \u0026#34;z\u0026#34; \u0026amp;\u0026amp; radix \u0026gt; 10) { c = 10 + c.codePointAt(0) - base; } mathInt += +c * Math.pow(radix, zLen - i - 1); } return mathInt; } function test(val) { let result = []; for (let i = 0; i \u0026lt; 40; i++) { result.push(`R: ${i}, V: ${parseInt(val, i)}`); } log(\u0026#34;\\n\u0026#34;, result); } test(\u0026#34;EEE\u0026#34;); log(parseInt(\u0026#34;0xEEE\u0026#34;, 16)); log(parseInt(\u0026#34;111111\u0026#34;, 2)); test(\u0026#34;-20AFE\u0026#34;);    [ \u0026#39;R: 0, V: NaN\u0026#39;, \u0026#39;R: 1, V: NaN\u0026#39;, \u0026#39;R: 2, V: NaN\u0026#39;, \u0026#39;R: 3, V: NaN\u0026#39;, \u0026#39;R: 4, V: NaN\u0026#39;, \u0026#39;R: 5, V: NaN\u0026#39;, \u0026#39;R: 6, V: NaN\u0026#39;, \u0026#39;R: 7, V: NaN\u0026#39;, \u0026#39;R: 8, V: NaN\u0026#39;, \u0026#39;R: 9, V: NaN\u0026#39;, \u0026#39;R: 10, V: NaN\u0026#39;, \u0026#39;R: 11, V: NaN\u0026#39;, \u0026#39;R: 12, V: NaN\u0026#39;, \u0026#39;R: 13, V: NaN\u0026#39;, \u0026#39;R: 14, V: NaN\u0026#39;, \u0026#39;R: 15, V: 3374\u0026#39;, \u0026#39;R: 16, V: 3822\u0026#39;, \u0026#39;R: 17, V: 4298\u0026#39;, \u0026#39;R: 18, V: 4802\u0026#39;, \u0026#39;R: 19, V: 5334\u0026#39;, \u0026#39;R: 20, V: 5894\u0026#39;, \u0026#39;R: 21, V: 6482\u0026#39;, \u0026#39;R: 22, V: 7098\u0026#39;, \u0026#39;R: 23, V: 7742\u0026#39;, \u0026#39;R: 24, V: 8414\u0026#39;, \u0026#39;R: 25, V: 9114\u0026#39;, \u0026#39;R: 26, V: 9842\u0026#39;, \u0026#39;R: 27, V: 10598\u0026#39;, \u0026#39;R: 28, V: 11382\u0026#39;, \u0026#39;R: 29, V: 12194\u0026#39;, \u0026#39;R: 30, V: 13034\u0026#39;, \u0026#39;R: 31, V: 13902\u0026#39;, \u0026#39;R: 32, V: 14798\u0026#39;, \u0026#39;R: 33, V: 15722\u0026#39;, \u0026#39;R: 34, V: 16674\u0026#39;, \u0026#39;R: 35, V: 17654\u0026#39;, \u0026#39;R: 36, V: 18662\u0026#39;, \u0026#39;R: 37, V: NaN\u0026#39;, \u0026#39;R: 38, V: NaN\u0026#39;, \u0026#39;R: 39, V: NaN\u0026#39; ] 3822 63 [ \u0026#39;R: 0, V: NaN\u0026#39;, \u0026#39;R: 1, V: NaN\u0026#39;, \u0026#39;R: 2, V: NaN\u0026#39;, \u0026#39;R: 3, V: NaN\u0026#39;, \u0026#39;R: 4, V: NaN\u0026#39;, \u0026#39;R: 5, V: NaN\u0026#39;, \u0026#39;R: 6, V: NaN\u0026#39;, \u0026#39;R: 7, V: NaN\u0026#39;, \u0026#39;R: 8, V: NaN\u0026#39;, \u0026#39;R: 9, V: NaN\u0026#39;, \u0026#39;R: 10, V: NaN\u0026#39;, \u0026#39;R: 11, V: -2787\u0026#39;, \u0026#39;R: 12, V: -3591\u0026#39;, \u0026#39;R: 13, V: -4539\u0026#39;, \u0026#39;R: 14, V: -5643\u0026#39;, \u0026#39;R: 15, V: -6915\u0026#39;, \u0026#39;R: 16, V: -133886\u0026#39;, \u0026#39;R: 17, V: -170201\u0026#39;, \u0026#39;R: 18, V: -213476\u0026#39;, \u0026#39;R: 19, V: -264551\u0026#39;, \u0026#39;R: 20, V: -324314\u0026#39;, \u0026#39;R: 21, V: -393701\u0026#39;, \u0026#39;R: 22, V: -473696\u0026#39;, \u0026#39;R: 23, V: -565331\u0026#39;, \u0026#39;R: 24, V: -669686\u0026#39;, \u0026#39;R: 25, V: -787889\u0026#39;, \u0026#39;R: 26, V: -921116\u0026#39;, \u0026#39;R: 27, V: -1070591\u0026#39;, \u0026#39;R: 28, V: -1237586\u0026#39;, \u0026#39;R: 29, V: -1423421\u0026#39;, \u0026#39;R: 30, V: -1629464\u0026#39;, \u0026#39;R: 31, V: -1857131\u0026#39;, \u0026#39;R: 32, V: -2107886\u0026#39;, \u0026#39;R: 33, V: -2383241\u0026#39;, \u0026#39;R: 34, V: -2684756\u0026#39;, \u0026#39;R: 35, V: -3014039\u0026#39;, \u0026#39;R: 36, V: -3372746\u0026#39;, \u0026#39;R: 37, V: NaN\u0026#39;, \u0026#39;R: 38, V: NaN\u0026#39;, \u0026#39;R: 39, V: NaN\u0026#39; ] undefined   å…³é”®ç‚¹ï¼š\n  è¾“å…¥å€¼ä¸€è¿›æ¥å°±ä¼šè¿›è¡Œå­—ç¬¦ä¸²åŒ–ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ•°ç»„ [1,2] æœ€åå¾—åˆ°çš„ç»“æœæ˜¯ 1 äº†\n  è¿›åˆ¶æ•°çš„å¤„ç†ï¼Œä¸º 0 æ—¶ radix = 10, é [2, 36] åŒºé—´çš„æ•°è§†ä¸ºéæ³•è¿›åˆ¶\n  è¾“å…¥çš„å†…å®¹(string) å¦‚ä½•è½¬æˆå¯¹åº”è¿›åˆ¶çš„æ•°ï¼Œå³ parse(Z, radix) å‡½æ•°\n    å­—ç¬¦ä¸²è½¬æ•°å­—å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function parse(Z, radix = 10) { let mathInt = 0; const zLen = Z.length; const base = \u0026#39;a\u0026#39;.codePointAt(0) for (let i = 0; i \u0026lt; zLen; i++) { let c = Z[i].toLowerCase() if (c \u0026gt;= \u0026#39;a\u0026#39; \u0026amp;\u0026amp; c \u0026lt;= \u0026#39;z\u0026#39; \u0026amp;\u0026amp; radix === 16) { c = 10 + c.codePointAt(0) - base } mathInt += +c * Math.pow(radix, zLen - i - 1); } return mathInt } const log = console.log log(parse(\u0026#39;EEE\u0026#39;, 16))    3822 undefined   â“â“â“ parseInt(0.0000005) = 5 â“â“â“\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  function test(res) { console.log(`parseInt(${res}) = ` + parseInt(res)) } test(0.5) test(0.05) test(0.005) test(0.0005) test(0.00005) test(0.000005) test(0.0000005) test(0.00000005) test(0.000000005)    parseInt(0.5) = 0 parseInt(0.05) = 0 parseInt(0.005) = 0 parseInt(0.0005) = 0 parseInt(0.00005) = 0 parseInt(0.000005) = 0 parseInt(5e-7) = 5 parseInt(5e-8) = 5 parseInt(5e-9) = 5 undefined   ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­\n ç»“æœä¸ç”¨åˆ†æäº†å§ï¼Œä¸Šé¢çš„ç»“æœå¾ˆæ˜æ˜¾äº†ï¼Œè¶…è¿‡6ä½çš„å°æ•°åœ¨ toString çš„æ—¶å€™è¢«è½¬æˆäº†æŒ‡ æ•°è¡¨ç¤ºå½¢å¼äº†ï¼Œè€Œ parseInt å®ç°ä¼ªç ä¸€å¼€å§‹å°±ä¼šå°†ä¼ è¿›å»çš„æ•°å­—è½¬æˆå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æœ€ååœ¨ è¯†åˆ«å­—ç¬¦ä¸²çš„æ—¶å€™é‡åˆ°äº† e å°±ç»ˆæ­¢äº†ï¼Œæœ€ç»ˆå¾—åˆ° 5 çš„ç»“æœã€‚\n æœ¬ç€è¿½æ ¹ç©¶åº•çš„åŸåˆ™ï¼Œè¿˜æ˜¯å»çœ‹ä¸‹ toString é‡Œé¢æ˜¯æ€ä¹ˆå¤„ç†çš„å§ ğŸš†\n ECMAScriptÂ® 2022 LanguageÂ Specification - toString\n  è¿™é‡Œå°±è¦çœ‹ä¸‹æ•°å­—æ˜¯å¦‚ä½•è½¬æˆå­—ç¬¦ä¸²çš„ï¼š Number::toString ( x )\n","permalink":"https://www.cheng92.com/web/apis/js-api-number-parseint/","tags":["javascript,","api,","Number"],"title":"JavaScript Api - Number.parseInt(s, r)"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n å£°æ˜ ï¼švue-next runtime-core è¿è¡Œæ—¶æ ¸å¿ƒä»£ç ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¾ƒå¤šï¼Œå¯èƒ½ä¼šåˆ†ä¸ºå‡ ç¯‡æ¥ å™è¿°, f è¿‡æ»¤æ‰å¯¹è±¡ç©ºå€¼å±æ€§ã€‚\n æ›´æ–°æ—¥å¿—\u0026amp;Todos ï¼š\n  [2021-01-08 10:12:50] åˆ›å»º\n  DONE [2021-01-15 10:24:00] scheduler\n  TODO apiWatch -\u0026gt; post cb \u0026amp; ssr\n  TODO STATEFUL_COMONENT\n  TODO patchFlag æµ‹è¯•å’Œç”¨é€”\n  TODO transformVNodeArgs\n  TODO Suspense ç»„ä»¶\n  TODO shouldTrack, currentBlock å’Œ block ç›¸å…³å‡½æ•°çš„ä½œç”¨\n  TODO setup() è¿”å›å€¼ç”¨æ¥åšäº†å•¥ï¼Ÿ\n  TODO setup() é‡Œé¢æ˜¯å¦‚ä½•æ”¶é›†ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œåˆæ˜¯å¦‚ä½•ï¼Ÿåœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿæ‰§è¡Œä»–ä»¬çš„ï¼Ÿ\n  TODO async component\n    æ¨¡å—åˆå§‹åŒ–ï¼š feat(init): runtime-core Â· gcclll/stb-vue-next@b22b4db Â· GitHub\n âš  Tips    class æ”¯æŒæ•°ç»„([\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;])ï¼Œå¯¹è±¡({foo:true,bar:false})ï¼Œå­—ç¬¦ä¸²(\u0026#39;foo bar\u0026#39;)\n  style æ”¯æŒæ•°ç»„([\u0026#39;color:red\u0026#39;, {foo:\u0026#39;foo\u0026#39;}])ï¼Œå¯¹è±¡({color:\u0026#39;red\u0026#39;,foo:\u0026#39;foo\u0026#39;})ï¼Œå­—ç¬¦ä¸²(color:red)\n  class component æ¡ä»¶ï¼š\n  function\n  å« __vccOpts = { template: \u0026#39;\u0026lt;div /\u0026gt;\u0026#39;}\n    vnode ref å±æ€§åˆå¹¶å¤„ç†é€»è¾‘ï¼Ÿ\n  vnode key å±æ€§ç®€å•çš„å€¼è¦†ç›–æ“ä½œï¼Ÿ\n  h() å’Œ createVNode å‡½æ•°å¤šç§ä½¿ç”¨æ–¹å¼ç»„åˆï¼Ÿ\n h(type, propsOrChildren, ...children), å‚æ•°ä¸ªæ•°å¤šå˜ï¼Œå¯¹äºè¿™ä¸ªå‡½æ•°çš„ä½¿ç”¨æ–¹æ³• è®°å¿†åªè¦è®°ä½ä¸€ç‚¹ï¼š\n props æ€»æ˜¯å¯¹è±¡ï¼Œchildren å¯ä»¥æ˜¯å¯¹è±¡(å¿…é¡»æ˜¯ VNode ç±»å‹ __v_isVNode)ä¹Ÿå¯ä»¥æ˜¯ æ•°ç»„ï¼Œæ‰€ä»¥ï¼š\n  argc = 2, å¦‚æœæ˜¯æ•°ç»„å°±ä¸€å®šæ˜¯ children\n  argc = 2, å¦‚æœæ˜¯å¯¹è±¡ä¸”æœ‰ __v_isVNode æ ‡è¯†ï¼Œä¸€å®šæ˜¯ children å¦åˆ™æ˜¯ props\n  argc = 3, æŒ‰ç…§ h(type, props, children) å¤„ç†\n  argc \u0026gt; 3, æŒ‰ç…§ h(type, props, ...children) å¤„ç†ï¼Œä»ç¬¬ä¸‰ä¸ªå¼€å§‹éƒ½æ˜¯ children\n    createVNode(type, props, children), å›ºå®šä¸‰ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªä¸€å®šæ˜¯ props, ç¬¬ä¸‰ ä¸ªä¸€å®šæ˜¯æ•°ç»„ç±»å‹çš„ childrenï¼Œå› ä¸ºå®ƒåé¢è¿˜æœ‰æ›´å¤šçš„å…¶ä»–å‚æ•°(patchFlag, dynamicProps, isBlockNode)ï¼Œæ‰€ä»¥å‰ä¸‰ä¸ªå¿…é¡»ç¡®å®šä¸‹æ¥ã€‚\n  scheduler, vue-next ä¸­çš„ä»»åŠ¡è°ƒåº¦å™¨å¦‚ä½•å®ç°ï¼Ÿ\n  api watch(source, cb, option) ä¸­çš„ source åªèƒ½æ˜¯ reactive/ref/function/array ç±»å‹ï¼Œ å¦‚æœæ˜¯æ•°ç»„æ—¶å…¶å…ƒç´ åªèƒ½æ˜¯ reactive/ref/function\n  api watch(â€¦, { deep: true }) æ˜¯å¦‚ä½•åšåˆ°æ·±åº¦ç›‘å¬çš„ï¼Ÿ\n  api watch(shallowRef, cb (newVal) =\u0026gt; {}) æ˜¯å¦‚ä½•ç›´æ¥ä½¿ç”¨ newVal.a çš„ï¼Ÿ\n1 2 3 4  var obj = shallowRef({ a: 0 }); watch(shallowRef, (newVal) =\u0026gt; { dummy = newVal.a; // è¿™é‡Œä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥è®¿é—® obj.aï¼Œobj åˆæ˜¯ä»€ä¹ˆï¼Ÿ });      provide \u0026amp; inject å¦‚ä½•å®ç°ï¼Ÿ\n provide(key,value) å‘ç»„ä»¶ provides[key] = value è®¾ç½®\n inject(key) ä»ç»„ä»¶ provides[key] å–å€¼\n  TODO setup() è¿”å›å€¼ç”¨æ¥åšäº†å•¥ï¼Ÿ\n  ç»„ä»¶å£°æ˜å‘¨æœŸå‡½æ•°(onBeforeXxx, onXxx)è§¦å‘é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ\n    ğŸ‚ init   å¯¼å‡ºå·²å®Œæˆæ¨¡å—(reactiviy)é‡Œçš„ Apis: feat(init): runtime-core\u0026gt; add exports from @vue/reactivity Â· gcclll/stb-vue-next@38e91a8 Â· GitHub\n è¿™éƒ¨åˆ†ä»£ç æœ‰ç‚¹å¤šï¼Œæ‰€ä»¥è¿™é‡Œäº‹å…ˆå°†æ‰€æœ‰ç±»å‹å®šä¹‰æ·»åŠ å¥½ï¼š\n feat(add): runtime-core\u0026gt;all types Â· gcclll/stb-vue-next@e3f7b94 Â· GitHub\n æœ‰å…³ç±»å‹å®šä¹‰è¯·ç§»æ­¥æœ€åä¸€èŠ‚(çº¯è´´ä»£ç çš„ï¼Œæ‰€ä»¥æ”¾åˆ°æœ€å)\n  ğŸ˜œ h function   feat(add): runtime-core\u0026gt;h function Â· gcclll/stb-vue-next@e48d5e2 Â· GitHub\n h, render å‡½æ•°åˆå§‹åŒ–ã€‚\n1 2 3 4 5  // Actual implementation export function h(type: any, propsOrChildren?: any, children?: any): VNode { // TODO  return {} as VNode; }     å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  // Actual implementation export function h(type: any, propsOrChildren?: any, children?: any): VNode { const l = arguments.length; if (l === 2) { if (isObject(propsOrChildren) \u0026amp;\u0026amp; !isArray(propsOrChildren)) { // æ²¡æœ‰ props çš„ å•èŠ‚ç‚¹(single vnode)  if (isVNode(propsOrChildren)) { return createVNode(type, null, [propsOrChildren]); } // æœ‰ props æ²¡æœ‰ children  return createVNode(type, propsOrChildren); } else { // omit props  return createVNode(type, null, propsOrChildren); } } else { // ä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹å…¨å½“åšå­©å­èŠ‚ç‚¹å¤„ç†  if (l \u0026gt; 3) { children = Array.prototype.slice.call(arguments, 2); } else if (l === 3 \u0026amp;\u0026amp; isVNode(children)) { children = [children]; } return createVNode(type, propsOrChildren, children); } }     h, æ¥å—ä¸å®šå‚æ•°\n é€»è¾‘è„‘å›¾:\n  ä»è„‘å›¾åˆ†æ”¯å¾—å‡ºæ”¯æŒçš„æƒ…å†µä»£ç ç¤ºä¾‹ï¼š\n  h(\u0026#39;div\u0026#39;) æ— å‚æ•°æ— å­©å­\n  h(\u0026#39;div\u0026#39;, { id: \u0026#39;foo\u0026#39; }) æœ‰ props æ—  children\n  h(\u0026#39;div\u0026#39;, [\u0026#39;foo\u0026#39;]) æ•°ç»„å½“åš chilren\n  h(\u0026#39;div\u0026#39;, vnode) æœ‰ __v_isVNode æ ‡è¯†å½“åš childrenï¼Œå¹¶è½¬æˆæ•°ç»„ [vnode]\n  h(\u0026#39;div\u0026#39;, {}, [\u0026#39;foo\u0026#39;]) æœ‰ props æœ‰ children\n  h(\u0026#39;div\u0026#39;, {}, vnode) æœ‰ props, æœ‰ children ä¸” = [vnode]\n  æ¥ä¸‹æ¥éœ€è¦å…·ä½“å»å®ç° createVNode å‡½æ•°ã€‚\n  ğŸŒ¿ createVNode function   feat(add): rc-\u0026gt;createVNode Â· gcclll/stb-vue-next@194f72f Â· GitHub\n è¿™ä¸ªå‡½æ•°æœ€ç»ˆæ˜¯æ„é€ äº† vnode: VNode è™šæ‹ŸèŠ‚ç‚¹ç»“æ„ï¼Œè¿”å›ã€‚\n è¿™é‡Œé¢åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤å®ç°ï¼š\n  type æ˜¯ vnode æ—¶å€™å¤„ç†\n  class ç»„ä»¶å¤„ç†\n  props å¤„ç†\n  shapeFlag æ£€æµ‹ï¼Œæ˜¯ä»€ä¹ˆç±»å‹ çš„ vnode\n  ç»„ä»¶å¯¹è±¡ä¸åº”è¯¥ reactive(æœ‰çŠ¶æ€çš„ç»„ä»¶, STATEFUL_COMONENT)\n  æ„å»º vnode: VNode å¯¹è±¡\n  æ£€æµ‹ vnode.key æ˜¯ä¸æ˜¯ NaN\n  normalize children\n  normalize suspense children\n  currentBlock å¤„ç†\n  è¿”å› vnode èŠ‚ç‚¹\n  1 2 3 4 5 6 7 8 9 10 11  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode, reactive }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(h(...args)); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; type only\\n\u0026#34;, _h(\u0026#34;div\u0026#34;)]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; type + props\\n\u0026#34;, _h(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34; })]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; type + omit props\\n\u0026#34;, _h(\u0026#34;div\u0026#34;, [\u0026#34;foo\u0026#34;])]);    \u0026gt;\u0026gt;\u0026gt; type only { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, shapeFlag: 1 } \u0026gt;\u0026gt;\u0026gt; type + props { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, props: { id: \u0026#39;foo\u0026#39; }, shapeFlag: 1 } \u0026gt;\u0026gt;\u0026gt; type + omit props { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, shapeFlag: 1 } \u0026gt;\u0026gt;\u0026gt; default slot { __v_isVNode: true, __v_skip: true, type: { template: \u0026#39;\u0026lt;br /\u0026gt;\u0026#39; }, shapeFlag: 4 } undefined  d3c6563 props   feat(add): rc-\u0026gt;createVNode, props Â· gcclll/stb-vue-next@d3c6563 Â· GitHub\n å¤„ç† class å’Œ style å±æ€§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  // 3. props å¤„ç†, class \u0026amp; style normalization  if (props) { // for reactive or proxy objects, we need to clone it to enable mutation.  if (isProxy(props) || InternalObjectKey in props) { props = extend({}, props); } let { class: klass, style } = props; if (klass \u0026amp;\u0026amp; !isString(klass)) { // 1. string -\u0026gt; klass  // \u0026#39;foo\u0026#39; -\u0026gt; \u0026#39;foo\u0026#39;  // 2. array -\u0026gt; \u0026#39;\u0026#39; + arr.join(\u0026#39; \u0026#39;)  // [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;] -\u0026gt; \u0026#39;foo bar\u0026#39;  // 3. object -\u0026gt; \u0026#39;\u0026#39; + value ? \u0026#39; value\u0026#39; : \u0026#39;\u0026#39;  // { foo: true, bar: false, baz: true } -\u0026gt; \u0026#39;foo baz\u0026#39;  props.class = normalizeClass(klass); } if (isObject(style)) { // reactive state objects need to be cloned since they are likely to be  // mutated  if (isProxy(style) \u0026amp;\u0026amp; !isArray(style)) { style = extend({}, style); } // 1. array -\u0026gt; object  // [{ color: \u0026#39;red\u0026#39; }, \u0026#39;font-size:10px;height:100px;\u0026#39;] -\u0026gt;  // { color: \u0026#39;red\u0026#39;, \u0026#39;font-size\u0026#39;: \u0026#39;10px\u0026#39;, height: \u0026#39;100px\u0026#39; }  // 2. object -\u0026gt; object åŸæ ·è¿”å›  props.style = normalizeStyle(style); } }      class æ•°ç»„ï¼Œå¯¹è±¡ï¼Œå­—ç¬¦ä¸²ï¼Ÿ\n æ•°ç»„ï¼š åˆå¹¶æˆå­—ç¬¦ä¸²ï¼Œ [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;] -\u0026gt; \u0026#39;foo bar\u0026#39;\n å¯¹è±¡ï¼š åˆå¹¶æˆå­—ç¬¦ä¸²ï¼Œ {foo: true, bar: false, baz: true} -\u0026gt; \u0026#39;foo baz\u0026#39;\n å­—ç¬¦ä¸²ï¼š åŸæ ·è¾“å‡º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  export function normalizeClass(value: unknown): string { let res = \u0026#34;\u0026#34;; if (isString(value)) { res = value; } else if (isArray(value)) { for (let i = 0; i \u0026lt; value.length; i++) { res += normalizeClass(value[i]) + \u0026#34; \u0026#34;; } } else if (isObject(value)) { for (const name in value) { if (value[name]) { res += name + \u0026#34; \u0026#34;; } } } return res.trim(); }      style æ•°ç»„ï¼Œå¯¹è±¡ï¼Œå­—ç¬¦ä¸²ï¼Ÿ\n æ•°ç»„ï¼š åˆå¹¶æˆå¯¹è±¡ï¼Œ [\u0026#39;color:red\u0026#39;, { \u0026#39;font-size\u0026#39;: \u0026#39;10px\u0026#39;, height: \u0026#39;100px\u0026#39; }] -\u0026gt; {color: \u0026#39;red\u0026#39;, \u0026#39;font-size\u0026#39;: \u0026#39;10px\u0026#39;, height: \u0026#39;100px\u0026#39;}\n å¯¹è±¡ï¼š åŸæ ·è¿”å›\n å­—ç¬¦ä¸²ï¼šè§£ææˆå¯¹è±¡ï¼Œ å¦‚æ•°ç»„å†…å­—ç¬¦ä¸²éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  export function normalizeStyle(value: unknown): NormalizedStyle | undefined { if (isArray(value)) { const res: Record\u0026lt;string, string | number\u0026gt; = {}; for (let i = 0; i \u0026lt; value.length; i++) { const item = value[i]; const normalized = normalizeStyle( isString(item) ? parseStringStyle(item) : item ); if (normalized) { for (const key in normalized) { res[key] = normalized[key]; } } } return res; } else if (isObject(value)) { return value; } }       æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c }, f, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) let _h = (...args) =\u0026gt; f(c(...args), \u0026#39;props\u0026#39;) // class åˆå¹¶æˆå­—ç¬¦ä¸² log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; class: string\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { class: \u0026#39;foo baz\u0026#39; })]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; class: array\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { class: [\u0026#39;foo\u0026#39;, \u0026#39;baz\u0026#39;] })]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; class: array\u0026lt;object|string\u0026gt;\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { class: [{ foo: \u0026#39;foo\u0026#39; }, \u0026#39;baz\u0026#39;, { baz: \u0026#39;baz\u0026#39; }] })]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; class: object\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { class: {\u0026#39;foo\u0026#39;: true, \u0026#39;baz\u0026#39;: false, \u0026#39;bar\u0026#39;: true} })]) // style åˆå¹¶æˆå¯¹è±¡ log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; style: array\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { style: [{ foo: \u0026#39;foo\u0026#39; }, { baz: \u0026#39;baz\u0026#39; }] })]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; style: object\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { style: { foo: \u0026#39;foo\u0026#39;, baz: \u0026#39;baz\u0026#39; } })]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; style: array\u0026lt;object|string\u0026gt;\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { style: [{ foo: \u0026#39;foo\u0026#39; }, \u0026#39;color:red\u0026#39;, { baz: \u0026#39;baz\u0026#39; }] })])    \u0026gt;\u0026gt;\u0026gt; class: string { props: { class: \u0026#39;foo baz\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; class: array { props: { class: \u0026#39;foo baz\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; class: array\u0026lt;object|string\u0026gt; { props: { class: \u0026#39;foo baz baz\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; class: object { props: { class: \u0026#39;foo bar\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; style: array { props: { style: { foo: \u0026#39;foo\u0026#39;, baz: \u0026#39;baz\u0026#39; } } } \u0026gt;\u0026gt;\u0026gt; style: object { props: { style: { foo: \u0026#39;foo\u0026#39;, baz: \u0026#39;baz\u0026#39; } } } \u0026gt;\u0026gt;\u0026gt; style: array\u0026lt;object|string\u0026gt; { props: { style: { foo: \u0026#39;foo\u0026#39;, color: \u0026#39;red\u0026#39;, baz: \u0026#39;baz\u0026#39; } } } undefined    class component   æ˜¯ç±»ç»„ä»¶å‰ææ˜¯ï¼š\n  å¿…é¡»æ˜¯å‡½æ•°\n  å¿…é¡»åŒ…å« __vccOpts å±æ€§\n  1 2 3 4 5 6 7 8  // 2. class component  if (isClassComponent(type)) { type = type.__vccOpts; } export function isClassComponent(value: unknown): value is ClassComponent { return isFunction(value) \u0026amp;\u0026amp; \u0026#34;__vccOpts\u0026#34; in value; }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c }, f, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const _h = (...args) =\u0026gt; f(c(...args)) class Component { $props static __vccOpts = { template: \u0026#39;\u0026lt;div /\u0026gt;\u0026#39; } } log(_h(Component))    { __v_isVNode: true, __v_skip: true, type: { template: \u0026#39;\u0026lt;div /\u0026gt;\u0026#39; }, shapeFlag: 4 // STATEFUL_COMPONENT } undefined    TODO stateful component \u0026amp; key NaN   æœ‰çŠ¶æ€çš„ç»„ä»¶ï¼Ÿ\n å³ type ä¸ºå¯¹è±¡æ—¶å€™è§†ä¸ºæœ‰çŠ¶æ€çš„ç»„ä»¶ã€‚\n å¦‚æœæ˜¯ STATEFUL_COMPONENT ä¸”æ˜¯ä¸ª proxy çš„æ—¶å€™ï¼Œå¼€å‘æ¨¡å¼ä¸‹ç»™å‡ºè­¦å‘Šâš ï¸ã€‚\n1 2 3 4 5 6  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c, reactive:r }, f, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const _h = (...args) =\u0026gt; f(c(...args)) log(_h(\u0026#39;div\u0026#39;, { key: NaN }))    { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, props: { key: NaN }, shapeFlag: 1 } undefined    88eaf09 type is vnode   feat(add): rc-\u0026gt;createVNode, type is vnode Â· gcclll/stb-vue-next@88eaf09 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  // \u0026gt; in createVNode  // 1. type is vnode  if (isVNode(type)) { // createVNode receiving an existing vnode. This happens in cases like  // \u0026lt;component :is=\u0026#34;vnode\u0026#34;/\u0026gt;  // #2078 make sure to merge refs during the clone instead of overwriting it  const cloned = cloneVNode(type, props, true /* mergeRef: true */); if (children) { normalizeChildren(cloned, children); } return cloned; } // cloneVNode  // çœç•¥ç›´æ¥å– vnode å€¼éƒ¨åˆ†  export function cloneVNode\u0026lt;T, U\u0026gt;( vnode: VNode\u0026lt;T, U\u0026gt;, extraProps?: (Data \u0026amp; VNodeProps) | null, mergeRef = false ): VNode\u0026lt;T, U\u0026gt; { // This is intentionally NOT using spread or extend to avoid the runtime  // key enumeration cost.  const { props, ref, patchFlag } = vnode; const mergedProps = extraProps ? mergeProps(props || {}, extraProps) : props; return { __v_isVNode: true, [ReactiveFlags.SKIP]: true, type: vnode.type, props: mergedProps, key: mergedProps \u0026amp;\u0026amp; normalizeKey(mergedProps), ref: extraProps \u0026amp;\u0026amp; extraProps.ref ? // #2078 in the case of \u0026lt;component :is=\u0026#34;vnode\u0026#34; ref=\u0026#34;extra\u0026#34;/\u0026gt;  // if the vnode itself already has a ref, cloneVNode will need to merge  // the refs so the single vnode can be set on multiple refs  mergeRef \u0026amp;\u0026amp; ref ? isArray(ref) ? ref.concat(normalizeRef(extraProps)!) : [ref, normalizeRef(extraProps)!] : normalizeRef(extraProps) : ref, // if the vnode is cloned with extra props, we can no longer assume its  // existing patch flag to be reliable and need to add the FULL_PROPS flag.  // note: perserve flag for fragments since they use the flag for children  // fast paths only.  patchFlag: extraProps \u0026amp;\u0026amp; vnode.type !== Fragment ? patchFlag === -1 // hoisted node  ? PatchFlags.FULL_PROPS : patchFlag | PatchFlags.FULL_PROPS : patchFlag, ssContent: vnode.ssContent \u0026amp;\u0026amp; cloneVNode(vnode.ssContent), ssFallback: vnode.ssFallback \u0026amp;\u0026amp; cloneVNode(vnode.ssFallback), }; }     cloneVNode ç»å¤§éƒ¨åˆ†å±æ€§éƒ½æ˜¯ç›´æ¥å¼•ç”¨è‡ª vnodeï¼Œä¸Šé¢åˆ—å‡ºçš„éƒ½æ˜¯éœ€è¦å¤„ç†çš„å±æ€§ï¼Œæ¯”å¦‚ï¼š\n  props ä¼šå°† vnode å’Œ cloneVNode ä¼ å…¥çš„ props è¿›è¡Œåˆå¹¶ï¼Œå¹¶ä¸”æ˜¯ä¼ å…¥çš„ props è¦†ç›– vnode.propsã€‚\n  key å±æ€§ï¼Œå–åˆå¹¶ä¹‹åçš„ key(æµ‹è¯•-\u0026gt;)\n1 2 3 4 5  // normalize åˆå¹¶åçš„ key  const key = mergedProps \u0026amp;\u0026amp; normalizeKey(mergedProps); const normalizeKey = ({ key }: VNodeProps): VNode[\u0026#34;key\u0026#34;] =\u0026gt; key != null ? key : null;      ref å±æ€§ï¼Œåˆå¹¶è§„åˆ™(æµ‹è¯•-\u0026gt;)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  // 1. mergeRef: boolean å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ˜¯å¦éœ€è¦åˆå¹¶  // 2. extraProps.ref è°ƒç”¨ cloneVNode æ—¶å€™ä¼ å…¥çš„ props ref  // 3. ref å¦‚æœæ˜¯æ•°ç»„ï¼ŒåŠ ä¸Šæ–°çš„ ref æ‰©å±•åŸæ•°ç»„  // 4. ref ä¸æ˜¯æ•°ç»„ï¼Œç”¨ ref å’Œ extra ref åˆå¹¶æˆæ–°æ•°ç»„  // 5. å¦‚æœ ref null, åˆ™ç›´æ¥ç”¨ extra ref normalize å‡ºæ–°çš„ ref  const ref = extraProps \u0026amp;\u0026amp; extraProps.ref ? // #2078 in the case of \u0026lt;component :is=\u0026#34;vnode\u0026#34; ref=\u0026#34;extra\u0026#34;/\u0026gt;  // if the vnode itself already has a ref, cloneVNode will need to merge  // the refs so the single vnode can be set on multiple refs  mergeRef \u0026amp;\u0026amp; ref ? isArray(ref) ? ref.concat(normalizeRef(extraProps)!) : [ref, normalizeRef(extraProps)!] : normalizeRef(extraProps) : ref; // normalization  const normalizeRef = ({ ref }: VNodeProps): VNodeNormalizedRefAtom | null =\u0026gt; { return (ref != null ? isString(ref) || isRef(ref) || isFunction(ref) ? { i: currentRenderingInstance, r: ref } : ref : null) as any; };      patchFlag å±æ€§(æµ‹è¯•-\u0026gt;)\n1 2 3 4 5 6  const patchFlag = extraProps \u0026amp;\u0026amp; vnode.type !== Fragment ? patchFlag === -1 // hoisted node  ? PatchFlags.FULL_PROPS : patchFlag | PatchFlags.FULL_PROPS : patchFlag;      ssContent é€’å½’è°ƒç”¨ cloneVNode(vnode.ssContent)\n  ssFallback é€’å½’è°ƒç”¨ cloneVNode(vnode.ssFallback)\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c, cloneVNode: cv }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(c(...args)); const node1 = _h(\u0026#34;div\u0026#34;, { foo: 1 }, null /* children */); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; vnode 1\\n\u0026#34;, node1]); const node2 = _h({}, null, [node1]); const cloned2 = cv(node2); // cloneVNode åªæ˜¯ä¸€æ¬¡æµ…æ‹·è´ log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; node2 == cloned2\\n\u0026#34;, f(cloned2), \u0026#34;\\n \u0026gt; node2 \\n\u0026#34;, node2]);    \u0026gt;\u0026gt;\u0026gt; vnode 1 { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, props: { foo: 1 }, shapeFlag: 1 } \u0026gt;\u0026gt;\u0026gt; node2 == cloned2 { __v_isVNode: true, __v_skip: true, type: {}, children: [ { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, props: [Object], shapeFlag: 1 } ], shapeFlag: 20 } \u0026gt; node2 { __v_isVNode: true, __v_skip: true, type: {}, children: [ { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, props: [Object], shapeFlag: 1 } ], shapeFlag: 20 } undefined   feat(add): rc-\u0026gt;createVNode, currentRenderingInstance Â· gcclll/stb-vue-next@4fbd98f Â· GitHub\nkey test   vnode.key çš„ clone æ“ä½œï¼Œå±äºå•çº¯çš„å€¼è¦†ç›–æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c, cloneVNode: cv }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(c(...args)); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; ä¿ç•™ vnode.key å€¼\\n\u0026#34;, f(cv(c(\u0026#34;div\u0026#34;, { key: 1 })), \u0026#34;key\u0026#34;)]); log([ \u0026#34;\u0026gt;\u0026gt;\u0026gt; æ›¿æ¢ vnode.key å€¼\\n\u0026#34;, f(cv(c(\u0026#34;div\u0026#34;, { key: 1 }), { key: 2 }), \u0026#34;key\u0026#34;), ]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; æ–° props.key å€¼\\n\u0026#34;, f(cv(c(\u0026#34;div\u0026#34;), { key: 2 }), \u0026#34;key\u0026#34;)]); log(\u0026#34;\u0026gt;\u0026gt;\u0026gt; æµ‹è¯• vnode.key å„ç§æƒ…å†µå€¼\u0026#34;); for (const key of [\u0026#34;\u0026#34;, \u0026#34;a\u0026#34;, 0, 1, NaN]) { log(f(c(\u0026#34;div\u0026#34;, { key }), \u0026#34;key\u0026#34;)); }    \u0026gt;\u0026gt;\u0026gt; ä¿ç•™ vnode.key å€¼ { key: 1 } \u0026gt;\u0026gt;\u0026gt; æ›¿æ¢ vnode.key å€¼ { key: 2 } \u0026gt;\u0026gt;\u0026gt; æ–° props.key å€¼ { key: 2 } \u0026gt;\u0026gt;\u0026gt; æµ‹è¯• vnode.key å„ç§æƒ…å†µå€¼ {} { key: \u0026#39;a\u0026#39; } {} { key: 1 } [Vue warn]: VNode created with invalid key (NaN). VNode type:div {} undefined    ref test   æµç¨‹è„‘å›¾ï¼š  æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c, cloneVNode: cv, ssrUtils: { setCurrentRenderingInstance: s }, }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(c(...args)); const mockIns1 = { ins: 1 }, mockIns2 = { ins: 2 }; s(mockIns1); let original = c(\u0026#34;div\u0026#34;, { ref: \u0026#34;foo\u0026#34; }); // æœ¬èº«æ²¡æœ‰çš„æ—¶å€™ä¼šå°† extraProps.ref ä½œä¸ºæ–°çš„ vnode.ref å€¼ log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; 1. vnode æœ¬èº«æ—  ref\\n\u0026#34;, f(original, \u0026#34;ref\u0026#34;)]); let cloned1 = cv(original); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; 2. ä¿ç•™åŸæœ‰çš„ vnode.ref\\n\u0026#34;, f(cloned1, \u0026#34;ref\u0026#34;)]); // è¿™é‡Œæ²¡æŒ‡å®š mergeProp æ‰€ä»¥ä¼šæ›¿æ¢åŸæ¥çš„ let cloned2 = cv(original, { ref: \u0026#34;bar\u0026#34; }); log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; 3. ref: \u0026#34;bar\u0026#34; æ›¿æ¢åŸæœ‰çš„ vnode.ref\\n\u0026#39;, f(cloned2, \u0026#34;ref\u0026#34;)]); let original2 = c(\u0026#34;div\u0026#34;); let cloned3 = cv(original2, { ref: \u0026#34;bar\u0026#34; }); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; 4. æ²¡æœ‰ vnode.ref æƒ…å†µï¼Œæ–°å¢ ref\\n\u0026#34;, f(cloned3, \u0026#34;ref\u0026#34;)]); s(mockIns2); // åº”è¯¥ä¿ç•™åŸæœ‰çš„ context instance let cloned4 = cv(original); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; 5. åº”è¯¥ä¿ç•™åŸæœ‰çš„ context instance\\n\u0026#34;, f(cloned4, \u0026#34;ref\u0026#34;)]); // ref è¦†ç›–ï¼Œä½¿ç”¨æ–°çš„ context instance: mockIns2 let cloned5 = cv(original, { ref: \u0026#34;bar\u0026#34; }); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; 6. ref æ”¹å˜ï¼Œä½¿ç”¨æ–°çš„ context instance\\n\u0026#34;, f(cloned5, \u0026#34;ref\u0026#34;)]); s(null); // ç½®ç©º context instance  log(\u0026#39;\\n\\n// mergeRef æƒ…å†µæµ‹è¯•\\n\u0026#39;) s(mockIns1) original = c(\u0026#39;div\u0026#39;, { ref: \u0026#39;foo\u0026#39; }) s(mockIns2) cloned1 = cv(original, { ref: \u0026#39;bar\u0026#39; }, true) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; mergeRef: true åˆå¹¶ vnode.ref\\n\u0026#39;, f(cloned1, \u0026#39;ref\u0026#39;)]) log(cloned1.ref[0]) log(cloned1.ref[1])    \u0026gt;\u0026gt;\u0026gt; 1. vnode æœ¬èº«æ—  ref { ref: { i: { ins: 1 }, r: \u0026#39;foo\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; 2. ä¿ç•™åŸæœ‰çš„ vnode.ref { ref: { i: { ins: 1 }, r: \u0026#39;foo\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; 3. ref: \u0026#34;bar\u0026#34; æ›¿æ¢åŸæœ‰çš„ vnode.ref { ref: { i: { ins: 1 }, r: \u0026#39;bar\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; 4. æ²¡æœ‰ vnode.ref æƒ…å†µï¼Œæ–°å¢ ref { ref: { i: { ins: 1 }, r: \u0026#39;bar\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; 5. åº”è¯¥ä¿ç•™åŸæœ‰çš„ context instance { ref: { i: { ins: 1 }, r: \u0026#39;foo\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; 6. ref æ”¹å˜ï¼Œä½¿ç”¨æ–°çš„ context instance { ref: { i: { ins: 2 }, r: \u0026#39;bar\u0026#39; } } // mergeRef æƒ…å†µæµ‹è¯• \u0026gt;\u0026gt;\u0026gt; mergeRef: true åˆå¹¶ vnode.ref { ref: [ { i: [Object], r: \u0026#39;foo\u0026#39; }, { i: [Object], r: \u0026#39;bar\u0026#39; } ] } { i: { ins: 1 }, r: \u0026#39;foo\u0026#39; } { i: { ins: 2 }, r: \u0026#39;bar\u0026#39; } undefined    TODO patchFlag test   TODO need openBlock\u0026amp;createBlock support.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c, cloneVNode: cv, ssrUtils: { setCurrentRenderingInstance: s }, }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(c(...args)); const hoist = c(\u0026#39;div\u0026#39;) // é™æ€èŠ‚ç‚¹ let vnode1 const vnode = (openBlock(), createBlock(\u0026#39;div\u0026#39;))      shapeFlag test  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c, cloneVNode: cv, Text }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(c(...args)); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; ELEMENT\\n\u0026#34;, f(c(\u0026#34;div\u0026#34;), \u0026#34;shapeFlag\u0026#34;)]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; STATEFUL_COMONENT\\n\u0026#34;, f(c({}), \u0026#34;shapeFlag\u0026#34;)]); log([ \u0026#34;\u0026gt;\u0026gt;\u0026gt; FUNCTION_COMONENT\\n\u0026#34;, f( c(() =\u0026gt; {}), \u0026#34;shapeFlag\u0026#34; ), ]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; Text\\n\u0026#34;, f(c(Text), \u0026#34;shapeFlag\u0026#34;)]);    \u0026gt;\u0026gt;\u0026gt; ELEMENT { shapeFlag: 1 } \u0026gt;\u0026gt;\u0026gt; STATEFUL_COMONENT { shapeFlag: 4 } \u0026gt;\u0026gt;\u0026gt; FUNCTION_COMONENT { shapeFlag: 2 } \u0026gt;\u0026gt;\u0026gt; Text { shapeFlag: 0 } undefined    mergeProps test  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c, cloneVNode: cv, Text, mergeProps }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); let p1 = { class: \u0026#34;c\u0026#34; }; let p2 = { class: [\u0026#34;cc\u0026#34;] }; let p3 = { class: [{ ccc: true }] }; let p4 = { class: { cccc: true } }; log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; merge class\\n\u0026#34;, mergeProps(p1, p2, p3, p4)]); let ps1 = { style: { color: \u0026#34;red\u0026#34;, fontSize: 10 }, }; let ps2 = { style: [ { color: \u0026#34;blue\u0026#34;, width: \u0026#34;200px\u0026#34; }, { width: \u0026#34;300px\u0026#34;, height: \u0026#34;300px\u0026#34;, fontSize: 30, }, ], }; let ps3 = { style: \u0026#39;width:100px;right:10;top:10\u0026#39; } log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; merge style\\n\u0026#34;, mergeProps(ps1, ps2, ps3)]); let clickHandler1 = function(){} let clickHandler2 = function(){} let focusHandler3 = function(){} let ph1 = { onClick: clickHandler1 } let ph2 = { onClick: clickHandler2, onFocus: focusHandler3 } log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; merge handlers\\n\u0026#39;, mergeProps(ph1, ph2)])    \u0026gt;\u0026gt;\u0026gt; merge class { class: \u0026#39;c cc ccc cccc\u0026#39; } \u0026gt;\u0026gt;\u0026gt; merge style { style: { color: \u0026#39;blue\u0026#39;, fontSize: 30, width: \u0026#39;100px\u0026#39;, height: \u0026#39;300px\u0026#39;, right: \u0026#39;10\u0026#39;, top: \u0026#39;10\u0026#39; } } \u0026gt;\u0026gt;\u0026gt; merge handlers { onClick: [ [Function: clickHandler1], [Function: clickHandler2] ], onFocus: [Function: focusHandler3] } undefined    TODO dynamic children test   \u0026gt; need openBlock\u0026amp;createBlock support\n1 2 3 4 5 6 7 8  const { rc: { h, createVNode: c, cloneVNode: cv, Text, mergeProps }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const hoist = createVNode(\u0026#39;div\u0026#39;) let vnode1      TODO transformVNodeArgs test     TODO 7ec1d30 suspense component   feat(add): rc-\u0026gt;createVNode, type is suspense component Â· gcclll/stb-vue-next@7ec1d30 Â· GitHub\n Suspense çš„ children å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  // 7. normalize suspense children  if (__FEATURE_SUSPENSE__ \u0026amp;\u0026amp; shapeFlag \u0026amp; ShapeFlags.SUSPENSE) { const { content, fallback } = normalizeSuspenseChildren(vnode); vnode.ssContent = content; vnode.ssFallback = fallback; } // normalizeSuspenseChildren  export function normalizeSuspenseChildren( vnode: VNode ): { content: VNode; fallback: VNode; } { const { shapeFlag, children } = vnode; let content: VNode, fallback: VNode; if (shapeFlag \u0026amp; ShapeFlags.SLOTS_CHILDREN) { content = normalizeSuspenseSlot((children as Slots).default); fallback = normalizeSuspenseSlot((children as Slots).fallback); } else { content = normalizeSuspenseSlot(children as VNodeChild); fallback = normalizeVNode(null); } return { content, fallback, }; } // \u0026gt;\u0026gt;\u0026gt; normalizeSuspenseSlot function normalizeSuspenseSlot(s: any) { if (isFunction(s)) { s = s() } if (isArray(s)) { // ROOT å¿…é¡»æ˜¯å•èŠ‚ç‚¹ \u0026lt;div\u0026gt;...\u0026lt;/div\u0026gt;  const singleChild = filterSingleRoot(s) if (__DEV__ \u0026amp;\u0026amp; !singleChild) { warn(`\u0026lt;Suspense\u0026gt; slots expect a single root node.`) } s = singleChild } return normalizeVNode(s) } // normalizeVNode export function normalizeVNode(child: VNodeChild): VNode { if (child == null || typeof child === \u0026#39;boolean\u0026#39;) { // empty placeholder  return createVNode(Comment) } else if (isArray(child)) { // fragment  return createVNode(Fragment, null, child) } else if (typeof child === \u0026#39;object\u0026#39;) { // already vnode, this should be the most common since compiled templates  // always produce all-vnode children arrays  // è¿™æ˜¯æœ€å¸¸ç”¨çš„æƒ…å†µï¼Œå› ä¸ºä½¿ç”¨æ¨¡æ¿çš„æ—¶å€™æœ€åç”Ÿæˆçš„ children æ˜¯æ•°ç»„  return child.el === null ? child : cloneVNode(child) } else { // strings and numbers  return createVNode(Text, null, String(child)) } }     æ£€æµ‹æ˜¯ä¸æ˜¯ single root å‡½æ•°ï¼š filterSingleRoot\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  export function filterSingleRoot( children: VNodeArrayChildren ): VNode | undefined { let singleRoot; for (let i = 0; i \u0026lt; children.length; i++) { const child = children[i]; if (isVNode(child)) { // ignore user comment  if (child.type !== Comment || child.children === \u0026#34;v-if\u0026#34;) { if (singleRoot) { // has more than 1 non-comment child, return now  return; } else { singleRoot = child; } } } else { return; } } return singleRoot; }      TODO 23fc943 currentBlock ä¼˜åŒ–   feat(add): rc-\u0026gt;createVNode, optimize diff, currentBlock Â· gcclll/stb-vue-next@23fc943 Â· GitHub\n è¿™é‡Œçš„å¤„ç†æ²¡æ€ä¹ˆææ˜ç™½â“\n  æ³¨æ„è¿™é‡Œå¢åŠ çš„å‡ ä¸ªå˜é‡â€¼\n blockStack, currentBlock:\n1 2 3 4 5 6 7 8 9  // Since v-if and v-for are the two possible ways node structure can dynamically // change, once we consider v-if branches and each v-for fragment a block, we // can divide a template into nested blocks, and within each block the node // structure would be stable. This allows us to skip most children diffing // and only worry about the dynamic nodes (indicated by patch flags). // é’ˆå¯¹ v-if, v-for åŠ¨æ€æ€§åšçš„ç”±äºï¼Œå‡å°‘å¯¹é™æ€èŠ‚ç‚¹çš„ diff ï¼Œåªéœ€è¦å…³å¿ƒåŠ¨æ€èŠ‚ç‚¹å³å¯ export const blockStack: (VNode[] | null)[] = [] let currentBlock: VNode[] | null = null     shouldTrack:\n1 2 3 4 5 6  // Whether we should be tracking dynamic child nodes inside a block. // Only tracks when this value is \u0026gt; 0 // We are not using a simple boolean because this value may need to be // incremented/decremented by nested usage of v-once (see below) // æ˜¯å¦åº”è¯¥ tracking block å†…åŠ¨æ€çš„å­©å­èŠ‚ç‚¹ let shouldTrack = 1;     æ–°å¢å¤„ç†é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // 8. currentBlock  if ( shouldTrack \u0026gt; 0 \u0026amp;\u0026amp; // é¿å… block èŠ‚ç‚¹ tracking è‡ªå·±  !isBlockNode \u0026amp;\u0026amp; // has current parent block  currentBlock \u0026amp;\u0026amp; // presence of a patch flag indicates this node needs patching on updates.  // component nodes also should always be patched, because even if the  // component doesn\u0026#39;t need to update, it needs to persist the instance on to  // the next vnode so that it can be properly unmounted later.  (patchFlag \u0026gt; 0 || shapeFlag \u0026amp; ShapeFlags.COMPONENT) \u0026amp;\u0026amp; // the EVENTS flag is only for hydration and if it is the only flag, the  // vnode should not be considered dynamic due to handler caching.  patchFlag !== PatchFlags.HYDRATE_EVENTS ) { currentBlock.push(vnode); }     è·Ÿè¿™å‡ ä¸ªå˜é‡æœ‰å…³çš„å‡½æ•°ï¼š\n  TODO block related(open/close/create)   feat(add): rc-\u0026gt;block related, open/create/closeBlock Â· gcclll/stb-vue-next@a2afc70 Â· GitHub\n è¿™é‡Œçš„æ‰€æœ‰å‡½æ•°éƒ½å’Œ createVNode é‡Œé¢çš„ currentBlock æœ‰å…³ã€‚\n openBlock:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  /** ,* Open a block. ,* This must be called before `createBlock`. It cannot be part of `createBlock` ,* because the children of the block are evaluated before `createBlock` itself ,* is called. The generated code typically looks like this: ,* ,* ```js ,* function render() { ,* return (openBlock(),createBlock(\u0026#39;div\u0026#39;, null, [...])) ,* } ,* ``` ,* disableTracking is true when creating a v-for fragment block, since a v-for ,* fragment always diffs its children. ,* ,* @private ,*/ export function openBlock(disableTracking = false) { blockStack.push((currentBlock = disableTracking ? null : [])); }     closeBlock:\n1 2 3 4  export function closeBlock() { blockStack.pop(); currentBlock = blockStack[blockStack.length - 1] || null; }     setBlockTracking:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  /** * Block tracking sometimes needs to be disabled, for example during the * creation of a tree that needs to be cached by v-once. The compiler generates * code like this: * * ``` js * _cache[1] || ( * setBlockTracking(-1), * _cache[1] = createVNode(...), * setBlockTracking(1), * _cache[1] * ) * ``` * * @private */ export function setBlockTracking(value: number) { shouldTrack += value }     createBlock:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  /** * Create a block root vnode. Takes the same exact arguments as `createVNode`. * A block root keeps track of dynamic nodes within the block in the * `dynamicChildren` array. * * @private */ export function createBlock( type: VNodeTypes | ClassComponent, props?: Record\u0026lt;string, any\u0026gt; | null, children?: any, patchFlag?: number, dynamicProps?: string[] ): VNode { const vnode = createVNode( type, props, children, patchFlag, dynamicProps, true /* isBlock: prevent a block from tracking itself */ ); // save current block children on the block vnode  vnode.dynamicChildren = currentBlock || (EMPTY_ARR as any); // close block  closeBlock(); // a block is always going to be patched, so track it as a child of its  // parent block  if (shouldTrack \u0026gt; 0 \u0026amp;\u0026amp; currentBlock) { currentBlock.push(vnode); } return vnode; }     ç›¸å…³è„‘å›¾ï¼š   normalizeChildren function   shapeFlag åˆå§‹å€¼æ£€æµ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  // encode the vnode type information into a bitmap const shapeFlag = isString(type) ? ShapeFlags.ELEMENT // 1  : __FEATURE_SUSPENSE__ \u0026amp;\u0026amp; isSuspense(type) ? ShapeFlags.SUSPENSE // 1 \u0026lt;\u0026lt; 7, 128  : isTeleport(type) ? ShapeFlags.TELEPORT // 1 \u0026lt;\u0026lt; 6, 64  : isObject(type) ? ShapeFlags.STATEFUL_COMPONENT // 1 \u0026lt;\u0026lt; 2, 4  : isFunction(type) ? ShapeFlags.FUNCTIONAL_COMPONENT // 1 \u0026lt;\u0026lt; 1, 2  : 0;     æµ‹è¯•:\n1 2 3 4 5 6 7  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c }, f, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const _h = (...args) =\u0026gt; f(c(...args)) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; only tag\\n\u0026#39;, _h(\u0026#39;p\u0026#39;)]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; tag + props\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { foo: \u0026#39;foo\u0026#39; })]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; tag + props + children\\n\u0026#39;, _h(\u0026#39;p\u0026#39;, { foo: \u0026#39;foo\u0026#39; }, [\u0026#39;foo\u0026#39;])])    \u0026gt;\u0026gt;\u0026gt; only tag { __v_isVNode: true, __v_skip: true, type: \u0026#39;p\u0026#39;, shapeFlag: 1 } \u0026gt;\u0026gt;\u0026gt; tag + props { __v_isVNode: true, __v_skip: true, type: \u0026#39;p\u0026#39;, props: { foo: \u0026#39;foo\u0026#39; }, shapeFlag: 1 } \u0026gt;\u0026gt;\u0026gt; tag + props + children { __v_isVNode: true, __v_skip: true, type: \u0026#39;p\u0026#39;, props: { foo: \u0026#39;foo\u0026#39; }, children: [ \u0026#39;foo\u0026#39; ], shapeFlag: 17 } undefined  children is function   feat(add): rc-\u0026gt;propsOrChildren is function Â· gcclll/stb-vue-next@28d4a55 Â· GitHub\n å¦‚æœæ˜¯å‡½æ•°ï¼Œå½“åš slot çš„ children å¤„ç†ã€‚\n normalizeChildren:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  export function normalizeChildren(vnode: VNode, children: unknown) { let type = 0 if (children == null) { children = null } else if (false /*array*/) { // TODO  } else if (false /*object*/) { // TODO  } else if (isFunction(children)) { // å¦‚æœæ˜¯å‡½æ•°å½“åš slot children ?  children = { default: children, _ctx: currentRenderingInstance } type = ShapeFlags.SLOTS_CHILDREN } else { // TODO æ™®é€šç±»å‹  } vnode.children = children as VNodeNormalizedChildren vnode.shapeFlag |= type }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode:c }, log, f } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const _h = (...args) =\u0026gt; f(h(...args)); const _c = (...args) =\u0026gt; f(c(...args)); const Component = { template: \u0026#39;\u0026lt;br /\u0026gt;\u0026#39; } const slot = () =\u0026gt; {} log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; default slot\\n\u0026#39;, _h(Component, slot)]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; children is function\\n\u0026#39;, _c(\u0026#39;div\u0026#39;, {}, slot)])    \u0026gt;\u0026gt;\u0026gt; default slot { __v_isVNode: true, __v_skip: true, type: { template: \u0026#39;\u0026lt;br /\u0026gt;\u0026#39; }, children: { default: [Function: slot], _ctx: null }, shapeFlag: 36 } \u0026gt;\u0026gt;\u0026gt; children is function { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, props: {}, children: { default: [Function: slot], _ctx: null }, shapeFlag: 33 } undefined    children is array or æ™®é€šç±»å‹   feat(add): rc-\u0026gt;createVNode, children is array or primitive Â· gcclll/stb-vue-next@850c0bc Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  // æ•°ç»„ç±»å‹ if (isArray(children)) { type = ShapeFlags.ARRAY_CHILDREN; } // éå¯¹è±¡ï¼Œæ•°ç»„ï¼Œå‡½æ•°çš„æ™®é€šç±»å‹å¤„ç† { children = String(children); // force teleport children to array so it can be moved around  if (shapeFlag \u0026amp; ShapeFlags.TELEPORT) { type = ShapeFlags.ARRAY_CHILDREN; children = [createTextVNode(children as string)]; } else { type = ShapeFlags.TEXT_CHILDREN; } } // createTextVNode export function createTextVNode(text: string = \u0026#34; \u0026#34;, flag: number = 0): VNode { return createVNode(Text, null, text, flag); } export const Text = Symbol(__DEV__ ? \u0026#39;Text\u0026#39; : undefined)     æ™®é€šç±»å‹å¤„ç†ä¸­å¦‚æœæ˜¯ ShapeFlags.TELETPORT å½“åš ARRAY_CHILDREN å¤„ç†ï¼Œä¸” children æŒ‰ç…§æ–‡æœ¬èŠ‚ç‚¹å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10  const { rc: { h, createVNode: c }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(h(...args)); const _c = (...args) =\u0026gt; f(c(...args)); log([`\u0026gt;\u0026gt;\u0026gt; array will be children(${1 | (1 \u0026lt;\u0026lt; 4)})\\n`, _h(\u0026#34;div\u0026#34;, [\u0026#34;foo\u0026#34;])]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; string will be children()\\n\u0026#34;, _h(\u0026#34;div\u0026#34;, \u0026#34;foo\u0026#34;)]);    \u0026gt;\u0026gt;\u0026gt; array will be children(17) { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, children: [ \u0026#39;foo\u0026#39; ], shapeFlag: 17 } \u0026gt;\u0026gt;\u0026gt; string will be children() { __v_isVNode: true, __v_skip: true, type: \u0026#39;div\u0026#39;, children: \u0026#39;foo\u0026#39;, shapeFlag: 9 } undefined    children is object   feat(add): rc-\u0026gt;createVNode, normalizeChildren is object Â· gcclll/stb-vue-next@959879e Â· GitHub\n shapeFlag å¯èƒ½æ˜¯ ShapeFlags.ELEMENT æˆ–è€… ShapeFalgs.TELEPORT ã€‚\n è¿™é‡Œå…ˆæµ‹è¯• ELEMENT æƒ…å†µï¼Œå› ä¸º TELEPORT è¿˜éœ€è¦å®ç° components/Teleport ã€‚\n å¦‚æœ type æ˜¯ å¯¹è±¡ï¼Œ shapeFlag åˆå§‹ç±»å‹ä¼šæ˜¯ ShapeFlags.STATEFULL_COMPONENT, 1 \u0026lt;\u0026lt; 2\n1 2 3 4 5 6 7 8 9 10 11 12  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { h, createVNode: c }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const _h = (...args) =\u0026gt; f(c(...args)); // å› ä¸º type = {} , shapeFlag = 1 \u0026lt;\u0026lt; 2, 4 // æ‰€ä»¥åœ¨ normalizeChildren é‡Œé¢ isObject åˆ†æ”¯ä¼šè¿›å…¥ else // è¿›è¡Œå¤„ç†ï¼Œç»è¿‡å¤„ç†ä¹‹åæˆä¸º 4 | SLOTS_CHILDREN,2\u0026lt;\u0026lt;5,32 = 36 log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; object\\n\u0026#34;, _h({}, null, { foo: \u0026#34;foo\u0026#34; })]);    \u0026gt;\u0026gt;\u0026gt; object { __v_isVNode: true, __v_skip: true, type: {}, children: { foo: \u0026#39;foo\u0026#39;, _ctx: null }, shapeFlag: 36 } undefined        â± api watch(source, cb, options)   feat(add): api watch TODOs Â· gcclll/stb-vue-next@4f0301e Â· GitHub\n è„‘å›¾ï¼š  ä¸ºäº†æ›´å¥½çš„å®Œæˆ apiWatchï¼Œ éœ€è¦å…ˆå®Œæˆäº† scheduler ä»»åŠ¡è°ƒåº¦éƒ¨åˆ†ã€‚\n  watch(source, cb, options) å‡½æ•°ä»¥ä¸‹ç§ä½¿ç”¨æ–¹å¼(ä¸‹é¢çš„ cb å‡å¯é€‰å‚æ•°)ï¼š\n  watch(fn) ç­‰ä»·äº watchEffect(fn), æ—  cb\n  watch(fn, cb) ç›‘å¬å‡½æ•°\n  watch(ref(0), cb)\n  watch(reactive({ count: 0}), cb) , reactive å¯¹è±¡é»˜è®¤ deep = true\n  watch([ref(0), reactive({count: 0})], cb)\n  watch(fn, cb, { immediate: true }) æ­¤æ—¶ï¼Œ cb å¿…é¡»ä¸ºå‡½æ•°ï¼Œ job-\u0026gt;fn è¢«ç«‹å³æ‰§ è¡Œä¸€æ¬¡ï¼Œ cb æ¥å—æ–°æ—§å€¼\n  watch(ref({ count: 0}), cb, { deep: true }) æ‰‹åŠ¨æŒ‡å®š deep: true æ·±åº¦ç›‘å¬\n  â€¦\n  æ‰§è¡Œå…·ä½“å®ç°çš„å‡½æ•°ï¼š doWatch()\n   Arg value description     source WatchSource, WatchSource[], WatchEffect, object object watched   cb WatchCallback or null callback     options WatchOptions = EMPTY_OBJ     immediate     deep     flush     onTrack     onTrigger      instance currentInstance -     watch(source, cb, options?) å‡½æ•°ä¸­çš„ cb æ˜¯å¿…é€‰é¡¹ï¼Œå¦‚æœæƒ³ç›´æ¥ watch effectï¼Œå¯ä½¿ ç”¨ watchEffect(fn, options?) api ã€‚\n  watch å‡½æ•°åŸºæœ¬æµç¨‹ï¼š\n  cb, immediate, deep æ£€æµ‹\n  getterï¼Œ æ ¹æ® source ä¸åŒç±»å‹è®¾ç½® getter\n  cb + deep: true\n  SSR node env\n  å°† cb å°è£…æˆ job\n  runner = effect(getter, option)\n  runner å¦‚ä½•æ‰§è¡Œï¼Ÿ\n  stop, removeï¼Œå‡½æ•°è¿”å›ä¸€ä¸ª stop+remove è¯¥ runner æ“ä½œçš„å‡½æ•°\n   ä¸‹é¢ç« èŠ‚ä¸­æµ‹è¯•çš„ç”¨ä¾‹åˆ†æè„‘å›¾ï¼š source is ref   feat(add): apiWatch-\u0026gt;no cb, getter is ref Â· gcclll/stb-vue-next@b9b7ac6 Â· GitHub\n fix: watch-\u0026gt;source is ref, cb -\u0026gt; job Â· gcclll/stb-vue-next@6752326 Â· GitHub æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { ref, nextTick, watch }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const count = ref(0); let dummy, i = 0; watch(count, (count, prevCount) =\u0026gt; { log(\u0026#34;\\nvalue changed: \u0026#34; + i++); dummy = [count, prevCount]; count + 1; if (prevCount) { prevCount + 1; } }); count.value++; await nextTick(); log(dummy); }; run();    undefined value changed: 0 1 0   æœ‰å…³ä»£ç (doWatch):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52  // -\u0026gt; getter let getter: () =\u0026gt; any; let forceTrigger = false; // 2.1 source is ref if (isRef(source)) { getter = () =\u0026gt; (source as Ref).value; forceTrigger = !!(source as Ref)._shallow; } // cb -\u0026gt; job å°è£… let oldValue = isArray(source) ? [] : INITIAL_WATCHER_VALUE; const job: SchedulerJob = () =\u0026gt; { if (cb) { // watch(source, cb)  const newValue = runner(); if (deep || forceTrigger || hasChanged(newValue, oldValue)) { // cleanup  if (cleanup) cleanup(); callWithAsyncErrorHandling(cb, instance, ErrorCodes.WATCH_CALLBACK, [ newValue, // pass undefined as the old value when it\u0026#39;s changed for the first time  // ç¬¬ä¸€æ¬¡çš„æ—¶å€™ oldValue ä¸º undefined  oldValue === INITIAL_WATCHER_VALUE ? undefined : oldValue, onInvalidate, ]); oldValue = newValue; } } else { // TODO  } }; // scheduler å°è£… scheduler = () =\u0026gt; { if (!instance || instance.isMounted) { queuePreFlushCb(job); } else { } }; // ä»€ä¹ˆæ–¹å¼æ‰§è¡Œ runner? // 8. TODO runner å¦‚ä½•æ‰§è¡Œï¼Ÿ if (cb) { if (immediate) { // TODO  } else { oldValue = runner(); } } else if (false /*flush-\u0026gt;post*/) { } else { runner(); }      source is reactive   å¦‚æœè¦ watch çš„å¯¹è±¡æ˜¯ä¸ª reactive ï¼Œéœ€è¦è¿›è¡Œé€’å½’ watch ï¼Œå¾—åˆ° getter.\n fix: watch-\u0026gt;source is reactive Â· gcclll/stb-vue-next@697f7f2 Â· GitHub\n æ–°å¢ç›¸å…³ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  // 1. å¦‚æœæ˜¯ reactiveï¼Œéœ€è¦æ·±åº¦ç›‘å¬ if (isReactive(source)) { getter = () =\u0026gt; source; deep = true; } // 2. deep: true if (cb \u0026amp;\u0026amp; deep) { const baseGetter = getter; // a. deep: true  // b. source is reactive  getter = () =\u0026gt; traverse(baseGetter()); } // traverse å‡½æ•° function traverse(value: unknown, seen: Set\u0026lt;unknown\u0026gt; = new Set()) { if (!isObject(value) || seen.has(value)) { return value; } seen.add(value); if (isRef(value)) { traverse(value.value, seen); } else if (isArray(value)) { for (let i = 0; i \u0026lt; value.length; i++) { traverse(value[i], seen); } } else if (isSet(value) || isMap(value)) { value.forEach((v: any) =\u0026gt; { traverse(v, seen); }); } else { for (const key in value) { traverse(value[key], seen); } } return value; }     é€’å½’ç›‘å¬ reactive å¯¹è±¡ä»»æ„å±‚çº§ä¸Šçš„å±æ€§å˜åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { nextTick, watchEffect, reactive, watch }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const state = reactive({ count: 0, r1: { count: 10 } }); let dummy; watch(state, (newVal, preVal) =\u0026gt; { dummy = [newVal, preVal]; }); state.count++; await nextTick(); log.br(dummy); state.r1.count-- await nextTick() log.br(dummy) }; run();    undefined { count: 1, r1: { count: 10 } } { count: 1, r1: { count: 10 } } { count: 1, r1: { count: 9 } } { count: 1, r1: { count: 9 } }   æ³¨æ„: newVal å’Œ preVal è¿”å›çš„æ˜¯æ•´ä¸ª state è€Œéå½“å‰æ‰€å‘ç”Ÿå˜æ›´çš„å±æ€§ (count/r1.count)ï¼Œå› ä¸ºåœ¨ job é‡Œé¢æ‰§è¡Œ runner() å¾—åˆ°æ–°å€¼æ˜¯åœ¨ traverse(baseGetter()) ä¹‹å‰å‘ç”Ÿçš„ï¼Œæ­¤æ—¶å–åˆ°çš„å€¼æ˜¯ state è‡ªèº«ã€‚\n    soure is array   feat(add): apiWatch-\u0026gt;source is array Â· gcclll/stb-vue-next@af1e590 Â· GitHub\n å¦‚æœè¦ç›‘å¬çš„å¯¹è±¡æ˜¯ä¸ªæ•°ç»„çš„æ—¶å€™ï¼Œéœ€è¦æ£€æµ‹æ•°ç»„å…ƒç´ çš„ç±»å‹ï¼Œé’ˆå¯¹ä¸åŒç±»å‹è¿›è¡Œå¤„ç†ã€‚\n è¦ç‚¹ï¼š\n  æ•°ç»„å…ƒç´ ä¸èƒ½æ˜¯é™¤ ref/reactive/function ä¹‹å¤–çš„ç±»å‹\n  å¯¹æ•°ç»„å…ƒç´ è®¾å€¼æ—¶å¿…é¡»é€šè¿‡å…ƒç´ åŸå§‹è®¾å€¼æ–¹å¼è¿›è¡Œ(æ¯”å¦‚ï¼š ref è¦ ref.value = xxx)ï¼Œ å› ä¸ºè¯¥æ•°ç»„æœ¬èº«ä¸æ˜¯ reactive çš„\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14  if (isArray(source)) { getter = () =\u0026gt; source.map((s) =\u0026gt; { if (isRef(s)) { return s.value; } else if (isReactive(s)) { return traverse(s); } else if (isFunction(s)) { return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER); } else { // TODO warn invalid source  } }); }      isRef -\u0026gt; ç›‘å¬ item.value\n  isReactive -\u0026gt; traverse(item) é€’å½’\n  isFunction -\u0026gt; callWithErrorHandling(item, instance, â€¦) ç›‘å¬å‡½æ•°è¿”å›å€¼\n  å…¶ä»–ç±»å‹ä¸æ”¯æŒ -\u0026gt; warn invalid source\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { ref, watch, nextTick, reactive }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const array = reactive([]); let dummy; watch(array, (newArr, preArr) =\u0026gt; { dummy = [newArr, \u0026#34;\\n\u0026#34;]; }); array.push(1); await nextTick(); log.br(dummy); }; run();    undefined [ 1 ]   æ•°ç»„æ··åˆæ¨¡å¼(å…ƒç´ åªæ”¯æŒ ref, reactive, function)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  const { rc: { ref, watch, nextTick, reactive, effect }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); let dummy, val = reactive([10, 1]); effect(() =\u0026gt; { dummy = val[0]; }); val[0]++; log(`dummy = ${dummy}\\n`); console.warn(\u0026#34;---\u0026#34;); const run = async () =\u0026gt; { const state = reactive({ count: 1 }); const status = ref(false); let dummy; watch([() =\u0026gt; state.count, status], (vals, oldVals) =\u0026gt; { dummy = [vals, oldVals]; }); state.count++; status.value = true; await nextTick(); log.br(dummy); }; run();    dummy = 11 undefined [ [ 2, true ], [ 1, false ] ]   Tip. watch æ•°ç»„çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡æ•°ç»„å…ƒç´ åŸæ¥çš„å¯¹è±¡å»æ“ä½œå€¼çš„å˜æ›´ï¼Œå¦‚æœé€šè¿‡æ•°ç»„ä¸‹ æ ‡è®¾å€¼æ˜¯ä¸ä¼šæˆåŠŸçš„ï¼Œå› ä¸ºè¿™ä¸ªæ•°ç»„æœ¬èº«ä¸æ˜¯ reactive çš„ã€‚\n æ¯”å¦‚ï¼š array[0]++ å¹¶ä¸ä¼šæ”¹å˜ state.count\n åªæœ‰é€šè¿‡ state.count++ è‡ªèº«èµ‹å€¼æ“ä½œæ‰ä¼šè§¦å‘æ›´æ–°ã€‚\n   source is function   feat(add): rc-\u0026gt;api watch-\u0026gt;source is function Â· gcclll/stb-vue-next@694a389 Â· GitHub\n å½“è¦ watch çš„å¯¹è±¡æ˜¯ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å¦æœ‰ cb æœ€åçš„ getter éƒ½æ˜¯é€šè¿‡\n callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER)\n æˆ–æ—  cb æ—¶ç­‰ä»·äºæ™®é€šçš„ effect å‡½æ•°\n callWithErrorHandling(source, instance,ErrorCodes.WATCH_CALLBACK,[onInvalidate])\n ç›´æ¥æ‰§è¡Œè¿™ä¸ªå‡½æ•°å»æ”¶é›†ä¾èµ–ã€‚\n  æ–°å¢ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  if (isFunction(source)) { // å¦‚æœæ˜¯å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œå–å¾—å‡½æ•°æ‰§è¡Œç»“æœ  if (cb) { // getter with cb  getter = () =\u0026gt; callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER); } else { // no cb -\u0026gt; simple effect  getter = () =\u0026gt; { if (instance \u0026amp;\u0026amp; instance.isUnmounted) { // ç»„ä»¶å·²ç»å¸è½½äº†  return; } if (cleanup) cleanup(); return callWithErrorHandling( source, instance, ErrorCodes.WATCH_CALLBACK, [onInvalidate] ); }; } }     feat(add): rc-\u0026gt;api watch-\u0026gt;source is function without cb Â· gcclll/stb-vue-next@9565b4a Â· GitHub\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { nextTick, watchEffect, watch, ref }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { let dummy, val = ref(0); watch(() =\u0026gt; (dummy = val.value)); val.value++; await nextTick(); log.br({ dummy }); log(\u0026#34;with cb\\n\u0026#34;); // function with cb  watch( () =\u0026gt; val.value, (val, oldVal) =\u0026gt; { dummy = [val, oldVal]; } ); val.value = 100; await nextTick(); log([dummy, \u0026#34;\\n\u0026#34;]); }; run();    undefined { dummy: 1 } with cb [ 100, 1 ]   feat(add): rc-\u0026gt;api watch-\u0026gt;source invalid warning Â· gcclll/stb-vue-next@11ee8ef Â· GitHub\n   è¿™é‡Œæœ‰ä¸ªå®¹æ˜“ææ··æ·†çš„åœ°æ–¹ï¼Œ watch(fn, cb) çš„æ—¶å€™ï¼Œè™½ç„¶ fn å’Œ cb éƒ½æ˜¯å‡½æ•°ï¼Œä½† æ˜¯è¦åŒºåˆ†å¼€è¿™ä¸¤è€…ï¼Œå¹¶ææ¸…æ¥šä»–ä»¬æ˜¯å•¥å’Œå…³ç³»æ˜¯å•¥ã€‚\n  fn æ˜¯è¢«æ£€æµ‹çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯ function é‚£åœ¨è¢«ç›‘å¬ä¹‹å‰éœ€è¦å…ˆæ‰§è¡Œå®ƒï¼Œç­‰äºæ˜¯ç›‘å¬ å‡½æ•°é‡Œé¢çš„å†…å®¹ï¼Œæ¯”å¦‚ï¼šå‡½æ•°å†…æœ‰è®¿é—®æŸä¸ª reactive å˜é‡\n  è€Œ cb æ˜¯å±äºå›è°ƒæ€§è´¨ï¼Œä¸”æ˜¯å½“æ•°æ®æœ‰æ›´æ–°çš„æ—¶å€™çš„å›è°ƒå‡½æ•°ï¼Œå®ƒåªä¼šåœ¨ä¸€ä¸ªåœ°æ–¹è¢« æ‰§è¡Œï¼Œå³å°è£… job çš„æ—¶å€™ï¼Œéœ€è¦å°†æ•°æ®æ›´æ–°å‰åçš„å˜åŒ–å€¼é€šè¿‡å®ƒä¼ é€’å‡ºæ¥(å¦‚ä¸‹é¢ğŸ‘‡çš„ ä»£ç )\n     1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const job: SchedulerJob = () =\u0026gt; { if (cb) { // watch(source, cb)  const newValue = runner(); if (deep || forceTrigger || hasChanged(newValue, oldValue)) { // cleanup  if (cleanup) cleanup(); callWithAsyncErrorHandling(cb, instance, ErrorCodes.WATCH_CALLBACK, [ newValue, // pass undefined as the old value when it\u0026#39;s changed for the first time  // ç¬¬ä¸€æ¬¡çš„æ—¶å€™ oldValue ä¸º undefined  oldValue === INITIAL_WATCHER_VALUE ? undefined : oldValue, onInvalidate, ]); oldValue = newValue; } } else { // watchEffect, no cb  runner(); } };      option deep   å¯¹äºæ·±åº¦ç›‘å¬ä¸»è¦æ˜¯å› ä¸º traverse() å‡½æ•°å¯¹ reactive å¯¹è±¡è¿›è¡Œäº†é€’å½’éå†ï¼Œå¯¹æ¯ä¸ªå± æ€§è¿›è¡Œäº†è®¿é—®ï¼Œä»è€Œè®©å®ƒæ”¶é›†åˆ°å½“å‰çš„ effect ä½œä¸ºä¾èµ–ï¼Œè¿™æ ·å°†æ¥è¿™äº›è¢«éå†åˆ°çš„å€¼å‘ç”Ÿ æ”¹å˜æ—¶å°±ä¼šè§¦å‘è¿™ä¸ªæ”¶é›†åˆ°çš„ effect æ‰§è¡Œï¼Œè¾¾åˆ°æ·±åº¦ç›‘å¬æ•ˆæœã€‚\n1 2 3 4 5 6 7 8  // 3. cb + deep: true  if (cb \u0026amp;\u0026amp; deep) { const baseGetter = getter; // a. deep: true  // b. source is reactive  getter = () =\u0026gt; traverse(baseGetter()); }     traverse() ä½œç”¨å°±æ˜¯é€’å½’éå†æ‰€æœ‰å±æ€§é€šè¿‡ return value æ¥æ‰§è¡Œ get æ“ä½œæ”¶é›†ä¾èµ–ã€‚\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { ref, reactive, watch, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const count = ref(0); const state = reactive({ nested: { count }, array: [1, 2, 3], map: new Map([ [\u0026#34;a\u0026#34;, 1], [\u0026#34;b\u0026#34;, 2], ]), set: new Set([1, 2, 3]), }); let dummy; watch( () =\u0026gt; state, (state) =\u0026gt; { dummy = [ state.nested.count, state.array[0], state.map.get(\u0026#34;a\u0026#34;), state.set.has(1), ]; }, { deep: true } ); state.nested.count++; await nextTick(); log([\u0026#34;\\n\u0026#34;, dummy]); state.array[0] = 2; await nextTick(); log([\u0026#34;\\n\u0026#34;, dummy]); state.map.set(\u0026#34;a\u0026#34;, 100); await nextTick(); log([\u0026#34;\\n\u0026#34;, dummy]); state.set.delete(1); await nextTick(); log([\u0026#34;\\n\u0026#34;, dummy]); }; run();    undefined [ 1, 1, 1, true ] [ 1, 2, 1, true ] [ 1, 2, 100, true ] [ 1, 2, 100, false ]  TODO deep ref     option immediate   feat(add): rc-\u0026gt;api watch-\u0026gt;immediate option Â· gcclll/stb-vue-next@204ce68 Â· GitHub\n immediate é€‰é¡¹ï¼Œä¼šè®© cb/job ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸æ˜¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¼‚æ­¥æ‰§è¡Œã€‚\n æ–°å¢ä»£ç åªéœ€è¦åŠ ä¸€è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10  if (cb) { if (immediate) { job(); // è¿™é‡Œç›´æ¥è°ƒç”¨ Job  } else { oldValue = runner(); } } else if (false /*flush-\u0026gt;post*/) { } else { runner(); }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { nextTick, watch, ref }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const _log = (desc, newline) =\u0026gt; log([newline ? \u0026#34;\\n\u0026#34; : \u0026#34;\u0026#34;, `${desc}\u0026gt; dummy = ${dummy}`]); const cb = (val) =\u0026gt; (dummy = val); const option = { immediate: true }; const count = ref(0); let dummy; watch(count, cb, option); _log(\u0026#34;æ”¹å˜å€¼ä¹‹å‰\u0026#34;); count.value++; await nextTick(); _log(\u0026#34;æ”¹å˜å€¼ä¹‹å\u0026#34;, true); const nul = ref(null); watch(() =\u0026gt; nul.value, cb, option); _log(\u0026#34;å½“åˆå§‹å€¼ä¸º null\u0026#34;); const undef = ref(); watch(() =\u0026gt; undef.value, cb, option); _log(\u0026#34;å½“åˆå§‹å€¼ä¸º undefined\u0026#34;); undef.value = 3; await nextTick(); _log(\u0026#34;å½“åˆå§‹å€¼ä¸º undefined, set 3\u0026#34;); undef.value = undefined; await nextTick(); _log(\u0026#34;å½“åˆå§‹å€¼ä¸º undefined, set undefined\u0026#34;); // undefined === undefined -\u0026gt; hasChanged() -\u0026gt; false  undef.value = undefined; await nextTick(); _log(\u0026#34;å½“åˆå§‹å€¼ä¸º undefined, set undefined\u0026#34;); }; run();    æ”¹å˜å€¼ä¹‹å‰ \u0026gt; dummy = 0 undefined æ”¹å˜å€¼ä¹‹å \u0026gt; dummy = 1 å½“åˆå§‹å€¼ä¸º null \u0026gt; dummy = null å½“åˆå§‹å€¼ä¸º undefined \u0026gt; dummy = undefined å½“åˆå§‹å€¼ä¸º undefined, set 3 \u0026gt; dummy = 3 å½“åˆå§‹å€¼ä¸º undefined, set undefined \u0026gt; dummy = undefined å½“åˆå§‹å€¼ä¸º undefined, set undefined \u0026gt; dummy = undefined   å¦‚ä¸Šç»“æœï¼Œ cb ä¼šç«‹å³æ‰§è¡Œã€‚\n åœ¨ä½¿ç”¨ deep å’Œ immediate é€‰é¡¹çš„æ—¶å€™å¦‚æœæ²¡æœ‰ cb ä¼šç»™å‡ºè­¦å‘Šï¼Œç›´æ¥çœ‹æºç å§:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // 1. cb, immediate, deep æ£€æµ‹ if (__DEV__ \u0026amp;\u0026amp; !cb) { if (immediate !== undefined) { warn( `watch() \u0026#34;immediate\u0026#34; option is only respected when using the ` + `watch(source, callback, options?) signature.` ); } if (deep !== undefined) { warn( `watch() \u0026#34;deep\u0026#34; option is only respected when using the ` + `watch(source, callback, options?) signature.` ); } }     ä¹Ÿå°±æ˜¯è¯´ï¼Œ deep å’Œ immediate å»ºè®®åœ¨ watch(s, cb, options) å½¢å¼ä¸‹ä½¿ç”¨ï¼Œå³åœ¨ æœ‰ cb å‚æ•°çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚\n é‚£ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\n   option onTrack + onTrigger   è¿™éƒ¨åˆ†å®ç°é€»è¾‘ä¸»è¦åœ¨ reactivity æ¨¡å—ã€‚\n onTrack åœ¨ reactivity ä¸­ä½¿ç”¨çš„ï¼Œç”¨æ¥åœ¨è§¦å‘ get å–å€¼æ“ä½œæ—¶è°ƒç”¨ track() å‡½æ•°æ”¶é›†ä¾ èµ–æ—¶çš„ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶å›è°ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // track() å‡½æˆæœ€å add æ“ä½œä¹‹å if (!dep.has(activeEffect)) { dep.add(activeEffect); // è‡ªèº«ä¿å­˜ä¸€ä»½è¢«ä¾èµ–è€…åå•  activeEffect.deps.push(dep); if (__DEV__ \u0026amp;\u0026amp; activeEffect.options.onTrack) { activeEffect.options.onTrack({ effect: activeEffect, target, type, key, }); } } // trigger() å‡½æ•°ä¸­å®ç° if (effect.options.onTrigger) { effect.options.onTrigger({ effect, target, key, type, newValue, oldValue, oldTarget, }); }     è¿™é‡Œä¼šå°† å½“å‰ target çš„ key å±æ€§æ‰€æ”¶é›†çš„ä¾èµ– activeEffect æš´éœ²å‡ºæ¥ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { nextTick, watchEffect, reactive }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const trackEvents = []; const triggerEvents = []; let dummy; const onTrack = (e /* activeEffect */) =\u0026gt; trackEvents.push(e); const onTrigger = (e /* effect */) =\u0026gt; triggerEvents.push(e); const obj = reactive({ foo: 1, bar: 2 }); watchEffect( () =\u0026gt; { dummy = [obj.foo, \u0026#34;bar\u0026#34; in obj, Object.keys(obj)]; }, { onTrack, onTrigger } ); await nextTick(); log([\u0026#34;\\n\u0026#34;, dummy]); // æœ‰å¤šå°‘ä¸ªå°±ç­‰äºå‘—è°ƒç”¨äº†å¤šå°‘æ¬¡  log(\u0026#34;track events count = \u0026#34; + trackEvents.length); trackEvents.forEach((e) =\u0026gt; log.props(e, [\u0026#34;target\u0026#34;, \u0026#34;type\u0026#34;, \u0026#34;key\u0026#34;, \u0026#34;deps\u0026#34;])); obj.foo = 3; obj.bar = 4; log(\u0026#34;trigger events count = \u0026#34; + triggerEvents.length); triggerEvents.forEach((e) =\u0026gt; log.props(e, [\u0026#34;type\u0026#34;, \u0026#34;key\u0026#34;, \u0026#34;oldValue\u0026#34;, \u0026#34;newValue\u0026#34;]) ); }; run();    undefined [ 1, true, [ \u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39; ] ] track events count = 3 { target: { foo: 1, bar: 2 }, type: \u0026#39;get\u0026#39;, key: \u0026#39;foo\u0026#39; } { target: { foo: 1, bar: 2 }, type: \u0026#39;has\u0026#39;, key: \u0026#39;bar\u0026#39; } { target: { foo: 1, bar: 2 }, type: \u0026#39;iterate\u0026#39;, key: Symbol(iterate) } trigger events count = 2 { key: \u0026#39;foo\u0026#39;, type: \u0026#39;set\u0026#39;, newValue: 3, oldValue: 1 } { key: \u0026#39;bar\u0026#39;, type: \u0026#39;set\u0026#39;, newValue: 4, oldValue: 2 }  è¿™é‡Œè¿˜éœ€è¦å¼€å‘ç¯å¢ƒæ‰èƒ½æµ‹è¯• onTrackï¼Œåªèƒ½æ”¹ä¸€æ”¹å»æ‰ __DEV__ è¯•è¯•ã€‚\n   stop \u0026amp; cleanup   stop: watch() çš„è¿”å›å€¼ï¼Œç”¨æ¥åœæ‰ effect ä½¿å…¶ effect.active = falseï¼Œè®© effect å¤±æ•ˆã€‚\n1 2 3 4 5 6 7  // 9. return runner-\u0026gt;stop, remove runner from instance.effects return () =\u0026gt; { stop(runner); if (instance) { remove(instance.effects!, runner); } };     cleanup: æ¸…ç†å·¥ä½œï¼Œè¿™æœ‰ä¸¤ä¸ªè¢«è°ƒç”¨çš„åœ°æ–¹(cleanup + onStopå®ƒä»¬è¢«æ³¨å†Œäº†åŒä¸€ä¸ªå‡½æ•°)ï¼Œ ä¸€ä¸ªæ˜¯è°ƒåŠ¨ cb/fn ä¹‹å‰ï¼Œä¸€ä¸ªæ˜¯ runner effect è°ƒç”¨ stop çš„æ—¶å€™ã€‚\n1 2 3 4 5 6  let cleanup: () =\u0026gt; void; const onInvalidate: InvalidateCbRegistrator = (fn: () =\u0026gt; void) =\u0026gt; { cleanup = runner.options.onStop = () =\u0026gt; { callWithErrorHandling(fn, instance, ErrorCodes.WATCH_CLEANUP); }; };    stop  stop æ˜¯ watch è°ƒç”¨çš„è¿”å›å€¼ï¼Œé‡Œé¢ä¼š stop runner ç„¶åå°† runner ä» instance.effects é‡Œé¢åˆ é™¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { reactive, nextTick, watch }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const state = reactive({ count: 0 }); let dummy; const stop = watch( () =\u0026gt; state.count, (count) =\u0026gt; { dummy = count; } ); state.count++; await nextTick(); log.br({ dummy }); stop(); state.count = 100; await nextTick(); log({ dummy }); }; run();    undefined { dummy: 1 } { dummy: 1 }   å¯ä»¥çœ‹åˆ° stop ä¹‹åä¸¤æ¬¡è¾“å‡ºç»“æœæ˜¯ä¸€æ ·ï¼Œå³ stop åé¢çš„ state.count å¤±æ•ˆäº†ï¼Œå› ä¸º stop effect ä¼šå°† effect.active ç½®ä¸º false ï¼Œæœ‰å¦‚ä¸‹ä»£ç è¢«æ‰§è¡Œ:\n1 2 3 4  // reactivity/src/effect.ts -\u0026gt; createReactiveEffect() if (!effect.active) { return options.scheduler ? undefined : fn(); }     åˆï¼Œ watch å‡½æ•°é‡Œé¢æ— è®ºå¦‚ä½• scheduler éƒ½æ˜¯æœ‰å€¼çš„ï¼Œæ‰€ä»¥å½“ effect ä¸ºéæ¿€æ´»çŠ¶æ€ï¼Œä»€ ä¹ˆéƒ½ä¸ä¼šå¹²ã€‚\n  cleanup(æ—  cb)   cleanup ç›¸å…³æºç ï¼Œå¯èƒ½æœ‰ç‚¹ç»•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  // cleanup å’Œæ³¨å†Œ cleanup çš„ä¸€ä¸ªå‡½æ•° // å¦‚ä¸‹ï¼Œcleanup å’Œ effect onStop æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œæ¸…ç† effect ç”¨ let cleanup: () =\u0026gt; void; const onInvalidate: InvalidateCbRegistrator = (fn: () =\u0026gt; void) =\u0026gt; { cleanup = runner.options.onStop = () =\u0026gt; { callWithErrorHandling(fn, instance, ErrorCodes.WATCH_CLEANUP); }; }; // runtime-core/src/apiWatch.ts:watch(source, cb, option) // Job å°è£…ä¸­å’Œ cleanup æœ‰å…³çš„ const job: SchedulerJob = () =\u0026gt; { if (!runner.active) { return; } if (cb) { // watch(source, cb)  const newValue = runner(); if (deep || forceTrigger || hasChanged(newValue, oldValue)) { // cleanupï¼Œåœ¨æ‰§è¡Œ cb ä¹‹å‰å…ˆæ‰§è¡Œ cleanup  if (cleanup) cleanup(); // call cb with catch error  // è¿™é‡Œç­‰ä»·äº cb(newValue, oldValue, onInvalidate)  oldValue = newValue; } } /* else... */ }; // ç„¶åè¿˜æœ‰ä¸ªåœ°æ–¹ä¸ cleanup æœ‰å…³ï¼Œä¸”è¿™é‡Œè¦è®²åˆ°çš„å†…å®¹ä¼šåœ¨è¿™éƒ¨åˆ†æ‰§è¡Œ // è·å– getterå‡½æ•°æ—¶å€™ï¼Œå¦‚æœ source æ˜¯å‡½æ•°ç­‰ä»·äº // watchEffect(source) if (isFunction(source)) { // å¦‚æœæ˜¯å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œå–å¾—å‡½æ•°æ‰§è¡Œç»“æœ  if (cb) { // ...  } else { // no cb -\u0026gt; simple effect  getter = () =\u0026gt; { if (instance \u0026amp;\u0026amp; instance.isUnmounted) { // ç»„ä»¶å·²ç»å¸è½½äº†  return; } if (cleanup) cleanup(); // ç­‰ä»·äº return source(onInvalidate)  }; } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { reactive, nextTick, watchEffect }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const state = reactive({ count: 0 }); let n = 0; const cleanup = () =\u0026gt; log(`\\ncalled ${++n}times.`); let dummy; const stop = watchEffect((onCleanup) =\u0026gt; { // è¿™é‡Œæ‰§è¡Œçš„å®é™…ä¸Šæ˜¯ onInvalidate å‡½æ•°ï¼Œå°†cleanup å°è£…åæ³¨å†Œåˆ°  // cleanup å’Œ onStop ä¸Šï¼Œåœ¨ cb æ‰§è¡Œä¹‹å‰æˆ– effect stop æ—¶å€™è°ƒç”¨  onCleanup(cleanup); dummy = state.count; }); state.count++; await nextTick(); // è¿™é‡Œä¼šè¾“å‡ºä¸€æ¬¡ \u0026#39;called 1 times.\u0026#39;  // å› ä¸º cb ä¹‹å‰ä¹‹å‰è¿›è¡Œäº†æ¸…ç†å·¥ä½œ(cleanup())  log.br({ dummy }); // è¿™é‡Œä¼šè¾“å‡ºä¸€æ¬¡ \u0026#39;called 2 times.\u0026#39;  // è¿™é‡Œæ˜¯ effect stop çš„ onStop è§¦å‘çš„  stop(); }; run();    undefined called 1 times. { dummy: 1 } called 2 times.   å³. å¦‚æœæƒ³åœ¨ effect fn ä¹‹å‰æˆ–åœæ­¢çš„æ—¶å€™è¿›è¡Œæ¸…ç†å·¥ä½œï¼Œå¯ä»¥ä½¿ç”¨ watchEffect(effect) çš„å‚æ•° effect å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ¥æ³¨å†Œ ä¸€ä¸ªå‡½æ•°ä½œä¸ºæ¸…ç†å·¥ä½œ æˆ–åšå…¶ä»–äº‹æƒ…ã€‚ å¦‚ï¼š watchEffect((onCleanup) =\u0026gt; { onCleanup(cleanup) ... }\n   cleanup(æœ‰ cb)   å½“æœ‰ cb çš„æ—¶å€™ï¼š watch(source, cb, ...) ï¼Œå°† onCleanup æ³¨å†Œå‡½æ•°ä» cb çš„ç¬¬ä¸‰ä¸ªå‚æ•°æš´éœ²å‡ºæ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { nextTick, watch, ref }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const count = ref(0); let n = 0; const cleanup = () =\u0026gt; log(`\\ncalled ${++n}times, dummy = ${dummy}`); let dummy; const stop = watch(count, (newVal, oldVal, onCleanup) =\u0026gt; { onCleanup(cleanup); dummy = newVal; }); // è¿™é‡Œ cleanup å°šä¸ä¼šæ‰§è¡Œ // å› ä¸ºç¬¬ä¸€æ¬¡æ‰§è¡Œæ˜¯æ³¨å†Œ cleanup è¡Œä¸º  count.value++; await nextTick(); // è¿™é‡Œä¼šæ‰§è¡Œä¸€æ¬¡ cleanup ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡èµ‹å€¼æ—¶æ³¨å†Œè¿‡äº†  count.value = 100; await nextTick(); // stop æ—¶å€™æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥æ€»å…±ä¼šæ‰§è¡Œä¸¤æ¬¡ cleanup, n = 2  stop(); log({n}) }; run();    undefined called 1 times, dummy = 1 called 2 times, dummy = 100 { n: 2 }   è„‘å›¾åˆ†æï¼š\n  æ–‡å­—åˆ†æï¼š\n  cleanup æ³¨å†Œæ—¶æœºåˆ†ä¸ºä¸¤ç§æƒ…å†µ\n  ä¸€æ˜¯æ—  cb çš„ watchEffect(fn) ï¼Œæ˜¯åœ¨ getter è®¾ç½®é˜¶æ®µå°è£…åˆ° getter å‡½æ•°é‡Œé¢ æ³¨å†Œçš„ï¼Œæ­¤æ—¶ä½œä¸º fn çš„ç¬¬ä¸€ä¸ªå‚æ•°æš´éœ²å‡ºæ¥ fn(onCleanUp) ï¼Œ\n  äºŒæ˜¯æœ‰ cb çš„ watch(ref(0), cb) , åœ¨ job å°è£…æœŸé—´åœ¨è°ƒç”¨ cb çš„æ—¶å€™æ³¨å†Œï¼Œæ­¤ æ—¶ä½œä¸º cb çš„ç¬¬ä¸‰ä¸ªå‚æ•°æš´éœ²å‡ºæ¥ cb(newVal, oldVal, onCleanup)\n   ä¸¤è€…åŒºåˆ« ï¼š watchEffect ç”±äºæ—  cb ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ runner, æ­¤æ—¶å°±æ”¶é›†åˆ°äº† cleanupï¼Œ è€Œ watch æœ‰ cb æ—¶åˆ™æ˜¯ä¼šåœ¨ç¬¬ä¸€æ¬¡å€¼æ›´æ–°è§¦å‘ runner æ‰§è¡Œæ‰å¼€å§‹æ”¶é›† cleanupã€‚\n   æ‰§è¡Œæ—¶æœºï¼Œè¯¥é˜¶æ®µå’Œæ³¨å†Œæ—¶æœºç›¸è¾…ç›¸æˆï¼Œä¸”åœ¨ cb/fn æ‰§è¡Œä¹‹å‰å°±ä¼šè¢«æ‰§è¡Œï¼Œå› æ­¤ cb/fn çš„ç¬¬ä¸€æ¬¡æ‰§è¡Œéƒ½å±äºå¯¹ cleanup çš„æ³¨å†Œ\n      flush sync   feat(add): rc-\u0026gt;api watch-\u0026gt;option flush=sync Â· gcclll/stb-vue-next@e1436f2 Â· GitHub\n æ”¯æŒåŒæ­¥ä»£ç ï¼Œå³æ‰€æœ‰ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼ˆåœ¨å€¼å‘ç”Ÿæ”¹å˜ä¹‹åï¼‰ï¼Œè€Œä¸æ˜¯è¿›å…¥é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œã€‚\n åªéœ€è¦å¢åŠ ä¸€è¡Œä»£ç å°±è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  // 6. TODO scheduler è®¾ç½® let scheduler: ReactiveEffectOptions[\u0026#34;scheduler\u0026#34;]; // 6.1 flush is \u0026#39;sync\u0026#39; if (flush === \u0026#34;sync\u0026#34;) { scheduler = job; // æ–°å¢ } // 6.2 TODO flush is \u0026#39;post\u0026#39; else if (false /* post */) { } // 6.3 TODO flush is \u0026#39;pre\u0026#39;(default) else { // default: \u0026#39;pre\u0026#39;  scheduler = () =\u0026gt; { if (!instance || instance.isMounted) { queuePreFlushCb(job); } else { // å¸¦ { pre: true } é€‰é¡¹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å¿…é¡»å‘ç”Ÿåœ¨ç»„ä»¶ mounted ä¹‹å‰  // ä»è€Œä½¿ä»–è¢«åŒæ­¥è°ƒç”¨ï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡  job(); } }; }     æ–°å¢ scheduler = job ç›´æ¥è®©ä»»åŠ¡å‡½æ•°èµ‹å€¼ç»™è°ƒåº¦å™¨ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæœ‰å€¼å‘ç”Ÿå˜åŒ–ï¼Œä¼š è§¦å‘ effect\u0026gt; trigger() åœ¨è¿™é‡Œé¢ä¼šæ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ option.scheduler å¦‚æœæœ‰ä¼šç«‹å³æ‰§è¡Œè¿™ ä¸ªå‡½æ•°ã€‚\n1 2 3 4 5 6  // reactivity/effect.ts\u0026gt;trigger() if (effect.options.scheduler) { effect.options.scheduler(effect); } else { effect(); }     æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { watch, ref }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const value = ref(0); let calls = 0; watch(value, () =\u0026gt; ++calls, { flush: \u0026#34;sync\u0026#34; }); log({ calls }); // -\u0026gt; 0  value.value = 100; log({ calls }); // -\u0026gt; 1 }; run();    { calls: 0 } { calls: 1 } undefined   æ³¨æ„çœ‹ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹å¹¶æ²¡æœ‰ç”¨ await nextTick() ï¼Œè€Œæ˜¯åŒæ­¥ä»£ç æ‰§è¡Œã€‚\n  shallow ref  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { watch, shallowRef, nextTick, triggerRef }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const v = shallowRef({ a: 1 }); // #1  let sideEffect = 0; watch(v, (obj) =\u0026gt; { // #2 cb -\u0026gt; cb(newVal, oldVal, onCleanUp)  sideEffect = obj.a; }); v.value = v.value; // #3  await nextTick(); log([\u0026#34;\\nshould not trigger: \u0026#34;, sideEffect]); // #4  v.value.a++; // #5  await nextTick(); log([\u0026#34;\\nshould not trigger: \u0026#34;, sideEffect]); // #6  triggerRef(v); // #7  await nextTick(); log([\u0026#34;\\nshould trigger now: \u0026#34;, sideEffect]); // #8 }; run();    undefined should not trigger: 0 should not trigger: 0 should trigger now: 2   ref è¿™ä¸€å—è¿˜æ²¡æ·±å…¥å»åˆ†æè¿‡ï¼Œå…ˆæš‚åœâ¸å»å®Œæˆä¸‹è¿™éƒ¨åˆ†ã€‚\n  DONE [2021-01-20 15:18:37] ref å®Œæˆï¼Œå¯ä»¥å¾€ä¸‹ç»§ç»­äº†\n    triggerRef ä½œç”¨æ˜¯æ‰‹åŠ¨è§¦å‘ ref.value ä¸Šæ”¶é›†çš„æ‰€æœ‰ä¾èµ–ã€‚\n ç»“æœåˆ†æï¼š\n  #1 shallowRef æ„å‘³ç€ {a: 1} ä¸­çš„å±æ€§ a é reactive\n  #2 watch v åŸºäº 1 æ‰€ä»¥åªæ˜¯å¯¹ ref value è¿›è¡Œäº†ç›‘å¬ï¼Œåé¢æ˜¯å€¼å˜æ›´å›è°ƒ\n  #3 å€¼æ²¡å‘ç”Ÿæ”¹å˜ï¼Œæ‰€æœ‰ #4 è¾“å‡ºè¿˜æ˜¯ 0\n  #5 ç”±äº a å±æ€§é reactive æ‰€ä»¥å®ƒæ²¡æœ‰ä¾èµ–æ”¶é›†æ‰€ä»¥ä¸ä¼šæ‰§è¡Œ cbï¼Œæ‰€ä»¥ #6 å‡º ä¾ç„¶æ˜¯ 0\n  #7 è¿™é‡Œæ‰‹åŠ¨è°ƒç”¨ triggerRef(v) ç­‰ä»·äº trigger(v, SET, \u0026#39;value\u0026#39;) è§¦å‘ ref value çš„ä¾èµ–æ‰§è¡Œï¼Œæ­¤æ—¶ cb ä¼šå¾—åˆ°æ‰§è¡Œï¼ŒsideEffect è¢«èµ‹å€¼æ–°çš„ v.a å€¼\n è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œåœ¨ cb é‡Œé¢æ˜¯ç”¨çš„ v.a è€Œä¸æ˜¯ v.value.a å› ä¸ºåœ¨ watch(s,cb,option) é‡Œé¢æ£€æµ‹åˆ°å¦‚æœ s æ˜¯ ref ç±»å‹ï¼Œä¼šå°† getter è®¾ç½®ä¸º getter = () =\u0026gt; s.value\n è€Œåœ¨æ‰§è¡Œ cb ä¹‹å‰å–æ–°å€¼æ˜¯é€šè¿‡ newVal = runner() å¾—åˆ°çš„ï¼Œè€Œè¿™ä¸ª runner = effect(getter, {...}) æ‰€ä»¥ç­‰äºæ˜¯ effect(() =\u0026gt; s.value, {...})\n æ‰€ä»¥å¯¹äº ref ç±»å‹ effect å°è£…çš„å…¶å®æ˜¯ () =\u0026gt; s.value è¿™ä¸ªå‡½ æ•°ï¼Œé‚£ä¹ˆå¯¹äº s.value çš„ä¾èµ–åˆ—è¡¨ä¸­å°±ä¼šæœ‰è¿™ä¸ªç®­å¤´å‡½æ•°ã€‚\n ç„¶ååœ¨ watch é‡Œé¢ä¼šå°† cb çš„æ‰§è¡Œå°è£…è¿› job ï¼Œç„¶åæ ¹æ®æƒ…å†µå°† job å°è£…æˆ–ç›´æ¥èµ‹å€¼ ç»™ scheduler ï¼Œè¿™ä¸ªä¼šä½œä¸º effect(, { scheduler }) çš„é€‰é¡¹ä¼ é€’è¿›å»ã€‚\n é‚£ä¹ˆåœ¨ trigger çš„æ—¶å€™æ£€æµ‹åˆ°æä¾›äº† scheduler å°±ä¼šè°ƒç”¨å®ƒï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨ triggerRef(v) ä¼šè§¦å‘ cb çš„è°ƒç”¨å°† obj.a~å¤åˆ¶ç»™ ~sideEffect ï¼Œè¿™ä¸ª obj å°±æ˜¯ runner() æ‰§è¡Œçš„è¿”å›å€¼ä¹Ÿå°±æ˜¯ () =\u0026gt; s.value è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼ã€‚\n    TODO flush pre(default) cb   TODO flush post cb   feat(add): rc-\u0026gt;watch-\u0026gt;flush = \u0026#39;post\u0026#39; Â· gcclll/stb-vue-next@ec14879 Â· GitHub\n feat(add): rc-\u0026gt;watch-\u0026gt;cb-\u0026gt;flush = \u0026#39;post\u0026#39; Â· gcclll/stb-vue-next@9f3ac7d Â· GitHub\n æ–°å¢ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // apiWatch.ts -\u0026gt; scheduler when flush=post if (flush === \u0026#34;post\u0026#34;) { scheduler = () =\u0026gt; queuePostRenderEffect(job, instance \u0026amp;\u0026amp; instance.suspense); } // renderer.ts -\u0026gt; queuePostRenderEffect // å°†ä»»åŠ¡åŠ å…¥åˆ° suspense.effects æˆ– è°ƒç”¨ queuePostFlushCb // åŠ å…¥åˆ° pendingPostFlushCbs export const queuePostRenderEffect = __FEATURE_SUSPENSE__ ? queueEffectWithSuspense : queuePostFlushCb; // components/Suspense.ts export function queueEffectWithSuspense( fn: Function | Function[], suspense: SuspenseBoundary | null ): void { if (suspense \u0026amp;\u0026amp; suspense.pendingBranch) { if (isArray(fn)) { suspense.effects.push(...fn); } else { suspense.effects.push(fn); } } else { queuePostFlushCb(fn); } }      TODO ssr support   TODO instance watch   feat(add): rc-\u0026gt;watch-\u0026gt;instance watch Â· gcclll/stb-vue-next@9ec5d51 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13  // this.$watch export function instanceWatch( this: ComponentInternalInstance, source: string | Function, cb: WatchCallback, options?: WatchOptions ): WatchStopHandle { const publicThis = this.proxy as any const getter = isString(source) ? () =\u0026gt; publicThis[source] : source.bind(publicThis) return doWatch(getter, cb.bind(publicThis), options, this) }     å°†ç›‘å¬æºï¼Œä¸å½“å‰å®ä¾‹ç»‘å®šï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²è½¬æˆå‡½æ•°ã€‚\n  ğŸº å°ç»“   è¿™ä¸€èŠ‚æ‰€æè¿°çš„ä¸»è¦æ˜¯ watch/watchEffect å‡½æ•°çš„å®ç°å’Œä½¿ç”¨ï¼Œç”¨æ¥ç›‘å¬æ•°æ®å˜åŒ–åšå‡ºç›¸ åº”ã€‚\n watch(source, cb, option) -\u0026gt; doWatch(source, cb, option)\n watchEffect(effect, option) -\u0026gt; doWatch(source /*function*/, null, option)\n é‡ç‚¹å›é¡¾ watch ï¼Œå› ä¸º watchEffect æ˜¯åœ¨ source ä¸º function ä¸”æ—  cb æ—¶å€™çš„æƒ…å†µã€‚\n ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ watch å‡½æ•°çš„å®ç°å†…å®¹æ¥é€ä¸ªå›é¡¾ï¼Œå‡½æ•°å®ç°ä»£ç æœ‰ä¸‰ä¸ªé‡ç‚¹\n æ³¨ğŸ–ï¼šwatch é‡Œé¢å‡½æ•°çš„è°ƒç”¨(source æˆ– cb) éƒ½æ˜¯é€šè¿‡ callWithErrorHandling å»å®Œæˆçš„ï¼Œ è¿™é‡Œå…¶å®å°±æ˜¯ä¸ªå¼‚å¸¸æ‹¦æˆªçš„ä½œç”¨(tryâ€¦catch)ï¼Œé˜²æ­¢æ‰§è¡ŒæŠ¥é”™é˜»ç¢æ•´ä½“é¡µé¢çš„æ‰§è¡Œã€‚\n   getter: æ ¹æ® source ç±»å‹å°è£… getter\n Ref : getter = () =\u0026gt; source.value\n Reactive: deep = true, traverse(source) å¯¹å¯¹è±¡æ‰€æœ‰å±æ€§è§¦å‘ä¸€æ¬¡ getter æ“ä½œã€‚\n Array: æ ¹æ®å…ƒç´ ç±»å‹ä¸åŒåšä¸åŒå¤„ç†(æ¯”å¦‚ï¼š ref/reactive/function ä¸”åªæ”¯æŒè¿™ ä¸‰ç§)\n Function: getter =\u0026gt; { â€¦ç›´æ¥æ‰§è¡Œ source } ä¸åŒç‚¹åœ¨äºå¦‚æœæœ‰ cb æ—¶ï¼Œæ‰§è¡Œ source() ï¼Œæ²¡æœ‰æ—¶ source(onInvalidate) è¿™ä¸ª onInvalidate æ˜¯ watch æš´éœ²å‡º å»çš„ä¸€ä¸ªæ¸…ç†å‡½æ•°å®ƒä¼šè¢«ç»‘å®šåˆ° cleanup å’Œ option.onStop ä¸Šï¼Œåœ¨ effect è¢« stop æˆ–åœ¨è°ƒç”¨ä¹‹å‰åšçš„ä¸€äº›æ¸…ç†å·¥ä½œã€‚\n è¿™ä¸ªæœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†å¯¹æ¯ä¸ªå±æ€§è¿›è¡Œä¸€æ¬¡ getter è°ƒç”¨ï¼Œç”¨æ¥ effect -\u0026gt; track æ”¶é›†æ¯ ä¸ªå±æ€§çš„ä¾èµ–åˆ—è¡¨(reactivity: targetMap -\u0026gt; depsMap -\u0026gt; dep)ã€‚\n  job: æ ¹æ® cb å‚æ•°å°è£… job(å°†æ¥åœ¨å€¼å˜æ›´æ˜¯è§¦å‘æ‰§è¡Œçš„å‡½æ•°)\n job çš„å°è£…åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ cb æ˜¯å‡½æ•°æˆ–ä¸ºç©ºå€¼æ—¶å€™ï¼Œè¿™é‡Œçš„åŒºåˆ«ä¹Ÿæ˜¯ä½“ç°åœ¨ cb çš„è°ƒç”¨ä¸Šé¢(å…·ä½“å°±æ˜¯ç»™ cb çš„å‚æ•°)ã€‚\n if(cb) é‚£ä¹ˆå…¶è°ƒç”¨å‚æ•°ä¼šæ˜¯ï¼š cb(newVal, oldVal, onCleanup/*onInvalidate*/)\n else æ²¡æœ‰ cb çš„æ—¶å€™ä¼šç›´æ¥æ‰§è¡Œ runner() è§¦å‘æ›´æ–°ã€‚\n æ³¨æ„åˆ°å’Œ 1 ä¸­æœ‰ç‚¹ç±»ä¼¼åœ°æ–¹äº†æ²¡ï¼Œè¿™é‡Œçš„ cb(â€¦) å’Œ getter å°è£…é˜¶æ®µå¯¹ source(onInvalidate) çš„è°ƒç”¨ï¼Œå³ä¸ç®¡æ˜¯æœ‰ cb è¿˜æ˜¯æ²¡æœ‰ cbï¼Œ onInvalidate è¿™ä¸ª å›è°ƒæ€»æ˜¯ä¼šè¢«æš´éœ²å‡ºå»ï¼Œæ— éæ˜¯ä½œä¸º cb å‚æ•°è¿˜æ˜¯ function source çš„å‚æ•°ï¼Œè¿™ä½¿å¾—æˆ‘ ä»¬å¯ä»¥åœ¨æ¯ä¸ªä»»åŠ¡æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œç»“æŸçš„æ—¶é—´ç‚¹åšä¸€äº›äº‹æƒ…(æ¯”å¦‚ï¼š cleanup)ã€‚\n   scheduler çš„å°è£…(æ ¹æ®é€‰é¡¹ç±»å‹ï¼Œä¸»è¦æ˜¯ flush = sync|post|pre)ï¼Œå€¼å˜æ›´ effect trigger ä¸­è°ƒç”¨çš„å‡½æ•°\n scheduler æ˜¯å°† job è¿›ä¸€æ­¥å°è£…ï¼Œå°†æ¥å½“å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ effect -\u0026gt; trigger é‡Œé¢ ä¼šè¢«è°ƒç”¨åˆ°ã€‚\n è¿™ä¸ªå‡½æ•°çš„å€¼ä¸»è¦ç”± flush é€‰é¡¹å†³å®šï¼Œé»˜è®¤å€¼æ˜¯ pre ï¼Œå…¶æ¬¡æœ‰ post|sync\n post: å¼‚æ­¥æ‰§è¡Œï¼Œä¼šæ·»åŠ åˆ°å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ(pendingPostFlushCbs)\n sync: è¡¨ç¤ºä¸ºåŒæ­¥æ›´æ–°ï¼Œå³å½“å€¼å‘ç”Ÿå˜åŒ–äº†ä¼šç«‹å³æ›´æ–°ï¼Œè¯¦æƒ…ã€‚\n1 2 3  // æ¯”å¦‚ï¼šref.value = 0 ref.value++; ref.value === 1; // true, è€Œä¸ç”¨ await nextTick() å°±å¯ä»¥å–åˆ°æ›´æ–°åçš„å€¼      pre: é»˜è®¤æ˜¯ pre ç±»å‹ï¼Œè¿™é‡ŒåŒºåˆ†ç»„ä»¶æ˜¯å¦åŠ è½½å®Œæˆï¼Œ instance.isUnmounted å¦‚æœ åŠ è½½å®Œæˆï¼Œè°ƒç”¨ queuePreFlushCb(job) æ·»åŠ åˆ° pendingPreFlushCbs[] ä¸­ç­‰å¾…æ‰§ è¡Œï¼Œå¦‚æœç»„ä»¶æ²¡æœ‰åŠ è½½å®Œæˆéœ€è¦ç«‹å³æ‰§è¡Œ job() ã€‚\n   åœ¨å‰é¢ä¸‰ä¸ªåŸºæœ¬æ¡ä»¶(getter/job/scheduler)å°è£…å®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥æ˜¯è°ƒç”¨ effect(getter, { lazy: true, scheduler, ... }) å¾—åˆ° runner() è¿™ä¸ª runner æ˜¯ å¯¹ getter å‡½æ•°çš„ ReactiveEffect å°è£…ã€‚\n runner: éšåå†³å®šä»€ä¹ˆæ—¶æœºæ‰§è¡Œè¿™ä¸ª runner() è§¦å‘ track æ”¶é›†ä¾èµ–ï¼Œåˆ¤å®šæ¡ä»¶æœ‰ cb, option.immediate, option.flush=\u0026#34;post\u0026#34;\n  cb \u0026amp;\u0026amp; immediate æ—¶å€™ç«‹å³æ‰§è¡Œ job() ä¸èµ° runner\n  cb \u0026amp;\u0026amp; !immediate ç«‹å³æ‰§è¡Œ runner() æ ¹æ®ä»»åŠ¡æ€§è´¨å†³å®šæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥\n  !cb \u0026amp;\u0026amp; flush===\u0026#39;post\u0026#39; æ£€æµ‹å¦‚æœæ˜¯ suspense åŠ å…¥åˆ° instance.suspense.effects å¦åˆ™ç›´æ¥ queuePostFlushCb(runner)\n è¿™ä¸ªéœ€è¦å¼€å¯ Suspense ç»„ä»¶æ”¯æŒï¼Œè¿™ä¸ª ast render å‡½æ•°å…¶å®å°±æ˜¯åœ¨ä¸€ä¸ª async å‡½æ•°é‡Œé¢æ‰§è¡Œçš„ä»£ç ã€‚\n  else ç›´æ¥æ‰§è¡Œ runner()\n      ğŸ api createApp  declaration  è¿™é‡Œå°±ä¸¤ä¸ªå‡½æ•°\n  createAppContext ä¸Šä¸‹æ–‡åˆ›å»º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  export function createAppContext(): AppContext { return { app: null as any, config: { isNativeTag: NO, performance: false, globalProperties: {}, optionMergeStrategies: {}, isCustomElement: NO, errorHandler: undefined, warnHandler: undefined, }, mixins: [], components: {}, directives: {}, provides: Object.create(null), }; }      createAppAPI åˆ›å»º createApp å‡½æ•°\n1 2 3 4 5 6  export function createAppAPI\u0026lt;HostElement\u0026gt;( render: RootRenderFunction, hydrate?: RootHydrateFunction ): CreateAppFunction\u0026lt;HostElement\u0026gt; { return function createApp(rootComponent, rootProps = null) {}; }      æ‰€ä»¥ä¸€ä¸ª App ä¸Šä¸‹æ–‡åŒ…å«å†…å®¹ï¼š\n   name - -     app -    config -     isNativeTag NO    performance false    globalProperties {}    optionMergeStrategies {}    isCustomElement NO    errorHandler undefined    warnHandler undefined   mixins []    components {}    directives {}    provides Object.create(null)       implementation   feat(add): createApp app apis Â· gcclll/stb-vue-next@1facd1b Â· GitHub\n  context = createAppContext() åˆ›å»ºä¸Šä¸‹æ–‡\n  installedPlugins = new Set() æ’ä»¶åˆ—è¡¨\n  isMounted = false åŠ è½½å®Œæˆæ ‡è¯†\n  app = context.app = {...}\n  return app\n   æ‰€ä»¥é‡ç‚¹å°±åœ¨ 4 æ„é€  appï¼Œå…¶åŒ…å«çš„ API å¦‚ä¸‹ï¼š\n   name function     get config() è·å–ä¸Šä¸‹æ–‡é…ç½®ä¿¡æ¯ï¼Œä¸å¯æ›´æ”¹ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºå®ä¾‹æ—¶çš„ option æ”¹å˜   use(pugin, â€¦options) æ’ä»¶ç³»ç»Ÿ   mixin(mixin) æ··åˆå™¨ç³»ç»Ÿ   component(name, component) ç»„ä»¶ç³»ç»Ÿ   directive(name, directive) æŒ‡ä»¤ç³»ç»Ÿ   mount(rootContainer, isHydrate) mount å‡½æ•°   unmount() -   provide(key, value) æ³¨å…¥ç³»ç»Ÿ    app.use(plugin, â€¦options)   feat(add): createApp use plugin Â· gcclll/stb-vue-next@a3abcba Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function use(plugin: Plugin, ...options: any[]) { if (installedPlugins.has(plugin)) { __DEV__ \u0026amp;\u0026amp; warn(`Plugin has already been applied to target app.`); } else if (plugin \u0026amp;\u0026amp; isFunction(plugin.install)) { // å‡½æ•°ç›´æ¥æ‰§è¡Œ  installedPlugins.add(plugin); plugin.install(app, ...options); } else if (isFunction(plugin)) { // æ²¡æœ‰ install å‡½æ•°æ—¶  installedPlugins.add(plugin); plugin(app, ...options); } else if (__DEV__) { // plugin å¿…é¡»è¦ä¹ˆè‡ªå·±æ˜¯å‡½æ•°ï¼Œè¦ä¹ˆæ˜¯åŒ…å« install å‡½æ•°çš„å¯¹è±¡  warn( `A plugin must either be a function or an object with an \u0026#34;install\u0026#34; ` + `function.` ); } return app; }     æ‰€ä»¥æ’ä»¶ plugin å¿…é¡»è¦ä¹ˆè‡ªå·±æ˜¯å‡½æ•°ã€‚\n  app.mixin(mixin)   feat(add): createApp mixin api Â· gcclll/stb-vue-next@b96afcf Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  function mixin(mixin: ComponentOptions) { if (__FEATURE_OPTIONS_API__) { if (!context.mixins.includes(mixin)) { context.mixins.push(mixin); // å¸¦æœ‰ props/emits çš„å…¨å±€ mixin ä¼šæ˜¯çš„ props/emits ç¼“å­˜ä¼˜åŒ–å¤±æ•ˆ  if (mixin.props || mixin.emits) { context.deopt = true; } } else if (__DEV__) { warn( \u0026#34;Mixin has already been applied to target app\u0026#34; + (mixin.name ? `: ${mixin.name}` : \u0026#34;\u0026#34;) ); } } else if (__DEV__) { // å¿…é¡»å¼€å¯äº† options api ç‰¹æ€§æ‰èƒ½ä½¿ç”¨ï¼Œå³ vue3 é‡Œé¢å¯æ ¹æ®éœ€è¦  // å…³é—­è¿™ä¸ªåŠŸèƒ½  warn(\u0026#34;Mixins are only available in builds supporting Options API\u0026#34;); } return app; }     å¯æ ¹æ®éœ€è¦åœ¨æ‰“åŒ…çš„æ—¶å€™ç”± __FEATURE_OPTIONS_API__ å†³å®šæ˜¯å¦ç»§ç»­æ”¯æŒ mixin åŠŸèƒ½ã€‚\n  app.component(name, component)   feat(add): createApp component api Â· gcclll/stb-vue-next@9b2579d Â· GitHub\n å†…ç½®æ ‡ç­¾ï¼š slot,component\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function component(name: string, component?: Component): any { if (__DEV__) { // éªŒè¯ç»„ä»¶åç§°æ˜¯å¦åˆæ³•  validateComponentName(name, context.config); } // æ²¡æœ‰å¯¹åº”ç»„ä»¶ï¼Œè§†ä¸ºæ ¹æ®åç§°è·å–ç»„ä»¶æ“ä½œ  if (!component) { return context.components[name]; } if (__DEV__ \u0026amp;\u0026amp; context.components[name]) { // ç»„ä»¶å·²ç»æ³¨å†Œè¿‡äº†ï¼Œå†æ¬¡æ³¨å†Œç­‰äºè¦†ç›–åŸæœ‰çš„  warn(`Component \u0026#34;${name}\u0026#34; has already been registered in target app.`); } context.components[name] = component; return app; }      éªŒè¯ç»„ä»¶åï¼Œä¸èƒ½ç”¨å†…ç½®(isBuiltInTag())æˆ–è‡ªå®šä¹‰(isCustomElement())çš„æ ‡ç­¾ä½œä¸ºç»„ä»¶å\n  æ²¡æœ‰ component å‚æ•°çš„æ—¶å€™è§†ä¸ºæ ¹æ® name å»è·å–ç»„ä»¶\n  å½“ name - component å­˜åœ¨æ—¶å±äºè¦†ç›–æ“ä½œï¼Œç»™å‡ºè­¦å‘Š\n    app.directive(name, directive)   feat(add): createApp directive api Â· gcclll/stb-vue-next@ec1a20e Â· GitHub\n å†…ç½®æŒ‡ä»¤é›†ï¼š bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function directive(name: string, directive?: Directive) { if (__DEV__) { validateDirectiveName(name); } if (!directive) { return context.directives[name] as any; } if (__DEV__ \u0026amp;\u0026amp; context.directives[name]) { warn(`Directive \u0026#34;${name}\u0026#34; has already been registered in target app.`); } context.directives[name] = directive; return app; }      app.mount(rootContainer, isHydrate)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  function mount(rootContainer: HostElement, isHydrate?: boolean): any { // TODO  if (!isMounted) { const vnode = createVNode(rootComponent as ConcreteComponent, rootProps); // ä¿å­˜ app context åˆ° root VNode èŠ‚ç‚¹ä¸Š  // è¿™ä¸ªå°†ä¼šåœ¨åˆå§‹åŒ– mount æ—¶å€™è¢«è®¾ç½®åˆ°æ ¹å®ä¾‹ä¸Š  vnode.appContext = context; // HMR root reload  if (__DEV__) { context.reload = () =\u0026gt; { render(cloneVNode(vnode), rootContainer); }; } if (isHydrate \u0026amp;\u0026amp; hydrate) { hydrate(vnode as VNode\u0026lt;Node, Element\u0026gt;, rootContainer as any); } else { render(vnode, rootContainer); } isMounted = true; app._container = rootContainer; // for devtools and telemetry  (rootContainer as any).__vue_app__ = app; if (__DEV__ || __FEATURE_PROD_DEVTOOLS__) { devtoolsInitApp(app, version); } return vnode.component!.proxy; } else if (__DEV__) { warn( `App has already been mounted.\\n` + `If you want to remount the same app, move your app creation logic ` + `into a factory function and create fresh app instances for each ` + `mount - e.g. \\`const createMyApp = () =\u0026gt; createApp(App)\\`` ); } }      vnode = createVNode(rootComponent, rootProps) åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹\n  vnode.appContext = context ä¿å­˜ä¸Šä¸‹æ–‡åˆ°è™šæ‹ŸèŠ‚ç‚¹ä¸Šï¼Œç»„ä»¶åˆå§‹åŒ–æ—¶ä½¿ç”¨\n  context.reload = () =\u0026gt; render(cloneVNode(vnode), rootContainer) HMR å¼€å‘æ—¶ æœ‰å˜æ›´çš„çƒ­åŠ è½½\n  rootContainer.__vue_app__ = app\n  devtool å¼€å‘å·¥å…·ç›¸å…³\n  è¿”å› vnode.component.proxy è¿™ä¸ªæ˜¯å¹²å•¥çš„ï¼Ÿ\n   æœ€åï¼Œå¦‚æœ app å·²ç»è¢«åŠ è½½äº†ä¸èƒ½é‡å¤ mountã€‚å¦‚æœéœ€è¦å¯¹ä¸€ä¸ªappåšé‡å¤ mountï¼Œå¯èƒ½çš„ éœ€æ±‚æ˜¯å­˜åœ¨åŒæ—¶åˆ›å»ºå¤šä¸ª app æƒ…å†µï¼Ÿ\n é‚£ä¹ˆè¿™ä¸ªæ—¶å€™åº”è¯¥ä½¿ç”¨å‡½æ•°æ–¹å¼ä½¿ç”¨ï¼Œå¦‚ï¼š\n myCreateApp = (...) =\u0026gt; createApp(App)\n  app.unmount()   feat(add): createApp unmount api Â· gcclll/stb-vue-next@63354d3 Â· GitHub\n1 2 3 4 5 6 7 8 9 10  function unmount() { if (isMounted) { render(null, app._container); if (__DEV__ || __FEATURE_PROD_DEVTOOLS__) { devtoolsUnmountApp(app); } } else { warn(`Cannot unmount an app that is not mounted.`); } }     render(null, ...) ?\n  app.provide(key, value)   feat(add): createApp provide api Â· gcclll/stb-vue-next@18fb22b Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function provide(key, value) { if (__DEV__ \u0026amp;\u0026amp; (key as string | symbol) in context.provides) { warn( `App already provides property with key \u0026#34;${String(key)}\u0026#34;. ` + `It will be overwritten with the new value.` ); } // TypeScript doesn\u0026#39;t allow symbols as index type  // https://github.com/Microsoft/TypeScript/issues/24587  context.provides[key as string] = value; return app; }     å°±æ˜¯ç®€å•çš„ç»™ context.provides è®¾ç½®æ“ä½œã€‚\n   åšä»€ä¹ˆçš„å‘¢ï¼Ÿ\n       test   è¿™é‡Œç›®å‰åªèƒ½æµ‹è¯• mount å’Œ unmount å…¶ä»–çš„ api(provide/â€¦) éœ€è¦ç­‰å®ƒä»¬è¢«å®ç°äº†æ‰èƒ½ ç»§ç»­æµ‹è¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rcTest: { defineComponent, nodeOps, createApp, serializeInner }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const Comp = defineComponent({ props: { count: { default: 0, }, }, setup(props) { return () =\u0026gt; props.count; }, }); const root1 = nodeOps.createElement(\u0026#34;div\u0026#34;); createApp(Comp).mount(root1); let si = serializeInner(root1); log(\u0026#34;root1 serialize, \u0026#34; + si); // mount with props const root2 = nodeOps.createElement(\u0026#34;div\u0026#34;); const app2 = createApp(Comp, { count: 1 }); app2.mount(root2); si = serializeInner(root2); log(\u0026#34;root2 serialize, \u0026#34; + si); // unmount const root3 = nodeOps.createElement(\u0026#34;div\u0026#34;); const app3 = createApp(Comp, { foo: 1 }); // åœ¨ mount ä¹‹å‰å¸è½½ try { app3.unmount(root3); // warnning } catch (e) { log(\u0026#34;unmount failed.\u0026#34;); } app3.mount(root3); app3.unmount(root3); si = serializeInner(root3); log(\u0026#34;root3 serialize, \u0026#34; + si);    root1 serialize, 0 root2 serialize, 1 root3 serialize, undefined      â› api provide \u0026amp; inject   feat(add): provide \u0026amp; inject api Â· gcclll/stb-vue-next@b4a1cbc Â· GitHub\n ä½œç”¨ï¼š åœ¨çˆ¶ç»„ä»¶ä¸­ provide(key,value) å‘å­ç»„ä»¶ä¼ å€¼ï¼Œ inject(key) åœ¨å­ç»„ä»¶ä¸­å¯ä»¥å–åˆ°è¯¥å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11  export function provide\u0026lt;T\u0026gt;(key: InjectionKey\u0026lt;T\u0026gt; | string | number, value: T) { // TODO } export function inject( key: InjectionKey\u0026lt;any\u0026gt; | string, defaultValue?: unknown, treatDefaultAsFactory = false ) { // TODO }     æ¶‰åŠå†…å®¹\n  provides ç»§æ‰¿ parent providesï¼Œéœ€è¦è‡ªå·±çš„å°±åˆ›å»ºæ–°å¯¹è±¡ç»§æ‰¿è‡ª parent providesï¼Œ æ‰€ä»¥æŸ¥æ‰¾ injections å¯ä»¥åœ¨åŸå‹é“¾æŸ¥æ‰¾ã€‚\n  inject(key, defaultValue, treatDefaultAsFactory = false) ä½ åªæ˜¯ä¸ªç®€å•çš„å–å€¼ æ“ä½œ (provides[key])ï¼ŸğŸ˜­ï¼ŸğŸ˜­ï¼Ÿ\n   Imp. provide å’Œ inject åªèƒ½åœ¨ setup() æˆ–å‡½æ•°å¼ç»„ä»¶ä¸­ä½¿ç”¨ï¼Œå®ƒä»¬çš„ä½œç”¨æ˜¯æ ¹æ®åŸ å‹é“¾ç‰¹æ€§å®ç°ä»çˆ¶ç»„ä»¶å‘å­ç»„ä»¶ä¼ é€’ä¸€äº›å€¼ã€‚\n  provide(key, value)   feat(add): provide \u0026amp; inject provide implementation Â· gcclll/stb-vue-next@42f3d05 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  export function provide\u0026lt;T\u0026gt;(key: InjectionKey\u0026lt;T\u0026gt; | string | number, value: T) { if (!currentInstance) { if (__DEV__) { warn(`provide() can only be used inside setup().`); } } else { let provides = currentInstance.provides; // é»˜è®¤æƒ…å†µå®ä¾‹ä¼šç»§æ‰¿å®ƒçˆ¶äº²çš„ provides å¯¹è±¡  // ä½†æ˜¯å½“å®ƒéœ€è¦ provide è‡ªå·±çš„ values æ—¶å€™ï¼Œé‚£ä¹ˆä½¿ç”¨å®ƒ  // çˆ¶äº²çš„ provides ä½œä¸ºåŸå‹åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡å‡ºæ¥å˜æˆè‡ªå·±çš„ provides  // è¿™æ ·åœ¨ `inject` é‡Œé¢å¯ä»¥ç®€ä¾¿çš„ä»åŸå‹é“¾ä¸­æŸ¥æ‰¾ injections  // ç®€å•è¯´å°±æ˜¯ï¼š  // 1. éœ€è¦è‡ªå·±çš„å°±åˆ›å»ºä¸ªæ–°çš„å¯¹è±¡ç»§æ‰¿è‡ª Parent provides  // 2. è¿™æ ·åœ¨æŸ¥æ‰¾çš„æ—¶å€™å°±å¯ä»¥å«æ–¹ä¾¿çš„é€šè¿‡åŸå‹é“¾æŸ¥æ‰¾ injections  const parentProvides = currentInstance.parent \u0026amp;\u0026amp; currentInstance.parent.provides; // å½“çˆ¶ç»„ä»¶å’Œå½“å‰å®ä¾‹ç›¸åŒçš„æ—¶å€™ï¼Œä»çˆ¶ç»„ä»¶çš„ provides åˆ›å»ºä¸€ä¸ªå¤‡ä»½å‡ºæ¥  if (parentProvides === provides) { provides = currentInstance.provides = Object.create(parentProvides); } // TS doesn\u0026#39;t allow symbol as index type  provides[key as string] = value; } }     Object.create(parentProvides) åˆ›æ–°æ–°çš„å¯¹è±¡æ¥å®¹çº³æ–°çš„ key-value\n   inject(key, defaultValue, treatDefaultAsFactory = false)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  export function inject(defaultValue?: unknown, treatDefaultAsFactory = false) { // TODO  // currentRenderingInstance å…¼å®¹å‡½æ•°å¼ç»„ä»¶  const instance = currentInstance || currentRenderingInstance; if (instance) { // #2400  // to support `app.use` plugins,  // fallback to appContext\u0026#39;s `provides` if the intance is at root  const provides = instance.parent == null // root  ? instance.vnode.appContext \u0026amp;\u0026amp; instance.vnode.appContext.provides : instance.parent.provides; if (provides \u0026amp;\u0026amp; (key as string | symbol) in provides) { // TS doesn\u0026#39;t allow symbol as index type  return provides[key as string]; } else if (arguments.length \u0026gt; 1) { return treatDefaultAsFactory \u0026amp;\u0026amp; isFunction(defaultValue) ? defaultValue() : defaultValue; } else if (__DEV__) { warn(`injection \u0026#34;${String(key)}\u0026#34; not found.`); } } else if (__DEV__) { warn(`inject() can only be used inside setup() or functional components.`); } }     inject å°±æ˜¯ä¸ªç®€å•çš„å–å€¼æ“ä½œè€Œå·²ã€‚\n å–å€¼æ¥æºéœ€è¦æ£€æµ‹æ˜¯ä¸æ˜¯æ ¹èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯æ ¹èŠ‚ç‚¹\n provides = instance.vnode.appContext.provides\n å¦åˆ™ï¼Œä½¿ç”¨ instance.parent.provides\n ç„¶åæ ¹æ® key å–å‡ºå€¼ provides[key]\n å¦‚æœæœ‰é»˜è®¤å€¼éœ€è¦è¿”å›é»˜è®¤å€¼?\n defaultValue æˆ– defaultValue()\n å±…ç„¶å¦‚æ­¤ç®€å•~~~ï¼Œè¿˜æ˜¯å…ˆçœ‹ä¸‹æ€ä¹ˆç”¨å§ï¼ï¼ï¼\n  test  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rcTest: { provide, inject, h, nodeOps, render, serialize, ref, nextTick }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const skey = Symbol(); const count = ref(1); const Provider = { setup() { provide(\u0026#34;foo\u0026#34;, \u0026#34;foo-p1\u0026#34;); // æ”¯æŒç¬¦å·å±æ€§å  provide(skey, 2); // å¯ä»¥æ˜¯å…¶ä»–ç±»å‹ ref, reactive, ...  provide(\u0026#34;count\u0026#34;, count); return () =\u0026gt; h(Provider2); }, }; const Provider2 = { setup() { provide(\u0026#34;foo\u0026#34;, \u0026#34;foo-p2\u0026#34;); provide(\u0026#34;baz\u0026#34;, \u0026#34;baz\u0026#34;); return () =\u0026gt; h(Middle); }, }; const Middle = { render: () =\u0026gt; h(Consumer), }; const Consumer = { setup() { const symb = inject(skey); // è¿™é‡Œ foo æ‹¿åˆ°çš„ä¼šæ˜¯ Provider2 çš„ foo å€¼  // å› ä¸º provides åŸå‹é“¾æ˜¯åŸºäºç»„ä»¶çˆ¶å­å…³ç³»æ¥åˆ›å»ºçš„  const foo = inject(\u0026#34;foo\u0026#34;); // é»˜è®¤å€¼  const bar = inject(\u0026#34;bar\u0026#34;, \u0026#34;bar\u0026#34;); // å› ä¸ºæ˜¯ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œçš„ count å°±æ˜¯ ref(1) è¿”å›çš„é‚£ä¸ª count  const count = inject(\u0026#34;count\u0026#34;); return () =\u0026gt; [symb, foo, bar, count.value].join(\u0026#34;,\u0026#34;); }, }; const root = nodeOps.createElement(\u0026#34;div\u0026#34;); render(h(Provider), root); let s = serialize(root); log(\u0026#34;1. root serialize, \u0026#34; + s); count.value++; await nextTick(); s = serialize(root); log(\u0026#34;2. root serialize, \u0026#34; + s); }; run();    1. root serialize, \u0026lt;div\u0026gt;2,foo-p2,bar,1\u0026lt;/div\u0026gt; undefined2. root serialize, \u0026lt;div\u0026gt;2,foo-p2,bar,2\u0026lt;/div\u0026gt;   ç»„ä»¶å±‚çº§å…³ç³»(çˆ¶-\u0026gt;å­)ï¼š Provider -\u0026gt; Middle -\u0026gt; Consumer\n åœ¨ provide(\u0026#39;foo\u0026#39;, 1) åˆ™åœ¨ Provider ç»„ä»¶çš„ provides ä¸­å¢åŠ äº† { foo: 1 } ,ç”±äº å­ç»„ä»¶çš„ provides æ˜¯æ²¿ç”¨æˆ–ç»§æ‰¿äº†çˆ¶çº§çš„ providesã€‚\n æ‰€ä»¥åœ¨å­ç»„ä»¶ Consumer ä¸­ç›´æ¥è°ƒç”¨ inject(\u0026#39;foo\u0026#39;) æ˜¯åœ¨ instance.provides é‡Œé¢å» æ‰¾è¿™ä¸ªå±æ€§å¯¹åº”çš„å€¼ï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™ä¸€ç›´åœ¨åŸå‹é“¾ä¸Šå¾€ä¸Šæ‰¾ï¼Œæœ€åæ‰¾åˆ°é¡¶çº§çˆ¶ç»„ä»¶ Provider ä¸Šæ‰¾åˆ°åŒ…å« \u0026#39;foo\u0026#39; å±æ€§ï¼Œåˆ™è¿”å›è¿™ä¸ªå€¼ã€‚\n æ‰€ä»¥ï¼Œ inject\u0026amp;provide çš„åº”ç”¨å…¶å®å°±æ˜¯åŸå‹é“¾çš„åº”ç”¨ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©çˆ¶ç»„ä»¶å¯ä»¥åƒå­ç»„ ä»¶æ³¨å…¥ä¸€äº›å€¼ã€‚\n   é‚£ä¹ˆä¸ºä»€ä¹ˆæ³¨å…¥çš„å€¼ç›´æ¥å˜æˆäº† \u0026lt;div\u0026gt;1\u0026lt;/div\u0026gt; å­èŠ‚ç‚¹äº†ï¼Ÿ\n       âœ¨ api computed   è¿™ä¸ª api æ˜¯å¯¹ reactivity\u0026gt;computed çš„ä¸€æ¬¡ç®€å•å°è£…ï¼Œè¯¦æƒ…è¯·ç›´æ¥æŸ¥çœ‹ reactivityå¯¹åº”çš„ computed ä¸€èŠ‚ã€‚\n ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11  export function computed\u0026lt;T\u0026gt;(getter: ComputedGetter\u0026lt;T\u0026gt;): ComputedRef\u0026lt;T\u0026gt; export function computed\u0026lt;T\u0026gt;( options: WritableComputedOptions\u0026lt;T\u0026gt; ): WritableComputedRef\u0026lt;T\u0026gt; export function computed\u0026lt;T\u0026gt;( getterOrOptions: ComputedGetter\u0026lt;T\u0026gt; | WritableComputedOptions\u0026lt;T\u0026gt; ) { const c = _computed(getterOrOptions as any) recordInstanceBoundEffect(c.effect) return c }      ğŸŒ€ api lifecycle   feat(add): api lifecycle init Â· gcclll/stb-vue-next@071d868 Â· GitHub\n feat(add): api lifecycle exports Â· gcclll/stb-vue-next@ee88856 Â· GitHub ç»„ä»¶å£°æ˜å‘¨æœŸ api ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  export function injectHook( type: LifecycleHooks, hook: Function \u0026amp; { __weh?: Function }, target: ComponentInternalInstance | null = currentInstance, prepend: boolean = false ): Function | undefined { // TODO  return } export const createHook = \u0026lt;T extends Function = () =\u0026gt; any\u0026gt;( lifecycle: LifecycleHooks ) =\u0026gt; (hook: T, target: ComponentInternalInstance | null = currentInstance) =\u0026gt; !isInSSRComponentSetup \u0026amp;\u0026amp; injectHook(lifecycle, hook, target) export const onBeforeMount = createHook(LifecycleHooks.BEFORE_MOUNT) export const onMounted = createHook(LifecycleHooks.MOUNTED) export const onBeforeUpdate = createHook(LifecycleHooks.BEFORE_UPDATE) export const onUpdated = createHook(LifecycleHooks.UPDATED) export const onUnMount = createHook(LifecycleHooks.UNMOUNTED)     å¦‚ä¸Šï¼Œæ‰€æœ‰çš„å£°æ˜å‘¨æœŸå‡½æ•°éƒ½æ˜¯é€šè¿‡ createHook -\u0026gt; injectHook å®ç°ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†çš„é‡ç‚¹ å°±æ˜¯è¿™ä¸ª injectHook(type, hook, targt, prepend) ã€‚\n åœ¨ createHook() é‡Œé¢æœ‰æ£€æµ‹æ˜¯ä¸æ˜¯ SSR ç¯å¢ƒï¼Œåªæœ‰é SSR ç¯å¢ƒä¸‹æ‰ä¼šæœ‰å£°æ˜å‘¨æœŸã€‚\n feat(add): api lifecycle injectHook Â· gcclll/stb-vue-next@6e9cd14 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  export function injectHook( type: LifecycleHooks, hook: Function \u0026amp; { __weh?: Function }, target: ComponentInternalInstance | null = currentInstance, prepend: boolean = false ): Function | undefined { if (target) { const hooks = target[type] || (target[type] = []); // å°† hook çš„æ‰§è¡Œå°è£…æˆä¸€ä¸ª error handling warpper å‡½æ•°ï¼Œå¹¶ä¸”ç¼“å­˜åˆ° hook.__weh  // ä¸Šï¼Œè¿™æ ·åœ¨è°ƒåº¦å™¨é‡Œé¢è°ƒç”¨çš„æ—¶å€™å¯ä»¥è¿›è¡Œå»é‡ï¼Œå› ä¸º scheduler é‡Œé¢æ‰§è¡Œçš„æ—¶å€™  // æœ‰å»é‡æ“ä½œï¼Œè¿™é‡Œçš„ __weh = \u0026#39;with error handling\u0026#39;  const wrappedHook = hook.__weh || (hook.__weh = (...args: unknown[]) =\u0026gt; { if (target.isUnmounted) { return; } // åœ¨æ‰€æœ‰çš„å£°æ˜å‘¨æœŸå‡½æ•°ä¸­éƒ½ disable tracking  // å› ä¸ºå®ƒä»¬æœ‰å¯èƒ½åœ¨ effects ä¸­è¢«è°ƒç”¨  pauseTracking(); // åœ¨ hook æ‰§è¡ŒæœŸé—´è®¾ç½® currentInstance = targt  // å‡è®¾ hook æ²¡æœ‰åŒæ­¥åœ°è§¦å‘å…¶ä»– hooksï¼Œå³åœ¨ä¸€ä¸ª hook é‡Œé¢åŒæ­¥è°ƒç”¨  // å¦ä¸€ä¸ªå£°æ˜å‘¨æœŸå‡½æ•°ï¼Ÿ  setCurrentInstance(target); const res = callWithAsyncErrorHandling(hook, target, type, args); setCurrentInstance(null); resetTracking(); return res; }); prepend ? hooks.unshift(wrappedHook) : hooks.push(wrappedHook); return wrappedHook; } else if (__DEV__) { // ...  } return; }      lifecycle hook å¯ä»¥åœ¨ setup() ä¸­æ‰§è¡Œ\n  è¿™é‡Œçš„æ‰€æœ‰å£°æ˜å‘¨æœŸå‡½æ•°éƒ½ä»¥äº‹ä»¶å½¢å¼å­˜åœ¨ï¼Œæ„å‘³ç€å¯ä»¥é€šè¿‡è¿™äº› api æ³¨å†Œå“ªä¸ªå£°æ˜å‘¨ æœŸéœ€è¦æ‰§è¡Œæ“ä½œçš„å‡½æ•°\n  åœ¨å£°æ˜å‘¨æœŸå‡½æ•°æ‰§è¡ŒæœŸé—´ä¸è¿›è¡Œ track æ”¶é›†ä¾èµ–æ“ä½œï¼Œå®ƒæœ‰å¯èƒ½åœ¨ setup() ä¸­è¿›è¡Œ\n   ä½¿ç”¨åŸç†ï¼šè°ƒç”¨ onXxx(fn, ins) å£°æ˜å‘¨æœŸå‡½æ•°æ—¶ï¼Œå®é™…ä¸Šåªæ˜¯å‘å½“å‰çš„å®ä¾‹ currentInstane[type] = [] ä¸Šæ³¨å†Œäº†ä¸€ä¸ªå›è°ƒå‡½æ•° fnã€‚æ¯”å¦‚ï¼š\n target.onMounted = [fn1, fn2] // target -\u0026gt; currentInstance å½“å‰å®ä¾‹\n ç„¶ååœ¨ç»„ä»¶ render/update è¿‡ç¨‹ä¸­æ ¹æ®å£°æ˜å‘¨æœŸçš„é˜¶æ®µè°ƒç”¨å¯¹åº”çš„ fns ã€‚\n test base  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rcTest: { render, nodeOps, onBeforeMount, h, serializeInner, onMounted, onBeforeUpdate, onUpdated, onBeforeUnmount, onBeforeUnmounted, ref, nextTick, }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const root = nodeOps.createElement(\u0026#34;div\u0026#34;); let called = 0; const s = () =\u0026gt; serializeInner(root); const fn = (stage) =\u0026gt; { called++; log(`\\n-\u0026gt; ${stage}, called = ${called}, serialize root = \u0026#34;${s()}\u0026#34; }`); // count.value++ }; const count = ref(0); const run = async () =\u0026gt; { const Comp = { setup() { // è¿™é‡Œæ•…æ„å°† onMounted æ”¾åœ¨å‰é¢  // ç»“æœä¼šå‘ç°è¿™ä¸ªè¿˜æ˜¯æœ€åæ‰æ‰§è¡Œ  onMounted(() =\u0026gt; fn(\u0026#34;onMounted\u0026#34;)); onBeforeMount(() =\u0026gt; fn(\u0026#34;onBeforeMount\u0026#34;)); onBeforeUpdate(() =\u0026gt; fn(\u0026#34;onBeforeUpdate\u0026#34;)); onUpdated(() =\u0026gt; fn(\u0026#34;onUpdated\u0026#34;)); return () =\u0026gt; h(\u0026#34;div\u0026#34;, count.value); }, }; render(h(Comp), root); count.value++; await nextTick(); log(\u0026#34;after set value...\u0026#34;); log(s()); }; run();    -\u0026gt; onBeforeMount, called = 1, serialize root = \u0026#34;\u0026#34; } -\u0026gt; onMounted, called = 2, serialize root = \u0026#34;\u0026lt;div\u0026gt;0\u0026lt;/div\u0026gt;\u0026#34; } undefined -\u0026gt; onBeforeUpdate, called = 3, serialize root = \u0026#34;\u0026lt;div\u0026gt;0\u0026lt;/div\u0026gt;\u0026#34; } -\u0026gt; onUpdated, called = 4, serialize root = \u0026#34;\u0026lt;div\u0026gt;1\u0026lt;/div\u0026gt;\u0026#34; } after set value... \u0026lt;div\u0026gt;1\u0026lt;/div\u0026gt;    test update   æµ‹è¯•åœ¨ onBeforeUpdate ä¸­æ‰§è¡Œå€¼æ›´æ–°æ“ä½œä¼šæ€æ ·ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rcTest: { render, nodeOps, onBeforeMount, h, serializeInner, onBeforeUpdate, onUpdated, ref, nextTick, }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const root = nodeOps.createElement(\u0026#34;div\u0026#34;); let called = 0; const s = () =\u0026gt; serializeInner(root); const fn = (stage) =\u0026gt; { called++; log(`\\n-\u0026gt; ${stage}, called = ${called}, serialize root = \u0026#34;${s()}\u0026#34; }`); count.value++ }; const count = ref(0); const run = async () =\u0026gt; { const Comp = { setup() { onUpdated(() =\u0026gt; log(\u0026#39;-\u0026gt; onUpdated, count.value = \u0026#39; + count.value + \u0026#39;, \u0026#39; + s())) onBeforeUpdate(() =\u0026gt; fn(\u0026#34;onBeforeUpdate\u0026#34;)); return () =\u0026gt; h(\u0026#34;div\u0026#34;, count.value); }, }; render(h(Comp), root); count.value++; await nextTick(); log(\u0026#34;after set value...\u0026#34;); log(s()); }; run();    undefined -\u0026gt; onBeforeUpdate, called = 1, serialize root = \u0026#34;\u0026lt;div\u0026gt;0\u0026lt;/div\u0026gt;\u0026#34; } -\u0026gt; onUpdated, count.value = 2, \u0026lt;div\u0026gt;2\u0026lt;/div\u0026gt; after set value... \u0026lt;div\u0026gt;2\u0026lt;/div\u0026gt;     æœ€å count.value æ¸²æŸ“å‡ºæ¥æ˜¯ 2ï¼Ÿ\n     test unmount  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rcTest: { render, nodeOps, onBeforeMount, h, serializeInner, onBeforeUpdate, onUpdated, onBeforeUnmount, onUnmounted, onMounted, ref, nextTick, }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const root = nodeOps.createElement(\u0026#34;div\u0026#34;); let called = 0; const s = () =\u0026gt; serializeInner(root); const fn = (stage) =\u0026gt; { called++; log(`\\n-\u0026gt; ${stage}, called = ${called}, serialize root = \u0026#34;${s()}\u0026#34; }`); }; const toggle = ref(true); const run = async () =\u0026gt; { const Comp = { setup() { return () =\u0026gt; (toggle.value ? h(Child) : null); }, }; const Child = { setup() { onBeforeUnmount(() =\u0026gt; fn(\u0026#34;onBeforeUnmount\u0026#34;)); onUnmounted(() =\u0026gt; fn(\u0026#34;onUnmounted\u0026#34;)); onMounted(() =\u0026gt; { // è¿™ç­‰äºæ˜¯ç­‰ç»„ä»¶åŠ è½½å®Œæˆä¹‹ååœ¨æ³¨å†Œ unmount  onBeforeUnmount(() =\u0026gt; log(\u0026#34;-\u0026gt; onBeforeUnmount called in onMounted\u0026#34;)); }); return () =\u0026gt; h(\u0026#34;div\u0026#34;); }, }; render(h(Comp), root); toggle.value = false; await nextTick(); log(\u0026#34;\\nafter set value...\u0026#34;); log(s()); }; run();    undefined -\u0026gt; onBeforeUnmount, called = 1, serialize root = \u0026#34;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026#34; } -\u0026gt; onBeforeUnmount called in onMounted -\u0026gt; onUnmounted, called = 2, serialize root = \u0026#34;\u0026lt;!----\u0026gt;\u0026#34; } after set value... \u0026lt;!----\u0026gt;    test order   æµ‹è¯•å£°æ˜å‘¨æœŸå‡½æ•°æ‰§è¡Œé¡ºåº(å’Œè°ƒç”¨é¡ºåºæ— å…³)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rcTest: { render, nodeOps, h, serializeInner, onBeforeMount, onMounted, onBeforeUpdate, onUpdated, onBeforeUnmount, onUnmounted, ref, nextTick, }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const root = nodeOps.createElement(\u0026#34;div\u0026#34;); let calls = []; const count = ref(0); const run = async () =\u0026gt; { const Root = { setup() { onBeforeMount(() =\u0026gt; calls.push(\u0026#39;root onBeforeMount\u0026#39;)) onMounted(() =\u0026gt; calls.push(\u0026#39;root onMounted\u0026#39;)) onBeforeUpdate(() =\u0026gt; calls.push(\u0026#39;root onBeforeUpdate\u0026#39;)) onUpdated(() =\u0026gt; calls.push(\u0026#39;root onUpdated\u0026#39;)) onBeforeUnmount(() =\u0026gt; calls.push(\u0026#39;root onBeforeUnmount\u0026#39;)) onUnmounted(() =\u0026gt; calls.push(\u0026#39;root onUnmounted\u0026#39;)) return () =\u0026gt; h(Mid, { count: count.value }); }, }; const Mid = { setup(props) { onBeforeMount(() =\u0026gt; calls.push(\u0026#39;Mid onBeforeMount\u0026#39;)) onMounted(() =\u0026gt; calls.push(\u0026#39;Mid onMounted\u0026#39;)) onBeforeUpdate(() =\u0026gt; calls.push(\u0026#39;Mid onBeforeUpdate\u0026#39;)) onUpdated(() =\u0026gt; calls.push(\u0026#39;Mid onUpdated\u0026#39;)) onBeforeUnmount(() =\u0026gt; calls.push(\u0026#39;Mid onBeforeUnmount\u0026#39;)) onUnmounted(() =\u0026gt; calls.push(\u0026#39;Mid onUnmounted\u0026#39;)) return () =\u0026gt; h(Child, { count: props.count }); }, }; const Child = { setup(props) { onBeforeMount(() =\u0026gt; calls.push(\u0026#39;Child onBeforeMount\u0026#39;)) onMounted(() =\u0026gt; calls.push(\u0026#39;Child onMounted\u0026#39;)) onBeforeUpdate(() =\u0026gt; calls.push(\u0026#39;Child onBeforeUpdate\u0026#39;)) onUpdated(() =\u0026gt; calls.push(\u0026#39;Child onUpdated\u0026#39;)) onBeforeUnmount(() =\u0026gt; calls.push(\u0026#39;Child onBeforeUnmount\u0026#39;)) onUnmounted(() =\u0026gt; calls.push(\u0026#39;Child onUnmounted\u0026#39;)) return () =\u0026gt; h(\u0026#39;div\u0026#39;, props.count); }, }; render(h(Root), root) log([\u0026#39;\\n0. before update value \u0026gt;\u0026#39;, calls]) calls.length = 0 // update  count.value++ await nextTick() log([\u0026#39;\\n1. update value \u0026gt;\u0026#39;, calls]) calls.length = 0 // unmount  render(null, root) log([\u0026#39;\\n2. unmount \u0026gt;\u0026#39;, calls]) calls.length = 0 }; run();    0. before update value \u0026gt; [ \u0026#39;root onBeforeMount\u0026#39;, \u0026#39;Mid onBeforeMount\u0026#39;, \u0026#39;Child onBeforeMount\u0026#39;, \u0026#39;Child onMounted\u0026#39;, \u0026#39;Mid onMounted\u0026#39;, \u0026#39;root onMounted\u0026#39; ] undefined 1. update value \u0026gt; [ \u0026#39;root onBeforeUpdate\u0026#39;, \u0026#39;Mid onBeforeUpdate\u0026#39;, \u0026#39;Child onBeforeUpdate\u0026#39;, \u0026#39;Child onUpdated\u0026#39;, \u0026#39;Mid onUpdated\u0026#39;, \u0026#39;root onUpdated\u0026#39; ] 2. unmount \u0026gt; [ \u0026#39;root onBeforeUnmount\u0026#39;, \u0026#39;Mid onBeforeUnmount\u0026#39;, \u0026#39;Child onBeforeUnmount\u0026#39;, \u0026#39;Child onUnmounted\u0026#39;, \u0026#39;Mid onUnmounted\u0026#39;, \u0026#39;root onUnmounted\u0026#39; ]   ä»ä¸Šé¢çš„ç»“æœå¯çŸ¥æ•´ä¸ªç»„ä»¶å£°æ˜å‘¨æœŸå‘ç”Ÿè¿‡ç¨‹ã€‚\n  ç»„ä»¶ mount é¡ºåºï¼Œ child -\u0026gt; mid -\u0026gt; compï¼Œå­ç»„ä»¶ -\u0026gt; â€¦ -\u0026gt; çˆ¶ç»„ä»¶\n  ç»„ä»¶ update é¡ºåºï¼Œ child -\u0026gt; mid -\u0026gt; comp, å­ç»„ä»¶ -\u0026gt; â€¦ -\u0026gt; çˆ¶ç»„ä»¶\n  ç»„ä»¶ unmount é¡ºåºï¼Œ child -\u0026gt; mid -\u0026gt; comp, å­ç»„ä»¶ -\u0026gt; â€¦ -\u0026gt; çˆ¶ç»„ä»¶\n  ç»„ä»¶çš„ before å£°æ˜å‘¨æœŸè§¦å‘é¡ºåºæ˜¯ï¼š child -\u0026gt; mid -\u0026gt; comp å®Œæˆä¹‹åçš„é¡ºåºåˆšå¥½ç›¸åã€‚\n  test render track \u0026amp; trigger  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rcTest: { render, nodeOps, h, serializeInner, ref, nextTick, reactive, onRenderTracked, onRenderTriggered }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = () =\u0026gt; { const events = []; let called = 0; const fn = (e) =\u0026gt; { called++; events.push(e); }; const obj = reactive({ foo: 1, bar: 2 }); const Comp = { setup() { onRenderTriggered(fn) onRenderTracked(fn); return () =\u0026gt; h(\u0026#34;div\u0026#34;, [obj.foo, \u0026#34;bar\u0026#34; in obj, Object.keys(obj).join(\u0026#34;\u0026#34;)]); }, }; render(h(Comp), nodeOps.createElement(\u0026#39;div\u0026#39;)) log(\u0026#39;called = \u0026#39; + called) // 3  log(\u0026#39;\u0026gt;\u0026gt; track events\u0026#39;) events.forEach(e =\u0026gt; log(f(e, [\u0026#39;target\u0026#39;, \u0026#39;type\u0026#39;, \u0026#39;key\u0026#39;]))) events.length = 0 log(\u0026#39;\u0026gt;\u0026gt; trigger events\u0026#39;) obj.foo++ events.forEach(e =\u0026gt; log(f(e, [\u0026#39;target\u0026#39;, \u0026#39;type\u0026#39;, \u0026#39;key\u0026#39;]))) events.length = 0 delete obj.bar events.forEach(e =\u0026gt; log(f(e, [\u0026#39;target\u0026#39;, \u0026#39;type\u0026#39;, \u0026#39;key\u0026#39;]))) events.length = 0 obj.baz = 3 events.forEach(e =\u0026gt; log(f(e, [\u0026#39;target\u0026#39;, \u0026#39;type\u0026#39;, \u0026#39;key\u0026#39;]))) events.length = 0 }; run();    called = 3 \u0026gt;\u0026gt; track events { target: { foo: 1, bar: 2 }, type: \u0026#39;get\u0026#39;, key: \u0026#39;foo\u0026#39; } { target: { foo: 1, bar: 2 }, type: \u0026#39;has\u0026#39;, key: \u0026#39;bar\u0026#39; } { target: { foo: 1, bar: 2 }, type: \u0026#39;iterate\u0026#39;, key: Symbol(iterate) } \u0026gt;\u0026gt; trigger events { target: { foo: 2, bar: 2 }, key: \u0026#39;foo\u0026#39;, type: \u0026#39;set\u0026#39; } { target: { foo: 2 }, key: \u0026#39;bar\u0026#39;, type: \u0026#39;delete\u0026#39; } { target: { foo: 2, baz: 3 }, key: \u0026#39;baz\u0026#39;, type: \u0026#39;add\u0026#39; } undefined      ğŸ¦‰ api define component  1 2 3 4  // implementation, close to no-op export function defineComponent(options: unknown) { return isFunction(options) ? { setup: options, name: options.name } : options }      ğŸ†˜ api setup helpers   feat(add): api setup helpers Â· gcclll/stb-vue-next@3e71787 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  // runtime-core/src/apiSetupHelpers.ts // implementation export function defineProps() { if (__DEV__) { warn( `defineProps() is a compiler-hint helper that is only usable inside ` + `\u0026lt;script setup\u0026gt; of a single file component. Its arguments should be ` + `compiled away and passing it at runtime has no effect.` ); } return null as any; } export function defineEmit() { if (__DEV__) { warn( `defineEmit() is a compiler-hint helper that is only usable inside ` + `\u0026lt;script setup\u0026gt; of a single file component. Its arguments should be ` + `compiled away and passing it at runtime has no effect.` ); } return null as any; } export function useContext(): SetupContext { const i = getCurrentInstance()!; if (__DEV__ \u0026amp;\u0026amp; !i) { warn(`useContext() called without active instance.`); } return i.setupContext || (i.setupContext = createSetupContext()); }     è¿™é‡ŒåŒ…å«ä¸‰ä¸ªå‡½æ•°ï¼Œå…¶ä¸­ defineProps\u0026amp;defineEmit éƒ½æ˜¯ä¸”åªä¼šåœ¨ \u0026lt;script setup\u0026gt; é‡Œ é¢ä½¿ç”¨ï¼Œä»–ä»¬çš„ä½œç”¨åªæ˜¯ç”¨äº compiler-sfc åŒ…ä¸­åœ¨ babel/parser è§£æè¯­æ³•æ ‘æœŸé—´ï¼Œ ç”¨æ¥æ ‡è¯†ä»–ä»¬æ˜¯ propsæˆ– emits çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åç»™ä»–ä»¬çš„å‚æ•°ä¼šè¢«å½“åš props å’Œ emits åˆå¹¶åˆ°æœ€ç»ˆ export å‡ºå»çš„å¯¹åº”å±æ€§ä¸Šï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ª define å‡½æ•°å®é™…ä¸Šä»€ä¹ˆéƒ½æ²¡åšã€‚\n çœ‹å®ä¾‹å§ -\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compile, f, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { content } = compile(` \u0026lt;script setup\u0026gt; import { defineProps, defineEmit } from \u0026#39;vue\u0026#39; ref: value = 1 const myEmit = defineEmit([\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;]) const props = defineProps({ fox: String, foy: () =\u0026gt; baz \u0026gt; 1 }) \u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; export default { props: { box: 2 } } \u0026lt;/script\u0026gt; `) log(content)    import { ref as _ref } from \u0026#39;vue\u0026#39; function setup(__props, { emit: myEmit }) { const props = __props const value = _ref(1) return { value, myEmit, props } } const __default__ = { props: { box: 2 } } export default /*#__PURE__*/ Object.assign(__default__, { expose: [], props: { fox: String, foy: () =\u0026gt; baz \u0026gt; 1 }, emits: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;], setup }) undefined   æˆ‘ä»¬æŠŠä¸Šé¢ç»“æœæ ¼å¼åŒ–ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  import { ref as _ref } from \u0026#34;vue\u0026#34;; function setup(__props, { emit: myEmit }) { const props = __props; const value = _ref(1); return { value, myEmit, props }; } const __default__ = { props: { box: 2, }, }; export default /*#__PURE__*/ Object.assign(__default__, { expose: [], props: { fox: String, foy: () =\u0026gt; baz \u0026gt; 1, }, emits: [\u0026#34;foo\u0026#34;, \u0026#34;bar\u0026#34;], setup, });     ä»ä¸Šé¢çš„ä»£ç å¯å‘ç°ï¼š\n  defineProps æœ€åè¢«åˆå¹¶æˆä¸€ä¸ª props å¯¹è±¡ï¼Œå¹¶ä¸”ä¼šå’Œ \u0026lt;script\u0026gt; ä¸­çš„ export default ä¸­çš„ props è¿›è¡Œå†æ¬¡åˆå¹¶ï¼Œå¹¶ä¸”è¿™ç§åˆå¹¶å±äºç®€å•çš„æ›¿æ¢æ“ä½œ\n æ‰€ä»¥å¦‚æœ defineProps å’Œ script ä¸­åŒæ—¶å­˜åœ¨ props çš„æƒ…å†µæœ€ç»ˆ \u0026lt;script\u0026gt; ä¸­ çš„ props ä¼šè¢«ä¸¢å¼ƒæ‰ï¼Œæ‰€ä»¥å°½é‡é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿã€‚\n  defineEmit ä¸­çš„å±æ€§ä¼šè¢«åˆå¹¶åˆ° emits ä¸Š\n  æ›´å¤šæœ‰å…³ \u0026lt;script setup\u0026gt; çš„å†…å®¹è¯·æŸ¥çœ‹ compiler-sfc åŒ…çš„åˆ†æ -\u0026gt;\n useContext() æ˜¯è·å–å½“å‰å®ä¾‹çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿™ä¸ªéœ€è¦ç»§ç»­å®ç°å¤æ‚çš„ render éƒ¨åˆ†æ‰ å¯èƒ½ä¼šä½¿ç”¨åˆ°ã€‚\n   ğŸŒŠ TODO api async comopnent   feat(add): async component Â· gcclll/stb-vue-next@cb4474a Â· GitHub\n å®šä¹‰å¼‚æ­¥ç»„ä»¶(defineAsyncComponent(source))ã€‚\n æ–°å¢åˆå§‹åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  export const isAsyncWrapper = (i: ComponentInternalInstance | VNode) =\u0026gt; !!(i.type as ComponentOptions).__asyncLoader; export function defineAsyncComponent\u0026lt; T extends Component = { new (): ComponentPublicInstance } \u0026gt;(source: AsyncComponentLoader\u0026lt;T\u0026gt; | AsyncComponentOptions\u0026lt;T\u0026gt;): T { // 1. TODO retry å°è£…  //  // 2. TODO å‡½æ•°å°è£…  //  // 3. TODO è¿”å›ç»„ä»¶ï¼Œæ£€æµ‹å¦‚æœæ˜¯å¯¹è±¡ç›´æ¥è¿”å›ï¼Œor å‡½æ•°å½“åš setup() å‡½æ•°å¤„ç†  return defineComponent({} as any) as any; }     é€šè¿‡æœç´¢ __asyncLoader åªåœ¨ hydration.ts ä¸­æœ‰ä½¿ç”¨åˆ°ï¼Œè€Œè¿™ä¸ªè²Œä¼¼åˆå’Œ SSR æœåŠ¡ ç«¯æ¸²æŸ“ç”±å…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆæš‚æ—¶ä¸ç»§ç»­äº†ï¼Œå…ˆå®Œæˆ renderer.ts çš„ render å‡½æ•°éƒ¨åˆ†ï¼Œç„¶ ååœ¨å®ç°äº† SSR + hydration ä¹‹åå†å›å¤´æ¥ç»§ç»­ã€‚\n implementation(init)   feat(add): async component-\u0026gt;load Â· gcclll/stb-vue-next@bd6e903 Â· GitHub\n feat: async component pause await render Â· gcclll/stb-vue-next@1c73e72 Â· GitHub å®ç°ä¸»è¦åˆ†å‡ æ­¥ï¼š\n  å°è£… retry() é‡è¯•å‡½æ•°\n  load() å‡½æ•°ï¼Œåˆ†æ”¯ source.loader() å¼‚æ­¥å‡½æ•°\n  ç»„è£…ç»„ä»¶è¿”å› defineComponent({__asyncLoader: load, setup() {...}, ...})\n å‰é¢ 1, 2 éƒ½æ˜¯å¯¹ source.loader è¿›è¡Œå°è£…å¤„ç†ï¼Œè¿™ä¸€æ­¥æ˜¯çœŸæ­£çš„åˆ›å»ºå¼‚æ­¥ç»„ä»¶ã€‚\n defineComponent(option) å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯æ£€æµ‹ option å¦‚æœæ˜¯å‡½æ•°å½“åš\n {setup: option, name: option.name} å¤„ç†ï¼Œå¦åˆ™ç›´æ¥è¿”å› option\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { nextTick, h, ref, defineAsyncComponent }, rcTest: { createApp, nodeOps, serializeInner: si }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const timeout = (n) =\u0026gt; new Promise((r) =\u0026gt; setTimeout(r, n)); let resolve; const Foo = defineAsyncComponent(() =\u0026gt; new Promise((r) =\u0026gt; (resolve = r))); const toggle = ref(true); const root = nodeOps.createElement(\u0026#34;div\u0026#34;); createApp({ render: () =\u0026gt; ( console.log(toggle.value, \u0026#34;xxx\u0026#34;), toggle.value ? h(Foo) : null ), }).mount(root); console.log(si(root)); // æ‰‹åŠ¨ resolve, è§¦å‘ loader().then(comp =\u0026gt; { ... })  resolve(() =\u0026gt; \u0026#34;resolved\u0026#34;); await timeout(); si(root); // åˆ°è¿™é‡Œ component å·²ç» resolved äº†  toggle.value = false; await nextTick(); si(root); // -\u0026gt; null  toggle.value = true; await nextTick(); si(root); // -\u0026gt; resolved }; run();    true xxx resolved comp before loaded.value = false \u0026lt;!----\u0026gt; undefined async comp load ok, resolved      ğŸ”¥ render function   ç¯‡å¹…å¤ªé•¿ï¼Œå¦èµ·å•ç‹¬æ–‡ç«  -\u0026gt; Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render\n  ğŸš’ scheduler ä»»åŠ¡è°ƒåº¦æœºåˆ¶   è®©æˆ‘ä»¬è·Ÿç€ scheduler.spec.ts æµ‹è¯•ç”¨ä¾‹æ¥é€æ­¥å±æ€§ scheduler çš„è°ƒåº¦æœºåˆ¶ã€‚\n åœ¨åšè¿™ä¸ªä¹‹å‰å…ˆæŠŠ scheduler.ts ä¸­é€»è¾‘ä»£ç å…¨æ¸…ç©ºï¼Œè¿™ä¸ªæ–‡ä»¶è¿˜æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„\n feat: rc-\u0026gt;reset scheduler.ts Â· gcclll/stb-vue-next@a54cc00 Â· GitHub\n æˆ‘ä»¬ä»é›¶å¼€å§‹ä¸€æ­¥æ­¥æ¥åˆ†æå®ç°ã€‚\n  è¿™éƒ¨åˆ†åŒ…å«ä¸‰ç§ä»»åŠ¡çš„ flush é€»è¾‘ä»£ç ï¼š\n  queue jobs -\u0026gt; flushIndex -\u0026gt; queue[] -\u0026gt; queueJob() -\u0026gt; queueFlush() -\u0026gt; flushJobs()\n  pre jobs -\u0026gt; preFlushIndex -\u0026gt; pendingPreFlushCbs[] -\u0026gt; activePreFlushCbs[] -\u0026gt; queuePreFlushCb() -\u0026gt; flushPreFlushCbs() -\u0026gt; flushJobs()\n  TODO post jobs -\u0026gt; â€¦\n  nextTick   feat(add): rc-\u0026gt;scheduler -\u0026gt; nextTick Â· gcclll/stb-vue-next@32b4827 Â· GitHub\n åœ¨ queue æ‰€æœ‰é˜Ÿåˆ—æ¸…ç©ºä¹‹åæ‰§è¡Œçš„ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰é‡è¦å…³è”çš„ä¸¤ä¸ªå˜é‡ï¼š\n  resolvedPromiseï¼Œä¸€ä¸ªç©ºçš„ promise then\n  currentFlushPromiseï¼Œå½“ queue é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åè¿”å›çš„ä¸€ä¸ª promise\n æ˜¯çš„ï¼Œæ˜¯æ‰€æœ‰ queue jobs å®Œæˆä¹‹åï¼Œå› ä¸º flushJobs å‡½æ•°é‡Œé¢éƒ½æ˜¯åŒæ­¥æ“ä½œï¼Œé‡è¦ä»£ ç ï¼š\n1 2 3 4 5 6 7  for (flushIndex = 0; flushIndex \u0026lt; queue.length; flushIndex++) { const job = queue[flushIndex]; if (job) { // TODO DEV -\u0026gt; æ£€æŸ¥é€’å½’æ›´æ–°é—®é¢˜  callWithErrorHandling(job, null, ErrorCodes.SCHEDULER); } }       æ‰€ä»¥ nextTick ä»»åŠ¡æ€»æ˜¯åœ¨ queue jobs æ‰€æœ‰ä»»åŠ¡å®Œæˆä¹‹åæ‰§è¡Œã€‚\n 1 2 3 4 5 6 7 8 9 10 11  const resolvedPromise: Promise\u0026lt;any\u0026gt; = Promise.resolve(); // å½“å‰æ­£åœ¨è¢«æ‰§è¡Œçš„ promise ä»»åŠ¡ let currentFlushPromise: Promise\u0026lt;void\u0026gt; | null = null; export function nextTick( this: ComponentPublicInstance | void, fn?: () =\u0026gt; void ): Promise\u0026lt;void\u0026gt; { const p = currentFlushPromise || resolvedPromise; return fn ? p.then(this ? fn.bind(this) : fn) : p; }     å‡½æ•°ä½œç”¨ï¼šåœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„ job promise ä¹‹åæ‰§è¡Œ nextTick çš„ä»»åŠ¡ï¼Œç­‰äºè¯´ nextTick å±äºä¸ªæ’é˜Ÿä»»åŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const calls = []; const pr = Promise.resolve(); const dummyThen = Promise.resolve().then(); const job1 = () =\u0026gt; calls.push(\u0026#34;job1\u0026#34;); const job2 = () =\u0026gt; calls.push(\u0026#34;job2\u0026#34;); nextTick(job1); job2(); log([\u0026#34;\\nbefore await, \u0026#34;, calls.length, \u0026#34;\\n\u0026#34;]); await dummyThen; log([\u0026#34;\\nafter await, \u0026#34;, calls.length, \u0026#34;\\n\u0026#34;]); log(calls.join(\u0026#34;-\u0026#34;)); }; run();    before await, 1 after await, 2 job2-job1   Tip. nextTick() å¼‚æ­¥ä»£ç æ‰§è¡Œï¼Œç»è¿‡ babel è½¬æ¢åçš„ä»£ç ï¼Œè¯·æŸ¥çœ‹ nextTick question\n   queueJob   feat(add): rc-\u0026gt;scheduler-\u0026gt;queueJob Â· gcclll/stb-vue-next@eb33b40 Â· GitHub\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  export function queueJob(job: SchedulerJob) { // the dedupe search uses the startIndex argument of Array.includes()  // by default the search index includes the current job that is being run  // so it cannot recursively trigger itself again.  // if the job is a watch() callback, the search will start with a +1 index to  // allow it recursively trigger itself - it is the user\u0026#39;s responsibility to  // ensure it doesn\u0026#39;t end up in an infinite loop.  if ( (!queue.length || !queue.includes( job, isFlushing \u0026amp;\u0026amp; job.allowRecurse ? flushIndex + 1 : flushIndex )) \u0026amp;\u0026amp; job !== currentPreFlushParentJob ) { queue.push(job) queueFlush } } function queueFlush() { if (!isFlushing \u0026amp;\u0026amp; !isFlushPending) { isFlushPending = true currentFlushPromise = resolvedPromise.then(flushJobs) } } // è¯·æŸ¥çœ‹ä¸‹ä¸€èŠ‚çš„å®ç° function flushJobs(seen?: CountMap) { // TODO }     éœ€è¦ flushJobs æ”¯æŒï¼Œè¯·åˆ° flushJobs(ğŸ‘‡) ä¸€èŠ‚æŸ¥çœ‹æµ‹è¯•æƒ…å†µã€‚\n  flushJobs   feat(add): rc-\u0026gt;scheduler-\u0026gt;flushJobs function Â· gcclll/stb-vue-next@e23be11 Â· GitHub\n  isFlushPending, isFlushing æ ‡è¯†é‡ç½®\n  flushPreFlushCbs, å¯¹ pre ç±»å‹çš„ jobs è¿›è¡Œ flush æ“ä½œï¼Œæœ‰å…³å‡½æ•° flushPreFlushCbs(flushå‡½æ•°) å’Œ queuePreFlushCb(å…¥åˆ—å‡½æ•°)\n  flush ä¹‹å‰è¿›è¡Œæ’åº\n  try -\u0026gt; callWithErrorHandling æ‰§è¡Œä»»åŠ¡å›è°ƒ\n  finally -\u0026gt; é‡ç½®ï¼Œæ¸…ç©º queue é˜Ÿåˆ—å†…å®¹å’Œæ ‡è¯†\n  TODO flushPostFlushCbs, å¯¹ post ç±»å‹çš„ jobs è¿›è¡Œ flush æ“ä½œï¼Œæœ‰å…³å‡½æ•° flushPostFlushCbs å’Œ queuePostFlushCb\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  function flushJobs(seen?: CountMap) { isFlushPending = false; isFlushing = true; if (__DEV__) { seen = seen || new Map(); } // flushPreFLushCbs(seen)ï¼Œé»˜è®¤çš„ job ç±»å‹  // flush ä¹‹å‰å¯¹ queue æ’åº  // 1. ç»„ä»¶æ›´æ–°é¡ºåºï¼šparent -\u0026gt; childï¼Œå› ä¸º parent æ€»æ˜¯åœ¨ child ä¹‹å‰  // è¢«åˆ›å»ºï¼Œå› æ­¤ parent render effect æœ‰æ›´ä½çš„ä¼˜å…ˆçº§æ•°å­—(æ•°å­—è¶Šå°è¶Šå…ˆåˆ›å»ºï¼Ÿ)  // 2. å¦‚æœç»„ä»¶åœ¨ parent æ›´æ–°æœŸé—´è¢«å¸è½½äº†ï¼Œé‚£ä¹ˆå®ƒçš„æ›´æ–°éƒ½ä¼šè¢«å¿½ç•¥æ‰  queue.sort((a, b) =\u0026gt; getId(a) - getId(b)); // å¼€å§‹ flush  try { for (flushIndex = 0; flushIndex \u0026lt; queue.length; flushIndex++) { const job = queue[flushIndex]; if (job) { // TODO DEV -\u0026gt; æ£€æŸ¥é€’å½’æ›´æ–°é—®é¢˜  callWithErrorHandling(job, null, ErrorCodes.SCHEDULER); } } } finally { // æƒ…å†µé˜Ÿåˆ—  flushIndex = 0; queue.length = 0; // TODO flush `post` ç±»å‹çš„ flush cbs  isFlushing = false; currentFlushPromise = null; // TDOO ä»£ç æ‰§è¡Œåˆ°å½“å‰ tick çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½æœ‰æ–°çš„ job åŠ å…¥  // some postFlushCb queued jobs!  // keep flushing until it drains.  } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const calls = []; const job1 = () =\u0026gt; { // #1  log.newline(\u0026#34;job1 running\u0026#34;); calls.push(\u0026#34;job1\u0026#34;); }; const job2 = () =\u0026gt; { // #2  log.newline(\u0026#34;job2 running\u0026#34;); calls.push(\u0026#34;job2\u0026#34;); }; // æ”¯æŒå»é‡  queueJob(job1); // #3  queueJob(job2); // #4  queueJob(job1); queueJob(job2); log(\u0026#34;before await \u0026#34; + calls); // #5  await nextTick(); // #6  log(\u0026#34;after await \u0026#34; + calls); // #7 }; run();    before await undefined job1 running job2 running after await job1,job2   å¦‚æœåœ¨æ²¡æœ‰ #6 çš„æƒ…å†µä¸‹ï¼Œåœ¨æ‰€æœ‰ Log ä¹‹åä¼šç«‹å³æ‰§è¡Œ queue jobsã€‚\n1 2 3 4 5 6  function queueFlush() { if (!isFlushing \u0026amp;\u0026amp; !isFlushPending) { isFlushPending = true; currentFlushPromise = resolvedPromise.then(flushJobs); } }     è¿™é‡Œ nextTick() è°ƒç”¨å¹¶æ²¡æœ‰ä¼ é€’ fn ï¼Œå› æ­¤ await nextTick() åœ¨è¿™é‡Œçš„ä½œç”¨å°±æ˜¯ç­‰ resolvedPromise æ‰§è¡Œå®Œæˆ(æ­¤æ—¶å¹¶æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ promise)\n const resolvedPromise: Promise\u0026lt;any\u0026gt; = Promise.resolve()\n å†æ‰§è¡Œåé¢çš„ä»£ç ã€‚\n queueJob å‡½æ•°åˆ†ä¸ºä¸¤æ­¥ï¼š\n  push æ”¶é›†ä»»åŠ¡ queue.push(job) ï¼ŒåŒæ­¥æ‰§è¡Œ\n  éšåç«‹å³è°ƒç”¨ queueFlush() åˆ·æ‰ä»»åŠ¡ï¼Œä»»åŠ¡å¼‚æ­¥ flush\n  åœ¨è¿™ä¸ªå®ä¾‹ä¸­ï¼ŒæŒ‰ç…§åŒæ­¥æ‰§è¡Œé¡ºåºï¼Œ\n  queueJob(job1) æ‰§è¡Œï¼Œå°† job1 -\u0026gt; push -\u0026gt; queue ä¸­ï¼Œ queueFlush ä¸­çš„ promise ç­‰å¾…\n  queueJob(job2) æ‰§è¡Œï¼Œå°† job2 -\u0026gt; push -\u0026gt; queue ä¸­ï¼Œ queueFlush ä¸­çš„ promise ç»§ç»­ç­‰å¾…\n  log before æ‰§è¡Œï¼Œç”±äº job è™½ç„¶å·²ç»åœ¨ queue ä¸­äº†ï¼Œä½†æ˜¯éœ€è¦ç­‰å¾… queueFlush å» å¼‚æ­¥æ‰§è¡Œä»–ä»¬ï¼Œæ‰€ä»¥è¿™é‡Œ calls ä¾æ—§æ˜¯ç©ºçš„\n  await nextTick() å¼‚æ­¥æ“ä½œ\n è¿™ä¸€å¥ç›®çš„åªæ˜¯ä¸ºäº†è®©åé¢çš„ log åœ¨ job1,job2 åé¢æ‰§è¡Œã€‚\n1 2  const p = currentFlushPromise || resolvedPromise; return fn ? p.then(this ? fn.bind(this) : fn) : p;     nextTick ä¼šåœ¨åˆšåˆšæ‰§è¡Œå®Œæ¯•çš„ promise åé¢å–æ‰§è¡Œåé¢çš„ä»»åŠ¡ï¼Œæ‰€ä»¥ log after è‚¯å®šæ˜¯åäº job1,job2 çš„æ‰§è¡Œçš„ã€‚\n  æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¼€å§‹è¿›å…¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œï¼Œç”±äº job1,job2 å…ˆå…¥é˜Ÿåˆ—ï¼Œåœ¨äº‹ä»¶å¾ª ç¯ä¸­ä¼šå…ˆäº log after æ‰§è¡Œï¼Œç„¶ååœ¨æ‰§è¡Œ log afterï¼Œæ‰€ä»¥å°±æœ‰äº†ä¸Šé¢çš„è¾“å‡ºç»“æœã€‚\n   å®ä¾‹æ‰§è¡Œè„‘å›¾ï¼š\n   queueJob while flushing   å½“ queue ä¸­ jobs æ­£åœ¨è¢«æ‰§è¡Œçš„æ—¶å€™è°ƒç”¨ queueJob è¿›å…¥æ–°çš„ä»»åŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const calls = []; const job1 = () =\u0026gt; { calls.push(\u0026#34;job1\u0026#34;); // job2 ä»»åŠ¡ä¼šåœ¨ job1 æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™åŠ å…¥åˆ°äº† queue  // ä½†æ˜¯å®ƒçš„æ‰§è¡Œéœ€ç­‰åˆ° queue ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œ  // å› ä¸ºä»»åŠ¡æ”¶é›†æ˜¯åŒæ­¥çš„ï¼Œä»»åŠ¡æ‰§è¡Œæ˜¯å¼‚æ­¥çš„ï¼Œè€Œ queue flush æ“ä½œåˆæ˜¯åŒæ­¥çš„  queueJob(job2); }; const job2 = () =\u0026gt; calls.push(\u0026#34;job2\u0026#34;); queueJob(job1); await nextTick(); log([\u0026#34;\\nafter await\\n\u0026#34;, calls]); }; run();    undefined after await [ \u0026#39;job1\u0026#39;, \u0026#39;job2\u0026#39; ]   çœ‹ä¸‹é¢çš„æµ‹è¯•ä»£ç ï¼ˆåœ¨ for å¾ªç¯è¿‡ç¨‹ä¸­æ”¹å˜æ•°ç»„é•¿åº¦ï¼Œä¼šæ£€æµ‹åˆ°è¿™ç§æ”¹å˜ï¼‰ï¼š\n1 2 3 4 5 6  const nums = [1, 2, 3]; const add = (i) =\u0026gt; nums.push(++i); for (let i = 0; i \u0026lt; nums.length; i++) { if (i === 1) add(i); console.log({ i, v: nums[i], l: nums.length }); }    { i: 0, v: 1, l: 3 } { i: 1, v: 2, l: 4 } { i: 2, v: 3, l: 4 } { i: 3, v: 2, l: 4 } undefined   æ‰€ä»¥ä¸Šé¢çš„ Job å®ä¾‹ï¼Œå°±å¾ˆå¥½ç†è§£äº†\n åœ¨ for queue jobs è¿‡ç¨‹ä¸­å‘ç°æœ‰æ–°çš„ job è¿›å…¥ï¼Œä¹‹å‰è¯´è¿‡äº† queue çš„å…¥åˆ—æ“ä½œæ˜¯åŒæ­¥ çš„ï¼Œæ‰€ä»¥ä¼šç«‹å³æ‰§è¡Œæ”¹å˜ queue é•¿åº¦ï¼Œæœ€ååŠ å…¥çš„ä»»åŠ¡ä¼šåœ¨ for å¾ªç¯è¿‡ç¨‹ä¸­æœ€åå¾—åˆ°æ‰§è¡Œã€‚\n  queuePreFlushCb   feat(add): rc-\u0026gt;scheduler-\u0026gt;queuePreFlushCb -\u0026gt; pre jobs, pendingPreFlusâ€¦ Â· gcclll/stb-vue-next@2c72cdc Â· GitHub\n æ–°å¢ä»£ç ï¼š\n  queuePreFlushCb, å…¥åˆ— pre jobs å‡½æ•°\n  flushPreFlushCbs, flush pre jobs å‡½æ•°\n  flushJobs ä¸­è°ƒç”¨ flushPreFlushCbs() åˆ·æ‰ pre jobs\n  è¿™ä¸ªæ˜¯ç”¨æ¥æ”¶é›†å’Œ flush pre ç±»å‹(é»˜è®¤ç±»å‹çš„ä»»åŠ¡)çš„é˜Ÿåˆ— pendingPreFlushCbs[] çš„å‡½æ•°ã€‚\n é€»è¾‘è„‘å›¾ï¼š  ç›¸å…³ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  export function queuePreFlushCb(cb: SchedulerCb) { queueCb(cb, activePreFlushCbs, pendingPreFlushCbs, preFlushIndex); } function queueCb( cb: SchedulerCbs, activeQueue: SchedulerCb[] | null, pendingQueue: SchedulerCb[], index: number ) { if (!isArray(cb)) { if ( !activeQueue || !activeQueue.includes( cb, (cb as SchedulerJob).allowRecurse ? index + 1 : index ) ) { pendingQueue.push(cb); } } else { pendingQueue.push(...cb); } queueFlush(); }     å¯¹æ¯” queueCb å’Œ queueJob ä¼šå‘ç°ä¸¤è€…æ²¡å¤šå¤§çš„å·®åˆ«ï¼Œå…ˆåŒæ­¥æ”¶é›†å†å¼‚æ­¥ flushï¼Œä¸¤è€…åˆ¤ æ–­æ¡ä»¶æœ‰ç»†å¾®å·®åˆ«ï¼Œå¦å¤– queueJob æ”¯æŒæ•°ç»„å½¢å¼çš„ cbï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  // queueJob if ( (!queue.length || !queue.includes( job, isFlushing \u0026amp;\u0026amp; job.allowRecurse ? flushIndex + 1 : flushIndex )) \u0026amp;\u0026amp; job !== currentPreFlushParentJob ) { queue.push(job); queueFlush(); }     æœ€åä¹Ÿéƒ½æ˜¯è°ƒç”¨ queueFlush() -\u0026gt; flushJobs() æ¥æ¸…ç©ºé˜Ÿåˆ— pendingQueue/queue ã€‚\n æ‰€ä»¥ä¸‹é¢è¿˜éœ€è¦åœ¨ flushJobs() é‡Œé¢å»å®ç°å¯¹ pre -\u0026gt; pendingQueue ç±»å‹é˜Ÿåˆ— flush æ“ ä½œ(flushPreFlushCbs())ã€‚\n  flushPreFlushCbs   æœ‰å…³å‡½æ•°å’Œå˜é‡\n   name type description     preFlushIndex number used in `for` to flush pre jobs   pendingPreFlushCbs array the queue to store pre jobs   activePreFlushCbs array the non-repeat copy of pendingPreFlushCbs, used to flushing   queuePreFlushCb function ä¸ flushPreFlushCbs å¯¹åº”çš„ pre job å…¥åˆ—å‡½æ•°   queueFlush function æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡çš„å‡½æ•°ï¼Œä¸‰ä¸ªç±»å‹çš„ä»»åŠ¡éƒ½åœ¨è¿™é‡Œé¢æ‰§è¡Œ(pre,post,queue)   flushJobs function å…·ä½“æ‰§è¡Œä»»åŠ¡çš„å‡½æ•°ï¼Œä¸‰ç§ä»»åŠ¡æ‰§è¡Œé¡ºåºæ˜¯ï¼š pre -\u0026gt; queue -\u0026gt; post     Tip. activePreFlushCbs å’Œ pendingPreFlushCbs çš„å…³ç³»ï¼š å‰è€…æ˜¯åè€…çš„ä¸€ä¸ªæ‹·è´ï¼Œ æ‹·è´å®Œä¼šç«‹å³æ¸…ç©º pending, ç›®çš„æ˜¯ä¸ºäº†è®© pending åœ¨ active flushing æœŸé—´èƒ½ç»§ç»­æ”¶é›† æ–°çš„ä»»åŠ¡ï¼Œè¿™æ ·å¦‚æœåœ¨æ‰§è¡ŒæœŸé—´æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—ï¼Œé‚£ä¹ˆåœ¨å‡½æ•°æœ€åçš„é€’å½’æ“ä½œä¼šå¯¹è¿™äº›æ–°å…¥ åˆ—çš„ä»»åŠ¡ç»§ç»­ flush æ‰ï¼Œç›´åˆ°å†ä¹Ÿæ²¡æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—ä¸ºæ­¢ã€‚\n æ³¨æ„ç‚¹ ï¼šå½“ queuePreFlushCb åœ¨ queueJob ä¸­ä½¿ç”¨æ—¶ä¸ä¼šä¸»åŠ¨è§¦å‘ cbs æ‰§è¡Œï¼Œå¦‚æœ éœ€è¦ç«‹å³æ‰§è¡Œè¿™äº› cbs éœ€è¦æ‰‹åŠ¨è°ƒç”¨ flushPreFlushCbs(seen, parentJob) å»åˆ·æ‰ pre cbs ä»»åŠ¡ï¼Œæˆ–è€…ç­‰åˆ°å½“å‰ job æ‰§è¡Œå®Œäº†ä¸‹ä¸€ä¸ª flushJobs() è°ƒç”¨ä¸­æ‰§è¡Œï¼Œå› ä¸º queueJob() æ‰§è¡ŒæœŸé—´ isFlushing = true ï¼Œè€Œåœ¨ queueFlush() ä¸­æœ‰æ£€æµ‹è¿™ä¸ªå€¼ï¼Œ å¦‚æœæ­£åœ¨æ‰§è¡Œ flushing æ˜¯ä¸ä¼šç»§ç»­æ‰§è¡Œçš„ï¼Œæ›´å¤šè¯¦æƒ…æŸ¥çœ‹åé¢çš„æµ‹è¯•å’Œåˆ†æã€‚\n  æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  export function flushPreFlushCbs( seen?: CountMap, parentJob: SchedulerJob | null = null ) { if (pendingPreFlushCbs.length) { currentPreFlushParentJob = parentJob; activePreFlushCbs = [...new Set(pendingPreFlushCbs)]; pendingPreFlushCbs.length = 0; if (__DEV__) { seen = seen || new Map(); } for ( preFlushIndex = 0; preFlushIndex \u0026lt; activePreFlushCbs.length; preFlushIndex++ ) { // TODO æ£€æŸ¥é€’å½’æ›´æ–°é—®é¢˜  activePreFlushCbs[preFlushIndex](); } activePreFlushCbs = null; preFlushIndex = 0; currentPreFlushParentJob = null; // é€’å½’ flush ç›´åˆ°æ‰€æœ‰ pre jobs è¢«æ‰§è¡Œå®Œæˆ  flushPreFlushCbs(seen, parentJob); } }     ç”¨é€”ï¼š api watch é‡Œé¢å¯¹é»˜è®¤ç±»å‹(pre)çš„ä»»åŠ¡çš„å…¥åˆ—æ“ä½œï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // default: \u0026#39;pre\u0026#39; function doWatch( source: WatchSource | WatchSource[] | WatchEffect | object, cb: WatchCallback | null, { immediate, deep, flush, onTrack, onTrigger }: WatchOptions = EMPTY_OBJ, instance = currentInstance ): WatchStopHandle { // ...  let scheduler: ReactiveEffectOptions[\u0026#34;scheduler\u0026#34;]; if (flush === \u0026#34;sync\u0026#34;) { // ...  } else if (flush === \u0026#34;post\u0026#34;) { // ...  } else { // default: \u0026#39;pre\u0026#39;  scheduler = () =\u0026gt; { if (!instance || instance.isMounted) { queuePreFlushCb(job); } else { // with \u0026#39;pre\u0026#39; option, the first call must happen before  // the component is mounted so it is called synchronously.  job(); } }; } // ... }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, queuePreFlushCb, flushPreFlushCbs, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const calls = []; const job1 = () =\u0026gt; { // #1  queuePreFlushCb(cb1); // #2  queuePreFlushCb(cb2); // #3  // æ‰‹åŠ¨è§¦å‘ cb1, cb2  flushPreFlushCbs(undefined, job1); // #4  calls.push(\u0026#34;job1\u0026#34;); // #5  }; const cb1 = () =\u0026gt; calls.push(\u0026#34;cb1\u0026#34;); // #6  const cb2 = () =\u0026gt; calls.push(\u0026#34;cb2\u0026#34;); // #7  queueJob(job1); // #8  await nextTick(); // #9  log.newline(calls); // #10 }; run();    undefined cb1 cb2 job1   æµ‹è¯•åˆ†æä»£ç è„‘å›¾ï¼š  æ–‡å­—åˆ†æï¼š\n  #8 å…ˆæ‰§è¡Œï¼Œ queueJob -\u0026gt; push job1 -\u0026gt; queue:[job1] -\u0026gt; queueFlush()\n åœ¨ queueFlush() ä¸­è°ƒç”¨ resolvedPromise.then(flushJobs) å¼‚æ­¥æ‰§è¡Œ flushJobs() å‡½æ•°åˆ·æ‰æ‰€æœ‰ä»»åŠ¡(pre/job/post)\n å¹¶ä¸”è®°å½•å½“å‰ tick ä¸‹çš„ promise: currentFlushPromise\n æ­¤æ—¶çš„ pendingPreFlushCbs[] ä¸­æ˜¯æ²¡æœ‰ä»»ä½•ä»»åŠ¡çš„ï¼Œæ‰€ä»¥ç»§ç»­æ‰§è¡Œ try{â€¦} å¼€å§‹ flush queue[] jobsï¼Œè¿™ä¸ªæ—¶å€™ flushIndex = 0 å¾—åˆ° job1ï¼Œå¼€å§‹æŒ‰é¡ºåºæ‰§è¡Œ job1\n  #1 å¼€å§‹æ‰§è¡Œ\n  #2 å°† cb1 push -\u0026gt; pendingPreFlushCbs=[cb1]\n  #3 å°† cb2 push -\u0026gt; pendingPreFlushCbs=[cb1, cb2]\n  #4 æ‰‹åŠ¨ flush pre cbs\n åœ¨ flushPreFlushCbs(undefind, job1) ä¸­ä¼šè®°å½• currentPreFlushParentJob = job1 è¿™ä¸ªå˜é‡å°†ä¼šåœ¨ queueJob(job) ä¸­ç”¨æ¥æ£€æµ‹ job æ˜¯ä¸æ˜¯å½“å‰çš„ job1 å¦‚æœæ˜¯ å°±ä¸å…è®¸ pushï¼Œå› ä¸º job1 ä¸‹æœ‰å­ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œå¿…é¡»ç­‰è¿™äº›å­ä»»åŠ¡(cb1, cb2) æ‰§è¡Œå®Œã€‚\n  #6 å¼€å§‹æ‰§è¡Œï¼Œ push \u0026#39;cb1\u0026#39; -\u0026gt; calls: [\u0026#39;cb1\u0026#39;]\n  #7 å¼€å§‹æ‰§è¡Œï¼Œ push \u0026#39;cb2\u0026#39; -\u0026gt; calls: [\u0026#39;cb1\u0026#39;, \u0026#39;cb2\u0026#39;]\n  #5 å¼€å§‹æ‰§è¡Œï¼Œ push \u0026#39;job1\u0026#39; -\u0026gt; alls: [\u0026#39;cb1\u0026#39;, \u0026#39;cb2\u0026#39;, \u0026#39;job1\u0026#39;]\n  #9 å¼€å§‹æ‰§è¡Œï¼Œå› ä¸º nextTick()\n1 2 3 4 5 6 7  export function nextTick( this: ComponentPublicInstance | void, fn?: () =\u0026gt; void ): Promise\u0026lt;void\u0026gt; { const p = currentFlushPromise || resolvedPromise; return fn ? p.then(this ? fn.bind(this) : fn) : p; }     è¿™é‡Œçš„ await ä¼šç­‰ job1 queueFlush() è§¦å‘çš„ promise.then(flushJobs) è¿”å›çš„ promise å®Œæˆä¹‹åå†æ‰§è¡Œåé¢çš„ä»£ç ã€‚\n  #10 log è¾“å‡º \u0026#39;cb1,cb2,job1\u0026#39;\n    queuePostFlushCb + flushPostFlushCbs   feat(add): rc-\u0026gt;scheduler-\u0026gt;queuePostFlushCb+flushPostFlushCbs Â· gcclll/stb-vue-next@845c21b Â· GitHub\n é€»è¾‘è„‘å›¾ï¼š  æœ‰äº† queue job å’Œ pre cb çš„åŸºç¡€åˆ†æï¼Œè¿™éƒ¨åˆ†ä¹Ÿå°±å¾ˆå¥½ç†è§£äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  export function queuePostFlushCb(cb: SchedulerCbs) { queueCb(cb, activePostFlushCbs, pendingPostFlushCbs, postFlushIndex); } export function flushPostFlushCbs(seen?: CountMap) { if (pendingPostFlushCbs.length) { const deduped = [...new Set(pendingPostFlushCbs)]; pendingPostFlushCbs.length = 0; // #1947 already has active queue, nested flushPostFlushCbs call  if (activePostFlushCbs) { activePostFlushCbs.push(...deduped); return; } activePostFlushCbs = deduped; if (__DEV__) { seen = seen || new Map(); } activePostFlushCbs.sort((a, b) =\u0026gt; getId(a) - getId(b)); for ( postFlushIndex = 0; postFlushIndex \u0026lt; activePostFlushCbs.length; postFlushIndex++ ) { // TODO é€’å½’ update æ£€æŸ¥  activePostFlushCbs[postFlushIndex](); } activePostFlushCbs = null; postFlushIndex = 0; } }     å’Œ pre cb çš„å¤„ç†æœ‰ä¸¤ä¸ªä¸åŒç‚¹ï¼š\n  éå›è°ƒå½¢å¼å¤„ç† flushing æœŸé—´æ¥å—åˆ°çš„æ–°ä»»åŠ¡ï¼Œè€Œæ˜¯é€šè¿‡æ”¹å˜æ‰§è¡Œå™¨ activePostFlushCbs æ¥å®ç°(å’Œ queue job ç±»ä¼¼)\n  æ²¡æœ‰é€’å½’å›è°ƒå½¢å¼å¤„ç†åç»­çš„æ–°ä»»åŠ¡ï¼Œå‚è€ƒ 1\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queuePostFlushCb, nextTick, queueJob }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); // len = activePostFlushCbs.length const run = async () =\u0026gt; { const calls = []; const cb1 = () =\u0026gt; { calls.push(\u0026#34;cb1\u0026#34;); // ä¼šåœ¨åŒä¸€ä¸ª tick æœŸé—´æ‰§è¡Œï¼Œå› ä¸ºå®ƒåœ¨for flushing æœŸé—´æ”¹å˜äº†  // activePostFlushCbsï¼Œå¹¶ä¸”ç´§éš cb1,cb2,cb3 ä¹‹åæ‰§è¡Œ  queuePostFlushCb(cb4); }; const cb2 = () =\u0026gt; calls.push(\u0026#34;cb2\u0026#34;); const cb3 = () =\u0026gt; calls.push(\u0026#34;cb3\u0026#34;); // job1 ä¼šåœ¨ cb4 ä¹‹åæ‰§è¡Œï¼Œå› ä¸º flushJobs åœ¨æŒ‰é¡ºåºæ‰§è¡Œå®Œ  // pre -\u0026gt; job -\u0026gt; post æœ€åçš„ finally é‡Œé¢å¯¹ queue è¿›è¡Œäº†æ£€æµ‹  // æ­¤æ—¶ queue = [job1] éšæ„ä¼šé€’å½’è°ƒç”¨ flushJobs() ç»§ç»­åˆ·  // ä½†æ˜¯ä¸ºä»€ä¹ˆ cb5 ä¼šåœ¨ job1 ä¹‹åå‘¢ï¼Ÿï¼Ÿï¼Ÿ  // å› ä¸º queuePostFlushCb push çš„æ˜¯ pendingPostFlushCbs è€Œä¸æ˜¯  // activePostFlushCbsï¼Œæ‰€ä»¥åœ¨ queuePostFlushCb ä¸­è°ƒç”¨è‡ªèº«å¢åŠ çš„æ–°  // cbs ä¼šåœ¨ finally åé¢çš„æ£€æµ‹é€’å½’ flushJobs() è°ƒç”¨ä¸­æ‰§è¡Œ  // è€Œ post çš„ä¼˜å…ˆçº§åˆä½äº job æ‰€ä»¥ job1 ä¼šä¼˜å…ˆè¾“å‡º  const cb4 = () =\u0026gt; (queuePostFlushCb(cb5), queueJob(job1), calls.push(\u0026#34;cb4\u0026#34;)); // ä¼šåœ¨ job1,cb5 ä¹‹åæ‰§è¡Œ  const job1 = () =\u0026gt; (queuePostFlushCb(cb6), calls.push(\u0026#34;job1\u0026#34;)); const cb5 = () =\u0026gt; calls.push(\u0026#34;cb5\u0026#34;); const cb6 = () =\u0026gt; calls.push(\u0026#34;cb6\u0026#34;); queuePostFlushCb([cb1, cb2]); queuePostFlushCb(cb3); // åº”è¯¥å»é‡  queuePostFlushCb([cb1, cb3]); queuePostFlushCb(cb2); await nextTick(); log.newline(calls); }; run();    undefined cb1 cb2 cb3 cb4 job1 cb5 cb6   å¯¹äº queuePostFlushCb å’Œ queueJob çš„æ··ç”¨åªè¦è®°ä½ä¸€ç‚¹ï¼Œ queuePostFlushCb ä¸ ä¼šè§¦å‘ activePostFlushCbs æ”¹å˜ï¼Œå› ä¸º isFlushing = trueï¼Œæ‰€ä»¥åªä¼šåœ¨å½“å‰ flushJobs() æ‰§è¡Œåˆ°æœ€åé€’å½’æ£€æµ‹çš„æ—¶å€™æ‰ä¼šè¿›å…¥ä¸‹ä¸€æ¬¡çš„ post+job è°ƒç”¨ã€‚\n   test nested(pre/job/post)   å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç»“åˆ pre, post, queue ä¸‰ç§ç±»å‹çš„ä»»åŠ¡è¿›è¡Œæµ‹è¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, queuePreFlushCb, nextTick, flushPreFlushCbs }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const calls = []; const cb1 = () =\u0026gt; { calls.push(\u0026#34;cb1\u0026#34;); }; const cb2 = () =\u0026gt; { calls.push(\u0026#34;cb2\u0026#34;); // queueJob å’Œ queuePreFlushCb ç»“åˆä½¿ç”¨  queueJob(job1); }; const cb3 = () =\u0026gt; { calls.push(\u0026#34;cb3\u0026#34;); // é“¾å¼ä½¿ç”¨ï¼Œcb4 ä¼šåœ¨ cb1,2,3 æ‰§è¡Œå®Œæˆä¹‹åæ‰ä¼šæ‰§è¡Œ  queuePreFlushCb(cb4); }; const cb4 = () =\u0026gt; { calls.push(\u0026#34;cb4\u0026#34;); }; const cb5 = () =\u0026gt; { calls.push(\u0026#34;cb5\u0026#34;); }; const job1 = () =\u0026gt; { calls.push(\u0026#34;job1\u0026#34;); // queuePreFlushCb åœ¨ queueJob ä¸­è°ƒç”¨  // pre cbs åœ¨ job ä¸­è°ƒç”¨çš„æ—¶å€™ä¸ä¼šè¢«æ‰§è¡Œï¼Œé™¤éåœ¨è¿™åé¢æ‰‹åŠ¨ flush  // æˆ–è€…æœ‰æ–°çš„ä»»åŠ¡è¿›æ¥ï¼Œå‘èµ· flushJobs è°ƒç”¨æ‰ä¼šæ‰§è¡Œ  queuePreFlushCb(cb5); // å¿…é¡»æ‰‹åŠ¨è§¦å‘, è¿™æ · cb5 æ‰ä¼šè¾“å‡º  flushPreFlushCbs(undefined, job1 /* currentPreFlushParentJob */); }; const cb6 = () =\u0026gt; { calls.push(\u0026#34;cb6\u0026#34;); }; queuePreFlushCb(cb1); queuePreFlushCb(cb2); queuePreFlushCb(cb1); queuePreFlushCb(cb2); queuePreFlushCb(cb3); await nextTick(); log(\u0026#34;\\n\u0026#34; + calls); }; run();    undefined cb1,cb2,cb3,cb4,job1,cb5    pendingPreFlushCbs è™½ç„¶æ˜¯ä¸ªæ•°ç»„ï¼Œä½†æ˜¯ flush æœŸé—´é€šè¿‡ [...new Set(pendingPreFlushCbs)] è¿›è¡Œäº†å»é‡æ“ä½œã€‚\n  é“¾å¼æ“ä½œï¼Œå› ä¸ºåœ¨æ‰§è¡ŒæœŸé—´ä½¿ç”¨çš„æ˜¯ activePreFlushCbs ä¸”æ­¤æ—¶çš„ pendingPreFlushCbs æ¸…ç©ºäº†ï¼Œç­‰å¾…æ–°ä»»åŠ¡å…¥åˆ—\n åœ¨æ‰§è¡Œ cb3 æœŸé—´ï¼Œè°ƒç”¨ queuePreFlushCb(cb4) æ­¤æ—¶ push cb4 -\u0026gt; pendingPreFlushCbs ï¼Œä½†å®é™…ä¸ä¼šå½±å“æœ¬æ¬¡çš„ for å¾ªç¯æ‰§è¡Œ\n è¿™ç‚¹å’Œ queueJob æœ‰ç‚¹ä¸åŒï¼Œå®ƒç›´æ¥ä½¿ç”¨çš„æ˜¯ queue -\u0026gt; for æ‰€ä»¥æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—ä¼šæ”¹ å˜ for çš„æ‰§è¡Œé•¿åº¦(queue.length)\n pre å¤„ç†ä¼šç­‰åˆ° activePreFlushCbs for æ‰§è¡Œå¾ªç¯ç»“æŸåï¼Œåœ¨å‡½æ•°çš„æœ€åé€’å½’è°ƒç”¨ flushPreFlushCbs() æ¥åˆ·æ‰æ–°å…¥åˆ—çš„ä»»åŠ¡(å¦‚ï¼š cb4)\n  queueJob åœ¨ queuePreFlushCb ä¸­è°ƒç”¨çš„æ—¶å€™ï¼Œ queue job æ€»æ˜¯åœ¨ pre cb ä¹‹åè¢«æ‰§è¡Œï¼Œè¿™ä¹Ÿ æ˜¯ flushJobs ä¸­å¤„ç†ä»£ç åº”ä½“ç°å‡ºçš„ç»“æœã€‚\n1 2 3 4 5  function flushJobs() { // 1. flush pre -\u0026gt; flushPreFlushCbs()  // 2. for -\u0026gt; queue job -\u0026gt; callWithErrorHandling(job, ...)  // 3. flush post -\u0026gt; flushPostFlushCbs() }     å¹¶ä¸”å¦‚ä¸Šé¢å®ä¾‹ç»“æœ cb4 åµŒå¥—åœ¨ cb3 ï¼Œjob1 åµŒå¥—åœ¨äº† cb2 ä¸­ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯ cb4 å…ˆ å¾—åˆ°æ‰§è¡Œäº†ï¼Œjob1 å†æ‰§è¡Œã€‚\n Tip. å› æ­¤ï¼Œå¯¹äº pre cbs å’Œ queue jobs ä¸¤ä¸ªç±»å‹çš„ä»»åŠ¡ï¼Œä¸ç®¡ä»€ä¹ˆæ—¶æœºå…¥åˆ—çš„ï¼Œéƒ½ä¼š æ˜¯å…ˆæ‰§è¡Œ pre cbs å†æ‰§è¡Œ queue jobs\n   queuePreFlushCb åœ¨ queueJob ä¸­è°ƒç”¨çš„æ—¶å€™ï¼Œæ–°çš„ pre job ä¼šåœ¨ queue job åæ‰§è¡Œ\n fix: rc-\u0026gt;scheduler-\u0026gt;flushJobs recursive Â· gcclll/stb-vue-next@b0155c5 Â· GitHub\n åŸå› ï¼š flushPreFlushCbs å…ˆäº queue jobs æ‰§è¡Œï¼Œå› æ­¤ queue jobs(job1) æ‰§è¡Œ çš„æ—¶å€™ queuePreFlushCb() åŠ å…¥çš„ä»»åŠ¡(cb5)æ­¤æ—¶ä¸ä¼šæ‰§è¡Œï¼Œè€Œæ˜¯ç­‰ queue jobs éƒ½æ‰§è¡Œå®Œä¹‹ååœ¨finally é‡Œé¢ä¼šåšä¸€æ¬¡æ£€æµ‹\n1 2 3  if (queue.length || pendingPreFlushCbs.length) { flushJobs(seen) }     è¿™ä¸ªæ—¶å€™ä¼šå»é€’å½’ flushJobs() æ­¤æ—¶æ‰å‘ç°æœ‰æ–°çš„ pendingPreFlushCbs (å¦‚ï¼š cb5)ï¼Œåˆ™å°†æ‰§è¡Œä»–ä»¬ï¼Œæ‰€ä»¥ç»“æœæ˜¯ job1,cb5 ã€‚\n    invalidateJob(job)   feat(add): rc-\u0026gt;scheduler-\u0026gt;invalidateJob Â· gcclll/stb-vue-next@24808b1 Â· GitHub\n æ˜¯ä»»åŠ¡å¤±æ•ˆï¼Œå…¶å®å°±æ˜¯å•çº¯çš„å°† Job ä» queue ä¸­åˆ é™¤äº†ã€‚\n1 2 3 4 5 6  export function invalidateJob(job: SchedulerJob) { const i = queue.indexOf(job); if (i \u0026gt; -1) { queue.splice(i, 1); } }     æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, queuePostFlushCb, invalidateJob, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const calls = []; const job1 = () =\u0026gt; { calls.push(\u0026#34;job1\u0026#34;); invalidateJob(job2); // è¿™é‡Œå°† job2 ä» queue[] ä¸­åˆ é™¤äº†  job2(); // æ³¨é‡Šè¿™ä¸ªç»“æœä¼šæ˜¯ï¼š job1 job3 job4  }; const job2 = () =\u0026gt; { calls.push(\u0026#34;job2\u0026#34;); }; const job3 = () =\u0026gt; { calls.push(\u0026#34;job3\u0026#34;); }; const job4 = () =\u0026gt; { calls.push(\u0026#34;job4\u0026#34;); }; queueJob(job1); queueJob(job2); queueJob(job3); queuePostFlushCb(job4); await nextTick(); log.newline(calls); }; run();    undefined job1 job2 job3 job4    job sort id ä»»åŠ¡å¯ä»¥æ’åº   åªæœ‰ post å’Œ job æ”¯æŒæ’åºã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, queuePostFlushCb, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { const calls = []; const job1 = () =\u0026gt; calls.push(\u0026#34;job1\u0026#34;); const job2 = () =\u0026gt; calls.push(\u0026#34;job2\u0026#34;); const job3 = () =\u0026gt; calls.push(\u0026#34;job3\u0026#34;); // job1 no id  job2.id = 2; job3.id = 1; const cb1 = () =\u0026gt; calls.push(\u0026#34;cb1\u0026#34;); const cb2 = () =\u0026gt; calls.push(\u0026#34;cb2\u0026#34;); const cb3 = () =\u0026gt; calls.push(\u0026#34;cb3\u0026#34;); cb1.id = 2; // cb2 no id  cb3.id = 1; queueJob(job1); queueJob(job2); queueJob(job3); queuePostFlushCb(cb1); queuePostFlushCb(cb2); queuePostFlushCb(cb3); await nextTick(); log.newline(calls); }; run();    undefined job3 job2 job1 cb3 cb1 cb2    allowRecurse è‡ªèº«é€’å½’   ç”¨ job.allowRecurse æ¥æ§åˆ¶ job æ˜¯å¦å¯ä»¥è‡ªå·±è§¦å‘è‡ªå·±æ‰§è¡Œ(PS. pre/job/post éƒ½æ”¯æŒ è¯¥å±æ€§)ã€‚\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { let count = 0; const job = () =\u0026gt; { if (count \u0026lt; 3) { count++; queueJob(job); } }; queueJob(job); queueJob(job); await nextTick(); log.newline(\u0026#34;before count: \u0026#34; + count); // è®¾ç½® allowRecurse = true å…è®¸è‡ªæˆ‘è°ƒåº¦  count = 0; job.allowRecurse = true; // é‡å¤å…¥åˆ—åŒä¸€ä¸ªä»»åŠ¡ä¼šåœ¨ push é˜¶æ®µå°±æ£€æµ‹å’Œè‡ªèº«é€’å½’è°ƒç”¨ä¸åŒ  queueJob(job); queueJob(job); await nextTick(); log.newline(\u0026#34;after count: \u0026#34; + count); }; run();    undefined before count: 1 after count: 3    checkRecursiveUpdates   feat(add): rc-\u0026gt;scheduler-\u0026gt;checkRecursiveUpdates Â· gcclll/stb-vue-next@7bcc14b Â· GitHub\n é™åˆ¶è°ƒç”¨è‡ªèº«çš„æ¬¡æ•°ï¼Œåœ¨ allowRecurse = true æƒ…å†µä¸‹ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { queueJob, nextTick }, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const run = async () =\u0026gt; { let count = 0; const job = () =\u0026gt; { if (count \u0026lt; 101) { count++; queueJob(job); } }; job.allowRecurse = true; queueJob(job); try { await nextTick(); } catch (e) { log.newline(e.message); } }; run();    undefined Maximum recursive updates exceeded. This means you have a reactive effect that is mutating its own dependencies and thus recursively triggering itself. Possible sources include component template, render function, updated hook or watcher source function.    å°ç»“    pre cbs: æ‰§è¡Œä¼˜å…ˆçº§æœ€é«˜ï¼Œåœ¨åŒä¸€ tick ä¸­ä¼šé€’å½’è°ƒç”¨è‡ªèº«æ¸…ç©º pendingPreFlushCbs ä¸­çš„ä»»åŠ¡ï¼Œåœ¨ queueJob ä¸­è°ƒç”¨æ—¶ä¸ä¼šè‡ªåŠ¨è§¦å‘éœ€è¦æ‰‹åŠ¨è§¦å‘æ‰§è¡Œï¼Œå› ä¸ºæ­¤æ—¶ isFlushing = true ã€‚\n job: æ‰§è¡Œä¼˜å…ˆçº§æ¬¡ä¹‹ï¼Œåœ¨åŒä¸€ tick ä¸­åŒä¸€ä¸ª for queue -\u0026gt; flushIndex ä¸‹ä¼šå¤„ç†æ­¤ æ—¶æ¥å—åˆ°çš„æ–°ä»»åŠ¡ï¼Œåœ¨ pre cbs ä¸­è°ƒç”¨æ—¶ä¼šåœ¨æ‰€æœ‰ pre cbs æ‰§è¡Œä¹‹åæ‰§è¡Œã€‚\n post cbs: æ‰§è¡Œä¼˜å…ˆçº§æœ€ä½ï¼Œåœ¨åŒä¸€ tick åŒä¸€æ¬¡ flushPostFlushCbs() è°ƒç”¨ä¸­ä¸ä¼š å¤„ç†æ–°çš„ post ä»»åŠ¡ï¼Œè€Œæ˜¯åœ¨ flushJobs() æ‰§è¡Œåˆ°æœ€å finally éƒ¨åˆ†æ£€ æµ‹ pendingPostFlushCbs ä»»åŠ¡é˜Ÿåˆ—æ¥å¤„ç†å½“å‰ tick ä¸‹æ–°æ¥å—åˆ°çš„ä»»åŠ¡ï¼Œ åœ¨ queuePreFlushCb() å’Œ queueJob() ä¸­è°ƒç”¨çš„æ—¶å€™ä¼šåœ¨ä»–ä»¬çš„ä»»åŠ¡ä¹‹åæ‰§è¡Œã€‚\n    ğŸ› BUGs fix \u0026amp; Questions   fix: no import EMPTY_ARR Â· gcclll/stb-vue-next@2a1ab04 Â· GitHub\nnextTick() åé¢çš„ä»£ç æœ€åæ‰§è¡Œï¼Ÿ   æµ‹è¯•ä»£ç ï¼š nextTick\n å…ˆçœ‹ä¸€æ®µä»£ç ï¼Œä»¥åŠ babeljs.io è½¬æ¢ä¹‹åçš„ç»“æœï¼š\n babel ä¹‹å‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  const run = async () =\u0026gt; { const p = Promise.resolve().then(); const p1 = p.then(() =\u0026gt; console.log(\u0026#34;before await\u0026#34;)); console.log(\u0026#34;between await and p1\u0026#34;); await p1; console.log(\u0026#34;after await\u0026#34;); const p2 = Promise.resolve().then(); await p2; console.log(\u0026#34;after p2\u0026#34;); }; run();     babel ä¹‹å(åªè´´å‡ºæ ¸å¿ƒéƒ¨åˆ†)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  while (1) { switch ((_context.prev = _context.next)) { case 0: p = Promise.resolve().then(); p1 = p.then(function () { return console.log(\u0026#34;before await\u0026#34;); }); console.log(\u0026#34;between await and p1\u0026#34;); _context.next = 5; return p1; case 5: console.log(\u0026#34;after await\u0026#34;); p2 = Promise.resolve().then(); _context.next = 9; return p2; case 9: console.log(\u0026#34;after p2\u0026#34;); case 10: case \u0026#34;end\u0026#34;: return _context.stop(); } }     å³ä¸Šé¢çš„ä»£ç è¢«è½¬æ¢ä¹‹åå˜æˆäº†ä¸€ä¸ª switchï¼Œé‡Œé¢æ˜¯ä¸€ä¸ª while å¾ªç¯ï¼Œå¼‚æ­¥ä»£ç æœ€ç»ˆçš„é¡º åºæ‰§è¡Œç”± _context.next æ¥è¡”æ¥ã€‚\n case 0 -\u0026gt; next = 5 -\u0026gt; case 5 -\u0026gt; next = 9 -\u0026gt; â€¦\n æ‰€ä»¥è¯´ nextTick() åé¢çš„ä»£ç éƒ½ä¼šè¢«æ”¾åˆ°å¼‚æ­¥ä»£ç \n    runtime-test æ¨¡å—ç®€ä»‹   è¿™é‡Œæµ‹è¯•éœ€è¦ç”¨åˆ°è¿™ä¸ªæ¨¡å—ï¼Œæ‰€ä»¥ç®€å•ç”¨è„‘å›¾æè¿°ä¸‹è¿™é‡Œé¢æœ‰å“ªäº›ä¸œè¥¿å’Œå¹²ä»€ä¹ˆçš„ã€‚\n  é‡è¦ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89  // nodeOpts.ts  // 1. createElement // 2. createText // 3. createComment // ä¸Šé¢ä¸‰ä¸ªå‡½æ•°åˆ†åˆ«åˆ›å»ºäº†ä¸‰ç§ç±»å‹èŠ‚ç‚¹ const node = { id: nodeId++, type: NodeTypes.ELEMENT, // TEXT | COMMENT  text: value, // èŠ‚ç‚¹å…·ä½“å†…å®¹  parentNode: null, // ä¸‹é¢æ˜¯ ELEMENT ç±»å‹æ‹¥æœ‰çš„å±æ€§  children: [], props: {}, tag, eventListeners: null, }; // 4. setText(node, text), ç›´æ¥ä¿®æ”¹ node.text function setText(node: TestText, text: string) { logNodeOp({ type: NodeOpTypes.SET_TEXT, targetNode: node, text, }); node.text = text; } // 5. æ’å…¥ insert(child, parent, ref?) function insert(child: TestNode, parent: TestElement, ref?: TestNode | null) { let refIndex; if (ref) { refIndex = parent.children.indexOf(ref); if (refIndex === -1) { console.error(\u0026#34;ref: \u0026#34;, ref); console.error(\u0026#34;parent: \u0026#34;, parent); throw new Error(\u0026#34;ref is not a child of parent\u0026#34;); } } // ...log  // remove the node first, but don\u0026#39;t log it as a REMOVE op  remove(child, false); // re-calculate the ref index because the child\u0026#39;s removal may have affected it  refIndex = ref ? parent.children.indexOf(ref) : -1; if (refIndex === -1) { parent.children.push(child); child.parentNode = parent; } else { parent.children.splice(refIndex, 0, child); child.parentNode = parent; } } // 6. remove(child) function remove(child: TestNode, logOp: boolean = true) { const parent = child.parentNode; if (parent) { const i = parent.children.indexOf(child); if (i \u0026gt; -1) { parent.children.splice(i, 1); } else { console.error(\u0026#34;target: \u0026#34;, child); console.error(\u0026#34;parent: \u0026#34;, parent); throw Error(\u0026#34;target is not a childNode of parent\u0026#34;); } child.parentNode = null; } } // 7. setElementText(), ç›´æ¥æ¸…ç©ºæ›¿æ¢ childrenï¼Œä¸å¦‚ patchChildren ä¸­ // å¯¹ new/old ç±»å‹ä¸åŒçš„æ—¶å€™éœ€è¦ full diff æ—¶æ›´æ–°èŠ‚ç‚¹ function setElementText(el: TestElement, text: string) { // ...  el.children.forEach((c) =\u0026gt; { c.parentNode = null; }); if (!text) { el.children = []; } else { el.children = [ { id: nodeId++, type: NodeTypes.TEXT, text, parentNode: el, }, ]; } }      é‡è¦ç±»å‹å£°æ˜    å¼‚æ­¥ç»„ä»¶é€‰é¡¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  export interface AsyncComponentOptions\u0026lt;T = any\u0026gt; { loader: AsyncComponentLoader\u0026lt;T\u0026gt; loadingComponent?: Component errorComponent?: Component delay?: number timeout?: number suspensible?: boolean onError?: ( error: Error, retry: () =\u0026gt; void, fail: () =\u0026gt; void, attempts: number ) =\u0026gt; any }      Vue App ç±»å‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  export interface App\u0026lt;HostElement = any\u0026gt; { version: string; config: AppConfig; use(plugin: Plugin, ...options: any[]): this; mixin(mixin: ComponentOptions): this; component(name: string): Component | undefined; component(name: string, component: Component): this; directive(name: string): Directive | undefined; directive(name: string, directive: Directive): this; mount( rootContainer: HostElement | string, isHydrate?: boolean ): ComponentPublicInstance; unmount(rootContainer: HostElement | string): void; provide\u0026lt;T\u0026gt;(key: InjectionKey\u0026lt;T\u0026gt; | string, value: T): this; // internal, but we need to expose these for the server-renderer and devtools  _uid: number; _component: ConcreteComponent; _props: Data | null; _container: HostElement | null; _context: AppContext; }     App é…ç½®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  export interface AppConfig { // @private  readonly isNativeTag?: (tag: string) =\u0026gt; boolean; performance: boolean; optionMergeStrategies: Record\u0026lt;string, OptionMergeFunction\u0026gt;; globalProperties: Record\u0026lt;string, any\u0026gt;; isCustomElement: (tag: string) =\u0026gt; boolean; errorHandler?: ( err: unknown, instance: ComponentPublicInstance | null, info: string ) =\u0026gt; void; warnHandler?: ( msg: string, instance: ComponentPublicInstance | null, trace: string ) =\u0026gt; void; }     Vue æ’ä»¶ç±»å‹ï¼š\n1 2 3 4 5 6  type PluginInstallFunction = (app: App, ...options: any[]) =\u0026gt; any; export type Plugin = | (PluginInstallFunction \u0026amp; { install?: PluginInstallFunction }) | { install: PluginInstallFunction; };      api watch ç±»å‹\n1 2 3 4 5 6 7 8 9 10  export interface WatchOptionsBase { flush?: \u0026#34;pre\u0026#34; | \u0026#34;post\u0026#34; | \u0026#34;sync\u0026#34;; onTrack?: ReactiveEffectOptions[\u0026#34;onTrack\u0026#34;]; onTrigger?: ReactiveEffectOptions[\u0026#34;onTrigger\u0026#34;]; } export interface WatchOptions\u0026lt;Immediate = boolean\u0026gt; extends WatchOptionsBase { immediate?: Immediate; deep?: boolean; }      component ç»„ä»¶ç±»å‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69  // å†…éƒ¨é€‰é¡¹  export interface ComponentInternalOptions { /** ,* @internal ,*/ __props?: NormalizedPropsOptions; /** ,* @internal ,*/ __emits?: ObjectEmitsOptions | null; /** ,* @internal ,*/ __scopeId?: string; /** ,* @internal ,*/ __cssModules?: Data; /** ,* @internal ,*/ __hmrId?: string; /** ,* This one should be exposed so that devtools can make use of it ,*/ __file?: string; } // å‡½æ•°å¼ç»„ä»¶  export interface FunctionalComponent\u0026lt;P = {}, E extends EmitsOptions = {}\u0026gt; extends ComponentInternalOptions { // use of any here is intentional so it can be a valid JSX Element constructor  (props: P, ctx: Omit\u0026lt;SetupContext\u0026lt;E\u0026gt;, \u0026#34;expose\u0026#34;\u0026gt;): any; props?: ComponentPropsOptions\u0026lt;P\u0026gt;; emits?: E | (keyof E)[]; inheritAttrs?: boolean; displayName?: string; } // ç±»ç»„ä»¶  export interface ClassComponent { new (...args: any[]): ComponentPublicInstance\u0026lt;any, any, any, any, any\u0026gt;; __vccOpts: ComponentOptions; } // ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç¼©å†™  export const enum LifecycleHooks { BEFORE_CREATE = \u0026#34;bc\u0026#34;, CREATED = \u0026#34;c\u0026#34;, BEFORE_MOUNT = \u0026#34;bm\u0026#34;, MOUNTED = \u0026#34;m\u0026#34;, BEFORE_UPDATE = \u0026#34;bu\u0026#34;, UPDATED = \u0026#34;u\u0026#34;, BEFORE_UNMOUNT = \u0026#34;bum\u0026#34;, UNMOUNTED = \u0026#34;um\u0026#34;, DEACTIVATED = \u0026#34;da\u0026#34;, ACTIVATED = \u0026#34;a\u0026#34;, RENDER_TRIGGERED = \u0026#34;rtg\u0026#34;, RENDER_TRACKED = \u0026#34;rtc\u0026#34;, ERROR_CAPTURED = \u0026#34;ec\u0026#34;, } // setup å‡½æ•°  export interface SetupContext\u0026lt;E = EmitsOptions\u0026gt; { attrs: Data; slots: Slots; emit: EmitFn\u0026lt;E\u0026gt;; expose: (exposed: Record\u0026lt;string, any\u0026gt;) =\u0026gt; void; }      component internal instance\n è¿™é‡Œæ¶µç›–äº†ä¸€ä¸ªç»„ä»¶éƒ½æœ‰å“ªäº›å±æ€§ï¼š\n uid, type, parent, root, appContext, vnode, next, subTree, update,\n render, ssrRender, provides, effects, accessCache, renderCache,\n components, directives, propsOptions, emitsOptions,\n proxy, exposed, withProxy, ctx,\n data, props, attrs, slots, refs, emit,\n emitted, setupState, devtoolsRawSetupState, setupContext,\n suspense, suspenseId, asyncDep, asyncResolved,\n isMounted, isUnmounted, isDeactivated,\n bc, c, bm, m, bu, u, bum, um, da, a, rtg, rtc, ec\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  export const enum LifecycleHooks { BEFORE_CREATE = \u0026#34;bc\u0026#34;, CREATED = \u0026#34;c\u0026#34;, BEFORE_MOUNT = \u0026#34;bm\u0026#34;, MOUNTED = \u0026#34;m\u0026#34;, BEFORE_UPDATE = \u0026#34;bu\u0026#34;, UPDATED = \u0026#34;u\u0026#34;, BEFORE_UNMOUNT = \u0026#34;bum\u0026#34;, UNMOUNTED = \u0026#34;um\u0026#34;, DEACTIVATED = \u0026#34;da\u0026#34;, ACTIVATED = \u0026#34;a\u0026#34;, RENDER_TRIGGERED = \u0026#34;rtg\u0026#34;, RENDER_TRACKED = \u0026#34;rtc\u0026#34;, ERROR_CAPTURED = \u0026#34;ec\u0026#34;, }     ç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207  /** * We expose a subset of properties on the internal instance as they are * useful for advanced external libraries and tools. */ export interface ComponentInternalInstance { uid: number; type: ConcreteComponent; parent: ComponentInternalInstance | null; root: ComponentInternalInstance; appContext: AppContext; /** * Vnode representing this component in its parent\u0026#39;s vdom tree */ vnode: VNode; /** * The pending new vnode from parent updates * @internal */ next: VNode | null; /** * Root vnode of this component\u0026#39;s own vdom tree */ subTree: VNode; /** * The reactive effect for rendering and patching the component. Callable. */ update: ReactiveEffect; /** * The render function that returns vdom tree. * @internal */ render: InternalRenderFunction | null; /** * SSR render function * @internal */ ssrRender?: Function | null; /** * Object containing values this component provides for its descendents * @internal */ provides: Data; /** * Tracking reactive effects (e.g. watchers) associated with this component * so that they can be automatically stopped on component unmount * @internal */ effects: ReactiveEffect[] | null; /** * cache for proxy access type to avoid hasOwnProperty calls * @internal */ accessCache: Data | null; /** * cache for render function values that rely on _ctx but won\u0026#39;t need updates * after initialized (e.g. inline handlers) * @internal */ renderCache: (Function | VNode)[]; /** * Resolved component registry, only for components with mixins or extends * @internal */ components: Record\u0026lt;string, ConcreteComponent\u0026gt; | null; /** * Resolved directive registry, only for components with mixins or extends * @internal */ directives: Record\u0026lt;string, Directive\u0026gt; | null; /** * reoslved props options * @internal */ propsOptions: NormalizedPropsOptions; /** * resolved emits options * @internal */ emitsOptions: ObjectEmitsOptions | null; // the rest are only for stateful components ---------------------------------  // main proxy that serves as the public instance (`this`)  proxy: ComponentPublicInstance | null; // exposed properties via expose()  exposed: Record\u0026lt;string, any\u0026gt; | null; /** * alternative proxy used only for runtime-compiled render functions using * `with` block * @internal */ withProxy: ComponentPublicInstance | null; /** * This is the target for the public instance proxy. It also holds properties * injected by user options (computed, methods etc.) and user-attached * custom properties (via `this.x = ...`) * @internal */ ctx: Data; // state  data: Data; props: Data; attrs: Data; slots: InternalSlots; refs: Data; emit: EmitFn; /** * used for keeping track of .once event handlers on components * @internal */ emitted: Record\u0026lt;string, boolean\u0026gt; | null; /** * setup related * @internal */ setupState: Data; /** * devtools access to additional info * @internal */ devtoolsRawSetupState?: any; /** * @internal */ setupContext: SetupContext | null; /** * suspense related * @internal */ suspense: SuspenseBoundary | null; /** * suspense pending batch id * @internal */ suspenseId: number; /** * @internal */ asyncDep: Promise\u0026lt;any\u0026gt; | null; /** * @internal */ asyncResolved: boolean; // lifecycle  isMounted: boolean; isUnmounted: boolean; isDeactivated: boolean; /** * @internal */ [LifecycleHooks.BEFORE_CREATE]: LifecycleHook; /** * @internal */ [LifecycleHooks.CREATED]: LifecycleHook; /** * @internal */ [LifecycleHooks.BEFORE_MOUNT]: LifecycleHook; /** * @internal */ [LifecycleHooks.MOUNTED]: LifecycleHook; /** * @internal */ [LifecycleHooks.BEFORE_UPDATE]: LifecycleHook; /** * @internal */ [LifecycleHooks.UPDATED]: LifecycleHook; /** * @internal */ [LifecycleHooks.BEFORE_UNMOUNT]: LifecycleHook; /** * @internal */ [LifecycleHooks.UNMOUNTED]: LifecycleHook; /** * @internal */ [LifecycleHooks.RENDER_TRACKED]: LifecycleHook; /** * @internal */ [LifecycleHooks.RENDER_TRIGGERED]: LifecycleHook; /** * @internal */ [LifecycleHooks.ACTIVATED]: LifecycleHook; /** * @internal */ [LifecycleHooks.DEACTIVATED]: LifecycleHook; /** * @internal */ [LifecycleHooks.ERROR_CAPTURED]: LifecycleHook; }      emit fn äº‹ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  export type EmitFn\u0026lt; Options = ObjectEmitsOptions, Event extends keyof Options = keyof Options \u0026gt; = Options extends Array\u0026lt;infer V\u0026gt; ? (event: V, ...args: any[]) =\u0026gt; void : {} extends Options // if the emit is empty object (usually the default value for emit) should be converted to function  ? (event: string, ...args: any[]) =\u0026gt; void : UnionToIntersection\u0026lt; { [key in Event]: Options[key] extends (...args: infer Args) =\u0026gt; any ? (event: key, ...args: Args) =\u0026gt; void : (event: key, ...args: any[]) =\u0026gt; void; }[Event] \u0026gt;;        ","permalink":"https://www.cheng92.com/vue/vue-mind-map-runtime-core-1/","tags":["vue,","vue3,","runtime-core"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1)"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n å£°æ˜ ï¼švue-next compiler-ssr æœåŠ¡ç«¯æ¸²æŸ“æ¨¡å—ï¼Œç›¸å…³çš„æ‰€æœ‰æµ‹è¯•ä»£ç å‡åœ¨ /js/vue/ ç›®å½•ä¸‹é¢ã€‚\n æ›´æ–°æ—¥å¿—\u0026amp;Todos ï¼š\n  [2021-01-04 20:11:43] åˆ›å»º\n  [2021-01-08 10:11:47] å®Œæˆ\n    æ¨¡å—åˆå§‹åŒ–ï¼šfeat(init): compiler-ssr Â· gcclll/stb-vue-next@dff9d31 Â· GitHub\n è„‘å›¾ï¼š\n Tip    ssr ä¸å¤„ç† v-on/v-once/v-cloak ä¸‰ä¸ªæŒ‡ä»¤\n  v-show è½¬æˆ exp ? \u0026#39;null\u0026#39; : {display: \u0026#39;none\u0026#39;} åˆå¹¶åˆ° style\n  \u0026lt;Suspense\u0026gt; ç»„ä»¶ï¼Œä¼šå°†æ‰€æœ‰ children æ”¾åˆ°ä¸€ä¸ª await å‡½æ•°é‡Œé¢æ‰§è¡Œ\n  \u0026lt;Teleport\u0026gt; ä½œç”¨ï¼Ÿ\n    05db578 compiler-ssr init   feat(init): compiler-ssr -\u0026gt; compile function Â· gcclll/stb-vue-next@05db578 Â· GitHub\n æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  export function compile( template: string, options: CompilerOptions = {} ): CodegenResult { options = { ...options, // å¼•ç”¨ DOM parser é€‰é¡¹  ...parserOptions, ssr: true, scopeId: options.mode === \u0026#39;function\u0026#39; ? null : options.scopeId, // æ€»æ˜¯åŠ ä¸Šå‰ç¼€ï¼Œssr ä¸éœ€è¦å…³ç³»å¤§å°  prefixIdentifiers: true, // ssr ä¸‹ä¸éœ€è¦ç¼“å­˜å’Œé™æ€æå‡ä¼˜åŒ–  cacheHandlers: false, hoistStatic: false } const ast = baseParse(template, options) // TODO Save raw options for AST. This is needed when performing sub-transforms  // on slot vnode branches.  transform(ast, { ...options, nodeTransforms: [ // TODO ... ssr transforms  ...(options.nodeTransforms || []) // user transforms  ], directiveTransforms: { // å¤ç”¨ compiler-core çš„ v-bind  bind: transformBind, // TODO ... more ssr directive transforms  ...(options.directiveTransforms || {}) // user transforms  } }) // TODO traverse the template AST and convert into SSR codegen AST  // by replacing ast.codegenNode.  // å°† compiler-core é˜¶æ®µç”Ÿæˆçš„ codegenNode è½¬æ¢æˆ SSR codegen AST  return generate(ast, options) }     æ²¿ç”¨ compiler-core çš„ä¸‰ä¸ªé˜¶æ®µ(parse -\u0026gt; transform -\u0026gt; generate)ï¼Œå¦åŠ ä¸Š SSR æ¸²æŸ“ç›¸ å…³çš„é€‰é¡¹å’Œå…¶å¯¹åº”çš„ transforms å‡½æ•°ã€‚\nssr text testing  1 2 3 4 5 6 7 8 9 10 11 12 13  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { code, matched, ast } = ssr(\u0026#34;foo\u0026#34;); log([\u0026#34;codegenNode: \u0026#34;, ast.codegenNode || \u0026#34;null\u0026#34;]); log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; render function\u0026#39;) log(code)    codegenNode: null \u0026gt;\u0026gt;\u0026gt; render function return function ssrRender(_ctx, _push, _parent, _attrs) { null } undefined   ç»“æœæ˜¾ç¤ºæ²¡æœ‰ codegenNodeï¼Œ ssrRender å‡½æ•°ä½“å†…ä¹Ÿå°±å•¥éƒ½æ²¡æœ‰ã€‚\n FIX: åº”è¯¥éœ€è¦éœ€è¦å®ç° ssrCodegenTransform ã€‚\n åé¢çš„æ‰€æœ‰æµ‹è¯•éƒ½ä¼šä¾èµ–ä¸‹é¢çš„æ­£åˆ™(å®˜æ–¹ç”¨ä¾‹ä¸­çš„ä»£ç )ï¼š\n /_push\\(\\`\u0026lt;div\\${\\s*_ssrRenderAttrs\\(_attrs\\)\\s*}\u0026gt;([^]*)\u0026lt;\\/div\u0026gt;\\`\\)/\n      54ad7e2 coding ssrCodegenTransform function   feat(add): compiler-ssr-\u0026gt; ssrCodegenTransform function Â· gcclll/stb-vue-next@54ad7e2 Â· GitHub\n ç”Ÿæˆ ssr codegenNode çš„ transform å‡½æ•°ã€‚\n å¤§è‡´æµç¨‹å’Œ compiler-core å·®ä¸å¤šã€‚\n  åˆ›å»ºä¸Šä¸‹æ–‡ context = createSSRTransformContext(ast, options)\n  options.ssrCssVars æ ·å¼å˜é‡å¤„ç†\n  å¦‚æœå¤šä¸ªä¸”è‡³å°‘æœ‰ä¸€ä¸ªä¸ºéæ–‡æœ¬èŠ‚ç‚¹ï¼Œéœ€è¦ç”¨åˆ° fragment\n  processChildren é€’å½’å¤„ç†æ‰€æœ‰å­©å­èŠ‚ç‚¹ï¼Œç”Ÿæˆ codegenNode , æ‰€ä»¥è¿™é‡Œæ˜¯ æ ¸å¿ƒ\n  helpers åˆå¹¶\n  1 2 3 4 5 6 7 8 9 10 11 12 13  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR: ssr, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { code, ast, matched } = ssr(\u0026#34;foo\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; ast.children\\n\u0026#34;, ast.children]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; ast.codegenNode.body\\n\u0026#34;, ast.codegenNode.body]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; code\\n\u0026#34;, code]);    \u0026gt;\u0026gt;\u0026gt; ast.children [ { type: 2, content: \u0026#39;foo\u0026#39;, loc: { start: [Object], end: [Object], source: \u0026#39;foo\u0026#39; } } ] \u0026gt;\u0026gt;\u0026gt; ast.codegenNode.body [ { type: 14, loc: { source: \u0026#39;\u0026#39;, start: [Object], end: [Object] }, callee: \u0026#39;_push\u0026#39;, arguments: [ [Object] ] } ] \u0026gt;\u0026gt;\u0026gt; code return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`foo`) } undefined   Bug1: body é‡Œé¢æ²¡ä¸œè¥¿, fix: body null Â· gcclll/stb-vue-next@f6d22c1 Â· GitHub\n Bug2: div æ²¡æœ‰è¢«è§£æåˆ°ï¼Œå› ä¸ºæ²¡æœ‰å®ç° ssrTransformElement æ‰€æœ‰è¿™é‡Œè¦å…ˆå®ç°å®ƒï¼Œ æµ‹è¯•ç”¨ä¾‹ä¸­é»˜è®¤æ˜¯ \u0026lt;div\u0026gt;${src}\u0026lt;/div\u0026gt; åŒ…èµ·æ¥çš„ã€‚\n å› ä¸ºæµ‹è¯•å‡½æ•° getCompiledSSRString ä¸­ä¼šå°† src ç”¨ \u0026lt;div\u0026gt; åŒ…è£¹èµ·æ¥ï¼Œæ‰€ä»¥éœ€è¦å…ˆå® ç° div çš„è§£æï¼Œå³ NodeTypes.ELEMENT ç±»å‹è§£æã€‚\n   561d41b ELEMENT: ssrTransformElement   feat(add): ssr-\u0026gt;ssrTransformElement Â· gcclll/stb-vue-next@561d41b Â· GitHub\n æ–°å¢ä¸¤ä¸ªå‡½æ•°å®ç°ï¼š\n  ssrProcessElement å¤„ç†æ ‡ç­¾\n  ssrPostTransformElement ELEMENT çš„è½¬æ¢å‡½æ•°\n  1 2 3 4 5 6 7 8 9 10  const { compileSFCScript, compileStyle, getCompiledSSRString: ssrs, compileSSR: ssr, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { code, ast, matched } = ssrs(\u0026#34;foo\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; code\\n\u0026#34;, code]);    \u0026gt;\u0026gt;\u0026gt; code return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div\u0026gt;foo\u0026lt;/div\u0026gt;`) } undefined   è¿˜æ˜¯æ²¡æœ‰ _ssrRenderAttrs åŒ¹é…å¤±è´¥ï¼Œä¸æœŸå¾…ç»“æœè¿˜å·®ä¸€æ­¥ï¼šå±æ€§è§£æã€‚\n feat(add): directives and node transforms from compiler-core Â· gcclll/stb-vue-next@dc15719 Â· GitHub\n  ea6bb01 add ssrInjectFallthroughAttrs æ³¨å…¥å±æ€§   feat(add): ssr-\u0026gt; add ssrInjectFallthroughAttrs Â· gcclll/stb-vue-next@ea6bb01 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  export const ssrInjectFallthroughAttrs: NodeTransform = (node, context) =\u0026gt; { // _attrs is provided as a function argument.  // mark it as a known identifier so that it doesn\u0026#39;t get prefixed by  // transformExpression.  if (node.type === NodeTypes.ROOT) { context.identifiers._attrs = 1; } const parent = context.parent; if (!parent || parent.type !== NodeTypes.ROOT) { return; } if (node.type === NodeTypes.IF_BRANCH \u0026amp;\u0026amp; hasSingleChild(node)) { injectFallThroughAttrs(node.children[0]); } else if (hasSingleChild(parent)) { injectFallThroughAttrs(node); } };     è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å°† render å‡½æ•°çš„ attrs å‚æ•°å¤„ç†æˆ v-bind æŒ‡ä»¤ã€‚\n å‰ææ¡ä»¶ï¼š\n  å¿…é¡»è¦æœ‰ parent çˆ¶å…ƒç´ ï¼Œå³ ROOT èŠ‚ç‚¹ä¸ä¼šå¤„ç†\n  ä¸” parent å¿…é¡»æ˜¯ ROOT èŠ‚ç‚¹ï¼Œå³ attrs ä¼šæ³¨å…¥åˆ°ç¬¬ä¸€ä¸ªæœ€å¤–å±‚çš„å…ƒç´ ä¸Š\n æ¯”å¦‚ï¼šå®ä¾‹ä¸­çš„ \u0026lt;div\u0026gt;${src}\u0026lt;/div\u0026gt; ï¼Œ render å‡½æ•°ä¸­çš„ attrs ä¼šè¢«æ³¨å…¥åˆ°è¿™ä¸ª div ä¸Šï¼Œè¿™ä¹Ÿæ˜¯ _ssrRenderAttrs çš„ç”±æ¥ã€‚\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11  const { compileSFCScript, compileStyle, getCompiledSSRString: ssrs, compileSSR: ssr, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { code, ast, matched } = ssrs(\u0026#34;foo\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; code\\n\u0026#34;, code]); log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; ast.children[0].props\\n\u0026#39;, ast.children[0].props])    \u0026gt;\u0026gt;\u0026gt; code return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div\u0026gt;foo\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; ast.children[0].props [ { type: 7, name: \u0026#39;bind\u0026#39;, arg: undefined, exp: { type: 4, loc: [Object], content: \u0026#39;_attrs\u0026#39;, isStatic: false, constType: 0 }, modifiers: [], loc: { source: \u0026#39;\u0026#39;, start: [Object], end: [Object] } } ] undefined   è™½ç„¶ç»“æœè¿˜æ²¡è¾¾é¢„æœŸï¼Œä½†æ˜¯ä¸Šé¢ç»“æœæ˜¾ç¤ºå·²ç»æœ‰å±æ€§äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è¦å¤„ç†è¿™ä¸ªå±æ€§äº†ï¼Œ è¿™ä¸ªåœ¨ ssrTransformElement ä¸­å¤„ç†ã€‚\n  7d20acd ELEMENT: ssrTransformElement\u0026gt;v-bind   feat(add): ssr-\u0026gt;element:v-bind Â· gcclll/stb-vue-next@7d20acd Â· GitHub\n æ–°å¢å¤„ç†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // éœ€è¦è¿è¡Œæ—¶åšç‰¹æ®Šå¤„ç† const needTagForRuntime = node.tag === \u0026#34;textarea\u0026#34; || node.tag.indexOf(\u0026#34;-\u0026#34;) \u0026gt; 0; // 1. TODO v-bind // v-bind=\u0026#34;obj\u0026#34; or v-bind:[key] can potentially overwrite other static // attrs and can affect final rendering result, so when they are present // we need to bail out to full `renderAttrs` const hasDynamicVBind = hasDynamicKeyVBind(node); if (hasDynamicVBind) { const { props } = buildProps(node, context, node.props, true /* ssr */); if (props) { const propsExp = createCallExpression(context.helper(SSR_RENDER_ATTRS), [ props, ]); if (node.tag === \u0026#34;textarea\u0026#34;) { // TODO  } else if (node.tag === \u0026#34;input\u0026#34;) { // TODO  } if (needTagForRuntime) { propsExp.arguments.push(`\u0026#34;${node.tag}\u0026#34;`); } openTag.push(propsExp); } }     å› ä¸ºåœ¨ä¸Šä¸€èŠ‚ä¸­å°† attrs æ³¨å†Œä¸ºäº† v-bind å±æ€§ï¼Œå› æ­¤åœ¨ transform element ä¸­å°±æœ‰ Props éœ€è¦å¤„ç†äº†ï¼Œ ssrRenderAttrs å°±æ˜¯åœ¨è¿™é‡Œå¢åŠ äº† SSR_RENDER_ATTRS ã€‚\n1 2 3 4 5 6 7 8 9 10  const { compileSFCScript, compileStyle, getCompiledSSRString: ssrs, compileSSR: ssr, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { code, ast, matched } = ssrs(\u0026#34;foo\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; code\\n\u0026#34;, code]);    \u0026gt;\u0026gt;\u0026gt; code const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;foo\u0026lt;/div\u0026gt;`) } undefined   åˆ°è¿™é‡Œç®—æ˜¯èƒ½æ»¡è¶³æµ‹è¯•ç”¨ä¾‹ä¸­çš„æ­£åˆ™è¦æ±‚äº†ã€‚\n _attrs æ³¨å…¥é€»è¾‘è„‘å›¾ï¼š   f6d22c1 TEXT èŠ‚ç‚¹ç±»å‹è§£æ   fix: body null Â· gcclll/stb-vue-next@f6d22c1 Â· GitHub\n æ–°å¢ pushStringPart å‡½æ•°çš„å®ç°ï¼Œç”¨æ¥å¤„ç† NodeTypes.TEXT èŠ‚ç‚¹ç±»å‹ã€‚\n1 2 3 4 5  switch (child.type) { case NodeTypes.TEXT: context.pushStringPart(escapeHtml(child.content)); break; }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssrs, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬\\n\u0026#34;, ssrs(\u0026#34;foo\u0026#34;).code]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬ï¼Œå«åæ–œæ \\n\u0026#34;, ssrs(`\\\\$foo`).code]); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬ï¼Œ\u0026amp;lt; ç­‰ç¬¦å·çš„\\n\u0026#34;, ssrs(`\u0026amp;lt;foo\u0026amp;gt;`).code]); log([ \u0026#34;\u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬ï¼Œå…ƒç´ åµŒå¥—\\n\u0026#34;, ssrs(`\u0026lt;div\u0026gt;\u0026lt;span\u0026gt;hello\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;bye\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;`).code, ]);    \u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬ const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;foo\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬ï¼Œå«åæ–œæ  const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\\\\\\$foo\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬ï¼Œ\u0026amp;lt; ç­‰ç¬¦å·çš„ const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026amp;lt;foo\u0026amp;gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; é™æ€æ–‡æœ¬ï¼Œå…ƒç´ åµŒå¥— const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;div\u0026gt;\u0026lt;span\u0026gt;hello\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;bye\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined    8f09472 INTERPOLATION æ’å€¼å¤„ç†   feat(add): ssr-\u0026gt;interpolation Â· gcclll/stb-vue-next@8f09472 Â· GitHub\n å¢åŠ ä»£ç ï¼š\n1 2 3 4 5  case NodeTypes.INTERPOLATION: context.pushStringPart( createCallExpression(context.helper(SSR_INTERPOLATE), [child.content]) ) break     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; æ’å€¼å¤„ç†\\n\u0026#34;, ssr(`\\`\\${foo}\\``).code]) log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; æ’å€¼å¤„ç†ï¼Œå…ƒç´ åµŒå¥—\\n\u0026#34;, ssr(`\u0026lt;div\u0026gt;\u0026lt;span\u0026gt;{{ foo }} bar\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;baz {{ qux }}\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; æ’å€¼å¤„ç† const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\\`\\${foo}\\`\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; æ’å€¼å¤„ç†ï¼Œå…ƒç´ åµŒå¥— const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div\u0026gt;\u0026lt;span\u0026gt;${ _ssrInterpolate(_ctx.foo) } bar\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;baz ${ _ssrInterpolate(_ctx.qux) }\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined   ç¬¬ä¸€ä¸ªå¹¶éç›´æ¥çš„å·®å€¼ï¼Œè€Œæ˜¯å­—ç¬¦ä¸²å½¢å¼ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å½“åšæ’å€¼å¤„ç†ã€‚\n åé¢çš„å·®å€¼è°ƒç”¨ _ssrInterpolate(_ctx.foo) å¤„ç†\n  ssrTransformElement ç»­  954a9ee static class å±æ€§å¤„ç†   feat(add): ssr-\u0026gt;static class attr Â· gcclll/stb-vue-next@954a9ee Â· GitHub\n é™æ€ class å±æ€§å¤„ç†:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  for (let i = 0; i \u0026lt; node.props.length; i++) { const prop = node.props[i]; // å¿½ç•¥ input ä¸Šçš„ true å€¼æˆ– false å€¼  if (node.tag === \u0026#34;input\u0026#34; \u0026amp;\u0026amp; isTrueFalseValue(prop)) { continue; } // special cases with children override  if (prop.type === NodeTypes.DIRECTIVE) { // TODO æŒ‡ä»¤å¤„ç†  } else { if (node.tag === \u0026#34;textarea\u0026#34; \u0026amp;\u0026amp; prop.name === \u0026#34;value\u0026#34; \u0026amp;\u0026amp; prop.value) { // TODO ç‰¹æ®Šæƒ…å†µï¼švalue on \u0026lt;textarea\u0026gt;  } else if (!hasDynamicVBind) { if (prop.name === \u0026#34;key\u0026#34; || prop.name === \u0026#34;ref\u0026#34;) { continue; } // static prop  if (prop.name === \u0026#34;class\u0026#34; \u0026amp;\u0026amp; prop.value) { staticClassBinding = JSON.stringify(prop.value.content); } openTag.push( ` ${prop.name}` + (prop.value ? `=\u0026#34;${escapeHtml(prop.value.content)}\u0026#34;` : ``) ); } } }     class å¤„ç†éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7  // static prop if (prop.name === \u0026#34;class\u0026#34; \u0026amp;\u0026amp; prop.value) { staticClassBinding = JSON.stringify(prop.value.content); } openTag.push( ` ${prop.name}` + (prop.value ? `=\u0026#34;${escapeHtml(prop.value.content)}\u0026#34;` : ``) );     ç­‰äºæ˜¯å°† class=\u0026#34;bar\u0026#34; åŸæ ·æ·»åŠ åˆ° openTag ä¸­äº†ï¼Œåªä¸è¿‡è¿™é‡Œå¯¹å€¼ç”¨ escapeHtml å¤„ ç†äº†ä¸€ä¸‹ã€‚\n åŒ¹é…ï¼š const escapeRE = /[\u0026#34;\u0026#39;\u0026amp;\u0026lt;\u0026gt;]/ æ›¿æ¢æˆå¯¹åº”çš„\n   char value     \u0026#34; \u0026amp;quot;   \u0026amp; \u0026amp;amp;   \u0026#39; \u0026amp;#39;   \u0026lt; \u0026amp;lt;   \u0026gt; \u0026amp;gt;     å¦‚ä¸‹æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; static class\\n\u0026#34;, ssr(\u0026#39;\u0026lt;div class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;p class=\u0026#34;foo\u0026gt;\u0026#34;\u0026gt;\u0026lt;/p\u0026gt;\u0026#39;).code]); log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; ref/key å±æ€§ä¼šè¢«å¿½ç•¥ï¼Œä¸è®ºé™æ€è¿˜æ˜¯åŠ¨æ€\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div key=\u0026#34;1\u0026#34; ref=\u0026#34;el\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; ref/key å±æ€§ä¼šè¢«å¿½ç•¥ï¼Œä¸è®ºé™æ€è¿˜æ˜¯åŠ¨æ€\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div :key=\u0026#34;1\u0026#34; :ref=\u0026#34;el\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code])    \u0026gt;\u0026gt;\u0026gt; static class const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;div class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;p class=\u0026#34;foo\u0026amp;gt;\u0026#34;\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; ref/key å±æ€§ä¼šè¢«å¿½ç•¥ï¼Œä¸è®ºé™æ€è¿˜æ˜¯åŠ¨æ€ const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; ref/key å±æ€§ä¼šè¢«å¿½ç•¥ï¼Œä¸è®ºé™æ€è¿˜æ˜¯åŠ¨æ€ const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined    c28d528 dynamic class å±æ€§å¤„ç†   feat(add): ssr-\u0026gt;dynamic class Â· gcclll/stb-vue-next@c28d528 Â· GitHub\n å½“æ—¢æœ‰ static ä¹Ÿæœ‰ dynamic class æ—¶éœ€è¦è¿›è¡Œåˆå¹¶ï¼Œä¸”æ˜¯å°† static å¾€ dynamic ä¸Šè¿›è¡Œ åˆå¹¶ï¼Œæœ€åæˆä¸ºåŠ¨æ€çš„ classã€‚\n æ–°å¢å¤„ç†é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10  if (attrName === \u0026#34;class\u0026#34;) { openTag.push( ` class=\u0026#34;`, (dynamicClassBinding = createCallExpression( context.helper(SSR_RENDER_CLASS), [value] )), `\u0026#34;` ); }     å¦‚æœä¹Ÿæœ‰é™æ€å±æ€§çš„æ—¶å€™ï¼Œå°†ä¸¤è€…åˆå¹¶ï¼Œéœ€è¦ç”¨åˆ°ä¸¤ä¸ªå‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function mergeCall(call: CallExpression, arg: string | JSChildNode) { const existing = call.arguments[0] as ExpressionNode | ArrayExpression; if (existing.type === NodeTypes.JS_ARRAY_EXPRESSION) { existing.elements.push(arg); } else { call.arguments[0] = createArrayExpression([existing, arg]); } } function removeStaticBinding( tag: TemplateLiteral[\u0026#34;elements\u0026#34;], binding: string ) { const regExp = new RegExp(`^ ${binding}=\u0026#34;.+\u0026#34;$`); const i = tag.findIndex((e) =\u0026gt; typeof e === \u0026#34;string\u0026#34; \u0026amp;\u0026amp; regExp.test(e)); if (i \u0026gt; -1) { tag.splice(i, 1); } }     mergeCall: å°†é™æ€ class åˆå¹¶åˆ°åŠ¨æ€ class ä¸Š removeStaticBinding: åˆ é™¤åŸæ¥çš„é™æ€ class å±æ€§\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; dynamic class\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div :class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; static class\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div class=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; static + dynamic class\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div class=\u0026#34;foo\u0026#34; :class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code])    \u0026gt;\u0026gt;\u0026gt; dynamic class const { ssrRenderClass: _ssrRenderClass, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div class=\u0026#34;${ _ssrRenderClass(_ctx.bar) }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; static class const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;div class=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; static + dynamic class const { ssrRenderClass: _ssrRenderClass, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div class=\u0026#34;${ _ssrRenderClass([_ctx.bar, \u0026#34;foo\u0026#34;]) }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined   é€»è¾‘è„‘å›¾ï¼š   ca39229 style å±æ€§å¤„ç†   feat(add): ssr-\u0026gt;style prop Â· gcclll/stb-vue-next@ca39229 Â· GitHub\n æ–°å¢å¤„ç†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  if (attrName === \u0026#34;style\u0026#34;) { // :style  if (dynamicStyleBinding) { // å·²ç»æœ‰ style åˆå¹¶  mergeCall(dynamicStyleBinding, value); } else { openTag.push( ` style=\u0026#34;`, (dynamicStyleBinding = createCallExpression( context.helper(SSR_RENDER_STYLE), [value] )), `\u0026#34;` ); } }    1 2 3 4 5 6 7  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; static style\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div style=\u0026#34;color:red\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; dynamic style\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div :style=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; dynamic + static style\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div :style=\u0026#34;bar\u0026#34; style=\u0026#34;color:red\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code])    \u0026gt;\u0026gt;\u0026gt; static style const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div style=\u0026#34;${ _ssrRenderStyle({\u0026#34;color\u0026#34;:\u0026#34;red\u0026#34;}) }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; dynamic style const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div style=\u0026#34;${ _ssrRenderStyle(_ctx.bar) }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; dynamic + static style const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div style=\u0026#34;${ _ssrRenderStyle([_ctx.bar, {\u0026#34;color\u0026#34;:\u0026#34;red\u0026#34;}]) }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined    dfd4fb9 v-html æŒ‡ä»¤å¤„ç†   feat(add): ssr-\u0026gt;v-html directive Â· gcclll/stb-vue-next@dfd4fb9 Â· GitHub\n è¿™ä¸ªå¤„ç†åœ¨ ssrTransformElement ä¸­åªéœ€è¦å¢åŠ ä¸€è¡Œä»£ç å°±OKï¼Œä½†æ˜¯éœ€è¦ç»“åˆ ssrProcessElement æ¥è¿›è¡Œå¤„ç†ã€‚\n1 2 3  if (prop.name === \u0026#34;html\u0026#34; \u0026amp;\u0026amp; prop.exp /* v-html */) { rawChildrenMap.set(node, prop.exp); }     ssrProcessElement ä¸­ä¼šå¯¹ rawChildrenMap è¿›è¡Œå¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  export function ssrProcessElement( node: PlainElementNode, context: SSRTransformContext ) { // ...  // å·²ç¼“å­˜çš„å¤„ç†ç»“æœ  const rawChildren = rawChildrenMap.get(node); if (rawChildren) { context.pushStringPart(rawChildren); } else if (node.children.length) { processChildren(node.children, context); } // ... }     æµ‹è¯•ï¼š\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; v-html\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div v-html=\u0026#34;foo\u0026#34;/\u0026gt;\u0026#39;).code])     ç›´æ¥è¿›è¡Œå€¼æ›¿æ¢ã€‚\n   678e98a v-text æŒ‡ä»¤å¤„ç†   feat(add): ssr-\u0026gt;v-text directive Â· gcclll/stb-vue-next@678e98a Â· GitHub\n è¿™é‡Œæ˜¯ç”¨æ’å€¼æ–¹å¼æ¥å¤„ç†äº† v-text ï¼š\n1 2 3  if (prop.name === \u0026#34;text\u0026#34; \u0026amp;\u0026amp; prop.exp /* v-text */) { node.children = [createInterpolation(prop.exp, prop.loc)]; }     æµ‹è¯•ï¼š\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log(ssr(\u0026#39;\u0026lt;div v-text=\u0026#34;foo\u0026#34;/\u0026gt;\u0026#39;).code)    const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div\u0026gt;${ _ssrInterpolate(_ctx.foo) }\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined     0472dfd v-slot æŒ‡ä»¤é”™è¯¯   feat(add): ssr-\u0026gt;v-slot directive Â· gcclll/stb-vue-next@0472dfd Â· GitHub\n ç”±äºæŒ‡ä»¤ä¸èƒ½åº”ç”¨äºé component æˆ– template ç»„ä»¶ä¸Šï¼Œæ‰€ä»¥è¿™é‡Œæ— æ³•é€‚ç”¨ã€‚\n  45e78e1 v-bind æŒ‡ä»¤   feat(add): ssr-\u0026gt;v-bind Â· gcclll/stb-vue-next@45e78e1 Â· GitHub\n ä¸‹é¢çš„æµ‹è¯•ä¸ºç»¼åˆæƒ…å†µæµ‹è¯•ï¼ŒåŒ…å«å¤§éƒ¨åˆ†ä½¿ç”¨æƒ…å†µã€‚\n  v-bind:arg(non-boolean)\n  v-bind:[arg] åŠ¨æ€å‚æ•°å¤„ç†\n  v-bind:[arg] + v-bind æ··åˆæ–¹å¼\n  style + :style\n  class + :class\n  v-on ä¼šè¢«å¿½ç•¥\n  key/ref æ— è®ºé™æ€åŠ¨æ€éƒ½ä¼šè¢«å¿½ç•¥\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); log( ssr(`\u0026lt;div style=\u0026#34;color:red\u0026#34; :style=\u0026#34;baz\u0026#34; class=\u0026#34;foo\u0026#34; :class=\u0026#34;bar\u0026#34; :[key]=\u0026#34;value\u0026#34; :id=\u0026#34;id\u0026#34; v-bind=\u0026#34;obj\u0026#34; v-on=\u0026#34;fxx\u0026#34; @click=\u0026#34;fxc\u0026#34; :key=\u0026#34;1\u0026#34; :ref=\u0026#34;el\u0026#34; \u0026gt;\u0026lt;/div\u0026gt;`).code );    const { mergeProps: _mergeProps } = require(\u0026#34;vue\u0026#34;) const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div${ _ssrRenderAttrs(_mergeProps({ style: [{\u0026#34;color\u0026#34;:\u0026#34;red\u0026#34;}, _ctx.baz], class: [\u0026#34;foo\u0026#34;, _ctx.bar], [_ctx.key || \u0026#34;\u0026#34;]: _ctx.value, id: _ctx.id }, _ctx.obj, { key: 1, ref: _ctx.el })) }\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined   key, ref ä¸ºä»€ä¹ˆæ²¡æœ‰å¿½ç•¥ï¼Ÿï¼Ÿï¼Ÿ\n    value on textarea   e79e343 static value   feat(add): ssr-\u0026gt;static value on textarea Â· gcclll/stb-vue-next@e79e343 Â· GitHub\n é™æ€ value å¤„ç†å¾ˆç®€å•ï¼Œç›´æ¥å½“åšå­èŠ‚ç‚¹æ›¿æ¢ã€‚\n1 2 3 4  if (node.tag === \u0026#34;textarea\u0026#34; \u0026amp;\u0026amp; prop.name === \u0026#34;value\u0026#34; \u0026amp;\u0026amp; prop.value) { // ç‰¹æ®Šæƒ…å†µï¼švalue on \u0026lt;textarea\u0026gt;  rawChildrenMap.set(node, escapeHtml(prop.value.content)); }     æµ‹è¯•\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString:ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; static value on textarea\\n\u0026#39;, ssr(\u0026#39;\u0026lt;textarea value=\u0026#34;fo\u0026amp;gt;o\u0026#34;/\u0026gt;\u0026#39;).code])    \u0026gt;\u0026gt;\u0026gt; static value on textarea const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;textarea\u0026gt;fo\u0026amp;gt;o\u0026lt;/textarea\u0026gt;\u0026lt;/div\u0026gt;`) } undefined    dynamic value   å¤„ç†ä»£ç ï¼š\n1 2 3 4 5  if (isTextareaWithValue(node, prop) \u0026amp;\u0026amp; prop.exp /* textarea with value */) { if (!hasDynamicVBind) { node.children = [createInterpolation(prop.exp, prop.loc)]; } }     å½“åšæ’å€¼ç±»å‹å¤„ç†ï¼Œä½œä¸ºå­©å­èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); log(ssr(\u0026#39;\u0026lt;textarea :value=\u0026#34;foo\u0026#34;/\u0026gt;\u0026#39;).code);    const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;textarea\u0026gt;${ _ssrInterpolate(_ctx.foo) }\u0026lt;/textarea\u0026gt;\u0026lt;/div\u0026gt;`) } undefined    cdd8fd0 dynamic arg åŠ¨æ€å‚æ•°   feat(add): ssr-\u0026gt;dynamic arg on textarea Â· gcclll/stb-vue-next@cdd8fd0 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  if (node.tag === \u0026#34;textarea\u0026#34;) { // TODO  const existingText = node.children[0] as | TextNode | InterpolationNode | undefined; // If interpolation, this is dynamic \u0026lt;textarea\u0026gt; content, potentially  // injected by v-model and takes higher priority than v-bind value  // v-model çš„ä¼˜å…ˆçº§é«˜äº v-bind value  if (!existingText || existingText.type !== NodeTypes.INTERPOLATION) { // \u0026lt;textarea\u0026gt; with dynamic v-bind. We don\u0026#39;t know if the final props  // will contain .value, so we will have to do something special:  // assign the merged props to a temp variable, and check whether  // it contains value (if yes, render is as children).  // å½“ textarea åŒ…å«åŠ¨æ€å‚æ•°æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç¡®å®šæœ€åçš„ç»“æœæ˜¯å¦åŒ…å« .value  // å› æ­¤æˆ‘ä»¬å°†ä¸å¾—ä¸åšäº›ç‰¹æ®Šå¤„ç†æ¥åº”å¯¹ï¼š  // å°†å·²åˆå¹¶çš„ props ä¿å­˜æˆä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œç„¶åæ£€æŸ¥å®ƒæ˜¯å¦åŒ…å« value å±æ€§(å¦‚æœ  // åŒ…å«ï¼Œåˆ™å°†å®ƒå½“åš children æ¥æ¸²æŸ“)  const tempId = `_temp${context.temps++}`; propsExp.arguments = [ createAssignmentExpression(createSimpleExpression(tempId, false), props), ]; rawChildrenMap.set( node, createCallExpression(context.helper(SSR_INTERPOLATE), [ createConditionalExpression( createSimpleExpression(`\u0026#34;value\u0026#34; in ${tempId}`, false), createSimpleExpression(`${tempId}.value`, false), createSimpleExpression( existingText ? existingText.content : ``, true ), false ), ]) ); } }     åœ¨åŒ…å«åŠ¨æ€å‚æ•°çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç¡®å®šæœ€ç»ˆå‚æ•°åå°±æ˜¯ value æ‰€ä»¥éœ€è¦åšäº›ç‰¹æ®Šå¤„ç†ã€‚\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log(ssr(`\u0026lt;textarea v-bind=\u0026#34;obj\u0026#34;\u0026gt;fallback\u0026lt;/textarea\u0026gt;`).code)    const { mergeProps: _mergeProps } = require(\u0026#34;vue\u0026#34;) const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { let _temp0 _push(`\u0026lt;textarea${ _ssrRenderAttrs(_temp0 = _mergeProps(_ctx.obj, _attrs), \u0026#34;textarea\u0026#34;) }\u0026gt;${ _ssrInterpolate((\u0026#34;value\u0026#34; in _temp0) ? _temp0.value : \u0026#34;fallback\u0026#34;) }\u0026lt;/textarea\u0026gt;`) } undefined   ç­‰äºå…ˆå°†æ‰€æœ‰å±æ€§åˆå¹¶èµ·æ¥ï¼Œåœ¨è¿è¡Œæ—¶å†³å®šæ˜¯å¦æœ‰ value å±æ€§ï¼Œå¦‚æœå­˜åœ¨å°±ä½¿ç”¨è¿™ä¸ªå€¼ å†…å®¹å¡«å…… \u0026lt;textarea\u0026gt; å­©å­èŠ‚ç‚¹ï¼Œå¦åˆ™ç›´æ¥ä½¿ç”¨åŸæ¥çš„å­©å­èŠ‚ç‚¹å†…å®¹(å¦‚: \u0026#34;fallback\u0026#34;)\n æºç å¤„ç†ä¸­æœ‰ä¸¤ä¸ªå‰ææ¡ä»¶ï¼Œæ‰ä¼šè¿™æ ·å¤„ç†\n  æ²¡æœ‰å­©å­èŠ‚ç‚¹\n  æˆ–è€…å­©å­èŠ‚ç‚¹ä¸æ˜¯æ’å€¼ç±»å‹\n  å³å¦‚æœæœ‰æ’å€¼ç±»å‹çš„å­©å­èŠ‚ç‚¹ï¼Œæ˜¯ä¸ä¼šè¿›è¡Œå¦‚ä¸Šçš„å¤„ç†çš„ï¼Œçœ‹ä¸‹é¢çš„å®ä¾‹ï¼š\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR: ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log(ssr(\u0026#39;\u0026lt;textarea v-bind=\u0026#34;obj\u0026#34;\u0026gt;{{ foo }}\u0026lt;/textarea\u0026gt;\u0026#39;).code)    const { mergeProps: _mergeProps } = require(\u0026#34;vue\u0026#34;) const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;textarea${ _ssrRenderAttrs(_mergeProps(_ctx.obj, _attrs), \u0026#34;textarea\u0026#34;) }\u0026gt;${ _ssrInterpolate(_ctx.foo) }\u0026lt;/textarea\u0026gt;`) } undefined   ç»“æœå¦‚ä¸Š â†‘ã€‚\n    b97d467 input + boolean attr   feat(add): ssr-\u0026gt;v-bind boolean on input Â· gcclll/stb-vue-next@b97d467 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); log([\u0026#34;\u0026gt;\u0026gt;\u0026gt; input\\n\u0026#34;, ssr(\u0026#34;\u0026lt;input\u0026gt;\u0026#34;).code]); log([ \u0026#34;\u0026gt;\u0026gt;\u0026gt; input with v-bind:arg(boolean)\\n\u0026#34;, ssr(`\u0026lt;input type=\u0026#34;checkbox\u0026#34; :checked=\u0026#34;checked\u0026#34;\u0026gt;`).code, ]);    \u0026gt;\u0026gt;\u0026gt; input const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;input\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; input with v-bind:arg(boolean) const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;input type=\u0026#34;checkbox\u0026#34;${ (_ctx.checked) ? \u0026#34; checked\u0026#34; : \u0026#34;\u0026#34; }\u0026gt;\u0026lt;/div\u0026gt;`) } undefined   TODO å¯¹äº v-bind + v-model çš„ç»“åˆä½¿ç”¨ï¼Œéœ€è¦å®ç° ssrTransformModel å‡½æ•°ï¼Œè¿™é‡Œæš‚æ—¶ä¸åšå¤„ç†ã€‚\n   TODO e58d062 dynamic key attr   feat(add): ssr-\u0026gt;dynamic key attr Â· gcclll/stb-vue-next@e58d062 Â· GitHub\n    893681b v-model transform   feat(add): ssr-\u0026gt;v-model, text type Â· gcclll/stb-vue-next@893681b Â· GitHub\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString:ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; \u0026lt;input\u0026gt; (text typesï¼Œé»˜è®¤)\u0026#39;, ssr(`\u0026lt;input v-model=\u0026#34;bar\u0026#34;\u0026gt;`).code])     è„‘å›¾ï¼š\n 7502230 input type: radio   feat(add): ssr-\u0026gt;v-model, type radio Â· gcclll/stb-vue-next@7502230 Â· GitHub\n v-model æ ¹æ® modelè¡¨è¾¾å¼çš„å€¼å’Œ value å±æ€§çš„å€¼ï¼Œåˆ¤æ–­æœ€ç»ˆè½¬æˆ checked å±æ€§ (\u0026lt;input type=\u0026#34;radio\u0026#34; checked\u0026gt;)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  if (type.value) { // é™æ€ç±»å‹  switch (type.value.content) { case \u0026#34;radio\u0026#34;: res.props = [ createObjectProperty( `checked`, createCallExpression(context.helper(SSR_LOOSE_EQUAL), [model, value]) ), ]; break; } }     æµ‹è¯•ï¼š\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString:ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log(ssr(`\u0026lt;input type=\u0026#34;radio\u0026#34; value=\u0026#34;foo\u0026#34; v-model=\u0026#34;bar\u0026#34;\u0026gt;`).code)    const { ssrLooseEqual: _ssrLooseEqual, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;input type=\u0026#34;radio\u0026#34; value=\u0026#34;foo\u0026#34;${ (_ssrLooseEqual(_ctx.bar, \u0026#34;foo\u0026#34;)) ? \u0026#34; checked\u0026#34; : \u0026#34;\u0026#34; }\u0026gt;\u0026lt;/div\u0026gt;`) } undefined    input type: checkbox   ç±»å‹ä¸º checkbox çš„æ—¶å€™è¦æ£€æŸ¥ true-value/false-value å±æ€§ã€‚\n880eaf3 with true/false-value   feat(add): ssr-\u0026gt;v-model, type checkbox with true/false-value Â· gcclll/stb-vue-next@880eaf3 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  switch (type.value.content) { // ...  case \u0026#34;checkbox\u0026#34;: const trueValueBinding = findProp(node, \u0026#34;true-value\u0026#34;); if (trueValueBinding) { const trueValue = trueValueBinding.type === NodeTypes.ATTRIBUTE ? JSON.stringify(trueValueBinding.value!.content) : trueValueBinding.exp!; res.props = [ createObjectProperty( `checked`, createCallExpression(context.helper(SSR_LOOSE_EQUAL), [ model, trueValue, ]) ), ]; } else { } break; // ... }     å¦‚æœå­˜åœ¨ true-value/false-value çš„æ—¶å€™ï¼Œæ£€æµ‹æ¡ä»¶å°±æ˜¯è¿™ä¸¤ä¸ªå€¼çš„æ¯”è¾ƒç»“æœï¼Œåªæœ‰è¿™ ä¸¤ä¸ªå€¼ç›¸ç­‰çš„æƒ…å†µä¸‹æ‰ä¼š checked ã€‚\n1 2 3 4 5 6 7  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString:ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; v-bind true-value/false-value\\n\u0026#39;, ssr(`\u0026lt;input type=\u0026#34;checkbox\u0026#34; :true-value=\u0026#34;foo\u0026#34; :false-value=\u0026#34;bar\u0026#34; v-model=\u0026#34;baz\u0026#34;\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; static true-value/false-value\\n\u0026#39;, ssr(`\u0026lt;input type=\u0026#34;checkbox\u0026#34; true-value=\u0026#34;foo\u0026#34; false-value=\u0026#34;bar\u0026#34; v-model=\u0026#34;baz\u0026#34;\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; true-value/false-value åªæœ‰å…¶ä¸­ä¸€ä¸ª\\n\u0026#39;, ssr(`\u0026lt;input type=\u0026#34;checkbox\u0026#34; false-value=\u0026#34;bar\u0026#34; v-model=\u0026#34;baz\u0026#34;\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; v-bind true-value/false-value const { ssrLooseEqual: _ssrLooseEqual, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;input type=\u0026#34;checkbox\u0026#34;${ (_ssrLooseEqual(_ctx.baz, _ctx.foo)) ? \u0026#34; checked\u0026#34; : \u0026#34;\u0026#34; }\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; static true-value/false-value const { ssrLooseEqual: _ssrLooseEqual, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;input type=\u0026#34;checkbox\u0026#34;${ (_ssrLooseEqual(_ctx.baz, \u0026#34;foo\u0026#34;)) ? \u0026#34; checked\u0026#34; : \u0026#34;\u0026#34; }\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; true-value/false-value åªæœ‰å…¶ä¸­ä¸€ä¸ª const { ssrLooseContain: _ssrLooseContain, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;input type=\u0026#34;checkbox\u0026#34;${ ((Array.isArray(_ctx.baz)) ? _ssrLooseContain(_ctx.baz, null) : _ctx.baz) ? \u0026#34; checked\u0026#34; : \u0026#34;\u0026#34; }\u0026gt;\u0026lt;/div\u0026gt;`) } undefined   â“ ä¸ºä»€ä¹ˆ false-value è¿˜åœ¨ï¼Ÿ\n FIX: fix: false.value -\u0026gt; false-value Â· gcclll/stb-vue-next@e0fc173 Â· GitHub\n  ä»ç»“æœçœ‹ï¼Œè²Œä¼¼ false-value å¹¶æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œç”¨åˆ°çš„åªæœ‰ true-value å»å’Œ v-model è¡¨è¾¾å¼å€¼è¿›è¡Œæ¯”è¾ƒã€‚\n  59b1577 without true/false-value   feat(add): ssr-\u0026gt;v-model, type checkbox without true/false-value Â· gcclll/stb-vue-next@59b1577 Â· GitHub\n1 2 3 4 5 6 7 8 9 10  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); log(ssr(`\u0026lt;input type=\u0026#34;checkbox\u0026#34; value=\u0026#34;foo\u0026#34; v-model=\u0026#34;bar\u0026#34;\u0026gt;`).code);    const { ssrLooseContain: _ssrLooseContain, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;input type=\u0026#34;checkbox\u0026#34; value=\u0026#34;foo\u0026#34;${ ((Array.isArray(_ctx.bar)) ? _ssrLooseContain(_ctx.bar, \u0026#34;foo\u0026#34;) : _ctx.bar) ? \u0026#34; checked\u0026#34; : \u0026#34;\u0026#34; }\u0026gt;\u0026lt;/div\u0026gt;`) } undefined   _ssrLooseContain(_ctx.bar, \u0026#34;foo\u0026#34;) ç®€å•çš„æ•°ç»„æ‰¾å€¼æ“ä½œï¼š\n1 2 3  export function ssrLooseContain(arr: unknown[], value: unknown): boolean { return looseIndexOf(arr, value) \u0026gt; -1; }     ç›¸å½“äºï¼Œå¦‚æœ v-model=\u0026#34;bar\u0026#34; çš„å€¼ bar æ˜¯ä¸ªæ•°ç»„ï¼Œåªéœ€è¦å…¶ä¸­æœ‰ä¸€ä¸ªæ»¡è¶³æ¡ä»¶å°±ä¼š checked ï¼Œè¿™ä¹Ÿæ˜¯ç»å¸¸ä½¿ç”¨åˆ°çš„æ–¹å¼ï¼Œå°†ä¸€ç»„æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ªæ•°ç»„é‡Œé¢ï¼Œç„¶åå¯¹åº”ä¸€ç»„ checkboxs ç”¨æ¥æ§åˆ¶è¿™äº›ç»„ä»¶çš„é€‰ä¸­æœªé€‰ä¸­çŠ¶æ€ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  \u0026lt;template\u0026gt; \u0026lt;input type=\u0026#34;checkbox\u0026#34; value=\u0026#34;1\u0026#34; v-model=\u0026#34;checkedBoxes\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;checkbox\u0026#34; value=\u0026#34;2\u0026#34; v-model=\u0026#34;checkedBoxes\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;checkbox\u0026#34; value=\u0026#34;3\u0026#34; v-model=\u0026#34;checkedBoxes\u0026#34;\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; export default { data() { return { checkedBoxes: [1, 2, 3] } } } \u0026lt;script\u0026gt;     å°±å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œåªè¦ checkedBoxes é‡Œé¢çš„å€¼å‘ç”Ÿæ”¹å˜ï¼Œå°±ä¼šè§¦å‘ checkbox çŠ¶æ€æ›´ æ–°ï¼Œä¸”åªæœ‰åœ¨æ•°ç»„å†…çš„å€¼ä¸å½“å‰ checkbox çš„ value å±æ€§å€¼ç›¸ç­‰å°±ä¼šè¢«é€‰ä¸­ï¼Œåä¹‹ä¸ä¼š è¢«é€‰ä¸­ã€‚\n    a0d4a40 input type: file æ—¶ä¸èƒ½ç”¨ v-model   feat(add): ssr-\u0026gt;v-model, type file with v-model error Â· gcclll/stb-vue-next@a0d4a40 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString: ssr, compileSSR, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); try { ssr(\u0026#39;\u0026lt;input type=\u0026#34;file\u0026#34; v-model=\u0026#34;foo\u0026#34;\u0026gt;\u0026#39;); } catch (e) { console.log(e.message); }    v-model cannot be used on file inputs since they are read-only. Use a v-on:change listener instead. undefined    d7309be v-model on textarea   feat(add): ssr-\u0026gt;v-model on textarea Â· gcclll/stb-vue-next@d7309be Â· GitHub\n å½“åšæ’å€¼å¤„ç†ï¼Œæ›¿æ¢æˆå­©å­èŠ‚ç‚¹ã€‚\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString:ssr, compileSSR, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log(ssr(`\u0026lt;textarea v-model=\u0026#34;foo\u0026#34;\u0026gt;bar\u0026lt;/textarea\u0026gt;`).code)    const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;textarea\u0026gt;${ _ssrInterpolate(_ctx.foo) }\u0026lt;/textarea\u0026gt;\u0026lt;/div\u0026gt;`) } undefined      169027e v-show transform   feat(add): ssr-\u0026gt;v-show Â· gcclll/stb-vue-next@169027e Â· GitHub\n v-show æŒ‡ä»¤çš„å¤„ç†ç›¸å¯¹ç®€å•ï¼Œæ ¹æ®æŒ‡ä»¤è¡¨è¾¾å¼å€¼ï¼Œåˆ›å»ºä¸€ä¸ªä¸‰å…ƒæ¡ä»¶è¡¨è¾¾å¼ï¼Œåˆ©ç”¨ display:none å±æ€§éšè—å…ƒç´ (éåˆ é™¤æ“ä½œ)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  export const ssrTransformShow: DirectiveTransform = (dir, node, context) =\u0026gt; { if (!dir.exp) { context.onError( createDOMCompilerError(DOMErrorCodes.X_V_SHOW_NO_EXPRESSION) ); } return { props: [ createObjectProperty( `style`, // -\u0026gt; dir.exp ? `null` : `display:none`  createConditionalExpression( dir.exp!, createSimpleExpression(`null`, false), createObjectExpression([ createObjectProperty( `display`, createSimpleExpression(`none`, true) ), ]), false /* no newline */ ) ), ], }; };     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString:ssrs, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic ä½œä¸ºæ ¹èŠ‚ç‚¹\\n\u0026#39;, ssr(`\u0026lt;div v-show=\u0026#34;foo\u0026#34;/\u0026gt;`).code]) log([\u0026#39;\\n\u0026gt;\u0026gt;\u0026gt; basic éæ ¹èŠ‚ç‚¹\\n\u0026#39;, ssrs(`\u0026lt;div v-show=\u0026#34;foo\u0026#34;/\u0026gt;`).code]) log([\u0026#39;\\n\u0026gt;\u0026gt;\u0026gt; basic éæ ¹èŠ‚ç‚¹ï¼ŒåŒ…å«é™æ€å’ŒåŠ¨æ€ style\\n\u0026#39;, ssrs(`\u0026lt;div v-show=\u0026#34;foo\u0026#34; style=\u0026#34;color:red\u0026#34; :style=\u0026#34;bar\u0026#34;/\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; basic ä½œä¸ºæ ¹èŠ‚ç‚¹ const { mergeProps: _mergeProps } = require(\u0026#34;vue\u0026#34;) const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${_ssrRenderAttrs(_mergeProps({ style: (_ctx.foo) ? null : { display: \u0026#34;none\u0026#34; } }, _attrs))}\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; basic éæ ¹èŠ‚ç‚¹ const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div style=\u0026#34;${ _ssrRenderStyle((_ctx.foo) ? null : { display: \u0026#34;none\u0026#34; }) }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; basic éæ ¹èŠ‚ç‚¹ï¼ŒåŒ…å«é™æ€å’ŒåŠ¨æ€ style const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;div${ _ssrRenderAttrs(_attrs) }\u0026gt;\u0026lt;div style=\u0026#34;${ _ssrRenderStyle([ (_ctx.foo) ? null : { display: \u0026#34;none\u0026#34; }, {\u0026#34;color\u0026#34;:\u0026#34;red\u0026#34;}, _ctx.bar ]) }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;`) } undefined    5bf3644 v-if transform   feat(add): ssr-\u0026gt;v-if Â· gcclll/stb-vue-next@5bf3644 Â· GitHub\n ssrTransformIf ä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨äº† compiler-core: transformIf è¿›è¡Œå¤„ç†ã€‚\n fix: ssr-\u0026gt;template v-if no ] Â· gcclll/stb-vue-next@094d5c0 Â· GitHub\n1 2 3 4 5 6  // Plugin for the first transform pass, which simply constructs the AST node // å…ˆç»è¿‡ core: transformIf å¤„ç†ä¸€é“ export const ssrTransformIf = createStructuralDirectiveTransform( /^(if|else|else-if)$/, processIf )     å‰©ä¸‹çš„ ssr çš„éƒ¨åˆ†ï¼Œéœ€è¦ç”¨åˆ° ssrProcessIf() è¿›è¡Œå•ç‹¬å¤„ç†ã€‚\n1 2 3 4 5  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { code, ast } = ssr(\u0026#39;\u0026lt;div v-if=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;) log([ast.children[0].branches[0], \u0026#39;\\n\u0026#39;, code])    { type: 10, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 23, line: 1, offset: 22 }, source: \u0026#39;\u0026lt;div v-if=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39; }, condition: { type: 4, content: \u0026#39;_ctx.foo\u0026#39;, isStatic: false, constType: 0, loc: { start: [Object], end: [Object], source: \u0026#39;foo\u0026#39; } }, children: [ { type: 1, ns: 0, tag: \u0026#39;div\u0026#39;, tagType: 0, props: [Array], isSelfClosing: false, children: [], loc: [Object], codegenNode: undefined, ssrCodegenNode: [Object] } ], userKey: undefined } const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { } undefined   å•¥ä¹Ÿæ²¡æœ‰ï¼Ÿ\n ä½†æ˜¯ä» ast.children[0].branches[0] ç»“æœçœ‹ç¡®å®è¢« core æ­£ç¡®å¤„ç†äº†\n æ‰€ä»¥è¿˜æ˜¯éœ€è¦å®ç° ssrProcessIf() å¹¶ä¸”åœ¨ ssrCodegenTransform-\u0026gt;processChildren å¢åŠ  NodeTypes.IF åˆ†æ”¯å¤„ç†ã€‚\n åŠ ä¸Š ssrProcessIf å†æµ‹è¯•ä¸€é(æµ‹è¯•å‡æ¥è‡ªå®˜æ–¹æµ‹è¯•ç”¨ä¾‹ ssrVIf.spec.ts å…¶ä»–åŒ)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic\\n\u0026#39;, ssr(\u0026#39;\u0026lt;div v-if=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;).code]) log([\u0026#39;\\n\u0026gt;\u0026gt;\u0026gt; with nested content\\n\u0026#39;, ssr(`\u0026lt;div v-if=\u0026#34;foo\u0026#34;\u0026gt;hello\u0026lt;span\u0026gt;ok\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; v-if + v-else\\n\u0026#39;, ssr(`\u0026lt;div v-if=\u0026#34;foo\u0026#34;/\u0026gt;\u0026lt;span v-else/\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; v-if + v-else-if\\n\u0026#39;, ssr(`\u0026lt;div v-if=\u0026#34;foo\u0026#34;/\u0026gt;\u0026lt;span v-else-if=\u0026#34;bar\u0026#34;/\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; v-if + v-else-if + v-else\\n\u0026#39;, ssr(`\u0026lt;div v-if=\u0026#34;foo\u0026#34;/\u0026gt;\u0026lt;span v-else-if=\u0026#34;bar\u0026#34;/\u0026gt;\u0026lt;span v-else/\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt;(text)\u0026#39;, ssr(`\u0026lt;template v-if=\u0026#34;foo\u0026#34;\u0026gt;hello\u0026lt;/template\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt;(single element)\u0026#39;, ssr(`\u0026lt;template v-if=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;div\u0026gt;hi\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt;(multiple element)\u0026#39;, ssr(`\u0026lt;template v-if=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;div\u0026gt;hi\u0026lt;/div\u0026gt;\u0026lt;div\u0026gt;hi\u0026lt;/div\u0026gt;\u0026lt;div\u0026gt;ho\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt;`).code]) // v-for transform åˆ°æ­¤è¿˜æ²¡å®ç°ï¼Œæ‰€ä»¥è¿™ä¸ªä¼šæŠ¥é”™ // log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt; (with v-for inside)\u0026#39;, ssr(`\u0026lt;template v-if=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;div v-for=\u0026#34;i in list\u0026#34;/\u0026gt;\u0026lt;/template\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt; + normal v-else\u0026#39;, ssr(`\u0026lt;template v-if=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;div\u0026gt;hi\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt;\u0026lt;div v-else/\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; basic const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/div\u0026gt;`) } else { _push(`\u0026lt;!----\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; with nested content const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;hello\u0026lt;span\u0026gt;ok\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;`) } else { _push(`\u0026lt;!----\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; v-if + v-else const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/div\u0026gt;`) } else { _push(`\u0026lt;span${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/span\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; v-if + v-else-if const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/div\u0026gt;`) } else if (_ctx.bar) { _push(`\u0026lt;span${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/span\u0026gt;`) } else { _push(`\u0026lt;!----\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; v-if + v-else-if + v-else const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/div\u0026gt;`) } else if (_ctx.bar) { _push(`\u0026lt;span${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/span\u0026gt;`) } else { _push(`\u0026lt;span${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/span\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt;(text) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;!--[--\u0026gt;hello\u0026lt;!--]--\u0026gt;`) } else { _push(`\u0026lt;!----\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt;(single element) const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;hi\u0026lt;/div\u0026gt;`) } else { _push(`\u0026lt;!----\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt;(multiple element) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;!--[--\u0026gt;\u0026lt;div\u0026gt;hi\u0026lt;/div\u0026gt;\u0026lt;div\u0026gt;hi\u0026lt;/div\u0026gt;\u0026lt;div\u0026gt;ho\u0026lt;/div\u0026gt;\u0026lt;!--]--\u0026gt;`) } else { _push(`\u0026lt;!----\u0026gt;`) } } \u0026gt;\u0026gt;\u0026gt; \u0026lt;template v-if\u0026gt; + normal v-else const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { if (_ctx.foo) { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;hi\u0026lt;/div\u0026gt;`) } else { _push(`\u0026lt;div${_ssrRenderAttrs(_attrs)}\u0026gt;\u0026lt;/div\u0026gt;`) } } undefined   ä¸ºä»€ä¹ˆæ˜¯ if(){}else{} ???\n è¿™ä¸ªè¦è¿½æº¯åˆ° compiler-core: codegen.ts é‡Œé¢å¯¹ ssr ç¯å¢ƒä¸‹çš„ if æŒ‡ä»¤çš„å¤„ç†ä»£ç ï¼š\n1 2 3 4 5  switch (node.type) { case NodeTypes.JS_IF_STATEMENT: !__BROWSER__ \u0026amp;\u0026amp; genIfStatement(node, context); break; }     è¿™ä¸ª genIfStatement å°±æ˜¯ç”¨æ¥ç”Ÿæˆ if...else ä»£ç çš„ã€‚\n è„‘å›¾ï¼š  æ‰€ä»¥ ssr v-if å¤„ç†å¤§è‡´æµç¨‹ç®€å•åˆ†ä¸¤æ­¥ï¼š\n  core: transformIf å¾—åˆ° node.branches\n  ssrProcessIf å¤„ç†ï¼Œç”Ÿæˆ if -\u0026gt; else if -\u0026gt; else\n    4839090 v-for transform   fix: ssr-\u0026gt;v-for add transform Â· gcclll/stb-vue-next@4839090 Â· GitHub\n ä¸»è¦è¿˜æ˜¯å€ŸåŠ©äº† compiler-core: transformFor å¤„ç†é€»è¾‘ï¼ŒåŠ ä¸Š ssrProcessFor åŠ å·¥å¤„ç† äº†ä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic\\n\u0026#39;, ssr(`\u0026lt;div v-for=\u0026#34;i in list\u0026#34; /\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; nested content\\n\u0026#39;, ssr(`\u0026lt;div v-for=\u0026#34;i in list\u0026#34;\u0026gt;foo\u0026lt;span\u0026gt;bar\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; nested v-for\\n\u0026#39;, ssr(`\u0026lt;div v-for=\u0026#34;row, i in list\u0026#34;\u0026gt;` + `\u0026lt;div v-for=\u0026#34;j in row\u0026#34;\u0026gt;{{ i }},{{ j }}\u0026lt;/div\u0026gt;` + `\u0026lt;/div\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; template v-for(text)\\n\u0026#39;, ssr(`\u0026lt;template v-for=\u0026#34;i in list\u0026#34;\u0026gt;{{ i }}\u0026lt;/template\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; template v-for (single element)\\n\u0026#39;, ssr(`\u0026lt;template v-for=\u0026#34;i in list\u0026#34;\u0026gt;\u0026lt;span\u0026gt;{{ i }}\u0026lt;/span\u0026gt;\u0026lt;/template\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; template v-for (multi element)\\n\u0026#39;, ssr(`\u0026lt;template v-for=\u0026#34;i in list\u0026#34;\u0026gt;\u0026lt;span\u0026gt;{{ i }}\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;{{ i + 1 }}\u0026lt;/span\u0026gt;\u0026lt;/template\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; render loop args should not be prefixed\\n\u0026#39;, \u0026#39;\u0026gt; render loop å¾ªç¯å›è°ƒçš„å‚æ•°ä¸åº”è¯¥åŠ å‰ç¼€\\n\u0026#39;, ssr(`\u0026lt;div v-for=\u0026#34;{ foo }, index in list\u0026#34;\u0026gt;{{ foo + bar + index }}\u0026lt;/div\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; basic const { ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; nested content const { ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;foo\u0026lt;span\u0026gt;bar\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; nested v-for const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, (row, i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;!--[--\u0026gt;`) _ssrRenderList(row, (j) =\u0026gt; { _push(`\u0026lt;div\u0026gt;${ _ssrInterpolate(i) },${ _ssrInterpolate(j) }\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; template v-for(text) const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;!--[--\u0026gt;${_ssrInterpolate(i)}\u0026lt;!--]--\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; template v-for (single element) const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;span\u0026gt;${_ssrInterpolate(i)}\u0026lt;/span\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; template v-for (multi element) const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;!--[--\u0026gt;\u0026lt;span\u0026gt;${ _ssrInterpolate(i) }\u0026lt;/span\u0026gt;\u0026lt;span\u0026gt;${ _ssrInterpolate(i + 1) }\u0026lt;/span\u0026gt;\u0026lt;!--]--\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; render loop args should not be prefixed \u0026gt; render loop å¾ªç¯å›è°ƒçš„å‚æ•°ä¸åº”è¯¥åŠ å‰ç¼€ const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, ({ foo }, index) =\u0026gt; { _push(`\u0026lt;div\u0026gt;${_ssrInterpolate(foo + _ctx.bar + index)}\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } undefined   ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  export function ssrProcessFor( node: ForNode, context: SSRTransformContext, disableNestedFragments = false ) { // éœ€è¦ Fragment çš„æ¡ä»¶  // 1. disableNestedFragments = false  // 2. æœ‰ä¸¤ä¸ªåŠä»¥ä¸Šçš„å­©å­èŠ‚ç‚¹æˆ–è€…ç¬¬ä¸€ä¸ªå­©å­èŠ‚ç‚¹çš„ç±»å‹ä¸æ˜¯ ELEMENTï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·ç»„ä»¶ï¼‰  const needFragmentWrapper = !disableNestedFragments \u0026amp;\u0026amp; (node.children.length !== 1 || node.children[0].type !== NodeTypes.ELEMENT) // åˆ›å»º for (...) è¡¨è¾¾å¼  const renderLoop = createFunctionExpression( createForLoopParams(node.parseResult) ) renderLoop.body = processChildrenAsStatement( node.children, context, needFragmentWrapper ) // v-for always renders a fragment unless explicitly disabled  if (!disableNestedFragments) { context.pushStringPart(`\u0026lt;!--[--\u0026gt;`) } // åˆ›å»ºè¡¨è¾¾å¼  context.pushStatement( createCallExpression(context.helper(SSR_RENDER_LIST), [ node.source, renderLoop ]) ) if (!disableNestedFragments) { context.pushStringPart(`\u0026lt;!--]--\u0026gt;`) } }     v-for å¤„ç†é™¤äº† tranformFor å‰©ä¸‹çš„å¤„ç†éƒ½åœ¨è¿™ä¸ª ssrProcessFor é‡Œé¢äº†ã€‚\n  8036837 å…¶ä»–ä¸éœ€è¦å¤„ç†çš„æƒ…å†µ   fix: ssr-\u0026gt;add other useless cases in process children Â· gcclll/stb-vue-next@8036837 Â· GitHub\n æ¯”å¦‚ï¼š\n  IF_BRANCH åœ¨ ssrProcessIf ä¸­è¢«å¤„ç†äº†\n  TEXT_CALL å’Œ COMPOUND_EXPRESSION åœ¨ ssr ä¸­ä¸ä¼šè¢«ç”¨åˆ°\n  COMMENT æ³¨é‡Šç®€å•çš„è¿˜åŸå¤„ç†å³å¯\n    TODO 16833be component transform   fix: ssr-\u0026gt;component transform Â· gcclll/stb-vue-next@16833be Â· GitHub\n 1 2 3 4 5 6 7  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR: ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic\\n\u0026#39;, ssr(`\u0026lt;foo id=\u0026#34;a\u0026#34; :prop=\u0026#34;b\u0026#34; /\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; åŠ¨æ€ç»„ä»¶ is\\n\u0026#39;, ssr(`\u0026lt;component is=\u0026#34;foo\u0026#34; prop=\u0026#34;b\u0026#34; /\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; åŠ¨æ€ç»„ä»¶ :is\\n\u0026#39;, ssr(`\u0026lt;component :is=\u0026#34;foo\u0026#34; prop=\u0026#34;b\u0026#34; /\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; basic const { resolveComponent: _resolveComponent, mergeProps: _mergeProps } = require(\u0026#34;vue\u0026#34;) const { ssrRenderComponent: _ssrRenderComponent } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { const _component_foo = _resolveComponent(\u0026#34;foo\u0026#34;) _push(_ssrRenderComponent(_component_foo, _mergeProps({ id: \u0026#34;a\u0026#34;, prop: _ctx.b }, _attrs), null, _parent)) } \u0026gt;\u0026gt;\u0026gt; åŠ¨æ€ç»„ä»¶ is const { resolveDynamicComponent: _resolveDynamicComponent, mergeProps: _mergeProps, createVNode: _createVNode } = require(\u0026#34;vue\u0026#34;) const { ssrRenderVNode: _ssrRenderVNode } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderVNode(_push, _createVNode(_resolveDynamicComponent(\u0026#34;foo\u0026#34;), _mergeProps({ prop: \u0026#34;b\u0026#34; }, _attrs), null), _parent) } \u0026gt;\u0026gt;\u0026gt; åŠ¨æ€ç»„ä»¶ :is const { resolveDynamicComponent: _resolveDynamicComponent, mergeProps: _mergeProps, createVNode: _createVNode } = require(\u0026#34;vue\u0026#34;) const { ssrRenderVNode: _ssrRenderVNode } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderVNode(_push, _createVNode(_resolveDynamicComponent(_ctx.foo), _mergeProps({ prop: \u0026#34;b\u0026#34; }, _attrs), null), _parent) } undefined    cdba013 component slot outlet   feat(add): ssr-\u0026gt;slot outlet transform Â· gcclll/stb-vue-next@cdba013 Â· GitHub\n \u0026lt;slot\u0026gt;\u0026lt;/slot\u0026gt; æ’æ§½å¤„ç†ã€‚\n å¤„ç†é€»è¾‘ï¼š\n  transform é˜¶æ®µ -\u0026gt; ssrTransformSlotOutlet\n è¿™é‡Œè¿˜åªæ˜¯åˆ›å»ºäº† ssrCodegenNode å¹¶æ²¡æœ‰å®é™…åˆ›å»º render å‡½æ•°\n1  _ssrRenderSlot(_ctx.$slots, slotName, slotProps, fallback, _push, _parent)      codegen å¤„ç† -\u0026gt; ssrCodgenTransform\n è¿™ä¸ªé˜¶æ®µæ˜¯æ‰©å±• 1 ä¸­çš„ç¬¬å››ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ fallbackï¼Œæ£€æµ‹ \u0026lt;slot\u0026gt;\u0026lt;/slot\u0026gt; ä¸‹æ˜¯ä¸ æ˜¯æœ‰å­©å­èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å½“åš fallback å¤„ç†ï¼Œæ›¿æ¢ node.ssrCodegenNode.arguments[3] çš„å€¼ã€‚\n   1 2 3 4 5 6 7 8 9  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic\\n\u0026#39;, ssr(`\u0026lt;slot/\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; with named\\n\u0026#39;, ssr(`\u0026lt;slot name=\u0026#34;foo\u0026#34;/\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; with dynamic named\\n\u0026#39;, ssr(`\u0026lt;slot :name=\u0026#34;bar.baz\u0026#34;/\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; with props and fallback\\n\u0026#39;, ssr(`\u0026lt;slot name=\u0026#34;foo\u0026#34; :p1=\u0026#34;1\u0026#34; bar=\u0026#34;2\u0026#34; \u0026gt;some {{ fallback }} content\u0026lt;/slot\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; with fallback\\n\u0026#39;, ssr(`\u0026lt;slot\u0026gt;some {{ fallback }} content\u0026lt;/slot\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; basic const { ssrRenderSlot: _ssrRenderSlot } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderSlot(_ctx.$slots, \u0026#34;default\u0026#34;, {}, null, _push, _parent) } \u0026gt;\u0026gt;\u0026gt; with named const { ssrRenderSlot: _ssrRenderSlot } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderSlot(_ctx.$slots, \u0026#34;foo\u0026#34;, {}, null, _push, _parent) } \u0026gt;\u0026gt;\u0026gt; with dynamic named const { ssrRenderSlot: _ssrRenderSlot } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderSlot(_ctx.$slots, _ctx.bar.baz, {}, null, _push, _parent) } \u0026gt;\u0026gt;\u0026gt; with props and fallback const { ssrRenderSlot: _ssrRenderSlot, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderSlot(_ctx.$slots, \u0026#34;foo\u0026#34;, { p1: 1, bar: \u0026#34;2\u0026#34; }, () =\u0026gt; { _push(`some ${_ssrInterpolate(_ctx.fallback)} content`) }, _push, _parent) } \u0026gt;\u0026gt;\u0026gt; with fallback const { ssrRenderSlot: _ssrRenderSlot, ssrInterpolate: _ssrInterpolate } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderSlot(_ctx.$slots, \u0026#34;default\u0026#34;, {}, () =\u0026gt; { _push(`some ${_ssrInterpolate(_ctx.fallback)} content`) }, _push, _parent) } undefined   ssrRenderSlot å‡½æ•°å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  export function ssrRenderSlot( slots: Slots | SSRSlots, slotName: string, slotProps: Props, fallbackRenderFn: (() =\u0026gt; void) | null, push: PushFn, parentComponent: ComponentInternalInstance ) { // template-compiled slots are always rendered as fragments  push(`\u0026lt;!--[--\u0026gt;`) const slotFn = slots[slotName] if (slotFn) { const scopeId = parentComponent \u0026amp;\u0026amp; parentComponent.type.__scopeId const ret = slotFn( slotProps, push, parentComponent, scopeId ? ` ${scopeId}-s` : `` ) if (Array.isArray(ret)) { // normal slot  renderVNodeChildren(push, ret, parentComponent) } } else if (fallbackRenderFn) { fallbackRenderFn() } push(`\u0026lt;!--]--\u0026gt;`) }     fallback ç”¨é€”ï¼šåœ¨æ²¡æœ‰ä»»ä½• slot template æ—¶å€™ä¼šé»˜è®¤ç”¨ fallback é‡Œçš„å†…å®¹æ¥æ¸²æŸ“è¿™ä¸ª slotã€‚\n å¦‚ï¼š\n1 2 3 4 5 6 7 8  \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;slot\u0026gt;some content\u0026lt;/slot\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- å½“å¼•ç”¨è¿™ä¸ªç»„ä»¶çš„ç»„ä»¶æ²¡æœ‰æä¾›ä»»ä½• slot æ¨¡æ¿çš„æ—¶å€™ï¼š ç›¸å½“äºç›´æ¥ä½¿ç”¨ fallback æ›¿æ¢æ’æ§½--\u0026gt; \u0026lt;div\u0026gt;some content\u0026lt;/div\u0026gt;      359f856 suspense å†…ç½®ç»„ä»¶   feat(add): ssr-\u0026gt;slot suspense component Â· gcclll/stb-vue-next@359f856 Â· GitHub\n 1 2 3 4 5 6 7 8 9 10 11 12 13  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; implicit default\\n\u0026#39;, ssr(`\u0026lt;suspense\u0026gt;\u0026lt;foo/\u0026gt;\u0026lt;/suspense\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; explicit slots\\n\u0026#39;, ssr(`\u0026lt;suspense\u0026gt; \u0026lt;template #default\u0026gt; \u0026lt;foo/\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;template #fallback\u0026gt; loading... \u0026lt;/template\u0026gt; \u0026lt;/suspense\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; implicit default const { resolveComponent: _resolveComponent, withCtx: _withCtx } = require(\u0026#34;vue\u0026#34;) const { ssrRenderComponent: _ssrRenderComponent, ssrRenderSuspense: _ssrRenderSuspense } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { const _component_foo = _resolveComponent(\u0026#34;foo\u0026#34;) _ssrRenderSuspense(_push, { default: () =\u0026gt; { _push(_ssrRenderComponent(_component_foo, null, null, _parent)) }, _: 1 /* STABLE */ }) } \u0026gt;\u0026gt;\u0026gt; explicit slots const { resolveComponent: _resolveComponent, withCtx: _withCtx } = require(\u0026#34;vue\u0026#34;) const { ssrRenderComponent: _ssrRenderComponent, ssrRenderSuspense: _ssrRenderSuspense } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { const _component_foo = _resolveComponent(\u0026#34;foo\u0026#34;) _ssrRenderSuspense(_push, { default: () =\u0026gt; { _push(_ssrRenderComponent(_component_foo, null, null, _parent)) }, fallback: () =\u0026gt; { _push(` loading... `) }, _: 1 /* STABLE */ }) } undefined   ssrRenderSuspense å®é™…ä¸Šåªæ˜¯ä¸€ä¸ª await å¼‚æ­¥å‡½æ•°å°è£…ï¼š\n1 2 3 4 5 6 7 8 9 10 11  export async function ssrRenderSuspense( push: PushFn, { default: renderContent }: Record\u0026lt;string, (() =\u0026gt; void) | undefined\u0026gt; ) { if (renderContent) { renderContent() } else { push(`\u0026lt;!----\u0026gt;`) } }     æœ€ç»ˆå°† SUSPENSE ä¸­çš„ç»„ä»¶å¼‚æ­¥æ¸²æŸ“ã€‚\n  e27a5e4 teleport å†…ç½®ç»„ä»¶   feat(add): ssr-\u0026gt;teleport component Â· gcclll/stb-vue-next@e27a5e4 Â· GitHub\n  ä½œç”¨â“\n1 2 3 4 5 6 7  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic\\n\u0026#39;, ssr(`\u0026lt;teleport :to=\u0026#34;target\u0026#34;\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/teleport\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; disabled prop\\n\u0026#39;, ssr(`\u0026lt;teleport :to=\u0026#34;target\u0026#34; disabled\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/teleport\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; disabled prop with value\\n\u0026#39;, ssr(`\u0026lt;teleport :to=\u0026#34;target\u0026#34; :disabled=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/teleport\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; basic const { ssrRenderTeleport: _ssrRenderTeleport } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderTeleport(_push, (_push) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }, _ctx.target, false, _parent) } \u0026gt;\u0026gt;\u0026gt; disabled prop const { ssrRenderTeleport: _ssrRenderTeleport } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderTeleport(_push, (_push) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }, _ctx.target, true, _parent) } \u0026gt;\u0026gt;\u0026gt; disabled prop with value const { ssrRenderTeleport: _ssrRenderTeleport } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _ssrRenderTeleport(_push, (_push) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }, _ctx.target, _ctx.foo, _parent) } undefined   ssrRenderTeleport :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  export function ssrRenderTeleport( parentPush: PushFn, contentRenderFn: (push: PushFn) =\u0026gt; void, target: string, disabled: boolean, parentComponent: ComponentInternalInstance ) { parentPush(\u0026#39;\u0026lt;!--teleport start--\u0026gt;\u0026#39;) let teleportContent: SSRBufferItem if (disabled) { contentRenderFn(parentPush) teleportContent = `\u0026lt;!----\u0026gt;` } else { const { getBuffer, push } = createBuffer() contentRenderFn(push) push(`\u0026lt;!----\u0026gt;`) // teleport end anchor  teleportContent = getBuffer() } const context = parentComponent.appContext.provides[ ssrContextKey as any ] as SSRContext const teleportBuffers = context.__teleportBuffers || (context.__teleportBuffers = {}) if (teleportBuffers[target]) { teleportBuffers[target].push(teleportContent) } else { teleportBuffers[target] = [teleportContent] } parentPush(\u0026#39;\u0026lt;!--teleport end--\u0026gt;\u0026#39;) }      e0fc173 transition group transform   fix: false.value -\u0026gt; false-value Â· gcclll/stb-vue-next@e0fc173 Â· GitHub\n1 2 3 4 5 6 7 8 9 10 11 12  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic\\n\u0026#39;, ssr(`\u0026lt;transition-group\u0026gt;\u0026lt;div v-for=\u0026#34;i in list\u0026#34;/\u0026gt;\u0026lt;/transition-group\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; with static tag\\n\u0026#39;, ssr(`\u0026lt;transition-group tag=\u0026#34;ul\u0026#34;\u0026gt;\u0026lt;div v-for=\u0026#34;i in list\u0026#34;/\u0026gt;\u0026lt;/transition-group\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; with dynamic tag\\n\u0026#39;, ssr(`\u0026lt;transition-group :tag=\u0026#34;someTag\u0026#34;\u0026gt;\u0026lt;div v-for=\u0026#34;i in list\u0026#34;/\u0026gt;\u0026lt;/transition-group\u0026gt;`).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; with multi fragments children\\n\u0026#39;, ssr(`\u0026lt;transition-group\u0026gt; \u0026lt;div v-for=\u0026#34;i in 10\u0026#34;/\u0026gt; \u0026lt;div v-for=\u0026#34;i in 10\u0026#34;/\u0026gt; \u0026lt;template v-if=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;div\u0026gt;ok\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; \u0026lt;/transition-group\u0026gt;`).code])    \u0026gt;\u0026gt;\u0026gt; basic const { ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;!--]--\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; with static tag const { ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;ul\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;/ul\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; with dynamic tag const { ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;${_ctx.someTag}\u0026gt;`) _ssrRenderList(_ctx.list, (i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }) _push(`\u0026lt;/${_ctx.someTag}\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; with multi fragments children const { ssrRenderList: _ssrRenderList } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { _push(`\u0026lt;!--[--\u0026gt;`) _ssrRenderList(10, (i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }) _ssrRenderList(10, (i) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }) if (_ctx.ok) { _push(`\u0026lt;div\u0026gt;ok\u0026lt;/div\u0026gt;`) } else { _push(`\u0026lt;!----\u0026gt;`) } _push(`\u0026lt;!--]--\u0026gt;`) } undefined   ssrRenderList:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  export function ssrRenderList( source: unknown, renderItem: (value: unknown, key: string | number, index?: number) =\u0026gt; void ) { if (isArray(source) || isString(source)) { for (let i = 0, l = source.length; i \u0026lt; l; i++) { renderItem(source[i], i) } } else if (typeof source === \u0026#39;number\u0026#39;) { if (__DEV__ \u0026amp;\u0026amp; !Number.isInteger(source)) { warn(`The v-for range expect an integer value but got ${source}.`) return } for (let i = 0; i \u0026lt; source; i++) { renderItem(i + 1, i) } } else if (isObject(source)) { if (source[Symbol.iterator as any]) { const arr = Array.from(source as Iterable\u0026lt;any\u0026gt;) for (let i = 0, l = arr.length; i \u0026lt; l; i++) { renderItem(arr[i], i) } } else { const keys = Object.keys(source) for (let i = 0, l = keys.length; i \u0026lt; l; i++) { const key = keys[i] renderItem(source[key], key, i) } } } }       ä¹Ÿå°±æ˜¯å°† children ç›´æ¥è°ƒç”¨ renderItem æ¸²æŸ“å‡ºæ¥ï¼Œé‚£è¿™ä¸ªè·ŸåŠ¨ç”»æœ‰ä»€ä¹ˆå…³ç³»å‘¢â“\n     c8e1d56 ssrCssVars inject   feat(add): ssr-\u0026gt;ssrCssVars inject Â· gcclll/stb-vue-next@c8e1d56 Â· GitHub\n1 2 3 4 5 6  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, getCompiledSSRString, compileSSR:ssr, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; basic\\n\u0026#39;, ssr(`\u0026lt;div/\u0026gt;`, { ssrCssVars: `{ color }` }).code]) log([\u0026#39;\u0026gt;\u0026gt;\u0026gt; fragment\\n\u0026#39;, ssr(`\u0026lt;div/\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;div\u0026gt;\u0026lt;p/\u0026gt;\u0026lt;/div\u0026gt;`, { ssrCssVars: `{ color }` }).code])    \u0026gt;\u0026gt;\u0026gt; basic const { mergeProps: _mergeProps } = require(\u0026#34;vue\u0026#34;) const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { const _cssVars = { style: { color: _ctx.color }} _push(`\u0026lt;div${_ssrRenderAttrs(_mergeProps(_attrs, _cssVars))}\u0026gt;\u0026lt;/div\u0026gt;`) } \u0026gt;\u0026gt;\u0026gt; fragment const { ssrRenderAttrs: _ssrRenderAttrs } = require(\u0026#34;@vue/server-renderer\u0026#34;) return function ssrRender(_ctx, _push, _parent, _attrs) { const _cssVars = { style: { color: _ctx.color }} _push(`\u0026lt;!--[--\u0026gt;\u0026lt;div${ _ssrRenderAttrs(_cssVars) }\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;div${ _ssrRenderAttrs(_cssVars) }\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;div${ _ssrRenderAttrs(_cssVars) }\u0026gt;\u0026lt;p\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;!--]--\u0026gt;`) } undefined   cssVars å±æ€§ä¼šæ³¨å…¥åˆ°æ¯ä¸ªå¤–å±‚åŒçº§å…ƒç´ ä¸Šã€‚\n  æ€»ç»“    ELEMENT è§£æ\n  v-html: \u0026lt;div v-html=\u0026#34;foo\u0026#34;/\u0026gt; =\u0026gt; \u0026lt;div\u0026gt;${foo}\u0026lt;/div\u0026gt;\n  v-text: \u0026lt;div v-text=\u0026#34;foo\u0026#34;/\u0026gt; =\u0026gt; \u0026lt;div\u0026gt;${_ssrInterpolate(_ctx.foo)}\u0026lt;/div\u0026gt;\n  v-slot: åªèƒ½ç”¨åœ¨ \u0026lt;template\u0026gt; å’Œ \u0026lt;component\u0026gt; æˆ–ç”¨æˆ·ç»„ä»¶ä¸Š\n  v-on: ssr ä¸­ä¸å¤„ç†\n  v-bind: å¿½ç•¥ refå’Œkey å±æ€§ï¼Œclass åˆå¹¶æˆåŠ¨æ€ class å±æ€§(style ä¹Ÿä¸€æ ·)\n \u0026lt;div class=\u0026#34;foo\u0026#34; :class=\u0026#34;bar\u0026#34;/\u0026gt; \u0026gt; ~\u0026lt;div class\u0026#34;${_ssrRenderCalss([_ctx.bar, \u0026#39;foo\u0026#39;])}\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;~\n    input: radio\n \u0026lt;input type=\u0026#34;radio\u0026#34; value=\u0026#34;foo\u0026#34; v-model=\u0026#34;bar\u0026#34;\u0026gt;\n =\u0026gt;\n1  \u0026lt;input type=\u0026#34;radio\u0026#34; value=\u0026#34;${(_ssrLooseEqual(_ctx.bar, \u0026#39;foo\u0026#39;)) ? \u0026#39;checked\u0026#39; : \u0026#39;\u0026#39;}\u0026#34;\u0026gt;      input: checkbox, è¯¦æƒ…-\u0026gt;\n æœ‰å…³å±æ€§ï¼š value, true-value, false-value, v-model\n å¦‚æœä½¿ç”¨ true/false-value é…å¥—ï¼Œåˆ™åªæ”¯æŒ v-model ç»‘å®šå•ä¸ªå±æ€§å€¼ã€‚\n å¦‚æœå•ç‹¬ä½¿ç”¨ value ï¼Œåˆ™ v-model æ”¯æŒç»‘å®šä¸€ä¸ªæ•°ç»„ï¼Œåªè¦å½“å‰ checkbox çš„ value å€¼åœ¨è¯¥æ•°ç»„é‡Œé¢ï¼Œåˆ™ä¸º checked çŠ¶æ€ï¼Œå¦åˆ™éé€‰ä¸­çŠ¶æ€ã€‚\n  input: file ä¸æ”¯æŒï¼Œå¦‚æœæ²¡æœ‰ type å±æ€§ï¼Œé»˜è®¤ä¸º text\n  ssrInjectFallthroughAttrs ï¼Œå°† ssrRender å‡½æ•°çš„ _attrs å‚æ•°ä½œä¸ºå±æ€§æ³¨å…¥åˆ°æœ€å¤– å±‚çš„å…ƒç´ ä¸Šã€‚\n  INTEROLATION: æ’å€¼è°ƒç”¨ _ssrInterpolate(_ctx.foo) å¤„ç†\n  v-show æŒ‡ä»¤å¤„ç†ï¼Œå°±æ˜¯åœ¨å…ƒç´ ä¸Šå¢åŠ ä¸€ä¸ª style = { display: \u0026#39;none\u0026#39; } æ¥åˆ‡æ¢å…ƒ ç´ æ˜¾ç¤ºéšè—\n  v-if å…ˆè°ƒç”¨ compiler-core çš„ transformIf è§£æå‡º node.branchesï¼Œç„¶åä½¿ç”¨ ssr ç«¯çš„ processIf å¤„ç†æˆ if (condition) {} else if () {} else {} è¯­å¥ï¼Œè€Œä¸æ˜¯ é ssr æƒ…å†µä¸‹çš„ä¸‰å…ƒè¡¨è¾¾å¼(?:)\n  v-for æŒ‡ä»¤ä½¿ç”¨ _ssrRenderList(_ctx.list, (row, i) =\u0026gt; {...})\n  \u0026lt;slot/\u0026gt; æ ‡ç­¾çš„å¤„ç†\n1 2 3 4 5 6 7  // `\u0026lt;slot name=\u0026#34;foo\u0026#34; :p1=\u0026#34;1\u0026#34; bar=\u0026#34;2\u0026#34; \u0026gt;some {{ fallback }} content\u0026lt;/slot\u0026gt; _ssrRenderSlot(_ctx.$slots, \u0026#34;foo\u0026#34;, { p1: 1, bar: \u0026#34;2\u0026#34; }, () =\u0026gt; { _push(`some ${_ssrInterpolate(_ctx.fallback)}content`) }, _push, _parent)      \u0026lt;Suspense/\u0026gt; å†…ç½®ç»„ä»¶ï¼Œå†…éƒ¨å¤„ç†å…¶å®ç­‰äºå°† children ç”¨ä¸€ä¸ª await å‡½æ•°åŒ…è£¹ èµ·æ¥äº†ï¼Œæˆä¸ºå¼‚æ­¥æ“ä½œã€‚\n  \u0026lt;Teleport/\u0026gt; å†…ç½®ç»„ä»¶ï¼Œéœ€è¦åˆ¶å®š to=\u0026#34;target\u0026#34;\n æ”¯æŒ disabled å±æ€§\n1 2 3 4  // \u0026lt;teleport :to=\u0026#34;target\u0026#34; :disabled=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/teleport\u0026gt; _ssrRenderTeleport(_push, (_push) =\u0026gt; { _push(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) }, _ctx.target, _ctx.foo, _parent)      ssr css vars ç®€å•åœ¨å…ƒç´ ä¸Šæ³¨å…¥ style = { color } å±æ€§\n    ","permalink":"https://www.cheng92.com/vue/vue-mind-map-compiler-ssr/","tags":["vue,","vue3,","compiler-ssr"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 6 â˜compiler-ssr"},{"categories":["web"],"contents":"  HTML æ ‡å‡†é¦–é¡µ HTML Standard\n 13 The HTML syntax  13.5 Named character references   è¿™ä¸‹é¢åŒ…å«äº†æ‰€æœ‰ç¬¦å· åå­— - Unicode - ç¬¦å· å¯¹åº”å…³ç³»è¡¨ã€‚\n    Element textContent, innerHTML, innerText   textContent\n innerText\n  ","permalink":"https://www.cheng92.com/web/html-spec-whatwg-st/","tags":["html"],"title":"HTML æ ‡å‡†"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n å£°æ˜ ï¼švue-next compiler-sfc æ¨¡å—ï¼Œç›¸å…³çš„æ‰€æœ‰æµ‹è¯•ä»£ç å‡åœ¨ /js/vue/ ç›®å½•ä¸‹é¢ã€‚\n æ›´æ–°æ—¥å¿—\u0026amp;Todos ï¼š\n  [2020-12-19 13:58:31] åˆ›å»º\n  [2021-01-04 19:47:10] å®Œæˆ\n  TODO defineProps å’Œ defineEmit åŸç†å’Œç”¨é€”\n  TODO inlineTemplate with ssr: true options\n  TODO more mind-maps\n    é‡ç‚¹ã€ç‰¹æ€§ã€é—®é¢˜     ğŸ”— \u0026lt;style\u0026gt; æ ‡ç­¾ä¸­å¯é€šè¿‡ v-bind() å¼•ç”¨CSS æ¨¡å—åŒ–åçš„å˜é‡\n  \u0026lt;script\u0026gt; å’Œ \u0026lt;script setup\u0026gt; ä¸­çš„ export default ä¼šåˆå¹¶ï¼Œä¸”æ˜¯ setup ä¼˜å…ˆçº§ æ›´é«˜ï¼Œå› æ­¤å°½é‡ä¸è¦å­˜åœ¨é‡å¤å±æ€§ã€‚\n    f21c84c init åˆå§‹åŒ–å·¥ä½œ   feat(init): compiler-sfc Â· gcclll/stb-vue-next@f21c84c\n cp compiler-sfc form vue-next:/packages/compiler-dom\n åˆ é™¤ compiler-sfc/src/* ä¸‹æ‰€æœ‰æ–‡ä»¶\n æ–°å»º compiler-sfc/src/index.ts å…¥å£æ–‡ä»¶\n åˆå§‹åŒ– index.ts:\n1 2 3 4 5 6 7 8 9  // API export { generateCodeFrame } from \u0026#39;@vue/compiler-core\u0026#39; // Types export { CompilerOptions, CompilerError, BindingMetadata } from \u0026#39;@vue/compiler-core\u0026#39;      feat(init): parse function Â· gcclll/stb-vue-next@e7e1cc1\n å£°æ˜ä¸€äº›åŸºæœ¬ç±»å‹ï¼Œæ¯”å¦‚ï¼š \u0026lt;template\u0026gt;, \u0026lt;script\u0026gt;, \u0026lt;style\u0026gt; è¿™ä¹Ÿæ˜¯ *.vue æ–‡ä»¶çš„ä¸‰ å¤§è¦ç´ ï¼Œè¿™é‡Œéœ€è¦å¤šå…³æ³¨ä¸€ç‚¹å°±æ˜¯ä¼šå‘ç° \u0026lt;script\u0026gt; æ ‡ç­¾é‡Œé¢å¤šæœ‰ä¸€ä¸ª setup å±æ€§ï¼Œ è¿™ä¸ªæ˜¯ vue è‡ªèº«å®šä¹‰çš„ä¸€ç§æ ‡ç­¾ç±»å‹ï¼Œæ¯”å¦‚åœ¨è¿™é‡Œé¢å¯ä»¥ç›´æ¥ä½¿ç”¨ ref å£°æ˜å˜é‡ï¼Œè¿™é‡Œ é¢çš„å˜é‡éƒ½ä¼šè‡ªåŠ¨å˜æˆå“åº”å¼çš„ç­‰ç­‰ã€‚\n SFC å—ç±»å‹å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9  export interface SFCBlock { type: string content: string attrs: Record\u0026lt;string, string | true\u0026gt; loc: SourceLocation map?: RawSourceMap lang?: string src?: string }     SFC \u0026lt;template\u0026gt; æ ‡ç­¾ç±»å‹å®šä¹‰ï¼š\n1 2 3 4  export interface SFCTemplateBlock extends SFCBlock { type: \u0026#39;template\u0026#39; ast: ElementNode }     SFC \u0026lt;script\u0026gt; è„šæœ¬æ ‡ç­¾ç±»å‹å®šä¹‰\n1 2 3 4 5 6 7  export interface SFCScriptBlock extends SFCBlock { type: \u0026#39;script\u0026#39; setup?: string | boolean bindings?: BindingMetadata scriptAst?: Statement[] scriptSetupAst?: Statement[] }     SFC \u0026lt;style\u0026gt; æ ·å¼æ ‡ç­¾ç±»å‹å®šä¹‰\n1 2 3 4 5  export interface SFCStyleBlock extends SFCBlock { type: \u0026#39;style\u0026#39; scoped?: boolean // æŒ‡å®šæ˜¯ä¸æ˜¯åªèƒ½ç”¨äºå½“å‰æ–‡ä»¶  module?: string | boolean // æ˜¯ä¸æ˜¯æ¨¡å—åŒ–æ ·å¼ }     SFC æ–‡ä»¶ç±»å‹å®šä¹‰\n1 2 3 4 5 6 7 8 9 10  export interface SFCDescriptor { filename: string source: string template: SFCTemplateBlock | null script: SFCScriptBlock | null scriptSetup: SFCScriptBlock | null styles: SFCStyleBlock[] customBlocks: SFCBlock[] cssVars: string[] }     parse å‡½æ•°å®šä¹‰ï¼š\n1 2 3 4 5 6  export function parse( source: string, { sourceMap = true }: SFCParseOptions ): SFCParseResult { return {} as SFCParseResult }      49ee210 parse function å®ç°éƒ¨åˆ†   feat: sfc-\u0026gt; code parse function Â· gcclll/stb-vue-next@49ee210\n å®ç° parse å‡½æ•°çš„åŸºæœ¬æ¶æ„:\n  sourceToSFC\u0026lt;key, source\u0026gt; ç”¨æ¥ç¼“å­˜ vueæ–‡ä»¶è§£æç»“æœï¼Œé¦–å…ˆå–ç¼“å­˜ç»“æœ\n  é€šè¿‡è°ƒç”¨ compiler-dom ä¸­çš„ compiler.parse å°†æ–‡ä»¶å†…å®¹ sourceè§£ææˆ AST\n  éå†æ‰€æœ‰ ast.children æ ¹æ® node.tag ç±»å‹å†³å®šèµ°ä»€ä¹ˆåˆ†æ”¯å¤„ç†\n \u0026lt;template\u0026gt; æ¨¡æ¿åˆ†æ”¯ï¼Œè¿™é‡Œé¢çš„æ‰€æœ‰å†…å®¹ä¼šè¢« parse ç»§ç»­è§£æå‡º ast\n \u0026lt;script [setup]\u0026gt; è„šæœ¬åˆ†æ”¯, å½“åš RAWDATA æ–‡æœ¬ç±»å‹å¤„ç†ï¼Œå¦‚æœæœ‰ setup å±æ€§ï¼Œ åˆ™æ‰€æœ‰ script éƒ½ä¸èƒ½å¸¦ src å±æ€§ï¼Œå³ä¸èƒ½å¼•ç”¨å¤–éƒ¨æ–‡ä»¶ï¼Œå› ä¸ºæ‰€æœ‰ script å†…å®¹ä¼šåˆ å¹¶åˆ°ä¸€èµ·å»å¤„ç†ã€‚\n \u0026lt;style [lang=\u0026#34;\u0026#34;]\u0026gt; æ ·å¼åˆ†æ”¯ï¼Œå½“åš RAWDATA æ–‡æœ¬ç±»å‹å¤„ç†\n  é”™è¯¯ç”¨æ³•æ£€æµ‹ï¼Œä¸»è¦æ˜¯ \u0026lt;script setup\u0026gt; è„šæœ¬æ ‡ç­¾ä¸èƒ½æœ‰ src çš„æ£€æµ‹\n  souremap çš„å¤„ç†\n  descriptor.cssVars = parseCssVars(descriptor) CSS å˜é‡çš„è§£æï¼Œä¼šå…¨éƒ¨è§£æåˆ° æ•°ç»„ cssVars é‡Œé¢å»\n  ç¼“å­˜è§£æåçš„ç»“æœåˆ° sourceToSFC.set(sourceKey, result)\n  å¯¹äº†ï¼Œåœ¨ switch case åˆ†æ”¯é‡Œé¢é»˜è®¤èµ°çš„æ˜¯è‡ªå®šä¹‰å—çš„å¤„ç†(vue æ–‡ä»¶ä¸­è¿˜å¯ä»¥è‡ªå®š ä¹‰ï¼Ÿ)\n   CSS vars å˜é‡å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  export const CSS_VARS_HELPER = `useCssVars`; export const cssVarRE = /\\bv-bind\\(\\s*(?:\u0026#39;([^\u0026#39;]+)\u0026#39;|\u0026#34;([^\u0026#34;]+)\u0026#34;|([^\u0026#39;\u0026#34;][^)]*))\\s*\\)/g; export function parseCssVars(sfc: SFCDescriptor): string[] { const vars: string[] = []; sfc.styles.forEach((style) =\u0026gt; { let match; // v-bind(\u0026#39;xxx\u0026#39;), v-bind(\u0026#34;xxx\u0026#34;), v-bind()  while ((match = cssVarRE.exec(style.content))) { vars.push(match[1] || match[2] || match[3]); } }); return vars; }     è¿™é‡Œæœ‰ä¸ª cssVarRE æ­£åˆ™ï¼Œæ¥çœ‹ä¸‹ï¼š\n  è¿™ä¸ªæ­£åˆ™å¯ä»¥åŒ¹é…ç»“æœï¼š v-bind(\u0026#39;...\u0026#39;), v-bind(\u0026#34;...\u0026#34;), v-bind(...)\n ä» compiler-src/__tests__/cssVars.spec.ts ç”¨ä¾‹ä¸­å¯çª¥è§è¿™ç§ç”¨æ³•ï¼š\n1 2 3 4 5  `\u0026lt;script\u0026gt;const a = 1\u0026lt;/script\u0026gt;\\n` + `\u0026lt;style\u0026gt;div{ color: v-bind(color); font-size: v-bind(\u0026#39;font.size\u0026#39;); }\u0026lt;/style\u0026gt;`     ğŸ’Ÿ ç°åœ¨å¯ä»¥ç›´æ¥åœ¨ \u0026lt;style\u0026gt; å˜è¿é‡Œé¢é€šè¿‡ v-bind() æ¥ç›´æ¥ä½¿ç”¨å¼•å…¥çš„ CSS å˜é‡ã€‚\n  feat(add): sfc-\u0026gt;parse add sourcemap Â· gcclll/stb-vue-next@afd8044\ne32d508 parse \u0026lt;template\u0026gt; case   feat: sfc-\u0026gt; add \u0026lt;template\u0026gt; parse Â· gcclll/stb-vue-next@e32d508\n ä¸»è¦å¢åŠ ä»£ç ï¼š switch case -\u0026gt; \u0026#39;template\u0026#39;:  å¢åŠ å‡½æ•°ï¼š createBlock() ç”¨æ¥å¤„ç† SFC æ ‡ç­¾çš„å±æ€§(å¦‚ï¼š lang, setup, src, scoped, module)\n å›é¡¾ä¸‹ compiler-dom, compiler-core å…¶å®å¯¹äº \u0026lt;template\u0026gt; æ ‡ç­¾çš„å¤„ç†å·¥ä½œä¾ç„¶é›†ä¸­ åœ¨è¿™ä¸¤ä¸ªåŒ…é‡Œé¢ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†èµ˜è¿°æ¨¡æ¿ ast çš„è§£æäº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const { parse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-sfc.global.js\u0026#39;) const source = ` \u0026lt;template\u0026gt; \u0026lt;div\u0026gt;{{ test }}\u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; div { color:v-bind(\u0026#39;fontColor\u0026#39;); } \u0026lt;/style\u0026gt;` const res = parse(source) console.log(res)    { descriptor: { filename: \u0026#39;anonymous.vue\u0026#39;, source: \u0026#39;\\n\u0026#39; + \u0026#39;\u0026lt;template\u0026gt;\\n\u0026#39; + \u0026#39; \u0026lt;div\u0026gt;{{ test }}\u0026lt;/div\u0026gt;\\n\u0026#39; + \u0026#39;\u0026lt;/template\u0026gt;\\n\u0026#39; + \u0026#39;\u0026lt;script\u0026gt;\u0026lt;/script\u0026gt;\\n\u0026#39; + \u0026#39;\u0026lt;style\u0026gt;\\n\u0026#39; + \u0026#39; div {\\n\u0026#39; + \u0026#34; color:v-bind(\u0026#39;fontColor\u0026#39;);\\n\u0026#34; + \u0026#39; }\\n\u0026#39; + \u0026#39;\u0026lt;/style\u0026gt;\u0026#39;, template: { type: \u0026#39;template\u0026#39;, content: \u0026#39;\\n \u0026lt;div\u0026gt;{{ test }}\u0026lt;/div\u0026gt;\\n\u0026#39;, loc: [Object], attrs: {}, ast: [Object] }, script: null, scriptSetup: null, styles: [], customBlocks: [], cssVars: [] }, errors: [] } undefined   å¦‚ä¸Šï¼šä¸€ä¸ªæœ€ç®€å•çš„ SFC è§£æåçš„ç»“æ„ã€‚\n  3160fed parse \u0026lt;script\u0026gt; case   feat(add): sfc-\u0026gt; script parse Â· gcclll/stb-vue-next@3160fed\n å¢åŠ  switch case script é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  case \u0026#39;script\u0026#39;: // è„šæœ¬æ ‡ç­¾å¤„ç†  const scriptBlock = createBlock(node, source, pad) as SFCScriptBlock const isSetup = !!scriptBlock.attrs.setup if (isSetup \u0026amp;\u0026amp; !descriptor.scriptSetup) { descriptor.scriptSetup = scriptBlock break } if (!isSetup \u0026amp;\u0026amp; !descriptor.script) { descriptor.script = scriptBlock break } errors.push(createDuplicateBlockError(node, isSetup)) break break     createBlock() ä¸­å¢åŠ å„å±æ€§çš„è§£æå’Œè®¾ç½®ï¼š\n lang -\u0026gt; block.lang\n src -\u0026gt; block.src\n style \u0026gt; scoped -\u0026gt; block.scoped\n style \u0026gt; module -\u0026gt; block.module\n script \u0026gt; setup -\u0026gt; block.setup\n å¦å¤–å¢åŠ äº† padContent() æ£€æµ‹å›è½¦æ¢è¡Œç¬¦æ›¿æ¢ï¼Ÿ\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { parse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-sfc.global.js\u0026#39;) const source = ` \u0026lt;script setup\u0026gt; import { x } from \u0026#39;./x\u0026#39; let a = 1 const b = 2 function c() {} class d {} \u0026lt;/script\u0026gt;` const res = parse(source) console.log(res.descriptor)    { filename: \u0026#39;anonymous.vue\u0026#39;, source: \u0026#39;\\n\u0026#39; + \u0026#39;\u0026lt;script setup\u0026gt;\\n\u0026#39; + \u0026#34;import { x } from \u0026#39;./x\u0026#39;\\n\u0026#34; + \u0026#39;let a = 1\\n\u0026#39; + \u0026#39;const b = 2\\n\u0026#39; + \u0026#39;function c() {}\\n\u0026#39; + \u0026#39;class d {}\\n\u0026#39; + \u0026#39;\u0026lt;/script\u0026gt;\u0026#39;, template: null, script: null, scriptSetup: { type: \u0026#39;script\u0026#39;, content: \u0026#39;\\n\u0026#39; + \u0026#34;import { x } from \u0026#39;./x\u0026#39;\\n\u0026#34; + \u0026#39;let a = 1\\n\u0026#39; + \u0026#39;const b = 2\\n\u0026#39; + \u0026#39;function c() {}\\n\u0026#39; + \u0026#39;class d {}\\n\u0026#39;, loc: { source: \u0026#39;\\n\u0026#39; + \u0026#34;import { x } from \u0026#39;./x\u0026#39;\\n\u0026#34; + \u0026#39;let a = 1\\n\u0026#39; + \u0026#39;const b = 2\\n\u0026#39; + \u0026#39;function c() {}\\n\u0026#39; + \u0026#39;class d {}\\n\u0026#39;, start: [Object], end: [Object] }, attrs: { setup: true }, setup: true }, styles: [], customBlocks: [], cssVars: [] } undefined    aa037fe parse \u0026lt;style\u0026gt; case   feat(add): sfc-\u0026gt; parse \u0026lt;style\u0026gt; Â· gcclll/stb-vue-next@aa037fe\n è§£æåçš„ç»“æœä¿å­˜åˆ° descriptor.styles.push(styleBlock) æ‰€ä»¥å¯ä»¥æœ‰å¤šä¸ª \u0026lt;style\u0026gt; å­˜åœ¨ã€‚\n Tip: è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª styleBlock.attrs.vars æ£€æµ‹ï¼Œéš¾ä¸æˆå°†æ¥ä¼šæ”¯æŒç›´æ¥ SFC é‡Œé¢ å£°æ˜ CSS å˜é‡?\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { parse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-sfc.global.js\u0026#39;) const source = ` \u0026lt;style scoped\u0026gt; h1 { color: red; font-size: v-bind(fontSize); border: v-bind(\u0026#39;border\u0026#39;); } \u0026lt;/style\u0026gt;` const res = parse(source) console.log(res.descriptor)    { filename: \u0026#39;anonymous.vue\u0026#39;, source: \u0026#39;\\n\u0026#39; + \u0026#39;\u0026lt;style scoped\u0026gt;\\n\u0026#39; + \u0026#39;h1 {\\n\u0026#39; + \u0026#39; color: red;\\n\u0026#39; + \u0026#39; font-size: v-bind(fontSize);\\n\u0026#39; + \u0026#34; border: v-bind(\u0026#39;border\u0026#39;);\\n\u0026#34; + \u0026#39;}\\n\u0026#39; + \u0026#39;\u0026lt;/style\u0026gt;\u0026#39;, template: null, script: null, scriptSetup: null, styles: [ { type: \u0026#39;style\u0026#39;, content: \u0026#39;\\n\u0026#39; + \u0026#39;h1 {\\n\u0026#39; + \u0026#39; color: red;\\n\u0026#39; + \u0026#39; font-size: v-bind(fontSize);\\n\u0026#39; + \u0026#34; border: v-bind(\u0026#39;border\u0026#39;);\\n\u0026#34; + \u0026#39;}\\n\u0026#39;, loc: [Object], attrs: [Object], scoped: true } ], customBlocks: [], cssVars: [ \u0026#39;fontSize\u0026#39;, \u0026#39;border\u0026#39; ] } undefined   å¯¹äº v-bind() å˜é‡çš„å¼•ç”¨ï¼Œä¸ç®¡æœ‰æ²¡å¼•å·ï¼Œéƒ½ä¼šå½“åšå˜é‡å¤„ç†ã€‚\n    compile \u0026lt;template\u0026gt;  c26e76c init compileTemplate   feat(init): sfc-\u0026gt;compile \u0026lt;template\u0026gt; Â· gcclll/stb-vue-next@c26e76c\n å¢åŠ ä¸¤ä¸ªç±»å‹å’Œ compileTemplate å‡½æ•°å®šä¹‰ï¼š\n SFCTemplateCompileResults æ¨¡æ¿ä¾¿åçš„ç»“æœç±»å‹\n1 2 3 4 5 6 7 8 9  export interface SFCTemplateCompileResults { code: string ast?: RootNode preamble?: string source: string tips: string[] errors: (string | CompilerError)[] map?: RawSourceMap }     SFCTemplateCompileOptions æ¨¡æ¿ç¼–è¯‘å™¨é€‰é¡¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  export interface SFCTemplateCompileOptions { source: string filename: string id: string scoped?: boolean isProd?: boolean ssr?: boolean ssrCssVars?: string[] inMap?: RawSourceMap compiler?: TemplateCompiler compilerOptions?: CompilerOptions preprocessLang?: string preprocessOptions?: any /** * In some cases, compiler-sfc may not be inside the project root (e.g. when * linked or globally installed). In such cases a custom `require` can be * passed to correctly resolve the preprocessors. */ preprocessCustomRequire?: (id: string) =\u0026gt; any /** * Configure what tags/attributes to transform into asset url imports, * or disable the transform altogether with `false`. */ transformAssetUrls?: AssetURLOptions | AssetURLTagConfig | boolean }     åŠ compileTemplate å‡½æ•°\n1 2 3 4 5  export function compileTemplate( options: SFCTemplateCompileOptions ): SFCTemplateCompileResults { return {} as SFCTemplateCompileResults }      TODO 1b2965f coding compileTemplate   feat: sfc-\u0026gt;compile compileTemplate code Â· gcclll/stb-vue-next@1b2965f\n è¿™ä¸ªå‡½æ•°ç›¸å…³çš„å†…å®¹ï¼š\n  preprocessLang\n  preprocessCustomRequire\n  TODO æ¨¡æ¿é¢„å¤„ç†å™¨ï¼Œæ²¡ææ˜ç™½è¿™é‡Œæ˜¯è¦åšä»€ä¹ˆï¼Ÿ\n ä»£ç é€»è¾‘ï¼š\n if preprocessor -\u0026gt; doCompileTemplate()\n elseif preprocessLang -\u0026gt; â€¦\n else -\u0026gt; doCompileTemplate()\n â¹ ç­‰å¾…æ¢ç´¢â€¦â€¦\n   7b49db4 coding doCompileTemplate å‡½æ•°å®ç°   feat(add): sfc-\u0026gt;compile doCompileTemplate Â· gcclll/stb-vue-next@7b49db4\n å‡½æ•°åŠŸèƒ½ï¼šæ”¶é›†ä¸¤ä¸ª transform ç»™ compiler.compile åœ¨æ¨¡æ¿ç¼–è¯‘æœŸé—´ä½¿ç”¨ã€‚\n  asset url èµ„æºåœ°å€è½¬æ¢ç”¨çš„ transform\n è¦å¤„ç†çš„æ ‡ç­¾å’Œå¯¹åº”çš„åŒ…å« url çš„å±æ€§:\n   tag prop with url     \u0026lt;video\u0026gt; \u0026#39;src\u0026#39;, \u0026#39;poster\u0026#39;   \u0026lt;source\u0026gt; \u0026#39;src\u0026#39;   \u0026lt;img\u0026gt; \u0026#39;src\u0026#39;   \u0026lt;image\u0026gt; \u0026#39;xlink:href\u0026#39;, \u0026#39;href\u0026#39;   \u0026lt;use\u0026gt; \u0026#39;xlink:href\u0026#39;, \u0026#39;href\u0026#39;      img/source æ ‡ç­¾ src åœ°å€è½¬æ¢\n   é‡ç‚¹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const shortId = id.replace(/^data-v-/, \u0026#39;\u0026#39;) const longId = `data-v-${shortId}` let { code, ast, preamble, map } = compiler.compile(source, { mode: \u0026#39;module\u0026#39;, prefixIdentifiers: true, hoistStatic: true, cacheHandlers: true, ssrCssVars: ssr \u0026amp;\u0026amp; ssrCssVars \u0026amp;\u0026amp; ssrCssVars.length ? \u0026#39;\u0026#39; /* TODO genCssVarsFromList(ssrCssVars, shortId, isProd) */ : \u0026#39;\u0026#39;, // css å±€éƒ¨ä½¿ç”¨ï¼ŒåŠ ä¸Šå¯¹åº”çš„å”¯ä¸€ id  scopeId: scoped ? longId : undefined, ...compilerOptions, nodeTransforms: nodeTransforms.concat(compilerOptions.nodeTransforms || []), filename, sourceMap: true, onError: e =\u0026gt; errors.push(e) })     å°† nodeTransforms: [transformAssetUrl, transformSrcset] ä¼ é€’ç»™ç¼–è¯‘å™¨å¤„ç†ã€‚\n æ³¨æ„è¿™é‡Œè®¾ç½®äº†å‡ ä¸ªå±æ€§ï¼š mode = \u0026#39;module\u0026#39;, prefixIdentifiers = true æ‰€ä»¥è¿™ä¸ªåº” è¯¥åªèƒ½è¿è¡Œåœ¨éæµè§ˆå™¨ç¯å¢ƒã€‚\n ä¸‹é¢æ¥å®ç°ä¸€ä¸ªç›¸å¯¹ç®€å•çš„ transformAssetUrl() å‡½æ•° â€¦â€¦\n  2d82400 coding transformAssetUrl è½¬æ¢èµ„æº url   feat(add): sfc-\u0026gt;compile templateTransformAssetUrl Â· gcclll/stb-vue-next@2d82400\n fix: sfc preprocess function Â· gcclll/stb-vue-next@e08f805\n å‡ ç§URLä½¿ç”¨æƒ…å†µå’Œè½¬æ¢ç»“æœå¦‚ä¸‹å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const { compileTemplate } = require(process.env.VNEXT_PKG_SFC + \u0026#39;/dist/compiler-sfc.cjs.js\u0026#39;) const { code, ast } = compileTemplate({ source: `\u0026lt;template\u0026gt;\u0026lt;div id=\u0026#34;test\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;./test/test.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;./test/test.png\u0026#34; /\u0026gt; \u0026lt;img :src=\u0026#34;imgUrl\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;http://1.1.1.1:100/imgs/test/test.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;data:....\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;#test/test.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;~test/test.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;~/test/test.png\u0026#34; /\u0026gt; \u0026lt;img src=\u0026#34;@test/test.png\u0026#34; /\u0026gt; \u0026lt;video src=\u0026#34;./test/video.mp4\u0026#34; poster=\u0026#34;./test/poster.png\u0026#34; /\u0026gt; \u0026lt;div src=\u0026#34;./test/test.png\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt;`, id: \u0026#39;\u0026#39;, filename: \u0026#39;test.vue\u0026#39; }) console.log(code)    import { createVNode as _createVNode, openBlock as _openBlock, createBlock as _createBlock } from \u0026#34;vue\u0026#34; import _imports_0 from \u0026#39;./test/test.png\u0026#39; import _imports_1 from \u0026#39;test/test.png\u0026#39; import _imports_2 from \u0026#39;@test/test.png\u0026#39; import _imports_3 from \u0026#39;./test/video.mp4\u0026#39; import _imports_4 from \u0026#39;./test/poster.png\u0026#39; const _hoisted_1 = { id: \u0026#34;test\u0026#34; } const _hoisted_2 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_0 }, null, -1 /* HOISTED */) const _hoisted_3 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_0 }, null, -1 /* HOISTED */) const _hoisted_4 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_5 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;http://1.1.1.1:100/imgs/test/test.png\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_6 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;data:....\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_7 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;#test/test.png\u0026#34; }, null, -1 /* HOISTED */) const _hoisted_8 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_1 }, null, -1 /* HOISTED */) const _hoisted_9 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_1 }, null, -1 /* HOISTED */) const _hoisted_10 = /*#__PURE__*/_createVNode(\u0026#34;img\u0026#34;, { src: _imports_2 }, null, -1 /* HOISTED */) const _hoisted_11 = /*#__PURE__*/_createVNode(\u0026#34;video\u0026#34;, { src: _imports_3, poster: _imports_4 }, null, -1 /* HOISTED */) const _hoisted_12 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, { src: \u0026#34;./test/test.png\u0026#34; }, null, -1 /* HOISTED */) export function render(_ctx, _cache) { return (_openBlock(), _createBlock(\u0026#34;template\u0026#34;, null, [ _createVNode(\u0026#34;div\u0026#34;, _hoisted_1, [ _hoisted_2, _hoisted_3, _createVNode(\u0026#34;img\u0026#34;, { src: _ctx.imgUrl }, null, 8 /* PROPS */, [\u0026#34;src\u0026#34;]), _hoisted_4, _hoisted_5, _hoisted_6, _hoisted_7, _hoisted_8, _hoisted_9, _hoisted_10, _hoisted_11, _hoisted_12 ]) ])) } undefined   æ¨¡æ¿ä¸­èµ„æºURLä¸è½¬æ¢å‡ ç§æƒ…å†µï¼š\n  å±æ€§ä¸æ˜¯é™æ€å±æ€§(NodeTypes.ATTRIBUTE)\n  éç‰¹å®šæ ‡ç­¾çš„ä¸è½¬æ¢(æˆ–è€…é€šè¿‡ options.tags é‡ŒæŒ‡å®šçš„æ ‡ç­¾)\n1 2 3 4 5 6 7  tags: { video: [\u0026#39;src\u0026#39;, \u0026#39;poster\u0026#39;], source: [\u0026#39;src\u0026#39;], img: [\u0026#39;src\u0026#39;], image: [\u0026#39;xlink:href\u0026#39;, \u0026#39;href\u0026#39;], use: [\u0026#39;xlink:href\u0026#39;, \u0026#39;href\u0026#39;] }      æ²¡æœ‰å±æ€§å€¼çš„å±æ€§\n  å¤–éƒ¨é“¾æ¥çš„URL(https å¼€å¤´çš„)\n  data: å¼€å¤´çš„èµ„æºåœ°å€\n  å±æ€§å€¼ä»¥ # å¼€å¤´çš„åœ°å€\n  éç»å¯¹è·¯å¾„ä¸”è´¹ç›¸å¯¹è·¯å¾„çš„(ä»¥ï¼Œ .|~|@ å¼€å¤´çš„åœ°å€)\n   éœ€è¦å¤„ç†çš„åˆåˆ†ä¸¤ç§æƒ…å†µï¼š\n  ç»™å®šäº† options.base åŸºåœ°å€çš„(.|~|@ ä¸ºç¬¬ä¸€ä¸ªå­—ç¬¦çš„)\n ç›´æ¥ç”¨ options.base + assert url å¤„ç†\n  é1ä¸­æ¸…ç©ºçš„ä½¿ç”¨ import imgName from \u0026#39;...img url\u0026#39; å¼•å…¥\n   PS. å¯¹äº CSS ä¸­çš„URLå¼•ç”¨æ”¾åˆ°åç»­ compileStyle ä¸­å»å±•ç¤ºã€‚\n     56358a8 compile \u0026lt;style\u0026gt;   feat(add): sfc-\u0026gt; compile style Â· gcclll/stb-vue-next@56358a8\n è¿™éƒ¨åˆ†ä»£ç éƒ½æ˜¯ç›´æ¥ Ctrl-c, Ctrl-v æ¥çš„ï¼Œä¹Ÿæ²¡æ·±å…¥ç ”ç©¶ï¼Œæ‰€ä»¥è¿™èŠ‚ä¹Ÿæ²¡ä»€ä¹ˆå¥½è®²è¿°çš„ã€‚\n å¾…åˆ°ä»¥åæœ‰æ—¶é—´å†æ¥ç ”ç©¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74  const { compileStyle } = require(process.env.VNEXT_PKG_SFC + \u0026#39;/dist/compiler-sfc.cjs.js\u0026#39;) const c = (source, option = {}) =\u0026gt; compileStyle({ source, filename: \u0026#39;test.css\u0026#39;, id: \u0026#39;data-v-test\u0026#39;, scoped: true, ...option }) const log = console.log const res = c(` h1 { color: red; } .foo { color: red; } h1 .foo { color: red; } h1 .foo, .bar, .baz { color: red; } .foo:after { color: red; } ::selection { display: none; } .abc, ::selection { color: red; } :deep(.foo) { color: red; } ::v-deep(.foo) { color: red; } ::v-deep(.foo .bar) { color: red; } .baz .qux ::v-deep(.foo .bar) { color: red; } :slotted(.foo) { color: red; } ::v-slotted(.foo) { color: red; } ::v-slotted(.foo .bar) { color: red; } .baz .qux ::v-slotted(.foo .bar) { color: red; } :global(.foo) { color: red; } ::v-global(.foo) { color: red; } ::v-global(.foo .bar) { color: red; } .baz .qux ::v-global(.foo .bar) { color: red; } @media print { .foo { color: red }} @supports(display: grid) { .foo { display: grid }} .anim { animation: color 5s infinite, other 5s; } .anim-2 { animation-name: color; animation-duration: 5s; } .anim-3 { animation: 5s color infinite, 5s other; } .anim-multiple { animation: color 5s infinite, opacity 2s; } .anim-multiple-2 { animation-name: color, opacity; animation-duration: 5s, 2s; } @keyframes color { from { color: red; } to { color: green; } } @-webkit-keyframes color { from { color: red; } to { color: green; } } @keyframes opacity { from { opacity: 0; } to { opacity: 1; } } @-webkit-keyframes opacity { from { opacity: 0; } to { opacity: 1; } } `) log(res.code)    h1[data-v-test] { color: red; } .foo[data-v-test] { color: red; } h1 .foo[data-v-test] { color: red; } h1 .foo[data-v-test], .bar[data-v-test], .baz[data-v-test] { color: red; } .foo[data-v-test]:after { color: red; } [data-v-test]::selection { display: none; } .abc[data-v-test],[data-v-test]::selection { color: red; } [data-v-test] .foo { color: red; } [data-v-test] .foo { color: red; } [data-v-test] .foo .bar { color: red; } .baz .qux[data-v-test] .foo .bar { color: red; } .foo[data-v-test-s] { color: red; } .foo[data-v-test-s] { color: red; } .foo .bar[data-v-test-s] { color: red; } .baz .qux .foo .bar[data-v-test-s] { color: red; } .foo { color: red; } .foo { color: red; } .foo .bar { color: red; } .foo .bar { color: red; } @media print { .foo[data-v-test] { color: red }} @supports(display: grid) { .foo[data-v-test] { display: grid }} .anim[data-v-test] { animation: color-test 5s infinite, other 5s; } .anim-2[data-v-test] { animation-name: color-test; animation-duration: 5s; } .anim-3[data-v-test] { animation: 5s color-test infinite, 5s other; } .anim-multiple[data-v-test] { animation: color-test 5s infinite,opacity-test 2s; } .anim-multiple-2[data-v-test] { animation-name: color-test,opacity-test; animation-duration: 5s, 2s; } @keyframes color-test { from { color: red; } to { color: green; } } @-webkit-keyframes color-test { from { color: red; } to { color: green; } } @keyframes opacity-test { from { opacity: 0; } to { opacity: 1; } } @-webkit-keyframes opacity-test { from { opacity: 0; } to { opacity: 1; } } undefined   PS. å¯¹äº CSS çš„è§£æéœ€è¦ postcss ä»¥åŠå„ç§é¢„å¤„ç†æ¥å¤„ç†ï¼Œè¿™é‡Œæš‚æ—¶ä¸å±•å¼€ã€‚\n   4d66531 compile \u0026lt;script\u0026gt;é‡ç‚¹   è¿™èŠ‚ä¼šæ˜¯é‡ç‚¹éƒ¨åˆ†ã€‚\n init compileScript function   åˆå§‹åŒ– compileScript() å‡½æ•°ä»¥åŠå‚æ•°é€‰é¡¹ç±»å‹ SFCScriptCompileOptions\n SFCScriptCompileOptions:\n  id: string, ä¼ é€’ç»™ compileStyle ç”¨äºä½œä¸º injected CSS å˜é‡å‰ç¼€ç”¨\n  isProd?: boolean å†³å®šç”Ÿæˆçš„ CSS å˜é‡æ˜¯å¦è¦åŠ ä¸Š hash å€¼\n  babelParserPlugins?: ParserPlugin[]\n  refSugar?: boolean ä½¿èƒ½ ref è¯­æ³•ç³–\n  inlineTemplate?: boolean å†…è”æ¨¡æ¿ï¼Ÿï¼Ÿï¼Ÿ\n   compileScript:\n1 2 3 4 5 6 7 8 9 10 11  /** * Compile `\u0026lt;script setup\u0026gt;` * It requires the whole SFC descriptor because we need to handle and merge * normal `\u0026lt;script\u0026gt;` + `\u0026lt;script setup\u0026gt;` if both are present. */ export function compileScript( sfc: SFCDescriptor, options: SFCScriptCompileOptions ): SFCScriptBlock { return {} as SFCScriptBlock }     feat(add): sfc-\u0026gt;script, compileScript steps comment Â· gcclll/stb-vue-next@54ea72a\n åˆ—å‡º compileScript() å°†è¦å®Œæˆçš„ä»»åŠ¡ï¼š\n   No. Desc Link     0 å‰ç½®å¤„ç† -   1 å¤„ç†å­˜åœ¨çš„ \u0026lt;script\u0026gt; ä»£ç ä½“ -   2 è§£æ \u0026lt;script setup\u0026gt;ï¼Œéå†ç½®é¡¶çš„è¯­å¥ -   3 å°† refè®¿é—®è½¬æ¢æˆå¯¹ ref.value çš„å¼•ç”¨ -   4 é‡Šæ”¾ setup ä¸Šä¸‹æ–‡ç±»å‹çš„è¿è¡Œæ—¶ props/emits ä»£ç  -   5 æ£€æŸ¥ç”¨æˆ·é€‰é¡¹(useOptions)å‚æ•°ï¼Œç¡®ä¿å®ƒæ²¡æœ‰å¼•ç”¨ setup ä¸‹çš„å˜é‡ -   6 åˆ é™¤ non-script çš„å†…å®¹ -   7 åˆ†æ binding metadata -   8 æ³¨å…¥ `useCssVars` è°ƒç”¨ -   9 å®Œæˆ setup() å‚æ•°ç­¾å -   10 ç”Ÿæˆè¿”å›è¯­å¥(return) -   11 å®Œæˆ default export -   12 å®Œæˆ Vue helpers imports -     æ¥ä¸‹æ¥å°±æ˜¯æŒ‰ç…§ä¸Šè¡¨çš„æ­¥éª¤æ¥ä¸€æ­¥æ­¥å®Œæˆ compileScript()\n PS. ä¸‹é¢æ¯ä¸ªå¯¹åº”ç« èŠ‚éƒ½æœ‰å¯¹åº”çš„åŸç‰ˆè‹±æ–‡æ³¨é‡Šï¼Œè‹±è¯­ä¸å¥½~~~~~ã€‚\n  å¢åŠ ä¸€äº›é€»è¾‘æ— å…³çš„å˜é‡å£°æ˜ï¼š feat(add): sfc-\u0026gt;script compileScript declarations Â· gcclll/stb-vue-next@06f1d95\n åœ¨è¿›å…¥æ­£å¼æ­¥éª¤ä¹‹å‰ï¼Œæ¥ç®€å•çœ‹çœ‹ä½¿ç”¨åˆ°çš„ @babel/parser è¿™ä¸ªæ’ä»¶æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œè¾“ å‡ºç»“æœåˆæ˜¯å•¥ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12  const { parse } = require(process.env.BABEL_DIR + \u0026#39;/parser/lib/index.js\u0026#39;) const log = console.log let code = ` import { a } from \u0026#39;./a.js\u0026#39;; const value = 1 * 10 + 100 - 20 / 30 + 1 export const name = a.getName(); export default { name } ` const res = parse(code, { sourceType: \u0026#39;module\u0026#39; }) console.log(res.program.body.map(body =\u0026gt; body.type).join(\u0026#39;\\n\u0026#39;))    ImportDeclaration VariableDeclaration ExportNamedDeclaration ExportDefaultDeclaration undefined   ä»¥ä¸Šè¾“å‡ºæ˜¯æ¯ä¸ªè¯­å¥åœ¨ parser ä¸­å¯¹åº”çš„ AST ç±»å‹ã€‚\n  0âƒ£ d7369ae æ—  \u0026lt;script setup\u0026gt; æ—¶   feat(add): script without setup-script parse Â· gcclll/stb-vue-next@d7369ae\n ä¸€å¼€å§‹ä¼šæ£€æµ‹æœ‰æ²¡æœ‰ script setup å¦‚æœæ²¡æœ‰ï¼Œç»§ç»­æ£€æµ‹ \u0026lt;script\u0026gt; æ™®é€šæ ‡ç­¾ï¼Œå¦‚æœä¸¤ è€…éƒ½ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\n å¦‚æœ \u0026lt;script\u0026gt; å­˜åœ¨ï¼Œåˆ™ç›´æ¥è°ƒç”¨ @babel/parser çš„ parse å‡½æ•°è¿›è¡Œè§£æï¼Œå› æ­¤åé¢ ä¸€å¨ä»£ç åœ¨è¿™ç§æƒ…å†µä¸‹(åªæœ‰æ™®é€šçš„ script æ—¶)æ˜¯ä¸éœ€è¦çš„ã€‚\n æ–°å¢ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const scriptAst = _parse(script.content, { plugins, sourceType: \u0026#39;module\u0026#39; }).program.body const bindings = analyzeScriptBindings(scriptAst) const needRewrite = cssVars.length || hasInheritAttrsFlag let content = script.content if (needRewrite) { // TODO need rewrite } return { ...script, content, bindings, scriptAst }     æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { compileScript, parse } = require(process.env.VNEXT_PKG_SFC + \u0026#39;/dist/compiler-sfc.cjs.js\u0026#39;) const compile = (src, options) =\u0026gt; { const { descriptor } = parse(src) return compileScript(descriptor, { ...options, id: \u0026#39;xxxx\u0026#39; }) } const code = ` \u0026lt;script\u0026gt; import { a } from \u0026#39;./a.js\u0026#39;; \u0026lt;/script\u0026gt; ` const res = compile(code) console.log(res.type, \u0026#39;\\n\u0026#39;, res.scriptAst)    script [ Node { type: \u0026#39;ImportDeclaration\u0026#39;, start: 1, end: 28, loc: SourceLocation { start: [Position], end: [Position], filename: undefined, identifierName: undefined }, range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: undefined, specifiers: [ [Node] ], source: Node { type: \u0026#39;StringLiteral\u0026#39;, start: 19, end: 27, loc: [SourceLocation], range: undefined, leadingComments: undefined, trailingComments: undefined, innerComments: undefined, extra: [Object], value: \u0026#39;./a.js\u0026#39; } } ] undefined   ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  const { compileScript, parse } = require(process.env.VNEXT_PKG_SFC + \u0026#39;/dist/compiler-sfc.cjs.js\u0026#39;) const { log } = require(process.env.BLOG_JS + \u0026#39;/utils.js\u0026#39;) const compile = (src, options) =\u0026gt; { const { descriptor } = parse(src) return compileScript(descriptor, { ...options, id: \u0026#39;xxxx\u0026#39; }) } const code = ` \u0026lt;script\u0026gt; export default { props: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;] } \u0026lt;/script\u0026gt;` const { type, scriptAst: ast } = compile(code) // é¦–å…ˆæ˜¯ä¸ª ExportDefaultDeclaration ç±»å‹ // export çš„å€¼ä¸ºä¸€ä¸ª ObjectExpression ç±»å‹ log(`\u0026gt;\u0026gt;\u0026gt; \u0026lt;script\u0026gt; è§£æåçš„ç±»å‹`) console.log(type) const node = ast[0] log(`\u0026gt;\u0026gt;\u0026gt; export default è§£æåçš„ç±»å‹`) log(node.type) log(`\u0026gt;\u0026gt;\u0026gt; { props : ... } è§£æåçš„ ast åŒ…å«çš„ keys`) log(Object.keys(node.declaration)) log(`\u0026gt; properties ä¸º ObjectExpression å¯¹è±¡çš„æˆå‘˜åˆ—è¡¨ï¼Œå¦‚ï¼š props`) log.props(node.declaration.properties[0], [\u0026#39;type\u0026#39;, \u0026#39;key\u0026#39;, \u0026#39;value\u0026#39;]) log(node.declaration.properties[0].value.elements)     +RESULTS: ç²¾ç®€ä¹‹åçš„è¾“å‡º\n\u0026gt;\u0026gt;\u0026gt; \u0026lt;script\u0026gt; è§£æåçš„ç±»å‹ script \u0026gt;\u0026gt;\u0026gt; export default è§£æåçš„ç±»å‹ ExportDefaultDeclaration \u0026gt;\u0026gt;\u0026gt; { props : ... } è§£æåçš„ ast åŒ…å«çš„ keys [ \u0026#39;type\u0026#39;, \u0026#39;start\u0026#39;, \u0026#39;end\u0026#39;, \u0026#39;loc\u0026#39;, \u0026#39;range\u0026#39;, \u0026#39;leadingComments\u0026#39;, \u0026#39;trailingComments\u0026#39;, \u0026#39;innerComments\u0026#39;, \u0026#39;extra\u0026#39;, \u0026#39;properties\u0026#39; ] \u0026gt; properties ä¸º ObjectExpression å¯¹è±¡çš„æˆå‘˜åˆ—è¡¨ï¼Œå¦‚ï¼š props { type: \u0026#39;ObjectProperty\u0026#39;, key: Node { type: \u0026#39;Identifier\u0026#39;, name: \u0026#39;props\u0026#39; }, value: Node { type: \u0026#39;ArrayExpression\u0026#39;, elements: [ [Node], [Node] ] } } [ Node { type: \u0026#39;StringLiteral\u0026#39;, extra: { rawValue: \u0026#39;foo\u0026#39;, raw: \u0026#34;\u0026#39;foo\u0026#39;\u0026#34; }, value: \u0026#39;foo\u0026#39; }, Node { type: \u0026#39;StringLiteral\u0026#39;, extra: { rawValue: \u0026#39;bar\u0026#39;, raw: \u0026#34;\u0026#39;bar\u0026#39;\u0026#34; }, value: \u0026#39;bar\u0026#39; } ]    819a413 export default {} è§£æ   feat(add): sfc-\u0026gt;script, parse export default members into bindings Â· gcclll/stb-vue-next@819a413\n (property.type === \u0026#39;ObjectMethod\u0026#39; \u0026amp;\u0026amp;property.key.type === \u0026#39;Identifier\u0026#39; \u0026amp;\u0026amp;(property.key.name === \u0026#39;setup\u0026#39; || property.key.name === \u0026#39;data\u0026#39;))\n æˆå‘˜æœ€ååœ¨ bindings é‡Œé¢å­˜åœ¨ç±»å‹å€¼ï¼š\n   name type(BindingTypes) value     props \u0026#39;PROPS\u0026#39; \u0026#39;props\u0026#39;   inject \u0026#39;PROPS\u0026#39; \u0026#39;props\u0026#39;   computed \u0026#39;OPTIONS\u0026#39; \u0026#39;options\u0026#39;   methods \u0026#39;OPTIONS\u0026#39; \u0026#39;options\u0026#39;     setup SETUP_MAYBE_REF \u0026#39;setup-maybe-ref\u0026#39;   data SETUP_MAYBE_REF \u0026#39;setup-maybe-ref\u0026#39;     åˆ°è¿™é‡Œè¿˜åªæ˜¯å€ŸåŠ© @babel/parser è¿›è¡Œäº†è§£æï¼Œvue è‡ªèº«çš„ä¸€äº›ç‰¹æ€§å¤„ç†åœ¨ analyzeScriptBindings() ä¸­ï¼Œè¿™ä¸ªå‡½æ•°è§£æçš„ç±»å‹æ˜¯ ExportDefaultDeclaration ä¹Ÿ å°±æ˜¯ export default {} çš„ä»£ç éƒ¨åˆ†ã€‚\n ç„¶åè°ƒç”¨ analyzeBindingsFromOptions(node.declaration) è§£æå¯¹è±¡æˆå‘˜ï¼Œè¿™é‡Œè¦å¤„ç† çš„ä¸»è¦æœ‰ä¸¤ç§ï¼š\n  ObjectProperty å±æ€§ç±»å‹æˆå‘˜\n (property.type === \u0026#39;ObjectProperty\u0026#39; \u0026amp;\u0026amp;!property.computed \u0026amp;\u0026amp;property.key.type === \u0026#39;Identifier\u0026#39;)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  const { compileScript, parse } = require(process.env.VNEXT_PKG_SFC + \u0026#39;/dist/compiler-sfc.cjs.js\u0026#39;) const { log } = require(process.env.BLOG_JS + \u0026#39;/utils.js\u0026#39;) const compile = (src, options) =\u0026gt; { const { descriptor } = parse(src) return compileScript(descriptor, { ...options, id: \u0026#39;xxxx\u0026#39; }) } const res = compile(` \u0026lt;script\u0026gt; export default { props: [\u0026#39;firstName\u0026#39;, \u0026#39;secondName\u0026#39;], inject: { foo: {} }, computed: { fullName() { return this.firstName + this.secondName + this.thirdName } }, methods: { getName() { return this.fullName } } } \u0026lt;/script\u0026gt; `) console.log(res.bindings)    { firstName: \u0026#39;props\u0026#39;, secondName: \u0026#39;props\u0026#39;, foo: \u0026#39;options\u0026#39;, fullName: \u0026#39;options\u0026#39;, getName: \u0026#39;options\u0026#39; } undefined    ObjectMethod æ–¹æ³•ç±»å‹æˆå‘˜ï¼Œä¸”åªå¤„ç† setup å’Œ data æ–¹æ³•\n feat(add): sfc-\u0026gt;script, parse export default data\u0026amp;setup into bingdings Â· gcclll/stb-vue-next@c7b617b\n éœ€è¦å¢åŠ ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  if ( property.type === \u0026#39;ObjectMethod\u0026#39; \u0026amp;\u0026amp; property.key.type === \u0026#39;Identifier\u0026#39; \u0026amp;\u0026amp; (property.key.name === \u0026#39;setup\u0026#39; || property.key.name === \u0026#39;data\u0026#39;) ) { for (const bodyItem of property.body.body) { // setup() {  // return {  // foo: null  // }  // }  if ( bodyItem.type === \u0026#39;ReturnStatement\u0026#39; \u0026amp;\u0026amp; bodyItem.argument \u0026amp;\u0026amp; bodyItem.argument.type === \u0026#39;ObjectExpression\u0026#39; ) { for (const key of getObjectExpressionKeys(bodyItem.argument)) { bindings[key] = property.key.name = \u0026#39;setup\u0026#39; ? BindingTypes.SETUP_MAYBE_REF : BindingTypes.DATA } } } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  const { compileScript, parse } = require(process.env.VNEXT_PKG_SFC + \u0026#39;/dist/compiler-sfc.cjs.js\u0026#39;) const { log } = require(process.env.BLOG_JS + \u0026#39;/utils.js\u0026#39;) const compile = (src, options) =\u0026gt; { const { descriptor } = parse(src) return compileScript(descriptor, { ...options, id: \u0026#39;xxxx\u0026#39; }) } const code = ` \u0026lt;script\u0026gt; export default { setup() { return { foo: null } }, data() { return { bar: null } }, props: [\u0026#39;baz\u0026#39;] } \u0026lt;/script\u0026gt;` const res = compile(code) log(res.bindings)    { foo: \u0026#39;setup-maybe-ref\u0026#39;, bar: \u0026#39;setup-maybe-ref\u0026#39;, baz: \u0026#39;props\u0026#39; } undefined      æµ‹è¯•  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75  const { compileScript, parse } = require(process.env.VNEXT_PKG_SFC + \u0026#39;/dist/compiler-sfc.cjs.js\u0026#39;) const { log } = require(process.env.BLOG_JS + \u0026#39;/utils.js\u0026#39;) const compile = (src, options) =\u0026gt; { const { descriptor } = parse(src) return compileScript(descriptor, { ...options, id: \u0026#39;xxxx\u0026#39; }) } log(`\u0026gt;\u0026gt;\u0026gt; setup return`) log(compile(` \u0026lt;script\u0026gt; const bar = 2 export default { setup() { return { foo: 1, bar } } } \u0026lt;/script\u0026gt;`).bindings) log(`\u0026gt;\u0026gt;\u0026gt; async setup return`) log(compile(` \u0026lt;script\u0026gt; const bar = 2 export default { async setup() { return { foo: 1, bar } } } \u0026lt;/script\u0026gt;`).bindings) log(`\u0026gt;\u0026gt;\u0026gt; computeds`) log(compile(` \u0026lt;script\u0026gt; export default { computed: { foo() {}, bar: { get() {}, set() {}, } } } \u0026lt;/script\u0026gt; `).bindings) log(`\u0026gt;\u0026gt;\u0026gt; æ··åˆ bindings`) log(compile(` \u0026lt;script\u0026gt; export default { inject: [\u0026#39;foo\u0026#39;], props: { bar: String, }, setup() { return { baz: null, } }, data() { return { qux: null } }, methods: { quux() {} }, computed: { quuz() {} } } \u0026lt;/script\u0026gt; `).bindings)      1âƒ£ eb650ca è§£æ \u0026lt;script\u0026gt;   feat(add): sfc-\u0026gt;script, export default handle Â· gcclll/stb-vue-next@eb650ca\nprocess normal \u0026lt;script\u0026gt; first if it exists\n  ç”¨åˆ°çš„æ’ä»¶ï¼š\n   Plugin     @babel/parser Â· Babel     è¿™ä¸€èŠ‚ä¸­çš„æ™®é€š \u0026lt;script\u0026gt; å‰ææ˜¯ï¼Œè‡³å°‘æœ‰ä¸€ä¸ª \u0026lt;script setup\u0026gt; å­˜åœ¨ï¼Œå¦åˆ™ä¼šç›´æ¥åœ¨ ä¸Šä¸€èŠ‚ å°±é€€å‡ºè§£æäº†ã€‚\n @babel/parser è§£æ import ç»“æœå¯¹ç…§è¡¨\n   æ®µ ç±»å‹ å€¼     import { a } from \u0026#39;./x\u0026#39; ImportDeclaration â€¦   a ImportSpecifier node.specifiers[i].imported.name   \u0026#39;./x\u0026#39; StringLiteral node.source.value    1 2 3 4 5 6 7 8 9 10 11 12 13  const { parse } = require(process.env.BABEL_DIR + \u0026#39;/parser/lib/index.js\u0026#39;) const code = ` import { a } from \u0026#39;./x\u0026#39;` const res = parse(code, { sourceType: \u0026#39;module\u0026#39; }).program.body const node = res[0] const spec = node.specifiers[0] console.log(`\u0026gt;\u0026gt;\u0026gt; node type \u0026gt; ${node.type}`) console.log(`\u0026gt;\u0026gt;\u0026gt; node source type \u0026gt; ${node.source.type}`) console.log(`\u0026gt;\u0026gt;\u0026gt; node source value \u0026gt; ${node.source.value}`) console.log(`\u0026gt;\u0026gt;\u0026gt; spec type \u0026gt; ${spec.type}`) console.log(`\u0026gt;\u0026gt;\u0026gt; spec imported type \u0026gt; ${spec.imported.type}`) console.log(`\u0026gt;\u0026gt;\u0026gt; spec imported name \u0026gt; ${spec.imported.name}`)    \u0026gt;\u0026gt;\u0026gt; node type \u0026gt; ImportDeclaration \u0026gt;\u0026gt;\u0026gt; node source type \u0026gt; StringLiteral \u0026gt;\u0026gt;\u0026gt; node source value \u0026gt; ./x \u0026gt;\u0026gt;\u0026gt; spec type \u0026gt; ImportSpecifier \u0026gt;\u0026gt;\u0026gt; spec imported type \u0026gt; Identifier \u0026gt;\u0026gt;\u0026gt; spec imported name \u0026gt; a   æ‰€ä»¥ vue-next ä¸­æ–°å¢çš„ä»£ç å¤„ç†é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // import ... from \u0026#39;./x\u0026#39; è¯­å¥ç±»å‹ if (node.type === \u0026#39;ImportDeclaration\u0026#39;) { // record imports for dedupe  // import è¿›æ¥çš„å˜é‡åˆ—è¡¨  for (const specifier of node.specifiers) { // å˜é‡å  const imported = specifier.type === \u0026#39;ImportSpecifier\u0026#39; \u0026amp;\u0026amp; specifier.imported.type === \u0026#39;Identifier\u0026#39; \u0026amp;\u0026amp; specifier.imported.name // æ³¨å†Œåˆ° userImports[local] = { isType, imported, source } ä¸­  registerUserImport( node.source.value, specifier.local.name, imported, node.importKind === \u0026#39;type\u0026#39; ) } }     ç„¶å compileScript ä¸­æœ‰ä¸€æ®µå¤„ç†ä¸æ˜ç™½ï¼š\n1 2 3 4  if (scriptSetup \u0026amp;\u0026amp; scriptSetupLang !== \u0026#39;ts\u0026#39;) { // do not process non js/ts script blocks  return scriptSetup }     è¿™é‡Œæ˜¯è¯´å¦‚æœæœ‰ \u0026lt;script setup\u0026gt; ä½†æ˜¯ç±»å‹ä¸æ˜¯ ts å°±ç›´æ¥è¿”å› scriptSetup ?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const { compileScript, parse } = require(process.env.VNEXT_PKG_SFC + \u0026#34;/dist/compiler-sfc.cjs.js\u0026#34;); const { log } = require(process.env.BLOG_JS + \u0026#34;/utils.js\u0026#34;); const compile = (src, options) =\u0026gt; { const { descriptor } = parse(src); return compileScript(descriptor, { ...options, id: \u0026#34;xxxx\u0026#34; }); }; const res = compile(` \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; import { a, a1, a2 } from \u0026#39;./a\u0026#39; \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt; import { b } from \u0026#39;./b\u0026#39; \u0026lt;/script\u0026gt; `);    handling script ... with setup userImports \u0026gt; [Object: null prototype] { a: { isType: false, imported: \u0026#39;a\u0026#39;, source: \u0026#39;./a\u0026#39; }, a1: { isType: false, imported: \u0026#39;a1\u0026#39;, source: \u0026#39;./a\u0026#39; }, a2: { isType: false, imported: \u0026#39;a2\u0026#39;, source: \u0026#39;./a\u0026#39; } } userImportAlias \u0026gt; [Object: null prototype] {} undefined   åˆ°æ­¤ï¼Œå› ä¸ºè¿˜æ²¡å®ç° \u0026lt;script setup\u0026gt; è§£æï¼Œæ‰€ä»¥åªèƒ½çœ‹åˆ°æ™®é€š script æ ‡ç­¾çš„å¤„ç†ç»“æœã€‚\nimport â€¦ from å¤„ç†  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  for (const node of scriptAst) { // import ... from \u0026#39;...\u0026#39;  if (node.type === \u0026#34;ImportDeclaration\u0026#34;) { // record imports for dedupe  for (const specifier of node.specifiers) { const imported = specifier.type === \u0026#34;ImportSpecifier\u0026#34; \u0026amp;\u0026amp; specifier.imported.type === \u0026#34;Identifier\u0026#34; \u0026amp;\u0026amp; specifier.imported.name; registerUserImport( node.source.value, specifier.local.name, imported, node.importKind === \u0026#34;type\u0026#34; ); } console.log(\u0026#34;userImports \u0026gt; \\n\u0026#34;, userImports); console.log(\u0026#34;userImportAlias \u0026gt; \\n\u0026#34;, userImportAlias); } }     ä¸Šé¢å¤„ç†ï¼šéå† script ä¸­æ‰€æœ‰ ast èŠ‚ç‚¹ï¼Œæ‰¾å‡º import ... from ... è¯­å¥ï¼Œå–å‡º\n å¼•å…¥çš„æ–‡ä»¶æºéƒ¨åˆ†ï¼š node.source.value\n å¼•å…¥ä¹‹åçš„å˜é‡æˆ–è§£æ„åçš„å˜é‡ï¼š imported.name\n ç»„æˆæ–°çš„ç»“æ„ { isType: false, imported: \u0026#39;a\u0026#39;, source: \u0026#39;./a\u0026#39;} ä¿å­˜åˆ° userImports ä¸­\n ä¿®æ”¹ä¸‹ï¼Œå¼•å…¥å¤šä¸ªå˜é‡å‘¢ï¼Ÿç»“æœå¦‚ä¸‹ï¼š\nuserImports \u0026gt; [Object: null prototype] { a: { isType: false, imported: \u0026#39;a\u0026#39;, source: \u0026#39;./a\u0026#39; }, a1: { isType: false, imported: \u0026#39;a1\u0026#39;, source: \u0026#39;./a\u0026#39; }, a2: { isType: false, imported: \u0026#39;a2\u0026#39;, source: \u0026#39;./a\u0026#39; }   æ¯ä¸ªå˜é‡ä½œä¸ºä¸€é¡¹ä¿å­˜ã€‚\n  export default {} å¤„ç†   export default {} è¯­æ³•çš„å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10  /* else */ if (node.type === \u0026#34;ExportDefaultDeclaration\u0026#34;) { // export default  defaultExport = node; const start = node.start! + scriptStartOffset!; s.overwrite( start, start + `export default`.length, `const ${defaultTempVar}=` ); }     å˜é‡ s :\n const s = new MagicString(source)\n ç­‰äºæ˜¯å°† export default å†…å®¹èµ‹å€¼ç»™ __default__ å˜é‡ä¸Šã€‚\n export default {...} å¤„ç†æˆ const __default__ =\n GitHub - Rich-Harris/magic-string: Manipulate strings like a wizard\n ä»ä»“åº“ä»‹ç»:\n Suppose you have some source code. You want to make some light modifications to it - replacing a few characters here and thereâ€¦\n è¿™ä¸ªåº“çš„ä½œç”¨æ˜¯ç”¨æ¥æ›¿æ¢æºç ä¸­çš„éƒ¨åˆ†ä»£ç çš„(å­—ç¬¦ä¸²çš„ä¸€äº›æ“ä½œ)ã€‚\n å…ˆçœ‹æµ‹è¯•å§ï¼šè¾“å‡ºå¤„ç†å‰åçš„ source -\u0026gt; s\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const [result] = compileSFC(` \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; export default { data() {}, computed: {} } \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt; export default {} \u0026lt;/script\u0026gt; `);    handling script ... with setup ----- before ----- \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; export default { data() {}, computed: {} } \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt; export default {} \u0026lt;/script\u0026gt; ----- after ----- \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; const __default__ = { data() {}, computed: {} } \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt; export default {} \u0026lt;/script\u0026gt; undefined   ç»“æœå¦‚ä¸Šã€‚\n Tip: è¯·å¿½ç•¥ setup éƒ¨åˆ†ï¼Œå› ä¸ºå¿…é¡»è¦æœ‰ä¸€ä¸ª \u0026lt;script setup\u0026gt; ä¸”å¿…é¡»æ˜¯ ts è¯­è¨€æ‰èƒ½è¿› å…¥åˆ°è¿™éƒ¨åˆ†å¤„ç†ã€‚\n   export â€¦ [from] å¤„ç†   export { ...} from \u0026#39;...\u0026#39; çš„å¤„ç†ã€‚\n å¦‚ï¼š\n export { x as default } from \u0026#39;./x\u0026#39;\n export { x as default }\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  /*else*/ if (node.type === \u0026#34;ExportNamedDeclaration\u0026#34; \u0026amp;\u0026amp; node.specifiers) { const defaultSpecifier = node.specifiers.find( (s) =\u0026gt; s.exported.type === \u0026#34;Identifier\u0026#34; \u0026amp;\u0026amp; s.exported.name === \u0026#34;default\u0026#34; ) as ExportSpecifier; if (defaultSpecifier) { defaultExport = node; // 1. remove specifier  if (node.specifiers.length \u0026gt; 1) { s.remove( defaultSpecifier.start! + scriptStartOffset!, defaultSpecifier.end! + scriptStartOffset! ); } else { s.remove( node.start! + scriptStartOffset!, node.end! + scriptStartOffset! ); } if (node.source) { // export { x as default } from \u0026#39;./x\u0026#39;  // é‡å†™æˆ rewrite to `import { x as __default } from \u0026#39;./x\u0026#39;  // ç„¶åæ·»åŠ åˆ°é¡¶éƒ¨  s.prepend( `import { ${defaultSpecifier.local.name}as ${defaultTempVar}} from \u0026#39;${node.source.value}\u0026#39;\\n` ); } else { // export { x as default }  // é‡å†™æˆ `const __default__ = x` ä¸”ç§»åˆ°æœ€å  s.append(`\\nconst ${defaultTempVar}= ${defaultSpecifier.local.name}\\n`); } } }     æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); compileSFC(` \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt;export { a as default } from \u0026#39;./x\u0026#39;\u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt;export default {}\u0026lt;/script\u0026gt; `); compileSFC(` \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; const a = {} export { a as default } \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt;export default {}\u0026lt;/script\u0026gt; `);    handling script ... with setup ----- s, source, before ----- \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt;export { a as default } from \u0026#39;./x\u0026#39;\u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt;export default {}\u0026lt;/script\u0026gt; ----- s, source, after ----- import { a as __default__ } from \u0026#39;./x\u0026#39; \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt;export default {}\u0026lt;/script\u0026gt; handling script ... with setup ----- s, source, before ----- \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; const a = {} export { a as default } \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt;export default {}\u0026lt;/script\u0026gt; ----- s, source, after ----- \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; const a = {} \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt;export default {}\u0026lt;/script\u0026gt; const __default__ = a undefined   ä»æ–‡ä»¶å¯¼å…¥çš„ï¼Œæ”¾åˆ° source æœ€å‰é¢å»äº†\n ç”¨å˜é‡å¯¼å‡ºçš„ï¼Œæ”¾åˆ° source æœ€åé¢å»äº†\n    2âƒ£ 8edf0d7 è§£æ \u0026lt;script setup\u0026gt;   feat(add): sfc-\u0026gt;script, setup ref process Â· gcclll/stb-vue-next@8edf0d7\n å¦‚æœåªä¿ç•™å…³é”®ä»£ç ï¼Œè¿™é‡Œçš„å¤„ç†ä¸»è¦åœ¨ processRefExpression() ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  // @babel/parser è§£æå‡º\u0026lt;script setup\u0026gt; çš„ ast const scriptSetupAst = parse( scriptSetup.content, { plugins: [ ...plugins, // allow top level await but only inside \u0026lt;script setup\u0026gt;  \u0026#34;topLevelAwait\u0026#34;, ], sourceType: \u0026#34;module\u0026#34;, }, startOffset ); for (const node of scriptSetupAst) { // ... çœç•¥  // å¤„ç† `ref: x` ç»‘å®šï¼Œè½¬æˆ refs  if ( node.type === \u0026#34;LabeledStatement\u0026#34; \u0026amp;\u0026amp; node.label.name === \u0026#34;ref\u0026#34; \u0026amp;\u0026amp; node.body.type === \u0026#34;ExpressionStatement\u0026#34; ) { // å¿…é¡»è¦å¼€å¯ ref åŠŸèƒ½  if (enableRefSugar) { warnExperimental(`ref: sugar`, 228); s.overwrite( node.label.start! + startOffset, node.boy.start! + startOffset, \u0026#34;const \u0026#34; ); processRefExpression(node.body.expression, node); } } }     ä¸‹é¢æ˜¯ processRefExpression å¯¹ ref: è¯­æ³•ç³–çš„å„ç§ä½¿ç”¨æƒ…å†µåˆ†æã€‚\nd4f6497 ref: n = 100   feat(add): sfc-\u0026gt;script, ref: in setup Â· gcclll/stb-vue-next@d4f6497\n å°† ref: n = 100 ç¿»è¯‘æˆ const n = _ref(100)\n æ–°å¢æ ¸å¿ƒå¤„ç†ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); compileSFC( ` \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; const a = {} export { a as default } \u0026lt;/script\u0026gt; \u0026lt;script lang=\u0026#34;ts\u0026#34; setup\u0026gt; ref: n = 100 \u0026lt;/script\u0026gt; `, { enableRefSugar: true } );      db7cb02 ref: { n = 1 } = useFoo()   feat(add): sfc-\u0026gt;script, ref: ({ b: 1} = {}) Â· gcclll/stb-vue-next@db7cb02\n å¯¹è±¡è§£æ„è¯­æ³•æ”¯æŒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); compileSFC( ` \u0026lt;script\u0026gt; export default { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({ b = 1, foo: bar, nested: { baz: bax } } = { count: 0, b: 2 }) \u0026lt;/script\u0026gt; `, { enableRefSugar: true } );    ---- before ---- \u0026lt;script\u0026gt; const __default__ = { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({ b = 1, foo: bar, nested: { baz: bax } } = { count: 0, b: 2 }) \u0026lt;/script\u0026gt; ---- after ---- \u0026lt;script\u0026gt; const __default__ = { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; const { b: __b = 1, foo: __bar, nested: { baz: __bax } } = { count: 0, b: 2 } \u0026lt;/script\u0026gt; undefined   æ”¯æŒè§£æ„åé‡å‘½åï¼šfeat(add): sfc-\u0026gt;script, ref: ({ b: bb} = {}) rename Â· gcclll/stb-vue-next@e83d25a\n å¯¹è±¡åµŒå¥—è§£æ„ï¼šfeat(add): sfc-\u0026gt;script, ref deconstruct nested object Â· gcclll/stb-vue-next@5c615d5\n è§£æ„é‡å‘½åï¼šfeat(add): sfc-\u0026gt;script, ref deconstruct object rename Â· gcclll/stb-vue-next@e3ffe6f\n  af26553 ref: [a] = useFoo() æ•°æ®è§£æ„   feat(add): sfc-\u0026gt;script, ref deconstruct array Â· gcclll/stb-vue-next@af26553\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); compileSFC( ` \u0026lt;script\u0026gt; export default { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({ foo: [bar], baz: [,,bax]} = useFoo()) \u0026lt;/script\u0026gt; `, { enableRefSugar: true } );    ---- before ---- \u0026lt;script\u0026gt; const __default__ = { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({ foo: [bar], baz: [,,bax]} = useFoo()) \u0026lt;/script\u0026gt; ---- after ---- \u0026lt;script\u0026gt; const __default__ = { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; const { foo: [__bar], baz: [,,__bax]} = useFoo() const bar = _ref(__bar); const bax = _ref(__bax); \u0026lt;/script\u0026gt; undefined    a9f4469 ref: ({â€¦foo} = useFoo()) å±•å¼€ç¬¦   feat(add): sfc-\u0026gt;script, ref deconstruct with es6 rest element Â· gcclll/stb-vue-next@a9f4469\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); compileSFC( ` \u0026lt;script\u0026gt; export default { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({...foo} = useFoo()) \u0026lt;/script\u0026gt; `, { enableRefSugar: true } );    ---- before ---- \u0026lt;script\u0026gt; const __default__ = { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({...fo} = useFoo()) \u0026lt;/script\u0026gt; ---- after ---- \u0026lt;script\u0026gt; const __default__ = { b: 2 } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; const {...__fo} = useFoo() \u0026lt;/script\u0026gt; undefined    d52a6d0 _ref(â€¦) å¢åŠ  ref å£°æ˜   feat(add): sfc-\u0026gt;script, ref all variables Â· gcclll/stb-vue-next@d52a6d0\n åœ¨è§£æå®Œæ‰€æœ‰ ref: xxx è¯­æ³•ä¹‹åï¼Œéœ€è¦å°†è§£æ„å‡ºæ¥çš„ç¼–ç ï¼Œè¿›è¡Œ ref åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11  const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) compileSFC(` \u0026lt;script\u0026gt;export default {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({ a, b: { foo, bar: bax }, c = 1, d: [doo1,, doo3], e: e1 = 2 } = useFoo()); \u0026lt;/script\u0026gt; `, { enableRefSugar: true })    ---- before ---- \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: ({ a, b: { foo, bar: bax }, c = 1, d: [doo1,, doo3], e: e1 = 2 } = useFoo()); \u0026lt;/script\u0026gt; ---- after ---- \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; const { a: __a, b: { foo: __foo, bar: __bax }, c: __c = 1, d: [__doo1,, __doo3], e: __e1 = 2 } = useFoo(); const a = _ref(__a); const foo = _ref(__foo); const bax = _ref(__bax); const c = _ref(__c); const doo1 = _ref(__doo1); const doo3 = _ref(__doo3); const e1 = _ref(__e1); \u0026lt;/script\u0026gt; undefined   åˆ°è¿™é‡Œ ref è¯­æ³•æ‰ç®—è§£æå®Œæˆäº†ã€‚\n  å€ŸåŠ© @babel/parser å¾—åˆ° script[setup] ast å¤„ç† ref åŠè§£æ„è¯­æ³•\n  å°†è§£æ„ä¹‹åçš„å˜é‡è¿›è¡Œ ref è¯­æ³•åŒ–ã€‚\n    168041c ref: a = 1, b = 2 å¤šæ¡è¯­å¥   feat(add): sfc-\u0026gt;script, multiple statements after ref: Â· gcclll/stb-vue-next@168041c\n1 2 3 4 5 6 7 8 9 10 11  const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); compileSFC( ` \u0026lt;script\u0026gt;export default {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: a = 1, b = 2, c = 3 \u0026lt;/script\u0026gt; `, { enableRefSugar: true } );    ---- before ---- \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; ref: a = 1, b = 2, c = 3 \u0026lt;/script\u0026gt; ---- after ---- \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; const a = _ref(1), b = _ref(2), c = _ref(3) \u0026lt;/script\u0026gt; undefined    6e337c5 imports ç½®é¡¶ğŸ”   feat(add): sfc-\u0026gt;script, hoist imports to top Â· gcclll/stb-vue-next@6e337c5\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { compileSFC, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); compileSFC( ` \u0026lt;script\u0026gt;export default {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { a } from \u0026#39;./a\u0026#39; import { b } from \u0026#39;./b\u0026#39; import { foo, bar } from \u0026#39;./baz\u0026#39; \u0026lt;/script\u0026gt; `, { enableRefSugar: true } );    ---- before ---- \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { a } from \u0026#39;./a\u0026#39; import { b } from \u0026#39;./b\u0026#39; import { foo, bar } from \u0026#39;./baz\u0026#39; \u0026lt;/script\u0026gt; ---- after ---- import { a } from \u0026#39;./a\u0026#39; \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { b } from \u0026#39;./b\u0026#39; import { foo, bar } from \u0026#39;./baz\u0026#39; \u0026lt;/script\u0026gt; ---- before ---- import { a } from \u0026#39;./a\u0026#39; \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { b } from \u0026#39;./b\u0026#39; import { foo, bar } from \u0026#39;./baz\u0026#39; \u0026lt;/script\u0026gt; ---- after ---- import { a } from \u0026#39;./a\u0026#39; import { b } from \u0026#39;./b\u0026#39; \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { foo, bar } from \u0026#39;./baz\u0026#39; \u0026lt;/script\u0026gt; ---- before ---- import { a } from \u0026#39;./a\u0026#39; import { b } from \u0026#39;./b\u0026#39; \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { foo, bar } from \u0026#39;./baz\u0026#39; \u0026lt;/script\u0026gt; ---- after ---- import { a } from \u0026#39;./a\u0026#39; import { b } from \u0026#39;./b\u0026#39; import { foo, bar } from \u0026#39;./baz\u0026#39; \u0026lt;script\u0026gt;const __default__ = {}\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; \u0026lt;/script\u0026gt; undefined   å¦‚ä¸Šï¼Œç»è¿‡å‡ è½®å¾ªç¯ï¼Œå°†ä¸‰ä¸ª import æå‡åˆ°äº†æœ€å¼€å§‹ä½ç½®ã€‚\n  TODO 68d4940 defineProps/Emit() å¤„ç†   feat(add): sfc-\u0026gt;script, defineProps/Emit Â· gcclll/stb-vue-next@68d4940\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  const { compile, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const {content, bindings} = compile(` \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { defineProps } from \u0026#39;vue\u0026#39; interface Test {} type Alias = number[] defineProps\u0026lt;{ string: string number: number boolean: boolean object: object objectLiteral: { a: number } fn: (n: number) =\u0026gt; void functionRef: Function objectRef: Object array: string[] arrayRef: Array\u0026lt;any\u0026gt; tuple: [number, number] set: Set\u0026lt;string\u0026gt; literal: \u0026#39;foo\u0026#39; optional?: any recordRef: Record\u0026lt;string, null\u0026gt; interface: Test alias: Alias union: string | number literalUnion: \u0026#39;foo\u0026#39; | \u0026#39;bar\u0026#39; literalUnionMixed: \u0026#39;foo\u0026#39; | 1 | boolean intersection: Test \u0026amp; {} }\u0026gt;() \u0026lt;/script\u0026gt;`)        3âƒ£ 5160a6d ref -\u0026gt; ref.value   feat(add): sfc-\u0026gt;script, ref -\u0026gt; ref.value Â· gcclll/stb-vue-next@5160a6d\n å°†å¯¹ ref å˜é‡çš„è®¿é—®è½¬æˆå¯¹ ref.value çš„è®¿é—®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { compileSFC, log, compile } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { content } = compile( ` \u0026lt;script setup\u0026gt; ref: a = 1 console.log(a) function get() { return a + 1 } \u0026lt;/script\u0026gt; ` ); console.log(content);    { enableRefSugar: true, refBindings: [Object: null prototype] { a: \u0026#39;setup-ref\u0026#39; } } \u0026lt;script setup\u0026gt; const a = _ref(1) console.log(a.value) function get() { return a.value + 1 } \u0026lt;/script\u0026gt; undefined    TODO 4âƒ£ a6f4dae extract define props/emits   feat(add): sfc-\u0026gt;script, extract props/emits Â· gcclll/stb-vue-next@a6f4dae\n1 2 3 4 5 6 7 8 9 10  const { compile, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { content } = compile(` \u0026lt;script setup\u0026gt; defineProps({ foo: String }) \u0026lt;/script\u0026gt; `) console.log(content)    ExpressionStatement -- undefined {} xx undefined    TODO 5âƒ£ 480acf0 checkInvalidScopeReference   feat(add): sfc-\u0026gt;script, check invalid scope references Â· gcclll/stb-vue-next@480acf0\n æ£€æŸ¥ useOptions ï¼Œæ˜¯å¦åŒ…å« \u0026lt;setup\u0026gt; ä¸­å·²ç»å­˜åœ¨çš„å˜é‡ï¼Œå³ useOptions ä¸­ä¸èƒ½ æœ‰ setup ä¸­å£°æ˜çš„å˜é‡ã€‚\n  TODO 6âƒ£ 25662c6 åˆ é™¤é script å†…å®¹   feat(add): sfc-\u0026gt;script, delete non-script content Â· gcclll/stb-vue-next@25662c6\n  7âƒ£ deed8c1 analyze binding metadata(bindingMetadata)   feat(add): sfc-\u0026gt;script, analyze binding metadata Â· gcclll/stb-vue-next@deed8c1\n1 2 3 4 5 6 7 8 9 10 11  const { compile, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const res = compile(` \u0026lt;script setup\u0026gt; const props = defineProps({ foo: String }) ref: a = 1 const b = 2 \u0026lt;/script\u0026gt; `); console.log(res.bindings);    { foo: \u0026#39;props\u0026#39;, props: \u0026#39;setup-const\u0026#39;, a: \u0026#39;setup-ref\u0026#39;, b: \u0026#39;setup-const\u0026#39; } undefined    8âƒ£ 9cd2fd5 inject useCssVars, css å˜é‡å¤„ç†   feat(add): sfc-\u0026gt;script, inject useCssVars Â· gcclll/stb-vue-next@9cd2fd5\n\u0026lt;style\u0026gt; v-bind css å˜é‡   å¤„ç† style ä¸­ä½¿ç”¨çš„ css å˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // compileScript.ts // TODO 8. æ³¨å…¥ `useCssVars` è°ƒç”¨  if (cssVars.length) { helperImports.add(CSS_VARS_HELPER) helperImports.add(\u0026#39;unref\u0026#39;) s.prependRight( startOffset, `\\n${genCssVarsCode( cssVars, bindingMetadata, scopeId, !!options.isProd )}\\n` ) }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { compile, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { content } = compile(` \u0026lt;script\u0026gt;const a = 1\u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { defineProps, ref } from \u0026#39;vue\u0026#39; const color = \u0026#39;red\u0026#39; const height = ref(\u0026#39;10px\u0026#39;) defineProps({ foo: Striing }) \u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; div { color: v-bind(color); font-size: v-bind(\u0026#39;font.size\u0026#39;); height: v-bind(height); border: v-bind(foo) } \u0026lt;/style\u0026gt; `); // 1. æœ¬åœ°å˜é‡ç»‘å®š // 2. æœ¬åœ° ref ç»‘å®š // 3. props ç»‘å®š console.log(content);    import { ref } from \u0026#39;vue\u0026#39; const a = 1 _useCssVars(_ctx =\u0026gt; ({ \u0026#34;xxxxxxxx-color\u0026#34;: (color), \u0026#34;xxxxxxxx-font_size\u0026#34;: (_ctx.font.size), \u0026#34;xxxxxxxx-height\u0026#34;: (height.value), \u0026#34;xxxxxxxx-foo\u0026#34;: (__props.foo) })) const color = \u0026#39;red\u0026#39; const height = ref(\u0026#39;10px\u0026#39;) undefined    css å˜é‡é‡å†™ï¼š   æºç å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const needRewrite = cssVars.length || hasInheritAttrsFlag; let content = script.content; if (needRewrite) { content = rewriteDefault(content, `__default__`, plugins); if (cssVars.length) { content += genNormalScriptCssVarsCode( cssVars, bindings, scopeId, !!options.isProd ); } if (hasInheritAttrsFlag) { content += `__default__.inheritAttrs = false`; } content += `\\nexport default __default__`; }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  const { compileStyle, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { code } = compileStyle({ source: `.foo { color: v-bind(color); font-size: v-bind(\u0026#39;font.size\u0026#39;); }`, filename: \u0026#34;test.css\u0026#34;, id: \u0026#34;data-v-test\u0026#34;, }); console.log(code);    .foo { color: var(--test-color); font-size: var(--test-font_size); } undefined    isProd option ä½¿ç”¨ hash å˜é‡å   ç”Ÿäº§æ¨¡å¼ï¼Œä½¿ç”¨éšæœº hash å€¼ä½œä¸ºåå­—ï¼š\n1 2 3 4 5 6 7 8  // cssVars.ts function genVarName(id: string, raw: string, isProd: boolean): string { if (isProd) { return hash(id + raw) } else { return `${id}-${raw.replace(/([^\\w-])/g, \u0026#39;_\u0026#39;)}` } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11  const { compile, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { content } = compile( `\u0026lt;script\u0026gt;const a = 1\u0026lt;/script\u0026gt;\\n` + `\u0026lt;style\u0026gt;div{ color: v-bind(color); font-size: v-bind(\u0026#39;font.size\u0026#39;); }\u0026lt;/style\u0026gt;`, { isProd: true } ); console.log(content);    const a = 1 const __default__ = {} import { useCssVars as _useCssVars } from \u0026#39;vue\u0026#39; const __injectCSSVars__ = () =\u0026gt; { _useCssVars(_ctx =\u0026gt; ({ \u0026#34;4003f1a6\u0026#34;: (_ctx.color), \u0026#34;41b6490a\u0026#34;: (_ctx.font.size) }))} const __setup__ = __default__.setup __default__.setup = __setup__ ? (props, ctx) =\u0026gt; { __injectCSSVars__();return __setup__(props, ctx) } : __injectCSSVars__ export default __default__ undefined      TODO 9âƒ£ eef6fd5 setup() å‚æ•°ç­¾å   feat(add): sfc-\u0026gt;script, setup() å‚æ•°ç­¾å Â· gcclll/stb-vue-next@eef6fd5\n1 2 3 4 5 6 7 8 9 10  const { compile, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { content } = compile(` \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { defineProps, defineEmit } from \u0026#39;vue\u0026#39; const props = defineProps({ foo: String }) const emit = defineEmit([\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;]) \u0026lt;/script\u0026gt;`) console.log(content)    import { defineComponent as _defineComponent } from \u0026#39;vue\u0026#39; export default _defineComponent({ expose: [], props: { foo: String }, emits: [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;], setup(__props, { emit }) { const props = __props return { props, emit } } }) undefined    ğŸ”Ÿ 9cedeab ç”Ÿæˆ return è¯­å¥   feat(add): sfc-\u0026gt;script, process render function return Â· gcclll/stb-vue-next@9cedeab\n1 2 3 4 5 6 7 8 9 10  const { compile, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { content } = compile(` \u0026lt;script setup\u0026gt; import { x } from \u0026#39;./x\u0026#39; let a = 1 const b = 2 function c() {} class d {} \u0026lt;/script\u0026gt;`); console.log(content);    import { x } from \u0026#39;./x\u0026#39; let a = 1 const b = 2 function c() {} class d {} return { a, b, c, d, x } } undefined   å°†æ‰€æœ‰å˜é‡éƒ½è¿”å›å‡ºå»äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const { compile, log } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const { content } = compile( ` \u0026lt;script setup\u0026gt; import { ref } from \u0026#39;vue\u0026#39; const count = ref(0) \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div\u0026gt;{{ count }}\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;static\u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;style\u0026gt; div { color: v-bind(count) } \u0026lt;/style\u0026gt;`, { inlineTemplate: true, } ); console.log(content);    import { toDisplayString as _toDisplayString, createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from \u0026#34;vue\u0026#34; const _hoisted_1 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, null, \u0026#34;static\u0026#34;, -1 /* HOISTED */) import { ref } from \u0026#39;vue\u0026#39; _useCssVars(_ctx =\u0026gt; ({ \u0026#34;xxxxxxxx-count\u0026#34;: (count.value) })) const count = ref(0) return (_ctx, _cache) =\u0026gt; { return (_openBlock(), _createBlock(_Fragment, null, [ _createVNode(\u0026#34;div\u0026#34;, null, _toDisplayString(count.value), 1 /* TEXT */), _hoisted_1 ], 64 /* STABLE_FRAGMENT */)) } } undefined   å¦‚æœè¦æ”¯æŒï¼š\n1 2 3 4 5 6  { inlineTemplate: true, templateOptions: { ssr: true } }     è¿˜éœ€è¦å®ç° compiler-ssr æ¨¡å—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // TODO 10. ç”Ÿæˆè¿”å›è¯­å¥(return) let returned; if (options.inlineTemplate) { if (sfc.template \u0026amp;\u0026amp; !sfc.template.src) { // TODO éœ€è¦ compiler-ssr æ”¯æŒ  } else { returned = `() =\u0026gt; {}`; } } else { // return bindings from setup  const allBindings: Record\u0026lt;string, any\u0026gt; = { ...setupBindings }; for (const key in userImports) { if (!userImports[key].isType) { allBindings[key] = true; } } returned = `{ ${Object.keys(allBindings).join(\u0026#34;, \u0026#34;)}}`; } s.appendRight(endOffset, `\\nreturn ${returned}\\n}\\n\\n`);      TODO 1âƒ£1âƒ£ cfca9de finalize default export   feat(add): sfc-\u0026gt;script, finalize default export Â· gcclll/stb-vue-next@cfca9de\n1 2 3 4 5 6 7 8 9 10 11 12  const { compile, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { content, bindings } = compile(` \u0026lt;script setup\u0026gt; import { defineEmit } from \u0026#39;vue\u0026#39; const myEmit = defineEmit([\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;]) const props = defineProps({ foo: String }) \u0026lt;/script\u0026gt; `) console.log(content)    export default { expose: [], props: { foo: String }, emits: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;], setup(__props, { emit: myEmit }) { const props = __props return { myEmit, props } } } undefined   emits å“ªå»äº†??? -\u0026gt; fix: d631810\n  FIX: fix: sfc-\u0026gt;script, expose indent Â· gcclll/stb-vue-next@d631810\n  TODO 1âƒ£2âƒ£ 5810296 finalize Vue helper imports   feat(add): sfc-\u0026gt;script, finalize vue helper imports Â· gcclll/stb-vue-next@5810296\n    61c3b7a transform src set   feat(add): sfc-\u0026gt;srcset transform Â· gcclll/stb-vue-next@61c3b7a\n è½¬æ¢ \u0026lt;img\u0026gt; å’Œ \u0026lt;source\u0026gt; çš„ srcset å±æ€§ã€‚\n img srcset å±æ€§å€¼ï¼š \u0026lt;img srcset=\u0026#34;url 1x, url2 2x, ...\u0026#34;\u0026gt; æµè§ˆå™¨ä¼šæ ¹æ®å®é™…æƒ…å†µæ¥ é€‰ç”¨ srcset ä¸­åˆé€‚çš„å›¾ç‰‡åœ°å€æ¥æ˜¾ç¤ºã€‚\n æœ‰å…³ Reponsive Images è¯´æ˜: Responsive images - Learn web development | MDNã€‚\n  æµ‹è¯•ï¼š\n1 2 3 4  const { compileWithSrcset: compile, log, src } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { code } = compile(src) console.log(code)    import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from \u0026#34;vue\u0026#34; import _imports_0 from \u0026#39;./logo.png\u0026#39; const _hoisted_1 = _imports_0 const _hoisted_2 = _imports_0 + \u0026#39;2x\u0026#39; const _hoisted_3 = _imports_0 + \u0026#39;2x\u0026#39; const _hoisted_4 = _imports_0 + \u0026#39;, \u0026#39; + _imports_0 + \u0026#39;2x\u0026#39; const _hoisted_5 = _imports_0 + \u0026#39;2x, \u0026#39; + _imports_0 const _hoisted_6 = _imports_0 + \u0026#39;2x, \u0026#39; + _imports_0 + \u0026#39;3x\u0026#39; const _hoisted_7 = _imports_0 + \u0026#39;, \u0026#39; + _imports_0 + \u0026#39;2x, \u0026#39; + _imports_0 + \u0026#39;3x\u0026#39; const _hoisted_8 = \u0026#34;/logo.png\u0026#34; + \u0026#39;, \u0026#39; + _imports_0 + \u0026#39;2x\u0026#39; export function render(_ctx, _cache) { return (_openBlock(), _createBlock(_Fragment, null, [ _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_1 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_2 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_3 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_4 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_5 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_6 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_7 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/logo.png\u0026#34;, srcset: \u0026#34;/logo.png, /logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;https://example.com/logo.png\u0026#34;, srcset: \u0026#34;https://example.com/logo.png, https://example.com/logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/logo.png\u0026#34;, srcset: _hoisted_8 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;data:image/png;base64,i\u0026#34;, srcset: \u0026#34;data:image/png;base64,i 1x, data:image/png;base64,i 2x\u0026#34; }) ], 64 /* STABLE_FRAGMENT */)) } undefined   æŒ‡å®š options.base: \u0026#39;/foo\u0026#39; æµ‹è¯•ç»“æœï¼š\n1 2 3 4  const { compileWithSrcset: compile, log, src } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { code } = compile(src, { base: \u0026#39;/foo\u0026#39; }) console.log(code)    import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from \u0026#34;vue\u0026#34; export function render(_ctx, _cache) { return (_openBlock(), _createBlock(_Fragment, null, [ _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: \u0026#34;/foo/logo.png\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: \u0026#34;/foo/logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: \u0026#34;/foo/logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: \u0026#34;/foo/logo.png, /foo/logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: \u0026#34;/foo/logo.png 2x, /foo/logo.png\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: \u0026#34;/foo/logo.png 2x, /foo/logo.png 3x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: \u0026#34;/foo/logo.png, /foo/logo.png 2x, /foo/logo.png 3x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/logo.png\u0026#34;, srcset: \u0026#34;/logo.png, /logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;https://example.com/logo.png\u0026#34;, srcset: \u0026#34;https://example.com/logo.png, https://example.com/logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/logo.png\u0026#34;, srcset: \u0026#34;/logo.png, /foo/logo.png 2x\u0026#34; }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;data:image/png;base64,i\u0026#34;, srcset: \u0026#34;data:image/png;base64,i 1x, data:image/png;base64,i 2x\u0026#34; }) ], 64 /* STABLE_FRAGMENT */)) } undefined   options.includeAbsolute: true é€‰é¡¹:\n1 2 3 4  const { compileWithSrcset: compile, log, src } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { code } = compile(src, { includeAbsolute: true }) console.log(code)    import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from \u0026#34;vue\u0026#34; import _imports_0 from \u0026#39;./logo.png\u0026#39; import _imports_1 from \u0026#39;/logo.png\u0026#39; const _hoisted_1 = _imports_0 const _hoisted_2 = _imports_0 + \u0026#39;2x\u0026#39; const _hoisted_3 = _imports_0 + \u0026#39;2x\u0026#39; const _hoisted_4 = _imports_0 + \u0026#39;, \u0026#39; + _imports_0 + \u0026#39;2x\u0026#39; const _hoisted_5 = _imports_0 + \u0026#39;2x, \u0026#39; + _imports_0 const _hoisted_6 = _imports_0 + \u0026#39;2x, \u0026#39; + _imports_0 + \u0026#39;3x\u0026#39; const _hoisted_7 = _imports_0 + \u0026#39;, \u0026#39; + _imports_0 + \u0026#39;2x, \u0026#39; + _imports_0 + \u0026#39;3x\u0026#39; const _hoisted_8 = _imports_1 + \u0026#39;, \u0026#39; + _imports_1 + \u0026#39;2x\u0026#39; const _hoisted_9 = \u0026#34;https://example.com/logo.png\u0026#34; + \u0026#39;, \u0026#39; + \u0026#34;https://example.com/logo.png\u0026#34; + \u0026#39;2x\u0026#39; const _hoisted_10 = _imports_1 + \u0026#39;, \u0026#39; + _imports_0 + \u0026#39;2x\u0026#39; const _hoisted_11 = \u0026#34;data:image/png;base64,i\u0026#34; + \u0026#39;1x, \u0026#39; + \u0026#34;data:image/png;base64,i\u0026#34; + \u0026#39;2x\u0026#39; export function render(_ctx, _cache) { return (_openBlock(), _createBlock(_Fragment, null, [ _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_1 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_2 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_3 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_4 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_5 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_6 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;./logo.png\u0026#34;, srcset: _hoisted_7 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/logo.png\u0026#34;, srcset: _hoisted_8 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;https://example.com/logo.png\u0026#34;, srcset: _hoisted_9 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;/logo.png\u0026#34;, srcset: _hoisted_10 }), _createVNode(\u0026#34;img\u0026#34;, { src: \u0026#34;data:image/png;base64,i\u0026#34;, srcset: _hoisted_11 }) ], 64 /* STABLE_FRAGMENT */)) } undefined    æ€»ç»“   SFC æ¨¡å—çš„ä½œç”¨ï¼š\n  è§£æ Render å‡½æ•°ï¼Œæ›¿æ¢ ref å˜é‡\n  è§£æ \u0026lt;script\u0026gt; æ ‡ç­¾\n  è§£æ \u0026lt;script setup\u0026gt;\n  ref: è§£æï¼Œå°† ref: ç±»å‹è®¿é—®è½¬æˆå¯¹ ref.value çš„è®¿é—®\n  å°† ref: { â€¦ } è§£æ„åçš„å˜é‡è¿›è¡Œ ref(â€¦) åŒ–\n  defineProps({ foo: String }) è§£æï¼Œåˆå¹¶åˆ° export default { props: {â€¦} }\n  defineEmit({ â€¦ }) è§£æï¼Œåˆå¹¶åˆ° export default { emits: {â€¦} }\n  cssVar v-bind å˜é‡ä½¿ç”¨ï¼Œè½¬æ¢ï¼ŒåŒ…å« ref å˜é‡å¼•ç”¨è½¬æ¢\n  asset url è½¬æ¢(ç›¸å¯¹è·¯å¾„ï¼Œç»å¯¹è·¯å¾„ï¼Œ ~@path/..., @path/.. è½¬æ¢)\n  \u0026lt;img\u0026gt;, \u0026lt;source\u0026gt; çš„ srcset URLè½¬æ¢\n   ç»¼åˆæµ‹è¯•ï¼š\nscript[setup] æµ‹è¯•  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript, compileStyle, compileWithSrcset, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { content, bindings, attrs } = compileSFCScript(` \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;img src=\u0026#34;./logo.png\u0026#34; srcset=\u0026#34;./logo.png, ./logo.png 2x, ./logo.png 3x\u0026#34;/\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;{{ count }}\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;static\u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; const a = 1 export default { props: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;], data() { return { foo: null, bar } }, setup() { return { foo: 1, a } }, computed: { fcc() {}, bcc: { get() {}, set() {} } }, inject: [\u0026#39;fjj\u0026#39;, \u0026#39;bjj\u0026#39;], // { fjj: {}, bjj: {} }, methods: { quux() {} }, } \u0026lt;/script\u0026gt; \u0026lt;script setup\u0026gt; import { defineProps, ref } from \u0026#39;vue\u0026#39; let a, b, c, d ref: aa = 1 + (await foa) ref: height = 100 // å¯¹è±¡è§£æ„è¦ç”¨æ‹¬å·åŒ…è£¹èµ·æ¥ ref: ({ foo, bar: bar, baz: { bax } } = useFoo()); ref: [ar, br] = useFoo() ref: count = 0 const color = \u0026#39;red\u0026#39; const size = ref(\u0026#39;10px\u0026#39;) defineProps({ foo: String }) defineEmit([\u0026#39;fox\u0026#39;, \u0026#39;foy\u0026#39;]) // ref åœ¨å‡½æ•°ä¸­è¢«è®¿é—® function test() { const { a } = aa } \u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; div { color: v-bind(color); font-size: v-bind(\u0026#39;font.size\u0026#39;); border: v-bind(foo); height: v-bind(height); } \u0026lt;/style\u0026gt; `) log(`\u0026gt;\u0026gt;\u0026gt; content è¾“å‡ºç»“æœï¼š`) log(content) log(`\u0026gt;\u0026gt;\u0026gt; bindings è¾“å‡ºç»“æœï¼š`) log(bindings)    \u0026gt;\u0026gt;\u0026gt; content è¾“å‡ºç»“æœï¼š import { ref as _ref, useCssVars as _useCssVars, unref as _unref } from \u0026#39;vue\u0026#39; import { ref } from \u0026#39;vue\u0026#39; const a = 1 const __default__ = { props: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;], data() { return { foo: null, bar } }, setup() { return { foo: 1, a } }, computed: { fcc() {}, bcc: { get() {}, set() {} } }, inject: [\u0026#39;fjj\u0026#39;, \u0026#39;bjj\u0026#39;], // { fjj: {}, bjj: {} }, methods: { quux() {} }, } async function setup(__props) { _useCssVars(_ctx =\u0026gt; ({ \u0026#34;xxxxxxxx-color\u0026#34;: (color), \u0026#34;xxxxxxxx-font_size\u0026#34;: (_ctx.font.size), \u0026#34;xxxxxxxx-foo\u0026#34;: (foo.value), \u0026#34;xxxxxxxx-height\u0026#34;: (height.value) })) let a, b, c, d const aa = _ref(1 + (await foa)) const height = _ref(100) // å¯¹è±¡è§£æ„è¦ç”¨æ‹¬å·åŒ…è£¹èµ·æ¥ const { foo: __foo, bar: __bar, baz: { bax: __bax } } = useFoo(); const foo = _ref(__foo); const bar = _ref(__bar); const bax = _ref(__bax); const [__ar, __br] = useFoo() const ar = _ref(__ar); const br = _ref(__br); const count = _ref(0) const color = \u0026#39;red\u0026#39; const size = ref(\u0026#39;10px\u0026#39;) // ref åœ¨å‡½æ•°ä¸­è¢«è®¿é—® function test() { const { a } = aa.value } return { a, b, c, d, aa, height, foo, bar, bax, ar, br, count, color, size, test, ref } } export default /*#__PURE__*/ Object.assign(__default__, { expose: [], props: { foo: String }, emits: [\u0026#39;fox\u0026#39;, \u0026#39;foy\u0026#39;], setup }) \u0026gt;\u0026gt;\u0026gt; bindings è¾“å‡ºç»“æœï¼š { foo: \u0026#39;setup-ref\u0026#39;, bar: \u0026#39;setup-ref\u0026#39;, a: \u0026#39;setup-let\u0026#39;, fcc: \u0026#39;options\u0026#39;, bcc: \u0026#39;options\u0026#39;, fjj: \u0026#39;options\u0026#39;, bjj: \u0026#39;options\u0026#39;, quux: \u0026#39;options\u0026#39;, ref: \u0026#39;setup-const\u0026#39;, b: \u0026#39;setup-let\u0026#39;, c: \u0026#39;setup-let\u0026#39;, d: \u0026#39;setup-let\u0026#39;, aa: \u0026#39;setup-ref\u0026#39;, height: \u0026#39;setup-ref\u0026#39;, bax: \u0026#39;setup-ref\u0026#39;, ar: \u0026#39;setup-ref\u0026#39;, br: \u0026#39;setup-ref\u0026#39;, count: \u0026#39;setup-ref\u0026#39;, color: \u0026#39;setup-const\u0026#39;, size: \u0026#39;setup-ref\u0026#39;, test: \u0026#39;setup-const\u0026#39; } undefined   ç»“æœç®€æï¼š\n  \u0026lt;script setup\u0026gt; æ ‡ç­¾å†…çš„ä»£ç éƒ½ä¼šè¢«è§£æåˆ° setup() {...} å‡½æ•°ä¸­\n å³å®ƒå’Œ \u0026lt;script\u0026gt; ä¸­ä»£ç æ˜¯ä¸å†²çªçš„ï¼Œæ¯”å¦‚ \u0026lt;script\u0026gt; é‡Œé¢çš„å˜é‡ a å’Œ \u0026lt;script setup\u0026gt; ä¸­çš„åŒåå˜é‡ a äº’ä¸å½±å“ã€‚\n  åœ¨ \u0026lt;style\u0026gt; ä¸­ä½¿ç”¨çš„ v-bind æŒ‡ä»¤ä¼šä½¿ç”¨ _useCssVars è¿›è¡Œæ³¨å†Œæ›¿æ¢æˆå®é™…çš„æ · å¼å€¼\n  defineProps ä¸­å®šä¹‰çš„å˜é‡å¯¹åº” export default -\u0026gt; props\n  defineEmits ä¸­å®šä¹‰çš„å˜é‡å¯¹åº” export default -\u0026gt; emits\n  ref: height = 100 ä¸­çš„ ref: è¯­æ³•æœ€ç»ˆä¼šè½¬æˆå¯¹åº”çš„ _ref(100) reactive å˜ é‡(è¯­æ³•ç³–ï¼Œvue\u0026gt;compile-sfcè§£æ)\n å¹¶ä¸”æ”¯æŒå¤šç§ç”¨æ³•ï¼Œè§£æ„/å¤šä¸ªå£°æ˜ç»„åˆ/è§£æ„é»˜è®¤å€¼ï¼Œå¯¹äºè§£æ„åçš„å˜é‡è¿›è¡Œ _ref(...) ç„¶å setup return ä¸­è¿”å›ã€‚\n ref: è¯­å¥ä¸­å¦‚æœæœ‰è§£æ„(å¯¹è±¡è§£æ„)æ“ä½œï¼Œé‚£ä¹ˆåé¢çš„è§£æ„è¡¨è¾¾å¼å¿…é¡»ç”¨æ‹¬å·(({ a } = useFoo()))åŒ…èµ·æ¥ã€‚\n Imp. ref: è§£æ„ä¸­çš„å˜é‡åä¸èƒ½ä»¥ $ å¼€å¤´ã€‚\n  å¦‚æœ script å’Œ script setup ä¸­çš„ export default ä¸­åŒæ—¶åŒ…å«åŒåå±æ€§ï¼Œä¼šè¢« script setup ä¸­çš„æ›¿æ¢æ‰ã€‚\n å› ä¸ºç”Ÿæˆçš„ä»£ç ä¸­æ˜¯å°† script setup å¾€ script ä¸Šåˆå¹¶ã€‚\n PS. \u0026lt;script\u0026gt; å’Œ \u0026lt;script setup\u0026gt; ä¸­ export default çš„å†…å®¹å°½é‡ä¸è¦é‡å¤ã€‚\n     typescript è¯­è¨€  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { compileSFCScript: compile, compileStyle, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const { scriptAst, content } = compile(` \u0026lt;script lang=\u0026#34;ts\u0026#34;\u0026gt; import { Options, Vue } from \u0026#39;vue-class-component\u0026#39;; @Options({ components: { HelloWorld, }, props: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;] }) export default class Home extends Vue {} \u0026lt;/script\u0026gt; `) console.log(content)    import { Options, Vue } from \u0026#39;vue-class-component\u0026#39;; @Options({ components: { HelloWorld, }, props: [\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;] }) export default class Home extends Vue {} undefined      ","permalink":"https://www.cheng92.com/vue/vue-mind-map-compiler-sfc/","tags":["vue,","vue3,","compiler-sfc"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 5 â˜ compiler-sfc"},{"categories":["linux"],"contents":" ğŸ‘´ Commands(å‘½ä»¤)  fasd  fasd [options] [query ...] [f|a|s|d|z] [opions] [query ...] options: -s list paths with scores -l list paths without scores -i interactive mode -e \u0026lt;cmd\u0026gt; set command to execute on the result file -b \u0026lt;name\u0026gt; only use \u0026lt;name\u0026gt; backend -B \u0026lt;name\u0026gt; add additional backend \u0026lt;name\u0026gt; -a match files and directories -d match directories only -f match files only -r match by rank only -t match by recent access only -R reverse listing order -h show a brief help message -[0-9] select the nth entry fasd [-A|-D] [paths ...] -A add paths -D delete paths  1  cd ~/ccc/tmp      grep, egrep, fgrep   grep(1) - Linux manual page\n grep [OPTIONâ€¦] PATTERNS [FILEâ€¦] grep [OPTIONâ€¦] -e PATTERNS â€¦ [FILEâ€¦] grep [OPTIONâ€¦] -f PATTERN_FILE â€¦ [FILEâ€¦]\n  ripgrep æœç´¢å‘½ä»¤   https://github.com/BurntSushi/ripgrep#installation\n  diff     é€‰é¡¹ ç®€ä»‹     -i å¿½ç•¥æ–‡ä»¶å†…å®¹å¤§å°å†™   -E å¿½ç•¥ tab ç¬¦å·å˜åŒ–   -b å¿½ç•¥ç©ºæ ¼å˜åŒ–   -w å¿½ç•¥æ‰€æœ‰ç©ºæ ¼   -B å¿½ç•¥æ‰€æœ‰ç©ºè¡Œ   -I RE å¿½ç•¥åŒ¹é…çš„è¡Œ   -a â€“text å°†æ‰€æœ‰æ–‡ä»¶å½“åšæ–‡æœ¬å¤„ç†   -c -C NUM è¾“å‡ºæ‹·è´çš„å†…å®¹çš„æŒ‡å®šè¡Œï¼Œé»˜è®¤ï¼š3   -u -U NUM -   -p â€“show-c-function æ˜¾ç¤º C å‡½æ•°å˜æ›´   -F RE -   -q â€“brief ä»…æ–‡ä»¶ä¸åŒæ˜¯è¾“å‡º   -e â€“ed -   â€“normal è¾“å‡ºæ­£å¸¸ diff   -n â€“rcs è¾“å‡ºRCSæ ¼å¼ä¸åŒ   -y â€“side-by-side è¾“å‡ºæˆä¸¤åˆ—   -W NUM -   â€“left-column -   -D NAME -   -l â€“paginate -   -t â€“expand-tabs -   -T â€“initial-tab -   -r â€“recursive é€’å½’æ¯”è¾ƒ   -N â€“new-file -   -x PAT æ’é™¤åŒ¹é…æ–‡ä»¶æ¯”è¾ƒ   -X FILE -   -S FILE â€“starting-file=FILE -      tree å‘½ä»¤ä½¿ç”¨   install: brew install truee\n   é€‰é¡¹ å«ä¹‰     -a é€’å½’åˆ—å‡ºæ‰€æœ‰ï¼Œé»˜è®¤ä½¿ç”¨   -d ä»…åˆ—å‡ºç›®å½•   -l TODO   -f å…¨è·¯å¾„(ç›¸å¯¹)æ˜¾ç¤º   -x TODO   -L æŒ‡å®šåˆ—å‡ºçš„å±‚çº§   -R é‡æ–°æ‰§è¡Œå‘½ä»¤ï¼Œå½“ç›®å½•å±‚çº§è¾¾åˆ°ä¸Šé™æ—¶   -P pattern åˆ—å‡ºä¸æŒ‡å®š pattern åŒ¹é…çš„ç»“æœ   -I pattern ä¸ -P ç›¸åï¼ŒåŒ¹é…çš„ä¸åˆ—å‡ºæ¥   --ignore-case -P, -I å¿½ç•¥å¤§å°å†™   -o filename ç»“æœè¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶     æ–‡ä»¶é€‰é¡¹    -q å°†ä¸å¯æ‰“å°å­—ç¬¦è¾“å‡ºæˆ ?   -N å°†ä¸å¯æ‰“å°å­—ç¬¦è¾“å‡ºæˆ is   -Q æ–‡ä»¶ååŒå¼•å·æ‹¬èµ·æ¥   -p è¾“å‡ºæ–‡ä»¶æƒé™   -u è¾“å‡ºæ–‡ä»¶ owner æˆ– UID   -g è¾“å‡ºæ–‡ä»¶ç”¨æˆ·ç»„æˆ– GID   -s è¾“å‡ºæ¯ä¸ªæ–‡ä»¶çš„å­—èŠ‚å¤§å°   -h ä»¥å¯è¯»å½¢å¼è¾“å‡ºæ¯ä¸ªæ–‡ä»¶å­—èŠ‚å¤§å°   --si å’Œ -h ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯ä»¥ SI å•ä½   -D è¾“å‡ºä¸Šæ¬¡ä¿®æ”¹çš„æ—¶é—´   -F ç›®å½•æœ€åæ˜¾ç¤º /   --inodes è¾“å‡ºæ–‡ä»¶ inode æ•°å­—   --device è¾“å‡ºæ¯ä¸ªæ–‡ä»¶æ‰€å±çš„è®¾å¤‡ID     æ’åºé€‰é¡¹    -v æ ¹æ® version   -t æ ¹æ®ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´   -c æ ¹æ®ä¸Šæ¬¡çŠ¶æ€å˜æ›´æ—¶é—´   -U å–æ¶ˆæ’åº   -r é€†åº   --dirsfirst ç›®å½•æ˜¾ç¤ºåœ¨æ–‡ä»¶ä¹‹å‰   --sort X name, version, size, mtime, ctime     å›¾å½¢åŒ–é€‰é¡¹    -i ä¸ç¼©è¿›   -A ANSI lines   -S ç¤ºä¾‹ï¼š ï¿½ï¿½ï¿½ package.json   -n å…³é—­è‰²å½©   -C é¢œè‰²æ˜¾ç¤º     XML/HTML/JSON é€‰é¡¹    -X XML æ ¼å¼è¾“å‡º   -J JSON æ ¼å¼è¾“å‡º   -H baseHREF HTML æ ¼å¼è¾“å‡º   -T string -   --nolinks -     è¾“å…¥é€‰é¡¹    --fromfile ä»æ–‡ä»¶è¯»å–     -I,-P ä½¿ç”¨çš„æ—¶å€™å¤šä¸ªè§„åˆ™ï¼š -I \u0026#39;dist|__tests__\u0026#39; ä¼šåŒæ—¶å¿½ç•¥ dist å’Œ tests ç›®å½•æˆ–æ–‡ä»¶ã€‚\n    crontab å®šæ—¶ä»»åŠ¡   OS X æ·»åŠ å®šæ—¶ä»»åŠ¡ | Coding Pub\n  ","permalink":"https://www.cheng92.com/post/linux-doc/","tags":["linux"],"title":"Linux çŸ¥è¯†å¤§å…¨"},{"categories":["shell"],"contents":"  Bash Reference Manual\n Bash - Replace pattern in string | bash Tutorial\n Linux Basis\u0026#xa0;\u0026#xa0;\u0026#xa0;ATTACH   ","permalink":"https://www.cheng92.com/post/shell/","tags":["shell"],"title":"Shell ç¼–ç¨‹"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n å£°æ˜ ï¼švue-next compiler-dom æ¨¡å— è°ƒè¯• ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å¯é€šè¿‡ \u0026lt;F12\u0026gt; æ§åˆ¶å°æŸ¥çœ‹\n æ›´æ–°æ—¥å¿—\u0026amp;Todos ï¼š\n  [2020-12-16 19:40:21] åˆ›å»º\n  [2020-12-19 13:01:02] å®Œæˆ\n  TODO å®Œå–„æµ‹è¯•ç”¨ä¾‹\n      i = 0, j = 0 const { compile: compile2, parse } = VueCompilerDOM const compile = (tpl, title, logAst = false) = { l2(title) const { code, ast } = compile2(tpl, { onError: (e) = console.warn(e.message), hoistStatic: true, ...( compile.options || {} ) }) log.gray(tpl) log([code]) logAst \u0026\u0026 log(typeof logAst === 'function' ? logAst(ast) : ast) return ast } const c = (tpl, desc, fn) = compile(tpl, desc, fn || (ast = ast.codegenNode))  0062974 compiler-domæ¨¡å—åˆå§‹åŒ–   feat(init): compiler-dom Â· gcclll/stb-vue-next@0062974\n æ—¥å¸¸æ“ä½œå…ˆ copyï¼šå…ˆå°† vue-next/packages/compiler-dom/ ä¸‹é¢çš„å†…å®¹æ‹·è´è¿‡æ¥ï¼Œåˆ é™¤ src ç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ ç ã€‚\n äº†è§£ç›®å½•ç»“æ„ï¼š\nâ•°â”€$ tree -C -I \u0026#39;dist|__tests__\u0026#39; . â”œâ”€â”€ LICENSE â”œâ”€â”€ README.md â”œâ”€â”€ api-extractor.json â”œâ”€â”€ index.js â”œâ”€â”€ package.json â””â”€â”€ src â”œâ”€â”€ decodeHtml.ts â”œâ”€â”€ decodeHtmlBrowser.ts â”œâ”€â”€ errors.ts â”œâ”€â”€ index.ts â”œâ”€â”€ namedChars.json â”œâ”€â”€ parserOptions.ts â”œâ”€â”€ runtimeHelpers.ts â””â”€â”€ transforms â”œâ”€â”€ ignoreSideEffectTags.ts â”œâ”€â”€ stringifyStatic.ts â”œâ”€â”€ transformStyle.ts â”œâ”€â”€ vHtml.ts â”œâ”€â”€ vModel.ts â”œâ”€â”€ vOn.ts â”œâ”€â”€ vShow.ts â”œâ”€â”€ vText.ts â””â”€â”€ warnTransitionChildren.ts 2 directories, 21 files   åŠŸèƒ½é¢„è§ˆï¼š\n  ignoreSideEffectTags.ts å¿½ç•¥æ¨¡æ¿ä¸­çš„ style, script æ ‡ç­¾\n  stringifyStatic.ts å¯¹é™æ€æå‡åšçš„ä¸€äº›å¤„ç†\n  transformStyle.ts å°†é™æ€ style å±æ€§è½¬æˆæŒ‡ä»¤ç±»å‹å±æ€§ï¼Œä¸”å°†å†…å®¹è½¬æˆå¯¹è±¡\n å¦‚ï¼š \u0026lt;div style=\u0026#34;color:red\u0026#34; /\u0026gt; ä¼šè½¬æˆï¼š\n1 2 3  _createBlock(\u0026#39;div\u0026#39;, { style: { color: \u0026#34;red\u0026#34; } }, null, 1 /* TEXT */)      vHtml.ts å°† v-html è¡¨è¾¾å¼è½¬æˆ innerHTML å†…å®¹\n  vModel.ts å¤„ç† \u0026lt;input\u0026gt; ç±»å‹ï¼Œåˆ é™¤ modelValue: value å±æ€§ï¼Œä¸å…è®¸æœ‰å‚æ•°\n  vOn.ts äº‹ä»¶ä¿®é¥°ç¬¦å¤„ç†, è¯¦æƒ…è¯·æŸ¥ç›¸å…³ç« èŠ‚ \u0026gt;\u0026gt;\u0026gt;  åˆ†ä¸ºä¸‰ç±»ï¼š\n  äº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦ passive, capture, once ä¼šè¢«è§£æåˆ°äº‹ä»¶ååé¢\n å¦‚ï¼š \u0026lt;div @click.capture.once=\u0026#34;i++\u0026#34; /\u0026gt; ç»“æœï¼š\n1 2 3  _createBlock(\u0026#39;div\u0026#39;, { \u0026#39;onClickCaptureOnce\u0026#39;: $event =\u0026gt; (i++) }, null, 40 /* PROPS, HYDRATE_EVENTS */, [\u0026#34;onClickCaptureOnce\u0026#34;])      é”®ç›˜ç±»äº‹ä»¶(onkeydown,onkeyup,onkeypress)ä¿®é¥°ç¬¦ ~~\n  ç³»ç»ŸæŒ‰é”®ç±»å‹ä¿®é¥°ç¬¦(ctrl,alt,shift,meta,exact)ï¼Œæ•è·å†’æ³¡(stop,prevent,self)ï¼Œé¼  æ ‡(middle,left,right)\n    vShow.ts é’ˆå¯¹ v-show æŒ‡ä»¤ï¼Œè¿™ä¸ªå¯èƒ½éœ€è¦åœ¨ runtime æœŸé—´å¤„ç†\n  vText.ts v-text æŒ‡ä»¤çš„å¤„ç†ï¼Œå°†è¡¨è¾¾å¼å†…å®¹è§£ææˆ textContent å±æ€§å†…å®¹\n  warnTransitionChildren.ts æ–‡ä»¶æ˜¯é’ˆå¯¹ \u0026lt;transition\u0026gt; å†…ç½®æ ‡ç­¾çš„æ£€æµ‹ï¼Œå®ƒçš„å­© å­èŠ‚ç‚¹åªèƒ½æœ‰ä¸€ä¸ª\n  decodeHtml[Browser].ts æ˜¯ç”¨æ¥å¤„ç† html ç¬¦å·è¯­ä¹‰åŒ–çš„ï¼Œåˆ†åˆ«æ˜¯ NODE ç¯å¢ƒå’Œæµè§ˆå™¨ç¯ å¢ƒçš„å¤„ç†é€»è¾‘\n  parserOptions.ts é’ˆå¯¹ compiler-core çš„é€‰é¡¹åšäº†è¿›ä¸€æ­¥æ‰©å±•(namespace, native tag, decodeEntities ç­‰)\n    4fa13bf init parse + compile function   feat(init): compiler-dom index.ts\u0026gt; compile + parse function Â· gcclll/stb-vue-next@4fa13bf\n åˆå§‹åŒ–ç¼–è¯‘å’Œè§£æå‡½æ•°ï¼Œå¯¹åº”ç€ compile-core çš„ baseCompile å’Œ baseParse å‡½æ•°ã€‚\n å³ï¼š compiler-dom æ˜¯é’ˆå¯¹ compiler-core çš„è¿›ä¸€æ­¥å°è£…å¤„ç†ï¼Œä¼ é€’ä¸€äº› transformXxx å‡½æ•°ï¼Œè‡³äºè¿™äº›å‡½æ•°åšäº†ä»€ä¹ˆå¤„ç†ï¼Œéœ€è¦ä¸‹é¢ä¸€æ­¥æ­¥æ¥æ­å¼€ã€‚\n compile :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  export function compile( template: string, options: CompilerOptions ): CodegenResult { return baseCompile( template, extend({}, parserOptions, { nodeTransforms: [], directiveTransforms: extend({}), // é™æ€æå‡ transform  transformHoist: __BROWSER__ ? null : stringifyStatic }) ) }     parse:\n1 2 3  export function parse(template: string, options: ParserOptions = {}): RootNode { return baseParse(template, extend({}, parserOptions, options)) }     å…¶å®åˆ°è¿™é‡Œä¹Ÿæ˜¯åº”è¯¥å¯ä»¥æ‰§è¡Œçš„ï¼Œæ¥æµ‹è¯•ä¸‹ï¼š\n1 2 3 4 5 6 7  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code, ast } = compile(`\u0026lt;div\u0026gt;{{ test }}\u0026lt;/div\u0026gt;`) console.log(code, \u0026#39;\\n\u0026gt;\u0026gt;\u0026gt; AST: \\n\u0026#39;, ast)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, _toDisplayString(test), 1 /* TEXT */)) } } \u0026gt;\u0026gt;\u0026gt; AST: { type: 0, children: [ { type: 1, ns: 0, tag: \u0026#39;div\u0026#39;, tagType: 0, props: [], isSelfClosing: false, children: [Array], loc: [Object], codegenNode: [Object] } ], codegenNode: { type: 13, tag: \u0026#39;\u0026#34;div\u0026#34;\u0026#39;, props: undefined, children: { type: 5, content: [Object], loc: [Object] }, patchFlag: \u0026#39;1 /* TEXT */\u0026#39;, dynamicProps: undefined, directives: undefined, isBlock: true, disableTracking: false, loc: { start: [Object], end: [Object], source: \u0026#39;\u0026lt;div\u0026gt;{{ test }}\u0026lt;/div\u0026gt;\u0026#39; } }, }   æ¥ä¸‹æ¥æ‰æ˜¯è¿›å…¥æ­£é¢˜ â›³â€¦ğŸš„ğŸš„ğŸš„\n  8c86624 add transformStyle node transform   feat: add transformStyle transform Â· gcclll/stb-vue-next@8c86624\n ä½œç”¨æ˜¯å°† node.props é‡Œé¢çš„ style å†…è”å±æ€§è½¬æˆå¯¹è±¡ç±»å‹ã€‚\n æ ¹æ®æ¡ä»¶ï¼Œè¿™é‡Œåªæ£€æµ‹é™æ€å±æ€§ï¼Œç„¶åå°†å…¶è½¬æˆ v-bind å‹çš„åŠ¨æ€å±æ€§ï¼Œå°†å†…è”è½¬æˆå¯¹è±¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  export const transformStyle: NodeTransform = node =\u0026gt; { if (node.type === NodeTypes.ELEMENT) { node.props.forEach((p, i) =\u0026gt; { if (p.type === NodeTypes.ATTRIBUTE \u0026amp;\u0026amp; p.name === \u0026#39;style\u0026#39; \u0026amp;\u0026amp; p.value) { // replace p with an expression node  node.props[i] = { type: NodeTypes.DIRECTIVE, name: `bind`, arg: createSimpleExpression(`style`, true, p.loc), exp: parseInlineCSS(p.value.content, p.loc), modifiers: [], loc: p.loc } } }) } }     å†…è”è½¬å¯¹è±¡è§£æå‡½æ•°ï¼š parseInlineCSS\n1 2 3 4 5 6 7 8 9 10 11 12  const parseInlineCSS = ( cssText: string, loc: SourceLocation ): SimpleExpressionNode =\u0026gt; { const normalized = parseStringStyle(cssText) return createSimpleExpression( JSON.stringify(normalized), false, loc, ConstantTypes.CAN_STRINGIFY ) }     parseStringStyle å¤„ç†å…¶å®å°±æ˜¯ä»¥ ; ä¸ºåˆ†éš”ç¬¦ï¼Œå°† name:value åˆ†å‰²å‡ºæ¥ï¼Œè§£æå‡º name å’Œ value ç»„æˆå¯¹è±¡ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code } = compile(`\u0026lt;div style=\u0026#34;color:red;font-size:30px;\u0026#34;\u0026gt;{{ text }}\u0026lt;/div\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { style: {\u0026#34;color\u0026#34;:\u0026#34;red\u0026#34;,\u0026#34;font-size\u0026#34;:\u0026#34;30px\u0026#34;} }, _toDisplayString(text), 1 /* TEXT */)) } } undefined    7ea8dfe add v-html transform   feat: add transform v-html Â· gcclll/stb-vue-next@7ea8dfe\n v-html æŒ‡ä»¤è½¬æ¢ã€‚\n ä»£ç å¾ˆç®€å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  export const transformVHtml: DirectiveTransform = (dir, node, context) =\u0026gt; { const { exp, loc } = dir if (!exp) { context.onError( createDOMCompilerError(DOMErrorCodes.X_V_HTML_NO_EXPRESSION, loc) ) } if (node.children.length) { context.onError( createDOMCompilerError(DOMErrorCodes.X_V_HTML_WITH_CHILDREN, loc) ) node.children.length = 0 } return { props: [ createObjectProperty( createSimpleExpression(`innerHTML`, true, loc), exp || createSimpleExpression(\u0026#39;\u0026#39;, true) ) ] } }     å…¶å®å°±æ˜¯é’ˆå¯¹ v-html å°†å…¶è½¬æˆ innerHTML åŠ¨æ€å±æ€§ï¼Œæ£€æµ‹ä¸¤ä¸ªä¸åˆæ³•ä½¿ç”¨æƒ…å†µ\n  æ²¡æœ‰è¡¨è¾¾å¼\n  åŒ…å«å­©å­èŠ‚ç‚¹\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const _c = tpl =\u0026gt; compile(tpl, { onError: e =\u0026gt; console.log(`é”™è¯¯æè¿°ï¼š` + e.message) }).code console.log(_c(`\u0026lt;div v-html=\u0026#34;test\u0026#34;/\u0026gt;`)) console.log(`\u0026gt;\u0026gt;\u0026gt; v-html ä¸‹ä¸èƒ½æœ‰ä»»ä½•å­©å­èŠ‚ç‚¹`) console.log(_c(`\u0026lt;div v-html=\u0026#34;test\u0026#34;\u0026gt;hello\u0026lt;/div\u0026gt;`)) console.log(`\u0026gt;\u0026gt;\u0026gt; v-html ä¸èƒ½æ²¡æœ‰è¡¨è¾¾å¼`) console.log(_c(`\u0026lt;div v-html\u0026gt;\u0026lt;/div\u0026gt;`))    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { innerHTML: test }, null, 8 /* PROPS */, [\u0026#34;innerHTML\u0026#34;])) } } \u0026gt;\u0026gt;\u0026gt; v-html ä¸‹ä¸èƒ½æœ‰ä»»ä½•å­©å­èŠ‚ç‚¹ é”™è¯¯æè¿°ï¼šv-html will override element children. const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { innerHTML: test }, null, 8 /* PROPS */, [\u0026#34;innerHTML\u0026#34;])) } } \u0026gt;\u0026gt;\u0026gt; v-html ä¸èƒ½æ²¡æœ‰è¡¨è¾¾å¼ é”™è¯¯æè¿°ï¼šv-html is missing expression. const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { innerHTML: \u0026#34;\u0026#34; })) } } undefined    è¿™é‡Œ v-html å±æ€§ä¼šè¢«è§£ææˆ node.props é‡Œé¢åŠ¨æ€å±æ€§ï¼Œå±æ€§åä¸º innerHTML ã€‚\n  å¦‚æœæœ‰ v-html æŒ‡ä»¤æ˜¯è¯¥ç»„ä»¶ä¸‹é¢å°±ä¸èƒ½æœ‰ä»»ä½•å­©å­èŠ‚ç‚¹\n    4f3a4ee add v-text transform   feat(add): v-text transform Â· gcclll/stb-vue-next@4f3a4ee\n v-text æŒ‡ä»¤è½¬æ¢å‡½æ•°ï¼Œè½¬æˆå±æ€§ä¸º textContent ã€‚\n ä»£ç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  export const transformVText: DirectiveTransform = (dir, node, context) =\u0026gt; { const { exp, loc } = dir if (!exp) { context.onError( createDOMCompilerError(DOMErrorCodes.X_V_TEXT_NO_EXPRESSION, loc) ) } if (node.children.length) { context.onError( createDOMCompilerError(DOMErrorCodes.X_V_TEXT_WITH_CHILDREN, loc) ) node.children.length = 0 } return { props: [ createObjectProperty( createSimpleExpression(`textContent`, true), exp ? createCallExpression( context.helperString(TO_DISPLAY_STRING), [exp], loc ) : createSimpleExpression(\u0026#39;\u0026#39;, true) ) ] } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const c = tpl =\u0026gt; compile(tpl, { onError: e =\u0026gt; console.log(`é”™è¯¯æè¿°: ${e.message}`) }).code console.log(c(`\u0026lt;div v-text=\u0026#34;test\u0026#34;/\u0026gt;`)) console.log(`\u0026gt;\u0026gt;\u0026gt; åŒ…å«å­©å­èŠ‚ç‚¹`) console.log(c(`\u0026lt;div v-text=\u0026#34;test\u0026#34;\u0026gt;hello\u0026lt;/div\u0026gt;`)) console.log(`\u0026gt;\u0026gt;\u0026gt; æ— è¡¨è¾¾å¼`) console.log(c(`\u0026lt;div v-text\u0026gt;\u0026lt;/div\u0026gt;`))    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { textContent: _toDisplayString(test) }, null, 8 /* PROPS */, [\u0026#34;textContent\u0026#34;])) } } \u0026gt;\u0026gt;\u0026gt; åŒ…å«å­©å­èŠ‚ç‚¹ é”™è¯¯æè¿°: v-text will override element children. const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { textContent: _toDisplayString(test) }, null, 8 /* PROPS */, [\u0026#34;textContent\u0026#34;])) } } \u0026gt;\u0026gt;\u0026gt; æ— è¡¨è¾¾å¼ é”™è¯¯æè¿°: v-text is missing expression. const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { textContent: \u0026#34;\u0026#34; })) } } undefined    588d5f1 add v-model transform   v-model æŒ‡ä»¤è½¬æ¢ã€‚\n åœ¨å®Œæˆ v-model æŒ‡ä»¤è½¬æ¢ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹ compiler-core é‡Œé¢çš„ v-model å¤„ç†çš„æœ€åç»“ æœæ˜¯ä»€ä¹ˆâ“\n1 2 3 4 5 6 7 8  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code } = compile(`\u0026lt;input v-model:value=\u0026#34;result\u0026#34; /\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { value: result, \u0026#34;onUpdate:value\u0026#34;: $event =\u0026gt; (result = $event) }, null, 40 /* PROPS, HYDRATE_EVENTS */, [\u0026#34;value\u0026#34;,\u0026#34;onUpdate:value\u0026#34;])) } } undefined   ç»“æœæ˜¾ç¤ºï¼šv-model æœ€ç»ˆè½¬æˆäº†ä¸¤ä¸ªå±æ€§\n { value: result, \u0026#34;onUpdate:value\u0026#34;: $event =\u0026gt; (result = $event)}\n è¿™ä¸ªåŸç†åº”è¯¥æ˜¯è¿™æ ·ï¼š è¾“å…¥æ¡†å†…å®¹ç»‘å®š result ï¼Œå½“è¾“å…¥æ¡†å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘ onUpdate:value äº‹ä»¶ï¼Œæ‰§è¡Œè¯¥å‡½æ•°é‡æ–°å¤åˆ¶ result å˜æ›´æ•°æ®ã€‚  åŠ ä¸Š compiler-dom é˜¶æ®µçš„ v-model transform ä¹‹åï¼š feat(add): v-model transform Â· gcclll/stb-vue-next@588d5f1\n1 2 3 4 5 6 7 8  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code } = compile(`\u0026lt;input v-model=\u0026#34;result\u0026#34; /\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { vModelText : _vModelText, createVNode : _createVNode, withDirectives : _withDirectives, openBlock : _openBlock, createBlock : _createBlock } = _Vue return _withDirectives((_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { \u0026#34;onUpdate:modelValue\u0026#34;: $event =\u0026gt; (result = $event) }, null, 8 /* PROPS */, [\u0026#34;onUpdate:modelValue\u0026#34;])), [ [_vModelText, result] ]) } } undefined   å˜åŒ–ï¼š\n  ä¸æ”¯æŒå‚æ•°äº†\n  åˆ é™¤äº† value: result å±æ€§(é»˜è®¤æ˜¯ modelValue)ã€‚\n  ç”¨ _withDirectives å°† \u0026lt;input\u0026gt; åŒ…èµ·æ¥äº†\n è¿™ä¸ªå‡½æ•°å®šä¹‰æ˜¯åœ¨ runtime-core é‡Œé¢å®šä¹‰äº†ï¼Œä½œç”¨å°±æ˜¯å°† ç¬¬äºŒä¸ªå‚æ•° [ [_vModelText, result] ] é‡Œé¢çš„æŒ‡ä»¤å¡åˆ° vnode.dirs æŒ‡ä»¤é›†ä¸­å»ã€‚\n   ä»£ç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89  export const transformModel: DirectiveTransform = (dir, node, context) =\u0026gt; { const baseResult = baseTransform(dir, node, context) // base transform has errors OR component v-model (only need props)  // æ²¡æœ‰ v-modelæŒ‡ä»¤ï¼Œæˆ–åº”ç”¨åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šäº†  if (!baseResult.props.length || node.tagType === ElementTypes.COMPONENT) { return baseResult } // ä¸èƒ½æœ‰å‚æ•°ï¼Ÿ  if (dir.arg) { // ... æŠ¥é”™ï¼Œä¸èƒ½æœ‰å‚æ•°ï¼Œå³å¿…é¡»æ˜¯ ~v-model=\u0026#34;xxx\u0026#34;~ æ¥ä½¿ç”¨  } // ä¸èƒ½æœ‰ value å±æ€§ï¼Œå› ä¸º input ç»‘å®šçš„å°±æ˜¯ value å±æ€§  function checkDuplicateValue() { // ... è¿™é‡Œæ—¢æ˜¯æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ \u0026lt;input value=\u0026#34;xx\u0026#34;\u0026gt; value å±æ€§  } const { tag } = node const isCustomElement = context.isCustomElement(tag) if ( tag === \u0026#39;input\u0026#39; || tag === \u0026#39;textarea\u0026#39; || tag === \u0026#39;select\u0026#39; || isCustomElement ) { let directiveToUse = V_MODEL_TEXT let isInvalidType = false if (tag === \u0026#39;input\u0026#39; || isCustomElement) { const type = findProp(node, `type`) if (type) { if (type.type === NodeTypes.DIRECTIVE) { // :type=\u0026#39;foo\u0026#39;  directiveToUse = V_MODEL_DYNAMIC } else if (type.value) { switch (type.value.content) { case \u0026#39;radio\u0026#39;: directiveToUse = V_MODEL_RADIO break case \u0026#39;checkbox\u0026#39;: directiveToUse = V_MODEL_CHECKBOX break case \u0026#39;file\u0026#39;: isInvalidType = true // ERROR ä¸èƒ½ç”¨åœ¨ \u0026lt;file\u0026gt; æ ‡ç­¾ä¸Š  break default: __DEV__ \u0026amp;\u0026amp; checkDuplicateValue() break } } } else if (hasDynamicKeyVBind(node)) { // element has bindings with dynamic keys, which can possibly contain  // \u0026#34;type\u0026#34;.  directiveToUse = V_MODEL_DYNAMIC } else { // text type  __DEV__ \u0026amp;\u0026amp; checkDuplicateValue() } } else if (tag === \u0026#39;select\u0026#39;) { directiveToUse = V_MODEL_SELECT } else { // textarea  __DEV__ \u0026amp;\u0026amp; checkDuplicateValue() } // inject runtime directive  // by returning the helper symbol via needRuntime  // the import will replaced a resolveDirective call.  if (!isInvalidType) { baseResult.needRuntime = context.helper(directiveToUse) } } else { // v-model åº”ç”¨åˆ°ä¸åˆæ³•çš„å…ƒç´ ä¸Š  } // native vmodel doesn\u0026#39;t need the `modelValue` props since they are also  // passed to the runtime as `binding.value`. removing it reduces code size.  // æœ€åè¿‡æ»¤æ‰ modelValue: xxx å±æ€§  baseResult.props = baseResult.props.filter( p =\u0026gt; !( p.key.type === NodeTypes.SIMPLE_EXPRESSION \u0026amp;\u0026amp; p.key.content === \u0026#39;modelValue\u0026#39; ) ) return baseResult }     æºç åˆ†æï¼š\n  åªå¤„ç† input, textarea, select æ–‡æœ¬æ¡†æ ‡ç­¾ï¼Œæˆ–è‡ªå®šä¹‰çš„æ ‡ç­¾\n  \u0026lt;input\u0026gt; æ ‡ç­¾ç±»å‹åˆ†ä¸º radio å’Œ checkbox å•å¤é€‰é¡¹æ¡†å¤„ç†ï¼Œä¸èƒ½ä½¿ç”¨ type=\u0026#39;file\u0026#39; ç±»å‹\n  \u0026lt;select\u0026gt; ä¸‹æ‹‰é€‰é¡¹æ¡†çš„å¤„ç†\n  è¿‡æ»¤æ‰ transform ä¹‹åçš„ {modelValue: value, \u0026#39;onUpdate:value\u0026#39;: $event =\u0026gt; value = $event} é‡Œé¢çš„ modelValueï¼švalue å±æ€§ï¼Œå› ä¸ºåœ¨ runtime-core æ—¶æœŸçš„ withDirectives() å¤„ç†é‡Œé¢ä¼šè¢«ç»‘å®šåˆ° value å±æ€§ä¸Š\n    a94aacd add v-on transform   feat(add): v-on transform Â· gcclll/stb-vue-next@a94aacd\n compiler-core é˜¶æ®µï¼š\n1 2 3 4 5 6 7 8 9  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code, ast } = compile(`\u0026lt;div v-on:keyup.enter.prevent=\u0026#34;pressKeyup\u0026#34; /\u0026gt;`) console.log(code) console.log(ast.codegenNode.props.properties)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { onKeyup: pressKeyup }, null, 40 /* PROPS, HYDRATE_EVENTS */, [\u0026#34;onKeyup\u0026#34;])) } } [ { type: 16, loc: { source: \u0026#39;\u0026#39;, start: [Object], end: [Object] }, key: { type: 4, loc: [Object], content: \u0026#39;onKeyup\u0026#39;, isStatic: true, constType: 3 }, value: { type: 4, content: \u0026#39;pressKeyup\u0026#39;, isStatic: false, constType: 0, loc: [Object] } } ] undefined   å¯ä»¥çœ‹åˆ° compile-core é˜¶æ®µæ˜¯æ²¡æœ‰å¤„ç†ä¿®é¥°ç¬¦çš„ã€‚\n v-on æŒ‡ä»¤æœ€åè§£ææˆ { key, value, type: 16 } ç»“æ„ã€‚\n compiler-dom v-on å¤„ç†é€»è¾‘ï¼š\n  resolveModifiers(key, modifiers) è§£æå‡ºä¸‰ç±»ä¿®é¥°ç¬¦\n  keyModifiers ä¿®é¥°ç¬¦\n é”®ç›˜äº‹ä»¶ï¼š onkeyup, onkeydown, onkeypress\n  eventOptionModifiers äº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦ï¼Œåªæœ‰ä¸‰ç§ passive, once, capture\n  nonKeyModifiers éæŒ‰é”®ç±»ä¿®é¥°ç¬¦\n äº‹ä»¶å†’æ³¡ç®¡ç†ï¼š stop,prevent,self\n ç³»ç»Ÿä¿®é¥°ç¬¦+exact: ctrl,shift,alt,meta,exact , exact è¡¨ç¤ºç²¾ç¡®åŒ¹é…æŒ‰é”®ã€‚\n é¼ æ ‡æŒ‰é”®ä¿®é¥°ç¬¦ï¼š middle\n    ç»è¿‡ 1 ä¹‹åå¾—å‡ºä¸‰ç§ç±»å‹çš„ä¿®é¥°ç¬¦ï¼Œå¤„ç†å…¶ä¸­çš„ nonKeyModifiers\n å°†è¿™ç§ç±»å‹çš„ä¿®é¥°ç¬¦ä¸­çš„ right, middle è½¬æ¢æˆå¯¹åº”çš„ onContextmenu å’Œ onMouseup äº‹ä»¶\n å³ï¼š\n å¦‚æœæœ‰ right ç‚¹å‡»äº‹ä»¶ä¼šè§¦å‘ onContextmenu äº‹ä»¶ï¼Œå¼¹å‡ºå³é”®èœå•ï¼Ÿ\n å¦‚æœæœ‰ middle é¼ æ ‡ä¸­é—´æ»šè½®äº‹ä»¶ï¼Œä¼šè§¦å‘ onMouseup é¼ æ ‡å¼¹èµ·äº‹ä»¶\n æœ€åå°† nonKeyModifiers ç»“åˆ value åˆ›å»ºæˆå‡½æ•°è¡¨è¾¾å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const {code} = compile( `\u0026lt;div @click.right=\u0026#34;testRight\u0026#34; @click.middle=\u0026#34;testMiddle\u0026#34; @click.left=\u0026#34;testLeft\u0026#34; /\u0026gt;`) console.log(`\u0026gt;\u0026gt;\u0026gt; right ä¿®é¥°ç¬¦è¢«å½“åš onContextmenu äº‹ä»¶å¤„ç†, middle -\u0026gt; onMouseup`) console.log(code)    \u0026gt;\u0026gt;\u0026gt; right ä¿®é¥°ç¬¦è¢«å½“åš onContextmenu äº‹ä»¶å¤„ç†, middle -\u0026gt; onMouseup const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { withModifiers : _withModifiers, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { onContextmenu: _withModifiers(testRight, [\u0026#34;right\u0026#34;]), onMouseup: _withModifiers(testMiddle, [\u0026#34;middle\u0026#34;]), onClick: _withModifiers(testLeft, [\u0026#34;left\u0026#34;]) }, null, 40 /* PROPS, HYDRATE_EVENTS */, [\u0026#34;onContextmenu\u0026#34;,\u0026#34;onMouseup\u0026#34;,\u0026#34;onClick\u0026#34;])) } } undefined    å¤„ç† keyModifiers ï¼Œå¦‚ï¼šé”®ç›˜äº‹ä»¶ä¿®é¥°ç¬¦ï¼Œç³»ç»Ÿä¿®é¥°ç¬¦ç­‰ç­‰\n æ¯”å¦‚ï¼šé”®ç›˜ ctrl-a ç»„åˆé”®\n1 2 3 4 5 6 7 8 9  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code } = compile(` \u0026lt;div @keydown.stop.capture.ctrl.a=\u0026#34;test\u0026#34; /\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { withModifiers : _withModifiers, withKeys : _withKeys, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { onKeydownCapture: _withKeys(_withModifiers(test, [\u0026#34;stop\u0026#34;,\u0026#34;ctrl\u0026#34;]), [\u0026#34;a\u0026#34;]) }, null, 40 /* PROPS, HYDRATE_EVENTS */, [\u0026#34;onKeydownCapture\u0026#34;])) } } undefined    å¤„ç† eventOptionModifiers ç»“åˆ key ç”Ÿæˆå¯¹åº”çš„äº‹ä»¶åè¡¨è¾¾å¼\n äº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦åªæœ‰ä¸‰ä¸ªï¼š capture,passive,once\n passive: passiveçš„ä½œç”¨å’ŒåŸç†_ä¸ªäººæ–‡ç«  - SegmentFault æ€å¦\n capture: DOM çš„äº‹ä»¶å‚³éæ©Ÿåˆ¶ï¼šæ•ç²èˆ‡å†’æ³¡\n è§£æç»“æœï¼Œäº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦è¢«åˆå¹¶åˆ°äº‹ä»¶åä¸­ï¼š\n1 2 3 4 5 6 7  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code } = compile(`\u0026lt;div @click.stop.capture.once=\u0026#34;test\u0026#34; /\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { withModifiers : _withModifiers, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { onClickCaptureOnce: _withModifiers(test, [\u0026#34;stop\u0026#34;]) }, null, 40 /* PROPS, HYDRATE_EVENTS */, [\u0026#34;onClickCaptureOnce\u0026#34;])) } } undefined   å¦‚ï¼šäº‹ä»¶å onClickCaptureOnce\n  å¦‚æœäº‹ä»¶åä¸ºåŠ¨æ€æˆ–æ˜¯é”®ç›˜äº‹ä»¶ï¼Œå¾—ç”¨ _withKeys() åŒ…ä¸€å±‚\n    æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const log = console.log const c = (tpl, title) =\u0026gt; { const { code, ast } = compile(tpl, { onError: e =\u0026gt; log(`é”™è¯¯æè¿°ï¼š${e.message}`) }) log(`\u0026gt;\u0026gt;\u0026gt; ${title}`) log(code) log(ast.codegenNode.props.properties) } c(`\u0026lt;div @click.stop.prevent=\u0026#34;test\u0026#34; /\u0026gt;`, \u0026#39;å¤šä¸ªä¿®é¥°ç¬¦\u0026#39;)    \u0026gt;\u0026gt;\u0026gt; å¤šä¸ªä¿®é¥°ç¬¦ const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { withModifiers : _withModifiers, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { onClick: _withModifiers(test, [\u0026#34;stop\u0026#34;,\u0026#34;prevent\u0026#34;]) }, null, 8 /* PROPS */, [\u0026#34;onClick\u0026#34;])) } } [ { type: 16, loc: { source: \u0026#39;\u0026#39;, start: [Object], end: [Object] }, key: { type: 4, loc: [Object], content: \u0026#39;onClick\u0026#39;, isStatic: true, constType: 3 }, value: { type: 14, loc: [Object], callee: Symbol(vOnModifiersGuard), arguments: [Array] } } ] undefined   \u0026lt;f12\u0026gt; æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ›´å¤šæµ‹è¯•ç”¨ä¾‹ç»“æœã€‚\n  l1(`v-on`) c(``, 'æ”¯æŒå¤šä¸ªä¿®é¥°ç¬¦') c(``, 'å¤šä¸ªäº‹ä»¶') c(``, 'å¤šä¸ªä¿®é¥°ç¬¦å’Œäº‹ä»¶é€‰é¡¹') c(``, 'é”®ç›˜äº‹ä»¶æˆ–åŠ¨æ€äº‹ä»¶ï¼Œåº”è¯¥ç”¨ keys guard åŒ…ä¸€å±‚(runtime-dom: withKeys())') c(``, `æ²¡æœ‰æŒ‰é”®ä¿®é¥°ç¬¦çš„æ—¶å€™ï¼Œä¸éœ€è¦ keys guard`) c(``, 'é™æ€äº‹ä»¶å+left/right ä¿®é¥°ç¬¦ï¼Œéœ€è¦ keys guard') c(``, 'åŠ¨æ€äº‹ä»¶å+left/right ä¿®é¥°ç¬¦ï¼Œéœ€è¦ keys guard') c(``, 'should not wrap normal guard if there is only keys guard') // è½¬æˆ onContextmenu äº‹ä»¶ c(``, 'should transform click.right') // å¦‚æœæ˜¯ click.right è½¬æˆ onContextmenu c(``, 'åŠ¨æ€äº‹ä»¶å + right ä¿®é¥°ç¬¦') // è½¬æˆ onMouseup c(``, 'é¼ æ ‡ä¸­é”®æŒ‰é”®äº‹ä»¶') c(``, 'é¼ æ ‡ä¸­é”®åŠ¨æ€æŒ‰é”®äº‹ä»¶') compile.options = { cacheHandlers: true } const root = c(``, 'ç¼“å­˜ handler ä¿®é¥°ç¬¦') log(root)   å°ç»“ :\n äº‹ä»¶ä¿®é¥°ç¬¦åˆ†ä¸ºä¸‰å¤§ç±»\n  äº‹ä»¶é€‰é¡¹ç±»å‹ä¿®é¥°ç¬¦(passive,capture,once)\n ä¼šå’Œäº‹ä»¶ååˆå¹¶ï¼š click.capture.once -\u0026gt; onClickCaptureOnce\n  é”®ç›˜äº‹ä»¶(åŒ…æ‹¬é”®ç›˜æŒ‰é”® a-b-c-â€¦)\n  å…¶ä»–ç±»å‹äº‹ä»¶ä¿®é¥°ç¬¦(å¦‚ï¼šstop,prevent,self, ctrl,shift,alt,meta,exact)\n   å…³äº right, middle ä¿®é¥°ç¬¦å¤„ç†æƒ…å†µ\n  right å¤„ç†æˆ onContextmenu äº‹ä»¶\n  middle å¤„ç†æˆ onMouseup äº‹ä»¶   right/middle æ˜¯åœ¨åŠ¨æ€äº‹ä»¶åä¸Šé¢ï¼Œä¼šæ£€æµ‹æ˜¯ä¸æ˜¯ onClick å¦‚æœæ˜¯è¿›è¡Œ 1/2 è½¬æ¢ï¼Œä¸ æ˜¯æŒ‰ç…§åŸäº‹ä»¶åå¤„ç†ã€‚\n å¦‚ï¼š @[eventName].middle=\u0026#34;test\u0026#34; -\u0026gt; eventName === \u0026#39;onClick\u0026#39; ? \u0026#39;onMouseup\u0026#39; : eventName\n     e64a1b3 add v-show transform   feat(add): v-show transform Â· gcclll/stb-vue-next@e64a1b3\n1 2 3 4 5 6 7 8 9 10 11 12 13  export const transformShow: DirectiveTransform = (dir, node, context) =\u0026gt; { const { exp, loc } = dir if (!exp) { context.onError( createDOMCompilerError(DOMErrorCodes.X_V_SHOW_NO_EXPRESSION, loc) ) } return { props: [], needRuntime: context.helper(V_SHOW) } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const { code, ast } = compile(`\u0026lt;div v-show=\u0026#34;test\u0026#34;/\u0026gt;`) console.log(code) console.log(`props: `, ast.codegenNode.props)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { vShow : _vShow, createVNode : _createVNode, withDirectives : _withDirectives, openBlock : _openBlock, createBlock : _createBlock } = _Vue return _withDirectives((_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, null, 512 /* NEED_PATCH */)), [ [_vShow, test] ]) } } props: undefined   è¿™é‡Œè²Œä¼¼ä»€ä¹ˆéƒ½æ²¡å¹²ï¼Œé™¤äº†è¿”å›ä¸€ä¸ª needRuntime: context.helper(V_SHOW) ï¼Œéš¾é“ v-show å¿…é¡»åœ¨ runtime æ—¶æœŸå¤„ç†ï¼Ÿï¼Ÿï¼Ÿ\n  436db72 add transition component warn transform   feat(add): transition component transform Â· gcclll/stb-vue-next@436db72\n è¿™é‡Œåªæ˜¯åŠ äº†ä¸ªé”™è¯¯ç”¨æ³•å¤„ç†ï¼Œå¯¹äº \u0026lt;transition\u0026gt; ç»„ä»¶ä¸‹é¢åªèƒ½æœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ã€‚\n  TODO af56754 add stringifyStatic node ç¯å¢ƒé™æ€æå‡   feat(add): node stringify static -\u0026gt; hoist Â· gcclll/stb-vue-next@af56754\n  f0cbb25 add ignoreSideEffectTags transform   feat(add): ignore side effect tags \u0026gt; script/style Â· gcclll/stb-vue-next@f0cbb25\n è¿™ä¸ª transform ä½œç”¨æ˜¯æ£€æµ‹æ¨¡æ¿ä¸­æ˜¯ä¸æ˜¯å­˜åœ¨ \u0026lt;script\u0026gt;, \u0026lt;style\u0026gt; æ ‡ç­¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const { parse, compile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) const c = (tpl, title) =\u0026gt; { console.log(`\u0026gt;\u0026gt;\u0026gt; ${title}`) const { code } = compile(tpl, { onError: e =\u0026gt; console.log(`\u0026gt; é”™è¯¯æè¿°ï¼š${e.message}`) }) console.log(code) } c(`\u0026lt;script\u0026gt;console.log(1)\u0026lt;/script\u0026gt;`, \u0026#39;å¿½ç•¥ \u0026lt;script\u0026gt; æ ‡ç­¾\u0026#39;) c(`\u0026lt;style\u0026gt;h1 { color: red }\u0026lt;/style\u0026gt;`, \u0026#39;å¿½ç•¥ \u0026lt;style\u0026gt; æ ‡ç­¾\u0026#39;)    \u0026gt;\u0026gt;\u0026gt; å¿½ç•¥ \u0026lt;script\u0026gt; æ ‡ç­¾ \u0026gt; é”™è¯¯æè¿°ï¼šTags with side effect (\u0026lt;script\u0026gt; and \u0026lt;style\u0026gt;) are ignored in client component templates. return function render(_ctx, _cache) { with (_ctx) { return null } } \u0026gt;\u0026gt;\u0026gt; å¿½ç•¥ \u0026lt;style\u0026gt; æ ‡ç­¾ \u0026gt; é”™è¯¯æè¿°ï¼šTags with side effect (\u0026lt;script\u0026gt; and \u0026lt;style\u0026gt;) are ignored in client component templates. return function render(_ctx, _cache) { with (_ctx) { return null } } undefined    fd0f5ae add dom parserOptions and decode html   å¯¹ compiler-core çš„ ParserOptions çš„ä¸€ç§æ‰©å±•:\n  isNativeTag: tag =\u0026gt; isHTMLTag(tag) || isSVGTag(tag)\n vue-next/packages/shared/src/domTagConfig.ts\n ä¸­åˆ¶å®šäº†ä¸€äº›åŸç”Ÿçš„æ ‡ç­¾ã€‚\n  isPreTag: pre æ ‡ç­¾\n  decodeEntities html å®ä½“è½¬æ¢\n åˆ†ä¸ºæµè§ˆå™¨ç¯å¢ƒå’ŒNDOEç¯å¢ƒå¤„ç†\n æµè§ˆå™¨ç¯å¢ƒå¤„ç†è¾ƒä¸ºç®€å•(è½¬æ ‡ç­¾å†…å®¹å–å‡ºå­—ç¬¦ä¸²ï¼Œåˆ©ç”¨æµè§ˆå™¨è‡ªèº«èƒ½åŠ›æ¥è½¬æ¢)ï¼š\n1 2 3 4 5  export function decodeHtmlBrowser(raw: string): string { ;(decoder || (decoder = document.createElement(\u0026#39;div\u0026#39;))).innerHTML = raw return decoder.textContent as string }     NODE ç¯å¢ƒç¨å¾®å¤æ‚ï¼Œä¸‹é¢åšäº›ç®€å•æµ‹è¯•å§ï¼š\n https://html.spec.whatwg.org/multipage/named-characters.html\n vue-next/packages/compiler-dom/src/namedChars.json\n ä¸Šé¢é“¾æ¥å’Œè·¯å¾„ä¸­åŒ…å«äº†æ‰€æœ‰å­—ç¬¦çš„ 16è¿›åˆ¶ - ç¬¦å· - åå­—å¯¹åº”è¡¨(json)ï¼Œä¸‹é¢éšä¾¿æ‰¾ å‡ ä¸ªæ¥æµ‹è¯•ä¸‹-\u0026gt; åˆ†æå¦‚æ³¨é‡Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { decodeHtml } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-dom.global.js\u0026#39;) let rawText = \u0026#39;a \u0026amp;#x20ac b \u0026amp;nbsp; e \u0026amp;FilledVerySmallSquare; d \u0026amp;Gg; f\u0026#39; const res = decodeHtml(rawText) // while å¾ªç¯é‡Œé¦–å…ˆæ˜¯åŒ¹é…æ­£åˆ™ï¼š/\u0026amp;(?:#x?)?/ -\u0026gt; \u0026amp;#x...åå…­è¿›åˆ¶æ•° æˆ– `\u0026amp;[name];` // å½¢å¼çš„å­—ç¬¦ï¼Œname å–è‡ª namedChars.json æ–‡ä»¶çš„ key // å¦‚æœéƒ½æ²¡æœ‰åŒ¹é…åˆ°ç›´æ¥é€€å‡ºå¾ªç¯ï¼Œ // å³ decodeHtml ç›®çš„æ˜¯å°†16è¿›åˆ¶å’Œ named è¡¨ç¤ºçš„ç¬¦å·è½¬æ¢è¯­ä¹‰åŒ–çš„ç¬¦å· // å¦‚ï¼š \u0026amp;#x20ac -\u0026gt; \u0026#34;euro;\u0026#34;: \u0026#34;â‚¬\u0026#34; -\u0026gt; â‚¬ ç¬¦å· // æˆ–è€… \u0026amp;nbsp; ç¬¦å· // æˆ–è€…ä½¿ç”¨ namedChars.json ä¸­çš„åå­—æ¥ä½œä¸ºç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚ï¼š \u0026amp;FilledVerySmallSquare; -\u0026gt; â–ª, \u0026amp;Gg; -\u0026gt; â‹™ console.log(res)    a â‚¬ b e â–ª d â‹™ f undefined    isBuiltInComponent, ä¸¤ä¸ªå†…ç½®ç»„ä»¶ï¼š Transition, TransitionGroup\n  getNamespace, æ›´è¯¦ç»†çš„å‘½åç©ºé—´æ£€æµ‹\n  getTextMode, æ–‡æœ¬æ¨¡å¼æ£€æµ‹\n textarea, title æ ‡ç­¾è§†ä¸º TextModes.RCDATA ç±»å‹\n style,iframe,script,noscript æ ‡ç­¾è§†ä¸º TextModes.RAWTEXT ç±»å‹\n å…¶ä»–è§†ä¸º TextModes.DATA ç±»å‹\n    ç”¨ä¾‹æµ‹è¯•(\u0026lt;f12\u0026gt; æŸ¥çœ‹æ§åˆ¶å°)ï¼š     æ€»ç»“   è¿™ä¸€æ¨¡å—çš„å®Œæˆï¼Œé›¶é›¶æ•£æ•£æ—¶é—´å¤§æ¦‚èŠ±äº†ä¸åˆ°ä¸€å‘¨çš„æ—¶é—´ï¼Œä¹Ÿæ˜¯ç”±äºæœ‰ compiler-core åŒ… çš„å®ŒæˆåŠåˆ†æçš„åŸºç¡€ä¸Šï¼Œè¿›å±•æ‰ä¼šè¿™ä¹ˆé¡ºåˆ©ã€‚\n  å¯¹äº compiler-dom è¿™ä¸€æ¨¡å—ä¸»è¦å†…å®¹ï¼Œå¿«é€Ÿé¢„è§ˆå¯ä»¥æŸ¥çœ‹ç¬¬ä¸€ç« èŠ‚çš„åŠŸèƒ½é¢„è§ˆã€‚\n è¿™é‡Œé‡ç‚¹å…³æ³¨çš„åœ°æ–¹ï¼Œæˆ‘è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ä¸ªï¼š\n  v-model å¯¹ \u0026lt;input\u0026gt; ç±»å‹æ£€æµ‹å’Œå¤„ç†\n  v-on äº‹ä»¶ä¿®é¥°ç¬¦çš„å¤„ç†ï¼Œæˆ‘æ„Ÿè§‰æ˜¯è¿™ä¸ªæ¨¡å—çš„ é‡ä¸­ä¹‹é‡\n  å¦å¤–å¯¹äº node ç¯å¢ƒçš„ html ç¬¦å·è¯­ä¹‰åŒ–çš„å¤„ç†ä¹Ÿå€¼å¾—åˆ†æ\n    ","permalink":"https://www.cheng92.com/vue/vue-mind-map-compiler-dom/","tags":["vue,","vue3,","compiler-dom"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 4 â˜compiler-dom"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ \n å£°æ˜ ï¼šè¯¥ç¯‡ä¸º ts æºç (commit)ç‰ˆæœ¬ï¼Œä¹‹å‰åšè¿‡ä¸€éå®Œæ•´çš„ js ç‰ˆæœ¬ï¼Œæ›´è¯¦ç»†ï¼Œä¹Ÿå¯å‚è€ƒ\n Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 3: compile.ts - è‹¥å¶çŸ¥ç§‹\n ç”±äº transform é˜¶æ®µç›´æ¥æµ‹è¯•ä¸å¤ªå¥½ç›´è§‚çš„çœ‹å‡ºç»“æœï¼Œå› æ­¤è¿™é‡Œä¼šç»“åˆ codegen æ¥ä¸€èµ·å® ç°ï¼Œå³è¯¥æ–‡åŒ…å« compiler-core ä¸‰å¤§é˜¶æ®µçš„æœ€åä¸¤ä¸ªé˜¶æ®µ(transform + generate)\n è°ƒè¯• ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å¯é€šè¿‡ \u0026lt;F12\u0026gt; æ§åˆ¶å°æŸ¥çœ‹\n æ›´æ–°æ—¥å¿—\u0026amp;Todos ï¼š\n  DONE [2020-12-12 18:33:33] é˜¶æ®µæ€§å®Œæˆï¼Œæµè§ˆå™¨æ”¯æŒçš„æ‰€æœ‰åŸºæœ¬åŠŸèƒ½(æµè§ˆå™¨ç¯å¢ƒæ‰€ æœ‰ç”¨ä¾‹æµ‹è¯•å‡å·²é€šè¿‡ï¼Œå¯é€šè¿‡æ§åˆ¶å°æŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹åŠå…¶è¿è¡Œè¿‡ç¨‹ç»“æœ)\n  TODO ssr æœåŠ¡ç«¯æ¸²æŸ“\n  TODO \u0026lt;setup\u0026gt; æ ‡ç­¾å¤„ç†\n  TODO éæµè§ˆå™¨ç¯å¢ƒæ”¯æŒ(prefixIdentifiers, cacheHandlers é€‰é¡¹éœ€è¦éæµè§ˆå™¨ç¯å¢ƒ)\n  TODO ref ç±»å‹å¤„ç†\n      i = 0, j = 0 const { baseCompile } = VueCompilerCore const compile = (tpl, title, logAst = false) = { l2(title) // if (!tpl) return null const { code, ast } = baseCompile(tpl, { onError: (e) = console.warn(e.message), hoistStatic: true, ...( compile.options || {} ) }) log.grey(tpl) log([code]) logAst \u0026\u0026 log(typeof logAst === 'function' ? logAst(ast) : ast) return ast } const c = (tpl, desc, fn) = compile(tpl, desc, fn || (ast = ast.codegenNode\u0026\u0026ast.codegenNode.props))  å…³é”®çŸ¥è¯†ç‚¹    ğŸ”— root.children.length = 1 ä¸”ç±»å‹æ˜¯ ELEMENTçš„æ—¶å€™å°† CREATE_VNODE æ”¹æˆ CREATE_BLOCK   ğŸ”— åŠ¨æ€å±æ€§ä¸ºè¡¨è¾¾å¼æ—¶ï¼Œä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼\n å¦‚ï¼š \u0026lt;div :[first + second]=\u0026#34;third\u0026#34; ... æ˜¯éæ³•çš„ã€‚\n å› ä¸º parseAttribute() ä¸­çš„æ­£åˆ™æ˜¯ä¸æ”¯æŒä¸­é—´æœ‰ç©ºæ ¼çš„ï¼š\n å–å‚æ•°åçš„æ­£åˆ™ï¼š /^[^\\t\\r\\n\\f /\u0026gt;][^\\t\\r\\n\\f /\u0026gt;=]*/\n  ğŸ”— v-bind æŒ‡ä»¤çš„å‡ ç§ç”¨æ³• -\u0026gt;\n  ğŸ”— ç”¨æˆ·ç»„ä»¶ -\u0026gt; æ’æ§½å¤„ç† -\u0026gt; v-slot ä½¿ç”¨æ–¹æ³•\n    è„‘å›¾   e03a03c init transform module   feat(init): transform section Â· gcclll/stb-vue-next@e03a03c\n åˆå§‹åŒ–å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78  export function createTransformContext( root: RootNode, { prefixIdentifiers = false, hoistStatic = false, cacheHandlers = false, nodeTransforms = [], directiveTransforms = {}, transformHoist = null, isBuiltInComponent = NOOP, isCustomElement = NOOP, expressionPlugins = [], scopeId = null, ssr = false, ssrCssVars = ``, bindingMetadata = {}, onError = defaultOnError }: TransformOptions ): TransformContext { const context: TransformContext = { // ...  // methods  helper(name) { context.helpers.add(name) return name }, helperString(name) { return `` }, replaceNode(node) {}, removeNode(node) {}, onNodeRemoved: () =\u0026gt; {}, addIdentifiers(exp) { // TODO  }, removeIdentifiers(exp) { // TODO  }, hoist(exp) { // TODO  return {} as any }, cache(exp, isVNode = false) { // TODO  return {} as any } } return context } export function transform(root: RootNode, options: TransformOptions) { // TODO } // TODO // createRootCodegen  export function traverseChildren( parent: ParentNode, context: TransformContext ) { // TODO } export function traverseNode( node: RootNode | TemplateChildNode, context: TransformContext ) {} export function createStructuralDirectiveTransform( name: string | RegExp, fn: StructuralDirectiveTransform ): NodeTransform { return {} as any }      fc6f1f1 add transform function   feat: transform function Â· gcclll/stb-vue-next@fc6f1f1\n  create transform context\n  traverse nodes, é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ„é€ å™¨ codegenNode\n  hoist static, é™æ€èŠ‚ç‚¹æå‡ï¼Œå¤ç”¨\n  ssr render, ä¸éœ€è¦åˆ›å»ºæ ¹èŠ‚ç‚¹ codegenNode\n  å¤åˆ¶ context å±æ€§åˆ° -\u0026gt; root\n    transform ä½œç”¨å°±æ˜¯é€šè¿‡ traverseNode() é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè§£æï¼Œæ„é€ å¯¹åº”çš„èŠ‚ç‚¹ codegenNode ã€‚\n  b0d72da add compile.ts\u0026gt;compile()   feat(add): compile function Â· gcclll/stb-vue-next@b0d72da\n å¯¹å¤–çš„ compile å‡½æ•°ï¼Œæ‰§è¡Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š\n  ast(baseParse()) -\u0026gt; è§£æå‡º ast ç»“æ„\n  transform(transform()) -\u0026gt; è§£æ ast å¾—åˆ° codegenNode\n  codegen(generate()) -\u0026gt; å°† codegenNode è§£ææˆ Render å‡½æ•°\n   è¿™æ˜¯åé¢æµ‹è¯•çš„åŸºç¡€ï¼Œæ‰€ä»¥å¾—æå‰å®ç°äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  export function baseCompile( template: string | RootNode, options: CompilerOptions = {} ): CodegenResult { // const onError = options.onError || defaultOnError  const isModuleMode = options.mode === \u0026#39;module\u0026#39; const prefixIdentifiers = !__BROWSER__ \u0026amp;\u0026amp; (options.prefixIdentifiers === true || isModuleMode) // TODO errors  const ast = isString(template) ? baseParse(template, options) : template const [nodeTransforms, directiveTransforms] = getBaseTransformPreset( prefixIdentifiers ) transform( ast, extend({}, options, { prefixIdentifiers, nodeTransforms: [ ...nodeTransforms, ...(options.nodeTransforms || []) // user transforms  ], directiveTransforms: extend( {}, directiveTransforms, options.directiveTransforms || {} ) }) ) return generate( ast, extend({}, options, { prefixIdentifiers }) ) }      35248ce add exports maybe needs   feat(add): compiler-core exports Â· gcclll/stb-vue-next@35248ce\n å¢åŠ  compiler-core æ¨¡å—çš„å¯¼å‡º(export)å†…å®¹\n  05a223b add transform pure text   feat(add): transform pure text Â· gcclll/stb-vue-next@05a223b\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  export function traverseNode( node: RootNode | TemplateChildNode, context: TransformContext ) { // ä¿å­˜å½“å‰è¢«å¤„ç†çš„ èŠ‚ç‚¹  context.currentNode = node // åº”ç”¨ transform æ’ä»¶  const { nodeTransforms } = context // é’ˆå¯¹æ¯ä¸ªèŠ‚ç‚¹ä¼šæ”¶é›†åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª transformXxx å‡½æ•°ï¼Œç”¨æ¥è§£æå®ƒçš„ ast  // å¾—åˆ° codegenNode ï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨å½“å‰çš„èŠ‚ç‚¹æ ‘è¢«é€’å½’éå†å®Œä¹‹åè°ƒç”¨  const exitFns = [] for (let i = 0; i \u0026lt; nodeTransforms.length; i++) { const onExit = nodeTransforms[i](node, context) if (onExit) { if (isArray(onExit)) { exitFns.push(...onExit) } else { exitFns.push(onExit) } } if (!context.currentNode) { // èŠ‚ç‚¹å¯èƒ½è¢«åˆ é™¤äº†ï¼Œæ¯”å¦‚ï¼š v-else-if, v-else ä¼šåˆå¹¶åˆ° v-if çš„ branches[] ä¸­  return } else { // èŠ‚ç‚¹å¯èƒ½ä¼šæ›¿æ¢äº†ï¼Œéœ€è¦æ›´æ–°  node = context.currentNode } } switch ( node.type // TODO  ) { } context.currentNode = node let i = exitFns.length while (i--) { exitFns[i]() } }     transform é˜¶æ®µä»£ç æ¯•ç«Ÿçš„ä¸‰ä¸ªé˜¶æ®µ\n  æ”¶é›† transformXxx å‡½æ•°åˆ° exitFns\n  æ ¹æ® astèŠ‚ç‚¹ç±»å‹é€’å½’éå†å­å­™èŠ‚ç‚¹\n  æŒ‰ç…§æ”¶é›†æ—¶ç›¸åçš„é¡ºåºæ‰§è¡Œ exitFnsï¼Œè§£æå‡º codegenNode\n   ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ generate() ä¸­ç›´æ¥è¿”å› ast : test: generate return ast for test Â· gcclll/stb-vue-next@999d8d6\n1 2 3 4 5 6  const { baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`pure text`) console.log(res.children[0])     +RESULTS:\n{ type: 2, content: \u0026#39;pure text\u0026#39;, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 10, line: 1, offset: 9 }, source: \u0026#39;pure text\u0026#39; } }   ç»“æœæ˜¾ç¤ºå¹¶æ²¡æœ‰ codegenNode å› ä¸ºåœ¨transformText ä¸­æ»¡è¶³æ¡ä»¶\n children.length === 1 \u0026amp;\u0026amp; node.type === NodeTypes.ROOT è€Œç›´æ¥é€€å‡ºäº†ã€‚\n è‡³äº root.codegenNode = undefined éœ€è¦å®ç° createRootCodegen()\n61ce406 add createRootCodegen() to create root.codegenNode   feat: createRootCodegen() for pure text Â· gcclll/stb-vue-next@61ce406\n åªå¢åŠ äº†é’ˆå¯¹é ELEMENT ç±»å‹æˆ–è€…å­©å­èŠ‚ç‚¹æ²¡æœ‰ codegenNode çš„æƒ…å†µå®ç°(å½“å‰ commit æœ€ç®€åŒ–)ã€‚\n å½“ root.children åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è‡ªå·±çš„ codegenNode æ—¶å€™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  function createRootCodegen(root: RootNode, context: TransformContext) { // const { helper } = context  const { children } = root if (children.length === 1) { // åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œç›´æ¥å–è¯¥å­©å­èŠ‚ç‚¹ çš„ codegenNode  const child = children[0] if (isSingleElementRoot(root, child) \u0026amp;\u0026amp; child.codegenNode) { // å½“ root èŠ‚ç‚¹ä¸‹åªæœ‰ä¸€ä¸ª element å…ƒç´ çš„å­©å­èŠ‚ç‚¹æ—¶ï¼Œä¸è¿›è¡Œæå‡  } else { // - single \u0026lt;slot/\u0026gt;, IfNode, ForNode: already blocks.  // - single text node: always patched.  // root codegen falls through via genNode()  root.codegenNode = child } } else if (children.length \u0026gt; 1) { // TODO  } else { // no children = noop, codegen will return null.  } }     æµ‹è¯•\n1 2 3 4 5 6  const { baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`pure text`) console.log(res)    { type: 0, children: [ { type: 2, content: \u0026#39;pure text\u0026#39;, loc: [Object] } ], helpers: [], components: [], directives: [], hoists: [], imports: [], cached: 0, temps: 0, codegenNode: { type: 2, content: \u0026#39;pure text\u0026#39;, loc: { start: [Object], end: [Object], source: \u0026#39;pure text\u0026#39; } }, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 10, line: 1, offset: 9 }, source: \u0026#39;pure text\u0026#39; } }   æ³¨æ„ codegenNode å…¶å®å°±æ˜¯ root.children[0] èŠ‚ç‚¹æœ¬èº«ã€‚\n  b9f3cb7 add transform text   feat: transformText function Â· gcclll/stb-vue-next@b9f3cb7\n   å¿…é¡»æ˜¯æ–‡æœ¬èŠ‚ç‚¹æˆ–è€…ç±»å‹æ˜¯ç»„åˆè¡¨è¾¾å¼ç±»å‹(COMPOUND_EXPRESSION)\n  patch flag å¤„ç†\n  æ„é€  TEXT_CALL ç±»å‹èŠ‚ç‚¹\n  codegenNode -\u0026gt; createCallExpression\n    f6d5271 add generate text codegen   codegen é˜¶æ®µç›®çš„æ˜¯å°† codegenNode è§£ææˆ Render å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚\n  f6d5271 add createCodegenContext()\n feat(add): codegen context creator Â· gcclll/stb-vue-next@f6d5271\n ä¸Šä¸‹æ–‡å¯¹è±¡åˆ›å»ºå‡½æ•°ï¼Œé‡ç‚¹æ–¹æ³•æœ‰ä¸¤ä¸ª(push(code, node) å’Œ helper(key))ã€‚\n FIX1: lint errors, fix: f6d5271 lint errors Â· gcclll/stb-vue-next@0ac8c2f\n  2ef2699 å¢åŠ  text codegen generator å®ç°\n feat: generate text codegen Â· gcclll/stb-vue-next@2ef2699\n è¯¥éƒ¨åˆ†æ¶‰åŠåˆ°ä¸€ä¸ªè¾ƒä¸ºå®Œæ•´çš„ codegen generator æµç¨‹ï¼Œæ‰€ä»¥å¢åŠ å†…å®¹è¾ƒå¤šï¼Œå› æ­¤è¿™é‡Œ ä¸ç›´æ¥è´´ä»£ç äº†ï¼Œè¯·ç‚¹å‡»ä¸Šé¢ commit é“¾æ¥æŸ¥çœ‹å®é™…å¢åŠ çš„æºç ã€‚\n å¤„ç†æµç¨‹ï¼š\n  preamble å¤„ç†ï¼Œå¦‚æœæ˜¯ Node ç¯å¢ƒéœ€è¦é€šè¿‡ import { ...} from \u0026#39;vue\u0026#39; è¯­æ³•ï¼Œå¦‚ æœæ˜¯æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ const { ... } = Vue è§£æ„è¯­æ³•ã€‚\n  æ˜¯å¦ä½¿ç”¨ with() {} ä½œç”¨åŸŸè¯­æ³•ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨çš„\n  return ... è¿”å›å®é™… render å‡½æ•°è¿”å›ç»“æœï¼Œè¿™é‡Œå°†è¿”å›æœ€åè¢«æ¸²æŸ“çš„ DOM ç»“æ„ã€‚\n  genNode() é€’å½’å¤„ç† ast ç”Ÿæˆ render å‡½æ•°çš„å¯¹åº”éƒ¨åˆ†ä»£ç \n    6b901f9 å¢åŠ  node ç¯å¢ƒæˆ– module ç¯å¢ƒå¤„ç†(genModulePreamble)\n feat: module preamble Â· gcclll/stb-vue-next@6b901f9 modue preamble : export { ... } from \u0026#39;vue\u0026#39; function preamble: const { ... } = Vue\n   é‡ç‚¹å¢åŠ çš„ genXxx å‡½æ•° genText(node, context) ä¸“é—¨ç”¨æ¥å¤„ç†æ–‡æœ¬èŠ‚ç‚¹çš„ã€‚\n1 2 3 4 5 6  function genText( node: TextNode | SimpleExpressionNode, context: CodegenContext ) { context.push(JSON.stringify(node.content), node) }      æµ‹è¯•   æµ‹è¯•å°†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œ\nfunction preamble å½¢å¼(ä½œä¸ºå…¨å±€ Vue å¯¹è±¡å¼•å…¥)  1 2 3 4 5 6  const { baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`pure text`) console.log(res.code)    return function render(_ctx, _cache) { with (_ctx) { return \u0026#34;pure text\u0026#34; } } undefined   fix: less the last } paren Â· gcclll/stb-vue-next@6b3bd2e\n  module preamble å½¢å¼(es6 æ¨¡å—åŒ–å¯¼å‡ºå¯¼å…¥)  1 2 3 4 5 6 7  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`pure text`, { mode: \u0026#39;module\u0026#39; }) console.log(res.code)    return function render(_ctx, _cache) { return \u0026#34;pure text\u0026#34; } undefined   è¿™é‡Œå¥½åƒçœ‹ä¸å‡ºå•¥åŒºåˆ«ï¼Œåé¢å†è¯´å§ã€‚\n      2f749b2 add interpolation generator   feat(add): transform -\u0026gt; generate interpolation Â· gcclll/stb-vue-next@2f749b2\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`{{ a \u0026gt; b }}`) console.log(res.code) console.log(res.ast.children[0])     è¿™é‡Œå®ç°åˆ†å‡ ä¸ªéƒ¨åˆ†ï¼š\n transform: traverseNode() å¢åŠ å¯¹æ’å€¼çš„å¤„ç†ï¼Œåé¢å¢åŠ äº† traverseChildren å¤„ç†ï¼Œå› ä¸ºæ‰€æœ‰çš„ ast éƒ½æ˜¯æŒ‚åœ¨ root.children ä¸­çš„ï¼Œæ‰€ä»¥æœ€å¼€å§‹è§£æçš„æ˜¯ ROOT èŠ‚ç‚¹ï¼Œå› æ­¤è¿™é‡Œå¿…é¡» è¦å¢åŠ  ROOT ç±»å‹çš„è§£æï¼Œè°ƒç”¨ traverseChildren(node, ctx) å»é€’å½’è§£æ root.children\n transform() -\u0026gt; traverseNode(): ROOT è§£æ -\u0026gt; traverseChildren() -\u0026gt; traverseNode(): INTERPOLATION\n  æ–°å¢æ ¸å¿ƒå‡½æ•°ï¼šéå†æ‰€æœ‰ children[] è°ƒç”¨ traverseNode() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  export function traverseChildren( parent: ParentNode, context: TransformContext ) { // TODO\tlet i = 0  const nodeRemoved = () =\u0026gt; { i-- } for (; i \u0026lt; parent.children.length; i++) { const child = parent.children[i] if (isString(child)) continue context.parent = parent context.childIndex = i // æ–¹ä¾¿åœ¨ transformXxx å‡½æ•°ä¸­èƒ½å¿«é€Ÿå®šä½åˆ°å½“å‰èŠ‚ç‚¹  context.onNodeRemoved = nodeRemoved traverseNode(child, context) } }      codegen: genNode() ä¸­æ–°å¢ INTERPOLATION å’Œ SIMPLE_EXPRESSION ç±»å‹çš„å¤„ç†ï¼Œ å› ä¸º INTERPOLATION çš„ ast.content(å¦‚ä¸Šé¢ä»£ç æ‰§è¡Œç»“æœ) ç±»å‹æ˜¯ SIMPLE_EXPRESSIONã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function genExpression(node: SimpleExpressionNode, context: CodegenContext) { const { content, isStatic } = node context.push(isStatic ? JSON.stringify(content) : content, node) } function genInterpolation(node: InterpolationNode, context: CodegenContext) { const { push, helper, pure } = context if (pure) push(PURE_ANNOTATION) push(`${helper(TO_DISPLAY_STRING)}(`) genNode(node.content, context) push(\u0026#39;)\u0026#39;) }      feat(add): comment generator Â· gcclll/stb-vue-next@2d0e2a6\n æ‹“å±•ï¼šadd comment generator\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;!-- i\u0026#39;m a comment --\u0026gt;`) console.log(res.code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createCommentVNode : _createCommentVNode } = _Vue return _createCommentVNode(\u0026#34; i\u0026#39;m a comment \u0026#34;) } } undefined    add element transfrom and generator  å‡†å¤‡å·¥ä½œ compiler-core/src/utils.ts   feat: utils for compiler-core Â· gcclll/stb-vue-next@9436d8f\n ç›¸å…³æ­£åˆ™ï¼š const memberExpRE = /^[A-Za-z_$][\\w$]*(?:\\s*\\.\\s*[A-Za-z_$][\\w$]*|\\[[^\\]]+\\])*$/\n  feat(add): resolveComponentType Â· gcclll/stb-vue-next@2265e46\n è§£æå‡ºç»„ä»¶çš„ç±»å‹ï¼Œå¤§ä½“åˆ†ä¸ºå››ç±»ï¼š\n  åŠ¨æ€ç»„ä»¶ï¼š \u0026lt;component is=\u0026#34;xx\u0026#34;\u0026gt; æˆ– \u0026lt;component v-is=\u0026#34;xx\u0026#34;\u0026gt;\n  å†…ç½®ç»„ä»¶ï¼š Teleport, Transition, KeepAlive, Suspense\n  ç”¨æˆ·ç»„ä»¶ï¼š $setup[] ä¸Šçš„ç»„ä»¶\n  ç”¨æˆ·ç»„ä»¶ï¼š context.components[] ä¸Šçš„ç»„ä»¶\n    87339d2 add element transform   feat(add): transformElement function Â· gcclll/stb-vue-next@87339d2\n æ™®é€šæ ‡ç­¾çš„ transform codegenNodeé˜¶æ®µã€‚\n  add createVNodeCall() å‡½æ•°ï¼Œåˆ›å»ºåŸºæœ¬çš„ ELEMENT ç±»å‹èŠ‚ç‚¹ codegenNode\n æ ¹æ® isBlock å‚æ•°å†³å®šä½¿ç”¨ BLOCK å‡½æ•°è¿˜æ˜¯ VNODE å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  export function createVNodeCall( context: TransformContext | null, tag: VNodeCall[\u0026#39;tag\u0026#39;], props?: VNodeCall[\u0026#39;props\u0026#39;], children?: VNodeCall[\u0026#39;children\u0026#39;], patchFlag?: VNodeCall[\u0026#39;patchFlag\u0026#39;], dynamicProps?: VNodeCall[\u0026#39;dynamicProps\u0026#39;], directives?: VNodeCall[\u0026#39;directives\u0026#39;], isBlock: VNodeCall[\u0026#39;isBlock\u0026#39;] = false, disableTracking: VNodeCall[\u0026#39;disableTracking\u0026#39;] = false, loc = locStub ): VNodeCall { if (context) { if (isBlock) { context.helper(OPEN_BLOCK) context.helper(CREATE_BLOCK) } else { context.helper(CREATE_VNODE) } } return { type: NodeTypes.VNODE_CALL, tag, props, children, patchFlag, dynamicProps, directives, isBlock, disableTracking, loc } }      add createObjectExpression() å‡½æ•°\n1 2 3 4 5 6 7 8 9 10  export function createObjectExpression( properties: ObjectExpression[\u0026#39;properties\u0026#39;], loc: SourceLocation = locStub ): ObjectExpression { return { type: NodeTypes.JS_OBJECT_EXPRESSION, loc, properties } }      add getStaticType() åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦åšé™æ€æå‡å¤„ç†\n  add transformElement: postTransformElement() å‡½æ•°\n  add stringifyDynamicPropNames() å°†å±æ€§è½¬æˆæ•°ç»„ç»“æ„\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) console.log(\u0026#39;root codegenNode: \u0026#39;, res.ast.codegenNode) console.log(res.code)    root codegenNode: undefined const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode } = _Vue return null } } undefined   æ­£ç¡®ç»“æœï¼š\nÆ’ render(_ctx, _cache) { with (_ctx) { const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;)) } }   é—®é¢˜ï¼š\n  æ ¹èŠ‚ç‚¹ codegenNode ä¸ºç©º\n  render å‡½æ•°å†…æ²¡æœ‰ openBlock, createBlock å¯¼å‡º\n  return åé¢æ²¡å†…å®¹(è¿™æ˜¯ generator èŒƒç•´ï¼Œæ­¤èŠ‚ä¸å±•å¼€)\n   é—®é¢˜1ï¼Œ2éƒ½æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹å¤„ç†çš„ï¼Œå› ä¸ºå½“ ROOT èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸ä¼šç”¨ CREATE_VNODE åˆ›å»ºï¼Œè€Œæ˜¯æ”¹ç”¨ CREATE_BLOCKï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªé—®é¢˜ä¸€èµ·å¤„ç†\n FIX 1,2: fix: no export open/create block function from Vue Â· gcclll/stb-vue-next@97cf290\n ä¿®æ”¹ï¼š createRootCodegen(root: RootNode, context: TransformContext)\n  2f58786 add element generator   feat: element generator Â· gcclll/stb-vue-next@2f58786\n è·¯å¾„ï¼š\n  VNODE_CALL -\u0026gt;\n  genVNodeCall() -\u0026gt;\n  genNodeList([], ctx) -\u0026gt;\n  string: push(node)\n  array: genNodeListAsArray(node, ctx)   other: genNode(node, ctx)\n     æµ‹è¯•:\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) console.log(\u0026#39;root codegenNode: \u0026#39;, res.ast.codegenNode) console.log(res.code)    root codegenNode: { type: 13, tag: \u0026#39;\u0026#34;div\u0026#34;\u0026#39;, props: undefined, children: undefined, patchFlag: undefined, dynamicProps: undefined, directives: undefined, isBlock: true, disableTracking: false, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 12, line: 1, offset: 11 }, source: \u0026#39;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026#39; } } const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;)) } }    05ca2f8 root.children æœ‰å¤šä¸ªå­©å­   feat: root.children has multi child Â· gcclll/stb-vue-next@05ca2f8 Â· GitHub\n å½“æœ‰å¤šä¸ªå­©å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ª fragment å°†ä»–ä»¬åŒ…èµ·æ¥ã€‚\n  FIX: æ­»å¾ªç¯ï¼Œ genNode(node.codegenNode, ctx)\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) console.log(res.code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(_Fragment,null,[ _createVNode(\u0026#34;div\u0026#34;), _createVNode(\u0026#34;div\u0026#34;) ],64 /* STABLE_FRAGMENT */)) } } undefined   FIX: å‚æ•°ä¹‹é—´å°‘äº†ç©ºæ ¼(feat: root.children has multi child Â· gcclll/stb-vue-next@05ca2f8)\n æ­£è§£ï¼š\nconst _Vue = Vue const { createVNode: _createVNode } = _Vue const _hoisted_1 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, null, null, -1 /* HOISTED */) const _hoisted_2 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, null, null, -1 /* HOISTED */) return function render(_ctx, _cache) { with (_ctx) { const { createVNode: _createVNode, Fragment: _Fragment, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(_Fragment, null, [ _hoisted_1, _hoisted_2 ], 64 /* STABLE_FRAGMENT */)) } }   æ­£ç¡®ç­”æ¡ˆä¸­åšäº†é™æ€æå‡å¤„ç†ï¼Œä»£ç åœ¨ transform() å‡½æ•°ä¸­ hoistStatic(root, context) çš„è°ƒç”¨ï¼Œä¼šä» ROOT èŠ‚ç‚¹å¼€å§‹éå†ï¼Œå°†éœ€è¦æå‡çš„èŠ‚ç‚¹è¿›è¡Œæå‡å¤„ç†ã€‚\n    7cb3dbf add hoist static é™æ€æå‡   æ»¡è¶³æå‡çš„ä¸‰ç§æƒ…å†µï¼š\n  tag å’Œ tagType éƒ½æ˜¯ ELEMENT ä¸”æ•´æ£µæ ‘éƒ½æ˜¯é™æ€\n  åŒ…å«åŠ¨æ€å­©å­èŠ‚ç‚¹ï¼Œä½†æ˜¯æœ‰é™æ€å±æ€§çš„ï¼Œå°†å±æ€§æå‡\n  çº¯æ–‡æœ¬èŠ‚ç‚¹\n   feat(add): hoist static Â· gcclll/stb-vue-next@7d7dbd4\n transform() ä¸­å¢åŠ é™æ€æå‡å¤„ç†ï¼š\n1 2 3  if (options.hoistStatic) { hoistStatic(root, context) }     feat: hoist static Â· gcclll/stb-vue-next@7cb3dbf\n  ä¿®æ”¹ genFunctionPreamble(ast: RootNode, context: CodegenContext) è§£æ„å‡ºéœ€è¦ç”¨åˆ°çš„å‡½æ•°(_createVNode)\n   å¢åŠ  genHoists() å‡½æ•°ï¼Œç”Ÿæˆ ast.hoists ä¸­éœ€è¦æå‡çš„èŠ‚ç‚¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  function genHoists(hoists: (JSChildNode | null)[], context: CodegenContext) { if (!hoists.length) { return } context.pure = true const { push, newline, helper, scopeId, mode } = context const genScopeId = !__BROWSER__ \u0026amp;\u0026amp; scopeId != null \u0026amp;\u0026amp; mode !== \u0026#39;function\u0026#39; newline() // push scope Id before initializing hoisted vnodes so that these vnodes // get the proper scopeId as well. if (genScopeId) { push(`${helper(PUSH_SCOPE_ID)}(\u0026#34;${scopeId}\u0026#34;)`) newline() } hoists.forEach((exp, i) =\u0026gt; { if (exp) { push(`const _hoisted_${i + 1}= `) genNode(exp, context) newline() } }) if (genScopeId) { push(`${helper(POP_SCOPE_ID)}()`) newline() } context.pure = false }       æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`, { hoistStatic: true }) console.log(res.code)    const _Vue = Vue const { createVNode: _createVNode } = _Vue const _hoisted_1 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, null, null, -1 /* HOISTED */) const _hoisted_2 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, null, null, -1 /* HOISTED */) return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(_Fragment, null, [ _hoisted_1, _hoisted_2 ], 64 /* STABLE_FRAGMENT */)) } } undefined   PS: é™æ€å±æ€§æå‡ feat: props hoist static Â· gcclll/stb-vue-next@1e58eeb\n   prop transform and generator   åœ¨è¿™ä¹‹å‰æˆ‘ä»¬å®Œæˆäº†ä»¥ä¸‹å‡ ä¸ªåŸºæœ¬éƒ¨åˆ†ï¼š\n  æ–‡æœ¬\n  æ’å€¼\n  æ™®é€šæ ‡ç­¾(ä¸€ä¸ªå’Œå¤šä¸ª)\n   æ¥ä¸‹æ¥éœ€è¦å®Œæˆå±æ€§çš„è§£ææ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå› ä¸º v-if, v-for, v-slot, ... éƒ½éœ€è¦å± æ€§è§£æã€‚\n å±æ€§è½¬æ¢è¿™é‡Œå¼‚å¸¸å¤æ‚ï¼Œéœ€è¦æ…¢æ…¢å±•å¼€æ¥è®²ï¼Œå¹¶ä¸”æ¶‰åŠåˆ°å„ç§æŒ‡ä»¤ï¼Œå› æ­¤å¯¹äºå®Œæ•´çš„æµ‹è¯•éœ€ è¦ç­‰æ‰€æœ‰æŒ‡ä»¤ transform å®Œæˆä¹‹åå†è¿›è¡Œã€‚\n1792f93 props transform  buildProps   feat(add): transform props Â· gcclll/stb-vue-next@1792f93\n  å°† codegenNode.props æ„å»ºæˆ å¦‚ä¸‹ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  { \u0026#34;type\u0026#34;:15, \u0026#34;properties\u0026#34;:[ { \u0026#34;type\u0026#34;:16, \u0026#34;key\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;class\u0026#34;, \u0026#34;isStatic\u0026#34;:true }, \u0026#34;value\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;second\u0026#34;, \u0026#34;isStatic\u0026#34;:true } }, { \u0026#34;type\u0026#34;:16, \u0026#34;key\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;onClick\u0026#34;, \u0026#34;isStatic\u0026#34;:true }, \u0026#34;value\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;clickHandle\u0026#34;, \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, } } ] }      v-bind,v-on æŒ‡ä»¤ï¼Œæ²¡æœ‰å‚æ•°ï¼Œéœ€è¦å°† props åˆå¹¶\n    transform props   feat: transform props in codgenNode Â· gcclll/stb-vue-next@20a5fa8\n    e4acc0d props generator   feat: props generator Â· gcclll/stb-vue-next@e4acc0d\n ä¿®æ”¹ç‚¹ï¼š\n  add genExpressionAsPropertyKey() ç”Ÿæˆå±æ€§ key å‡½æ•°\n ä¸‰ç§å¯èƒ½çš„å±æ€§å\n  é™æ€å±æ€§å: \u0026lt;div class=\u0026#34;value\u0026#34;\u0026gt; -\u0026gt; { class: \u0026#34;value\u0026#34; }\n  åŠ¨æ€å±æ€§å: \u0026lt;div :[propName]=\u0026#34;value\u0026#34; -\u0026gt; { [propName]: \u0026#34;value\u0026#34;}\n  ç»„åˆè¡¨è¾¾å¼å±æ€§åï¼šTODO\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // ç”Ÿæˆå¯¹è±¡çš„å±æ€§ key (å¯èƒ½æ˜¯é™æ€ï¼ŒåŠ¨æ€) function genExpressionAsPropertyKey( node: ExpressionNode, context: CodegenContext ) { const { push } = context if (node.type === NodeTypes.COMPOUND_EXPRESSION) { // TODO åŠ¨æ€å±æ€§åæˆ–è¡¨è¾¾å¼  } else if (node.isStatic) { // only quote key if necessary  const text = isSimpleIdentifier(node.content) ? node.content : JSON.stringify(node.content) push(text, node) } else { push(`[${node.content}]`, node) } }        add genObjectExpression() å°†å±æ€§åˆ—è¡¨ç”Ÿæˆå¯¹è±¡\n éå†èŠ‚ç‚¹çš„ node.properties å…ˆç”Ÿæˆ key(genExpressionAsPropertyKey(key)) å†ç”Ÿæˆ value(genNode(value)) ã€‚\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;div class=\u0026#34;first\u0026#34; name=\u0026#34;div\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`, { hoistStatic: true }) console.log(res.code)    const _Vue = Vue const { createVNode: _createVNode } = _Vue const _hoisted_1 = { class: \u0026#34;first\u0026#34;, name: \u0026#34;div\u0026#34; } return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1)) } } undefined   å®ä¾‹ä¸­æœ€åæ˜¯ç”¨çš„ createBlock() æ˜¯å› ä¸º root.children åªæœ‰ä¸€ä¸ª child ã€‚\n   static props   ä¿®æ”¹å‡½æ•°ï¼š transforms/transformElement\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;div class=\u0026#34;first\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;div class=\u0026#34;second\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`, { hoistStatic: true }) console.log(res.ast.codegenNode.children[0].props[0])    { type: 6, name: \u0026#39;class\u0026#39;, value: { type: 2, content: \u0026#39;first\u0026#39;, loc: { start: [Object], end: [Object], source: \u0026#39;\u0026#34;first\u0026#34;\u0026#39; } }, loc: { start: { column: 6, line: 1, offset: 5 }, end: { column: 19, line: 1, offset: 18 }, source: \u0026#39;class=\u0026#34;first\u0026#34;\u0026#39; } } undefined    6951dd1 merge props   feat: merge props Â· gcclll/stb-vue-next@6951dd1\n åˆå¹¶å±æ€§çš„æ¡ä»¶ï¼šå­˜åœ¨æ²¡æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œå¦‚ï¼š \u0026lt;div v-bind=\u0026#34;{...}\u0026#34; v-on=\u0026#34;{...}\u0026#34;\n FIX: fix: merge toHandlers props Â· gcclll/stb-vue-next@12a66f0\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const log = (code, title) =\u0026gt; { console.log(`\u0026gt;\u0026gt;\u0026gt; ${title}`) const res = baseCompile(code) console.log(res.code) } log(` \u0026lt;div class=\u0026#34;first\u0026#34; v-on=\u0026#34;{ click: clickHandle }\u0026#34; v-bind=\u0026#34;{ style: \u0026#39;color:red\u0026#39; }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`, \u0026#39;æ— å‚æ•°çš„æŒ‡ä»¤ï¼Œåˆå¹¶æ‰€æœ‰å±æ€§\u0026#39;) log(`\u0026lt;div class=\u0026#34;second\u0026#34; v-on:click=\u0026#34;clickHandle\u0026#34; v-bind:style=\u0026#34;color:red\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`, \u0026#39;æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œä¸åˆå¹¶\u0026#39;)    \u0026gt;\u0026gt;\u0026gt; æ— å‚æ•°çš„æŒ‡ä»¤ï¼Œåˆå¹¶æ‰€æœ‰å±æ€§ const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toHandlers : _toHandlers, mergeProps : _mergeProps, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _mergeProps({ class: \u0026#34;first\u0026#34; }, _toHandlers({ click: clickHandle }), { style: \u0026#39;color:red\u0026#39; }), null, 16 /* FULL_PROPS */)) } } \u0026gt;\u0026gt;\u0026gt; æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œä¸åˆå¹¶ const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return _withDirectives((_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { class: \u0026#34;second\u0026#34; }, null, 512 /* NEED_PATCH */)), ) } } undefined   æœ‰å‚æ•°æŒ‡ä»¤æ—¶ï¼Œéœ€è¦ç»“åˆ v-on æŒ‡ä»¤è§£æï¼Œå› æ­¤éœ€è¦å…ˆå®ç°äº† transform æŒ‡ä»¤æ‰èƒ½å¾—åˆ°ä¸‹é¢çš„æ­£ç¡®ç»“æœã€‚\n ä¸åˆå¹¶(mergeProps()) çš„æ­£è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { class: \u0026#34;second\u0026#34;, onClick: clickHandle, style: { color: \u0026#39;red\u0026#39; } }, null, 12 /* STYLE, PROPS */, [\u0026#34;onClick\u0026#34;])) } } })     ä¸‹é¢å°†ç»§ç»­å®ŒæˆæŒ‡ä»¤ç›¸å…³çš„ transform\n    6c43451 add v-on transform   init: feat(init): v-on directive Â· gcclll/stb-vue-next@98dcc96\n å®ç°ï¼šfeat: v-on directive transform Â· gcclll/stb-vue-next@6c43451\n1 2 3 4 5 6 7 8 9  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(`\u0026lt;div class=\u0026#34;second\u0026#34; v-on:click=\u0026#34;clickHandle\u0026#34; v-bind:style=\u0026#34;color:red\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`) console.log(res.code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return _withDirectives((_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { class: \u0026#34;second\u0026#34;, onClick: clickHandle }, null, 8 /* PROPS */, [\u0026#34;onClick\u0026#34;])), ) } } undefined   é—®é¢˜ï¼š v-bind æ²¡æœ‰è¢«è§£æå‡ºæ¥ã€‚\n å¦‚æœ v-onçš„ exp æ˜¯ä¸ªç®€å•çš„è¡¨è¾¾å¼ï¼Œéœ€è¦å°†å…¶è½¬æˆå‡½æ•° $event =\u0026gt; (i++)\n feat(add): v-on with simple expression as handler Â· gcclll/stb-vue-next@1542b41\n åˆ¤æ–­æ˜¯ç®€å•è¡¨è¾¾å¼çš„ä¾æ®ï¼š\n const isInlineStatement = !(isMemberExp || fnExpRE.test(exp.content))\n å³ä¸æ˜¯ member expression ä¹Ÿä¸æ˜¯ function expression ã€‚\n member expression: /^[A-Za-z_$][\\w$]*(?:\\s*\\.\\s*[A-Za-z_$][\\w$]*|\\[[^\\]]+\\])*$/  function expresstion: /^\\s*([\\w$_]+|\\([^)]*?\\))\\s*=\u0026gt;|^\\s*function(?:\\s+[\\w$]+)?\\s*\\(/  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code, ast } = baseCompile(`\u0026lt;div v-on:click=\u0026#34;i++\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`) console.log(code) console.log(`\u0026gt;\u0026gt;\u0026gt; event name`) console.log(ast.codegenNode.props.properties[0].key) console.log(`\u0026gt;\u0026gt;\u0026gt; event handler`) console.log(ast.codegenNode.props.properties[0].value)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { onClick: $event =\u0026gt; (i++) }, null, 8 /* PROPS */, [\u0026#34;onClick\u0026#34;])) } } \u0026gt;\u0026gt;\u0026gt; event name { type: 4, loc: { start: { column: 11, line: 1, offset: 10 }, end: { column: 16, line: 1, offset: 15 }, source: \u0026#39;click\u0026#39; }, content: \u0026#39;onClick\u0026#39;, isStatic: true, constType: 3 } \u0026gt;\u0026gt;\u0026gt; event handler { type: 8, loc: { source: \u0026#39;\u0026#39;, start: { line: 1, column: 1, offset: 0 }, end: { line: 1, column: 1, offset: 0 } }, children: [ \u0026#39;$event =\u0026gt; (\u0026#39;, { type: 4, content: \u0026#39;i++\u0026#39;, isStatic: false, constType: 0, loc: [Object] }, \u0026#39;)\u0026#39; ] } undefined  æ›´å¤šæµ‹è¯•ç”¨ä¾‹(\u0026lt;f12\u0026gt;)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -\u0026gt;\u0026gt; ã€‚\n  l1(`v-on æŒ‡ä»¤`) c(``, `v-on click`) c(``, `v-onåŠ¨æ€äº‹ä»¶å`) l2(`TODO 'dynamic arg with prefixing'`) l2(`TODO dynamic arg with complex exp prefixing`) c(``, 'å¦‚æœ v-on çš„exp æ˜¯ä¸ªç®€å•è¡¨è¾¾å¼ï¼Œè¦ç”¨å‡½æ•°å°è£…èµ·æ¥') c(``, `æ”¯æŒå¤šä¸ªè¡¨è¾¾å¼`) c(``, `æ”¯æŒå¤šè¡Œè¡¨è¾¾å¼`) c(``, `å‡½æ•°è°ƒç”¨`) c(``, `å‡½æ•°è°ƒç”¨åŠ è¡¨è¾¾å¼æ··åˆ`) c(`foo($event)\"/`, `å¦‚æœæœ¬èº«æ˜¯å‡½æ•°ä¸ç”¨å¤šä½™å¤„ç†`) c(`{ foo($event) } \"/`, `= å¦‚æœè¡¨è¾¾å¼å·²ç»æ˜¯å‡½æ•°åŸæ ·è¾“å‡ºå°±è¡Œ`) c(``, `function, å¦‚æœè¡¨è¾¾å¼å·²ç»æ˜¯å‡½æ•°åŸæ ·è¾“å‡ºå°±è¡Œ`) c(``, `å¦‚æœè¡¨è¾¾å¼æ˜¯å¯¹è±¡å–å€¼è¡¨è¾¾å¼ï¼Œä¸ç”¨å¤„ç†`) c(``, `å¦‚æœæ²¡æœ‰è¡¨è¾¾å¼å’Œä¿®é¥°ç¬¦ï¼ŒæŠ¥é”™`) c(``, `å¦‚æœæ²¡è¡¨è¾¾å¼ä½†æ˜¯æœ‰ä¿®é¥°ç¬¦ï¼Œä¸æŠ¥é”™`) c(``, `äº‹ä»¶åä¸º foo-bar è¦è½¬æˆé©¼å³° onFooBar`) c(``, 'case conversion for vnode hooks') compile.options = { cacheHandlers: true } c(``, `empty handler`) c(``, 'member expression handler') c(``, 'compound member expression handler') c(``, 'bail on component member expression handler') c(`foo()\" /`, 'inline function expression handler') c(``, 'inline statement handler')   options.cacheHandlers å±æ€§è¦é…åˆ options.prefixIdentifiers ä½¿ç”¨ã€‚\n ä½œç”¨æ˜¯ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°ï¼ŒåŸç†æ˜¯:\n1 2 3 4 5 6 7 8 9  return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { onClick: _cache[1] || (_cache[1] = () =\u0026gt; {}) })) } }     ç¼“å­˜çš„é™„åŠ æ¡ä»¶ï¼š let shouldCache: boolean = context.cacheHandlers \u0026amp;\u0026amp; !exp\n æ²¡æœ‰è¡¨è¾¾å¼å€¼çš„æƒ…å†µä¸‹æ‰ç¼“å­˜ï¼Œå› ä¸ºæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªç©ºçš„å‡½æ•°ä½œä¸ºäº‹ä»¶ handlerï¼Œä¸ºäº†é¿å… åˆ›å»ºè¿‡å¤šçš„æ— æ„ä¹‰çš„ç©ºå‡½æ•°ï¼Œä½¿ç”¨ç¼“å­˜æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©(ä½†ï¼Œä¸€èˆ¬ç»‘å®šäº†äº‹ä»¶åº”è¯¥ä¸è‡³äºä¸ ç»™å¤„ç†å‡½æ•°å§!!!)ã€‚\n  f805858 add v-bind transform   feat(add): v-bind transform Â· gcclll/stb-vue-next@f805858\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const res = baseCompile(` \u0026lt;div v-bind:name=\u0026#34;test\u0026#34; :age=\u0026#34;100\u0026#34; :[propName]=\u0026#34;myName\u0026#34; :[first+second]=\u0026#34;thrid\u0026#34; :no-need-camel-prop=\u0026#34;noNeedCamelProp\u0026#34; :need-camel-prop.camel=\u0026#34;needCamelProp\u0026#34; :no-exp-prop.camel \u0026gt;\u0026lt;/div\u0026gt;`, { onError(e) { console.log(e.message) } }) console.log(`\u0026gt;\u0026gt;\u0026gt; render function\\n`) console.log(res.code)    v-bind is missing expression. \u0026gt;\u0026gt;\u0026gt; render function const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { name: test, age: 100, [propName || \u0026#34;\u0026#34;]: myName, [first+second || \u0026#34;\u0026#34;]: thrid, \u0026#34;no-need-camel-prop\u0026#34;: noNeedCamelProp, needCamelProp: needCamelProp, noExpProp: \u0026#34;\u0026#34; }, null, 16 /* FULL_PROPS */, [\u0026#34;name\u0026#34;,\u0026#34;age\u0026#34;,\u0026#34;no-need-camel-prop\u0026#34;,\u0026#34;needCamelProp\u0026#34;,\u0026#34;noExpProp\u0026#34;])) } } undefined   v-bind å±æ€§æ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\n  v-bind:name=\u0026#34;test\u0026#34; æ— ç¼©å†™å±æ€§ï¼Œæœ€æ™®é€šçš„ä¸€ç§ç”¨æ³•\n  :age=\u0026#34;100\u0026#34; ç¼©å†™å½¢å¼\n  :[propName]=\u0026#34;myName\u0026#34; æ™®é€šåŠ¨æ€å±æ€§å\n  :[first+second]=\u0026#34;third\u0026#34; è¡¨è¾¾å¼åŠ¨æ€å±æ€§å\n  :no-need-camel-prop=\u0026#34;noNeedCamelProp\u0026#34; ä¸éœ€è¦è½¬é©¼å³°çš„å±æ€§å\n  :need-camel-prop.camel=\u0026#34;needCamelProp\u0026#34; éœ€è¦è½¬æˆé©¼å³°çš„å±æ€§åï¼Œéœ€è¦åˆ¶å®š .camel ä¿®é¥°ç¬¦\n  no-exp-prop.camel æ— å±æ€§å€¼çš„å±æ€§ï¼Œä¼šç»™é»˜è®¤ \u0026#34;\u0026#34; å€¼ï¼ŒåŒæ—¶ç»™å‡ºè­¦å‘Šï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚\n  æ›´å¤šæµ‹è¯•ç”¨ä¾‹(\u0026lt;f12\u0026gt;)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -\u0026gt;\u0026gt; ã€‚\n  l1(`v-bind æŒ‡ä»¤ `) c(``, 'basic') c(``, `dynamic arg`) c(``, `should error if no expression`) c(``, '.camel modifier') c(``, '.camel modifier w/ dynamic arg') c(``, '.camel modifier w/ dynamic arg + prefixIdentifiers')    0cc76f0 add v-model transform   feat(add): v-model transform Â· gcclll/stb-vue-next@0cc76f0\n \u0026lt;input v-model=\u0026#34;model\u0026#34; /\u0026gt;\n ç»è¿‡ transformModel ä¹‹åçš„ node.props:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  [ { \u0026#34;type\u0026#34;:16, // JS_PROPERTY \u0026#34;key\u0026#34;:{ \u0026#34;type\u0026#34;:4, // SIMPLE_EXPRESSION \u0026#34;content\u0026#34;:\u0026#34;modelValue\u0026#34;, \u0026#34;isStatic\u0026#34;:true, \u0026#34;constType\u0026#34;:3 }, \u0026#34;value\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;model\u0026#34;, \u0026#34;isStatic\u0026#34;:false, \u0026#34;constType\u0026#34;:0, } }, { \u0026#34;type\u0026#34;:16, \u0026#34;key\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;onUpdate:modelValue\u0026#34;, \u0026#34;isStatic\u0026#34;:true, \u0026#34;constType\u0026#34;:3 }, \u0026#34;value\u0026#34;:{ \u0026#34;type\u0026#34;:8, // COMPOUND_EXPRESSION \u0026#34;children\u0026#34;:[ \u0026#34;$event =\u0026gt; (\u0026#34;, { \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;model\u0026#34;, \u0026#34;isStatic\u0026#34;:false, \u0026#34;constType\u0026#34;:0, }, \u0026#34; = $event)\u0026#34; ] } } ]     compiler-core é˜¶æ®µçš„è§£æè„‘å›¾ï¼š  ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ v-model æŒ‡ä»¤çš„è§£æä¹Ÿæ˜¯åœ¨ buildProps ä¸­å®Œæˆçš„ï¼Œå…³äºè¿™ä¸ªå‡½æ•°çš„è„‘ å›¾ä¹Ÿå¯ä»¥æŸ¥çœ‹ buildProps(node, context) å¦‚ä½•æ„å»º props ?\n vue/baseCompile è§£æä¹‹åçš„ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { modelValue: model, \u0026#34;onUpdate:modelValue\u0026#34;: $event =\u0026gt; (model = $event) }, null, 8 /* PROPS */, [\u0026#34;modelValue\u0026#34;, \u0026#34;onUpdate:modelValue\u0026#34;])) } }     vue/compile ç»è¿‡ compile-dom package(æœªå®Œæˆ) çš„ transformModel ä¹‹åçš„ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { vModelText: _vModelText, createVNode: _createVNode, withDirectives: _withDirectives, openBlock: _openBlock, createBlock: _createBlock } = _Vue return _withDirectives((_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { \u0026#34;onUpdate:modelValue\u0026#34;: $event =\u0026gt; (model = $event) }, null, 8 /* PROPS */, [\u0026#34;onUpdate:modelValue\u0026#34;])), [ [_vModelText, model] ]) } } })     fix: v-model no value Â· gcclll/stb-vue-next@a537be0\n ä¿®å¤ä¹‹å(genNode æ²¡æœ‰å®ç° 8,COMPOUND_EXPRESSION ç±»å‹)ï¼Œæµ‹è¯•\n  ä¸å¸¦å‚æ•°çš„ v-model\n1 2 3 4 5 6 7  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;input v-model=\u0026#34;model\u0026#34; /\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { modelValue: model, \u0026#34;onUpdate:modelValue\u0026#34;: $event =\u0026gt; (model = $event) }, null, 8 /* PROPS */, [\u0026#34;modelValue\u0026#34;,\u0026#34;onUpdate:modelValue\u0026#34;])) } }    æŒ‡ä»¤ { prefixIdentifiers: true } é€‰é¡¹(éœ€è¦ node ç¯å¢ƒ, TODO)\n1 2 3 4 5 6 7 8 9  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;input v-model=\u0026#34;model\u0026#34; /\u0026gt;`, { prefixIdentifiers: true }) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { modelValue: model, \u0026#34;onUpdate:modelValue\u0026#34;: $event =\u0026gt; (model = $event) }, null, 8 /* PROPS */, [\u0026#34;modelValue\u0026#34;,\u0026#34;onUpdate:modelValue\u0026#34;])) } } undefined    ç»„åˆè¡¨è¾¾å¼(8,COMPOUND_EXPRESSION)\n1 2 3 4 5 6 7  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;input v-model=\u0026#34;model[index]\u0026#34; /\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { modelValue: model[index], \u0026#34;onUpdate:modelValue\u0026#34;: $event =\u0026gt; (model[index] = $event) }, null, 8 /* PROPS */, [\u0026#34;modelValue\u0026#34;,\u0026#34;onUpdate:modelValue\u0026#34;])) } } undefined    å¸¦å‚æ•°\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;input v-model:value=\u0026#34;model\u0026#34; /\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { value: model, \u0026#34;onUpdate:value\u0026#34;: $event =\u0026gt; (model = $event) }, null, 40 /* PROPS, HYDRATE_EVENTS */, [\u0026#34;value\u0026#34;,\u0026#34;onUpdate:value\u0026#34;])) } } undefined   ä¸å¸¦å‚æ•°çš„æ—¶å€™å‚æ•°åä¼šç»™ä¸€ä¸ªé»˜è®¤å€¼ï¼š modelValue, å¦‚æœæœ‰è‡ªå·±çš„å‚æ•°ä¼šç›´æ¥ä½¿ ç”¨æä¾›çš„å‚æ•°åã€‚\n  åŠ¨æ€å‚æ•°\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;input v-model:[value]=\u0026#34;model\u0026#34; /\u0026gt;`) console.log(code)     æœ‰é—®é¢˜ç»“æœï¼š\nconst _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { [value]: model, : $event =\u0026gt; (model = $event) }, null, 16 /* FULL_PROPS */)) } }   ç»“æœæ˜¾ç¤ºï¼ŒåŠ¨æ€å±æ€§çš„äº‹ä»¶åæ²¡æœ‰è¢«è§£æå‡ºæ¥ : $event =\u0026gt; (model = $event) ã€‚\n ä¿®å¤ä¹‹åç»“æœ(fix: v-model dynamic arg generate Â· gcclll/stb-vue-next@94a7a85)ï¼š\nconst _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;input\u0026#34;, { [value]: model, [\u0026#34;onUpdate:\u0026#34; + value]: $event =\u0026gt; (model = $event) }, null, 16 /* FULL_PROPS */)) } }    ç¼“å­˜äº‹ä»¶å›è°ƒå‡½æ•°(cacheHandlers: true, TODO)\n éœ€è¦ç»“åˆ prefixIdentifiers: true ä½¿ç”¨ã€‚\n  é’ˆå¯¹ v-model è¿˜éœ€è¦ compile-runtime é˜¶æ®µçš„æ”¯æŒï¼Œç”±äºè¿™é‡Œè¿˜æ²¡å®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œçš„ç»“æœ å’Œ vue-next æµ‹è¯•ç»“æœä¼šæœ‰äº›å‡ºå…¥ï¼Œå‡ºå…¥ç‚¹åœ¨äº compiler-runtime æœŸä¼šå°† modelValue: model åˆ é™¤ã€‚\n æ›´å¤šæµ‹è¯•ç”¨ä¾‹(\u0026lt;f12\u0026gt;)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -\u0026gt;\u0026gt; ã€‚\n  l1(`v-model æŒ‡ä»¤`) c('', 'simple expression') c('', 'simple expression (with multilines)') c('', 'compound expression') c('', 'with argument') c('', 'with dynamic argument') c('', 'should cache update handler w/ cacheHandlers: true') c('', 'should not cache update handler if it refers v-for scope variables') c('', 'should mark update handler dynamic if it refers slot scope variables') c('', 'should generate modelModifiers for component v-model') c('', 'should generate modelModifiers for component v-model with arguments') c('', 'missing expression') c('', 'empty expression') c('', 'mal-formed expression') c('', 'used on scope variable')    bf18a84 add v-once transform   feat(add): v-once Â· gcclll/stb-vue-next@bf18a84\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const seen = new WeakSet() export const transformOnce: NodeTransform = (node, context) =\u0026gt; { if (node.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; findDir(node, \u0026#39;once\u0026#39;, true)) { // ç¼“å­˜å®ç° v-onceï¼Œå°±ç®—æœ‰æ•°æ®æ›´æ–°ä¹Ÿä¸ä¼šé‡æ–°ç”Ÿæˆ render å‡½æ•°  if (seen.has(node)) { return } seen.add(node) context.helper(SET_BLOCK_TRACKING) return () =\u0026gt; { const cur = context.currentNode as ElementNode | IfNode | ForNode if (cur.codegenNode) { cur.codegenNode = context.cache(cur.codegenNode, true /* isVNode */) } } } }     v-once æŒ‡ä»¤çš„å®ç°çœ‹ä¼¼æŒºç®€å•çš„ï¼Œå°†è§£æåçš„ node èŠ‚ç‚¹ç¼“å­˜åˆ° seen: WeakSet ä¸­ï¼Œ ä¸‹æ¬¡ä½¿ç”¨çš„æ—¶å€™ç›´æ¥å–ç¼“å­˜(context.cache(...))ï¼Œè€Œä¸æ˜¯é‡æ–°ç”Ÿæˆ codegenNode\n JS_CACHE_EXPRESSION ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  export function createCacheExpression( index: number, value: JSChildNode, isVNode: boolean = false ): CacheExpression { return { type: NodeTypes.JS_CACHE_EXPRESSION, index, // åœ¨ context.cached ä¸­çš„ç´¢å¼•  value, // v-onceèŠ‚ç‚¹çš„ ast  isVNode, // block æˆ– vnode ?  loc: locStub } }     generator é˜¶æ®µå®ç°ï¼šfeat(add): v-once generator Â· gcclll/stb-vue-next@8bacf14\n åœ¨ genNode() ä¸­å¢åŠ  JS_CACHE_EXPRESSION ç±»å‹çš„åˆ†æ”¯å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function genCacheExpression(node: CacheExpression, context: CodegenContext) { const { push, helper, indent, deindent, newline } = context if (node.isVNode) { indent() push(`${helper(SET_BLOCK_TRACKING)}(-1),`) newline() } push(`_cache[${node.index}] = `) genNode(node.value, context) if (node.isVNode) { push(`,`) newline() push(`${helper(SET_BLOCK_TRACKING)}(1),`) newline() push(`_cache[${node.index}]`) deindent() } push(`)`) }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const c = ( tpl, desc ) =\u0026gt; { console.log(desc) const { code } = baseCompile(tpl) console.log(code) } c(`\u0026lt;div :id=\u0026#34;foo\u0026#34; v-once /\u0026gt;`, `\u0026gt;\u0026gt;\u0026gt; \u0026lt;div :id=\u0026#34;foo\u0026#34; v-once /\u0026gt;`) c(`\u0026lt;div\u0026gt;\u0026lt;div :id=\u0026#34;foo\u0026#34; v-once /\u0026gt;\u0026lt;/div\u0026gt;`, `\u0026gt;\u0026gt;\u0026gt; æ ‡ç­¾ä¸­åµŒå¥—ä½¿ç”¨`) c(`\u0026lt;div\u0026gt;\u0026lt;Comp :id=\u0026#34;foo\u0026#34; v-once /\u0026gt;\u0026lt;/div\u0026gt;`, `\u0026gt;\u0026gt;\u0026gt; åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸Š`)    \u0026gt;\u0026gt;\u0026gt; \u0026lt;div :id=\u0026#34;foo\u0026#34; v-once /\u0026gt; const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { setBlockTracking : _setBlockTracking, createVNode : _createVNode } = _Vue return _cache[1] || ( _setBlockTracking(-1), _cache[1] = _createVNode(\u0026#34;div\u0026#34;, { id: foo }, null, 8 /* PROPS */, [\u0026#34;id\u0026#34;]), _setBlockTracking(1), _cache[1] ) } } \u0026gt;\u0026gt;\u0026gt; æ ‡ç­¾ä¸­åµŒå¥—ä½¿ç”¨ const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { setBlockTracking : _setBlockTracking, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ _cache[1] || ( _setBlockTracking(-1), _cache[1] = _createVNode(\u0026#34;div\u0026#34;, { id: foo }, null, 8 /* PROPS */, [\u0026#34;id\u0026#34;]), _setBlockTracking(1), _cache[1] ) ])) } } \u0026gt;\u0026gt;\u0026gt; åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸Š const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { setBlockTracking : _setBlockTracking, resolveComponent : _resolveComponent, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ _cache[1] || ( _setBlockTracking(-1), _cache[1] = _createVNode(_component_Comp, { id: foo }, null, 8 /* PROPS */, [\u0026#34;id\u0026#34;]), _setBlockTracking(1), _cache[1] ) ])) } } undefined   TODO ç¼ºå°‘ï¼š const _component_Comp = _resolveComponent(\u0026#34;Comp\u0026#34;)\næ›´å¤šæµ‹è¯•ç”¨ä¾‹(\u0026lt;f12\u0026gt;)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -\u0026gt;\u0026gt; ã€‚\n  l1(`v-once æŒ‡ä»¤`) c(``, 'as root node', ast = ast.codegenNode) c(``, 'on nested plain element') c(``, 'on component') c(``, 'on slot outlet') c(``, 'with hoistStatic: true') c(``, 'with v-if/else') c(``, 'with v-for')    acdea14 add v-if transform   v-if æŒ‡ä»¤æºç è„‘å›¾å¯å‚è€ƒï¼š 05 v-if æŒ‡ä»¤(git:0a591b6)\n å¯¹äº v-if|else|else-if æŒ‡ä»¤åœ¨ transform é˜¶æ®µï¼Œè½¬æ¢æ”¶é›† transformXxx å‡½æ•°è¿‡ç¨‹ä¸­ï¼Œ ä¼šå…ˆé’ˆå¯¹æŒ‡ä»¤è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ï¼š v-else, v-else-if æŒ‡ä»¤çš„ç»„ä»¶ä¼šè¢«è§£æåˆ° v-if èŠ‚ ç‚¹çš„ node.branches[] åˆ†æ”¯æ•°ç»„é‡Œé¢ä¹‹åè¢«åˆ é™¤ï¼Œè¿™äº›éƒ½æ˜¯åœ¨æ”¶é›† transformXxx ä¹‹å‰éœ€è¦å®Œæˆçš„ã€‚\n åŒ…æ‹¬ v-for æŒ‡ä»¤éƒ½éœ€è¦ç»è¿‡ createStructuralDirectiveTransform() å‡½æ•°å°è£…ä¸€å±‚ ä¹‹åï¼Œè¿”å›å¯¹åº”çš„ transformXxx å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  export function createStructuralDirectiveTransform( name: string | RegExp, fn: StructuralDirectiveTransform ): NodeTransform { const matches = isString(name) ? (n: string) =\u0026gt; n === name : (n: string) =\u0026gt; name.test(n) return (node, context) =\u0026gt; { if (node.type === NodeTypes.ELEMENT) { const { props } = node // structural directive transforms are not concerned with slots  // as they are handled separately in vSlot.ts  if (node.tagType === ElementTypes.TEMPLATE \u0026amp;\u0026amp; props.some(isVSlot)) { return } const exitFns = [] for (let i = 0; i \u0026lt; props.length; i++) { const prop = props[i] if (prop.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; matches(prop.name)) { // structural directives are removed to avoid infinite recursion  // also we remove them *before* applying so that it can further  // traverse itself in case it moves the node around  props.splice(i, 1) i-- const onExit = fn(node, prop, context) if (onExit) exitFns.push(onExit) } } return exitFns } } }     é€šè¿‡ for (...) å°†æ‰€æœ‰ v-if/v-for ç›¸å…³æŒ‡ä»¤ç»è¿‡ä»–ä»¬è‡ªå·±çš„å¤„ç†å‡½æ•°(æ¯”å¦‚ï¼š processIf ) ä¹‹åå¾—åˆ°æœ€ç»ˆçš„ onExit æ”¶é›†åˆ° exitFns ä¸­ï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­éšæ—¶ä¼šå‡º ç°èŠ‚ç‚¹çš„åˆ é™¤æ“ä½œ(æ¯”å¦‚ï¼š v-else èŠ‚ç‚¹ä¼šåœ¨è§£æå®Œä¹‹åè¢«åˆ é™¤)ï¼Œåœ¨æ­£å¸¸çš„ traverse è¿‡ ç¨‹ä¸­è¿™äº›èŠ‚ç‚¹éƒ½ä¸ä¼šå†å­˜åœ¨ã€‚\n PS: æ­£ç¡®ç†è§£åº”è¯¥å±äºç§»åŠ¨æ“ä½œï¼Œå› ä¸ºåŸå§‹çš„ AST ç»“æ„å¹¶æ²¡æ”¹å˜ï¼Œåªä¸è¿‡æ˜¯åœ¨åŸæœ‰çš„ AST æ•°ç»“æ„ä¸­ç§»é™¤åˆ°æ–°çš„ AST èŠ‚ç‚¹ä¸‹é¢äº†ã€‚\n acdea14 v-if transform init   feat(init): v-if transform Â· gcclll/stb-vue-next@acdea14\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  export const transformIf = createStructuralDirectiveTransform( /^(if|else|else-if)$/, (node, dir, context) =\u0026gt; { return processIf(node, dir, context, (ifNode, branch, isRoot) =\u0026gt; { // TODO  console.log(ifNode, branch, isRoot) return () =\u0026gt; {} }) } ) export function processIf( node: ElementNode, dir: DirectiveNode, context: TransformContext, processCodegen?: ( node: IfNode, branch: IfBranchNode, isRoot: boolean ) =\u0026gt; (() =\u0026gt; void) | undefined ) {}     åˆå§‹åŒ– v-if process å‡½æ•°ï¼Œ processIf å‡½æ•°é‡Œé¢ä¼šé’ˆå¯¹ v-if èŠ‚ç‚¹ç”šè‡³å®ƒçš„å…„å¼ŸèŠ‚ç‚¹åš ä¸€ç³»åˆ—æ“ä½œï¼Œæ¯”å¦‚å°†ä¸‹ä¸€ä¸ªæ˜¯ v-else çš„å…„å¼ŸèŠ‚ç‚¹åˆ é™¤ç§»åˆ°è‡ªå·±çš„ branches[] é‡Œé¢ã€‚\n  9039a3e v-if transform processIf   feat: v-if processIf Â· gcclll/stb-vue-next@9039a3e\n è¿™é‡Œå¢åŠ äº†ä¸¤ä¸ªå‡½æ•°çš„å®ç°ï¼š\n  processIf, è§£æ ifï¼Œåˆ›å»º IF,9 ç±»å‹çš„ç»“æ„ï¼Œæ›¿æ¢ v-if åŸæ¥çš„ ast\n1 2 3 4 5  const ifNode: IfNode = { type: NodeTypes.IF, loc: node.loc, branches: [branch] }     å…¶ä¸­ branches ä¿å­˜ç€æ‰€æœ‰ v-else, v-else-if åˆ†æ”¯èŠ‚ç‚¹ï¼Œè¿™é‡Œå…¶å®æ˜¯åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤ çš„åˆ†æ”¯èŠ‚ç‚¹ï¼Œå› ä¸º v-if ç³»åˆ—æŒ‡ä»¤åœ¨ render å‡½æ•°ä¸­æ˜¯ä»¥ä¸‰å…ƒè¿ç®—ç¬¦(?:)å½¢å¼å­˜ åœ¨çš„ï¼Œæ‰€ä»¥ if åé¢å¿…é¡»è¦æœ‰ä¸€ä¸ªåˆ†æ”¯ï¼Œå³ condition ? node1 : node2 ä¸­çš„ node2 å¿…é¡»æ˜¯ä¸ªæœ‰æ•ˆçš„å€¼ï¼Œæ‰èƒ½æ­£å¸¸ä½¿ç”¨ ?: è¿ç®—ç¬¦ã€‚\n æ‰€ä»¥ï¼Œå¦‚æœåªæœ‰ v-if æŒ‡ä»¤çš„æ—¶å€™ä¸‰å…ƒç¬¦åé¢çš„å€¼èµ·å§‹æ˜¯ä¸ªç©ºå€¼(å¥½åƒæ˜¯ null)\n  createIfBranch, åˆ›å»º v-if çš„åˆ†æ”¯èŠ‚ç‚¹çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function createIfBranch(node: ElementNode, dir: DirectiveNode): IfBranchNode { return { type: NodeTypes.IF_BRANCH, loc: node.loc, // condition ? v-if node : v-else node  condition: dir.name === \u0026#39;else\u0026#39; ? undefined : dir.exp, // å¦‚æœç”¨çš„æ˜¯ \u0026lt;template v-if=\u0026#34;condition\u0026#34; ... å°±éœ€è¦ node.children  // å› ä¸º template æœ¬èº«æ˜¯ä¸è¯¥è¢«æ¸²æŸ“çš„  children: node.tagType === ElementTypes.TEMPLATE \u0026amp;\u0026amp; !findDir(node, \u0026#39;for\u0026#39;) ? node.children : [node], // å¯¹äº v-for, v-if/... éƒ½åº”è¯¥ç»™å®ƒä¸ª key, è¿™é‡Œæ˜¯ç”¨æˆ·ç¼–å†™æ˜¯çš„æä¾›çš„å”¯ä¸€ key  // å¦‚æœæ²¡æœ‰è§£æå™¨ä¼šé»˜è®¤ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ key  userKey: findProp(node, `key`) } }     æ³¨æ„çœ‹æœ€åä¸€ä¸ªå±æ€§ï¼Œ v-if åˆ†æ”¯ä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ª key å±æ€§çš„ã€‚\n    44985b4 v-if transform createIfBranch   feat: v-if createIfBranch Â· gcclll/stb-vue-next@44985b4\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  export function createConditionalExpression( test: ConditionalExpression[\u0026#39;test\u0026#39;], consequent: ConditionalExpression[\u0026#39;consequent\u0026#39;], alternate: ConditionalExpression[\u0026#39;alternate\u0026#39;], newline = true ) { return { type: NodeTypes.JS_CONDITIONAL_EXPRESSION, test, consequent, alternate, newline, loc: locStub } }     è¿™é‡Œçš„ç»“æ„(v-if)åœ¨ render å‡½æ•°ä¸­çš„å¯¹åº”å…³ç³»ï¼š\n test ? consequent : alternate\n å¦‚æœæœ‰ v-else-if æ—¶å€™ï¼Œ alternate ç»“æ„ä¼šæ˜¯ä¸ªå®Œæ•´çš„ JS_CONDITIONAL_EXPRESSION ï¼Œå³ï¼š alternate: { test, consequent, alternate, ...} æ‰€ä»¥ï¼š\n test ? consequent : test1 ? consequent 1 : alternate\n fix: no v-if transform Â· gcclll/stb-vue-next@1e24eb7\n åˆ°è¿™é‡Œ v-if æŒ‡ä»¤ transform é˜¶æ®µå·²ç»å®Œæˆï¼Œæµ‹è¯•ç»“æœï¼š\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code, ast } = baseCompile(`\u0026lt;div v-if=\u0026#34;ok\u0026#34;/\u0026gt;`) console.log(`\u0026gt;\u0026gt;\u0026gt; ast.codegenNode ç»“æœ`) console.log(ast.codegenNode)    \u0026gt;\u0026gt;\u0026gt; ast.codegenNode ç»“æœ { type: 9, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 17, line: 1, offset: 16 }, source: \u0026#39;\u0026lt;div v-if=\u0026#34;ok\u0026#34;/\u0026gt;\u0026#39; }, branches: [ { type: 10, loc: [Object], condition: [Object], children: [Array], userKey: undefined } ], codegenNode: { type: 19, test: { type: 4, content: \u0026#39;ok\u0026#39;, isStatic: false, isConstant: false, loc: [Object] }, consequent: { type: 13, tag: \u0026#39;\u0026#34;div\u0026#34;\u0026#39;, props: [Object], children: undefined, patchFlag: undefined, dynamicProps: undefined, directives: undefined, isBlock: true, disableTracking: false, loc: [Object] }, alternate: { type: 14, loc: [Object], callee: Symbol(createCommentVNode), arguments: [Array] }, newline: true, loc: { source: \u0026#39;\u0026#39;, start: [Object], end: [Object] } } } undefined   +RESULTS: é”™è¯¯ç»“æœ\nconst _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { key: 0 })) } } \u0026gt;\u0026gt;\u0026gt; ast.codegenNode ç»“æœ { type: 13, tag: \u0026#39;\u0026#34;div\u0026#34;\u0026#39;, props: { type: 15, loc: { source: \u0026#39;\u0026#39;, start: [Object], end: [Object] }, properties: [ [Object] ] }, children: undefined, patchFlag: undefined, dynamicProps: undefined, directives: undefined, isBlock: true, disableTracking: false, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 17, line: 1, offset: 16 }, source: \u0026#39;\u0026lt;div v-if=\u0026#34;ok\u0026#34;/\u0026gt;\u0026#39; } } undefined   ç»“æœæ˜¾ç¤ºæ˜¯ä¸å¯¹çš„ï¼Œå› ä¸ºåˆ›å»ºçš„ IF ç»“æ„æ²¡æœ‰æ›¿æ¢ ast ğŸŒ²ä¸­åŸæ¥çš„èŠ‚ç‚¹ï¼Œè¿½è¸ªåå‘ç°æ˜¯ æ¼æ‰äº† context.replaceNode(node) çš„å®ç°ã€‚\n fix: v-if codegenNode is incorrect Â· gcclll/stb-vue-next@47c30d2\n traverseNode ä¸­éœ€è¦å¢åŠ  case 9,IF åˆ†æ”¯å¤„ç†ï¼Œéå†æ‰€æœ‰çš„ branches[] ã€‚\n fix: v-if branches no codegenNode Â· gcclll/stb-vue-next@179f06f\n  742757e v-if generator   feat: v-if generator Â· gcclll/stb-vue-next@742757e\n genNode å¢åŠ  JS_CONDITIONAL_EXPRESSION åˆ†æ”¯å¤„ç†(genConditionalExpression)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function genConditionalExpression( node: ConditionalExpression, context: CodegenContext ) { const { test, consequent, alternate, newline: needNewline } = node const { push, indent, deindent, newline } = context if (test.type === NodeTypes.SIMPLE_EXPRESSION) { // éç®€å•çš„æ ‡è¯†ç¬¦éœ€è¦ç”¨æ‹¬å·ï¼Œå¯èƒ½æ˜¯è¡¨è¾¾å¼ï¼Œæ‰€ä»¥éœ€è¦ (a + b) ? ... : ...  const needsParams = !isSimpleIdentifier(test.content) needsParams \u0026amp;\u0026amp; push(`(`) genExpression(test, context) needsParams \u0026amp;\u0026amp; push(`)`) } else { push(`(`) genNode(test, context) push(`)`) } needNewline \u0026amp;\u0026amp; indent() context.indentLevel++ needNewline || push(` `) push(`? `) genNode(consequent, context) context.indentLevel-- needNewline \u0026amp;\u0026amp; newline() needNewline || push(` `) push(`: `) const isNested = alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION if (!isNested) { // ä¸æ˜¯åµŒå¥—  context.indentLevel++ } genNode(alternate, context) if (!isNested) { context.indentLevel-- } needNewline \u0026amp;\u0026amp; deindent(true /* without newline */) }     genConditionalExpression å¤„ç†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†\n  test ç”Ÿæˆæ¡ä»¶è¡¨è¾¾å¼ï¼Œè¿™é‡Œæ˜¯: ok ï¼Œå¦‚æœæ˜¯è¡¨è¾¾å¼éœ€è¦æ‹¬å·ï¼š (a + b)\n  consequent ç”¨æ¥ç”Ÿæˆ ? åé¢çš„è¡¨è¾¾å¼ï¼Œå³ ok ç»“æœä¸º truth æ—¶æ‰§è¡Œ\n  alternate ç”¨æ¥ç”Ÿæˆ : åé¢çš„è¡¨è¾¾å¼ï¼Œå³ ok ç»“æœä¸º falsy æ—¶æ‰§è¡Œ\n alternate ä¸­çš„ç»“æ„å¯èƒ½ä¹Ÿæ˜¯ä¸ª JS_CONDITIONAL_EXPRESSION ç»“æ„ï¼Œä»£è¡¨å¯èƒ½æœ‰ v-else-if åˆ†æ”¯ï¼Œå¦‚ï¼š (a + b) ? node1 : (c + d) ? node2 : othernode ã€‚\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const c = ( tpl, desc ) =\u0026gt; { console.log(`\u0026gt;\u0026gt;\u0026gt; ` + desc) const { code } = baseCompile(tpl, { hoistStatic: true }) console.log(code) } c(`\u0026lt;div v-if=\u0026#34;ok\u0026#34;/\u0026gt;`, \u0026#39;basic v-if\u0026#39;) c(`\u0026lt;template v-if=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;div/\u0026gt;hello\u0026lt;p/\u0026gt;\u0026lt;/template\u0026gt;`, \u0026#39;template v-if\u0026#39;)    \u0026gt;\u0026gt;\u0026gt; basic v-if const _Vue = Vue const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue const _hoisted_1 = { key: 0 } return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue return ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) } } \u0026gt;\u0026gt;\u0026gt; template v-if const _Vue = Vue const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode } = _Vue const _hoisted_1 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, null, null, -1 /* HOISTED */) const _hoisted_2 = /*#__PURE__*/_createTextVNode(\u0026#34;hello\u0026#34;) const _hoisted_3 = /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, null, -1 /* HOISTED */) return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, createTextVNode : _createTextVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue return ok ? (_openBlock(), _createBlock(_Fragment, { key: 0 }, [ _hoisted_1, _hoisted_2, _hoisted_3 ], 64 /* STABLE_FRAGMENT */)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) } } undefined   BUG: è¿™é‡Œå±…ç„¶å°‘äº†ä¸ª _hoisted_2 ???\n1 2 3 4 5  [ _hoisted_1, , _hoisted_3 ]     ç­”ï¼š genNode() ä¸­ç¼ºå°‘å¯¹ 4,TEXT_CALL çº¯æ–‡æœ¬ç±»å‹å¤„ç†ã€‚\n è§£ï¼šfix: v-if TEXT_CALL gen node Â· gcclll/stb-vue-next@2372b5f\næ›´å¤šæµ‹è¯•ç”¨ä¾‹(\u0026lt;f12\u0026gt;)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -\u0026gt;\u0026gt; ã€‚\n  l1(`v-if æŒ‡ä»¤`) compile(``, 'basic v-if') compile(`hello`, 'template v-if') compile(``, 'component v-if')    fa77b51 v-else/v-else-if   feat(add): v-else Â· gcclll/stb-vue-next@fa77b51\n ä¿®æ”¹ç‚¹ï¼š\n  processCodegen() å‡½æ•°é‡Œé¢å¢åŠ åˆ†æ”¯å¤„ç†\n è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹: getParentCondition() ä¼šä¸€ç›´æŸ¥æ‰¾ JS_CONDITIONAL_EXPRESSION ç±»å‹èŠ‚ç‚¹çš„ alternate ï¼Œå¦‚æœå®ƒä¾æ—§æ˜¯ä¸ª JS_CONDITIONAL_EXPRESSION ç±»å‹ï¼Œè¯´æ˜æ˜¯å¤šçº§çš„ if/else æ¡ä»¶è¯­å¥ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ åä¸€ä¸ªä¸æ˜¯ä¸ºæ­¢ã€‚\n ç›¸å½“äº ï¼š c1 ? cons1 : c2 ? cons2 : c3 ? cons3 : alt ä¼šä¸€ç›´ä» c1 èŠ‚ç‚¹å¼€å§‹ æŸ¥æ‰¾ç›´åˆ°æ‰¾åˆ°æœ€åçš„é‚£ä¸ª alt èŠ‚ç‚¹ä¸ºæ­¢ï¼Œç„¶åå°†æ–°çš„åˆ†æ”¯æŒ‚åˆ° alt åé¢ç»„ç»‡æˆæ–° çš„åˆ†æ”¯: c1 ? cons1 : c2 ? cons2 : c3 ? cons3 : c4 ? cons4 : newalt\nPS: c1, c2, c3, c4 åˆ†åˆ«ä»£è¡¨åˆ†æ”¯èŠ‚ç‚¹çš„ test ï¼Œæœ€åè¿½åŠ çš„ c4 ? cons4 : newalt ä¸‰ä¸ªå¯¹è±¡éƒ½å±äºæ–°åŠ çš„èŠ‚ç‚¹ï¼Œ {test -\u0026gt; c4, cons4 -\u0026gt; consequent, alternate -\u0026gt; newalt }\n   processIf() é‡Œå¢åŠ åˆ†æ”¯å¤„ç†\n æ–°å¢ä»£ç é‡Œæœ‰ä¸ª while å¾ªç¯å»ä»å½“å‰çš„åˆ†æ”¯èŠ‚ç‚¹å¼€å§‹åœ¨å®ƒçš„å…„å¼ŸèŠ‚ç‚¹é‡Œé¢å¾€å›æ‰¾ï¼Œç›´ åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ª 9,IF èŠ‚ç‚¹ï¼Œè¿™ä¸­é—´ä¸å…è®¸å‡ºç°å…¶ä»–æœ‰æ•ˆèŠ‚ç‚¹(é™¤æ³¨é‡Šï¼Œç©ºæ–‡æœ¬èŠ‚ç‚¹å¤–)ï¼Œ å› ä¸º v-if/else æŒ‡ä»¤èŠ‚ç‚¹å¿…é¡»ç´§é ç€ã€‚\n æ‰¾åˆ°ä¹‹åï¼Œè¦å°†å½“å‰åˆ†æ”¯èŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶ä¸”åŒæ—¶è¦å»æ‰‹åŠ¨ traverseNode(branch) ä¸€æ¬¡ï¼Œ å› ä¸ºä»–åœ¨åŸæ¥çš„ ast æ ‘ç§åˆ é™¤äº†ï¼Œæ‰€ä»¥åŸæ¥çš„ traverse è¿›ç¨‹ä¸ä¼šéå†å®ƒï¼Œå› æ­¤éœ€è¦æ‰‹ åŠ¨æ‰§è¡Œ traverse å»å¤„ç†å®ƒåŠå…¶å­©å­èŠ‚ç‚¹ç”Ÿæˆå¯¹åº”çš„ codegenNode ã€‚\n ç„¶åå°†å…¶ push åˆ° 9,IF èŠ‚ç‚¹çš„ node.branches é‡Œé¢ä½œä¸ºåˆ†æ”¯ã€‚\n  isSameKey(a,b) æ–°å¢ï¼Œæ£€æµ‹ä¸¤ä¸ª key å±æ€§æ˜¯ä¸æ˜¯ç›¸åŒ\n å‡ ç§åˆ¤å®šä¸ºä¸ç›¸åŒçš„æ¡ä»¶ï¼š\n  key ç±»å‹ä¸åŒ (a.type !== b.type)\n  key å€¼ä¸åŒ (a.value.content !== b.value.content)\n  key å¦‚æœæ˜¯æŒ‡ä»¤ç±»å‹ï¼Œæ£€æµ‹è¡¨è¾¾å¼ç±»å‹ï¼Œé™æ€å±æ€§å¼‚åŒ(isStatic)\n    getParentCondition() æ–°å¢ï¼Œé€’å½’ 9ï¼ŒIF èŠ‚ç‚¹çš„ node.alternate.alternate.alternate... ç›´åˆ°æ‰¾åˆ° alternate ä¸æ˜¯ JS_CONDITIONAL_EXPRESSION çš„æƒ…å†µ\n   FIX: fix: v-else current node dont removed Â· gcclll/stb-vue-next@464d681\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;div v-if=\u0026#34;ok\u0026#34;/\u0026gt;\u0026lt;p v-else/\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue return ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { key: 0 })) : (_openBlock(), _createBlock(\u0026#34;p\u0026#34;, { key: 1 })) } } undefined  æ›´å¤šæµ‹è¯•(\u0026lt;f12\u0026gt;)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -\u0026gt;\u0026gt; ã€‚\n  compile(``, 'v-if + v-else') compile(`hello`, 'template v-if') compile(``, 'v-if + v-else-if') compile(`fine`, 'v-if + v-else-if + v-else') compile(`   fine `, 'comment between branches') l1(`with prefixIdentifiers ... TODO`) l1(`errors`) compile(``, `æ²¡æœ‰åŒ¹é…çš„ v-if`) compile(``, `, æ²¡æœ‰åŒ¹é…çš„ v-if`) compile(``, `, ç›¸åŒçš„ key` ) log.red(`ä¸å…è®¸ä¸åŒåˆ†æ”¯ä½¿ç”¨ç›¸ä¼¼çš„ keyï¼Œå› ä¸º key æ˜¯æŒ‡ä»¤å±æ€§ï¼Œå› æ­¤ä¼šå¯¹æ¯”å®ƒçš„ç±»å‹åŠè¡¨è¾¾å¼`) l1(`v-on with v-if`) compile(`w/ v-if`, 'v-if ä¸Šä½¿ç”¨ v-on æŒ‡ä»¤') log.blue(`å› ä¸ºè¿™é‡Œç”¨çš„æ˜¯æ— å‚æ•°çš„ v-on æ‰€ä»¥ä¼šå¯¼è‡´æ‰€æœ‰å±æ€§è¢«åˆå¹¶(_mergeProps(...))ã€‚`)   BUG: v-else-if è¢«è§£ææˆäº† else å› ä¸º parser é˜¶æ®µåŒ¹é…æ­£åˆ™ä¸å¯¹ã€‚ fix: parser v-else-if failed Â· gcclll/stb-vue-next@5b83d1c\n    6c82066 add v-for transform   feat(init): v-for Â· gcclll/stb-vue-next@3a1662e\n feat: v-for directive Â· gcclll/stb-vue-next@6c82066\n v-for æŒ‡ä»¤å®ç°è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„å‡ ä¸ªå‡½æ•°ï¼š\n  transformFor() æœ€ç»ˆç”Ÿæˆçš„ tranformXxx å‡½æ•°\n  createStructuralDirectiveTransform() åŒ v-if æŒ‡ä»¤\n  processFor() å¤„ç† v-for æŒ‡ä»¤å…¥å£\n  processCodegen() åŒ v-if ç”¨æ¥ç”Ÿæˆ codegenNode çš„å‡½æ•°\n  parseForExpression() å°† v-for=\u0026#34;item in items\u0026#34; è¡¨è¾¾å¼è§£ææˆ ForParseResult{source, value, key, index} ç±»å‹ AST ã€‚\n  createAliasExpression() ç»™ value, key, index åˆ›å»º SIMPLE_EXPRESSION ç±»å‹ ç»“æ„ã€‚\n  createForLoopParams() åˆ›å»º _renderList å‡½æ•°å›è°ƒçš„å‚æ•° [value, key, index] ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨é»˜è®¤å˜é‡ï¼š _ æˆ– __ ï¼Œå¦‚ï¼š (_, __, index)\n   å…¶ä¸­ parseForExpression() å‡½æ•°æ˜¯è§£æ v-for è¡¨è¾¾å¼çš„æ ¸å¿ƒå‡½æ•°ï¼Œé‡Œé¢ä½¿ç”¨äº†ä¸‰ä¸ª æ­£åˆ™ï¼Œç”¨æ¥åŒ¹é…æŒ‡ä»¤è¡¨è¾¾å¼ï¼š\n  const forAliasRE = /([\\s\\S]*?)\\s+(?:in|of)\\s+([\\s\\S]*)/\n  åŒ¹é… v-for=\u0026#34;item in items\u0026#34; ä¸­çš„å€¼éƒ¨åˆ†\n1 2 3 4 5 6 7 8  const re = /([\\s\\S]*?)\\s+(?:in|of)\\s+([\\s\\S]*)/ const log = (params) =\u0026gt; console.log(params.map((p, i) =\u0026gt; `${i}, ${p}`).join(`\\n`)) log.title = console.log log.title(`\u0026gt;\u0026gt;\u0026gt; åŒ¹é… item in items`) log(\u0026#34;item in items\u0026#34;.match(re)) log.title(`\u0026gt;\u0026gt;\u0026gt; åŒ¹é… (item, key) in items`) log(\u0026#34;( item, key ) in items\u0026#34;.match(re))    \u0026gt;\u0026gt;\u0026gt; åŒ¹é… item in items 0, item in items 1, item 2, items \u0026gt;\u0026gt;\u0026gt; åŒ¹é… (item, key) in items 0, ( item, key ) in items 1, ( item, key ) 2, items undefined    const forIteratorRE = /,([^,\\}\\]]*)(?:,([^,\\}\\]]*))?$/\n  è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ç”¨æ¥åŒ¹é… (item, key) in items ä¸­çš„ item å’Œ key\n1 2 3 4 5 6 7 8  const re = /,([^,\\}\\]]*)(?:,([^,\\}\\]]*))?$/ const log = (params) =\u0026gt; console.log(params.map((p, i) =\u0026gt; `${i}, ${p}`).join(`\\n`)) log.title = console.log log.title(`\u0026gt;\u0026gt;\u0026gt; åŒ¹é… \u0026#39;item, key, index\u0026#39; ä¸­çš„ key å’Œ index`) log(\u0026#34;item, key, index\u0026#34;.match(re)) log.title(`\u0026gt;\u0026gt;\u0026gt; åŒ¹é… \u0026#34;item, key\u0026#34; ä¸­çš„ key`) log(\u0026#34;item, key\u0026#34;.match(re))    \u0026gt;\u0026gt;\u0026gt; åŒ¹é… \u0026#39;item, key, index\u0026#39; ä¸­çš„ key å’Œ index 0, , key, index 1, key 2, index \u0026gt;\u0026gt;\u0026gt; åŒ¹é… \u0026#34;item, key\u0026#34; ä¸­çš„ key 0, , key 1, key 2, undefined undefined    const stripParensRE = /^\\(|\\)$/g è¿™ä¸ªç”¨æ¥åŒ¹é… (item, key, index) å‰åæ‹¬å·\n   parseForExpression() æ ¸å¿ƒå®ç°ï¼š\n  source æ•°æ®æºï¼Œ forAliasRE åŒ¹é…åçš„ RHS å€¼\n1 2 3 4 5 6 7  source: { type: 4, // SIMPLE_EXPRESSION loc: { source: \u0026#39;obj\u0026#39;, start: [Object], end: [Object] }, isConstant: false, content: \u0026#39;obj\u0026#39;, isStatic: false }      value çš„å–å€¼ï¼Œåœ¨ AST ä¸­å¯¹åº” valueAlias\n valueContent = valueContent.replace(forIteratorRE, \u0026#39;\u0026#39;).trim()\n é€šè¿‡åŒ¹é… key, index çš„æ­£åˆ™ï¼Œåå‘æ›¿æ¢å¾—åˆ° value\n1 2 3 4  const re = /,([^,\\}\\]]*)(?:,([^,\\}\\]]*))?$/ console.log(`item, key, index`.replace(re, \u0026#39;\u0026#39;).trim()) console.log(`\u0026gt;\u0026gt;\u0026gt; æ”¯æŒè§£æ„`) console.log(`[ id, value ], key, index`.replace(re, \u0026#39;\u0026#39;).trim())    item \u0026gt;\u0026gt;\u0026gt; æ”¯æŒè§£æ„ [ id, value ] undefined   è§£æåçš„ç»“æ„ï¼š\n1 2 3 4 5 6 7  valueAlias: { type: 4, // SIMPLE_EXPRESSION loc: { source: \u0026#39;value\u0026#39;, start: [Object], end: [Object] }, isConstant: false, content: \u0026#39;value\u0026#39;, isStatic: false }      key å–å€¼å¤„ç†ï¼Œåœ¨ AST ä¸­å¯¹åº” keyAlias\n1 2 3 4 5 6 7  keyAlias: { type: 4, loc: { source: \u0026#39;key\u0026#39;, start: [Object], end: [Object] }, isConstant: false, content: \u0026#39;key\u0026#39;, isStatic: false }      index å–å€¼å¤„ç†ï¼Œåœ¨ ASTä¸­å¯¹åº” objectIndexAlias\n1 2 3 4 5 6 7  objectIndexAlias: { type: 4, loc: { source: \u0026#39;index\u0026#39;, start: [Object], end: [Object] }, isConstant: false, content: \u0026#39;index\u0026#39;, isStatic: false }       æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { ast } = baseCompile(`\u0026lt;span v-for=\u0026#34;(value, key, index) in obj\u0026#34; /\u0026gt;`) const { source, valueAlias, keyAlias, objectIndexAlias, type } = ast.codegenNode console.log(`type: ${type}`) console.log(`\u0026gt;\u0026gt;\u0026gt; æ•°æ®æº`) console.log(source) console.log(`\u0026gt;\u0026gt;\u0026gt; value`) console.log(valueAlias) console.log(`\u0026gt;\u0026gt;\u0026gt; key`) console.log(keyAlias) console.log(`\u0026gt;\u0026gt;\u0026gt; index`) console.log(objectIndexAlias) console.log(`\u0026gt;\u0026gt;\u0026gt; _renderList(obj, (value, key, index) =\u0026gt; {...}) ç¬¬äºŒä¸ªå‚æ•°`) console.log(ast.codegenNode.codegenNode.children.arguments[1])    type: 11 \u0026gt;\u0026gt;\u0026gt; æ•°æ®æº { type: 4, loc: { source: \u0026#39;obj\u0026#39;, start: { column: 37, line: 1, offset: 36 }, end: { column: 40, line: 1, offset: 39 } }, isConstant: false, content: \u0026#39;obj\u0026#39;, isStatic: false } \u0026gt;\u0026gt;\u0026gt; value { type: 4, loc: { source: \u0026#39;value\u0026#39;, start: { column: 15, line: 1, offset: 14 }, end: { column: 20, line: 1, offset: 19 } }, isConstant: false, content: \u0026#39;value\u0026#39;, isStatic: false } \u0026gt;\u0026gt;\u0026gt; key { type: 4, loc: { source: \u0026#39;key\u0026#39;, start: { column: 22, line: 1, offset: 21 }, end: { column: 25, line: 1, offset: 24 } }, isConstant: false, content: \u0026#39;key\u0026#39;, isStatic: false } \u0026gt;\u0026gt;\u0026gt; index { type: 4, loc: { source: \u0026#39;index\u0026#39;, start: { column: 27, line: 1, offset: 26 }, end: { column: 32, line: 1, offset: 31 } }, isConstant: false, content: \u0026#39;index\u0026#39;, isStatic: false } \u0026gt;\u0026gt;\u0026gt; _renderList(obj, (value, key, index) =\u0026gt; {...}) ç¬¬äºŒä¸ªå‚æ•° { type: 18, // JS_FUNCTION_EXPRESSION params: [ { type: 4, loc: [Object], isConstant: false, content: \u0026#39;value\u0026#39;, isStatic: false }, { type: 4, loc: [Object], isConstant: false, content: \u0026#39;key\u0026#39;, isStatic: false }, { type: 4, loc: [Object], isConstant: false, content: \u0026#39;index\u0026#39;, isStatic: false } ], returns: { type: 13, tag: \u0026#39;\u0026#34;span\u0026#34;\u0026#39;, props: undefined, children: undefined, patchFlag: undefined, dynamicProps: undefined, directives: undefined, isBlock: true, disableTracking: false, loc: { start: [Object], end: [Object], source: \u0026#39;\u0026lt;span v-for=\u0026#34;(value, key, index) in obj\u0026#34; /\u0026gt;\u0026#39; } }, newline: true, isSlot: false, loc: { source: \u0026#39;\u0026#39;, start: { line: 1, column: 1, offset: 0 }, end: { line: 1, column: 1, offset: 0 } } } undefined    39a20fe add v-for generator   feat(add): v-for generator Â· gcclll/stb-vue-next@39a20fe\n codegen é˜¶æ®µæ–°å¢å¯¹åº”çš„å®ç°ï¼š 18,JS_FUNCTION_EXPRESSION\n è¿™ä¸ªä¸»è¦æ˜¯ç”¨æ¥è§£æ _renderList(source, (value, key, index) =\u0026gt; { ... }) å‡½æ•°çš„ ç¬¬äºŒä¸ªå‚æ•°çš„ï¼Œè¿™æ˜¯ä¸ªç”¨æ¥ render åˆ—è¡¨é¡¹çš„å‡½æ•°ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(\u0026#39;\u0026lt;span v-for=\u0026#34;(item) in items\u0026#34; /\u0026gt;\u0026#39;) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { renderList : _renderList, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock, createVNode : _createVNode } = _Vue return (_openBlock(true), _createBlock(_Fragment, null, _renderList(items, (item) =\u0026gt; { return (_openBlock(), _createBlock(\u0026#34;span\u0026#34;)) )), 256 /* UNKEYED_FRAGMENT */)) } } undefined   æ›´å¤šæµ‹è¯•ç”¨ä¾‹è¯· \u0026lt;f12\u0026gt; æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ã€‚\n  l1(`v-for directive`) compile(``, `basic v-for`) compile('', 'value + key + index') compile('', `skipped value`) compile('', `skipped key`) compile('', `skipped value \u0026 key`) compile('{{item}}\n', `v-for with constant expression`) compile(`hello`, `template v-for`) compile('', `template v-for w/ `) log.red(`TODO  å¾…å®Œæˆ......`) compile('', `template v-for key injection with single child`) compile('', `v-for on `) log.red(`TODO  å¾…å®Œæˆ......`) compile('', `keyed v-for`) compile('hello', `keyed template v-for`) compile(``, `v-if + v-for`) compile(``, 'v-if + v-for on ') compile('', `v-for on element with custom directive`)    7cb8908 add slot outlet transform   feat(add): v-slot transform Â· gcclll/stb-vue-next@7cb8908\n transform \u0026lt;slot /\u0026gt; æ ‡ç­¾ã€‚\n \u0026lt;slot/\u0026gt; åœ¨ render å‡½æ•°ä¸­æ˜¯ä»¥ _renderSlot($slot, name, props, children) å½¢å¼å­˜åœ¨ã€‚\n\u0026lt;slot\u0026gt; ä¸Šä¸å…è®¸è‡ªå®šä¹‰çš„æŒ‡ä»¤å­˜åœ¨ï¼Ÿ\n  ç›¸å…³å‡½æ•°/å‚æ•°ï¼š\n  transformSlotOutlet() è¯¥é˜¶æ®µçš„ tranformXxx å‡½æ•°\n  SlotOutletProcessResult ç±»å‹å®šä¹‰ {slotName, slotProps}\n  processSlotOutlet(), \u0026lt;slot/\u0026gt; çš„å¤„ç†è¿‡ç¨‹\n é¦–å…ˆæ˜¯è§£ææ’æ§½åç§°(name å±æ€§)ï¼Œè¯¥å±æ€§å¯ä»¥æ˜¯åŠ¨æ€(\u0026lt;slot :name=\u0026#34;myslot\u0026#34;/\u0026gt;)ä¹Ÿ å¯ä»¥æ˜¯é™æ€çš„(\u0026lt;slot name=\u0026#34;myslot\u0026#34;/\u0026gt;)ã€‚\n ç„¶åè§£æå‡ºæ’æ§½ä¸Šå®šä¹‰çš„ä¸€äº›å±æ€§(é™æ€)ï¼Œé™¤äº† :name ä¹‹å¤–æ’æ§½ä¸Š ä¸å…è®¸æœ‰å…¶ä»–çš„ æŒ‡ä»¤ç±»å‹çš„å±æ€§å­˜åœ¨ ã€‚\n  children å‚æ•°\n \u0026lt;slot\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;p/\u0026gt;\u0026lt;/slot\u0026gt;\n åœ¨ \u0026lt;slot\u0026gt; æ ‡ç­¾å†…çš„æ‰€æœ‰å…ƒç´ (\u0026lt;div/\u0026gt;\u0026lt;p/\u0026gt;)ä¼šè¢«è§£ææˆ _renderSlot çš„ç¬¬å››ä¸ªå‚æ•°ã€‚\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { ast } = baseCompile(`\u0026lt;slot/\u0026gt;`) console.log(ast.codegenNode)    { type: 1, ns: 0, tag: \u0026#39;slot\u0026#39;, tagType: 2, props: [], isSelfClosing: true, children: [], loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 8, line: 1, offset: 7 }, source: \u0026#39;\u0026lt;slot/\u0026gt;\u0026#39; }, codegenNode: { type: 14, // JS_CALL_EXPRESSION loc: { start: [Object], end: [Object], source: \u0026#39;\u0026lt;slot/\u0026gt;\u0026#39; }, callee: Symbol(renderSlot), arguments: [ \u0026#39;$slots\u0026#39;, \u0026#39;\u0026#34;default\u0026#34;\u0026#39; ] } } undefined   æ›´å¤š codegenNode ç»“æœè¯· \u0026lt;f12\u0026gt; æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ã€‚\n  l1(` æ’æ§½ transform é˜¶æ®µ`) const _a = ast = [`_renderSlot å‚æ•°åˆ—è¡¨ï¼š` , ast.children[0].codegenNode.arguments ] const c1 = (tpl, desc, ast = _a) = compile.call(null, tpl, desc, ast) c1(``, `default slot outlet`) c1(``, `statically named slot outletï¼Œå«é™æ€åå­—`) c1(``, `dynamically named slot outlet, å«åŠ¨æ€åå­—`) c1(``, `TODO dynamically named slot outlet w/ prefixIdentifiers: true`) c1(``, `default slot outlet with propsï¼Œé»˜è®¤æ’æ§½+é™åŠ¨æ€å±æ€§`) c1(``, `statically named slot outlet with propsï¼Œé™æ€å…·åæ’æ§½+å…¶ä»–é™åŠ¨æ€å±æ€§`) c1(``, `dynamically named slot outlet with propsï¼ŒåŠ¨æ€å…·åæ’æ§½+å…¶ä»–é™åŠ¨æ€å±æ€§`) c1(``, `default slot outlet with fallback`) c1(``, `named slot outlet with fallback`) c1(``, `default slot outlet with props \u0026 fallback`) c1(``, `named slot outlet with props \u0026 fallback`) c1(``, `error on unexpected custom directive on ï¼Œä¸å…è®¸æœ‰è‡ªå®šä¹‰æŒ‡ä»¤ï¼Ÿ`)  ebdb1ed add track slot scopes   feat: add track slot scopes Â· gcclll/stb-vue-next@ebdb1ed\n è¿˜ä¸çŸ¥é“å¹²å—çš„â“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  // A NodeTransform that: // 1. Tracks scope identifiers for scoped slots so that they don\u0026#39;t get prefixed // by transformExpression. This is only applied in non-browser builds with // { prefixIdentifiers: true }. // 2. Track v-slot depths so that we know a slot is inside another slot. // Note the exit callback is executed before buildSlots() on the same node, // so only nested slots see positive numbers. export const trackSlotScopes: NodeTransform = (node, context) =\u0026gt; { // \u0026lt;component\u0026gt; or \u0026lt;template\u0026gt;  if ( node.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; (node.tagType === ElementTypes.COMPONENT || node.tagType === ElementTypes.TEMPLATE) ) { // We are only checking non-empty v-slot here  // since we only care about slots that introduce scope variables.  const vSlot = findDir(node, \u0026#39;slot\u0026#39;) if (vSlot) { const slotProps = vSlot.exp if (!__BROWSER__ \u0026amp;\u0026amp; context.prefixIdentifiers) { slotProps \u0026amp;\u0026amp; context.addIdentifiers(slotProps) } context.scopes.vSlot++ return () =\u0026gt; { if (!__BROWSER__ \u0026amp;\u0026amp; context.prefixIdentifiers) { slotProps \u0026amp;\u0026amp; context.removeIdentifiers(slotProps) } context.scopes.vSlot-- } } } }        36c1f36 (v-slot)build user component as slots   ç»„ä»¶æ˜¯å¦‚ä½•å½“åš slot å¤„ç†çš„\n feat(add): user component treat as slot to build Â· gcclll/stb-vue-next@36c1f36\n å®Œæ•´ç”¨æˆ·ç»„ä»¶å½“ slot å¤„ç†æµç¨‹å›¾ï¼š  \u0026lt;Comp\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt;\n è¿™é‡Œ Comp æ˜¯ç»„ä»¶ç±»å‹(tagType=1,COMPONENT) ä¼šåœ¨ transformElement ä¸­è¢«å½“åš slot æ¥å¤„ç†è°ƒç”¨ buildSlots() ã€‚\næ›´å¤šæµ‹è¯•ç”¨ä¾‹(\u0026lt;f12\u0026gt;)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -\u0026gt;\u0026gt; ã€‚\n  l1(`æ’æ§½ generator é˜¶æ®µ`) compile(``, 'implicit default slot') compile(`{{ foo }}{{ bar }}`, 'on-component default slot') compile(`{{ foo }}{{ bar }}`, 'on component named slot') compile(` {{ foo }}{{ bar }}  {{ foo }}{{ bar }}  `, 'template named slots') compile(`{{ foo }}{{ bar }}`, 'on component dynamically named slot') compile(` foobar `, 'named slots w/ implicit default slot') compile(` {{ foo }}{{ bar }}  {{ foo }}{{ bar }}  `, 'dynamically named slots') compile(` {{ foo }}{{ bar }}{{ baz }}  {{ foo }}{{ bar }}{{ baz }}  `, 'nested slots scoping') compile(`foo `, 'should force dynamic when inside v-for') l2(` TODO should only force dynamic slots when actually using scope vars w/ prefixIdentifiers: true`) compile(` hello `, 'named slot with v-if') l2(` TODO named slot with v-if + prefixIdentifiers: true`) compile(` foo bar baz `, 'named slot with v-if + v-else-if + v-else') l2(` TODO 'named slot with v-for w/ prefixIdentifiers: true'`) compile(` {{ name }} `, 'named slot with v-for') compile(``, 'å…·åæ’æ§½+å…¶ä»–é template å…ƒç´ å…¨å½“åšé»˜è®¤æ’æ§½å¤„ç†')  fbed5cf add component with default slot without \u0026lt;template\u0026gt; transform   feat(add): default slot without template Â· gcclll/stb-vue-next@fbed5cf\n \u0026lt;Comp\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt;\n è¿™ç§æƒ…å†µï¼Œç”¨æˆ·ç»„ä»¶ä¸Šæ—¢æ²¡æœ‰ v-slot å­©å­èŠ‚ç‚¹é‡Œé¢ä¹Ÿæ²¡æœ‰ \u0026lt;template v-slot\u0026gt; æœ€å çš„å¤„ç†æ˜¯ \u0026lt;Comp\u0026gt;\u0026lt;/Comp\u0026gt; é‡Œé¢çš„æ‰€æœ‰ children è¢«å½“åšé»˜è®¤æ’æ§½å¤„ç†ã€‚\n è¯¥ç¤ºä¾‹ç¬¦åˆï¼š\n  ç»„ä»¶ä¸Šæ²¡æœ‰ v-slot æŒ‡ä»¤\n  å­©å­èŠ‚ç‚¹é‡Œé¢æ²¡æœ‰ \u0026lt;template v-slot:name=\u0026#34;slotProps\u0026#34;\u0026gt;\n  å› æ­¤ï¼Œè¿™é‡Œçš„å¤„ç†æ˜¯å°† \u0026lt;div/\u0026gt; å³ comp.children å…¨éƒ¨ä½œä¸ºé»˜è®¤çš„ slot:default æ¥å¤„ç†ã€‚\n å¤„ç†æµç¨‹ï¼š \u0026lt;Comp\u0026gt; -\u0026gt; transformElement -\u0026gt; isComponent -\u0026gt; buildSlots() -\u0026gt; {slots, hasDynamicSlots} -\u0026gt; vnodeChildren -\u0026gt; {type: 13,VNODE_CALL, children: vnodeChildren, ... }\n1 2 3 4 5 6 7  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { ast } = baseCompile(`\u0026lt;Comp\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt;`) console.log(ast.codegenNode)    { type: 13, tag: \u0026#39;_component_Comp\u0026#39;, props: undefined, children: { type: 15, loc: { start: [Object], end: [Object], source: \u0026#39;\u0026lt;Comp\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt;\u0026#39; }, properties: [ [Object], [Object] ] }, patchFlag: undefined, dynamicProps: undefined, directives: undefined, isBlock: true, disableTracking: false, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 20, line: 1, offset: 19 }, source: \u0026#39;\u0026lt;Comp\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt;\u0026#39; } } undefined   å¦å¤–åœ¨ transformElement() å‡½æ•°ä¸­é€šè¿‡ isComponent = node.tagType === ElementTypes.COMPONENT æ£€æµ‹æ˜¯ä¸æ˜¯ç”¨æˆ·ç»„ä»¶ï¼Œå¦‚æœæ˜¯ç»§ç»­è§£æè¯¥ç»„ä»¶ç±»å‹(resolveComponentType())ã€‚\n è¿™é‡Œæœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯ï¼š vnodeTag = _component_Comp ä½œä¸ºæ ‡ç­¾åï¼Œä¹Ÿæ˜¯è¯¥ \u0026lt;Comp/\u0026gt; ç»„ä»¶åœ¨ Vue å®ä¾‹è¿‡ç¨‹ä¸­çš„å­˜åœ¨çš„æ ‡ç­¾å(ç»„ä»¶åç§°)ã€‚\n  8bed175 add component with default slot without \u0026lt;template\u0026gt; generator   feat(add): user component resolver generator Â· gcclll/stb-vue-next@8bed175\n å› ä¸ºåœ¨ transform é˜¶æ®µ transformElement è¿‡ç¨‹ä¸­ï¼Œæ£€æµ‹åˆ° \u0026lt;Comp\u0026gt; æ˜¯ä¸ªç”¨æˆ·ç»„ä»¶ï¼Œæ‰€ ä»¥å°†å…¶å¢åŠ åˆ°äº† context.components.add(\u0026#39;Comp\u0026#39;) ä¸­äº†ï¼Œåœ¨ generator é˜¶æ®µä¼šå»æ£€æµ‹ è¿™ä¸ª components ç”¨æ¥è§£æç»„ä»¶å¾—åˆ°ç»„ä»¶çš„å¼•ç”¨ï¼š\n _component_Comp = _resolveComponent(\u0026#34;Comp\u0026#34;)\n æ–°å¢çš„ä»£ç ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ï¼š\n  æ–°å¢ genAssets() å‡½æ•°å¤„ç† context.components\n å¤„ç†ä¹‹åçš„ç»“æœå°±æ˜¯å¢åŠ  _component_Comp = _resolveComponent(\u0026#34;Comp\u0026#34;)\n  åœ¨ generate() ä¸­å¢åŠ  ast.components æ£€æµ‹ï¼Œå¦‚æœæœ‰å†…å®¹è°ƒç”¨ genAssets() è§£ æ\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  // generate() ä¸­å¢åŠ   if (ast.components.length) { genAssets(ast.components, \u0026#39;component\u0026#39;, context) if (ast.directives.length || ast.temps \u0026gt; 0) { newline() } } // æ–°å¢ function genAssets( assets: string[], type: \u0026#39;component\u0026#39; | \u0026#39;directive\u0026#39;, { helper, push, newline }: CodegenContext ) { const resolver = helper( type === \u0026#39;component\u0026#39; ? RESOLVE_COMPONENT : RESOLVE_DIRECTIVE ) for (let i = 0; i \u0026lt; assets.length; i++) { const id = assets[i] push( `const ${toValidAssetId(id, type)}= ${resolver}(${JSON.stringify(id)})` ) if (i \u0026lt; assets.length - 1) { newline() } } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;Comp\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt;`, { hoistStatic: true }) console.log(code)    const _Vue = Vue const { createVNode: _createVNode } = _Vue const _hoisted_1 = /*#__PURE__*/_createVNode(\u0026#34;div\u0026#34;, null, null, -1 /* HOISTED */) return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, openBlock : _openBlock, createBlock : _createBlock } = _Vue const _component_Comp = _resolveComponent(\u0026#34;Comp\u0026#34;) return (_openBlock(), _createBlock(_component_Comp, null, { default: _withCtx(() =\u0026gt; [ _hoisted_1 ]), _: 1 })) } } undefined   ç¼ºå°‘ 1 /* STABLE */ æ³¨é‡Š: fix: slot flag text Â· gcclll/stb-vue-next@08a6fca\n æ³¨æ„ _createBlock() çš„ç¬¬ä¸‰ä¸ªå‚æ•°å˜æˆäº†ä¸€ä¸ªå¯¹è±¡(children) å¯¹è±¡é‡Œé¢åŒ…å«äº†ä¸¤ä¸ª å±æ€§: default å’Œ _ åˆ†åˆ«ä»£è¡¨äº†é»˜è®¤æ’æ§½ä¸‹çš„å­©å­èŠ‚ç‚¹ï¼Œå’Œè¯¥æ’æ§½æ ‡è¯†(1-STABLE,2-FORWARDED,3-DYNAMIC)\n  9f58154 fix: æ–‡æœ¬èŠ‚ç‚¹æ²¡æœ‰åˆå¹¶(transformText)   fix: adjacent text node need merge Â· gcclll/stb-vue-next@9f58154\n å¯¹äº `\u0026lt;Comp v-slot=\u0026#34;{ foo }\u0026#34;\u0026gt;{{ foo }}{{ bar }}\u0026lt;/Comp\u0026gt;` ç”¨ä¾‹å¾—åˆ°çš„ç»“æœéé¢„æœŸã€‚\n vue-next æ­£ç¡®ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11  const { baseCompile } = require(process.env.PWD + \u0026#39;/../../static/vue/vue.js\u0026#39;) const { ast } = baseCompile(`\u0026lt;Comp v-slot=\u0026#34;{ foo }\u0026#34;\u0026gt;{{ foo }}{{ bar }}\u0026lt;/Comp\u0026gt;`) const returns = ast.codegenNode.children.properties[0].value.returns console.log(returns) console.log(`\u0026gt;\u0026gt;\u0026gt; è§£æåçš„ {{ foo }} {{ bar }} åº”è¯¥åˆå¹¶`) console.log(returns[0].content) console.log(`\u0026gt;\u0026gt;\u0026gt; ä¸‹é¢æ­£æ˜¯åˆå¹¶ä¹‹åçš„ä¸¤ä¸ªæ’å€¼`) console.log(returns[0].content.children)    You are running a development build of Vue. Make sure to use the production build (*.prod.js) when deploying for production. [ { type: 12, content: { type: 8, loc: [Object], children: [Array] }, loc: { start: [Object], end: [Object], source: \u0026#39;{{ foo }}\u0026#39; }, codegenNode: { type: 14, loc: [Object], callee: Symbol(createTextVNode), arguments: [Array] } } ] \u0026gt;\u0026gt;\u0026gt; è§£æåçš„ {{ foo }} {{ bar }} åº”è¯¥åˆå¹¶ { type: 8, loc: { start: { column: 24, line: 1, offset: 23 }, end: { column: 33, line: 1, offset: 32 }, source: \u0026#39;{{ foo }}\u0026#39; }, children: [ { type: 5, content: [Object], loc: [Object] }, \u0026#39; + \u0026#39;, { type: 5, content: [Object], loc: [Object] } ] } \u0026gt;\u0026gt;\u0026gt; ä¸‹é¢æ­£æ˜¯åˆå¹¶ä¹‹åçš„ä¸¤ä¸ªæ’å€¼ [ { type: 5, content: { type: 4, isStatic: false, constType: 0, content: \u0026#39;foo\u0026#39;, loc: [Object] }, loc: { start: [Object], end: [Object], source: \u0026#39;{{ foo }}\u0026#39; } }, \u0026#39; + \u0026#39;, { type: 5, content: { type: 4, isStatic: false, constType: 0, content: \u0026#39;bar\u0026#39;, loc: [Object] }, loc: { start: [Object], end: [Object], source: \u0026#39;{{ bar }}\u0026#39; } } ] undefined   çœ‹ä¸‹ç°é˜¶æ®µ stb-vue-next è¾“å‡ºç»“æœï¼š\n1 2 3 4 5 6 7 8 9  const { baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { ast } = baseCompile(`\u0026lt;Comp v-slot=\u0026#34;{ foo }\u0026#34;\u0026gt;{{ foo }}{{ bar }}\u0026lt;/Comp\u0026gt;`) const returns = ast.codegenNode.children.properties[0].value.returns console.log(returns[0].content) console.log(returns[1].content)    { type: 5, content: { type: 4, isStatic: false, isConstant: false, content: \u0026#39;foo\u0026#39;, loc: { start: [Object], end: [Object], source: \u0026#39;foo\u0026#39; } }, loc: { start: { column: 24, line: 1, offset: 23 }, end: { column: 33, line: 1, offset: 32 }, source: \u0026#39;{{ foo }}\u0026#39; } } { type: 5, content: { type: 4, isStatic: false, isConstant: false, content: \u0026#39;bar\u0026#39;, loc: { start: [Object], end: [Object], source: \u0026#39;bar\u0026#39; } }, loc: { start: { column: 33, line: 1, offset: 32 }, end: { column: 42, line: 1, offset: 41 }, source: \u0026#39;{{ bar }}\u0026#39; } } undefined   stb-vue-next æ˜æ˜¾ returns é‡Œé¢åŒ…å«äº†ä¸¤ä¸ªå…ƒç´ åˆ†åˆ«æ˜¯ï¼š {{ foo }} å’Œ {{ bar }}\n è¿™æ˜¯å› ä¸ºåœ¨ transformText é‡Œé¢æ²¡æœ‰è¿›è¡Œæ–‡æœ¬(æ’å€¼ä¹Ÿç®—)åˆå¹¶ã€‚\n  0773374 add component nested slots scoping   fix: patchFlag should |= but != Â· gcclll/stb-vue-next@0773374\n æ’æ§½åµŒå¥—ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8  `\u0026lt;Comp\u0026gt; \u0026lt;template #default=\u0026#34;{ foo }\u0026#34;\u0026gt; \u0026lt;Inner v-slot=\u0026#34;{ bar }\u0026#34;\u0026gt; {{ foo }}{{ bar }}{{ baz }} \u0026lt;/Inner\u0026gt; {{ foo }}{{ bar }}{{ baz }} \u0026lt;/template\u0026gt; \u0026lt;/Comp\u0026gt;`     æ’æ§½åµŒå¥—ä½¿ç”¨æ—¶çš„è§£ææ˜¯å…ˆé‡Œåå¤–ï¼Œå› ä¸ºåœ¨ transform é˜¶æ®µ ast é˜¶æ®µè½¬æ¢ä¹‹åï¼Œä¼šè¿›è¡Œå› æº¯ï¼Œå›æº¯è¿‡ç¨‹æ˜¯ç›¸åçš„ã€‚\n å¦‚ï¼š\n ast ç»“æ„ transformï¼š\n Comp.children -\u0026gt; [template] -\u0026gt; template.children -\u0026gt; [Inner, foo, bar, baz] -\u0026gt; Inner.children -\u0026gt; [foo, bar, baz]\n astå›æº¯:\n Inner.children -\u0026gt; Inner -\u0026gt; template.children -\u0026gt; template -\u0026gt; Comp.children -\u0026gt; Comp\n æ‰€ä»¥é¦–å…ˆæ‰§è¡Œ transformElement() çš„æ˜¯ Inner æ‰€ä»¥å®ƒä¼šå…ˆè¿›å…¥ buildSlots() æ„ å»ºæ’æ§½ç»“æ„ï¼Œå®Œäº†ä¹‹åæ˜¯ \u0026lt;template\u0026gt; æœ€åæ˜¯ \u0026lt;Comp\u0026gt;\n  render æ¨å¯¼è¿‡ç¨‹ï¼š\n  \u0026lt;Inner v-slot=\u0026#34;{bar}\u0026#34;\u0026gt;{{foo}}{{bar}}{{baz}}\u0026lt;/Inner\u0026gt;\n æ˜¯åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šåº”ç”¨äº† v-slot ä¸”æ˜¯é»˜è®¤æ’æ§½ï¼Œå› æ­¤å®ƒçš„æ‰€æœ‰å­©å­èŠ‚ç‚¹éƒ½ä¼šæˆä¸ºé»˜è®¤ æ’æ§½ä¸€éƒ¨åˆ†ã€‚\n ç»“æœï¼š\n1 2 3 4 5 6  _createVNode(_component_Inner, null, { default: _withCtx(({ bar }) =\u0026gt; [ _createTextVNode(_toDisplayString(foo) + _toDisplayString(bar) + _toDisplayString(baz), 1 /* TEXT */) ]), _: 2, /* DYNAMIC */ }, 1024 /* DYNAMIC_SLOTS */)     è¿™é‡Œä½¿ç”¨çš„æ˜¯ _createVNode å› ä¸º Inner éå”¯ä¸€çš„å­©å­èŠ‚ç‚¹ã€‚\n  \u0026lt;template #default=\u0026#34;{foo}\u0026#34;\u0026gt;...\u0026lt;/template\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12  (_openBlock(), _createBlock(_component_Comp, null { default: _withCtx(({ foo }) =\u0026gt; [ _createVNode(_component_Inner, null, { default: _withCtx(({ bar }) =\u0026gt; [ _createTextVNode(_toDisplayString(foo) + _toDisplayString(bar) + _toDisplayString(baz), 1 /* TEXT */) ]), _: 2 /* DYNAMIC */ }, 1024 /* DYNAMIC_SLOTS */), _createTextVNode(_toDisplayString(foo) + _toDisplayString(bar) + _toDisplayString(baz), 1 /* TEXT */) ]), _: 1 /* STABLE */ }))     è¿™é‡Œæœ‰ä¸ªåˆ¤æ–­ Inner ä¸ºåŠ¨æ€ slot çš„å…³é”®ç‚¹ï¼š context.scopes.vSlot \u0026gt; 0 è€Œè¿™ä¸ª å€¼æ˜¯åœ¨æ”¶é›† transformXxx é˜¶æ®µé€’å¢ +1 è€Œåå›æº¯è¿‡ç¨‹ä¸­ -1 çš„ã€‚\n åœ¨æ”¶é›†é˜¶æ®µ \u0026lt;template\u0026gt; æ”¶é›†åˆ° trackSlotScopes() å‡½æ•°æ­¤æ—¶ context.scopes.vSlot = 1 ç„¶åé€’å½’ childrenæ‰§è¡Œåˆ° Inner æ”¶é›†é˜¶æ®µçš„æ—¶å€™ context.scopes.vSlot = 2 ç›´åˆ°é€’å½’ç»“æŸã€‚\n å¼€å§‹å›æº¯ï¼Œå…ˆæ˜¯åœ¨ Inner ä¸Šåº”ç”¨ transformElement ç›´åˆ° Inner å›æº¯åˆ°æ‰§è¡Œ trackSlotScopes() åº”ä¸ºå®ƒä¹Ÿæœ‰ v-slot æŒ‡ä»¤ï¼Œæ‰€ä»¥ Inner èƒ½æ”¶é›†åˆ°è¿™ä¸ªå‡½æ•°ï¼Œ å®ƒå›æº¯ç»“æŸæ‰§è¡Œ trackSlotScopes() éšä¹‹ context.scopes.vSlot-- æ‰€ä»¥æ­¤æ—¶ï¼Œåœ¨ å›æº¯ Inner ç»“æŸä¹‹ååœ¨å¼€å§‹å›æº¯ \u0026lt;template\u0026gt; ä¹‹å‰ context.scopes.vSlot = 1 ã€‚\n è¿™å°±æ˜¯ Inner ä¸ºä»€ä¹ˆæ²¡æœ‰åŠ¨æ€å±æ€§åä½†æ˜¯ä¾æ—§ä¼šåˆ¤æ–­ä¸ºåŠ¨æ€æ’æ§½çš„åŸç†ã€‚\n ä¸€å¥è¯ï¼šå¦‚æœåœ¨ \u0026lt;template v-slot\u0026gt; é‡Œé¢åµŒå¥—å¦ä¸€ä¸ª v-slot é‚£ä¸ªè¿™ä¸ªä¸ç®¡æœ‰æ²¡æœ‰ åŠ¨æ€å±æ€§åéƒ½ä¼šè¢«å½“åšåŠ¨æ€æ’æ§½æ¥å¤„ç†ã€‚\n     c1ace74 add component with v-slot inside v-for  1 2 3  `\u0026lt;div v-for=\u0026#34;i in list\u0026#34;\u0026gt; \u0026lt;Comp v-slot=\u0026#34;bar\u0026#34;\u0026gt;foo\u0026lt;/Comp\u0026gt; \u0026lt;/div\u0026gt;`     let hasDynamicSlots = context.scopes.vSlot \u0026gt; 0 || context.scopes.vFor \u0026gt; 0;\n æ ¹æ®è¿™ä¸ªåˆ¤æ–­å†³å®š v-for é‡Œé¢çš„ v-slot ä¸ºåŠ¨æ€æ’æ§½ã€‚\n  cfef20e add named slot with v-if   feat(add): slot with v-if Â· gcclll/stb-vue-next@cfef20e\n1 2 3  `\u0026lt;Comp\u0026gt; \u0026lt;template #one v-if=\u0026#34;ok\u0026#34;\u0026gt;hello\u0026lt;/template\u0026gt; \u0026lt;/Comp\u0026gt;`     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;Comp\u0026gt; \u0026lt;template #one v-if=\u0026#34;ok\u0026#34;\u0026gt;hello\u0026lt;/template\u0026gt; \u0026lt;/Comp\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, createSlots : _createSlots, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue const _component_Comp = _resolveComponent(\u0026#34;Comp\u0026#34;) return (_openBlock(), _createBlock(_component_Comp, null, _createSlots({ _: 2 /* DYNAMIC */ }, [ ok ? { name: \u0026#34;one\u0026#34;, fn: _withCtx(() =\u0026gt; [ _createTextVNode(\u0026#34;hello\u0026#34;) ]) } : undefined ]), 1024 /* DYNAMIC_SLOTS */)) } } undefined   åŠ¨æ€ slots å¤„ç†ä¹‹åï¼š _createSlots({ /* é™æ€ slots */, [ /* åŠ¨æ€ slots åˆ—è¡¨ */ ] })\n çœ‹ä¸‹é¢çš„è¿è¡Œæ—¶çš„ createSlots(slots, dynamicSlots) å…¶å®å°±æ˜¯è®²ä¸¤è€…åˆå¹¶åœ¨ä¸€èµ·äº† v-if æ˜¯ä¸ªå¯¹è±¡ { fn, name } v-for æ˜¯è¯¥å¯¹è±¡çš„æ•°ç»„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  export function createSlots( slots: Record\u0026lt;string, Slot\u0026gt;, dynamicSlots: ( | CompiledSlotDescriptor | CompiledSlotDescriptor[] | undefined)[] ): Record\u0026lt;string, Slot\u0026gt; { for (let i = 0; i \u0026lt; dynamicSlots.length; i++) { const slot = dynamicSlots[i] // array of dynamic slot generated by \u0026lt;template v-for=\u0026#34;...\u0026#34; #[...]\u0026gt;  if (isArray(slot)) { for (let j = 0; j \u0026lt; slot.length; j++) { slots[slot[j].name] = slot[j].fn } } else if (slot) { // conditional single slot generated by \u0026lt;template v-if=\u0026#34;...\u0026#34; #foo\u0026gt;  slots[slot.name] = slot.fn } } return slots }     æ‹“å±•ï¼š v-else, v-else-if feat(add): v-else/v-else-if with v-slot Â· gcclll/stb-vue-next@e48d46a\n ä¸æ™®é€šçš„ v-else/v-else-if å¤„ç†æœºåˆ¶ä¸€æ ·ï¼Œé¦–å…ˆæ˜¯è¦æ‰¾åˆ°ä»–ä»¬å…„å¼ŸèŠ‚ç‚¹å‰é¢çš„ v-if èŠ‚ç‚¹ï¼Œ ç„¶åå°†è¯¥èŠ‚ç‚¹æŒ‚æ¥åˆ° v-if èŠ‚ç‚¹åé¢ã€‚\n æ ¸å¿ƒä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  // v-else/if on slot let j = i let prev while (j--) { // æ‰¾åˆ°ç›¸é‚»çš„ v-if  prev = children[j] // å¾€å›æ‰¾ç¬¬ä¸€ä¸ªéæ³¨é‡Šçš„èŠ‚ç‚¹  if (prev.type !== NodeTypes.COMMENT) { break } } // å¦‚æœè¯¥èŠ‚ç‚¹æ˜¯ v-if åˆæ³•ï¼Œå¦åˆ™ä¸åˆæ³•ä½¿ç”¨æƒ…å†µ if (prev \u0026amp;\u0026amp; isTemplateNode(prev) \u0026amp;\u0026amp; findDir(prev, \u0026#39;if\u0026#39;)) { // remove node  children.splice(i, 1) i-- __TEST__ \u0026amp;\u0026amp; assert(dynamicSlots.length \u0026gt; 0) // attach this slot to previous conditional  let conditional = dynamicSlots[ dynamicSlots.length - 1 ] as ConditionalExpression // è¿™ç›®çš„æ˜¯æ‰¾åˆ° ?: è¡¨è¾¾å¼æœ€åçš„é‚£ä¸ªèŠ‚ç‚¹  while ( conditional.alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION ) { conditional = conditional.alternate } // å°†å½“å‰çš„ v-else/v-else-if æŒ‚åˆ°æœ€åé‚£ä¸ªèŠ‚ç‚¹è¡¨è¾¾å¼ä½ç½®  // vElse.exp æ£€æµ‹æ˜¯ v-else-if è¿˜æ˜¯ v-else(æ²¡æœ‰å€¼exp)  conditional.alternate = vElse.exp ? createConditionalExpression( vElse.exp, buildDynamicSlot(slotName, slotFunction), defaultFallback ) : buildDynamicSlot(slotName, slotFunction) } else { context.onError( createCompilerError(ErrorCodes.X_V_ELSE_NO_ADJACENT_IF, vElse.loc) ) }      c1ace74 add v-for on v-slot component   feat(add): v-slot inside v-for Â· gcclll/stb-vue-next@c1ace74\n v-for çš„å¤„ç†å’Œ v-if åŸç†æ˜¯ä¸€æ ·çš„ï¼Œæœ€åè¿”å›çš„éƒ½æ˜¯ {name, fn} ç±»å‹ï¼Œåªä¸è¿‡ v-for è¿”å›çš„æ˜¯è¿™ä¸ªç±»å‹çš„æ•°ç»„ã€‚\n v-for _renderList å’Œ slot çš„ç»“åˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  _renderList(list, (i) =\u0026gt; { return { name: name, fn: _withCtx(() =\u0026gt; [ _createTextVNode(_toDisplayString(name), 1 /* TEXT */) ]) } }) // ç­‰äºæ˜¯ï¼š [ { name, fn }, { name1, fn1 }] // ç„¶å _renderSlots -\u0026gt; _renderSlots({ _: 2 /* DYNAMIC */ }, [ _renderList(list, ...) ]) // -\u0026gt; _createBlock _createBlock(_component_Comp, null, _renderSlots({ /* é™æ€ï¼Œæœ€ç»ˆåŠ¨æ€æ’æ§½ä¼šåˆå¹¶åˆ°è¯¥å¯¹è±¡æ¥ */ }, [ /* ... åŠ¨æ€åˆ—è¡¨ */ ])) // å¯¹æ¯”æ— åŠ¨æ€æ’æ§½æƒ…å†µï¼š _createBlock(_component_Comp, null { default: _withCtx(() =\u0026gt; [ _createTextVNode(_toDisplayString(foo), 1 /* TEXT */) ]), _: 1 /* STABLE */ })     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const { code } = baseCompile(`\u0026lt;Comp\u0026gt; \u0026lt;template v-for=\u0026#34;name in list\u0026#34; #[name]\u0026gt;{{ name }}\u0026lt;/template\u0026gt; \u0026lt;/Comp\u0026gt;`) console.log(code)    const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, renderList : _renderList, createSlots : _createSlots, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue const _component_Comp = _resolveComponent(\u0026#34;Comp\u0026#34;) return (_openBlock(), _createBlock(_component_Comp, null, _createSlots({ _: 2 /* DYNAMIC */ }, [ _renderList(list, (name) =\u0026gt; { return { name: name, fn: _withCtx(() =\u0026gt; [ _createTextVNode(_toDisplayString(name), 1 /* TEXT */) ]) } )) ]), 1024 /* DYNAMIC_SLOTS */)) } } undefined   æ— éå°±æ˜¯ä¸åŒç±»å‹å…ƒç´ ã€ç»„ä»¶ render æ–¹å¼çš„ç»„åˆã€‚\n  å°ç»“ï¼šv-slot å‡ ç§ç”¨æ³•    \u0026lt;Comp\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt; , ç”¨æˆ·ç»„ä»¶ä¸Šçš„é»˜è®¤æ’æ§½\n1 2 3 4 5 6 7  const _hoisted_1 = /*# __PURE__ */_createVNode(\u0026#39;div\u0026#39;, null, null, -1 /* HOISTED */) (_openBlock(), _createBlock(_component_Comp, null, { default: _withCtx(() =\u0026gt; [ _hoisted_1 ]), _: 1 /* STABLE */ }))      \u0026lt;Comp v-slot=\u0026#34;slotProps\u0026#34;\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/Comp\u0026gt;, ç”¨æˆ·ç»„ä»¶ä¸Šå¸¦ slotProps çš„é»˜è®¤æ’æ§½\n1 2 3 4 5 6 7  const _hoisted_1 = /*# __PURE__ */_createVNode(\u0026#39;div\u0026#39;, null, null, -1 /* HOISTED */) (_openBlock(), _createBlock(_component_Comp, null, { default: _withCtx((slotProps) =\u0026gt; [ _hoisted_1 ]), _: 1 /* STABLE */ }))      \u0026lt;Comp v-slot:named=\u0026#34;slotProps\u0026#34;\u0026gt;, ç”¨æˆ·ç»„ä»¶ä¸Šå…·åæ’æ§½\n1 2 3 4 5 6  const _hoisted_1 = /*# __PURE__ */_createVNode(\u0026#39;div\u0026#39;, null, null, -1 /* HOISTED */) (_openBlock(), _createBlock(_component_Comp, null, { named: _withCtx((slotProps) =\u0026gt; [ _hoisted_1 ]) }))      \u0026lt;Comp v-slot:[named]=\u0026#34;slotProps\u0026#34;\u0026gt;, ç”¨æˆ·ç»„ä»¶ä¸ŠåŠ¨æ€å…·åæ’æ§½\n1 2 3 4 5 6  const _hoisted_1 = /*# __PURE__ */_createVNode(\u0026#39;div\u0026#39;, null, null, -1 /* HOISTED */) (_openBlock(), _createBlock(_component_Comp, null, { [named]: _withCtx((slotProps) =\u0026gt; [ _hoisted_1 ]) }))      \u0026lt;template\u0026gt; é»˜è®¤æ’æ§½\n \u0026lt;Comp\u0026gt;\u0026lt;template v-slot=\u0026#34;slotProps\u0026#34;\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/template\u0026gt;\u0026lt;/Comp\u0026gt;\n \u0026lt;template\u0026gt; ä¸Šçš„é»˜è®¤æ’æ§½ï¼Œè¿™ä¸ªæ—¶å€™ \u0026lt;Comp\u0026gt; ä¸èƒ½åœ¨ä½¿ç”¨ v-slot ï¼Œä¸‹åŒ   \u0026lt;template\u0026gt; å…·åæ’æ§½\n \u0026lt;Comp\u0026gt;\u0026lt;template v-slot:named=\u0026#34;slotProps\u0026#34;\u0026gt;\u0026lt;/Comp\u0026gt;\n1 2 3 4  return (_openBlock(), _createBlock(_component_Comp, null, { named: _withCtx((slotProps) =\u0026gt; []), _: 1 /* STABLE */ }))      \u0026lt;template\u0026gt; åŠ¨æ€å…·åæ’æ§½\n \u0026lt;Comp\u0026gt;\u0026lt;template v-slot:[named]=\u0026#34;slotProps\u0026#34;\u0026gt;\u0026lt;/Comp\u0026gt;\n1 2 3 4  return (_openBlock(), _createBlock(_component_Comp, null, { [named]: _withCtx((slotProps) =\u0026gt; []), _: 1 /* STABLE */ }))      \u0026lt;template\u0026gt; å…·åæ’æ§½ï¼Œå…¶ä½™é template å…ƒç´ å½“åšé»˜è®¤æ’æ§½å¤„ç†\n \u0026lt;Comp\u0026gt;\u0026lt;template v-slot:named=\u0026#34;slotProps\u0026#34;\u0026gt;\u0026lt;div/\u0026gt;\u0026lt;/template\u0026gt;\u0026lt;div :id=\u0026#34;defaultSlotId\u0026#34;/\u0026gt;\u0026lt;/Comp\u0026gt;\n \u0026lt;template\u0026gt; ä¸Šçš„å…·åæ’æ§½ + é»˜è®¤æ’æ§½ï¼Œåœ¨ç»„ä»¶å†…çš„é \u0026lt;template\u0026gt; å…ƒç´ (å³ï¼š \u0026lt;div/\u0026gt;)éƒ½ä¼šè¢«åŠ¨ä½œé»˜è®¤æ’æ§½æ¥å¤„ç†\n1 2 3 4 5 6 7 8 9 10 11 12  const _hoisted_1 = /*# __PURE__ */_createVNode(\u0026#34;div\u0026#34;, null, null, -1 /* HOISTED */) _createBlock(_component_Comp, null, { named: _withCtx((slotProps) =\u0026gt; [ _hoisted_1 ]), default: _withCtx(() =\u0026gt; [ _createVNode(\u0026#39;div\u0026#39;, { id: defaultSlotId }, null, 8 /* PROPS */, [\u0026#34;id\u0026#34;]) ]) _: 1 /* STABLE */ })      v-slot + v-if æ’æ§½ä½¿ç”¨\n \u0026lt;Comp\u0026gt;\u0026lt;template v-if=\u0026#34;ok\u0026#34; #named=\u0026#34;slotProps\u0026#34;\u0026gt;{{ bar }}\u0026lt;/template\u0026gt;\u0026lt;/Comp\u0026gt;\n é…åˆ v-if ä½¿ç”¨çš„ slot template, æœ€åè§£ææˆ ï¼š ok ? { name: \u0026#39;named\u0026#39;, fn : _withCtx(() =\u0026gt; [ _createTextVNode(_toDisplayString(bar)) ]) } : undefined\n1 2 3 4 5 6 7 8 9 10 11  return (_openBlock(), _createBlock(_component_Comp, null, _renderSlots( { _: 2 /* DYNAMIC */ }, [ ok ? { name: \u0026#39;named\u0026#39;, fn: _withCtx((slotProps) =\u0026gt; [ _createTextVNode(_toDisplayString(bar), 1 /* TEXT */) ]) } : undefined ] )))      v-slot + v-for æ’æ§½ä¸Šä½¿ç”¨\n \u0026lt;Comp\u0026gt;\u0026lt;template v-for=\u0026#34;i in list\u0026#34; #named=\u0026#34;{ prop }\u0026#34;\u0026gt;{{ bar }}\u0026lt;/template\u0026gt;\u0026lt;/Comp\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11  return (_openBlock(), _createBlock(_component_Comp, null, _renderSlots( { _: 2 /* DYNAMIC */ }, _renderList(list, (i) =\u0026gt; { return { name: \u0026#39;named\u0026#39;, fn: _withCtx(({ prop }) =\u0026gt; [ _createTextVNode(_toDisplayString(bar), 1 /* TEXT */) ]) } }) )))       æ’æ§½æŒ‰çŠ¶æ€åˆ†ä¸ºï¼š\n  é™æ€æ’æ§½ï¼ŒåŠ¨æ€æ’æ§½é™¤å¤–çš„æ’æ§½\n  åŠ¨æ€æ’æ§½ï¼Œæœ‰ v-if/v-for/v-else[-if] æŒ‡ä»¤æˆ– v-slot:[named] æˆ–ä½œä¸º v-for èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹éƒ½è§†ä¸ºåŠ¨æ€æ’æ§½\n       update vue-next merge into stb-vue-next[2020-12-11 16:54:06]   æ›´æ–° vue-next åˆå¹¶åˆ° stb-vue-nextã€‚\n  ast.ts æ›´æ–°\n  SimpleExpressionNode : å»æ‰ isConstant å±æ€§ï¼Œå¢åŠ  constType\n  å»æ‰äº† StaticType å¢åŠ  ConstantType\n1 2 3 4 5 6 7 8 9 10 11  /** * Static types have several levels. * Higher levels implies lower levels. e.g. a node that can be stringified * can always be hoisted and skipped for patch. */ export const enum ConstantTypes { NOT_CONSTANT = 0, CAN_SKIP_PATCH, CAN_HOIST, CAN_STRINGIFY }        codegen.ts æ›´æ–°\n fix: merge vue-next codegen.ts Â· gcclll/stb-vue-next@521b879\n  parse.ts æ›´æ–°\n ast ç»“æ„ä¸­çš„ isConstant æ”¹æˆ ConstantTypes ç±»å‹å€¼\n fix: merge vue-next parse.ts isConstant -\u0026gt; constType Â· gcclll/stb-vue-next@fdbdc4f\n  transform.ts æ›´æ–°\n fix: merge vue-next transform.ts Â· gcclll/stb-vue-next@22a8f0b\n  add filename\n  add isTS, inline\n    transformElement.ts\n fix: merge vue-next transformElement.ts Â· gcclll/stb-vue-next@1d85990\n  transformSlotOutlet.ts\n fix: merge vue-next transformSlotOutlet.ts Â· gcclll/stb-vue-next@58e87f3 ä¿®æ”¹ \u0026lt;slot\u0026gt;\u0026lt;/slot\u0026gt; å±æ€§è§£æé€»è¾‘ã€‚\n    6efbc86 add expression transform(node-env)   feat: transformExpression -\u0026gt; processExpression Â· gcclll/stb-vue-next@6efbc86\n transformExpression å¤„ç†çš„æ˜¯å¤æ‚è¡¨è¾¾å¼æƒ…å†µï¼Œä¸”éœ€è¦åœ¨éæµè§ˆå™¨ç¯å¢ƒï¼Œå› ä¸ºå®ƒéœ€è¦ä¾èµ– ä¸€äº› JavaScript è§£æå™¨æ¥ååŠ©å®Œæˆã€‚\n éœ€è¦å¤„ç†çš„ä¸¤ç§ç±»å‹ï¼š\n  INTERPOLATION æ’å€¼ç±»å‹\n  ELEMENT ç±»å‹ä¸”æ²¡æœ‰ v-for æŒ‡ä»¤çš„æ ‡ç­¾ï¼Œå¯¹äºæŒ‡ä»¤éœ€è¦å¤„ç†çš„æœ‰ arg, exp å¦‚æœ å‚æ•°æ˜¯åŠ¨æ€çš„æƒ…å†µ\n   ä¸¤è€…æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ processExpression(node, context, asPrarms, asRawStatement) è¿™ ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ‰ç‚¹å¤æ‚ï¼Œéœ€è¦æ…¢æ…¢æ¶ˆåŒ–ğŸ• ğŸ• ğŸ•   TODOs(ssr render, node env, setup meta)   åœ¨æ­¤ä¹‹å‰éƒ½æ˜¯åŸºäºæµè§ˆå™¨å»å®Œæˆå’Œæµ‹è¯•çš„ï¼Œä½†æ˜¯ç”±äºåé¢ compiler-dom æœ‰äº›æµ‹è¯•åŒæ ·éœ€è¦ node ç¯å¢ƒæ”¯æŒï¼Œå› æ­¤è¿™é‡Œå¿…é¡»å…ˆå®Œæˆæ‰€æœ‰æµè§ˆå™¨çš„æ”¯æŒï¼Œè¿™æ · prefixIdentifiers å’Œ cacheHandlers ä¹Ÿå°†æ”¯æŒã€‚\n add generate imports and module mode: feat: gen imports Â· gcclll/stb-vue-next@ea7f16b\n TODO ssr template literal: feat(add): gen template literal Â· gcclll/stb-vue-next@356bc93\n TODO ssr if generate: feat(add): ssr gen if statement Â· gcclll/stb-vue-next@1c424be  TODO ssr assigment expression generate: ç”Ÿæˆèµ‹å€¼è¡¨è¾¾å¼ feat(add): ssr gen assignment expression Â· gcclll/stb-vue-next@1f99a11\n TODO ssr generate sequence exprssion: feat(add): ssr gen sequence expression Â· gcclll/stb-vue-next@81aa0b0\n TODO ssr generate return statement: feat(add): ssr gen return statement Â· gcclll/stb-vue-next@c85406c\n TODO ssr v-on transform: feat(add): ssr v-on transform Â· gcclll/stb-vue-next@adefeec\n TODO setup mode v-model on ref: feat(add): setup mode v-model on ref Â· gcclll/stb-vue-next@20bb40d\n TODO process expression in vIf.ts feat(add): v-if process expression Â· gcclll/stb-vue-next@56c49c7\n TODO setup mode ref in transformElement feat(add): transform ref in setup mode in transformElement Â· gcclll/stb-vue-next@54f467f\n  non-browser testing(éæµè§ˆå™¨ç¯å¢ƒæµ‹è¯•)   æœ¬ç« èŠ‚æµ‹è¯•éƒ½æ˜¯åŸºäº node ç¯å¢ƒè¿›è¡Œæµ‹è¯•çš„ï¼Œæµ‹è¯•ä»£ç ä½äºå„ä¸ª package ç›®å½•ä¸‹çš„ __nests__ (node tests ç¼©å†™)é‡Œé¢ã€‚\n ç”±äºæµ‹è¯•è¾“å‡ºç»“æœè¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨æ§åˆ¶å°å½¢å¼è¾“å‡ºï¼Œè¯· \u0026lt;f12\u0026gt; æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹\n l1(`hoist static testing é™æ€æå‡æµ‹è¯•`) c(``, 'should NOT hoist root node')     jest è·‘ğŸƒç”¨ä¾‹   fix: jest errors Â· gcclll/stb-vue-next@2085dd6\n@vue/runtime-dom (guessing \u0026#39;runtimeDom\u0026#39;) created packages/vue/dist/vue.global.js in 5.1s PASS packages/compiler-core/__tests__/transforms/transformElement.spec.ts (9.278 s) PASS packages/compiler-core/__tests__/transforms/vModel.spec.ts PASS packages/compiler-core/__tests__/transforms/vFor.spec.ts PASS packages/compiler-core/__tests__/parse.spec.ts PASS packages/compiler-core/__tests__/transforms/hoistStatic.spec.ts PASS packages/compiler-core/__tests__/codegen.spec.ts PASS packages/compiler-core/__tests__/transforms/vIf.spec.ts PASS packages/compiler-core/__tests__/transforms/vSlot.spec.ts PASS packages/compiler-core/__tests__/transforms/transformExpressions.spec.ts PASS packages/compiler-core/__tests__/transforms/vOn.spec.ts PASS packages/compiler-core/__tests__/transform.spec.ts PASS packages/compiler-core/__tests__/compile.spec.ts PASS packages/compiler-core/__tests__/transforms/transformSlotOutlet.spec.ts PASS packages/compiler-core/__tests__/transforms/transformText.spec.ts PASS packages/compiler-core/__tests__/transforms/vOnce.spec.ts PASS packages/compiler-core/__tests__/scopeId.spec.ts PASS packages/compiler-core/__tests__/transforms/vBind.spec.ts PASS packages/compiler-core/__tests__/transforms/noopDirectiveTransform.spec.ts PASS packages/compiler-core/__tests__/utils.spec.ts Test Suites: 19 passed, 19 total Tests: 480 passed, 480 total Snapshots: 205 passed, 205 total Time: 17.699 s   å…¨éƒ¨é€šè¿‡æµ‹è¯•ï¼ŒæœŸé—´å‡ºç°ä¸¤ä¸ªå°é—®é¢˜ï¼š\n  transformElement é‡Œé¢è§£æåŠ¨æ€å±æ€§(vnodeDynamicProps)çš„æ—¶å€™ä¼šå°†è¿™äº›å±æ€§ç»„æˆ å­—ç¬¦ä¸²æ•°ç»„ï¼Œè¿™é‡Œå°‘äº†ä¸ªé€—å·\n   genFunctionExpression() é‡Œé¢å°†å‡½æ•° } é”™å†™æˆäº† )\n     ç»¼åˆæµ‹è¯•  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67  const { baseParse, baseCompile } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const log = (...args) =\u0026gt; console.log.apply(console, args) const c = tpl =\u0026gt; baseCompile(tpl, { hoistStatic: true }).code let tpl = ``, code = `` tpl = ` \u0026lt;div :id=\u0026#34;status\u0026#34; class=\u0026#34;status\u0026#34; :style=\u0026#34;{ color: \u0026#39;red\u0026#39; }\u0026#34;\u0026gt; \u0026lt;button v-if=\u0026#34;opened\u0026#34; @click=\u0026#34;opened = !opened\u0026#34;\u0026gt;å…³é—­\u0026lt;/button\u0026gt; \u0026lt;button v-else-if=\u0026#34;invalid\u0026#34; v-on.enter=\u0026#34;{ clicked: toggleValid }\u0026#34;\u0026gt;æœ‰æ•ˆ\u0026lt;/button\u0026gt; \u0026lt;button v-else @click.prevent=\u0026#34;() =\u0026gt; opened = true\u0026#34;\u0026gt;æ‰“å¼€\u0026lt;/button\u0026gt; \u0026lt;p :name=\u0026#34;vbind\u0026#34;\u0026gt;v-bind ç¼©å†™\u0026lt;/p\u0026gt; \u0026lt;p class=\u0026#34;vbind-no-arg\u0026#34; v-bind=\u0026#34;{ name: \u0026#39;vbind\u0026#39; }\u0026#34;\u0026gt;æ— å‚æ•°çš„ v-bind\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;list\u0026#34; :class=\u0026#34;list\u0026#34; style=\u0026#34;color:red;\u0026#34;\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li v-for=\u0026#34;(value, key, index) in list\u0026#34;\u0026gt;{{ value }}\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;once\u0026#34; :class=\u0026#34;once\u0026#34;\u0026gt;{{ once }}\u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;user-comp\u0026#34; :class=\u0026#34;user-comp\u0026#34;\u0026gt; \u0026lt;!-- æˆ‘æ˜¯æ³¨é‡Šï¼šç”¨æˆ·ç»„ä»¶ --\u0026gt; \u0026lt;List\u0026gt;{{ \u0026#34;æˆ‘æ˜¯ \u0026lt;List/\u0026gt; çš„é»˜è®¤æ’æ§½\u0026#34; }}\u0026lt;/List\u0026gt; \u0026lt;List v-slot=\u0026#34;{ prop }\u0026#34;\u0026gt;\u0026lt;p class=\u0026#34;title\u0026#34;\u0026gt;æˆ‘æ˜¯å¸¦ slotProps({{ prop }}) çš„é»˜è®¤æ’æ§½\u0026lt;/p\u0026gt;\u0026lt;/List\u0026gt; \u0026lt;List v-slot:title=\u0026#34;{ prop }\u0026#34;\u0026gt;\u0026#34;æˆ‘æ˜¯å¸¦åå­—{{ prop }}çš„æ’æ§½\u0026#34;\u0026lt;/List\u0026gt; \u0026lt;List\u0026gt; \u0026lt;template v-slot:one=\u0026#34;slotProps\u0026#34;\u0026gt;\u0026lt;p\u0026gt;{{ slotProps.title }}\u0026lt;/p\u0026gt;\u0026lt;/template\u0026gt; \u0026lt;p\u0026gt;æˆ‘æ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;æˆ‘ä¹Ÿæ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;æˆ‘ä¹Ÿæ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;æˆ‘ä»¬éƒ½æ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\u0026lt;/p\u0026gt; \u0026lt;/List\u0026gt; \u0026lt;List\u0026gt; \u0026lt;template\u0026gt; \u0026lt;p\u0026gt;æˆ‘æ˜¯é»˜è®¤æ’æ§½\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;template v-slot:one=\u0026#34;{ prop }\u0026#34;\u0026gt; \u0026lt;p\u0026gt;æˆ‘æ˜¯åå­—ä¸º one çš„å…·åæ’æ§½æ’æ§½({{ prop }})\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/List\u0026gt; \u0026lt;List v-if=\u0026#34;ok\u0026#34; v-slot:one=\u0026#34;slotProps\u0026#34;\u0026gt;\u0026lt;p\u0026gt;æˆ‘æ˜¯å¸¦ v-if æŒ‡ä»¤çš„ä¸” v-slot å¼•ç”¨åœ¨ç»„ä»¶ä¸Šçš„å…·å \u0026#34;one\u0026#34; æ’æ§½ï¼Œæ ‡é¢˜å±æ€§ï¼š {{ slotProps.title }}\u0026lt;/p\u0026gt;\u0026lt;/List\u0026gt; \u0026lt;List\u0026gt; \u0026lt;template\u0026gt;\u0026lt;!-- æˆ‘æ˜¯é»˜è®¤æ’æ§½ï¼Œç»™ä½ ä»¬æ³¨é‡Šç”¨çš„ï¼ï¼ï¼ï¼ï¼ï¼ --\u0026gt;\u0026lt;/template\u0026gt; \u0026lt;template v-if=\u0026#34;ok\u0026#34; v-slot:one=\u0026#34;{ prop }\u0026#34;\u0026gt; \u0026lt;p\u0026gt;å¸¦ v-if + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;template v-for=\u0026#34;(value, key, index) in list\u0026#34; v-slot:two=\u0026#34;slotProps\u0026#34;\u0026gt; \u0026lt;p\u0026gt;å¸¦ v-for + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/List\u0026gt; \u0026lt;/div\u0026gt; ` code = c(tpl) log(`\u0026gt;\u0026gt;\u0026gt; å¤æ‚åº”ç”¨åœºæ™¯`) log(code) log(`\\n\u0026gt; æ³¨é‡Š\\n`, `1. v-on è¡¨è¾¾å¼ä¸ºç®€å•è¡¨è¾¾å¼æ—¶ä¼šè¢«å¤„ç†æˆä¸€ä¸ªç®­å¤´å‡½æ•°\\n`, `2. v-on å¦‚æœæ²¡æœ‰å‚æ•°æ—¶ï¼Œä¼šè§¦å‘è¯¥ç»„ä»¶ä¸Šçš„æ‰€æœ‰å±æ€§åˆå¹¶(_mergeProps(...))\\n`, `3. v-on è¡¨è¾¾å¼ä¸ºä¸€ä¸ªå‡½æ•°å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†\\n`, `4. v-for è°ƒç”¨ _renderList(list, fn) æ¸²æŸ“åˆ—è¡¨ï¼Œlist åˆ—è¡¨æ•°æ®æ¥æºï¼Œfn åˆ—è¡¨é¡¹æ¸²æŸ“å‡½æ•°\\n`, `5. v-slot åº”ç”¨åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šæ—¶ï¼Œé‡Œé¢å°±ä¸èƒ½åœ¨ä½¿ç”¨ v-slot\\n`, `6. åªè¦åœ¨ template ä¸Šåº”ç”¨äº† v-if/v-for æˆ–è€…å°†ç”¨æˆ·ç»„ä»¶æ”¾åœ¨ v-for ä¸‹é¢è¿™äº›æ’æ§½éƒ½ä¼šè¢«å½“åšåŠ¨æ€æ’æ§½å¤„ç†\\n`)    \u0026gt;\u0026gt;\u0026gt; å¤æ‚åº”ç”¨åœºæ™¯ const _Vue = Vue const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode } = _Vue const _hoisted_1 = { class: \u0026#34;title\u0026#34; } const _hoisted_2 = /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;æˆ‘æ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†\u0026#34;, -1 /* HOISTED */) const _hoisted_3 = /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;æˆ‘ä¹Ÿæ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†\u0026#34;, -1 /* HOISTED */) const _hoisted_4 = /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;æˆ‘ä¹Ÿæ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\u0026#34;, -1 /* HOISTED */) const _hoisted_5 = /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;æˆ‘ä»¬éƒ½æ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\u0026#34;, -1 /* HOISTED */) const _hoisted_6 = /*#__PURE__*/_createVNode(\u0026#34;template\u0026#34;, null, [ /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;æˆ‘æ˜¯é»˜è®¤æ’æ§½\u0026#34;) ], -1 /* HOISTED */) const _hoisted_7 = /*#__PURE__*/_createVNode(\u0026#34;template\u0026#34;, null, [ /*#__PURE__*/_createCommentVNode(\u0026#34; æˆ‘æ˜¯é»˜è®¤æ’æ§½ï¼Œç»™ä½ ä»¬æ³¨é‡Šç”¨çš„ï¼ï¼ï¼ï¼ï¼ï¼ \u0026#34;) ], -1 /* HOISTED */) const _hoisted_8 = /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;å¸¦ v-if + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°\u0026#34;, -1 /* HOISTED */) const _hoisted_9 = /*#__PURE__*/_createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;å¸¦ v-for + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°\u0026#34;, -1 /* HOISTED */) return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode, toHandlers : _toHandlers, mergeProps : _mergeProps, renderList : _renderList, Fragment : _Fragment, toDisplayString : _toDisplayString, createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, createSlots : _createSlots } = _Vue const _component_List = _resolveComponent(\u0026#34;List\u0026#34;) return (_openBlock(), _createBlock(_Fragment, null, [ _createVNode(\u0026#34;div\u0026#34;, { id: status, class: \u0026#34;status\u0026#34;, style: { color: \u0026#39;red\u0026#39; } }, [ opened ? (_openBlock(), _createBlock(\u0026#34;button\u0026#34;, { key: 0, onClick: $event =\u0026gt; (opened = !opened) }, \u0026#34;å…³é—­\u0026#34;, 8 /* PROPS */, [\u0026#34;onClick\u0026#34;])) : invalid ? (_openBlock(), _createBlock(\u0026#34;button\u0026#34;, _mergeProps({ key: 1 }, _toHandlers({ clicked: toggleValid })), \u0026#34;æœ‰æ•ˆ\u0026#34;, 16 /* FULL_PROPS */)) : (_openBlock(), _createBlock(\u0026#34;button\u0026#34;, { key: 2, onClick: () =\u0026gt; opened = true }, \u0026#34;æ‰“å¼€\u0026#34;, 8 /* PROPS */, [\u0026#34;onClick\u0026#34;])), _createVNode(\u0026#34;p\u0026#34;, { name: vbind }, \u0026#34;v-bind ç¼©å†™\u0026#34;, 8 /* PROPS */, [\u0026#34;name\u0026#34;]), _createVNode(\u0026#34;p\u0026#34;, _mergeProps({ class: \u0026#34;vbind-no-arg\u0026#34; }, { name: \u0026#39;vbind\u0026#39; }), \u0026#34;æ— å‚æ•°çš„ v-bind\u0026#34;, 16 /* FULL_PROPS */) ], 12 /* STYLE, PROPS */, [\u0026#34;id\u0026#34;]), _createVNode(\u0026#34;div\u0026#34;, { id: \u0026#34;list\u0026#34;, class: list, style: \u0026#34;color:red;\u0026#34; }, [ _createVNode(\u0026#34;ul\u0026#34;, null, [ (_openBlock(true), _createBlock(_Fragment, null, _renderList(list, (value, key, index) =\u0026gt; { return (_openBlock(), _createBlock(\u0026#34;li\u0026#34;, null, _toDisplayString(value), 1 /* TEXT */)) )), 256 /* UNKEYED_FRAGMENT */)) ]) ], 2 /* CLASS */), _createVNode(\u0026#34;div\u0026#34;, { id: \u0026#34;once\u0026#34;, class: once }, _toDisplayString(once), 3 /* TEXT, CLASS */), _createVNode(\u0026#34;div\u0026#34;, { id: \u0026#34;user-comp\u0026#34;, class: user-comp }, [ _createCommentVNode(\u0026#34; æˆ‘æ˜¯æ³¨é‡Šï¼šç”¨æˆ·ç»„ä»¶ \u0026#34;), _createVNode(_component_List, null, { default: _withCtx(() =\u0026gt; [ _createTextVNode(_toDisplayString(\u0026#34;æˆ‘æ˜¯ \u0026lt;List/\u0026gt; çš„é»˜è®¤æ’æ§½\u0026#34;), 1 /* TEXT */) ]), _: 1 /* STABLE */ }), _createVNode(_component_List, null, { default: _withCtx(({ prop }) =\u0026gt; [ _createVNode(\u0026#34;p\u0026#34;, _hoisted_1, \u0026#34;æˆ‘æ˜¯å¸¦ slotProps(\u0026#34; + _toDisplayString(prop) + \u0026#34;) çš„é»˜è®¤æ’æ§½\u0026#34;, 1 /* TEXT */) ]), _: 1 /* STABLE */ }), _createVNode(_component_List, null, { title: _withCtx(({ prop }) =\u0026gt; [ _createTextVNode(\u0026#34;\\\u0026#34;æˆ‘æ˜¯å¸¦åå­—\u0026#34; + _toDisplayString(prop) + \u0026#34;çš„æ’æ§½\\\u0026#34;\u0026#34;, 1 /* TEXT */) ]), _: 1 /* STABLE */ }), _createVNode(_component_List, null, { one: _withCtx((slotProps) =\u0026gt; [ _createVNode(\u0026#34;p\u0026#34;, null, _toDisplayString(slotProps.title), 1 /* TEXT */) ]), default: _withCtx(() =\u0026gt; [ _hoisted_2, _hoisted_3, _hoisted_4, _hoisted_5 ]), _: 1 /* STABLE */ }), _createVNode(_component_List, null, { one: _withCtx(({ prop }) =\u0026gt; [ _createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;æˆ‘æ˜¯åå­—ä¸º one çš„å…·åæ’æ§½æ’æ§½(\u0026#34; + _toDisplayString(prop) + \u0026#34;)\u0026#34;, 1 /* TEXT */) ]), default: _withCtx(() =\u0026gt; [ _hoisted_6 ]), _: 1 /* STABLE */ }), ok ? (_openBlock(), _createBlock(_component_List, { key: 0 }, { one: _withCtx((slotProps) =\u0026gt; [ _createVNode(\u0026#34;p\u0026#34;, null, \u0026#34;æˆ‘æ˜¯å¸¦ v-if æŒ‡ä»¤çš„ä¸” v-slot å¼•ç”¨åœ¨ç»„ä»¶ä¸Šçš„å…·å \\\u0026#34;one\\\u0026#34; æ’æ§½ï¼Œæ ‡é¢˜å±æ€§ï¼š \u0026#34; + _toDisplayString(slotProps.title), 1 /* TEXT */) ]), _: 1 /* STABLE */ })) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true), _createVNode(_component_List, null, _createSlots({ default: _withCtx(() =\u0026gt; [ _hoisted_7 ]), _: 2 /* DYNAMIC */ }, [ ok ? { name: \u0026#34;one\u0026#34;, fn: _withCtx(({ prop }) =\u0026gt; [ _hoisted_8 ]) } : undefined, _renderList(list, (value, key, index) =\u0026gt; { return { name: \u0026#34;two\u0026#34;, fn: _withCtx((slotProps) =\u0026gt; [ _hoisted_9 ]) } )) ]), 1024 /* DYNAMIC_SLOTS */) ], 2 /* CLASS */) ], 64 /* STABLE_FRAGMENT */)) } } \u0026gt; æ³¨é‡Š 1. v-on è¡¨è¾¾å¼ä¸ºç®€å•è¡¨è¾¾å¼æ—¶ä¼šè¢«å¤„ç†æˆä¸€ä¸ªç®­å¤´å‡½æ•° 2. v-on å¦‚æœæ²¡æœ‰å‚æ•°æ—¶ï¼Œä¼šè§¦å‘è¯¥ç»„ä»¶ä¸Šçš„æ‰€æœ‰å±æ€§åˆå¹¶(_mergeProps(...)) 3. v-on è¡¨è¾¾å¼ä¸ºä¸€ä¸ªå‡½æ•°å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç† 4. v-for è°ƒç”¨ _renderList(list, fn) æ¸²æŸ“åˆ—è¡¨ï¼Œlist åˆ—è¡¨æ•°æ®æ¥æºï¼Œfn åˆ—è¡¨é¡¹æ¸²æŸ“å‡½æ•° 5. v-slot åº”ç”¨åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šæ—¶ï¼Œé‡Œé¢å°±ä¸èƒ½åœ¨ä½¿ç”¨ v-slot 6. åªè¦åœ¨ template ä¸Šåº”ç”¨äº† v-if/v-for æˆ–è€…å°†ç”¨æˆ·ç»„ä»¶æ”¾åœ¨ v-for ä¸‹é¢è¿™äº›æ’æ§½éƒ½ä¼šè¢«å½“åšåŠ¨æ€æ’æ§½å¤„ç† undefined    ","permalink":"https://www.cheng92.com/vue/vue-mind-map-compiler-core-transform-generate/","tags":["vue,","vue3,","compiler-core,","parser,","compiler,","transform"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform + codegen"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n   stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„å­¦ä¹ åŠå°è¯•åº”ç”¨äºæœºé¡¶ç›’ç¯å¢ƒã€‚ \n  æœ¬æ–‡ä¾æ® commit è¿›ç¨‹è¿›è¡Œè®°å½•ï¼Œåªè¦è·Ÿç€ä¸‹é¢çš„è¿›ç¨‹èµ°ï¼Œä½ å°†èƒ½å®Œæ•´å® ç° vue ast parser å“¦ ğŸ’ƒğŸ¼ğŸ’ƒğŸ¼ğŸ’ƒğŸ¼ \n å£°æ˜ï¼šè¯¥ç¯‡ä¸º ts æºç (commit)ç‰ˆæœ¬ï¼Œä¹‹å‰åšè¿‡ä¸€éå®Œæ•´çš„ js ç‰ˆæœ¬ï¼Œæ›´è¯¦ç»†ï¼Œä¹Ÿå¯å‚è€ƒ\n Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts - è‹¥å¶çŸ¥ç§‹\n  è„‘å›¾     compiler-core parser åˆå§‹åŒ–   Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts\n c0a03af add baseParse declaration\n feat(add): baseParse declaration Â· gcclll/stb-vue-next@c0a03af\n æ·»åŠ  baseParse() å‡½æ•°å£°æ˜ï¼š\n1 2 3  export function baseParse(content: string, options: ParserOptions): RootNode { return {} as RootNode }     cb2d452 init baseParse function\n feat: baseParse function Â· gcclll/stb-vue-next@cb2d452\n å¢åŠ  baseParse å‡½æ•°å®ç°ï¼Œå’Œæ¶‰åŠåˆ°çš„ä¸€äº›å‡½æ•°å’Œç±»å‹å£°æ˜ã€‚\n1 2 3 4 5 6 7 8  export function baseParse(content: string, options: ParserOptions): RootNode { const context = createParserContext(content, options) const start = getCursor(context) return createRoot( parseChildren(context, TextModes.DATA, []), getSelection(context, start) ) }        870343c add parseChildren function   feat(init): parseChildren function Â· gcclll/stb-vue-next@870343c\n  4c6009d add pure text parser(parseText, parseTextData)   feat(add): parseText, parseTextData Â· gcclll/stb-vue-next@4c6009d\n fix lint errors: 005c261\n fix: lint errors Â· gcclll/stb-vue-next@005c261\n æ–°å¢äº†ä¸‰ä¸ªå‡½æ•°ï¼š\n  pushNode(nodes: TemplateChildNode[], node: TemplateChildNode): void\n éå† while è§£æåçš„ ast ï¼Œåˆå¹¶ç›¸é‚»çš„æ–‡æœ¬èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  function pushNode(nodes: TemplateChildNode[], node: TemplateChildNode): void { if (node.type === NodeTypes.TEXT) { // åˆå¹¶ä¸¤ä¸ªç›¸é‚»çš„æ–‡æœ¬å†…å®¹  const prev = last(nodes) // Merge if both this and the previous node are text and those are  // consecutive. This happens for cases like \u0026#34;a \u0026lt; b\u0026#34;.  if ( prev \u0026amp;\u0026amp; prev.type === NodeTypes.TEXT \u0026amp;\u0026amp; prev.loc.end.offset === node.loc.start.offset ) { prev.content += node.content prev.loc.end = node.loc.end prev.loc.source += node.loc.source return } } nodes.push(node) }      parseText(context: ParserContext, mode: TextModes): TextNode\n è§£ææ–‡æœ¬èŠ‚ç‚¹ï¼Œæ–‡æœ¬èŠ‚ç‚¹ç»“æŸæ ‡è¯†ï¼š \u0026lt; å’Œ {{ ï¼Œåˆ†åˆ«ä»£è¡¨æ ‡ç­¾å’Œæ’å€¼å¼€å§‹ç¬¦å·ã€‚\n å¦‚ï¼š some text\u0026lt;div\u0026gt;...., some text{{ ... }}\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  function parseText(context: ParserContext, mode: TextModes): TextNode { __TEST__ \u0026amp;\u0026amp; assert(context.source.length \u0026gt; 0) const endTokens = [\u0026#39;\u0026lt;\u0026#39;, context.options.delimiters[0]] if (mode === TextModes.CDATA) { endTokens.push(\u0026#39;]]\u0026gt;\u0026#39;) } let endIndex = context.source.length // æ‰¾åˆ°é‡åˆ°çš„ç¬¬ä¸€ä¸ªç»“æŸç¬¦ }}, \u0026lt;  for (let i = 0; i \u0026lt; endTokens.length; i++) { const index = context.source.indexOf(endTokens[i], 1) if (index !== -1 \u0026amp;\u0026amp; endIndex \u0026gt; index) { endIndex = index } } __TEST__ \u0026amp;\u0026amp; assert(endIndex \u0026gt; 0) const start = getCursor(context) const content = parseTextData(context, endIndex, mode) return { type: NodeTypes.TEXT, content, loc: getSelection(context, start) } }      function parseTextData(context: ParserContext, length: number, mode: TextModes): string\n å¤„ç† HTML ä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œæ¯”å¦‚ï¼š a \u0026gt; b =\u0026gt; a \u0026amp;lt; b\n1 2 3 4 5 6 7 8  const decodeRE = /\u0026amp;(gt|lt|amp|apos|quot);/g const decodeMap: Record\u0026lt;string, string\u0026gt; = { gt: \u0026#39;\u0026gt;\u0026#39;, lt: \u0026#39;\u0026lt;\u0026#39;, amp: \u0026#39;\u0026amp;\u0026#39;, apos: \u0026#34;\u0026#39;\u0026#34;, quot: \u0026#39;\u0026#34;\u0026#39; }       æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) let ast = baseParse(`some text`) console.log(`\u0026gt;\u0026gt;\u0026gt; æ™®é€šæ–‡æœ¬ \u0026#34;some text\u0026#34;`) console.log(ast) console.log(`\u0026gt;\u0026gt;\u0026gt; å¸¦ html è¯­ä¹‰ç¬¦å·çš„æ–‡æœ¬ \u0026#34;a \u0026amp;lt; b\u0026#34;`) ast = baseParse(`a \u0026amp;lt; b`) console.log(ast)     +RESULTS: å¦‚ç»“æœæ˜¾ç¤º \u0026amp;lt;, \u0026amp;gt; ç­‰ç¬¦å·ä¼šè¢«è½¬æˆè¯­ä¹‰åŒ–ç¬¦å·ã€‚\n\u0026gt;\u0026gt;\u0026gt; æ™®é€šæ–‡æœ¬ \u0026#34;some text\u0026#34; { type: 0, children: [ { type: 2, content: \u0026#39;some text\u0026#39;, loc: [Object] } ], } \u0026gt;\u0026gt;\u0026gt; å¸¦ html è¯­ä¹‰ç¬¦å·çš„æ–‡æœ¬ \u0026#34;a \u0026amp;lt; b\u0026#34; { type: 0, children: [ { type: 2, content: \u0026#39;a \u0026lt; b\u0026#39;, loc: [Object] } ], } undefined    d7dbc28 add comment parser(parseComment)   feat(add): comment parser Â· gcclll/stb-vue-next@d7dbc28\n ä¿®æ”¹ parseChildren():\n else if s[0] === \u0026#39;\u0026lt;\u0026#39; ä½œä¸ºå¼€å§‹ï¼Œå¯èƒ½æ˜¯æ ‡ç­¾ã€html æ³¨é‡Šç­‰ç­‰ã€‚\n  ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  function parseComment(context: ParserContext): CommentNode { __TEST__ \u0026amp;\u0026amp; assert(startsWith(context.source, \u0026#39;\u0026lt;!--\u0026#39;)) const start = getCursor(context) let content: string const match = /--(\\!)?\u0026gt;/.exec(context.source) if (!match) { // éæ³•æ³¨é‡Š  content = context.source.slice(4) advanceBy(context, context.source.length) emitError(context, ErrorCodes.EOF_IN_COMMENT) } else { if (match.index \u0026lt;= 3) { // ä¸æ»¡è¶³ \u0026lt;!-- --\u0026gt;  emitError(context, ErrorCodes.ABRUPT_CLOSING_OF_EMPTY_COMMENT) } if (match[1]) { // éæ³•ç»“æŸ \u0026lt;!-- --!\u0026gt;  emitError(context, ErrorCodes.INCORRECTLY_CLOSED_COMMENT) } // æ³¨é‡Šå†…å®¹  content = context.source.slice(4, match.index) // åµŒå¥—æ³¨é‡Š  const s = context.source.slice(0, match.index) let prevIndex = 1, nestedIndex = 0 while ((nestedIndex = s.indexOf(\u0026#39;\u0026lt;!--\u0026#39;, prevIndex)) !== -1) { advanceBy(context, nestedIndex - prevIndex + 1) if (nestedIndex + 4 \u0026lt; s.length) { emitError(context, ErrorCodes.NESTED_COMMENT) } prevIndex = nestedIndex + 1 } advanceBy(context, match.index + match[0].length - prevIndex + 1) } return { type: NodeTypes.COMMENT, content, loc: getSelection(context, start) } }      é€šè¿‡ /--(\\!)?\u0026gt;/ åŒ¹é…æ³¨é‡Šçš„ç»“æŸ\n  å¦‚æœæ— æ³•åŒ¹é…åˆ°ï¼Œè¯´æ˜æ˜¯éæ³•æ³¨é‡Šï¼Œå¦‚ï¼š \u0026lt;!-- xxx -\u0026gt;\n  åŒ¹é…åˆ°ä¹‹åçš„éæ³•æƒ…å†µ(match.index \u0026lt;= 3)ï¼š \u0026lt;!--\u0026gt; æˆ– \u0026lt;!---\u0026gt;\n  æ•è·ç»„((\\!))ä¹ŸåŒ¹é…åˆ°äº†ï¼Œéæ³•ç»“æŸï¼š \u0026lt;!-- --!\u0026gt;\n  åµŒå¥—æ³¨é‡Šä¹Ÿè§†ä¸ºéæ³•\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const catchError = fn =\u0026gt; { try { fn() } catch (e) { console.log(e.message) } } let ast = baseParse(`\u0026lt;!-- xx --\u0026gt;`) console.log(`\u0026gt;\u0026gt;\u0026gt; éæ³•æ³¨é‡Šï¼š\u0026#34;\u0026lt;!-- xxx -\u0026gt;\u0026#34;`) catchError( () =\u0026gt; baseParse(`\u0026lt;!-- xxx -\u0026gt;`)) console.log(`\u0026gt;\u0026gt;\u0026gt; éæ³•æ³¨é‡Šï¼š\u0026#34;\u0026lt;!---\u0026gt;\u0026#34;`) catchError( () =\u0026gt; baseParse(`\u0026lt;!---\u0026gt;`)) console.log(`\u0026gt;\u0026gt;\u0026gt; éæ³•æ³¨é‡Šï¼š\u0026#34;\u0026lt;!-- xx --!\u0026gt;\u0026#34;`) catchError( () =\u0026gt; baseParse(`\u0026lt;!-- xx --!\u0026gt;`)) console.log(`\u0026gt;\u0026gt;\u0026gt; åµŒå¥—æ³¨é‡Šï¼š\u0026#34;\u0026lt;!-- \u0026lt;!-- --\u0026gt;\u0026#34;`) catchError( () =\u0026gt; baseParse(`\u0026lt;!-- \u0026lt;!-- --\u0026gt;`)) console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; æœ‰æ•ˆæ³¨é‡Š\u0026#39;) console.log(ast)     +RESULTS:\n\u0026gt;\u0026gt;\u0026gt; éæ³•æ³¨é‡Šï¼š\u0026#34;\u0026lt;!-- xxx -\u0026gt;\u0026#34; Unexpected EOF in comment. \u0026gt;\u0026gt;\u0026gt; éæ³•æ³¨é‡Šï¼š\u0026#34;\u0026lt;!---\u0026gt;\u0026#34; Illegal comment. \u0026gt;\u0026gt;\u0026gt; éæ³•æ³¨é‡Šï¼š\u0026#34;\u0026lt;!-- xx --!\u0026gt;\u0026#34; Incorrectly closed comment. \u0026gt;\u0026gt;\u0026gt; åµŒå¥—æ³¨é‡Šï¼š\u0026#34;\u0026lt;!-- \u0026lt;!-- --\u0026gt;\u0026#34; Unexpected \u0026#39;\u0026lt;!--\u0026#39; in comment. \u0026gt;\u0026gt;\u0026gt; æœ‰æ•ˆæ³¨é‡Š { type: 0, children: [ { type: 3, content: \u0026#39; xx \u0026#39;, loc: [Object] } ], // ... }    7d5f9c4 add bogus comment parser(parseBogusComment)   feat(add): bogus comment parser Â· gcclll/stb-vue-next@7d5f9c4\n åŒ¹é…æ­£åˆ™ï¼š /^\u0026lt;(?:[\\!\\?]|\\/[^a-z\u0026gt;])/i\n   \u0026lt;!DOCTYPE æ³¨é‡Š\n  \u0026lt;![[CDATA\u0026gt; ç±»å‹\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  function parseBogusComment(context: ParserContext): CommentNode | undefined { // \u0026lt;?... or \u0026lt;!... or \u0026lt;/.... å½¢å¼æ³¨é‡Š ???  __TEST__ \u0026amp;\u0026amp; assert(/^\u0026lt;(?:[\\!\\?]|\\/[^a-z\u0026gt;])/i.test(context.source)) const start = getCursor(context) const contentStart = context.source[1] === \u0026#39;?\u0026#39; ? 1 : 2 let content: string // ç»“æŸ  const closeIndex = context.source.indexOf(\u0026#39;\u0026gt;\u0026#39;) if (closeIndex === -1) { content = context.source.slice(contentStart) advanceBy(context, context.source.length) } else { content = context.source.slice(contentStart, closeIndex) advanceBy(context, closeIndex + 1) } return { type: NodeTypes.COMMENT, content, loc: getSelection(context, start) } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const catchError = fn =\u0026gt; { let res try { res = fn() } catch (e) { console.log(e.message) } res \u0026amp;\u0026amp; console.log(res) } // html ä¸­ä½¿ç”¨ \u0026lt;![CDATA[ æ³¨é‡Š catchError(() =\u0026gt; baseParse(`\u0026lt;![CDATA[ xxx ]]`)) catchError(() =\u0026gt; baseParse(`\u0026lt;!DOCTYPE xxx \u0026gt;`))     +RESULTS:\nCDATA section is allowed only in XML context. { type: 0, children: [ { type: 3, content: \u0026#39;DOCTYPE xxx \u0026#39;, loc: [Object] } ], }    cef8485 add more error element situations   feat(add): more error element situations Â· gcclll/stb-vue-next@cef8485\n æ›´å¤šé”™è¯¯æ ‡ç­¾æƒ…å†µï¼Œä»¥ \u0026lt;/ å¼€å¤´çš„æƒ…å†µå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const catchError = fn =\u0026gt; { let res try { res = fn() } catch (e) { console.log(e.message) } res \u0026amp;\u0026amp; console.log(res) } catchError(() =\u0026gt; baseParse(`\u0026lt;/`)) catchError(() =\u0026gt; baseParse(`\u0026lt;/\u0026gt;`)) catchError(() =\u0026gt; baseParse(`\u0026lt;/xx\u0026gt;`)) catchError(() =\u0026gt; baseParse(`\u0026lt;?`)) catchError(() =\u0026gt; baseParse(`\u0026lt;*`))     +RESULTS:\nUnexpected EOF in tag. End tag name was expected. Invalid end tag. \u0026#39;\u0026lt;?\u0026#39; is allowed only in XML context. Illegal tag name. Use \u0026#39;\u0026amp;lt;\u0026#39; to print \u0026#39;\u0026lt;\u0026#39;.    b8cb825 add interpolation parser   feat(add): interpolation parser Â· gcclll/stb-vue-next@b8cb825\n æ’å€¼è§£æã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  function parseInterpolation( context: ParserContext, mode: TextModes ): InterpolationNode | undefined { const [open, close] = context.options.delimiters __TEST__ \u0026amp;\u0026amp; assert(startsWith(context.source, open)) const closeIndex = context.source.indexOf(close, open.length) if (closeIndex === -1) { emitError(context, ErrorCodes.X_MISSING_INTERPOLATION_END) return undefined } const start = getCursor(context) advanceBy(context, open.length) const innerStart = getCursor(context) const innerEnd = getCursor(context) // æ’å€¼å†…å®¹é•¿åº¦  const rawContentLength = closeIndex - open.length const rawContent = context.source.slice(0, rawContentLength) // html è¯­ä¹‰åŒ–ç¬¦å·æ›¿æ¢  const preTrimContent = parseTextData(context, rawContentLength, mode) // å»æ‰å‰åç©ºæ ¼  const content = preTrimContent.trim() // å»æ‰ç©ºæ ¼åçš„å†…å®¹æ‰€åœ¨çš„ç´¢å¼•ä½ç½®  const startOffset = preTrimContent.indexOf(content) if (startOffset \u0026gt; 0) { advancePositionWithMutation(innerStart, rawContent, startOffset) } const endOffset = rawContentLength - (preTrimContent.length - content.length - startOffset) advancePositionWithMutation(innerEnd, rawContent, endOffset) advanceBy(context, close.length) return { type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, isStatic: false, isConstant: false, content, loc: getSelection(context, innerStart, innerEnd) }, loc: getSelection(context, start) } }     æ‰§è¡Œæ“ä½œï¼š\n  æ ¹æ® {{, }} å–å‡ºæ’å€¼èµ·å§‹ç´¢å¼•\n  æˆªå–æ’å€¼å†…å®¹ï¼Œæ›¿æ¢ html è¯­ä¹‰å­—ç¬¦ï¼Œä¸”å»æ‰å‰åç©ºæ ¼\n  ç»„è£…æ’å€¼ç»“æ„\n  1 2 3 4 5 6 7 8  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const ast = baseParse(`{{ foo.value }}`) console.log(ast) console.log(`\u0026gt;\u0026gt;\u0026gt; æ’å€¼èŠ‚ç‚¹`) console.log(ast.children[0])     +RESULTS:\n{ type: 0, children: [ { type: 5, content: [Object], loc: [Object] } ], } \u0026gt;\u0026gt;\u0026gt; æ’å€¼èŠ‚ç‚¹ { type: 5, content: { type: 4, isStatic: false, isConstant: false, content: \u0026#39;foo.value\u0026#39;, loc: { start: [Object], end: [Object], source: \u0026#39;foo.value\u0026#39; } }, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 16, line: 1, offset: 15 }, source: \u0026#39;{{ foo.value }}\u0026#39; } } undefined    397da38 add element parser   feat(add): parse element function Â· gcclll/stb-vue-next@397da38\n è§£æå…ƒç´ æ ‡ç­¾çš„å…¥å£å‡½æ•°ï¼Œå®é™…è¯¦ç»†è§£æåœ¨ parseTag() å‡½æ•°ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç»“åˆ parseTag çš„å®ç°æ‰èƒ½æµ‹è¯•ã€‚\n ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  function parseElement( context: ParserContext, ancestors: ElementNode[] ): ElementNode | undefined { __TEST__ \u0026amp;\u0026amp; assert(/^\u0026lt;[a-z]/i.test(context.source)) const wasInPre = context.inPre const wasInVPre = context.inVPre const parent = last(ancestors) // è§£æå‡ºå¼€å§‹æ ‡ç­¾  const element = {} as any // parseTag(context, TagType.Start, parent)  const isPreBoundray = context.inPre \u0026amp;\u0026amp; !wasInPre const isVPreBoundray = context.inVPre \u0026amp;\u0026amp; !wasInVPre if (element.isSelfClosing || context.options.isVoidTag(elment.tag)) { return element } ancestors.push(element) const mode = context.options.getTextMode(element, parent) const children = parseChildren(context, mode, ancestors) // è¦å°†å­©å­èŠ‚ç‚¹è§£æå®Œæˆçš„ parent element pop æ‰ï¼Œå¾…å¤„ç†ä¸‹ä¸€ä¸ª parent çš„ children  ancestors.pop() if (startsWithEndTagOpen(context.source, element.tag)) { // ç»“æŸæ ‡ç­¾  // parseTag(context, TagType.End, parent)  } else { emitError(context, ErrorCodes.X_MISSING_END_TAG, 0, element.loc.start) if (context.source.length === 0 \u0026amp;\u0026amp; element.tag.toLowerCase() === \u0026#39;script\u0026#39;) { const first = children[0] if (first \u0026amp;\u0026amp; startsWith(first.loc.source, \u0026#39;\u0026lt;!--\u0026#39;)) { emitError(context, ErrorCodes.EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT) } } } element.loc = getSelection(context, element.loc.start) if (isPreBoundray) { context.inPre = false } if (isVPreBoundray) { context.inVPre = false } return element }     æºç åˆ†æï¼š\n  é€šè¿‡è°ƒç”¨ parseTag() è§£æå‡ºæ ‡ç­¾å…ƒç´ ç»“æ„\n  åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾(\u0026lt;div/\u0026gt;)ï¼Œæˆ–è€…å¤–éƒ¨å®šä¹‰çš„ç©ºæ ‡ç­¾(ä¸éœ€è¦ç»“æŸæ ‡ç­¾çš„ï¼Œå¦‚ï¼š \u0026lt;my-tag\u0026gt; ï¼Œä¸ºåˆæ³•æ ‡ç­¾)\n  è°ƒç”¨ parseChildren() é€’å½’è§£æè¯¥èŠ‚ç‚¹ä¸‹å­å­™èŠ‚ç‚¹\n  ç»“æŸæ ‡ç­¾è§£æ\n  \u0026lt;pre\u0026gt; å’Œ v-pre æ£€æµ‹\n    3b96a74 add tag parser   feat(add): tag parser Â· gcclll/stb-vue-next@3b96a74\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  function parseTag( context: ParserContext, type: TagType, parent: ElementNode | undefined ): ElementNode { // åŒ¹é… \u0026lt;div\u0026gt; æˆ– \u0026lt;/div\u0026gt;  __TEST__ \u0026amp;\u0026amp; assert(/^\u0026lt;\\/?[a-z]/i.test(context.source)) __TEST__ \u0026amp;\u0026amp; assert( type === (startsWith(context.source, \u0026#39;\u0026lt;/\u0026#39;) ? TagType.End : TagType.Start) ) // å¼€å§‹æ ‡ç­¾  const start = getCursor(context) const match = /^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i.exec(context.source)! const tag = match[1] const ns = context.options.getNamespace(tag, parent) advanceBy(context, match[0].length) advanceSpaces(context) // ä¿å­˜å½“å‰çŠ¶æ€ï¼Œå¾…ä¼šéœ€è¦å›è¿‡å¤´æ¥è§£æå±æ€§  // const cursor = getCursor(context)  // const currentSource = context.source  // è§£æå±æ€§  let props = [] as any[] // TODO parseAttributes(context, type)  // TODO \u0026lt;pre\u0026gt; æ ‡ç­¾  // TODO v-pre æŒ‡ä»¤  // ç»“æŸæ ‡ç­¾  let isSelfClosing = false if (context.source.length === 0) { emitError(context, ErrorCodes.EOF_IN_TAG) } else { // \u0026lt;div ... /\u0026gt;  isSelfClosing = startsWith(context.source, \u0026#39;/\u0026gt;\u0026#39;) // åˆ°è¿™é‡Œä¸åº”è¯¥æ˜¯ End æ ‡ç­¾  if (type === TagType.End \u0026amp;\u0026amp; isSelfClosing) { emitError(context, ErrorCodes.END_TAG_WITH_TRAILING_SOLIDUS) } advanceBy(context, isSelfClosing ? 2 : 1) } let tagType = ElementTypes.ELEMENT // TODO æ ‡ç­¾ç±»å‹è§£æ  return { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined } }      å¼€å§‹æ ‡ç­¾åŒ¹é…æ­£åˆ™ï¼š /^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i\n   \u0026lt;pre\u0026gt; æ ‡ç­¾å¤„ç†\n  v-pre æŒ‡ä»¤å¤„ç†\n  è‡ªé—­åˆæ ‡ç­¾å¤„ç†\n  ç»„è£…å…ƒç´ ç»“æ„ NodeTypes.ELEMENT\n   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) let ast = baseParse(`\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;`) console.log(`\u0026gt;\u0026gt;\u0026gt; æ™®é€šæ ‡ç­¾`) console.log(ast.children[0]) ast = baseParse(`\u0026lt;img/\u0026gt;`) console.log(`\u0026gt;\u0026gt;\u0026gt; è‡ªé—­åˆæ ‡ç­¾`) console.log(ast.children[0]) console.log(`\u0026gt;\u0026gt;\u0026gt; è‡ªå®šä¹‰ç©ºæ ‡ç­¾ \u0026lt;mydiv\u0026gt;`) ast = baseParse(`\u0026lt;mydiv\u0026gt;`, { isVoidTag: () =\u0026gt; `mydiv` }) console.log(ast.children[0])     +RESULTS: çœç•¥éƒ¨åˆ†è¾“å‡º\n\u0026gt;\u0026gt;\u0026gt; æ™®é€šæ ‡ç­¾ { type: 1, ns: 0, tag: \u0026#39;div\u0026#39;, tagType: 0, props: [], isSelfClosing: false, children: [], } \u0026gt;\u0026gt;\u0026gt; è‡ªé—­åˆæ ‡ç­¾ { type: 1, ns: 0, tag: \u0026#39;img\u0026#39;, tagType: 0, props: [], isSelfClosing: true, children: [], } \u0026gt;\u0026gt;\u0026gt; è‡ªå®šä¹‰ç©ºæ ‡ç­¾ \u0026lt;mydiv\u0026gt; { type: 1, ns: 0, tag: \u0026#39;mydiv\u0026#39;, tagType: 0, props: [], isSelfClosing: false, children: [], }    bf28a36 add tag parser of tag type   feat(add): parse tag for tag type Â· gcclll/stb-vue-next@bf28a36\n è§£æå‡ºæ ‡ç­¾çš„æ ‡ç­¾å(component ? template ? slot ? â€¦)ã€‚\n  if (options.isNativeTag \u0026amp;\u0026amp; !hasVIs)\n !options.isNativeTag(tag) å¦‚æœä¸æ˜¯åŸç”Ÿæ ‡ç­¾ï¼Œåˆ™è§†ä¸º COMPONENT\n  ç¬¬äºŒç§ä¸º COMPONENT æƒ…å†µ\n1 2 3 4 5 6 7  else if ( hasVIs || isCoreComponent(tag) || (options.isBuiltInComponent \u0026amp;\u0026amp; options.isBuiltInComponent(tag)) || /^[A-Z].test(tag)/ || tag === \u0026#39;component\u0026#39; )      æœ‰ v-is æŒ‡ä»¤\n  isCoreComponent() vue å†…ç½®æ ‡ç­¾(Teleport, Suspense, KeepAlive, BaseTransition)\n  é€‰é¡¹ä¸­è‡ªå®šä¹‰çš„\n  æ ‡ç­¾åé¦–å­—æ¯å¤§å†™çš„ä¹Ÿè§†ä¸º component\n  æ ‡ç­¾åç›´æ¥æ˜¯ component çš„\n    if (tag === \u0026#39;slot\u0026#39;) æ’æ§½æ ‡ç­¾\n  \u0026lt;template\u0026gt; æ ‡ç­¾ï¼Œä¸”å¸¦æœ‰æŒ‡ä»¤\n1 2 3 4 5 6  tag === \u0026#39;template\u0026#39; \u0026amp;\u0026amp; props.some(p =\u0026gt; { return ( p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; isSpecialTemplateDirective(p.name) ) })     ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤ï¼š\n1 2 3  const isSpecialTemplateDirective = /*#__PURE__*/ makeMap( `if,else,else-if,for,slot` )      è¿™ä¸ªç”±äºéœ€è¦ç”¨åˆ°å±æ€§ï¼Œæ‰€ä»¥éœ€è¦ç»“åˆ parseAttributes å®ç°æ‰èƒ½è¿›è¡Œæµ‹è¯•ã€‚\n  73fd01f add attribute name and value parser   feat(add): attribute name and value parser Â· gcclll/stb-vue-next@73fd01f\n è¿™é‡Œæ–°å¢äº†ä¸‰ä¸ªå‡½æ•°(ä»£ç è¾ƒå¤šï¼Œéœ€è¦æŸ¥çœ‹æºç ç›´æ¥ç‚¹å‡»ä¸Šé¢ commit é“¾æ¥)\n  parseAttributes(context, type) å±æ€§è§£æå…¥å£ï¼Œé€šè¿‡ while å¾ªç¯è§£æå‡ºæ‰€æœ‰å±æ€§\n  parseAttribute(context, nameSet) è§£æå•ä¸ªå±æ€§ï¼Œå±æ€§åç”¨ nameSet é›†åˆå­˜å‚¨é¿ å…é‡å¤\n  parseAttributeValue(context) è§£æå±æ€§å€¼\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const ast = baseParse(`\u0026lt;div class=\u0026#34;app\u0026#34; :staticPropName=\u0026#34;bar\u0026#34; @press.enter=\u0026#34;pressKey\u0026#34; :[dynamicPropName]=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`) const ele = ast.children[0] console.log(ele) console.log(`\u0026gt;\u0026gt;\u0026gt; é™æ€å±æ€§ï¼šclass`) console.log(ele.props[0]) console.log(`\u0026gt;\u0026gt;\u0026gt; åŠ¨æ€å±æ€§é™æ€å±æ€§åï¼šstaticPropName`) console.log(ele.props[1]) console.log(`\u0026gt;\u0026gt;\u0026gt; å¸¦ä¿®é¥°ç¬¦çš„å±æ€§ï¼špress.enter`) console.log(ele.props[2]) console.log(`\u0026gt;\u0026gt;\u0026gt; åŠ¨æ€å±æ€§åï¼šdynamicPropName`) console.log(ele.props[3])     +RESULTS: å…ƒç´ ç»“æ„\n{ type: 1, ns: 0, tag: \u0026#39;div\u0026#39;, tagType: 1, props: [...], // å¦‚ä¸‹ isSelfClosing: false, children: [], }   +RESULTS: å±æ€§åˆ—è¡¨ï¼Œ çœç•¥ loc ä½ç½®æ•°æ®\n\u0026gt;\u0026gt;\u0026gt; é™æ€å±æ€§ï¼šclass { type: 6, name: \u0026#39;class\u0026#39;, value: { type: 2, content: \u0026#39;app\u0026#39;, } } \u0026gt;\u0026gt;\u0026gt; åŠ¨æ€å±æ€§é™æ€å±æ€§åï¼šstaticPropName { type: 7, name: \u0026#39;bind\u0026#39;, exp: { type: 4, content: \u0026#39;bar\u0026#39;, isStatic: false, isConstant: false, }, arg: { type: 4, content: \u0026#39;staticPropName\u0026#39;, isStatic: true, isConstant: true, }, modifiers: [], } \u0026gt;\u0026gt;\u0026gt; å¸¦ä¿®é¥°ç¬¦çš„å±æ€§ï¼špress.enter { type: 7, name: \u0026#39;on\u0026#39;, exp: { type: 4, content: \u0026#39;pressKey\u0026#39;, isStatic: false, isConstant: false, }, arg: { type: 4, content: \u0026#39;press\u0026#39;, isStatic: true, isConstant: true, }, modifiers: [ \u0026#39;enter\u0026#39; ], } \u0026gt;\u0026gt;\u0026gt; åŠ¨æ€å±æ€§åï¼šdynamicPropName { type: 7, name: \u0026#39;bind\u0026#39;, exp: { type: 4, content: \u0026#39;foo\u0026#39;, isStatic: false, isConstant: false, }, arg: { type: 4, content: \u0026#39;dynamicPropName\u0026#39;, isStatic: false, isConstant: false, }, modifiers: [], }    e32401e add combine whitespace nodes   feat(add): combine whitespace node Â· gcclll/stb-vue-next@e32401e\n åˆå¹¶åˆ é™¤ç©ºè¡Œæˆ–ç©ºå­—ç¬¦ä¸²èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const ast = baseParse(` \u0026lt;div\u0026gt; some text other text \u0026lt;/div\u0026gt;`) console.log(ast.children[0].children[0])     +RESULTS: æ­£ç¡®ç»“æœ\n{ type: 2, content: \u0026#39; some text other text \u0026#39;, loc: { start: { column: 6, line: 2, offset: 6 }, end: { column: 1, line: 5, offset: 28 }, source: \u0026#39;\\nsome text\\nother text\\n\u0026#39; } }   +RESULTS: \u0026#39;sometextothertext\u0026#39; ç©ºæ ¼éƒ½è¢«åˆ äº†ï¼Ÿ fix: all whitespce removed Â· gcclll/stb-vue-next@bb31509\n{ type: 1, ns: 0, tag: \u0026#39;div\u0026#39;, tagType: 1, props: [], isSelfClosing: false, children: [ { type: 2, content: \u0026#39;sometextothertext\u0026#39;, loc: [Object] } ], loc: { start: { column: 1, line: 2, offset: 1 }, end: { column: 7, line: 5, offset: 34 }, source: \u0026#39;\u0026lt;div\u0026gt;\\nsome text\\nother text\\n\u0026lt;/div\u0026gt;\u0026#39; }, codegenNode: undefined } undefined   +RESULTS: children = [] ? fix: no children Â· gcclll/stb-vue-next@66936f3\n{ type: 1, ns: 0, tag: \u0026#39;div\u0026#39;, tagType: 1, props: [], isSelfClosing: false, children: [], loc: { start: { column: 1, line: 2, offset: 1 }, end: { column: 7, line: 5, offset: 34 }, source: \u0026#39;\u0026lt;div\u0026gt;\\nsome text\\nother text\\n\u0026lt;/div\u0026gt;\u0026#39; }, codegenNode: undefined } undefined    ç”¨ä¾‹æµ‹è¯•   \u0026lt;f12\u0026gt; æ‰“å¼€æ§åˆ¶å°æœ‰æƒŠå–œå“¦â•°(Â°â–½Â°)â•¯ ğŸ‘€ğŸ‘€ğŸ‘€ğŸ‘€ğŸ‘€ğŸ‘€ğŸ‘€ğŸ‘€ã€‚\n ä¸‹é¢ç« èŠ‚æ‰€æœ‰æµ‹è¯•éƒ½æ˜¯æ ¹æ®å®˜æ–¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œçš„ï¼šparse.spec.ts\n try { let i = 0, j = 0 const { baseParse } = VueCompilerCore const l1 = x = console.log(`%c  ${++i} ${x}`, 'background: #222; color: #bada55') const l2 = x = console.log(`%c  ${i}.${j++} ${x}`, 'background: #222; color: #bada55') const log = (args) = console.log.apply(console, args) const parse = (content, option = {}) = log(baseParse(content, { onError: (e) = console.warn(e.message), ...option }).children) l1('Text, æ–‡æœ¬æµ‹è¯•') l2(`æ— æ•ˆçš„ç»“æŸæ ‡ç­¾(\"some text\")ã€‚`) parse(`some text`) l2(`æ’å€¼è§£æ(\"some {{ foo + bar }} text\")`) parse(`some {{ foo + bar }} text`) l2(`è¡¨è¾¾å¼åŒ…å« ç¬¦å·çš„å·®å€¼(\"some {{ ad }} text\")`) log(['æ’å€¼å†…çš„å†…å®¹éƒ½ä¼šä»¥ {{ å¼€å§‹ }} ç»“æŸç›´æ¥æˆªå–ä½œä¸º contentï¼Œæ‰€ä»¥è¿™é‡Œé¢çš„ éƒ½æ˜¯åˆæ³•çš„å­˜åœ¨']) parse(`some {{ ad }} text`) l2(`æ ‡ç­¾ + æ’å€¼æ··åˆ(\"some {{ foo \")`) parse(`some {{ foo `) l2(`å•ä¸ª d }}`) parse(`{{ ad }}`) l2(`æ’å€¼å†…éƒ¨å…è®¸å­˜åœ¨ä¸€äº›ç¬¦åˆæ³•æ ‡ç­¾('{{ \"\" }}')`) parse(`{{ \"\" }}`) l2(`å¯ä»¥è‡ªå®šä¹‰æ’å€¼åˆ†éš”ç¬¦ï¼Œå¦‚ï¼š\"{\" å’Œ \"}\"`) parse(`{msg}\n`, { delimiters: ['{', '}'] }) j = 0 l1(`Comment, æ³¨é‡Š`) l2(`ç©ºæ³¨é‡Š(\"\")`) parse(``) l2(`ç®€å•æ³¨é‡Š(\"\")`) parse(``) l2(`ä¸¤ä¸ªæ³¨é‡Š(\"\")`) parse(``) l2(`ç”Ÿæˆæ¨¡å¼ä¸‹  ä¸­çš„æ³¨é‡Šåº”è¯¥è¢«åˆ é™¤(\"\")`) parse(``) j = 0 l1(`Element, æ™®é€šæ ‡ç­¾`) l2(`simple div(\"hello\")`) parse(`hello`) l2(`empty div(\"\")`) parse(``) l2(`è‡ªé—­åˆæ ‡ç­¾(\"after\")`) parse(`after`) l2(`ç©ºæ ‡ç­¾(\"after\")`) parse(`after`, { isVoidTag: tag = tag === 'img' }) l2(`å¸¦æŒ‡ä»¤çš„ (\"\")`) parse(``) l2(`ä¸å¸¦æŒ‡ä»¤çš„ (\"\")`) parse(``) l2(`åŸç”Ÿæ ‡ç­¾(\"\")`) parse(``, { isNativeTag: tag = tag === 'div' }) l2(`v-is with \"isNativeTag\"(\"\")`) parse(``, { isNativeTag: tag = tag === 'div' }) l2(`v-is without \"isNativeTag\"(\"\")`) parse(``) l2(`è‡ªå®šä¹‰å…ƒç´ (\"\")`) log([`è‡ªå®šä¹‰å…ƒç´ çš„ç±»å‹ä¸º 0,ELEMENT`]) parse(``, { isNativeTag: tag = tag === 'div', isCustomElement: tag = tag === 'comp' }) l2(`å†…ç½®ç»„ä»¶(\"\")`) parse(``, { isBuiltInComponent: tag = (tag === 'comp' ? Symbol() : void 0) }) l2(`æ’æ§½å…ƒç´ (\"\")`) parse(``) l2(`æ²¡æœ‰å€¼çš„å±æ€§(\"\")`) parse(``) l2(`ç©ºå€¼å±æ€§ï¼ŒåŒå¼•å·(\"\")`) parse(``) l2(`ç©ºå€¼å±æ€§ï¼Œå•å¼•å·(\"\")`) parse(``) l2(`æœ‰å€¼å±æ€§ï¼ŒåŒå¼•å·(\"\\'\"\")`) parse(`\\'\"`) l2(`æœ‰å€¼å±æ€§ï¼Œå•å¼•å·(\"\\\"'\")`) parse(`\\\"'`) l2(`æœ‰å€¼å±æ€§ï¼Œæ²¡æœ‰å¼•å·(\"\")`) log([`æ²¡æœ‰å¼•å·çš„æƒ…å†µï¼Œå±æ€§å€¼ä¼šè§£æåˆ° \"\" ç¬¦å·ç»“æŸ`]) parse(``) l2(`å¤šä¸ªå±æ€§(\"\")`) parse(``) l2(`æ— å€¼æŒ‡ä»¤(\"\")`) parse(``) l2(`æœ‰å€¼æŒ‡ä»¤(\"\")`) log([`æœ‰å€¼æŒ‡ä»¤ï¼Œå€¼ä¼šè§£æåˆ°å±æ€§è¡¨è¾¾å¼ä¸Š prop.exp = {...}`]) parse(``) l2(`æœ‰å‚æ•°æŒ‡ä»¤(\"\")`) log([`å‚æ•°ä¼šè¢«è§£æåˆ° prop.arg ä¸Šï¼ŒisStatic = isConstant = true`]) parse(``) l2(`æœ‰åŠ¨æ€å‚æ•°æŒ‡ä»¤(\"\")`) log([`å‚æ•°ä¼šè¢«è§£æåˆ° prop.arg ä¸Šï¼Œ isStatic = isConstant = false`]) parse(``) l2(`å¸¦ä¿®é¥°ç¬¦çš„æŒ‡ä»¤(\"\")`) log([`ä¿®é¥°ç¬¦ä¼šè¢«è§£æåˆ° prop.modifiers = [ 'enter' ] ä¸­`]) parse(``) l2(`ä¸¤ä¸ªä¿®é¥°ç¬¦çš„æŒ‡ä»¤(\"\")`) log([`ä¿®é¥°ç¬¦ä¼šè¢«è§£æåˆ° prop.modifiers = [ 'enter', 'exact' ] ä¸­`]) parse(``) l2(`å¸¦å‚æ•°å’Œä¿®é¥°ç¬¦çš„æŒ‡ä»¤(\"\")`) parse(``) l2(`å¸¦åŠ¨æ€å‚æ•°å’Œä¿®é¥°ç¬¦çš„æŒ‡ä»¤(\"\")`) parse(``) l2(`v-bind ç¼©å†™ \":\"(\"\")`) parse(``) l2(`v-bind ç¼©å†™ï¼Œå¸¦ä¿®é¥°ç¬¦(\"\")`) parse(``) l2(`v-on ç¼©å†™(\"\")`) parse(``) l2(`v-on ç¼©å†™ï¼Œå¸¦ä¿®é¥°ç¬¦(\"\")`) parse(``) l2(`v-slot ç¼©å†™(\"\")`) parse(``) l2(`v-slot åŒ…å«ç‚¹è¯­æ³•çš„(\"\")`) parse(``) l2(`v-pre æŒ‡ä»¤`) log([ `{{ bar }}\\n` + `{{ bar }}` ]) parse( `{{ bar }}\\n` + `{{ bar }}` ) l2(`ç»“æŸæ ‡ç­¾å¤§å°å†™ä¸æ•æ„Ÿ(\"helloafter\")`) parse(`helloafter`) j = 0 l1(`å…¶ä»–æƒ…å†µ`) l2(`è‡ªé—­åˆæ ‡ç­¾(\"\")`) parse(``) l2(`å¤šä¸ªè‡ªé—­åˆæ ‡ç­¾`) log([ `\\n` + `` ]) parse( `\\n` + `` ) l2(`å¤åˆç±»å‹æ ‡ç­¾ç»„åˆ`) log([ `\\n` + ` \\n` + ` inside it --\\n` + `` ]) parse( `\\n` + ` \\n` + ` inside it --\\n` + `` ) l2(`æ— æ•ˆçš„å¤åˆç±»å‹æ ‡ç­¾ç»„åˆ(\"\\n\\n\\n\")`) parse(`\\n\\n\\n`) l2(`æ­£ç¡®çš„ä½ç½®ä¿¡æ¯`) log([ ` foo is {{ bar }} but {{ baz }}` ]) parse(` foo is {{ bar }} but {{ baz }}` ) j = 0 l1(\"HTML Entities è§£ç \") l2(`ä½¿ç”¨é»˜è®¤æ˜ å°„å…³ç³»(\"\u0026gt;\u0026lt;\u0026amp;\u0026apos;\u0026quot;\u0026foo;\")`) parse(`\u0026gt;\u0026lt;\u0026amp;\u0026apos;\u0026quot;\u0026foo;`) l2(`ä½¿ç”¨è‡ªå®šä¹‰æ˜ å°„å…³ç³»(\"\u0026amp;\u0026cups;\")`) parse(`\u0026amp;\u0026cups;`, { decodeEntities: text = text.replace('\u0026cups;', '\\u222A\\uFE00') }) j = 0 l1(\"ç©ºæ ¼ç®¡ç†\") l2(`åœ¨æ ‡ç­¾å†…çš„ç©ºæ ¼åº”è¯¥åˆ é™¤(\"  \")`) parse(`  `) l2(`æ ‡ç­¾ä¹‹é—´çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦åº”è¯¥åˆ é™¤(\" \\n  \\n \")`) parse(` \\n  \\n `) l2(`ä¸æ³¨é‡Šç›¸é‚»çš„ç©ºæ ¼åº”è¯¥åˆ é™¤(\" \\n  \")`) parse(` \\n  `) l2(`æ³¨é‡Šä¸å…ƒç´ ä¹‹é—´çš„ç©ºæ ¼åº”è¯¥åˆ é™¤(\" \\n  \\n \")`) parse(` \\n  \\n `) l2(`æ’å€¼ä¹‹é—´çš„æ³¨é‡Šä¸åº”è¯¥åˆ é™¤(\"{{ foo }} \\n {{ bar }}\")`) parse(`{{ foo }} \\n {{ bar }}`) l2(`å…ƒç´ ä¹‹é—´çš„ç©ºæ ¼ä¸åº”è¯¥åˆ é™¤(\"  \")`) parse(`  `) l2(`æ–‡æœ¬ä¹‹é—´çš„ç©ºæ ¼åº”è¯¥åˆå¹¶æˆä¸€ä¸ª(\" foo \\n bar baz \")`) parse(' foo \\n bar baz ') l2(` æ ‡ç­¾ä¸­çš„é¦–è¡Œç©ºæ ¼åº”è¯¥åˆ é™¤(\"\\n foo bar \")`) parse(`\\n foo bar `) l2(` åœ¨å­å…ƒç´ åé¢çš„æ¢è¡Œç¬¦ä¸è¯¥åˆ é™¤(\"\\n foo bar \")`) parse(`\\n foo bar `) j = 0 const err = ( content, info ) = (l2(info ? `${info} (\"${content}\")` : content), parse(content)) l1(`Errors, é”™è¯¯`) err(``) err(``) err(``) err(``) err(``, \"ä¸èƒ½åœ¨ HTML ä¸­ä½¿ç”¨ CDATA\") err(``, \"é‡å¤å±æ€§\") err(``, \"ç»“æŸæ ‡ç­¾ä¸Šä¸èƒ½æœ‰å±æ€§\") err(``, \"ç»“æŸæ ‡ç­¾æœ€åå¤šäº†ä¸ªæ–œæ '/'\") err(`æ ‡ç­¾ä¸­ä¸èƒ½ä½¿ç”¨ html æ³¨é‡Š\") err(`console.log('hello')`, \" ç¼ºå°‘ç»“æŸæ ‡ç­¾\") err(``, \"é”™è¯¯æ³¨é‡Šç»“æŸ\") err(``, \"é”™è¯¯æ³¨é‡Šå¼€å§‹ 1\") err(``, \"é”™è¯¯æ³¨é‡Šå¼€å§‹ 2\") err(``, \"é”™è¯¯æ³¨é‡Šå¼€å§‹ 3\") err(``, \"å¿½ç•¥ doctype\") err(`a `, \"æ ‡ç­¾åç¬¬ä¸€ä¸ªå­—ç¬¦éæ³• 1\") err(``, \"æ ‡ç­¾åç¬¬ä¸€ä¸ªå­—ç¬¦éæ³• 2\") err(`a `, \"æ ‡ç­¾åç¬¬ä¸€ä¸ªå­—ç¬¦éæ³• 3\") err(``, \"æ ‡ç­¾åç¬¬ä¸€ä¸ªå­—ç¬¦éæ³• 4\") err(`{{a `, \"æ’å€¼é‡Œé¢ `, \"æ— æ•ˆçš„å±æ€§å 1\") err(``, \"æ— æ•ˆçš„å±æ€§å 2\") err(``, \"æ— æ•ˆçš„å±æ€§å 3\") err(``, \"ç¼ºå°‘ç»“æŸæ ‡ç­¾\") err(``, \"å±æ€§ä¹‹é—´å¿…é¡»è¦æœ‰ç©ºæ ¼\") err(``, \"ä½†æ˜¯å¯ä»¥æœ‰ \\r\\n æ¢è¡Œç¬¦\") err(``, \"åµŒå¥—æ³¨é‡Š 1\") err(``, \"åµŒå¥—æ³¨é‡Š 2\") err(``, \"åµŒå¥—æ³¨é‡Š 3\") err(``, \"éæ³•æ³¨é‡Š\") err(``, \"å±æ€§åä¸­åŒ…å«éæ³•å­—ç¬¦(\\\") 1\") err(``, \"å±æ€§åä¸­åŒ…å«éæ³•å­—ç¬¦(') 2\") err(``, \"å±æ€§åä¸­åŒ…å«éæ³•å­—ç¬¦(`, \"æ²¡å¼•å·å±æ€§ä¸­çš„éæ³•å­—ç¬¦(\\\")\") err(``, \"æ²¡å¼•å·å±æ€§ä¸­çš„éæ³•å­—ç¬¦(\\')\") err(``, \"æ²¡å¼•å·å±æ€§ä¸­çš„éæ³•å­—ç¬¦(`, \"æ²¡å¼•å·å±æ€§ä¸­çš„éæ³•å­—ç¬¦(=)\") err(``, \"æ²¡å¼•å·å±æ€§ä¸­çš„éæ³•å­—ç¬¦(`)\") err(``, \"å±æ€§åä¸­çš„éæ³•å­—ç¬¦(=)\") err(``) err(``) err(``, \"æ— æ•ˆç»“æŸæ ‡ç­¾\") err(``, \"æ— æ•ˆç»“æŸæ ‡ç­¾\") err(`{{''}}`, \"æ’å€¼ä¸­æœ‰æ•ˆ\") err(``, \"å¤šè¡Œæ–‡æœ¬ä¸­æœ‰æ•ˆ\") err(`]]`, \"svg CDATA ä¸­æœ‰æ•ˆ\") err(`--`, \"æ³¨é‡Šä¸­æœ‰æ•ˆ\") err(``, \"æ²¡æœ‰ç»“æŸæ ‡ç­¾\") err(``, \"æ²¡æœ‰ç»“æŸæ ‡ç­¾\") err(`{{ foo`, \"éæ³•æ’å€¼\") err(`{{`, \"éæ³•æ’å€¼\") err(`{{}}`, \"ç©ºæ’å€¼\") err(``, \"æ— æ•ˆæŒ‡ä»¤å‚æ•°\") } catch (e) { console.log(e.message) console.log('æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ es6+ æ–°è¯­æ³•ï¼Œè¯·ä½¿ç”¨ chrome æµè§ˆã€‚') }  1 2 3 4 5 6 7 8 9 10 11  const { baseParse } = require(process.env.PWD + \u0026#39;/../../static/js/vue/compiler-core.global.js\u0026#39;) const _ = x =\u0026gt; console.log(`\u0026gt;\u0026gt;\u0026gt; ${x}`) const __ = x =\u0026gt; console.log(x) const parse = content =\u0026gt; baseParse(content, { onError: (e) =\u0026gt; console.log(e.message) }) __(parse(`some text`).children[0])     æ›´å¤šæµ‹è¯•å†…å®¹å’Œè¾“å‡º(ç”±äºç¯‡å¹…é—®é¢˜)è¯·æŸ¥çœ‹ \u0026lt;F12\u0026gt; æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ã€‚ +RESULTS:\n{ type: 2, content: \u0026#39;some text\u0026#39;, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 10, line: 1, offset: 9 }, source: \u0026#39;some text\u0026#39; } } undefined    ","permalink":"https://www.cheng92.com/vue/vue-mind-map-compiler-core-parser/","tags":["vue,","vue3,","compiler-core,","parser,","compiler"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 2 â˜compiler-core - ast parser"},{"categories":["vue"],"contents":"  æ›´æ–°æ—¥å¿—\u0026amp;Todos ï¼š\n  DONE [2021-01-20 15:16:45] ref\n    è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  function _log(el, content) { $(el).children('.result').append('' + content + '\n') }     stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„å­¦ä¹ åŠå°è¯•åº”ç”¨äºæœºé¡¶ç›’ç¯å¢ƒã€‚ \n  æœ¬æ–‡ä¾æ® commit è¿›ç¨‹è¿›è¡Œè®°å½• \n æ‰€æœ‰ç”¨ä¾‹è¯·æŒ‰ \u0026lt;f12\u0026gt; æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ \u0026gt;\n  let i = 0, j = 0 const l1 = x = (j = 0, console.log(`%c  ${++i} ${x}`, 'background: #222; color: #bada55')) const l2 = x = console.log(`%c  ${i}.${j++} ${x}`, 'background: #222; color: #bada55') const log = (args) = console.log.apply(console, Array.isArray(args) ? args : [args]) log.blue = x = log([`%c ${x}`, `color: blue`]) log.red = x = log([`%c ${x}`, `color: red`]) log.gray = x = log([`%c ${x}`, `color: gray`]) log.blues = xx = xx.forEach(x = log.blue(x)) log.gray.fn = (fn) = (log.gray(fn), fn())   const { reactive, isReactive, expect } = VueReactivity l1(`reactivity/reacitve`) l2(`Object`) log.gray.fn(() = { let original = { foo: 1 } let observed = reactive(original) log.blues([ `observed !== original, ` + (original !== observed), `observed is reactive, ` + isReactive(observed), `original is reactive, ` + isReactive(original), `observed.foo === ` + observed.foo, `\"foo\" in observed, ` + ('foo' in observed), `own keys: ` + Object.keys(observed) ]) }) l2(`proto, åŸå‹å“åº”å¼`) log.gray.fn(() = { const obj = {} const reactiveObj = reactive(obj) // å±æ€§è¯»å–ï¼Œä¼šå¯¼è‡´è¯¥å±æ€§ä¹Ÿå˜æˆ reactive const prototype = reactiveObj['__proto__'] const otherObj = { data: ['a'] } log.blues([ `\"reactiveObj\" is reactive, ` + isReactive(reactiveObj), `otherObj is reactive, ` + isReactive(otherObj) , ]) const reactiveOther = reactive(otherObj) log.blues([ `reactiveOther is reactive, ` + isReactive(otherObj), `reactiveOther.data[0] = ` + reactiveOther.data[0] ]) })  å…³é”®çŸ¥è¯†ç‚¹   è®¡ç®—å±æ€§æ˜¯å¦‚ä½•å®ç°ç»“æœç¼“å­˜çš„ï¼Ÿ\n    init project   åˆå§‹åŒ–é¡¹ç›®ï¼šfeat: reactive-fn Â· gcclll/stb-vue-next@cb3470d\n ç”±äºå®Œæ•´è„‘å›¾ä¼šæ¯”è¾ƒå…¨è€Œå¤§æ‰€ä»¥æ”¾åˆ°æ–‡å­—æœ€åå»ã€‚ã€‚ã€‚\n ä¹Ÿå¯ä»¥ç‚¹å‡»è¯¥é“¾æ¥ç›´æ¥æ–°çª—å£æ‰“å¼€ï¼Œæ•ˆæœæ›´ä½³ã€‚\n  add: createReactiveObject   feat: reactive-fn Â· gcclll/stb-vue-next@cb3470d\n  ä»…å¢åŠ å‡½æ•°å£°æ˜:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  export function reactive(target: object) { // å¦‚æœè¯•å›¾ observe ä¸€ä¸ªåªè¯» proxyï¼Œè¿”å›åªè¯»ç‰ˆæœ¬  if (target \u0026amp;\u0026amp; (target as Target)[ReactiveFlags.IS_READONLY]) { return target } return createReactiveObject( target, false, mutableHandlers, {} // mutableCollectionHandlers  ) } function createReactiveObject( target: Target, isReadonly: boolean, baseHandlers: ProxyHandler\u0026lt;any\u0026gt;, collectionHandlers: ProxyHandler\u0026lt;any\u0026gt; ) {}     mutableHandlers: æ™®é€šå¯¹è±¡ç±»å‹çš„ proxy handlers\n mutableCollectionHandlers: é›†åˆç±»å‹çš„ proxy handlersï¼Œå› ä¸º Reflect å¹¶æ²¡æœ‰å¯¹é›† åˆç±»å‹åšåº•å±‚æ˜ å°„ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚\n  feat: reactive(target)   feat: createReactiveObject Â· gcclll/stb-vue-next@443a0b5\n   é‡ç‚¹ï¼š new Proxy(target, collection)\n  è¢«ä»£ç†ç±»å‹å¿…é¡»æ˜¯å¯¹è±¡(å¼•ç”¨ç±»å‹)\n  target æœ¬èº«å·²ç»æ˜¯ proxy äº†\n  target ä»£ç†æœ‰ç¼“å­˜ä¸ç”¨é‡å¤åˆ›å»º\n  å¿…é¡»æ˜¯åˆæ³•çš„ç±»å‹(Object|Array|[Weak]Map|[Weak]Set)æ‰èƒ½è¢«ä»£ç†\n  è®°å¾—ç¼“å­˜æ–°åˆ›å»ºçš„ä»£ç†å…³ç³»(proxyMap å…¨å±€å˜é‡)\n  ç”¨ä¾‹ä¸€ï¼šæ™®é€šå¯¹è±¡  1 2 3 4 5 6 7 8 9 10 11  const { effect, reactive, targetMap, isReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const original = { foo: 1 } const observed = reactive(original) console.log(\u0026#39;observed is not orignial,\u0026#39; + original !== observed) console.log(\u0026#39;observed is reactive, \u0026#39; + isReactive(observed)) console.log(\u0026#39;original is reactive, \u0026#39; + isReactive(original)) console.log(\u0026#39;observed.foo === 1, \u0026#39; + observed.foo === 1) console.log(\u0026#39;`foo` in observed, \u0026#39; + (`foo` in observed)) console.log(`Object.keys(observed) == [\u0026#39;foo\u0026#39;], ` + (Object.keys(observed).toString() === \u0026#39;foo\u0026#39;))     +RESULTS:\ntrue observed is reactive, true original is reactive, false false `foo` in observed, true Object.keys(observed) == [\u0026#39;foo\u0026#39;], true undefined   b2143f9 FIX: isReactive(observed): false\n fix: get object\u0026#39;s __v_isReactive prop Â· gcclll/stb-vue-next@1005ef3\n åœ¨ createGetter ä¸­å¢åŠ åˆ¤æ–­ï¼Œå¦‚æœæ¥å–çš„å±æ€§ä¸º __v_isReactive åˆ™ç›´æ¥è¿”å› !isReadonly ã€‚\n  ç”¨ä¾‹äºŒï¼šåŸå‹  1 2 3 4 5 6 7 8 9 10 11  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const obj = {} const reactiveObj = reactive(obj) console.log(\u0026#39;reactiveObj is reactive, \u0026#39; + isReactive(reactiveObj)) const prototype = reactiveObj[\u0026#39;__proto__\u0026#39;] const otherObj = { data: [\u0026#39;a\u0026#39;] } console.log(\u0026#39;otherObj is reactive, \u0026#39; + isReactive(otherObj)) const reactiveOther = reactive(otherObj) console.log(\u0026#39;reactiveOther is reactive, \u0026#39; + isReactive(reactiveOther)) console.log(\u0026#39;reactiveOther.data[0] is `a`, \u0026#39; + ( reactiveOther.data[0] === \u0026#39;a\u0026#39; )) console.log(`__proto__, ` + prototype)     +RESULTS:\nreactiveObj is reactive, true otherObj is reactive, false reactiveOther is reactive, true reactiveOther.data[0] is `a`, true __proto__, [object Object] undefined   FIX: 1005ef3 å½“å–å€¼æ—¶å±æ€§åä¸º __proto__ æ—¶ï¼šç›´æ¥è¿”å›å–å€¼ç»“æœã€‚\n feat: get key is symbol or proto or __v_isRef Â· gcclll/stb-vue-next@1e2a3fe\n  ç”¨ä¾‹ä¸‰ï¼šåµŒå¥—å¯¹è±¡  1 2 3 4 5 6 7 8 9 10 11 12  const {isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const original = { nested: { foo: 1 }, array: [{ bar: 2 }] } const observed = reactive(original) console.log(`observed.nested is reactive ${isReactive(observed.nested)}`) console.log(`observed.array is reactive ${isReactive(observed.array)}`) console.log(`observed.array[0] is reactive ${isReactive(observed.array[0])}`)     +RESULTS:\nobserved.nested is reactive true observed.array is reactive true observed.array[0] is reactive true    ç”¨ä¾‹å››ï¼šä»£ç†åçš„å¯¹è±¡æ“ä½œä¹Ÿä¼šä½“ç°åœ¨åŸå¯¹è±¡ä¸Š  1 2 3 4 5 6 7 8 9  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const or = { foo: 1 } const ob = reactive(or) ob.bar = 1 console.log(`ob.bar = ${ob.bar}, or.bar = ${or.bar}`) delete ob.foo console.log(`\u0026#39;foo\u0026#39; in ob: ${\u0026#39;foo\u0026#39; in ob}, \u0026#39;foo\u0026#39; in or: ${\u0026#39;foo\u0026#39; in or}`)     +RESULTS:\nob.bar = 1, or.bar = 1 \u0026#39;foo\u0026#39; in ob: false, \u0026#39;foo\u0026#39; in or: false   ç»“æœåˆ é™¤åï¼Œä¾æ—§åœ¨ï¼Œéœ€è¦å®ç° delete proxy handlerã€‚\n  ç”¨ä¾‹äº”ï¼šåŸå§‹å¯¹è±¡ä¸Šçš„æ“ä½œä¹Ÿè¦èƒ½åœ¨ä»£ç†åå¯¹è±¡æœ‰æ‰€ä½“ç°  1 2 3 4 5 6 7 8 9  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const original = { foo: 1 } const observed = reactive(original) original.bar = 1 console.log(`observed.bar = ${observed.bar}, original.bar = ${original.bar}`) delete original.foo console.log(`\u0026#39;foo\u0026#39; in original: ${\u0026#39;foo\u0026#39; in original}, \u0026#39;foo\u0026#39; in observed: ${\u0026#39;foo\u0026#39; in observed}`)     +RESULTS:\nobserved.bar = 1, original.bar = 1 \u0026#39;foo\u0026#39; in original: false, \u0026#39;foo\u0026#39; in observed: false    ç”¨ä¾‹å…­ï¼šè¢«è®¾ç½®çš„å€¼å¦‚æœæ˜¯å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šè¢« Reactive  1 2 3 4 5 6 7  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const observed = reactive({}) const raw = {} observed.foo = raw // #0 console.log(`observed.foo === faw, ${observed.foo === raw}`) // #1 console.log(`observed.foo is reactive, ${isReactive(observed.foo)}`)     +RESULTS:\nobserved.foo === faw, false observed.foo is reactive, true   è®¿é—® raw ä¹‹å‰(#1 ä¹‹å‰)å®ƒè¿˜ä¸æ˜¯ reactiveï¼Œå› ä¸ºé€’å½’ reactive å‘ç”Ÿåœ¨ track() ä¸­ï¼Œå³å–å€¼é˜¶æ®µã€‚\n å¦‚ï¼šæ§åˆ¶å°æµ‹è¯•è¾“å‡º\nvar ob = reactive({}) var raw = {} ob.foo = raw ob Proxy {foo: {â€¦}} [[Handler]]: Object deleteProperty: Æ’ deleteProperty(target, key) get: Æ’ (target, key, receiver) set: Æ’ (target, key, value, receiver) [[Target]]: Object foo: {} // æ³¨æ„è¿™é‡Œ [[IsRevoked]]: false   è¿›è¡Œä¸€æ¬¡å–å€¼ï¼š\nob.foo ProxyÂ {} [[Handler]]: Object [[Target]]: Object [[IsRevoked]]: false    ç”¨ä¾‹ä¸ƒï¼šä¸è¯¥é‡å¤ proxyï¼Œè¿”å›ç¬¬ä¸€ä¸ª proxy ç»“æœ  1 2 3 4 5 6  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const original = { foo: 1 } // #1 const observed1 = reactive(original) // #2 const observed2 = reactive(observed1) // #3 console.log(`observed2 === observed1, ${observed2 === observed1}`)    observed2 === observed1, true undefined   å› ä¸º reactive() å®ç°ä¸­ç»„äº†æ£€æµ‹ï¼Œå¦‚æœè‡ªèº«æ˜¯ä¸ª proxy å°±ç›´æ¥è¿”å›ï¼Œæ‰€ä»¥ #3 ä¸­å® é™…ç›´æ¥å°† observed1 è¿”å›äº†ã€‚\n  TODO ç”¨ä¾‹å…«ï¼šä¸åº”è¯¥ç”¨ proxies æ±¡æŸ“åŸå§‹å¯¹è±¡ï¼Ÿ  1 2 3 4 5 6 7 8 9  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const original = { foo: 1 } const original2 = { bar: 2 } const observed = reactive(original) const observed2 = reactive(original2) observed.bar = observed2 console.log(`observed.bar === observed2, ${observed.bar === observed2}`) console.log(`original.bar === original2, ${original.bar === original2}`)     +RESULTS:\nobserved.bar === observed2, true original.bar === original2, false      basic proxy get handler(createGetter)   feat: reactive proxy get handler Â· gcclll/stb-vue-next@598e047\n commit: åªå®ç°å¯¹è±¡çš„ get proxy handler ï¼Œå¯¹è±¡å±æ€§è¢«è®¿é—®çš„æ—¶å€™ä¼šè§¦å‘ä»£ç†ï¼Œæ¯”å¦‚ä¸‹é¢ å®ä¾‹ä¸­ï¼Œå½“è®¿é—® observed.count æ—¶å€™ä¼šè§¦å‘ console.log({ res }, \u0026#34;get\u0026#34;) æ‰§è¡Œã€‚\n æœ€ç®€å• proxy get handler è„‘å›¾ï¼š   è°ƒç”¨ Reflect.get(target, key, receiver) æ‰§è¡ŒåŸå­æ“ä½œ\n  è¿”å›æ‰§è¡Œç»“æœ\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function createGetter(isReadonly = false, shallow = false) { // target: è¢«å–å€¼çš„å¯¹è±¡ï¼Œkey: å–å€¼çš„å±æ€§ï¼Œreceiver: this çš„å€¼  return function get(target: Target, key: string | symbol, receiver: object) { const res = Reflect.get(target, key, receiver) // æ˜¯å¦åªéœ€è¦ reactive ä¸€çº§å±æ€§(ä¸é€’å½’ reactive)  if (shallow) { return res } return res } } export const mutableHandlers: ProxyHandler\u0026lt;object\u0026gt; = { get }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  const { effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const target = { count: 0 } const ob = reactive(target) effect(() =\u0026gt; ob.count) // ob.count å±æ€§ æ”¶é›† effect fn  console.log(targetMap.get(target))     +RESULTS: effect ä¼šç«‹å³æ‰§è¡Œ fnï¼Œ ob.count å–å€¼è§¦å‘ get proxy æ”¶é›† fn -\u0026gt; count =\u0026gt; deps\u0026lt;Set\u0026gt;\nMap(1) { \u0026#39;count\u0026#39; =\u0026gt; Set(1) { [Function: reactiveEffect] { id: 0, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [Array], options: {} } } }    add track() and effect()   feat: track+effect Â· gcclll/stb-vue-next@3fc9634\n ä¸ºäº†å®Œæˆè§‚å¯Ÿå±æ€§ï¼Œé€šè¿‡å±æ€§çš„å–å€¼æ“ä½œæ¥æ”¶é›†ä¾èµ–è¿‡ç¨‹ï¼Œè¿™é‡ŒåŒæ—¶å®ç°äº† track() å’Œ effect() å‡½æ•°ã€‚\ntrack(target, type, key) ç›‘å¬å–å€¼æ”¶é›†ä¾èµ–ï¼š   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  export function track(target: object, type: TrackOpTypes, key: unknown) { if (!shouldTrack || activeEffect === undefined) { return; } // Map\u0026lt; obj -\u0026gt; Map\u0026lt;key, Set[...deps]\u0026gt; \u0026gt;  let depsMap = targetMap.get(target); if (!depsMap) { // åˆå§‹åŒ–  targetMap.set(target, (depsMap = new Map())); } let dep = depsMap.get(key); if (!dep) { depsMap.set(key, (dep = new Set())); } // æ­£åœ¨è¯·æ±‚æ”¶é›†çš„ effect ï¼Œæ˜¯åˆæ¬¡å‡ºç°  if (!dep.has(activeEffect)) { dep.add(activeEffect); // è‡ªèº«ä¿å­˜ä¸€ä»½è¢«ä¾èµ–è€…åå•  activeEffect.deps.push(dep); if (__DEV__ \u0026amp;\u0026amp; activeEffect.options.onTrack) { activeEffect.options.onTrack({ effect: activeEffect, target, type, key, }); } } }      effect(fn, options)     å‚æ•°åˆ—è¡¨ ï¼š\n fn - è¢«å°è£…çš„å‡½æ•°ï¼Œé‡Œé¢å¯å¯¹å¯¹è±¡æ‰§è¡Œ get/set æ“ä½œã€‚\n  ä¸»è¦åŠŸèƒ½ ï¼šå°† fn å°è£…æˆ ReactiveEffect å‡½æ•°\n1 2 3 4 5 6 7 8 9 10  export interface ReactiveEffect\u0026lt;T = any\u0026gt; { (): T // effectå‡½æ•°ä¸»é¢˜  _isEffect: true // æ ‡è®°è‡ªèº«æ˜¯ä¸æ˜¯ä¸€ä¸ª ReactiveEffect ç±»å‹  id: number // uid++ è€Œæ¥ï¼Œå…¨å±€çš„ä¸€ä¸ªç›¸å¯¹å”¯ä¸€çš„ id  active: boolean // è®°å½•å½“å‰çš„ effect æ˜¯ä¸æ˜¯æ¿€æ´»çŠ¶æ€  raw: () =\u0026gt; T // å°è£…ä¹‹å‰çš„é‚£ä¸ª fn  deps: Array\u0026lt;Dep\u0026gt; // fn çš„è¢«ä¾èµ–è€…åˆ—è¡¨  options: ReactiveEffectOptions // é¢å¤–é€‰é¡¹ï¼Œå¦‚ï¼šlazy  allowRecurse: boolean // ??? }      è§£å†³é—®é¢˜ :\n  fn å°è£…ä¹‹åï¼Œæ‰§è¡Œ fn è¿‡ç¨‹ä¸­ä½¿ç”¨ tryâ€¦finally ï¼Œé˜²æ­¢ fn æ‰§è¡Œå¼‚å¸¸å¯¼è‡´ effect è¿›ç¨‹ä¸­æ–­\n  ç»“åˆ shouldTrack, activeEffect å’Œ track() å‡½æ•°ï¼Œæœ‰æ•ˆçš„é¿å…äº†åœ¨ fn ä¸­æ‰§è¡Œ obj.value++ å¯¼è‡´ effect æ­»å¾ªç¯é—®é¢˜ï¼Œå› ä¸º tryâ€¦finally ç¡®ä¿äº†åªæœ‰ fn å‡½æ•° å®Œæˆä¹‹åæ‰ä¼šè¿›å…¥ finally æ¢å¤ effect çŠ¶æ€(shouldTrack = true, activeEffect = last || null)ã€‚\n     ç›¸å…³å‡½æ•°åŠå˜é‡åˆ—è¡¨\n   name type desc     activeEffect ReactiveEffect å½“å‰æ­£åœ¨å¤„ç†çš„ Effectï¼Œfn è¿˜æœªæ‰§è¡Œå®Œæˆï¼Œfinally è¿˜æ²¡ç»“æŸ   effectStack Array, [] ç¼“å­˜æ‰€æœ‰çŠ¶æ€è¿˜æ²¡å®Œæˆçš„ Effect   shouldTrack boolean, true track() ä¸­ç”¨æ¥æ£€æµ‹å½“å‰ effect æ˜¯å¦ç»“æŸï¼Œä»è€Œåˆ¤å®šæ˜¯å¦å¯ä»¥ç»§ç»­æ‰§è¡Œ track() æ”¶é›†ä¾èµ–   trackStack Array, [] ä¿å­˜ç€æ‰€æœ‰ Effect çš„ shouldTrack å€¼   effect() function å°è£… fnæˆ ReactiveEffect ç»“æ„   track(target, type, key) function æ”¶é›†ä¾èµ–ï¼Œå¹¶ä¸”å“åº”å¼é€’å½’   trigger(...) function å½“å€¼æ›´æ–°æ—¶è§¦å‘æ‰€æœ‰ä¾èµ–æ›´æ–°   createReactiveEffect(fn, options) function effect() å‡½æ•°ä¸»é¢˜åŠŸèƒ½åˆ†ç¦»å‡ºæ¥   cleanup(effect: ReactiveEffect) function æ¸…ç©ºæ‰€æœ‰ fn çš„ä¾èµ– effect.deps[]   enableTracking() function ä½¿èƒ½ Effect ï¼ŒshouldTrack = true, å¹¶å°†å…¶åŠ å…¥ trackStack   resetTracking() function é‡ç½® Effect, shouldTrack = ä¸Šä¸€ä¸ª Effect çš„ shouldTrack å€¼æˆ– true    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69  export function effect\u0026lt;T = any\u0026gt;( fn: () =\u0026gt; T, options: ReactiveEffectOptions = EMPTY_OBJ ): ReactiveEffect\u0026lt;T\u0026gt; { if (isEffect(fn)) { fn = fn.raw // å–å‡ºåŸå§‹çš„å‡½æ•°ï¼Œå°è£…ä¹‹å‰çš„  } // å°è£…æˆ ReactiveEffect  const effect = createReactiveEffect(fn, options) if (!options.lazy) { // å¦‚æœå¹¶æ²¡æŒ‡å®š lazy: true é€‰é¡¹ï¼Œåˆ™ç«‹å³æ‰§è¡Œ effect æ”¶é›†ä¾èµ–  // å› ä¸º effect ä¸€èˆ¬éƒ½ä¼šæœ‰å–å€¼æ“ä½œï¼Œæ­¤æ—¶ä¼šè§¦å‘ proxy get handler  // ç„¶åæ‰§è¡Œ track() ç»“åˆå½“å‰çš„ activeEffect å³ effect() æ‰§è¡Œæ—¶å€™çš„è¿™ä¸ª  // effectï¼Œè¿™æ ·å–å€¼æ“ä½œå°±å’Œå½“å‰å–å€¼ä½œç”¨åŸŸä¸‹çš„ä¾èµ–å‡½æ•°å»ºç«‹çš„ä¾èµ–å…³ç³»  effect() } return effect } let uid = 0 function createReactiveEffect\u0026lt;T = any\u0026gt;( fn: () =\u0026gt; T, options: ReactiveEffectOptions ): ReactiveEffect\u0026lt;T\u0026gt; { // å°† fn æ‰§è¡Œå°è£…æˆ ReactiveEffect ç±»å‹çš„å‡½æ•°  const effect = function reactiveEffect(): unknown { if (!effect.active) { // éæ¿€æ´»çŠ¶æ€ï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨è°ƒç”¨äº† stop  // é‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™å°±éœ€è¦è€ƒè™‘è°ƒç”¨ stop è€…æ˜¯å¦æä¾›äº†æ‰‹åŠ¨è°ƒåº¦è¯¥ effect  // çš„å‡½æ•° scheduler ? ä¹Ÿå°±æ˜¯è¯´ä½ åœæ­¢ä½ å¯ä»¥é‡æ–°å¯åŠ¨  return options.scheduler ? undefined : fn() } if (!effectStack.includes(effect)) { // 1. cleanup, ä¿æŒçº¯å‡€  cleanup(effect) try { // 2. ä½¿å…¶ tracking çŠ¶æ€æœ‰æ•ˆï¼Œtrack() ä¸­æœ‰ç”¨  enableTracking() // track() å¯ä»¥æ‰§è¡Œæ”¶é›†æ“ä½œ  effectStack.push(effect) // effect å…¥æ ˆ  // 3. ä¿å­˜ä¸ºå½“å‰çš„ activeEffect, track() ä¸­æœ‰ç”¨  activeEffect = effect // è®°å½•å½“å‰çš„ effect -\u0026gt; track/trigger  // 4. æ‰§è¡Œ fn å¹¶è¿”å›ç»“æœ  return fn() // è¿”å›æ‰§è¡Œç»“æœ  } finally { // å§‹ç»ˆéƒ½ä¼šæ‰§è¡Œï¼Œé¿å…å‡ºç°å¼‚å¸¸å°† effect è¿›ç¨‹å¡æ­»  // 5. å¦‚æœæ‰§è¡Œå¼‚å¸¸ï¼Œä¸¢å¼ƒå½“å‰çš„ effect ï¼Œå¹¶å°†çŠ¶æ€é‡ç½®ä¸ºä¸Šä¸€ä¸ª effect  // ç”±ä¸€ä¸ª effect æ ˆæ¥ç»´æŠ¤ã€‚  effectStack.pop() resetTracking() activeEffect = effectStack[effectStack.length - 1] } } } as ReactiveEffect effect.id = uid++ effect.allowRecurse = !!options.allowRecurse effect._isEffect = true effect.active = true effect.raw = fn // è¿™é‡Œä¿å­˜åŸå§‹å‡½æ•°å¼•ç”¨  effect.deps = [] effect.options = options return effect }     ä¾èµ–å’Œå±æ€§å˜æ›´å‘ç”Ÿè”ç³»çš„æ¡¥æ¢æ¨¡å—ã€‚\n  effect(fn, options) å°è£…æ‰§è¡Œ fnï¼Œè§¦å‘å–å€¼æ“ä½œ -\u0026gt;\n  track(target, type, key) æ”¶é›†å¯¹è±¡åŠå±æ€§æ‰€æœ‰ä¾èµ– -\u0026gt;\n  fn ä¸­è®¾å€¼æ“ä½œè§¦å‘ trigger(...) æ‰§è¡Œæ‰€æœ‰ depsï¼Œæ›´æ–° DOMã€‚\n      add trigger() proxy set handler   feat: proxy set and trigger operation Â· gcclll/stb-vue-next@20afde9\nproxy set handler(createSetter)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  function createSetter(shallow = false) { return function set( target: object, key: string | symbol, value: unknown, receiver: object ): boolean { const oldValue = (target as any)[key] // TODO shallow or not, or ref ?  //  const hadKey = isArray(target) \u0026amp;\u0026amp; isIntegerKey(key) ? Number(key) \u0026lt; target.length : hasOwn(target, key) const result = Reflect.set(target, key, value, receiver) if (target === toRaw(receiver)) { if (!hadKey) { // TODO ADD  } else if (hasChanged(value, oldValue)) { trigger(target, TriggerOpTypes.SET, key, value, oldValue) } } return result }      trigger()  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59  export function trigger( target: object, type: TriggerOpTypes, key?: unknown, newValue?: unknown, oldValue?: unknown, oldTarget?: Map\u0026lt;unknown, unknown\u0026gt; | Set\u0026lt;unknown\u0026gt; ) { const depsMap = targetMap.get(target) if (!depsMap) { return } const effects = new Set\u0026lt;ReactiveEffect\u0026gt;() const add = (effectsToAdd: Set\u0026lt;ReactiveEffect\u0026gt; | undefined) =\u0026gt; { if (effectsToAdd) { effectsToAdd.forEach(effect =\u0026gt; { if (effect !== activeEffect || effect.allowRecurse) { effects.add(effect) } }) } } if (type === TriggerOpTypes.CLEAR) { // TODO collection clear operation  } else if (key === \u0026#39;length\u0026#39; \u0026amp;\u0026amp; isArray(target)) { // TODO array change operation  } else { // SET | ADD | DELETE operation  if (key !== void 0) { add(depsMap.get(key)) } // TODO è¿­ä»£å™¨ keyï¼Œfor...of, ä½¿ç”¨è¿­ä»£å™¨æ˜¯å¯¹æ•°æ®çš„ç›‘å¬å˜åŒ–  } const run = (effect: ReactiveEffect) =\u0026gt; { if (__DEV__ \u0026amp;\u0026amp; effect.options.onTrigger) { effect.options.onTrigger({ effect, target, key, type, newValue, oldValue, oldTarget }) } if (effect.options.scheduler) { effect.options.scheduler(effect) } else { effect() } } effects.forEach(run) }        observe object recursively   feat: observe object recursively Â· gcclll/stb-vue-next@b2143f9\n é’ˆå¯¹åµŒå¥—å¯¹è±¡è¿›è¡Œé€’å½’ Reactive ã€‚\n   effect -\u0026gt; track -\u0026gt; trigger å…³ç³»å›¾   åˆ°æ­¤ effect + track + trigger å®Œæˆäº†æœ€ç®€å•çš„å“åº”å¼ä»£ç ã€‚\n   effect å°è£…æ³¨å†Œå‡½æ•°\n  track å–å€¼è§¦å‘æ”¶é›†ä¾èµ–å‡½æ•°\n  trigger è®¾å€¼è§¦å‘æ‰€æœ‰ä¾èµ–å‡½æ•°æ‰§è¡Œ\n    add delete(deleteProperty) proxy handler   feat: delete proxy handler Â· gcclll/stb-vue-next@05b98c5\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function deleteProperty(target: object, key: string | symbol): boolean { const hadKey = hasOwn(target, key) const oldValue = (target as any)[key] const result = Reflect.deleteProperty(target, key) if (result \u0026amp;\u0026amp; hadKey) { // åˆ é™¤æˆåŠŸï¼Œè§¦å‘ DELETE  trigger(target, TriggerOpTypes.DELETE, key, undefined, oldValue) } return result } export const mutableHandlers: ProxyHandler\u0026lt;object\u0026gt; = { get,\tget, set\tset, deleteProperty }     åˆ é™¤æˆåŠŸè°ƒç”¨ trigger() è§¦å‘ DELETE ã€‚\n  add has, ownKeys proxy handlers   feat: has + ownKeys proxy handler Â· gcclll/stb-vue-next@ab69fe9\n å¢åŠ  has, ownKeys proxy handlers.\n1 2 3 4 5 6 7 8 9 10 11 12  function has(target: object, key: string | symbol): boolean { const result = Reflect.has(target, key) if (!isSymbol(key) || !builtInSymbols.has(key)) { track(target, TrackOpTypes.HAS, key) } return result } function ownKeys(target: object): (string | num | symbol)[] { track(target, TrackOpTypes.ITERATE, isArray(target) ? \u0026#39;length\u0026#39; : ITERATE_KEY) return Reflect.ownKeys(target) }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const obj = reactive({ n: 0 }) let dummy = false const runner = effect(() =\u0026gt; (dummy = \u0026#39;n\u0026#39; in obj), { lazy: true }) console.log(`before run effect, dummy = ${dummy}`) runner() console.log(`after run effect, dummy = ${dummy}`)     +RESULTS:\nbefore run effect, dummy = false after run effect, dummy = true    TODO add array support   feat: array support Â· gcclll/stb-vue-next@9aeb678\n ä¿®æ”¹ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  // æ•°ç»„å†…ç½®æ–¹æ³•å¤„ç† const arrayInstrumentations: Record\u0026lt;string, Function\u0026gt; = {} ;([\u0026#39;includes\u0026#39;, \u0026#39;indexOf\u0026#39;, \u0026#39;lastIndexOf\u0026#39;] as const).forEach(key =\u0026gt; { const method = Array.prototype[key] as any arrayInstrumentations[key] = function(this: unknown[], ...args: unknown[]) { const arr = toRaw(this) for (let i = 0, l = this.length; i \u0026lt; l; i++) { track(arr, TrackOpTypes.GET, i + \u0026#39;\u0026#39;) } const res = method.apply(arr, args) if (res === -1 || res === false) { return method.apply(arr, args.map(toRaw)) } else { return res } } }) ;([\u0026#39;push\u0026#39;, \u0026#39;pop\u0026#39;, \u0026#39;shift\u0026#39;, \u0026#39;unshift\u0026#39;, \u0026#39;splice\u0026#39;] as const).forEach(key =\u0026gt; { const method = Array.prototype[key] as any arrayInstrumentations[key] = function(this: unknown[], ...args: unknown[]) { pauseTracking() const res = method.apply(this, args) resetTracking() return res } }) // createGetter function createGetter(isReadonly = false, shallow = false) { // ...  // 4. target is array  const targetIsArray = isArray(target) if (targetIsArray \u0026amp;\u0026amp; hasOwn(arrayInstrumentations, key)) { return Reflect.get(arrayInstrumentations, key, receiver) } // ... }      ç´¢å¼•æ“ä½œ(includes, lastIndexOf, indexOf)å¤„ç†\n ç¡®ä¿ç´¢å¼•å–å€¼çš„æ—¶å€™ï¼Œèƒ½ä½¿ç”¨ track() æ­£ç¡®æ”¶é›†å¯¹åº”ç´¢å¼•çš„ä¾èµ–åˆ—è¡¨ã€‚\n  å¯æ”¹å˜åŸæ•°ç»„é•¿åº¦æ“ä½œ(push, pop, shift, unshift, splice)\n å› ä¸ºè¿™äº›å‡½æ•°å†…éƒ¨å®ç°éƒ½éœ€è¦è®¿é—®åŠæ”¹å˜åŸæ•°ç»„çš„é•¿åº¦ï¼Œå› æ­¤è¿™é‡Œéœ€è¦åšä¸€å±‚ä¿æŠ¤ï¼Œå®ƒ ä»¬æ‰§è¡Œä¹‹å‰ shouldTrack = false ï¼Œæ‰§è¡Œå®Œæˆä¹‹å shouldTrack = true ï¼Œé¿å… track() æ­»å¾ªç¯ã€‚\n   ä¸‹é¢å‡ä¸º vue-next æºç ä¸­ç”¨ä¾‹åˆ†æã€‚\n T1: è¯»å†™æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const original = [{ foo: 1 }, { bar: 2 }] const observed = reactive(original) console.log(`#01 original !== observed, ${original !== observed}`) console.log(`#02 original is reactive, ${isReactive(original)}`) console.log(`#03 observed is reactive, ${isReactive(observed)}`) console.log(`#04 observed[0] is reactive, ${isReactive(observed[0])}`) const clone = observed.slice() console.log(`#05 clone[0] is reactive, ${isReactive(clone[0])}`) console.log(`#06 clone[0] !== original[0], ${clone[0] !== original[0]}`) console.log(`#07 clone[0] === observed[0], ${clone[0] === observed[0]}`) const value = { baz: 3 } const reactiveValue = reactive(value) observed[0] = value console.log(`#08 observed[0] === reactiveValue, ${observed[0] === reactiveValue}`) console.log(`#09 original[0] === value, ${original[0] === value}`) delete observed[0] console.log(`#10 observed[0] === undefined, ${observed[0] === undefined}`) console.log(`#11 original[0] === undefined, ${original[0] === undefined}`) observed.push(value) console.log(`#12 observed[2] === reactiveValue, ${observed[2] === reactiveValue}`) console.log(`#13 original[2] === value, ${original[2] === value}`)     +RESULTS:\n#01 original !== observed, true #02 original is reactive, false #03 observed is reactive, true #04 observed[0] is reactive, true #05 clone[0] is reactive, true #06 clone[0] !== original[0], true #07 clone[0] === observed[0], true #08 observed[0] === reactiveValue, true #09 original[0] === value, true #10 observed[0] === undefined, true #11 original[0] === undefined, true #12 observed[2] === reactiveValue, true #13 original[2] === value, true   åˆ†æï¼š\n  #01 å› ä¸º Proxy å†…éƒ¨å®ç°å®é™…ä¼šåˆ›å»ºæ–°å¯¹è±¡\n  #02 è¯»å– __v_isReactive åœ¨ createGetter() é‡Œé¢ä¼šç›´æ¥è¿”å› !isReadonly\n  #03 åŒä¸Š\n  #04 å–å€¼çš„æ—¶å€™è¿”å›ç»“æœä¹‹å‰ä¼šæ£€æµ‹å½“å‰æ˜¯ä¸æ˜¯å¯¹è±¡å¦‚æœæ˜¯ä¼šæ‰§è¡Œé€’å½’ reactive\n  #05 slice å®ç°è¿‡ç¨‹å¹¶éæ·±æ‹·è´\n  #06 å’Œ observed[0] !== original[0] ä¸€ä¸ªåŸå› \n  #07 æµ…æ‹·è´é—®é¢˜\n  #08 å…ˆ observed[0] å¯¹ value å–å€¼æ“ä½œï¼Œæ­¤æ—¶ Reactive value å¯¹è±¡æ—¶ï¼Œå‘ç°è¯¥å¯¹\n  è±¡å·²ç»æœ‰æ˜ å°„äº†(proxyMap ä¸­å·²å­˜åœ¨ value -\u0026gt; reactiveValue å…³ç³»ã€‚)\n  #09 proxy çš„æ”¹å˜ä¹Ÿä¼šä½“ç°åœ¨ original å¯¹è±¡ä¸Šã€‚\n1 2 3 4  const target = { } const ob = new Proxy(target, {}) ob.value = { test: 1 } console.log(target)     +RESULTS:\n{ value: { test: 1 } }    #10 åŒä¸Š\n  #11 åŒä¸Š\n  #12 åŒ #08 proxyMap ä¸­æœ‰ç¼“å­˜äº†\n  #13 åŒä¸Š\n   T2ï¼šç´¢å¼•æ–¹æ³•(includes, lastIndexOf, indexOf)\n1 2 3 4 5 6 7 8 9 10 11  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const raw = {} const arr = reactive([{}, {}]) arr.push(raw) console.log(`arr.indexOf(raw), ${arr.indexOf(raw)}`) console.log(`arr.indexOf(raw, 3), ${arr.indexOf(raw, 3)}`) console.log(`arr.includes(raw), ${arr.includes(raw)}`) console.log(`arr.includes(raw, 3), ${arr.includes(raw, 3)}`) console.log(`arr.lastIndexOf(raw), ${arr.lastIndexOf(raw)}`) console.log(`arr.lastIndexOf(raw, 1), ${arr.lastIndexOf(raw, 1)}`)     +RESULTS:\narr.indexOf(raw), 2 arr.indexOf(raw, 3), -1 arr.includes(raw), true arr.includes(raw, 3), false arr.lastIndexOf(raw), 2 arr.lastIndexOf(raw, 1), -1   T3ï¼šæ•°ç»„å…ƒç´ æœ¬èº«å·²ç»æ˜¯ Proxy\n1 2 3 4 5 6  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const raw = [] const obj = reactive({}) raw.push(obj) const arr = reactive(raw) console.log(`arr.includes(obj), ${arr.includes(obj)}`)     +RESULTS: è¿™ä¸ªåº”è¯¥å¾ˆå¥½ç†è§£ï¼Œå¯¹è±¡å·²ç»æ˜¯ proxy ä¹‹åä¸ä¼šå†ç»§ç»­ä»£ç†ï¼Œè€Œæ˜¯è¿”å› proxyMap ä¸­ç¼“å­˜è¿‡çš„ä»£ç†ç»“æœã€‚\narr.includes(obj), true   T4: reverse æ–¹æ³•ä¹Ÿåº”è¯¥æ˜¯ reactive çš„\n TODO: reverse ä¹‹åæ‰¾ä¸åˆ°(indexOf)åŸå§‹å¯¹è±¡äº†ï¼Ÿ\n æ ¹æ® reverse() çš„å®ç°åŸç†ï¼Œæœ¬è´¨ä¸Šæ˜¯å…ƒç´ ä¹‹é—´çš„æ›¿æ¢æ“ä½œï¼Œå› æ­¤å¹¶ä¸ä¼šæ”¹å˜æ•°ç»„æˆ–å…ƒ ç´ æœ¬èº«æ˜¯ proxy æ€§è´¨ï¼Œä¸”å±äºç´¢å¼•èµ‹å€¼æ“ä½œï¼Œå› æ­¤ä¼šè§¦å‘ç´¢å¼•çš„ reactive ç›¸å…³æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11  const { isReactive, effect, reactive, targetMap, toRaw } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const obj = { a: 1 } const arr = reactive([obj, { b: 2 }]) let index = -1 console.log(`#1 obj === arr[0], ${obj === toRaw(arr[0])}`) effect(() =\u0026gt; (index = arr.indexOf(obj))) // index = 0 console.log(`#2 before reverse, index = ${index}`) arr.reverse() // #3 console.log(`#4 after reverse, index = ${index}`) console.log(`#5 obj === arr[1], ${obj === toRaw(arr[1])}`)    #1 obj === arr[0], true #2 before reverse, index = 0 #4 after reverse, index = -1 #5 obj === arr[1], true undefined   +RESULTS: å¤±è´¥\nbefore reverse, index = 0 after reverse, index = -1 [ { b: 2 }, { a: 1 } ]   T5: ä½¿ç”¨ delete åˆ é™¤æ•°ç»„å…ƒç´ æ—¶ä¸åº”è¯¥è§¦å‘ length ä¾èµ–\n1 2 3 4 5 6 7 8 9 10  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const arr = reactive([1,2,3]) let dummy = 0 effect(() =\u0026gt; { dummy = arr.length + 1 }) console.log(`before delete, dummy = ${dummy}, arr = ${arr}, len = ${arr.length}`) delete arr[1] console.log(`after delete, dummy = ${dummy}, arr = ${arr}, len = ${arr.length}`)     +RESULTS: åˆ é™¤æ“ä½œå¹¶ä¸ä¼šæ”¹å˜æ•°ç»„é•¿åº¦\nbefore delete, dummy = 4, arr = 1,2,3, len = 3 after delete, dummy = 4, arr = 1,,3, len = 3 undefined   PS: èµ‹å€¼å·²æœ‰çš„ä¸‹æ ‡å…ƒç´ å€¼ã€æ·»åŠ éæ­£æ•´æ•°ç±»å‹çš„å±æ€§åˆ°æ•°ç»„ä¸Šéƒ½ä¸ä¼šè§¦å‘ length ä¾ èµ–ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰æ”¹å˜æ•°ç»„é•¿åº¦ã€‚\n  T6: åœ¨ effect fn ä¸­ä½¿ç”¨ for ... in è¿­ä»£è¯­å¥åº”è¯¥ track length\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const { isReactive, effect, reactive, targetMap } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const nums = [1] const array = reactive(nums) let len = \u0026#39;\u0026#39; effect(() =\u0026gt; { len = \u0026#39;\u0026#39; for (const key in array) { len += key } }) console.log(`before push, len = ${len}`) array.push(1) console.log(`after push, len = ${len}`)    before push, len = 0 after push, len = 01 undefined   +RESULTS: è¾“å‡ºæ˜¾ç¤ºï¼Œlength ä¾èµ–å·²ç» track åˆ°äº†ï¼Œåªæ˜¯ Length å˜åŒ–å¹¶æ²¡æœ‰è§¦å‘\nMap(1) { \u0026#39;length\u0026#39; =\u0026gt; Set(1) { [Function: reactiveEffect] { id: 0, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [Array], options: {} } } } before push, len = 0 after push, len = 0   FIX: feat(add): array add element support Â· gcclll/stb-vue-next@21b4881\n     array add element support   feat(add): array add element support Â· gcclll/stb-vue-next@21b4881\n å¢åŠ æ·»åŠ æ•°ç»„å…ƒç´ æ”¯æŒã€‚\n       createGetter -\u0026gt; get proxy handler ä¸­å¢åŠ å±æ€§æ·»åŠ  trigger æ“ä½œ\n trigger(target, TriggerOpTypes.ADD, key, value)\n  effect.ts -\u0026gt; trigger() ä¸­å¢åŠ æ•°ç»„é•¿åº¦å˜æ›´ä¾èµ–æ”¶é›†å’Œ ADD æ“ä½œä¾èµ–æ”¶é›†\n     add shallow reactive   feat(add): shallowReactive api Â· gcclll/stb-vue-next@e85dfc6\n æ­£å¸¸ track è¿‡ç¨‹ä¸­ä¼šæ£€æµ‹åµŒå¥—å†…çš„æ˜¯ä¸æ˜¯å¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡ä¼šè¿›è¡Œé€’å½’ reactive è®©å†…éƒ¨åµŒå¥—çš„å¯¹è±¡ä¹Ÿ reactive åŒ–ã€‚\n shallow reactive æ„æ€æ˜¯å½“å¯¹è±¡å­˜åœ¨åµŒå¥—çš„æ—¶å€™ï¼Œä¸è¿›è¡Œé€’å½’ reactive ã€‚\n è¿™ä¸ªé€šè¿‡åœ¨ track() å‡½æ•°ä¸­åšä¸€æ¬¡æ‹¦æˆªå¤„ç†ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const props = shallowReactive({ n: { foo: 1} }) console.log(`props.n is reactive, ${isReactive(props.n)}`) const props2 = shallowReactive({ n: reactive({ foo: 1 }) }) props2.n = reactive({ foo: 2 }) console.log(`props2.n is reactive, ${isReactive(props2.n)}`) // array test const shallowArray = shallowReactive([]) const a = {} let size effect(() =\u0026gt; { size = shallowArray.length }) console.log(`\u0026gt;\u0026gt; array`) console.log(`before push a, size = ${size}`) shallowArray.push(a) console.log(`after push a, size = ${size}`) shallowArray.pop() console.log(`after pop, size = ${size}`) console.log(`\u0026gt;\u0026gt; è¿­ä»£æ—¶ä¸åº”è§‚å¯Ÿ`) shallowArray.push(a) const spreadA = [...shallowArray][0] // è¿­ä»£ä¹Ÿæœ‰å–å€¼è¿‡ç¨‹ï¼Œshallow = true ä¸ä¼šé€’å½’ reactive console.log(`spreadA is reactive, ${isReactive(spreadA)}`) console.log(`\u0026gt;\u0026gt; onTrack`) const onTrackFn = () =\u0026gt; console.log(\u0026#39;on tracking...\u0026#39;) let b effect(() =\u0026gt; { b = Array.from(shallowArray) }, { onTrack: onTrackFn })     +RESULTS: Array.from æœ¬è´¨æ˜¯è¿­ä»£å™¨æ“ä½œï¼Œæ‰€ä»¥ä¼šè§¦å‘è¿­ä»£å™¨ tracking ã€‚\nprops.n is reactive, false props2.n is reactive, true \u0026gt;\u0026gt; array before push a, size = 0 after push a, size = 1 after pop, size = 0 \u0026gt;\u0026gt; è¿­ä»£æ—¶ä¸åº”è§‚å¯Ÿ spreadA is reactive, false \u0026gt;\u0026gt; onTrack on tracking... on tracking... undefined    add readonly reactive   feat(add): readonly reactive Â· gcclll/stb-vue-next@66e7903\næµ‹è¯•(for Object)ï¼š  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  const { isReactive, effect, reactive, targetMap, shallowReactive, readonly, isProxy, isReadonly } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) console.log(`\u0026gt;\u0026gt;\u0026gt; should make nested values readonly`) const original = { foo: 1, bar: { baz: 2 } } const wrapped = readonly(original) console.log(`wrapped !== original, ${wrapped !== original}`) console.log(`wrapped is proxy, ${isProxy(wrapped)}`) console.log(`wrapped is reactive, ${isReactive(wrapped)}`) console.log(`wrapped is readonly, ${isReadonly(wrapped)}`) console.log(`original is reactive, ${isReactive(original)}`) console.log(`original is readonly, ${isReadonly(original)}`) console.log(`wrapped.bar is reactive, ${isReactive(wrapped.bar)}`) console.log(`wrapped.bar is readonly, ${isReadonly(wrapped.bar)}`) console.log(`original.bar is reactive, ${isReactive(original.bar)}`) console.log(`original.bar is readonly, ${isReadonly(original.bar)}`) console.log(`\u0026gt;\u0026gt; get`) console.log(`wrapped.foo = ${wrapped.foo}`) console.log(`\u0026gt;\u0026gt; has`) console.log(`\u0026#39;foo\u0026#39; in wrapped, ${\u0026#39;foo\u0026#39; in wrapped}`) console.log(`\u0026gt;\u0026gt; ownKeys`) console.log(`Object.keys(wrapped), [${Object.keys(wrapped)}]`) console.log(`\u0026gt;\u0026gt; set or delete, should fail`) const qux = Symbol(\u0026#39;qux\u0026#39;) const original2 = { foo: 1, bar: { baz: 2 }, [qux]: 3 } const wrapped2 = readonly(original2) wrapped2.foo = 2 // fail console.log(`after \u0026#39;wrapped2.foo = 2\u0026#39;, wrapped2.foo = ${wrapped2.foo}`) wrapped2.bar.baz = 3 console.log(`after \u0026#39;wrapped2.bar.baz = 3\u0026#39;, wrapped2.bar.baz = ${wrapped2.bar.baz}`) wrapped2[qux] = 4 console.log(`after \u0026#39;wrapped2[qux] = 4\u0026#39;, wrapped2[qux] = ${wrapped2[qux]}`) delete wrapped2.foo console.log(`after \u0026#39;delete wrapped2.foo\u0026#39;, wrapped2.foo = ${wrapped2.foo}`) delete wrapped2.bar.baz console.log(`after \u0026#39;delete wrapped2.bar.baz\u0026#39;, wrapped2.bar.baz = ${wrapped2.bar.baz}`) delete wrapped2[qux] console.log(`after \u0026#39;delete wrapped2[qux]\u0026#39;, wrapped2[qux] = ${wrapped2[qux]}`)     +RESULTS: readonly ä¼šé€’å½’åµŒå¥—å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒå†…éƒ¨çš„å¯¹è±¡éƒ½ä¼šæ˜¯ readonlyã€‚\n\u0026gt;\u0026gt;\u0026gt; should make nested values readonly wrapped !== original, true wrapped is proxy, true wrapped is reactive, false wrapped is readonly, true original is reactive, false original is readonly, false wrapped.bar is reactive, false wrapped.bar is readonly, true original.bar is reactive, false original.bar is readonly, false \u0026gt;\u0026gt; get wrapped.foo = 1 \u0026gt;\u0026gt; has \u0026#39;foo\u0026#39; in wrapped, true \u0026gt;\u0026gt; ownKeys Object.keys(wrapped), [foo,bar] \u0026gt;\u0026gt; set or delete, should fail after \u0026#39;wrapped2.foo = 2\u0026#39;, wrapped2.foo = 1 after \u0026#39;wrapped2.bar.baz = 3\u0026#39;, wrapped2.bar.baz = 2 after \u0026#39;wrapped2[qux] = 4\u0026#39;, wrapped2[qux] = 3 after \u0026#39;delete wrapped2.foo\u0026#39;, wrapped2.foo = 1 after \u0026#39;delete wrapped2.bar.baz\u0026#39;, wrapped2.bar.baz = 2 after \u0026#39;delete wrapped2[qux]\u0026#39;, wrapped2[qux] = 3    æµ‹è¯•(for Array):  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  const { isReactive, effect, readonly, isReadonly, reactive, targetMap, isProxy, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) console.log(`\u0026gt;\u0026gt;\u0026gt; should make nested values readonly`) const original = [{ foo: 1 }] const wrapped = readonly(original) console.log(`wrapped !== original`) console.log(`wrapped is proxy, ${isProxy(wrapped)}`) console.log(`wrapped is reactive, ${isReactive(wrapped)}`) console.log(`wrapped is readonly, ${isReadonly(wrapped)}`) console.log(`original is reactive, ${isReactive(original)}`) console.log(`original is readonly, ${isReadonly(original)}`) console.log(`wrapped[0] is reactive, ${isReactive(wrapped[0])}`) console.log(`wrapped[0] is readonly, ${isReadonly(wrapped[0])}`) console.log(`original[0] is reactive, ${isReactive(original[0])}`) console.log(`original[0] is readonly, ${isReadonly(original[0])}`) console.log(`\u0026gt; get`) console.log(`wrapped[0].foo = ${wrapped[0].foo}`) console.log(`\u0026gt; has`) console.log(`0 in wrapped, ${0 in wrapped}`) console.log(`\u0026gt; ownKeys`) console.log(`Object.keys(wrapped) = [${Object.keys(wrapped)}]`) const wrapped2 = readonly([{ foo: 1 }]) wrapped2[0] = 1 console.log(`after \u0026#39;wrapped2[0] = 1\u0026#39;, wrapped2[0] = ${wrapped2[0]}`) wrapped2[0].foo = 2 console.log(`after \u0026#39;wrapped2[0].foo = 2\u0026#39;, wrapped2[0].foo = ${wrapped2[0].foo}`) wrapped2.length = 0 console.log(`after \u0026#39;wrapped2.length = 0\u0026#39;, wrapped2.length = ${wrapped.length}`) console.log(`after \u0026#39;wrapped2.length = 0\u0026#39;, wrapped2[0].foo = ${wrapped2[0].foo}`) wrapped2.push(2) console.log(`after \u0026#39;wrapped2.push(2)\u0026#39;, wrapped2.length = ${wrapped2.length}`)     +RESULTS:\n\u0026gt;\u0026gt;\u0026gt; should make nested values readonly wrapped !== original wrapped is proxy, true wrapped is reactive, false wrapped is readonly, true original is reactive, false original is readonly, false wrapped[0] is reactive, false wrapped[0] is readonly, true original[0] is reactive, false original[0] is readonly, false \u0026gt; get wrapped[0].foo = 1 \u0026gt; has 0 in wrapped, true \u0026gt; ownKeys Object.keys(wrapped) = [0] after \u0026#39;wrapped2[0] = 1\u0026#39;, wrapped2[0] = [object Object] after \u0026#39;wrapped2[0].foo = 2\u0026#39;, wrapped2[0].foo = 1 after \u0026#39;wrapped2.length = 0\u0026#39;, wrapped2.length = 1 after \u0026#39;wrapped2.length = 0\u0026#39;, wrapped2[0].foo = 1 after \u0026#39;wrapped2.push(2)\u0026#39;, wrapped2.length = 1 undefined    æµ‹è¯•(reactive, readonly äº’æ’©)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const { isReactive, effect, reactive, readonly, isReadonly, targetMap, toRaw, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const a = readonly({}) const b = reactive(a) console.log(`*#1* isReadonly(b), ${isReadonly(b)}`) console.log(`*#2* toRaw(a) === toRaw(b), ${toRaw(a) === toRaw(b)}`) console.log(`*#3* a === b, ${ a === b }`)     +RESULTS:\n*#1* isReadonly(b), true *#2* toRaw(a) === toRaw(b), true *#3* a === b, true undefined    #1 b is readonly: createReactive ä¸­çš„å¤„ç†\n1 2 3  if (target[ReactiveFlags.Raw] \u0026amp;\u0026amp; !(isReadonly \u0026amp;\u0026amp; target[ReactiveFlags.IS_REACTIVE])) { return target }     ä¸Šé¢çš„å¤„ç†é’ˆå¯¹ b = reactive(a) æœ‰ï¼š\n a æ»¡è¶³ target[ReactiveFlags.Raw] å› ä¸ºå®ƒæ˜¯ readonly çš„.\n isReadonly = false\n target[ReactiveFlags.IS_REACTIVE] ä¸æ»¡è¶³\n å› æ­¤ä¸Šé¢çš„åˆ¤æ–­æ»¡è¶³ target[ReactiveFlags.RAW] \u0026amp;\u0026amp; !target[ReactiveFlags.IS_REACTIVE] ç›´æ¥è¿”å› target ã€‚\n  #2 toRaw(a) === toRaw(b) è¿™ä¸ªç»“æœä¸º trueï¼Œå› ä¸º #1 ä¸­çš„åŸå› ï¼Œç›´æ¥è¿”å›äº† targetï¼Œ æ‰€ä»¥ b å®é™…ä¸Šå°±æ˜¯ a(å¦‚ç»“æœ #3)\n      add shallow readonly reactive   feat(add): shallow readonly reactive Â· gcclll/stb-vue-next@aaaf911\n  æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { isReactive, effect, reactive, targetMap, shallowReactive, shallowReadonly } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) // åµŒå¥—å¯¹è±¡ä¸åº”è¯¥ reactive console.log(`\u0026gt;\u0026gt;\u0026gt; should not make non-reactive properties reactive`) let props = shallowReadonly({ n: {foo: 1} }) console.log(`isReactive(props.n), ${isReactive(props.n)}`) // æ ¹å±æ€§åº”è¯¥æ˜¯ readonly console.log(`\u0026gt;\u0026gt;\u0026gt; should make root level properties readonly`) props = shallowReadonly({n : 1}) props.n = 2 console.log(`after \u0026#39;props.n = 2\u0026#39;, props.n = ${props.n}`) // åµŒå¥—çš„å±æ€§ä¸åº”è¯¥æ˜¯ readonly ï¼Œå› ä¸ºæ˜¯ shallow console.log(`\u0026gt;\u0026gt;\u0026gt; should NOT make nested properties readonly`) props = shallowReadonly({ n: { foo: 1 } }) props.n.foo = 2 console.log(`after \u0026#39;props.n.foo = 2\u0026#39;, props.n.foo = ${props.n.foo}`)     +RESULTS:\n\u0026gt;\u0026gt;\u0026gt; should not make non-reactive properties reactive isReactive(props.n), false \u0026gt;\u0026gt;\u0026gt; should make root level properties readonly after \u0026#39;props.n = 2\u0026#39;, props.n = 1 \u0026gt;\u0026gt;\u0026gt; should NOT make nested properties readonly after \u0026#39;props.n.foo = 2\u0026#39;, props.n.foo = 2 undefined   è¿™é‡Œçš„ç»“æœä¸éš¾ç†è§£\n  shallow ä¸ä¼šé€’å½’ reactive\n  readonly è®©å±æ€§åªè¯»ï¼Œä½†æ˜¯ç”±äºæ˜¯ shallow æ‰€ä»¥åªæœ‰å¯¹è±¡æ ¹å±æ€§æ‰æ˜¯åªè¯»\n    add effect stop   feat(add): effect stop Â· gcclll/stb-vue-next@f1e5b3a\n  stop() å‡½æ•°æ“ä½œï¼š\n  æ¸…ç©ºæ‰€æœ‰ effect ä¸Šçš„ depsï¼ŒåŒæ—¶å°†å½“å‰çš„ effect ä»æ‰€æœ‰ä¾èµ–å®ƒçš„ dep ä¸­åˆ é™¤\n effect.deps[i].delete(effect) , è¿™ä¸€æ­¥æ˜¯å°† targetMap \u0026gt; depsMap \u0026gt; deps ä¸­ çš„ effect åˆ é™¤ã€‚\n effect.deps.length = 0\n  å°† effect.active ç½®ä¸º false\n   æ‰§è¡Œ stop() ä¹‹åï¼Œåªèƒ½æ‰‹åŠ¨è°ƒç”¨ runner() æ¥è§¦å‘ effect fn(å‰ææ˜¯æ²¡æœ‰æä¾› options.scheduler ï¼Œå¦åˆ™æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ) ã€‚\n è¢« stopped çš„ effect å¯ä»¥å½“åšå¦ä¸€ä¸ªæ­£å¸¸çš„ effect çš„ fnã€‚\n  é›†åˆç±»å‹ä»£ç†(proxy handlers)è„‘å›¾    add collection handlers   feat(add): mutable collection handlers Â· gcclll/stb-vue-next@521f755\n collection proxy handlers è„‘å›¾é“¾æ¥\n å› ä¸º Reflect æ²¡æœ‰é›†åˆæ“ä½œçš„å¯¹åº”æ¥å£ï¼Œæ‰€ä»¥é’ˆå¯¹é›†åˆç±»å‹éœ€è¦é€šè¿‡ get proxy æ¥ä¸­è½¬ åšç‰¹æ®Šå¤„ç†ã€‚\n1 2 3 4 5 6  function createInstrumentationGetter(isReadonly: boolean, shallow: boolean) { // TODO } export const mutableCollectionHandlers: ProxyHandler\u0026lt;CollectionTypes\u0026gt; = { // get: createInstrumentationGetter(false, false) }     æ·»åŠ é›†åˆç±»å‹çš„ handlersã€‚\n  add collection get proxy handler   feat(add): collection get proxy Â· gcclll/stb-vue-next@a5e8e06\n é’ˆå¯¹é›†åˆçš„æ‰€æœ‰æ“ä½œä»£ç†éƒ½æ˜¯é€šè¿‡ get proxy å˜ç›¸å®Œæˆçš„ï¼Œæ‰€ä»¥ææ‡‚è¿™é‡Œæ˜¯è‡³å…³é‡è¦çš„ã€‚\n collection proxy handler:\n1 2 3  export const mutableCollectionHandlers: ProxyHandler\u0026lt;CollectionTypes\u0026gt; = { get: createInstrumentationGetter(false, false) }     ç®€å•å§ï¼Œåˆ«è¢«å‡ğŸ˜ç»™è¿·æƒ‘äº†ï¼ï¼ï¼\n è¿™é‡Œçš„åŸç†å¦‚æœæƒ³é€šäº†ä¹Ÿç®€å•ã€‚\n è¯•æƒ³ä¸‹ï¼Œæˆ‘ä»¬è°ƒç”¨é›†åˆç±»å‹çš„æ–¹æ³•æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Ÿï¼Ÿï¼Ÿ\n map.get(), map.set(), map.delete(), ...\n éƒ½æ˜¯é€šè¿‡ç‚¹è¯­æ³•ä½¿ç”¨çš„ï¼Œç‚¹è¯­æ³•å‰æä¹Ÿå¿…é¡»æ˜¯å…ˆå–å‡ºå€¼æ¥è¿›è¡Œæ“ä½œï¼Œå³è¦è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œå…ˆ å°†æ–¹æ³•å–å‡ºæ¥ï¼Œå› æ­¤è¿™é‡Œå°±æ˜¯å–å€¼æ“ä½œã€‚\n ä»è¿™ä¸€ä¸ªå±‚çº§ä¸Šå»ç†è§£å»å®ç°ï¼Œå°±å¯ä»¥é€šè¿‡é›†åˆçš„ proxy get æ¥å˜ç›¸å®ç°æ‰€æœ‰é›†åˆçš„æ–¹ æ³•å’Œå±æ€§ä»£ç†ã€‚\n æ³¨æ„ Reflect.get(target, key, receiver) ç¬¬ä¸€ä¸ªä¼ çš„æ˜¯ä»€ä¹ˆï¼Ÿ\n boolean ? instrumentations : target å³å°è£…åçš„ instrumentations å•Š !\n å¦‚ï¼š map.get() -\u0026gt; target: map, key: get -\u0026gt; target: instumentations, key: get -\u0026gt; get(target, key, isReadonly, isShallow)\n é›†åˆçš„æ“ä½œæœ€ç»ˆ â€”â€“\u0026gt; è½¬å˜æˆ instrumentations å¯¹è±¡ä¸Šçš„æ“ä½œã€‚\n å»æ‰æš‚æ—¶ä¸éœ€è¦çš„ä»£ç (65ea709)ï¼š\n feat: add get proxy handler Â· gcclll/stb-vue-next@65ea709\n å®ç°é¡ºåº(åŸç†)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  // 1. å¯¹å¤–çš„ handlers export const mutableCollectionHandlers: ProxyHandler\u0026lt;CollectionTypes\u0026gt; = { get: createInstrumentationGetter(false, false) } // 2. å°è£… get proxy æ‰€æœ‰ collection æ“ä½œçš„å…¥å£ function createInstrumentationGetter(isReadonly: boolean, shallow: boolean) { const instrumentations = mutableInstrumentations return ( target: CollectionTypes, key: string | symbol, receiver: CollectionTypes ) =\u0026gt; { if (key === ReactiveFlags.IS_REACTIVE) { return !isReadonly } else if (key === ReactiveFlags.IS_READONLY) { return isReadonly } else if (key === ReactiveFlags.RAW) { return target } // å°†é›†åˆæ“ä½œä»£ç†åˆ° instrumentations å¯¹è±¡ä¸Š  return Reflect.get( hasOwn(instrumentations, key) \u0026amp;\u0026amp; key in target ? instrumentations : target, key, receiver ) } } // 3. map -\u0026gt; instrumentations -\u0026gt; proxy ä¸­é—´å¯¹è±¡ const mutableInstrumentations: Record\u0026lt;string, Function\u0026gt; = { // get proxy handler, this -\u0026gt; target  get(this: MapTypes, key: unknown) { return get(this, key) } } // 4. æœ€ç»ˆæ‰§è¡Œæ“ä½œå¾—åˆ°ç»“æœçš„å‡½æ•° function get( target: MapTypes, key: unknown, isReadonly = false, isShallow = false ) { // TODO  console.log({ target, key }) return target.get(key) }     ç†è§£è¿‡ç¨‹ï¼š\n é¦–å…ˆè¦ç†è§£æ‰§è¡Œè¿™ä¸€å¥ map.get(\u0026#39;foo\u0026#39;) å‘ç”Ÿäº†ä»€ä¹ˆ\n  é¦–å…ˆæ˜¯ map.get å–å€¼æ“ä½œï¼Œå³ createInstrumentationGetter() æœ€å return çš„ é‚£ä¸€å¥\n å…¶å®æ˜¯é’ˆå¯¹ map.get æ“ä½œçš„ä»£ç†ï¼Œå°† \u0026#34;get\u0026#34; æ–¹æ³•ä» map å¯¹è±¡ä¸­å–å‡ºæ¥çš„ä»£ç†ã€‚\n æ‰€ä»¥ Reflect.get(target, key, receiver) è¿™é‡Œçš„ key = \u0026#34;foo\u0026#34;\n  ç»è¿‡ #1 ä¹‹åï¼Œéœ€è¦ç«‹å³æ‰§è¡Œ \u0026#34;get\u0026#34; æ–¹æ³•å³ () æ“ä½œ\n æ­¤æ—¶æ‰§è¡Œçš„æ˜¯ mutableInstrumentations.get(this, key) æ–¹æ³•\n æ‰€ä»¥è¿™é‡Œçš„ key = \u0026#39;foo\u0026#39; , this å°±æ˜¯è°ƒç”¨ get() æ–¹æ³•çš„å¯¹è±¡ map ã€‚   æœ€å get æ“ä½œä¼šè¢«æ¨¡å—å…¨å±€å‡½æ•° get(target, key, isReadonly, isShallow) ä»£æ›¿ï¼Œ åšäº†è®¸å¤šç‰¹æ®Šå¤„ç†ï¼Œæ”¶é›†ä¾èµ–ã€‚\n     12bc4da add get handler   feat(add): get function for collection proxy Â· gcclll/stb-vue-next@12bc4da\n FIX: edc1d3f æ­»å¾ªç¯é—®é¢˜(ç›´æ¥æ”¾å› target.get(key) åˆä¼šè§¦å‘ get -\u0026gt; â€¦) fix: infinite loop Â· gcclll/stb-vue-next@edc1d3f\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map([[\u0026#39;foo\u0026#39;, 1]]) const observed = reactive(map) const res = observed.get(\u0026#39;foo\u0026#39;) console.log({ res })     +RESULTS:\n{ key: \u0026#39;get\u0026#39;, target: Map(1) { \u0026#39;foo\u0026#39; =\u0026gt; 1 }, x: \u0026#39;in createInstrumentationsGetter\u0026#39; } { key: \u0026#39;foo\u0026#39;, target: Map(1) { \u0026#39;foo\u0026#39; =\u0026gt; 1 }, x: \u0026#39;in get\u0026#39; } { res: 100 }   ç»“æœå¦‚ä¸Š(å‚è§.åŸç†è¯¦ç»†åˆ†æ)\n  reactive(map) -\u0026gt; å°† map ä»£ç†ç»™ instrumentations{ get }\n  observed.get -\u0026gt; å¾—åˆ° instrumentations é‡Œé¢çš„ \u0026#34;get\u0026#34; æ–¹æ³•\n  (\u0026#39;foo\u0026#39;) -\u0026gt; æ‰§è¡Œ instrumentations.get(this, key), key = \u0026#39;foo\u0026#39;\n  è¿”å›ç»“æœ\n   è‡³æ­¤ï¼Œå®Œæˆ collection get proxy handler çš„å®Œæ•´æµç¨‹ã€‚\n   0b3fd71 add get handler track   feat(add): collection proxy get -\u0026gt; global get Â· gcclll/stb-vue-next@0b3fd71\n æ–°å¢get æ“ä½œï¼Œtrack æ·»åŠ ä¾èµ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map([[\u0026#39;foo\u0026#39;, 1]]) const observed = reactive(map) let dummy effect(() =\u0026gt; { dummy = observed.get(\u0026#39;foo\u0026#39;) }) console.log(`dummy = ${dummy}`)     +RESULTS:\n{ key: \u0026#39;get\u0026#39;, target: Map(1) { \u0026#39;foo\u0026#39; =\u0026gt; 1 }, x: \u0026#39;in createInstrumentationGetter\u0026#39; } { key: \u0026#39;foo\u0026#39;, type: \u0026#39;get\u0026#39;, dep: Set(1) { [Function: reactiveEffect] { id: 0, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [Array], options: {} } }, x: \u0026#39;in track\u0026#39; } { key: \u0026#39;foo\u0026#39;, target: Map(1) { \u0026#39;foo\u0026#39; =\u0026gt; 1 }, x: \u0026#39;in global get\u0026#39; } dummy = 100   åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ\n  collection proxy handler å– map.get æ–¹æ³•, key = \u0026#39;get\u0026#39;\n  (\u0026#39;prop\u0026#39;) æ‰§è¡ŒæœŸè§¦å‘ instrumentations.get(this, key), key = \u0026#39;foo\u0026#39;\n  æ‰§è¡Œ global get è§¦å‘ track æ”¶é›†ä¾èµ–ï¼Œè¿”å›ç»“æœå€¼\n   å‡è®¾ map.get(key) çš„ key ä¹Ÿæ˜¯ä¸ª proxy :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) let dummy const key = reactive({ k: 1 }) const value = reactive({ v: 2 }) const map = reactive(new Map([[key, value]])) effect( () =\u0026gt; { dummy = map.get(key) } ) console.log(`dummy = ${dummy}`)     +RESULTS:\n{ #1 key: \u0026#39;get\u0026#39;, target: Map(1) { { k: 1 } =\u0026gt; { v: 2 } }, x: \u0026#39;in createInstrumentationGetter\u0026#39; } #2 { key: { k: 1 }, rawKey: { k: 1 }, eq: false } { #3 key: { k: 1 }, type: \u0026#39;get\u0026#39;, dep: Set(1) { [Function: reactiveEffect] { id: 0, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [Array], options: {} } }, x: \u0026#39;in track\u0026#39; } { #4 key: { k: 1 }, type: \u0026#39;get\u0026#39;, dep: Set(1) { [Function: reactiveEffect] { id: 0, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [Array], options: {} } }, x: \u0026#39;in track\u0026#39; } { #5 key: { k: 1 }, target: Map(1) { { k: 1 } =\u0026gt; { v: 2 } }, x: \u0026#39;in global get\u0026#39; } dummy = 100    #1 proxy collection get handler\n  #2 global get å‡½æ•°é‡Œè°ƒç”¨ track ä¹‹å‰è¾“å‡ºï¼Œæ˜¾ç¤º key å’Œ rawKey æ˜¯ä¸åŒçš„ (eq = false)ï¼Œå› ä¸ºå‰è€…æ˜¯ä¸ª proxy åè€…æ˜¯ key proxy çš„ rawValue ã€‚\n  #3 track() è°ƒç”¨æ—¶çš„è¾“å‡ºï¼Œæ˜¾ç¤ºçš„æ˜¯éœ€è¦æ”¶é›†ä¾èµ–çš„æ˜¯ proxy key{k: 1}   #4 track() è°ƒç”¨æ—¶çš„è¾“å‡ºï¼Œæ˜¾ç¤ºçš„æ˜¯éœ€è¦æ”¶é›†ä¾èµ–çš„æ˜¯ raw key{k: 1}\n   ä» #3, #4 å¯çŸ¥å¦‚æœ key æœ¬èº«å·²ç»æ˜¯ proxy é‚£ä¹ˆå®ƒåŠå…¶å¯¹åº”çš„ rawKey åŒæ—¶ä¹Ÿä¼šæ”¶é›† å½“å‰çš„ effect ã€‚\n  77b14ef add get handler return value   feat(add): collection proxy get with value return Â· gcclll/stb-vue-next@77b14ef\n  è¿™é‡Œå¤„ç†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š\n  å–å‡º has æ–¹æ³•æ£€æµ‹å­˜åœ¨æ€§\n  æ ¹æ® isReadonly å’Œ isShallow å†³å®šå¯¹è¿”å›å€¼åšä»€ä¹ˆå¤„ç†ï¼Œå¦‚ï¼šé€’å½’ reactive/readonly\n  ä½¿ç”¨ target.get(key) å–å‡ºç»“æœå€¼è¿”å›\n      add collection set proxy handler   feat(add): collection set proxy handler Â· gcclll/stb-vue-next@7b680df\n set proxy handler å¤„ç†\n  è®¾å€¼çš„æ—¶å€™å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µ a) set, b) add\n  éœ€è¦è€ƒè™‘ proxy key å’Œ raw key é—®é¢˜\n  æœ€å trigger è§¦å‘ä¾èµ–\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  function set(this: MapTypes, key: unknown, value: unknown) { value = toRaw(value) const target = toRaw(this) const { has, get } = getProto(target) let hadKey = has.call(target, key) // è€ƒè™‘ key å¯èƒ½æ˜¯ proxy  if (!hadKey) { // to add  key = toRaw(key) hadKey = has.call(target, key) } else if (__DEV__) { checkIdentityKeys(target, has, key) } const oldValue = get.call(target, key) // è®¾å€¼ç»“æœ  const result = target.set(key, value) if (!hadKey) { // æ·»åŠ æ“ä½œ  trigger(target, TriggerOpTypes.ADD, key, value) } else { // è®¾å€¼æ“ä½œ  trigger(target, TriggerOpTypes.SET, key, value, oldValue) } return result }     æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map() const observed = reactive(map) console.log(`\u0026gt; before get, deps`) console.log(targetMap.get(map)) let dummy effect(() =\u0026gt; { dummy = observed.get(\u0026#39;foo\u0026#39;) }) console.log(`\u0026gt; after get, deps`) console.log(targetMap.get(map).get(\u0026#39;foo\u0026#39;)) console.log(`#1 before set, dummy = ${dummy}`) observed.set(\u0026#39;foo\u0026#39;, 1) console.log(`#2 after set, dummy = ${dummy}`)     +RESULTS:\n\u0026gt; before get, deps undefined \u0026gt; after get, deps \u0026lt;ref *1\u0026gt; Set(1) { [Function: reactiveEffect] { id: 0, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [ [Circular *1] ], options: {} } } #1 before set, dummy = undefined #2 after set, dummy = 1    add collection size,has,add proxy handler   feat(add): size, has, add collection proxy handlers Â· gcclll/stb-vue-next@73fa5eb\n has: proxy key, raw key éƒ½éœ€è¦ track has æ“ä½œä¾èµ–\n1 2 3 4 5 6 7 8 9 10 11 12 13  function has(this: CollectionTypes, key: unknown, isReadonly = false): boolean { const target = (this as any)[ReactiveFlags.RAW] const rawTarget = toRaw(target) const rawKey = toRaw(key) if (key !== rawKey) { !isReadonly \u0026amp;\u0026amp; track(rawTarget, TrackOpTypes.HAS, key) } !isReadonly \u0026amp;\u0026amp; track(rawTarget, TrackOpTypes.HAS, rawKey) return key === rawKey ? target.has(key) : target.has(key) || target.has(rawKey) }     size: å–size å†…éƒ¨å®ç°è¿‡ç¨‹ä¸­æ˜¯éœ€è¦å¯¹ collection è¿›è¡Œè¿­ä»£æ“ä½œçš„ï¼Œæ‰€ä»¥ track ç”¨çš„æ˜¯ ITERATE_KEY\n1 2 3 4 5  function size(target: IterableCollections, isReadonly = false) { target = (target as any)[ReactiveFlags.RAW] !isReadonly \u0026amp;\u0026amp; track(toRaw(target), TrackOpTypes.ITERATE, ITERATE_KEY) return Reflect.get(target, \u0026#39;size\u0026#39;, target) }     add: set.add æ“ä½œï¼Œæ ¹æ® set ç‰¹æ€§ï¼Œkey,value éƒ½æ˜¯åŒä¸€ä¸ªä¸”å…ƒç´ æ˜¯ä¸é‡å¤çš„ï¼Œæ‰€ä»¥åªéœ€ è¦æ£€æµ‹æ˜¯ä¸æ˜¯æ–°å¢ï¼Œæ–°å¢å°±éœ€è¦ trigger ADD ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  function add(this: SetTypes, value: unknown) { value = toRaw(value) const target = toRaw(this) const proto = getProto(target) const hadKey = proto.has.call(target, value) const result = target.add(value) // å› ä¸º set æ˜¯ä¸ä¼šå­˜åœ¨é‡å¤å…ƒç´ çš„ï¼Œæ‰€ä»¥åªä¼šåœ¨æ²¡æœ‰å½“å‰ key çš„æƒ…å†µä¸‹æ‰ä¼šæ‰§è¡Œ  // æ·»åŠ æ“ä½œ  if (!hadKey) { trigger(target, TriggerOpTypes.ADD, value, value) } return result }     trigger å¤„ç†ï¼š838b402\n feat(add): collection trigger cases Â· gcclll/stb-vue-next@838b402\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map() const observed = reactive(map) let dummy effect(() =\u0026gt; { dummy = observed.size }) console.log(`before set, get map size -\u0026gt; dummy = ${dummy}`) observed.set(\u0026#39;foo\u0026#39;, 1) console.log(`after set, get map size -\u0026gt; dummy = ${dummy}`) effect(() =\u0026gt; { dummy = observed.has(\u0026#39;foo\u0026#39;) }) console.log(`observed has \u0026#39;foo\u0026#39; -\u0026gt; dummy = ${dummy}`) const set = new Set() const observedSet = reactive(set) effect(() =\u0026gt; { dummy = observedSet.size }) console.log(`before add, get set size -\u0026gt; dummy = ${dummy}`) observedSet.add(1) console.log(`after add, get set size -\u0026gt; dummy = ${dummy}`)     +RESULTS:\nbefore set, get map size -\u0026gt; dummy = 0 after set, get map size -\u0026gt; dummy = 1 observed has \u0026#39;foo\u0026#39; -\u0026gt; dummy = true before add, get set size -\u0026gt; dummy = 0 after add, get set size -\u0026gt; dummy = 1    add collection delete,clear proxy handler   feat(add): collection delete and clear Â· gcclll/stb-vue-next@b3c5087\n delete:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function deleteEntry(this: CollectionTypes, key: unknown) { const target = toRaw(this) const { has, get } = getProto(target) let hadKey = has.call(target, key) if (!hadKey) { key = toRaw(key) hadKey = has.call(target, key) } else if (__DEV__) { checkIdentityKeys(target, has, key) } const oldValue = get ? get.call(target, key) : undefined const result = target.delete(key) if (hadKey) { trigger(target, TriggerOpTypes.DELETE, key, undefined, oldValue) } return result }     clear:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function clear(this: IterableCollections) { const target = toRaw(this) const hadItems = target.size !== 0 const oldTarget = __DEV__ ? isMap(target) ? new Map(target) : new Set(target) : undefined const result = target.clear() if (hadItems) { trigger(target, TriggerOpTypes.CLEAR, undefined, undefined, oldTarget) } return result }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map() const observedMap = reactive(map) let dummy effect(() =\u0026gt; { dummy = observedMap.size }) console.log(`\u0026gt;\u0026gt;\u0026gt; map`) observedMap.set(\u0026#39;foo\u0026#39;, 1) console.log(`before delete, dummy = ${dummy}`) observedMap.delete(\u0026#39;foo\u0026#39;) console.log(`after delete, dummy = ${dummy}`) observedMap.set(\u0026#39;foo\u0026#39;, 1) observedMap.set(\u0026#39;bar\u0026#39;, 1) console.log(`before clear, dummy = ${dummy}`) observedMap.clear() console.log(`after clear, dummy = ${dummy}`) console.log(`\u0026gt;\u0026gt;\u0026gt; set`) const set = new Set() const observedSet = reactive(set) effect(() =\u0026gt; { dummy = observedSet.size }) observedSet.add(1) console.log(`before delete, dummy = ${dummy}`) observedSet.delete(1) console.log(`after delete, dummy = ${dummy}`) observedSet.add(1) observedSet.add(2) observedSet.add(3) console.log(`before clear, dummy = ${dummy}`) observedSet.clear() console.log(`after clear, dummy = ${dummy}`)     +RESULTS:\n\u0026gt;\u0026gt;\u0026gt; map before delete, dummy = 1 after delete, dummy = 0 before clear, dummy = 2 after clear, dummy = 0 \u0026gt;\u0026gt;\u0026gt; set before delete, dummy = 1 after delete, dummy = 0 before clear, dummy = 3 after clear, dummy = 0    add collection forEach proxy handler   feat(add): collection forEach proxy handler Â· gcclll/stb-vue-next@77a0222\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function createForEach(isReadonly: boolean, isShallow: boolean) { return function forEach( this: IterableCollections, callback: Function, thisArg?: unknown ) { const observed = this as any const target = observed[ReactiveFlags.RAW] const rawTarget = toRaw(target) const wrap = isReadonly ? toReadonly : isShallow ? toShallow : toReactive !isReadonly \u0026amp;\u0026amp; track(rawTarget, TrackOpTypes.ITERATE, ITERATE_KEY) return target.forEach((value: unknown, key: unknown) =\u0026gt; { // é‡è¦ï¼šç¡®ä¿å›è°ƒ  // 1. åœ¨ reactive map ä½œç”¨åŸŸä¸‹è¢«æ‰§è¡Œ(this, å’Œç¬¬ä¸‰ä¸ªå‚æ•°)  // 2. æ¥å—çš„ value å€¼åº”è¯¥æ˜¯ä¸ª reactive/readonly ç±»å‹  return callback.call(thisArg, wrap(value), wrap(key), observed) }) } }     å°† forEach å°è£…äº†ä¸€å±‚ï¼Œå¯¹ä¼ é€’ç»™å›è°ƒçš„å€¼ reactive åŒ–ï¼Œä½¿ç”¨ ITERATE_KEY æ”¶é›†è°ƒç”¨ è¯¥æ–¹æ³•çš„ä¾èµ–ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map() const ob = reactive(map) let dummy = 0 effect(() =\u0026gt; { ob.forEach((value) =\u0026gt; (dummy += value || 0)) }) console.log(`#1 before set 1, dummy = ${dummy}`) ob.set(\u0026#39;foo\u0026#39;, 1) console.log(`#2 before set 2, dummy = ${dummy}`) ob.set(\u0026#39;bar\u0026#39;, 2) console.log(`#3 after set, dummy = ${dummy}`)     +RESULTS:\n#1 before set 1, dummy = 0 #2 before set 2, dummy = 1 #3 after set, dummy = 4    #1 effect ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯æ­¤æ—¶ map æ²¡æ•°æ®\n  #1 æ·»åŠ  foo =\u0026gt; 1 ä¹‹åæ‰§è¡Œ effect fn forEach è¿­ä»£å™¨è¿›è¡Œç´¯åŠ æ“ä½œçš„ç»“æœ\n  #2 æ·»åŠ  bar =\u0026gt; 2 ç»“æœæ˜¯ 4ï¼ŒåŸå› æ˜¯åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ dummy = 1 çš„ï¼Œæ‰€ä»¥å†ç´¯åŠ ä¹‹\n  åå°±æ˜¯ 4\n  add collection iterators methods proxy handler   feat(add): collection iterable methods Â· gcclll/stb-vue-next@e5497be\n add code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  interface Iterable { [Symbol.iterator](): Iterator } interface Iterator { next(value?: any): IterationResult } interface IterationResult { value: any done: boolean } function createIterableMethod( method: string | symbol, isReadonly: boolean, isShallow: boolean ) { return function( this: IterableCollections, ...args: unknown[] ): Iterable \u0026amp; Iterator { const target = (this as any)[ReactiveFlags.RAW] const rawTarget = toRaw(target) const targetIsMap = isMap(rawTarget) const isPair = method === \u0026#39;entries\u0026#39; || (method === Symbol.iterator \u0026amp;\u0026amp; targetIsMap) const isKeyOnly = method === \u0026#39;keys\u0026#39; \u0026amp;\u0026amp; targetIsMap const innerIterator = target[method](...args) const wrap = isReadonly ? toReadonly : isShallow ? toShallow : toReactive !isReadonly \u0026amp;\u0026amp; track( rawTarget, TrackOpTypes.ITERATE, isKeyOnly ? MAP_KEY_ITERATE_KEY : ITERATE_KEY ) // é‡å†™è¿­ä»£å™¨ï¼Œè®©å…¶è¿”å›çš„å¯¹è±¡ä¹Ÿæ˜¯ reactive/readonly ç±»å‹  return { next() { const { value, done } = innerIterator.next() return done ? { value, done } : { value: isPair ? [wrap(value[0]), wrap(value[1])] : wrap(value), done } }, [Symbol.iterator]() { return this } } } }     test:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  const { isReactive, effect, reactive, targetMap, shallowReactive, toRaw } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map() const obj = { name: \u0026#39;dax\u0026#39; } map.set(\u0026#34;foo\u0026#34;, 1) map.set(\u0026#34;bar\u0026#34;, 2) map.set(\u0026#39;dax\u0026#39;, obj) const observed = reactive(map) let dummy = [] effect(() =\u0026gt; { for (let key of observed.entries()) { dummy.push(key) } }) console.log(`\u0026gt;\u0026gt;\u0026gt; #1 set`) console.log(`before set, dummy = ${dummy}`) observed.set(\u0026#39;baz\u0026#39;, 3) console.log(`after set, dummy = ${dummy}`) console.log(`obj in map is reactive ${isReactive(observed.get(\u0026#34;dax\u0026#34;))}`) effect(() =\u0026gt; { dummy = observed.size }) console.log(`\u0026gt;\u0026gt;\u0026gt; #2 clear`) console.log(`before clear, dummy = ${dummy}`) observed.clear() console.log(`after clear, dummy = ${dummy}`) console.log(`\u0026gt;\u0026gt;\u0026gt; #3 should not observe custom property`) effect(() =\u0026gt; (dummy = observed.customProp)) console.log(`before set cumstom prop, dummy = ${dummy}`) observed.customProp = \u0026#39;Hello World\u0026#39; console.log(`after set cumstom prop, dummy = ${dummy}`) console.log(`\u0026gt;\u0026gt;\u0026gt; #4 ä¸åº”è¯¥ä½¿ Proxies æ±¡æŸ“åŸæ¥çš„ Map å¯¹è±¡`) const map2 = new Map() const observed2 = reactive(map2) const value = reactive({}) observed2.set(\u0026#39;key\u0026#39;, value) console.log(`map2.get(\u0026#39;key\u0026#39;) !== value, ${map2.get(\u0026#39;key\u0026#39;) !== value}`) console.log(`map2.get(\u0026#39;key\u0026#39;) === toRaw(value), ${map2.get(\u0026#39;key\u0026#39;) === toRaw(value)}`)     +RESULTS:\n\u0026gt;\u0026gt;\u0026gt; #1 set before set, dummy = foo,1,bar,2,dax,[object Object] after set, dummy = foo,1,bar,2,dax,[object Object],foo,1,bar,2,dax,[object Object],baz,3 obj in map is reactive true \u0026gt;\u0026gt;\u0026gt; #2 clear before clear, dummy = 4 after clear, dummy = 0 \u0026gt;\u0026gt;\u0026gt; #3 should not observe custom property before set cumstom prop, dummy = undefined after set cumstom prop, dummy = undefined \u0026gt;\u0026gt;\u0026gt; #4 ä¸åº”è¯¥ä½¿ Proxies æ±¡æŸ“åŸæ¥çš„ Map å¯¹è±¡ map2.get(\u0026#39;key\u0026#39;) !== value, true map2.get(\u0026#39;key\u0026#39;) === toRaw(value), true    #1 åœ¨éå†è¿‡ç¨‹ä¸­ get -\u0026gt; track -\u0026gt; é€’å½’ reactiveï¼Œæ‰€ä»¥ obj æ˜¯ obsreved.get(\u0026#39;dax\u0026#39;) ç»“æœæ˜¯ reactive ã€‚\n  #2 clear å†…éƒ¨å®ç°ä¼šå–è¿­ä»£å™¨è¿›è¡Œè¿­ä»£åˆ é™¤ï¼Œå¹¶ä¸”æ”¹å˜æœ€ç»ˆ size å€¼ã€‚\n  #3 collectionHandlers.ts ä¸­çš„æ–¹æ³•éƒ½æ˜¯é’ˆå¯¹é›†åˆæœ¬èº«å…ƒç´ è¿›è¡Œæ“ä½œçš„ï¼Œå¯¹äºè‡ªå®šä¹‰ å±æ€§æ˜¯ä¸åœ¨å“åº”å¼ Map/Set ä¹‹åˆ—çš„ã€‚\n  #4 set proxy handler é‡Œé¢çš„å®ç°ä¼šå…ˆå– toRaw(value) å†è¿›è¡Œè®¾ç½®æ“ä½œã€‚\n    add collection readonly proxy handlers   feat(add): readonly collection handlers Â· gcclll/stb-vue-next@fa2636d\n åˆ›å»ºå‡ ä¸ªè®¾ç½®å‹çš„æ–¹æ³•(add,set,delete,clear) create readonly method for settable handlers(add,set,delete,clear)\n1 2 3 4 5 6 7 8 9 10 11 12  function createReadonlyMethod(type: TriggerOpTypes): Function { return function(this: CollectionTypes, ...args: unknown[]) { if (__DEV__) { const key = args[0] ? `on key \u0026#34;${args[0]}\u0026#34;` : `` console.warn( `${capitalize(type)}operation ${key}failed: target is readonly.`, toRaw(this) ) } return type === TriggerOpTypes.DELETE ? false : this } }     readonly instrumentations:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const readonlyInstrumentations: Recor\u0026lt;string, Function\u0026gt; = { get(this: MapTypes, key: unknown) { return get(this, key, true) }, get size() { return size((this as unknown) as IterableCollections, true) }, has(this: MapTypes, key: unknown) { return has.call(this, key, true) }, add: createReadonlyMethod(TriggerOpTypes.ADD), set: createReadonlyMethod(TriggerOpTypes.SET), delete: createReadonlyMethod(TriggerOpTypes.DELETE), clear: createReadonlyMethod(TriggerOpTypes.CLEAR), forEach: createForEach(true, false) }     æµ‹è¯•ï¼š\n  add collection shallow proxy handlers   feat(add): shallow collection handlers Â· gcclll/stb-vue-next@676bc70\n ä¸ä¼šé€’å½’ reactive ç‰ˆæœ¬ã€‚\n  computed  types definitions   feat(add): computed type definitions Â· gcclll/stb-vue-next@e9e53a1\n computed è®¡ç®—å±æ€§çš„ä¸€äº›ç±»å‹å®šä¹‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11  import { Ref } from \u0026#39;./ref\u0026#39; export interface ComputedRef\u0026lt;T = any\u0026gt; extends WritableComputedRef\u0026lt;T\u0026gt; {} export interface WritableComputedRef\u0026lt;T\u0026gt; extends Ref\u0026lt;T\u0026gt; {} export type ComputedGetter\u0026lt;T\u0026gt; = (ctx?: any) =\u0026gt; T export type ComputedSetter\u0026lt;T\u0026gt; = (v: T) =\u0026gt; void export interface WritableComputedOptions\u0026lt;T\u0026gt; {}     computed å‡½æ•°é‡è½½(315e0d9)ï¼š feat(add): computed function reloads Â· gcclll/stb-vue-next@315e0d9\n1 2 3 4 5 6 7  export function computed\u0026lt;T\u0026gt;(getter: ComputedGetter\u0026lt;T\u0026gt;): ComputedRef\u0026lt;T\u0026gt; export function computed\u0026lt;T\u0026gt;( options: WritableComputedOptions\u0026lt;T\u0026gt; ): WritableComputedRef\u0026lt;T\u0026gt; export function computed\u0026lt;T\u0026gt;( getterOrOptions: ComputedGetter\u0026lt;T\u0026gt; | WritableComputedOptions\u0026lt;T\u0026gt; ) {}      implementation   feat(add): computed tpl and computed function Â· gcclll/stb-vue-next@64d380d\n è®¡ç®—å±æ€§å®ç°å…¨åœ¨ ComputedRefImpl\u0026lt;T\u0026gt; ç±»çš„å®ç°ä¸­ï¼Œå®ç°å…³é”®ç‚¹\n  ä½¿ç”¨ effect å°è£… getter å‡½æ•°ï¼Œæ”¶é›†æ‰€æœ‰ä¾èµ–ï¼Œåœ¨ç‰¹å®šæ—¶å€™æ‰§è¡Œ effect\n  _dirty æ ‡è®°ï¼Œä¸€æ—¦ _dirty = true è¡¨ç¤ºæ•°æ®æœ‰æ›´æ–°ï¼Œä¸‹æ¬¡å–å€¼çš„æ—¶å€™å°±è¦ç«‹å³æ‰§è¡Œ effect å–æœ€æ–°å€¼\n   class ComputedRefImpl\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  // è®¡ç®—å±æ€§æ¨¡æ¿ class ComputedRefImpl\u0026lt;T\u0026gt; { private _value!: T private _dirty = true public readonly effect: ReactiveEffect\u0026lt;T\u0026gt; public readonly __v_isRef = true; public readonly [ReactiveFlags.IS_READONLY]: boolean constructor( getter: ComputedGetter\u0026lt;T\u0026gt;, private readonly _setter: ComputedSetter\u0026lt;T\u0026gt;, isReadonly: boolean ) { this.effect = effect(getter, { lazy: true, scheduler: () =\u0026gt; { if (!this._dirty) { this._dirty = true trigger(toRaw(this), TriggerOpTypes.SET, \u0026#39;value\u0026#39;) } } }) this[ReactiveFlags.IS_READONLY] = isReadonly } get value() { if (this._dirty) { this._value = this.effect() this._dirty = false } track(toRaw(this), TrackOpTypes.GET, \u0026#39;value\u0026#39;) return this._value } set value(newValue: T) { this._setter(newValue) } }     computed å‡½æ•°:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  export function computed\u0026lt;T\u0026gt;(getter: ComputedGetter\u0026lt;T\u0026gt;): ComputedRef\u0026lt;T\u0026gt; export function computed\u0026lt;T\u0026gt;( options: WritableComputedOptions\u0026lt;T\u0026gt; ): WritableComputedRef\u0026lt;T\u0026gt; export function computed\u0026lt;T\u0026gt;( getterOrOptions: ComputedGetter\u0026lt;T\u0026gt; | WritableComputedOptions\u0026lt;T\u0026gt; ) { let getter: ComputedGetter\u0026lt;T\u0026gt; let setter: ComputedSetter\u0026lt;T\u0026gt; if (isFunction(getterOrOptions)) { getter = getterOrOptions setter = __DEV__ ? () =\u0026gt; { console.warn(\u0026#39;Write operation failed: computed value is readonly\u0026#39;) } : NOOP } else { getter = getterOrOptions.get setter = getterOrOptions.set } return new ComputedRefImpl( getter, setter, isFunction(getterOrOptions) || !getterOrOptions.set ) as any }     computed å‡½æ•°çš„ options å¯ä»¥æ˜¯å‡½æ•°æˆ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç”¨å¤–éƒ¨è‡ªå®šä¹‰ setter å‡½æ•°ï¼Œæ¯”å¦‚ åœ¨æ›´æ–°ä¹‹å‰è®°å½•å½“å‰çŠ¶æ€ï¼Œå°±å¯ä»¥åœ¨ options.set ä¸­å»å®ç°ã€‚\n æµ‹è¯•è¯·ç§»æ­¥â€œè®¡ç®—å±æ€§æµ‹è¯•ç”¨ä¾‹â€\n è„‘å›¾è¯·ç›´æ¥æŸ¥çœ‹â€œå®Œæ•´è„‘å›¾ computed éƒ¨åˆ†â€\n    add ref    è¿™éƒ¨åˆ†å› ä¸ºä¹‹å‰æ²¡æœ‰å•ç‹¬æ‹å‡ºæ¥ä¸€æ­¥æ­¥å®ç°ï¼Œè€Œæ˜¯ç›´æ¥æ‹·è´è¿‡æ¥äº†ä¸ºäº†å…ˆæµ‹è¯• computed å± æ€§ã€‚\n æ‰€ä»¥è¿™é‡Œç›´æ¥æ ¹æ®æºç ä»¥åŠä½¿ç”¨æ–¹å¼æ¥è¿›è¡Œé€æ­¥åˆ†æã€‚\n APIs:\n   api function     isRef(r:any) æ£€æµ‹å‡½æ•°   ref(value) å°† value è½¬æˆ Ref ç±»å‹   shallowRef(value) ä¸è¿›è¡Œé€’å½’ reactive   createRef(rawValue, shallow = false) create ref, for ref/shallowRef   triggerRef(ref: Ref) è§¦å‘ ref å˜é‡ä¸Šçš„æ‰€æœ‰ä¾èµ–   unref(ref) å–æ¶ˆ ref åŒ–ï¼Œè¿”å› ref.value åŸå§‹å€¼   proxyRefs(objectWithRefs) refs ä»£ç†   RefImpl Ref å˜é‡æ¨¡æ¿   CustomRefImpl è‡ªå®šä¹‰ Ref å˜é‡æ¨¡æ¿    ref \u0026amp; shallow ref   ref() å’Œ shallowRef() å‡½æ•°éƒ½æ˜¯è°ƒç”¨çš„åŒä¸€ä¸ªå‡½æ•° createRef(val, shallow) æ¥ åˆ›å»ºref å˜é‡ï¼Œè€Œ createRef æœ¬èº«ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ new äº†ä¸€ä¸ª RefImpl å®ä¾‹å‡ºæ¥ã€‚\n å¦å¤–é’ˆå¯¹å·²ç»æ˜¯ ref çš„å€¼ä¸éœ€è¦é‡å¤ new æ“ä½œï¼Œç›´æ¥è¿”å›åŸ refã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // ref  export function ref(value?: unknown) { return createRef(value); } // shallow ref export function shallowRef(value?: unknown) { return createRef(value, true) } // createRef(rawValue, shallow = false) function createRef(rawValue: unknown, shallow = false) { if (isRef(rawValue)) { return rawValue } return new RefImpl(rawValue, shallow) }     å‚æ•°ï¼š\n  val éœ€è¦è¿›è¡Œ ref åŒ–çš„å˜é‡\n  shallow å¦‚æœ val æ˜¯å¯¹è±¡çš„æ—¶å€™å†³å®šæ˜¯å¦éœ€è¦å¯¹è¯¥å¯¹è±¡è¿›è¡Œé€’å½’ reactive åŒ–\n   çœ‹ä¸‹ ref ç»“æ„æ¨¡æ¿ç±»ï¼š RefImpl\u0026lt;T\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  class RefImpl\u0026lt;T\u0026gt; { private _value: T public readonly __v_isRef = true constructor(private _rawValue: T, public readonly _shallow = false) { this._value = _shallow ? _rawValue : convert(_rawValue) } get value() { track(toRaw(this), TrackOpTypes.GET, \u0026#39;value\u0026#39;) return this._value } set value(newVal) { if (hasChanged(toRaw(newVal), this._rawValue)) { this._rawValue = newVal this._value = this._shallow ? newVal : convert(newVal) trigger(toRaw(this), TriggerOpTypes.SET, \u0026#39;value\u0026#39;, newVal) } } }     ä»£ç æ˜¯ç›¸å½“ç®€å•çš„ï¼Œå››ä¸ªå±æ€§(_value/__v_isRef/_rawValue/_shallow)+ä¸¤ä¸ªè®¿é—®å™¨æ–¹æ³• (value getter/setter)ã€‚\n æ ¹æ® es6 class è¯­æ³•ï¼Œæ„é€ å‚æ•°å¦‚æœä½¿ç”¨äº†æƒé™ä¿®é¥°ç¬¦ä¼šè‡ªåŠ¨è½¬æˆæˆå‘˜å±æ€§ï¼Œæ‰€ä»¥ _rawValue å’Œ _shallow ä¹Ÿæ˜¯ RefImpl æˆå‘˜å±æ€§å’Œ _value æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äºè¿™ ä¸¤ä¸ªå€¼å¯ä»¥é€šè¿‡å¤–éƒ¨æ§åˆ¶ã€‚\n  å¼€å§‹æµ‹è¯•å§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rt: { ref, shallowRef, effect, reactive }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); const a = ref(1); log(\u0026#34;1. base usage \u0026gt;\u0026gt;\u0026gt;\u0026#34;); log([\u0026#34;before, a.value = \u0026#34;, a.value]); a.value = 2; log([\u0026#34;after, a.value = \u0026#34;, a.value]); log(\u0026#34;\\n2. should be reactive \u0026gt;\u0026gt;\u0026gt;\u0026#34;); log(\u0026#34;ge/set value é‡Œé¢ä½¿ç”¨çš„æ˜¯ track/trigger\u0026#34;); let dummy, calls = 0; effect(() =\u0026gt; { calls++; dummy = a.value; }); log(`before set a.value, dummy=${dummy}, calls=${calls}`); a.value = 3; log(`after set a.value, dummy=${dummy}, calls=${calls}`); log(\u0026#34;\\n3. é»˜è®¤æƒ…å†µä¸‹å¯¹åµŒå¥—å¯¹è±¡å±æ€§è¿›è¡Œ reactive \u0026gt;\u0026gt;\u0026gt;\u0026#34;); const b = ref({ count: 1 }); effect(() =\u0026gt; (dummy = b.value.count)); log(\u0026#34;before set, dummy = ${dummy}\u0026#34;); log(\u0026#34;after set, dummy = ${dummy}\u0026#34;); log(\u0026#34;\\n4. ref() ä¸ä¼ å€¼çš„æ—¶å€™ä¹Ÿåº”è¯¥å¯ä»¥å·¥ä½œ\u0026#34;); const c = ref(); // ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œç»™ä»€ä¹ˆå€¼éƒ½å¯ä»¥ effect(() =\u0026gt; (dummy = c.value)); log(`before set, dummy = ${dummy}`); c.value = 100; log(`after set, dummy = ${dummy}`); // å½“åµŒå¥—åœ¨ä¸€ä¸ªå¤šå±‚çº§çš„å¯¹è±¡é‡Œçš„æ—¶å€™ // å› ä¸º ref() è¿”å›çš„æ˜¯ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥æ”¾åœ¨å¯¹è±¡é‡Œé¢æœ¬è´¨ä¸Šæ“ä½œçš„è¿˜æ˜¯ // ref æœ¬èº« log(\u0026#34;\\n5. ref ä½œä¸ºå¤šçº§å¯¹è±¡çš„å€¼æ—¶\u0026#34;); const d = ref(1); const obj = reactive({ d, b: { c: d }, }); let dummy1, dummy2; effect(() =\u0026gt; { dummy1 = obj.d; dummy2 = obj.b.c; }); log(`before set, dummy1=${dummy1}, dummy2=${dummy2}`); d.value++; log(`d.value++, dummy1=${dummy1}, dummy2=${dummy2}`); // æ³¨æ„è¿™é‡Œç›´æ¥é’ˆå¯¹ ref è¿›è¡Œèµ‹å€¼æ“ä½œè€Œä¸æ˜¯obj.d.value++ // è¿™æ ·ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå› ä¸º set proxy é‡Œé¢æœ‰æ£€æµ‹è¯¥å±æ€§æ˜¯ä¸æ˜¯ ref // å¦‚æœæ˜¯ Ref ä¼šè½¬å˜æˆå¯¹ obj.d.value++ ä¹Ÿå°±æ˜¯è¯´ vue å†…éƒ¨å¸® // æˆ‘ä»¬è¿™ä¹ˆåšäº†ï¼Œä¸‹é¢å¯¹ obj.b.c++ åŒ obj.d++; log(`obj.d++, dummy1=${dummy1}, dummy2=${dummy2}`); obj.b.c++; log(`obj.b.c++, dummy1=${dummy1}, dummy2=${dummy2}`);    1. base usage \u0026gt;\u0026gt;\u0026gt; before, a.value = 1 after, a.value = 2 2. should be reactive \u0026gt;\u0026gt;\u0026gt; ge/set value é‡Œé¢ä½¿ç”¨çš„æ˜¯ track/trigger before set a.value, dummy=2, calls=1 after set a.value, dummy=3, calls=2 3. é»˜è®¤æƒ…å†µä¸‹å¯¹åµŒå¥—å¯¹è±¡å±æ€§è¿›è¡Œ reactive \u0026gt;\u0026gt;\u0026gt; before set, dummy = ${dummy} after set, dummy = ${dummy} 4. ref() ä¸ä¼ å€¼çš„æ—¶å€™ä¹Ÿåº”è¯¥å¯ä»¥å·¥ä½œ before set, dummy = undefined after set, dummy = 100 5. ref ä½œä¸ºå¤šçº§å¯¹è±¡çš„å€¼æ—¶ before set, dummy1=1, dummy2=1 d.value++, dummy1=2, dummy2=2 obj.d++, dummy1=3, dummy2=3 obj.b.c++, dummy1=4, dummy2=4 undefined   æµ‹è¯•åˆ†æï¼š\n  åŸºæœ¬ä½¿ç”¨\n ref å®ç°åŸºäº effect çš„ track å’Œ trigger\n get value å®ç°\n1 2 3 4 5 6 7 8  class RefImpl { // ...  get value() { track(toRaw(this), TrackOpTypes.GET, \u0026#34;value\u0026#34;); return this._value; } // ... }     set value å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13  class RefImpl { set value(newVal) { if (hasChanged(toRaw(newVal), this._rawValue)) { this._rawValue = newVal; // convert() æ£€æµ‹ newVal æ˜¯å¯¹è±¡å°±è°ƒç”¨ reactive  // æ³¨æ„è¿™é‡Œåªæ˜¯ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥ ref å¯ä»¥æ¥å—ä»»æ„ç±»å‹çš„å€¼  this._value = this._shallow ? newVal : convert(newVal); // trigger è§¦å‘ value å±æ€§ä¸Šçš„ä¾èµ–è¿›è¡Œ  // å› ä¸º track ä¹Ÿæ˜¯åœ¨è¿™ä¸ªå±æ€§ä¸Šè¿›è¡Œæ”¶é›†çš„  trigger(toRaw(this), TriggerOpTypes.SET, \u0026#34;value\u0026#34;, newVal); } } }      should be reactive\n è¿™ä¸ªåœ¨ 1 åˆ—å‡ºäº† get value æºç ï¼Œç»“åˆ track/trigger è¾¾åˆ° reactive ç›®çš„ã€‚\n  è¿™ä¸€ç‚¹ç›´æ¥çœ‹æºç  set value(newVal)\n this._value = this._shallow ? newVal : convert(newVal)\n convert() é’ˆå¯¹å¯¹è±¡ reactive\n  å› ä¸º new RefImpl(rawValue, shallow) æ˜¯ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œç»™å•¥å€¼éƒ½è¡Œ\n  å› ä¸º new RefImpl(rawValue, shallow) è¿”å›çš„æ˜¯ä¸ª RefImpl å®ä¾‹å¯¹è±¡ï¼Œå±äºå¼•ç”¨ç±» å‹ï¼Œä¸ç®¡å¯¹è±¡å±‚çº§å¤šæ·±ï¼Œæœ€ç»ˆå¼•ç”¨çš„éƒ½æ˜¯è¿™ä¸ªå¯¹è±¡ã€‚\n    object ref   å¯¹å¯¹è±¡çš„æ‰€æœ‰å±æ€§è¿›è¡Œ ref åŒ–ï¼Œåœ¨è¿›è¡Œ proxy ref ä¹‹å‰éœ€è¦å…ˆå®Œæˆè¿™éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒä¾èµ– object refã€‚\n   function æè¿°     toRefs(object) refå¯¹è±¡çš„æ‰€æœ‰å±æ€§   ObjectRefImpl å¯¹è±¡ ref æ¨¡æ¿   toRef(object, key) é’ˆå¯¹ object[key] è¿›è¡Œ ref     ç›¸å…³æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  class ObjectRefImpl\u0026lt;T extends object, K extends keyof T\u0026gt; { public readonly __v_isRef = true constructor(private readonly _object: T, private readonly _key: K) {} get value() { return this._object[this._key] } set value(newVal) { this._object[this._key] = newVal } } // ref object å±æ€§çš„ export function toRef\u0026lt;T extends object, K extends keyof T\u0026gt;( object: T, key: K ): ToRef\u0026lt;T[K]\u0026gt; { return isRef(object[key]) ? object[key] : (new ObjectRefImpl(object, key) as any) } // ref object æ‰€æœ‰å±æ€§ export function toRefs\u0026lt;T extends object\u0026gt;(object: T): ToRefs\u0026lt;T\u0026gt; { if (__DEV__ \u0026amp;\u0026amp; !isProxy(object)) { console.warn(`toRefs() expects a reactive object but received a plain one.`) } const ret: any = isArray(object) ? new Array(object.length) : {} for (const key in object) { ret[key] = toRef(object, key) } return ret }     æºç åˆ†æ ï¼š ObjectRefImpl ä¸­é’ˆå¯¹æ¯ä¸ª object[key] æŒæœ‰äº†ä¸€ä»½ object å¼• ç”¨ _object, ä¸”åœ¨æœ€å¼€å§‹ new å®ä¾‹çš„æ—¶å€™å°†å±æ€§åä¿å­˜åˆ°äº† _keyï¼Œåç»­å–å€¼è®¾å€¼ç”¨çš„éƒ½ æ˜¯è¿™ä¸ªå€¼ï¼Œç„¶åé‡å†™äº† getter/setter å‡½æ•°ï¼Œåœ¨å–å€¼è®¾å€¼çš„æ—¶å€™æ“ä½œ _object + _key ã€‚\n æ‰“ä¸ªæ¯”æ–¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  // åŸå§‹å¯¹è±¡ const rawObj = { count: 0 }; // toRef(rawObj, \u0026#39;count\u0026#39;) ä¹‹å const reffed = { _key: \u0026#34;count\u0026#34;, _object: rawObj, get value() { return this._object[this._key]; }, set value(newVal) { this._object[this._key] = newVal; }, }; // ç„¶åå½“ä½ æ”¹å˜ reffed.value å€¼æ—¶å®é™…ä¸Šæ˜¯åœ¨æ”¹å˜ rawObj.count çš„å€¼ console.log(`before set, rawObj.count = ${rawObj.count}`) reffed.value = 100 console.log(`after set, rawObj.count = ${rawObj.count}`) // toRefs(rawObj) å°±æ˜¯å¯¹æ‰€æœ‰å±æ€§è¿›è¡Œ toRef()ï¼Œç„¶åå°†è¿”å›çš„å€¼ç”¨ // åŒæ ·çš„ key ç»„æˆæ–°çš„å¯¹è±¡è¿”å› // å¦‚: æ²¿ç”¨ä¸Šé¢çš„æµ‹è¯• // toRefs(rawObj) ç­‰äºæ˜¯è¿”å›äº†ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡è¿™ä¸ªå¯¹è±¡å†…å®¹ä¸ºï¼š const reffedObj = { count: reffed } // éšåæˆ‘ä»¬ç›´æ¥é€šè¿‡ä¿®æ”¹ reffedObj.count æ¥é—´æ¥æ“ä½œ rawObj å¯¹è±¡é‡Œå±æ€§çš„å€¼ console.log(\u0026#39;before set on obj, rawObj.count = \u0026#39; + rawObj.count) reffedObj.count.value = 200 console.log(\u0026#39;after set on obj, rawObj.count = \u0026#39; + rawObj.count)    before set, rawObj.count = 0 after set, rawObj.count = 100 before set on obj, rawObj.count = 100 after set on obj, rawObj.count = 200 undefined   çœ‹åˆ°æ²¡ï¼Œå®é™…éƒ½æ˜¯æ”¹å˜äº† rawObj.count\n æ‰€ä»¥, object ref ç­‰äºæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡é‡Œé¢åŒ…å«çš„å±æ€§å’Œ raw object å±æ€§åä¸€ è‡´ï¼Œä½†æ˜¯å€¼æ˜¯ ObjectRefImpl åˆ›å»ºçš„å®ä¾‹ï¼Œç”¨æ¥é—´æ¥æ“ä½œ raw object ã€‚\n  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { effect, reactive, ref, toRef, proxyRefs, toRefs }, f, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const objRef = ref({ count: 0 }) let dummy effect(() =\u0026gt; { dummy = objRef.value.count }) // proxyRefs(objRef)  log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; ref åŸºæœ¬ç”¨æ³•\u0026#39;) log(`1. dummy = ${dummy}`) objRef.value.count++ log(`2. dummy = ${dummy}`) log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; toRef ç”¨æ³•ï¼Œref å¯¹è±¡å±æ€§\u0026#39;) const a = reactive({ x: 1 }) const x = toRef(a, \u0026#39;x\u0026#39;)      ref proxy   ä½œç”¨ï¼šä»£ç† ref éå†çš„ get/set æ“ä½œï¼Œè®© get åœ¨è¿”å›ä¹‹å‰å…ˆ unref(result) å¾—åˆ°åŸå§‹ çš„å€¼è¿”å›ï¼Œè®© set åœ¨ set ä¹‹å‰ç¡®ä¿è®¾å€¼çš„å€¼æ˜¯åœ¨ ref.value ä¸Šã€‚\n å’Œ ref proxy æœ‰å…³çš„å‡½æ•°å’Œå±æ€§:\n   function æè¿°     shallowUnwrapHandlers { get, set } ä»£ç†çš„ handler   proxyRefs(objectWithRefs) ä»£ç† ref å¯¹è±¡     æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // proxy handler const shallowUnwrapHandlers: ProxyHandler\u0026lt;any\u0026gt; = { get: (target, key, receiver) =\u0026gt; unref(Reflect.get(target, key, receiver)), set: (target, key, value, receiver) =\u0026gt; { const oldValue = target[key]; if (isRef(oldValue) \u0026amp;\u0026amp; !isRef(value)) { oldValue.value = value; return true; } else { return Reflect.set(target, key, value, receiver); } }, }; export function proxyRefs\u0026lt;T extends object\u0026gt;( objectWithRefs: T ): ShallowUnwrapRef\u0026lt;T\u0026gt; { return isReactive(objectWithRefs) ? objectWithRefs : new Proxy(objectWithRefs, shallowUnwrapHandlers); }     ref proxy ä½œç”¨ï¼šé’ˆå¯¹è¢« ref çš„ object å¯¹è±¡ï¼Œè¿›è¡Œ get å’Œ set æ“ä½œä»£ç†ã€‚\n get æ“ä½œï¼Œ Reflect.get(...) æ‹¿åˆ°çš„æ˜¯ä¸ª unrefï¼Œé€šè¿‡ proxy get handler å» ref åŒ–ï¼Œ è¿”å›å…¶åŸå§‹å€¼ã€‚\n set æ“ä½œï¼Œ Reflect.set(...) æ–°å€¼æ˜¯ ref ç›´æ¥è¦†ç›–ä¹‹å‰çš„ target[key] å€¼ï¼Œå¦‚æœä¸æ˜¯ refï¼Œå°†å…¶è®¾ç½®åˆ° oldValue.value ä¸Šã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { effect, reactive, ref, toRef, proxyRefs, toRefs }, f, log } = require(process.env.BLOG_JS + \u0026#39;/vue/lib.js\u0026#39;) const objRef = ref({ count: 0 }) let dummy effect(() =\u0026gt; { dummy = objRef.value.count }) // proxyRefs(objRef)  log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; ref åŸºæœ¬ç”¨æ³•\u0026#39;) log(`1. dummy = ${dummy}`) objRef.value.count++ log(`2. dummy = ${dummy}`) log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; toRef ç”¨æ³•ï¼Œref å¯¹è±¡å±æ€§\u0026#39;) const a = reactive({ x: 1 }) const x = toRef(a, \u0026#39;x\u0026#39;)    \u0026gt;\u0026gt;\u0026gt; before proxy 1. dummy = 0 2. dummy = 1 undefined    custom ref   ç›¸å…³å‡½æ•°å’Œç±»ï¼š\n   function æè¿°     CustomRefImpl è‡ªå®šä¹‰çš„ ref æ¨¡æ¿   customRef(factory) è‡ªå®šä¹‰ refï¼Œå³ç”±å¤–éƒ¨å†³å®šå¦‚ä½•å®ç° getter \u0026amp; settter value     è®©ä½¿ç”¨è€…è‡ªå®šä¹‰ä»¥ä»€ä¹ˆæ–¹å¼åœ¨ get çš„æ—¶å€™ track æˆ– set çš„æ—¶å€™ trigger\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  export type CustomRefFactory\u0026lt;T\u0026gt; = ( track: () =\u0026gt; void, trigger: () =\u0026gt; void ) =\u0026gt; { get: () =\u0026gt; T; set: (value: T) =\u0026gt; void; }; class CustomRefImpl\u0026lt;T\u0026gt; { private readonly _get: ReturnType\u0026lt;CustomRefFactory\u0026lt;T\u0026gt;\u0026gt;[\u0026#34;get\u0026#34;]; private readonly _set: ReturnType\u0026lt;CustomRefFactory\u0026lt;T\u0026gt;\u0026gt;[\u0026#34;set\u0026#34;]; public readonly __v_isRef = true; constructor(factory: CustomRefFactory\u0026lt;T\u0026gt;) { const { get, set } = factory( () =\u0026gt; track(this, TrackOpTypes.GET, \u0026#34;value\u0026#34;), () =\u0026gt; trigger(this, TriggerOpTypes.SET, \u0026#34;value\u0026#34;) ); this._get = get; this._set = set; } get value() { return this._get(); } set value(newVal) { this._set(newVal); } }     å°±æ˜¯æˆ‘åªè´Ÿè´£ç»™ä½ æ„é€ ä¸€ä¸ª Ref ç»“æ„çš„å¯¹è±¡ï¼Œè‡³äºä»€ä¹ˆ get å’Œ set æ€ä¹ˆå®ç°å…¨æƒäº¤ç»™ä½¿ ç”¨è€…ï¼Œget/set é»˜è®¤ track/trigger value å±æ€§ã€‚\n æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  // æºæ–‡ä»¶ï¼š/js/vue/lib.js const { rc: { reactive, toRefs, customRef, effect, isRef }, f, log, } = require(process.env.BLOG_JS + \u0026#34;/vue/lib.js\u0026#34;); let value = 1; let _trigger; const custom = customRef((track, trigger) =\u0026gt; ({ get() { track(); return value; }, set(newValue) { value = newValue; _trigger = trigger; }, })); log(\u0026#39;custom is ref, \u0026#39; + isRef(custom)) let dummy effect(() =\u0026gt; { dummy = custom.value }) log(\u0026#39;dummy = \u0026#39; + dummy) custom.value = 2 // è¿™ä¸ªæ—¶å€™è¿˜ä¸ä¼šè§¦å‘ä¾èµ–æ›´æ–°ï¼Œå› ä¸º trigger å¹¶æ²¡æœ‰æ‰§è¡Œ // åªæ˜¯ç¼“å­˜åˆ°äº† _trigger ä¸Š _trigger() // æ‰‹åŠ¨è§¦å‘ effects log(\u0026#39;dummy = \u0026#39; + dummy)    custom is ref, true dummy = 1 dummy = 2 undefined    è¾…åŠ©å‡½æ•°     function desc     isRef(value) æ£€æµ‹ value.__v_isRef å€¼   triggerRef(ref) æ‰‹åŠ¨è§¦å‘ ref value ä¸Šçš„ä¾èµ–   unref(ref) è¿”å› ref.value å€¼        jest ğŸƒè·‘ğŸƒç”¨ä¾‹  é™¤äº† runtime-dom æ²¡å®ç°çš„éƒ¨åˆ†ï¼Œéƒ½é€šè¿‡äº†æµ‹è¯•ã€‚\n@vue/runtime-dom (guessing \u0026#39;runtimeDom\u0026#39;) created packages/vue/dist/vue.global.js in 1.4s FAIL packages/reactivity/__tests__/effect.spec.ts â— Test suite failed to run packages/reactivity/__tests__/ref.spec.ts:11:26 - error TS2307: Cannot find module \u0026#39;@vue/runtime-dom\u0026#39; or its corresponding type declarations. 11 import { computed } from \u0026#39;@vue/runtime-dom\u0026#39; ~~~~~~~~~~~~~~~~~~ PASS packages/reactivity/__tests__/reactive.spec.ts PASS packages/reactivity/__tests__/collections/Set.spec.ts PASS packages/reactivity/__tests__/collections/Map.spec.ts PASS packages/reactivity/__tests__/reactiveArray.spec.ts PASS packages/reactivity/__tests__/collections/WeakMap.spec.ts PASS packages/reactivity/__tests__/collections/WeakSet.spec.ts PASS packages/reactivity/__tests__/shallowReactive.spec.ts PASS packages/reactivity/__tests__/readonly.spec.ts FAIL packages/reactivity/__tests__/ref.spec.ts â— Test suite failed to run Configuration error: Could not locate module @vue/runtime-dom mapped as: /Users/simon/github/vue/stb-vue-next/packages/$1/src. Please check your configuration for these entries: { \u0026#34;moduleNameMapper\u0026#34;: { \u0026#34;/^@vue\\/(.*?)$/\u0026#34;: \u0026#34;/Users/simon/github/vue/stb-vue-next/packages/$1/src\u0026#34; }, \u0026#34;resolver\u0026#34;: undefined } 2 | ref, 3 | effect, \u0026gt; 4 | reactive, | ^ 5 | isRef, 6 | toRef, 7 | toRefs, at createNoMappedModuleFoundError (node_modules/jest-resolve/build/index.js:551:17) at Object.\u0026lt;anonymous\u0026gt; (packages/reactivity/__tests__/ref.spec.ts:4:23) PASS packages/reactivity/__tests__/computed.spec.ts Test Suites: 2 failed, 9 passed, 11 total Tests: 169 passed, 169 total Snapshots: 0 total Time: 15.568 s    ç”¨ä¾‹åˆ†æ  Map.spec.ts   instanceof\n1 2 3 4 5 6 7  test(\u0026#39;instanceof\u0026#39;, () =\u0026gt; { const original = new Map() const observed = reactive(original) expect(isReactive(observed)).toBe(true) expect(original instanceof Map).toBe(true) expect(observed instanceof Map).toBe(true) })     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const map = new Map() const ob = reactive(map) console.log(`#1 ob is reactive, ${isReactive(ob)}`) console.log(`#2 ${map instanceof Map}`) console.log(`#3 ${ob instanceof Map}`) console.log(map, ob)     +RESULTS:\n#1 ob is reactive, true #2 true #3 true Map(0) {} Map(0) {}   should observe mutations(åº”è¯¥è§‚å¯Ÿå˜åŒ–)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  it(\u0026#39;should observe mutations\u0026#39;, () =\u0026gt; { let dummy const map = reactive(new Map()) effect(() =\u0026gt; { dummy = map.get(\u0026#39;key\u0026#39;) }) expect(dummy).toBe(undefined) map.set(\u0026#39;key\u0026#39;, \u0026#39;value\u0026#39;) expect(dummy).toBe(\u0026#39;value\u0026#39;) map.set(\u0026#39;key\u0026#39;, \u0026#39;value2\u0026#39;) expect(dummy).toBe(\u0026#39;value2\u0026#39;) map.delete(\u0026#39;key\u0026#39;) expect(dummy).toBe(undefined) })     æµ‹è¯•:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) let dummy const map = reactive(new Map()) effect(() =\u0026gt; { dummy = map.get(\u0026#39;key\u0026#39;) }) console.log(`#1 dummy = ${dummy}`) map.set(\u0026#39;key\u0026#39;, \u0026#39;value\u0026#39;) console.log(`#2 dummy = ${dummy}`) map.set(\u0026#39;key\u0026#39;, \u0026#39;value2\u0026#39;) console.log(`#3 dummy = ${dummy}`) map.delete(\u0026#39;key\u0026#39;) console.log(`#4 dummy = ${dummy}`)     +RESULTS:\n#1 dummy = undefined #2 dummy = value // set è§¦å‘ trigger effect fn #3 dummy = value2 // åŒä¸Š #4 dummy = undefined // åˆ é™¤è§¦å‘ DELETE trigger ä¸è¯¥   #4 å±æ€§çš„ ADD | DELETE | SET æ“ä½œé¦–å…ˆä¼šå°†æ‰€æœ‰ä¸è¯¥ key æœ‰å…³çš„ä¾èµ–æ·»åŠ åˆ°å°†æ‰§è¡Œåºåˆ—ã€‚\n1 2 3 4  // SET | ADD | DELETE operation  if (key !== void 0) { add(depsMap.get(key)) }     should observe mutations with observed value as key\n å°† reactive ç±»å‹çš„å€¼ä½œä¸º key çš„æ—¶å€™ä¹Ÿåº”è¯¥èƒ½è¢«è§‚å¯Ÿå˜åŒ–ã€‚\n    computed.spec.ts   ä¸‹é¢æ‰€æœ‰çš„ç”¨ä¾‹éƒ½å¯ä»¥å‚è€ƒ ç”¨ä¾‹ 01 çš„è„‘å›¾(åŸç†å›¾)\nshould return updated value  1 2 3 4 5 6 7  it(\u0026#39;should return updated value\u0026#39;, () =\u0026gt; { const value = reactive\u0026lt;{ foo?: number }\u0026gt;({}) const cValue = computed(() =\u0026gt; value.foo) expect(cValue.value).toBe(undefined) value.foo = 1 expect(cValue.value).toBe(1) })     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { isReactive, effect, reactive, targetMap, shallowReactive, computed } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const value = reactive({}) const cValue = computed(() =\u0026gt; value.foo) console.log(`#1 before set value.foo, cValue.value = ${cValue.value}`) value.foo = 1 console.log(`#2 after set value.foo, cValue.value = ${cValue.value}`)     +RESULTS:\n#1 before set value.foo, cValue.value = undefined #2 after set value.foo, cValue.value = 1   åˆ†æç»“æœ\n #1 : å› ä¸º computed é»˜è®¤æ˜¯ effect lazy çš„ï¼Œæ‰€ä»¥ä¸ä¼šç«‹å³æ‰§è¡Œ effectï¼Œæ‰€ä»¥ cValue ä¹Ÿå°±ä¸ä¼šæœ‰å€¼\n #2 : æ­¤æ—¶å€¼ä¸º 1ï¼Œå¹¶ä¸æ˜¯å› ä¸º value.foo = 1 è§¦å‘çš„ effect æ‰§è¡Œï¼Œ\n è€Œæ˜¯å› ä¸º _dirty é»˜è®¤æ˜¯ true çš„ï¼Œæ‰€ä»¥åœ¨ #1 å¤„å–å€¼çš„æ—¶å€™è§¦å‘äº† effect() æ‰§è¡Œï¼Œ _dirty = false äº†ï¼Œå€¼ç»“æœå·²å‡ºã€‚\n1 2 3 4 5 6 7 8  get value() { if (this._dirty) { this._value = this.effect() this._dirty = false } track(toRaw(this), TrackOpTypes.GET, \u0026#39;value\u0026#39;) return this._value }     ä¹Ÿæ­£æ˜¯ç”±äº effect çš„æ‰§è¡Œï¼Œè®© value.foo æ”¶é›†åˆ°äº†è¿™ä¸ªä¾èµ–ã€‚\n éšåè®¾ç½® value.foo ä¹Ÿä¼šå°† computed effect æ‰§è¡Œï¼Œç”±äº options ä¸­æä¾›äº† schedulerï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œç½® _dirty = true ï¼Œä½†æ˜¯æ­¤æ—¶è®¡ç®—å±æ€§å€¼å¹¶ä¸ä¼šç«‹å³è®¡ç®—å¾—å‡º ç»“æœ(å› ä¸ºå®ƒçš„è®¡ç®—æ“ä½œå§‹ç»ˆæ˜¯åœ¨ get value() é‡Œé¢å‘ç”Ÿçš„)ï¼Œæ‰€æœ‰å½“ä¸‹æ¬¡å–å€¼æ“ä½œ(å³ #2 è¡Œæ‰§è¡Œæ—¶)ï¼Œæ£€æµ‹åˆ° _dirty = true äº†æ‰ä¼šé‡æ–°è®¡ç®—è¿”å›æœ€æ–°ç»“æœã€‚\n ç”¨ä¾‹è„‘å›¾ï¼š\n   should compute lazily  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  it(\u0026#39;should compute lazily\u0026#39;, () =\u0026gt; { const value = reactive\u0026lt;{ foo?: number }\u0026gt;({}) const getter = jest.fn(() =\u0026gt; value.foo) const cValue = computed(getter) // lazy  expect(getter).not.toHaveBeenCalled() expect(cValue.value).toBe(undefined) expect(getter).toHaveBeenCalledTimes(1) // should not compute again  cValue.value expect(getter).toHaveBeenCalledTimes(1) // should not compute until needed  value.foo = 1 expect(getter).toHaveBeenCalledTimes(1) // now it should compute  expect(cValue.value).toBe(1) expect(getter).toHaveBeenCalledTimes(2) // should not compute again  cValue.value expect(getter).toHaveBeenCalledTimes(2) })     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  const { isReactive, effect, reactive, targetMap, shallowReactive, computed } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const value = reactive({}) let n = 0 const getter = () =\u0026gt; { ++n return value.foo } const cValue = computed(getter) // lazy console.log(`#1 before get value, getter called ${n}times.`) console.log(`#2 get value(), cValue.value = ${cValue.value}`) console.log(`#3 after get value, getter called ${n}times`) // ä¸è¯¥é‡å¤è®¡ç®—ï¼Œå› ä¸º _dirty åœ¨ #3 ä¹‹åå€¼ä¸º false cValue.value console.log(`#4 after get value 2, getter called ${n}times`) // è§¦å‘ cValue çš„ effect æ‰§è¡Œ schedulerï¼Œä½¿å¾— _dirty = true value.foo = 1 // trigger effect // å› ä¸ºä¸Šé¢èµ‹å€¼æ“ä½œåªæ˜¯è®© _dirty = true äº†ï¼Œå¹¶æ²¡æœ‰ç«‹å³é‡æ–°è®¡ç®— // å› ä¸ºè®¡ç®—å±æ€§çš„ç»“æœæ€»æ˜¯åœ¨ get value() æ“ä½œä¸­å®Œæˆçš„ console.log(`#5 after set \u0026#39;value.foo = 1\u0026#39;, getter called ${n}times`) // è¿™é‡Œè¿›è¡Œå–å€¼æ“ä½œï¼Œæ­£å¼å‘èµ·é‡æ–°è®¡ç®— console.log(`#6 should re-compute value, getter called ${n}times, cValue.value = ${cValue.value}`) // #6 é‡æ–°è®¡ç®—å _dirty åˆå˜æˆäº† falseï¼Œæ‰€ä»¥ç°åœ¨å–å€¼ä¸ä¼šå†é‡æ–°è®¡ç®— cValue.value console.log(`#7 should not re-compute value, getter called ${n}times, cValue.value = ${cValue.value}`)     +RESULTS: åˆ†æå¦‚ä»£ç æ³¨é‡Š\n#1 before get value, getter called 0 times. #2 get value(), cValue.value = undefined #3 after get value, getter called 1 times #4 after get value 2, getter called 1 times #5 after set \u0026#39;value.foo = 1\u0026#39;, getter called 1 times #6 should re-compute value, getter called 1 times, cValue.value = 1 #7 should not re-compute value, getter called 2 times, cValue.value = 1   Tips: æ€»æ˜¯è®°ç€è®¡ç®—å±æ€§é‡æ–°è®¡ç®—çš„å…³é”®ç‚¹ï¼šâ€œ_dirty = true ä¸”éšåçš„å–å€¼æ“ä½œâ€ã€‚\n   should no longer update when stopped  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  it(\u0026#39;should no longer update when stopped\u0026#39;, () =\u0026gt; { const value = reactive\u0026lt;{ foo?: number }\u0026gt;({}) const cValue = computed(() =\u0026gt; value.foo) let dummy effect(() =\u0026gt; { dummy = cValue.value }) expect(dummy).toBe(undefined) value.foo = 1 expect(dummy).toBe(1) stop(cValue.effect) value.foo = 2 expect(dummy).toBe(1) })     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  const { isReactive, effect, reactive, targetMap, shallowReactive, computed, stop } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const value = reactive({}) const cValue = computed(() =\u0026gt; value.foo) let dummy effect(() =\u0026gt; { dummy = cValue.value }) console.log(`before set value, dummy = ${dummy}`) value.foo = 1 console.log(`after set value, dummy = ${dummy}`) // åœæ­¢äº† effect.active = falseï¼Œåœ¨æ‰§è¡Œ effect fn çš„æ—¶å€™ // ä¼šæ£€æµ‹ active å¦‚æœæ˜¯ false ä¼šç›´æ¥æ‰§è¡Œï¼š // options.scheduler ? undefined : fn() // è€Œç”±äºè®¡ç®—å±æ€§æ˜¯é»˜è®¤æä¾›äº† scheduler çš„ï¼Œæ‰€ä»¥åœ¨ stop ä¹‹å // effect å°±ä¸ä¼šè¢«æ‰§è¡Œ stop(cValue.effect) value.foo = 2 console.log(`after stop and set value, dummy = ${dummy}`)     +RESULTS:\nbefore set value, dummy = undefined after set value, dummy = 1 after stop and set value, dummy = 1    TODO should support setter  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  it(\u0026#39;should support setter\u0026#39;, () =\u0026gt; { const n = ref(1) const plusOne = computed({ get: () =\u0026gt; n.value + 1, set: val =\u0026gt; { n.value = val - 1 } }) expect(plusOne.value).toBe(2) n.value++ expect(plusOne.value).toBe(3) plusOne.value = 0 expect(n.value).toBe(-1) })      should be readonly   åªè¯»ç‰ˆæœ¬ï¼Œæ˜¯æœ‰ computed ä½¿ç”¨çš„æ—¶å€™ä¼ å…¥çš„å‚æ•°(option)å†³å®šçš„ã€‚\n  å¦‚æœ option æ˜¯å‡½æ•°(getter) é‚£å°±æ˜¯åªè¯»çš„\n  å¦‚æœ option æ˜¯å¯¹è±¡ä¸”æä¾›äº† option.set é‚£ä¹ˆæ˜¯éåªè¯»\n  å¦‚æœ option æ˜¯å¯¹è±¡ä½†æ˜¯æ²¡æœ‰æä¾› option.set é‚£ä¹ˆä¹Ÿæ˜¯åªè¯»çš„\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  it(\u0026#39;should be readonly\u0026#39;, () =\u0026gt; { let a = { a: 1 } const x = computed(() =\u0026gt; a) expect(isReadonly(x)).toBe(true) expect(isReadonly(x.value)).toBe(false) expect(isReadonly(x.value.a)).toBe(false) const z = computed\u0026lt;typeof a\u0026gt;({ get() { return a }, set(v) { a = v } }) expect(isReadonly(z)).toBe(false) expect(isReadonly(z.value.a)).toBe(false) })     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  const { isReactive, isReadonly, effect, reactive, targetMap, shallowReactive, computed } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) const a = { a: 1 } const x = computed(() =\u0026gt; a) console.log(`#1 x is readonly, ${isReadonly(x)}`) // true console.log(`#2 x.value is readonly, ${isReadonly(x.value)}`) console.log(`#3 x.value.a is readonly, ${isReadonly(x.value.a)}`) const z = computed({ get() { return a }, set(v) { a = v } }) console.log(`#4 z is readonly, ${isReadonly(z)}`) console.log(`#5 z.value.a is readonly, ${isReadonly(z.value.a)}`)     +RESULTS:\n#1 x is readonly, true #2 x.value is readonly, false #3 x.value.a is readonly, false #4 z is readonly, false #5 z.value.a is readonly, false      effect.ts  effect + track + trigger   commit: feat: effect-trigger Â· gcclll/stb-vue-next@b5f97b4\n  lazy: true æ ‡è¯† effect fn ä¸ä¼šç«‹å³æ‰§è¡Œ\n  ç‚¹å‡» set æ“ä½œï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰ä¾èµ–ï¼Œæ‰€ä»¥åªä¼šè§¦å‘ count++\n  å½“ç‚¹å‡» get æ“ä½œï¼Œè§¦å‘ track() æ”¶é›†ä¾èµ– fn -\u0026gt; deps\n  å†ç‚¹å‡» set æ“ä½œï¼Œæ­¤æ—¶å·²ç»æœ‰ä¾èµ–ï¼Œæ‰€ä»¥ä¼š trigger() æ‰€æœ‰ä¾èµ–æ›´æ–°\n  options.scheduler é€‰é¡¹ä½œç”¨\n å¦‚æœ options æœ‰ scheduler é€‰é¡¹ï¼Œ trigger() çš„æ—¶å€™ä¸ä¼šç«‹å³æ‰§è¡Œ effects è€Œæ˜¯ è°ƒç”¨ scheduler å¹¶å°†å½“å‰éœ€è¦è¢«æ‰§è¡Œçš„ effect å½“åšå‚æ•°ç»™ schedulerï¼Œç”±ä½¿ç”¨è€…å†³å®š ä½•æ—¶å»æ‰§è¡Œ effectï¼Œæ¯”å¦‚éœ€è¦åœ¨ dummy æ›´æ–°ä¹‹å‰åšç‚¹ä»€ä¹ˆã€‚\n   #_effect_test_02.box { display: flex; justify-content: space-around; } #_effect_test_02.boxbutton{ border: none; width: 250px; }  ç‚¹æˆ‘è§¦å‘ getæ“ä½œï¼ ç‚¹æˆ‘è§¦å‘ setæ“ä½œï¼  æ‰‹åŠ¨è°ƒç”¨ scheduler ä¹‹å‰ æ‰‹åŠ¨è°ƒç”¨ scheduler ä¹‹å  ç‚¹å‡»æŸ¥çœ‹æµ‹è¯•æºç  é‡ç½®     setTimeout(function test() { if (typeof $ === 'undefined') return var ins = VueReactivity var effect = ins.effect var reactive = ins.reactive var target = { count: 0 } var counter = reactive(target) var $el = $(\"#_effect_test_02\") var LOG = function (msg) { _log($el, msg) } var lazyEffect = effect( function fn() { var c = counter.count LOG('æ­£åœ¨æ‰§è¡Œ effect fn..., counter.count = ' + counter.count) }, { lazy: true } ) var effected = false var getDeps = function () { if (!ins.targetMap) return new Set() const depsMap = ins.targetMap.get(target) || new Map() return depsMap.get('count') || new Set() } $el.find(\".setval\").click(function() { counter.count++ var size = getDeps().size if (size === 0) { LOG('target æ­¤æ—¶æ— ä»»ä½•ä¾èµ–ï¼Œdeps.size = ' + size + ', counter.count = ' + counter.count) } }) $el.find(\".reset\").click(function() { ins.cleanup(lazyEffect) $el.children(\".result\").html('') effected = false counter.count = 0 dummy = 0 runner = undefined times = 0 LOG('target.count deps.size = ' + getDeps().size) }) $el.find(\".getval\").click(function() { if (!effected) { effected = true lazyEffect() // æ‰‹åŠ¨æ‰§è¡Œ effect LOG('æ‰‹åŠ¨æ‰§è¡Œ effect()ï¼Œå¼€å§‹æ”¶é›†ä¾èµ– fn - deps, size: ' + getDeps().size) } LOG('å–å€¼æ“ä½œ(target.count çš„ deps æ•°)ï¼š' + ins.targetMap.get(target).get('count').size + ', counter.count = ' + counter.count) }) $el.find('.code').click(function() { console.log($(\"#GW0MDx\").html()) LOG('æºç å·²è¾“å‡ºåˆ°æ§åˆ¶å°(F12-console)....') }) var dummy = 0, runner var counter1 = reactive({ count: 0 }) var times = 0 var schedulerEffect = effect(function fn() { dummy = counter1.count }, { scheduler: function(_effect) { LOG('scheduler æ‰§è¡Œæ¬¡æ•° ' + ++times + ', dummy = ' + dummy) runner = function() { _effect() } } }) LOG('scheduler effect fn ç¬¬ä¸€æ¬¡ä¼šè¢«æ‰§è¡Œï¼Œ dummy = ' + dummy) $el.find('.before-scheduler').click(function() { LOG('scheduler ä¸ä¼šè¢«æ‰§è¡Œ, dummy = ' + dummy) }) $el.find('.after-scheduler').click(function() { counter1.count++ runner() }) }, 1000)        effect æµ‹è¯•  æµ‹è¯•1(base, prototype)   æµ‹è¯•å†…å®¹ï¼š\n  effect åŸºæœ¬ä½¿ç”¨\n  effect ä½œç”¨åŸŸåŸå‹é“¾\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  // åªæ‰§è¡Œä¸€æ¬¡ effect fn const { isReactive, effect, reactive, targetMap, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) // åŸºæœ¬çš„æµ‹è¯•ç”¨ä¾‹å°±ä¸åˆ—å‡ºæ¥äº†ï¼Œè¿™é‡Œåªåˆ—å‡ºæœ‰ç–‘é—®çš„ // 1. effect fn åªæ‰§è¡Œä¸€æ¬¡ // 2. observe åŸºæœ¬å±æ€§ // 3. observe å¤šä¸ªå±æ€§(n1,n2...) -\u0026gt; effect(() =\u0026gt; (dummy = obj.n1 + obj.n2)) // 4. åŒä¸€ä¸ªå±æ€§å¤šä¸ª effectï¼Œä¼šå°†è¿™å¤šä¸ª effects æ”¶é›†åˆ° prop çš„ deps ä¸­ // 5. observe å±æ€§åˆ é™¤ let dummy, dummy1, dummy2 const ob = reactive({ foo: { bar: 0 } }) effect(() =\u0026gt; (dummy = ob.foo.bar)) // effect -\u0026gt; ob, ob.foo, ob.foo.bar deps effect(() =\u0026gt; (dummy1 = ob.foo.bar)) console.log(`before set, dummy = ${dummy}, dummy1 = ${dummy1}`) ob.foo.bar = 8 console.log(`after set, dummy = ${dummy}, dummy1 = ${dummy1}`) delete ob.foo.bar console.log(`after delete, dummy = ${dummy}, dummy1 = ${dummy1}`) console.log(`\u0026gt;\u0026gt;\u0026gt; åŸå‹é“¾`) const obj1 = { num: 0 }, obj2 = { num: 2 } const counter = reactive(obj1) const parentCounter = reactive(obj2) // å–å€¼åŸç†ï¼š å…ˆè‡ªèº«å†å¾€ä¸Šæ‰¾åŸå‹é“¾ï¼Œæ‰€æœ‰åªè¦ Object.setPrototypeOf(counter, parentCounter) effect(() =\u0026gt; (dummy = counter.num)) console.log(`dummy = ${dummy}`) console.log(`\u0026gt; #1 obj1.num çš„ä¾èµ–`) console.log(targetMap.get(obj1).get(\u0026#39;num\u0026#39;)) console.log(`\u0026gt; #2 obj2.num çš„ä¾èµ–, delete ä¹‹å‰`) console.log(targetMap.get(obj2)) delete counter.num // è¿™é‡Œåˆ é™¤äº†å±æ€§ï¼Œè§¦å‘ effect fn é‡Œé¢å–å€¼æ“ä½œå‘ç°æ²¡æœ‰å±æ€§äº† // å¾€åŸå‹é“¾æ‰¾ï¼Œæ‰¾åˆ° parentCounter.num ï¼Œæ­¤æ—¶ parentCounter.num æ”¶é›† effect fn è¿›è‡ªå·±çš„ deps // æ‰€ä»¥åé¢çš„ parentCounter.num ä¸Šçš„æ“ä½œåŒæ ·ä¼šè§¦å‘ effect fn console.log(`after delete, dummy = ${dummy}`) console.log(`\u0026gt; #3 obj2.num çš„ä¾èµ–, delete ä¹‹å`) console.log(targetMap.get(obj2).get(\u0026#39;num\u0026#39;)) parentCounter.num = 4 console.log(`#4 after \u0026#39;parentCounter.num = 4\u0026#39;, dummy = ${dummy}`) counter.num = 3 console.log(`#5 after counter.num = 3\u0026#39;, dummy = ${dummy}`)     ç»“æœåˆ†æï¼š\n  #1 obj1.num ä¾èµ–æ˜¯åœ¨ effect ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™æ”¶é›†çš„\n  #2 obj2.num åœ¨æ‰§è¡Œ delete counter.num ä¹‹å‰æ˜¯æ²¡æœ‰ä»»ä½•ä¾èµ–\n å› ä¸ºæ­¤æ—¶å¹¶æ²¡æœ‰ä»»ä½• parentCounter ä¸Šçš„æ“ä½œ\n  #3 obj2.num æœ‰äº†è‡ªå·±çš„ä¾èµ–\n æ­¤æ—¶ï¼Œæ‰§è¡Œäº† delete counter.num é€»è¾‘å¦‚ä¸‹ï¼š\n å¯¹ counter.num æ‰§è¡Œåˆ é™¤ä¼šè§¦å‘ num ä¸Šçš„æ‰€æœ‰ä¾èµ– depsï¼Œå³æ‰§è¡Œ effect fnï¼Œ\n åœ¨ effect fn é‡Œé¢æœ‰ counter.num çš„å–å€¼æ“ä½œï¼Œä½†æ˜¯å‘ç°å±æ€§è¢«åˆ é™¤ï¼Œæ ¹æ®å–å€¼æŸ¥æ‰¾ åŸç†ï¼Œä¼šåœ¨å¯¹è±¡çš„åŸå‹é“¾ä¸Šé€çº§å¾€ä¸ŠæŸ¥æ‰¾(parentCounter)ï¼Œæ‰¾åˆ° parentCounter.num éšæœºè¿›è¡Œå–å€¼æ“ä½œï¼Œæ‰€ä»¥åˆ é™¤æ“ä½œä¹‹åçš„ dummy = 2 ï¼Œä¸”å–å€¼ æ“ä½œè§¦å‘ tracking å› æ­¤æ­¤æ—¶ parentCounter.num å°±æœ‰äº†è‡ªå·±çš„ä¾èµ– effect fnã€‚\n  #4 ç»™ parentCounter è®¾å€¼è§¦å‘ effect fnï¼ŒæŸ¥æ‰¾åŸå‹é“¾ , æ‰€ä»¥ dummy = 4\n  #5 ç»™ counter è®¾å€¼è§¦å‘ effect fnï¼Œä¸æŸ¥æ‰¾åŸå‹é“¾(è‡ªèº«å±æ€§)ï¼Œæ‰€ä»¥ dummy = 3\n  +RESULTS:\nbefore set, dummy = 0, dummy1 = 0 after set, dummy = 8, dummy1 = 8 after delete, dummy = undefined, dummy1 = undefined \u0026gt;\u0026gt;\u0026gt; åŸå‹é“¾ dummy = 0 \u0026gt; #1 obj1.num çš„ä¾èµ– \u0026lt;ref *1\u0026gt; Set(1) { [Function: reactiveEffect] { id: 2, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [ [Circular *1] ], options: {} } } \u0026gt; #2 obj2.num çš„ä¾èµ–, delete ä¹‹å‰ undefined after delete, dummy = 2 \u0026gt; #3 obj2.num çš„ä¾èµ–, delete ä¹‹å \u0026lt;ref *1\u0026gt; Set(1) { [Function: reactiveEffect] { id: 2, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [ [Circular *1], [Set] ], options: {} } } #4 after \u0026#39;parentCounter.num = 4\u0026#39;, dummy = 4 #5 after counter.num = 3\u0026#39;, dummy = 3 undefined    æµ‹è¯•2(stop, â€¦)    stop :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  const { isReactive, effect, reactive, targetMap, shallowReactive, stop } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) console.log(`\u0026gt;\u0026gt;\u0026gt; stop effect`) let dummy const obj = reactive({ prop: 1 }) const runner = effect(() =\u0026gt; { dummy = obj.prop }) obj.prop = 2 console.log(`#1, after \u0026#39;obj.prop = 2\u0026#39;, dummy = ${dummy}`) console.log(`\u0026gt; prop deps, before stop`) console.log(targetMap.get(obj.__v_raw).get(\u0026#39;prop\u0026#39;)) // æ¸…ç©ºäº†æ‰€æœ‰ä¾èµ–  stop(runner) // stop the effect, set effect.active = false  console.log(`\u0026gt; prop deps, after stop`) console.log(targetMap.get(obj.__v_raw).get(\u0026#39;prop\u0026#39;)) obj.prop = 3 console.log(`#2, after stop, \u0026#39;obj.prop = 3\u0026#39;, dummy = ${dummy}`) obj.prop = 4 console.log(`#3, after stop, \u0026#39;obj.prop = 4\u0026#39;, dummy = ${dummy}`) runner() console.log(`#4, after run runner, dummy = ${dummy}, runner.active = ${runner.active}`)     +RESULTS:\n\u0026gt;\u0026gt;\u0026gt; stop effect #1, after \u0026#39;obj.prop = 2\u0026#39;, dummy = 2 \u0026gt; prop deps, before stop \u0026lt;ref *1\u0026gt; Set(1) { [Function: reactiveEffect] { id: 0, allowRecurse: false, _isEffect: true, active: true, raw: [Function (anonymous)], deps: [ [Circular *1] ], options: {} } } \u0026gt; prop deps, after stop Set(0) {} #2, after stop, \u0026#39;obj.prop = 3\u0026#39;, dummy = 2 #3, after stop, \u0026#39;obj.prop = 4\u0026#39;, dummy = 2 #4, after run runner, dummy = 4, runner.active = false undefined    stop å¹²äº†ä¸¤ä»¶äº‹(a. æ¸…ç©ºæ‰€æœ‰ effect.deps, b. å°† effect.active ç½®ä¸º false)\n  stop ä¹‹å trigger æ—¶æ²¡æœ‰ deps å¯æ‰§è¡Œï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½• effect fn ä¸ä¼šè¢«æ‰§è¡Œ\n  æ‰‹åŠ¨æ‰§è¡Œ runner() ä¹‹åæ‰§è¡Œeffect fn é‡æ–°æ”¶é›†ä¾èµ–(æ­¤æ—¶ active ä¾æ—§ä¸º false)\n    stop + scheduler :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const { isReactive, effect, reactive, targetMap, stop, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) let dummy const obj = reactive({ prop : 1 }) const queue = [] const runner = effect(() =\u0026gt; (dummy = obj.prop), { scheduler: e =\u0026gt; queue.push(e) }) obj.prop = 2 console.log(`#1 after \u0026#39;obj.prop = 2\u0026#39;, dummy = ${dummy}`) console.log(`#2 after \u0026#39;obj.prop = 2\u0026#39;, queue.length = ${queue.length}`) stop(runner) queue.forEach(e =\u0026gt; e()) console.log(`#3 after stop, queue forEach, dummy = ${dummy}`)     +RESULTS:\n#1 after \u0026#39;obj.prop = 2\u0026#39;, dummy = 1 #2 after \u0026#39;obj.prop = 2\u0026#39;, queue.length = 1 #3 after stop, queue forEach, dummy = 1   æä¾›äº† scheduler é€‰é¡¹çš„ effect æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œæºç ï¼š\n1 2 3  if (!effect.active) { return options.scheduler ? undefined : fn() }      onStop :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const { isReactive, effect, reactive, targetMap, stop, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) let n = 0 const runner = effect(() =\u0026gt; {}, { onStop() { console.log(`stopped ${++n}times`) } }) stop(runner) stop(runner) stop(runner)     +RESULTS:\nstopped 1 times   åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸º effect.active = true æ—¶æ‰å¯ä»¥è¢« stop ã€‚\n  stop: ä¸€ä¸ª stopped çš„ effect åœ¨ä¸€ä¸ªæ­£å¸¸çš„ effect ä¸­è°ƒç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  const { isReactive, effect, reactive, targetMap, stop, shallowReactive } = require(process.env.PWD + \u0026#39;/../../static/js/vue/reactivity.global.js\u0026#39;) let dummy const obj = reactive({ prop: 1 }) const runner = effect(() =\u0026gt; { dummy = obj.prop }) stop(runner) obj.prop = 2 console.log(`#1 after stop runner, dummy = ${dummy}`) // è¿™é‡Œç­‰äºæ˜¯æ‰‹åŠ¨æ‰§è¡Œäº† runner effect `dummy = obj.prop` // æ‰€ä»¥ä¸‹é¢çš„ effect è¢« obj.prop æ”¶é›†è¿› deps\u0026lt;Set\u0026gt; effect(() =\u0026gt; { runner() }) obj.prop = 3 console.log(`#2 after runner in effect, dummy = ${dummy}`)     +RESULTS:\n#1 after stop runner, dummy = 1 #2 after runner in effect, dummy = 3    #1 å€¼ä¾æ—§æ˜¯ 1 ï¼Œæ˜¯å› ä¸º stop äº†\n  #2 å€¼ä¸º 3ï¼Œæ˜¯å› ä¸º effect æ‰§è¡Œ runner() ä½¿å¾— obj.prop æ”¶é›†åˆ°ç¬¬äºŒä¸ª effect fn ã€‚\n        å®Œæ•´è„‘å›¾   collection proxy handlers è„‘å›¾     effect è„‘å›¾       ","permalink":"https://www.cheng92.com/vue/vue-mind-map-reactivity/","tags":["vue,","vue3,","compiler-core,","parser,","compiler"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹ 1 â˜reactivity"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n ğŸŒ§ åº  â­ â­ ç”±äºå›¾ç‰‡æ˜¯ä½¿ç”¨ github åšçš„å›¾åºŠï¼Œæ²¡æœ‰ CDN åŠ é€Ÿï¼Œä¸”æœ‰äº›å›¾ç‰‡æ¯”è¾ƒå¤§(å¯èƒ½\n â­ â­ å¿« 1M) åŠ è½½æŒºæ…¢çš„ï¼Œæ¯å¼ å›¾ç‰‡éƒ½æœ‰å¯¹åº”çš„ä¸ƒç‰›(ä½†ä¸ä¸€å®šæ˜¯æœ€æ–°çš„)é“¾æ¥ï¼Œå¯èƒ½ä¼šå¿«ä¸€ç‚¹ã€‚\n â­ â­ å›¾ç‰‡å·²å…¨éƒ¨æ›´æ–°åˆ° https://www.cheng92.com/img/... ä¸‹\n ğŸ˜„ æ›´æ–°æ—¥å¿—\n  \u0026lt;2020-09-07 Mon\u0026gt; æ‰€æœ‰å›¾ç‰‡ä¿®æ”¹ä¸º github åœ°å€ï¼Œåç»­ä¿®æ”¹å›¾ç‰‡å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸ éœ€è¦ä¸Šä¼ åˆ°ä¸ƒç‰›ã€‚\n  \u0026lt;2020-09-10 Thu\u0026gt; å›¾åºŠåˆ‡æ¢åˆ° ç äº‘ gitee è‡ªåŠ¨åŒæ­¥è‡ª githubã€‚\n  \u0026lt;2020-09-11 Fri\u0026gt; æ›´æ–°å›¾ç‰‡åˆ°åšå®¢ç›®å½• /static/imgs/... ï¼Œæ–‡å†…è®¿é—®è·¯å¾„ï¼š /img/vue3/... ï¼Œå•ç‹¬è®¿é—®åŠ ä¸ŠåŸŸåå°±è¡Œï¼š https://www.cheng92.com/img/vue3/...\n  \u0026lt;2020-09-28 Mon\u0026gt; æ‰€æœ‰è„‘å›¾ä¿®æ”¹ä¸º svg æ ¼å¼ï¼Œå»ºè®®é€šè¿‡æ–° tab æ‰“å¼€ï¼Œæœ‰äº›èŠ‚ç‚¹å¯èƒ½åŒ…å«é“¾ æ¥ã€‚\n    ğŸŒ© åŠŸèƒ½ç‰¹æ€§åˆ†æ(parser-\u0026gt;transform-\u0026gt;codegen)   ä» compiler-01 å¼€å§‹éƒ½æ˜¯é’ˆå¯¹æŸä¸ªç¤ºä¾‹åšçš„åˆ†æï¼Œä½†æ˜¯éšæ—¶ç¤ºä¾‹çš„æ¨¡æ¿å¤æ‚åº¦å¢åŠ ï¼Œè„‘å›¾ çš„å¤§å°å°†è¶Šæ¥è¶Šå¤§ï¼Œä¸å ªé‡è´Ÿï¼Œé˜…è¯»å›é¡¾èµ·æ¥ä¹Ÿå¾ˆè´¹åŠ²ï¼Œåœ¨å®Œæˆäº† compiler-01 - compiler-05 ä¹‹åå¯¹æ•´ä¸ªåˆ†æè¿‡ç¨‹ä¹Ÿæœ‰äº†å¤§æ¦‚çš„äº†è§£ï¼Œå¦èµ·è¿™ä¸€ç« èŠ‚çš„ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½å•çº¯ çš„é’ˆå¯¹æŸä¸€ç‰¹å®šåŠŸèƒ½ç»˜åˆ¶å¯¹åº”çš„æµç¨‹å›¾ï¼Œæ¯”å¦‚ï¼š\n å±æ€§æ˜¯å¦‚ä½•è§£æçš„ï¼Œæœ€ååœ¨ render å‡½æ•°ä¸­åˆæ˜¯ä»€ä¹ˆï¼Ÿ\n æ’å€¼ï¼Ÿ v-if, v-else, v-for, v-once ç­‰æŒ‡ä»¤åˆæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ\n è¿™ä¸€ç« èŠ‚çš„æ‰€æœ‰è„‘å›¾ï¼Œç»˜åˆ¶åˆ†ä¸ºä»¥ä¸‹é˜¶æ®µï¼Œå¦‚æœæµç¨‹ç®€å•å¤šä¸ªé˜¶æ®µå¯èƒ½ä¼šåœ¨åŒä¸€å¼ è„‘å›¾ä¸Š\n  parser é˜¶æ®µå¾—åˆ°å®Œæ•´çš„ ast\n  compiler é˜¶æ®µè§£æ ast ç”ŸæˆèŠ‚ç‚¹ codegenNode\n  generate é˜¶æ®µåˆ©ç”¨ codegenNode ç»„è£…æˆ render å‡½æ•°\n  å¾…ç»­â€¦â€¦\n    ç« èŠ‚é¢„è§ˆï¼š\n   åŠŸèƒ½ ç®€è¿°     div \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;   attributes,é™æ€å±æ€§ \u0026lt;div id=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;   v-bind \u0026lt;div :class=\u0026#34;bar.baz\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;   interpolation \u0026lt;div\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;   v-if \u0026lt;div\u0026gt;\u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;   v-once \u0026lt;div\u0026gt;\u0026lt;p v-once\u0026gt;test v-once\u0026lt;/p\u0026gt;\u0026lt;/div\u0026gt;    DONE 01 div, çº¯æ ‡ç­¾   \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\n ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;)) } } })       parser é˜¶æ®µï¼Œ parseElement -\u0026gt; parseTag\n   compiler é˜¶æ®µï¼Œ transform -\u0026gt; traverseNode -\u0026gt; traverseChildren ï¼Œåªæœ‰ 0,ROOT å’Œ 1,ELEMENT ä¸¤ä¸ªç±»å‹åˆ†æ”¯å¤„ç†ã€‚\n   codegen é˜¶æ®µï¼Œåªæœ‰ div çš„ block å¤„ç†(_openBlock(), _createBlock(\u0026#34;div\u0026#34;))\n     DONE 02 attributes, é™æ€å±æ€§   \u0026lt;div id=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\n  parser é˜¶æ®µ ï¼š\n ä¸ pcg-01 ç›¸æ¯”è¾ƒï¼Œå¤šäº†å·¦è¾¹ parseTag -\u0026gt; parseAttributes -\u0026gt; parseAttribute è§£æå± æ€§ id=\u0026#34;foo\u0026#34; çš„å¤„ç†ã€‚\n   compiler é˜¶æ®µï¼š\n ä¸ pcg-01 ç›¸æ¯”è¾ƒï¼Œå¤šäº† transformElement ä¸­ props å±æ€§çš„å¤„ç†ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ props.length = 1 é‡Œé¢æœ‰ä¸€ä¸ª id=\u0026#34;foo\u0026#34; å±æ€§ï¼Œéœ€è¦å»è°ƒç”¨ buildProps è§£æï¼Œæˆä¸‹é¢ çš„è§£æ„:\n1 2 3 4 5 6 7 8 9 10  { properties: [ { key: { type:4, content: \u0026#34;id\u0026#34;, ...}, // SIMPLE_EXPRESSION  value: {type: 4, content: \u0026#34;foo\u0026#34;, ...}, type: 16 // JS_PROPERTY  } ] type: 15, // JS_OBJECT_EXPRESSION  }       codegen é˜¶æ®µï¼š\n åœ¨ genNodeList([tag, props, children, â€¦], ctx) è§£æçš„æ—¶å€™ï¼Œè¿™é‡Œ props ä¸å†æ˜¯ nullï¼Œå› æ­¤ä¼šè¿›å…¥ Props è§£æè¿‡ç¨‹ï¼š\n genNode(props, ctx) -\u0026gt; 15,JS_OBJECT_EXPRESSION -\u0026gt; genObjectExpression(node, ctx) -\u0026gt; éå† node.properties -\u0026gt; genExpressionPropertyKey(key,ctx) ç”Ÿæˆå±æ€§ å { id: ~ -\u0026gt; ~genNode(value, ctx) ç”Ÿæˆå±æ€§å€¼ -\u0026gt; 4, SIMPLE_EXPRESSION -\u0026gt; genExpression(value, ctx) ç”Ÿæˆå±æ€§å€¼ { id: \u0026#34;foo\u0026#34;\n     DONE 03 v-bind æŒ‡ä»¤   \u0026lt;div :class=\u0026#34;bar.baz\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\n ç»“æœé¢„è§ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { class: bar.baz }, null, 2 /* CLASS */)) } } })      parser é˜¶æ®µï¼š\n   compiler é˜¶æ®µï¼š\n   codegen é˜¶æ®µï¼š\n     DONE 04 interpolation, æ’å€¼   \u0026lt;div\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, _toDisplayString(world.burn()), 1 /* TEXT */)) } } })      parser é˜¶æ®µ\n   compiler é˜¶æ®µ\n   codegen é˜¶æ®µ\n     DONE 05 v-if æŒ‡ä»¤(git:0a591b6)   \u0026lt;div\u0026gt;\u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;\n git commit: 0a591b62d6961526b333afeb5f77c532b3992e31\n vue.global:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  (function anonymous( ) { const _Vue = Vue const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue const _hoisted_1 = { key: 0 } return function render(_ctx, _cache) { with (_ctx) { const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, createCommentVNode: _createCommentVNode } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) ])) } } })     å·®å¼‚ç‚¹ï¼š\n  å°‘äº†å…¨å±€ä½œç”¨åŸŸä¸‹çš„ _Vue è§£æ„\n  key æ²¡æœ‰ hoisted\n  è„‘å›¾åˆ—è¡¨ï¼š\n  parser é˜¶æ®µ\n   compiler é˜¶æ®µ\n   codegen é˜¶æ®µ\n   æ‹“å±• 1ï¼šv-if-else æŒ‡ä»¤   \u0026lt;div\u0026gt;\u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt;\u0026lt;div v-else\u0026gt;no\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;\n vue.global:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  (function anonymous( ) { const _Vue = Vue const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue const _hoisted_1 = { key: 0 } const _hoisted_2 = { key: 1 } return function render(_ctx, _cache) { with (_ctx) { const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, createCommentVNode: _createCommentVNode } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_2, \u0026#34;no\u0026#34;)) ])) } } })     ä¸ pcg-05 å·®å¼‚ï¼š\n1 2 3  ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) // è¿™é‡Œæ²¡æœ‰ elseif, else åˆ†æ”¯ä¼šåˆ›å»ºä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹      å’Œ\n1 2 3  ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_2, \u0026#34;no\u0026#34;)) // åˆ†æ”¯èŠ‚ç‚¹      é€ æˆè¿™å·®ä¸€ç‚¹æ˜¯åœ¨å“ªå¤„ç†çš„å‘¢ï¼Ÿï¼Ÿï¼Ÿ\n v-if æŒ‡ä»¤çš„ codegen è¿‡ç¨‹æœ‰ä¸‰ä¸ªé‡è¦å› ç´ ï¼š\n  test ç”Ÿæˆæ¡ä»¶è¡¨è¾¾å¼\n  consequent ç”Ÿæˆæˆç«‹æ¡ä»¶(ok=true)è¡¨è¾¾å¼çš„\n  alternate ç”Ÿæˆå¤±è´¥æ¡ä»¶(ok=false)è¡¨è¾¾å¼çš„\n  å› æ­¤è¯¥æ‰©å±•é‡ç‚¹åœ¨ alternate å¤„ç† ğŸ›¬â€¦\n åœ¨ transform é˜¶æ®µé’ˆå¯¹ v-else çš„å¤„ç†é€»è¾‘ï¼š\n traverseNode ä¸­çš„ exitFns æ”¶é›†é˜¶æ®µï¼Œè°ƒç”¨ transformIf å– transform å‡½æ•°è¿‡ç¨‹ä¸­ï¼Œæœ‰ ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š\n  éå†å½“å‰ v-else èŠ‚ç‚¹çš„æ‰€æœ‰å…„å¼ŸèŠ‚ç‚¹(siblings=parent.children)\n  æ‰¾åˆ°å½“å‰èŠ‚ç‚¹ node åœ¨ siblings ä¸­çš„ä½ç½® i\n  while i-- ä¾æ¬¡å¾€å‰æ‰¾å…„å¼ŸèŠ‚ç‚¹(å¦‚æœæ˜¯ COMMENT èŠ‚ç‚¹ï¼Œåˆ é™¤ä¿å­˜å¾…æ¢å¤ï¼Œå¦‚æœæ˜¯ 9,IF èŠ‚ç‚¹å³æ‰¾åˆ°çš„ç›®æ ‡èŠ‚ç‚¹ sibling)\n  åˆ é™¤å½“å‰çš„ node åŒæ—¶è°ƒç”¨ createIfBranch åˆ›å»º 10,IF_BRANCH ç±»å‹çš„åˆ†æ”¯èŠ‚ç‚¹ç»“ æ„ï¼Œåˆå¹¶åˆ° sibling.branches ä¸­\n  è°ƒç”¨ processCodegen å‡½æ•°å³ transformIf æ—¶å€™æ‰§è¡Œä¼šå¾—åˆ°ç”Ÿæˆ codegenNode çš„é‚£ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå®ƒè·å– tranform å‡½æ•° exitFn ã€‚\n  æ‰‹åŠ¨æ‰§è¡Œ traverseNode(node, â€¦) è¿›è¡Œé€’å½’éå†è¯¥ v-else èŠ‚ç‚¹æ ‘(å› ä¸ºåœ¨ 4 ä¸­èŠ‚ç‚¹ è¢«åˆ é™¤äº†ï¼Œå› æ­¤ä¸»é€’å½’çº¿ä¸Šä¸ä¼šå‡ºç°è¿™ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ traverse)\n  æœ€åæ‰§è¡Œ exitFn ç”Ÿæˆè¯¥ v-else èŠ‚ç‚¹æ ‘çš„ codegenNode ã€‚\n æ³¨æ„ç‚¹ ï¼šè¿™ä¸€æ­¥ v-else æ›¿æ¢ alternate è¿‡ç¨‹ä¸­æœ‰ä¸ª while å¾ªç¯ç”¨æ¥é€’å½’æŸ¥æ‰¾é 19,JS_CONDITIONAL_EXPRESSION ç±»å‹çš„èŠ‚ç‚¹çš„ alternate å†è¿›è¡Œæ›¿æ¢ï¼Œè¿™ä¹ˆåšçš„åŸ å› æ˜¯ v-if-else æŒ‡ä»¤çš„åœ¨ render å‡½æ•°ä¸­æ˜¯é€šè¿‡ä¸‰ç›®è¿ç®—ç¬¦(?:)å®ç°çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ : åé¢çš„æ˜¯ä¸€ä¸ª comment vnode ç±»å‹å ä½ç”¨ï¼Œå½“å®é™…æœ‰ else åˆ†æ”¯çš„æ—¶å€™ä¼šè¿›è¡Œæ›¿æ¢ï¼Œ æ­¤æ—¶æ›¿æ¢éœ€è¦è€ƒè™‘åˆ°è¡¨è¾¾å¼åµŒå¥—çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°æœ€åé‚£ä¸ª comment vnode ï¼Œè¯¦ç»† æ­¥éª¤ç›´æ¥çœ‹è„‘å›¾å§ã€‚\n     parser é˜¶æ®µ\n   transform é˜¶æ®µ\n   codegen é˜¶æ®µ\n     æ‹“å±• 2ï¼šv-if-elseif-else æŒ‡ä»¤    parser é˜¶æ®µ\n ç›¸æ¯”è¾ƒ æ‹“å±•1ï¼šv-if-else è¿™é‡Œåªæ˜¯å¤šäº†ä¸€ä¸ª v-else-if è¿™åœ¨ parser é˜¶æ®µæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œ ç›´æ¥å‚è€ƒæ‹“å±• 1 çš„è„‘å›¾ã€‚\n   transform é˜¶æ®µ\n  å¯¹æ¯”å‰åç»“æœå‘ç°ï¼š v-if/v-else-if/v-else æŒ‡ä»¤ä½“ç³»çš„å®ç°å…³é”®åœ¨äº codegenNode ä¸­ ä¸‰ä¸ªå­—æ®µï¼š\n  test ?: è¡¨è¾¾å¼çš„æ¡ä»¶\n  consequent ?: è¡¨è¾¾å¼æ¡ä»¶ä¸º true çš„æ—¶å€™æ¸²æŸ“çš„èŠ‚ç‚¹\n  alternate ?: è¡¨è¾¾å¼æ¡ä»¶ä¸º false çš„æ—¶å€™æ¸²æŸ“çš„èŠ‚ç‚¹\n  å¦‚æœæœ‰å¤šçº§åµŒå¥—çš„æƒ…å†µï¼Œä¼šåœ¨ alternate ä¸­ä½“ç°å‡ºæ¥ï¼Œè¿™é‡Œé¢è¦ä¹ˆæ˜¯ä¸€ä¸ªèŠ‚ç‚¹ç»“æ„ï¼Œ è¦ä¹ˆæ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ…å«({ test, consequent, alternate }) åµŒå¥—çš„è¡¨è¾¾å¼ç»“æ„ã€‚\n v-else-if æ¸²æŸ“æµç¨‹æŸ¥çœ‹ç‰¹å®šçš„åŠŸèƒ½è„‘å›¾ã€‚\n  codegen é˜¶æ®µ\n       DONE 06 å« v-once æŒ‡ä»¤æ¨¡æ¿(git:2d0bab4)   \u0026lt;div\u0026gt;\u0026lt;p v-once\u0026gt;test v-once\u0026lt;/p\u0026gt;\u0026lt;/div\u0026gt;\n æµç¨‹å›¾ï¼š  git commit: 2d0bab4cfbf3408afe93270d7e9dc8ecd511dbe0\n  parser é˜¶æ®µæ²¡ä»€ä¹ˆä¸åŒï¼Œæœ€ç»ˆéƒ½æ˜¯ç”ŸæˆæŒ‡ä»¤ç±»å‹çš„ ast æ ‘\n  é‡ç‚¹åœ¨ transform é˜¶æ®µï¼Œå…ˆ transformText -\u0026gt; transformElement -\u0026gt; transformOnce å¤„ç†\n ç»è¿‡ transformOnce ä¹‹å codegenNodeç»“æœå˜åŒ–ï¼Œä» 13,VNODE_CALL ç±»å‹å˜æˆäº† 20,JS_CACHE_EXPRESSION ç±»å‹ã€‚\n  æ›´æ–° getBaseTransformPreset\n  å®ç° transforms/vOnce-\u0026gt;transformOnce\n  buildProps(node, ctx props = node.props, ssr=false) ä¸­å¿½ç•¥å±æ€§ v-once å¤„ç†ï¼Œ äº¤ç»™ transformOnce() å¤„ç†\n    codegen é˜¶æ®µçš„å¤„ç†ï¼Œç”Ÿæˆ Render å‡½æ•°ï¼Œå¯¹äº v-once å¤„ç†åŸç†æ˜¯åˆ©ç”¨ç¼“å­˜æœºåˆ¶ï¼Œç¬¬ ä¸€æ¬¡åˆ›å»ºèŠ‚ç‚¹å­˜å‚¨åˆ°å¯¹åº”çš„ context.cache[] ä¸­ï¼Œåé¢æ›´æ–°èŠ‚ç‚¹æ—¶å€™ç›´æ¥å–å¯¹åº”ç¼“å­˜ã€‚\n å®ç°å…³é”®å‡½æ•°:\n  genNode\n  genCacheExpression\n      TODO 07 v-for æŒ‡ä»¤   è„‘å›¾ï¼š  è¿™é‡Œå°†ä¸‰ä¸ªé˜¶æ®µåˆå¹¶åœ¨ä¸€èµ·äº†ï¼Œ transform é˜¶æ®µçš„è§£æå•ç‹¬æ”¾åœ¨äº† 9. transform é˜¶æ®µå¦‚ ä½•è½¬æ¢ v-for æŒ‡ä»¤ï¼Ÿ è¿™éƒ¨åˆ†å’Œ v-if è§£æä¸€æ ·æ¯”è¾ƒå¤æ‚ï¼Œä¸”å±äºç‰¹å®šçš„æŒ‡ä»¤è§£æä½œä¸ºå…³é”® åŠŸèƒ½è¿›è¡Œåˆ†æã€‚\n æ‰€ä»¥å¯¹äº transform é˜¶æ®µè¯¦ç»†å®ç°å’Œè„‘å›¾è¯·ç‚¹å‡»ä¸Šé¢é“¾æ¥æŸ¥çœ‹å†…å®¹ã€‚\n    â˜€ å…³é”®åŠŸèƒ½   è¿™ä¸€ç« èŠ‚æ˜¯é’ˆå¯¹æ•´ä¸ª vue3 æºç è§£æ„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜æˆ–ä¸€äº›é‡è¦æˆ–å…³é”®çš„ä¸€äº›åŠŸèƒ½ï¼Œè¿› è¡Œæå–è§£è¯»ã€‚\nDONE 1. buildProps(node, context) å¦‚ä½•æ„å»º props ?   CLOSED: [2020-09-18 Fri 16:07]\n  State \u0026#34;DONE\u0026#34; from \u0026#34;TODO\u0026#34; [2020-09-18 Fri 16:07]\n   props åœ¨ compile é˜¶æ®µæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæ˜¯å¦‚ä½•ä»(ç¤ºä¾‹04)\n  å˜æˆä¸‹é¢è¿™æ ·çš„ï¼š\n  å®Œæ•´æµç¨‹ï¼š   DONE 2. transformIf() æ˜¯å¦‚ä½•è¿”å› v-if æŒ‡ä»¤çš„ transform çš„ï¼Ÿ   å‚è€ƒç”¨ä¾‹ 05\n v-if æŒ‡ä»¤æ˜¯å¦‚ä½•è½¬æ¢çš„ï¼Ÿï¼Ÿï¼Ÿ\n è¿™ä¸ªè½¬æ¢å‡½æ•°åˆæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿï¼Ÿï¼Ÿ\n å¾—åˆ°è¿™ä¸ªè½¬æ¢å‡½æ•°è¿‡ç¨‹ä¸­åšäº†ä»€ä¹ˆ ï¼Ÿï¼Ÿï¼Ÿ\n é€šè¿‡åœ¨ traverseNode ä¸­ï¼Œ switch node é˜¶æ®µä¹‹å‰ï¼Œæ”¶é›† transform å‡½æ•°åˆ° exitFns[] ä¸­çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°äº† v-if æŒ‡ä»¤çš„å…ƒç´ ï¼Œä¼šæ‰§è¡Œ transformIf ï¼Œè¿™ä¸ªæ—¶å€™ä¼šéå†è§£æ node.props æ‹¿åˆ°è¿™ä¸ª v-if æŒ‡ä»¤å±æ€§ï¼Œè°ƒç”¨ processIf å°†è¯¥èŠ‚ç‚¹è½¬æ¢æˆ\n1 2 3 4  { branches: [branch], type: 9 // IF  }     å¹¶ä¸”ç”¨è¿™ä¸ªæ–°ç”Ÿæˆçš„èŠ‚ç‚¹ç»“æ„å»æ›¿æ¢åŸæ¥çš„ div v-if èŠ‚ç‚¹ç»“æ„ã€‚\n å³ï¼šåœ¨æ‹¿åˆ° transform if å‡½æ•°ä¹‹å‰ div v-if èŠ‚ç‚¹ç»“æ„å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œæˆä¸ºäº†\n type = 9 çš„ç»“æ„ï¼Œæœ€ååŸæ¥çš„èŠ‚ç‚¹æˆä¸ºäº† branches çš„å…ƒç´ ã€‚\n å¹¶ä¸”åŸèŠ‚ç‚¹çš„ props ä¼šè¢«æ¸…ç©º(é¿å…å›æº¯çš„æ—¶å€™é‡å¤å¤„ç†)ã€‚\n  transformIf:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  const transformIf = createStructuralDirectiveTransform( /^(if|else|else-if)$/, (node, dir, context) =\u0026gt; { return processIf(node, dir, context, (ifNode, branch, isRoot) =\u0026gt; { // Exit callback. Complete the codegenNode when all children have been  // transformed.  return () =\u0026gt; { // è¿™ä¸ªæ‰æ˜¯çœŸæ­£åœ¨å›æº¯è¿‡ç¨‹ä¸­è°ƒç”¨çš„ transform if å‡½æ•°  if (isRoot) { ifNode.codegenNode = createCodegenNodeForBranch(branch, 0, context); } else { // attach this branch\u0026#39;s codegen node to the v-if root.  let parentCondition = ifNode.codegenNode; while ( parentCondition.alternate.type === 19 /* JS_CONDITIONAL_EXPRESSION */ ) { parentCondition = parentCondition.alternate; } parentCondition.alternate = createCodegenNodeForBranch( branch, ifNode.branches.length - 1, context ); } }; }); } );     æµç¨‹å›¾ï¼š   TODO 3. codegen å¦‚ä½•ç”Ÿæˆå±æ€§(_createBLock(tag, props, â€¦))ç¬¬äºŒä¸ªå‚æ•°ï¼Ÿ   å¦‚ï¼š\n1 2 3 4 5 6  // ...  return (_openBlock(), _createBlock(\u0026#39;div\u0026#39;, { id: \u0026#34;foo\u0026#34;, class: bar.baz }))     id å’Œ class æ˜¯å¦‚ä½•ç”Ÿæˆå¯¹è±¡çš„ã€‚\n  DONE 4. transform é˜¶æ®µå¦‚ä½•å¯¹å±æ€§é™æ€æå‡ï¼Ÿ  CLOSED: [2020-09-28 Mon 10:55]\n  State \u0026#34;DONE\u0026#34; from \u0026#34;TODO\u0026#34; [2020-09-28 Mon 10:55]\n  æ²¡æœ‰ hoist ä¹‹å‰ï¼š\n1 2 3 4 5  return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { key: 0 }, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) ]))     æœ‰ hoist ä¹‹åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  (function anonymous( ) { const _Vue = Vue // ... çœç•¥  // æå‡åˆ° render å‡½æ•°ä¹‹å  const _hoisted_1 = { key: 0 } return function render(_ctx, _cache) { with (_ctx) { // ... çœç•¥  return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) ])) } } })      transform é˜¶æ®µæ˜¯åœ¨ æ‰§è¡Œå®Œ traverseNode() ä¹‹åè°ƒç”¨ hoistStatic(root,context) é€šè¿‡ walk() é€’å½’éå† æ‰€æœ‰çš„å­©å­èŠ‚ç‚¹æ¥æ£€æµ‹æ»¡è¶³æ¡ä»¶çš„ hoist å±æ€§æˆ–èŠ‚ç‚¹ã€‚\n å³ï¼šé™æ€æå‡åŠ¨ä½œå‘ç”Ÿåœ¨æ‰€æœ‰èŠ‚ç‚¹çš„ codegenNode è§£æå®Œæ¯•ä¹‹å(ä¸”æ»¡è¶³ï¼š options.hoistStatic = true)ã€‚\n  codegen é˜¶æ®µæ˜¯åœ¨ genFunctionPreamable(ast, context) æ£€æµ‹ ast.hoists æ•°ç»„å°†éœ€è¦ç”¨ åˆ°çš„å‡½æ•°æå‡åˆ° render ä¹‹å¤–ï¼Œç„¶åè°ƒç”¨ genHoists(ast.hoists) ç”Ÿæˆéœ€è¦æå‡çš„å±æ€§ã€‚\n æœ€åæ ¹æ®ï¼š\n1 2 3 4 5  node: content: \u0026#34;_hoisted_1\u0026#34; isConstant: true isStatic: false type: 4 // SIMPLE_EXPRESSION      æœ€åç”¨ _hoisted_1 æ¥æ›¿ä»£ { key: 0 } è¿™ä¸ªæƒŠå¤©å±æ€§ã€‚\n  DONE 5. codegen å¦‚ä½•ç”Ÿæˆ if-elseif-else åˆ†æ”¯èŠ‚ç‚¹ ?  CLOSED: [2020-10-04 Sun 12:47]\n  State \u0026#34;DONE\u0026#34; from \u0026#34;TODO\u0026#34; [2020-10-04 Sun 12:47]\n  ç”Ÿæˆåˆ†æ”¯å…¥å£å‡½æ•°äº§ç”Ÿè¿‡ç¨‹ï¼štraverseNode ä¸­æ”¶é›† exitFns è¿‡ç¨‹ä¸­æ‰§è¡Œ transformIf ç»è¿‡ä¸€äº›åˆ—æ“ä½œä¹‹åå¾—åˆ°ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨å½“å‰èŠ‚ç‚¹æ ‘é€’å½’ç»“æŸåè°ƒç”¨ï¼Œç”Ÿæˆ codegenNode\n è¿”å›çš„åˆ†æ”¯èŠ‚ç‚¹ codegenNode ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61  { \u0026#34;type\u0026#34;:19, \u0026#34;test\u0026#34;:{ // ok ? ... : ...  \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;ok\u0026#34;, \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;loc\u0026#34;:{ // ...  \u0026#34;source\u0026#34;:\u0026#34;ok\u0026#34; } }, \u0026#34;consequent\u0026#34;:{ // cond ? è¿™é‡Œçš„ä»£ç  : ...  \u0026#34;type\u0026#34;:13, \u0026#34;tag\u0026#34;:\u0026#34;\u0026#34;div\u0026#34;\u0026#34;, \u0026#34;props\u0026#34;:{ \u0026#34;type\u0026#34;:15, \u0026#34;loc\u0026#34;:{ /* ... */ }, \u0026#34;properties\u0026#34;:[ { \u0026#34;type\u0026#34;:16, \u0026#34;key\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;key\u0026#34;, \u0026#34;isStatic\u0026#34;:true }, \u0026#34;value\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;0\u0026#34;, \u0026#34;isStatic\u0026#34;:false } } ] }, \u0026#34;children\u0026#34;:{ \u0026#34;type\u0026#34;:2, \u0026#34;content\u0026#34;:\u0026#34;yes\u0026#34;, \u0026#34;loc\u0026#34;:{ \u0026#34;source\u0026#34;:\u0026#34;yes\u0026#34; } }, \u0026#34;isBlock\u0026#34;:true, \u0026#34;isForBlock\u0026#34;:false, \u0026#34;loc\u0026#34;:{ \u0026#34;source\u0026#34;:\u0026#34;\u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt;\u0026#34; } }, \u0026#34;alternate\u0026#34;:{ // cond ? ... : è¿™é‡Œçš„ä»£ç   \u0026#34;type\u0026#34;:14, \u0026#34;loc\u0026#34;:{ \u0026#34;source\u0026#34;:\u0026#34;\u0026#34;, }, \u0026#34;arguments\u0026#34;:[ \u0026#34;\u0026#34;v-if\u0026#34;\u0026#34;, \u0026#34;true\u0026#34; ] }, \u0026#34;newline\u0026#34;:true, }     å¤„ç†æµç¨‹å›¾ï¼š\n   DONE 6. transform é˜¶æ®µå¦‚ä½•è½¬æ¢ v-else-if æŒ‡ä»¤ï¼Ÿ   ç¤ºä¾‹ä»£ç ï¼š\n1 2 3 4 5  \u0026lt;div\u0026gt; \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;div v-else-if=\u0026#34;nok\u0026#34;\u0026gt;nok\u0026lt;/div\u0026gt; \u0026lt;div v-else\u0026gt;no\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt;       DONE 7. ä»€ä¹ˆæ—¶å€™ç”¨ createVNode ä»€ä¹ˆæ—¶å€™ç”¨ createBlock ï¼Ÿ   åˆ°ç›®å‰ä¸ºæ­¢å¤§éƒ¨åˆ†çš„å®ä¾‹éƒ½æ˜¯é€šè¿‡ block è§£æçš„ï¼Œå› ä¸ºå­©å­èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªã€‚\n å­©å­èŠ‚ç‚¹æœ‰å¤šä¸ªçš„æ—¶å€™ä¼šè¿›å…¥ VNode æµç¨‹ï¼Œè¿™é‡Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹æ¥å°†å¤šä¸ªå­©å­ åŒ…èµ·æ¥å»ç”Ÿæˆ render å‡½æ•°ã€‚\n è™šæ‹ŸèŠ‚ç‚¹åˆ›å»ºæœ‰è¿™ä¹ˆå‡ ä¸ªå‡½æ•°ï¼š createVNode, createCommentVNode, createTextVNode è¿™äº›å‡½æ•°ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿå’Œ openBlock, createBlock åŒºåˆ«åœ¨å“ªï¼Ÿ\n å¯¹æ¯”ä¸¤ä¸ªç¤ºä¾‹ï¼š\n vnode ç‰ˆ v1:\n1 2 3 4  \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt;     é vnode ç‰ˆ v2:\n1 2 3  \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;/div\u0026gt;     åŒºåˆ«ï¼šæ’å€¼ {{world.burn()}} æœ‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; æ­¤æ—¶æ’å€¼ èŠ‚ç‚¹çš„å¤„ç†ä¼šä¸ä¸€æ ·ï¼Œå…ˆçœ‹ç»“æœï¼š\n  v1 ç»“æœ(è¿™ä¸ªç»“æœæ˜¯æœ‰é—®é¢˜çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜)ï¼š\n é—®é¢˜ï¼š _createTextVNode(, 1 /* TEXT */) è¿™é‡Œå°‘äº†ä¸ªå‚æ•°ï¼Œåº”è¯¥æ˜¯é‚£ä¸ªæ’å€¼è¡¨è¾¾å¼ã€‚\n è§£å†³æ–¹æ³•ï¼šåŠ ä¸Š genNode: COMPOUND_EXPRESSION åˆ†æ”¯å¤„ç†ã€‚\n å¤„ç†ä¹‹åï¼š _createTextVNode(_toDisplayString(world.burn()) + \u0026#34; \u0026#34;, 1 /* TEXT */)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  const _Vue = Vue; const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode, } = _Vue; const _hoisted_1 = { key: 0 }; return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode, } = _Vue; return ( _openBlock(), _createBlock( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz, }, [ _createTextVNode(, 1 /* TEXT */), ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true), ], 2 /* CLASS */ ) ); } };      v2 ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  (function anonymous() { const _Vue = Vue; return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, } = _Vue; return ( _openBlock(), _createBlock( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz, }, _toDisplayString(world.burn()), 3 /* TEXT, CLASS */ ) ); } }; });       è„‘å›¾ï¼š\n   DONE 8. transform é˜¶æ®µå¦‚ä½•åšé™æ€æå‡ï¼Ÿ   é™æ€æå‡æ£€æµ‹åœ¨ transform é˜¶æ®µï¼Œ traverseNode éå†å®Œ ast æ ‘ä¹‹åï¼Œä¼šè°ƒç”¨ hoistStatic(root, context) å¯¹æ‰€æœ‰ codegenNode è¿›è¡Œé€’å½’ï¼Œå°†éœ€è¦é™æ€æå‡çš„èŠ‚ç‚¹æå– åˆ° root.hoists ä¸­ã€‚\n1 2 3 4 5 6 7 8  function transform(root, options) { const context = createTransformContext(root, options); traverseNode(root, context); if (options.hoistStatic) { hoistStatic(root, context); } // ... }     é™æ€æå‡æ¡ä»¶ï¼š\n  æ ¹èŠ‚ç‚¹å¿…é¡»æœ‰ä¸€ä¸ªå­©å­ä»¥ä¸ŠèŠ‚ç‚¹ï¼Œä¸”æ‰€æœ‰å­å­™èŠ‚ç‚¹éƒ½å¿…é¡»æ˜¯é™æ€èŠ‚ç‚¹(isStatic(child, resultCache))\n  å¦‚æœèŠ‚ç‚¹æ˜¯åŠ¨æ€èŠ‚ç‚¹ï¼Œåˆ™æ£€æµ‹å…¶æ‰€æœ‰å±æ€§ï¼Œæå–å‡ºé™æ€å±æ€§å°†å…¶æå‡\n  æå‡ä¹‹åçš„å±æ€§æˆ–èŠ‚ç‚¹ä¼šä¿å­˜åˆ° context.hoists é‡Œé¢\n  æºç è„‘å›¾ï¼š   DONE 9. transform é˜¶æ®µå¦‚ä½•è½¬æ¢ v-for æŒ‡ä»¤ï¼Ÿ   è¿™é‡Œå’Œ transform å¦‚ä½•è½¬æ¢ v-else-if ä¸€æ ·å¤æ‚ï¼Œè¿™é‡Œå°†å•ç‹¬è¿›è¡Œåˆ†æç»˜å‡ºå¯¹åº”è„‘å›¾ï¼Œç¤º ä¾‹æ¥æºäº v-for æŒ‡ä»¤ ä¸”ä¿æŒåŒæ­¥ã€‚\n  æµ‹è¯•ç”¨ä¾‹ï¼š\n1 2 3  \u0026lt;ul class=\u0026#34;list\u0026#34;\u0026gt; \u0026lt;li v-for=\u0026#34;user in users\u0026#34;\u0026gt;{{user.name}}\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt;`     transform é˜¶æ®µå‰å ast å¯¹æ¯”ï¼š\n  transform ä¹‹å‰çš„ \u0026lt;li\u0026gt; ast:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  // ast.children[0]/*\u0026lt;ul\u0026gt;*/.children[0]/*\u0026lt;li\u0026gt;*/ var before = { type: 1, tag: \u0026#39;li\u0026#39;, props: [ { type: 7, name: \u0026#39;for\u0026#39;, exp: { type: 4, content: \u0026#39;user in users\u0026#39;, isStatic: false, isConstant: false, }, loc: { source: \u0026#34;v-for=\u0026#39;user in users\u0026#39;\u0026#34; }, }, ], isSelfClosing: false, children: [ { type: 5, content: { type: 4, isStatic: false, isConstant: false, content: \u0026#39;user.name\u0026#39;, }, loc: { source: \u0026#39;{{user.name}}\u0026#39; }, }, ]      tranform ä¹‹åçš„ \u0026lt;li\u0026gt; ast:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  // ast.children[0]/*\u0026lt;ul\u0026gt;*/.children[0]/*\u0026lt;li\u0026gt;*/ var after = { type: 11, // FOR source: { // æºæ•°æ®  type: 4, isConstant: false, content: \u0026#39;users\u0026#39;, isStatic: false, }, valueAlias: { // è¿­ä»£è¿‡ç¨‹ä¸­çš„å€¼  type: 4, isConstant: false, content: \u0026#39;user\u0026#39;, isStatic: false, }, parseResult: { source: \u0026#39;...\u0026#39; /*å¯¹åº”å¤–é¢çš„source*/, value: \u0026#39;...\u0026#39; /*å¯¹åº”å¤–é¢çš„ valueAlias*/, }, children: [ { type: 1, tag: \u0026#39;li\u0026#39;, props: [], children: [ { // {{user.name}}  type: 5, content: { type: 4, isStatic: false, isConstant: false, content: \u0026#39;user.name\u0026#39;, }, }, ], codegenNode: {/*...è§ li çš„ codegenNode */}, }, ], codegenNode: {/*...*/}, }      type: 11, FOR ç±»å‹\n  source: æ¸²æŸ“åˆ—è¡¨çš„æ•°æ®æ¥æºï¼Œè¿™é‡Œæ˜¯ users\n  valueAlias: æ¸²æŸ“åˆ—è¡¨é¡¹éœ€è¦çš„æ•°æ® user\n    transform ä¹‹åç”Ÿæˆçš„ \u0026lt;li\u0026gt; codegenNode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  node.codegenNode = { type: 11, // FOR codegenNode: { type: 13, // VNODE_CALL  children: { type: 14, // JS_CALL_EXPRESSION  arguments: [ // å°†ä½œä¸º callee: _renderList çš„å‚æ•°  { type: 4, isConstant: false, content: \u0026#39;users\u0026#39;, isStatic: false, }, { // ç”¨æ¥ç”Ÿæˆå‡½æ•°çš„ (user) =\u0026gt; { retrun `è§£æåçš„returns` }  type: 18, // JS_FUNCTION_EXPRESSION  params: [ // è¿™ä¸ªä½œä¸º _renderList ç¬¬äºŒä¸ªå‡½æ•°çš„å‚æ•°  { type: 4, isConstant: false, content: \u0026#39;user\u0026#39;, isStatic: false, }, ], returns: { // _renderList ç¬¬äºŒä¸ªå‚æ•°å‡½æ•°çš„è¿”å›å€¼  type: 13, tag: \u0026#39;\u0026#34;li\u0026#34;\u0026#39;, children: { type: 5, // INTERPOLATION  content: { type: 4, isStatic: false, isConstant: false, content: \u0026#39;user.name\u0026#39;, }, }, patchFlag: \u0026#39;1 /* TEXT */\u0026#39;, isBlock: true, disableTracking: false, }, newline: true, // è¿™ä¸ªç»“åˆ body å†³å®šæ˜¯å¦æ˜¯ (user) =\u0026gt; xx è¿˜æ˜¯ (user) =\u0026gt; { return xxx }  isSlot: false, }, ], }, patchFlag: \u0026#39;256 /* UNKEYED_FRAGMENT */\u0026#39;, isBlock: true, disableTracking: true, },     const children = codegenNode.children\n  children: ç”Ÿæˆ _renderList( å‡½æ•°\n _renderList(\n  children.arguments: ç”Ÿæˆ _renderList(users, fn) å‡½æ•°çš„ ä¸¤ä¸ªå‚æ•° users å’Œ fn\n  children.arguments[0]: å°†ç”Ÿæˆç¬¬ä¸€ä¸ªå‚æ•° users\n _renderList(users,\n  children.arguments[1]: å°†ç”Ÿæˆ fn å‡½æ•°\n _renderList(users, fn\n  children.arguments[1].type: 18ï¼Œè¡¨ç¤ºæ˜¯ JS_FUNCTION_EXPRESSION ç±»å‹ï¼Œç”¨ æ¥ç”Ÿæˆå‡½æ•°çš„\n  children.arguments[1].params: ä½œä¸º fn å‡½æ•°çš„å‚æ•°\n _renderList(users, (user) =\u0026gt;\n  children.arguments[1].returns: ä½œä¸º fnå‡½æ•°çš„è¿”å›å€¼\n _renderList(users, (user) =\u0026gt; { return (_openBlock(), _createBlock(\u0026#34;li\u0026#34;, null, _toDisplayString(user.name), 1 /*TEXT*/)) })\n    ä»ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œ v-for æŒ‡ä»¤æœ€åä¼šè¢«æ›¿æ¢æˆä¸‹é¢çš„ç»“æ„ï¼š\n { type:11, valueAlias:/*è¿™é‡Œæ˜¯è¿­ä»£å½“å‰çš„æ•°æ® user */, source: /* è¿™é‡Œæ˜¯æ•°æ®æºï¼Œå¦‚ï¼šusers*/}\n ç”Ÿæˆçš„ li codegenNode ç»“æ„ï¼š\n {type: 13, children: {/*...*/}}\n renderList(users, (user)=\u0026gt; {return xx}) æœ€ç»ˆç”± children å†…æ•°æ®å‘ˆç°ï¼š\n {type: 14, arguments: [{...}, {...}]}\n arguments:  [{ type: 4, content: \u0026#34;users\u0026#34; }, { type: 18, params: {...} returns: {...} }}]\n ç¬¬äºŒä¸ªå‚æ•°æˆå‘˜è¡¨(ç”Ÿæˆï¼š _renderList(users, fn))\n   memeber type value description     type 18,JS_FUNCTION_EXPRESSION 18 ç”Ÿæˆå‡½æ•° fn çš„ç±»å‹   params 4,SIMPLE_EXPRESSION {type:4, content: \u0026#34;user\u0026#34;} fn ç¬¬ä¸€ä¸ªå‚æ•° user, (user) =\u0026gt; xxx   returns 13,VNODECALL {type:13, tag: \u0026#34;\\\u0026#34;li\\\u0026#34;\u0026#34;, ...} fn å‡½æ•°çš„è¿”å›å€¼   body - - fn çš„å‡½æ•°ä½“ï¼Œ () =\u0026gt; body, å’Œ returns ç›¸å†²çªï¼ŒäºŒé€‰ä¸€ï¼Œä¸” returns ä¼˜å…ˆ        â˜ compiler-core: parser   vue3.0 çš„è§£æå™¨æ¨¡å—ï¼Œå°† html æ¨¡æ¿è§£ææˆ AST å¯¹è±¡ã€‚\nå¸¦æŒ‡ä»¤çš„æ ‡ç­¾è§£æå…¨è¿‡ç¨‹(v-bind)   ä»£ç ï¼š baseParse(`\u0026lt;div v-bind:keyup.enter.prevent=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;`)\n  parseChildren â¡ï¸ while\n  parseElement â¬…ï¸ \u0026lt;div ....\u0026gt;\u0026lt;/div\u0026gt;\n  parseTag â¡ï¸ node: div â¡ï¸ parseAttributes è§£æå±æ€§ â¬…ï¸ v-bind:keyup...\u0026gt;\u0026lt;/div\u0026gt;\n  parseAttribute â¡ï¸\n  å…ˆè§£æ =\u0026#34;ok\u0026#34; å‡ºå€¼\n  åè§£æ v-bind:keyup.enter.prevent\n    æœ€åå¾—åˆ° props[0] -\u0026gt; { name: \u0026#39;bind\u0026#39;, arg: { content: \u0026#39;keyup\u0026#39;, ... }, exp: { content: \u0026#39;ok\u0026#39;, ... }, modifiers: [\u0026#39;enter\u0026#39;, \u0026#39;prevent\u0026#39; ]}\n  name: æŒ‡ä»¤çš„åç§°ï¼Œ v-bind, @ éƒ½ä¼šè½¬æˆ bind åç§°\n  arg: è¡¨ç¤ºæŒ‡ä»¤ç»‘å®šçš„å‚æ•°åç§°ï¼Œè¿™é‡Œå¯ä»¥æ˜¯åŠ¨æ€å˜é‡ï¼Œå¦‚ï¼š v-bind:[dynamicVarName] ï¼Œç”± arg.isConstant æ ‡è¯†ã€‚\n  exp: è¡¨ç¤ºè¡¨è¾¾å¼çš„å€¼\n     æµç¨‹å›¾ï¼š   æ ‡ç­¾è§£æ(\u0026lt;div\u0026gt;hello world\u0026lt;/div\u0026gt;)   ä»£ç ï¼š baseParse(`\u0026lt;div\u0026gt;hello world\u0026lt;/div\u0026gt;`)\n  parseChildren while å¼€å§‹è§£æ\n  é‡åˆ° \u0026lt;d æ»¡è¶³ /^[z-a]/i è¿›å…¥ parseElement è§£ææ ‡ç­¾\n  parseElement -\u0026gt; parseTag è§£æå‡ºåä¸º div çš„æ ‡ç­¾èŠ‚ç‚¹ï¼Œ content = `hello world\u0026lt;/div\u0026gt;`\n  parseElement -\u0026gt; parseChildren è§£æå‡º hello world æ–‡æœ¬èŠ‚ç‚¹ä½œä¸º div èŠ‚ç‚¹çš„ children[0]ï¼Œ content = `\u0026lt;/div\u0026gt;`\n  è¿”å›åˆ° parseChildren è§£æ \u0026lt;/div\u0026gt; å‘ç° ancestors æœ‰å†…å®¹ä¸”æ‰¾åˆ°äº† \u0026lt;/div\u0026gt; åŒ¹é…çš„ \u0026lt;div\u0026gt; èŠ‚ç‚¹ï¼Œæœ€åå®ŒæˆåŒ¹é…ã€‚\n   æµç¨‹å›¾ï¼š\n è‡ªé—­åˆæ ‡ç­¾(\u0026lt;img/\u0026gt;)çš„è§£æï¼Œä¹Ÿåœ¨ parseTag é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªé’ˆå¯¹è¿™ä¸ªçš„å¤„ç†ï¼š  1 2 3 4 5 6 7 8 9 10  // è§£æåˆ°è¿™é‡Œçš„æ—¶å€™ content åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š`/\u0026gt;xxx`  isSelfClosing = startsWith(context.source, \u0026#39;/\u0026gt;\u0026#39;) if (type === TagType.End \u0026amp;\u0026amp; isSelfClosing) { // å¦‚æœè‡ªé—­åˆæ²¡æœ‰å¼€å§‹æ ‡ç­¾ï¼Œæ˜¯éæ³•çš„  emitError(context, ErrorCodes.END_TAG_WITH_TRAILING_SOLIDUS) } // è¿™é‡Œåˆ¤æ–­å¦‚æœæ˜¯è‡ªé—­åˆçš„ï¼Œé‚£ä¹ˆè¯¥æ ‡ç­¾çš„è§£æå°±å·²ç»ç»“æŸäº†  advanceBy(context, isSelfClosing ? 2 : 1)      ç©ºæ ‡ç­¾çš„å¤„ç†ï¼Œéœ€è¦åœ¨è°ƒç”¨è§£æå‡½æ•° baseParse çš„æ—¶å€™æ˜ç¡®å‘ŠçŸ¥å®ƒå“ªäº›æ˜¯ç©ºæ ‡ç­¾(å¦‚ï¼š \u0026lt;img\u0026gt;)ï¼š  1 2 3  const ast = baseParse(\u0026#39;\u0026lt;img\u0026gt;after\u0026#39;, { isVoidTag: (tag) =\u0026gt; tag === \u0026#39;img\u0026#39; })     isVoidTag ä¼šåœ¨ parseElement çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œåœ¨è°ƒç”¨ parseTag è§£æå®Œ TagType.Start ä¹‹åæ£€æµ‹ï¼Œå¦‚æœæ˜¯ç©ºæ ‡ç­¾ç±»å‹ï¼Œä¼šç›´æ¥é€€å‡ºè§£æå³å®Œæˆè¯¥æ ‡ç­¾çš„è§£æ è¿‡ç¨‹(å› ä¸ºæ˜¯ç©ºæ ‡ç­¾ï¼Œæ‰€ä»¥åé¢çš„å†…å®¹å°±ä¸å†å±äºå®ƒäº†ï¼Œå¯ä»¥ç»“æŸäº†)ï¼š\n1 2 3 4  // è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†  if (element.isSelfClosing || context.options.isVoidTag?.(element.tag)) { return element; }      æ¨¡æ¿æ ‡ç­¾çš„è§£æ(\u0026lt;template\u0026gt;\u0026lt;/template\u0026gt;)   è¿™ä¸ªè§£æå’Œæ™®é€šæ ‡ç­¾åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯åœ¨ parseTag é‡Œé¢è§£æçš„æ—¶å€™æ›´æ–°ä¸‹ç±»å‹å°±å¯ä»¥äº†ï¼Œå¾ˆ ç®€å•çš„æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  function parseTag( context: ParserContext, type: TagType, parent: ElementNode | undefined ): ElementNode { // ...çœç•¥ï¼Œè¿™äº›éƒ½å¯ä»¥çœç•¥äº†ï¼Œå’Œæ™®é€šæ ‡ç­¾å¤„ç†ä¸€æ¨¡ä¸€æ ·  let tagType = ElementTypes.ELEMENT const options = context.options if (!context.inVPre \u0026amp;\u0026amp; !options.isCustomElement(tag)) { // ...çœç•¥ï¼Œvue å†…ç½®ç»„ä»¶ç±»å‹  if (tag === \u0026#39;slot\u0026#39;) { tagType = ElementTypes.SLOT } else if ( // æ‰€ä»¥è¿™é‡Œæ‰æ˜¯é‡ç‚¹ï¼Œä½œä¸ºæ¨¡æ¿æ ‡ç­¾å¿…é¡»æ»¡è¶³ä¸€å®šçš„æ¡ä»¶  // 1. å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå±æ€§ï¼Œä¸”ç±»å‹æ˜¯æŒ‡ä»¤  // 2. å¹¶ä¸”æ»¡è¶³ const isSpecialTemplateDirective = /*#__PURE__*/ makeMap(`if,else,else-if,for,slot`)  // å³è¯¥æŒ‡ä»¤å¿…é¡»æ˜¯ if, else, else-if, for, slotï¼Œä¹Ÿå°±æ˜¯è¯´æ¨¡æ¿å¿…é¡»ç”¨ä½œå¾ªç¯æˆ–æ’æ§½æ—¶ä½¿ç”¨  tag === \u0026#39;template\u0026#39; \u0026amp;\u0026amp; props.some(p =\u0026gt; { return ( p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; isSpecialTemplateDirective(p.name) ) }) ) { tagType = ElementTypes.TEMPLATE } } return { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined // to be created during transform phase  } }     æ‰€ä»¥ä¸‹é¢è¿™ä¸¤ä¸ªç”¨ä¾‹å°±èƒ½å¾ˆå¥½çš„å¾—åˆ°è§£é‡Šäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  test(\u0026#34;template element with directives\u0026#34;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;template v-if=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/template\u0026gt;\u0026#39;); const element = ast.children[0]; expect(element).toMatchObject({ type: NodeTypes.ELEMENT, tagType: ElementTypes.TEMPLATE, // è¿™é‡Œæ˜¯æ¨¡æ¿ç±»å‹ï¼Œå› ä¸ºæœ‰ `v-if\u0026#39; æŒ‡ä»¤  }); }); // template element with directives  test(\u0026#34;template element without directives\u0026#34;, () =\u0026gt; { const ast = baseParse(\u0026#34;\u0026lt;template\u0026gt;\u0026lt;/template\u0026gt;\u0026#34;); const element = ast.children[0]; expect(element).toMatchObject({ type: NodeTypes.ELEMENT, tagType: ElementTypes.ELEMENT, // è€Œè¿™é‡Œä¾æ—§æ˜¯å…ƒç´ ç±»å‹ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•æŒ‡ä»¤  }); });        è§£ææ— æ•ˆçš„ \u0026lt;/div\u0026gt;   ä»£ç ï¼š baseParse(`\u0026lt;/div\u0026gt;`)\n ç»è¿‡çš„å‡½æ•°ï¼š\n  parseChildren è¿›å…¥è§£æ while\n  parseText è§£æå‡ºæœ‰æ•ˆæ–‡æœ¬\n  å›åˆ° parseChildren while å¾ªç¯è§£æ \u0026lt;/div\u0026gt; æŠ¥é”™\n   æµç¨‹å›¾ï¼š   æ’å€¼è§£æ some {{ foo + bar }} text   ä»£ç ï¼š baseParse(`some {{ foo + bar }} text`)\n  parseChildren â¡ï¸ while: some {{ foo + bar }} text\n  parseText â¡ï¸ node[0]: `some`\n  {{ foo + bar }} text â¡ï¸ parseInterpolation â¡ï¸ node[1]: foor + bar\n  ` text` â¡ï¸ parseText â¡ï¸ node[2]: `text`\n  nodes -\u0026gt; root.children\n  è§£æè¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š\n  æ’å€¼è§£æï¼Œé¦–å…ˆæ˜¯åŒ¹é… `{{` ç„¶åå»çš„ }} çš„ç´¢å¼•ï¼Œæœ€åé€šè¿‡ slice(startIdx, endIdx) å–åˆ°è¦è§£æçš„è¡¨è¾¾å¼ã€‚\n  `some` å’Œ `text` ä¸ä¼šåˆå¹¶åˆ°ä¸€ä¸ª node ä¸­ï¼Œå› ä¸ºä¸æ˜¯ç›¸é‚»çš„ï¼Œè¯·æ³¨æ„åˆå¹¶æ–‡ æœ¬ ndoe çš„å‰ææ¡ä»¶ï¼šå‰ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¿…é¡»æ˜¯æ–‡æœ¬èŠ‚ç‚¹ç±»å‹ã€‚\n  æµç¨‹å›¾ï¼š   è§£æ simple text   è§£æçº¯æ–‡æœ¬ï¼Œåªä¼šè¿›å…¥ while å¾ªç¯ä¸­çš„ !node æ£€æµ‹ç„¶åè¿›å…¥ parseText çº¯æ–‡æœ¬è§£ æï¼Œä¼šåŒ¹é… \u0026lt;, {{, ]]\u0026gt; ä½œä¸ºçº¯æ–‡æœ¬çš„ç»“æŸæ ‡å¿—ã€‚\n å¾—åˆ°çº¯æ–‡æœ¬å†…å®¹åä¼ é€’ç»™ parseTextData æ›¿æ¢ /\u0026amp;(gt|lt|amp|apos|quot);/g html è¯­ä¹‰ç¬¦å·ä¹‹åè¿”å›ç»™ parseText:content ç»„ç»‡æ–‡æœ¬èŠ‚ç‚¹ç»“æ„è¿”å›ã€‚\n é€€å‡º while å¾ªç¯ï¼Œå°† node å¡åˆ° root.children[] é‡Œé¢ï¼Œä½œä¸ºæ ¹èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹ã€‚\n ä»£ç ï¼š baseParse(`simple text`)\n æµç¨‹å›¾ï¼š     ğŸŒ™ compiler-core: compiler   vu3.0 ç¼–è¯‘å™¨æ¨¡å—ï¼Œå°† parser è§£æå¾—åˆ°çš„ AST å¯¹è±¡ç¼–è¯‘æˆå¯¹åº”çš„ render å‡½æ•°ã€‚\n è¯¥æ¨¡å—ä¸»è¦å®ç°çš„ä¸‰å¤§å—ï¼Œå› ä¸ºè¿™ä¸‰ä¸ªå…³è”æ€§å¾ˆå¼ºï¼Œå› æ­¤æ”¾åˆ°ä¸€å—äº†ã€‚\n  compile.ts ç¼–è¯‘å™¨ä¸»æ¨¡å—\n  transform.ts å³ transforms/ ç›®å½•ï¼Œè¯­æ³•è½¬æ¢æ¨¡å—ï¼Œå…¥å£å‡½æ•°ï¼š transform()ï¼Œæ¯”å¦‚ï¼š v-if æŒ‡ä»¤ï¼Œå‡½æ•°ï¼Œå˜é‡ç­‰\n  codegen.ts å…¥å£å‡½æ•°ï¼š generate() ï¼Œç”Ÿæˆä»£ç å­—ç¬¦ä¸²ï¼Œç”¨æ¥è°ƒç”¨ new Function(code) ç”Ÿæˆ render å‡½æ•°ã€‚\n   æµç¨‹å›¾ï¼š 01-simple text ç¼–è¯‘è¿‡ç¨‹   ä»£ç ï¼š\n1 2 3  compile(`simple text`, { filename: `foo.vue` })     01-simple-text æµ‹è¯•ç”¨ä¾‹åœ°å€\n æµç¨‹å›¾ï¼š  è¯¦ç»†è¿‡ç¨‹åˆ†æè¯·ç‚¹å‡»é“¾æ¥ã€‚\n  02-pure interpolation ç¼–è¯‘è¿‡ç¨‹   ä»£ç ï¼š\n1 2 3  compile(`{{ world.burn() }}`, { filename: `foo.vue`, })     02-pure-interpolation æµ‹è¯•ç”¨ä¾‹åœ°å€\n æµç¨‹å›¾ï¼š\n  è¯¦ç»†è¿‡ç¨‹åˆ†æè¯·ç‚¹å‡»é“¾æ¥ã€‚\n  03-inerpolation in pure div   ä»£ç ï¼š\n1 2 3  compile(`\u0026lt;div\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;`, { filename: `foo.vue`, })     ç”¨ä¾‹åœ°å€\n æµç¨‹å›¾ï¼š\n  è¯¦ç»†è¿‡ç¨‹åˆ†æè¯·ç‚¹å‡»é“¾æ¥ã€‚\n  04-interpolation in div with props   ä»£ç ï¼š\n1 2 3  compile(`\u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;`, { filename: `foo.vue`, })     ç”¨ä¾‹åœ°å€\n æµç¨‹å›¾ï¼š   05-interpolation, v-if, props  1 2 3 4 5  code = ` \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt;`     å¦‚æœæ”¾åˆ°ä¸€å¼ å›¾é‡Œé¢ï¼Œå®åœ¨å¤ªç¹çäº†ï¼Œç®€åŒ–ï¼Œæ‹†åˆ†å¦‚ä¸‹ï¼š\n   æ•´ä½“æµç¨‹åŠå¯¼è‡´ç»“æœ\n  parse ast æµç¨‹\n  transform ast æµç¨‹ï¼Œè¿™éƒ¨åˆ†ä¼šæ¯”è¾ƒç¹ç\n  codegen generate æµç¨‹\n  transform é˜¶æ®µæµç¨‹å›¾ï¼š  generate é˜¶æ®µæµç¨‹å›¾ï¼š     ","permalink":"https://www.cheng92.com/vue/vue-mind-map-house-cc/","tags":["vue,","vue3,","compiler-core,","parser,","compiler"],"title":"Vue3 æºç å¤´è„‘é£æš´ä¹‹â˜compiler-core"},{"categories":["algorithm,","array"],"contents":" 0001_two-sum   ","permalink":"https://www.cheng92.com/algo/algo-leetcode-easy/","tags":["algorithm,","leetcode,","programming,","javascript"],"title":"Algorithm On Leetcode - Easy Level"},{"categories":["vue"],"contents":" reactivity   compiler-core  compile.ts  baseCompile   baseCompile(template, options)\n å°† template è§£ææˆ render å‡½æ•°ï¼Œé‡ç‚¹æ­¥éª¤:\n  baseParse(template, options) å°†å­—ç¬¦ä¸²æ¨¡æ¿è§£ææˆ AST å¯¹è±¡ã€‚\n  transform(ast, â€¦) å°† AST è¿›ä¸€æ­¥è½¬æ¢å¤„ç†\n  å°†è½¬æ¢åçš„ ast è°ƒç”¨ codegen çš„ generate æ–¹æ³•ç”Ÿæˆ render ã€‚\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  export function baseCompile(template, options) { const isModuleMode = options.mode === \u0026#34;module\u0026#34;; // ... ç•¥å»é”™è¯¯âå¤„ç†  const prefixIdentifiers = !__BROWSER__ \u0026amp;\u0026amp; (options.prefixIdentifiers === true || isModuleMode); // 1. baseParse å¾—åˆ° AST å¯¹è±¡ï¼Œä¸¤ç§æƒ…å†µï¼š1. æœªè§£æçš„æ¨¡æ¿ï¼Œ2. ä»¥è§£æä¹‹åçš„ ast å¯¹è±¡  const ast = typeof template === \u0026#34;string\u0026#34; ? baseParse(template, options) : template; // 2. å–å‡ºæ‰€æœ‰ node å’Œ directive çš„ transforms  const [nodeTransforms, directiveTransforms] = getBaseTransformPreset( prefixIdentifiers ); // 3. è¿›è¡Œè½¬æ¢ï¼Œè°ƒç”¨ transform  transform(ast, { // åˆå¹¶é€‰é¡¹  ...options, // è°ƒç”¨ baseCompile æ—¶å€™çš„ç¬¬äºŒä¸ªå‚æ•°  prefixIdentifiers, // è¿˜ä¸çŸ¥é“æ˜¯å¹²å•¥çš„???  // èŠ‚ç‚¹è½¬æ¢å™¨åˆå¹¶ï¼Œå¤–éƒ¨è½¬æ¢å™¨ä¼˜å…ˆï¼Œå³ä½¿ç”¨è€…å¯è‡ªå®šä¹‰è‡ªå·±çš„è½¬æ¢å™¨  nodeTransforms: [...nodeTransforms, ...(options.nodeTransforms || {})], // æŒ‡ä»¤è½¬æ¢å™¨ï¼ŒåŒä¸Šã€‚  directiveTransforms: [ ...directiveTransforms, ...(options.directiveTransforms || {}), ], }); // 4. è°ƒç”¨ generate ç”Ÿæˆ render å‡½æ•°çš„ codegen å¹¶è¿”å›ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç»„ä»¶æ¸²  // æŸ“å‡½æ•°  return generate(ast, { ...options, prefixIdentifiers, }); }     è¿™ä¹Ÿæ˜¯é™¤äº†é”™è¯¯å¤„ç†ä¹‹åçš„å®Œæ•´çš„ baseCompile å‡½æ•°å®ç°ã€‚\n  getBaseTransformPreset   getBaseTransformPreset(prefixIdentifiers: boolean)\n åˆå¹¶æ‰€æœ‰ transformï¼Œè¿”å›ä¸€ä¸ª TransformPreset ç±»å‹çš„æ•°ç»„\nstage-2:   å¢åŠ  transformBind æŒ‡ä»¤å¤„ç†ï¼Œå¤„ç† :class = \u0026#34;bar.baz\u0026#34; çš„æ—¶å€™éœ€è¦ç”¨åˆ°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  export function getBaseTransformPreset(prefixIdentifiers) { return [ [ // ... çœç•¥å…¶ä»–ï¼Œç¬¬ä¸€é˜¶æ®µæˆ‘ä»¬åº”è¯¥åªéœ€è¦æ–‡æœ¬è½¬æ¢  transformText, ...(!__BROWSER__ \u0026amp;\u0026amp; prefixIdentifiers ? [transformExpression] : []), transformElement, ], { // ...çœç•¥æŒ‡ä»¤  bind: transformBind, }, ]; }      stage-1: 01-simple text   ç¬¬ä¸€é˜¶æ®µæˆ‘ä»¬åªéœ€è¦æ–‡æœ¬è½¬æ¢ï¼Œé€šè¿‡ ç”¨ä¾‹ä¸€ å³å¯ï¼Œæ‰€ä»¥è¿™é‡Œå°±åªä¿ç•™ transformText å°±å¯ä»¥äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯å»å®ç°å®ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11  export function getBaseTransformPreset(prefixIdentifiers) { return [ [ // ... çœç•¥å…¶ä»–ï¼Œç¬¬ä¸€é˜¶æ®µæˆ‘ä»¬åº”è¯¥åªéœ€è¦æ–‡æœ¬è½¬æ¢  transformText, ], { // ...çœç•¥æŒ‡ä»¤  }, ]; }          tranform.ts  transformExpression   transformExpression(node, context)\n  transformText   transformText(node, context)\n è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªç”¨æ¥è½¬æ¢æ–‡æœ¬èŠ‚ç‚¹ç±»å‹(NodeTransform)çš„å‡½æ•°ã€‚\n è¿”å›å‡½æ•°åˆ†æ(return () =\u0026gt; { ... })ï¼Œä¸»è¦ç”±ä¸‰ä¸ª for æ„æˆï¼š\n  ç¬¬ä¸€ä¸ª for åµŒå¥—ç¬¬äºŒä¸ª for æ„æˆåŒé‡å¾ªç¯ï¼Œç”¨æ¥åˆå¹¶ node.children é‡Œé¢ç›¸é‚»çš„æ–‡æœ¬ èŠ‚ç‚¹\n ç¬¬ä¸€ä¸ª For é‡Œé¢ä½¿ç”¨çš„æ˜¯ children.length åŠ¨æ€è·å–å½“å‰æ•°ç»„çš„é•¿åº¦ï¼Œç»“åˆä»£ç ä¸­çš„ splice å’Œ jâ€“ã€‚ä»è€Œå®Œæˆåˆå¹¶æ“ä½œã€‚\n1 2 3 4 5 6  // 1. åŸæ¥çš„ child è¢«é‡å†™  // 2. child, ` + `, next åˆå¹¶åˆ°äº†æ–° child.children é‡Œé¢  currentContainer.children.push(` + `, next); // åˆ é™¤è¢«åˆå¹¶çš„æ–‡æœ¬èŠ‚ç‚¹  children.splice(j, 1); j--; // -1 æ˜¯å› ä¸ºä¸Šé¢åˆ é™¤äº†å½“å‰å…ƒç´ ï¼Œfor å¾ªç¯è¿‡ç¨‹ä¸­é•¿åº¦æ˜¯åŠ¨æ€è·å–çš„       ç¬¬ä¸‰ä¸ª for éå†ç¬¬ä¸€æ­¥ä¹‹åçš„ childrenï¼Œå¯¹æ¯ä¸ª child è¿›è¡Œé‡å®šä¹‰ï¼Œç±»å‹æ”¹å˜æˆ NodeTyeps.TEXT_CALL ç±»å‹ï¼Œå¢åŠ  codegenNode å±æ€§ã€‚\n   ä»£ç å®Œæ•´ç‰ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111  export const transformText = (node, context) =\u0026gt; { // æ–‡æœ¬è½¬æ¢åªèƒ½æ˜¯ä¸‹é¢å››ç§ç±»å‹  const validTypes = [ NodeTypes.ROOT, NodeTypes.ELEMENT, NodeTypes.FOR, NodeTypes.IF_BRANCH, ]; // åˆæ³•ç±»å‹æ£€æµ‹  if (validTypes.indexOf(node.type)) { // è¿”å›ä¸€ä¸ªå¯æ‰§è¡Œå‡½æ•°ï¼Œè®°å¾—åœ¨ transformNode å—ï¼Œè¿™ä¸ªè¿”å›çš„å‡½æ•°  // å°†ä¼šè¢«å®ƒåœ¨ while ä¸­ æ‰§è¡Œ æ‰ã€‚  return () =\u0026gt; { const children = node.children; let currentContainer = undefined; let hasText = false; // åŒé‡å¾ªç¯ï¼Œåˆå¹¶æ‰€æœ‰ç›¸é‚»çš„æ–‡æœ¬èŠ‚ç‚¹  // å¦‚ï¼š[text1, text2, element, text3, ele, text4, text5]  // text1 å’Œ text2 ä¼šåˆå¹¶åˆ°text1  // text3 ä¸ä¼šåˆå¹¶  // text4 å’Œ text5 ä¼šè¢«åˆå¹¶  for (let i = 0; i \u0026lt; children.length; i++) { const child = children[i]; if (isText(child)) { // TODO æ–‡æœ¬èŠ‚ç‚¹æ‰è¿›è¡Œè§£æ  hasText = true; // åˆå¹¶ç›¸é‚»çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œ text1 + text2  for (let j = i + 1; j \u0026lt; children.length; j++) { const next = children[j]; // ä¸‹ä¸€ä¸ªä¹Ÿæ˜¯æ–‡æœ¬èŠ‚ç‚¹çš„æ—¶å€™ï¼Œè¦å°†ä¸¤è€…åˆå¹¶  if (isText(next)) { if (!currentContainer) { // è¿™é‡Œç­‰äºé‡å†™äº† child çš„å¼•ç”¨ï¼Œå°†è‡ªèº« push åˆ°äº†  // æ–°ç»“æ„ä¸­çš„ children  currentContainer = children[i] = { type: NodeTypes.COMPOUND_EXPRESSION, loc: child.loc, children: [child], }; } // 1. åŸæ¥çš„ child è¢«é‡å†™  // 2. child, ` + `, next åˆå¹¶åˆ°äº†æ–° child.children é‡Œé¢  currentContainer.children.push(` + `, next); // åˆ é™¤è¢«åˆå¹¶çš„æ–‡æœ¬èŠ‚ç‚¹  children.splice(j, 1); j--; // -1 æ˜¯å› ä¸ºä¸Šé¢åˆ é™¤äº†å½“å‰å…ƒç´ ï¼Œfor å¾ªç¯è¿‡ç¨‹ä¸­é•¿åº¦æ˜¯åŠ¨æ€è·å–çš„  } else { currentContainer = undefined; break; } } } } // é›†ä¸­ä¸æ»¡è¶³è½¬æ¢æ¡ä»¶çš„æƒ…å†µ  if ( // 1. æ²¡æœ‰æ–‡æœ¬å†…å®¹  // 2. åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹  // 2.1 ç»„ä»¶æ ¹èŠ‚ç‚¹  // 2.2 \u0026lt;element\u0026gt; å…ƒç´ èŠ‚ç‚¹  !hasText || (children.length === 1 \u0026amp;\u0026amp; (node.type === NodeTypes.ROOT || (node.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; node.tagType === ElementTypes.ELEMENT))) ) { return; } // å¼€å§‹è½¬æ¢  for (let i = 0; i \u0026lt; children.length; i++) { const chld = children[i]; if (isText(child) || child.type === NodeTypes.COMPOUND_EXPRESSION) { const callArgs = []; // éæ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥ push æ‰ï¼Œè¿™é‡Œ child.content !== \u0026#39; \u0026#39; çš„åŸå› åœ¨äº  // parseChildren é‡Œé¢ while å¾ªç¯æœ€åæœ‰ä¸ªremove whitespace æ“ä½œ  // ä¼šå°†æœ‰æ•ˆçš„ç©ºèŠ‚ç‚¹è½¬æˆä¸€ä¸ªç©ºæ ¼çš„å­—ç¬¦ä¸²ã€‚  // createTextVNode é»˜è®¤æ˜¯ä¸€ä¸ªå•ç©ºæ ¼  if (child.type !== NodeTypes.TEXT || child.content !== \u0026#34; \u0026#34;) { callArgs.push(child); } // éæœåŠ¡ç«¯æ¸²æŸ“ï¼Œä¸”éæ–‡æœ¬èŠ‚ç‚¹  if (!context.ssr \u0026amp;\u0026amp; child.type !== NodeTypes.TEXT) { callArgs.push( // TODO è¿™ä¸ªæ˜¯å¹²å˜›çš„ï¼Ÿï¼Ÿï¼Ÿ  `${PatchFlags.TEXT}/* ${PatchFlagNames[PatchFlags.TEXT]}*/` ); } children[i] = { type: NodeTypes.TEXT_CALL, // æ–‡æœ¬å‡½æ•°  content: child, loc: child.loc, codegenNode: createCallExpression( context.helper(CREATE_TEXT), callArgs ), }; } } }; } }     ä½¿ç”¨åˆ°çš„å¤–é¢å‡½æ•°å’Œå±æ€§ï¼š\n  CREATE_TEXTï¼š ä¸€ä¸ªç¬¦å·å±æ€§ export const CREATE_TEXT = Symbol(__DEV__ ? `createTextVNode` : ``);\n  createCallExpression(callee, args, loc) è¿”å› JS_CALL_EXPRESSION ç±»å‹å¯¹è±¡ã€‚\n  PatchFlags å’Œ PatchFlagNames ä¸€ä¸ªåå­—æ˜ å°„\n  isText æ–‡æœ¬èŠ‚ç‚¹ç±»å‹(æ’å€¼å’Œ text)\n1 2 3 4  export function isText(node) { // æ’å€¼æˆ– text å‡è§†ä¸ºæ–‡æœ¬  return node.type === NodeTypes.INTERPOLATION || node.type === NodeTypes.TEXT; }       å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹åˆ›å»ºå‡½æ•°ï¼š createTextVNode\n  transform   transform(root, options)\n è°ƒç”¨çš„å‡½æ•°ï¼š\n  createTransformContext(root, options) åˆ›å»º transform è½¬æ¢å™¨ç±»å‹çš„ä¸Šä¸‹æ–‡å¯¹è±¡\n  traverseNode(root, context) éå†æ‰€æœ‰èŠ‚ç‚¹\n  ssr æœåŠ¡ç«¯æ¸²æŸ“å¤„ç†\n  åˆå§‹åŒ– root æ ¹èŠ‚ç‚¹ä¸Šçš„ä¸€äº›å±æ€§\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  export function transform(root, options) { const context = createTransformContext(root, options); traverseNode(root, context); if (options.hoistStatic) { hoistStatic(root, context); } // ... ssr å¤„ç†  // root å±æ€§åˆå¹¶ï¼Œåˆå§‹åŒ–  root.helpers = [...context.helpers]; root.components = [...context.components]; root.directives = [...context.directives]; root.imports = [...context.imports]; root.hoists = context.hoists; root.temps = context.temps; root.cached = context.cached; }      transformElement   transformElement(node, context)\nstage-2   stage-1 03-inerpolation in pure div  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99  export const transformElement = (node, context) =\u0026gt; { if ( !( // é¦–å…ˆå¿…é¡»æ˜¯ ELEMENT ç±»å‹  ( node.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; // ç„¶åæ˜¯æ ‡ç­¾ç±»å‹ä¸º element æˆ–è€…æ˜¯ component ç»„ä»¶  (node.tagType === ElementTypes.ELEMENT || node.tagType === ElementTypes.COMPONENT) ) ) ) { return; } return function postTransformElement() { const { tag, props } = node; const isComponent = node.tagType === ElementTypes.COMPONENT; // è™šæ‹ŸèŠ‚ç‚¹çš„ tag ç±»å‹ï¼Œtest-03 ç›´æ¥è¿”å› `div`  const vnodeTag = isComponent ? resolveComponentType(node, context) : `\u0026#34;${tag}\u0026#34;`; // æ˜¯ä¸æ˜¯åŠ¨æ€ç»„ä»¶  const isDynamicComponent = typeof vnodeTag === \u0026#34;object\u0026#34; \u0026amp;\u0026amp; vnodeTag.callee === RESOLVE_DYNAMIC_COMPONENT; // TODO ... å£°æ˜ä¸€äº›å˜é‡  let vnodeProps; let vnodeChildren; let vnodePatchFlag; let patchFlag = 0; let vnodeDynamicProps; let dynamicPropNames; let vnodeDirectives; // TODO shouldUseBlock  let shouldUseBlock = false; if (props.length \u0026gt; 0) { // TODO  } if (node.children.length \u0026gt; 0) { if (vnodeTag === KEEP_ALIVE) { // TODO KeepAlive  } const shouldBuildAsSlots = isComponent \u0026amp;\u0026amp; // Teleport å¹¶éçœŸå®çš„ç»„ä»¶ï¼Œä¸”ä¸“ç”¨äºè¿è¡Œæ—¶å¤„ç†  vnodeTag !== TELEPORT \u0026amp;\u0026amp; vnodeTag !== KEEP_ALIVE; // è¿™æ®µ if...else if ...else ç›®çš„æ˜¯å¾—åˆ° vnodeChildren  if (shouldBuildAsSlots) { // TODO  } else if (node.children.length === 1 \u0026amp;\u0026amp; vnodeTag !== TELEPORT) { const child = node.children[0]; const type = child.type; // åŠ¨æ€æ–‡æœ¬å­©å­èŠ‚ç‚¹æ£€æµ‹  const hasDynamicTextChild = type === NodeTypes.INTERPOLATION || type === NodeTypes.COMPOUND_EXPRESSION; if (hasDynamicTextChild \u0026amp;\u0026amp; !getStaticType(child)) { patchFlag |= PatchFlags.TEXT; } if (hasDynamicTextChild || type === NodeTypes.TEXT) { vnodeChildren = child; } else { vnodeChildren = node.children; } } else { vnodeChildren = node.children; } } // TODO patchFlag \u0026amp; dynamicPropNames  node.codegenNode = createVNodeCall( context, vnodeTag, vnodeProps, vnodeChildren, vnodePatchFlag, vnodeDynamicProps, vnodeDirectives, !!shouldUseBlock, false /* isForBlack */, node.loc ); }; }     è¿›å…¥ createVNodeCall æ—¶çš„å‚æ•°å€¼ï¼š\n  è¿™é‡Œä¼šå°†ä¸€äº›éœ€è¦ç”¨åˆ°çš„å‡½æ•°æ·»åŠ åˆ° context.helpers:Set ä¸­ç­‰å¾…è§£æ„ï¼š\n è¯¥ç”¨ä¾‹ä¸­ä¼šæœ‰ CREATE_VNODE è¢«è§£æ„å‡ºæ¥ã€‚\n    transformBind   transformBind(prop, node, context)\n æŒ‡ä»¤ä¹Ÿå±äºå±æ€§ä¸€ç§ï¼Œæ‰€ä»¥å®ƒçš„å¤„ç†æºå¤´æ˜¯åœ¨ transformElement é‡Œé¢ã€‚\n è¿™é‡Œåªä¸è¿‡æ˜¯æä¾›äº† v-bind å¤„ç†æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  export const transformBind = (dir, node, context) =\u0026gt; { const { exp, modifiers, loc } = dir; const arg = dir.arg; // TODO é”™è¯¯å¤„ç†  if (modifiers.includes(\u0026#34;camel\u0026#34;)) { if (arg.type === NodeTypes.SIMPLE_EXPRESSION) { if (arg.isStatic) { // æ¨ªçº¿ è½¬é©¼å³°å¼  arg.content = camelize(arg.content); } else { arg.content = `${context.helperString(CAMELIZE)}(${arg.content})`; } } else { arg.children.unshift(`${context.helperString(CAMELIZE)}(`); arg.children.push(`)`); } } return { props: [ createObjectProperty(arg, exp || createSimpleExpression(\u0026#34;\u0026#34;, true, loc)), ], }; };      transformIf()   è¿™ä¸ªå‡½æ•°æ˜¯ç”±ä¸€ç³»åˆ—çš„æ“ä½œä¹‹åæ‰è¿”å›çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥å¤„ç† /^(if|else|else-if)$/ æŒ‡ä»¤ï¼Œç”Ÿæˆå¯¹åº”åˆ†æ”¯èŠ‚ç‚¹çš„ codegenNode ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  export const transformIf = createStructuralDirectiveTransform( /^(if|else|else-if)$/, (node, dir, context) =\u0026gt; { return processIf(node, dir, context, (ifNode, branch, isRoot) =\u0026gt; { // èƒ½åˆ°è¿™é‡Œè¯´æ˜ v-if ä¸‹æ‰€æœ‰çš„ child éƒ½å·²ç»å¤„ç†å®Œæ¯•ï¼Œå¯ä»¥è¿”å›å¤„ç†  // codegenNode çš„å‡½æ•°äº†  return () =\u0026gt; { console.log({ dir, isRoot }); if (isRoot) { ifNode.codegenNode = createCodegenNodeForBranch(branch, 0, context); } else { // å°†å½“å‰åˆ†æ”¯çš„codegenNodeæŒ‚è½½åˆ° v-if æ ¹èŠ‚ç‚¹ä¸Š  let parentCondition = ifNode.codegenNode; while ( parentCondition.alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION ) { // è¿™ä¸ªå¾ªç¯çš„ç›®çš„æ˜¯ä¸ºäº†æ‰¾åˆ°æœ€åé‚£ä¸ªéœ€è¦è¢«æ›¿æ¢çš„ alternate èŠ‚ç‚¹  // å› ä¸ºæœ‰å¯èƒ½ä¼šæœ‰ `?:` åµŒå¥—çš„å¯èƒ½  // å¦‚ï¼š ok ? expr1 : expr2 æƒ…å†µæ‰¾åˆ°çš„æ˜¯ expr2 éœ€è¦è¢«æ›¿æ¢  // å¦‚ï¼š ok ? expr1 : (ok2 ? expr2 : expr3) é‚£ä¹ˆæ‰¾åˆ°çš„å°±æ˜¯ expr3  // ...  // å› ä¸ºæœ€åä¸€ä¸ª `:` åé¢çš„è¡¨è¾¾å¼å¦‚æœæ²¡æœ‰ else åº”è¯¥ä¼šæ˜¯ä¸ª  // comment vnodeç±»å‹çš„å ä½èŠ‚ç‚¹  parentCondition = parentCondition.alternate; } parentCondition.alternate = createCodegenNodeForBranch( branch, ifNode.branches.length - 1, context ); } }; }); } )      createCodegenNodeForBranch   createCodegenNodeForBranch(branch, index, context)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function createCodegenNodeForBranch(branch, index, context) { if (branch.condition) { return createConditionalExpression( branch.condition, createChildrenCodegenNode(branch, index, context), createCallExpression(context.helper(CREATE_COMMENT), [ __DEV__ ? \u0026#39;\u0026#34;v-if\u0026#34;\u0026#39; : \u0026#39;\u0026#34;\u0026#34;\u0026#39;, \u0026#34;true\u0026#34;, ]) ); } else { return createChildrenCodegenNode(branch, index, context); } }      createChildrenCodegenNode   createChildrenCodegenNode(branch, index, context)\nstage-1 05-interpolation, v-if, props   è¯¥é˜¶æ®µåªå®Œæˆä¸€ä¸ªå­©å­èŠ‚ç‚¹ä¸”æ˜¯ ELEMENT ç±»å‹çš„æ—¶å€™å¤„ç†ï¼Œå¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µæ˜¯éœ€è¦ç”¨ fragment å°†è¿™äº› children åŒ…èµ·æ¥çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  // åˆ›å»º v-if åˆ†æ”¯çš„å­©å­èŠ‚ç‚¹ï¼ŒåŒæ—¶åŠ ä¸Š key å±æ€§  function createChildrenCodegenNode(branch, index, context) { const { helper } = context; const keyProperty = createObjectProperty( `key`, createSimpleExpression(index + ``, false) ); const { children } = branch; const firstChild = children[0]; // å¤šä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ç”¨ fragment åŒ…èµ·æ¥  const needFragmentWrapper = children.length !== 1 || firstChild.type !== NodeTypes.ELEMENT; if (needFragmentWrapper) { // TODO  } else { // åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ä¸”æ˜¯ ELEMENT  const vnodeCall = firstChild.codegenNode; if ( vnodeCall.type === NodeTypes.VNODE_CALL \u0026amp;\u0026amp; // ç»„ä»¶çš„ vnodes æ€»æ˜¯è¢«è¿½è¸ªä¸”å®ƒçš„å­©å­ä»¬ä¼šè¢«ç¼–è¯‘è¿›  // slots å› æ­¤æ²¡å¿…è¦å°†å®ƒå˜æˆä¸€ä¸ª block  (firstChild.tagType !== ElementTypes.COMPONENT || vnodeCall.tag === TELEPORT) ) { // TODO  vnodeCall.isBlock = true; helper(OPEN_BLOCK); helper(CREATE_BLOCK); } injectProp(vnodeCall, keyProperty, context); return vnodeCall; } }        createTransformContext   createTransformContext(root, options)\n å•çº¯çš„æ„å»ºå’Œåˆå§‹åŒ– transform è½¬æ¢å™¨ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚\nstage-1: 01 simple text   ä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œå¹¶ä¸éœ€è¦å…·ä½“å®ç°ä»€ä¹ˆï¼Œçº¯æ–‡æœ¬å¹¶æ²¡æœ‰ç”¨åˆ°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68  export function createTransformContext( root, { prefixIdentifiers = false, hoistStatic = false, cacheHandlers = false, nodeTransforms = [], directiveTransforms = {}, transformHoist = null, isBuiltInComponent = NOOP, expressionPlugins = [], scopeId = null, ssr = false, onError = defaultOnError, } ) { const context = { // options  prefixIdentifiers, hoistStatic, cacheHandlers, nodeTransforms, directiveTransforms, transformHoist, isBuiltInComponent, expressionPlugins, scopeId, ssr, onError, // state  root, helpers: new Set(), components: new Set(), directives: new Set(), hoists: [], imports: new Set(), temps: 0, cached: 0, identifiers: {}, scopes: { vFor: 0, vSlot: 0, vPre: 0, vOnce: 0, }, parent: null, currentNode: root, childIndex: 0, // methods  helper(name) {}, helperString(name) {}, replaceNode(node) {}, removeNode(node) {}, onNodeRemoved: () =\u0026gt; {}, addIdentifiers(exp) {}, removeIdentifiers(exp) {}, hoist(exp) {}, cache(exp, isVNode = false) {}, }; function addId(id) {} function removeId(id) {} return context; }      stage-2: 02 pure interpolation æ’å€¼èŠ‚ç‚¹çš„ç¼–è¯‘  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  export function createTransformContext( root, { ... } ) { const context = { // ...  helpers: new Set(), // ...  // æ–°å¢ helper å®ç°  helper(name) { context.helpers.add(name); return name; }, // ...  }; function addId(id) {} function removeId(id) {} return context; }        createRootCodegen   createRootCodegen(root, context)\n åˆ›å»º root èŠ‚ç‚¹ä¸Šçš„ codegenNode å€¼ï¼Œè¿™ä¹Ÿæ˜¯å°†æ¥ç”¨æ¥ç¼–è¯‘æˆ render å‡½æ•°çš„æºç å­—ç¬¦ä¸²ã€‚\nstage-1: 01 simple text  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  function createRootCodegen(root, context) { // TODO helper  const { children } = root; const child = children[0]; if (children.length === 1) { // åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹  // ä¸”å­©å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå…ƒç´  element ç±»å‹ï¼Œå°†å®ƒæ”¾åœ¨ä¸€ä¸ªä»£ç å—é’Ÿè¿”å›  // å¦‚ï¼š { code }  if (isSingleElementRoot(root, child) \u0026amp;\u0026amp; child.codegenNode) { // TODO  } else { root.codegenNode = child; } } else if (children.length \u0026gt; 1) { } else { // æ²¡æœ‰å­©å­èŠ‚ç‚¹ï¼Œ codegen è¿”å› nullï¼Œçœ‹åˆ°æ²¡  // 01 simple text è¿”å› null é—®é¢˜æ‰¾åˆ°æ ¹æºäº†  } }     å®ç°å®Œè¿™ä¸ªä¹‹åå‘ç°ï¼Œgenerate é‡Œé¢çš„ genNode è¿˜æ²¡å®ç°ï¼ŒçœŸå®ä¸¢ä¸‰è½å››~~~~ã€‚\n    createStructuralDirectiveTransform   createStructuralDirectiveTransform(name, fn)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  function createStructuralDirectiveTransform(name, fn) { const matches = isString(name) ? (n) =\u0026gt; n === name : (n) =\u0026gt; name.test(n); return (node, context) =\u0026gt; { if (node.type === 1 /* ELEMENT */) { const { props } = node; // structural directive transforms are not concerned with slots  // as they are handled separately in vSlot.ts  if (node.tagType === 3 /* TEMPLATE */ \u0026amp;\u0026amp; props.some(isVSlot)) { return; } const exitFns = []; for (let i = 0; i \u0026lt; props.length; i++) { const prop = props[i]; if (prop.type === 7 /* DIRECTIVE */ \u0026amp;\u0026amp; matches(prop.name)) { // structural directives are removed to avoid infinite recursion  // also we remove them *before* applying so that it can further  // traverse itself in case it moves the node around  props.splice(i, 1); i--; const onExit = fn(node, prop, context); if (onExit) exitFns.push(onExit); } } return exitFns; } }; }      traverseNode   traverseNode(node, context)\nstage-1: 01 simple text çœç•¥ switch é‡Œé¢çš„ä¸Šçº¿ï¼Œå› ä¸ºè¿™é‡Œåªæ˜¯çº¯æ–‡æœ¬ä¸å† case èŒƒå›´ã€‚  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  export function traverseNode(node, context) { context.currentNode = node; const { nodeTransforms } = context; const exitFns = []; for (let i = 0; i \u0026lt; nodeTransforms.length; i++) { // è°ƒç”¨è¯¸å¦‚ transformText çš„å‡½æ•°  const onExit = nodeTransforms[i](node, context); if (onExit) { const fns = Array.isArray(onExit) ? onExit : [onExit]; exitFns.push(...fns); } if (!context.currentNode) { // å¯èƒ½è¢«ç§»é™¤äº†  return; } else { // èŠ‚ç‚¹å¯èƒ½è¢«æ›¿æ¢è¿‡ï¼Œé‡æ–°å»ºç«‹å¼•ç”¨  node = context.currentNode; } } switch (node.type) { // ... çœç•¥  case NodeTypes.ROOT: traverseChildren(node, context); break; } let i = exitFns.length; // æ‰§è¡Œæ‰€æœ‰è½¬æ¢  while (i--) { exitFns[i](); } }      stage-2: 02 pure interpolation æ’å€¼èŠ‚ç‚¹çš„ç¼–è¯‘   å¢åŠ  INTERPOLATION ç±»å‹èŠ‚ç‚¹åˆ†æ”¯å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  export function traverseNode(node, context) { // ...  switch (node.type) { // ...  // æ–°å¢ï¼šå¯¹æ’å€¼ç±»å‹èŠ‚ç‚¹å¤„ç†  case NodeTypes.INTERPOLATION: if (!context.ssr) { // è¿™ä¸ªå‡½æ•°æ¥è‡ªä¸Šä¸‹æ–‡å¤„ç†ä¸­çš„ helper(name)  context.helper(TO_DISPLAY_STRING); } break // ...  } // ...  }     ä¿®æ”¹ä¹‹åä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  export function traverseNode(node, context) { context.currentNode = node; const { nodeTransforms } = context; const exitFns = []; for (let i = 0; i \u0026lt; nodeTransforms.length; i++) { // è°ƒç”¨è¯¸å¦‚ transformText çš„å‡½æ•°  const onExit = nodeTransforms[i](node, context); if (onExit) { const fns = Array.isArray(onExit) ? onExit : [onExit]; exitFns.push(...fns); } if (!context.currentNode) { // å¯èƒ½è¢«ç§»é™¤äº†  return; } else { // èŠ‚ç‚¹å¯èƒ½è¢«æ›¿æ¢è¿‡ï¼Œé‡æ–°å»ºç«‹å¼•ç”¨  node = context.currentNode; } } switch (node.type) { // ... çœç•¥  case NodeTypes.INTERPOLATION: if (!context.ssr) { // è¿™ä¸ªå‡½æ•°æ¥è‡ªä¸Šä¸‹æ–‡å¤„ç†ä¸­çš„ helper(name)  context.helper(TO_DISPLAY_STRING); } break; case NodeTypes.ROOT: traverseChildren(node, context); break; } let i = exitFns.length; // æ‰§è¡Œæ‰€æœ‰è½¬æ¢  while (i--) { exitFns[i](); } }      stage-3: 05-interpolation, v-if, props   å¢åŠ  IF å’Œ IF_BRANCH åˆ†æ”¯å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  export function traverseNode(node, context) { context.currentNode = node; const { nodeTransforms } = context; const exitFns = []; for (let i = 0; i \u0026lt; nodeTransforms.length; i++) { // è°ƒç”¨è¯¸å¦‚ transformText çš„å‡½æ•°  const onExit = nodeTransforms[i](node, context); if (onExit) { const fns = Array.isArray(onExit) ? onExit : [onExit]; exitFns.push(...fns); } if (!context.currentNode) { // å¯èƒ½è¢«ç§»é™¤äº†  return; } else { // èŠ‚ç‚¹å¯èƒ½è¢«æ›¿æ¢è¿‡ï¼Œé‡æ–°å»ºç«‹å¼•ç”¨  node = context.currentNode; } } switch (node.type) { // ... çœç•¥  case NodeTypes.INTERPOLATION: if (!context.ssr) { // è¿™ä¸ªå‡½æ•°æ¥è‡ªä¸Šä¸‹æ–‡å¤„ç†ä¸­çš„ helper(name)  context.helper(TO_DISPLAY_STRING); } break; case NodeTypes.IF: for (let i = 0; i \u0026lt; node.branches.length; i++) { traverseNode(node.branches[i], context); } break; case NodeTypes.IF_BRANCH: case NodeTypes.ELEMENT: case NodeTypes.ROOT: traverseChildren(node, context); break; } let i = exitFns.length; // æ‰§è¡Œæ‰€æœ‰è½¬æ¢  while (i--) { exitFns[i](); } }        TODO createIfBranch(â€¦)   traverseChildren   traverseChildren(parent, context)\n å¤„ç† node.children å­©å­èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  export function traverseChildren(parent, context) { let i = 0; const nodeRemoved = () =\u0026gt; { i--; }; for (; i \u0026lt; parent.children.length; i++) { const child = parent.children[i]; // è¿‡ç•¥æ‰å­—ç¬¦ä¸²ï¼Œåªå¤„ç† ast child  if (typeof child === \u0026#34;string\u0026#34;) continue; context.parent = parent; context.childIndex = i; context.onNodeRemoved = nodeRemoved; traverseNode(child, context); } }      éå†æ‰€æœ‰ ast ï¼Œè®©æ¯ä¸ªèŠ‚ç‚¹æŒæœ‰è‡ªçˆ¶çº§å¼•ç”¨ã€‚\n  éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¿›è¡Œ traverseNodeï¼Œè§£æå‡º codegenNode å€¼\n    buildProps   buildProps(node, context, props = node.props, ssr = false)\nstage-1 05-interpolation, v-if, props  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135  export function buildProps(node, context, props = node.props, ssr = false) { const { tag, loc: elementLoc } = node; const isComponent = node.tagType === ElementTypes.COMPONENT; let properties = []; // ä¿å­˜åˆå¹¶ä¹‹åçš„å±æ€§ï¼Œå‰ææ˜¯æœ‰é‡å¤å±æ€§ï¼Œæ¯”å¦‚ï¼š  // class,style ä¼šåˆå¹¶æˆä¸€ä¸ª  // v-on çš„ handlers ä¼šåˆå¹¶æˆæ•°ç»„  const mergeArgs = []; const runtimeDirectives = []; let patchFlag = 0; let hasRef = false; let hasClassBinding = false; let hasStyleBinding = false; let hasHydrationEventBinding = false; let hasDynamicKeys = false; const dynamicPropNames = []; const analyzePatchFlag = ({ key, value }) =\u0026gt; { if (key.type === NodeTypes.SIMPLE_EXPRESSION \u0026amp;\u0026amp; key.isStatic) { const name = key.content; // TODO v-on  if ( value.type === NodeTypes.JS_CACHE_EXPRESSION || ((value.type === NodeTypes.SIMPLE_EXPRESSION || value.type === NodeTypes.COMPOUND_EXPRESSION) \u0026amp;\u0026amp; getStaticType(value) \u0026gt; 0) ) { // å¦‚æœ prop æ˜¯ä¸€ä¸ª cached handler æˆ–è€…æœ‰ä¸€ä¸ªå¸¸é‡å€¼ï¼Œå°±å¿½ç•¥  return; } if (name === \u0026#34;ref\u0026#34;) { hasRef = true; } else if (name === \u0026#34;class\u0026#34; \u0026amp;\u0026amp; !isComponent) { hasClassBinding = true; } // TODO style, åŠ¨æ€å±æ€§å  } else { hasDynamicKeys = true; } }; for (let i = 0; i \u0026lt; props.length; i++) { // é™æ€å±æ€§  const prop = props[i]; if (prop.type === NodeTypes.ATTRIBUTE) { const { loc, name, value } = prop; // TODO hasRef  // TODO skip \u0026lt;component :is=\u0026#34;...\u0026#34;\u0026gt;  // å¤„ç†é™æ€å±æ€§  properties.push( createObjectProperty( createSimpleExpression( name, true, getInnerRange(loc, 0, name.length) ), createSimpleExpression( value ? value.content : \u0026#34;\u0026#34;, true, value ? value.loc : loc ) ) ); } else { // DIRECTIVE æŒ‡ä»¤å¤„ç†  // name æŒ‡ä»¤å, arg æŒ‡ä»¤å‚æ•°ï¼Œexp æŒ‡ä»¤è¡¨è¾¾å¼  const { name, arg, exp, loc } = prop; const isBind = name === \u0026#34;bind\u0026#34;; // TODO v-slot  // TODO v-once  // TODO v-is æˆ– :is + \u0026lt;component\u0026gt;  // TODO isOn \u0026amp;\u0026amp; ssr  // TODO v-bind å’Œ v-on æ²¡æœ‰å‚æ•°æƒ…å†µ  // å–å‡ºå¯¹åº”çš„ transform å‡½æ•°å¤„ç†ï¼Œæ¯”å¦‚ï¼šv-bind å¯¹åº” transformBind  const directiveTransform = context.directiveTransforms[name]; if (directiveTransform) { const { props, needRuntime } = directiveTransform(prop, node, context); !ssr \u0026amp;\u0026amp; props.forEach(analyzePatchFlag); properties.push(...props); // TODO needRuntime  } else { // TODO æ²¡æœ‰å†…ç½® transformï¼Œè¡¨ç¤ºè¯¥æŒ‡ä»¤æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„  // runtimeDirectives.push(prop)  } } } let propsExpression = undefined; // TODO v-bind=\u0026#34;object\u0026#34; æˆ– v-on=\u0026#34;object\u0026#34;  // åˆå¹¶å±æ€§  if (mergeArgs.length) { // TODO merge args  } else if (properties.length) { propsExpression = createObjectExpression( dedupeProperties(properties), elementLoc ); } // patchFlag åˆ†æ  if (hasDynamicKeys) { // TODO  } else { if (hasClassBinding) { patchFlag |= PatchFlags.CLASS; } // TODO å…¶ä»–, style, åŠ¨æ€å±æ€§ï¼Œhydration  } // TODO need_patch  return { props: propsExpression, directives: runtimeDirectives, patchFlag, dynamicPropNames, }; }        hoistStatic   hoistStatic(root, context)\n1 2 3 4 5 6 7 8 9  // é™æ€æå‡ï¼Œå°†é™æ€æ–‡æœ¬èŠ‚ç‚¹æå‡å—ï¼Ÿï¼Ÿï¼Ÿ  export function hoistStatic(root, context) { walk( root.children, context, new Map(), isSingleElementRoot(root, root.children[0]) ); }      walk   walk(children, context, resultCache, doNotHoistNode = false)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80  function walk(children, context, resultCache, doNotHoistNode = false) { let hasHoistedNode = false; let hasRuntimeConstant = false; for (let i = 0; i \u0026lt; children.length; i++) { const child = children[i]; if ( child.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; child.tagType === ElementTypes.ELEMENT ) { let staticType; if ( !doNotHoistNode \u0026amp;\u0026amp; (staticType === getStaticType(child, resultCache)) \u0026gt; 0 ) { if (staticType === StaticType.HAS_RUNTIME_CONSTANT) { hasRuntimeConstant = true; } // æ•´ä¸ªæ ‘éƒ½æ˜¯é™æ€çš„  child.codegenNode.patchFlag = PatchFlags.HOISTED + (__DEV__ ? ` /* HOISTED */` : ``); child.codegenNode = context.hoist(child.codegenNode); hasHoistedNode = true; continue; } else { // èŠ‚ç‚¹åŒ…å«åŠ¨æ€å­©å­èŠ‚ç‚¹ï¼Œä½†æ˜¯å®ƒçš„å±æ€§å¯èƒ½ç¬¦åˆ hoisting æ¡ä»¶  const codegenNode = child.codegenNode; if (codegenNode.type === NodeTypes.VNODE_CALL) { const flag = getPatchFlag(codegenNode); if ( (!flag || flag === PatchFlags.NEED_PATCH || flag === PatchFlags.TEXT) \u0026amp;\u0026amp; !hasDynamicKeyOrRef(child) \u0026amp;\u0026amp; !hasCachedProps(child) ) { const props = getNodeProps(child); if (props) { codegenNode.props = context.hoist(props); } } } } } else if (child.type === NodeTypes.TEXT_CALL) { const staticType = getStaticType(child.content, resultCache); if (staticType \u0026gt; 0) { if (staticType === StaticType.HAS_RUNTIME_CONSTANT) { hasRuntimeConstant = true; } child.codegenNode = context.hoist(child.codegenNode); hasHoistedNode = true; } } // é€’å½’å­©å­èŠ‚ç‚¹  if (child.type === NodeTypes.ELEMENT) { walk(child.children, context, resultCache); } else if (child.type === NodeTypes.FOR) { // ä¸æå‡ v-for å•å­©å­èŠ‚ç‚¹å› ä¸ºå®ƒä¼šå˜æˆä¸€ä¸ª block  walk(child.children, context, resultCache, child.children.length === 1); } else if (child.type === NodeTypes.IF) { for (let i = 0; i \u0026lt; child.branches.length; i++) { const branchChildren = child.branches[i].children; // ä¸æå‡ v-if å•å­©å­èŠ‚ç‚¹å› ä¸ºå®ƒä¼šå˜æˆä¸€ä¸ª block  walk(branchChildren, context, resultCache, branchChildren.length === 1); } } } if (!hasRuntimeConstant \u0026amp;\u0026amp; hasHoistedNode \u0026amp;\u0026amp; context.transformHoist) { context.transformHoist(children, context); } }      processIf   processIf(node, dir, context, processCodegen)\n å¤„ç† v-if/v-else/v-else-if æŒ‡ä»¤çš„å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  export function processIf(node, dir, context, processCodegen) { // TODO no exp error handle  // TODO prefixIdentifiers \u0026amp;\u0026amp; dir.exp  if (dir.name === \u0026#34;if\u0026#34;) { const branch = createIfBranch(node, dir); const ifNode = { type: NodeTypes.IF, loc: node.loc, branches: [branch], }; context.replaceNode(ifNode); if (processCodegen) { return processCodegen(ifNode, branch, true); } } else { // æ‰¾åˆ°å¯¹åº”çš„å…„å¼ŸèŠ‚ç‚¹(v-if)  const siblings = context.parent.children; const comments = []; // å½“å‰åˆ†æ”¯èŠ‚ç‚¹åœ¨å…¶çˆ¶èŠ‚ç‚¹çš„ children ä¸­çš„ä½ç½®  // æ–¹ä¾¿åé¢æ‰¾åˆ°å‰é¢æœ€è¿‘çš„é‚£ä¸ªå…„å¼Ÿ  let i = siblings.indexOf(node); while (i-- \u0026gt;= -1) { const sibling = siblings[i]; if (__DEV__ \u0026amp;\u0026amp; sibling \u0026amp;\u0026amp; sibling.type === NodeTypes.COMMENT) { context.removeNode(sibling); // å°†æ¥è¦åˆå¹¶å›å»çš„  comments.unshift(sibling); continue; } if (sibling \u0026amp;\u0026amp; sibling.type === NodeTypes.IF) { // 1. å°†å½“å‰èŠ‚ç‚¹åˆ é™¤åŒæ—¶å°†ç§»åŠ¨åˆ° if åˆ†æ”¯çš„ branches[] ä¸­å»  context.removeNode(); if (__DEV__ \u0026amp;\u0026amp; comments.length) { branch.children = [...comments, ...branch.children]; } sibling.branches.push(branch); // è¿™ä¸ª onExit å°±æ˜¯ç”¨æ¥ transform åˆ†æ”¯å¾—åˆ°codegenNodeçš„é‚£ä¸ªå‡½æ•°  const onExit = processCodegen \u0026amp;\u0026amp; processCodegen(sibling, branch, false); // 2. å› ä¸º 1 ä¸­å·²ç»å°†èŠ‚ç‚¹ä»ä¸»å¹²é€’å½’æ ‘ç§åˆ é™¤äº†ï¼Œå› æ­¤è¿™é‡Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡  // traverse ç¡®ä¿è¯¥åˆ†æ”¯èŠ‚ç‚¹çš„æ ‘èƒ½æ­£ç¡®è§£æå‡º codgenNode  traverseNode(branch, context); // 3. æ‰§è¡Œ transform å‡½æ•°ï¼Œè§£æå½“å‰èŠ‚ç‚¹çš„ codegenNode  if (onExit) onExit(); // 4. é‡ç½® currentNodeï¼Œè¡¨æ˜è¯¥èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤äº†  // è¿˜è®°å¾— traverseNode é‡Œé¢æ”¶é›† exitFns å¾ªç¯æ‰¾é‚£ä¸ªæœ‰ä¸ªæ£€æµ‹å§  context.currentNode = null; } else { // éæ³•çš„ä½¿ç”¨ï¼Œv-if/v-else/v-else-if å¿…é¡»ç´§é ç€  context.onError( createCompilerError(ErrorCodes.X_V_ELSE_NO_ADJACENT_IF, node.loc) ); break; } } } }        codegen.ts  createCodgenContext(ast, context)  stage-1: 01 simple text  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  // æ„å»º condegen ä¸Šä¸‹æ–‡å¯¹è±¡  function createCodegenContext( ast, { mode = \u0026#34;function\u0026#34;, prefixIdentifiers = mode === \u0026#34;module\u0026#34;, sourceMap = false, filename = `template.vue.html`, scopeId = null, optimizeBindings = false, runtimeGlobalName = `Vue`, runtimeModuleName = `vue`, ssr = false, } ) { const context = { mode, prefixIdentifiers, sourceMap, filename, scopeId, optimizeBindings, runtimeGlobalName, runtimeModuleName, ssr, source: ast.loc.source, code: ``, column: 1, line: 1, offset: 0, indentLevel: 0, pure: false, map: undefined, helper(key) {}, push(code, node) { context.code += code; // TODO éæµè§ˆå™¨ç¯å¢ƒå¤„ç†ï¼Œnode ç¯å¢ƒ  }, indent() { // æ–°è¡Œç¼©è¿›  newline(++context.indentLevel); }, deindent(withoutNewLine = false) { if (withoutNewLine) { --context.indentLevel; } else { newline(--context.indentLevel); } }, newline() { newline(context.indentLevel); }, }; function newline(n) { context.push(\u0026#34;\\n\u0026#34; + ` `.repeat(n)); } function addMapping(loc, name) {} return context; }        generate()   generate å‡½æ•°é›å½¢ï¼š\n1 2 3 4 5 6 7  export function generate(ast, options) { return { ast, code: \u0026#34;\u0026#34;, map: \u0026#34;\u0026#34;, }; }     å‡½æ•°çš„ç›®çš„æ˜¯ï¼šé€šè¿‡ ast æ¥ç”Ÿæˆ codeï¼Œè¿™ä¸ª code å°†æ¥ä¼šè¢« compileToFunction è°ƒç”¨ new Function(code) ç”Ÿæˆ render å‡½æ•°çš„ã€‚\nstage-1: 01 simple text  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83  export function generate(ast, options = {}) { const context = createCodegenContext(ast, options); const { mode, push, prefixIdentifiers, indent, deindent, newline, scopeId, ssr, } = context; const hasHelpers = ast.helpers.length \u0026gt; 0; const useWithBlock = !prefixIdentifiers \u0026amp;\u0026amp; mode !== \u0026#34;module\u0026#34;; const genScopeId = !__BROWSER__ \u0026amp;\u0026amp; scopeId != null \u0026amp;\u0026amp; mode === \u0026#34;module\u0026#34;; // TODO preambles  if (!__BROWSER__ \u0026amp;\u0026amp; mode === \u0026#34;module\u0026#34;) { // TODO genModulePreamble(ast, context, genScopeId)  } else { genFunctionPreamble(ast, context); } if (genScopeId \u0026amp;\u0026amp; !ssr) { push(`const render = ${PURE_ANNOTATION}_withId(`); } if (!ssr) { // å‡½æ•°å£°æ˜  push(`function render(_ctx, _cache) {`); } else { // TODO ssr render  } indent(); if (useWithBlock) { // use with(_ctx) { ...}  push(`with (_ctx) {`); indent(); // TODO hasHelpers  } // TODO ast.components ç»„ä»¶å¤„ç†  // TODO ast.directives æŒ‡ä»¤å¤„ç†  // TODO ast.temps ä¸´æ—¶å˜é‡å¤„ç†  // TODO æ¢è¡Œ  if (!ssr) { push(`return `); } // ç”Ÿæˆä»£ç ç‰‡æ®µ  if (ast.codegenNode) { genNode(ast.codegenNode, context); } else { push(`null`); } if (useWithBlock) { deindent(); push(`}`); } deindent(); push(`}`); if (genScopeId \u0026amp;\u0026amp; !ssr) { push(`)`); } return { ast, code: context.code, map: \u0026#34;\u0026#34;, }; }     ä»£ç ä¸­åªåŒ…å«æ–‡æœ¬è§£æéœ€è¦çš„å†…å®¹ã€‚ä½†æ˜¯ç»“æœæ˜¾ç¤ºï¼š\nast: {type: 0, children: Array(1), loc: {â€¦}, helpers: Array(0), components: Array(0), â€¦} code: \u0026#34;function render(_ctx, _cache) {â†µ with (_ctx) {â†µ return null}}\u0026#34; map: \u0026#34;\u0026#34;   å³ï¼š ast.codegenNode æ˜¯ç©ºå€¼ï¼Œæœ€åå¹¶æ²¡æœ‰ æ‰§è¡Œ genNode(ast.codgenNode, context) ã€‚\n å› æ­¤é—®é¢˜è¿˜åœ¨ transformText é‡Œé¢ï¼Œä½†æ˜¯çº¯æ–‡æœ¬ä¼šç›´æ¥åœ¨ç¬¬ä¸€ä¸ª for åçš„ if åˆ¤æ–­ä¸­ç›´æ¥ return äº†ï¼Œé‚£ä¹ˆé—®é¢˜å‡ºåœ¨å“ªï¼Ÿï¼Ÿï¼Ÿ\n è¿›è¿‡å¾€ä¸Šè¿½æº¯ï¼Œå‘ç°åœ¨ traverseNode å®ç°ä¸­æœ‰ä¸€éƒ¨åˆ† switch ä»£ç è¢«æˆ‘ä»¬çœç•¥ï¼Œè€Œé‡Œé¢å°± æœ‰ä¸ª case æ˜¯æ–‡æœ¬èŠ‚ç‚¹ä¼šèµ°åˆ°çš„ï¼Œå³ï¼š NodeTypes.ROOT å› ä¸ºè¿™ä¸ªç”¨ä¾‹æ–‡æœ¬æ˜¯ç›´æ¥æŒ‚åœ¨æ ¹ èŠ‚ç‚¹ä¸‹é¢çš„ï¼Œé‚£ä¹ˆå°±å¾—å®ç° traverseChildren äº†ã€‚\n ç„¶åï¼Œå®ç°å®Œ traverseChildren ä¹‹åå¹¶æ²¡è§£å†³é—®é¢˜ï¼Œå› ä¸ºè¿™é‡Œé¢æ ¹æœ¬æ²¡æœ‰å¤„ç†èµ‹å€¼ codgenNode çš„æ“ä½œã€‚\n é‚£ä¹ˆåªèƒ½ç”¨æœ€ç¬¨æ‹™çš„æ–¹æ³•äº†ï¼Œç›´æ¥æœç´¢ codegen* ç„¶ååˆå‘ç°æ–°å¤§é™†(transform é‡Œé¢æœ‰ ä¸ª createRootCodgen(â€¦) å¹¶æ²¡æœ‰å®ç°)ï¼Œ ğŸƒâ€â™‚ï¸ go -\u0026gt;\n  stage-2: 02 pure interpolation   è¿™é‡Œæ–°å¢äº† push ast.helpers.map(...) å¤„ç†ï¼Œæ¯”å¦‚ traverseNode stage-2 ä¸­æ–°å¢çš„ INTERPOLATION åˆ†æ”¯ä¸­çš„å¤„ç†æ˜¯ context.helper(TO_DISPLAY_STRING) å°±æ˜¯ç»™ä¸Šä¸‹æ–‡çš„ helpers å¢åŠ äº† Symbol(\u0026#39;toDisplayString\u0026#39;) ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  export function generate(ast, options = {}) { // ...  const hasHelpers = ast.helpers.length \u0026gt; 0; // ...  if (useWithBlock) { // use with(_ctx) { ...}  push(`with (_ctx) {`); indent(); // æ–°å¢ï¼š hasHelpers  if (hasHelpers) { // æ¯”å¦‚ï¼šæ’å€¼å¤„ç†æ—¶ç”¨åˆ° TO_DISPLAY_STRING helper  // ä¸ºäº†é¿å…å‘½åå†²çªï¼Œè¿™é‡Œéƒ½éœ€è¦å°†ä»–ä»¬é‡å‘½å  push( `const { ${ast.helpers .map((s) =\u0026gt; `${helperNameMap[s]}: _${helperNameMap[s]}`) .join(\u0026#34;, \u0026#34;)}} = _Vue` ); push(\u0026#34;\\n\u0026#34;); newline(); } } // ...  }     æ­£å¥½åœ¨è¿™é‡Œä¼šæ£€æµ‹ context.helpers è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\n traverseNode çš„ switch ä¸­æ’å€¼ INTERPOLATION åˆ†æ”¯å¤„ç†ä¸­å¢åŠ äº†ä¸€ä¸ª TO_DISPLAY_STRING ç¬¦å·ç±»å‹å€¼åˆ° context.helpers: Set ä¸­ï¼Œè¿™å…¶å®å°±æ˜¯ä¸ª _Vue å®ä¾‹ä¸­çš„ä¸€ä¸ªå‡½æ•°åç§°ï¼Œåœ¨è¿™é‡Œä¼šéå† context.helpers å°†éœ€è¦ç”¨åˆ°çš„å‡½æ•°ä»å®ä¾‹ä¸­è§£ æ„å‡ºæ¥ã€‚\n    genNode(node, context)  stage-3: 04-interpolation in div with props   è¿™ä¸ªç”¨ä¾‹ä¸­éœ€è¦è§£æ props[{ id }, { class }] è¿™ä¸¤ä¸ªå±æ€§ç»è¿‡ buildProps å¤„ç†ä¹‹å ä¼šå˜æˆä¸€ä¸ªå¯¹è±¡ç»“æ„ï¼š\n { type: 15 /* JS_OBJECT_EXPRESSION */, properties: [{id}, {class}], ...}\n1 2 3 4 5 6 7 8  0: key: {type: 4 /*SIMPLE_EXPRESSION*/, loc: {â€¦}, isConstant: false, content: \u0026#34;id\u0026#34;, isStatic: true} type: 16 // JS_PROPERTY  value: {type: 4, loc: {â€¦}, isConstant: false, content: \u0026#34;foo\u0026#34;, isStatic: true} 1: key: {type: 4, content: \u0026#34;class\u0026#34;, isStatic: true, isConstant: true, loc: {â€¦}} type: 16 // JS_PROPERTY  value: {type: 4, content: \u0026#34;bar.baz\u0026#34;, isStatic: false, isConstant: false, loc: {â€¦}}     æ‰€ä»¥è¿™é‡Œé¦–å…ˆéœ€è¦å¢åŠ ä¸€ä¸ª JS_OBJECT_EXPRESSION åˆ†æ”¯å¤„ç†è¿™ä¸¤ä¸ªå±æ€§ï¼Œè§£ææˆå±æ€§å¯¹ è±¡ä¼ é€’ç»™ _createBlock(\u0026#39;div\u0026#39;, props, ...)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  function genNode(node, context) { if (typeof node === \u0026#34;string\u0026#34;) { context.push(node); return; } // TODO is symbol  switch (node.type) { // ... çœç•¥  case NodeTypes.ELEMENT: genNode(node.codegenNode, context); break; case NodeTypes.TEXT: genText(node, context); break; case NodeTypes.SIMPLE_EXPRESSION: // å¦‚ï¼šæ’å€¼å†…å®¹ï¼Œå±æ€§å€¼  genExpression(node, context); break; case NodeTypes.INTERPOLATION: console.log(node, \u0026#34;interpolation\u0026#34;); genInterpolation(node, context); break; case NodeTypes.VNODE_CALL: genVNodeCall(node, context); break; case NodeTypes.JS_OBJECT_EXPRESSION: // æ–°å¢å±æ€§ propertieså¤„ç†  genObjectExpression(node, context); break; }      stage-2: 02 pure interpolation   è¿™ä¸ªé˜¶æ®µéœ€è¦æ”¯æŒæ’å€¼çš„è§£æï¼Œè€Œæ’å€¼åœ¨ ast ä¸­æ•°æ®ç»“æ„ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  { \u0026#34;type\u0026#34;:5, // INTERPOLATION \u0026#34;content\u0026#34;:{ \u0026#34;type\u0026#34;:4, // SIMPLE_EXPRESSION \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;world.burn()\u0026#34;, \u0026#34;loc\u0026#34;:{ // ... , \u0026#34;source\u0026#34;:\u0026#34;world.burn()\u0026#34; } }, \u0026#34;loc\u0026#34;:{ // ..., \u0026#34;source\u0026#34;:\u0026#34;{{ world.burn() }}\u0026#34; } }     è¿™é‡Œéœ€è¦ç»è¿‡ä¸¤æ¬¡é€’å½’è°ƒç”¨ genNode åˆ†åˆ«å»è§£æ type=5 // INTERPOLATION å’Œ type=4 // SIMPLE_EXPRESSION ä¸¤ç§ç±»å‹ï¼Œä¸”å‰åå½¢åŒçˆ¶å­å…³ç³»ã€‚\n é‚£ä¹ˆå°±æœ‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  function genNode(node, context) { if (typeof node === \u0026#34;string\u0026#34;) { context.push(node); return; } // TODO is symbol  switch (node.type) { // ... çœç•¥  case NodeTypes.TEXT: genText(node, context); break; case NodeTypes.SIMPLE_EXPRESSION: // å¦‚ï¼šæ’å€¼å†…å®¹ï¼Œå±æ€§å€¼  genExpression(node, context); break; case NodeTypes.INTERPOLATION: console.log(node, \u0026#34;interpolation\u0026#34;); genInterpolation(node, context); break; } }      å…ˆç»è¿‡ INTERPOLATION åˆ†æ”¯è°ƒç”¨ genInterpolation(node, context) å»è§£ææ’å€¼èŠ‚ç‚¹\n    stage-1: 01 simple text   è¿™é‡Œæˆ‘ä»¬åªå¤„ç†æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function genNode(node, context) { if (typeof node === \u0026#34;string\u0026#34;) { context.push(node); return; } // TODO is symbol  switch (node.type) { // ... çœç•¥  case NodeTypes.TEXT: genText(node, context); break; } }     ç„¶åå°±æ˜¯å®ç° case çš„ genText(node, context)\n    genNodeList(nodes, context, multilines=false, comma=true)   ç”Ÿæˆ _createBlock(tag, props, children, â€¦) å‡½æ•°çš„å‚æ•°åˆ—è¡¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  function genNodeList(nodes, context, multilines = false, comma = true) { const { push, newline } = context; for (let i = 0; i \u0026lt; nodes.length; i++) { const node = nodes[i]; if (typeof node === \u0026#34;string\u0026#34;) { push(node); } else if (Array.isArray(node)) { genNodeListAsArray(node, context); } else { // nodes[1], props è¿›å…¥è¿™é‡Œå¤„ç†  genNode(node, context); } if (i \u0026lt; nodes.length - 1) { if (multilines) { comma \u0026amp;\u0026amp; push(\u0026#34;,\u0026#34;); newline(); } else { comma \u0026amp;\u0026amp; push(\u0026#34;, \u0026#34;); } } } }      genNodeListAsArray(nodes, context)   å°†å‚æ•°åˆ—è¡¨è½¬æˆæ•°ç»„ï¼Œ nodes: [tag, props, chldren, ...] -\u0026gt; [\u0026#39;div\u0026#39;, {}, ...}]\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // å°†å‚æ•°ä»¬å˜æˆæ•°ç»„  function genNodeListAsArray(nodes, context) { const multilines = nodes.length \u0026gt; 3 || ((!__BROWSER__ || __DEV__) \u0026amp;\u0026amp; nodes.some((n) =\u0026gt; Array.isArray(n) || !isText(n))); context.push(`[`); multilines \u0026amp;\u0026amp; context.indent(); genNodeList(nodes, context, multilines); multilines \u0026amp;\u0026amp; context.deindent(); context.push(`]`); }      genNullableArgs(args)   è¿‡æ»¤æ‰å‚æ•°åˆ—è¡¨å°¾éƒ¨å€¼ä¸º å‡å€¼ çš„å‚æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11  // è¿‡æ»¤å°¾éƒ¨ nullable çš„å€¼  function genNullableArgs(args) { let i = args.length; while (i--) { if (args[i] != null) break; } // ä¸­é—´çš„ nullable å€¼ è½¬æˆ null  return args.slice(0, i + 1).map((arg) =\u0026gt; arg || `null`); }      genObjectExpression(node, context)    ç©ºå±æ€§åˆ—è¡¨ï¼Œè¿”å› {}\n  å…ˆ genExpressionAsPropertyKey(node, context) è§£æå±æ€§å\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  // ç”Ÿæˆå¯¹è±¡è¡¨è¾¾å¼ï¼Œç”¨æ¥å¤„ç† properties  function genObjectExpression(node, context) { const { push, indent, deindent, newline } = context; const { properties } = node; if (!properties.length) { push(`{}`, node); return; } const multilines = properties.length \u0026gt; 1 || ((!__BROWSER__ || __DEV__) \u0026amp;\u0026amp; properties.some((p) =\u0026gt; p.value.type !== NodeTypes.SIMPLE_EXPRESSION)); push(multilines ? `{` : `{ `); multilines \u0026amp;\u0026amp; indent(); for (let i = 0; i \u0026lt; properties.length; i++) { const { key, value } = properties[i]; // key å¤„ç†ï¼Œå±æ€§å  genExpressionAsPropertyKey(key, context); push(`: `); // value å¤„ç†ï¼Œå±æ€§å€¼ï¼Œå¦‚æœæ˜¯é™æ€çš„å­—ç¬¦ä¸²åŒ–ï¼Œå¦‚æœæ˜¯åŠ¨æ€çš„ç›´æ¥å˜é‡æ–¹å¼  // å¦‚ï¼š id=\u0026#34;foo\u0026#34; -\u0026gt; id: \u0026#34;foo\u0026#34;  // å¦‚ï¼š :class=\u0026#34;bar.baz\u0026#34; -\u0026gt; class: bar.baz  // è¿™é‡Œ bar æ˜¯å¯¹è±¡ï¼Œbaz æ˜¯ barå¯¹è±¡çš„å±æ€§  genNode(value, context); if (i \u0026lt; properties.length - 1) { push(`,`); newline(); } } multilines \u0026amp;\u0026amp; deindent(); push(multilines ? `}` : ` }`); }      genExpressionAsPropertyKey(node, context)   ç”Ÿæˆå¯¹è±¡å±æ€§åï¼š\n  å±æ€§åç”±ç»„åˆè¡¨è¾¾å¼åŠ¨æ€ç”Ÿæˆï¼Œå¦‚ï¼š { [prefix + \u0026#39;_\u0026#39; + name]: \u0026#39;value\u0026#39; }\n  é™æ€å±æ€§ï¼Œåˆåˆ†æ ‡å‡†æ ‡è¯†ç¬¦å’Œéæ ‡å‡†çš„(éœ€è¦ç”¨å¼•å·åŒ…èµ·æ¥çš„)ï¼Œå¦‚ï¼š { foo: \u0026#39;value\u0026#39; } æˆ– { \u0026#39;23adf34\u0026#39;: \u0026#39;value\u0026#39; }\n  ç®€å•çš„åŠ¨æ€å±æ€§ï¼Œå¦‚ï¼š { [foo]: \u0026#39;value\u0026#39; }\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function genExpressionAsPropertyKey(node, context) { const { push } = context; if (node.type === NodeTypes.COMPOUND_EXPRESSION) { push(`[`); genCompoundExpression(node, context); push(`]`); } else if (node.isStatic) { // é™æ€å±æ€§  const text = isSimpleIdentifier(node.content) ? node.content : JSON.stringify(node.content); push(text, node); } else { // åŠ¨æ€å±æ€§  push(`[${node.content}]`, node); } }      genCompoundExpression(node, context)  1 2 3 4 5 6 7 8 9 10  function genCompoundExpression(node, context) { for (let i = 0; i \u0026lt; node.children.length; i++) { const child = node.children[i]; if (typeof child === \u0026#34;string\u0026#34;) { context.push(child); } else { genNode(child, context); } } }      genText(node, context)   è¿™é‡Œæ²¡ä»€ä¹ˆé˜¶æ®µæ€§çš„ï¼Œå°±æ˜¯ä¸€å¥å¾ˆç®€å•çš„å­—ç¬¦ä¸²åŒ–æ–‡æœ¬èŠ‚ç‚¹å†…å®¹ã€‚\n1 2 3 4  function genText(node, context) { // æ–‡æœ¬ç›´æ¥å­—ç¬¦ä¸²åŒ–  context.push(JSON.stringify(node.content), node); }      genFunctionPreamble(ast, context)    ç”Ÿæˆ const _Vue = Vue\n  ä¸€äº›å‡½æ•°çš„å…¨å±€æå‡è§£æ„ï¼Œå¦‚ï¼š const { createVNode: _createVnode } = _Vue\n  ä¸€äº›é™æ€å±æ€§æå‡ï¼Œå¦‚ï¼š const _hoisted_1 = {key: 0}\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  function genFunctionPreamble(ast, context) { const { push, newline, ssr, runtimeGlobalName, runtimeModuleName, prefixIdentifiers, } = context; // TODO ...  const VueBinding = !__BROWSER__ \u0026amp;\u0026amp; ssr ? `require(${JSON.striingify(runtimeModuleName)})` : runtimeGlobalName; const aliasHelper = (s) =\u0026gt; `${helperNameMap[s]}: _${helperNameMap[s]}`; if (ast.helpers.length \u0026gt; 0) { if (!__BROWSER__ \u0026amp;\u0026amp; prefixIdentifiers) { push( `const { ${ast.helpers.map(aliasHelper).join(\u0026#34;, \u0026#34;)}} = ${VueBinding}\\n` ); } else { // with æ¨¡å¼ï¼Œé‡å‘½å Vue é¿å…å†²çª  push(`const _Vue = ${VueBinding}\\n`); if (ast.hoists.length) { const staticHelpers = [ CREATE_VNODE, CREATE_COMMENT, CREATE_TEXT, CREATE_STATIC, ] .filter((helper) =\u0026gt; ast.helpers.includes(helper)) .map(aliasHelper) .join(\u0026#34;, \u0026#34;); push(`const { ${staticHelpers}} = _Vue\\n`); } } } // TODO ç”Ÿæˆ ssr helpers å˜é‡  genHoists(ast.hoists, context); newline(); push(`return `); }      genInterpolation(node, context)  1 2 3 4 5 6 7 8 9 10  function genInterpolation(node, context) { const { push, helper, pure } = context; if (pure) push(PURE_ANNOTATION); push(`${helper(TO_DISPLAY_STRING)}(`); // è°ƒç”¨ genNode è§£ææ’å€¼çš„å†…å®¹ï¼Œè¡¨è¾¾å¼èŠ‚ç‚¹ç±»å‹ï¼ŒNodeTypes.SIMPLE_EXPRESSION  genNode(node.content, context); push(`)`); }     context.helper(TO_DISPLAY_STRING) æ˜¯ä» helpersMap ä¸­å–å‡º TO_DISPLAY_STRING å¯¹ åº”çš„å‡½æ•°åç§°(ä¸‹åˆ’çº¿é‡å‘½åä¹‹åçš„åç§°)ï¼Œçœ‹ context.helper å®ç°:\n1 2 3  helper(key) { return `_${helperNameMap[key]}`; }     åˆ«åæ“ä½œåœ¨ generate çš„ useWithBlock åˆ¤æ–­ä¸­ç”Ÿæˆã€‚\n  genExpression(node, context)  1 2 3 4  function genExpression(node, context) { const { content, isStatic } = node; context.push(isStatic ? JSON.stringify(content) : content, node); }     è¡¨è¾¾å¼çš„å€¼å¯ä»¥æ˜¯é™æ€çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŠ¨æ€çš„ï¼Œ\n  TODO å¦‚æœæ˜¯é™æ€ç›´æ¥å­—ç¬¦ä¸²åŒ–ï¼Ÿï¼Ÿï¼Ÿ\n  DONE å¦‚æœæ˜¯åŠ¨æ€çš„ç›´æ¥ push content å˜æˆå˜é‡ç›´æ¥ä»ä¸Šä¸‹æ–‡å»å–å˜é‡å€¼\n å¦‚ 02 pure interpolation ä¸­çš„ world.burn() ä¼šç›´æ¥è¢«å¡åˆ° context.code ç»“åˆ æˆ return _toDisplayString(world.burn()); ç”Ÿæˆå‡½æ•°ä¹‹åç›¸å½“äºè¿™æ ·è°ƒ ç”¨ï¼š _ctx.world.burn() ã€‚\n    genVNodeCall(node, context)  stage-1 03-inerpolation in pure div   å¢åŠ  createVNode helper\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  function genVNodeCall(node, context) { const { push, helper, pure } = context; const { tag, props, children, patchFlag, dynamicProps, directives, isBlock, isForBlock, } = node; // TODO directives start  // TODO isblock start  if (pure) { push(PURE_ANNOTATION); } push(helper(isBlock ? CREATE_BLOCK : CREATE_VNODE) + `(`, node); // TODO genNodeList  push(`)`); // TODO isblock end  // TODO directives end  }        genCallExpression(node, context)  1 2 3 4 5 6 7 8 9 10 11  function genCallExpression(node, context) { const { push, helper, pure } = context; const callee = typeof node.callee === \u0026#34;string\u0026#34; ? node.callee : helper(node.callee); if (pure) { push(PURE_ANNOTATION); } push(callee + `(`, node); genNodeList(node.arguments, context); push(`)`); }      genConditionalExpression(node, context)   genHoists(ast.hoists, context)    scope id å¤„ç†\n  é™æ€æå‡ const _hoisted_i = xxx\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  function genHoists(hoists, context) { if (!hoists.length) { return; } context.pure = true; const { push, newline, helper, scopeId, mode } = context; const genScopeId = !__BROWSER__ \u0026amp;\u0026amp; scopeId != null \u0026amp;\u0026amp; mode !== \u0026#34;function\u0026#34;; newline(); // å…ˆ push scope id åœ¨åˆå§‹åŒ– hoisted vnodes ä¹‹å‰ï¼Œä»è€Œè¿™äº›èŠ‚ç‚¹èƒ½è·å–åˆ°é€‚å½“çš„ scopeId  if (genScopeId) { push(`${helper(PUSH_SCOPE_ID)}(\u0026#34;${scopeId}\u0026#34;)`); newline(); } hoists.forEach((exp, i) =\u0026gt; { if (exp) { push(`const _hoisted_${i + 1}= `); genNode(exp, context); newline(); } }); if (genScopeId) { push(`${helper(POP_SCOPE_ID)}()`); newline(); } context.pure = false; }        è™šæ‹ŸèŠ‚ç‚¹åˆ›å»ºå‡½æ•°     name transform desc     createTextVNode transformText åˆ›å»ºæ–‡æœ¬è™šæ‹ŸèŠ‚ç‚¹        ","permalink":"https://www.cheng92.com/vue/vue3-source-code-function-list/","tags":["vue,","vue3,","vuenext,","compiler"],"title":"Vue3 æ‰€æœ‰å‡½æ•°æºç å³ç®€è¦è¯´æ˜"},{"categories":["javascript"],"contents":"  window.g_fold_chapter = 1   æœ¬æ–‡é»˜è®¤å¤„äºæŠ˜å çŠ¶æ€ï¼Œå¯ç‚¹å‡»æ ‡é¢˜åæ–¹çš„ â€¦ å±•å¼€æˆ–é—­åˆã€‚ \n å‚è€ƒé“¾æ¥ï¼š\n  https://muyiy.cn/question/js/33.html\n   JavaScript  èŠ‚æµå’Œé˜²æŠ–    é˜²æŠ–ï¼šåŠ¨ä½œå‘ç”Ÿåï¼Œå»¶æ—¶å¤šä¹…åæ‰§è¡ŒåŠ¨ä½œå›è°ƒ\n æ¯”å¦‚ï¼šç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»ä¹‹ååœ¨ä¸€å®šæ—¶é—´åè§¦å‘å›è°ƒï¼Œåœ¨è¯¥æ—¶é—´å†…å¦‚æœå†å‘ç”Ÿç‚¹å‡»äº‹ä»¶ ä¸ä¼šç«‹å³è§¦å‘å›è°ƒï¼Œè€Œæ˜¯é‡ç½®å»¶æ—¶è§¦å‘æ—¶é—´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function debounce(fn, time) { let timer = null return function() { clearTimeout(timer) timer = setTimeout(() =\u0026gt; fn.apply(this, arguments), time) } } function log(time) { setTimeout(() =\u0026gt; console.log(\u0026#39;x: \u0026#39; + time), time || 10) } const dlog = debounce(log, 100) dlog(10) dlog(50) dlog(100) dlog(120)    x: 120   10, 50, 100 éƒ½æ²¡è§¦å‘ï¼Œå› ä¸ºæ‰§è¡Œé—´éš”éƒ½ä¸è¶…è¿‡ 100 æ‰€ä»¥è¢« clearTimeout å–æ¶ˆäº†ï¼Œ çŸ¥é“ç¬¬å››ä¸ª dlog(120) è°ƒç”¨ï¼Œåé¢æ²¡æœ‰äº†ï¼Œå¾—åˆ°æ‰§è¡Œè¾“å‡ºç»“æœã€‚\n  èŠ‚æµï¼šä¸¤ä¸ªåŠ¨ä½œè§¦å‘æœ‰ä¸€å®šçš„æ—¶é—´é—´éš”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  function throttle(fn, duration) { let last = 0 return function() { let current = Date.now() if (current - last \u0026lt; duration) return fn.apply(this, arguments) last = Date.now() } } function log(time) { console.log(\u0026#39;x: \u0026#39; + time) } function delay(time) { setTimeout(() =\u0026gt; dlog(time), time) } // 100ms é—´éš”  const dlog = throttle(log, 100) delay(10) delay(50) delay(150) delay(160) delay(270)    x: 10 // now - 0 \u0026gt;= 100 x: 150 // 150 - 50 \u0026gt;= 100 x: 270 // 270 - 160 \u0026gt;= 100    é˜²æŠ–å’ŒèŠ‚æµåŒºåˆ«\n é˜²æŠ– æ˜¯æŒ‡åŒä¸€ç§ç±»å‹çš„åŠ¨ä½œæ— è®ºå‘ç”Ÿå¤šå°‘æ¬¡ï¼Œåªè¦é—´éš”æ—¶é—´ä¸å¤Ÿé•¿ï¼Œå°±æ°¸è¿œåªä¼šè§¦å‘ æœ€åé‚£ä¸€ä¸ªåŠ¨ä½œå›è°ƒ ã€‚\n èŠ‚æµ æ˜¯æŒ‡ä¸¤ä¸ªåŠ¨ä½œä¸­é—´å¿…é¡»é—´éš”ç‰¹å®šçš„æ—¶é—´ï¼Œå¦åˆ™åé¢çš„åŠ¨ä½œä¸ä¼šè§¦å‘ï¼Œå³åœ¨è¿™å›º å®šçš„æ—¶é—´é—´éš”ä¹‹å†…çš„åŠ¨ä½œä¼šè¢«å¿½ç•¥ï¼Œ åªä¼šæ‰§è¡Œç¬¬ä¸€ä¸ªåŠ¨ä½œå›è°ƒ ã€‚\n  æµ‹è¯•ï¼š\nç§»åŠ¨é¼ æ ‡åˆ°æˆ‘ä¸Šé¢ç§»åŠ¨ï¼Œç¦»å¼€æ—¶é‡ç½®ï¼Œç§»åŠ¨æ—¶è§‚å¯Ÿè“æ¡å˜åŒ–ï¼Œåœæ­¢æ—¶è§‚å¯Ÿçº¢æ¡å˜åŒ– debounce throttle         ä¸‹é¢çš„ä»£ç æ‰“å°ä»€ä¹ˆï¼Ÿ  IIFE å‡½æ•°åæ˜¯ä¸ªå¸¸é‡ï¼Ÿ   å‡½æ•°å®šä¹‰å®ç°åŸç†ï¼š http://ecma-international.org/ecma-262/5.1/#sec-13\n åšå®¢å†…ä¼ªç é“¾æ¥ -\u0026gt;\u0026gt;\n  éä¸¥æ ¼æ¨¡å¼\n1 2 3 4 5 6  var b = 10 ;(function b() { b = 20 console.log(b) })()    [Function: b]   è¾“å‡ºç»“æœåˆ†æï¼šéä¸¥æ ¼æ¨¡å¼ä¸‹ IIFE çš„å‡½æ•°åä¸èƒ½è¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœèµ‹å€¼äº†çš„è¯é™é»˜æ˜¯å¤± è´¥çš„ï¼Œæ‰€ä»¥è¯´ b = 20 è¿™ä¸€å¥æ²¡å…¶ä»»ä½•ä½œç”¨ï¼Œå‡½æ•°å†…éƒ¨çš„ b è¿˜æ˜¯ IIFE çš„é‚£ä¸ªå‡½æ•° åï¼Œæ‰€ä»¥æœ€åè¾“å‡ºä¾æ—§æ˜¯ [Function: b] ã€‚\n   ä¸¥æ ¼æ¨¡å¼\n1 2 3 4 5 6 7 8 9 10 11  var b = 10 try { ;(function b() { \u0026#34;use strict\u0026#34;; b = 20 console.log(b) })() } catch(e) { console.log(e) }    TypeError Assignment to constant variable.   ç»“æœåˆ†æï¼šå°† IIFE å†…éƒ¨æ¢æˆä¸¥æ ¼æ¨¡å¼å°±èƒ½å¾ˆæ˜æ˜¾çš„è¯´æ˜é—®é¢˜äº†ï¼Œä¸Šé¢ç»“æœæŠ¥é”™â€œä¸èƒ½ç»™ å¸¸é‡èµ‹å€¼â€ï¼Œç«‹å³å‡½æ•°åæ˜¯ä¸å¯å˜çš„å¸¸é‡ã€‚\n   window.b/this.b\n1 2 3 4 5 6 7 8  var b = 10; (function b() { b = 20 console.log(b) console.log(this.b) // 10  })()    [Function: b] 10   å› ä¸ºè¿™é‡Œæ˜¯ä»¥ node module ç¯å¢ƒè¿è¡Œçš„ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨ window.b/this.b/global.b å»å–åˆ°å¤–é¢çš„ var b = 10 çš„å€¼ï¼Œç»“æœæ˜¯æ ¹æ®æµè§ˆå™¨ç¯å¢ƒ è¿è¡Œç»“æœã€‚\n ç¬¬äºŒä¸ª log ç»“æœæ˜¯ 10 ï¼ŒåŸå› æ˜¯åœ¨å…¨å±€ä½œç”¨åŸŸä¸‹ç”¨ var å£°æ˜çš„å˜é‡æ˜¯å…¨å±€å˜ é‡ï¼Œä¼šæŒ‚åˆ° window å¯¹è±¡ä¸‹é¢ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ window.b å–åˆ°å®ƒçš„å€¼ï¼Œç”¨ this.b ä¹Ÿèƒ½å–åˆ°æ˜¯å› ä¸º IIFE å‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡æ˜¯åœ¨å…¨å±€ï¼Œæ‰€ä»¥ this æŒ‡å‘ window ã€‚\n   å‡½æ•°æå‡(å£°æ˜+èµ‹å€¼)\n1 2 3 4 5 6 7 8 9 10 11 12 13  var b = 10 function b() { b = 20 console.log(b) } console.log({ b }) try { b() } catch(e) { console.log(e.message) }    { b: 10 } b is not a function   ç»“æœåˆ†æï¼šæå‡å¯¹äºå‘½åå¼å‡½æ•°è¡¨è¾¾å¼æ¥è¯´ï¼Œå®ƒçš„å£°æ˜å’Œèµ‹å€¼éƒ½ä¼šè¢«æå‡ï¼Œå¯¹äº var å£°æ˜çš„å˜é‡åªä¼šæå‡å£°æ˜ï¼Œæ‰€ä»¥å°±æœ‰   function b å£°æ˜å’Œèµ‹å€¼æå‡ï¼Œ var b å£°æ˜æå‡ï¼Œç”±äºå£°æ˜åªä¼šå‘ç”Ÿä¸€æ¬¡ï¼Œ æ‰€ä»¥è¿™é‡Œç›¸å½“äºåªæœ‰ä¸€æ¬¡å£°æ˜å’Œèµ‹å€¼ï¼Œå³æ­¤æ—¶æœ‰å˜é‡ b å®ƒçš„å€¼æ˜¯ function b() {} ã€‚\n  ä½†æ˜¯ var b = 10 çš„èµ‹å€¼ä¸ä¼šæå‡ï¼Œæ‰€ä»¥å½“æ‰§è¡Œåˆ°è¿™ä¸€å¥çš„æ—¶å€™ï¼Œ b çš„å€¼ ä¼šè¢«è¿™é‡Œçš„èµ‹å€¼æ“ä½œç»™æ›¿æ¢æˆ 10 ã€‚\n     åªæœ‰ b = 10\n1 2 3 4 5 6 7 8  function b() { console.log(b) // [Function b]  b = 1 console.log(window.b) // 1  console.log(b) // 1  } b()    [Function b] 1 1          CSS(3)  transition åŠ¨ç”»   CSS Transition Examples â€“ How to Use Hover Animation, Change Opacity, and More\n    ","permalink":"https://www.cheng92.com/web/web-fe-zero/","tags":["javascript,","web"],"title":"å‰ç«¯ï¼Œä¸€ç‚¹éƒ½ä¸å¥½ç©"},{"categories":[],"contents":"","permalink":"https://www.cheng92.com/web/javascript-native-dev-with-rollupjs/","tags":[],"title":"ç”¨ Rollupjs æ‰“åŒ…åŸç”Ÿé¡¹ç›®"},{"categories":["javascript"],"contents":"   æºç å‚è€ƒé“¾æ¥ï¼šhttps://github.com/stefanpenner/es6-promise\n   å®Œæ•´çš„ promise.js é“¾æ¥  æ„é€ å‡½æ•° Promise    ä¸‰ä¸ªçŠ¶æ€: PENDING, FULFILL, REJECT ã€‚\n  PID è®°å½• promise id å±æ€§\n  _state å½“å‰ promise çš„çŠ¶æ€(pending/fulfill/reject)\n  _result å½“å‰ promise ä»»åŠ¡æ‰§è¡Œçš„ç»“æœå€¼\n  _subs å½“å‰ promise çš„è®¢é˜…è€…(then æ—¶æ³¨å†Œçš„ resolver/rejection)\n  æ„é€ å‡½æ•°ä¸­ç«‹å³æ‰§è¡Œ resolver æ ¹æ®ä»»åŠ¡æ‰§è¡Œæƒ…å†µç”±ä½¿ç”¨è€…å†³å®šæ˜¯è°ƒç”¨ resolvePromise è¿˜æ˜¯ rejectPromise\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  var PID = Math.random().toString(36).substring(2); var PENDING = 0; var FULFILL = 1; var REJECT = 2; var i = 0; var proto = MyPromise.prototype; var noop = function () {}; function MyPromise(resolver) { this[PID] = i++; this._state = PENDING; this._result = undefined; this._subs = []; if (!this instanceof Promise) { throw new TypeError(\u0026#34;åªèƒ½é€šè¿‡new æ„é€  Promise å®ä¾‹ã€‚\u0026#34;); } var _this = this; try { resolver( function resolvePromise(value) { resolve(_this, value); }, function rejectPromise(reason) { reject(_this, reason); } ); } catch (e) { reject(this, e); } } MyPromise.prototype.then = then; function resolve(val) { console.log(val, \u0026#39;resolve\u0026#39;) } function reject() {}     æµ‹è¯•ï¼š\n1 2 3 4  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new MyPromise(function (resolve, reject) { Util.delay(() =\u0026gt; resolve(100), 1000) })    100 resolve    resolve å’Œ reject å‡½æ•°   è¿™ä¸¤ä¸ªå‡½æ•°è‡³å…³é‡è¦ï¼Œä»–ä»¬è´Ÿè´£æ”¹å˜ promise çš„çŠ¶æ€å€¼ï¼Œä¹Ÿæ˜¯æ•´ä¸ª Promise å®ç°è¿‡ç¨‹ä¸­å”¯ ä¸€èƒ½æ”¹å˜çŠ¶æ€å€¼çš„åœ°æ–¹ã€‚\n ä»–ä»¬çš„æ‰§è¡Œä¼šè§¦å‘æ‰€æœ‰å›è°ƒçš„æ‰§è¡Œ(promise._subs)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  function resolve(promise, value) { if (promise === value) { reject(promise, Util.error.returnSelfPromise()); } else if (Util.isObjectOrFunction(value)) { // TODO  } else { fulfill(promise, value); } } function reject(promise, reason) { if (promise._state !== PENDING) { return; } promise._state = REJECT; promise._result = reason; asap(function () { publish(promise); }); }      asap å‡½æ•°  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  // å°†æ‰€æœ‰ä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ ¹æ®å¹³å°å†³å®šè°ƒç”¨é‚£ä¸ªå¼‚æ­¥å‡½æ•°  var queue = new Array(1000); var qlen = 0; function asap(callback) { queue[qlen] = callback; qlen++; if (qlen === 1) { // è¿™é‡Œæ˜¯é€šè¿‡ç¬¬ä¸€æ¬¡å…¥åˆ—æ“ä½œæ¥è§¦å‘ flush é˜Ÿåˆ—æ“ä½œ  // å› ä¸º flush æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨å®ƒè¿˜æ²¡ä¹‹å‰ä¹‹å‰æœ‰å¯èƒ½æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—  // è¿™ä¸ªæ—¶å€™ qlen \u0026gt; 1 ï¼Œç›´åˆ° flush æ‰§è¡Œï¼Œé€šè¿‡ qlen é queue ç¡®ä¿åœ¨æ‰§è¡Œçš„æ—¶åˆ»  // å¯ä»¥å°†è¿™ä¹‹å‰çš„æ‰€æœ‰å…¥åˆ—çš„ä»»åŠ¡éƒ½å¾—åˆ°æ‰§è¡Œ  setTimeout(flush()); } } function flush() { for (var i = 0; i \u0026lt; qlen; i++) { var callback = queue[i]; if (callback) callback(); // æ¸…ç©ºå·²æ‰§è¡Œçš„ä»»åŠ¡  queue[i] = undefined; } // åœ¨æ­¤åˆ»è‡³ Flushä¹‹å‰å…¥åˆ—çš„ä»»åŠ¡éƒ½å¾—åˆ°äº†æ‰§è¡Œï¼Œé‡ç½®é‡æ–°æ¥å—æ–°çš„ä»»åŠ¡  qlen = 0; }     æŒ‰ç…§ Promise çš„å®šä¹‰ï¼Œè¢« Promise å®šä¹‰çš„ä»»åŠ¡ä¸è®ºä»£ç æ˜¯å¼‚æ­¥çš„è¿˜æ˜¯åŒæ­¥çš„ï¼Œéƒ½ä¼šè¢«å½“åš å¼‚æ­¥ä»»åŠ¡æ¥æ‰§è¡Œï¼Œæ¯”å¦‚ï¼š\n1 2 3 4  new Promise((resolve)=\u0026gt; { resolve(100) }).then(val =\u0026gt; console.log(100)) console.log(200)    200 100   ç»“æœæ˜¾ç¤º 200 å…ˆè¾“å‡ºï¼Œåè¾“å‡º 100ï¼Œä½†æ˜¯å…¶å®æˆ‘ä»¬åœ¨ new Promise() çš„æ—¶å€™ä¼ å…¥çš„å‡½æ•° é‡Œé¢å…¶å®éƒ½æ˜¯åŒæ­¥ä»£ç ï¼Œç»è¿‡ Promise å°è£…ç½®åéƒ½æˆäº†å¼‚æ­¥çš„äº†ã€‚\n å› æ­¤è¿™é‡Œçš„ asap å°±æ˜¯è¿™ä¸ªä½œç”¨ï¼Œå½“ä»»åŠ¡å°±ç®—æ˜¯åŒæ­¥ä»£ç çš„æ—¶å€™ï¼Œä¾ç„¶å°†å…¶å˜æˆå¼‚æ­¥ä»»åŠ¡å» æ‰§è¡Œã€‚\n å¹¶ä¸”è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªé˜Ÿåˆ— queue æ¥ç®¡ç†è¿™äº›ä»»åŠ¡ï¼Œé’ˆå¯¹åŸä½œè€…çš„ä»£ç åšäº†ä¸€äº›æ”¹åŠ¨ï¼Œå» æ‰äº†å¹³å°æœ‰å…³çš„ä»£ç ï¼Œå¹¶å°†ä»»åŠ¡ç›´æ¥äºŒæ¬¡å°è£…æˆäº†ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ qlen++ è€Œä¸æ˜¯ qlen +=2 ã€‚\n è¿™é‡Œå¦‚æœä¸ä»”ç»†æ€è€ƒå¯èƒ½è¿˜ä¸å¤ªå¥½ç†è§£åŸä½œè€…ä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿï¼Ÿï¼Ÿ\n  ä¸ºä»€ä¹ˆ qlen === 1 çš„æ—¶å€™è§¦å‘ flush ?\n ç­” ï¼šå…¶å®æƒ³æ˜ç™½äº†ä¹Ÿç®€å•ï¼Œå°±æ˜¯ä¸ºäº†åªè¦é˜Ÿåˆ—æ˜¯ç©ºçš„æ—¶å€™ä¸€æ—¦æœ‰æ–°çš„ä»»åŠ¡è¿›æ¥å°±ç«‹å³è§¦å‘ä»»åŠ¡ å‡ºåˆ— flush æ‰é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ä»»åŠ¡ï¼Œå¹¶ä¸”æ˜¯é¡ºåºæ‰§è¡Œï¼Œé¡ºåºæ‰§è¡Œï¼Œé¡ºåºæ‰§è¡Œï¼Œé‡è¦çš„äº‹ æƒ…è¯´ä¸‰éå˜›ï¼Œæƒ³è±¡ä¸‹å¦‚æœæ²¡æœ‰è¿™ä¸ªæœºåˆ¶ï¼Œä¸€æ—¦æœ‰ promise settled äº†ï¼Œå°±è°ƒç”¨ä¸€ä¸ª setTimeout ?  æœ‰äº†è¿™ä¸ªæœºåˆ¶ä¹‹åï¼Œåœ¨ å½“å‰çš„ setTimeout flush ä¹‹å‰ï¼Œä¼šå°½å¯èƒ½çš„è®©å½“å‰é˜Ÿåˆ—æ‰¿è½½ æ›´å¤šçš„ promise ä»»åŠ¡ï¼Œç›´åˆ° flush ç»“æŸï¼Œé‡å¯å¦ä¸€ä¸ª setTimeoutã€‚\n   ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ queue æ•°ç»„çš„é•¿åº¦æ¥æ§åˆ¶ ?\n TODO\n    æƒ…æ™¯æµ‹è¯•ï¼šåœ¨ flush ä¹‹å‰ qlen å€¼å‘ç”Ÿå˜åŒ–äº†ï¼Œéœ€è¦åšç‚¹ä¿®æ”¹è®©æ•ˆæœæ›´ç›´è§‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11  function asap(callback) { queue[qlen] = callback; qlen++; if (qlen === 1) { // è¿™é‡ŒåŠ å¤§ flush çš„æ—¶é—´ç‚¹ï¼Œè®© asap æœ‰è¶³å¤Ÿçš„æ—¶é—´æ¥å“åº”æ›´å¤šçš„å¼‚æ­¥ä»»åŠ¡  setTimeout(flush, 3000); } }     æµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p1 = new MyPromise((resolve) =\u0026gt; { Util.delay(() =\u0026gt; resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;p1 then 1\u0026#39;) }) new MyPromise((resolve) =\u0026gt; { Util.delay(() =\u0026gt; resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;p2 then 1\u0026#39;) }) new MyPromise((resolve) =\u0026gt; { Util.delay(() =\u0026gt; resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;p3 then 1\u0026#39;) }) new MyPromise((resolve) =\u0026gt; { Util.delay(() =\u0026gt; resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;p4 then 1\u0026#39;) })    { qlen: 1 } { qlen: 2 } { qlen: 3 } { qlen: 4 } 100 p1 then 1 100 p2 then 1 100 p3 then 1 100 p4 then 1   çœ‹åˆ°æ²¡ï¼Œ qlen=4 äº†ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ asap ä¸­è°ƒç”¨ flush çš„æ—¶å€™åŠ äº† 3 ç§’çš„å»¶æ—¶ï¼Œæ‰€ä»¥èƒ½ å¾ˆç›´è§‚çš„çœ‹å¾—åˆ°åœ¨ä¸€ä¸ª settimeout å›è°ƒä¹‹å‰ä¼šæ¥å—åˆ°å¤šä¸ª promise ä»»åŠ¡ã€‚\n  then å‡½æ•°å®ç°  then åŠŸèƒ½è¯´æ˜ï¼š    æ”¶é›† pending çŠ¶æ€ promise çš„ callback(å­˜æ”¾åˆ° _subs ä¸­)\n å› ä¸º promise ä»»åŠ¡å¦‚æœå¼‚æ­¥çš„ï¼Œè°ƒç”¨ then(resolve,reject) çš„æ—¶å€™ï¼Œresolve å’Œ reject æ˜¯ä¸åº”è¯¥ç«‹å³æ‰§è¡Œçš„ï¼Œå¿…é¡»ç­‰å¼‚æ­¥ä»»åŠ¡ç»“æŸä¹‹åå†æ‰§è¡Œï¼Œå¦åˆ™å°±ä¸ç¬¦åˆäº† promise åŸåˆ™(å¼‚æ­¥ä»»åŠ¡åŒæ­¥åŒ–)ã€‚\n æ‰€ä»¥å½“ promise ä»»åŠ¡æ˜¯å¼‚æ­¥æƒ…å†µä¸‹ï¼Œthen å‡½æ•°çš„åŠŸèƒ½åº”è¯¥æ˜¯ç”¨æ¥æ”¶é›† resolve/reject çš„ï¼Œç­‰å¾…ä»»åŠ¡ç»“æŸåè°ƒç”¨ã€‚\n  ä½œä¸º then é“¾å¼è°ƒç”¨çš„æ¡¥æ¢ï¼Œå³è¿™ä¸ªæ¡¥æ¢å¿…é¡»æ˜¯åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢å»å®Œæˆçš„ã€‚\n   æ—¢ç„¶æœ‰äº†æ”¶é›†ï¼Œé‚£å¿…ç„¶å°±æœ‰è§¦å‘åŠ¨ä½œï¼Œè§¦å‘ä¹Ÿå¿…é¡»ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆæ‰ä¼šè§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ ä¸ªåŠ¨ä½œå¿…é¡»æ˜¯åœ¨ resolve() é‡Œé¢å®Œæˆï¼Œå› ä¸º Promise ä½¿ç”¨è€…ä¼šæ ¹æ®è‡ªå·±ä»»åŠ¡æƒ…å†µå»åœ¨é€‚ å½“çš„ä½ç½®è°ƒç”¨ resolve å’Œ rejectã€‚\n  éœ€è¦å®Œæˆçš„å‡½æ•°ï¼š   fulfill(promise, value) ï¼Œä»»åŠ¡æˆåŠŸå®Œæˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function fulfill(promise, result) { if (promise._state !== PENDING) { // çŠ¶æ€å·²ç»å®Œæˆä¸èƒ½å†æ”¹å˜çŠ¶æ€  return; } promise._state = FULFILL; promise._result = result; if (promise._subs.length \u0026gt; 0) { asap(function () { publish(promise); }); } }     publish(promise)  ä»»åŠ¡å®Œæˆä¹‹å flush æ‰æ‰€æœ‰å›è°ƒ(then pending é˜¶æ®µæ”¶é›†çš„ _subs[])\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function publish(promise) { var subs = promise._subs; var child, callback, result = promise.result; for (var i = 0; i \u0026lt; subs.length; i += 3) { child = subs[i]; callback = subs[i + promise._state]; if (child) { // TODO å¼‚æ­¥ä»»åŠ¡  } else { callback(result); } } subs.length = 0; }     subscribe(parent, child, onFulfillment, onRejection)\n å¦‚æœä»»åŠ¡æ˜¯ä¸ªå¼‚æ­¥ä»»åŠ¡å°±ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè¦ç­‰åˆ°ä»»åŠ¡ç»“æŸæ‰èƒ½æ‰§è¡Œå›è°ƒï¼Œæ‰€ä»¥å°±å¿…é¡»è¦æœ‰ ä¸ªåœ°æ–¹èƒ½å°†è¿™äº›å›è°ƒæ”¶é›†åˆ°å½“å‰çš„ promise å®ä¾‹ä¸­ï¼Œç­‰å¾…è°ƒç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function subscribe(parent, child, onFulfillment, onRejection) { var subs = parent._subs; var len = subs.length; // PENDING  subs[len] = child; subs[len + FULFILL] = onFulfillment; subs[len + REJECT] = onRejection; // parent promise çŠ¶æ€å¦‚æœå®Œæˆäº†ï¼Œç«‹å³è§¦å‘å½“å‰ child çš„ promise  // å¯èƒ½æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ä»»åŠ¡åˆšå¥½å®Œæˆäº†???  if (len === 0 \u0026amp;\u0026amp; parent._state) { asap(function () { publish(parent); }); } }     then(onFulfillment, onRejection)  è¿™é‡Œè¦åŒºåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ pending çŠ¶æ€å’Œé pending çŠ¶æ€çš„å¤„ç†ï¼Œpending è¯´æ˜å¯ èƒ½æ˜¯å¼‚æ­¥ä»»åŠ¡è¿˜æ²¡ç»“æŸï¼Œä¸èƒ½ç«‹å³ settledï¼Œè°ƒç”¨ subscribe() å»æ”¶é›†å›è°ƒã€‚\n ä¸€ç§æ˜¯é pending çŠ¶æ€ï¼Œåœ¨è°ƒç”¨ then ä¹‹ååªæœ‰ä¸€ç§æƒ…å†µä¼šä½¿å¾— promise çŠ¶æ€æ”¹å˜äº†ï¼Œ é‚£å°±æ˜¯ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼Œè°ƒç”¨äº† resolve æˆ– reject è®¾ç½®äº† promise._state æ”¹å˜ äº†çŠ¶æ€ï¼Œå› ä¸ºåªæœ‰è¿™ä¸¤ä¸ªå‡½æ•°æ‰ä¼šæ”¹å˜ promise çŠ¶æ€å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function then(onFulfillment, onRejection) { var parent = this; // åˆ›å»ºä¸€ä¸ªæ–°çš„ promiseï¼Œç”¨æ¥è¡”æ¥åé¢çš„ then  var child = new this.constructor(noop); var _state = this._state; // æ ¹æ®çŠ¶æ€å†³å®šæ‰§è¡Œå“ªä¸ªå›è°ƒ  var callback = arguments[_state - 1]; if (_state) { // çŠ¶æ€å·²ç»æ”¹å˜ï¼Œä»»åŠ¡å·²ç»å®Œæˆäº†ï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ  invokeCallback(_state, child, callback, parent._result); } else { // è®¢é˜…æ‰€æœ‰å›è°ƒ  subscribe(parent, child, onFulfillment, onRejection); } return child; }     invokeCallback(settled, promise, callback, detail)\n è¿™ä¸ªå‡½æ•°æ‰¿è½½äº†å½“å‰ then promise1 çš„å›è°ƒæ‰§è¡Œå¹¶è§£æç»“æœ(å¼‚å¸¸å¤„ç†)ï¼Œç„¶åå°†å€¼ä¼ é€’ ç»™ä¸‹ä¸€ä¸ª then promise2(then é‡Œé¢ new this.constructor(noop) å‡ºæ¥çš„)ï¼Œè°ƒç”¨ resolve(child)~æˆ– ~reject(child) å»è§¦å‘ promise2 çš„å›è°ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  function invokeCallback(settled, promise, callback, detail) { var value; // è®°å½• callback æ‰§è¡Œçš„ç»“æœ  var hasCallback = typeof callback === \u0026#34;function\u0026#34;; var succeeded = true; // callback å¯èƒ½æ‰§è¡Œå¤±è´¥  var error; if (hasCallback) { // å¼€å§‹æ‰§è¡Œ callback, å³ then(resolve, reject) çš„ Resolve/Reject  try { // å°†ä¸Šä¸€ä¸ª promise ç»“æœä½œä¸ºå‚æ•°ä¼ é€’åˆ° then å›è°ƒ  value = callback(detail); } catch (e) { // å›è°ƒæ‰§è¡Œå¤±è´¥ï¼Œæœ‰é”™è¯¯æˆ–è€…å¼‚å¸¸  error = e; succeeded = false; } if (promise === value) { reject(promise, Util.error.returnSelfPromise()); return; } } else { // æ²¡æœ‰å›è°ƒçš„æ—¶å€™ then() ???  value = detail; } // è¿™é‡Œè¦æ£€æµ‹ä¸‹ä¸€ä¸ªæ–° new çš„ promise çŠ¶æ€  // ä¸‹é¢çš„åŠ¨ä½œéƒ½æ˜¯ä¸ºäº†ä¸‹ä¸€ä¸ª then åšå‡†å¤‡çš„ï¼Œè¿™é‡Œçš„promise  // æ˜¯åœ¨ä¸Šä¸€ä¸ª then é‡Œé¢çš„new å‡ºæ¥çš„ promise è¡”æ¥ä¸‹ä¸€ä¸ª then ç”¨  if (promise._state !== PENDING) { // noop çŠ¶æ€å®Œæˆäº†çš„ promise  } else if (hasCallback \u0026amp;\u0026amp; succeeded) { // æ‰§è¡ŒæˆåŠŸï¼Œ resolve  resolve(promise, value); } else if (succeeded === false) { // then ä¸­çš„å›è°ƒæ‰§è¡Œå¤±è´¥äº†  reject(promise, error); } else if (settled === FULFILL) { fulfill(promise, value); } else if (settled === REJECT) { reject(promise, value); } }      æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new MyPromise((resolve, reject) =\u0026gt; { Util.delay(() =\u0026gt; resolve(100)) }).then(val =\u0026gt; { Util.log(val, \u0026#39;then 1 resolve\u0026#39;) })     +RESULTS å®ç° invokeCallback ä¹‹å‰:\nundefined   è¿™é‡Œæ²¡ä»»ä½•è¾“å‡ºï¼Œå› ä¸ºè¿˜æ²¡å®ç° invokeCallback(settled, promise, callback, detail) è¿™é‡Œé¢ä¼šé’ˆå¯¹ then çš„ resolve æˆ– reject æ‰§è¡Œç»“æœåšå‡ºç›¸åº”çš„å¤„ç†ã€‚\n å®ç°å…³é”®ç‚¹ï¼š   callback å®é™…ä¸Šæ˜¯ then(resolve, reject) ä¸­çš„ resolve/reject ï¼Œæ ¹æ®ä¸Šä¸€ä¸ª promise çŠ¶æ€ settled å†³å®šçš„ã€‚\n  ä½¿ç”¨ tryâ€¦catch æ•è· callback æ‰§è¡Œå¼‚å¸¸ï¼Œç¡®ä¿ then å›è°ƒä¹Ÿèƒ½å— Promise è§„åˆ™çº¦ æŸã€‚\n  å‡ ç§æƒ…å†µå†³å®šè°ƒç”¨ resolve è¿˜æ˜¯ reject è¿›å…¥ä¸‹ä¸€ä¸ªé“¾å¼å›è°ƒ(then)ã€‚\n  +RESULTS å®ç° invokeCallback ä¹‹å:\n100 then 1 resolve   æ­¤æ—¶çš„ promise._subs å¦‚ä¸‹ï¼š\n[ MyPromise { \u0026#39;8st4da5md17\u0026#39;: 1, _state: 0, _result: undefined, _subs: [] // è¿™æ˜¯é‚£ä¸ª child promise }, [Function (anonymous)], // è¿™é‡Œæ˜¯ then resolver undefined // è¿™é‡Œæ˜¯ then rejection å› ä¸ºæ²¡ä¼ æ‰€ä»¥æ˜¯ undefined ]    then é“¾å¼è°ƒç”¨ï¼š  1 2 3 4 5 6 7 8 9 10 11  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new MyPromise((resolve, reject) =\u0026gt; { Util.delay(() =\u0026gt; resolve(100)) }).then(val =\u0026gt; { /* p1 */ Util.log(val, \u0026#39;then 1 resolve\u0026#39;) return 200 }, /* p2 */).then(val =\u0026gt; {/* p3 */ Util.log(val, \u0026#39;then 2 resolve\u0026#39;) return 300 }, /* p4 */)    100 then 1 resolve 200 then 2 resolve      then callback è¿”å›å¯¹è±¡æˆ–å‡½æ•°   é’ˆå¯¹è¿”å›å¯¹è±¡çš„æƒ…å†µï¼Œå…¶å®ä¹Ÿå¯ä»¥è·Ÿæ™®é€šç±»å‹å¤„ç†ä¸€æ ·ï¼š\n é¦–å…ˆè¦æŠŠ Resolve é‡Œé¢å¯¹å¯¹è±¡å’Œå‡½æ•°çš„æ£€æµ‹å»æ‰ï¼Œæˆ–è€…ä¹Ÿè®©å®ƒæ‰§è¡Œ fulfill(promise, value) :\n1 2 3 4 5 6 7 8 9 10  function resolve(promise, value) { if (promise === value) { reject(promise, Util.error.returnSelfPromise()); } else if (Util.isObjectOrFunction(value)) { // TODO  fulfill(promise, value); } else { fulfill(promise, value); } }     å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new MyPromise((resolve) =\u0026gt; { Util.delay(() =\u0026gt; resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;, then 1\u0026#39;) return { name: \u0026#39;then 1 return\u0026#39; } }).then(val =\u0026gt; { console.log(val, \u0026#39;, then 2\u0026#39;) })    100 , then 1 { name: \u0026#39;then 1 return\u0026#39; } , then 2   ä½†æ˜¯å¦‚æœæœ‰å¤šä¸ª then é“¾å¼è°ƒç”¨çš„æƒ…å†µï¼Œä¸€èˆ¬éƒ½ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å¸¸è§æƒ…å†µä¼šæ˜¯ä¸€ä¸ªå¼‚ æ­¥çš„ promise ï¼Œè¿™æ ·ç»Ÿä¸€å½“æˆæ™®é€šç±»å‹å¤„ç†å°±æ˜¾å¾—ä¸å¤ªåˆç†äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½•åŸä½œè€…å°†è¿”å› å€¼æ˜¯ å‡½æ•°æˆ–å¯¹è±¡ çš„æ—¶å€™åˆ†å¼€å¤„ç†äº†ã€‚\n å› ä¸ºåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæœ‰ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š\n  è¿”å›çº¯å¯¹è±¡ç±»å‹(é promise æˆ– å¸¦æœ‰ then çš„å¯¹è±¡)\n  è¿”å›ä¸€ä¸ªæ–°çš„ promise å®ä¾‹\n  è¿”å›ä¸€ä¸ªå¸¦æœ‰ then çš„å¯¹è±¡æˆ–å‡½æ•°\n  æ‰€ä»¥éœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†ã€‚\nvalue å¯èƒ½æ˜¯ null   æ•è·è¿™ç§æƒ…å†µå¼‚å¸¸æ‰§è¡Œ rejectã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function resolve(promise, value) { if (promise === value) { reject(promise, Util.error.returnSelfPromise()); } else if (Util.isObjectOrFunction(value)) { let then; try { then = value.then; } catch (e) { // value å¯èƒ½æ˜¯ undefined æˆ– nullï¼Œæˆ–å…¶ä»–éæ³•ç±»å‹(å¦‚ï¼šæ•°å­—)  reject(promise, e); return; } // handleMaybeThenable(promise, value, then);  } else { fulfill(promise, value); } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new MyPromise(resolve =\u0026gt; { Util.delay(resolve(null)) }).then(val =\u0026gt; { console.log(val, \u0026#39;p then resolve 1\u0026#39;) }, reason =\u0026gt; { console.log(reason.message, \u0026#39;, p then reject 1\u0026#39;) })    Cannot read property \u0026#39;then\u0026#39; of null , p then reject 1    value è¿”å›çš„æ˜¯ä¸€ä¸ª Promise å®ä¾‹   å³ä½¿ç”¨è€…åœ¨ then å›è°ƒé‡Œé¢ new äº†ä¸€ä¸ª Promise å®ä¾‹è¿”å›å‡ºæ¥ï¼Œè¿™ä¹Ÿæ˜¯å¸¸è§çš„ä½¿ç”¨åœº æ™¯ä¹‹ä¸€ï¼Œç»å¸¸ä¼šæœ‰å¤šä¸ªæœ‰ä¾èµ–å‰åç»“æœçš„å¼‚æ­¥è¯·æ±‚çš„æ—¶å€™ï¼Œé€šè¿‡ promise then æ¥é“¾ å¼åŒæ­¥æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function resolve(promise, value) { if (promise === value) { reject(promise, Util.error.returnSelfPromise()); } else if (Util.isObjectOrFunction(value)) { let then; try { then = value.then; } catch (e) { // value å¯èƒ½æ˜¯ undefined æˆ– nullï¼Œæˆ–å…¶ä»–éæ³•ç±»å‹(å¦‚ï¼šæ•°å­—)  reject(promise, e); return; } handleMaybeThenable(promise, value, then); } else { fulfill(promise, value); } }     å¢åŠ  handleMaybeThenable(promise, value, then); å‡½æ•°å¤„ç†å…¶ä»–æƒ…å†µã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function handleMaybeThenable(promise, thenable, then) { // originalThen å®ç°çš„ then å‡½æ•°ï¼Œå³ MyPromise.prototype.then  // è¿™èƒ½ç¡®ä¿ thenable çš„ç¡®æ˜¯æˆ‘ä»¬çš„ MyPromise å®ä¾‹  if (thenable.constructor === promise.constructor \u0026amp;\u0026amp; thenable.resolve === originalResolve \u0026amp;\u0026amp; thenable.then === originalThen) { // è¿™é‡Œè¦åšçš„å¤„ç†æ˜¯ç›´æ¥é’ˆå¯¹ thenable çŠ¶æ€åšå‡ºåˆ¤æ–­  if (thenable._state === FULFILL) { fulfill(promise, thenable._result) } else if (thenable._state === REJECT) { reject(promise, thenable._result) } else { // ç›´æ¥æ„é€  resolver å’Œ rejection  subscribe(thenable, undefined, val =\u0026gt; resolve(promise, val), reason =\u0026gt; reject(promise, reason)) } } else { // TODO  } }     è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤„ç† then å›è°ƒä¸­è¿”å›ä¸€ä¸ª Promise å®ä¾‹çš„æƒ…å†µäº†ã€‚\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new MyPromise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 1 resolve\u0026#39;) return new MyPromise(resolve =\u0026gt; { Util.delay(resolve(200)) }) }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 2 resolve\u0026#39;) })    100 , p then 1 resolve 200 , p then 2 resolve undefined   æ‰€ä»¥å¾ˆé¡ºåˆ©çš„å°±çœ‹åˆ°äº†æ­£ç¡®çš„ç»“æœï¼Œå› ä¸ºè¿”å›çš„æœ¬èº«å°±æ˜¯ MyPromise ï¼Œæ‰€ä»¥åªéœ€è¦æ ¹æ® å…¶çŠ¶æ€åšç›¸åº”çš„å¤„ç†å³å¯(fulfill / reject / subscribe)ã€‚\n  value æœ‰å¯èƒ½æœ‰è‡ªå·±çš„ then å‡½æ•°å‘¢ï¼Ÿ  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  function handleForeignThenable(promise, thenable, then) { asap(() =\u0026gt; () =\u0026gt; { let sealed = false; // ä¿è¯åªä¼šæ‰§è¡Œä¸€æ¬¡  try { then.call( thenable, (value) =\u0026gt; { if (sealed) return; sealed = true; if (value !== thenable) { resolve(promise, value); } else { fulfill(promise, value); } }, (reason) =\u0026gt; { if (sealed) return; sealed = true; reject(promise, reason); } ); } catch (e) { sealed = true; reject(promise, e); } }); }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new MyPromise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 1 resolve\u0026#39;) return { name: 1, then(resolve, reject) { console.log(resolve, reject, \u0026#39;object then\u0026#39;) resolve(200) } } }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 2 resolve\u0026#39;) })    100 , p then 1 resolve [Function (anonymous)] [Function (anonymous)] object then 200 , p then 2 resolve   å¦‚æœè¿”å›çš„å¯¹è±¡ç±»å‹å±æ€§æœ‰ä¸€ä¸ª then å‡½æ•°çš„è¯ï¼Œåˆ™ MyPromise çš„å¤„ç†æ˜¯å°† resolve å’Œ reject å°è£…ä¸€å±‚ä¼ é€’ç»™å¤–éƒ¨çš„ then ï¼Œç”±å®ƒå†³å®šä½•æ—¶ä½¿ç”¨ï¼Ÿã€‚\n æ³¨é‡Š resolve(200) ä¹‹åï¼š\n100 , p then 1 resolve [Function (anonymous)] [Function (anonymous)] object then   å¯¹æ¯”ä¸‹åŸç”Ÿçš„ Promise å‘¢ï¼Œå°† MyPromise æ¢æˆ Promise 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p = new Promise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 1 resolve\u0026#39;) return { name: 1, then(resolve, reject) { console.log(resolve, reject, \u0026#39;object then\u0026#39;) resolve(200) } } }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 2 resolve\u0026#39;) })    100 , p then 1 resolve [Function (anonymous)] [Function (anonymous)] object then 200 , p then 2 resolve   ç»“æœå’Œ MyPromise ä¸€æ ·ï¼Œå¦‚æœåœ¨ object then ä¸­ä¸è°ƒç”¨ resolve æˆ– reject ç»“æœï¼Œ é‚£ä¹ˆ then é“¾ä¹Ÿä¼šæ–­å¼€ï¼š\n100 , p then 1 resolve [Function (anonymous)] [Function (anonymous)] object then    ç–‘é—® 1ï¼š foreign then çš„ resolve ä¸ºä»€ä¹ˆè¦åˆ¤æ–­è¿”å›å€¼æ˜¯ä¸æ˜¯ç­‰äºè¯¥å¯¹è±¡è‡ªèº«ï¼Ÿ\n1 2 3 4 5  if (value !== thenable) { resolve(promise, value); } else { fulfill(promise, value); }     ç­” ï¼šå¦‚æœ value === thenable ï¼Œç›´æ¥è°ƒç”¨ resolve(promise, value) ä¼šé€ æˆæ­»å¾ª ç¯ resolve -\u0026gt; value.then is function -\u0026gt; handleMaybeThenable -\u0026gt; handleForeignThenable -\u0026gt; resolve -\u0026gt; â€¦\n éªŒè¯æ–¹æ³•ï¼Œå°† asap å»¶è¿Ÿæ—¶é—´åŠ å¤§ï¼Œå¹¶ä¸”ç»™ asap å¥—ä¸€å±‚ï¼ŒåŠ ä¸Šå»¶æ—¶æ—¶é—´ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function asap(callback) { queue[qlen] = callback; qlen++; if (qlen === 1) { // è¿™é‡Œæ˜¯é€šè¿‡ç¬¬ä¸€æ¬¡å…¥åˆ—æ“ä½œæ¥è§¦å‘ flush é˜Ÿåˆ—æ“ä½œ  // å› ä¸º flush æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨å®ƒè¿˜æ²¡ä¹‹å‰ä¹‹å‰æœ‰å¯èƒ½æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—  // è¿™ä¸ªæ—¶å€™ qlen \u0026gt; 1 ï¼Œç›´åˆ° flush æ‰§è¡Œï¼Œé€šè¿‡ qlen é queue ç¡®ä¿åœ¨æ‰§è¡Œçš„æ—¶åˆ»  // å¯ä»¥å°†è¿™ä¹‹å‰çš„æ‰€æœ‰å…¥åˆ—çš„ä»»åŠ¡éƒ½å¾—åˆ°æ‰§è¡Œ  setTimeout(flush, 3000); } } let bakAsap = asap asap = cb =\u0026gt; setTimeout(bakAsap(cb), 500)     è¿™æ ·å¯ä»¥é¿å…å¡æ­»ï¼Œæ¯éš” 500ms ä¼šæ‰§è¡Œä¸€æ¬¡ asapï¼Œ3000ms ä¹‹å flush queueã€‚\n ä¿®æ”¹å¦‚ä¸‹ï¼Œç›´æ¥ resolveï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  (value) =\u0026gt; { if (sealed) return; sealed = true; resolve(promise, value); // if (value !== thenable) {  // resolve(promise, value);  // } else {  // fulfill(promise, value);  // }  }     ä¿®æ”¹ç”¨ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  let i = 0 new MyPromise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 1 resolve\u0026#39;) const obj = { name: 1, then(resolve, reject) { console.log(i++, \u0026#39;, object then\u0026#39;) resolve(obj) } } return obj }).then(val =\u0026gt; { console.log(val, \u0026#39;, p then 2 resolve\u0026#39;) })     æ‰§è¡Œç»“æœï¼š\nâœ js git:(master) âœ— node promise.js 100 , p then 1 resolve 0 , object then 1 , object then 2 , object then 3 , object then 4 , object then 5 , object then 6 , object then // å¦‚æœä¸åœæ­¢ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œå› ä¸ºæ­»å¾ªç¯äº†      Promise Api å®ç°   åœ¨ ecma262 æ–‡æ¡£ä¸­æˆ‘ä»¬çŸ¥é“ Promise æœ‰å¦‚ä¸‹ APIsï¼š\n    åç§° ç®€ä»‹     Promise all(iterable) æ»¡è¶³æ¡ä»¶ï¼šæ‰€æœ‰ promises éƒ½ fulfilled    allSettled(iterable) ä¸åœ¨ä¹ç»“æœæ˜¯ FULFILL è¿˜æ˜¯ REJECTï¼Œåªè¦æ‰€æœ‰çš„ä»»åŠ¡çŠ¶æ€éƒ½æ”¹å˜äº†å°± FULFILL å¦åˆ™ REJECT    any(iterable) åªè¦æœ‰ä¸€ä¸ªä»»åŠ¡ FULFILL ç»“æœå°±æ˜¯ FULFILL å¦åˆ™ REJECT    race(iterable) ç«äº‰å…³ç³»ï¼Œç¬¬ä¸€ä¸ªçŠ¶æ€æ”¹å˜å‘ç”Ÿæ”¹å˜ race çŠ¶æ€å°±è·Ÿç€æ”¹å˜ï¼Œæ˜¯å•¥å°±æ˜¯å•¥ï¼ŒFULFILL -\u0026gt; FULFILL, REJECT -\u0026gt; REJECT    reject(rejectHandler) è¿”å›ä¸€ä¸ªå¿…å®š REJECT çš„ promise    resolve(fulfillHandler) è¿”å›ä¸€ä¸ªå¿…å®š FULFILL çš„ promise     Promise.prototype catch(onRejected)     finally(onFinally)     then(onFulfilled, onRejected)      å½“ç›®å‰è¡¨ä¸­çš„å‡½æ•°åªå®ç°äº† then å’Œ resolve ä¸‹é¢å°†ä¸€ä¸€å®ç°å®ƒä»¬ã€‚\nPromise.reject(rejectHandler)  1 2 3 4 5  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) Promise.reject(\u0026#39;test reject result\u0026#39;).then(null, reason =\u0026gt; { console.log(reason, \u0026#39;, p reject then\u0026#39;) })    test reject result , p reject then   è¿™ä¸ªè·Ÿ Promise.resolve ä¸€æ ·ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ª Promise å®ä¾‹ insï¼Œè°ƒç”¨ reject(ins, reason) 1 2 3 4 5 6 7 8 9 10 11 12  function originalReject(reason) { const ctor = this; if (typeof value === \u0026#34;object\u0026#34; \u0026amp;\u0026amp; value.constructor === ctor) { return value; } const ins = new ctor(noop); reject(promise, reason); return ins; }      Promise.race(entries)   race ç«äº‰æœºåˆ¶ï¼Œåªè¦æœ‰ä¸€ä¸ª fulfilled äº†å°±ç«‹å³ç»“æŸã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p1 = new MyPromise(resolve =\u0026gt; { Util.delay(() =\u0026gt; resolve(100), 100) }) const p2 = new MyPromise((resolve, reject) =\u0026gt; { Util.delay(() =\u0026gt; reject(200), 80) }) MyPromise.race([p1, p2]).then(val =\u0026gt; { console.log(val, \u0026#39;, race then resolve\u0026#39;) }, reason =\u0026gt; { console.log(reason, \u0026#39;, race then reject\u0026#39;) })    200 , race then reject   åªè¦æœ‰ä¸€ä¸ªçŠ¶æ€æ”¹å˜äº†å°±é‡Œé¢ç»“æŸ race ï¼Œå®ƒä¸åœ¨ä¹ç»“æŸçš„æ—¶å€™é‚£ä¸ª promise æ˜¯ fulfilled è¿˜æ˜¯ rejected ã€‚\n å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  MyPromise.race = function (entries) { const ctor = this; if (!Array.isArray(entries)) { return new ctor((_, reject) =\u0026gt; reject(new TypeError(\u0026#34;race å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„\u0026#34;)) ); } else { return new ctor((resolve, reject) =\u0026gt; { // éå†æ‰€æœ‰ä»»åŠ¡  const len = entries.length; for (let i = 0; i \u0026lt; len; i++) { // ç›´æ¥è°ƒç”¨ resolve å»æ‰§è¡Œä»»åŠ¡ï¼Œç„¶åæŒ‚ä¸€ä¸ª then  // å› ä¸º resolve å’Œ reject åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸€æ—¦åªè¦æœ‰ä¸ª entry  // ç»“æŸäº†å°±ä¼šæ‰§è¡Œåé¢çš„ then å»è°ƒç”¨ resolve æˆ– rejectï¼Œ  // åé¢çš„å°±ç®—æ‰§è¡Œåˆ°äº†ä¹Ÿ settled äº†ï¼Œä¹Ÿä¸ä¼šé‡å¤æ‰§è¡Œ resolve å’Œ reject  ctor.resolve(entries[i]).then(resolve, reject); } }); } }      Promise.any(entries)  åªè¦æœ‰ä¸ª promise fulfilled äº†ï¼Œè¿”å›çš„ promise çŠ¶æ€å°±ä¼šå˜æˆ fulfilledï¼Œå¦åˆ™æ˜¯ rejectedï¼Œå¹¶ä¸” rejected then çš„å›è°ƒæ¥å—çš„å‚æ•° reason ä¼šæ˜¯ entries ä¸­æ‰€æœ‰ rejected promise ç»“æœå€¼æ•°ç»„.\n ä¿®æ”¹ç‚¹ï¼šå°†åº”è¯¥ fulfill() åœ°æ–¹æ¢æˆ reject() ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91  function Enumerator(entries, option) { var p = (this.promise = new Ctor(noop)); this.option = option || {}; // ä¿å­˜ç»“æŸçš„å‡½æ•°ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½ settled ä¹‹åè°ƒç”¨çš„å‡½æ•°  // Promise.any æ‰€æœ‰çš„ REJECT ä¼šè°ƒç”¨ reject  // Promise.all æ‰€æœ‰çš„éƒ½ FULFILL ä¼šè°ƒç”¨ fulfill  // æ‰€ä»¥è¦åŒºåˆ†å¼€  this.$settle = opt.isPromiseAnyFlag ? reject : fulfill; if (Array.isArray(entries)) { // ... çœç•¥  if (this._length === 0) { // ç»“æŸäº†  this.$settle(p, this._result); } else { this._enumerate(entries); if (this._remaining === 0) { // æ‰€æœ‰ä»»åŠ¡çŠ¶æ€æ”¹å˜äº†  this.$settle(p, this._result); } } } else { // å¿…é¡»æ˜¯æ•°ç»„ç±»å‹  reject(p, new TypeError(\u0026#34;å¿…é¡»æä¾›æ•°ç»„ç±»å‹\u0026#34;)); } } Enumerator.prototype._enumerate = function (entries) { var p = this.promise; // å½“å‰ promise çŠ¶æ€å¤„äº PENDING çŠ¶æ€ä¸‹è¿›è¡Œéå†  for (var i = 0; p._state === PENDING \u0026amp;\u0026amp; i \u0026lt; entries.length; i++) { var entry = entries[i]; var then, error; try { then = entry.then; } catch (e) { error = e; } if (then === originalThen \u0026amp;\u0026amp; entry._state !== PENDING) { // ... çœç•¥  } else if (typeof then !== \u0026#34;function\u0026#34;) { // ... çœç•¥  } else if (p.constructor === Ctor) { var promise = new Ctor(noop); if (error) { // è¿™é‡Œå¦‚æœæ‰§è¡Œé”™è¯¯è¦åŒºåˆ†ä¸‹æ˜¯ Promise.any è¿˜æ˜¯ Promise.all  if (this.option.isPromiseAnyFlag) { this._result[i] = error; this._remaining--; } else { reject(entry, error); } } else { } // ...  } else { // ...  } } }; Enumerator.prototype._settle = function (state, i, result) { var p = this.promise; var opt = this.option; if (p._state === PENDING) { this._remaining--; // ä¿®æ”¹ç‚¹  // for Promise.any  if (opt.isPromiseAnyFlag) { if (state === REJECT) { this._result[i] = result; } else { resolve(p, result); } } else { // ...  } } if (this._remaining === 0) { // Promise.any åº”è¯¥ reject  // ä¿®æ”¹ç‚¹  this.$settle(p, this._result); } };     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p1 = new MyPromise(resolve =\u0026gt; { Util.delay(() =\u0026gt; resolve(100), 100) }) const p2 = new MyPromise((resolve, reject) =\u0026gt; { Util.delay(() =\u0026gt; reject(200), 80) }) const p3 = new MyPromise((resolve, reject) =\u0026gt; { Util.delay(() =\u0026gt; reject(300), 80) }) MyPromise.any([p1, p2]).then(val =\u0026gt; { console.log(val, \u0026#39;, any then resolve 1\u0026#39;) }, reason =\u0026gt; { console.log(reason, \u0026#39;, any then reject 1\u0026#39;) }) MyPromise.any([p2, p3]).then(val =\u0026gt; { console.log(val, \u0026#39;, any then resolve 2\u0026#39;) }, reason =\u0026gt; { console.log(reason, \u0026#39;, any then reject 2\u0026#39;) })    [ 200, 300 ] , any then reject 2 100 , any then resolve 1   ç¬¬ä¸€è¡Œè¾“å‡ºï¼šp2, p3 éƒ½æ˜¯ REJECT ï¼Œæ‰€ä»¥æœ€åç»“æœæ˜¯ REJECT ç¬¬äºŒè¡Œè¾“å‡ºï¼šp1, p2 ä¸­ p1 æ˜¯ FULFILL ï¼Œæ‰€ä»¥æœ€åç»“æœæ˜¯ FULFILL\n  Promise.all(entries)   all å‡½æ•°çš„å®ç°å…³é”®ï¼šè¦ç­‰åˆ°æ‰€æœ‰çš„ promise çŠ¶æ€éƒ½ settled äº†ï¼Œæ‰èƒ½ fulfillã€‚\n ç„¶åä»»åŠ¡æœ‰å¼‚æ­¥ä¹Ÿå¯èƒ½æœ‰åŒæ­¥ä»»åŠ¡(å³ promise çŠ¶æ€æ˜¯å¦ç«‹å³æ”¹å˜)ï¼Œä¸ç®¡å¦‚ä½•éƒ½è¦ç­‰åˆ°ä»– ä»¬çŠ¶æ€å‘ç”Ÿæ”¹å˜äº†ä¹‹åæ‰èƒ½è®© all ç»“æŸï¼Œæ‰€ä»¥ä¸¤ç§å¤„ç†æƒ…å†µ\n  çŠ¶æ€ç«‹å³å‘ç”Ÿæ”¹å˜äº†çš„ï¼Œç›´æ¥è®°å½•\n  çŠ¶æ€æ˜¯ PENDING çš„æ³¨å†Œè®°å½•å›è°ƒç›´åˆ°æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆ\n  å¦‚æœé‡åˆ°æœ‰ä¸€ä¸ª rejected çš„ç«‹å³ç»“æŸï¼Œå¦åˆ™ç­‰å¾…æ‰€æœ‰éƒ½ fulfilled æ‰ç»“æŸï¼Œå¹¶ä¸”å°†æ‰€ æœ‰ fulfilled ç»“æœç»„æˆæ•°ç»„ä¼ é€’ç»™ä¸‹ä¸€ä¸ª promiseã€‚\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89  // ç®€åŒ–ç‰ˆæœ¬ï¼Œåªå¤„ç†ï¼š  // 1. entry æ˜¯ promise ç±»å‹ï¼Œ  // 2. entry æ˜¯æ™®é€šç±»å‹(é promiseï¼Œthen ä¸æ˜¯å‡½æ•°)  Enumerator.prototype._enumerateSimple = function (entries) { var p = this.promise; for (var i = 0; p._state === PENDING \u0026amp;\u0026amp; i \u0026lt; entries.length; i++) { var entry = entries[i]; if (entry.constructor === Ctor) { // æ˜¯ä¸ª promise ä»»åŠ¡  if (entry._state !== PENDING) { this._settle(entry._state, i, entry._result); } else { this._willSettle(entry, i); } } else { // é promise ç±»å‹å¤„ç†  this._remaining--; this._result[i] = entry; } } }; Enumerator.prototype._enumerate = function (entries) { var p = this.promise; // å½“å‰ promise çŠ¶æ€å¤„äº PENDING çŠ¶æ€ä¸‹è¿›è¡Œéå†  for (var i = 0; p._state === PENDING \u0026amp;\u0026amp; i \u0026lt; entries.length; i++) { var entry = entries[i]; var then, error; try { then = entry.then; } catch (e) { error = e; } if (then === originalThen \u0026amp;\u0026amp; entry._state !== PENDING) { // entry ä¸ä¸€å®šæ˜¯ Promise ä½†æœ‰ then å‡½æ•°ï¼Œä¸”çŠ¶æ€æ”¹å˜äº†çš„  this._settle(entry._state, i, entry._result); } else if (typeof then !== \u0026#34;function\u0026#34;) { // æ™®é€šç±»å‹å€¼  this._remaining--; this._result[i] = entry; } else if (p.constructor === Ctor) { // åˆ°è¿™é‡Œå‰ææ¡ä»¶ï¼š  // 1. then ä¸æ˜¯ originalThen æˆ– entry._state = PENDING  // 2. then æ˜¯ä¸ªå‡½æ•°  // 3. this.promise æ˜¯æˆ‘ä»¬å®šä¹‰çš„ MyPromise  // é‚£ä¹ˆå°† entry ç”¨ MyPromise å°è£…  var promise = new Ctor(noop); if (error) { reject(entry, error); } else { handleMaybeThenable(promise, entry, then); } this._willSettle(promise, i); } else { this._willSettle(new Ctor((resolve) =\u0026gt; resolve(entry)), i); } } }; Enumerator.prototype._settle = function (state, i, result) { var p = this.promise; if (p._state !== PENDING) { this._remaining--; if (state === REJECT) { reject(p, result); } else { this._result[i] = result; } } if (this._remaining === 0) { fulfill(p, this._result); } }; Enumerator.prototype._willSettle = function (promise, i) { // è®¢é˜…ç»“æœ  subscribe( promise, undefined, (value) =\u0026gt; this._settle(FULFILL, i, value), (reason) =\u0026gt; this._settle(REJECT, i, reason) ); };     åŸä½œè€…çš„å®ç°é€šè¿‡å°è£…äº†ä¸€ä¸ª Enumerator æ¥å®ç° Promise.all å…¶ä¸­æœ‰ä¸€ä¸ªæ„é€ å‡½æ•° (Enumerator)å’Œä¸‰ä¸ªåŸå‹å‡½æ•°(_settle, _willSettle, _enumrate)ã€‚\n  Enumerator æ¥å—ä¸€ä¸ª entries æ˜¯ä¸€ä¸ªæ•°ç»„\n æ„é€ å‡½æ•°åˆå§‹åŒ–äº†å‡ ä¸ªå˜é‡ï¼š\n  _length å³ entries ä»»åŠ¡çš„ä¸ªæ•°\n  _remaining ä»»åŠ¡çŠ¶æ€æ˜¯ PENDING çš„ä¸ªæ•°ï¼Œé€šè¿‡æ£€æµ‹è¿™ä¸ªæ˜¯ä¸æ˜¯ä¸ºé›¶æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ æ‰€æœ‰ä»»åŠ¡éƒ½ç»“æŸäº†ã€‚\n  _result ä¸€ä¸ªç»“æœæ•°ç»„ï¼Œä¿å­˜æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚\n    _settle æ£€æµ‹å½“å‰ entry çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ REJECT å°±è®© this.promise REJECT ï¼Œç»“æŸå¾ªç¯ï¼Œå¦åˆ™ä¿å­˜ç»“æœï¼Œæœ€åæ£€æµ‹ this._remaining ã€‚\n  _willSettle å› ä¸º entry çš„çŠ¶æ€å¯èƒ½æ˜¯ PENDING æ‰€ä»¥è¦æ‰§è¡Œè®¢é˜…ï¼Œç­‰å¾…å®ƒç»“æŸå†è¿› å…¥ _settle å›åˆ°ç¬¬ 2 æ­¥ã€‚\n   æ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„å®ç°å…³é”®å–å†³äº entry çŠ¶æ€æ˜¯å¦æ˜¯ç«‹å³æ”¹å˜äº†ï¼Œå¦‚æœæ˜¯ç›´æ¥æ£€æµ‹ç»“æœï¼Œå¦ åˆ™æ„é€ è¯¥ entry çš„ onFulfillment å’Œ onRejection å¹¶æ‰§è¡Œè®¢é˜…ï¼Œç­‰å¾…å®ƒç»“æŸå†æ£€æµ‹ ç»“æœã€‚æœ€åæ ¹æ®ç»“æœå†³å®š this.promise çŠ¶æ€ï¼Œå› ä¸º Promise.all FULFILL çš„æ¡ä»¶ æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½ FULFILL æ‰è¡Œï¼Œæ‰€ä»¥åªè¦é‡åˆ°ä¸€ä¸ª entry rejected äº†é‚£ä¹ˆ this.promise å°±åº”è¯¥ç»“æŸä¸”çŠ¶æ€æ˜¯ REJECT ã€‚\n æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p1 = new MyPromise(resolve =\u0026gt;{ Util.delay(() =\u0026gt; resolve(100), 100) }) const p2 = new MyPromise(resolve =\u0026gt;{ Util.delay(() =\u0026gt; resolve(200), 80) }) const p3 = new MyPromise((_, reject) =\u0026gt;{ Util.delay(() =\u0026gt; reject(300), 80) }) MyPromise.all([p1, p2]).then(result =\u0026gt; { console.log(result, \u0026#39;, promise all 1\u0026#39;) }) MyPromise.all([p1, p3]).then(null, reason =\u0026gt; { console.log(reason, \u0026#39;, promise all 2\u0026#39;) })    300 , promise all 2 [ 100, 200 ] , promise all 1   æ”¹æˆåŸç”Ÿ Promise ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p1 = new Promise(resolve =\u0026gt;{ Util.delay(() =\u0026gt; resolve(100), 100) }) const p2 = new Promise(resolve =\u0026gt;{ Util.delay(() =\u0026gt; resolve(200), 80) }) const p3 = new Promise((_, reject) =\u0026gt;{ Util.delay(() =\u0026gt; reject(300), 80) }) Promise.all([p1, p2]).then(result =\u0026gt; { console.log(result, \u0026#39;, promise all 1\u0026#39;) }) Promise.all([p1, p3]).then(null, reason =\u0026gt; { console.log(reason, \u0026#39;, promise all 2\u0026#39;) })    300 , promise all 2 [ 100, 200 ] , promise all 1   ç»“æœ OKã€‚\n  Promise.allSettled(entries)es2020  è¿™ä¸ªå’Œ Promise.all åŒºåˆ«åœ¨äºï¼Œå®ƒä¸åœ¨ä¹ entries ä¸­ä»»åŠ¡çš„çŠ¶æ€æ˜¯ FULFILL è¿˜æ˜¯ REJECT ï¼Œ åªè¦å®ƒçŠ¶æ€ settled å³å¯ï¼Œä¸”ä¼šç­‰åˆ°æ‰€æœ‰ä»»åŠ¡éƒ½ settled äº†æ‰ä¼š FULFILL ã€‚\n æ‰€ä»¥è¿™é‡Œçš„å®ç°å’Œ Promise.all ä¼šæœ‰æ‰€å·®åˆ«ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡å¯¹ Enumerator åšç»†å¾® æ”¹åŠ¨æ¥å®ç°ã€‚\n ä¿®æ”¹ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  function Enumerator(entries, option) { var p = (this.promise = new Ctor(noop)); // ä¿®æ”¹ç‚¹1ï¼šå¢åŠ  Promise.allSettled flag  this.isAllSettledFlag = false; if (typeof option === \u0026#34;object\u0026#34;) { this.isAllSettledFlag = !!option.isAllSettledFlag; } // ... çœç•¥  } Enumerator.prototype._settle = function (state, i, result) { var p = this.promise; if (p._state === PENDING) { this._remaining--; // api ä¸æ˜¯ Promise.allSettled  // ä¿®æ”¹ç‚¹2ï¼šå¢åŠ åˆ¤æ–­æ˜¯ä¸æ˜¯ Promise.allSettled è°ƒç”¨  if (state === REJECT \u0026amp;\u0026amp; !this.isAllSettledFlag) { reject(p, result); } else { this._result[i] = result; } } if (this._remaining === 0) { fulfill(p, this._result); } }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) const p1 = new MyPromise(resolve =\u0026gt;{ Util.delay(() =\u0026gt; resolve(100), 100) }) const p2 = new MyPromise(resolve =\u0026gt;{ Util.delay(() =\u0026gt; resolve(200), 80) }) const p3 = new MyPromise((_, reject) =\u0026gt;{ Util.delay(() =\u0026gt; reject(300), 80) }) MyPromise.allSettled([p1, p2]).then(result =\u0026gt; { console.log(result, \u0026#39;, promise allSettled 1 resolve\u0026#39;) }) MyPromise.allSettled([p1, p3]).then(value =\u0026gt; { console.log(value, \u0026#39;, promise allSettled 2 resolve\u0026#39;) })    [ 100, 200 ] , promise allSettled 1 resolve [ 100, 300 ] , promise allSettled 2 resolve    Promise.prototype.finally(onFinally)   è¿™ä¸ªå‡½æ•°ç›®çš„å°±æ˜¯ä¸ç®¡ promise ä»»åŠ¡æœ€é‡æ˜¯ fulfilled è¿˜æ˜¯ rejected éƒ½ä¼šè¢«æ‰§è¡Œã€‚\n å®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function originalFinally(callback) { var promise = this; var ctor = promise.constructor; // 1. ä¿è¯ callback æ€»æ˜¯æ‰§è¡Œï¼Œå³ç›¸å½“äºåœ¨æœ€ååˆæŒ‚äº†ä¸ª thenï¼Œ  // è¿™æ ·å°±èƒ½ä¿è¯ä¹‹å‰æœ‰å¤šå°‘ then ä¸”è¿™äº› then ç»“æœæ˜¯ fulfilled è¿˜æ˜¯ rejected  // è¿™ä¸ªéƒ½ä¼šè¢«æ‰§è¡Œ  // 2. å›è°ƒ callback è¦è¢«æ‰§è¡Œä¸”è¦ä¿è¯ callback çš„æ‰§è¡Œç»“æœ  // ä¹Ÿèƒ½ç¬¦åˆ promise then é“¾è§„åˆ™  if (typeof callback === \u0026#34;function\u0026#34;) { return promise.then( (value) =\u0026gt; ctor.resolve(callback(value)).then(() =\u0026gt; value), (reason) =\u0026gt; ctor.resolve(callback(reason)).then(() =\u0026gt; { throw reason; }) ); } return promise.then(callback, callback); }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) new Promise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;then 1\u0026#39;) }).finally(() =\u0026gt; { console.log(\u0026#39;finally 1\u0026#39;) }).then((val) =\u0026gt; { console.log(val, \u0026#39;then 2\u0026#39;) // è¿™é‡Œå¼•ç”¨æœªå£°æ˜ç±»å‹ï¼Œä¼šæŠ¥é”™  return a + b }, reason =\u0026gt; { console.log(reason.message, \u0026#39;reject 2\u0026#39;) }).finally(() =\u0026gt; { console.log(\u0026#39;finally 2\u0026#39;) }).finally(100).then(val =\u0026gt; { console.log(val, \u0026#39;then 3\u0026#39;) }, reason =\u0026gt; { console.log(reason.message, \u0026#39;reject 3\u0026#39;) })     åŸç”Ÿ Promise æ‰§è¡Œç»“æœ\n100 then 1 finally 1 undefined then 2 finally 2 a is not defined reject 3   æ³¨æ„è¿™é‡Œæœ‰å‡ ç‚¹åŠŸèƒ½éœ€è¦å®Œæˆï¼š\n  finally æ€»æ˜¯è¦è¢«æ‰§è¡Œ\n  finally çš„å‚æ•°å¯ä»¥æ˜¯æ™®é€šç±»å‹çš„å€¼\n  finally è°ƒç”¨ä¹‹ååé¢è¿˜å¯ä»¥ç»§ç»­é“¾å¼è°ƒç”¨ï¼Œå³å®ƒæ‰§è¡Œå®Œä¹Ÿè¦è¿”å›ä¸€ä¸ª Promise å®ä¾‹\n  æ¢æˆ MyPromise:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) new MyPromise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;then 1\u0026#39;) }).finally(() =\u0026gt; { console.log(\u0026#39;finally 1\u0026#39;) }).then((val) =\u0026gt; { console.log(val, \u0026#39;then 2\u0026#39;) // è¿™é‡Œå¼•ç”¨æœªå£°æ˜ç±»å‹ï¼Œä¼šæŠ¥é”™  return a + b }, reason =\u0026gt; { console.log(reason.message, \u0026#39;reject 2\u0026#39;) }).finally(() =\u0026gt; { console.log(\u0026#39;finally 2\u0026#39;) }).finally(100).then(val =\u0026gt; { console.log(val, \u0026#39;then 3\u0026#39;) }, reason =\u0026gt; { console.log(reason.message, \u0026#39;reject 3\u0026#39;) })    100 then 1 finally 1 undefined then 2 finally 2 a is not defined reject 3   ä½¿ç”¨ MyPromise ä¹‹ååˆä¸¤ä¸ªå¼‚å¸¸ï¼Œè¢«åé¢ä¸¤ä¸ª then rejection æ•è·åˆ°äº†ï¼š promise is not defined ï¼Œè¿™è¯´æ˜ finally\n å¢åŠ è¿”å›å€¼ä¼ é€’ç»™ finally å›è°ƒï¼Œæµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) new MyPromise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;then 1\u0026#39;) return 200 }).finally((val) =\u0026gt; { console.log(val, \u0026#39;, finally 1\u0026#39;) })    100 then 1 200 , finally 1 undefined    Promise.prototype.catch(onRejection)   ECMA262æ ‡å‡†æµç¨‹ï¼š\n26.6.5.1 Promise.prototype.catch ( onRejected ) When the catch method is called with argument onRejected, the following steps are taken: 1. Let promise be the this value. 2. Return ? Invoke(promise, \u0026#34;then\u0026#34;, Â« undefined, onRejected Â»).   å®ç°ï¼š\n1 2 3 4 5  MyPromise.prototype.catch = function (onRejection) { // å› ä¸ºå¦‚æœæœ‰å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šéšç€é“¾å¼è°ƒç”¨é“¾ä¸­ä¸€ç›´å¾€åæµï¼ŒçŸ¥é“è¢«å¤„ç†æ‰  // æ‰€ä»¥è¿™é‡Œåªè¦æŒ‚ä¸€ä¸ª then å»æ¥å—é”™è¯¯å¹¶å¤„ç†å°±å¯ä»¥äº†  return this.then(null, onRejection); }     æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  const { MyPromise, Util} = require(`${process.env.PWD}/../../static/js/promise.js`) new MyPromise(resolve =\u0026gt; { Util.delay(resolve(100)) }).then(val =\u0026gt; { console.log(val, \u0026#39;, then 1\u0026#39;) return a + b }).catch(err =\u0026gt; { console.log(err.message) return 200 }).then(val =\u0026gt; { console.log(val, \u0026#39;, then 2\u0026#39;) })    100 , then 1 a is not defined 200 , then 2   then 2 èƒ½å¤Ÿè¾“å‡ºæ˜¯å› ä¸º then 1 çš„é”™è¯¯è¢« catch å¤„ç†æ‰äº†ï¼Œæ‰€ä»¥ then 2 å¯ä»¥æ­£å¸¸ resolveã€‚\n    å®Œæ•´è„‘å›¾     Jest æµ‹è¯•  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93  const Promise = require(\u0026#34;./promise.js\u0026#34;).MyPromise; const delay = (fn, t) =\u0026gt; setTimeout(fn, t); const log = (...args) =\u0026gt; console.log.apply(console, args); describe(\u0026#34;Promise\u0026#34;, () =\u0026gt; { test(\u0026#34;Promise then resolve\u0026#34;, () =\u0026gt; { return new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100))).then((value) =\u0026gt; expect(value).toBe(100) ); }); test(\u0026#34;Promise then reject\u0026#34;, () =\u0026gt; { return new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;test reject\u0026#34;)) ).then(null, (reason) =\u0026gt; expect(reason).toBe(\u0026#34;test reject\u0026#34;)); }); test(\u0026#34;Promise catch\u0026#34;, () =\u0026gt; { return new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100))) .then(() =\u0026gt; a /* a is not defined */) .catch((err) =\u0026gt; expect(err.message).toBe(\u0026#34;a is not defined\u0026#34;)); }); test(\u0026#34;Promise finally\u0026#34;, () =\u0026gt; { return new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100))) .then((value) =\u0026gt; 200) .finally((result) =\u0026gt; expect(result).toBe(200)); }); test(\u0026#34;Promise finally with catch\u0026#34;, () =\u0026gt; { return new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100))) .then((value) =\u0026gt; a) .catch((err) =\u0026gt; err.message) .finally((result) =\u0026gt; expect(result).toBe(\u0026#34;a is not defined\u0026#34;)); }); test(\u0026#34;Promise all\u0026#34;, () =\u0026gt; { const p1 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100), 100)); const p2 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(200), 200)); const p3 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(300), 80)); const p4 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(400), 120)); let pa1 = Promise.all([p1, p4]).then((value) =\u0026gt; value); let pa2 = Promise.all([p1, p2]).then(null, (reason) =\u0026gt; reason); let pa3 = Promise.all([p2, p3]).then(null, (reason) =\u0026gt; reason); return Promise.allSettled([pa1, pa2, pa3]).then((value) =\u0026gt; expect(value).toStrictEqual([[100, 400], 200, 300]) ); }); test(\u0026#34;Promise allSettled\u0026#34;, () =\u0026gt; { const p1 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100), 100)); const p2 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;p2 reject\u0026#34;), 200) ); const p3 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(300), 120)); return Promise.allSettled([p1, p2, p3]).then((value) =\u0026gt; expect(value).toStrictEqual([100, \u0026#34;p2 reject\u0026#34;, 300]) ); }); test(\u0026#34;Promise race resolve\u0026#34;, () =\u0026gt; { const p1 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100), 100)); const p2 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;p2 reject\u0026#34;), 200) ); return Promise.race([p2, p1]).then((value) =\u0026gt; expect(value).toBe(100)); }); test(\u0026#34;Promise race reject\u0026#34;, () =\u0026gt; { const p1 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100), 100)); const p2 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;p2 reject\u0026#34;), 80)); return Promise.race([p2, p1]).then(null, (reason) =\u0026gt; expect(reason).toBe(\u0026#34;p2 reject\u0026#34;) ); }); test(\u0026#34;Promise any resolve\u0026#34;, () =\u0026gt; { const p1 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100), 100)); const p2 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;p2 reject\u0026#34;), 80)); const p3 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;p3 reject\u0026#34;), 80)); return Promise.any([p2, p1, p3]).then((value) =\u0026gt; expect(value).toBe(100)); }); test(\u0026#34;Promise any reject\u0026#34;, () =\u0026gt; { const p1 = new Promise((resolve) =\u0026gt; delay(() =\u0026gt; resolve(100), 100)); const p2 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;p2 reject\u0026#34;), 80)); const p3 = new Promise((_, reject) =\u0026gt; delay(() =\u0026gt; reject(\u0026#34;p3 reject\u0026#34;), 80)); return Promise.any([p2, p3]).then(null, (value) =\u0026gt; expect(value).toStrictEqual([\u0026#34;p2 reject\u0026#34;, \u0026#34;p3 reject\u0026#34;]) ); }); });     ç»“æœï¼š\nâœ js git:(master) âœ— jest jest PASS ./promise.spec.js (5.19s) Promise âœ“ Promise then resolve (11ms) âœ“ Promise then reject (3ms) âœ“ Promise catch (5ms) âœ“ Promise finally (4ms) âœ“ Promise finally with catch (6ms) âœ“ Promise all (205ms) âœ“ Promise allSettled (204ms) âœ“ Promise race resolve (101ms) âœ“ Promise race reject (85ms) âœ“ Promise any resolve (102ms) âœ“ Promise any reject (85ms) Test Suites: 1 passed, 1 total Tests: 11 passed, 11 total Snapshots: 0 total Time: 9.801s Ran all test suites.    æ€»ç»“   Promise å®ç°å…³é”®ç‚¹ï¼š\n  resolver ç«‹å³æ‰§è¡Œï¼Œ resolve/reject å°è£…ä¹‹åæš´éœ²ç»™ resolver çš„ä½¿ç”¨è€…è°ƒç”¨ï¼Œæ¯” å¦‚ï¼šè¯·æ±‚æˆåŠŸè°ƒç”¨ resolve(value), è¯·æ±‚å¤±è´¥è°ƒç”¨ reject(reason) ã€‚\n  resolve å‡½æ•°å®ç°éœ€è¦åˆ¤æ–­å„ç§æƒ…å†µï¼Œä¸»è¦åŒ…å«ï¼š\n  ä¸èƒ½å¤„ç†è‡ªèº«ï¼Œä¼šé€ æˆæ­»å¾ªç¯ï¼Œå³ then çš„ callback é‡Œé¢ä¸èƒ½è¿”å›å½“å‰ promise å® ä¾‹è‡ªèº«\n  å¦‚æœæ˜¯å¯¹è±¡æˆ–å‡½æ•°ï¼Œè¦è€ƒè™‘åˆ°æä¾›äº† then(resolve, reject) å‡½æ•°æƒ…å†µ\n  æ˜¯ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚\n    ä»»åŠ¡åˆ†ç«‹å³å®Œæˆå’Œå»¶æ—¶å®Œæˆæƒ…å†µï¼Œç«‹å³å®Œæˆçš„ä»£è¡¨çŠ¶æ€ç«‹å³æ”¹å˜äº†ç›´æ¥åœ¨ then å‡½æ•°ä¸­ fulfill æˆ– reject å³å¯ï¼Œå¦‚æœæ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦é€šè¿‡è®¢é˜…(subscribe)æ¥å®ç°ã€‚\n  then å‡½æ•°ä¸­ä¸ºäº†é“¾å¼è°ƒç”¨ï¼Œéœ€è¦æ–°å»ºä¸€ä¸ª child promise ä½œä¸ºè¿”å›å€¼ã€‚\n  Promise.all, allSettled, any è¿™å‡ ä¸ª api çš„å®ç°é€šè¿‡ Enumerator å°è£…ã€‚\n  Promise.all å®ç°åŸç†ï¼Œéå†æ‰€æœ‰ä»»åŠ¡ï¼ŒåŒæ­¥çš„ç›´æ¥è®°å½•ç»“æœï¼Œå¼‚æ­¥çš„è®¢é˜…ç»“æœï¼Œå¼‚ æ­¥å®Œæˆä¹‹åæ£€æµ‹æœ€ç»ˆçš„å€¼ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­åªè¦ä¸­é—´æœ‰ä»»ä¸€ä¸ª REJECT äº†, Promise.all() çŠ¶æ€ç«‹å³æ”¹å˜ä¸º REJECT ç»“æŸï¼Œè¿”å›ç»“æœæ˜¯ï¼š FULFILL-ç»“æœæ•°ç»„ï¼Œ REJECT-å¤±è´¥åŸå› ã€‚\n  Promise.allSettled å®ç°åŸç†ä¸ Promise.all å¤§ç›¸å¾„åº­ï¼Œåªè¦å°† Promise.all é‡Œé¢ é‡åˆ° REJECT çš„å¤„ç†æ”¹æˆè®°å½•ç»“æœå°±è¡Œï¼Œæœ€åæ‰€æœ‰çš„å®Œæˆä¹‹åå°± FULFILL ï¼Œè¿”å›ç»“æœ æ˜¯æ‰€æœ‰ä»»åŠ¡ FULFILL ç»“æœæˆ–æ‰€æœ‰ REJECT åŸå› ç»„æˆçš„æ•°ç»„ã€‚\n  Promise.any çš„å®ç°ä¸ Promise.all åˆšå¥½ç›¸åï¼Œå®ƒåªè¦é‡åˆ°æœ‰ä¸€ä¸ª FULFILL å°±ç»“æŸï¼Œ è¿”å› FULFILL çŠ¶æ€ï¼Œé™¤éæ‰€æœ‰çš„éƒ½ REJECT äº†æ‰ä¼š REJECT ï¼Œè¿”å›ç»“æœå€¼ä¸ºï¼š FULFILL-æˆåŠŸç»“æœå€¼ï¼Œ REJECT-è¿”å›æ‰€æœ‰å¤±è´¥ä»»åŠ¡çš„åŸå› ç»„æˆçš„æ•°ç»„ã€‚\n    ","permalink":"https://www.cheng92.com/web/javascript-ecma-promise/","tags":["javascript,","es6,","promise"],"title":"JavaScript - Promise å®ç°(0-1)"},{"categories":["life"],"contents":" å¤é™µé€çƒŸ   çƒŸéƒ½ä¼—äººå´‡ä»°çš„å¤§å®—å¸ˆï¼Œä¹ƒåˆ›ç«‹çƒŸéƒ½åŸºä¸šä¸ä¼ ç»Ÿä¹‹äººã€‚ä¸ºäººé«˜æ·±è«æµ‹ï¼Œå†·å³»ç»è‰³ï¼Œæ­¦å­¦é€ è¯£æœ‰â€œä¸€å¼ç•™ç¥â€ä¹‹ç¾ç§°ï¼Œå¤©åœ°äººä¸‰å‰‘æ›´æ˜¯éœ‡æ…‘å½“ä¸–ã€‚æ€§æ ¼å†·è¨€ç–æ·¡ï¼Œçœ‹ä¼¼é€€å±…å¹•åï¼Œå´å‡¡äº‹å°½åœ¨å…¶çœ¼ä¸­ï¼Œç´ ä»¥å•†äººé‡åˆ©æ–½æ©å–ä¹‰è‡ªå±…ï¼Œæ¸¸èµ°å„æ–¹åæ”¶æ¸”åˆ©ï¼Œè¿ç­¹å¸·å¹„æŒæ§çƒŸéƒ½è¡Œäº‹æ–¹é’ˆã€‚å¿ƒæœºæ·±æ²‰éš¾ä»¥è‡†æµ‹ï¼Œå…³ç³»ç€å†°æ¥¼è¡€æ¡ˆä¸å·¨é­”ç¥å¤±è½ä¹‹è°œ [1] ã€‚\n  è¯—å·ï¼šå†·ç¯çœ‹å‰‘ï¼Œå‰‘ä¸Šå‡ ç•ªåŠŸåï¼Ÿç‚‰é¦™æ— é¡»è®¡è‹ç”Ÿï¼Œçºµä¸€å·çƒŸé€ï¼Œä¸‡ä¸ˆäº‘åŸ‹ï¼Œå­¤é˜³è¿˜ç…§å¤é™µã€‚  \n    è§†é¢‘æ”¶é›†     ","permalink":"https://www.cheng92.com/post/life-bdx-persons/","tags":["life,","interesting,","funny"],"title":"sié“å‹å…siè´«é“"},{"categories":["vue"],"contents":"   è¯—å·ï¼šå†·ç¯çœ‹å‰‘ï¼Œå‰‘ä¸Šå‡ ç•ªåŠŸåï¼Ÿç‚‰é¦™æ— é¡»è®¡è‹ç”Ÿï¼Œçºµä¸€å·çƒŸé€ï¼Œä¸‡ä¸ˆäº‘åŸ‹ï¼Œå­¤é˜³è¿˜ç…§å¤é™µã€‚  \n vue-next methods need polyfills   String.fromCodePoint, startsWith, some, filter, Array.from\n  ä¸‡èƒ½çš„ Counter  1 2 3 4 5 6 7 8 9 10 11  { // test  const Counter = { data() { return { counter: 0, }; }, }; Vue.createApp(Counter).mount(\u0026#34;#v-test-counter\u0026#34;); }    Counter: {{ counter }} + \u0026nbsp;-    0001_0002-new-slot-syntax   æ–° slot è¯­æ³•ã€‚\n  æ–° v-slot æŒ‡ä»¤å°† slot å’Œ slot-scope è¯­æ³•åˆå¹¶åˆ°ä¸€èµ·äº†\n  v-slot çš„ç¼©å†™(#) åˆå¹¶äº† scoped å’Œ normal slots\n  slot-scope 3.0 ä¸­ä¼šè¢«ç§»é™¤\n   result:\n{{ msg }} 2. æˆ‘æ˜¯æ²¡æœ‰å±æ€§çš„å…·åæ’æ§½ {{ msg }} -- {{ msg }}   # -- {{ msg }}   5. æ’æ§½åµŒå¥—ï¼š{{ foo }} {{ bar }} {{ baz }}    6. æ’æ§½åˆ«åï¼š  Loading...\n {{ user.name }}  Error: {{ error.message }}\n     template:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  \u0026lt;div id=\u0026#34;v-test-slot\u0026#34;\u0026gt; \u0026lt;!-- 1. é»˜è®¤ slot --\u0026gt; \u0026lt;Foo v-slot=\u0026#34;{ msg }\u0026#34; :style=\u0026#34;{color: \u0026#39;red\u0026#39;}\u0026#34;\u0026gt; {{ msg }}\u0026lt;/Foo\u0026gt; \u0026lt;!-- 2. æ— å±æ€§çš„å…·åæ’æ§½ --\u0026gt; \u0026lt;Foo v-slot:zero :style=\u0026#34;{color: \u0026#39;purple\u0026#39;}\u0026#34;\u0026gt;2. æˆ‘æ˜¯æ²¡æœ‰å±æ€§çš„å…·åæ’æ§½\u0026lt;/Foo\u0026gt; \u0026lt;!-- ä¹Ÿå¯ä»¥ä½¿ç”¨ç¼©å†™ \u0026lt;Foo #=\u0026#34;{ msg }\u0026#34;\u0026gt;{{ msg }}\u0026lt;/Foo\u0026gt; --\u0026gt; \u0026lt;!-- 3. å…·åæ’æ§½ --\u0026gt; \u0026lt;Foo :style=\u0026#34;{color: \u0026#39;blue\u0026#39;}\u0026#34;\u0026gt; \u0026lt;!-- å…·å slot --\u0026gt; \u0026lt;template v-slot:one=\u0026#34;{ msg }\u0026#34;\u0026gt; {{ msg }} \u0026lt;/template\u0026gt; \u0026lt;/Foo\u0026gt; \u0026lt;!-- 4. å…·åæ’æ§½ï¼ŒæŒ‡ä»¤ç¼©å†™ï¼š v-bind -\u0026gt; # --\u0026gt; \u0026lt;Foo :style=\u0026#34;{color: \u0026#39;green\u0026#39;}\u0026#34;\u0026gt; \u0026lt;template #two=\u0026#34;{ msg }\u0026#34;\u0026gt; {{ msg }} \u0026lt;/template\u0026gt; \u0026lt;/Foo\u0026gt; \u0026lt;!-- 5. åµŒå¥—æ’æ§½ --\u0026gt; \u0026lt;Foo2 v-slot=\u0026#34;foo\u0026#34; :style=\u0026#34;{ color: \u0026#39;darkorchid\u0026#39; }\u0026#34;\u0026gt; \u0026lt;bar v-slot=\u0026#34;bar\u0026#34;\u0026gt; \u0026lt;baz v-slot=\u0026#34;baz\u0026#34;\u0026gt; 5. æ’æ§½åµŒå¥—ï¼š{{ foo }} {{ bar }} {{ baz }} \u0026lt;/baz\u0026gt; \u0026lt;/bar\u0026gt; \u0026lt;/Foo2\u0026gt; \u0026lt;!-- 6. æ’æ§½åˆ«å --\u0026gt; \u0026lt;Bax style=\u0026#34;color:slateblue;\u0026#34;\u0026gt; \u0026lt;template #default\u0026gt; 6. æ’æ§½åˆ«åï¼š \u0026lt;/template\u0026gt; \u0026lt;template #pending\u0026gt; \u0026lt;p\u0026gt;Loading...\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;template #resolved=\u0026#34;{ users }\u0026#34;\u0026gt; \u0026lt;ul\u0026gt;\u0026lt;li v-for=\u0026#34;user in users\u0026#34;\u0026gt;{{ user.name }}\u0026lt;/li\u0026gt;\u0026lt;/ul\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;template #rejected=\u0026#34;{ error }\u0026#34;\u0026gt; \u0026lt;p\u0026gt;Error: {{ error.message }}\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/Bax\u0026gt; \u0026lt;/div\u0026gt;     javascript:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71  { // slot è¯­æ³•  const app = Vue.createApp({ data() { return { msg: \u0026#34;hello slot !\u0026#34;, }; }, }); app.component(\u0026#34;foo\u0026#34;, { data() { return { defaultSlotMsg: \u0026#34;1. æˆ‘æ˜¯é»˜è®¤æ’æ§½ defaultï¼Œç›´æ¥åº”ç”¨åœ¨ Foo ä¸Š \u0026lt;Foo v-slot\u0026gt;\u0026#34;, namedSlotMsg: \u0026#34;3. æˆ‘æ˜¯å…·åæ’æ§½\u0026#34;, shortSlotMsg: \u0026#34;4. æˆ‘æ˜¯æ’æ§½æŒ‡ä»¤ç¼©å†™ shorthand\u0026#34;, }; }, template: ` \u0026lt;div\u0026gt; \u0026lt;slot :msg=\u0026#34;defaultSlotMsg\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;slot name=\u0026#34;zero\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;slot name=\u0026#34;one\u0026#34; :msg=\u0026#34;namedSlotMsg\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;slot name=\u0026#34;two\u0026#34; :msg=\u0026#34;shortSlotMsg\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;/div\u0026gt;`, }); app.component(\u0026#34;foo2\u0026#34;, { data() { return { foo: \u0026#34;foo\u0026#34; }; }, template: `\u0026lt;div\u0026gt;\u0026lt;slot :foo=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt;\u0026lt;/div\u0026gt;`, }); app.component(\u0026#34;bar\u0026#34;, { data() { return { bar: \u0026#34;bar\u0026#34; }; }, template: `\u0026lt;div\u0026gt;\u0026lt;slot :bar=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt;\u0026lt;/div\u0026gt;`, }); app.component(\u0026#34;baz\u0026#34;, { data() { return { baz: \u0026#34;baz\u0026#34; }; }, template: `\u0026lt;div\u0026gt;\u0026lt;slot :baz=\u0026#34;baz\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt;\u0026lt;/div\u0026gt;`, }); app.component(\u0026#34;bax\u0026#34;, { data() { return { users: [{ name: \u0026#34;foo\u0026#34; }, { name: \u0026#34;bar\u0026#34; }, { name: \u0026#34;baz\u0026#34; }], error: { message: \u0026#34;æ¥å£è¿”å› 500, åç«¯æ¥é”…ã€‚\u0026#34;, }, }; }, template: ` \u0026lt;div\u0026gt; \u0026lt;slot\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;div :style=\u0026#34;{ \u0026#39;text-indent\u0026#39;: \u0026#39;1rem\u0026#39; }\u0026#34;\u0026gt; \u0026lt;slot name=\u0026#34;pending\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;slot name=\u0026#34;resolved\u0026#34; :users=\u0026#34;users\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;slot name=\u0026#34;rejected\u0026#34; :error=\u0026#34;error\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt;`, }); app.mount(\u0026#34;#v-test-slot\u0026#34;); }     æ³¨æ„ç‚¹ ï¼š\n This is why I now believe allowing using slot-scope without a template was a mistake.\n è¨€å¤–ä¹‹æ„ï¼šè¯·ç»“åˆ \u0026lt;template\u0026gt; å»ä½¿ç”¨ slot\n   TODO 0003-dynamic-directive-arguments   import js     ","permalink":"https://www.cheng92.com/vue/vue-next-rfcs/","tags":["vue,","vue3,","vuenext"],"title":"Vue3.0 RFCs è¿‡çœ¼äº‘çƒŸ(å¤é™µé€çƒŸ)"},{"categories":["css3"],"contents":" æµ‹è¯•   é€‰æ‹©å™¨  :not + :last-child   å¯ä»¥é€šè¿‡\n1 2 3  element:not(:last-child) { // ä½œç”¨äºéæœ€åä¸€ä¸ªå…ƒç´ ä¸Š }        ","permalink":"https://www.cheng92.com/post/css/css3/","tags":["css3"],"title":"CSS3 é»‘æ£®æ—"},{"categories":["javascript"],"contents":"    regenerator: npm install -g renerator å°† es6+ è¯­æ³•ç¼–è¯‘æˆ es5 è¯­æ³•\n   ç¤¾åŒºé“¾æ¥     name link     esdiscuss.org es æ ‡å‡†è®¨è®ºç¤¾åŒº   ecma262 å®˜æ–¹æ ‡å‡†æ–‡æ¡£   ecma262 å®˜æ–¹æ ‡å‡†æ–‡æ¡£      äº‹ä»¶   w3äº‹ä»¶æ¥å£ï¼šDocument Object Model Events\n w3 äº‹ä»¶æµUI Events\n  äº‹ä»¶ä¿®é¥°ç¬¦(capture,passive,once)\n  æ•è·(capture)+å†’æ³¡(bubble)   ç™½è¯è§£é‡Š Javascriptäº‹ä»¶preventDefault,stopPropagationåŠreturn falseçš„åŒºåˆ« - SegmentFault æ€å¦\n    æ“ä½œç¬¦   operator.\ndelete   ReturnIfAbrupt\n IsPropertyReference ( V ): Type(V.[[Base]]) æ˜¯ Boolean,String,Symbol,BigInt, Number, Object è¿”å› true, å¦åˆ™ false.\n IsSuperReference ( V ): V.[[ThisValue]] éç©ºè¿”å› trueï¼Œå¦åˆ™ false ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  let ref = UnaryExpression ReturnIfAbrupt(ref) if (ref is not ReferenceRecord) { return true } if (IsUnresolvableReference(ref)) { assert(ref.[[Strict]] === false) return true } if (IsPropertyReference(ref)) { if (IsSuperReference(ref)) { throw new ReferenceError() } let baseObj = ToObject(ref.[[Base]]) let deleteStatus = baseObj.[[Delete]](ref.[[ReferencedName]]) if (deleteStatus === false \u0026amp;\u0026amp; ref.[[Strict]]) { throw new TypeError() } return deleteStatus } else { let base = ref.[[Base]] assert(base is EnvironmentRecord) return base.DeleteBinding(ref.[[ReferencedName]]) }      in  RelationalExpression : RelationalExpression in ShiftExpression 1. Let lref be the result of evaluating RelationalExpression. 2. Let lval be ? GetValue(lref). 3. Let rref be the result of evaluating ShiftExpression. 4. Let rval be ? GetValue(rref). 5. If Type(rval) is not Object, throw a TypeError exception. 6. Return ? HasProperty(rval, ? ToPropertyKey(lval)).   code:\n1 2 3 4 5 6 7 8 9 10  function in(lRelationalExp, rShiftExp) { let lref = lRelationalExp() let lval = GetValue(lref) let rref = rShiftExp() let rval = GetValue(rref) if (!isObject(rval)) { throw new TypeError(\u0026#39;right shift expression is not object.\u0026#39;) } return HasProperty(rval, ToProperty(lval)) }     -\u0026gt; HasProperty(O, P)\n    Document  Document.execCommand()     Array  Array.from(items[, mapfn[, thisArg]])  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93  let C = this let mapping if (mapfn === undefined) { mapping = false } else { if (!IsCallable(mapfn)) { throw new TypeError() } mapping = true } let usingIterator = GetMthod(items, @@iterator) let A if (usingIterator) { if (IsConstructor(C)) { A = Construct(C) } else { // å¯èƒ½æ˜¯è¢«å€Ÿç”¨äº†ï¼Œå¦‚ï¼šArray.from.call(...)  A = ArrayCreate(0) } let iteratorRecord = GetIterator(items, sync, usingIterator) let k = 0, error while (true) { if (k \u0026gt;= Math.pow(2, 53) - 1) { // æº¢å‡ºäº†  error = ThrowCompletion(new TypeError()) return IteratorClose(iteratorRecord, error) } let Pk = ToString(k) let next = IteratorStep(iteratorRecord) // çŸ¥é“è¿­ä»£å™¨è¿­ä»£ç»“æŸï¼Œæ²¡æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ äº†ä½œä¸ºç»ˆæ­¢æ¡ä»¶  if (!next) { // åªæœ‰ä¸€ä¸ªå…ƒç´   Set(A, \u0026#39;length\u0026#39;, k, true) return A } let nextValue = IteratorValue(next) let mappedValue if (mapping) { mappedValue = Call(mapfn, thisArg, \u0026lt;\u0026lt;nextValue, k\u0026gt;\u0026gt;) if (mappedValue is AbruptCompletion) { // ç»ˆæ­¢è¿­ä»£  return IteatorClose(iteratorRecord, mappedValue) } mappedValue = mappedValue.[[Value]] } else { mappedValue = nextValue } let defineStatus = CreateDataPropertyOrThrow(A, Pk, mappedValue) if (defineStatus is AbruptCompletion) { return IteratorClose(iteratorRecord, defineStatus) } k++ } // NOTE: items ä¸æ˜¯ä¸ª iterable å¯¹è±¡ï¼Œå¯èƒ½æ˜¯ç±»æ•°ç»„å¯¹è±¡  let arrayLike = ToObject(items) let len = LengthOfArrayLike(arrayLike) if (IsConstructor(C)) { A = Construct(C, len) } else { A = ArrayCreate(len) } let k = 0 // ç±»æ•°ç»„å¯¹è±¡ï¼Œé¦–å…ˆç”±è‡ªå·±çš„ length å±æ€§  while (k \u0026lt; len) { let Pk = ToString(k) let kValue = Get(arrayLike, Pk) if (mapping) { mappedValue = Call(mapfn, thisArg, \u0026lt;\u0026lt;kValue, k\u0026gt;\u0026gt;) } else { mappedValue = kValue } CreateDataPropertyOrThrow(A, Pk, mappedValue) k++ } Set(A, \u0026#39;length\u0026#39;, len, true) return A }     å®ç°åˆ†ä¸¤ç§æƒ…å†µï¼š\n  æ•°ç»„ç±»å‹ï¼Œç›´æ¥ while å¾ªç¯å–è¿­ä»£å™¨ next ä¸‹ä¸€ä¸ªå€¼\n  ç±»æ•°ç»„ç±»å‹ï¼Œå– len while å¾ªç¯å¯¹è±¡å–å€¼è®¾å€¼æ“ä½œ\n  ä¸¤ç§æƒ…å†µè®¾å€¼æ“ä½œéƒ½æ­»è°ƒç”¨çš„ CreateDataPropertyOrThrow æœ€ç»ˆä½¿ç”¨çš„æ˜¯ O.[[DefineOwnProperty]](P, newDesc) ç»™å¯¹è±¡è¿½åŠ å±æ€§ã€‚\n newDesc: {[[Value]]: V, [[Writable]]: true, [[Enumerable]]: true, [[Configurable]]: true}\n  Array.prototype.includes   Array.prototype.slice(start, end)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  function slice(start, end) { let O = ToObject(this) let len = LengthOfArrayLike(O) let relativeStart = ToIntegerOrInfinity(start) let k // æœ€ç»ˆç›®çš„æ˜¯å– start ç´¢å¼•  if (relativeStart === -Infinity) { k = 0 } else if (relativeStart \u0026lt; 0) { k = max(len + relativeStart, 0) } else { k = min(relativeStart, len) } let relativeEnd // å–ç»“æŸç´¢å¼•  if (end === undefined) { relativeEnd = len } else { relativeEnd = ToIntegerOrInfinity(end) } // å’Œ relativeStart ä¸€æ ·åšä¸€éç´¢å¼•å¤„ç†  let final if (relativeEnd === -Infinity) { final = 0 } else if (relativeEnd \u0026lt; 0) { final = max(len + relativeEnd, 0) } else { final = min(relativeEnd, len) } let count = max(final - k, 0) // åˆ›å»ºä¸ªç©ºæ•°ç»„  let A = ArraySpeciesCreate(O, count) let n = 0 // æ•°ç»„é•¿åº¦  while (k \u0026lt; final) { let Pk = ToString((k)) let kPresent = HasProperty(O, count) if (kPresent) { // å·²ç»å­˜åœ¨  let kValue = Get(O, Pk) // åˆ›å»ºæ–°å±æ€§  CreateDataPropertyOrThrow(A, ToString(n), kValue) } k++ n++ } Set(A, \u0026#39;length\u0026#39;, n, true) return A }      Array.prototype.reverse()  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  function revers() { const O = ToObject(this) let len = LengthOfArrayLike(O) let middle = floor(len / 2) let lower = 0 while (lower !== middle) { let upper = len - lower - 1 // å¯¹ç§°çš„æœ€åé¢é‚£ä¸ª  let upperP = ToString(upper) let lowerP = ToString(lower) let lowerExists = HasProperty(O, lowerP) let lowerValue, upperValue if (lowerExists) { lowerValue = Get(O, lowerP) } let upperExists = HasProperty(O, upperP) if (upperExists) { upperValue = Get(O, upperP) } if (lowerExists \u0026amp;\u0026amp; upperExists) { // å€¼äº’æ¢  set(O, lowerP, upperValue, true) set(O, upperP, lowerValue, true) } else if (!lowerExists \u0026amp;\u0026amp; upperExists) { set(O, lowerP, upperValue, true) DeletePropertyOrThrow(O, upperP) // å› ä¸ºå·¦ä¾§æ²¡å€¼ï¼Œæ‰€ä»¥å°†å³ä¾§ä½ç½®åˆ é™¤  } else if (lowerExists \u0026amp;\u0026amp; !upperExists) { DeletePropertyOrThrow(O, lowerP) // å› ä¸ºå³ä¾§æ²¡å€¼ï¼Œæ‰€ä»¥å°†å·¦ä¾§ä½ç½®åˆ é™¤  set(O, upperP, lowerValue, true) } else { assert(!lowerExists \u0026amp;\u0026amp; !upperExists) } lower++ } return O }        Map  Map([iterable])   Map.prototype.clear()   Map.prototype.constructor   Map.prototype.delete(key)   Map.prototype.entries()   Map.prototype.forEach(callback)   Map.prototype.get(key)  1 2 3 4 5 6 7 8 9 10 11 12 13  function get(key) { let M = this RequireInternalSlot(M, [[MapData]]) let entries = M.[[MapData]] // list  for (let { [[Key]], [[Value]] }p of entries) { if (p.[[Key]] \u0026amp;\u0026amp; SameValueZero(p.[[Key]], key)) return p.[[Value]] } return undefined }     å–å‡ºMap æ•°æ®åˆ—è¡¨ï¼Œéå†æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„å€¼ã€‚\n  Map.prototype.has(key)   Map.prototype.keys()   Map.prototype.set(key,value)   Map.prototype.size   Map.prototype.values()     Proxy \u0026amp; Reflect   å¯è¢«ä»£ç†çš„æ¥å£åˆ—è¡¨:\n   å†…éƒ¨æ–¹æ³• ä»£ç†handleræ–¹æ³• åŸå­æ“ä½œ Reflect æ–¹æ³•     [[GetProtoypeOf]] getPrototypeOf Object.getPrototypeOf(target) Reflect.getPrototypeOf(obj)   [[SetPrototypeOf]] setPrototypeOf Object.setPrototypeOf(target, proto) Reflect.setPrototypeOf(obj, protoObj)   [[IsExtensible]] isExtensible Object.isExtensible(proxy) Reflect.isExtensible(obj)   [[PreventExtensions]] preventExtensions Object.preventExtensions(obj) Reflect.preventExtensions(obj)   [[GetOwnProperty]](P) getOwnPropertyDescriptor Object.getOwnPropertyDescriptor Reflect.getOwnPropertyDescriptor(obj, \u0026#39;prop\u0026#39;)   [[DefineOwnProperty]](P, desc) defineProperty å±æ€§å®šä¹‰å‡½æ•°: Object.defineProperty(obj, key, value) Reflect.defineProperty(obj, \u0026#39;prop\u0026#39;, descriptors)   [[HasProperty]](P) has å±æ€§æ£€æµ‹æ“ä½œç¬¦ï¼š name in obj Reflect.has(obj, \u0026#39;prop\u0026#39;)   [[Get]](P, Receiver) get å–å€¼æ“ä½œï¼Œå¦‚ï¼š obj.name Reflect.get(obj, prop)   [[Set]](P, V, Receiver) set èµ‹å€¼æ“ä½œï¼Œå¦‚ï¼š obj.name = 1 Reflect.set(obj, prop, value)   [[Delete]](P) deleteProperty å±æ€§åˆ é™¤æ“ä½œï¼Œå¦‚ï¼š delete obj.name Reflect.deleteProperty(obj.prop)   [[OwnPropertyKeys]]() ownKeys Object.getOwnPropertyNames å’Œ Object.getOwnPropertySymbols Reflect.ownKeys(obj)   [[Call(thisArgument, argumentsList)]] apply å‡½æ•°è°ƒç”¨ proxy1(1, 2) æ“ä½œè§¦å‘ Reflect.apply(target, thisArg, argumentsList)   [[Construct]](argumentsList, newTarget) construct new Func() æ“ä½œ Reflect.construct(fn, args)    ProxyCreate(target, handler)abstract    åˆ›å»ºåŸºæœ¬å¯¹è±¡ P\n  è®¾ç½®å†…éƒ¨å‡½æ•° -\u0026gt; handler å‡½æ•°æ˜ å°„\n  Callable(target) å•ç‹¬å¤„ç†\n  Construct(target) å•ç‹¬å¤„ç†\n  è®¾ç½® P.[[ProxyHandler]] = handler\n  è®¾ç½® P.[[ProxyTarget]] = target\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  function ProxyCreate(target, handler) { if (Type(target) !== \u0026#39;object\u0026#39;) { throw new TypeError(\u0026#39;target required object.\u0026#39;) } if (Type(handler) !== \u0026#39;object\u0026#39;) { throw new TypeError(\u0026#39;handler required object.\u0026#39;) } let P = MakeBasicObject(\u0026lt;\u0026lt;[[ProxyHandler]], [[ProxyTarget]]\u0026gt;\u0026gt;) // è®¾ç½® P é™¤äº† [[Call]] å’Œ [[Construct]] ä¹‹å¤–çš„ä¸»è¦å†…éƒ¨æ–¹æ³•  // Internal Method -\u0026gt; Handler Method  // [[GetPrototypeOf]] -\u0026gt; getPrototypeOf  // [[SetPrototypeOf]] -\u0026gt; setPrototypeOf  // [[IsExtensible]] -\u0026gt; isExtensible  // [[PreventExtensions]] -\u0026gt; preventExtensions  // [[GetOwnProperty]] -\u0026gt; getOwnPropertyDescriptor  // [[DefineOwnProperty]] -\u0026gt; defineProperty  // [[HasProperty]] -\u0026gt; has  // [[Get]] -\u0026gt; get  // [[Set]] -\u0026gt; set  // [[Delete]] -\u0026gt; deleteProperty  // [[OwnPropertyKeys]] -\u0026gt; ownKeys  // [[Call]] -\u0026gt; apply  // [[Construct]] -\u0026gt; construct  if (IsCallable(target)) { // set P.[[Call]]  if (IsConstructor(target)) { // set P.[[Construct]]  } } P.[[ProxyTarget]] = target P.[[ProxyHandler]] = handler return P }      [[Construct(argumentsList, newTarget)]] abstract  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  function [[Construct]](argumentsList, newTarget) { let handler = O.[[ProxyHandler]] if (!handler) { throw new TypeError(\u0026#39;handler is null\u0026#39;) } assert(Type(handler) === \u0026#39;object\u0026#39;) let target = O.[[ProxyTarget]] assert(IsConstructor(target) === true) let trap = GetMethod(handler, \u0026#39;construct\u0026#39;) if (trap === undefined) { return Construct(target, argumentsList, newTarget) } let argArray = CreateArrayFromList(argumentsList) let newObj = Call(trap, handler, \u0026lt;\u0026lt;target, argArray, newTarget\u0026gt;\u0026gt;) if (Type(newObj) !== \u0026#39;object\u0026#39;) { throw new TypeError(\u0026#39;create new object error\u0026#39;) } return newObj }      [[Call]](thisArgument, arugmentList) abstract  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function [[Call]](thisArgument, argumentsList) { let handler = O.[[ProxyHandler]] if (!handler) { throw new TypeError(\u0026#39;no handler.\u0026#39;) } assert(Type(handler) === \u0026#39;object\u0026#39;) let target = O.[[ProxyTarget]] let trap = GetMethod(handler, \u0026#39;apply\u0026#39;) if (!trap) { return Call(target, thisArgument, argumentsList) } let argArray = CreateArrayFromList(argumentsList) return Call(trap, handler, \u0026lt;\u0026lt;target, thisArgument, argArray\u0026gt;\u0026gt;) }        TODO ES2017     Proposal Stage -     Object.values/Object.entries 3 å¯¹è±¡æ“ä½œ    Object.keys ( O )   EnumerableOwnPropertyNames, CreateArrayFromList\n1 2 3 4 5 6 7 8 9  function keys(O) { let obj = Object(O) // éå†å¯¹è±¡çš„é”®  let nameList = EnumerableOwnPropertyNames(obj, key) // åˆ›å»ºæ•°ç»„  return CreateArrayFromList(nameList) }      Object.values ( O )   EnumerableOwnPropertyNames, CreateArrayFromList\n1 2 3 4 5 6 7 8 9  function keys(O) { let obj = Object(O) // éå†å¯¹è±¡çš„é”®  let nameList = EnumerableOwnPropertyNames(obj, value) // åˆ›å»ºæ•°ç»„  return CreateArrayFromList(nameList) }      Object.entries( O )  1 2 3 4 5 6 7 8 9  function keys(O) { let obj = Object(O) // éå†å¯¹è±¡çš„é”®  let nameList = EnumerableOwnPropertyNames(obj, key+value) // åˆ›å»ºæ•°ç»„  return CreateArrayFromList(nameList) }        TODO ES2016     Proposal Stage -     Array.prototype.includes 4 åŸå®šç”¨ contains ä½†æ˜¯ä¸å…¼å®¹ã€‚   Exponentiation Operator 4    SIMD.JS - SIMD APIs + polyfill 3 ä¸€ç§ç±»ä¼¼å‘é‡çš„æ•°æ®ç±»å‹   Async Functions 3 async...await è¯­æ³•ï¼Œå®ç°è§„èŒƒ   String padding 3    Trailing commas in function parameter lists and calls 3    Object.getOwnPropertyDescriptors 3    function.sent metaproperty 2    Rest/Spread Properties 2    Shared memory and atomics 2    Function.prototype.toString revision 2    ArrayBuffer.transfer 1    Additional export-from Statements 1    Class and Property Decorators 1    Observable 1    String.prototype.{trimLeft,trimRight} 1    Class Property Declarations 1    String#matchAll 1    Callable class constructors 1    System.global 1    Asynchronous Iterators 1      æ¥å£ç›¸å…³ï¼š\n  Array.prototype.includes\n  Object.getOwnPropertyDescriptors\n  Function.prototype.toString\n  String.prototype.{trimLeft,trimRight}\n  String#matchAll\n  System.global\n  Array.prototype.includes ( searchElement [ , fromIndex ] )s4   ä¸ indexOf æ¯”è¾ƒï¼š\n  è¯­ä¹‰æ˜ç¡®ã€‚\n  æ”¯æŒ NaN æ£€æµ‹ï¼Œå› ä¸º indexOf æ˜¯ä½¿ç”¨æ’ç­‰(Strict Equality Comparison)è¿›è¡Œæ¯”è¾ƒ çš„ï¼Œ includes ä½¿ç”¨çš„æ˜¯ SameValueZero è¿›è¡Œæ¯”è¾ƒã€‚\n  éå†çš„æ—¶å€™ä¸ä¼šå¿½ç•¥ missing array å…ƒç´ (ä¿—ç§°ï¼šhole å…ƒç´ ï¼Œæ¯”å¦‚ map çš„æ—¶å€™å°±ä¼šè·³ è¿‡è¿™äº›å…ƒç´ )ï¼Œè€Œæ˜¯å°†ä»–ä»¬è§†ä¸º undefined ã€‚\n  1 2  console.log(\u0026#39;[1, NaN 2] index of `NaN`: \u0026#39; + [1, NaN, 2].indexOf(NaN)) // -1  console.log(\u0026#39;[1, NaN 2] includes `NaN`: \u0026#39; + [1, NaN, 2].includes(NaN)) // true      result:\n[1, NaN 2] index of `NaN`: -1 [1, NaN 2] includes `NaN`: true   ä¼ªç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  function includes(searchElement[, fromIndex]) { let O = Object(this) let len = LengthOfArrayLike(O) if (len === 0) { return false } // é»˜è®¤æ˜¯ 0  let n = int(fromIndex) || 0 let k if (n \u0026gt;= 0) { k = n } else { // å°äºé›¶ä»å³å¼€å§‹æ•°  k = len + n if (k \u0026lt; 0) k = 0 } while (k \u0026lt; len) { let elementK = get(O, String(k)) // è¿™é‡Œä½¿ç”¨çš„æ˜¯ç±» 0 å€¼ï¼Œè€Œéæ’ç­‰æ¯”è¾ƒ  if (SameValueZero(searchElement, elementK)) { return true } k++ } return false }     âš ï¸ includes å¹¶ä¸å¼ºçƒˆè¦æ±‚è°ƒç”¨è€…æ˜¯ä¸ªæ•°ç»„å¯¹è±¡ï¼Œå¦‚ä¸Šä¼ªç å®ç°ä¸­ä½¿ç”¨çš„æ˜¯ LengthOfArrayLike(O) å³ç±»æ•°ç»„çš„å¯¹è±¡éƒ½å¯ä»¥ä½¿ç”¨å®ƒã€‚\n1 2 3 4 5 6 7 8 9  var obj = { length: 2, 0: \u0026#39;foo\u0026#39;, 1: \u0026#39;bar\u0026#39; } // è¿™é‡Œå€Ÿç”¨ä¸€ä¸‹æ•°ç»„çš„å‡½æ•°  console.log([].includes.call(obj, \u0026#39;foo\u0026#39;))     +RESULTS:\ntrue   ä¸ºä»€ä¹ˆä¸ç”¨ has ï¼Ÿ\n has å¸¸ç”¨æ¥æ£€æµ‹é”® \u0026#34;keys\u0026#34;ï¼Œ includes ç”¨æ¥æ£€æµ‹å€¼ \u0026#34;values\u0026#34;ï¼Œå¦‚ï¼š\n  Map ç±»å‹\n Map.prototype.has(key) Reflect.has(target, propertyKey)\n  Set é›†åˆç±»å‹(é›†åˆç±»å‹ value æ—¢æ˜¯ key ä¹Ÿæ˜¯ value)\n Set.prototype.has(value)\n  String ç±»å‹ï¼Œç´¢å¼• + å­—ç¬¦\n String.prototype.includes(searchString, position)\n    å®˜æ–¹å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10  assert([1, 2, 3].includes(2) === true); assert([1, 2, 3].includes(4) === false); assert([1, 2, NaN].includes(NaN) === true); assert([1, 2, -0].includes(+0) === true); assert([1, 2, +0].includes(-0) === true); assert([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;].includes(\u0026#34;a\u0026#34;) === true); assert([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;].includes(\u0026#34;a\u0026#34;, 1) === false);     moreâ€¦\n  Exponentiation Operator(å¹‚è¿ç®—ç¬¦)s3  1 2 3 4 5 6 7 8 9 10  let squared = 2 ** 2 let cubed = 2 ** 3 let a = 2 a **= 2 let b = 3 b **= 3 console.log({ squared, cubed, a, b })    { squared: 4, cubed: 8, a: 4, b: 27 }   moreâ€¦\n    çº¯æ¦‚å¿µ  Environment Records(link)   è‹±æ–‡åŸç‰ˆ -\u0026gt;\u0026gt;\u0026gt;\n ä¸­æ–‡è¯‘ç‰ˆ -\u0026gt;\u0026gt;\u0026gt;\n    ä¼ªç   C  CreateImmutableBinding(N, S)   CreateImmutableBinding(N, S), åœ¨å½“å‰çš„ Environment Record ä¸­ä¸ºæœªåˆå§‹åŒ–çš„ N åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸å¯å˜(Immutable)çš„ç»‘å®šï¼Œå‰ææ˜¯è¯¥ç»‘å®šå…³ç³»ä¹‹å‰æ²¡æœ‰å‘ç”Ÿè¿‡ï¼Œå¦‚æœ S å€¼ä¸º true åˆ™è¯¥å…³ç³»ä¼šè¢«è§†ä¸ºä¸¥æ ¼ç»‘å®š(å³ä¸¥æ ¼æ¨¡å¼å’Œéä¸¥æ ¼æ¨¡å¼)ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function CreateImmutableBinding(N, S) { // 1. å–å½“å‰ç¯å¢ƒ  let envRec = DeclarativeEnvirnomentRecord // 2. æ–­è¨€ï¼šenvRec ä¸­æ²¡æœ‰ N çš„ç»‘å®šå…³ç³»  assert(envRec..notBinding(N)) // 3. åˆ›å»ºç»‘å®šï¼Œä¸” record æ˜¯æœªåˆå§‹åŒ–çŠ¶æ€  envRec.ImmutableBinding(N) // 4. ä¸¥æ ¼æ¨¡å¼  if (S === true) { envRec..Strict = True } // æ­£å¸¸ç»“æŸ  return NormalCompletion(empty) }      CreateArrayFromList ( elements )   CreateDataPropertyOrThrow\n ç”¨ List åˆ›å»ºæ•°ç»„ç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function CreateArrayFromList( elements ) { assert(elements is List) // åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„  let array = ArrayCreate(0) let n = 0 for (let e of elements) { CreateDataPropertyOrThrow(array, ToString(n), e) n++ } return array }      CreateDataPropertyOrThrow ( O, P, V )   CreateDataProperty, IsPropertyKey\n æŠ½è±¡æ“ä½œï¼šä¸ºå¯¹è±¡åˆ›å»ºä¸€ä¸ªæ–°çš„å±æ€§å’Œå¯¹åº”çš„å€¼ï¼Œå¦‚æœå¤±è´¥æŠ›å‡ºå¼‚å¸¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function CreateDataPropertyOrThrow ( O, P, V ) { assert(Types(O) is Object) // æ˜¯ä¸æ˜¯åˆæ³•çš„å¯¹è±¡å±æ€§å  assert(IsPropertyKey(P) === true) let success = CreateDataProperty(O, P, V) if (!success) throw new TypeError() return success }      CreateDataProperty ( O, P, V )   æŠ½è±¡æ“ä½œï¼šåˆ›å»ºå¯¹è±¡å±æ€§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function CreateDataProperty ( O, P, V ) { assert(Type(O) === Object) assert(IsPropertyKey(P) === true) // å¯¹è±¡å±æ€§æè¿°ç¬¦å¯¹è±¡  let newDesc = PropertyDescriptor{ [[Value]]: V, [[Writable]]: true, [[Enumerable]]: true, [[Configurable]]: true } return O.[[DefineOwnProperty]](P, newDesc) }     å¤±è´¥æƒ…å†µ(è¿”å› false)ï¼š\n  å±æ€§ä¸å¯é…ç½®(Configurable: false)\n  O æ˜¯ä¸å¯æ‰©å±•ç±»å‹\n      E  EnumerableOwnPropertyNames ( O, kind )   CreateArrayFromList\n æŠ½è±¡æ“ä½œï¼šå–å‡ºå¯¹è±¡ O çš„å±æ€§æˆ–å€¼(key, value, æˆ– key+value)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function EnumerableOwnPropertyNames(O, kind) { // kind -\u0026gt; key, value or key+value  // å¿…é¡»æ˜¯ä¸ªå¼•ç”¨ç±»å‹  assert(Type(O) === Object) // è‡ªèº«çš„æ‰€æœ‰å±æ€§  let ownKeys = O.[[OwnPropertyKeys]]() let properties = new List() for (let key of ownKeys) { let desc if (Type(key) === String) { // å–å‡ºå€¼æ¥  desc = O.[[GetOwnProperty]](key) // æœ‰æ•ˆå€¼ä¸”æ˜¯å¯æšä¸¾çš„  if (desc !== undefined \u0026amp;\u0026amp; desc.[[Enumerable]]) { if (kind === \u0026#39;key\u0026#39;) { // ä¿å­˜å±æ€§å  properties.append(key) } else { let value = Get(O, key) if (kind === \u0026#39;value\u0026#39;) { // ä¿å­˜å±æ€§å€¼  properties.append(value) } else { assert(kind === \u0026#39;key+value\u0026#39;) let entry = CreateArrayFromList(\u0026lt;key, value\u0026gt;) properties.append(entry) } } } } } return properties }        F  Function Definition(å‡½æ•°å®šä¹‰)   å‚è€ƒé“¾æ¥\n æœ‰å‡ ç§å‡½æ•°å£°æ˜æ–¹å¼ï¼š\n  FunctionDeclaration : function Identifier ( FormalParameterListopt ) { FunctionBody }\n TODO\n  FunctionExpression : function ( FormalParameterListopt ) { FunctionBody }\n TODO\n  FunctionExpression : function Identifier ( FormalParameterListopt ) { FunctionBody }\n å…³è”å‡½æ•°ï¼š CreateImmutableBinding(N, S)\n å®ä¾‹ï¼Œå‡½æ•°è¡¨è¾¾å¼ï¼š (function b() {})()\n ä¼ªç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  // 1. env æ˜¯å½“å‰å¯æ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒå˜é‡  let funcEnv = NewDeclarativeEnvironment(env) // 2. ä¿å­˜ funcEnv çš„ç¯å¢ƒè®°å½•  let envRec = funcEnv.env_record // 3. ä¸å¯å˜ç»‘å®šï¼Ÿ  envRec.CreateImmutableBinding(Identifier) // 4. åˆ›å»ºå‡½æ•° new Function(\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;return a + b\u0026#39;)  let closure = new Function(FormalParameterList, FunctionBody) // 5. ç»‘å®š closure æ‰§è¡Œç¯å¢ƒ  closure.bind(funcEnv) // 6. ä¸¥æ ¼æ¨¡å¼å¤„ç†  let Strict if (\u0026#39;use strict;\u0026#39;) { Strict = true } // 7. åˆå§‹åŒ– immutable binding ?  envRec.InitializeImmutableBinding(Identifier, closure) return closure      FunctionBody : SourceElementsopt\n TODO\n      H  HasProperty(O, p)   Link -\u0026gt;\n -\u0026gt; 7.3.11 HasProperty ( O, P )\n The abstract operation HasProperty takes arguments O (an Object) and P (a property key). It returns a completion record which, if its Type is normal, has a Value which is a Boolean. It is used to determine whether an object has a property with the specified property key. The property may be either an own or inherited(å±æ€§å¯ä»¥æ˜¯è‡ªå·±çš„ä¹Ÿå¯ä»¥æ˜¯ç»§æ‰¿æ¥çš„ï¼Œå³æŸ¥æ‰¾æ•´ä¸ªåŸå‹é“¾). It performs the following steps when called:\n  Assert: Type(O) is Object.\n  Assert: IsPropertyKey(P) is true.\n  Return ? O.HasProperty(P).\n      I  IsPropertyKey ( argument )  1 2 3 4 5 6 7  function IsPropertyKey ( argument ) { // åªæœ‰å­—ç¬¦ä¸²å’Œç¬¦å·æ˜¯åˆæ³•å±æ€§å  if (Type(argument) === String || Type(argument) === Symbol) return true return false }        L  LengthOfArrayLike ( obj )  1 2 3 4 5 6 7  function LengthOfArrayLike ( obj ) { // å¿…é¡»æ˜¯ä¸ªå¯¹è±¡ç±»å‹  assert(Type(obj) === \u0026#39;object\u0026#39;) // è·å–å¯¹è±¡çš„ length å±æ€§ï¼Œå¦‚ï¼š { 0: \u0026#39;foo\u0026#39;, 1: \u0026#39;bar\u0026#39;, length: 2 }  return ToLength(Get(obj, \u0026#39;length\u0026#39;)) }        S  SameValueZero(x, y)  1 2 3 4 5 6 7 8 9 10 11 12 13  function SameValueZero(x, y) { // ä¸åŒç±»å‹  if (Type(x) !== Type(y)) return false if (Type(x) === \u0026#39;number\u0026#39; || Type(x) === \u0026#39;bigint\u0026#39;) { // æ•°å­—å¤„ç†  return Type(x)::sameValueZero(x, y) } // éæ•°å­—å¤„ç†  return SameValueNonNumeric(x, y) }      SameValueNonNumeric ( x, y )  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  function SameValueNonNumeric ( x, y ) { // å› ä¸ºè¿™é‡Œåªå¤„ç†éæ•°å­—æƒ…å†µ  assert(x, !Number \u0026amp;\u0026amp; !BigInt) assert(Type(x) === Type(y)) if (Type(x) === \u0026#39;undefined\u0026#39;) return true if (Type(x) === \u0026#39;null\u0026#39;) return true if (Type(x) === \u0026#39;string\u0026#39;) { // è¿™é‡Œæ¯”è¾ƒç¨‹åº¦ï¼Œé€ä¸ªå­—ç¬¦æ¯”è¾ƒï¼Œç›¸åŒè¿”å› trueï¼Œå¦åˆ™ false  return x === y } if (Type(x) === \u0026#39;boolean\u0026#39;) { if (x === true \u0026amp;\u0026amp; y === true) return true return false } if (Type(x) === \u0026#39;symbol\u0026#39;) { // æ¯”è¾ƒä¸¤ä¸ªç¬¦å·ç±»å‹çš„å€¼  return x.value === y.value } return x === y }      StrictEqualityComparison ä¸¥æ ¼æ¯”è¾ƒ  1 2 3 4 5 6 7 8 9 10 11 12  function StrictEqualityComparison() { if(Type(x) !== Type(y)) return false if (Type(x) === \u0026#39;number\u0026#39; || Type(x) === \u0026#39;bigint\u0026#39;) { // ç›´æ¥ equal æ¯”è¾ƒ  return Type(x)::equal(x, y) } // éæ•°å­—å’Œ SameValueZero å¤„ç†ä¸€æ ·  return SameValueNonNumeric(x,y) }          ","permalink":"https://www.cheng92.com/web/javascript-docs/","tags":["javascript,","api"],"title":"JavaScript Api \u0026 æ–‡æ¡£"},{"categories":[],"contents":"  window.g_need_fold = 1   Org-mode ç®€æ˜æ‰‹å†Œ - open source - åšå®¢å›­\nembrace  embrace-add(,ea)   Documentation Two Emacs manuals, the GNU Emacs manual and An Introduction to Programming in Emacs Lisp, can be purchased in printed form from the FSF store.\n These manuals, along with the Emacs Lisp Reference Manual and several other manuals documenting major modes and other optional features, can also be read online. They are also distributed with Emacs in Info format; type C-h i in Emacs to view them.\n GNU Emacs manual: Read Online or Purchase An Introduction to Programming in Emacs Lisp: Read Online or Purchase Emacs Lisp Reference Manual: Read Online Other Emacs manuals: Read Onlin_e The Emacs distribution includes the full source code for the manuals, as well as several Emacs Reference Cards in various languages.\n  Asking for help To ask for \\{ help\\ } with GNU Emacs, use the mailing list help-gnu-emacs@gnu.org or the newsgroup gnu.emacs.help. The mailing list and newsgroup are linked: messages posted on one appear on the other as well.\n Reporting bugs To report bugs, or to \u0026lt;button\u0026gt;contribute\u0026lt;/button\u0026gt; fixes and improvements, use the built-in Emacs bug reporter (M-x report-emacs-bug) or send email to bug-gnu-emacs@gnu.org. You can browse our bug database at debbugs.gnu.org. For more information on contributing, see the CONTRIBUTE file (also distributed with Emacs). To report bugs, or to \u0026lt;button\u0026gt;contribute\u0026lt;/button\u0026gt; fixes and improvements, use the built-in Emacs bug reporter (M-x report-emacs-bug) or send email to bug-gnu-emacs@gnu.org. You can browse our bug database at debbugs.gnu.org. For more information on contributing, see the CONTRIBUTE file (also distributed with Emacs). To report bugs, or to \u0026lt;button\u0026gt;contribute\u0026lt;/button\u0026gt; fixes and improvements, use the built-in Emacs bug reporter (M-x report-emacs-bug) or send email to bug-gnu-emacs@gnu.org. You can browse our bug database at debbugs.gnu.org. For more information on contributing, see the CONTRIBUTE file (also distributed with Emacs). TodoTo report bugs, or to \u0026lt;button\u0026gt;contribute\u0026lt;/button\u0026gt; fixes and improvements, use the built-in Emacs bug reporter (M-x report-emacs-bug) or send email to bug-gnu-emacs@gnu.org. You can browse our bug database at debbugs.gnu.org. For more information on contributing, see the CONTRIBUTE file (also distributed with Emacs).\n For all other queries, consult the list of Emacs-related mailing lists on savannah.gnu.org and the complete list of GNU mailing lists on lists.gnu.org. See Get Help with GNU Software for help with GNU software in general.@@html:\u0026lt;/kbd\u0026gt;@@__\n1 2 3 4 5 6 7  function test(a, b, c, d, e) { console.log(\u0026#39;aaaaa = \u0026#39; + a) console.log(\u0026#39;aaaaa = \u0026#39; + b) console.log(\u0026#39;aaaaa = \u0026#39; + c) console.log(\u0026#39;aaaaa = \u0026#39; + d) console.log(\u0026#39;aaaaa = \u0026#39; + e) `}`      embrace-change(,ec)   embrace-delete(,ed)     emoji   ğŸ± ğŸŒµ\n  ein, emacs-ipython-notebook   https://www.cheng92.com gccll/test\n1 2 3 4  import numpy, math, matplotlib.pyplot as plt %matplotlib inline x = numpy.linspace(0, 2*math.pi) plt.plot(x, numpy.sin(x))      latex   $f(x) = x^{2}$ (@1(@1j)j)\n  org  test\n  xxxxxxxxf\n xxxxxx\n aaa\n aaa\n åˆ é™¤çº¿\n $x^{2}$\n xxx\n   åå­— æ€§åˆ«        colorful text   red...xxx\nred text...\n   blocks  comment..\n TIP\n tipâ€¦.\n Note\n dangerâ€¦ dangerâ€¦ dangerâ€¦ dangerâ€¦ dangerâ€¦\n WARNING\n warningâ€¦\n xxx â€“ demo xxx â€“ demo xxx â€“ demo xxx â€“ demo xxx â€“ demo xxx â€“ demo xxx â€“ demo\n  #+begin_ğ’³ I love Emacs! #+end_ğ’³\n~example~  1  warn    center content\n  quote â€¦.\n octoicon:report Note that kbd:C-x_C-e evaluates a Lisp form!\n  show:GLOSSARY\n badge:Thanks|for_reading tweet:https://github.com/alhassy/org-special-block-extras badge:|buy_me_a coffee|gray|https://www.buymeacoffee.com/alhassy|buy-me-a-coffee\nlink-here:solution Syntactically, (apply f \u0026#39;(x0 ... xN)) = (f x0 ... xN).\n Ain\u0026#39;t that cool?\nThat is, we can ((apply)) a function to a list of arguments!\n  demo blockâ€¦\n Are you excited to learn some Lisp? blue:Yes!\n Pop-quiz: How does doc:apply work?\n test example test ~example~ test example test example    restclient  1 2  GET https://api.github.com User-Agent: Emacs Restclient      valign test   head 1  head 2  head 3  head 4  head 5           use bootstrap   buttons:\nPrimary Secondary Success Danger Warning Info Light Dark  icons:\n    hugo-test  ä½¿ç”¨æ•™ç¨‹\nå¢åŠ æœç´¢åŠŸèƒ½    æ–¹æ¡ˆä¸€\n  è¿™ä¸ªæ˜¯å¢åŠ äº†ä¸€ä¸ªé¡µé¢ï¼Œåœ¨è¿™ä¸ªé¡µé¢é‡Œé¢è¿›è¡Œæœç´¢ï¼Œä¸æ˜¯å¾ˆå‹å¥½ï¼Œæˆ‘å¸Œæœ›çš„æ˜¯åœ¨å½“å‰é¡µé¢ç»„ å¥½æ˜¯å¼¹æ¡†+ä¸‹æ‹‰åˆ—è¡¨å½¢å¼è¿›è¡Œæœç´¢ã€‚\n æœç´¢ç»“æœï¼š   æ–¹æ¡ˆäºŒ\n è¿™ä¸ªè²Œä¼¼è¿˜ä¸é”™ï¼Œå€¼å¾—ä¸€è¯•ã€‚\n  https://www.algolia.com/\n      ç½‘æ˜“äº‘éŸ³ä¹     å¢åŠ ä»£ç åŒºå¤åˆ¶æŒ‰é’®    ä¿®æ”¹ themes/even/assets/js/main.js å¢åŠ  addCopyButton åŸç†å°±æ˜¯ï¼Œå°† pre.chroma\u0026gt;code é‡Œé¢çš„æ–‡æœ¬å…¨æ‹·è´åˆ°ä¸€ä¸ªä¸´æ—¶åˆ›å»ºçš„ textarea æ ‡ç­¾é‡Œé¢ï¼Œç„¶å è°ƒç”¨ document.execCommand(\u0026#39;copy\u0026#39;) å°†å†…å®¹æ‹·è´åˆ°å‰ªåˆ‡æ¿ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  function addCopyButton() { //ç”¨ div åŒ…è£¹ figure ä¾¿äºå®šä½  $(\u0026#34;.src .highlight\u0026#34;).wrap(\u0026#39;\u0026lt;div class=\u0026#34;highlight-wrapper\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;); //æ·»åŠ å¤åˆ¶æŒ‰é’®  $(\u0026#34;.highlight\u0026#34;).before( \u0026#39;\u0026lt;div class=\u0026#34;copy-code btn btn-outline-secondary\u0026#34;\u0026gt;å¤åˆ¶\u0026lt;/div\u0026gt;\u0026#39; ); //ä¸ºå¤åˆ¶æŒ‰é’®æ·»åŠ clickäº‹ä»¶  $(\u0026#34;.copy-code\u0026#34;).on(\u0026#34;click\u0026#34;, function () { //åˆå§‹åŒ–  $(\u0026#34;textarea\u0026#34;).remove(\u0026#34;#targetId\u0026#34;); //è·å–å¯¹åº”çš„ä»£ç   var codeText = \u0026#34;\u0026#34;; $(this) .next(\u0026#34;div.highlight\u0026#34;) .find(\u0026#34;pre.chroma\u0026gt;code\u0026#34;) .each(function (i) { // è¿‡æ»¤æ‰è¡Œå·çš„é‚£ä¸ª pre  if (i \u0026gt; 0) { codeText += $(this).text() + \u0026#34;\\n\u0026#34;; } }); //æ·»åŠ  \u0026lt;textarea\u0026gt; DOMèŠ‚ç‚¹ï¼Œå°†è·å–çš„ä»£ç å†™å…¥  var target = document.createElement(\u0026#34;textarea\u0026#34;); target.style.opacity = 0; target.style.left = \u0026#34;-9999px\u0026#34;; target.id = \u0026#34;targetId\u0026#34;; $(this).append(target); target.textContent = codeText; //é€‰ä¸­textareaå†…çš„ä»£ç   target.focus(); target.setSelectionRange(0, target.value.length); // å¤åˆ¶é€‰ä¸­çš„å†…å®¹  document.execCommand(\u0026#34;copy\u0026#34;); //åˆ é™¤æ·»åŠ çš„èŠ‚ç‚¹  $(\u0026#34;textarea\u0026#34;).remove(\u0026#34;#targetId\u0026#34;); $(this).html(\u0026#34;æˆåŠŸ\u0026#34;); var thisCopied = $(this); setTimeout(function () { thisCopied.html(\u0026#34;å¤åˆ¶\u0026#34;); }, 1200); }); }      ä¿®æ”¹ themes/even/assets/sass/_partial/_post/_code.scss å¢åŠ æŒ‰é’®æ ·å¼\n  1 2 3  function test() { console.log(\u0026#39;è¯·å¤åˆ¶æˆ‘ï¼Œå¥½å—ï¼Ÿ\u0026#39;) }    testä½¿ç”¨çš„ begin_example  1 2 3  function main(int argc, int* argv[]) { printf(\u0026#34;%d, %s\u0026#34;, 100, \u0026#34;hello world\u0026#34;) }      header2  header3  header4         hugo themes   https://learn.netlify.app/en/\n   ","permalink":"https://www.cheng92.com/post/my-first-post/","tags":["demo"],"title":"My First Post"},{"categories":["vue"],"contents":"  window.g_need_fold = 1   è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚\n  æ–‡å­—æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³çœ‹æ–‡å­—å¯ç›´æ¥è½¬åˆ°è¿™é‡Œçœ‹è„‘å›¾\nå¯èƒ½æ„Ÿå…´è¶£åˆ—è¡¨ï¼š   æºç ç›¸å…³çš„ç–‘é—®/é—®é¢˜åˆ—è¡¨åŠå…¶è§£ç­” ğŸ›³ ğŸ›³ ğŸ›³ ğŸ›³ ğŸ›³\n  é˜¶æ®µæ€§çš„ä»£ç å¤‡ä»½(æ¯”å¦‚èƒ½ pass æŸä¸ªç”¨ä¾‹) ğŸš˜ ğŸš˜ ğŸš˜ ğŸš˜ ğŸš˜\n  æ‰€æœ‰è„‘å›¾åˆ—è¡¨åŠç®€è¦è§£æ\n  å°ç»“   å°ç»“ä¹‹æ‰€ä»¥æ”¾åœ¨æœ€å‰é¢ï¼Œä¸»è¦åŸå› æœ‰äºŒï¼š\n  æ–‡ç« éƒ½æ˜¯æ ¹æ®æµ‹è¯•ç”¨ä¾‹é€æ­¥ç”±å°‘åˆ°å¤šï¼Œç®€åˆ°å…¨çš„è¿›åº¦å»å®ç°å’Œæµ‹è¯•çš„ã€‚\n  æ–‡å­—å†…å®¹å¤ªå¤šï¼Œå°ç»“æ”¾å‰é¢èƒ½æå‰å¤§æ¦‚æœ‰ä¸ªå…¨å±€è§‚ï¼Œå…¨å±€çš„æ¦‚å¿µã€‚\n  ä¸Šå›¾ï¼šå‡ ä¸ªé‡è¦å‡½æ•°å’Œå‡ ä¸ªç®€å•çš„ç”¨ä¾‹\n  æ¯ä¸ªå‡½æ•°çš„é‡è¦å®ç°è§£è¯´ï¼š\n  parseChildren æ‰€æœ‰æ¨¡æ¿è§£æçš„å…¥å£ï¼Œé‡ç‚¹æ˜¯ while å¾ªç¯æ£€æµ‹è§„åˆ™è¿›å…¥å¯¹åº”çš„ parse* å‡½æ•°è§£æï¼Œåˆå¹¶ç›¸é‚»æ–‡æœ¬èŠ‚ç‚¹ï¼Œè¿‡æ»¤ç©ºè¡ŒèŠ‚ç‚¹ï¼Œè¿”å› root.childrenã€‚\n  parseComment è¿™é‡Œçš„æ³¨é‡Šæ˜¯æŒ‡ \u0026lt;!--xx--\u0026gt; html æ³¨é‡Šï¼ŒåŒºåˆ†å‡ ç§éæ³•æƒ…å†µï¼Œå¯é€šè¿‡ç”¨ ä¾‹æ¥ç†Ÿæ‚‰(a. æ­£å¸¸æ³¨é‡Šï¼Œb. éæ³•æ³¨é‡Š)\n  parseElememt è§£ææ ‡ç­¾ï¼Œå¾—åˆ°æ•´ä¸ªæ ‡ç­¾çš„ ast ç»“æ„ï¼ŒåŒ…å«ï¼šæ ‡ç­¾å tagï¼Œå±æ€§åˆ—è¡¨ propsï¼Œå­©å­èŠ‚ç‚¹ childrenï¼Œç­‰ç­‰ã€‚\n  æ£€æµ‹è‡ªé—­åˆ(\u0026lt;div/\u0026gt;)å’Œç©ºæ ‡ç­¾(\u0026lt;img\u0026gt;)æ£€æµ‹ï¼Œå®ƒä»¬æ²¡æœ‰å­©å­èŠ‚ç‚¹ã€‚\n  å…³é”®çš„ ancestors æ•°ç»„ï¼Œåœ¨é€’å½’è§£æå­©å­èŠ‚ç‚¹çš„æ—¶å€™é€šè¿‡å‡ºå…¥æ ˆæ“ä½œä¿å­˜å½“å‰è§£æçš„ èŠ‚ç‚¹å¯¹è±¡(å¦‚ï¼šç–‘é—®3)ã€‚\n    parseText æ–‡æœ¬è§£æï¼Œéæ ‡ç­¾ï¼Œéæ’å€¼ç±»å‹çš„èŠ‚ç‚¹ä¼šè¢«å½“åšæ–‡æœ¬ç±»å‹å»è§£æã€‚æ–‡æœ¬ç»“æŸ æ ¹æ®æ˜¯ (\u0026lt;, {{, ]]\u0026gt;)ã€‚\n  parseTextData è§£ææ–‡æœ¬ï¼Œæ›¿æ¢ html æ ‡è®°(åŒ¹é…ï¼š /\u0026amp;(gt|lt|amp|apos|quot);/g)\n  parseTag è§£æå…ƒç´ æ ‡ç­¾ï¼Œå±æ€§ propsï¼Œv-pre ç­‰æŒ‡ä»¤éƒ½æ˜¯åœ¨è¿™é‡Œé¢å‘èµ·è§£æçš„ï¼Œæ³¨æ„è‡ªé—­ åˆæ ‡ç­¾çš„å¤„ç† isSelfClosing æ ‡å¿—ç»“æŸ parseElement ä¸­è§£æè¿›ç¨‹ã€‚\n  parseAttributes whle å¾ªç¯è°ƒç”¨ parseAttribute è§£æå±æ€§å­˜åˆ° props ä¸­ã€‚\n  parseAttribute è§£æå•ä¸ªå±æ€§ï¼Œé›†åˆä¿å­˜å±æ€§åé˜²æ­¢é‡å¤ï¼Œå…ˆè§£æå±æ€§å€¼ï¼Œç„¶åè§£æå± æ€§åï¼ŒæŒ‡ä»¤ï¼Œä¿®é¥°ç¬¦ï¼Œå‚æ•°ç­‰ã€‚\n  parseAttributeValue è§£æå±æ€§å€¼ï¼ŒåŒºåˆ†æœ‰å¼•å·æˆ–æ²¡å¼•å·(å³å±æ€§å€¼å¯ä»¥æ²¡å¼•å·å“¦ğŸ˜¯)ã€‚\n  parseInterpolation æ’å€¼è§£æï¼Œå– {{ å’Œ }} ä¹‹é—´çš„æ–‡æœ¬ä½œä¸ºè¡¨è¾¾å¼ã€‚\n  parseCDATA è§£æ xml æ³¨é‡Šï¼Œå½“åšæ–‡æœ¬å¤„ç†\n  parseBogusComment è§£æ \u0026lt;? çš„æ³¨é‡Š\n    parse.spec.ts   æµ‹è¯•ç”¨ä¾‹ç»“æ„ï¼šcompiler: parse æˆªæ­¢ï¼š2020-09-02 22:53:14\n æ‰€æœ‰ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼šparse.ts çš„è§£æåŠŸèƒ½å‡ ä¹å…¨éƒ¨å®ç°(å¯èƒ½ä¼šæœ‰é—æ¼)\nErrorCodes å„ç§é”™è¯¯æƒ…å†µç”¨ä¾‹  ä¸é€šè¿‡ç”¨ä¾‹ï¼š\n  \u0026lt;textarea\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/textarea\u0026gt;\n  \u0026lt;template\u0026gt;\u0026lt;svg\u0026gt;\u0026lt;![CDATA[cdata]]\u0026gt;\u0026lt;/svg\u0026gt;\u0026lt;/template\u0026gt;\n  ç”¨ä¾‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  const ast = baseParse(code, { getNamespace: (tag, parent) =\u0026gt; { // è¿™é‡Œä½œç”¨æ˜¯æ”¹å˜å‘½åç©ºé—´ï¼Œä»è€Œåœ¨ parseChildren while å¾ªç¯é‡Œé¢  // èƒ½è¿›å…¥åˆ° parseCDATA è§£æ svg  const ns = parent ? parent.ns : Namespaces.HTML; if (ns === Namespaces.HTML) { if (tag === \u0026#34;svg\u0026#34;) { return Namespaces.HTML + 1; } } return ns; }, getTextMode: ({ tag }) =\u0026gt; { // è¿™é‡Œä½œç”¨æ”¹å˜ textarea æ ‡ç­¾çš„ mode = RCDATAï¼Œä»è€Œåœ¨ parseChildren while  // é‡Œé¢å°† textarea å†…éƒ¨çš„éƒ½å½“åšæ–‡æœ¬äº¤ç»™ parseText å»è§£æï¼ŒparseText é‡Œé¢ä¼šä»  // \u0026lt;/div\u0026gt;\u0026lt;/textarea\u0026gt; ç¬¬äºŒä¸ªå­—ç¬¦å¼€å§‹åŒ¹é… `\u0026lt;` æˆ– `{{` ä»¥ç¤ºç»“æŸæ ‡ç­¾çš„å¼€å§‹ä½ç½®  // æœ€åè§£æå‡º `\u0026lt;/div\u0026gt;` è¿™ä¸ªçº¯æ–‡æœ¬ï¼Œå‰©ä¸‹çš„ \u0026lt;/textarea\u0026gt; è¿›å…¥ isEnd  // åœ¨å®ç° isEnd é‡Œé¢çš„ case RCDATA åˆ†æ”¯åé¡ºåˆ©æ¨å‡ºå¾ªç¯  if (tag === \u0026#34;textarea\u0026#34;) { return TextModes.RCDATA; } if (tag === \u0026#34;script\u0026#34;) { return TextModes.RAWTEXT; } return TextModes.DATA; }, ...options, onError: spy, });     å¤§éƒ¨åˆ†éƒ½èƒ½é€šè¿‡ï¼Œåªæœ‰å°‘éƒ¨åˆ†ä¸èƒ½é€šè¿‡çš„åˆ†ä¸ºå‡ ç§ï¼š\n  CDATA ç±»å‹å¤„ç†ï¼Œéœ€è¦å®ç° parseBogusComment å’Œ parseCDATA ä¸¤ä¸ªå‡½æ•°\n  RCDATA ç±»å‹å‡ ä¸ªç”¨ä¾‹ä¸èƒ½é€šè¿‡ï¼ŒåŸå› åœ¨äºåœ¨ isEnd å‡½æ•°ä¸­æ²¡æœ‰å®ç°é™¤ DATA ç±»å‹å¤–çš„ æƒ…å†µï¼Œå®ç°ä¹‹åå°±èƒ½æ­£å¸¸æ£€æµ‹ RCDATA çš„ç»“æŸæ ‡ç­¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function isEnd( context /*ParserContext*/, mode /*TextModes*/, ancestors /*ElementNode[]*/ ) /*boolean*/ { const s = context.source; // mode ä¸º TextModes å„ç§æƒ…å†µ  // ...çœç•¥  switch (mode) { case TextModes.DATA: if (s.startsWith(\u0026#34;\u0026lt;/\u0026#34;)) { // æ ‡ç­¾  for (let i = ancestors.length - 1; i \u0026gt;= 0; --i) { if (startsWithEndTagOpen(s, ancestors[i].tag)) { return true; } } } // æ–°å¢ - start  case TextModes.RCDATA: case TextModes.RAWTEXT: { const parent = last(ancestors); if (parent \u0026amp;\u0026amp; startsWithEndTagOpen(s, parent.tag)) { return true; } break; } case TextModes.CDATA: if (s.startsWith(\u0026#34;]]\u0026gt;\u0026#34;)) { return true; } break; // æ–°å¢ - end  } // æ˜¯ TextModes.TEXT ç›´æ¥è¿”å› source çš„å†…å®¹æ˜¯å¦ä¸ºç©ºäº†  return !s; }      æ³¨é‡Šåä¾‹(åµŒå¥—æ³¨é‡Š)ï¼š    \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!--b--\u0026gt;\u0026lt;/template\u0026gt;\n  \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!--b\u0026lt;!--c--\u0026gt;\u0026lt;/template\u0026gt;\n  \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!--\u0026gt;\u0026lt;/template\u0026gt;\n  \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!--\n      å…¶ä»–ç”¨ä¾‹  02-valid/invalid html  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  test(\u0026#34;valid html\u0026#34;, () =\u0026gt; { const ast = baseParse( `\u0026lt;div :class=\u0026#34;{ some: condition }\u0026#34;\u0026gt;\\n` + ` \u0026lt;p v-bind:style=\u0026#34;{ color: \u0026#39;red\u0026#39; }\u0026#34;/\u0026gt;\\n` + ` \u0026lt;!-- a comment with \u0026lt;html\u0026gt; inside it --\u0026gt;\\n` + `\u0026lt;/div\u0026gt;` ); expect(ast).toMatchSnapshot(); expect(ast.children).toHaveLength(1); const el = ast.children[0]; expect(el).toMatchObject({ tag: \u0026#34;div\u0026#34;, }); expect(el.children).toHaveLength(2); expect(el.children[0]).toMatchObject({ tag: \u0026#34;p\u0026#34;, }); expect(el.children[1]).toMatchObject({ type: NodeTypes.COMMENT, }); }); test(\u0026#34;invalid html\u0026#34;, () =\u0026gt; { expect(() =\u0026gt; { baseParse(`\u0026lt;div\u0026gt;\\n\u0026lt;span\u0026gt;\\n\u0026lt;/div\u0026gt;\\n\u0026lt;/span\u0026gt;`); }).toThrow(\u0026#34;Element is missing end tag.\u0026#34;); const spy = jest.fn(); const ast = baseParse(`\u0026lt;div\u0026gt;\\n\u0026lt;span\u0026gt;\\n\u0026lt;/div\u0026gt;\\n\u0026lt;/span\u0026gt;`, { onError: spy, }); expect(spy.mock.calls).toMatchObject([ [ { code: ErrorCodes.X_MISSING_END_TAG, loc: { start: { offset: 6, line: 2, column: 1, }, }, }, ], [ { code: ErrorCodes.X_INVALID_END_TAG, loc: { start: { offset: 20, line: 4, column: 1, }, }, }, ], ]); expect(ast).toMatchSnapshot(); });     è¿™é‡Œè¦åˆ†æçš„æ˜¯ invalid html, è¿™ä¸ªç”¨ä¾‹æ‹¿å‡ºæ¥è¯´ä¸»è¦åŸå› æ˜¯å®ƒèƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£æ ‡ ç­¾åµŒå¥—æ—¶å€™çš„è§£æè¿‡ç¨‹ã€‚\n \u0026lt;div\u0026gt;\\n\u0026lt;span\u0026gt;\\n\u0026lt;/div\u0026gt;\\n\u0026lt;/span\u0026gt;\n å¤§è‡´è§£ææµç¨‹æ˜¯ï¼š parseChildren -\u0026gt; parseElement -\u0026gt; parseTag -\u0026gt; parseChildren -\u0026gt; parseElement -\u0026gt; parseTag -\u0026gt; æŠ¥é”™\n debugger local æ•°æ®(è§£æå®Œ \u0026lt;span\u0026gt; ä¹‹å):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  Local ancestors: Array(1) 0: {type: 1, ns: 0, tag: \u0026#34;div\u0026#34;, tagType: 0, props: Array(0), â€¦} length: 1 children: [] context: column: 1 inPref: false inVPref: false line: 3 offset: 13 options: {delimiters: Array(2), getNamespace: Æ’, getTextMode: Æ’, isVoidTag: Æ’, isPreTag: Æ’, â€¦} originalSource: \u0026#34;\u0026lt;div\u0026gt;â†µ\u0026lt;span\u0026gt;â†µ\u0026lt;/div\u0026gt;â†µ\u0026lt;/span\u0026gt;\u0026#34; source: \u0026#34;\u0026lt;/div\u0026gt;â†µ\u0026lt;/span\u0026gt;\u0026#34;      è§£æå‡º div æ ‡ç­¾ï¼Œæ‰€ä»¥ ancestors.length === 1\n  è§£æå‡º span æ ‡ç­¾ï¼Œancestors.length åº”è¯¥æ˜¯ 2ï¼Œä½†æ˜¯ä¸Šé¢æˆ‘ä»¬åªä¿ç•™äº† span è§£æä¹‹ åçš„æ•°æ®ï¼Œæ‰€ä»¥ ancestors.span è¢« pop() æ‰äº†ï¼Œå› ä¸ºå®ƒä¸æ˜¯é‡ç‚¹\n  è§£æå®Œ span ä¹‹åä¼šå»è§£æ \\n ï¼Œä½†æ˜¯ä¼šè¢« removedWhitespace é‚£æ®µé€»è¾‘è¿‡æ»¤æ‰(æ»¡è¶³ åœ¨ pre å’Œ next ä¹‹é—´æ¡ä»¶)\n  é‚£ä¹ˆé‡ç‚¹åœ¨è¿™ï¼Œåˆ°è¿™ä¸€æ­¥ä¹Ÿæ˜¯ä¸Šé¢ä»£ç  source = `\u0026lt;/div\u0026gt;\\n\u0026lt;/span\u0026gt;` çš„æ—¶å€™\n  æ£€æµ‹åˆ° \u0026lt;/ å¼€å§‹ç»“æŸæ ‡ç­¾è§£æï¼Œæ³¨æ„çœ‹ parseElement ä¸­æœ‰è¿™ä¹ˆä¸€æ®µ\n1 2 3  if (startsWithEndTagOpen(context.source, element.tag)) { parseTag(context, TagType.End, parent); }     ç»è¿‡ 4 ä¹‹åçš„ source åˆšå¥½èƒ½æ»¡è¶³è¿™ä¸ª if ï¼Œå› æ­¤æºå¸¦ TagType.End è¿›å…¥ parseTagï¼Œ æ­¤æ—¶æœ‰ä¸ªå˜é‡ parent ä¿å­˜äº† pop() ä¹‹å‰çš„é‚£ä¸ª ancestors[1] å³ span é‚£ä¸ªæ ‡ç­¾ ï¼Œä½†æ˜¯è¿™é‡Œçš„ç»“æŸæ ‡ç­¾æ˜¯ div æœ€åä¼šåŒ¹é…å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚\n    01-self closing single/multiple tag  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  /* ä¸ç®¡æ˜¯å•æ ‡ç­¾è¿˜æ˜¯å¤šæ ‡ç­¾ä¹Ÿå¥½ï¼Œè‡ªé—­åˆæ ‡ç­¾çš„å¤„ç†éƒ½ä¸€æ ·ï¼Œåœ¨ parseTag é‡Œé¢è§£æéƒ½éœ€è¦ç»è¿‡è¿™ä¹ˆ ä¸€æ®µï¼šadvanceBy(context, isSelfClosing ? 2 : 1); ç„¶åç»“åˆ parseElement ä¸­çš„æ£€æµ‹ isSelfClosing ç›´æ¥é€€å‡ºè¿”å›å…ƒç´ èŠ‚ç‚¹ï¼Œå³ä¸éœ€è¦å†ç»§ç»­ è§£æå­èŠ‚ç‚¹äº†(å®ƒæ²¡æœ‰) ,*/ test(\u0026#39;self closing single tag\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;div :class=\u0026#34;{ some: condition }\u0026#34; /\u0026gt;\u0026#39;) expect(ast.children).toHaveLength(1) expect(ast.children[0]).toMatchObject({ tag: \u0026#39;div\u0026#39; }) }) test(\u0026#39;self closing multiple tag\u0026#39;, () =\u0026gt; { const ast = baseParse( `\u0026lt;div :class=\u0026#34;{ some: condition }\u0026#34; /\u0026gt;\\n` + `\u0026lt;p v-bind:style=\u0026#34;{ color: \u0026#39;red\u0026#39; }\u0026#34;/\u0026gt;` ) expect(ast).toMatchSnapshot() expect(ast.children).toHaveLength(2) expect(ast.children[0]).toMatchObject({ tag: \u0026#39;div\u0026#39; }) expect(ast.children[1]).toMatchObject({ tag: \u0026#39;p\u0026#39; }) })        Element å…ƒç´ æ ‡ç­¾è§£æ  13-ç»“æŸæ ‡ç­¾å¿½ç•¥å¤§å°å†™   \u0026lt;div\u0026gt;hello\u0026lt;/DIV\u0026gt;after\n å› ä¸ºè§£æåˆ°ç»“æŸæ ‡ç­¾çš„æ—¶å€™åŒ¹é…ç»“æŸæ ‡ç­¾åç§°çš„æ—¶å€™ä¼šè°ƒç”¨ startsWithEndTagOpen æ£€æµ‹ï¼Œ ä¸”é‡Œé¢æ˜¯å¿½ç•¥å¤§å°å†™çš„ï¼Œç»Ÿä¸€è½¬æˆå°å†™å»æ¯”è¾ƒã€‚\n1 2 3 4 5 6 7 8  // åŒ¹é…ï¼š\u0026lt;/tag\u0026gt; æˆ–\u0026lt;/tag æ²¡æœ‰ `\u0026gt;` çš„æƒ…å†µ???  function startsWithEndTagOpen(source, tag) { return ( source.startsWith(\u0026#34;\u0026lt;/\u0026#34;) \u0026amp;\u0026amp; source.substr(2, tag.length).toLowerCase() === tag.toLowerCase() \u0026amp;\u0026amp; /[\\t\\n\\f /\u0026gt;]/.test(source[2 + tag.length] || \u0026#34;\u0026gt;\u0026#34;) ); }      12-v-pre ç”¨ä¾‹æµ‹è¯•   `\u0026lt;div v-pre :id=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;Comp/\u0026gt;{{ bar }}\u0026lt;/div\u0026gt;\\n` + `\u0026lt;div :id=\u0026#34;foo\u0026#34;\u0026gt;\u0026lt;Comp/\u0026gt;{{ bar }}\u0026lt;/div\u0026gt;`\n ç°é˜¶æ®µä»£ç æš‚æ—¶æ˜¯ä¸æ”¯æŒçš„ v-pre çš„ã€‚æ‰€ä»¥è§£æä¹‹åä¼šå‡ºç°ä¸‹é¢çš„ç»“æœï¼š\n root.children[3] æœ‰ä¸‰ä¸ªå­©å­èŠ‚ç‚¹\n  first: div v-pre(è¿˜æ²¡å®ç°æ‰€ä»¥å½“åšæ™®é€šæ ‡ç­¾å¤„ç†)ï¼Œfirst.children[2] æœ‰ä¸¤ä¸ªå­©å­\n  component ç±»å‹çš„ \u0026lt;Comp/\u0026gt; å› ä¸ºé¦–å­—æ¯å¤§å†™æ‰€ä»¥å½“åšç»„ä»¶ç±»å‹å¤„ç†\n  bar æ’å€¼èŠ‚ç‚¹\n    second: \\n æ–‡æœ¬èŠ‚ç‚¹\n  third: div :idï¼Œthird.children[2] ä¹Ÿæœ‰ä¸¤ä¸ªå­©å­å’Œ first ä¸€æ ·\n  1 2 3 4  (3)Â [{â€¦}, {â€¦}, {â€¦}] 0: {type: 1, ns: 0, tag: \u0026#34;div\u0026#34;, tagType: 0, props: Array(1),Â â€¦} 1: {type: 2, content: \u0026#34;â†µ\u0026#34;, loc: {â€¦}} 2: {type: 1, ns: 0, tag: \u0026#34;div\u0026#34;, tagType: 0, props: Array(1),Â â€¦}length: 3__proto__: Array(0)     å®ç°ä¹‹åï¼š\n0: {type: 1, ns: 0, tag: \u0026#34;div\u0026#34;, tagType: 0, props: Array(1), â€¦} 1: null 2: {type: 1, ns: 0, tag: \u0026#34;div\u0026#34;, tagType: 0, props: Array(1), â€¦} length: 3 __proto__: Array(0)   è¦é€šè¿‡è¯¥ç”¨ä¾‹éœ€è¦ä¿®æ”¹çš„ç‚¹ï¼š\n  parseChildren é‡Œè¦æ·»åŠ åˆ é™¤ç©ºå­—ç¬¦æ¢è¡Œç¬¦æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  function parseChildren( context /* ParserContext*/, mode /*TextModes*/, ancestors /*ElementNode[]*/ ) { // ...  const parent = last(ancestors); const ns = parent ? parent.ns : Namespaces.HTML; const nodes /*TemplateChildNode[]*/ = []; // ... çœç•¥ while  // æ–°å¢-start  let removedWhitespace = false; // TODO ç©ºæ ¼ç®¡ç†ï¼Œä¸ºäº†æ›´é«˜æ•ˆçš„è¾“å‡º  // `\\n\u0026lt;div\u0026gt;...` åˆ é™¤å¼€å¤´çš„ç©ºæ ¼å­—ç¬¦ï¼Œä¹‹å‰è§£æ v-pre ç”¨ä¾‹æ˜¯å¡åœ¨è¿™é‡Œäº†  // è¿™é‡Œå¿˜è®°å®ç°äº†ï¼Œæ‰€ä»¥ç”¨ä¾‹ http://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/#headline-3  // å¾—åˆ°äº†ä¸‰ä¸ª childï¼Œç¬¬äºŒä¸ªæ˜¯ \\nï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œæ²¡å®ç°è¿‡æ»¤  if (mode !== TextModes.RAWTEXT) { if (!context.inPre) { for (let i = 0; i \u0026lt; nodes.length; i++) { const node = nodes[i]; if (node.type === NodeTypes.TEXT) { if (!/[^\\t\\r\\n\\f ]/.test(node.content)) { const prev = nodes[i - 1]; const next = nodes[i + 1]; // 1. ç©ºæ ¼æ˜¯ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…  // 2. ç©ºæ ¼ä¸æ³¨é‡ŠèŠ‚ç‚¹ç›¸é‚»  // 3. ç©ºæ ¼åœ¨ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œå°±æˆ‘ä»¬é‡åˆ°çš„ \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\\n\u0026lt;div\u0026gt;...  // ä¸Šé¢ä¸‰ç§æƒ…å†µçš„ç©ºæ ¼ä¼šè¢«å¿½ç•¥  if ( !prev || !next || prev.type === NodeTypes.COMMENT || next.type === NodeTypes.COMMENT || (prev.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; next.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; /[\\r\\n]/.test(node.content)) ) { removedWhitespace = true; nodes[i] = null; } else { // å¦åˆ™æ›¿æ¢æˆç©ºæ ¼  node.content = \u0026#34; \u0026#34;; } } else { // æ›¿æ¢æˆç©ºæ ¼  node.content = node.content.replace(/[\\t\\r\\n\\f ]+/g, \u0026#34; \u0026#34;); } } } } else if (parent \u0026amp;\u0026amp; context.options.isPreTag(parent.tag)) { //å¦‚æœæ˜¯ \u0026lt;pre\u0026gt; åˆ æ‰ç¬¬ä¸€è¡Œçš„ç©ºè¡Œ  const first = nodes[0]; if (first \u0026amp;\u0026amp; first.type === NodeTypes.TEXT) { first.content = first.content.replace(/^\\r?\\n/, \u0026#34;\u0026#34;); } } } // \u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt; æ–°å¢-end  return removedWhitespace ? nodes.filter(Boolean) : nodes; }      ä¿®æ”¹ parseTag å¢åŠ  v-pre, \u0026lt;pre\u0026gt; ä»£ç å¤„ç†\n è¿™é‡Œä¼šæœ‰ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹å°±æ˜¯å®ƒæ£€æµ‹åˆ°æ˜¯ pre ä¼šå›å¤´é‡æ–°è§£æå±æ€§ï¼Œç„¶åè¿‡æ»¤æ‰ v-pre æŒ‡ä»¤ï¼Œå¹¶ä¸”åœ¨ parseAttribute é‡Œé¢ä¼šæ£€æµ‹åˆ° inVPre ä»æ¥ä¸ä¼šè¿› è¡ŒæŒ‡ä»¤è§£æï¼Œåªä¼šè§£ææ™®é€šçš„ propsã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  function parseTag(context, type, parent) { // ...  // æ–°å¢-start  if (context.options.isPreTag(tag)) { context.inPre = true; } // 1. inVPre = false å› ä¸ºåˆå§‹åŒ–é»˜è®¤ä¸ä¼šæ˜¯ v-pre çš„  // 2. åªè¦å±æ€§åˆ—è¡¨ä¸­æœ‰ä¸€ä¸ªæ»¡è¶³ï¼šv-pre æŒ‡ä»¤ç±»å‹  if ( !context.inVPre \u0026amp;\u0026amp; props.some((p) =\u0026gt; p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; p.name === \u0026#34;pre\u0026#34;) ) { context.inVPre = true; // è¿™é‡Œæ¢å¤ä¹‹å‰çš„è§£æï¼Œå› ä¸º \u0026lt;div v-pre\u0026gt;...\u0026lt;/div\u0026gt; èµ°åˆ°è¿™é‡Œçš„æ—¶å€™å·²ç»è§£æå®Œäº†  // æ‰€ä»¥è¦æ¢å¤å±æ€§å­—ç¬¦ä¸²ï¼Ÿ  extend(context, cursor); context.source = currentSource; // ä¸ºä»€ä¹ˆè¦é‡æ–°è§£æï¼Œç›´æ¥è¿‡æ»¤ä¸å¥½å—ï¼Ÿ  // å› ä¸º parseAttribute ä¸­åœ¨ inVPre = true æƒ…å†µä¸‹æ˜¯ä¸ä¼šå»è§£æå…¶ä»–æŒ‡ä»¤å±æ€§çš„  // å…¶ä»–æŒ‡ä»¤ç…§æ ·ä¼šè§£æï¼Œç›´æ¥è¿‡æ»¤æ‰æ‰€æœ‰æŒ‡ä»¤å±æ€§ä¸å°±å¥½äº†ï¼Ÿ  props = parseAttributes(context, type).filter((p) =\u0026gt; p.name !== \u0026#34;v-pre\u0026#34;); } // æ–°å¢-end  // ...  const val = { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined, }; return val; }        11-\u0026lt;div\u0026gt; id=a/\u0026gt;\u0026lt;/div\u0026gt; å±æ€§å€¼ä¸­æ²¡æœ‰å¼•å·æ—¶   æ²¡æœ‰å¼•å·çš„æ—¶å€™æœ‰ä¸€äº›éæ³•å­—ç¬¦ï¼š const unexpectedChars = /[\u0026#34;\u0026#39;\u0026lt;=`]/g; ï¼Œé‡åˆ°è¿™äº› å€¼çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚\n åœ¨è¿™ä¹‹å‰æœ‰ä¸€ä¸ªåŒ¹é…ä½¿ç”¨æ¥åŒ¹é…å‡ºå€¼çš„ï¼š\n const match = /^[^\\t\\r\\n\\f \u0026gt;]+/.exec(context.source);\n è¿™ä¸ªä¼šå°† \u0026gt; ä¹‹å‰çš„ = ä¹‹åçš„å±æ€§å€¼åŒ¹é…å‡ºæ¥ï¼Œç„¶åäº¤ç»™ parseTextData è¿›è¡Œè§£æã€‚\n  10-\u0026lt;div\u0026gt; id=\u0026#34;\u0026gt;\\\u0026#39;\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; å±æ€§å€¼ä¸­æœ‰å¼•å·æ—¶   è¿™ç§æƒ…å†µæ˜¯åˆæ³•çš„ï¼Œå±æ€§å€¼é‡Œé¢çš„å†…å®¹ä¼šè¢«å½“åšçº¯æ–‡æœ¬å¤„ç†ã€‚\nprops: Array(1) 0: name: \u0026#34;id\u0026#34; type: 6 value: content: \u0026#34;\u0026gt;\u0026#39;\u0026#34; // å±æ€§å€¼ type: 2   è¿™ä¸ªå¤„ç†è·Ÿ ç”¨ä¾‹09 æ˜¯ä¸€æ ·çš„é€»è¾‘\n å¤šä¸ªå±æ€§çš„æƒ…å†µï¼Œåœ¨ parseAttributes ä¸­æœ‰ä¸ª while å¾ªç¯å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function parseAttributes( context: ParserContext, type: TagType ): (AttributeNode | DirectiveNode)[] { const props = [] const attributeNames = new Set\u0026lt;string\u0026gt;() while ( context.source.length \u0026gt; 0 \u0026amp;\u0026amp; !startsWith(context.source, \u0026#39;\u0026gt;\u0026#39;) \u0026amp;\u0026amp; !startsWith(context.source, \u0026#39;/\u0026gt;\u0026#39;) ) { // ...  const attr = parseAttribute(context, attributeNames) // ...  } return props }      09-\u0026lt;div id=\u0026#34;\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; å±æ€§å€¼ä¸ºç©ºçš„æƒ…å†µ  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  test(\u0026#39;attribute with empty value, double quote\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;div id=\u0026#34;\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;) const element = ast.children[0] as ElementNode expect(element).toStrictEqual({ type: NodeTypes.ELEMENT, ns: Namespaces.HTML, tag: \u0026#39;div\u0026#39;, tagType: ElementTypes.ELEMENT, codegenNode: undefined, props: [ { type: NodeTypes.ATTRIBUTE, name: \u0026#39;id\u0026#39;, value: { type: NodeTypes.TEXT, content: \u0026#39;\u0026#39;, loc: { start: { offset: 8, line: 1, column: 9 }, end: { offset: 10, line: 1, column: 11 }, source: \u0026#39;\u0026#34;\u0026#34;\u0026#39; } }, loc: { start: { offset: 5, line: 1, column: 6 }, end: { offset: 10, line: 1, column: 11 }, source: \u0026#39;id=\u0026#34;\u0026#34;\u0026#39; } } ], isSelfClosing: false, children: [], loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 17, line: 1, column: 18 }, source: \u0026#39;\u0026lt;div id=\u0026#34;\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#39; } }) })     è§£æï¼š parseTag -\u0026gt; parseAttributes -\u0026gt; parseAttribute -\u0026gt; parseAttributeValue -\u0026gt; parseTextData ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œç»„ç»‡ï¼š { type, content: \u0026#39;\u0026#39;, ... } è¿”å›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  function parseAttributeValue( context: ParserContext ) { // ...çœç•¥  const quote = context.source[0] const isQuoted = quote === `\u0026#34;` || quote === `\u0026#39;` if (isQuoted) { // id=\u0026#34;\u0026#34;ï¼Œæœ‰å¼•å·  // Quoted value.  advanceBy(context, 1) const endIndex = context.source.indexOf(quote) if (endIndex === -1) { content = parseTextData( context, context.source.length, TextModes.ATTRIBUTE_VALUE ) } else { // åˆ°è¿™é‡Œ  content = parseTextData(context, endIndex, TextModes.ATTRIBUTE_VALUE) advanceBy(context, 1) } } else { // ä¸ä¼šåˆ°è¿™é‡Œ  } return { content, isQuoted, loc: getSelection(context, start) } }      08-\u0026lt;div id\u0026gt;\u0026lt;/div\u0026gt; æ— å±æ€§å€¼çš„å±æ€§  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  test(\u0026#34;attribute with no value\u0026#34;, () =\u0026gt; { const ast = baseParse(\u0026#34;\u0026lt;div id\u0026gt;\u0026lt;/div\u0026gt;\u0026#34;); const element = ast.children[0]; expect(element).toStrictEqual({ type: NodeTypes.ELEMENT, ns: Namespaces.HTML, tag: \u0026#34;div\u0026#34;, tagType: ElementTypes.ELEMENT, codegenNode: undefined, props: [ { type: NodeTypes.ATTRIBUTE, name: \u0026#34;id\u0026#34;, value: undefined, loc: { start: { offset: 5, line: 1, column: 6 }, end: { offset: 7, line: 1, column: 8 }, source: \u0026#34;id\u0026#34;, }, }, ], isSelfClosing: false, children: [], loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 14, line: 1, column: 15 }, source: \u0026#34;\u0026lt;div id\u0026gt;\u0026lt;/div\u0026gt;\u0026#34;, }, }); }); // attribute with no value      è§£æï¼š parseTag -\u0026gt; parseAttributes -\u0026gt; parseAttribute é‡Œé¢æœ‰ä¸€æ®µé’ˆå¯¹å±æ€§å€¼å¤„ç†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  function parseAttribute( context: ParserContext, nameSet: Set\u0026lt;string\u0026gt; ): AttributeNode | DirectiveNode { // ... çœç•¥  // è¿™é‡Œæ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ name= æˆ– name=value æƒ…å†µ  if (/^[\\t\\r\\n\\f ]*=/.test(context.source)) { advanceSpaces(context) advanceBy(context, 1) advanceSpaces(context) value = parseAttributeValue(context) // è¿™é‡Œæ˜¯é˜²æ­¢ name= åé¢æ²¡æœ‰å€¼å¾—æƒ…å†µæŠ¥é”™  if (!value) { emitError(context, ErrorCodes.MISSING_ATTRIBUTE_VALUE) } } // ... å› ä¸º id æ²¡æœ‰ id=? æ‰€ä»¥ç›´æ¥å›åˆ°è¿™é‡Œï¼Œä¸ä¼šè¿›å…¥  // parseAttributeValue è§£æå±æ€§å€¼  // ... id éæŒ‡ä»¤å±æ€§ï¼Œæ‰€ä»¥ç›´æ¥åˆ°æœ€åä»¥æ™®é€šå±æ€§ç±»å‹é€€å‡º  return { type: NodeTypes.ATTRIBUTE, name, value: value \u0026amp;\u0026amp; { type: NodeTypes.TEXT, content: value.content, loc: value.loc }, loc } }      07-isCustomElement è‡ªå®šä¹‰å…ƒç´   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  test(\u0026#34;custom element\u0026#34;, () =\u0026gt; { const ast = baseParse(\u0026#34;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;comp\u0026gt;\u0026lt;/comp\u0026gt;\u0026#34;, { isNativeTag: (tag) =\u0026gt; tag === \u0026#34;div\u0026#34;, isCustomElement: (tag) =\u0026gt; tag === \u0026#34;comp\u0026#34;, }); expect(ast.children[0]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#34;div\u0026#34;, tagType: ElementTypes.ELEMENT, // ç”±äºæ˜¯ isNativeTag() ä½¿ç”¨äº†é»˜è®¤ ELEMENT  }); expect(ast.children[1]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#34;comp\u0026#34;, tagType: ElementTypes.ELEMENT, // ç”±äºæ˜¯ isCustomElement() æ‰€ä»¥å‹æ ¹ä¸ä¼šè¿›å…¥åˆ° if ... ä¸­æ£€æµ‹ç±»å‹  }); })     è‡ªå®šä¹‰ç±»å‹åˆ¤æ–­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57  function parseTag( context: ParserContext, type: TagType, parent: ElementNode | undefined ): ElementNode { // ... çœç•¥  let tagType = ElementTypes.ELEMENT const options = context.options // \u0026lt;comp\u0026gt; ç”±äºæ˜¯ isCustomElement å› æ­¤å‹æ ¹ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ if (false) ...  if (!context.inVPre \u0026amp;\u0026amp; !options.isCustomElement(tag)) { const hasVIs = props.some( p =\u0026gt; p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; p.name === \u0026#39;is\u0026#39; ) if (options.isNativeTag \u0026amp;\u0026amp; !hasVIs) { // div ä¼šè¿›å…¥åˆ°è¿™é‡Œï¼Œä½†æ˜¯æ£€æµ‹å¤±è´¥ if (!true) ...  if (!options.isNativeTag(tag)) tagType = ElementTypes.COMPONENT } else if ( // div è¿™é‡Œéƒ½ä¸æ»¡è¶³ï¼Œif (false) ...  hasVIs || isCoreComponent(tag) || (options.isBuiltInComponent \u0026amp;\u0026amp; options.isBuiltInComponent(tag)) || /^[A-Z]/.test(tag) || tag === \u0026#39;component\u0026#39; ) { tagType = ElementTypes.COMPONENT } if (tag === \u0026#39;slot\u0026#39;) { tagType = ElementTypes.SLOT } else if ( tag === \u0026#39;template\u0026#39; \u0026amp;\u0026amp; props.some(p =\u0026gt; { return ( p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; isSpecialTemplateDirective(p.name) ) }) ) { tagType = ElementTypes.TEMPLATE } } // æ‰€ä»¥ \u0026lt;div\u0026gt; æœ€ç»ˆä½¿ç”¨äº†é»˜è®¤å€¼ï¼šELEMENT  // æ‰€ä»¥ \u0026lt;comp\u0026gt; ç›´æ¥åˆ°äº†è¿™é‡Œï¼Œæ˜¯ï¼šELEMENT ç±»å‹  return { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined // to be created during transform phase  } }      06-isNativeTag åŸç”Ÿæ ‡ç­¾ç±»å‹   è¿™ä¸ªç”¨ä¾‹(\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;comp\u0026gt;\u0026lt;/comp\u0026gt;\u0026lt;Comp\u0026gt;\u0026lt;/Comp\u0026gt;)é‡Œé¢æœ‰ä¸‰ä¸ªæ ‡ç­¾ï¼š\n  div\n  comp\n  Comp\n   åŒæ—¶ä¼ é€’ä¸€ä¸ª options: { isNativeTag: tag =\u0026gt; tag === \u0026#39;div\u0026#39; }\n æ„æ€å‘Šè¯‰ç¼–è¯‘å™¨è¿™é‡Œé¢åªæœ‰ div å±äºåŸç”Ÿæ ‡ç­¾ï¼Œå…¶ä»–çš„éƒ½å±äºç»„ä»¶ç±»å‹ï¼Œè¿™ä¸ªåœ¨ parseTag å®ç°ä¸­ä½“ç°å‡ºæ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  test(\u0026#34;native element with `isNativeTag`\u0026#34;, () =\u0026gt; { const ast = baseParse(\u0026#34;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;comp\u0026gt;\u0026lt;/comp\u0026gt;\u0026lt;Comp\u0026gt;\u0026lt;/Comp\u0026gt;\u0026#34;, { isNativeTag: (tag) =\u0026gt; tag === \u0026#34;div\u0026#34;, }); expect(ast.children[0]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#34;div\u0026#34;, tagType: ElementTypes.ELEMENT, }); expect(ast.children[1]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#34;comp\u0026#34;, tagType: ElementTypes.COMPONENT, }); expect(ast.children[2]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#34;Comp\u0026#34;, tagType: ElementTypes.COMPONENT, }); }); // native element with `isNativeTag`      é€šè¿‡è¯¥ç”¨ä¾‹çš„ä»£ç å®ç°ç‰‡æ®µ(åœ¨ç”¨ä¾‹ 05 ä¸­å°±å·²ç»å®ç°è¿‡äº†ï¼Œå› æ­¤è¯¥ç”¨ä¾‹é¡ºåˆ©é€šè¿‡)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  function parseTag( context: ParserContext, type: TagType, parent: ElementNode | undefined ): ElementNode { // ... çœç•¥  let tagType = ElementTypes.ELEMENT const options = context.options // å‰æï¼Œé v-pre æŒ‡ä»¤ï¼Œä¸”éè‡ªå®šä¹‰æ ‡ç­¾(é»˜è®¤ï¼šNO)  if (!context.inVPre \u0026amp;\u0026amp; !options.isCustomElement(tag)) { // æ˜¯å¦æœ‰ v-is æŒ‡ä»¤  const hasVIs = props.some( p =\u0026gt; p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; p.name === \u0026#39;is\u0026#39; ) // é¦–å…ˆç”±æä¾›åŸç”Ÿæ ‡ç­¾æ£€æµ‹å‡½æ•°ï¼Œä¸”æ²¡æœ‰ v-is æƒ…å†µä¸‹è¿›å…¥ç»„ä»¶åˆ¤æ–­  if (options.isNativeTag \u0026amp;\u0026amp; !hasVIs) { // ç±»å‹ä¸º COMPONENT ç»„ä»¶ç±»å‹  if (!options.isNativeTag(tag)) tagType = ElementTypes.COMPONENT } // ... çœç•¥  } return { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined // to be created during transform phase  } }     è€Œåœ¨æ²¡æœ‰æä¾› isNativeTag() çš„æƒ…å†µä¸‹ï¼Œä¸‰ç§æ ‡ç­¾çš„è§£æç»“æœä¸­çš„ tagType åˆæ˜¯ä¸ä¸€ æ ·çš„ï¼Œå»¶ç»­ä¸Šé¢çš„å¸¦ç»§ç»­åˆ†æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  function parseTag( context: ParserContext, type: TagType, parent: ElementNode | undefined ): ElementNode { // ... çœç•¥  let tagType = ElementTypes.ELEMENT const options = context.options // å‰æï¼Œé v-pre æŒ‡ä»¤ï¼Œä¸”éè‡ªå®šä¹‰æ ‡ç­¾(é»˜è®¤ï¼šNO)  if (!context.inVPre \u0026amp;\u0026amp; !options.isCustomElement(tag)) { // æ˜¯å¦æœ‰ v-is æŒ‡ä»¤  const hasVIs = props.some( p =\u0026gt; p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; p.name === \u0026#39;is\u0026#39; ) // é¦–å…ˆç”±æä¾›åŸç”Ÿæ ‡ç­¾æ£€æµ‹å‡½æ•°ï¼Œä¸”æ²¡æœ‰ v-is æƒ…å†µä¸‹è¿›å…¥ç»„ä»¶åˆ¤æ–­  if (options.isNativeTag \u0026amp;\u0026amp; !hasVIs) { // ç±»å‹ä¸º COMPONENT ç»„ä»¶ç±»å‹  if (!options.isNativeTag(tag)) tagType = ElementTypes.COMPONENT } else if ( // æŠŠè¿™é‡Œçœç•¥çš„éƒ¨åˆ†åŠ ä¸Š...  hasVIs || isCoreComponent(tag) || (options.isBuiltInComponent \u0026amp;\u0026amp; options.isBuiltInComponent(tag)) || // é‡ç‚¹åœ¨è¿™é‡Œï¼Œæ£€æµ‹åˆ°å¦‚æœæ ‡ç­¾åå¼€å¤´æ˜¯å¤§å†™çš„å°±ä¼šè¢«è§†ä¸ºç»„ä»¶ç±»å‹  /^[A-Z]/.test(tag) || tag === \u0026#39;component\u0026#39; ) { tagType = ElementTypes.COMPONENT } // ... çœç•¥  } return { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined // to be created during transform phase  } }     é‚£ä¹ˆæ¥ä¸‹æ¥çš„ç”¨ä¾‹ä¹Ÿä¸æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  test(\u0026#39;v-is without `isNativeTag`\u0026#39;, () =\u0026gt; { const ast = baseParse( `\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;div v-is=\u0026#34;\u0026#39;foo\u0026#39;\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;Comp\u0026gt;\u0026lt;/Comp\u0026gt;`, { isNativeTag: tag =\u0026gt; tag === \u0026#39;div\u0026#39; } ) expect(ast.children[0]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#39;div\u0026#39;, tagType: ElementTypes.ELEMENT // è¿™é‡Œæ¯‹åº¸ç½®ç–‘æ˜¯é»˜è®¤åŸç”Ÿå…ƒç´ ç±»å‹  }) expect(ast.children[1]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#39;div\u0026#39;, // å®¹æ˜“äº§ç”Ÿç–‘é—®çš„æ˜¯è¿™ä¸ªï¼Œè¿™é‡Œä¸ºä»€ä¹ˆæ˜¯ COMPONENTï¼Œè€Œä¸æ˜¯ element å‘¢  // è¿™é‡Œå…³é”®åœ¨äº v-isï¼Œè®°å¾—ï¼šisNativeTag() æ£€æµ‹çš„ä¼˜å…ˆçº§æœ€é«˜å‰ææ˜¯ !hasVIs æˆç«‹æƒ…å†µ  // ç„¶è€Œè¿™é‡Œæ˜¾ç„¶ hasVIs === true  // å› æ­¤è¿›å…¥äº† else if (... || hasVIs || ...) { tagType = ElementTypes.COMPONENT }  tagType: ElementTypes.COMPONENT }) expect(ast.children[2]).toMatchObject({ type: NodeTypes.ELEMENT, tag: \u0026#39;Comp\u0026#39;, // è¿™é‡Œæ²¡å•¥ç–‘é—®ï¼Œå¤§å†™å¼€å¤´æ‰€ä»¥æ˜¯ç»„ä»¶ç±»å‹  tagType: ElementTypes.COMPONENT }) })     è‡ªå®šä¹‰ç»„ä»¶ï¼š\n  05-template element with directives   è¿™ä¸ªç”¨ä¾‹å¼€å§‹æ¨¡æ¿çš„è§£æã€‚\n1 2 3 4 5 6 7 8  test(\u0026#39;template element with directives\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;template v-if=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/template\u0026gt;\u0026#39;) const element = ast.children[0] expect(element).toMatchObject({ type: NodeTypes.ELEMENT, tagType: ElementTypes.TEMPLATE }) }     baseParse(\u0026#39;\u0026lt;template v-if=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/template\u0026gt;\u0026#39;) è§£æä¹‹åçš„ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  { \u0026#34;type\u0026#34;:0, \u0026#34;children\u0026#34;:[ { // \u0026lt;template\u0026gt; èŠ‚ç‚¹ \u0026#34;type\u0026#34;:1, \u0026#34;ns\u0026#34;:0, \u0026#34;tag\u0026#34;:\u0026#34;template\u0026#34;, \u0026#34;tagType\u0026#34;:3, \u0026#34;props\u0026#34;:[ { \u0026#34;type\u0026#34;:7, // DIRECTIVE \u0026#34;name\u0026#34;:\u0026#34;if\u0026#34;, \u0026#34;exp\u0026#34;:{ \u0026#34;type\u0026#34;:4, // SIMPLE_EXPRESSION \u0026#34;content\u0026#34;:\u0026#34;ok\u0026#34;, \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;loc\u0026#34;:{ // ... çœç•¥ } }, \u0026#34;modifiers\u0026#34;:[ // ä¿®é¥°ç¬¦ ], \u0026#34;loc\u0026#34;:{ // çœç•¥ \u0026#34;source\u0026#34;:\u0026#34;v-if=\u0026#34;ok\u0026#34;\u0026#34; } } ], // ... çœç•¥ } ], // ... çœå» }     ä¸ºäº†èƒ½è§£æå‡º v-if=\u0026#34;ok\u0026#34; æˆ‘ä»¬éœ€è¦å»å®ç° parseAttributes(context, type) -\u0026gt; parseAttribute -\u0026gt; parseAttributeValue\n è¯¥ç”¨ä¾‹è€ƒå¯Ÿçš„å…¶å®å¹¶ä¸æ˜¯ \u0026lt;template\u0026gt; æ¨¡æ¿æ ‡ç­¾è§£æï¼Œè€Œæ˜¯æ ‡ç­¾ä¸Šçš„å±æ€§è§£æï¼Œå¯¹æ™®é€šçš„ \u0026lt;div\u0026gt; æ ‡ç­¾ä¾ç„¶å¯ä»¥è§£æå‡ºå±æ€§ props[]ã€‚\n é’ˆå¯¹æ¨¡æ¿ \u0026lt;template\u0026gt; æ ‡ç­¾çš„å¤„ç†è¯¦æƒ…å¯ä»¥æŸ¥çœ‹æ­¤å¤„(å«è„‘å›¾)ï¼Œæ›´ç›´è§‚ã€‚\n   04-void element   ç©ºæ ‡ç­¾è§£æï¼Œå¦‚ï¼š~\u0026lt;img\u0026gt;~\n å‰ææ˜¯æä¾›äº† isVoidTag() é€‰é¡¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  test(\u0026#39;void element\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;img\u0026gt;after\u0026#39;, { isVoidTag: (tag) =\u0026gt; tag === \u0026#39;img\u0026#39; }) const element = ast.children[0] expect(element).toStrictEqual({ type: NodeTypes.ELEMENT, ns: Namespaces.HTML, tag: \u0026#39;img\u0026#39;, tagType: ElementTypes.ELEMENT, codegenNode: undefined, props: [], isSelfClosing: false, children: [], loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 5, line: 1, column: 6 }, source: \u0026#39;\u0026lt;img\u0026gt;\u0026#39; } }) }     è¯¥ç”¨ä¾‹å’Œè‡ªé—­æ ‡ç­¾ç±»ä¼¼éƒ½æ˜¯åœ¨ parseTag è§£æå®Œä¹‹ååœ¨ parseElement ä¸­ç»“æŸè§£æï¼Œä¸åŒç‚¹ åœ¨äºè°ƒç”¨ baseParse çš„æ—¶å€™éœ€è¦ä¼ é€’ä¸€ä¸ªåŒ…å« isVoidTag() çš„é€‰é¡¹ {isVoidTag: tag =\u0026gt; tag === \u0026#39;img\u0026#39;} ç”¨æ¥å‘Šè¯‰è§£æå™¨ä»€ä¹ˆæ ·çš„æ ‡ç­¾å±äºç©ºæ ‡ç­¾ï¼Œå³ä¸æ˜¯ \u0026lt;img/\u0026gt; ä¹Ÿä¸æ˜¯ \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt; ç±»å‹ã€‚\n parseElement ä¸­è§£ææ¡ä»¶ï¼š\n1 2 3 4 5 6 7 8  parseElement(context, ancestors) { // ... parseTag ä¸­è§£æ \u0026lt;img ...\u0026gt;  // è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†  if (element.isSelfClosing || context.options.isVoidTag?.(element.tag)) { return element } // ...  }      03-self closing  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  test(\u0026#39;self closing\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;div/\u0026gt;after\u0026#39;) const element = ast.children[0] expect(element).toStrictEqual({ type: NodeTypes.ELEMENT, ns: Namespaces.HTML, tag: \u0026#39;div\u0026#39;, tagType: ElementTypes.ELEMENT, codegenNode: undefined, props: [], isSelfClosing: true, children: [], loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 6, line: 1, column: 7 }, source: \u0026#39;\u0026lt;div/\u0026gt;\u0026#39; } }) }      02-empty div   å’Œ 01-simple div ä¸€æ ·ï¼Œæ— éå°±æ˜¯æ²¡æœ‰ children[] å­èŠ‚ç‚¹äº†ã€‚åœ¨ parseElement -\u0026gt; parseTag è§£æå°±ç»“æŸäº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  test(\u0026#39;empty div\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;) const element = ast.children[0] expect(element).toStrictEqual({ type: NodeTypes.ELEMENT, ns: Namespaces.HTML, tag: \u0026#39;div\u0026#39;, tagType: ElementTypes.ELEMENT, codegenNode: undefined, props: [], isSelfClosing: false, children: [], loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 11, line: 1, column: 12 }, source: \u0026#39;\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026#39; } }) }      01-simple div   æµç¨‹å›¾ï¼š  å› ä¸º parseElement å·²ç»å®ç°ï¼Œå› æ­¤è¿™ä¸ªé¡ºåˆ©é€šè¿‡ï¼Œ~parseElement~ è§£æå…ˆæ£€æµ‹ \u0026lt;/div\u0026gt; ç»“æŸæ ‡ç­¾ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºéæ³•æ— ç»“æŸæ ‡ç­¾è§¦å‘ ErrorCodes.EOF_IN_TAG å¼‚å¸¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  test(\u0026#39;simple div\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt;\u0026#39;) const element = ast.children[0] expect(element).toStrictEqual({ type: NodeTypes.ELEMENT, ns: Namespaces.HTML, tag: \u0026#39;div\u0026#39;, tagType: ElementTypes.ELEMENT, codegenNode: undefined, props: [], isSelfClosing: false, // \u0026lt;div åä¸º \u0026gt; ä¸ºéè‡ªé—­åˆæ ‡ç­¾  children: [ { type: NodeTypes.TEXT, content: \u0026#39;hello\u0026#39;, loc: { start: { offset: 5, line: 1, column: 6 }, // h ä½ç½®ç´¢å¼•  end: { offset: 10, line: 1, column: 11 }, // o ä½ç½®ç´¢å¼•  source: \u0026#39;hello\u0026#39; } } ], loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 16, line: 1, column: 17 }, // é‡åˆ°\u0026lt;div\u0026gt; ä¼šç›´æ¥åˆ¤æ–­æ˜¯å¦æœ‰ \u0026lt;/div\u0026gt; ç„¶åæˆªå–`\u0026lt;div\u0026gt;...\u0026lt;/div\u0026gt;  source: \u0026#39;\u0026lt;div\u0026gt;hello\u0026lt;/div\u0026gt;\u0026#39; } }) })     æ ‡ç­¾çš„è§£æåœ¨ parseTag ä¸­å®Œæˆï¼Œ å¦‚æœæ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œä¼šç½®æ ‡å¿—ä½ isSelfClosing = true ã€‚\n å¹¶ä¸”è§£ææ ‡ç­¾åªä¼šè§£æåˆ° \u0026lt;div\u0026gt; ä¸­çš„ \u0026lt;div éƒ¨åˆ†å°±ç»“æŸï¼Œæ˜¯å› ä¸ºéœ€è¦æ£€æµ‹åé¢æ˜¯ \u0026gt; è¿˜æ˜¯ /\u0026gt; å¦‚æœæ˜¯ /\u0026gt; åˆ™ä¸ºè‡ªé—­åˆæ ‡ç­¾éœ€è¦åŒºåˆ†å¤„ç†ï¼Œå› æ­¤è¿™é‡Œä¼šæœ‰ä¸ªåˆ¤æ–­æ¥å†³å®š advanceBy 1 æˆ– 2 ä¸ªæŒ‡é’ˆä½ç½®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // parseTag  let isSelfClosing = false if (context.source.length === 0) { emitError(context, ErrorCodes.EOF_IN_TAG) } else { // some \u0026lt;div\u0026gt; ... \u0026lt;/div\u0026gt; åˆ°è¿™é‡Œçš„ source = \u0026gt; ... \u0026lt;/div\u0026gt;  // æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /\u0026gt; å¼€å¤´çš„  isSelfClosing = context.source.startsWith(\u0026#39;/\u0026gt;\u0026#39;) if (type === TagType.End \u0026amp;\u0026amp; isSelfClosing) { emitError(context, ErrorCodes.END_TAG_WITH_TRAILING_SOLIDUS) } // å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/\u0026gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(\u0026gt;)  // åˆ°è¿™é‡Œ source = ... \u0026lt;/div\u0026gt;  advanceBy(context, isSelfClosing ? 2 : 1) }        Comment æ³¨é‡Šè§£æ   æ³¨é‡Šé£æ ¼ï¼š \u0026lt;!-- ... --\u0026gt; ï¼Œé˜¶æ®µ 5 åŠä¹‹å‰è¿˜ä¸æ”¯æŒæ³¨é‡Šè§£æï¼Œå› ä¸ºè¿˜æ²¡å®ç° parseCommentã€‚\n æ³¨é‡Šæµ‹è¯•ç”¨ä¾‹ä¸å­˜åœ¨é˜¶æ®µæ€§çš„å®ç°ï¼Œåªè¦å®ç°äº† parseComment å°±é¥¿éƒ½å¯ä»¥é€šè¿‡äº†ï¼Œå› æ­¤è¿™é‡Œæ”¾åœ¨ä¸€èµ·é€šè¿‡è®°å½•ã€‚\n  empty comment ç©ºæ³¨é‡ŠèŠ‚ç‚¹\n  simple comment æ­£å¸¸æ³¨é‡ŠèŠ‚ç‚¹\n  two comments å¤šä¸ªæ³¨é‡ŠèŠ‚ç‚¹\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  describe(\u0026#39;Comment\u0026#39;, () =\u0026gt; { test(\u0026#39;empty comment\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;!----\u0026gt;\u0026#39;) const comment = ast.children[0] expect(comment).toStrictEqual({ type: NodeTypes.COMMENT, content: \u0026#39;\u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 7, line: 1, column: 8 }, source: \u0026#39;\u0026lt;!----\u0026gt;\u0026#39; } }) }) // empty comment  test(\u0026#39;simple comment\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;!--abc--\u0026gt;\u0026#39;) const comment = ast.children[0] expect(comment).toStrictEqual({ type: NodeTypes.COMMENT, content: \u0026#39;abc\u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 10, line: 1, column: 11 }, source: \u0026#39;\u0026lt;!--abc--\u0026gt;\u0026#39; } }) }) // simple comment  test(\u0026#39;two comments\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;!--abc--\u0026gt;\u0026lt;!--def--\u0026gt;\u0026#39;) const comment1 = ast.children[0] const comment2 = ast.children[1] expect(comment1).toStrictEqual({ type: NodeTypes.COMMENT, content: \u0026#39;abc\u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 10, line: 1, column: 11 }, source: \u0026#39;\u0026lt;!--abc--\u0026gt;\u0026#39; } }) expect(comment2).toStrictEqual({ type: NodeTypes.COMMENT, content: \u0026#39;def\u0026#39;, loc: { start: { offset: 10, line: 1, column: 11 }, end: { offset: 20, line: 1, column: 21 }, source: \u0026#39;\u0026lt;!--def--\u0026gt;\u0026#39; } }) }) // two comments  })     è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ªç”¨ä¾‹ï¼Œä¸€å¼€å§‹æµ‹è¯•å¹¶ä¸èƒ½é€šè¿‡ï¼Œæ˜¯å› ä¸ºå®ç° pushNode çš„æ—¶å€™å¿˜è®°åŠ ä¸Š __DEV__ ç¯å¢ƒæ£€æµ‹äº†ï¼Œå› ä¸ºç”Ÿäº§ç¯å¢ƒæ˜¯ä¸éœ€è¦ä¿å­˜æ³¨é‡ŠèŠ‚ç‚¹çš„ï¼Œå¼€å‘ç¯å¢ƒä¸ºäº†æµ‹è¯•éœ€è¦æœ‰ è¿™ä¸ªä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function pushNode(nodes, node) { // è¿™é‡ŒåŠ ä¸Š __DEV__ æ£€æµ‹ï¼Œå¼€å‘çš„æ—¶å€™è¿˜æ˜¯éœ€è¦çš„  // ä¸ç„¶ç”¨ä¾‹ä¼šé€šä¸è¿‡ï¼Œå› ä¸ºè¿™é‡Œç›´æ¥è¿”å› Undefined äº†ï¼Œå¯¼è‡´  // parent.children[] é‡Œé¢å¹¶ä¸å­˜åœ¨è¿™ä¸ªæ³¨é‡ŠèŠ‚ç‚¹  // åŠ ä¸Šå°±å¥½äº†  if (!__DEV__ \u0026amp;\u0026amp; node.type === NodeTypes.COMMENT) { // æ³¨é‡ŠèŠ‚ç‚¹ä¸å¤„ç†  return } // ... çœç•¥  }      Interpolation æ’å€¼è§£æ  05-custom delimiters   è‡ªå®šä¹‰æ’å€¼åˆ†éš”ç¬¦ï¼Œå…¶å®å¤„ç†æµç¨‹å’Œæ’å€¼å¤„ç†ä¸€æ ·ï¼Œæ‰€ä»¥æ²¡å•¥å¥½è®²çš„ï¼Œé˜¶æ®µä»£ç  4 å°±æ”¯æŒè¯¥ç”¨ä¾‹é€šè¿‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  test(\u0026#39;custom delimiters\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;p\u0026gt;{msg}\u0026lt;/p\u0026gt;\u0026#39;, { delimiters: [\u0026#39;{\u0026#39;, \u0026#39;}\u0026#39;] }) const element = ast.children[0] const interpolation = element.children[0] expect(interpolation).toStrictEqual({ type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, content: `msg`, isStatic: false, isConstant: false, loc: { start: { offset: 4, line: 1, column: 5 }, end: { offset: 7, line: 1, column: 8 }, source: \u0026#39;msg\u0026#39; } }, loc: { start: { offset: 3, line: 1, column: 4 }, end: { offset: 8, line: 1, column: 9 }, source: \u0026#39;{msg}\u0026#39; } }) })      04-it can have tag-like notation (3)   å‰é¢çš„ä¸¤ä¸ªç”¨ä¾‹å·²ç»è§£é‡Šè¿‡äº†ï¼Œæ’å€¼é‡Œé¢çš„å†…å®¹ä¼šåœ¨ parseInterpolation ä¸­ç›´æ¥å¤„ç†æˆæ’ å€¼çš„æ¨¡æ¿(source)ï¼Œä¸ä¼šè¿›å…¥åˆ° while å¾ªç¯è§¦å‘å¼‚å¸¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  test(\u0026#39;it can have tag-like notation (3)\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;\u0026lt;div\u0026gt;{{ \u0026#34;\u0026lt;/div\u0026gt;\u0026#34; }}\u0026lt;/div\u0026gt;\u0026#39;) // è¿™é‡Œè§£æå‡ºæ¥çš„æ˜¯ \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt; è¿™ä¸ªå…ƒç´ èŠ‚ç‚¹  const element = ast.children[0] as ElementNode // æ ‡ç­¾å†…éƒ¨çš„æ‰€æœ‰å†…å®¹åœ¨è§£æä¹‹åä¼šè¢«å½“åšå­èŠ‚ç‚¹å­˜æ”¾åˆ° children[] æ•°ç»„ä¸­  // å› æ­¤è¿™é‡Œç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹æ˜¯ä¸ªæ’å€¼æ¨¡æ¿  const interpolation = element.children[0] as InterpolationNode expect(interpolation).toStrictEqual({ type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, isStatic: false, // The `isConstant` is the default value and will be determined in `transformExpression`.  isConstant: false, content: \u0026#39;\u0026#34;\u0026lt;/div\u0026gt;\u0026#34;\u0026#39;, loc: { start: { offset: 8, line: 1, column: 9 }, end: { offset: 16, line: 1, column: 17 }, source: \u0026#39;\u0026#34;\u0026lt;/div\u0026gt;\u0026#34;\u0026#39; } }, loc: { start: { offset: 5, line: 1, column: 6 }, end: { offset: 19, line: 1, column: 20 }, source: \u0026#39;{{ \u0026#34;\u0026lt;/div\u0026gt;\u0026#34; }}\u0026#39; } }) })      03-it can have tag-like notation(2)   è¿™ä¸ªç”¨ä¾‹å…¶å®å’Œ ç”¨ä¾‹ 2 æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ˜¯è§£æäº†ä¸¤ä¸ªæ’å€¼è€Œå·²ï¼Œå…ˆè§£æ {{ a\u0026lt;b }} ï¼Œæœ€åå‰©ä¸‹çš„ {{ c\u0026gt;d }} ä¼šåœ¨é€€å‡º parseInterpolation ä¹‹åå‰©ä½™çš„ context.source ä¸º {{ c\u0026gt;d }} åœ¨ parseChildren é‡Œé¢ç»§ç»­è¿›è¡Œ while å¾ªç¯å¤„ ç†ï¼Œéšåˆæ£€æµ‹åˆ°æ˜¯æ’å€¼å†æ¬¡è°ƒç”¨ parseInterpolation è¿›è¡Œå¤„ç†å¾—åˆ°ç¬¬äºŒä¸ªæ’å€¼èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  test(\u0026#39;it can have tag-like notation (2)\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;{{ a\u0026lt;b }}{{ c\u0026gt;d }}\u0026#39;) const interpolation1 = ast.children[0] as InterpolationNode const interpolation2 = ast.children[1] as InterpolationNode expect(interpolation1).toStrictEqual({ type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, content: `a\u0026lt;b`, isStatic: false, isConstant: false, loc: { start: { offset: 3, line: 1, column: 4 }, end: { offset: 6, line: 1, column: 7 }, source: \u0026#39;a\u0026lt;b\u0026#39; } }, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 9, line: 1, column: 10 }, source: \u0026#39;{{ a\u0026lt;b }}\u0026#39; } }) expect(interpolation2).toStrictEqual({ type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, isStatic: false, isConstant: false, content: \u0026#39;c\u0026gt;d\u0026#39;, loc: { start: { offset: 12, line: 1, column: 13 }, end: { offset: 15, line: 1, column: 16 }, source: \u0026#39;c\u0026gt;d\u0026#39; } }, loc: { start: { offset: 9, line: 1, column: 10 }, end: { offset: 18, line: 1, column: 19 }, source: \u0026#39;{{ c\u0026gt;d }}\u0026#39; } }) }     æ”¯æŒè¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ğŸ›¬\n  02-it can have tag-like notation(1)   è¯¥ç”¨ä¾‹é‡Œé¢è™½ç„¶æœ‰ \u0026lt; ç¬¦å·ï¼Œä½†æ˜¯ç”±äºæ˜¯åœ¨æ’å€¼å†…éƒ¨ï¼Œä¼šè¿›å…¥ parseInterpolation ä¹‹å å°±è¢«è§£ææˆæ’å€¼çš„ sourceï¼Œå¹¶ä¸ä¼šè¿›å…¥ while é‡Œé¢çš„ä½œä¸ºæ ‡ç­¾çš„å¼€å§‹ \u0026lt; æ¥è§£æã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  test(\u0026#39;it can have tag-like notation\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;{{ a\u0026lt;b }}\u0026#39;) const interpolation = ast.children[0] expect(interpolation).toStrictEqual({ type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, content: `a\u0026lt;b`, // content = preTrimContent.trim() å»æ‰å‰åç©ºæ ¼  isStatic: false, isConstant: false, loc: { start: { offset: 3, line: 1, column: 4 }, end: { offset: 6, line: 1, column: 7 }, source: \u0026#39;a\u0026lt;b\u0026#39; } }, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 9, line: 1, column: 10 }, source: \u0026#39;{{ a\u0026lt;b }}\u0026#39; } }) })     é€šè¿‡è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ğŸ›¬\n  01- simple interpolation  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  test(\u0026#39;simple interpolation\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;{{message}}\u0026#39;) const interpolation = ast.children[0] expect(interpolation).toStrictEqual({ type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, content: `message`, isStatic: false, isConstant: false, loc: { start: { offset: 2, line: 1, column: 3 }, // m ä½ç½®  end: { offset: 9, line: 1, column: 10 }, // æœ€åä¸€ä¸ª e ä½ç½®  source: `message` } }, loc: { start: { offset: 0, line: 1, column: 1 }, // ç¬¬ä¸€ä¸ª { ä½ç½®  end: { offset: 11, line: 1, column: 12 }, // æœ€åä¸€ä¸ª } ä½ç½®  source: \u0026#39;{{message}}\u0026#39; } }) }        Text æ–‡æœ¬è§£æ  07-only \u0026#34;{{\u0026#34; don\\\u0026#39;t separate nodes   è¿™ä¸ªç”¨ä¾‹æ˜¯ç”¨æ¥æ£€æµ‹æ’å€¼ä¸å®Œæ•´çš„æƒ…å†µï¼Œæ­£å¸¸ä¼šçˆ†å‡º X_MISSING_INTERPOLATION_END å¼‚ å¸¸ï¼Œåœ¨è¯¥ç”¨ä¾‹ä¸­é‡å†™äº†è¯¥å¼‚å¸¸å¤„ç†ï¼Œå› æ­¤ä¸ä¼šæŠ¥é”™ï¼Œç”¨ä¾‹ä¼šå¾ˆé¡ºåˆ©é€šè¿‡ï¼Œå› ä¸ºæ²¡æœ‰å¼‚å¸¸ï¼Œ parseInterpolation ä¼šé€€å‡ºï¼Œæœ€å {{ ä¼šè¢«å½“åšæ™®é€šæ–‡æœ¬å†…å®¹å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  test(\u0026#39;lonly \u0026#34;{{\u0026#34; don\\\u0026#39;t separate nodes\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;a {{ b\u0026#39;, { onError: (error) =\u0026gt; { if (error.code !== ErrorCodes.X_MISSING_INTERPOLATION_END) { throw error } } }) const text = ast.children[0] expect(text).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#39;a {{ b\u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 6, line: 1, column: 7 }, source: \u0026#39;a {{ b\u0026#39; } }) }) // lonly \u0026#34;{{\u0026#34; don\\\u0026#39;t separate nodes      parseInterpolation è¯¥ç”¨ä¾‹å¤„ç†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  function parseInterpolation(context, mode) { // æ‰¾å‡ºæ’å€¼æ¨¡æ¿çš„å¼€å§‹å’Œç»“æŸç¬¦å·ï¼Œé»˜è®¤æ˜¯ {{ å’Œ }}  const [open, close] = context.options.delimiters const closeIndex = context.source.indexOf(close, open.length) if (closeIndex === -1) { // è¿™é‡Œæ£€æµ‹åˆ°æ²¡æœ‰ }} é€€å‡ºï¼Œå¹¶ä¸”åˆ°è¿™é‡Œ context æŒ‡é’ˆä¿¡æ¯å¹¶æ²¡æœ‰æ”¹å˜  // å› æ­¤é€€å‡ºä¹‹åï¼Œé‡æ–° while æœ€åè¿›å…¥æ–‡æœ¬è§£æ parseText  emitError(context, ErrorCodes.X_MISSING_INTERPOLATION_END) return undefined } // ... çœç•¥  }     test:\nâœ packages git:(master) âœ— jest compiler-core PASS compiler-core/__tests__/parse.spec.js (19.233 s) compiler: parse Text âœ“ simple text (5 ms) âœ“ simple text with invalid end tag (2 ms) âœ“ text with interpolation (1 ms) âœ“ text with interpolation which has `\u0026lt;` (1 ms) âœ“ text with mix of tags and interpolations (1 ms) âœ“ lonly \u0026#34;\u0026lt;\u0026#34; don\u0026#39;t separate nodes (7 ms) âœ“ lonly \u0026#34;{{\u0026#34; don\u0026#39;t separate nodes Test Suites: 1 passed, 1 total Tests: 7 passed, 7 total Snapshots: 0 total Time: 23.277 s Ran all test suites matching /compiler-core/i    06-only \u0026#34;\u0026lt;\u0026#34; don\\\u0026#39;t separate nodes  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  test(\u0026#39;lonly \u0026#34;\u0026lt;\u0026#34; don\\\u0026#39;t separate nodes\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;a \u0026lt; b\u0026#39;, { onError: (err) =\u0026gt; { if (err.code !== ErrorCodes.INVALID_FIRST_CHARACTER_OF_TAG_NAME) { throw err } } }) const text = ast.children[0] expect(text).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#39;a \u0026lt; b\u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 5, line: 1, column: 6 }, source: \u0026#39;a \u0026lt; b\u0026#39; } }) // lonly \u0026#34;\u0026lt;\u0026#34; don\\\u0026#39;t separate nodes  }     è¿™ä¸ªç”¨ä¾‹åœ¨å®ç°çš„ test-05 ä¹‹åå°±å¯ä»¥é€šè¿‡ï¼Œå› ä¸º a \u0026lt; b å¹¶ä¸æ˜¯æ’å€¼ä¸€éƒ¨åˆ†ï¼Œä¼šè¢«å½“åš çº¯æ–‡æœ¬å¤„ç†ï¼Œè€Œä¸ºäº†é¿å…æŠ¥é”™ç”¨ä¾‹ä¸­é‡å†™äº† onError=ï¼Œå› ä¸º while å¾ªç¯é‡Œåœ¨æ£€æµ‹åˆ° =\u0026lt; å¼€å¤´çš„ if æ¡ä»¶åˆ†æ”¯ä¸­ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸ºç©ºæ ¼çš„æƒ…å†µä¼šè¿›å…¥æœ€åçš„ else åˆ†æ”¯å¤„ç†ï¼Œå³è§¦å‘ INVALID_FIRST_CHARACTER_OF_TAG_NAME å¼‚å¸¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  else if (mode === TextModes.DATA \u0026amp;\u0026amp; s[0] === \u0026#39;\u0026lt;\u0026#39;) { // ... æ ‡ç­¾å¼€å¤´ \u0026lt;...  if (s.length === 1) { emitError(context, ErrorCodes.EOF_BEFORE_TAG_NAME, 1) } else if (s[1] === \u0026#39;!\u0026#39;) { // TODO æ³¨é‡Šå¤„ç†ï¼Œ\u0026lt;!-- ...  } else if (s[1] === \u0026#39;/\u0026#39;) { // ...  } else if (/[a-z]/i.test(s[1])) { // ...  } else if (s[1] === \u0026#39;?\u0026#39;) { // ...  } else { // ä¼šè¿›å…¥åˆ°è¿™é‡Œï¼Œè§¦å‘å¼‚å¸¸ï¼Œä½†æ˜¯ç”±äº options é‡Œæä¾›äº† onError é‡å†™äº†å®ƒ  // å› æ­¤è¿™é‡Œä¸ä¼šè§¦å‘å¼‚å¸¸ï¼Œè€Œæ˜¯é€€å‡ºè¯¥åˆ†æ”¯è¿›å…¥ çº¯æ–‡æœ¬å¤„ç†ï¼Œåˆå¹¶æ–‡æœ¬ pushnode æ“ä½œ  emitError(context, ErrorCodes.INVALID_FIRST_CHARACTER_OF_TAG_NAME, 1) } }      05-text with mix of tags and interpolations  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  test(\u0026#39;text with mix of tags and interpolations\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;some \u0026lt;span\u0026gt;{{ foo \u0026lt; bar + foo }} text\u0026lt;/span\u0026gt;\u0026#39;) const text1 = ast.children[0] as TextNode const text2 = (ast.children[1] as ElementNode).children![1] as TextNode expect(text1).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#39;some \u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 5, line: 1, column: 6 }, source: \u0026#39;some \u0026#39; } }) expect(text2).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#39; text\u0026#39;, loc: { start: { offset: 32, line: 1, column: 33 }, end: { offset: 37, line: 1, column: 38 }, source: \u0026#39; text\u0026#39; } }) }     è¿™æ˜¯ä¸ªæ ‡ç­¾+æ’å€¼æ··åˆæ¨¡æ¿ï¼Œç°é˜¶æ®µçš„ä»£ç æ˜¯é€šä¸è¿‡è¯¥æµ‹è¯•çš„ï¼Œå› ä¸ºå®ƒä¼šè¿›å…¥åˆ°ä¸‹é¢è¿™ä¸ªåˆ†æ”¯ï¼š\n1 2 3 4 5 6 7  else if (/[a-z]/i.test(s[2])) { // è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???  // åˆ°è¿™é‡Œå°±ä¼šæŠ¥é”™  emitError(context, ErrorCodes.X_INVALID_END_TAG) parseTag(context, TagType.End, parent) continue } else {     å¦‚æ§åˆ¶å°è¾“å‡ºï¼š\n  é”™è¯¯ä¸Šé¢çš„è¾“å‡ºå…¶å®æ˜¯ }} å’Œ {{ çš„è§£æä½ç½®ä¿¡æ¯ï¼Œå¹¶ä¸” \u0026lt;div\u0026gt; å¹¶æ²¡æœ‰è§£ææ˜¯å› ä¸ºæˆ‘ä»¬ è¿˜æ²¡å®ç° parseElement åˆ†æ”¯é€»è¾‘ï¼Œæ‰€ä»¥ç›´æ¥è¿‡æ»¤æ‰å½“æˆæ–‡æœ¬å¤„ç†äº†ã€‚\n  å³è¾¹ï¼š offset=14 åˆšå¥½æ˜¯ `some \u0026lt;span\u0026gt;{{ ` å­—ç¬¦ä¸²é•¿åº¦ + 1 å³æ’å€¼å†…ç¬¬ä¸€ä¸ªç©ºæ ¼çš„ä½ç½®\n  å·¦è¾¹ï¼šoffset=29 åˆšå¥½æ˜¯ 14 + `foo \u0026lt; bar + foo` é•¿åº¦ä½ç½®(slice ä¸åŒ…å« endIdx)ï¼Œ å³æ’å€¼å†…æœ€åä¸€ä¸ªç©ºæ ¼çš„ä½ç½®\n  æ¥ä¸‹æ¥æˆ‘ä»¬å¾—çœ‹ä¸‹æ€ä¹ˆä¸æŠ¥é”™èƒ½è§£æ \u0026lt;/div\u0026gt; ã€‚\n å¤§æ¦‚çš„çŒœæƒ³æ˜¯åœ¨è§£æ \u0026lt;div\u0026gt; çš„æ—¶å€™å‘ç°æ˜¯æ ‡ç­¾ï¼Œå¯èƒ½ä¼šé‡å†™ onError ï¼Œé¿å…åœ¨è§£æ \u0026lt;/div\u0026gt; è§¦å‘å¼‚å¸¸ï¼Œè€Œæ˜¯è¿›å…¥ parseTag è§£æç»“æŸæ ‡ç­¾ã€‚ä½†å¾ˆå¯æƒœä¸æ˜¯è¿™æ ·ï¼Œè€Œæ˜¯åœ¨ parseElement ä¸­é€’å½’ è°ƒç”¨ parseChildren è§£ææ ‡ç­¾å†…éƒ¨çš„æ¨¡æ¿ï¼Œè§£æå®Œæˆä¹‹åæ£€æµ‹ ç»“æŸæ ‡ç­¾ï¼Œæ— ç»“æŸæ ‡ç­¾ï¼Œéæ³•å¼‚å¸¸ï¼Œå…·ä½“å®ç°è¯·çœ‹ parseElement æºç å® ç°ã€‚ \n åœ¨å®ç°äº† parseElement å’Œéƒ¨åˆ† parseTag ä¹‹åç”¨ä¾‹é€šè¿‡ï¼š\nâœ packages git:(master) âœ— jest compiler-core PASS compiler-core/__tests__/parse.spec.js (14.492 s) compiler: parse Text âœ“ simple text (5 ms) âœ“ simple text with invalid end tag (2 ms) âœ“ text with interpolation (2 ms) âœ“ text with interpolation which has `\u0026lt;` (1 ms) âœ“ text with mix of tags and interpolations (2 ms) Test Suites: 1 passed, 1 total Tests: 5 passed, 5 total Snapshots: 0 total Time: 15.743 s Ran all test suites matching /compiler-core/i.   æœŸé—´ç¢°åˆ°ä¸ªé—®é¢˜ï¼š\n \u0026gt; Cannot find module \u0026#39;core-js/modules/es6.string.iterator\u0026#39; from \u0026#39;packages/compiler-core/parse.js\u0026#39;\n è§£å†³æ–¹æ¡ˆï¼šæ˜¯ core-js é™çº§åˆ° 2\n  04-text with interpolation which has `\u0026lt;`  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  test(\u0026#39;text with interpolation which has `\u0026lt;`\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;some {{ a\u0026lt;b \u0026amp;\u0026amp; c\u0026gt;d }} text\u0026#39;) const text1 = ast.children[0] as TextNode const text2 = ast.children[2] as TextNode expect(text1).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#39;some \u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 5, line: 1, column: 6 }, source: \u0026#39;some \u0026#39; } }) expect(text2).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#39; text\u0026#39;, loc: { start: { offset: 21, line: 1, column: 22 }, end: { offset: 26, line: 1, column: 27 }, source: \u0026#39; text\u0026#39; } }) })     è¿™ä¸ªç”¨ä¾‹å…¶å®å’Œ 03-text with interpolation ç”¨ä¾‹åŸç†ä¸€æ ·ï¼Œè™½ç„¶æ’å€¼é‡Œé¢æœ‰ç‰¹æ®Šå­—ç¬¦ \u0026lt; ï¼Œä½†æ˜¯ç”±äºåœ¨ parseInterpolation å‡½æ•°è§£æè¿‡ç¨‹ä¸­æ˜¯é€šè¿‡æˆªå– {{ åˆ° }} ç›´æ¥çš„å…¨éƒ¨ å­—ç¬¦ä¸²å»è§£æçš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  function parseInterpolation( context: ParserContext, mode: TextModes ): InterpolationNode | undefined { // ... çœç•¥  // ä¹Ÿå°±æ˜¯è¿™ä¸¤è¡Œï¼Œå°† {{ ... }} å†…çš„æ‰€æœ‰å†…å®¹ä¸€æ¬¡æ€§å–å‡ºæ¥è§£æäº†ï¼Œå› æ­¤å¹¶ä¸ä¼š  // è¿›å…¥åˆ° parseChildren çš„ while å¾ªç¯ä¸­å¤„ç†ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°å¼‚å¸¸æƒ…å†µ  const rawContentLength = closeIndex - open.length const rawContent = context.source.slice(0, rawContentLength) // ... çœç•¥  }     æ‰€ä»¥è¿™ä¸ªç”¨ä¾‹ä¼šå¾ˆé¡ºåˆ©çš„é€šè¿‡(åœ¨ 03 ç”¨ä¾‹é€šè¿‡çš„å‰æä¸‹)ã€‚\nPASS packages/compiler-core/__tests__/parse.spec.js (5.375 s) compiler: parse Text âœ“ simple text (5 ms) âœ“ simple text with invalid end tag (3 ms) âœ“ text with interpolation (41 ms) âœ“ text with interpolation which has `\u0026lt;` (3 ms)    03-text with interpolation   è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ -\u0026gt;\n è¯¥ç”¨ä¾‹æ£€éªŒçš„å·®å€¼çš„å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  test(\u0026#34;text with interpolation\u0026#34;, () =\u0026gt; { const ast = baseParse(\u0026#34;some {{ foo + bar }} text\u0026#34;); const text1 = ast.children[0], text2 = ast.children[2]; expect(text1).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#34;some \u0026#34;, loc: { start: { offset: 0, line: 1, column: 1 }, source: \u0026#34;some \u0026#34;, end: { offset: 5, line: 1, column: 6 }, }, }); expect(text2).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#34; text\u0026#34;, loc: { start: { offset: 20, line: 1, column: 21 }, source: \u0026#34; text\u0026#34;, end: { offset: 25, line: 1, column: 26 }, }, }); }     å·®å€¼çš„å¤„ç†åˆ†æ”¯åœ¨ parseChildren çš„\n1 2 3 4  if (!context.inVPre \u0026amp;\u0026amp; startsWith(s, context.options.delimiters[0])) { // \u0026#39;{{\u0026#39;  node = parseInterpolation(context, mode) }     å®Œæˆï¼Œå› ä¸ºéœ€è¦ parseInterpolation() çš„æ”¯æŒã€‚\n ç”¨ä¾‹ç»“æœ(OK )ï¼š\nâœ vue-next-code-read git:(master) âœ— jest parse.spec PASS packages/compiler-core/__tests__/parse.spec.js compiler: parse Text âœ“ simple text (4 ms) âœ“ simple text with invalid end tag (2 ms) âœ“ text with interpolation (47 ms) console.log { column: 18, line: 1, offset: 17 } { column: 9, line: 1, offset: 8 } 1 at parseInterpolation (packages/compiler-core/parse.js:262:11) Test Suites: 1 passed, 1 total Tests: 3 passed, 3 total Snapshots: 0 total Time: 8.776 s Ran all test suites matching /parse.spec/i. âœ vue-next-code-read git:(master) âœ—    02-simple text\\\u0026lt;div\u0026gt;   è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥-\u0026gt;\n åœ¨è·‘è¿™ä¸ªç”¨ä¾‹çš„æ—¶å€™å‡ºç°å†…å­˜æº¢å‡ºäº†ï¼ŒæŸ¥äº†ä¸‹åŸå› æ˜¯å› ä¸ºåªæ˜¯å¢åŠ äº† while é‡Œé¢çš„å„ç§ if åˆ†æ”¯ï¼Œä½†æ˜¯å®é™…å¹¶æ²¡æœ‰å®ç°ï¼Œè¿™ä¸ªç”¨ä¾‹ä¼šèµ°åˆ°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  else if (mode === TextModes.DATA \u0026amp;\u0026amp; s[0] === \u0026#34;\u0026lt;\u0026#34;) { // ... æ ‡ç­¾å¼€å¤´ \u0026lt;...  if (s.length === 1) { emitError(context, ErrorCodes.EOF_BEFORE_TAG_NAME, 1); } else if (s[1] === \u0026#34;!\u0026#34;) { // TODO æ³¨é‡Šå¤„ç†ï¼Œ\u0026lt;!-- ...  } else if (s[1] === \u0026#34;/\u0026#34;) { // \u0026lt;/...  if (s.length === 2) { emitError(context, ErrorCodes.EOF_BEFORE_TAG_NAME, 2); } else if (s[2] === \u0026#34;\u0026gt;\u0026#34;) { // ...  } else if (/[a-z]/i.test(s[2])) { // ä¼šèµ°åˆ°è¿™ä¸ªåˆ†æ”¯é‡Œé¢ï¼Œä½†æ˜¯ç”±äºä¸‹é¢çš„ parseTag æœªå®ç°ï¼Œå› æ­¤ä¸€ç›´åœ¨è¿™ä¸ªåˆ†æ”¯é‡Œé¢å¾ªç¯  // åŠ ä¸Šç”¨ä¾‹é‡Œé¢é‡å†™äº† onError ä¸ä¼š throw err ç»ˆæ­¢ï¼Œå› æ­¤ä¼šå‡ºç°æ­»å¾ªç¯  emitError(context, ErrorCodes.X_INVALID_END_TAG); // ä½†æ˜¯ä¸Šé¢éƒ½æŠ¥é”™äº†ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦åŠ ä¸ª parseTag??? æ­£å¸¸ç†è§£åº”è¯¥æ˜¯èµ°ä¸åˆ°è¿™é‡Œå•Š  // é™¤éæœ‰é‡å†™ onError æŠ¥é”™æœºåˆ¶???  // parseTag(context, TagType.End, parent);  continue; } else { // ...  }     å› æ­¤è¦é€šè¿‡è¿™ä¸ªç”¨ä¾‹ï¼Œå°±å¿…é¡»å¾—å®ç° parseTag(context, TagType.End, parent) å‡½æ•°è§£ææ ‡ç­¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  test(\u0026#34;simple text with invalid end tag\u0026#34;, () =\u0026gt; { const onError = jest.fn(); const ast = baseParse(\u0026#34;some text\u0026lt;/div\u0026gt;\u0026#34;, { onError, }); const text = ast.children[0]; expect(onError).toBeCalled(); expect(text).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#34;some text\u0026#34;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 9, line: 1, column: 10 }, source: \u0026#34;some text\u0026#34;, }, }); }     å› ä¸º baseparse è°ƒç”¨çš„æ—¶å€™æœ‰ä¼ é€’ onError è¦†ç›–æŠ¥é”™ä»£ç ï¼Œä¼šè¿›å…¥åˆ° parseTag è¿›è¡Œè§£æ æ ‡ç­¾ï¼Œå¦‚æœä¸å®ç°ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚å› æ­¤è¿™é‡Œè¦é€šè¿‡è¿™ä¸ªç”¨ä¾‹å°±å¿…é¡»å®ç° parseTag():\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function parseTag(context, type, parent) { // è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦  const start = getCursor(context); // åŒ¹é… \u0026lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ \u0026gt; ç»™å¿½ç•¥æ‰???  const match = /^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i.exec(context.source); const tag = match[1]; const ns = context.options.getNamespace(tag, parent); // log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° \u0026lt;/div\u0026gt; çš„æœ€æœ‰ä¸€ä¸ª \u0026gt; ä¸Š  // åœ¨è¿™é‡Œ context.offset = 10, context.line = 1  advanceBy(context, match[0].length); // è¿‡æ»¤æ‰ç©ºæ ¼  advanceSpaces(context); // log2: ç»è¿‡ advance ä¹‹å context.offset = 15, context.line = 1  // æ­£å¥½è¿‡æ»¤ \u0026lt;/div 5 ä¸ªå­—ç¬¦  const cursor = getCursor(context); const currSource = context.source; }     parseTag å®ç°åˆ°è¿™é‡Œå°±å¯ä»¥æ»¡è¶³é€šè¿‡æµ‹è¯•ç”¨ä¾‹çš„æ¡ä»¶äº†ï¼Œè¿™é‡Œé¢ä¼šå»åŒ¹é… \u0026lt;/div ç„¶åå°† å…¶è¿‡æ»¤æ‰(é€šè¿‡ advanceBy å’Œ advanceSpaces æ¥æ”¹å˜ context é‡Œé¢çš„ offset å’Œ line å€¼)ï¼Œ è¾“å‡ºç»“æœ(log1 å’Œ log2 ä½ç½® context çš„è¾“å‡º)ï¼š\n   01-simple text   è¿™é‡Œç”¨åˆ°çš„å°±ä¸€ä¸ª baseParse å‡½æ•°ï¼Œéœ€è¦æˆ‘ä»¬æ¥å®ç°å…¶åŸºæœ¬çš„åŠŸèƒ½ä»¥é€šè¿‡è¯¥ç”¨ä¾‹ã€‚\n ç”¨ä¾‹æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  test(\u0026#39;simple text\u0026#39;, () =\u0026gt; { const ast = baseParse(\u0026#39;some text\u0026#39;) const text = ast.children[0] as TextNode expect(text).toStrictEqual({ type: NodeTypes.TEXT, content: \u0026#39;some text\u0026#39;, loc: { start: { offset: 0, line: 1, column: 1 }, end: { offset: 9, line: 1, column: 10 }, source: \u0026#39;some text\u0026#39; } }) })     ç”¨ä¾‹çš„åŸºæœ¬åŠŸèƒ½ï¼ŒéªŒè¯ baseParse è§£æå‡ºæ¥çš„æ–‡æœ¬èŠ‚ç‚¹å¯¹è±¡æ˜¯å¦æ»¡è¶³åŸºæœ¬è¦æ±‚ã€‚\n æ”¯æŒè¯¥ç”¨ä¾‹çš„é‡è¦éƒ¨åˆ†ä»£ç ï¼š\n  createParseContext æ„å»ºè¢«è§£æçš„å†…å®¹çš„å¯¹è±¡ç»“æ„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function createParserContext(context, options) /*ParserContext*/ { return { options: { ...defaultParserOptions, ...options, }, // åˆå§‹åŒ–ä»¥ä¸‹å†…å®¹  column: 1, line: 1, offset: 0, originalSource: context, source: context, inPref: false, inVPref: false, }; }      parseChildren\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  function parseChildren( context /* ParserContext*/, mode /*TextModes*/, ancesotrs /*ElementNode[]*/ ) { // ...  const nodes /*TemplateChildNode[]*/ = []; while (!isEnd(context, mode, ancesotrs)) { // do sth  const s = context.source; let node = undefined; // ç”±äº baseparse é‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ  // é¢å»è§£æ  if (mode === TextModes.DATA || mode === TextModes.RCDATA) { // è¿‡ç•¥æ‰éæ–‡æœ¬çš„  if (!context.inVPre \u0026amp;\u0026amp; s.startsWith(context.options.delimiters[0])) { // ... æ’å€¼å¤„ç†{{}}  } else if (mode === TextModes.DATA \u0026amp;\u0026amp; s[0] === \u0026#34;\u0026lt;\u0026#34;) { // ... æ ‡ç­¾å¼€å¤´ \u0026lt;...  } // ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°  // !node ç»™ parseText è§£æ  } if (!node) { // çº¯æ–‡æœ¬é‡ç‚¹åœ¨è¿™é‡Œé¢å¤„ç†ï¼Œæˆªå–å­—ç¬¦ç›´åˆ°é‡åˆ° \u0026lt;, {{, ]]\u0026gt; æ ‡å¿—ç»“æŸ  // ç„¶åä¼ å…¥åˆ° parseTextData() åˆ¤æ–­æ˜¯å¦æ˜¯æ•°æ®ç»‘å®šçš„å˜é‡ï¼Œåœ¨  // context.options.decodeEntities() ä¸­å¤„ç†  node = parseText(context, mode); } if (Array.isArray(node)) { for (let i = 0; i \u0026lt; node.length; i++) { pushNode(nodes, node[i]); } } else { pushNode(nodes, node); } } let removedWhitespace = false; return removedWhitespace ? nodes.filter(Boolean) : nodes; }      parseText\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  function parseText(context, mode) { // å­—ç¬¦ä¸²è§£æç›´åˆ°é‡åˆ° \u0026lt;, {{, ]]\u0026gt; ä¸ºæ­¢  const endTokens = [\u0026#34;\u0026lt;\u0026#34;, context.options.delimiters[0]]; if (mode === TextModes.CDATA) { endTokens.push(\u0026#34;]]\u0026gt;\u0026#34;); } let endIndex = context.source.length; for (let i = 0; i \u0026lt; endTokens.length; i++) { const index = context.source.indexOf(endTokens[i], 1); if (index !== -1 \u0026amp;\u0026amp; endIndex \u0026gt; index) { endIndex = index; } } const start = getCursor(context); // è§£æ \u0026amp; å¼€å¤´çš„ html è¯­ä¹‰çš„ç¬¦å·(\u0026gt;,\u0026lt;,\u0026amp;,\u0026#39;,\u0026#34;)  const content = parseTextData(context, endIndex, mode); return { type: NodeTypes.TEXT, content, // loc:{ start, end, source}  // start,end: { line, column, offset }  loc: getSelection(context, start), }; }      parseTextData\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // è§£ææ–‡æœ¬æ•°æ®ï¼Œçº¯æ–‡æœ¬å†…å®¹  function parseTextData(context, length, mode) { const rawText = context.source.slice(0, length); // è§£ææ¢è¡Œï¼Œæ›´æ–° line, column, offsetï¼Œè¿”å›æ¢è¡Œä¹‹åçš„çš„ source  advanceBy(context, length); if ( mode === TextModes.RAWTEXT || mode === TextModes.CDATA || rawText.indexOf(\u0026#34;\u0026amp;\u0026#34;) === -1 ) { return rawText; } return context.options.decodeEntities( rawText, mode === TextModes.ATTRIBUTE_VALUE ); }      advancedBy è§£æå¤šä¸ªå­—ç¬¦ä¹‹åæ›´æ–° start,end(line,column,offset) ï¼Œå°¤å…¶æ˜¯æ¢è¡Œç¬¦çš„ç‰¹æ®Šå¤„ç†ã€‚\n1 2 3 4 5  function advanceBy(context, numberOfCharacters) { const { source } = context; advancePositionWithMutation(context, source, numberOfCharacters); context.source = source.slice(numberOfCharacters); }      advancePositionWithMutation\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  export function advancePositionWithMutation( pos, source, numberOfCharacters = source.length ) { let linesCount = 0; let lastNewLinePos = -1; for (let i = 0; i \u0026lt; numberOfCharacters; i++) { if (source.charCodeAt(i) === 10 /* newline char code */) { linesCount++; lastNewLinePos = i; } } pos.offset += numberOfCharacters; pos.line += linesCount; pos.column = lastNewLinePos === -1 ? pos.column + numberOfCharacters : numberOfCharacters - lastNewLinePos; return pos; }            å‡½æ•°åˆ—è¡¨  baseParse(context, options)  1 2 3 4 5 6 7 8  function baseParse(content, options /* ParserOptions */) /*RootNode*/ { const context = createParserContext(content, options); const start = getCursor(context); return createRoot( parseChildren(context, TextModes.DATA, []), getSelection(context, start) ); }     baseParse å†…éƒ¨å®ç°åŸºæœ¬å°±æ˜¯è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å¾—é’ˆå¯¹å®ƒä½¿ç”¨çš„å‡ ä¸ªæ–¹æ³•å»é€ä¸€å®ç°ï¼š\n  createParserContextï¼Œåˆ›å»ºèŠ‚ç‚¹è§£æå¯¹è±¡ï¼ŒåŒ…å«è§£æè¿‡ç¨‹ä¸­éœ€è¦æˆ–éœ€è¦ä¿å­˜çš„æ•°æ®\n  getCursorï¼Œè·å– context ä¸­çš„ offset, line, column, start, end ç­‰ä¿¡æ¯\n  createRootï¼Œåˆ›å»ºæ ¹èŠ‚ç‚¹\n  parseChildrenï¼Œè§£æå­èŠ‚ç‚¹\n  getSelectionï¼Œè·å–é€‰ä¸­çš„æœªè§£æçš„å†…å®¹\n  baseParse å‡½æ•°å¤§ä½“ç»“æ„å’Œä»£ç è°ƒç”¨å›¾ç¤ºï¼š\n   createParseContext(context, options)   å‡½æ•°ä½œç”¨ï¼š*åˆ›å»ºè§£æå™¨ä¸Šä¸‹æ–‡å¯¹è±¡(åŒ…å«è§£æè¿‡ç¨‹ä¸­çš„ä¸€äº›è®°å½•ä¿¡æ¯)*\n å‡½æ•°å£°æ˜ï¼š\n function createParserContext(context, options) /*ParserContext*/ {}\n å‚æ•°æ²¡ä»€ä¹ˆå¥½è®²çš„äº†ï¼Œä» baseParse ç»§æ‰¿è€Œæ¥ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª ParserContext ç±»å‹ã€‚å…·ä½“ å®ç°å…¶å®å°±æ˜¯è¿”å›ä¸€ä¸ª ParserContext ç±»å‹çš„å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†æºç å­—ç¬¦ä¸²è¢«è§£ææ˜¯çš„ä¸€ äº›ä¿¡æ¯å­˜å‚¨ï¼Œæ¯”å¦‚ï¼šè§£ææ—¶æŒ‡é’ˆçš„ä½ç½® offsetï¼Œå½“å‰è¡Œåˆ—(line, column)ï¼ŒåŠå…¶ä»–ä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function createParserContext( content: string, options: ParserOptions ): ParserContext { return { options: { // è§£æå™¨çš„é»˜è®¤é€‰é¡¹ç»™äº†äº›é»˜è®¤å€¼ï¼Œæ¯”å¦‚ï¼šisVoidTag: No, isPreTag: NOï¼Œ ç­‰ç­‰  ...defaultParserOptions, ...options }, column: 1, line: 1, offset: 0, originalSource: content, source: content, inPre: false, inVPre: false } }      parseChildren(context, mode, ancestors)  1 2 3 4 5  function parseChildren( context /* ParserContext*/, mode /*TextModes*/, ancesotrs /*ElementNode[]*/ ) /* TemplateChildNode[] */{}     å‚æ•°åˆ—è¡¨ï¼š\n  contextï¼Œå¾…è§£æçš„æ¨¡æ¿å¯¹è±¡(ParserContext)\n  modeï¼Œæ–‡æœ¬æ¨¡å¼(TextModes)\n  ancestorsï¼Œç¥–å…ˆå…ƒç´ (ElementNode[]â€‹)\n  è¿”å›ç»“æœï¼š TemplateChildNode[]â€‹\né˜¶æ®µä¸€(test01 some text)   å®ç° parseText() ä¹‹åçš„ parseChildren() ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  function parseChildren( context /* ParserContext*/, mode /*TextModes*/, ancesotrs /*ElementNode[]*/ ) { // ...  const nodes /*TemplateChildNode[]*/ = []; while (!isEnd(context, mode, ancesotrs)) { // do sth  const s = context.source; let node = undefined; // ç”±äº baseparseé‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ  // é¢å»è§£æ  if (mode === TextModes.DATA || mode === TextModes.RCDATA) { // è¿‡ç•¥æ‰éæ–‡æœ¬çš„  if (!context.inVPre \u0026amp;\u0026amp; s.startsWith(context.options.delimiters[0])) { // ... æ’å€¼å¤„ç†{{}}  } else if (mode === TextModes.DATA \u0026amp;\u0026amp; s[0] === \u0026#34;\u0026lt;\u0026#34;) { // ... æ ‡ç­¾å¼€å¤´ \u0026lt;...  } // ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°  // !node ç»™ parseText è§£æ  } if (!node) { node = parseText(context, mode); } if (Array.isArray(node)) { for (let i = 0; i \u0026lt; node.length; i++) { pushNode(nodes, node[i]); } } else { pushNode(nodes, node); } console.log(context, \u0026#34;parse children\u0026#34;); } let removedWhitespace = false; return removedWhitespace ? nodes.filter(Boolean) : nodes; }     æœ€åå¤„ç†å®Œä¹‹åæ–‡æœ¬èŠ‚ç‚¹å¯¹è±¡å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  { options: { delimiters: [ \u0026#39;{{\u0026#39;, \u0026#39;}}\u0026#39; ], getNamespace: [Function: getNamespace], getTextMode: [Function: getTextMode], isVoidTag: false, isPreTag: false, isCustomElement: false, decodeEntities: [Function: decodeEntities], onError: null }, // è¿™é‡Œå‘ç”Ÿäº†å˜æ¢  // column: å®šä½åˆ°äº†å­—ç¬¦ä¸²æœ€åå³ \u0026#39;simple text\u0026#39; çš„é•¿åº¦ + 1ï¼Œå³ç»“æŸä½ç½®  // line: å› ä¸ºåªæœ‰ä¸€è¡Œï¼Œæ‰€ä»¥ line å¹¶æœªå‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœå‘ç”Ÿäº†æ”¹å˜ä¼šåœ¨ advancedBy é‡Œé¢è¿›è¡Œå¤„ç†æ›´æ–°  // offset: ç±»ä¼¼æ–‡ä»¶å¤„ç†æ—¶çš„æŒ‡é’ˆåç§»é‡ï¼Œå³å­—ç¬¦ä¸²é•¿åº¦  column: 12, line: 1, offset: 11, // ä¼šå‘ç°å¤„ç†å®Œæˆä¹‹åï¼ŒoriginalSource ç»´æŒåŸæ ·  originalSource: \u0026#39;simple text\u0026#39;, // source å˜æˆäº†ç©ºå­—ç¬¦ä¸²ï¼Œå› ä¸ºå¤„ç†å®Œäº†  source: \u0026#39;\u0026#39;, inPref: false, inVPref: false } // parse children      baseParse ä¹‹åçš„ ast ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  // è¿™ä¸ªç»“æ„çš„å½¢æˆæ˜¯ç»è¿‡ createRoot å¤„ç†ä¹‹åçš„ç»“æœ  // ç»è¿‡ parseChildren ä¹‹åçš„ç»“æœä¼šè¢«å­˜æ”¾åˆ° root çš„children ä¸­ï¼Œå¦‚ä¸‹  { type: 0, children: [ { type: 2, content: \u0026#39;\\nsimple text 1\\n simple text 2\\n\u0026#39;, loc: [Object] } ], loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 1, line: 4, offset: 30 }, source: \u0026#39;\\nsimple text 1\\n simple text 2\\n\u0026#39; }, helpers: [], components: [], directives: [], hoists: [], imports: [], cached: 0, temps: 0, codegenNode: undefined } //// ast  // ç¬¬ä¸€ä¸ª children ç»“æ„ï¼š  { type: 2, content: \u0026#39;\\nsimple text 1\\n simple text 2\\n\u0026#39;, loc: { start: { column: 1, line: 1, offset: 0 }, end: { column: 1, line: 4, offset: 30 }, source: \u0026#39;\\nsimple text 1\\n simple text 2\\n\u0026#39; } } //// ast      é˜¶æ®µä»£ç ï¼štest-01-some-text æµ‹è¯•ç”¨ä¾‹é€šè¿‡\n å›¾ç¤ºï¼šæ–‡æœ¬è§£æ\n   é˜¶æ®µäºŒ(\u0026lt;div â€¦\u0026gt;\u0026lt;/div\u0026gt;\\n\u0026lt;div â€¦\u0026gt;\u0026lt;/div\u0026gt;)   å¢åŠ ç©ºè¡ŒèŠ‚ç‚¹è¿‡æ»¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142  function parseChildren( context /* ParserContext*/, mode /*TextModes*/, ancestors /*ElementNode[]*/ ) { // ...  const parent = last(ancestors); const ns = parent ? parent.ns : Namespaces.HTML; const nodes /*TemplateChildNode[]*/ = []; let i = 0; while (!isEnd(context, mode, ancestors)) { // do sth  const s = context.source; let node = undefined; // ç”±äº baseparseé‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ  // é¢å»è§£æ  if (mode === TextModes.DATA || mode === TextModes.RCDATA) { // è¿‡ç•¥æ‰éæ–‡æœ¬çš„  if (!context.inVPre \u0026amp;\u0026amp; s.startsWith(context.options.delimiters[0])) { // ... æ’å€¼å¤„ç†{{}}  node = parseInterpolation(context, mode); } else if (mode === TextModes.DATA \u0026amp;\u0026amp; s[0] === \u0026#34;\u0026lt;\u0026#34;) { // ... æ ‡ç­¾å¼€å¤´ \u0026lt;...  if (s.length === 1) { emitError(context, ErrorCodes.EOF_BEFORE_TAG_NAME, 1); } else if (s[1] === \u0026#34;!\u0026#34;) { // TODO æ³¨é‡Šå¤„ç†ï¼Œ\u0026lt;!-- ...  if (s.startsWith(\u0026#34;\u0026lt;!--\u0026#34;)) { // æ™®é€šçš„ html æ³¨é‡Š  node = parseComment(context); } } else if (s[1] === \u0026#34;/\u0026#34;) { // \u0026lt;/...  if (s.length === 2) { emitError(context, ErrorCodes.EOF_BEFORE_TAG_NAME, 2); } else if (s[2] === \u0026#34;\u0026gt;\u0026#34;) { // \u0026lt;/\u0026gt; ä¸å¸¦æ ‡ç­¾åçš„æ— æ•ˆæ ‡ç­¾  emitError(context, ErrorCodes.MISSING_END_TAG_NAME, 2); // è¿‡æ»¤æ‰ \u0026lt;/\u0026gt; è¿™ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼Œoffset\u0026gt;\u0026gt;3 é€€å‡ºæœ¬æ¬¡å¾ªç¯ç»§ç»­è§£æ  advanceBy(context, 3); continue; } else if (/[a-z]/i.test(s[2])) { // è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???  emitError(context, ErrorCodes.X_INVALID_END_TAG); parseTag(context, TagType.End, parent); continue; } else { emitError( context, ErrorCodes.INVALID_FIRST_CHARACTER_OF_TAG_NAME, 2 ); // node = parseBogusComment(context)  } } else if (/[a-z]/i.test(s[1])) { // è§£æèµ·å§‹æ ‡ç­¾ï¼Œå³è¿™é‡Œæ‰æ˜¯æ ‡ç­¾æœ€å¼€å§‹çš„ä½ç½®ã€‚  node = parseElement(context, ancestors); } else if (s[1] === \u0026#34;?\u0026#34;) { // \u0026lt;? å¼€å§‹çš„  emitError( context, ErrorCodes.UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME, 1 ); // node = parseBogusComment(context)  } else { // å…¶ä»–æƒ…å†µéƒ½è§†ä¸ºéæ³•  emitError(context, ErrorCodes.INVALID_FIRST_CHARACTER_OF_TAG_NAME, 1); } } // ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°  // !node ç»™ parseText è§£æ  } if (!node) { node = parseText(context, mode); } if (Array.isArray(node)) { for (let i = 0; i \u0026lt; node.length; i++) { pushNode(nodes, node[i]); } } else { pushNode(nodes, node); } } console.log(nodes); let removedWhitespace = false; // TODO ç©ºæ ¼ç®¡ç†ï¼Œä¸ºäº†æ›´é«˜æ•ˆçš„è¾“å‡º  // `\\n\u0026lt;div\u0026gt;...` åˆ é™¤å¼€å¤´çš„ç©ºæ ¼å­—ç¬¦ï¼Œä¹‹å‰è§£æ v-pre ç”¨ä¾‹æ˜¯å¡åœ¨è¿™é‡Œäº†  // è¿™é‡Œå¿˜è®°å®ç°äº†ï¼Œæ‰€ä»¥ç”¨ä¾‹ http://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/#headline-3  // å¾—åˆ°äº†ä¸‰ä¸ª childï¼Œç¬¬äºŒä¸ªæ˜¯ \\nï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œæ²¡å®ç°è¿‡æ»¤  if (mode !== TextModes.RAWTEXT) { if (!context.inPre) { for (let i = 0; i \u0026lt; nodes.length; i++) { const node = nodes[i]; if (node.type === NodeTypes.TEXT) { if (!/[^\\t\\r\\n\\f ]/.test(node.content)) { const prev = nodes[i - 1]; const next = nodes[i + 1]; // 1. ç©ºæ ¼æ˜¯ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…  // 2. ç©ºæ ¼ä¸æ³¨é‡ŠèŠ‚ç‚¹ç›¸é‚»  // 3. ç©ºæ ¼åœ¨ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œå°±æˆ‘ä»¬é‡åˆ°çš„ \u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\\n\u0026lt;div\u0026gt;...  // ä¸Šé¢ä¸‰ç§æƒ…å†µçš„ç©ºæ ¼ä¼šè¢«å¿½ç•¥  if ( !prev || !next || prev.type === NodeTypes.COMMENT || next.type === NodeTypes.COMMENT || (prev.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; next.type === NodeTypes.ELEMENT \u0026amp;\u0026amp; /[\\r\\n]/.test(node.content)) ) { removedWhitespace = true; nodes[i] = null; } else { // å¦åˆ™æ›¿æ¢æˆç©ºæ ¼  node.content = \u0026#34; \u0026#34;; } } else { // æ›¿æ¢æˆç©ºæ ¼  node.content = node.content.replace(/[\\t\\r\\n\\f ]+/g, \u0026#34; \u0026#34;); } } } } else if (parent \u0026amp;\u0026amp; context.options.isPreTag(parent.tag)) { //å¦‚æœæ˜¯ \u0026lt;pre\u0026gt; åˆ æ‰ç¬¬ä¸€è¡Œçš„ç©ºè¡Œ  const first = nodes[0]; if (first \u0026amp;\u0026amp; first.type === NodeTypes.TEXT) { first.content = first.content.replace(/^\\r?\\n/, \u0026#34;\u0026#34;); } } } return removedWhitespace ? nodes.filter(Boolean) : nodes; }        parseComment(context)   æ³¨é‡Šå¤„ç†å‡½æ•°ï¼Œè§£æåŸåˆ™æ˜¯åŒ¹é… \u0026lt;!-- å¼€å¤´å’Œ --\u0026gt; ç»“å°¾ï¼Œä¸­é—´éƒ¨åˆ†ç»Ÿç»Ÿè§†ä¸ºæ³¨é‡Šï¼Œä¸­ é—´éœ€è¦è€ƒè™‘åµŒå¥—æ³¨é‡Šé—®é¢˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59  function parseComment(context) /* CommentNode */ { const start = getCursor(context) let content const match = /--(\\!)?\u0026gt;/.exec(context.source) if (!match) { // æ²¡æœ‰é—­åˆæ³¨é‡Šï¼Œåé¢çš„æ‰€æœ‰éƒ½ä¼šè¢«å½“åšæ³¨é‡Šå¤„ç†  content = context.source.slice(4) advanceBy(context, context.source.length) // åé¢æ‰€æœ‰çš„éƒ½æˆä¸ºæ³¨é‡Š  emitError(context, ErrorCodes.EOF_IN_COMMENT) } else { console.log(match) if (match.index \u0026lt;= 3) { // ç©ºæ³¨é‡Šä¹ŸæŠ¥é”™  emitError(context, ErrorCodes.ABRUPT_CLOSING_OF_EMPTY_COMMENT) } // éæ³•ç»“æŸï¼Œæ¯”å¦‚ï¼š \u0026lt;!-xx--!\u0026gt;ï¼Œæ­£åˆ™é‡Œé¢æœ‰ä¸ª (\\!)? æ•è·ç»„  // match[1] å°±æ˜¯æŒ‡è¿™ä¸ªåŒ¹é…  if (match[1]) { emitError(context, ErrorCodes.INCORRECTLY_CLOSED_COMMENT) } // å–æ³¨é‡Šå†…å®¹ï¼Œmatch.index å³ /--(\\!)?\u0026gt;/ æ­£åˆ™åŒ¹é…çš„å¼€å§‹ç´¢å¼•ä½ç½®  content = context.source.slice(4, match.index) // åµŒå¥—æ³¨é‡Š??? è¿™é‡Œslice ä¹‹åçš„ s ä¸åŒ…å«ç»“æŸ --\u0026gt;  const s = context.source.slice(0, match.index) let prevIndex = 1, nestedIndex = 0 console.log({ s }) // é¦–å…ˆèƒ½è¿›å…¥ parseCommentï¼Œè¯´æ˜ source æ˜¯ä»¥ \u0026lt;!-- å¼€å¤´çš„ï¼Œä¸”æ˜¯åŒ…å« --\u0026gt; çš„  // å¦åˆ™å‰é¢å°±ä¼šå‡ºç°å¼‚å¸¸ï¼Œå› æ­¤å¦‚æœåµŒå¥—é‚£å¯èƒ½æƒ…å†µåªæœ‰\u0026lt;!--x\u0026lt;!--y--\u0026gt;æ³¨é‡Šä¸­é—´  // å‡ºç°è¿‡ \u0026lt;!--  while ((nestedIndex = s.indexOf(\u0026#39;\u0026lt;!--\u0026#39;, prevIndex)) !== -1) { console.log({ nestedIndex, prevIndex, s, len: s.length }) advanceBy(context, nestedIndex - prevIndex + 1) // + 4 å€¼æ˜¯ `\u0026lt;!--`.lengthï¼Œå¦‚æœå°äº s.lengthï¼Œè¯´æ˜åµŒå¥—äº†æ³¨é‡Š  if (nestedIndex + 4 \u0026lt; s.length) { // éæ³•åµŒå¥—, å¦‚ï¼š\u0026lt;!--\u0026lt;!--x--\u0026gt;  emitError(context, ErrorCodes.NESTED_COMMENT) } /// ç„¶åå®šä½åˆ°åµŒå¥—çš„ç¬¬ä¸€ä¸ª \u0026lt;!-- çš„ ! ç´¢å¼•ä¸Šï¼Œè¿›å…¥ä¸‹ä¸€è½®å¤„ç†ï¼Œç›´  // åˆ°æ‰¾åˆ°æœ€åä¸€ä¸ªåˆæ³•çš„ \u0026lt;!--  prevIndex = nestedIndex + 1 } // è¿™é‡Œåº”è¯¥æ˜¯æ²¡åµŒå¥—çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ  advanceBy(context, match.index + match[0].length - prevIndex + 1) } return { type: NodeTypes.COMMENT, content, loc: getSelection(context, start) } }      parseElement(context, mode)   è¿™ä¸ªè§£æå‡½æ•°ï¼Œç”¨æ¥è§£æ \u0026lt;div\u0026gt; æ ‡ç­¾ã€‚\né˜¶æ®µä¸€(test-05)   some \\\u0026lt;span\u0026gt;{{ foo \u0026lt; bar + foo }} text\\\u0026lt;/span\u0026gt;\n æ­¤é˜¶æ®µåªå®ç°å¯¹ \u0026lt;div\u0026gt;...\u0026lt;/div\u0026gt; çš„è§£æï¼Œä¸åŒ…å«å±æ€§ç­‰ç­‰å…¶ä»–å¤æ‚æƒ…å†µï¼Œå› ä¸ºåªéœ€è¦èƒ½ é€šè¿‡ç”¨ä¾‹ 5 å°±è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  function parseElement(context, ancestors) { // assert context.source æ˜¯ä»¥ \u0026lt;[a-z] å¼€å¤´çš„  const wasInPre = context.inPre const wasInVPre = context.inVPre // å– ancestors æœ€åä¸€ä¸ªèŠ‚ç‚¹ node  const parent = last(ancestors) const element = parseTag(context, TagType.Start, parent) // pre or v-pre  const isPreBoundary = context.inPre \u0026amp;\u0026amp; !wasInVPre const isVPreBoundary = context.inVPre \u0026amp;\u0026amp; !wasInVPre // è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†  if (element.isSelfClosing || context.options.isVoidTag?.(element.tag)) { return element } // å­å…ƒç´  childrenï¼Œè¢«æ¼æ‰çš„ä»£ç ï¼Œä¼šè¿›å…¥é€’å½’è°ƒç”¨ parseChildren å»è§£æ  // \u0026lt;span\u0026gt;...\u0026lt;/span\u0026gt; æ ‡ç­¾å†…çš„æ¨¡æ¿  ancestors.push(element) const mode = context.options.getTextMode(element, parent) const children = parseChildren(context, mode, ancestors) ancestors.pop() element.children = children // P1.... è§£æä¹‹å children é‡Œé¢åº”è¯¥åŒ…å«ä¸¤ä¸ª node  // node1: æ’å€¼å†…å®¹ `foo \u0026lt; bar + foo`  // node2: æ–‡æœ¬èŠ‚ç‚¹ ` text`  console.log(element) // ç»“æŸæ ‡ç­¾ï¼Ÿ \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; è¿™ç§ç±»å‹ï¼Ÿ  // ä¸Šé¢ä¼šè§£ææ ‡ç­¾å†…çš„æ¨¡æ¿ï¼Œè§£æå®Œä¹‹å source æ­£å¸¸åº”è¯¥ä¼šæ˜¯ `\u0026lt;/span\u0026gt; ....`  // è¿›å…¥ if è§£æç»“æŸæ ‡ç­¾  if (startsWithEndTagOpen(context.source, element.tag)) { parseTag(context, TagType.End, parent) } else { // ä¼šè¿›å…¥åˆ°è¿™é‡Œå‡ºç°æŠ¥é”™  emitError(context, ErrorCodes.X_MISSING_END_TAG, 0, element.loc.start) if (context.source.length === 0 \u0026amp;\u0026amp; element.tag.toLowerCase() === \u0026#39;script\u0026#39;) { const first = children[0] if (first \u0026amp;\u0026amp; first.loc.source.startsWith(\u0026#39;\u0026lt;!--\u0026#39;)) { emitError(context, ErrorCodes.EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT) } } } element.loc = getSelection(context, element.loc.start) console.log(element, \u0026#39;after\u0026#39;) if (isPreBoundary) { context.inPre = false } if (isVPreBoundary) { context.inVPre = false } return element }     å®ç°åˆ°è¿™é‡Œæ˜¯ä¸ºäº†æƒ³çœ‹ä¸‹ç»è¿‡ parseTag ä¹‹åçš„ element æ˜¯ä»€ä¹ˆï¼ŸparseTag é‡Œé¢æœ‰ä¸ªæ­£åˆ™ æ˜¯ç”¨æ¥åŒ¹é…å¼€å§‹æˆ–ç»“æŸæ ‡ç­¾çš„ï¼Œå³ï¼š /^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i è¿™ä¸ªæ—¢å¯ä»¥åŒ¹é… å¼€å§‹æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥åŒ¹é…ç»“æŸæ ‡ç­¾ï¼Œå¹¶ä¸”è€ƒè™‘äº† \u0026lt;div \u0026gt; æœ‰ç©ºæ ¼çš„æƒ…å†µï¼Œå¿½ç•¥å¤§å°å†™ã€‚\n æ­£åˆ™åŒ¹é…æµ‹è¯•ç»“æœï¼š\n/^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i.exec(\u0026#39;\u0026lt;span\u0026gt;\u0026#39;) (2)Â [\u0026#34;\u0026lt;span\u0026#34;, \u0026#34;span\u0026#34;, index: 0, input: \u0026#34;\u0026lt;span\u0026gt;\u0026#34;, groups: undefined]   æ‰€ä»¥è¿™é‡Œé¦–å…ˆåŒ¹é…è§£æçš„æ˜¯å¼€å§‹æ ‡ç­¾ \u0026lt;div\u0026gt; ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  // some \u0026lt;span\u0026gt;{{ foo \u0026lt; bar + foo }} text\u0026lt;/span\u0026gt; // parseTag ä¹‹åçš„ element { \u0026#34;type\u0026#34;:1, // èŠ‚ç‚¹ç±»å‹æ˜¯ NodeTypes.ELEMENT \u0026#34;ns\u0026#34;:0, // å‘½åç©ºé—´å°±æ˜¯ HTML \u0026#34;tag\u0026#34;:\u0026#34;span\u0026#34;, \u0026#34;tagType\u0026#34;:0, // æ ‡ç­¾ç±»å‹ ElementTypes.ELEMENT \u0026#34;props\u0026#34;:[ // æ ‡ç­¾å±æ€§ï¼Œè¿™é‡Œæ²¡æœ‰ ], \u0026#34;isSelfClosing\u0026#34;:false, // æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œå¦‚ï¼š\u0026lt;img/\u0026gt; \u0026#34;children\u0026#34;:[], \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:6, // column ä¸æ¢è¡Œçš„æƒ…å†µä¸‹ä¸º offset + 1ï¼Œä» 1 å¼€å§‹è®¡æ•° \u0026#34;line\u0026#34;:1, // æ²¡æ¢è¡Œç¬¦ \u0026#34;offset\u0026#34;:5 // \u0026lt;span\u0026gt; çš„ \u0026lt; å¼€å§‹ä½ç½®ç´¢å¼• `some `.length = 5 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:12, \u0026#34;line\u0026#34;:1, // è¿™é‡Œå€¼çš„å˜åŒ–åˆ†ä¸¤æ­¥ // parseTag:start çš„æ—¶å€™ // 1. è§£æå‡º \u0026lt;span ï¼Œè¿™ä¸ªæ—¶å€™ offset å…¶å®æ˜¯ 10 // 2. æ£€æµ‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œå†³å®š advancedBy // ç§»åŠ¨æŒ‡é’ˆä½ç½®æ•°(è‡ªé—­åˆï¼š2ï¼Œéè‡ªé—­åˆï¼š1)ï¼Œåˆ°è¿™é‡Œ offset = 11 \u0026#34;offset\u0026#34;:11 }, \u0026#34;source\u0026#34;:\u0026#34;\u0026lt;span\u0026gt;\u0026#34; // ä¸ºä»€ä¹ˆä¸æ˜¯ `\u0026lt;span\u0026gt;` ??? æ¼äº†è‡ªé—­åˆæ ‡ç­¾æ£€æµ‹æŒ‡é’ˆç§»ä½ } }     è§£æä¹‹å context å†…å®¹å˜åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  { \u0026#34;options\u0026#34;:{ // å¿½ç•¥é€‰é¡¹ï¼Œç›®å‰å¯¹æˆ‘ä»¬æ²¡å•¥ç”¨ }, \u0026#34;column\u0026#34;:12, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:11, // \u0026lt;span\u0026gt; åé¢çš„ \u0026gt; ç´¢å¼• \u0026#34;originalSource\u0026#34;:\u0026#34;some \u0026lt;span\u0026gt;{{ foo \u0026lt; bar + foo }} text\u0026lt;/span\u0026gt;\u0026#34;, // è§£æä¹‹åçš„æ¨¡æ¿ï¼Œä¸ºä½• \u0026gt; æ²¡è¢«å»æ‰???ï¼Œè§ é—®é¢˜1 \u0026#34;source\u0026#34;:\u0026#34;{{ foo \u0026lt; bar + foo }} text\u0026lt;/span\u0026gt;\u0026#34;, \u0026#34;inPref\u0026#34;:false, \u0026#34;inVPref\u0026#34;:false }     åˆ°æ­¤æˆ‘ä»¬å·²ç»è§£æé™¤äº† \u0026lt;span\u0026gt; å¼€å§‹æ ‡ç­¾ï¼Œè¿™ä¸ªæ—¶å€™çš„ =node.childrens = []=ï¼Œä¸‹ä¸€æ­¥ è§£ææ ‡ç­¾é‡Œé¢çš„å†…å®¹ã€‚\n åœ¨å®ç°å®Œæ•´çš„ parseElement ä¹‹åå‘ç°æ‰§è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ªç”¨ä¾‹å¹¶ä¸æ˜¯ \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; æ ‡ç­¾å†…æ²¡ä¸œè¥¿ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ else è§¦å‘ emitError() ï¼Œé‚£ä¸æ˜¯æ²¡æ³•å¾€ä¸‹èµ°äº†ï¼Ÿï¼Ÿï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // å­å…ƒç´  childrenï¼Œè¢«æ¼æ‰çš„ä»£ç ï¼Œä¼šè¿›å…¥é€’å½’è°ƒç”¨ parseChildren å»è§£æ  // \u0026lt;span\u0026gt;...\u0026lt;/span\u0026gt; æ ‡ç­¾å†…çš„æ¨¡æ¿  ancestors.push(element) const mode = context.options.getTextMode(element, parent) const children = parseChildren(context, mode, ancestors) ancestors.pop() element.children = children // ...........â˜ğŸ».â˜ğŸ».â˜ğŸ».â˜ğŸ».â˜ğŸ»ï¼ŒåŠ å›å»  if (startsWithEndTagOpen(context.source, element.tag)) { parseTag(context, TagType.End, parent) } else { emitError(context, ErrorCodes.X_MISSING_END_TAG, 0, element.loc.start) if (context.source.length === 0 \u0026amp;\u0026amp; element.tag.toLowerCase() === \u0026#39;script\u0026#39;) { const first = children[0] if (first \u0026amp;\u0026amp; first.loc.source.startsWith(\u0026#39;\u0026lt;!--\u0026#39;)) { emitError(context, ErrorCodes.EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT) } } }     é‚£æ˜¯å› ä¸ºå‰é¢æ¼äº†ä¸€æ®µä»£ç ã€‚\n ä»£ç åŠ ä¸Šä¹‹åæœ€åä»£ç  P1 å‡ºçš„è¾“å‡º ancestors é‡Œé¢ä¼šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹(element)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62  // ancestors[{...}]ï¼Œancestors ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ \u0026lt;span\u0026gt; è¿™ä¸ªèŠ‚ç‚¹ // é‡ç‚¹æˆ‘ä»¬è¦çœ‹çš„æ˜¯è¿™ä¸ªèŠ‚ç‚¹çš„ children å› ä¸ºå…¶å†…éƒ¨æœ‰ `{{ foo \u0026lt; bar + foo }} text` // æ‰€ä»¥å®ƒ çš„ element åº”è¯¥æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼š`foo \u0026lt; bar + foo` å’Œ ` text` { // \u0026lt;span\u0026gt; èŠ‚ç‚¹æœ¬èº«çš„å±æ€§ï¼Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯ children \u0026#34;children\u0026#34;:[ { // ç¬¬ä¸€ä¸ª child æ˜¯ {{ ... }} æ£€æµ‹åˆ°æ’å€¼è¿›å…¥ parseInterpolation åˆ†æ”¯ // å¤„ç†ï¼Œå¾—åˆ°ä¸‹é¢çš„èŠ‚ç‚¹ç»“æ„ï¼Œæ’å€¼è§£æåœ¨ parseInterpolation ä¸€ç« æœ‰åˆ†æè¿‡äº† \u0026#34;type\u0026#34;:5, \u0026#34;content\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;foo \u0026lt; bar + foo\u0026#34;, \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:15, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:14 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:30, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:29 }, \u0026#34;source\u0026#34;:\u0026#34;foo \u0026lt; bar + foo\u0026#34; } }, \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:12, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:11 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:33, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:32 }, \u0026#34;source\u0026#34;:\u0026#34;{{ foo \u0026lt; bar + foo }}\u0026#34; } }, { \u0026#34;type\u0026#34;:2, \u0026#34;content\u0026#34;:\u0026#34; text\u0026#34;, \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:33, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:32 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:38, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:37 }, \u0026#34;source\u0026#34;:\u0026#34; text\u0026#34; } } ], // \u0026lt;span\u0026gt; æœ¬èº«èŠ‚ç‚¹çš„ loc }     è¿™é‡Œä¹Ÿæ²¡ä»€ä¹ˆå¥½è§£é‡Šçš„ï¼Œæ’å€¼åœ¨ parseInterpolation å¤„åˆ†æè¿‡äº†ï¼Œæ–‡æœ¬è§£æåœ¨ parseText å¤„åˆ†æäº†ã€‚\n    parseInterpolation(context, mode)   å‡½æ•°å£°æ˜ï¼š\n1 2 3 4  function parseInterpolation( context: ParserContext, mode: TextModes ): InterpolationNode | undefined {}     context: å°†è¢«è§£æçš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è¿™é‡Œçš„ source åº”è¯¥æ˜¯ä»¥å·®å€¼ ({{)å¼€å§‹çš„å­—ç¬¦ä¸²ã€‚\n mode: æ–‡æœ¬æ¨¡å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  function parseInterpolation(context, mode) { // æ‰¾å‡ºæ’å€¼æ¨¡æ¿çš„å¼€å§‹å’Œç»“æŸç¬¦å·ï¼Œé»˜è®¤æ˜¯ {{ å’Œ }}  const [open, close] = context.options.delimiters; const closeIndex = context.source.indexOf(close, open.length); if (closeIndex === -1) { emitError(context, ErrorCodes.X_MISSING_INTERPOLATION_END); return undefined; } const start = getCursor(context); advanceBy(context, open.length); // ä¸‹é¢æ˜¯ä» {{ ä¹‹åçš„å­—ç¬¦ä¸²å¼€å§‹è§£æ  const innerStart = getCursor(context), innerEnd = getCursor(context), // æ’å€¼é‡Œé¢çš„å­—ç¬¦ä¸²é•¿åº¦  rawContentLength = closeIndex - open.length, // æ’å€¼é‡Œé¢çš„å­—ç¬¦ä¸²å†…å®¹  rawContent = context.source.slice(0, rawContentLength), preTrimContent = parseTextData(context, rawContentLength, mode), content = preTrimContent.trim(), startOffset = preTrimContent.indexOf(content); if (startOffset \u0026gt; 0) { advancePositionWithMutation(innerStart, rawContent, startOffset); } // {{ foo + bar }} -\u0026gt;  // res = (\u0026#39; foo + bar \u0026#39;.length - \u0026#39;foo + bar\u0026#39;.length - \u0026#39; \u0026#39;.length)  // æ’å€¼é‡Œé¢å­—ç¬¦ä¸²çš„é•¿åº¦ - å»æ‰ç©ºæ ¼åçš„é•¿åº¦ - èµ·å§‹ç©ºæ ¼çš„é•¿åº¦ï¼Œå¾—åˆ°çš„  // å°±æ˜¯ç»“æŸä½ç½®çš„ offset  const endOffset = rawContentLength - (preTrimContent.length - content.length - startOffset); advancePositionWithMutation(innerEnd, rawContent, endOffset); // å®šä½åˆ° }} ä½ç½®  advanceBy(context, close.length); console.log(innerEnd, innerStart, \u0026#34;1\u0026#34;); return { type: NodeTypes.INTERPOLATION, content: { type: NodeTypes.SIMPLE_EXPRESSION, isStatic: false, isConstant: false, content, loc: getSelection(context, innerStart, innerEnd), }, loc: getSelection(context, start), }; }      å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°åœ¨ç»è¿‡è§£æä¹‹å innerStart å’Œ innerEnd éƒ½æ•°æ®éƒ½æ­£ç¡®å®šä½åˆ°äº†ç›¸åº”ä½ç½®ï¼Œ innerStart æ˜¯è§£æåæ’å€¼å­—ç¬¦ä¸²çš„å¼€å§‹ä½ç½®(ç¬¬ä¸€ä¸ª { offset = 8(or=\u0026#39;red\u0026#39;\u0026gt;ï¿½ï¿½åº¦\u0026lt;/font\u0026gt;))ï¼ŒinnerEnd æ˜¯è§£æåæ’å€¼å­—ç¬¦ä¸²çš„ç»“æŸä½ç½® (æœ€åä¸€ä¸ª } offset = 17(\u0026lt;font color=\u0026#34;purple\u0026#34;\u0026gt;\u0026#39;some {{ foo + bar \u0026#39;çš„é•¿ åº¦))ã€‚\n  è§£æä¹‹åå¾—åˆ°çš„ ast.children å°†ä¼šæœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼š\n1 2 3 4 5 6  (3) [{â€¦}, {â€¦}, {â€¦}] 0: {type: 2, content: \u0026#34;some \u0026#34;, loc: {â€¦}} // å·¦ä¾§æ–‡æœ¬ 1: {type: 5, content: {â€¦}, loc: {â€¦}} // æ’å€¼éƒ¨åˆ† 2: {type: 2, content: \u0026#34; text\u0026#34;, loc: {â€¦}} // å³ä¾§æ–‡æœ¬ length: 3 __proto__: Array(0)     è§£æå›é¡¾(åˆ†åˆ«è§£æå‡ºäº†ä¸‰ä¸ªèŠ‚ç‚¹å¯¹è±¡)ï¼š\n  0: {type: 2, content: \u0026#34;some \u0026#34;, loc: {â€¦}}\nè¯¦ç»†ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9  0: content: \u0026#34;some \u0026#34; // è§£æå‡ºçš„æ–‡æœ¬å†…å®¹ loc: // ä½ç½®ä¿¡æ¯ end: {column: 6, line: 1, offset: 5} // è¯¥èŠ‚ç‚¹åœ¨æ¨¡æ¿ä¸­çš„ä½ç½®ä¿¡æ¯ source: \u0026#34;some \u0026#34; // æ–‡æœ¬æºå†…å®¹ start: {column: 1, line: 1, offset: 0} // è¯¥èŠ‚ç‚¹åœ¨æ¨¡æ¿ä¸­çš„ç»“æŸä¿¡æ¯ __proto__: Object type: 2 // èŠ‚ç‚¹ç±»å‹ __proto__: Object     é‚£ä¹ˆæ˜¯å¦‚ä½•å¾—åˆ°ä¸Šé¢çš„ç»“æœçš„å‘¢ï¼Ÿï¼Ÿï¼Ÿé‚£å¾—ä» parseChildren è¯´èµ·äº†ï¼Œæ¨¡æ¿ï¼š\n  â€”\u0026gt;\u0026gt; \u0026#34;some {{ foo + bar }} text\u0026#34; \n (!context.inVPre \u0026amp;\u0026amp; s.startsWith(context.options.delimiters[0])) æ£€æµ‹å¤±è´¥\n mode === TextModes.DATA \u0026amp;\u0026amp; s[0] === \u0026#34;\u0026lt;\u0026#34; æ£€æµ‹å¤±è´¥\n å³ä¸€å¼€å§‹å¹¶ä¸ä¼šè¿›å…¥æ’å€¼å’Œæ ‡ç­¾è§£æä»£ç ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥ parseText(context, mode) ä¸­è§£ææ–‡æœ¬ï¼Œè§£ææ—¶å€™ç›´åˆ°é‡åˆ° {{ ä¹‹å‰éƒ½ä¸€ç›´ä¼šå½“åšæ–‡æœ¬è§£æï¼Œè€Œä¹‹å‰çš„æ–‡æœ¬ä¸­åˆ ä¸åŒ…å« decodeMap ä¸­çš„å­—ç¬¦ï¼Œå› æ­¤çŸ¥é“é‡åˆ° { ä¹‹å‰ä¼šä¸€ç›´æ‰§è¡Œ while é‡Œé¢çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11  if (!node) { node = parseText(context, mode); } if (Array.isArray(node)) { for (let i = 0; i \u0026lt; node.length; i++) { pushNode(nodes, node[i]); } } else { pushNode(nodes, node); }     è¿™æ®µä»£ç ï¼Œè€Œç”±äº \u0026#34;some \u0026#34; éƒ½æ˜¯æ™®é€šå­—ç¬¦ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²ä¼šå¯¹åº”ä¸€ä¸ª node ï¼Œç„¶ååˆéƒ½æ˜¯ æ™®é€šæ–‡æœ¬èŠ‚ç‚¹ï¼Œä¼šç»è¿‡ pushNode(nodes, node[i]) å¤„ç†æ‰ï¼Œè¿›è¡Œåˆå¹¶æœ€åæˆä¸ºä¸Šé¢çš„ ä¸€ä¸ªå®Œæ•´çš„ \u0026#34;some \u0026#34; å¯¹åº”æ–‡æœ¬èŠ‚ç‚¹ç»“æ„ã€‚\n  1: {type: 5, content: {â€¦}, loc: {â€¦}}\nèŠ‚ç‚¹ç»“æ„ï¼š\n1: content: // è¿™é‡Œçš„æ•°æ®æ˜¯ç»è¿‡æ’å€¼è§£æä¹‹åçš„æ¨¡æ¿å¯¹è±¡ content: \u0026#34;foo + bar\u0026#34; // trim ä¹‹åçš„æ’å€¼å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰ }} ??? isConstant: false // éå¸¸é‡ç±»å‹ isStatic: false // éé™æ€èŠ‚ç‚¹ loc: // è§£æä¹‹åçš„è¯¥èŠ‚ç‚¹åœ¨æ•´ä¸ªæ¨¡æ¿ä¸­çš„ä½ç½®ä¿¡æ¯ // 17 -\u0026gt; r æ‰€åœ¨çš„ä½ç½® end: {column: 18, line: 1, offset: 17} source: \u0026#34;foo + bar\u0026#34; // 8 -\u0026gt; f æ‰€åœ¨çš„ä½ç½®ï¼Œå³ start -\u0026gt; end =\u0026gt; \u0026#39;f \u0026lt;-\u0026gt; r\u0026#39; start: {column: 9, line: 1, offset: 8} __proto__: Object type: 4 // æ’å€¼è¡¨è¾¾å¼ç±»å‹ __proto__: Object loc: // è¿™é‡Œæ˜¯æ²¡ç»è¿‡å»å°¾éƒ¨ç©ºæ ¼çš„ä½ç½®ä¿¡æ¯ // 20 -\u0026gt; \u0026#39;some {{ foo + bar \u0026#39; æœ€åä¸€ä¸ªç©ºæ ¼ä½ç½® end: {column: 21, line: 1, offset: 20} source: \u0026#34;{{ foo + bar }}\u0026#34; // 5 -\u0026gt; \u0026#39;some \u0026#39; ç¬¬ä¸€ä¸ª { ä½ç½® start: {column: 6, line: 1, offset: 5} __proto__: Object type: 5 // æ’å€¼ç±»å‹ __proto__: Object   å¦‚ä¸Šæ‰€æ³¨é‡Šçš„ï¼Œç¬¬ä¸€çº§çš„ loc æ˜¯é€šè¿‡è§£æ \u0026#34;{{ foo + bar}}\u0026#34; åœ¨æ•´ä¸ªæ¨¡æ¿ä¸­çš„ä½ç½® ä¿¡æ¯ï¼Œcontent é‡Œé¢åŒ…å«çš„æ˜¯æ’å€¼å†…éƒ¨çš„ä¿¡æ¯ï¼Œå³çœŸæ­£çš„è¡¨è¾¾å¼ç»“æ„ä¿¡æ¯ã€‚\n  {type: 2, content: \u0026#34; text\u0026#34;, loc: {â€¦}}\n å’Œç¬¬ä¸€æ­¥ä¸­ä¸€æ ·ï¼Œåªä¼šç»è¿‡ parseText(context, mode) è§£æå‡ºçº¯æ–‡æœ¬å†…å®¹ï¼š\u0026#34; text\u0026#34;ï¼Œæœ€åçš„ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10  { type: 2, content: \u0026#34; text\u0026#34;, loc: { // ä» text å‰é¢çš„ç©ºæ ¼å¼€å§‹è®°å½•ï¼Œ\u0026#34;some {{ foo + bar }}\u0026#34; é•¿åº¦ä¸º 20 start: { column: 21, line: 1, offset: 20 }, source: \u0026#34; text\u0026#34;, end: { column: 26, line: 1, offset: 25} } }      ä¸‰æ­¥åˆ†æå®Œä¹‹åï¼Œåˆ°ç°åœ¨æˆ‘ä»¬åº”è¯¥å…·å¤‡è„±ç¦»ä»£ç å°±å¯ä»¥ç›´æ¥æ ¹æ®æ¨¡æ¿å¾—åˆ°è§£æåå¯¹åº”çš„ children ç»“æ„ã€‚åˆ†æçš„é‡ç‚¹æ˜¯è¦å¾—åˆ°ä¸€ä¸ª { type, content, loc: { start, source, end }} ç»“æ„çš„å¯¹è±¡ã€‚\n1 2 3 4 5 6  // start/end: { column/*è¯¥èŠ‚ç‚¹èµ·å§‹ç»“æŸçš„åˆ—ï¼Œä» 1 å¼€å§‹è®¡æ•°çš„å€¼*/, line/*è¯¥èŠ‚ç‚¹æ¨¡æ¿æ‰€åœ¨çš„è¡Œï¼Œä» 1 å¼€å§‹è®¡æ•°çš„å€¼*/, offset/*è¯¥èŠ‚ç‚¹èµ·å§‹ç»“æŸçš„ç´¢å¼•ï¼Œä» 0 å¼€å§‹è®¡æ•°çš„å€¼*/ }    PS: å¯¹äº foo å’Œ bar å˜é‡æ•°æ®è§£ææ‰§è¡Œç»“æœè¿™å—æš‚æ—¶ä¸è®¨è®ºï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•åšåˆ°çš„ï¼Œç°é˜¶æ®µåªå…³å¿ƒæ¨¡æ¿çš„è§£æã€‚   parseTag(context, type, parent)  é˜¶æ®µä¸€(simple text\u0026lt;\\/div\u0026gt;)    ä¸ºä»€ä¹ˆåªåŒ¹é… \u0026lt;/div è€Œå¿½ç•¥æ‰æœ€åä¸€ä¸ª \u0026gt;??? å‚æ•°:\n1 2 3 4 5  function parseTag( context: ParserContext, // è¦ç»§ç»­è§£æçš„æ¨¡æ¿å¯¹è±¡ simple text\u0026lt;/div\u0026gt; é‡Œé¢çš„ \u0026lt;/div\u0026gt;  type: TagType, // Start(\u0026lt;div\u0026gt;), End(\u0026lt;/div\u0026gt;)å¼€å§‹ç»“æŸæ ‡ç­¾  parent: ElementNode | undefined // è¯¥æ ‡ç­¾çš„çˆ¶çº§  ): ElementNode     å…·ä½“å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function parseTag(context, type, parent) { // è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ simple text çš„é•¿åº¦  const start = getCursor(context); // åŒ¹é… \u0026lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ \u0026gt; ç»™å¿½ç•¥æ‰???  const match = /^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i.exec(context.source); const tag = match[1]; const ns = context.options.getNamespace(tag, parent); // æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° \u0026lt;/div\u0026gt; çš„æœ€æœ‰ä¸€ä¸ª \u0026gt; ä¸Š  advanceBy(context, match[0].length); // è¿‡æ»¤æ‰ç©ºæ ¼  advanceSpaces(context); const cursor = getCursor(context); const currSource = context.source; }        é˜¶æ®µäºŒ(test-text-05)   æ»¡è¶³ç”¨ä¾‹ 5(some \u0026lt;span\u0026gt;{{ foo \u0026lt; bar + foo }} text\u0026lt;/span\u0026gt;) çš„ä»£ç å®ç°ï¼Œè¿™é‡Œåªéœ€ è¦èƒ½è§£æ \u0026lt;span\u0026gt; ... \u0026lt;/span\u0026gt; æ ‡ç­¾å°±å¯ä»¥ï¼Œæ²¡æœ‰ pre, v-pre, \u0026lt;span/\u0026gt;è‡ªé—­åˆæ ‡ ç­¾ ï¼Œå› æ­¤ä¸‹é¢çœç•¥è¿™å‡ éƒ¨åˆ†æ£€æµ‹ä»£ç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61  function parseTag(context, type, parent) { // è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦  const start = getCursor(context) // åŒ¹é… \u0026lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ \u0026gt; ç»™å¿½ç•¥æ‰???  const match = /^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i.exec(context.source) const tag = match[1] const ns = context.options.getNamespace(tag, parent) // log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° \u0026lt;/div\u0026gt; çš„æœ€æœ‰ä¸€ä¸ª \u0026gt; ä¸Š  // åœ¨è¿™é‡Œ context.offset = 10, context.line = 1  advanceBy(context, match[0].length) // è¿‡æ»¤æ‰ç©ºæ ¼  advanceSpaces(context) // log2: ç»è¿‡ advanceä¹‹å context.offset = 15, context.line = 1  // æ­£å¥½è¿‡æ»¤ \u0026lt;/div 5ä¸ªå­—ç¬¦  const cursor = getCursor(context) const currSource = context.source // TODO-1 è§£ææ ‡ç­¾å…ƒç´ çš„å±æ€§  // TODO-2 in pre ...  // TODO-3 v-pre æŒ‡ä»¤  // TODO-3 \u0026lt;div/\u0026gt; è‡ªé—­æ ‡ç­¾  // è¿™é‡Œè¦å®ç°ï¼Œä¸ç„¶æœ€åè§£æå®Œæˆä¹‹å source ä¼šæ˜¯ï¼š\u0026gt;...\u0026lt;/span\u0026gt;  // éœ€è¦æ£€æµ‹ä¸‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾æ¥ç§»åŠ¨æŒ‡é’ˆä½ç½®  let isSelfClosing = false if (context.source.length === 0) { emitError(context, ErrorCodes.EOF_IN_TAG) } else { // some \u0026lt;div\u0026gt; ... \u0026lt;/div\u0026gt; åˆ°è¿™é‡Œçš„ source = \u0026gt; ... \u0026lt;/div\u0026gt;  // æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /\u0026gt; å¼€å¤´çš„  isSelfClosing = context.source.startsWith(\u0026#39;/\u0026gt;\u0026#39;) if (type === TagType.End \u0026amp;\u0026amp; isSelfClosing) { emitError(context, ErrorCodes.END_TAG_WITH_TRAILING_SOLIDUS) } // å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/\u0026gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(\u0026gt;)  // åˆ°è¿™é‡Œ source = ... \u0026lt;/div\u0026gt;  advanceBy(context, isSelfClosing ? 2 : 1) } let tagType = ElementTypes.ELEMENT const options = context.options // ä¸æ˜¯ v-preï¼Œä¸”ä¸æ˜¯è‡ªå®šä¹‰ç»„ä»¶ï¼Œè¿™ä¸ª if ç›®çš„æ˜¯ä¸ºäº†æ£€æµ‹å¹¶æ”¹å˜  // tagType æ ‡ç­¾ç±»å‹  if (!context.inVPre \u0026amp;\u0026amp; !options.isCustomElement(tag)) { // TODO-4 æ£€æµ‹ tagType  } return { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing: false, // TODO  children: [], loc: getSelection(context, start), codegenNode: undefined } }     è¦èƒ½é€šè¿‡ç”¨ä¾‹5å¿…é¡»æ­é… parseElement(context, ancestors) æ‰è¡Œï¼Œå¹¶ä¸”é‡ç‚¹åœ¨ parseElement ä¸­ï¼Œå› ä¸ºæœ‰äº†å¼€å§‹æ ‡ç­¾æ‰ä¼šæœ‰ç»“æŸæ ‡ç­¾çš„è§£æï¼Œä¸ç„¶ä¼šè§¦å‘ç»“æŸæ ‡ç­¾è§£æåˆ† æ”¯é‡Œé¢çš„ error:\n1 2 3 4 5 6  else if (/[a-z]/i.test(s[2])) { // è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???  emitError(context, ErrorCodes.X_INVALID_END_TAG) parseTag(context, TagType.End, parent) continue }     å› æ­¤å¦‚æœè¿™é‡Œä¸ä¼šè§¦å‘ X_INVALID_END_TAG é‚£å¿…å®šæ˜¯ parseElement é‡Œé¢åšäº†ä»€ä¹ˆå¤„ç†ï¼Œ è¿™ä¸ªå®ç°äº† parseElement æ‰å¾—ä»¥çŸ¥æ™“(ç›®å‰åªæ˜¯çŒœæµ‹~~~)ï¼Œä¼ é€é—¨ğŸšª\u0026gt;\u0026gt;\u0026gt;\n  é˜¶æ®µä¸‰(test-element-03)   æ”¯æŒè‡ªé—­æ ‡ç­¾è§£æï¼Œå®ç°äº†é˜¶æ®µäºŒä¹‹åï¼Œè¿™é‡Œå…¶å®å¾ˆç®€å•ï¼Œåœ¨ä¸Šä¸€é˜¶æ®µä¸­çš„å®ç°åœ¨ parseTag ä¸­è¿”å›çš„æ—¶å€™ isSelfClosing å†™æ­»æˆäº† false ï¼Œè¦æ”¯æŒè¿™ä¸ªç”¨ä¾‹ï¼Œåªè¦å°† å®ƒçš„å€¼èµ‹å€¼ä¸ºå®é™…çš„ isSelfClosing å°±å¯ä»¥äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  parseTag() { // ...  let isSelfClosing = false if (context.source.length === 0) { emitError(context, ErrorCodes.EOF_IN_TAG) } else { // some \u0026lt;div\u0026gt; ... \u0026lt;/div\u0026gt; åˆ°è¿™é‡Œçš„ source = \u0026gt; ... \u0026lt;/div\u0026gt;  // æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /\u0026gt; å¼€å¤´çš„  isSelfClosing = context.source.startsWith(\u0026#39;/\u0026gt;\u0026#39;) if (type === TagType.End \u0026amp;\u0026amp; isSelfClosing) { emitError(context, ErrorCodes.END_TAG_WITH_TRAILING_SOLIDUS) } // å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/\u0026gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(\u0026gt;)  // åˆ°è¿™é‡Œ source = ... \u0026lt;/div\u0026gt;  advanceBy(context, isSelfClosing ? 2 : 1) } // ...  }      é˜¶æ®µå››(æ”¯æŒ template + v-if)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81  function parseTag(context, type, parent) { // è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦  const start = getCursor(context) // åŒ¹é… \u0026lt;div æˆ– \u0026lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ \u0026gt; ç»™å¿½ç•¥æ‰???  // å…¶å®ä¸æ˜¯å¿½ç•¥æ‰ \u0026gt; è€Œæ˜¯å› ä¸ºå¦‚æœæ˜¯ \u0026lt;div å¼€å¤´ï¼Œé‚£ä¹ˆåé¢æœ‰å¯èƒ½æ˜¯ \u0026lt; æˆ–  // /\u0026gt; åé¢éœ€è¦å¤„ç†é—­åˆå’Œéé—­åˆé—®é¢˜  const match = /^\u0026lt;\\/?([a-z][^\\t\\r\\n\\f /\u0026gt;]*)/i.exec(context.source) const tag = match[1] const ns = context.options.getNamespace(tag, parent) // log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° \u0026lt;/div\u0026gt; çš„æœ€æœ‰ä¸€ä¸ª \u0026gt; ä¸Š  // åœ¨è¿™é‡Œ context.offset = 10, context.line = 1  advanceBy(context, match[0].length) // è¿‡æ»¤æ‰ç©ºæ ¼  advanceSpaces(context) // log2: ç»è¿‡ advance ä¹‹å context.offset = 15, context.line = 1  // æ­£å¥½è¿‡æ»¤ \u0026lt;/div 5 ä¸ªå­—ç¬¦  const cursor = getCursor(context) const currSource = context.source // è§£ææ ‡ç­¾å…ƒç´ çš„å±æ€§  let props = parseAttributes(context, type) // TODO-2 in pre ...  // TODO-3 v-pre æŒ‡ä»¤  // ....  let tagType = ElementTypes.ELEMENT const options = context.options // ä¸æ˜¯ v-preï¼Œä¸”ä¸æ˜¯è‡ªå®šä¹‰ç»„ä»¶ï¼Œè¿™ä¸ª if ç›®çš„æ˜¯ä¸ºäº†æ£€æµ‹å¹¶æ”¹å˜  // tagType æ ‡ç­¾ç±»å‹  // TODO-4 æ£€æµ‹ tagType  if (!context.inVPre \u0026amp;\u0026amp; !options.isCustomElement(tag)) { // æ˜¯å¦æœ‰ is æŒ‡ä»¤ï¼Ÿ  const hasVIs = props.some( (p) =\u0026gt; p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; p.name === \u0026#39;is\u0026#39; ) if (options.isNativeTag \u0026amp;\u0026amp; !hasVIs) { // æ²¡æœ‰ is æŒ‡ä»¤ï¼Œä¸”ä¸æ˜¯åŸç”Ÿæ ‡ç­¾ï¼Œé‚£å°±æ˜¯è‡ªå®šä¹‰çš„ç»„ä»¶äº†  if (!options.isNativeTag(tag)) tagType = ElementTypes.COMPONENT } else if ( hasVIs || isCoreComponent(tag) || options.isBuiltInComponent?.(tag) || /^[A-Z]/.test(tag) || tag === \u0026#39;component\u0026#39; ) { // æœ‰ is æŒ‡ä»¤ || vue æ ¸å¿ƒç»„ä»¶(keep-alive...) || å†…ç½®ç»„ä»¶  // || æ ‡ç­¾åå¤§å†™å¼€å¤´  tagType === ElementTypes.COMPONENT } if (tag === \u0026#39;slot\u0026#39;) { tagType === ElementTypes.SLOT } else if ( tag === \u0026#39;template\u0026#39; \u0026amp;\u0026amp; props.some( (p) =\u0026gt; p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; isSpecialTemplateDirective(p.name) ) ) { // æ˜¯æ¨¡æ¿çš„å‰ææ˜¯æœ‰æŒ‡ä»¤ï¼Œå¹¶ä¸”æ˜¯ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤  tagType = ElementTypes.TEMPLATE } } const val = { type: NodeTypes.ELEMENT, ns, tag, tagType, props: [], // TODO  isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined } return val }     è¿™é‡Œçš„å®ç°æ¶‰åŠåˆ°å‡ ä¸ªæ–°çš„å‡½æ•°ï¼š\n  options.isCustomElement(tag) é»˜è®¤åœ¨ options é‡Œé¢æ˜¯ NO\n  options.isNativeTag(tag) ä½œä¸ºå¯é€‰ OptionalOptions é€‰é¡¹ç±»å‹ï¼Œå¹¶æ²¡é»˜è®¤å€¼\n  isCoreComponent(tag) vue å†…éƒ¨ä½œä¸ºæ ¸å¿ƒç»„ä»¶çš„æ ‡ç­¾\n1 2 3 4 5 6  { // ä¸»è¦å°±è¿™å››ä¸ª Teleport: TELEPORT, Suspense: SUSPENSE, KeepAlive: KEEP_ALIVE, BaseTransition: BASE_TRANSITION }      options.isBuiltInComponent?.(tag) å’Œ isNativeTag ä¸€æ ·ä½œä¸ºå¯é€‰é€‰é¡¹ï¼Œæ— é»˜è®¤å€¼\n  isSpecialTemplateDirective(p.name) ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤\n1 2 3  const isSpecialTemplateDirective = /*#__PURE__*/ makeMap( `if,else,else-if,for,slot` )     ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè¦è¢«å®šä¹‰ä¸ºæ˜¯ \u0026lt;template\u0026gt; ç±»å‹å¿…é¡»åŒ…å« if,else,else-if,for,slot è¿™å…¶ä¸­çš„ä»»ä¸€ä¸ªæŒ‡ä»¤å±æ€§ï¼Œåˆ¤æ–­æ¡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  if ( tag === \u0026#39;template\u0026#39; \u0026amp;\u0026amp; props.some( (p) =\u0026gt; // isSpecialTemplateDirective æ˜¯ä½¿ç”¨ makeMap åˆ›å»ºçš„å‡½æ•°  // å³ key =\u0026gt; true/false çš„ä¸€äº›å‡½æ•°  p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; isSpecialTemplateDirective(p.name) ) ) { // æ˜¯æ¨¡æ¿çš„å‰ææ˜¯æœ‰æŒ‡ä»¤ï¼Œå¹¶ä¸”æ˜¯ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤(if, else, else-if, slot, for)  tagType = ElementTypes.TEMPLATE }        é˜¶æ®µäº”(\u0026lt;div â€¦\u0026gt;\u0026lt;/div\u0026gt;\\n\u0026lt;div â€¦\u0026gt;\u0026lt;/div\u0026gt;)     parseText(context, mode)   è§£ææ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°(\u0026lt;, {{, ]]\u0026gt;)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  function parseText(context: ParserContext, mode: TextModes): TextNode { __TEST__ \u0026amp;\u0026amp; assert(context.source.length \u0026gt; 0) const endTokens = [\u0026#39;\u0026lt;\u0026#39;, context.options.delimiters[0]] if (mode === TextModes.CDATA) { endTokens.push(\u0026#39;]]\u0026gt;\u0026#39;) } let endIndex = context.source.length for (let i = 0; i \u0026lt; endTokens.length; i++) { const index = context.source.indexOf(endTokens[i], 1) if (index !== -1 \u0026amp;\u0026amp; endIndex \u0026gt; index) { endIndex = index } } __TEST__ \u0026amp;\u0026amp; assert(endIndex \u0026gt; 0) const start = getCursor(context) // æ–‡æœ¬å†…å®¹å¯èƒ½åŒ…å« \u0026amp;gt; \u0026amp;lt; \u0026amp;amp; \u0026amp;apos; \u0026amp;quot; ç­‰htmlç¬¦å·ï¼Œéœ€è¦  // å°†ä»–ä»¬æ›¿æ¢æˆå¯¹åº” \u0026gt; \u0026lt; \u0026amp; \u0026#39; \u0026#34;  const content = parseTextData(context, endIndex, mode) return { type: NodeTypes.TEXT, content, loc: getSelection(context, start) } }     å¯¼å›¾ï¼š\n   parseTextData(context, length, mode)   æ–‡æœ¬èŠ‚ç‚¹å¯èƒ½åŒ…å«æ•°æ®ï¼Œé€šè¿‡ context.options.decodeEntities(???) æ¥è§£æã€‚\n ä¸€äº›å­—ç¬¦çš„ html ä¹¦å†™æ ¼å¼ï¼Œæœ‰ /\u0026amp;(gt|lt|amp|apos|quot);/ ï¼Œæœ€ç»ˆä¼šè¢«å¯¹åº”çš„å­—ç¬¦æ›¿æ¢æ‰ã€‚\n decodeEntities: (rawText: string): string =\u0026gt; rawText.replace(decodeRE, (_, p1) =\u0026gt; decodeMap[p1])\n å­—ç¬¦é›†ï¼š\n1 2 3 4 5 6 7  const decodeMap: Record\u0026lt;string, string\u0026gt; = { gt: \u0026#39;\u0026gt;\u0026#39;, lt: \u0026#39;\u0026lt;\u0026#39;, amp: \u0026#39;\u0026amp;\u0026#39;, apos: \u0026#34;\u0026#39;\u0026#34;, quot: \u0026#39;\u0026#34;\u0026#39; }     ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  /** ,* Get text data with a given length from the current location. ,* This translates HTML entities in the text data. ,*/ function parseTextData( context: ParserContext, length: number, mode: TextModes ): string { const rawText = context.source.slice(0, length) advanceBy(context, length) if ( mode === TextModes.RAWTEXT || mode === TextModes.CDATA || rawText.indexOf(\u0026#39;\u0026amp;\u0026#39;) === -1 ) { return rawText // å¦‚æœä¸åŒ…å« \u0026amp;gt; \u0026amp;lt; ç­‰htmlæ ‡è®°  } else { // DATA or RCDATA containing \u0026#34;\u0026amp;\u0026#34;\u0026#34;. Entity decoding required.  // å¦‚æœå­—ç¬¦ä¸²ä¸­åŒ…å«è¿™äº›å­—ç¬¦ï¼Œå¾—å»å°†ä»–ä»¬æ›¿æ¢æˆå¯¹åº”çš„æ˜æ–‡å­—ç¬¦ã€‚  return context.options.decodeEntities( rawText, mode === TextModes.ATTRIBUTE_VALUE ) } }     å¯¼å›¾ï¼š   parseAttributes(context, type)   è¿™é‡Œå®šä¹‰ props[] æ•°ç»„ï¼ŒçœŸæ­£è§£æå•ä¸ªå±æ€§çš„åœ¨ parseAttribute ä¸­ï¼Œè§£æä¹‹åçš„å•ä¸ª å±æ€§è§£æ„ä¿å­˜åˆ°æ•°ç»„ä¸­ï¼Œè¿”å›ç»™å½“å‰ç»„ä»¶ä½œä¸º props å±æ€§å­—æ®µå­˜åœ¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  // è§£ææ ‡ç­¾æ‰€æœ‰å±æ€§  function parseAttributes(context, type) { const props = []; const attributeNames = new Set(); while ( context.source.length \u0026gt; 0 \u0026amp;\u0026amp; !context.source.startsWith(\u0026#34;\u0026gt;\u0026#34;) \u0026amp;\u0026amp; !context.source.startsWith(\u0026#34;/\u0026gt;\u0026#34;) ) { // éæ³•å±æ€§ï¼Œ \u0026lt;div /v-if=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;??  if (context.source.startsWith(\u0026#34;/\u0026#34;)) { emitError(context, ErrorCodes.UNEXPECTED_SOLIDUS_IN_TAG); advanceBy(context, 1); advanceSpaces(context); continue; } // \u0026lt;/div\u0026gt; ç»“æŸæ ‡ç­¾ï¼Œä»¥å±æ€§ç»“æŸçš„æ ‡ç­¾?  if (type === TagType.End) { emitError(context, ErrorCodes.END_TAG_WITH_ATTRIBUTES); } // é€ä¸ªè§£æå±æ€§  const attr = parseAttribute(context, attributeNames); if (type === TagType.Start) { props.push(attr); } if (/^[^\\t\\r\\n\\f /\u0026gt;]/.test(context.source)) { emitError(context, ErrorCodes.MISSING_WHITESPACE_BETWEEN_ATTRIBUTES); } advanceSpaces(context); } return props; }      parseAttribute(context, nameSet)   è§£ææ ‡ç­¾å±æ€§æˆ–æŒ‡ä»¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140  function parseAttribute(context, nameSet) { const start = getCursor(context) const match = /^[^\\t\\r\\n\\f /\u0026gt;][^\\t\\r\\n\\f /\u0026gt;=]*/.exec(context.source) const name = match[0] if (nameSet.has(name)) { // é‡å¤å±æ€§å  emitError(context, ErrorCodes.DUPLICATE_ATTRIBUTE) } nameSet.add(name) if (name[0] === \u0026#39;=\u0026#39;) { // =name=value ?  emitError(context, ErrorCodes.UNEXPECTED_EQUALS_SIGN_BEFORE_ATTRIBUTE_NAME) } { const pattern = /[\u0026#34;\u0026#39;\u0026lt;]/g let m while ((m = pater.exec(name))) { // ä¸åˆæ³•çš„å±æ€§å  emitError( context, ErrorCodes.UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME, m.index ) } } // ç§»åŠ¨æŒ‡é’ˆ  advanceBy(context, name.length) // type: { content, isQuoted, loc }  let value // å»ç©ºæ ¼è§£æå±æ€§å€¼  if (/^[\\t\\r\\n\\f ]*=/.test(context.source)) { // å±æ€§åä¸ = ä¹‹é—´å­˜åœ¨ç©ºæ ¼çš„æƒ…å†µï¼Œå»æ‰ç©ºæ ¼  advanceSpaces(context) advanceBy(context, 1) advanceSpaces(context) // å»æ‰ç©ºæ ¼ä¹‹åè§£æå±æ€§å€¼  value = parseAttributeValue(context) if (!value) { emitError(context, ErrorCodes.MISSING_ATTRIBUTE_VALUE) } } const loc = getSelection(context, start) // v-dir æˆ– ç¼©å†™  if (!context.inVPre \u0026amp;\u0026amp; /^(v-|:|@|#)/.test(name)) { // ?: éæ•è·ç»„  // 1. (?:^v-([a-z0-9]+))? -\u0026gt; åŒ¹é… v-dir æŒ‡ä»¤ï¼Œéè´ªå©ªåŒ¹é…ï¼Œæ•è·æŒ‡ä»¤å  // ç§°([a-z0=9]+)  // 2. (?:(?::|^@|^#)([^\\.]+))? -\u0026gt; åŒ¹é… :,@,#  // 3. (.+)?$ åŒ¹é…ä»»æ„å­—ç¬¦  const match = /(?:^v-([a-z0-9]+))?(?:(?::|^@|^#)([^\\.]+))?(.+)?$/i.exec( name ) let arg // ([a-z0-9]+), ([^\\.]+)  if (match[2]) { const startOffset = name.indexOf(match[2]) const loc = getSelection( context, getNewPosition(context, start, startOffset), getNewPosition(context, start, startOffset + match[2].length) ) let content = match[2] let isStatic = true // é™æ€å±æ€§å  // åŠ¨æ€å±æ€§åè§£æ  if (content.startsWith(\u0026#39;[\u0026#39;)) { isStatic = false if (!content.endsWith(\u0026#39;]\u0026#39;)) { // å¦‚æœæ˜¯åŠ¨æ€å±æ€§åï¼Œå¿…é¡»æ˜¯ [varName] å½¢å¼  emitError( context, ErrorCodes.X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END ) } content = content.substr(1, content.length - 2) } arg = { type: NodeTypes.SIMPLE_EXPRESSION, content, isStatic, isConstant: isStatic, loc } } // å±æ€§æ˜¯å¦è¢«å¼•å·åŒ…èµ·æ¥  if (value \u0026amp;\u0026amp; value.isQuoted) { const valueLoc = value.loc valueLoc.start.offset++ valueLoc.start.column++ valueLoc.end = advancePositionWithClone(valueLoc.start, value.content) // å–å¼•å·å†…çš„æ‰€æœ‰å†…å®¹  valueLoc.source = valueLoc.source.slice(1, -1) } return { type: NodeTypes.DIRECTIVE, // : -\u0026gt; v-bind, @ -\u0026gt; v-on, # -\u0026gt; v-slot çš„ç¼©å†™  name: match[1] || (name.startsWith(\u0026#39;:\u0026#39;) ? \u0026#39;bind\u0026#39; : name.startsWith(\u0026#39;@\u0026#39;) ? \u0026#39;on\u0026#39; : \u0026#39;slot\u0026#39;), exp: value \u0026amp;\u0026amp; { type: NodeTypes.SIMPLE_EXPRESSION, content: value.content, isStatic: false, isConstant: false, loc: value.loc }, arg, // ä¿®é¥°ç¬¦å¤„ç†, v-bind.m1.m2 -\u0026gt; .m1.m2 -\u0026gt; [\u0026#39;m1\u0026#39;, \u0026#39;m2\u0026#39;]  modifiers: match[3] ? match[3].substr[1].split(\u0026#39;.\u0026#39;) : [], loc } } return { type: NodeTypes.ATTRIBUTE, name, value: value \u0026amp;\u0026amp; { type: NodeTypes.TEXT, content: value.content, loc: value.loc }, loc } }     è¯¥å‡½æ•°å®ç°ä¸»è¦æœ‰å‡ éƒ¨åˆ†(ä»¥ \u0026lt;div v-bind:keyup.enter.prevent=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; ä¸ºä¾‹)ï¼š\n  åŒ¹é…å±æ€§åï¼Œå…³é”®æ­£åˆ™ï¼š /^[^\\t\\r\\n\\f /\u0026gt;][^\\t\\r\\n\\f /\u0026gt;=]*/ ä¼šå°† v-if=\u0026#34;varname\u0026#34; ä¸­ç­‰å·å‰é¢çš„ v-bind:keyup.enter.prevent éƒ½åŒ¹é…å‡ºæ¥ã€‚\n  å°†åŒ¹é…åˆ°çš„å±æ€§åæ”¶é›†åˆ° nameSet[] ä¸­ï¼Œæ£€æµ‹é‡å¤æ€§ã€‚\n è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå±æ€§ååŒ¹é…çš„ç»“æœä¼šå°†å˜é‡åï¼Œ ä¿®é¥°ç¬¦éƒ½åŒ¹é…åˆ°ï¼Œå¦‚ï¼š \u0026lt;div v-bind:keyup.enter.prevent=\u0026#34;ok\u0026#34;\u0026gt; ï¼Œæœ€å add åˆ° nameSet ä¸­çš„å®Œæ•´å±æ€§åä¸ºï¼š v-bind:keyup.enter.prevent ã€‚ \n  éæ³•å±æ€§åæ£€æµ‹(å¦‚ï¼š =name=value ï¼Œæˆ–å±æ€§åä¸­åŒ…å« [\u0026#34;\u0026#39;\u0026lt;] å­—ç¬¦)ï¼Œå¼‚å¸¸\n  ç§»åŠ¨æŒ‡é’ˆ advanceBy(context, name.length) å®šä½åˆ°å±æ€§ååçš„ä½ç½®ï¼Œç›®çš„æ˜¯ä¸ºäº†å– å±æ€§å€¼ï¼Œå‰©ä¸‹ï¼š =\u0026#34;ok\u0026#34; ã€‚\n  æ­£åˆ™ï¼š /^[\\t\\r\\n\\f ]*=/ ï¼Œè§£æå±æ€§å€¼ï¼Œè°ƒç”¨ parseAttributeValue è§£æå‡ºå±æ€§å€¼æ¥\n  æŒ‡é’ˆå½’ä½è‡³å¼€å§‹ä½ç½®ï¼Œå¦‚ï¼š v-bind:keyup.enter.prevent=\u0026#34;ok\u0026#34; çš„å¼€å§‹ä½ç½®ä¸º v ä½ç½®ï¼Œè§£æä¿®é¥°ç¬¦ï¼Œå¾—åˆ° modifiers: [] ï¼Œè¿™é‡Œçš„å…³é”®åœ¨äºæ­£ åˆ™ï¼š /(?:^v-([a-z0-9]+))?(?:(?::|^@|^#)([^\\.]+))?(.+)?$/i ï¼Œä¼šåŒ¹é… v-if, :, @, #... æŒ‡ä»¤å’ŒæŒ‡ä»¤ç¼©å†™ä»¥åŠä¿®é¥°ç¬¦ã€‚\n  è§£ææŒ‡ä»¤åé¢çš„å˜é‡åç§°ï¼Œå¦‚ï¼š keyup ï¼Œæœ‰å¯èƒ½æ˜¯åŠ¨æ€å€¼ v-bind:[varname] ã€‚\n  æ£€æµ‹å±æ€§å€¼æœ‰æ²¡è¢«å¼•å·åŒ…èµ·æ¥ï¼Œå¦‚æœæœ‰ï¼Œè¦æ›´æ–° value.loc ï¼Œåªå–å¼•å·å†…çš„å†…å®¹ content.source = valueLoc.source.slice(1, -1)\n  è¿”å›æŒ‡ä»¤èŠ‚ç‚¹ç±»å‹å¯¹è±¡\n    å¦åˆ™è¿”å›æ™®é€šå±æ€§ç±»å‹èŠ‚ç‚¹\n    parseAttributeValue(context)   è§£æå±æ€§å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  function parseAttributeValue(context) { // ä¿å­˜æ¨¡æ¿å­—ç¬¦ä¸²æŒ‡é’ˆèµ·ç‚¹ä½ç½®  const start = getCursor(context) let content const quote = context.source[0] const isQuoted = quote === `\u0026#34;` || quote === `\u0026#39;` if (isQuoted) { // æœ‰å¼•å·  advanceBy(context, 1) const endIndex = context.source.indexOf(quote) // æ²¡æœ‰ç»“æŸå¼•å·??? æ•´ä¸ª source å½“åšæ–‡æœ¬æ•°æ®å¤„ç†???  if ((endIndex = -1)) { content = parseTextData( context, context.source.length, TextModes.ATTRIBUTE_VALUE ) } else { content = parseTextData(context, endIndex, TextModes.ATTRIBUTE_VALUE) advanceBy(context, 1) } } else { // æ²¡æœ‰å¼•å·  const match = /^[^\\t\\r\\n\\f \u0026gt;]+/.exec(context.source) if (!match) { // æ— å±æ€§å€¼  return undefined } const unexpectedChars = /[\u0026#34;\u0026#39;\u0026lt;=`]/g let m while ((m = unexpectedChars.exec(match[0]))) { // æ— å¼•å·å€¼ä¸­éæ³•å­—ç¬¦æ£€æµ‹  emitError( context, ErrorCodes.UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE ) } // è§£ææ–‡æœ¬æ•°æ®  content = parseTextData(context, match[0].length, TextModes.ATTRIBUTE_VALUE) } return { content, isQuoted, loc: getSelection(context, start) } }      DONE parseCDATA(context, ancestors)  CLOSED: [2020-09-02 Wed 23:14]\n  State \u0026#34;DONE\u0026#34; from \u0026#34;TODO\u0026#34; [2020-09-02 Wed 23:14]\n  è§£æ \u0026lt;![CDATA[....]] xml ç±»å‹æ³¨é‡Šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  // \u0026lt;![CDATA[...  function parseCDATA(context, ancestors) { advanceBy(context, 9); // `\u0026lt;![CDATA[`.length = 9  const nodes = parseChildren(context, TextModes.CDATA, ancestors); if (context.source.length === 0) { emitError(context, ErrorCodes.EOF_IN_CDATA); } else { advanceBy(context, 3); } return nodes; }      DONE parseBogusComment(context)  CLOSED: [2020-09-02 Wed 23:11]\n  State \u0026#34;DONE\u0026#34; from \u0026#34;TODO\u0026#34; [2020-09-02 Wed 23:11]\n  è§£æä¸€äº›æ³¨é‡Šæ€§çš„ç»“æ„ï¼Œå¦‚ï¼š \u0026lt;!DOCTYPE ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  function parseBogusComment(context) { const start = getCursor(context); const contentStart = context.source[1] === \u0026#34;?\u0026#34; ? 1 : 2; let content; const closeIndex = context.source.indexOf(\u0026#34;\u0026gt;\u0026#34;); if (closeIndex === -1) { // æ²¡æœ‰ç»“æŸç´¢å¼•ï¼Œåé¢æ‰€æœ‰çš„éƒ½å°†æˆä¸ºæ³¨é‡Š  content = context.source.slice(contentStart); advanceBy(context, context.source.length); } else { content = context.source.slice(contentStart, closeIndex); // å®šä½åˆ°æ³¨é‡Šåé¢çš„å­—ç¬¦  advanceBy(context, closeIndex + 1); } return { type: NodeTypes.COMMENT, content, loc: getSelection(context, start), }; }      pushNode(nodes, node)    æ³¨é‡ŠèŠ‚ç‚¹ä¸å¤„ç†\n  åˆå¹¶æ–‡æœ¬èŠ‚ç‚¹(å‰ææ˜¯ prev, node ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ç´§æŒ¨ç€çš„ï¼Œç”± loc.end.offset å’Œ loc.start.offset åˆ¤æ–­)\n  è¿”å›æ–°å¢ node çš„ nodes èŠ‚ç‚¹æ•°ç»„\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  function pushNode(nodes: TemplateChildNode[], node: TemplateChildNode): void { // ignore comments in production  /* istanbul ignore next */ if (!__DEV__ \u0026amp;\u0026amp; node.type === NodeTypes.COMMENT) { return } if (node.type === NodeTypes.TEXT) { // ä¸¤ä¸ªè¿ç€çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‹¼å‡‘åˆ°ä¸€èµ·å»  const prev = last(nodes) // Merge if both this and the previous node are text and those are  // consecutive. This happens for cases like \u0026#34;a \u0026lt; b\u0026#34;.  if ( prev \u0026amp;\u0026amp; prev.type === NodeTypes.TEXT \u0026amp;\u0026amp; prev.loc.end.offset === node.loc.start.offset ) { prev.content += node.content prev.loc.end = node.loc.end prev.loc.source += node.loc.source return } } nodes.push(node) }      isEnd(context, mode, ancestors)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  function isEnd( context: ParserContext, mode: TextModes, ancestors: ElementNode[] ): boolean { const s = context.source switch (mode) { case TextModes.DATA: if (startsWith(s, \u0026#39;\u0026lt;/\u0026#39;)) { //TODO: probably bad performance  for (let i = ancestors.length - 1; i \u0026gt;= 0; --i) { if (startsWithEndTagOpen(s, ancestors[i].tag)) { return true } } } break case TextModes.RCDATA: case TextModes.RAWTEXT: { const parent = last(ancestors) if (parent \u0026amp;\u0026amp; startsWithEndTagOpen(s, parent.tag)) { return true } break } case TextModes.CDATA: if (startsWith(s, \u0026#39;]]\u0026gt;\u0026#39;)) { return true } break } return !s }      getCursor(context)  1 2 3 4  function getCursor(context: ParserContext): Position { const { column, line, offset } = context return { column, line, offset } }      getSelection(context, start, end?: Postion)   å–å®æ—¶è§£æåçš„ sourceï¼Œstartï¼Œend çš„å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function getSelection( context: ParserContext, start: Position, end?: Position ): SourceLocation { end = end || getCursor(context) return { start, end, source: context.originalSource.slice(start.offset, end.offset) } }        é‡è¦ç±»å‹å£°æ˜   è¯¥æ¨¡å—æ‰€æœ‰ç±»å‹å£°æ˜ç»Ÿä¸€å½’ç±»åˆ°æ­¤ï¼Œé¡ºåºæŒ‰ç…§ç”¨ä¾‹è§£æé‡åˆ°çš„é¡ºåºä¸ºä¸»ã€‚\ndefaultParserOptions  1 2 3 4 5 6 7 8 9 10 11 12 13  // é»˜è®¤çš„è§£æå™¨é€‰é¡¹  export const defaultParserOptions: MergedParserOptions = { delimiters: [`{{`, `}}`], getNamespace: () =\u0026gt; Namespaces.HTML, // å‘½åç©ºé—´  getTextMode: () =\u0026gt; TextModes.DATA, // æ–‡æœ¬ç±»å‹  isVoidTag: NO, // è‡ªå…³é—­æ ‡ç­¾???ï¼Œå¦‚ï¼š\u0026lt;img\u0026gt;, \u0026lt;hr\u0026gt; ...  isPreTag: NO, // \u0026lt;pre\u0026gt; ä»£ç æ ‡ç­¾???ï¼Œéœ€è¦ä¿ç•™ç©ºæ ¼ä¿è¯ç¼©è¿›çš„  isCustomElement: NO, // è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¦‚ï¼šTransition  decodeEntities: (rawText: string): string =\u0026gt; // è§£ç å®ä¾‹ï¼Œä¸€äº›ç‰¹æ®Šç¬¦å·è¡¨ç¤ºï¼Œå¦‚ï¼š\u0026amp;gt;, \u0026amp;lt;, \u0026amp;amp;, \u0026amp;apos; \u0026amp;quot;  rawText.replace(decodeRE, (_, p1) =\u0026gt; decodeMap[p1]), onError: defaultOnError }      TextModes  1 2 3 4 5 6 7 8  export const enum TextModes { // | Elements | Entities | End sign | Inside of  DATA, // | âœ” | âœ” | End tags of ancestors |  RCDATA, // | âœ˜ | âœ” | End tag of the parent | \u0026lt;textarea\u0026gt;  RAWTEXT, // | âœ˜ | âœ˜ | End tag of the parent | \u0026lt;style\u0026gt;,\u0026lt;script\u0026gt;  CDATA, ATTRIBUTE_VALUE }      ParserOptions   å®šä¹‰ä½ç½®ï¼š\nsrc/options.ts  æ¥å£å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  export interface ParserOptions { /** ,* e.g. platform native elements, e.g. \u0026lt;div\u0026gt; for browsers ,*/ isNativeTag?: (tag: string) =\u0026gt; boolean /** ,* e.g. native elements that can self-close, e.g. \u0026lt;img\u0026gt;, \u0026lt;br\u0026gt;, \u0026lt;hr\u0026gt; ,*/ isVoidTag?: (tag: string) =\u0026gt; boolean /** ,* e.g. elements that should preserve whitespace inside, e.g. \u0026lt;pre\u0026gt; ,*/ isPreTag?: (tag: string) =\u0026gt; boolean /** ,* Platform-specific built-in components e.g. \u0026lt;Transition\u0026gt; ,*/ isBuiltInComponent?: (tag: string) =\u0026gt; symbol | void /** ,* Separate option for end users to extend the native elements list ,*/ isCustomElement?: (tag: string) =\u0026gt; boolean /** ,* Get tag namespace ,*/ getNamespace?: (tag: string, parent: ElementNode | undefined) =\u0026gt; Namespace /** ,* Get text parsing mode for this element ,*/ getTextMode?: ( node: ElementNode, parent: ElementNode | undefined ) =\u0026gt; TextModes /** ,* @default [\u0026#39;{{\u0026#39;, \u0026#39;}}\u0026#39;] ,*/ delimiters?: [string, string] /** ,* Only needed for DOM compilers ,*/ decodeEntities?: (rawText: string, asAttr: boolean) =\u0026gt; string onError?: (error: CompilerError) =\u0026gt; void }     å­—æ®µè¯´æ˜ï¼š\n  isNativeTag?: (tag: string) =\u0026gt; boolean ä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ˜¯åŸç”Ÿæ ‡ç­¾(å¦‚ï¼šli, div)\n  isVoidTag?: (tag: string) =\u0026gt; boolean,è‡ªå…³é—­æ ‡ç­¾ï¼Œå¦‚ï¼šimg, br, hr\n  isPreTag?: (tag: string) =\u0026gt; boolean ï¼Œä»£ç æ ‡ç­¾ï¼Œéœ€è¦ç©ºæ ¼ç¼©è¿›çš„ï¼Œå¦‚ï¼špre\n  isBuiltInComponent?: (tag: string) =\u0026gt; symbol | void ï¼Œå¹³å°ç›¸å…³çš„å†…ç½®ç»„ä»¶ï¼Œå¦‚ï¼šTransition\n  isCoustomElement?: (tag: string) =\u0026gt; boolean ï¼Œç”¨æˆ·è‡ªå®šçš„æ ‡ç­¾\n  getNamespace?: (tag: string, parent: ElementNode | undefined) =\u0026gt; Nâ„amespace ï¼Œè·å–æ ‡ç­¾å‘½åç©ºé—´\n  getTextMode?: (node: ElementNode, parent: ElementNode|undefined) =\u0026gt; TextModes è·å–æ–‡æœ¬è§£ææ¨¡å¼\n  delimiters?: [string, string] ï¼Œæ’å€¼åˆ†éš”ç¬¦ï¼Œé»˜è®¤ï¼š [\u0026#39;{{\u0026#39;, \u0026#39;}}\u0026#39;]\n  decodeEntities?: (rawText: string, asAttr: boolean) =\u0026gt; string ï¼Œä»…ç”¨äº DOM compilers\n  onError?: (error: CompilerError) =\u0026gt; void\n    ParserContext   å®šä¹‰ä½ç½®ï¼š\nsrc/parse.ts  æ¥å£å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10  export interface ParserContext { options: MergedParserOptions // è§£æå™¨é€‰é¡¹ï¼Œå³åˆå¹¶ä¹‹åçš„å‚æ•°å¯¹è±¡  readonly originalSource: string // æœ€åˆçš„æºç ï¼Œå³è§£æä¹‹å‰çš„æœ€åŸå§‹çš„å­—ç¬¦ä¸²ï¼Œåªè¯»ç‰ˆæœ¬  source: string // è§£æä¸­çš„æºç å­—ç¬¦ä¸²ï¼Œä¼šå‘ç”Ÿå˜åŒ–çš„å­—ç¬¦ä¸²  offset: number // è§£æçš„æŒ‡é’ˆä½ç½®ï¼Œç±»ä¼¼æ–‡ä»¶è¯»å–æ˜¯çš„æŒ‡é’ˆåç§»é‡  line: number // è§£æä½ç½®åœ¨æºç ä¸­çš„å½“å‰è¡Œ  column: number // è§£æä½ç½®åœ¨æºç ä¸­çš„å½“å‰åˆ—  inPre: boolean // æ ‡è¯†æ˜¯ä¸æ˜¯ \u0026lt;pre\u0026gt; æ ‡ç­¾ï¼Œå¦‚æœæ˜¯éœ€è¦ä¿ç•™ç©ºæ ¼ä¿è¯ç¼©è¿›  inVPre: boolean // v-pre æŒ‡ä»¤ï¼Œä¸å¤„ç†æŒ‡ä»¤å’Œæ’å€¼(v-xxx, {{...}})  }        utils.ts  advancePositionWithMutation(pos,source, numberOfCharacters)   æ›´æ–° context çš„ lineï¼Œcolumnï¼Œoffset çš„å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  // advance by mutation without cloning (for performance reasons), since this  // gets called a lot in the parser  export function advancePositionWithMutation( pos: Position, source: string, numberOfCharacters: number = source.length ): Position { let linesCount = 0 let lastNewLinePos = -1 for (let i = 0; i \u0026lt; numberOfCharacters; i++) { if (source.charCodeAt(i) === 10 /* newline char code */) { linesCount++ lastNewLinePos = i } } pos.offset += numberOfCharacters pos.line += linesCount pos.column = lastNewLinePos === -1 ? pos.column + numberOfCharacters : numberOfCharacters - lastNewLinePos return pos }        é˜¶æ®µä»£ç è®°å½•    text01: some text çš„ä»£ç å¤‡ä»½\n  text02: some text \\\u0026lt;div\u0026gt; 01 ä»£ç å¤‡ä»½\n  text02: some text \\\u0026lt;div\u0026gt; 02 ä»£ç å¤‡ä»½\n  text03: some {{ foo + bar }} text ä»£ç å¤‡ä»½\n  text04: some {{ a\u0026lt;b \u0026amp;\u0026amp; c\u0026gt;d }} text ä»£ç å¤‡ä»½\n  comment: \u0026lt;!â€“xâ€“\u0026gt;æ³¨é‡Šè§£æä»£ç å¤‡ä»½\n  test-element-v-pre ä»£ç å¤‡ä»½, æ”¯æŒ v-pre å’Œ \u0026lt;pre\u0026gt; æ ‡ç­¾ï¼Œä»¥åŠæ¢è¡Œ\n   æ‰€æœ‰ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178  âœ packages git:(master) âœ— jest compiler-core -u PASS compiler-core/__tests__/parse.spec.js (5.287 s) compiler: parse Text âœ“ simple text (8 ms) âœ“ simple text with invalid end tag (3 ms) âœ“ text with interpolation (2 ms) âœ“ text with interpolation which has `\u0026lt;` (1 ms) âœ“ text with mix of tags and interpolations (2 ms) âœ“ lonly \u0026#34;\u0026lt;\u0026#34; don\u0026#39;t separate nodes âœ“ lonly \u0026#34;{{\u0026#34; don\u0026#39;t separate nodes Interpolation âœ“ simple interpolation (1 ms) âœ“ it can have tag-like notation (1 ms) âœ“ it can have tag-like notation (2) (1 ms) âœ“ it can have tag-like notation (3) (1 ms) âœ“ custom delimiters Comment âœ“ empty comment (1 ms) âœ“ simple comment (1 ms) âœ“ two comments Element âœ“ simple div âœ“ empty div (1 ms) âœ“ self closing (1 ms) âœ“ void element âœ“ template element with directives (2 ms) âœ“ template element without directives (1 ms) âœ“ native element with `isNativeTag` (1 ms) âœ“ native element without `isNativeTag` (1 ms) âœ“ v-is with `isNativeTag` (2 ms) âœ“ v-is without `isNativeTag` (5 ms) âœ“ custom element (1 ms) âœ“ attribute with no value (2 ms) âœ“ attribute with empty value, double quote (1 ms) âœ“ attribute with empty value, single quote (1 ms) âœ“ attribute with value, double quote (1 ms) âœ“ attribute with value, single quote (1 ms) âœ“ attribute with value, unquoted âœ“ multiple attributes (2 ms) âœ“ directive with no value (1 ms) âœ“ directive with value âœ“ directive with argument (1 ms) âœ“ directive with a modifier (1 ms) âœ“ directive with two modifiers âœ“ directive with argument and modifiers (1 ms) âœ“ v-bind shorthand (1 ms) âœ“ v-bind shorthand with modifier (1 ms) âœ“ v-on shorthand âœ“ v-on shorthand with modifier (1 ms) âœ“ v-slot shorthand (1 ms) âœ“ v-pre (1 ms) âœ“ end tags are case-insensitive. (1 ms) Others âœ“ self closing single tag (1 ms) âœ“ self closing multiple tag (5 ms) âœ“ valid html (5 ms) âœ“ invalid html (54 ms) âœ“ parse with correct location info (2 ms) decodeEntities option âœ“ use the given map (1 ms) whitespace management âœ“ should remove whitespaces at start/end inside an element âœ“ should remove whitespaces w/ newline between elements âœ“ should remove whitespaces adjacent to comments (3 ms) âœ“ should remove whitespaces w/ newline between comments and elements (1 ms) âœ“ should NOT remove whitespaces w/ newline between interpolations (1 ms) âœ“ should NOT remove whitespaces w/o newline between elements (1 ms) âœ“ should condense consecutive whitespaces in text (1 ms) Errors ABRUPT_CLOSING_OF_EMPTY_COMMENT âœ“ \u0026lt;template\u0026gt;\u0026lt;!--\u0026gt;\u0026lt;/template\u0026gt; (3 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!---\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!----\u0026gt;\u0026lt;/template\u0026gt; (1 ms) CDATA_IN_HTML_CONTENT âœ“ \u0026lt;template\u0026gt;\u0026lt;![CDATA[cdata]]\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;svg\u0026gt;\u0026lt;![CDATA[cdata]]\u0026gt;\u0026lt;/svg\u0026gt;\u0026lt;/template\u0026gt; (1 ms) DUPLICATE_ATTRIBUTE âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#34;\u0026#34; id=\u0026#34;\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (3 ms) END_TAG_WITH_ATTRIBUTES âœ“ \u0026lt;template\u0026gt;\u0026lt;div\u0026gt;\u0026lt;/div id=\u0026#34;\u0026#34;\u0026gt;\u0026lt;/template\u0026gt; (1 ms) END_TAG_WITH_TRAILING_SOLIDUS âœ“ \u0026lt;template\u0026gt;\u0026lt;div\u0026gt;\u0026lt;/div/\u0026gt;\u0026lt;/template\u0026gt; (2 ms) EOF_BEFORE_TAG_NAME âœ“ \u0026lt;template\u0026gt;\u0026lt; (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;/ (2 ms) EOF_IN_CDATA âœ“ \u0026lt;template\u0026gt;\u0026lt;svg\u0026gt;\u0026lt;![CDATA[cdata (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;svg\u0026gt;\u0026lt;![CDATA[ (2 ms) EOF_IN_COMMENT âœ“ \u0026lt;template\u0026gt;\u0026lt;!--comment (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!-- (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;! (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!- (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!abc (1 ms) EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT âœ“ \u0026lt;script\u0026gt;\u0026lt;!--console.log(\u0026#39;hello\u0026#39;) (2 ms) âœ“ \u0026lt;script\u0026gt;console.log(\u0026#39;hello\u0026#39;) (3 ms) EOF_IN_TAG âœ“ \u0026lt;template\u0026gt;\u0026lt;div (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id = (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#39;abc (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#34;abc (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#39;abc\u0026#39; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#34;abc\u0026#34; (4 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=abc (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#39;abc\u0026#39;/ (3 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#34;abc\u0026#34;/ (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=abc / (1 ms) INCORRECTLY_CLOSED_COMMENT âœ“ \u0026lt;template\u0026gt;\u0026lt;!--comment--!\u0026gt;\u0026lt;/template\u0026gt; (1 ms) INCORRECTLY_OPENED_COMMENT âœ“ \u0026lt;template\u0026gt;\u0026lt;!\u0026gt;\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!-\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!ELEMENT br EMPTY\u0026gt;\u0026lt;/template\u0026gt; (3 ms) âœ“ \u0026lt;!DOCTYPE html\u0026gt; (2 ms) INVALID_FIRST_CHARACTER_OF_TAG_NAME âœ“ \u0026lt;template\u0026gt;a \u0026lt; b\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;ï¿½\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;a \u0026lt;/ b\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;/ï¿½\u0026gt;\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;template\u0026gt;{{a \u0026lt; b}}\u0026lt;/template\u0026gt; (1 ms) MISSING_ATTRIBUTE_VALUE âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (3 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id= \u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id= /\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (5 ms) MISSING_END_TAG_NAME âœ“ \u0026lt;template\u0026gt;\u0026lt;/\u0026gt;\u0026lt;/template\u0026gt; (1 ms) MISSING_WHITESPACE_BETWEEN_ATTRIBUTES âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#34;foo\u0026#34;class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div id=\u0026#34;foo\u0026#34;\\x0d;\\x0a;class=\u0026#34;bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (1 ms) NESTED_COMMENT âœ“ \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!--b--\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!--b\u0026lt;!--c--\u0026gt;\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!--\u0026gt;\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;!--a\u0026lt;!-- (4 ms) UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME âœ“ \u0026lt;template\u0026gt;\u0026lt;div a\u0026#34;bc=\u0026#39;\u0026#39;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div a\u0026#39;bc=\u0026#39;\u0026#39;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (3 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div a\u0026lt;bc=\u0026#39;\u0026#39;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (3 ms) UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE âœ“ \u0026lt;template\u0026gt;\u0026lt;div foo=bar\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div foo=bar\u0026#39;\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (3 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div foo=bar\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div foo=bar=baz\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div foo=bar`\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) UNEXPECTED_EQUALS_SIGN_BEFORE_ATTRIBUTE_NAME âœ“ \u0026lt;template\u0026gt;\u0026lt;div =foo=bar\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div =\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (1 ms) UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME âœ“ \u0026lt;template\u0026gt;\u0026lt;?xml?\u0026gt;\u0026lt;/template\u0026gt; (1 ms) UNEXPECTED_SOLIDUS_IN_TAG âœ“ \u0026lt;template\u0026gt;\u0026lt;div a/b\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; (2 ms) X_INVALID_END_TAG âœ“ \u0026lt;template\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; âœ“ \u0026lt;template\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/template\u0026gt; âœ“ \u0026lt;template\u0026gt;{{\u0026#39;\u0026lt;/div\u0026gt;\u0026#39;}}\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;textarea\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/textarea\u0026gt; (1 ms) âœ“ \u0026lt;svg\u0026gt;\u0026lt;![CDATA[\u0026lt;/div\u0026gt;]]\u0026gt;\u0026lt;/svg\u0026gt; âœ“ \u0026lt;svg\u0026gt;\u0026lt;!--\u0026lt;/div\u0026gt;--\u0026gt;\u0026lt;/svg\u0026gt; X_MISSING_END_TAG âœ“ \u0026lt;template\u0026gt;\u0026lt;div\u0026gt;\u0026lt;/template\u0026gt; (1 ms) âœ“ \u0026lt;template\u0026gt;\u0026lt;div\u0026gt; (1 ms) X_MISSING_INTERPOLATION_END âœ“ {{ foo (1 ms) âœ“ {{ (2 ms) âœ“ {{}} X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END âœ“ \u0026lt;div v-foo:[sef fsef] /\u0026gt; (1 ms) Test Suites: 1 passed, 1 total Tests: 135 passed, 135 total Snapshots: 79 passed, 79 total Time: 6.398 s, estimated 20 s Ran all test suites matching /compiler-core/i.      é—®é¢˜/ç–‘é—®åˆ—è¡¨    å¦‚ä½•åŒºåˆ†å†…ç½®æ ‡ç­¾|å†…ç½®ç»„ä»¶|æ ¸å¿ƒç»„ä»¶|è‡ªå®šä¹‰ç»„ä»¶ï¼ŸğŸ›«\n  ä¸ºä»€ä¹ˆ parseTag è§£æ \u0026lt;div\u0026gt; ä¹‹ååªä¼šå¾— åˆ° \u0026lt;div è€Œä¸ä¼šå°† \u0026gt; è§£æè¿›å»ï¼ŸğŸ›« \nç­”ï¼šæ˜¯å› ä¸ºæ¼æ‰å®ç°äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œè‡ªé—­åˆæ ‡ç­¾çš„æ£€æµ‹ï¼Œç§»åŠ¨æŒ‡é’ˆ(2/1ä½)   å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  function parseTag(context, type) { // .... çœç•¥  // TODO-3 \u0026lt;div/\u0026gt; è‡ªé—­æ ‡ç­¾  // è¿™é‡Œè¦å®ç°ï¼Œä¸ç„¶æœ€åè§£æå®Œæˆä¹‹å source ä¼šæ˜¯ï¼š\u0026gt;...\u0026lt;/span\u0026gt;  // éœ€è¦æ£€æµ‹ä¸‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾æ¥ç§»åŠ¨æŒ‡é’ˆä½ç½®  let isSelfClosing = false if (context.source.length === 0) { emitError(context, ErrorCodes.EOF_IN_TAG) } else { // some \u0026lt;div\u0026gt; ... \u0026lt;/div\u0026gt; åˆ°è¿™é‡Œçš„ source = \u0026gt; ... \u0026lt;/div\u0026gt;  // æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /\u0026gt; å¼€å¤´çš„  isSelfClosing = context.source.startsWith(\u0026#39;/\u0026gt;\u0026#39;) if (type === TagType.End \u0026amp;\u0026amp; isSelfClosing) { emitError(context, ErrorCodes.END_TAG_WITH_TRAILING_SOLIDUS) } // å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/\u0026gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(\u0026gt;)  // åˆ°è¿™é‡Œ source = ... \u0026lt;/div\u0026gt;  advanceBy(context, isSelfClosing ? 2 : 1) } // ... çœç•¥  }      ä¸ºä»€ä¹ˆ parseElementÂ è§£æ children çš„æ—¶å€™å…ˆ ancestors.push(element) è§£æä¹‹ååˆ pop() æ‰ï¼Ÿ\nç­”ï¼šè¦å›åˆ°è¿™ä¸ªé—®é¢˜è¦ä» parseChildren å’Œ parseElement ä¸¤ä¸ªå‡½æ•°ç»“åˆæ¥çœ‹ï¼Œå¦‚ä¸‹ä»£ç åˆ†æ  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // è§£ææµç¨‹(ç”¨ä¾‹5)ï¼š  // 1. å…ˆ parseChildren(context, mode, ancestors)  // è§£æ `some \u0026lt;span\u0026gt;{{ foo \u0026lt; bar + foo }} text\u0026lt;/span\u0026gt;`  // 1) é¦–å…ˆå¾—åˆ°çš„æ˜¯ `some ` æ–‡æœ¬èŠ‚ç‚¹  // 2) æ£€æµ‹åˆ° \u0026lt;span\u0026gt; è¿›å…¥æ ‡ç­¾è§£æ parseElement(context, ancestors) æ³¨æ„è¿™é‡Œçš„ //\tancestorsï¼Œæ˜¯ç”± parseChildren ç»§æ‰¿è¿‡æ¥çš„  // 2. è¿›å…¥ parseElement è§£æè¿›ç¨‹  // 1) é‡åˆ° \u0026lt;span\u0026gt; è§£æå‡ºæ ‡ç­¾èŠ‚ç‚¹ span  // 2) åœ¨è‡ªèº«å‡½æ•°å†…æ£€æµ‹åˆ°æ ‡ç­¾å†…è¿˜æœ‰å†…å®¹ï¼Œé‡æ–°è°ƒç”¨ parseChildren(..., ancestors)  // 3) æ‰€ä»¥é‡ç‚¹æ¥äº†  // ...  // ...  // ancestors æ˜¯ parseChildren ä¼ é€’è¿‡æ¥çš„ï¼ŒparseElement é‡Œé¢å°†  // push çš„ç›®çš„ï¼šè®©å­èŠ‚ç‚¹æœ‰æ‰€ä¾èµ–ï¼ŒçŸ¥é“è‡ªå·±çš„çˆ¶çº§æ˜¯è°ï¼Œä½†å¥½åƒ parseChildren é‡Œé¢ç”¨åˆ°  // parent ä¹Ÿæ˜¯ä¸ºäº†è·å–å‘½åç©ºé—´å»ç”¨äº†  // pop çš„ç›®çš„ï¼šéš¾é“æ˜¯ä¸ºäº†ä¸æ±¡æŸ“ ancestors ???      å¥½åƒè¿˜ä¸æ˜¯å¾ˆæ˜ç¡®ä¸ºä½•è¦ push-\u0026gt;pop(DONE)ã€‚\n æ›´æ–°ï¼š2020-09-02 16:57:35\n åœ¨æµ‹è¯•ç”¨ä¾‹ parse-test-other-01 æ—¶ï¼ŒåµŒå¥—æ ‡ç­¾è§£æçš„æ—¶å€™ ancestors ä¸­ä¿å­˜ç€å¤šçº§ åµŒå¥—æ ‡ç­¾çš„çˆ¶çº§(å½“å‰è¢«è§£æçš„èŠ‚ç‚¹çš„çˆ¶çº§)ã€‚\n æ¯”å¦‚ï¼š \u0026lt;div\u0026gt;\u0026lt;span\u0026gt;\\n\u0026lt;/div\u0026gt;\u0026lt;/span\u0026gt; è¿™ä¸ªæ˜¯åä¾‹å“ˆï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹ã€‚\nancestors: Array(2) 0: {type: 1, ns: 0, tag: \u0026#34;div\u0026#34;, tagType: 0, props: Array(0), â€¦} 1: {type: 1, ns: 0, tag: \u0026#34;span\u0026#34;, tagType: 0, props: Array(0), â€¦} length: 2   è§£æé¡ºåºï¼š div -\u0026gt; push:ancestors[0] -\u0026gt; span -\u0026gt; push:ancestors[1] -\u0026gt; \\n è§£ æå®Œæˆä¹‹åï¼Œå‘ç° parent æœ‰å†…å®¹ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹è§£æå®Œä¹‹åä¼šè¢« push åˆ° span.children~é‡Œé¢å»ï¼Œåˆ°è¿™é‡Œ span è§£æå®Œäº†ï¼Œæ‰€ä»¥è¦é€€å‡ºå½“å‰é€’å½’å›åˆ° div çš„è§£ æï¼Œå› æ­¤éœ€è¦å°†~ancestors.pop() æ‰æœ€åä¸€ä¸ªï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ div çš„ child èƒ½æ­£ç¡® push åˆ°~div.ancestors~ ä¸­å»ã€‚\n    ","permalink":"https://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/","tags":["vue,","vue3,","vuenext,","compiler"],"title":"Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts"},{"categories":["vue"],"contents":"  æŠ½è±¡è¯­æ³•æ ‘ä»£ç æºæ–‡ä»¶ã€‚\n createVNodeCall  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  export function createVNodeCall( context: TransformContext | null, tag: VNodeCall[\u0026#39;tag\u0026#39;], props?: VNodeCall[\u0026#39;props\u0026#39;], children?: VNodeCall[\u0026#39;children\u0026#39;], patchFlag?: VNodeCall[\u0026#39;patchFlag\u0026#39;], dynamicProps?: VNodeCall[\u0026#39;dynamicProps\u0026#39;], directives?: VNodeCall[\u0026#39;directives\u0026#39;], isBlock: VNodeCall[\u0026#39;isBlock\u0026#39;] = false, isForBlock: VNodeCall[\u0026#39;isForBlock\u0026#39;] = false, loc = locStub ): VNodeCall { if (context) { if (isBlock) { context.helper(OPEN_BLOCK) context.helper(CREATE_BLOCK) } else { context.helper(CREATE_VNODE) } if (directives) { context.helper(WITH_DIRECTIVES) } } return { type: NodeTypes.VNODE_CALL, tag, props, children, patchFlag, dynamicProps, directives, isBlock, isForBlock, loc } }      createRoot(children, loc = locStub)   åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ª RootNode ç±»å‹å¯¹è±¡ã€‚\n å‚æ•°ï¼š\n  children èŠ‚ç‚¹å­å­™èŠ‚ç‚¹ï¼Œç±»å‹ï¼šTemplateChildNode[]â€‹\n1 2 3 4 5 6 7 8 9 10  export type TemplateChildNode = | ElementNode // èŠ‚å…ƒç´ ç‚¹ç±»å‹  | InterpolationNode // æ’å€¼èŠ‚ç‚¹  | CompoundExpressionNode // æ··åˆè¡¨è¾¾å¼èŠ‚ç‚¹  | TextNode // æ–‡æœ¬èŠ‚ç‚¹  | CommentNode // æ³¨é‡ŠèŠ‚ç‚¹  | IfNode // v-if èŠ‚ç‚¹  | IfBranchNode // v-else, v-else-if åˆ†æ”¯èŠ‚ç‚¹  | ForNode // v-ofr èŠ‚ç‚¹  | TextCallNode // ???       loc ä¸€ä¸ª SourceLoation ç±»å‹çš„ç»“æ„ï¼Œé»˜è®¤å€¼ä¸º locStub\n1 2 3 4 5  export const locStub: SourceLocation = { source: \u0026#39;\u0026#39;, start: { line: 1, column: 1, offset: 0 }, end: { line: 1, column: 1, offset: 0 } }      ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  export function createRoot( children: TemplateChildNode[], loc = locStub ): RootNode { return { type: NodeTypes.ROOT, children, helpers: [], components: [], directives: [], hoists: [], imports: [], cached: 0, temps: 0, codegenNode: undefined, loc } }      ","permalink":"https://www.cheng92.com/vue/vue3-source-code-compiler-core-ast_ts/","tags":["vue,","vue3,","vuenext,","compiler"],"title":"Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 2: ast.ts"},{"categories":["vue"],"contents":"  window.g_need_fold = 1   è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚\n  æ–‡å­—æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³çœ‹æ–‡å­—å¯ç›´æ¥è½¬åˆ°è¿™é‡Œçœ‹è„‘å›¾\n  ç”±äº compile å’Œ transform å…³è”æ€§æ¯”è¾ƒå¼ºè¿™é‡Œå°†æ”¾åœ¨ä¸€èµ·å»å®Œæˆã€‚ \nå‡†å¤‡å·¥ä½œ  è¦å®Œæˆè¿™ä¸€éƒ¨åˆ†ï¼Œé¦–å…ˆè¦äº†è§£å®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ\n åœ¨ parse.ts æ–‡ä¸­æˆ‘ä»¬å®Œæˆäº†è§£æå™¨çš„éƒ¨åˆ†ï¼Œä½œç”¨æ˜¯å°†æ¨¡æ¿è§£ææˆ AST å¯¹è±¡ã€‚\n åœ¨è¿™é‡Œ compile.ts ä½œç”¨å°±æ˜¯å°†è¿™äº› AST å¦‚ä½•ç¿»è¯‘æˆ render å‡½æ•°ã€‚\n ä¸ºäº†æ›´ç›´è§‚çš„ä½“éªŒ compile çš„ä½œç”¨ï¼Œåœ¨ vue æºç é‡Œé¢æœ‰ä¸€ä¸ªæ‰“åŒ…ä¹‹åçš„ç›®å½•ï¼š\n /vue-next/packages/vue/dist/vue.global.js\n ç„¶åæˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ¨¡æ¿ï¼Œå»ç¼–è¯‘ä¸‹çœ‹çœ‹ç»“æœï¼š\n1 2 3 4 5 6 7 8  const source = ` \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;template v-else\u0026gt;no\u0026lt;/template\u0026gt; \u0026lt;div v-for=\u0026#34;(value, index) in list\u0026#34;\u0026gt;\u0026lt;span\u0026gt;{{ value + index }}\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; `.trim(),     è¿›è¡Œç¼–è¯‘(å®Œæ•´ç¤ºä¾‹)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  \u0026lt;script src=\u0026#34;./vue.global.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; console.log(Vue, \u0026#34;00\u0026#34;); const { compile } = Vue; const result = compile( ` \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;template v-else\u0026gt;no\u0026lt;/template\u0026gt; \u0026lt;div v-for=\u0026#34;(value, index) in list\u0026#34;\u0026gt;\u0026lt;span\u0026gt;{{ value + index }}\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; `.trim(), { sourceMap: true, filename: \u0026#34;foo.vue\u0026#34; } ); console.log(result, \u0026#34;xx\u0026#34;); \u0026lt;/script\u0026gt;     è¿è¡Œä¹‹å result ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95  (function anonymous() { const _Vue = Vue; const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode, } = _Vue; const _hoisted_1 = { key: 0 }; // è¿™é‡Œ v-if ... else é‡Œé¢çš„ \u0026lt;template\u0026gt;no\u0026lt;/template\u0026gt; ï¼Ÿ  // åˆ›å»ºæ–‡æœ¬è™šæ‹ŸèŠ‚ç‚¹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆç›´æ¥åœ¨ render å¤–å°±æ‰§è¡Œäº†ï¼Ÿï¼Ÿï¼Ÿ  // åˆæ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿï¼Ÿï¼Ÿ  const _hoisted_2 = _createTextVNode(\u0026#34;no\u0026#34;); // ç¥çº§å‡½æ•° \u0026gt;\u0026gt;\u0026gt; render  return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode, Fragment: _Fragment, renderList: _renderList, } = _Vue; return ( _openBlock(), _createBlock( \u0026#34;div\u0026#34;, { // è§£æå‡ºæ¥çš„ div å±æ€§ï¼Œ id å’Œ class  // parseAttribute çš„ç»“æœ  id: \u0026#34;foo\u0026#34;, // æ³¨æ„è¿™é‡Œæ˜¯å­—ç¬¦ä¸²  class: bar.baz, // è¿™é‡Œæ˜¯å˜é‡å½¢å¼å­˜åœ¨ï¼Œå› ä¸ºç”¨åˆ°äº† :class å±äºæŒ‡ä»¤è§£æ  }, [ // è¿™é‡Œæ˜¯å­©å­èŠ‚ç‚¹ä»¬  // 1. ç¬¬ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œæ’å€¼  _createTextVNode( // æ’å€¼é‡Œé¢çš„å†…å®¹è°ƒç”¨è½¬æ¢æˆæ–‡æœ¬  _toDisplayString(world.burn()) + \u0026#34; \u0026#34;, 1 /* TEXT */ ), // 2. ç¬¬äºŒä¸ªå­©å­èŠ‚ç‚¹ v-if...v-else  // v-if æŒ‡ä»¤ï¼Œå‚æ•°æ˜¯ ok  // ç„¶åè¿™é‡Œåˆæ˜¯æ€ä¹ˆåšåˆ° ok ? ... : ...  // æŒ‡ä»¤è§£æçš„æ—¶å€™ v-if çš„å¤„ç†åˆæ˜¯æ€ä¹ˆåšçš„ï¼Œtransform/vIf ???  // ç›¸é‚»çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ£€æµ‹æ˜¯å¦æ˜¯ v-if æŒ‡ä»¤ç°‡ï¼Ÿï¼Ÿï¼Ÿ  // åˆ°åº•çœŸç›¸å¦‚ä½• ???  ok // åˆ›å»º div  ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) // åˆ›å»º template  : (_openBlock(), _createBlock( _Fragment, { key: 1 }, // æå‰è¢«è§£æå‡ºæ¥çš„ template -\u0026gt; no æ–‡æœ¬èŠ‚ç‚¹  // éš¾é“æ˜¯æå‰éå†ï¼Ÿï¼Ÿï¼Ÿå°†æ‰€æœ‰çš„ template å¦‚æœæ˜¯  // é™æ€çš„å°±å…ˆå…¨éƒ¨åˆ›å»ºå‡ºæ¥ï¼Ÿï¼Ÿï¼Ÿ  [_hoisted_2], 64 /* STABLE_FRAGMENT */ )), // 3. ç¬¬ä¸‰ä¸ªå­©å­èŠ‚ç‚¹ï¼Œdiv v-for  (_openBlock(true), _createBlock( _Fragment, null, // æ¸²æŸ“åˆ—è¡¨  _renderList(list, (value, index) =\u0026gt; { return ( _openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ _createVNode( \u0026#34;span\u0026#34;, null, _toDisplayString(value + index), 1 /* TEXT */ ), ]) ); }), 256 /* UNKEYED_FRAGMENT */ )), ], 2 /* CLASS */ ) ); } }; });     è¯¸å¤šçš„ç–‘é—®ç­‰ç€å»è§£ç­”ï¼ï¼ï¼\n ä½†è‡³å°‘æœ‰ä¸€ç‚¹å¾ˆæ¸…æ™°çš„çŸ¥é“ï¼Œcompile å°±æ˜¯å°† AST ç¼–è¯‘æˆ render å‡½æ•°ç”¨çš„ã€‚\n çŸ¥é“äº†æœ€ç»ˆç›®çš„ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¼«é•¿çš„æ¢ç´¢ä¹‹è·¯äº† ğŸƒ ğŸƒ ğŸƒ\n æ„é€ æ•°æ®ï¼Œè§‚å¯Ÿæœ€ç»ˆç”Ÿæˆçš„ VNode ç»“æ„(ä¸Šé¢ä»£ç æ‰§è¡Œä¹‹åç»“æœè¿”å›ç»™ resultï¼Œå…¶å®å°± æ˜¯ render å‡½æ•°):\n1 2 3 4 5 6 7 8 9 10  result({ list: [1,2,3], ok: true, bar: { baz: \u0026#39;xx\u0026#39; }, world: { burn() {} } })     ä¼ é€’ä¸€äº›å‚æ•°è°ƒç”¨ä¹‹åç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  {_isVNode: true, type: \u0026#34;div\u0026#34;, props: {â€¦}, key: null, ref: null, â€¦} anchor: null appContext: null // ä¸‰ä¸ªå­©å­èŠ‚ç‚¹  children: Array(3) 0: {_isVNode: true, type: Symbol(Text), props: null, key: null, ref: null, â€¦} 1: {_isVNode: true, type: \u0026#34;div\u0026#34;, props: {â€¦}, key: 0, ref: null, â€¦} 2: {_isVNode: true, type: Symbol(Fragment), props: null, key: null, ref: null, â€¦} length: 3 component: null dirs: null // ä¸‰ä¸ªåŠ¨æ€å­©å­èŠ‚ç‚¹  dynamicChildren: Array(3) 0: {_isVNode: true, type: Symbol(Text), props: null, key: null, ref: null, â€¦} 1: {_isVNode: true, type: \u0026#34;div\u0026#34;, props: {â€¦}, key: 0, ref: null, â€¦} 2: {_isVNode: true, type: Symbol(Fragment), props: null, key: null, ref: null, â€¦} length: 3 dynamicProps: null el: null key: null patchFlag: 2 // å±æ€§  props: {id: \u0026#34;foo\u0026#34;, class: \u0026#34;xx\u0026#34;} ref: null scopeId: null shapeFlag: 17 suspense: null target: null targetAnchor: null transition: null // æ ‡ç­¾  type: \u0026#34;div\u0026#34; // æ ‡è¯†ä¸ºè™šæ‹ŸèŠ‚ç‚¹  _isVNode: true      compile.spec.ts  ç”±äº compile.spec.ts åŸæ¥åªæœ‰ä¸€ä¸ªç”¨ä¾‹ï¼Œç›¸å¯¹æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä¸åˆ©äºå­¦ä¹ ã€‚\n è¿™é‡Œå°†æ ¹æ® parse.spec.ts å¾ªåºæ¸è¿›çš„å»å®ç° compile + transform çš„åŠŸèƒ½ã€‚\n ä¸‹é¢æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹å‡ä»¥ vue.global.js æ‰“åŒ…ä¹‹åçš„æ–‡ä»¶ï¼Œè¿è¡Œç»“æœä¸ºå‰æï¼š\n1 2 3 4 5 6 7  const test = `simple text`; const result = compile(test.trim(), { sourceMap: true, filename: \u0026#34;foo.vue\u0026#34;, }); console.log(result, \u0026#34;xx\u0026#34;);     é€šè¿‡ä¿®æ”¹ test å€¼æ¥å¾—åˆ°çœŸå®çš„ render å‡½æ•°ã€‚\n å®Œæˆäº† 01-simple text ç”¨ä¾‹ä¹‹åå‘ç°æŒ‰ç…§ parse.spec.ts å¯èƒ½ä¸å¤ªç†æƒ³ï¼Œæ¯•ç«Ÿ parse éƒ¨ åˆ†çš„ç”¨ä¾‹æœ‰ç‚¹å¤šï¼Œå¦‚æœæŒ‰ç…§é‚£ä¸ªæ¥è¿™éƒ¨åˆ†ä¹Ÿå°†ä¼šå¾ˆæ¼«é•¿ï¼Œæ€è€ƒè‰¯ä¹…åº”è¯¥è¿˜æ˜¯æŒ‰ç…§ compile.spec.ts ä¸­çš„ç”¨ä¾‹è¿›è¡Œæ‹†åˆ†ä¹‹åå³ç®€å…¥éš¾å¼å»é€šè¿‡è¯¥ç”¨ä¾‹ã€‚\n å®Œæ•´ç”¨ä¾‹ï¼š\n1 2 3 4 5 6 7 8  const source = ` \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;template v-else\u0026gt;no\u0026lt;/template\u0026gt; \u0026lt;div v-for=\u0026#34;(value, index) in list\u0026#34;\u0026gt;\u0026lt;span\u0026gt;{{ value + index }}\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; `.trim()    01-simple text   compiledï¼š\n1 2 3 4 5 6 7 8 9  (function anonymous( ) { return function render(_ctx, _cache) { with (_ctx) { return \u0026#34;simple text\u0026#34; } } })     ä¹Ÿå°±æ˜¯è¯´ \u0026#34;simple text\u0026#34; æœ€åè½¬å˜æˆçš„ render å‡½æ•°å¦‚ä¸Šæ‰€ç¤ºã€‚\n æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥å°±æ˜¯å¦‚ä½•æ¥å®ç° compile å’Œ transform èƒ½å¾—åˆ°è¿™æ ·çš„ç»“æœï¼Œè¿™å°†æ˜¯è¯¥æ¨¡å—å®Œ æˆç¬¬ä¸€æ­¥ ğŸ†™ ğŸ†™ ğŸ†™ ğŸ†™ ğŸ†™ ğŸ†™ ğŸ†™ ğŸ†™ ğŸ†™ ğŸ†™\n parse ä¹‹åçš„ ast:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  {type: 0, children: Array(1), loc: {â€¦}, helpers: Array(0), components: Array(0), â€¦} cached: 0 children: Array(1) 0: content: \u0026#34;simple text\u0026#34; loc: {start: {â€¦}, end: {â€¦}, source: \u0026#34;simple text\u0026#34;} type: 2 length: 1 codegenNode: undefined components: [] directives: [] helpers: [] hoists: [] imports: [] loc: {start: {â€¦}, end: {â€¦}, source: \u0026#34;simple text\u0026#34;} temps: 0 type: 0     åœ¨å®Œæˆ transformText ä¹‹åï¼Œå‘ç° result.code æ˜¯ç©ºçš„ï¼Œè¿˜ä»¥ä¸ºæ˜¯è¿™é‡Œé¢å®ç°é—®é¢˜çš„ï¼Œå…¶ å®æ˜¯ generate å‡½æ•°è¿˜æ²¡å®ç°çš„åŸå› ã€‚\n æ‰€æœ‰éœ€è¦æ”¯æŒçš„å‡½æ•°éƒ½å®Œæˆä¹‹åï¼š\n{ast: {â€¦}, code: \u0026#34;function render(_ctx, _cache) {â†µ with (_ctx) {â†µ return \u0026#34;simple text\u0026#34;}}\u0026#34;, map: \u0026#34;\u0026#34;} ast: {type: 0, children: Array(1), loc: {â€¦}, helpers: Array(0), components: Array(0), â€¦} code: \u0026#34;function render(_ctx, _cache) {â†µ with (_ctx) {â†µ return \u0026#34;simple text\u0026#34;}}\u0026#34; map: \u0026#34;\u0026#34;   ä¼šå‘ç°æœ€ç»ˆçš„ code å³æˆ‘ä»¬æƒ³è¦çš„ render å‡½æ•°ï¼Œå’Œç”¨ vue.global.js ç”Ÿæˆçš„ä¸€è‡´ã€‚\n å¦‚æœéœ€è¦å°†è½¬æˆå‡½æ•°ï¼Œè¿™ä¸ªéœ€è¦ç”¨åˆ° compileToFunction è¿™ä¸ªä¸åœ¨æˆ‘ä»¬è¿™ä¸ªè®¨è®ºèŒƒå›´ï¼Œå…¶ å®é‡Œé¢ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨ new Function(code) å°±è¡Œäº†ï¼Œæ¥çœ‹ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10  import { baseCompile as compile } from \u0026#34;../compile.js\u0026#34;; const source = `simple text`.trim(); const result = compile(source, { sourceMap: true, filename: `foo.vue`, }); const render = new Function(result.code); console.log(render, \u0026#34;compiled\u0026#34;);     è¾“å‡ºï¼š\nÆ’ anonymous( ) { function render(_ctx, _cache) { with (_ctx) { return \u0026#34;simple text\u0026#34;}} } \u0026#34;compiled\u0026#34;   ç„¶åä¼šå‘ç°ç»“æœå¥½åƒä¸å¤ªå¯¹ï¼Œé¦–å…ˆ render ä¼šè¢«ä¸€ä¸ªåŒ¿åå‡½æ•°åŒ…èµ·æ¥ï¼Œè¿™ä¸ªæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½† æ˜¯è²Œä¼¼åŒ¿åå‡½æ•°æ²¡æœ‰ç»“æŸçš„ } è¿™ä¸ªæˆ‘æƒ³é—®é¢˜è‚¯å®šå¤„åœ¨äº† generate é‡Œé¢ã€‚\n å…¶å®æ˜¯å› ä¸º createCodgenContext é‡Œé¢çš„ å‡½æ•°æ²¡æœ‰å®ç°ï¼Œå¦å¤–è¿™æ ·æ˜¯ä¸å¯¹çš„ï¼Œå› ä¸º new Function(code) ä¼šå°† code ç”¨ä¸€ä¸ªåŒ¿åå‡½æ•°æ¥åŒ…è£¹èµ·æ¥ï¼Œå› æ­¤æƒ³è¦å¾—åˆ° render å‡½æ•°ï¼Œå¿… é¡»æ˜¯ä»¥ return å½¢å¼è¿”å›ï¼Œå› æ­¤è¿™é‡Œè¿˜æœ‰ä¸ªé—æ¼çš„åœ°æ–¹: genFunctionPreamble éœ€è¦å»å® ç°ï¼Œè¿™é‡Œé¢æœ€åä¼š push ä¸€ä¸ª return åˆ° code å¼€å¤´ã€‚\n æ›´æ–°åè¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 9  Æ’ anonymous( ) { return function render(_ctx, _cache) { with (_ctx) { return \u0026#34;simple text\u0026#34; } } }     åœ¨å®ç° genFunctionPreamble ä¹‹åï¼Œè‡³æ­¤å®Œæˆäº†ä¸€ä¸ªå¾—åˆ° render å‡½æ•°çš„å®Œæ•´è¿‡ç¨‹ã€‚\n ä¸‹é¢å°†ä½¿ç”¨æµç¨‹å›¾æ–¹å¼è¿›è¡Œå›é¡¾ï¼Œåˆ†ææ•´ä¸ªè¿‡ç¨‹ã€‚\n   02-pure interpolation ç¬¬ä¸€ä¸ªå­©å­èŠ‚ç‚¹   {{ world.burn() }}\n æµ‹è¯•ï¼š\n1 2 3 4 5 6 7  const test01 = `{{ world.burn() }}`; const result = compile(test01.trim(), { sourceMap: true, filename: \u0026#34;foo.vue\u0026#34;, }); console.log(result, \u0026#34;xx\u0026#34;);     vue.global ç»“æœï¼š\n1 2 3 4 5 6 7  Æ’ render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString } = _Vue return _toDisplayString(world.burn()) } }     01-simple text é˜¶æ®µä»£ç è¿”å›çš„ç»“æœ:\n1 2 3 4 5  Æ’ render(_ctx, _cache) { with (_ctx) { return // è¿™é‡Œæ²¡ä»»ä½•ä¸œè¥¿  } }     é€šè¿‡ç”¨ä¾‹ 01 å¤§æ¦‚çš„å®Œæˆäº†ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œè¦é€šè¿‡è¯¥ç”¨ä¾‹åº”è¯¥åªéœ€è¦åœ¨è¿™è¿‡ç¨‹ä¸­å¢ åŠ å¯¹æ’å€¼çš„å¤„ç†å³å¯ã€‚\n å¤„ç†æ­¥éª¤(é€šè¿‡ç”¨ä¾‹ 01 æ€»ç»“å‡ºçš„æ­¥éª¤)ï¼š\n baseCompile -\u0026gt; baseParse -\u0026gt; getBaseTransformPreset å¾—åˆ° transform å‡½æ•° -\u0026gt; transform -\u0026gt; generate\n  baseParse -\u0026gt; ast\n  getBaseTransformPreset -\u0026gt; è¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆ transformInterpolationï¼Œæ’å€¼å¹¶æ²¡æœ‰ å¯¹åº”çš„ transform å‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ generate ä¸­ç»“åˆ ast.helpers å¤„ç†ã€‚\n  transform -\u0026gt; createTransformContext -\u0026gt; traverseNode -\u0026gt; createRootCodegen -\u0026gt; â€¦\n è¿™ä¸€æ­¥éœ€è¦å¤„ç†çš„åº”è¯¥åªæœ‰ traverseNode éœ€è¦ä¿®æ”¹ï¼Œåœ¨ switch é‡Œå¢åŠ  INTERPOLATION åˆ†æ”¯ï¼Œå› ä¸º createRootCodegen é‡Œé¢ root å¦‚æœåªæœ‰ä¸€ä¸ªå­©å­çš„æƒ…å†µ ä¸‹ä¼šå’Œç”¨ä¾‹ 01 ä¸€æ ·ç›´æ¥èµ‹å€¼ context.codegenNode = root.children[0]\n  generate -\u0026gt; createCodegenContext -\u0026gt; genFunctionPreamble é»˜è®¤æ˜¯ function æ¨¡ å¼ -\u0026gt; push function render(_ctx, _cache) { -\u0026gt; push with (_ctx) -\u0026gt; â€¦ -\u0026gt; genNode(ast.codegenNode, context)\n è¿™é‡Œéœ€è¦ä¿®æ”¹çš„ç‚¹åº”è¯¥åªæœ‰ genNode é‡Œé¢ï¼Œä¹Ÿæ˜¯å¢åŠ  INTERPOLATION switch åˆ†æ”¯ï¼Œ å¤„ç†æ’å€¼éƒ¨åˆ†çš„ä»£ç ã€‚\n   æœ‰äº†ä¸Šé¢çš„åˆæ­¥åˆ†æï¼Œè¿™é‡Œå¯ä»¥æ¯”è¾ƒæ˜ç¡®çš„çŸ¥é“éœ€è¦ä¿®æ”¹çš„ç‚¹ï¼š\n  DONE traverseNode ä¸­å¢åŠ  INTERPOLATION åˆ†æ”¯\n  DONE genNode ä¸­å¢åŠ  INTERPOLATION åˆ†æ”¯\n  DONE genNode ä¸­å¢åŠ  SIMPLE_EXPRESSION åˆ†æ”¯å¤„ç†æ’å€¼å†…çš„è¡¨è¾¾å¼\n   ä¿®æ­£ï¼šäº‹å®ä¸Šå¹¶æ²¡æœ‰ transformInterpolation ğŸ¤¦ğŸ¤¦ğŸ¤¦ğŸ¤¦\n ä¿®æ”¹å®Œä¹‹åæŠ¥é”™ï¼š\ntransform.js:184 Uncaught TypeError: Cannot read property \u0026#39;length\u0026#39; of undefined at traverseChildren (transform.js:184) at traverseNode (transform.js:119) at traverseChildren (transform.js:192) at traverseNode (transform.js:119) at transform (transform.js:133) at baseCompile (compile.js:37) at compile.html:12   æ ¹æ®æŠ¥é”™å®šä½åˆ°ï¼Œåœ¨è§£æ root.children[0] çš„æ—¶å€™ç»è¿‡ traverseChildren é‡Œé¢æ—¶å€™çš„ parent.children å€¼ä¸º undefinedã€‚\n åŸå› æ˜¯ traverseNode é‡Œé¢çš„ NodeTypes.INTERPOLATION åˆ†æ”¯æ²¡æœ‰åŠ  break å¯¼è‡´çš„ï¼ŒåŠ ä¸Š ä¹‹åï¼š\n1 2 3 4 5 6 7  Æ’ render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString } = _Vue return } } \u0026#34;compiled\u0026#34;     å’Œæ­£ç¡®ç»“æœç›¸æ¯”å°‘äº†ç‚¹ä¸œè¥¿ return _toDisplayString(world.burn())\n  with å†…çš„è§£æ„æ¥æºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function generate() { // ...  if (hasHelpers) { // æ¯”å¦‚ï¼šæ’å€¼å¤„ç†æ—¶ç”¨åˆ° TO_DISPLAY_STRING helper  // ä¸ºäº†é¿å…å‘½åå†²çªï¼Œè¿™é‡Œéƒ½éœ€è¦å°†ä»–ä»¬é‡å‘½å  // traverseNode é‡Œé¢ context.help(helper)  push( `const { ${ast.helpers .map((s) =\u0026gt; `${helperNameMap[s]}: _${helperNameMap[s]}`) .join(\u0026#34;, \u0026#34;)}} = _Vue` ); push(\u0026#34;\\n\u0026#34;); newline(); } // ...  }      ç¼ºå°‘çš„ return _toDisplayString(world.burn())\n  generate ä¸­æœ€å push `return `\n  æ‰§è¡Œ genNode(ast.codgenNode, context) å¤„ç†ç¼ºå°‘çš„éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9  {type: 5, content: {â€¦}, loc: {â€¦}} content: content: \u0026#34;world.burn()\u0026#34; isConstant: false isStatic: false loc: {start: {â€¦}, end: {â€¦}, source: \u0026#34;world.burn()\u0026#34;} type: 4 // SIMPLE_EXPRESSIONï¼Œç¬¬äºŒæ­¥  loc: {start: {â€¦}, end: {â€¦}, source: \u0026#34;{{ world.burn() }}\u0026#34;} type: 5 // INTERPOLATIONï¼Œç¬¬ä¸€æ­¥       node ç±»å‹é¦–å…ˆæ˜¯ INTERPOLATION ï¼Œè¿›å…¥ genInterpolation(node, context)\n1 2 3 4 5 6 7 8 9 10 11 12  function genInterpolation(node, context) { const { push, helper, pure } = context; if (pure) push(PURE_ANNOTATION); // è¿™é‡Œä» helpers é‡Œé¢å–å‡º toDisplayString  push(`${helper(TO_DISPLAY_STRING)}(`); // è¿™é‡Œç”Ÿæˆ `world.burn()` SIMPLE_EXPRESSION ç±»å‹  genNode(node.content, context); push(`)`); }      å– node.content è°ƒç”¨ genNode(node.content, context) ç”Ÿæˆ `world.burn()` è¡¨è¾¾å¼ã€‚\n è¿›å…¥ switch node.type === NodeTypes.SIMPLE_EXPRESSION åˆ†æ”¯ï¼Œè°ƒç”¨ genExpression(node, context)\n      ğŸŒ» Perfect: æœ€åç»“æœï¼š\n1 2 3 4 5 6 7  Æ’ render(_ctx, _cache) { // generate  with (_ctx) { // useWithBlock  const { toDisplayString : _toDisplayString } = _Vue // ast.helpers  return _toDisplayString(world.burn()) // genNode -\u0026gt; genInterpolation -\u0026gt; genExpression  } } // \u0026#34;compiled\u0026#34;      å®Œæ•´æµç¨‹å›¾ï¼š\n   03-inerpolation in pure div   test:\n1 2 3 4 5 6  const source = `\u0026lt;div\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;`.trim(); const result = compile(source, { sourceMap: true, filename: `foo.vue`, });     vue.global:\n1 2 3 4 5 6 7 8 9 10 11 12  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, _toDisplayString(world.burn()), 1 /* TEXT */)) } } })     å…ˆé˜¶æ®µçš„ç»“æœï¼š\n1 2 3 4 5  Æ’ render(_ctx, _cache) { with (_ctx) { return } } \u0026#34;compiled\u0026#34;     æµç¨‹å›¾ï¼š  æµç¨‹åˆ†æï¼š\n  baseParse(template, options) è§£æå‡º ast\n  transform(ast, â€¦) é€’å½’éå†å¤„ç† root.children ç”Ÿæˆå„èŠ‚ç‚¹çš„ codegenNode\n  traverseNode(root, context) æ ¸å¿ƒå‡½æ•°ï¼Œç»“åˆ traverseChildren é€šè¿‡éå†+é€’å½’ å¤„ç†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ”¶é›†å¯¹åº”çš„ transform* å‡½æ•°ï¼Œåœ¨ç»“æŸé€’å½’ä¹‹åå›æº¯è¿‡ç¨‹ä¸­æ‰§è¡Œè¿™äº› transform* æ¥æ”¶é›†èŠ‚ç‚¹å¯¹åº”çš„ codegenNode\n  éå†æ‰€æœ‰çš„ nodeTrasforms[] æ¥æ”¶é›†å½“å‰èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶çš„ transform* å‡½æ•° åˆ° exitFns[] ä¸­ï¼Œæ¯”å¦‚ï¼š è¿™é‡Œçš„ ELEMENT ç±»å‹(\u0026lt;div\u0026gt;\u0026lt;/div\u0026gt;)ä¼šæ”¶é›†åˆ° transformElement å’Œ transformText ã€‚\n  NodeTypes.ROOT è¿›å…¥ traverseChildren(node, context) ç»§ç»­å¤„ç† root.children ï¼Œè¿™é‡ŒåŒæ—¶ä¼šè®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„ parent å€¼ï¼ŒROOT ç±»å‹æ”¶é›† transformText ã€‚\n  NodeTypes.ELEMENT ä¹Ÿä¼šè¿›å…¥åˆ° traverseChildren(node, context) å¤„ç† node.children ï¼Œèµ‹å€¼ parent, æ”¶é›† transformText å’Œ transformElement ã€‚\n  NodeTypes.INTERPOLATION å¯¹äºæ’å€¼èŠ‚ç‚¹ï¼Œä¸ä¼šè¿›å…¥ traverseChildren è€Œæ˜¯åœ¨ switch åˆ†æ”¯ä¸­è°ƒç”¨ context.helper() å»æ›´æ–° context.helpers ç”¨æ¥ä» Vue ä¸­ è§£æ„å‡ºéœ€è¦çš„å‡½æ•°ã€‚\n    TODO hoistStatic(root, context) é™æ€æå‡ç”¨çš„ï¼Œé’ˆå¯¹é™æ€èŠ‚ç‚¹æå‡åˆ°å‡½æ•°å¤–é¢(è¿™é‡Œæš‚ æ—¶æœªæ·±å…¥ï¼Œæ²¡ç”¨åˆ°)\n  createRootCodegen(root, context) ç”Ÿæˆ root.codegenNode ï¼Œæœ‰å¯èƒ½æ˜¯æ¥è‡ªç¬¬ä¸€ ä¸ªä¸”å”¯ä¸€ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œåˆ†ä¸ºä¸¤ä¸ªåˆ†æ”¯å…·ä½“ç»†èŠ‚ç‚¹å‡»å‡½æ•°é“¾æ¥ã€‚\n  ç»è¿‡ transform å¤„ç†ä¹‹åçš„ ast å¯¹è±¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  { // å»æ‰ä¸é‡è¦çš„éƒ¨åˆ†  \u0026#34;type\u0026#34;:0, // ROOT ç±»å‹  \u0026#34;children\u0026#34;:[ { \u0026#34;type\u0026#34;:1, // ELEMENT ç±»å‹  \u0026#34;tag\u0026#34;:\u0026#34;div\u0026#34;, \u0026#34;tagType\u0026#34;:0, // Start  \u0026#34;children\u0026#34;:[ { \u0026#34;type\u0026#34;:5, // INTERPOLATION  \u0026#34;content\u0026#34;:{ \u0026#34;type\u0026#34;:4, // SIMPLE_EXPRESSION  \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;world.burn()\u0026#34;, }, } ], \u0026#34;codegenNode\u0026#34;:{ // è¿™é‡Œå®é™…ä¸Šæ˜¯ root.children[0] ç»è¿‡ transformElement ä¹‹åçš„ç»“æœ  // å˜æˆäº†VNODE_CALL åœ¨ codegen-generate å¤„ç†éƒ¨åˆ†ä¼šç”¨åˆ°  \u0026#34;type\u0026#34;:13, // VNODE_CALL  \u0026#34;tag\u0026#34;:\u0026#34;\u0026#34;div\u0026#34;\u0026#34;, \u0026#34;children\u0026#34;:{ \u0026#34;type\u0026#34;:5, // INTERPOLATION  \u0026#34;content\u0026#34;:{ \u0026#34;type\u0026#34;:4, // SIMPLE_EXPRESSION  \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;world.burn()\u0026#34;, }, }, \u0026#34;patchFlag\u0026#34;:\u0026#34;1 /* TEXT */\u0026#34;, // è¿™ä¸ªç›®å‰ä¸çŸ¥é“å¹²å•¥çš„  \u0026#34;isBlock\u0026#34;:true, // å†³å®šä½¿ç”¨ openBlock/createBlock, è¿˜æ˜¯ createVNode  \u0026#34;isForBlock\u0026#34;:false, } } ], \u0026#34;codegenNode\u0026#34;:{ // root æ ¹èŠ‚ç‚¹çš„  // åœ¨ createRootCodegen ä¸­æœ‰ä¸ªå¤„ç†æ˜¯ï¼Œå¦‚æœroot.children æœ‰ä¸”åªæœ‰ä¸€ä¸ª  // ELEMENT ç±»å‹çš„èŠ‚ç‚¹çš„æ—¶å€™ï¼Œroot.codegenNode ä¼šè¢«è¿™ä¸ªèŠ‚ç‚¹çš„ codegenNode  // è¦†ç›–ï¼Œå³root ä½¿ç”¨å®ƒå”¯ä¸€çš„å­©å­èŠ‚ç‚¹çš„ codegenNode  \u0026#34;type\u0026#34;:13, // VNODE_CALL  \u0026#34;tag\u0026#34;:\u0026#34;\u0026#34;div\u0026#34;\u0026#34;, \u0026#34;children\u0026#34;:{ \u0026#34;type\u0026#34;:5, \u0026#34;content\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;content\u0026#34;:\u0026#34;world.burn()\u0026#34;, }, }, \u0026#34;patchFlag\u0026#34;:\u0026#34;1 /* TEXT */\u0026#34;, \u0026#34;isBlock\u0026#34;:true, \u0026#34;isForBlock\u0026#34;:false, }, }      generate(ast, â€¦) ç”Ÿæˆä»£ç ç‰‡æ®µ -\u0026gt; new Function(context.code)\n  genFunctionPreamble(ast, context) ä¸»è¦ä½¿ç”¨æ¥æ£€æµ‹ç¯å¢ƒä»è€Œå¯¼å…¥ Vue å®ä¾‹ (å¦‚ï¼š~const _Vue = Vue~)ï¼Œæœ€å render å‡½æ•°çš„ `return ` ä¹Ÿæ˜¯è¿™é‡Œç”Ÿæˆçš„ã€‚\n  genNode(ast.codegenNode, context) å¯¹æ¯ä¸ª ast èŠ‚ç‚¹ç»“æ„è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆå¯¹åº”çš„ Render å‡½æ•°ç›¸å…³éƒ¨ä»¶ã€‚\n  genVNodeCall(node, context) ç”ŸæˆèŠ‚ç‚¹çš„å‚æ•°ï¼Œè°ƒç”¨å‡½æ•°ä¹‹ç±»çš„ï¼Œå¦‚ï¼š openBlock() , createBlock(...) åŠå‚æ•°åˆ—è¡¨ createBlock(tag, props, children, patchFlag, ...) ï¼ŒæŒ‡ä»¤ç­‰éƒ¨ä»¶ã€‚\n  patchFlag æ˜¯åœ¨ transformElement é‡Œé¢å¤„ç†å€¼çš„ã€‚\n ç»è¿‡ generate ä¹‹åç”Ÿæˆçš„ render å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, _toDisplayString(world.burn()), 1 /* TEXT */)) } } })     render({ world: { burn() { return `burn the world !` }}}) æ‰§è¡Œä¹‹åå¾—åˆ°çš„ VNode èŠ‚ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  { \u0026#34;_isVNode\u0026#34;:true, \u0026#34;type\u0026#34;:\u0026#34;div\u0026#34;, \u0026#34;props\u0026#34;:null, \u0026#34;key\u0026#34;:null, \u0026#34;ref\u0026#34;:null, \u0026#34;scopeId\u0026#34;:null, \u0026#34;children\u0026#34;:\u0026#34;burn the world !\u0026#34;, \u0026#34;component\u0026#34;:null, \u0026#34;suspense\u0026#34;:null, \u0026#34;dirs\u0026#34;:null, \u0026#34;transition\u0026#34;:null, \u0026#34;el\u0026#34;:null, \u0026#34;anchor\u0026#34;:null, \u0026#34;target\u0026#34;:null, \u0026#34;targetAnchor\u0026#34;:null, \u0026#34;shapeFlag\u0026#34;:9, \u0026#34;patchFlag\u0026#34;:1, \u0026#34;dynamicProps\u0026#34;:null, \u0026#34;dynamicChildren\u0026#34;:[ ], \u0026#34;appContext\u0026#34;:null }          04-interpolation in div with props   code: `\u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;`\n è¿™ä¸ªç”¨ä¾‹å’Œ ç”¨ä¾‹3 åªæœ‰ä¸€ä¸ªå±æ€§çš„å·®åˆ«ï¼Œæ‰€ä»¥è¿™é‡Œåªè¦å‚è€ƒ test 03 æ¥å®ç° div å±æ€§çš„ è§£æå’Œç¼–è¯‘å³å¯ï¼Œæ‰€æœ‰æµç¨‹å’Œæµç¨‹å›¾å¯å‚è€ƒ 03 æ¥å®ç°ã€‚\n è¿˜æ˜¯è€æ–¹æ³•ï¼Œæ ¹æ®è·Ÿè¸ª vue.global debugger è¿‡ç¨‹æ¥åˆ†ææ•´ä¸ªè¿‡ç¨‹ã€‚ æœŸå¾…ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  (function anonymous( ) { const _Vue = Vue return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz }, _toDisplayString(world.burn()), 3 /* TEXT, CLASS */)) } } })     createStructuralDirectiveTransform(name, fn) å¦‚æœå­˜åœ¨å±æ€§ï¼Œéƒ½ä¼šç»è¿‡è¿™ä¸ªå‡½æ•°æ˜¯å›  ä¸º if,else-if,else,for çš„ transform éƒ½æ˜¯é€šè¿‡è¿™ä¸ªåˆ›å»ºçš„ï¼Œæ‰€ä»¥åœ¨ç»è¿‡ traverseNode ä¸­çš„ exitFns æ”¶é›†è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œåˆ°è¿™é‡Œã€‚\n ç„¶åè¿™ä¸ªç”¨ä¾‹ä¸­å¹¶æ²¡æœ‰ v-if, v-for ç±»ä¼¼çš„åˆ†æ”¯æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™äº› transform* ä¸ä¼šè¢«æ”¶é›† åˆ°ã€‚\n root.children[0]: div æ”¶é›† transformElement ï¼ŒELEMENT ç±»å‹éœ€è¦æ”¶é›†æ¥è§£æå‡º codegenNodeã€‚\n  æµç¨‹å›¾åˆ†æï¼šè¿™é‡Œå’Œ 03 å¯¹æ¯”å¤šäº†ä¸¤éƒ¨åˆ†å¤„ç†\n  transform é˜¶æ®µçš„ props è§£æ\n è¿™ä¸€é˜¶æ®µçš„å¤„ç†å‘ç”Ÿåœ¨ transformElement ä¸­å¯¹ props å±æ€§çš„æ£€æµ‹ï¼Œä¸€æ—¦æ£€æµ‹åˆ°æœ‰å±æ€§ åˆ—è¡¨ï¼Œéœ€è¦ç»è¿‡ buildProps è§£æå‡ºæ–°çš„å±æ€§å¯¹è±¡:\n buildProps ä¹‹å‰çš„ props\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  props: Array(2) 0: // å±æ€§ id  loc: {..., source: \u0026#34;id=\u0026#34;foo\u0026#34;\u0026#34;} name: \u0026#34;id\u0026#34; type: 6 // ATTRIBUTE  value: content: \u0026#34;foo\u0026#34; loc: {..., source: \u0026#34;\u0026#34;foo\u0026#34;\u0026#34;} type: 2 // TEXT  1: // å±æ€§ :class  arg: content: \u0026#34;class\u0026#34; isConstant: true isStatic: true loc: {..., source: \u0026#34;class\u0026#34;} type: 4 // SIMPLE_EXPRESSION  exp: content: \u0026#34;bar.baz\u0026#34; isConstant: false isStatic: false loc: {..., source: \u0026#34;bar.baz\u0026#34;} type: 4 // SIMPLE_EXPRESSION  loc: {..., source: \u0026#34;:class=\u0026#34;bar.baz\u0026#34;\u0026#34;} modifiers: [] name: \u0026#34;bind\u0026#34; type: 7 // DIRECTIVE      buildProps è§£æä¹‹åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  Return value: Object directives: [] dynamicPropNames: [] patchFlag: 2 // CLASS  props: properties: Array(2) 0: key: {type: 4, isConstant: false, content: \u0026#34;id\u0026#34;, isStatic: true} type: 16 // JS_ARRAY_EXPRESSION  value: {type: 4, isConstant: false, content: \u0026#34;foo\u0026#34;, isStatic: true} 1: key: {type: 4, content: \u0026#34;class\u0026#34;, isStatic: true, isConstant: true}} type: 16 value: {type: 4, content: \u0026#34;bar.baz\u0026#34;, isStatic: false, isConstant: false, type: 15 // JS_PROPERTY      è¿™é‡Œé¢çš„å¤„ç†åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š 1. ATTRIBUTE\u0026lt;6\u0026gt; ç±»å‹ï¼Œ 2. DIRECTIVE\u0026lt;7\u0026gt; æŒ‡ä»¤ç±»å‹æ˜¯ åˆ†å¼€å¤„ç†çš„ï¼Œæ™®é€šå±æ€§è°ƒç”¨ createObjectProperty(key, value) æ„å»ºæ–°çš„å¯¹è±¡ï¼ŒæŒ‡ ä»¤å±æ€§é€šè¿‡æŒ‡ä»¤åç§°ä» context.directiveTransforms å¯¹è±¡ä¸­å–å‡ºå¯¹åº”çš„å‡½æ•°è¿›è¡Œå¤„ ç†ï¼Œæ¯”å¦‚ v-bind å¯¹åº”å‡½æ•° transformBind(prop, node, context) å¤„ç†ã€‚\n æ¯”å¦‚ï¼š id=\u0026#34;foo\u0026#34; å¤„ç†ä¹‹åçš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  Return value: Object key: // å±æ€§å  content: \u0026#34;id\u0026#34; isConstant: false isStatic: true loc: {source: \u0026#34;id\u0026#34;} type: 4 // SIMPLE_EXPRESSION  type: 16 // JS_PROPERTY  value: // å±æ€§å€¼  content: \u0026#34;foo\u0026#34; isConstant: false isStatic: true loc: {source: \u0026#34;\u0026#34;foo\u0026#34;\u0026#34;} type: 4 // SIMPLE_EXPRESSION  // åŒ…å« key, type, value ä¸‰ä¸ªå±æ€§å€¼      æ¯”å¦‚ï¼š :class=\u0026#34;bar.baz\u0026#34; å¤„ç†ä¹‹åçš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  Return value: Object props: Array(1) 0: key: content: \u0026#34;class\u0026#34; isConstant: true isStatic: true type: 4 // SIMPLE_EXPRESSION  type: 16 // JS_ARRAY_EXPRESSION  value: content: \u0026#34;bar.baz\u0026#34; isConstant: false isStatic: false type: 4 // åŒ…å« key, type, valueï¼Œå’Œæ™®é€šå±æ€§ç±»å‹ä¸ä¸€æ ·  // è¿™é‡Œæ˜¯ JS_ARRAY_EXPRESSION       generate é˜¶æ®µçš„ props è§£æ\n render å‡½æ•°ç”Ÿæˆé˜¶æ®µï¼Œ genVNodeCall è§£æ codegenNode, å…¶ä¸­æœ‰ä¸€ä¸ª genNodeList(nodes, â€¦) è¿™é‡Œçš„ nodes æ˜¯ [tag, props, children, patchFlag, ...] è¯¥ç”¨ä¾‹ä¸­ç›¸æ¯”ç”¨ä¾‹03 è¿™é‡Œçš„ props ä¸æ˜¯ null ï¼Œæ‰€ä»¥åœ¨ genNodeList ä¸­ i = 1 çš„æ—¶å€™ä¼šè¿›å…¥åˆ° genNode(props, context) å»è§£æå±æ€§åˆ—è¡¨ã€‚\n è¿›å…¥ä¹‹å‰ props å€¼ï¼š\n1 2 3  loc: {source: \u0026#34;\u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;\u0026#34;} properties: (2) [{â€¦}, {â€¦}] // è¿™é‡Œæ˜¯ id, class ä¸¤ä¸ªå±æ€§  type: 15 // JS_OBJECT_EXPRESSION      ç±»å‹ä¸º JS_OBJECT_EXPRESSION\u0026lt;15\u0026gt; åœ¨ genNode é‡Œé¢ä¼šè¿›å…¥ genObjectExpression(node, context) åˆ†æ”¯å°†å±æ€§è§£ææˆå¯¹è±¡ï¼Œå¦‚ï¼š {id: \u0026#34;foo\u0026#34;, class: bar.baz} ã€‚\n genObjectExpression é‡Œé¢å¯¹å±æ€§çš„å¤„ç†ä¸»è¦åˆ†ä¸¤æ­¥ï¼Œå…ˆè°ƒç”¨ genExpressionAsPropertyKey(node, context) å»å¤„ç†å±æ€§å key nodeï¼Œå®Œæˆä¹‹åï¼Œå†è°ƒ ç”¨ genNode(value, context) å»å¤„ç†å€¼ value node(æœ€åè¿›å…¥ genExpression(node, context), å› ä¸ºç±»å‹ä¸º SIMPLE_EXPRESSION\u0026lt;4\u0026gt;)ã€‚\n æœ€åå¾—åˆ° {id: \u0026#34;foo\u0026#34;, class: bar.baz} ä½œä¸º createBlock(\u0026#39;div\u0026#39;, ...) çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚\n  ä¿®æ”¹å®Œä¹‹åè¿è¡Œç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11  (function anonymous( ) { return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34; }, _toDisplayString(world.burn()), 1 /* TEXT */)) } } })     ç»“æœä¸æ­£ç¡®ç»“æœåˆä¸¤ç‚¹ç¼ºé™·ï¼š\n  å±æ€§æ¼æ‰äº† class\n  patchFlag é‚£é‡Œä¸å¯¹ï¼Œæ­£ç¡®åº”è¯¥æ˜¯ 3 /* TEXT, CLASS */\n  æ²¡æœ‰æŠ¥é”™èƒ½èµ°é€šè¯´æ˜è‡³å°‘é€»è¾‘æ˜¯é€šçš„å‡ºç°ä¸Šé¢ä¸¤ä¸ªé—®é¢˜åŸå› ï¼Œæº¯æºèµ·æ¥ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå› ä¸ºæˆ‘ä»¬ çŸ¥é“ props åœ¨ transform é˜¶æ®µæ˜¯ transformElement é‡Œé¢ï¼Œgenerate é˜¶æ®µæ˜¯åœ¨ genObjectExpression() ä¸­, è€Œ patchFlag ä¹Ÿæ˜¯åœ¨ transformElement å¤„ç†çš„ã€‚\n é€šè¿‡åœ¨ genObjectExpression() for å¾ªç¯ä¸­å¢åŠ æ‰“å°ï¼Œæ˜¾ç¤º properties ä¸­åªæœ‰ä¸€ä¸ª id å±æ€§ï¼Œé‚£ä¹ˆå±æ€§è§£ææœ€åæ˜¯åœ¨ buildProps é‡Œé¢çš„ï¼Œ bingo!!! æ²¡æœ‰å®ç° transformBind ã€‚\n é‚£ä¹ˆä¿®æ”¹ç‚¹æœ‰äºŒï¼š\n  åœ¨ compile.ts çš„ getBaseTransformPreset å¢åŠ æŒ‡ä»¤ transform å‡½æ•° transformBind\n  å®ç° transformBind\n  ä¿®æ”¹ä¹‹åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  (function anonymous( ) { return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz }, _toDisplayString(world.burn()), 3 /* TEXT, CLASS */)) } } })    æ‰©å±• 1ï¼šå¢åŠ  camel ä¿®é¥°ç¬¦   code: `\u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34; :test-prop.camel=\u0026#34;bar.bax\u0026#34;\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;`\n ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  (function anonymous( ) { return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz, testName: bar.bax }, _toDisplayString(world.burn()), 3 /* TEXT, CLASS */)) } } })     å› ä¸º transformBind ä¸­æœ‰æ£€æµ‹ä¿®é¥°ç¬¦ä¸­æ˜¯å¦åŒ…å« camel ï¼Œå¦‚æœæœ‰åˆ™ä¼šè¿›è¡Œé©¼å³°è½¬æ¢ï¼Œå¦ åˆ™ä¸ä¼šè½¬è€Œæ˜¯å°† test-prop ç”¨å¼•å·åŒ…èµ·æ¥ï¼š \u0026#34;test-prop\u0026#34; ã€‚\n  æ‰©å±• 2ï¼šåŠ¨æ€å±æ€§ä¸”æœ‰ camel ä¿®é¥°ç¬¦   code: `\u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34; :[prop_name].camel=\u0026#34;bar.bax\u0026#34;\u0026gt;{{ world.burn() }}\u0026lt;/div\u0026gt;`\n è¿™ä¸ªæ—¶å€™éœ€è¦å®ç° transform.js ä¸­ createTransformContext ä¸­ context.helperString\n1 2 3  helperString(name) { return `_${helperNameMap[context.helper(name)]}`; }     ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  (function anonymous( ) { return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, camelize : _camelize, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz, [_camelize(prop_name)]: bar.bax }, _toDisplayString(world.burn()), 1 /* TEXT */)) } } })     ä¼šå‘ç°è¿™é‡Œå¤šè§£æ„äº†ä¸ª _camelize å‡½æ•°å‡ºæ¥ï¼Œé€šè¿‡å‡½æ•°è°ƒç”¨æ–¹å¼å»å¤„ç†åŠ¨æ€å±æ€§åã€‚\n    05-interpolation, v-if, props  1 2 3 4 5  code = ` \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt;`     å¢åŠ äº† \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\n ast: åœ¨ç»è¿‡ parse.ts ä¹‹ååº”è¯¥å…·å¤‡çœ‹åˆ°æ¨¡æ¿èƒ½å¤Ÿåˆ†æå‡º ast ç»“æ„èƒ½åŠ›ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77  { type: 0, // ROOT  children: [ { // div#foo  type: 1, // ELEMENT  tag: \u0026#39;div\u0026#39;, tagType: 0, // Start  props: [ { // id  type: 6, // ATTRIBUTE  name: \u0026#39;id\u0026#39;, value: { type: 2, // TEXT  content: \u0026#39;foo\u0026#39; } }, { // :class  type: 7, // DIRECTIVE  name: \u0026#39;bind\u0026#39;, arg: { type: 4, // SIMPLE_EXPRESSION  content: \u0026#39;class\u0026#39;, isStatic: true, // é™æ€å‚æ•°å  isConstant: true }, // å‚æ•°å class  exp: { type: 4, // SIMPLE_EXPRESSION  content: \u0026#34;bar.baz\u0026#34;, isStatic: false, isConstant: false }, // è¡¨è¾¾å¼ bar.baz  modifiers: [], // ä¿®é¥°ç¬¦  } ], children: [ { // world.burn  type: 5, // INTERPOLATION  content: { content: \u0026#34;world.burn()\u0026#34;, isStatic: false, isConstant: false, type: 4, // SIMPLE_EXPRESSION  }, }, { // \u0026#34; \u0026#34; ç©º  type: 2, // TEXT  content: \u0026#39; \u0026#39; }, { // div v-if  type: 1, // ELEMENT  tag: \u0026#39;div\u0026#39;, tagType: 0, // Start  children: [ { // yes  type: 2, // TEXT  content: \u0026#34;yes\u0026#34; } ], props: [ { type: 7, // DIRECTIVE  name: \u0026#39;if\u0026#39;, exp: { type: 4, content: \u0026#34;ok\u0026#34;, isStatic: false, isConstant: false }, modifiers: [] } ] } ] }, // div#foo  ], codegenNode: undefined }     vue.global ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  (function anonymous() { const _Vue = Vue; const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode, } = _Vue; const _hoisted_1 = { key: 0 }; return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode, } = _Vue; return ( _openBlock(), _createBlock( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz, }, [ _createTextVNode( _toDisplayString(world.burn()) + \u0026#34; \u0026#34;, 1 /* TEXT */ ), ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true), ], 2 /* CLASS */ ) ); } }; });     è¿™é‡Œæœ‰å‡ ä¸ªä¸åŒç‚¹ï¼š\n  _createBlock ç¬¬ä¸‰ä¸ªå‚æ•° children å˜æˆäº†æ•°ç»„ï¼Œä¸”ä½¿ç”¨äº† _createTextVNode() åˆ›å»º è™šæ‹ŸèŠ‚ç‚¹\n  å°±æ˜¯å¤šäº†ä¸ªæ–°å¢çš„é‚£ä¸ª div v-if èŠ‚ç‚¹\n  patchFlag çš„å˜åŒ–\n   å…ˆçœ‹ä¸‹ä¿®æ”¹ä¹‹å‰çš„ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  (function anonymous() { return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString: _toDisplayString, createVNode: _createVNode, camelize: _camelize, createTextVNode: _createTextVNode, openBlock: _openBlock, createBlock: _createBlock, } = _Vue; return ( _openBlock(), _createBlock( \u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz, [_camelize(prop_name)]: bar.bax, }, [, _createVNode(\u0026#34;div\u0026#34;, null, \u0026#34;yes\u0026#34;)] ) ); } }; });     å·®å¼‚ç‚¹ï¼š\n  æ²¡æœ‰ render å‡½æ•°å¤–çš„è§£æ„\n  æ²¡æœ‰ render å‡½æ•°å¤–çš„ const _hoisted_1 = { key: 0 };\n  æ²¡æœ‰ _createCommentVNode\n  children é‡Œé¢çš„å·®å€¼èŠ‚ç‚¹ä¸¢å¤±äº†\n  div v-if èŠ‚ç‚¹å¤„ç†é”™è¯¯\n  å…ˆè§£å†³å·®å€¼é—®é¢˜(ç¬¬ 4 ç‚¹)ï¼Œè¿™é‡Œæ’å€¼èŠ‚ç‚¹ä¸ºä»€ä¹ˆä¼šä¸¢å¤±ï¼Ÿ\n è¡¥æ¼ï¼š\n  å®ç° transformIf\n createStructuralDirectiveTransform åˆ›å»ºæŒ‡ä»¤(å¦‚ï¼šv-if, v-else ç­‰)ç›¸å…³çš„ transform å‡½æ•°ï¼Œæ³¨æ„è¿™é‡Œçš„æ­£åˆ™ï¼š /^(if|else|else-if)$/\n ç”±äºæŒ‡ä»¤æ˜¯å­˜åœ¨ node.props å±æ€§é‡Œé¢çš„ï¼Œè¿™é‡Œä¼šç›´æ¥éå†æ‰€æœ‰çš„å±æ€§ï¼Œæ‰¾å‡ºæ»¡è¶³æ¡ä»¶ type:DIRECTIVE ä¸” prop.name åŒ¹é…ä¸Šé¢çš„æ­£åˆ™çš„æŒ‡ä»¤ã€‚\n å› ä¸ºè¿™é‡Œè¦å°†æ‰€æœ‰çš„æŒ‡ä»¤è½¬æˆåˆ†æ”¯ç±»å‹çš„ç»“æ„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  { type: 9, // IF  branches: [{ children: [{ /* è¿™é‡Œä¿å­˜äº†è½¬æ¢ä¹‹å‰çš„ v-if èŠ‚ç‚¹ */}] condition: { content: \u0026#39;ok\u0026#39;, // ...  type: 4, // SIMPLE_EXPRESSION  } // branch  type: 10, // IF_BRANCH  }] }     æœ€åå¤„ç†ä¹‹åå¾—åˆ°çš„ ifNode åŒ…å«æ‰€æœ‰åˆ†æ”¯ ifNode.branches ï¼Œ branch å³å½“å‰è¦å¤„ ç†çš„åˆ†æ”¯äº¤ç»™è¿”å›çš„é‚£ä¸ª transform å‡½æ•°å¾…é€’å½’å®Œæˆä¹‹åå–å¤„ç†å¾—åˆ°è¯¥åˆ†æ”¯èŠ‚ç‚¹çš„ codegenNode\n ç„¶åç»è¿‡é€’å½’ä¹‹åï¼Œå›æº¯è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œè¿”å›çš„é‚£ä¸ªå‡½æ•°(transform if) è¿›å…¥ createCodegenNodeForBranch -\u0026gt; createChildrenCodegenNode -\u0026gt; createCallExpression åˆ›å»ºåˆ†æ”¯èŠ‚ç‚¹ codegenã€‚\n  å®ç° traverseNode ä¸­çš„ IF(9) å’Œ IF_BRANCH(10) åˆ†æ”¯\n  å®ç° generate é˜¶æ®µçš„ if èŠ‚ç‚¹å¤„ç†\n ä¿®æ”¹ genNode å¢åŠ  IF, IF_BRANCH, JS_CALL_EXPRESSION, JS_CONDITIONAL_EXPRESSION åˆ†æ”¯ã€‚\n å¢åŠ  genCallExpression å‡½æ•°ç”Ÿæˆå‚æ•°ã€‚\n å¢åŠ  genConditionalExpression å‡½æ•°ç”Ÿæˆ if åˆ†æ”¯(å¦‚ï¼š ok ? ... : ...)\n   åœ¨å®Œæˆä¸Šè¿°ä¸‰ä¸ªæ­¥éª¤ä¹‹åè¾“å‡ºç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  (function anonymous( ) { return function render(_ctx, _cache) { with (_ctx) { const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode, createTextVNode : _createTextVNode } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { id: \u0026#34;foo\u0026#34;, class: bar.baz }, [ _createTextVNode(_toDisplayString(world.burn()), 1 /* TEXT */), ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { key: 0 }, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) ], 2 /* CLASS */)) } } })    æ‰©å±•ä¸€ï¼šhoisted æ”¯æŒ    genFunctionPreamble(ast, context) ä¸­å¢åŠ  genHoists(ast.hoists, context)\n  transform é˜¶æ®µå¯¹ hoisted å¤„ç†(transforms/hoistStatic.ts çš„ walk() å‡½æ•°ï¼Œé å†æ‰€æœ‰å­©å­èŠ‚ç‚¹ï¼Œæ‰¾å‡ºèŠ‚ç‚¹ props ä¸­æ‰€æœ‰å±æ€§åä¸º key æˆ– ref çš„å±æ€§)\n  transform.js çš„ context.hoist() å®ç°ï¼Œä¿®æ”¹ props å±æ€§\n è¿™é‡Œ vue.global.js å’Œ å®é™… vue transform.ts ä¸­çš„ä»£ç æœ‰ç»†å¾®å·®åˆ«ï¼Œä½†ä¸å½±å“æ•´ä½“ æµç¨‹ï¼Œä¸çŸ¥é“ä¸ºä½•ï¼Ÿ\n   å®ç°ä¹‹åä¼šå‘ç°åœ¨è¿”å› render å‡½æ•°ä¹‹å‰å¤šäº† const _hoisted_1 = { key: 0 } å’Œä¸€äº› å‡½æ•°çš„è§£æ„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  (function anonymous( ) { const _Vue = Vue const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue const _hoisted_1 = { key: 0 } return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true) ])) } } })      æ‰©å±•äºŒï¼šv-else æ”¯æŒ   ç›¸å…³è„‘å›¾é“¾æ¥ â€“\u0026gt;\n1 2 3 4 5 6  code = ` \u0026lt;div id=\u0026#34;foo\u0026#34; :class=\u0026#34;bar.baz\u0026#34;\u0026gt; {{ world.burn() }} \u0026lt;div v-if=\u0026#34;ok\u0026#34;\u0026gt;yes\u0026lt;/div\u0026gt; \u0026lt;div v-else\u0026gt;no\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt;`     v-if å’Œ v-else çš„ ast:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  [ { // v-if  \u0026#34;type\u0026#34;:1, // ELEMENT  \u0026#34;ns\u0026#34;:0, \u0026#34;tag\u0026#34;:\u0026#34;div\u0026#34;, \u0026#34;tagType\u0026#34;:0, \u0026#34;props\u0026#34;:[ { \u0026#34;type\u0026#34;:7, // DIRECTIVE  \u0026#34;name\u0026#34;:\u0026#34;if\u0026#34;, \u0026#34;exp\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;ok\u0026#34;, \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, }, } ], \u0026#34;children\u0026#34;:[{...}], }, { // v-else  \u0026#34;type\u0026#34;:1, // ELEMENT  \u0026#34;ns\u0026#34;:0, \u0026#34;tag\u0026#34;:\u0026#34;div\u0026#34;, \u0026#34;tagType\u0026#34;:0, \u0026#34;props\u0026#34;:[ { \u0026#34;type\u0026#34;:7, // else, DIRECTIVE  \u0026#34;name\u0026#34;:\u0026#34;else\u0026#34;, } ], \u0026#34;children\u0026#34;:[{...}], } ]     ä»ä¹‹å‰çš„å®ç°ç»“æœå¯çŸ¥ï¼Œ å•ä¸ª v-if çš„å¤„ç†æ˜¯åœ¨åé¢è¿½åŠ ä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹ï¼Œå› ä¸ºåœ¨ Render å‡½æ•°ä¸­è¿™äº›èŠ‚ç‚¹æ˜¯ä»¥ä¸‰ç›®è¿ç®—ç¬¦(?:)é“¾æ¥èµ·æ¥ç»„æˆè¡¨è¾¾å¼çš„ï¼Œå¦‚ï¼š\n1 2 3  ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, { key: 0 }, \u0026#34;yes\u0026#34;)) : _createCommentVNode(\u0026#34;v-if\u0026#34;, true)     æŒ‰ç…§ç†è§£ï¼Œå¦‚æœå¢åŠ äº† v-else åˆ†æ”¯ï¼Œé‚£ä¹ˆåº”è¯¥éœ€è¦å°† : åçš„æ³¨é‡ŠèŠ‚ç‚¹æ›¿æ¢æˆçœŸæ­£çš„ èŠ‚ç‚¹ï¼Ÿ\n çŒœæƒ³ ï¼š\n ä»ä»£ç è¯­æ³•è§’åº¦æ€è€ƒï¼Œ if/else/else-if è‚¯å®šå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ else å¦‚æœæƒ³è¦æ­£ ç¡®è§£æé‚£å‰æå¿…é¡»è¦æœ‰ if æ‰è¡Œã€‚è¿™ä¸€æ­¥æ˜¯å¦‚ä½•å®ç°å‘¢ï¼Ÿ\n æ ¹æ®ä¸Šé¢ ast è§£æç»“æœæ˜¾ç¤ºï¼Œåœ¨ parser é˜¶æ®µï¼Œæ— è®ºæ˜¯ if è¿˜æ˜¯ else éƒ½æ˜¯åŒç­‰å¯¹å¾…çš„ï¼Œå³å®ƒ ä»¬éƒ½æ˜¯ä¸ªæŒ‡ä»¤(9,DIRECTIVE)ï¼Œç„¶åæ ¹æ®ä¹‹å‰ v-if çš„ transform å¯çŸ¥ï¼Œv-else ä¹Ÿæ˜¯åœ¨ è¿™ä¸ªé˜¶æ®µå¹¶ä¸”æ˜¯åœ¨åŒä¸€ä¸ª transformIf ä¸­å¤„ç†çš„ï¼Œå³ä¸‹é¢ else TODO éƒ¨åˆ†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  export const transformIf = createStructuralDirectiveTransform( /^(if|else|else-if)$/, (node, dir, context) =\u0026gt; { return processIf(node, dir, context, (ifNode, branch, isRoot) =\u0026gt; { // èƒ½åˆ°è¿™é‡Œè¯´æ˜ v-if ä¸‹æ‰€æœ‰çš„ child éƒ½å·²ç»å¤„ç†å®Œæ¯•ï¼Œå¯ä»¥è¿”å›å¤„ç†  // codegenNode çš„å‡½æ•°äº†  return () =\u0026gt; { console.log({ dir, isRoot }); if (isRoot) { ifNode.codegenNode = createCodegenNodeForBranch(branch, 0, context); } else { // TODO  } }; }); } )      æ‰€ä»¥å®ç°æ­¥éª¤å¦‚ä¸‹\n  å®ç° transformIf è¿”å›çš„ transform å‡½æ•°çš„ else éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†æ‰¿æ‹… äº† v-else/v-else-if æŒ‡ä»¤èŠ‚ç‚¹çš„ codegenNode ç”Ÿæˆå·¥ä½œã€‚\n  å®ç° processIf() çš„åˆ†æ”¯éƒ¨åˆ†\n  createCodegenNodeForBranch(branch, index, context) è¿”å›æ–°çš„ alternate æ›¿æ¢æ‰ å ä½çš„æ³¨é‡Šåˆ†æ”¯ã€‚\n  å› ä¸ºéƒ½æ˜¯åœ¨ v-if çš„ branches é‡Œé¢ï¼Œåœ¨ codegen é˜¶æ®µå’Œ v-if çš„å¤„ç†æ˜¯ä¸€æ ·çš„ï¼Œä¸éœ€ è¦ä¿®æ”¹ä»€ä¹ˆã€‚\n  ä¿®æ”¹å®Œä¹‹åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  (function anonymous( ) { const _Vue = Vue const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue const _hoisted_1 = { key: 0 } const _hoisted_2 = { key: 1 } return function render(_ctx, _cache) { with (_ctx) { const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue return (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, null, [ ok ? (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_1, \u0026#34;yes\u0026#34;)) : (_openBlock(), _createBlock(\u0026#34;div\u0026#34;, _hoisted_2, \u0026#34;no\u0026#34;)) ])) } } })          é—®é¢˜åˆ—è¡¨    compile.js:37 Uncaught TypeError: object is not iterable (cannot read property Symbol(Symbol.iterator))\n åŸå› æ˜¯ï¼šåœ¨æ•°ç»„é‡Œé¢ä½¿ç”¨å±•å¼€ç¬¦çš„æ—¶å€™ [], {} æ··ç”¨äº†\n1 2 3 4 5 6 7 8 9 10 11 12 13  transform(ast, { // åˆå¹¶é€‰é¡¹  ...options, // è°ƒç”¨ baseCompile æ—¶å€™çš„ç¬¬äºŒä¸ªå‚æ•°  prefixIdentifiers, // è¿˜ä¸çŸ¥é“æ˜¯å¹²å•¥çš„???  // èŠ‚ç‚¹è½¬æ¢å™¨åˆå¹¶ï¼Œå¤–éƒ¨è½¬æ¢å™¨ä¼˜å…ˆï¼Œå³ä½¿ç”¨è€…å¯è‡ªå®šä¹‰è‡ªå·±çš„è½¬æ¢å™¨  // nodeTransforms: [...nodeTransforms, ...(options.nodeTransforms || {})], // FIX: è¿™é‡Œç”¨æ³•æœ‰é—®é¢˜ä¿®æ”¹å‰  nodeTransforms: [...nodeTransforms, ...(options.nodeTransforms || [])], // FIX: ä¿®æ”¹å  // æŒ‡ä»¤è½¬æ¢å™¨ï¼ŒåŒä¸Šã€‚  directiveTransforms: { ...directiveTransforms, ...(options.directiveTransforms || {}), }, });        ","permalink":"https://www.cheng92.com/vue/vue3-source-code-compiler-core-compile_ts/","tags":["vue,","vue3,","vuenext,","compiler"],"title":"Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 3: compile.ts"},{"categories":["vue"],"contents":" è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚\n æ–‡å­—æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³çœ‹æ–‡å­—å¯ç›´æ¥è½¬åˆ°è¿™é‡Œçœ‹è„‘å›¾\nç®€ä»‹ reactivity æ˜¯ vue next é‡Œé¢é€šè¿‡ proxy + reflect å®ç°çš„å“åº”å¼æ¨¡å—ã€‚\næºç è·¯å¾„ï¼š packages/reactivity\nå…¥å£æ–‡ä»¶ï¼špackages/reactivity/src/index.ts\nç–‘é—®ç‚¹è§£ç­”ï¼š\n  shallowReactive ç›¸å½“äºæµ…å¤åˆ¶ï¼Œåªé’ˆå¯¹å¯¹è±¡çš„ä¸€çº§ reactiveï¼ŒåµŒå¥—çš„å¯¹è±¡ä¸ä¼š reactive\nå‚è€ƒï¼šæµ‹è¯•ä»£ç  reactive.spec.ts\n1 2 3 4 5  test(\u0026#39;should keep reactive properties reactive\u0026#39;, () =\u0026gt; { const props: any = shallowReactive({ n: reactive({ foo: 1 }) }) props.n = reactive({ foo: 2 }) expect(isReactive(props.n)).toBe(true) })     å®Œæ•´çš„ reactivity æ¨¡å—ä»£ç é“¾æ¥ã€‚\né˜¶æ®µä»£ç é“¾æ¥  æµ‹è¯•ç”¨ä¾‹ reactive.spec.ts é€šè¿‡åçš„ä»£ç é“¾æ¥ æµ‹è¯•ç”¨ä¾‹ effect.spec.tsé€šè¿‡åçš„ä»£ç é“¾æ¥ 05-21å· git pull åçš„æ›´æ–°åˆ å¹¶ä¹‹åçš„ reactive.js å°† reactive.js æ‹†åˆ†æˆ effect.js + baseHandlers.js å®Œæˆ collection handlers(set + get) å®Œæˆ collection Map, Set æ”¯æŒ æ”¯æŒ Ref ç±»å‹ æ”¯æŒ computed å±æ€§  æ–‡ä¸­é‡ç‚¹é“¾æ¥  vue ä¸­æ˜¯å¦‚ä½•é˜²æ­¢åœ¨ effect(fn) çš„ fn ä¸­é˜²æ­¢ ob.prop++ å¯¼è‡´æ ˆæº¢å‡ºçš„ï¼Ÿ vue ä¸­ä¸ºä½•èƒ½å¯¹ JSON.parse(JSON.stringify({})) èµ·ä½œç”¨çš„ï¼Ÿ é›†åˆ handlers çš„ get å‡½æ•°å®ç° this é—®é¢˜ Key å’Œ rawKey çš„é—®é¢˜(get ä¸­)ï¼Œä¸ºä»€ä¹ˆè¦ä¸¤æ¬¡ track:getï¼Ÿ ä¸ºä»€ä¹ˆ key1 å’Œ toReactive(key1) åçš„ key11 å‰å set ä¼šæ”¹å˜ key1 å¯¹åº”çš„å€¼ï¼Ÿï¼Ÿï¼Ÿ å¦‚æœ Ref ç±»å‹æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ reactive åŒ–ä¼šæœ‰ä»€ä¹ˆç»“æœï¼Ÿï¼Ÿï¼Ÿ è®¡ç®—å±æ€§çš„é“¾å¼åµŒå¥—ä½¿ç”¨è¾“å‡ºç»“æœè¯¦ç»†åˆ†æè¿‡ç¨‹(æƒ³è¦é€å½»computedè¯·çœ‹è¿™é‡Œï¼ï¼ï¼)  é—ç•™é—®é¢˜  DONE ownKeys ä»£ç†æ”¶é›†çš„ä¾èµ–ä¸èƒ½è¢«è§¦å‘ã€‚ TODO Ref:a ç±»å‹åœ¨å¯¹è±¡ä¸­æ‰§è¡Œ obj.a++ ä¹‹åä¾æ—§æ˜¯ Ref ç±»å‹çš„ a ???  æ›´æ–° 2020-05-21 21:19:07 git pull æ¨¡å—ç»“æ„  __tests__/ æµ‹è¯•ä»£ç ç›®å½• src/ ä¸»è¦ä»£ç ç›®å½•  src ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š\n baseHandler.ts ä¼ å…¥ç»™ä»£ç†çš„å¯¹è±¡ï¼Œä»£ç† Object/Array æ—¶ä½¿ç”¨çš„ Handlersã€‚ collectionHandlers.ts ä¼ å…¥ç»™ä»£ç†çš„å¯¹è±¡ï¼Œä»£ç† [Week]Set/Mapç±»å‹æ—¶ä½¿ç”¨çš„ Handlersã€‚ computed.ts è®¡ç®—å±æ€§ä»£ç  effect.ts operations.ts æ“ä½œç±»å‹æšä¸¾ reactive.ts ä¸»è¦ä»£ç  ref.ts  Proxy å’Œ Reflect å›é¡¾ å°† reactive -\u0026gt; createReactiveObject ç®€åŒ–åˆå¹¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function reactive(target, toProxy, toRaw, baseHandlers, collectionHandlers) { // ... å¿…é¡»æ˜¯å¯¹è±¡ return  // ... å·²ç»è®¾ç½®è¿‡ä»£ç†äº†  let observed = null // ... æœ¬èº«å°±æ˜¯ä»£ç†  // ... ç™½åå•æ£€æµ‹  // ... handlers  // new ä»£ç†  let handlers = baseHandlers || collectionHandlers || {} // ...  observed = new Proxy(target, handlers) // ç¼“å­˜ä»£ç†è®¾ç½®ç»“æœåˆ° toProxy, toRaw  return observed }   å¢åŠ ä¸€ä¸ª reactive å¯¹è±¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  const target = { name: \u0026#39;vuejs\u0026#39; } const observed = reactive(target, null, null, { get: function (target, prop, receiver) { console.log(target, prop, receiver === observed, \u0026#39;get\u0026#39;) } }) console.log(target, observed)   è¾“å‡ºç»“æœï¼š\n {name: \u0026ldquo;vuejs\u0026rdquo;} Proxy {name: \u0026ldquo;vuejs\u0026rdquo;}\n=\u0026gt; original.name \u0026ldquo;vuejs\u0026rdquo; =\u0026gt; observed.name index.js:28 true \u0026ldquo;name\u0026rdquo; true \u0026ldquo;get\u0026rdquo; undefined =\u0026gt; observed === original false\n è®¿é—® target, observed çš„å±æ€§ name ç»“æœå¦‚ä¸Šï¼Œobserved æ˜¯è¢«ä»£ç†ä¹‹åçš„å¯¹è±¡ã€‚\n Observed.name è¾“å‡ºç»“æœæ˜¯ handler.get æ‰§è¡Œä¹‹åçš„ç»“æœï¼Œå› ä¸ºæ²¡ä»»ä½•è¿”å›æ‰€ä»¥æ˜¯ undefined get(target, prop, receiver) æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä»£è¡¨  target: è¢«ä»£ç†çš„å¯¹è±¡ï¼Œå³åŸå§‹çš„é‚£ä¸ª target å¯¹è±¡ prop: è¦è·å–å¯¹è±¡çš„å±æ€§å€¼çš„ key receiver: ä»£ç†ä¹‹åçš„å¯¹è±¡ï¼Œå³ observed    å…¶ä»–ä¸»è¦å‡ ä¸ªä»£ç†æ–¹æ³•ï¼š\n set èµ‹å€¼çš„æ—¶å€™è§¦å‘ï¼Œå¯¹åº” Reflect.set(target, prop, value) get å–å€¼çš„æ—¶å€™è§¦å‘ï¼Œå¯¹åº” Reflect.get(target, prop, reciver) ownKeys ä½¿ç”¨ for...in æ—¶è§¦å‘ï¼Œå¯¹åº” Reflect.ownKeys(target) has ä½¿ç”¨ prop in obj æ—¶è§¦å‘ï¼Œå¯¹åº”è¯­æ³• ï¼š ... in ... deleteProperty ä½¿ç”¨ delete obj.name è§¦å‘ï¼Œå¯¹åº” delete obj.name apply è¢«ä»£ç†å¯¹è±¡æ˜¯å‡½æ•°çš„æ—¶å€™ï¼Œé€šè¿‡ fn.apply() æ—¶è§¦å‘ï¼Œhandler é‡Œå¯¹åº” fn() construct æ„é€ å™¨ï¼Œnew target() æ—¶è§¦å‘ getPrototypeOf è°ƒç”¨ Object.getPrototypeOf(target) è§¦å‘ï¼Œè¿”å›å¯¹è±¡ æˆ– null  setPrototypeOf è®¾ç½®å¯¹è±¡åŸå‹æ—¶è§¦å‘ï¼Œå¦‚ï¼š obj.prototype = xxx  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73  let original = { name: \u0026#39;vuejs\u0026#39;, foo: 1 } original = test const observed = reactive(original, null, null, { get: function (target, prop, receiver) { console.log(target === original, prop, receiver === observed, \u0026#39;get\u0026#39;) return Reflect.get(...arguments) }, set: function (target, prop, value) { console.log(prop, value, \u0026#39;set\u0026#39;) Reflect.set(target, prop, value) }, ownKeys: function (target) { console.log(\u0026#39;get own keys...\u0026#39;) return Reflect.ownKeys(target) }, has: function (target, key) { console.log(\u0026#39;has proxy handler...\u0026#39;) return key in target }, deleteProperty: function (target, key) { console.log(key + \u0026#39;deleted from \u0026#39;, target) delete target[key] }, // é€‚ç”¨äºè¢«ä»£ç†å¯¹è±¡æ˜¯å‡½æ•°ç±»å‹çš„  apply: function (target, thisArg, argList) { console.log(\u0026#39;apply...\u0026#39;, argList) target(...argList) }, construct(target, args) { console.log(\u0026#39;proxy construct ... \u0026#39;, args) return new target(...args) }, // å¿…é¡»è¿”å›ä¸€ä¸ªå¯¹è±¡æˆ–è€… nullï¼Œä»£ç† Object.getPrototypeOf å–å¯¹è±¡åŸå‹  getPrototypeOf(target) { console.log(\u0026#39;proxy getPrototypeOf...\u0026#39;) return null }, setPrototypeOf(target, proto) { console.log(\u0026#39;proxy setPrototypeOf...\u0026#39;, proto) } }) console.log(observed.name) // -\u0026gt; true \u0026#34;name\u0026#34; true \u0026#34;get\u0026#34; observed.name = \u0026#39;xxx\u0026#39; // -\u0026gt; name xxx set for (let prop in observed) { } // -\u0026gt; get own keys... \u0026#39;name\u0026#39; in observed // -\u0026gt; has proxy handler delete observed.foo // foo deleted from { name: \u0026#39;xxx\u0026#39;, foo: 1 }  function test() { console.log(this.name, \u0026#39;test apply\u0026#39;) } observed.apply(null, [1, 2, 3]) // apply... (3)Â [1, 2, 3] // æ³¨æ„ç‚¹ï¼šproxy-construct çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¼ å…¥æ„é€ å‡½æ•°æ—¶çš„å‚æ•°åˆ—è¡¨ // å°±ç®—æ˜¯ä»¥ä¸‹é¢æ–¹å¼ä¸€ä¸ªä¸ªä¼ é€’çš„ new observed(1, 2, 3) // proxy construct ... (3)Â [1, 2, 3] Object.getPrototypeOf(observed) // proxy getPrototypeOf... observed.prototype = { bar: 2 } // prototype {bar: 2} set // index.js:31 true \u0026#34;prototype\u0026#34; true \u0026#34;get\u0026#34; // index.js:90 {bar: 2} console.log(observed.prototype)   éœ€è¦æ³¨æ„çš„ç‚¹ï¼š\n construct çš„ä»£ç† handler ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‚æ•°åˆ—è¡¨æ•°ç»„ã€‚ getPrototypeOf ä»£ç†é‡Œé¢è¿”å›ä¸€ä¸ªæ­£å¸¸çš„å¯¹è±¡ æˆ– nullè¡¨ç¤ºå¤±è´¥ã€‚  reactive å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  export function reactive(target: object) { // if trying to observe a readonly proxy, return the readonly version.  // è¿™é‡Œå¯¹åªè¯»çš„å¯¹è±¡è¿›è¡Œåˆ¤æ–­ï¼Œå› ä¸ºåªè¯»çš„å¯¹è±¡ä¸å…è®¸ä¿®æ”¹å€¼  // åªè¦æ›¾ç»è¢«ä»£ç†è¿‡çš„å°±ä¼šè¢«å­˜åˆ° readonlyToRaw è¿™ä¸ª WeakMap é‡Œé¢  // ç›´æ¥è¿”å›åªè¯»ç‰ˆæœ¬  if (readonlyToRaw.has(target)) { return target } return createReactiveObject( target, rawToReactive, reactiveToRaw, mutableHandlers, mutableCollectionHandlers ) }   ä¼ å…¥ä¸€ä¸ª target è¿”å›ä»£ç†å¯¹è±¡ã€‚\ncreateReactiveObject çœŸæ­£æ‰§è¡Œä»£ç†çš„æ˜¯è¿™ä¸ªå‡½æ•°é‡Œé¢ã€‚\nå‚æ•°åˆ—è¡¨  target è¢«ä»£ç†çš„å¯¹è±¡ toProxy ä¸€ä¸ª WeakMap é‡Œé¢å­˜å‚¨äº† target -\u0026gt; observed toRaw å’Œ toProxy åˆšå¥½ç›¸åçš„ä¸€ä¸ª WeakMap å­˜å‚¨äº† observed -\u0026gt; target baseHandlers ä»£ç†æ—¶ä¼ é€’ç»™ Proxy çš„ç¬¬äºŒä¸ªå‚æ•° collectionHandlers ä»£ç†æ—¶ä¼ é€’ç»™ Proxy çš„ç¬¬äºŒä¸ªå‚æ•°(ä¸€ä¸ªåŒ…å«å››ç§é›†åˆç±»å‹çš„ Set)  å‡½æ•°ä½“ ä¸‹é¢æ˜¯å°† reactive å’Œ createReactiveObject è¿›è¡Œåˆå¹¶çš„ä»£ç ã€‚\näº‹å…ˆå£°æ˜çš„å˜é‡åˆ—è¡¨ï¼š\n1 2 3 4 5 6 7 8  // é›†åˆç±»å‹çš„æ„é€ å‡½æ•°ï¼Œç”¨æ¥æ£€æµ‹ target æ˜¯ä½¿ç”¨ baseHandlers // è¿˜æ˜¯ collectionHandlers const collectionTypes = new Set([Set, Map, WeakMap, WeakSet]) // åªè¯»å¯¹è±¡çš„ mapï¼Œåªè¯»å¯¹è±¡ä»£ç†æ—¶å€™ç›´æ¥è¿”å›åŸå§‹å¯¹è±¡ const readonlyToRaw = new WeakMap() // å­˜å‚¨ä¸€äº›åªè¯»æˆ–æ— æ³•ä»£ç†çš„å€¼ const rawValues = new WeakSet()   åˆå¹¶åçš„ reactive(target, toProxy, toRaw, basehandlers, collectionHandlers) å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  function reactive(target, toProxy, toRaw, baseHandlers, collectionHandlers) { // åªè¯»çš„å¯¹è±¡  if (readonlyToRaw.has(target)) { return target } // ... å¿…é¡»æ˜¯å¯¹è±¡ return  if (target \u0026amp;\u0026amp; typeof target !== \u0026#39;object\u0026#39;) { console.warn(\u0026#39;ä¸æ˜¯å¯¹è±¡ï¼Œä¸èƒ½è¢«ä»£ç†ã€‚ã€‚ã€‚\u0026#39;) return target } // toProxy æ˜¯ä¸€ä¸ª WeakMap ï¼Œå­˜å‚¨äº† observed -\u0026gt; target  // å› æ­¤è¿™é‡Œæ£€æµ‹æ˜¯ä¸æ˜¯å·²ç»ä»£ç†è¿‡äº†é¿å…é‡å¤ä»£ç†æƒ…å†µ  let observed = toProxy.get(target) if (observed !== void 0) { console.log(\u0026#39;target å·²ç»è®¾ç½®è¿‡ä»£ç†äº†\u0026#39;) return observed } // ... æœ¬èº«å°±æ˜¯ä»£ç†  // toRaw ä¹Ÿæ˜¯ä¸€ä¸ª WeakMap å­˜å‚¨äº† target -\u0026gt; observed  // è¿™é‡Œåˆ¤æ–­è¿™ä¸ªï¼Œå¯èƒ½æ˜¯ä¸ºäº†é˜²æ­¢ï¼Œå°†æ›¾ç»è¢«ä»£ç†ä¹‹åçš„ observed ä¼ è¿›æ¥å†ä»£ç†çš„æƒ…å†µ  if (toRaw.has(target)) { console.log(\u0026#39;target æœ¬èº«å·²ç»æ˜¯ä»£ç†\u0026#39;) return target } // ...... è¿™é‡Œçœç•¥éæ³•å¯¹è±¡çš„åˆ¤æ–­ï¼Œæ”¾åœ¨åé¢å±•ç¤º ......  // æ ¹æ® target ç±»å‹å†³å®šä½¿ç”¨å“ªä¸ª handlers  // `Set, Map, WeakSet, SeakMap` å››ç§ç±»å‹ä½¿ç”¨ collectionHandlers é›†åˆç±»å‹çš„ handlers  // `Object, Array` ä½¿ç”¨ basehandlers  const handlers = collectionTypes.has(target.constructor) ? collectionHandlers : baseHandlers // new ä»£ç†  observed = new Proxy(target, handlers) // ç¼“å­˜ä»£ç†è®¾ç½®ç»“æœåˆ° toProxy, toRaw  toProxy.set(observed, target) toRaw.set(target, observed) return observed }     readonlyToRaw.has(target) æ£€æµ‹æ˜¯å¦æ˜¯åªè¯»å¯¹è±¡ï¼Œç›´æ¥è¿”å›è¯¥å¯¹è±¡\n  æ£€æµ‹ targetæ˜¯å¼•ç”¨ç±»å‹è¿˜æ˜¯æ™®é€šç±»å‹ï¼Œåªæœ‰å¼•ç”¨ç±»å‹æ‰èƒ½è¢«ä»£ç†\n  toProxy ä¸­å­˜å‚¨äº† target-\u0026gt;observed å†…å®¹ï¼Œæ£€æµ‹ target æ˜¯ä¸æ˜¯å·²ç»æœ‰ä»£ç†äº†\n  toRaw ä¸­å­˜å‚¨äº† observed-\u0026gt;target æ£€æµ‹æ˜¯å¦å·²ç»æ˜¯ä»£ç†äº†\n  äº”ç§ä¸åˆæ³•çš„å¯¹è±¡ç±»å‹ï¼Œä¸èƒ½ä½œä¸ºä»£ç†æº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  // ... ç™½åå•æ£€æµ‹ï¼Œæºç ä¸­è°ƒç”¨çš„æ˜¯ `canObserve` è¿™é‡Œä¸€ä¸ªä¸ªæ‹†åˆ†æ¥æ£€æµ‹  // 1. Vue å®ä¾‹æœ¬èº«ä¸èƒ½è¢«ä»£ç†  if (target._isVue) { console.log(\u0026#39;target æ˜¯ vue å®ä¾‹ï¼Œä¸èƒ½è¢«ä»£ç†\u0026#39;) return target } // 2. Vue çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œå…¶å®å°±æ˜¯ä¸€å †åŒ…å«æ¨¡æ¿å­—ç¬¦ä¸²çš„å¯¹è±¡è§£æ„  // è¿™ä¸ªæ˜¯ç”¨æ¥ç”Ÿæˆ render æ„å»º DOM çš„ï¼Œä¸èƒ½ç”¨æ¥è¢«ä»£ç†  if (target._isVNode) { console.log(\u0026#39;target æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œä¸èƒ½è¢«ä»£ç†\u0026#39;) return targtet } // é™å®šäº†åªèƒ½è¢«ä»£ç†çš„ä¸€äº›å¯¹è±¡ï¼š \u0026#39;Object, Array, Map, Set, WeakMap, WeakSet`  // Object.prototype.toString.call(target) =\u0026gt; [object Object] å– (-1, 8)  // å…¶å® `Object` æ„é€ å‡½æ•°å­—ç¬¦ä¸²  const toRawType = (target) =\u0026gt; Object.prototype.toString.call(target).slice(8, -1) if ( ![\u0026#39;Object\u0026#39;, \u0026#39;Array\u0026#39;, \u0026#39;Map\u0026#39;, \u0026#39;Set\u0026#39;, \u0026#39;WeakMap\u0026#39;, \u0026#39;WeakSet\u0026#39;].includes( toRawType(target) ) ) { console.log( `target ä¸æ˜¯å¯ä»£ç†èŒƒå›´å¯¹è±¡(\u0026#39;Object\u0026#39;, \u0026#39;Array\u0026#39;, \u0026#39;Map\u0026#39;, \u0026#39;Set\u0026#39;, \u0026#39;WeakMap\u0026#39;, \u0026#39;WeakSet\u0026#39;)` ) return target } // é‚£äº›è¢«æ ‡è®°ä¸ºåªè¯»æˆ–è€…éå“åº”å¼çš„WeakSetsçš„å€¼  if (rawValues.has(target)) { return target } // è¢«å†»ç»“çš„å¯¹è±¡ï¼Œæ˜¯ä¸å…è®¸ä»»ä½•ä¿®æ”¹æ“ä½œçš„ï¼Œä¸å¯ç”¨ä½œå“åº”å¼å¯¹è±¡  if (Object.isFrozen(target)) { return target }     æ ¹æ® target çš„ç±»å‹æ£€æµ‹é‡‡ç”¨å“ªç§ç±»å‹çš„ handlersï¼Œé›†åˆç±»å‹ä½¿ç”¨ collectionhandlersï¼Œå¯¹è±¡ç±»å‹é‡‡ç”¨ baseHandlers\n  åˆ›å»ºä»£ç† new Proxy(target, handlers)\n  ç¼“å­˜ä»£ç†æºåŠä»£ç†ç»“æœåˆ° toProxy, toRaw é¿å…å‡ºç°é‡å¤ä»£ç†çš„æƒ…å†µ\n  è¿”å›ä»£ç†å¯¹è±¡ observedã€‚\n  ä½¿ç”¨ reactive ä¸ºäº†åŒºåˆ†ä¸¤ç§ä»£ç†ç±»å‹(é›†åˆç±»å‹ï¼Œæ™®é€šå¯¹è±¡(å¯¹è±¡å’Œæ•°ç»„))ï¼Œè¿™é‡Œä½¿ç”¨ä¸¤ä¸ªå¯¹è±¡(setTarget, objTarget)ï¼Œåˆ›å»ºä¸¤ä¸ªä»£ç†(setObserved, objObserved)ï¼Œåˆ†åˆ«ä¼ å…¥ä¸åŒçš„ä»£ç† handlersï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  const toProxy = new WeakMap() const toRaw = new WeakMap() const setTarget = new Set([1, 2, 3]) const objTarget = { foo: 1, bar: 2 } const setObserved = reactive(setTarget, toProxy, toRaw, null, { get(target, prop, receiver) { console.log(prop, \u0026#39;set get...\u0026#39;) // return Reflect.get(target, prop, receiver)  }, // set/map é›†åˆç±»å‹  has(target, prop) { const ret = Reflect.has(target, prop) console.log(ret, target, prop, \u0026#39;set has...\u0026#39;) return ret } }) const objObserved = reactive( objTarget, toProxy, toRaw, { // object/arary, æ™®é€šç±»å‹  get(target, prop, receiver) { console.log(prop, \u0026#39;object/array get...\u0026#39;) return Reflect.get(target, prop, receiver) } }, {} )   è¾“å‡ºä»£ç†çš„ç»“æœå¯¹è±¡å¦‚ä¸‹ï¼šconsole.log(setObserved, objObserved)\nç»“æœï¼šProxy {1, 2, 3} Proxy {foo: 1, bar: 2}\nç„¶åå‡ºç°äº†é”™è¯¯ï¼Œå½“æˆ‘è¯•å›¾è°ƒç”¨ setObserved.has(1) çš„æ—¶å€™æŠ¥é”™äº†ï¼š\nè·å– setObserved.size å±æ€§æŠ¥é”™ï¼Œä¸åŒçš„æ˜¯ set proxy handler æœ‰è¢«è°ƒç”¨ï¼Œè¿™é‡Œåº”è¯¥æ˜¯è°ƒç”¨ Reflect.get() æ—¶å€™æŠ¥é”™äº†ï¼š\ngoogle ä¹‹åè¿™é‡Œæœ‰ç¯‡æ–‡ç« é‡Œç»™å‡ºäº†é—®é¢˜åŸå› å’Œè§£å†³æ–¹æ¡ˆ\nè§£å†³æ–¹æ³•ï¼Œåœ¨ get proxy handler é‡Œé¢åŠ ä¸Šåˆ¤æ–­ï¼Œå¦‚æœæ˜¯å‡½æ•°å°±ä½¿ç”¨ targetå»è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const setObserved = reactive(setTarget, toProxy, toRaw, null, { get(target, prop, receiver) { switch (prop) { default: { // å¦‚æœæ˜¯å‡½æ•°ï¼Œç»è¿‡ä»£ç†ä¹‹åä¼šä¸¢å¤±ä½œç”¨åŸŸé—®é¢˜ï¼Œæ‰€ä»¥è¦  // é‡æ–°ç»™ä»–ç»‘å®šä¸‹ä½œç”¨åŸŸ  console.log(prop, \u0026#39;get...\u0026#39;) return typeof target[prop] === \u0026#39;function\u0026#39; ? target[prop].bind(target) : target[prop] } } },   ç»“æœï¼š\n Proxy {1, 2, 3} Proxy {foo: 1, bar: 2} -\u0026gt; setObserved.has(1) has get\u0026hellip; true\n baseHandlers.ts è¿™ä¸ªæ–‡ä»¶æ¨¡å—å‡ºç°äº†å‡ ä¸ª handlers æ˜¯éœ€è¦å¼„æ¸…æ¥šçš„ï¼Œæ¯”å¦‚ï¼š\nbaseHandlers.ts é‡Œé¢å’Œ Array, Object æœ‰å…³çš„å››ä¸ªï¼š\n mutableHandlers readonlyHandlers shallowReactiveHandlers, shallowReadonlyHandlers  collectionHandlers.ts é‡Œå’Œé›†åˆç›¸å…³çš„ä¸¤ä¸ªï¼š\n mutableCollectionHandlers readonlyCollectionHandlers  åœ¨ä¸Šä¸€èŠ‚è®²è¿‡ createReactiveObject éœ€è¦ç»™å‡ºä¸¤ä¸ª handlers ä½œä¸ºå‚æ•°ï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹æ•°ç»„å’Œæ™®é€šå¯¹è±¡çš„ï¼Œå¦ä¸€ä¸ªæ˜¯é’ˆå¯¹é›†åˆç±»å‹çš„ã€‚\nä¸‹é¢åˆ†åˆ«æ¥çœ‹çœ‹ä¸¤ä¸ªæ–‡ä»¶ä¸­åˆ†åˆ«éƒ½å¹²äº†ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿ\nåˆ—å‡ºæ–‡ä»¶ä¸­ç›¸å…³çš„å‡½æ•°å’Œå±æ€§ï¼š å±æ€§:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // ç¬¦å·é›†åˆ const builtInSymbols = new Set(/* ... */); // å››ä¸ªé€šè¿‡ createGetter ç”Ÿæˆçš„ get å‡½æ•° const get = /*#__PURE__*/ createGetter() const shallowGet = /*#__PURE__*/ createGetter(false, true) const readonlyGet = /*#__PURE__*/ createGetter(true) const shallowReadonlyGet = /*#__PURE__*/ createGetter(true, true) // ä¸‰ä¸ªæ•°ç»„å‡½æ•° \u0026#39;includes\u0026#39;, \u0026#39;indexOf\u0026#39;, \u0026#39;lastIndexOf\u0026#39; const arrayInstrumentations: Record\u0026lt;string, Function\u0026gt; = {} // setter const set = /*#__PURE__*/ createSetter() const shallowSet = /*#__PURE__*/ createSetter(true)   å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // åˆ›å»º getter å‡½æ•°çš„å‡½æ•° function createGetter(isReadonly = false, shallow = false) { /* ... */ } // åˆ›å»º setter å‡½æ•°çš„å‡½æ•° function createSetter(shallow = false) { /* ... */ } // delete obj.name åŸå­æ“ä½œ function deleteProperty(target: object, key: string | symbol): boolean { /*...*/ } // åŸå­æ“ä½œ key in obj function has(target: object, key: string | symbol): boolean { /* ... */ } // Object.keys(target) æ“ä½œï¼Œå–å¯¹è±¡ key function ownKeys(target: object): (string | number | symbol)[] {/*...*/}   å››ä¸ªè¦è¢«å¯¼å‡ºçš„ handlersï¼š\n1 2 3 4  export const mutableHandlers: ProxyHandler\u0026lt;object\u0026gt; = {/*...*/} export const readonlyHandlers: ProxyHandler\u0026lt;object\u0026gt; = {/*...*/} export const shallowReactiveHandlers: ProxyHandler\u0026lt;object\u0026gt; = {/*...*/} export const shallowReadonlyHandlers: ProxyHandler\u0026lt;object\u0026gt; = {/*...*/}   æ¥ä¸‹æ¥ä¸€ä¸ªä¸ªæ¥åˆ†æåˆ†æï¼Œçœ‹çœ‹æ¯ä¸ªéƒ½æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿï¼Ÿï¼Ÿ\nå…ˆä» createGetter è¯´èµ·å§ -\u0026gt;\nä¸ºäº†ä¸‹é¢æ–¹ä¾¿è°ƒè¯•ï¼Œå¯¹ä¸Šé¢çš„ reactive() è¿›è¡Œäº†ç®€åŒ–ï¼Œåªä¿ç•™äº†ä¸ handlers æœ‰å…³çš„éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  const collectionTypes = new Set([Set, Map, WeakMap, WeakSet]) function reactive(target, toProxy, toRaw, baseHandlers, collectionHandlers) { // ç®€åŒ–  if (typeof target !== \u0026#39;object\u0026#39;) return target //... isVue, VNode...  let observed = null const handlers = collectionTypes.has(target.constructor) ? collectionHandlers : baseHandlers observed = new Proxy(target, handlers) toProxy.set(target, observed) toRaw.set(observed, target) return observed } const toProxy = new WeakMap(), toRaw = new WeakMap()   createGetter(isReadonly = false, shallow = false) å‚æ•°ï¼š\n isReadonly = false shallow = false  ç®€åŒ–ä¹‹åçš„ createGetterï¼Œå…ˆç”¨å®ƒæ¥åˆ›å»ºä¸€ä¸ª get ç„¶ååˆ›å»ºä¸€ä¸ª baseHandler: mutableHandlers å¯å˜çš„ handlersã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  { // å¾ˆæ˜æ˜¾è¿™ä¸ª proxy handler get, ç®€åŒ–ä¹‹å...  return function get(target, key, receiver) { const res = Reflect.get(...arguments) // ... çœç•¥1ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œä¸”æ˜¯ includes, indexOf, lastIndexOf æ“ä½œ  // ç›´æ¥è¿”å›å®ƒå¯¹åº”çš„ res  // ... çœç•¥2ï¼Œå¦‚æœæ˜¯ç¬¦å·å±æ€§ï¼Œç›´æ¥è¿”å› res  // ... çœç•¥3, æµ… reactiveï¼Œä¸æ”¯æŒåµŒå¥—  // ... çœç•¥4ï¼ŒisRef ç±»å‹ï¼Œåˆ¤æ–­æ˜¯æ•°ç»„è¿˜æ˜¯å¯¹è±¡ï¼Œæ•°ç»„æ‰§è¡Œ track(...), å¯¹è±¡è¿”å› res.value  // éåªè¯»å±æ€§ï¼Œæ‰§è¡Œ track()ï¼Œæ”¶é›†ä¾èµ–  !isReadonly \u0026amp;\u0026amp; track(target, \u0026#39;get\u0026#39;, key) console.log(res, key, \u0026#39;get...\u0026#39;) // return res  // éå¯¹è±¡ç›´æ¥è¿”å›åŸç»“æœï¼Œå¦‚æœæ˜¯å¯¹è±¡åŒºåˆ†åªè¯»ä¸å¦  return typeof res === \u0026#39;object\u0026#39; \u0026amp;\u0026amp; res !== null ? isReadonly ? // need to lazy access readonly and reactive here to avoid  // circular dependency  res // ... readonly(res)  : reactive(res, toProxy, toRaw, mutableHandlers) : res } }   ä¸Šé¢æˆ‘ä»¬çœç•¥äº†æš‚æ—¶ä¸å…³å¿ƒçš„æ˜¯å“ªä¸ªéƒ¨åˆ†ï¼š\n æ•°ç»„ç±»å‹ä¸” key æ˜¯ ['includes', 'indexOf', 'lastIndexOf'] å…¶ä¸­ä»»ä¸€ä¸€ä¸ª ç¬¦å·å±æ€§å¤„ç† ref ç±»å‹å¤„ç†  ç›®å‰æˆ‘ä»¬åªå…³å¿ƒå¦‚ä½•åˆ›å»º get å’Œä¸€ä¸ªæœ€ç®€å•çš„ basehandler: mutableHandler\nä½¿ç”¨ createGetter: get\n1 2 3 4 5 6 7 8 9 10  // ç¤ºä¾‹ 1 const objTarget = { foo: 1, bar: { name: \u0026#39;bar\u0026#39; } } // å°† createGetter ç”Ÿæˆçš„ get -\u0026gt; mutableHandlers ä¼ å…¥ reactive const objObserved = reactive(objTarget, toProxy, toRaw, mutableHandlers)   è¿™é‡Œ get æˆ‘è®¤ä¸ºåªæœ‰ä¸¤ä¸ªç›®çš„ï¼š\né€’å½’ reactiveï¼Œå°±åœ¨æœ€åè¿”å›çš„æ—¶å€™æ£€æµ‹ res ç»“æœæ—¶å€™ è¿™é‡Œæˆ‘ä»¬é¦–å…ˆæ¥éªŒè¯ä¸‹é€’å½’ reactive é—®é¢˜ï¼Œå³å½“æˆ‘ä»¬è®¿é—®å¯¹è±¡ä¸­åµŒå¥—å¯¹è±¡é‡Œé¢çš„å±æ€§æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯ä¸ä¼šè§¦å‘ get çš„ï¼Œæˆ‘ä»¬åœ¨ createGetter çš„ return å‰é¢åŠ ä¸Šä¸€å¥ return res ã€‚\nä¹Ÿå°±æ˜¯è¯´ä¸æ£€æµ‹ç»“æœæ˜¯ä¸æ˜¯å¯¹è±¡ï¼Œè€Œç›´æ¥è¿”å›å½“å‰å–å€¼çš„ç»“æœï¼š\n =\u0026gt; objObserved.foo \u0026ldquo;foo\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; 1 =\u0026gt; objObserved.bar {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; {name: \u0026ldquo;bar\u0026rdquo;} {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; =\u0026gt; objObserved.bar.name {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; \u0026ldquo;bar\u0026rdquo; =\u0026gt; const bar = objObserved.bar {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; undefined =\u0026gt; bar.name \u0026ldquo;bar\u0026rdquo;\n åˆ†æä¸Šé¢çš„æµ‹è¯•ç»“æœï¼š\n objObserved.foo ç›´æ¥å–å¯¹è±¡çš„æˆå‘˜å€¼ï¼Œè§¦å‘äº† proxy get objObserved.bar å–å¯¹è±¡çš„å¯¹è±¡æˆå‘˜ï¼Œè§¦å‘äº† proxy get   objObserved.bar.name å–åµŒå¥—å¯¹è±¡çš„æˆå‘˜ï¼Œè§¦å‘äº† proxy getä½†è¯·æ³¨æ„å®é™…ä¸Šè§¦å‘ get çš„æ˜¯ objObserved.bar å¾—å–å€¼è¿‡ç¨‹ï¼Œå› ä¸ºè¾“å‡ºçš„ res æ˜¯ {name: \u0026quot;bar\u0026quot;}ï¼Œä¹Ÿå°±æ˜¯è¯´å– bar.name çš„nameæ—¶å€™å®é™…å¹¶æ²¡æœ‰è§¦å‘ proxy getï¼Œè¿™è¯´æ˜ proxy get åªèƒ½ä»£ç†ä¸€çº§ã€‚   ä¸ºäº†è¯æ˜ä»£ç†åªèƒ½ä»£ç†ä¸€çº§ï¼Œä¸‹é¢é€šè¿‡ bar = objObserved.bar å†å»å– bar.name å°±å¾ˆæ˜æ˜¾å¹¶æ²¡æœ‰è§¦å‘ proxy get  é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦åœ¨ return çš„æ—¶å€™å»æ£€æµ‹æ˜¯ä¸æ˜¯å¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡éœ€è¦è¿›è¡Œé€’å½’ reactiveçš„åŠ¨ä½œã€‚\né‚£ä¹ˆï¼Œæˆ‘ä»¬å°† return res æ³¨é‡Šæ‰å†æ¥çœ‹çœ‹ç»“æœå¦‚ä½•ï¼š\n =\u0026gt; objObserved.foo 1 \u0026ldquo;foo\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; 1 =\u0026gt; objObserved.bar {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; Proxy {name: \u0026ldquo;bar\u0026rdquo;} =\u0026gt; objObserved.bar.name {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; bar name get\u0026hellip; \u0026ldquo;bar\u0026rdquo; =\u0026gt; const bar = objObserved.bar {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; bar.name =\u0026gt; bar name get\u0026hellip; \u0026ldquo;bar\u0026rdquo;\n çœ‹åˆ°å·®å¼‚æ²¡ï¼Œé¦–å…ˆä» objObserved.bar.name å°±å¯çœ‹å‡ºå·®å¼‚äº†ï¼Œè¿™é‡Œé¦–å…ˆè§¦å‘çš„å®é™…æ˜¯ objObserved.bar çš„ proxy getï¼Œæ­¤æ—¶ return çš„æ—¶å€™å‘ç°ç»“æœæ˜¯ä¸ªå¯¹è±¡ï¼Œå› æ­¤å°† bar ä¼ å…¥ reactive(bar) è¿›ä¸€æ­¥ä»£ç†ï¼Œå®Œæˆä¹‹åå– bar.name çš„æ—¶å€™ bar å·²ç»æ˜¯ reactive å¯¹è±¡äº†ï¼Œå› æ­¤å°±åœ¨ {name: \u0026ldquo;bar\u0026rdquo;} \u0026ldquo;bar\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026quot; åé¢ç´§è·Ÿç€å‡ºç°äº†bar name get\u0026hellip; è¾“å‡ºã€‚\næ­¤æ—¶ï¼Œæ— è®ºåé¢æ˜¯èµ‹å€¼åˆ°å˜é‡ bar å†å– bar.name ç»“æœä¸€æ ·ä¼šè§¦å‘å¯¹åº”çš„ proxy getï¼Œæ¯•ç«Ÿå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œç±»ä¼¼æŒ‡é’ˆä¸€æ ·ï¼Œæ–°å¢äº†ä¸€ä¸ªå˜é‡æŒ‡å‘å®ƒï¼Œå®ƒä¾æ—§åœ¨å“ªé‡Œã€‚\nåˆ°æ­¤ï¼Œæœ€åŸºæœ¬çš„ proxy get å“åº”å¼ä¹Ÿå®Œæˆäº†ï¼Œå¹¶ä¸”èƒ½åšåˆ°åµŒå¥—å¯¹è±¡çš„ reactive åŒ–ï¼Œæ„Ÿè§‰ç›¸æ¯” vue3 ä¹‹å‰çš„é€šè¿‡ defineProperty å®ç°æ›´åŠ æ¸…æ™°å®¹æ˜“ç†è§£ã€‚\næ”¶é›†ä¾èµ–(track) æ—¢ç„¶æœ‰äº†å“åº”å¼æ•°æ®ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯å¦‚æœåˆ©ç”¨å…¶ç‰¹æ€§ä¸ºæˆ‘ä»¬åšç‚¹äº‹æƒ…ï¼Œä½†æ˜¯å®ƒåˆå¦‚ä½•çŸ¥é“ä¸ºæˆ‘ä»¬åšä»€ä¹ˆçš„ï¼Œè¿™ä¸ªæ—¶å€™å°±æœ‰äº†æ‰€è°“çš„â€œæ”¶é›†ä¾èµ–â€ã€‚\nâ€œæ”¶é›†ä¾èµ–â€å°±æ˜¯åœ¨ get å–å€¼æœŸé—´å‘ç”Ÿçš„ï¼Œä¹Ÿå°±æ˜¯ createGetter ä¸­çš„ track() è°ƒç”¨æ—¶è§¦å‘äº†ä¾èµ–æ”¶é›†åŠ¨ä½œã€‚\ntrack() ç›¸å…³çš„ä»£ç åœ¨ effect.ts ä¸­ï¼š\nå‡½æ•°å®šä¹‰ï¼š\nexport function track(target: object, type: TrackOpTypes, key: unknown){} \næœ‰ä¸‰ä¸ªå‚æ•°ï¼š\n targetï¼šproxy get æ—¶å€™ä¼ é€’ç»™ proxy çš„é‚£ä¸ªå¯¹è±¡ type: è¦ track çš„ç±»å‹ï¼Œæœ‰ä¸‰ç§ï¼š get, has,iterateï¼Œåˆ†åˆ«æ˜¯å–å€¼ï¼Œæ£€æµ‹å±æ€§å­˜åœ¨æ€§ï¼Œä»¥åŠè¿­ä»£æ—¶ã€‚ Key: é’ˆå¯¹ target å¯¹è±¡é‡Œé¢çš„å±æ€§ï¼Œæ”¶é›†ä¾èµ–åˆ° targetMap -\u0026gt; depsMap -\u0026gt; dep:Set ä¸­  ç®€åŒ– track(target, type)ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // trackType -\u0026gt; get, has, iterate function track(target, type, key) { // ...çœç•¥1 æ£€æµ‹ shouldTrack å’Œ activeEffect æ ‡è®°  // å– target è‡ªå·±çš„ä¾èµ– map ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜æ˜¯é¦–æ¬¡ï¼Œéœ€è¦ç»™å®ƒåˆ›å»ºä¸€ä¸ª  // ç©ºçš„é›†åˆï¼Œè¿™é‡Œä½¿ç”¨ Map è€Œä¸æ˜¯ WeakMapï¼Œä¸ºçš„æ˜¯å¼ºå¼•ç”¨ï¼Œå®ƒæ¶‰åŠåˆ°  // æ•°æ®çš„æ›´æ–°è§¦å‘ UI æ¸²æŸ“ï¼Œå› æ­¤ä¸è¯¥ä½¿ç”¨ WeakMapï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ä¾èµ–ä¸¢å¤±é—®é¢˜  let depsMap = targetMap.get(target) if (!depsMap) { targetMap.set(target, (depsMap = new Map())) } // æ¥ä¸‹æ¥å¯¹ key å–å…¶ä¾èµ–  // å¦‚æœå±æ€§çš„ä¾èµ–ä¸å­˜åœ¨ï¼Œè¯´æ˜è¯¥å¯¹è±¡æ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦åˆ›å»ºå…¶ä¾èµ–åº“  // ä¸”è¿™é‡Œä½¿ç”¨äº† `Set` æ˜¯ä¸ºäº†é¿å…é‡å¤æ³¨å†Œä¾èµ–æƒ…å†µï¼Œé¿å…æ•°æ®çš„æ›´æ–°å¯¼è‡´é‡å¤è§¦å‘  // åŒä¸€ä¸ª update æƒ…å†µ  let dep = depsMap.get(key) if (!dep) { depsMap.set(key, (dep = new Set())) } // æ³¨å†Œå®é™…çš„ update: activeEffect æ“ä½œ  if (!dep.has(activeEffect)) { dep.add(activeEffect) activeEffect.deps.push(dep) } }   ä»£ç å®ç°ä¸»è¦æœ‰ä¸‰ä¸ªè¿‡ç¨‹ï¼š\n æ£€æµ‹å…¨å±€çš„ targetMap ä¸­æ˜¯ä¸æ˜¯æœ‰ target è‡ªå·±çš„ä¾èµ–ä»“åº“(Map) æ£€æµ‹ depsMap = targetMap.get(target) ä¸­æ˜¯ä¸æ˜¯æœ‰å–å€¼ key å¯¹åº”çš„ä¾èµ–é›†åˆ dep æ³¨å†Œ activeEffectå¯¹è±¡ï¼Œç„¶åå°†å½“å‰ target-key-dep æ³¨å†Œåˆ° activeEffectï¼Œç„¶åå‘ç°æ¯ä¸ª activeEffectä¼šæœ‰è‡ªå·±çš„ deps ä¿å­˜äº†æ‰€æœ‰å¯¹è±¡ key çš„ä¾èµ–ã€‚  æ”¶é›†ä¾èµ–çš„è¿‡ç¨‹å¦‚å›¾ï¼šï¼Œæ‰§è¡Œå–å€¼ activeEffect.deps ä¸­å°±ä¼šæ–°å¢ä¸€ä¸ª Set\nåˆ°è¿™é‡Œï¼Œä¾èµ–æ”¶é›†ç®—æ˜¯å®Œæˆï¼Œä½†å¹¶ä¸æ˜¯å¾ˆæ˜ç™½ activeEffect å…·ä½“æ˜¯åšä»€ä¹ˆçš„???\næ—¢ç„¶ä¾èµ–æ”¶é›†ï¼Œè¦ææ˜ç™½ activeEffect æ˜¯åšä»€ä¹ˆçš„ï¼Œä¼°è®¡çš„ä» set å…¥æ‰‹äº†ï¼Œä¸‹é¢æ¥å®ç° set ä»è€Œå®Œæˆä¸€ä¸ªå®Œæ•´çš„ get -\u0026gt; dep -\u0026gt; set -\u0026gt; update çš„è¿‡ç¨‹ã€‚\ngo on\u0026hellip;\ncreateSetter(shallow = false) æºç ç®€åŒ–ç‰ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  function createSetter(shallow = false) { // æ ‡å‡†çš„ proxy set  return function set(target, key, value, receiver) { // å–æ—§å€¼  const oldValue = target[key] // å…ˆä¸ç®¡ shallow mode  // è¿˜è®°å¾— reactive é‡Œé¢çš„ toRawå•Šï¼Œå¯¹è±¡è¿™é‡Œå°±æ˜¯å–å‡º  // value çš„åŸå§‹å¯¹è±¡ targetï¼Œå‰ææ˜¯å®ƒæœ‰ reactive() è¿‡  // æ‰ä¼šè¢«å­˜å…¥åˆ° toRaw: observed -\u0026gt; target ä¸­  // æš‚æ—¶ç®€åŒ–æˆï¼š toRaw.get(value)  value = toRaw.get(value) // ... çœç•¥ï¼Œref æ£€æµ‹  const hadKey = hasOwn(target, key) // å…ˆæ‰§è¡Œè®¾ç½®åŸå­æ“ä½œ  const result = Reflect.set(target, key, value, receiver) // åªæœ‰å¯¹è±¡æ˜¯å®ƒè‡ªèº«çš„æ—¶å€™ï¼Œæ‰è§¦å‘ dep-update(æ’é™¤åŸå‹é“¾)  if (target === toRaw(receiver)) { if (!hadKey) { // æ–°å¢å±æ€§æ“ä½œ  trigger(target, \u0026#39;add\u0026#39;, key, value) } else if (hasChanged(value, oldValue)) { // å€¼æ”¹å˜æ“ä½œ,æ’é™¤ NaN !== NaN æƒ…å†µ  trigger(target, \u0026#39;set\u0026#39;, key, value, oldValue) } } return result } }   è¿™é‡Œä¸»è¦æœ‰å‡ ä¸ªæ“ä½œï¼š\n shallow mode æ£€æµ‹ï¼Œå·²çœç•¥ã€‚ value = toRaw(value) å¦‚æœ value æ˜¯ observedï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ toRaw å–å‡ºè¢«ä»£ç†ä¹‹å‰çš„å¯¹è±¡ targetï¼Œè¿˜è®°å¾— reactive() é‡Œé¢çš„é‚£ä¸ª toRaw, toProxy ç¼“å­˜æ“ä½œå§ã€‚ è°ƒç”¨ Reflect.set() å…ˆå°†å€¼è®¾ç½®ä¸‹å»ï¼Œç„¶åå†è€ƒè™‘æ˜¯å¦è§¦å‘ä¾èµ– æ£€æµ‹å¯¹è±¡åŸå‹é“¾ï¼Œåªæœ‰å½“å¯¹è±¡æ˜¯è‡ªèº«çš„æ—¶å€™æ‰è§¦å‘ä¾èµ– è§¦å‘çš„è¡Œä¸ºåªæœ‰ä¸¤ç§è¦ä¹ˆæ˜¯æ–°å¢å±æ€§(add)ï¼Œè¦ä¹ˆæ˜¯æ›´æ”¹å€¼(set, å€¼ä¸å˜çš„æƒ…å†µä¸è§¦å‘)  è¿™é‡Œæœ‰ä¸ªä¸ createGetter é‡Œé¢æ”¶é›†ä¾èµ– (track())å¯¹åº”çš„è§¦å‘ä¾èµ–å‡½æ•°ï¼š triggerã€‚\næ¥ä¸‹æ¥å°±æ˜¯è¦çœ‹çœ‹ trigger() é‡Œé¢éƒ½åšäº†å•¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  function trigger(target, type, key, newValue, oldValue, oldTarget) { // step1: æ£€æµ‹æ˜¯å¦è¢« track è¿‡ï¼Œæ²¡æœ‰æ ¹æœ¬å°±æ²¡æœ‰ä¾èµ–  const depsMap = targetMap.get(target) if (!depsMap) return // step2: å°† dep åŠ å…¥åˆ° effects  // åˆ›å»ºä¸¤ä¸ª effects, ä¸€ä¸ªæ™®é€šçš„ï¼Œä¸€ä¸ªè®¡ç®—å±æ€§  const effects = new Set() const computedRunners = new Set() // æ ¹æ® effect çš„é€‰é¡¹ computed å†³å®šæ˜¯æ·»åŠ åˆ°é‚£ä¸ª Set ä¸­  const add = (effectsToAdd) =\u0026gt; effectsToAdd.forEach( (effect) =\u0026gt; (effect !== activeEffect || !shouldTrack) \u0026amp;\u0026amp; (effect.options.computed ? computedRunners.push(effect) : effects.push(effect)) ) // if ... clear  if (false) { // TODO æ¸…ç©ºåŠ¨ä½œï¼Œè§¦å‘æ‰€æœ‰ä¾èµ–  } // æ•°ç»„é•¿åº¦å˜åŒ–  else if (false) { // TODO è§¦å‘æ›´é•¿åº¦å˜åŒ–æœ‰å…³çš„æ‰€æœ‰ä¾èµ–  } else { // ä¾‹å¦‚ï¼š SET | ADD | DELETE æ“ä½œ  if (key !== void 0) { add(depsMap.get(key)) } const isAddOrDelete = type === \u0026#39;add\u0026#39; || (type === \u0026#39;delete\u0026#39; \u0026amp;\u0026amp; !Array.isArray(target)) if (isAddOrDelete || (type === \u0026#39;set\u0026#39; \u0026amp;\u0026amp; target instanceof Map)) { // åˆ é™¤æˆ–æ·»åŠ æ“ä½œï¼Œæˆ–è€… map çš„è®¾ç½®æ“ä½œ  add(depsMap.get(Array.isArray(target) ? \u0026#39;length\u0026#39; : ITERATE_KEY)) } // Map çš„æ·»åŠ æˆ–åˆ é™¤æ“ä½œ  if (isAddOrDelete \u0026amp;\u0026amp; target instanceof Map) { add(depsMap.get(MAP_KEY_ITERATE_KEY)) } } // step3: æ‰§è¡Œ effects ä¸­æ‰€æœ‰çš„ dep  const run = (effect) =\u0026gt; { // é€‰é¡¹æä¾›äº†è‡ªå·±çš„è°ƒåº¦å™¨ï¼Œæ‰§è¡Œè‡ªå·±çš„  if (effect.options.scheduler) { effect.options.scheduler(effect) } else { effect() } } // è§¦å‘åº”è¯¥è§¦å‘çš„ä¾èµ–  computedRunners.forEach(run) effects.forEach(run) }   ä¸»è¦æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š\n step1: æ£€æµ‹æ˜¯å¦æ”¶é›†è¿‡ä¾èµ–ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜å¯èƒ½æ²¡æœ‰è¢«ç”¨è¿‡ï¼Œæ²¡ä»€ä¹ˆå¯è§¦å‘çš„ step2: ä¸»è¦æ˜¯è¿‡æ»¤æ”¶é›†åˆ°ä¾èµ–ï¼Œé’ˆå¯¹å½“å‰æ›´æ”¹æ“ä½œçš„æ‰€æœ‰ä¾èµ–è§¦å‘(add) step2: ç»è¿‡ç¬¬äºŒæ­¥çš„ä¾èµ–è¿‡æ»¤ä¹‹åï¼Œè§¦å‘æ‰€æœ‰çš„ä¾èµ–(run)  è¿™é‡Œé¢æœ‰ä¸¤ä¸ªé‡è¦çš„å±æ€§(effects,computedRunners)å’Œä¸¤ä¸ªå‡½æ•°(add,run)\nadd: è¿‡æ»¤ï¼Œrun: æ‰§è¡Œã€‚\nå¾ˆæ˜æ˜¾ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜æ˜¯æ²¡æœ‰è§£å†³ï¼Œä¾èµ–å¯¹åº”çš„ update æ˜¯å¦‚ä½•æ”¶é›†çš„é—®é¢˜ï¼Œå› ä¸º set ä¹Ÿåªæ˜¯å°†å·²ç»æ”¶é›†å¥½ dep æ‰§è¡Œè€Œå·²ã€‚\neffect.ts è¯¥æ–‡ä»¶ä¸­ä¸»è¦åŒ…å«ä¸‰ä¸ªé‡è¦å‡½æ•°:\n trigger(target, type, key?, newValue?, oldValue?, oldTarget?) è§¦å‘ä¾èµ–å‡½æ•° effect-\u0026gt;createReactiveEffect(fn, options) è½¬æ¢ä¾èµ–å‡½æ•°æˆReactiveEffectç±»å‹ï¼Œå¹¶ä¸”ç«‹å³æ‰§è¡Œå®ƒã€‚ track(target, type, key)  ä»¥åŠä¸€äº›è¾…åŠ©å‡½æ•°ï¼š\n  isEffect() æ£€æµ‹æ˜¯ä¸æ˜¯ ReactiveEffect ç±»å‹ isEffect = fn =\u0026gt; fn?._isEffect === true\n  stop(effect: ReactiveEffect) åœæ­¢ effect ï¼Œå¦‚æœé€‰é¡¹ä¸­æä¾›äº† onStop ç›‘å¬è¯¥åŠ¨ä½œï¼Œæ‰§è¡Œå®ƒï¼Œé‡ç½® effect.activeã€‚\n1 2 3 4 5 6 7 8 9  export function stop(effect: ReactiveEffect) { if (effect.active) { cleanup(effect) if (effect.options.onStop) { effect.options.onStop() } effect.active = false } }     cleanup(effect: ReactiveEffect)\n1 2 3 4 5 6 7 8 9 10 11  // åœ¨ track çš„æ—¶å€™ï¼ŒåŠ å…¥ effect æ—¶ï¼Œå¯¹å…¶åšä¸€æ¬¡æ¸…ç†å·¥ä½œ // ä¿è¯ effect.deps å¹²å‡€ function cleanup(effect: ReactiveEffect) { const { deps } = effect if (deps.length) { for (let i = 0; i \u0026lt; deps.length; i++) { deps[i].delete(effect) } deps.length = 0 } }     pauseTracking() \n1 2 3 4 5  // æš‚åœ track åŠ¨ä½œ export function pauseTracking() { trackStack.push(shouldTrack) shouldTrack = false }     enableTracking() \n1 2 3 4 5  // æ¢å¤ track åŠ¨ä½œ export function enableTracking() { trackStack.push(shouldTrack) shouldTrack = true }     resetTracking() \n1 2 3 4 5  // é‡ç½® trackï¼Œå¯èƒ½ fn æ‰§è¡Œå¤±è´¥äº†ï¼Œtry ... finally ... ä¸¢å¼ƒ fn:effect æ—¶å€™è°ƒç”¨ export function resetTracking() { const last = trackStack.pop() shouldTrack = last === undefined ? true : last }     åŒ…å«çš„å±æ€§å˜é‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // ä¿å­˜ç€ target å¯¹è±¡çš„æ‰€æœ‰ä¾èµ–çš„ Map \u0026lt;target, dep\u0026lt;Set\u0026gt;\u0026gt; // target -\u0026gt; Map\u0026lt;key, dep[]\u0026gt; const targetMap = new WeakMap\u0026lt;any, KeyToDepMap\u0026gt;() // effect æ ˆï¼Œä¿å­˜æ‰€æœ‰çš„ fn-\u0026gt;effect const effectStack: ReactiveEffect[] = [] // å½“å‰æ¿€æ´»çŠ¶æ€çš„ effect let activeEffect: ReactiveEffect | undefined export const ITERATE_KEY = Symbol(__DEV__ ? \u0026#39;iterate\u0026#39; : \u0026#39;\u0026#39;) export const MAP_KEY_ITERATE_KEY = Symbol(__DEV__ ? \u0026#39;Map key iterate\u0026#39; : \u0026#39;\u0026#39;) // æ‰§è¡Œ effect æ—¶ï¼Œuid++ï¼Œå³æ¯ä¸ª effect éƒ½ä¼šæœ‰è‡ªå·±çš„å”¯ä¸€çš„ uid let uid = 0 // è®°å½•å½“å‰ effect çš„çŠ¶æ€ï¼Œ let shouldTrack = true // å½“å‰ effect -\u0026gt; shouldTack // æ¯å¢åŠ ä¸€ä¸ª effect è®°å½• shouldTrack = true, push åˆ° trackStack // å¦‚æœ effect.raw\u0026lt;fn\u0026gt; æ‰§è¡Œå¼‚å¸¸ä¼š pop æ‰ï¼Œè¿˜åŸ shouldTrack -\u0026gt; last, // pop trackStack const trackStack: boolean[] = []   ä¸€ç›´åˆ°è¿™é‡Œæˆ‘ä»¬åŸºæœ¬å®Œæˆäº† reactive-\u0026gt;get-\u0026gt;set-\u0026gt;track-\u0026gt;trigger-\u0026gt;effect ä¸€ç³»åˆ—åŠ¨ä½œï¼Œ\nä¹Ÿè¯¥æˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™äº†ï¼ŒæŒ‰æ­£å¸¸åº”è¯¥ä¼šæœ‰æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œå“åº”å¼-\u0026gt;æ³¨å†Œfn:update-\u0026gt;å–å€¼æ”¶é›†ä¾èµ–-\u0026gt; è®¾ç½®è§¦å‘ fn:udpate è°ƒç”¨\n=\u0026raquo;\u0026raquo;\u0026raquo;\u0026raquo;\u0026gt;\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  const r = (target) =\u0026gt; reactive(target, toProxy, toRaw, mutableHandlers) const fn = () =\u0026gt; console.log(\u0026#39;effect fn\u0026#39;) let res = effect(fn, {}) console.log(Object.keys(res), \u0026#39;after effect\u0026#39;) let dummy const counter = r({ num: 0 }) effect(() =\u0026gt; (dummy = counter.num)) console.log(dummy, \u0026#39;before\u0026#39;) counter.num = 7 console.log(dummy, \u0026#39;after\u0026#39;)   ä¸Šé¢çš„ä¾‹å­è¿è¡Œä¹‹åï¼Œå¹¶æ²¡æœ‰å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼ï¼ï¼\n effect fn [\u0026ldquo;id\u0026rdquo;, \u0026ldquo;_isEffect\u0026rdquo;, \u0026ldquo;active\u0026rdquo;, \u0026ldquo;raw\u0026rdquo;, \u0026ldquo;deps\u0026rdquo;, \u0026ldquo;options\u0026rdquo;] \u0026ldquo;after effect\u0026rdquo; 0 \u0026ldquo;num\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026rdquo; 0 \u0026ldquo;before\u0026rdquo; 0 \u0026ldquo;after\u0026rdquo;\n æŒ‰ç…§æˆ‘ä»¬çš„å®ç°ï¼Œç†è®ºä¸Š after çš„ç»“æœåº”è¯¥æ˜¯ 7 æ‰å¯¹ï¼Œä½†ç»“æœæ˜¾ç¤ºä¾ç„¶æ˜¯ 0ï¼Œè¿™è¯´æ˜äº†æˆ‘ä»¬è°ƒç”¨ effect(fn) å¹¶æ²¡æœ‰ä¸ä¸Šé¢çš„ r({ num: 0 }) å‘ç”Ÿä»»ä½•è”ç³»ï¼Œå³ fn å¹¶æ²¡æœ‰è¢«æ”¶é›†åˆ° counter.num çš„ä¾èµ– deps ä¸­å»ï¼Œé‚£è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿï¼Ÿ\n æˆ‘ä»¬æ¥å›é¡¾åˆ†æä¸‹ä¹‹å‰æ‰€ä½œå·¥ä½œçš„æ•´ä¸ªè¿‡ç¨‹(reactive-\u0026gt;get-\u0026gt;set-\u0026gt;track-\u0026gt;trigger-\u0026gt;effect):\n reactive å°†æ•°æ®é€šè¿‡ proxy è½¬æˆå“åº”å¼ get-\u0026gt;track æ”¶é›†ä¾èµ–ï¼Œç›¸å…³å±æ€§ï¼štargetMap, depsMap, dep, activeEffect, activeEffect.depsã€‚ set-\u0026gt;trigger è§¦å‘ä¾èµ– update å‡½æ•°ï¼Œæ¶‰åŠåˆ°çš„ targetMap, depsMap, add, run effect å°† update å‡½æ•°ï¼Œè½¬æ¢æˆ ReactiveEffect ç±»å‹  çºµè§‚è¿™æ•´ä¸ªè¿‡ç¨‹ï¼Œå°¤å…¶æ˜¯ get-\u0026gt;track ï¼Œ set-\u0026gt;trigger -\u0026gt; effect æ”¶é›†ï¼Œè§¦å‘å’Œ effect ä¸‰ä¸ªè¿‡ç¨‹ï¼Œå”¯ä¸€æœ‰å¯èƒ½è®©ä»–ä»¬å‘ç”Ÿè”ç³»çš„åº”è¯¥å°±æ˜¯è¿™ä¸ª activeEffect æ¨¡å—åŸŸé‡Œçš„å˜é‡ï¼Œæ ‡è¯†ç€å½“å‰å¤„äºæ¿€æ´»çŠ¶æ€çš„ effectï¼Œå®ƒçš„ä½¿ç”¨å‡ ä¹è´¯ç©¿äº†æ•´ä¸ªè¿‡ç¨‹(track-\u0026gt;trigger-\u0026gt;effectï¼Œè¿™ä¸‰ä¸ªå‡½æ•°ä¹Ÿéƒ½åœ¨ effect.ts ä¸­å®ç°)ã€‚\né‚£ä¹ˆæ¥ä¸‹æ¥\u0026hellip;\u0026hellip;\nå‰é¢éƒ½æ˜¯ç®€åŒ–ä¹‹åçš„ï¼Œç°åœ¨çœ‹çœ‹å®Œæ•´çš„è¿™ä¸‰ä¸ªå‡½æ•°å®ç°ï¼š\ntrack(target, type, key) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  export function track(target: object, type: TrackOpTypes, key: unknown) { if (!shouldTrack || activeEffect === undefined) { return } let depsMap = targetMap.get(target) if (!depsMap) { targetMap.set(target, (depsMap = new Map())) } let dep = depsMap.get(key) if (!dep) { depsMap.set(key, (dep = new Set())) } if (!dep.has(activeEffect)) { dep.add(activeEffect) activeEffect.deps.push(dep) if (__DEV__ \u0026amp;\u0026amp; activeEffect.options.onTrack) { activeEffect.options.onTrack({ effect: activeEffect, target, type, key }) } } }   trigger(\u0026hellip;) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88  export function trigger( target: object, type: TriggerOpTypes, key?: unknown, newValue?: unknown, oldValue?: unknown, oldTarget?: Map\u0026lt;unknown, unknown\u0026gt; | Set\u0026lt;unknown\u0026gt; ) { const depsMap = targetMap.get(target) if (!depsMap) { // never been tracked  return } const effects = new Set\u0026lt;ReactiveEffect\u0026gt;() const computedRunners = new Set\u0026lt;ReactiveEffect\u0026gt;() const add = (effectsToAdd: Set\u0026lt;ReactiveEffect\u0026gt; | undefined) =\u0026gt; { if (effectsToAdd) { effectsToAdd.forEach(effect =\u0026gt; { if (effect !== activeEffect || !shouldTrack) { if (effect.options.computed) { computedRunners.add(effect) } else { effects.add(effect) } } else { // the effect mutated its own dependency during its execution.  // this can be caused by operations like foo.value++  // do not trigger or we end in an infinite loop  } }) } } if (type === TriggerOpTypes.CLEAR) { // collection being cleared  // trigger all effects for target  depsMap.forEach(add) } else if (key === \u0026#39;length\u0026#39; \u0026amp;\u0026amp; isArray(target)) { depsMap.forEach((dep, key) =\u0026gt; { if (key === \u0026#39;length\u0026#39; || key \u0026gt;= (newValue as number)) { add(dep) } }) } else { // schedule runs for SET | ADD | DELETE  if (key !== void 0) { add(depsMap.get(key)) } // also run for iteration key on ADD | DELETE | Map.SET  const isAddOrDelete = type === TriggerOpTypes.ADD || (type === TriggerOpTypes.DELETE \u0026amp;\u0026amp; !isArray(target)) if ( isAddOrDelete || (type === TriggerOpTypes.SET \u0026amp;\u0026amp; target instanceof Map) ) { add(depsMap.get(isArray(target) ? \u0026#39;length\u0026#39; : ITERATE_KEY)) } if (isAddOrDelete \u0026amp;\u0026amp; target instanceof Map) { add(depsMap.get(MAP_KEY_ITERATE_KEY)) } } const run = (effect: ReactiveEffect) =\u0026gt; { if (__DEV__ \u0026amp;\u0026amp; effect.options.onTrigger) { effect.options.onTrigger({ effect, target, key, type, newValue, oldValue, oldTarget }) } if (effect.options.scheduler) { effect.options.scheduler(effect) } else { effect() } } // Important: computed effects must be run first so that computed getters  // can be invalidated before any normal effects that depend on them are run.  computedRunners.forEach(run) effects.forEach(run) }   effect(fn, options) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  export function effect\u0026lt;T = any\u0026gt;( fn: () =\u0026gt; T, options: ReactiveEffectOptions = EMPTY_OBJ ): ReactiveEffect\u0026lt;T\u0026gt; { if (isEffect(fn)) { fn = fn.raw } const effect = createReactiveEffect(fn, options) if (!options.lazy) { effect() } return effect } function createReactiveEffect\u0026lt;T = any\u0026gt;( fn: (...args: any[]) =\u0026gt; T, options: ReactiveEffectOptions ): ReactiveEffect\u0026lt;T\u0026gt; { const effect = function reactiveEffect(...args: unknown[]): unknown { if (!effect.active) { return options.scheduler ? undefined : fn(...args) } if (!effectStack.includes(effect)) { cleanup(effect) try { enableTracking() effectStack.push(effect) activeEffect = effect return fn(...args) } finally { effectStack.pop() resetTracking() activeEffect = effectStack[effectStack.length - 1] } } } as ReactiveEffect effect.id = uid++ effect._isEffect = true effect.active = true effect.raw = fn effect.deps = [] effect.options = options return effect }   å¯¹æ¯”ä¸‰ä¸ªå‡½æ•°    è¿‡ç¨‹ shouldTrack/activeEffect      track if (!shouldTrack || activeEffect === undefined) return    trigger add é‡Œé¢æœ‰ä¸ªåˆ¤æ–­ï¼šif (!shouldTrack || effect !== activeEffect)`æ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œæ·»åŠ æ“ä½œ    effect effectStack.push(effect)\nactiveEffect = effect\n// enable tracking\ntrackStack.push(shouldTrack)\nshouldTrack = true     å¯¹ä¸‹é¢æµ‹è¯•ä»£ç é€è¡Œåˆ†æï¼š\n1 2 3 4 5 6 7  let dummy const counter = r({ num: 0 }) effect(() =\u0026gt; (dummy = counter.num)) console.log(dummy, counter, \u0026#39;before\u0026#39;) counter.num = 7 console.log(dummy, \u0026#39;after\u0026#39;)     const counter = r({sum: 0}) è¿™é‡Œå°† { sum: 0 } reactive ä»£ç†ä¹‹åèµ‹å€¼ç»™äº† counter ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª counter æ˜¯ä¸ª Proxyï¼š  effect(() =\u0026gt; (dummy = counter.num)) åœ¨è¿™é‡Œè°ƒç”¨ effect(fn) æ³¨å†Œäº†ä¸€ä¸ª updaterï¼Œé‡Œé¢ç”¨åˆ°äº† counter.num é‚£ä¹ˆå°±ä¼šè§¦å‘ counter.num çš„ proxy getï¼Œç„¶åä¼šè§¦å‘ track() æ”¶é›†ä¾èµ–: å¹¶ä¸”æˆ‘ä»¬ä»å›¾ä¸­ç»“æœå¯çŸ¥ï¼Œ fn å®é™…è¢«ç«‹å³æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè¿™æ˜¯ effect å‡½æ•°é‡Œé¢çš„æ“ä½œã€‚ æŒ‰é¢„æœŸï¼Œè¿™é‡Œçš„ fn åº”è¯¥ä¼šè¢«æ”¶é›†åˆ° counter.num çš„ deps ä¸­ã€‚ æˆ‘ä»¬åœ¨ track() æœ€ååŠ ä¸Šæ‰“å°\n1 2 3 4 5  if (!dep.has(activeEffect)) { dep.add(activeEffect) activeEffect?.deps?.push(dep) console.log(dep, activeEffect.deps) }   ç»“æœï¼šå³ï¼ŒactiveEffect.deps ä»¥åŠæ”¶é›†åˆ°äº† counter.num çš„ä¾èµ–: Map(1) {\u0026quot;num\u0026quot; =\u0026gt; Set(1)}ã€‚   console.log(dummy, counter, 'before') ç»è¿‡ä¸Šé¢çš„ç»“æœåˆ†æï¼Œåœ¨ç¬¬2æ­¥çš„æ—¶å€™ï¼Œç¡®å®å·²ç»æ”¶é›†åˆ°äº† counter.num çš„ fn:updaterï¼Œä¸”å­˜æ”¾åˆ°äº† targetMap -\u0026gt; despMap -\u0026gt; num:Set(1) ä¸­ã€‚ å› æ­¤è¿™é‡Œçš„è¾“å‡ºå†…å®¹æ˜¯ï¼š 0 \u0026ldquo;num\u0026rdquo; \u0026ldquo;get\u0026hellip;\u0026quot; æ²¡ä»€ä¹ˆæ¯›ç—…ï¼Œé‚£ç»§ç»­å¾€ä¸‹ï¼Œé—®é¢˜æˆ–è®¸å¤„åœ¨è®¾ç½®çš„æ—¶å€™???\n  counter.num = 7 æœ€åå‘ç°é—®é¢˜æ‰€åœ¨ï¼ŒåŸå§‹æ˜¯ä¸ªè¶…çº§ä½çº§çš„é—®é¢˜(æ‚è„¸~~ï¼Œæ²¡è„¸è§äºº~~~)ã€‚ æ²¡æœ‰åˆ›å»º set handler å¹¶æ·»åŠ åˆ° mutableHandlers é‡Œé¢ã€‚ åªè¦æ·»åŠ ä¸¤å¥ï¼š const set = createSetter() ç„¶åï¼š const mutableHandlers = { get, set } å°±èƒ½å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚\n  console.log(dummy, 'after') æœ€åçœ‹ä¸‹æœ€ç»ˆè¾“å‡ºï¼š1 effect(() =\u0026gt; (dummy = counter.num)) å–å€¼æ—¶ proxy get é‡Œé¢çš„è¾“å‡º\n2ï¼š è®¾ç½®å€¼ä¸º 7 ä¹‹å‰çš„è¾“å‡º\n3ï¼š è®¾ç½®å€¼å½“ä¸­çš„è¾“å‡º 4ï¼š æœ€åä¸€ä¸ªlogå–å€¼ proxy get çš„è¾“å‡º 5ï¼š æœ€å log çš„è¾“å‡ºå†…å®¹\n  è™½ç„¶çŠ¯äº†ä¸ªéå¸¸ä½çº§çš„é”™è¯¯ï¼Œä½†ä¹Ÿæ­£å› ä¸ºè¿™ä¸ªä½çº§é”™è¯¯ï¼Œä¿ƒä½¿è‡ªå·±ä¸€æ­¥æ­¥çš„å»è·Ÿè¸ª get-\u0026gt;track, set-\u0026gt;trigger, effect æ•´ä¸ªè¿‡ç¨‹ï¼Œä»è€Œäº†è§£äº†ä¾èµ–æ”¶é›†ï¼Œupdater è§¦å‘åŸç†ã€‚\nå°ç»“ 1 åˆ°æ­¤ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„å“åº”å¼ä»£ç ä¹Ÿç®—å‘Šä¸€æ®µè½ï¼Œè¿™é‡Œè´´ä¸€ä¸‹ç®€åŒ–åå¯è¿è¡Œçš„å®Œæ•´ä»£ç (reactive.js)å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276  const hasChanged = (value, oldValue) =\u0026gt; value !== oldValue \u0026amp;\u0026amp; (value === value || oldValue === oldValue) const __DEV__ = false let shouldTrack = true const ITERATE_KEY = Symbol(__DEV__ ? \u0026#39;iterate\u0026#39; : \u0026#39;\u0026#39;) const MAP_KEY_ITERATE_KEY = Symbol(__DEV__ ? \u0026#39;Map key iterate\u0026#39; : \u0026#39;\u0026#39;) const effectStack = [] const trackStack = [] let uid = 0 const reactiveToRaw = new WeakMap() const rawToReactive = new WeakMap() // baseHandlers.ts start const get = createGetter() const set = createSetter() // å­˜æ”¾ç›®æ ‡ä¾èµ–çš„ mapï¼š target -\u0026gt; depsMap // ä¸€ä¸ªç›®æ ‡ï¼Œæœ‰è‡ªå·±çš„ä¸€ä¸ª map å­˜æ”¾ä¾èµ– const targetMap = new WeakMap() let activeEffect = { _isEffect: true, id: 0, active: false, raw: null, deps: [], options: {} } function toRaw(observed) { return reactiveToRaw.get(observed) || observed } function effect(fn, options = {}) { // å¦‚æœæ˜¯ä¸ª activeEffect ç±»å‹ï¼Œé‚£ä¹ˆå…¶æ‰§è¡Œå‡½æ•°åº”è¯¥æ˜¯ fn.raw  if (fn?._isEffect === true) { fn = fn.raw } // æ¥ä¸‹æ¥è¦åˆ›å»ºä¸€ä¸ª effect  const _effect = function reactiveEffect(...args) { if (!_effect.active) { // éæ¿€æ´»çŠ¶æ€  return options.scheduler ? undefined : fn(...args) } if (!effectStack.includes(_effect)) { // å¦‚æœæ ˆä¸­ä¸åŒ…å«å½“å‰çš„ effectï¼Œå³æ²¡æœ‰æ³¨å†Œè¿‡è¯¥ effect  // æ³¨å†Œè¿‡å°±ä¸éœ€è¦é‡å¤æ³¨å†Œäº†  // æ·»åŠ å‰å…ˆæ‰§è¡Œæ¸…ç†å·¥ä½œ cleanup -\u0026gt; effect.deps[i].delete(effect)  try { shouldTrack = true effectStack.push(_effect) activeEffect = _effect return fn(...args) } finally { // fn æ‰§è¡Œå¼‚å¸¸äº†ï¼Œç§»é™¤å¯¹åº”çš„ effect  effectStack.pop() const last = trackStack.pop() // è¿˜åŸçŠ¶æ€å€¼  shouldTrack = last === undefined ? true : last // è¿˜åŸå½“å‰æ¿€æ´»çš„ effect  activeEffect = effectStack[effectStack.length - 1] } } } _effect.id = uid++ _effect._isEffect = true _effect.active = true _effect.raw = fn _effect.deps = [] _effect.options = options if (!options.lazy) { _effect() } return _effect } function trigger(target, type, key, newValue, oldValue, oldTarget) { // step1: æ£€æµ‹æ˜¯å¦è¢« track è¿‡ï¼Œæ²¡æœ‰æ ¹æœ¬å°±æ²¡æœ‰ä¾èµ–  const depsMap = targetMap.get(target) if (!depsMap) return // step2: å°† dep åŠ å…¥åˆ° effects  // åˆ›å»ºä¸¤ä¸ª effects, ä¸€ä¸ªæ™®é€šçš„ï¼Œä¸€ä¸ªè®¡ç®—å±æ€§  const effects = new Set() const computedRunners = new Set() // æ ¹æ® effect çš„é€‰é¡¹ computed å†³å®šæ˜¯æ·»åŠ åˆ°é‚£ä¸ª Set ä¸­  const add = (effectsToAdd) =\u0026gt; { effectsToAdd?.forEach( (effect) =\u0026gt; (effect !== activeEffect || !shouldTrack) \u0026amp;\u0026amp; (effect.options.computed ? computedRunners.add(effect) : effects.add(effect)) ) } // if ... clear  if (false) { // TODO æ¸…ç©ºåŠ¨ä½œï¼Œè§¦å‘æ‰€æœ‰ä¾èµ–  } // æ•°ç»„é•¿åº¦å˜åŒ–  else if (false) { // TODO è§¦å‘æ›´é•¿åº¦å˜åŒ–æœ‰å…³çš„æ‰€æœ‰ä¾èµ–  } else { // ä¾‹å¦‚ï¼š SET | ADD | DELETE æ“ä½œ  if (key !== void 0) { add(depsMap.get(key)) } const isAddOrDelete = type === \u0026#39;add\u0026#39; || (type === \u0026#39;delete\u0026#39; \u0026amp;\u0026amp; !Array.isArray(target)) if (isAddOrDelete || (type === \u0026#39;set\u0026#39; \u0026amp;\u0026amp; target instanceof Map)) { // åˆ é™¤æˆ–æ·»åŠ æ“ä½œï¼Œæˆ–è€… map çš„è®¾ç½®æ“ä½œ  add(depsMap.get(Array.isArray(target) ? \u0026#39;length\u0026#39; : ITERATE_KEY)) } // Map çš„æ·»åŠ æˆ–åˆ é™¤æ“ä½œ  if (isAddOrDelete \u0026amp;\u0026amp; target instanceof Map) { add(depsMap.get(MAP_KEY_ITERATE_KEY)) } } // step3: æ‰§è¡Œ effects ä¸­æ‰€æœ‰çš„ dep  const run = (effect) =\u0026gt; { // é€‰é¡¹æä¾›äº†è‡ªå·±çš„è°ƒåº¦å™¨ï¼Œæ‰§è¡Œè‡ªå·±çš„  if (effect.options.scheduler) { effect.options.scheduler(effect) } else { effect() } } // è§¦å‘åº”è¯¥è§¦å‘çš„ä¾èµ–  computedRunners.forEach(run) effects.forEach(run) } // trackType -\u0026gt; get, has, iterate function track(target, type, key) { if (!shouldTrack || activeEffect === undefined) return // ...çœç•¥1 æ£€æµ‹ shouldTrack å’Œ activeEffect æ ‡è®°  // å– target è‡ªå·±çš„ä¾èµ– map ï¼Œå¦‚æœæ²¡æœ‰è¯´æ˜æ˜¯é¦–æ¬¡ï¼Œéœ€è¦ç»™å®ƒåˆ›å»ºä¸€ä¸ª  // ç©ºçš„é›†åˆï¼Œè¿™é‡Œä½¿ç”¨ Map è€Œä¸æ˜¯ WeakMapï¼Œä¸ºçš„æ˜¯å¼ºå¼•ç”¨ï¼Œå®ƒæ¶‰åŠåˆ°  // æ•°æ®çš„æ›´æ–°è§¦å‘ UI æ¸²æŸ“ï¼Œå› æ­¤ä¸è¯¥ä½¿ç”¨ WeakMapï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ä¾èµ–ä¸¢å¤±é—®é¢˜  let depsMap = targetMap.get(target) if (!depsMap) { targetMap.set(target, (depsMap = new Map())) } // æ¥ä¸‹æ¥å¯¹ key å–å…¶ä¾èµ–  // å¦‚æœå±æ€§çš„ä¾èµ–ä¸å­˜åœ¨ï¼Œè¯´æ˜è¯¥å¯¹è±¡æ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦åˆ›å»ºå…¶ä¾èµ–åº“  // ä¸”è¿™é‡Œä½¿ç”¨äº† `Set` æ˜¯ä¸ºäº†é¿å…é‡å¤æ³¨å†Œä¾èµ–æƒ…å†µï¼Œé¿å…æ•°æ®çš„æ›´æ–°å¯¼è‡´é‡å¤è§¦å‘  // åŒä¸€ä¸ª update æƒ…å†µ  let dep = depsMap.get(key) if (!dep) { depsMap.set(key, (dep = new Set())) } // æ³¨å†Œå®é™…çš„ update: activeEffect æ“ä½œ  if (!dep.has(activeEffect)) { dep.add(activeEffect) activeEffect?.deps?.push(dep) } } function createGetter(isReadonly = false, shallow = false) { // å¾ˆæ˜æ˜¾è¿™ä¸ª proxy handler get, ç®€åŒ–ä¹‹å...  return function get(target, key, receiver) { const res = Reflect.get(...arguments) // ... çœç•¥1ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œä¸”æ˜¯ includes, indexOf, lastIndexOf æ“ä½œ  // ç›´æ¥è¿”å›å®ƒå¯¹åº”çš„ res  // ... çœç•¥2ï¼Œå¦‚æœæ˜¯ç¬¦å·å±æ€§ï¼Œç›´æ¥è¿”å› res  // ... çœç•¥3, æµ… reactiveï¼Œä¸æ”¯æŒåµŒå¥—  // ... çœç•¥4ï¼ŒisRef ç±»å‹ï¼Œåˆ¤æ–­æ˜¯æ•°ç»„è¿˜æ˜¯å¯¹è±¡ï¼Œæ•°ç»„æ‰§è¡Œ track(...), å¯¹è±¡è¿”å› res.value  // éåªè¯»å±æ€§ï¼Œæ‰§è¡Œ track()ï¼Œæ”¶é›†ä¾èµ–  !isReadonly \u0026amp;\u0026amp; track(target, \u0026#39;get\u0026#39;, key) console.log(res, key, \u0026#39;get...\u0026#39;) // return res  // éå¯¹è±¡ç›´æ¥è¿”å›åŸç»“æœï¼Œå¦‚æœæ˜¯å¯¹è±¡åŒºåˆ†åªè¯»ä¸å¦  return typeof res === \u0026#39;object\u0026#39; \u0026amp;\u0026amp; res !== null ? isReadonly ? // need to lazy access readonly and reactive here to avoid  // circular dependency  res // ... readonly(res)  : reactive(res, toProxy, toRaw, mutableHandlers) : res } } function createSetter(shallow = false) { // æ ‡å‡†çš„ proxy set  return function set(target, key, value, receiver) { // å–æ—§å€¼  const oldValue = target[key] // å…ˆä¸ç®¡ shallow mode  // è¿˜è®°å¾— reactive é‡Œé¢çš„ toRawå•Šï¼Œå¯¹è±¡è¿™é‡Œå°±æ˜¯å–å‡º  // value çš„åŸå§‹å¯¹è±¡ targetï¼Œå‰ææ˜¯å®ƒæœ‰ reactive() è¿‡  // æ‰ä¼šè¢«å­˜å…¥åˆ° toRaw: observed -\u0026gt; target ä¸­  // æš‚æ—¶ç®€åŒ–æˆï¼š toRaw.get(value)  value = toRaw(value) // ... çœç•¥ï¼Œref æ£€æµ‹  console.log(target, key, value, reactiveToRaw, \u0026#39;set\u0026#39;) const hadKey = Object.hasOwnProperty(target, key) // å…ˆæ‰§è¡Œè®¾ç½®åŸå­æ“ä½œ  const result = Reflect.set(target, key, value, receiver) // åªæœ‰å¯¹è±¡æ˜¯å®ƒè‡ªèº«çš„æ—¶å€™ï¼Œæ‰è§¦å‘ dep-update(æ’é™¤åŸå‹é“¾)  if (target === toRaw(receiver)) { if (!hadKey) { // æ–°å¢å±æ€§æ“ä½œ  trigger(target, \u0026#39;add\u0026#39;, key, value) } else if (hasChanged(value, oldValue)) { // å€¼æ”¹å˜æ“ä½œ,æ’é™¤ NaN !== NaN æƒ…å†µ  trigger(target, \u0026#39;set\u0026#39;, key, value, oldValue) } } return result } } const mutableHandlers = { get, set } // baseHandlers.ts end  const collectionTypes = new Set([Set, Map, WeakMap, WeakSet]) function reactive(target, toProxy, toRaw, baseHandlers, collectionHandlers) { // ç®€åŒ–  if (typeof target !== \u0026#39;object\u0026#39;) return target //... isVue, VNode...  let observed = null const handlers = collectionTypes.has(target.constructor) ? collectionHandlers : baseHandlers observed = new Proxy(target, handlers) toProxy.set(target, observed) toRaw.set(observed, target) return observed } const r = (target) =\u0026gt; reactive(target, rawToReactive, reactiveToRaw, mutableHandlers) const fn = () =\u0026gt; console.log(\u0026#39;effect fn\u0026#39;) let res = effect(fn, {}) console.log(Object.keys(res), \u0026#39;after effect\u0026#39;) // ä½¿ç”¨ç¤ºä¾‹ let dummy const counter = r({ num: 0 }) effect(() =\u0026gt; (dummy = counter.num)) console.log(dummy, counter, \u0026#39;before\u0026#39;) counter.num = 7 console.log(dummy, counter, \u0026#39;after\u0026#39;)   æ ¸å¿ƒå‡½æ•°ï¼š\n   å‡½æ•°å åŠŸèƒ½     createGetter-\u0026gt;get åˆ›å»º proxy çš„ get handlerï¼Œé‡Œé¢ä¼šè°ƒç”¨ track æ”¶é›†ä¾èµ–   createSetter-\u0026gt;set åˆ›å»º proxy çš„ set handlerï¼Œé‡Œé¢ä¼šè°ƒç”¨ trigger è§¦å‘ targetMap\u0026gt;depsMap\u0026gt;dep:Setä¾èµ–æ‰§è¡Œ   track(target, type, key) æ”¶é›† target å¯¹è±¡æˆ– target[key] å±æ€§çš„ä¾èµ–   trigger(target, type, key?, newValue?, oldValue?, oldTarget?) è§¦å‘ target å¯¹è±¡çš„ä¾èµ–è°ƒç”¨   effect(fn, options) æ³¨å†Œreactiveå±æ€§çš„updater    æ¶‰åŠåˆ°çš„æ ¸å¿ƒå±æ€§ï¼š\nReactiveEffect ç±»å‹å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9  export interface ReactiveEffect\u0026lt;T = any\u0026gt; { (...args: any[]): T _isEffect: true id: number active: boolean raw: () =\u0026gt; T deps: Array\u0026lt;Dep\u0026gt; options: ReactiveEffectOptions }      å±æ€§å ç±»å‹ ä½œç”¨     activeEffect ReactiveEffect è®°å½•å½“å‰çš„ effectï¼Œåœ¨ effect()æ³¨å†Œupdaterçš„æ—¶å€™ç½®ä¸ºå½“å‰çš„ REï¼Œåœ¨ get-\u0026gt;track é‡Œé¢æ·»åŠ åˆ° targetMap-\u0026gt;depsMap-\u0026gt;dep ä¸­ï¼Œä¸”åŒæ—¶æ›´æ–°è‡ªå·±çš„ activeEffect.deps.push(dep)   effectStack Array\u0026lt;ReactiveEffect\u0026gt; å­˜æ”¾æ‰€æœ‰çš„ ReactiveEffect çš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´é¡µé¢ä¸­æ‰€æœ‰çš„ updater\u0026lt;ReactiveEffect\u0026gt; éƒ½æ˜¯å­˜åœ¨è¿™é‡Œé¢ã€‚ä½†æ˜¯æ¯ä¸ª updater æ‰§è¡Œå®Œä¹‹åå°±ä¼šè¢«ç§»å‡º effectStackï¼Œå› ä¸º efffect()è°ƒç”¨é‡Œé¢æœ‰ä¸ª try...finally æ— è®ºç»“æœå¦‚ä½•éƒ½ä¼šè¢« pop æ‰ã€‚   shouldTrack Boolean ç”¨æ¥è¿½è¸ªå½“å‰ effect-\u0026gt;activeEffect çš„çŠ¶æ€   trackStack Array\u0026lt;Boolean\u0026gt; ç”¨æ¥å­˜æ”¾å½“å‰ effect çš„ shouldTrack çŠ¶æ€å€¼   targetMap WeakMap å­˜æ”¾è¢« reactive å¯¹è±¡ä¾èµ–çš„ Mapï¼Œå³ï¼šæ¯ä¸ª target åœ¨ targetMap é‡Œé¢æœ‰è‡ªå·±çš„ä¸€ä¸ª depsMapï¼Œé‡Œé¢ä»¥ target =\u0026gt; \u0026lt;key, Set\u0026gt; å½¢å¼å­˜åœ¨ï¼Œkey è¡¨ç¤º target ä¸Šçš„ä¸€ä¸ªå±æ€§é”®ï¼ŒSet å­˜æ”¾äº†è¯¥ key çš„æ‰€æœ‰ä¾èµ– depã€‚å±‚çº§å…³ç³»ï¼štargetMap:WeakMap -\u0026gt; depsMap:Map -\u0026gt; dep:Set   depsMap Map target å¯¹è±¡é‡Œæ‰€æœ‰å±æ€§å’Œå…¶ä¾èµ–å¯¹åº”çš„å…³ç³»é›†åˆï¼Œå¦‚ï¼šcounter.num çš„ä¾èµ–ï¼š { \u0026quot;num\u0026quot; =\u0026gt; Set(1) }   reactiveToRaw WeakMap ä½œä¸º reactive çš„ç¬¬ä¸‰ä¸ªå‚æ•° toRawï¼Œä¿å­˜äº† observed-\u0026gt;target å…³ç³»çš„ WeakMapã€‚   rawToReactive WeakMap ä½œä¸º reactive çš„ç¬¬äºŒä¸ªå‚æ•° toProxyï¼Œä¿å­˜äº† target-\u0026gt;observed å…³ç³»çš„ WeakMapï¼Œå’Œ reactiveToRaw åˆšå¥½ç›¸åã€‚   uid Number æ¯ä¸ª effect éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œä¸€ç›´é€’å¢ã€‚    æ”¯æŒæ•°ç»„ reactive åœ¨è¿™ä¹‹å‰éƒ½æ˜¯åœ¨å¯¹è±¡åŸºç¡€ä¸Šåšçš„æµ‹è¯•ï¼Œå¹¶æ²¡æœ‰å¢åŠ æ•°ç»„çš„æ”¯æŒï¼Œæ¯”å¦‚ï¼šjest(æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½æ¥è‡ªå®˜æ–¹ä»“åº“) -\u0026gt;\n1 2 3 4 5 6 7 8 9 10 11 12 13  test(\u0026#39;åµŒå¥—çš„ reactives\u0026#39;, () =\u0026gt; { const original = { nested: { foo: 1 }, array: [{ bar: 2 }] } const observed = reactive(original) expect(isReactive(observed.nested)).toBe(true) expect(isReactive(observed.array)).toBe(true) expect(isReactive(observed.array[0])).toBe(true) })   æµ‹è¯•ç»“æœï¼š\nä¹Ÿå°±æ˜¯è¯´åšåˆ°ç°åœ¨ï¼Œå¹¶ä¸æ”¯æŒæ•°ç»„çš„ reactiveï¼Œè¿™ä¹Ÿæ˜¯è¿™èŠ‚å°†è¦å®Œå–„çš„ç‚¹ã€‚\n  æ•°ç»„ä¸‰ä¸ªæ–¹æ³•(includes, indexOf, lastIndexOf)çš„ä¾èµ–æ”¶é›†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // æ•°ç»„ä¸‰ä¸ªæ–¹æ³•çš„å¤„ç† const arrayInstrumentations = {} // å…¼å®¹æ•°ç»„ä¸‰ä¸ªç´¢å¼•æ–¹æ³•ï¼Œæ”¶é›†ä»–ä»¬ç›¸å…³çš„ä¾èµ– ;[\u0026#39;includes\u0026#39;, \u0026#39;indexOf\u0026#39;, \u0026#39;lastIndexOf\u0026#39;].forEach((key) =\u0026gt; { arrayInstrumentations[key] = function (...args) { const arra = toRaw(this) for (let i = 0, l = this.length; i \u0026lt; l; i++) { track(arr, \u0026#39;get\u0026#39;, i + \u0026#39;\u0026#39;) } // ä½¿ç”¨åŸå§‹æ–¹æ³•æ‰§è¡Œä¸€æ¬¡(æœ‰å¯èƒ½æ˜¯ reactive çš„)  const res = arr[key](...args) if (res === -1 || res === false) { // å¦‚æœç»“æœå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–¹æ³•å†æ‰§è¡Œä¸€æ¬¡  return arr[key](...args.map(toRaw)) } else { return res } } })     createGetter -\u0026gt; get çš„æ—¶å€™å¢åŠ æ•°ç»„æ”¯æŒï¼š\n1 2 3 4 5 6 7 8 9 10  function createGetter(isReadonly = false, shallow = false) { return function get(target, key, receiver) { const targetIsArray = Array.isArray(target) if (targetIsArray \u0026amp;\u0026amp; hasOwn(arrayInstrumentations, key)) { return Reflect.get(arrayInstrumentations, key, receiver) } // ...çœç•¥  } }   åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æ­£å¸¸æ”¶é›†åˆ°æ•°ç»„çš„ä¾èµ–äº†ï¼Œæµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10  \u0026lt;script type=\u0026#34;module\u0026#34;\u0026gt; import { reactive, effect, targetMap } from \u0026#39;./packages/reactive.js\u0026#39; let n let arr = [\u0026#39;vue\u0026#39;, \u0026#39;reactive\u0026#39;] const observed = reactive(arr) effect(() =\u0026gt; (n = observed[0])) // è¿™é‡Œè¿˜å¯ä»¥æ·»åŠ å¤šä¸ªä¾èµ–ï¼Œæ¯”å¦‚ï¼šeffect(() =\u0026gt; (m = observed[0]))  // è¿™æ ·ï¼ŒtargetMap\u0026gt;depsMap:arr\u0026gt;dep é‡Œé¢å°±ä¼šæœ‰ä¸¤ä¸ªäº† [f, f]  console.log({n, targetMap}) \u0026lt;/script\u0026gt;   è¾“å‡ºç»“æœï¼š\n![image-20200519095740412](/Users/simon/Library/Application Support/typora-user-images/image-20200519095740412.png)\n effect(() =\u0026gt; (n = observed[0]))ä¼šæ‰§è¡Œä¸€æ¬¡ fn ï¼Œå³å–äº†ä¸€æ¬¡æ•°ç»„çš„ 0 ä¸‹æ ‡å€¼ï¼Œè§¦å‘äº† get æ£€æµ‹åˆ°æ˜¯æ•°ç»„è¿›å…¥æ•°ç»„ä¾èµ–æ”¶é›†ç¨‹åºarrayInstrumentations ï¼Œè§¦å‘ track æ”¶é›†ä¾èµ–  ğŸ™†â€â™‚ï¸ï¼Œä¾èµ–å’±æ”¶é›†åˆ°äº†ï¼Œç¬¬ä¸‰æ­¥å°±æ˜¯å¦‚ä½•å»è§¦å‘å®ƒä»¬äº† \u0026raquo;\u0026raquo;\n  æ•°ç»„çš„ set-\u0026gt;trigger å®é™…ä¸Šå·²ç»æ”¯æŒäº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // è§¦å‘ updater function trigger(target, type, key, newValue, oldValue, oldTarget) { // ...  if (type === \u0026#39;clear\u0026#39;) { // ...  } else if (key === \u0026#39;length\u0026#39; \u0026amp;\u0026amp; Array.isArray(target)) { // ...  } else { // å¦‚æœæ˜¯æ•°ç»„ï¼Œä¼ å…¥ key æ˜¯ç´¢å¼•å€¼ï¼Œä¼šè¿›å…¥è¿™ä¸ª if è¿›è¡Œä¾èµ–æ”¶é›†  if (key !== void 0) { // å¯¹è±¡å±æ€§ deps  add(depsMap.get(key)) } // ...  }   æ‰€ä»¥ä¸‹é¢çš„ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11  \u0026lt;script type=\u0026#34;module\u0026#34;\u0026gt; import { reactive, effect, targetMap } from \u0026#39;./packages/reactive.js\u0026#39; let n, m let arr = [\u0026#39;vue\u0026#39;, \u0026#39;reactive\u0026#39;] const observed = reactive(arr) effect(() =\u0026gt; (n = observed[0])) effect(() =\u0026gt; (m = observed[0])) observed[0] = \u0026#39;setter n\u0026#39; observed[1] = \u0026#39;setter m\u0026#39; console.log({n, m, targetMap}) \u0026lt;/script\u0026gt;   è¾“å‡ºç»“æœ(set æ•°ç»„å…ƒç´ å€¼çš„æ—¶å€™å‡ºå‘äº† dep æ›´æ–° n, m çš„å€¼)ï¼š\n   æœ€å jest æµ‹è¯•ç»“æœ(å¤±è´¥\u0026hellip;): åŸå› æ˜¯ä¹‹å‰çš„ createGetterä»£ç åˆæœ‰ä¸ªé—®é¢˜ï¼Œè¿”å›çš„æ—¶å€™æ£€æµ‹ç»“æœçš„æ—¶å€™ï¼Œé€’å½’ reactive ä¼ é€’äº† targetï¼Œåº”è¯¥æ˜¯ res æ‰å¯¹ï¼š\n1 2 3 4 5  return res \u0026amp;\u0026amp; typeof res === \u0026#39;object\u0026#39; ? isReadonly ? readonly(target) // ä¿®æ­£ï¼štarget -\u0026gt; res  : reactive(target) // ä¿®æ­£ï¼štarget -\u0026gt; res  : res   ä¿®æ­£ä¹‹å jest ç»“æœ(:perfect)ï¼š\n â˜ vue-next-code-read [master] âš¡ jest PASS packages/tests/reactive/reactive.spec.js reactivity/reactive âœ“ Object (4 ms) âœ“ åµŒå¥—çš„ reactives (1 ms)\nTest Suites: 1 passed, 1 total Tests: 2 passed, 2 total Snapshots: 0 total Time: 7.547 s Ran all test suites. â˜ vue-next-code-read [master] âš¡\n   OKï¼Œæ•°ç»„çš„ reactive å®Œæˆã€‚\n jest æµ‹è¯•ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  â˜ vue-next-code-read [master] âš¡ jest FAIL packages/__tests__/reactive/reactive.spec.js reactivity/reactive âœ“ Object (5 ms) âœ“ åµŒå¥—çš„ reactives (1 ms) âœ“ observed value should proxy mutations to original (Object) (1 ms) âœ“ setting a property with an unobserved value should wrap with reactive (1 ms) âœ• observing already observed value should return same Proxy (4 ms) âœ• should not pollute original object with Proxies (2 ms) âœ• unwrap âœ“ should not unwrap Ref\u0026lt;T\u0026gt; âœ“ should unwrap computed refs âœ• non-observable values (36 ms) âœ• markRaw âœ• should not observe frozen objects (1 ms) shallowReactive âœ• should not make non-reactive properties reactive âœ• should keep reactive properties reactive     âœ• observing already observed value should return same Proxy (4 ms) è¿™ä¸ªæ˜¯å› ä¸º createReactiveObject()é‡Œé¢åˆ¤æ–­çš„æ—¶å€™åˆ¤æ–­é”™è¯¯ï¼š\n1 2 3  if (toRaw.has(observed)) { // ä¿®æ­£æˆï¼štarget  return target }   ä¿®æ”¹åæµ‹è¯•é€šè¿‡ã€‚\n  âœ• should not pollute original object with Proxies (5 ms) ä¿®æ”¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function createSetter(shallow = false) { return function set(target, key, value, receiver) { // æ–°å¢åˆ¤æ–­ï¼Œå¦‚æœæ˜¯é€’å½’ reactive è®¾ç½®çš„æ—¶å€™å–åŸå§‹å€¼å»ä¼ é€’ç»™ reflect  if (!shallow) { // æ¯”å¦‚ï¼švalue å¦‚æœæ˜¯ Observedï¼Œé‚£ä¹ˆä» reactiveToRaw ä¸­å– proxy  // ä¹‹å‰çš„é‚£ä¸ª target å‡ºæ¥ï¼Œç»™ reflect  value = toRaw(value) // TODO !shallow is ref  } // const res = Reflect.set(...arguments)  // è¿™é‡Œå°±ä¸èƒ½ç›´æ¥ ...arguments äº†ï¼Œéƒ½å°†æœ€æ–°çš„ value ä¼ é€’ä¸‹å»  const res = Reflect.set(target, key, value, receiver) }   ä¿®æ”¹åæµ‹è¯•é€šè¿‡ã€‚\n  âœ• unwrap æ˜¯å› ä¸ºæ²¡æœ‰å¯¼å‡º toRaw å‡½æ•°å¯¼è‡´çš„ï¼Œå¯¼å…¥ä¸‹å°±å¥½äº†ã€‚\n  âœ• non-observable values (8 ms) éœ€è¦æ”¹äº›ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼šæºç é‡Œé¢åŠ äº† expect -\u0026gt; toHaveBeenWarnedLast ä¸ºäº†æ›´å‹å¥½çš„æç¤ºã€‚\n1 2 3 4 5 6 7 8  /// ä¿®æ”¹åï¼š expect(reactive(1)).toBe(1) expect(reactive(\u0026#39;foo\u0026#39;)).toBe(\u0026#39;foo\u0026#39;) expect(reactive(false)).toBe(false) expect(reactive(null)).toBe(null) expect(reactive(undefined)).toBe(undefined) const s = Symbol() expect(reactive(s)).toBe(s)     âœ• markRaw åœ¨ createReactiveObject() ä¸­å¢åŠ  canObserve(target) æ£€æµ‹è§£å†³ï¼Œå› ä¸ºæ£€æµ‹ä¸­å°±æœ‰ä¸€é¡¹ rawValues.has(value)\n  âœ• should not observe frozen objects (1 ms) åœ¨ createReactiveObject() ä¸­å¢åŠ  canObserve(target) æ£€æµ‹è§£å†³ã€‚\n  âœ• should not make non-reactive properties reactive æ²¡å¯¼å‡º shallowReactiveã€‚\n  âœ• should keep reactive properties reactive\n1 2 3 4 5 6 7  // ç²—å¿ƒçš„é”…ï¼Œè¿™ä¸ªå†™åäº† const shallowSet = createGetter(false, true) const shallowGet = createSetter(true) // ä¿®æ­£ï¼š const shallowSet = createSetter(true) const shallowGet = createSetter(false, true)     ä¿®æ­£ä¸Šè¿°é—®é¢˜ä¹‹å jest ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  vue-next-code-read [master] âš¡ jest PASS packages/__tests__/reactive/reactive.spec.js reactivity/reactive âœ“ Object (6 ms) âœ“ åµŒå¥—çš„ reactives âœ“ observed value should proxy mutations to original (Object) (1 ms) âœ“ setting a property with an unobserved value should wrap with reactive (1 ms) âœ“ observing already observed value should return same Proxy âœ“ should not pollute original object with Proxies (1 ms) âœ“ unwrap âœ“ should not unwrap Ref\u0026lt;T\u0026gt; (1 ms) âœ“ should unwrap computed refs âœ“ non-observable values (2 ms) âœ“ markRaw (1 ms) âœ“ should not observe frozen objects (1 ms) shallowReactive âœ“ should not make non-reactive properties reactive âœ“ should keep reactive properties reactive Test Suites: 1 passed, 1 total Tests: 14 passed, 14 total Snapshots: 0 total Time: 6.436 s Ran all test suites.   é˜¶æ®µä»£ç é“¾æ¥ reactive_with_array.js ä»£ç \nhandlersç»­(baseHandlers çš„ delete, has, ownKeys) å‰é¢å®Œæˆäº† proxy-set å’Œ proxy-getï¼Œè¿™èŠ‚ç»§ç»­å®Œæˆå…¶ä»–çš„ proxyï¼ŒåŒ…å«ï¼š\n deleteProperty(target, key) ownKeys(target) has(target, key)  delete åœ¨ä¹‹å‰å®ç°çš„åŸºç¡€ä¸Š reactive.js å¢åŠ  delete proxyï¼Œè¿™ä¹‹å‰å…ˆæ¥çœ‹ä¸‹ç°æœ‰çš„åŠŸèƒ½æ˜¯å¦æ”¯æŒ delete æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  const target = { foo: 1, bar: 2 } const n = reactive(target) let dum effect(() =\u0026gt; { console.log(\u0026#39;updating...\u0026#39;) dum = n.bar }) /* console.log(targetMap.get(target), dum, \u0026#39;map\u0026#39;) */ console.log({ dum }, \u0026#39;before\u0026#39;) delete n.bar // code 1 // n.bar = 3 // code2 console.log({ dum }, \u0026#39;after\u0026#39;)   è¿™é‡Œå…ˆæ³¨å†Œä¸€ä¸ª updaterï¼Œåé¢é€šè¿‡æ›´æ–° n.bar å€¼ï¼Œæ¥è§¦å‘ updaterï¼Œç»“æœï¼š\n updating\u0026hellip; {dum: 2} \u0026ldquo;before\u0026rdquo; updating\u0026hellip; {dum: 3} \u0026ldquo;after\u0026rdquo;\n ç»“æœå¦‚æˆ‘ä»¬æ‰€æ–™ï¼Œç„¶åæŠŠ code1 æ”¾å¼€ï¼Œæ³¨é‡Šæ‰ code2ï¼Œç†è®ºä¸Šä¹Ÿä¼šè§¦å‘ updaterï¼š\n updating\u0026hellip; {dum: 2} \u0026ldquo;before\u0026rdquo; {dum: 2} \u0026ldquo;after\u0026rdquo;\n å®é™…ç»“æœéæˆ‘ä»¬æ‰€æ–™ï¼Œå› ä¸ºè¿˜æ²¡å®ç°\u0026hellip;\u0026hellip;\næ¥ä¸‹æ¥çœ‹ä¸‹è¦å®ç° delete proxy éœ€è¦å“ªäº›æ­¥éª¤ \u0026raquo;\u0026raquo;\u0026raquo;\n  å£°æ˜ delete proxy handler : deleteProperty\n1 2 3 4 5 6 7 8 9 10 11 12 13  // delete proxy function deleteProperty(target, key) { const hadKey = target.hasOwnProperty(key) const oldValue = target[key] // æ“ä½œå…ˆæ‰§è¡Œä¸‹å»  const result = Reflect.deleteProperty(target, key) // å¦‚æœæ‰§è¡ŒæˆåŠŸä¸”è‡ªèº«å­˜åœ¨è¯¥å±æ€§ï¼Œæ’é™¤åŸå‹é“¾æ“ä½œ  if (result \u0026amp;\u0026amp; hadKey) { // ç›´æ¥è§¦å‘ updaters  trigger(target, \u0026#39;delete\u0026#39;, key, undefined, oldValue) } return result // ä¸èƒ½ä¸¢ï¼Œå¿…é¡»åé¦ˆåˆ é™¤ç»“æœ boolean }     åŠ å…¥åˆ°mutableHandlers\n1 2 3 4 5  const mutableHandlers = { get, set, deleteProperty }     åªè¦ç»è¿‡ä¸Šé¢ç®€å•çš„ä¸¤æ­¥å°±å®ç°äº† delete æ“ä½œä»£ç†ï¼Œä½†æ‰§è¡Œç»“æœå´æŠ¥é”™äº†(æ˜æ˜å’Œæºç ä¸€æ ·å•Šï¼Œæ‚²å‚¬ã€’â–½ã€’!!!)\nä»è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œ delete æ“ä½œç¡®å®è§¦å‘äº† updaterï¼Œæœ€å dum: undefined ä¹Ÿè¯æ˜äº†è¿™ç‚¹ã€‚\nè‡³äºæŠ¥é”™\u0026hellip;ï¼Œ(âŠ™oâŠ™)â€¦ï¼Œ(âŠ™oâŠ™)â€¦ï¼Œå°‘äº†ä¸ª return result å°†åˆ é™¤æ“ä½œç»“æœè¿”å›ã€‚\nhas 1 2 3 4 5  function has(target, key) { const result = Reflect.has(target, key) track(target, \u0026#39;has\u0026#39;, key) return result }   æ›´æ–° mutableHandlers:\n1 2 3 4 5 6  const mutableHandlers = { get, set, deleteProperty, has }   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const target = { foo: 1, bar: 2 } const n = reactive(target) let dum, has const updater = () =\u0026gt; { console.log(\u0026#39;updating...\u0026#39;) dum = \u0026#39;bar\u0026#39; in n } effect(updater) const dep = targetMap.get(target).get(\u0026#39;bar\u0026#39;) for (let fn of dep) { console.log(fn.raw, fn.raw === updater, \u0026#39;deps\u0026#39;) } console.log({ dum }, \u0026#39;before\u0026#39;) n.bar = 3 console.log({ dum }, \u0026#39;after\u0026#39;)   ç»“æœï¼š\n 'bar' in n æ”¶é›†ä¾èµ– updater n.bar = 3 è§¦å‘ ownKeys æ”¶é›†åˆ°çš„ updater   updating\u0026hellip; () =\u0026gt; { console.log(\u0026lsquo;updating\u0026hellip;') dum = \u0026lsquo;bar\u0026rsquo; in n } true \u0026ldquo;deps\u0026rdquo; {dum: true} \u0026ldquo;before\u0026rdquo; updating\u0026hellip; {dum: true} \u0026ldquo;after\u0026rdquo;\n ownKeys 1 2 3 4  function ownKeys(target) { track(target, \u0026#39;iterate\u0026#39;, ITERATE_KEY) return Reflect.ownKeys(target) }   æ›´æ–° mutableHandlers:\n1 2 3 4 5 6 7  const mutableHandlers = { get, set, deleteProperty, has, ownKeys }   æ³¨æ„ ownKeys çš„å®ç°é‡Œä½¿ç”¨åˆ° äº†ä¸€ä¸ª Symbol: ITERATE_KEYï¼Œå¼€å§‹ä¸€ç›´ä¸æ˜ç™½ trigger é‡Œä¸ºå•¥ä¼šç”¨åˆ°è¿™ä¸ªå» depsMap.get(ITERRATE_KEY)ï¼Œè¿™é‡Œåº”è¯¥æ˜ç™½æ˜¯æ€ä¹ˆå›äº‹äº†ï¼Œå°±æ˜¯é’ˆå¯¹å¯¹è±¡çš„è¿­ä»£å™¨æ“ä½œçš„æ—¶å€™ï¼Œä½¿ç”¨åˆ° ownKeysï¼Œéœ€è¦å¯¹è¯¥æ“ä½œæ”¶é›†ä¾èµ–ï¼Œé‚£ä¹ˆå°±éœ€è¦æœ‰ä¸ªå”¯ä¸€çš„ key å»è®¾ç½® targetMap, depsMapï¼Œè¿™é‡Œçš„ ITERATE_KEY å°±æ˜¯è¿™ä¸ªä½œç”¨ï¼Œç”¨å®ƒæ¥æ”¶é›†(track)å¯¹è±¡è¿­ä»£æ“ä½œçš„æ‰€æœ‰ä¾èµ–ï¼Œç„¶åé€šè¿‡ trigger é‡Œé¢æŸ¥æ‰¾è¿™ä¸ªç¬¦å·å€¼å»å–æ‰€æœ‰ updatersã€‚\næµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const target = { foo: 1, bar: 2 } const n = reactive(target) let dum, has const updater = () =\u0026gt; { console.log(\u0026#39;updating...\u0026#39;) dum = Object.keys(n) // è§¦å‘ä¾èµ–æ”¶é›† } effect(updater) const dep = targetMap.get(target).get(ITERATE_KEY) for (let it of dep) { console.log(it.raw, it.raw === updater, \u0026#39;deps\u0026#39;) } console.log(dum, \u0026#39;before\u0026#39;) n.bar = 3 // è§¦å‘ updaters console.log(dum, \u0026#39;after\u0026#39;)   ç»“æœï¼š\n updating\u0026hellip; {foo: 1, bar: 2} \u0026ldquo;own keys\u0026rdquo; () =\u0026gt; { console.log(\u0026lsquo;updating\u0026hellip;') dum = Object.keys(n) } true \u0026ldquo;deps\u0026rdquo; (2) [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] \u0026ldquo;before\u0026rdquo; (2) [\u0026ldquo;foo\u0026rdquo;, \u0026ldquo;bar\u0026rdquo;] \u0026ldquo;after\u0026rdquo;\n ä½†æ˜¯å‘ç°å¹¶æ²¡æœ‰è§¦å‘ updatersã€‚\ntrigger é‡Œé¢åŠ æ‰“å°ç»“æœï¼š\n1 2 3 4 5 6 7 8 9  // éæ•°ç»„çš„åˆ é™¤æˆ–æ·»åŠ æ“ä½œ const isAddOrDelete = type === \u0026#39;add\u0026#39; || (type === \u0026#39;delete\u0026#39; \u0026amp;\u0026amp; !Array.isArray(target)) console.log({ type, key }, target instanceof Map) // å¯¹è±¡çš„å±æ€§çš„æ–°å¢å’Œåˆ é™¤ï¼Œæˆ–è€… Map ç±»å‹çš„ set æ“ä½œ if (isAddOrDelete || (type === \u0026#39;set\u0026#39; \u0026amp;\u0026amp; target instanceof Map)) { add(depsMap.get(Array.isArray(target) ? \u0026#39;length\u0026#39; : ITERATE_KEY)) }   è¾“å‡º {type: \u0026quot;set\u0026quot;, key: \u0026quot;foo\u0026quot;} false è¯´æ˜ç¡®å®æœ‰è§¦å‘ triggerï¼Œä½†æ˜¯æ¡ä»¶ï¼š\nif (isAddOrDelete || (type === 'set' \u0026amp;\u0026amp; target instanceof Map))\né˜»æ­¢äº†å®ƒè¿›å…¥ add æ”¶é›† ITERATE_KEY å¯¹åº”çš„ä¾èµ–ï¼Œå› ä¸º target ä¸æ˜¯ Map ç±»å‹ã€‚\nTODO ä¸ºå•¥ä¼šè¿™æ ·ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ\njest æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233  â˜ vue-next-code-read [master] âš¡ jest PASS packages/__tests__/reactive/reactive.spec.js FAIL packages/__tests__/reactive/effect.spec.js â— reactivity/effect â€º should observe iteration expect(received).toBe(expected) // Object.is equality Expected: \u0026#34;Hello World!\u0026#34; Received: \u0026#34;Hello\u0026#34; 161 | expect(dummy).toBe(\u0026#39;Hello\u0026#39;) 162 | list.push(\u0026#39;World!\u0026#39;) \u0026gt; 163 | expect(dummy).toBe(\u0026#39;Hello World!\u0026#39;) \u0026gt; | ^ \u0026gt; 164 | list.shift() \u0026gt; 165 | expect(dummy).toBe(\u0026#39;World!\u0026#39;) \u0026gt; 166 | }) at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:163:19) â— reactivity/effect â€º should observe implicit array length changes expect(received).toBe(expected) // Object.is equality Expected: \u0026#34;Hello World!\u0026#34; Received: \u0026#34;Hello\u0026#34; 173 | expect(dummy).toBe(\u0026#39;Hello\u0026#39;) 174 | list[1] = \u0026#39;World!\u0026#39; \u0026gt; 175 | expect(dummy).toBe(\u0026#39;Hello World!\u0026#39;) \u0026gt; | ^ \u0026gt; 176 | list[3] = \u0026#39;Hello!\u0026#39; \u0026gt; 177 | expect(dummy).toBe(\u0026#39;Hello World! Hello!\u0026#39;) \u0026gt; 178 | }) at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:175:19) â— reactivity/effect â€º should observe enumeration expect(received).toBe(expected) // Object.is equality Expected: 7 Received: 3 203 | expect(dummy).toBe(3) 204 | numbers.num2 = 4 \u0026gt; 205 | expect(dummy).toBe(7) \u0026gt; | ^ \u0026gt; 206 | delete numbers.num1 \u0026gt; 207 | expect(dummy).toBe(4) \u0026gt; 208 | }) at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:205:19) â— reactivity/effect â€º should not observe well-known symbol keyed properties expect(received).toBe(expected) // Object.is equality Expected: undefined Received: true 234 | array[key] = true 235 | expect(array[key]).toBe(true) \u0026gt; 236 | expect(dummy).toBe(undefined) \u0026gt; | ^ \u0026gt; 237 | }) \u0026gt; 238 | \u0026gt; 239 | it(\u0026#39;should observe function valued properties\u0026#39;, () =\u0026gt; { at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:236:19) â— reactivity/effect â€º should observe json methods expect(received).toBe(expected) // Object.is equality Expected: 1 Received: undefined 523 | }) 524 | obj.a = 1 \u0026gt; 525 | expect(dummy.a).toBe(1) \u0026gt; | ^ \u0026gt; 526 | }) \u0026gt; 527 | \u0026gt; 528 | it(\u0026#39;should observe class method invocations\u0026#39;, () =\u0026gt; { at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:525:21) â— reactivity/effect â€º scheduler expect(jest.fn()).toHaveBeenCalledTimes(expected) Expected number of calls: 1 Received number of calls: 0 573 | // should be called on first trigger 574 | obj.foo++ \u0026gt; 575 | expect(scheduler).toHaveBeenCalledTimes(1) \u0026gt; | ^ \u0026gt; 576 | // should not run yet \u0026gt; 577 | expect(dummy).toBe(1) \u0026gt; 578 | // manually run at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:575:23) â— reactivity/effect â€º events: onTrack expect(jest.fn()).toHaveBeenCalledTimes(expected) Expected number of calls: 3 Received number of calls: 0 598 | ) 599 | expect(dummy).toEqual([\u0026#39;foo\u0026#39;, \u0026#39;bar\u0026#39;]) \u0026gt; 600 | expect(onTrack).toHaveBeenCalledTimes(3) \u0026gt; | ^ \u0026gt; 601 | expect(events).toEqual([ \u0026gt; 602 | { \u0026gt; 603 | effect: runner, at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:600:21) â— reactivity/effect â€º events: onTrigger expect(jest.fn()).toHaveBeenCalledTimes(expected) Expected number of calls: 1 Received number of calls: 0 637 | obj.foo++ 638 | expect(dummy).toBe(2) \u0026gt; 639 | expect(onTrigger).toHaveBeenCalledTimes(1) \u0026gt; | ^ \u0026gt; 640 | expect(events[0]).toEqual({ \u0026gt; 641 | effect: runner, \u0026gt; 642 | target: toRaw(obj), at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:639:23) â— reactivity/effect â€º stop TypeError: (0 , _reactive2.stop) is not a function 667 | obj.prop = 2 668 | expect(dummy).toBe(2) \u0026gt; 669 | stop(runner) \u0026gt; | ^ \u0026gt; 670 | obj.prop = 3 \u0026gt; 671 | expect(dummy).toBe(2) \u0026gt; 672 | at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:669:5) â— reactivity/effect â€º stop with scheduler expect(received).toBe(expected) // Object.is equality Expected: 1 Received: 2 689 | ) 690 | obj.prop = 2 \u0026gt; 691 | expect(dummy).toBe(1) \u0026gt; | ^ \u0026gt; 692 | expect(queue.length).toBe(1) \u0026gt; 693 | stop(runner) \u0026gt; 694 | at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:691:19) â— reactivity/effect â€º events: onStop TypeError: (0 , _reactive2.stop) is not a function 704 | }) 705 | \u0026gt; 706 | stop(runner) \u0026gt; | ^ \u0026gt; 707 | expect(onStop).toHaveBeenCalled() \u0026gt; 708 | }) \u0026gt; 709 | at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:706:5) â— reactivity/effect â€º stop: a stopped effect is nested in a normal effect TypeError: (0 , _reactive2.stop) is not a function 714 | dummy = obj.prop 715 | }) \u0026gt; 716 | stop(runner) \u0026gt; | ^ \u0026gt; 717 | obj.prop = 2 \u0026gt; 718 | expect(dummy).toBe(1) \u0026gt; 719 | at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:716:5) â— reactivity/effect â€º should trigger all effects when array length is set 0 expect(received).toBe(expected) // Object.is equality Expected: 3 Received: 1 773 | 774 | observed.unshift(3) \u0026gt; 775 | expect(dummy).toBe(3) \u0026gt; | ^ \u0026gt; 776 | expect(record).toBe(3) \u0026gt; 777 | \u0026gt; 778 | observed.length = 0 at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:775:19) Test Suites: 1 failed, 1 passed, 2 total Tests: 13 failed, 49 passed, 62 total Snapshots: 0 total Time: 2.917 s, estimated 3 s Ran all test suites.   å…¨æ˜¯å¤±è´¥å•Šï¼ï¼ï¼\nè¿˜æ˜¯è€è€å®å®çš„ä¸€ä¸ªä¸ªæ¥è§£å†³å§\u0026hellip;\u0026hellip;\n  â— reactivity/effect â€º should observe iteration\næ•°ç»„æ“ä½œå¤±è´¥ï¼Œpush çš„æ—¶å€™æ²¡æœ‰è§¦å‘ updaterã€‚\nç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11  const list = reactive([\u0026#39;Hello\u0026#39;]) let dummy effect(() =\u0026gt; { console.log(\u0026#39;updating....\u0026#39;) dummy = list.join(\u0026#39; \u0026#39;) }) console.log(targetMap, \u0026#39;dep\u0026#39;) console.log(dummy, \u0026#39;1\u0026#39;) list[0] = \u0026#39;hello\u0026#39; /* list.push(\u0026#39;World!\u0026#39;) */ console.log(dummy, \u0026#39;2\u0026#39;)   ç»“æœ(ç›´æ¥ç´¢å¼•èµ‹å€¼æ˜¯ç”Ÿæ•ˆçš„ï¼Œé‚£ä¹ˆä¸ºå•¥ push æ²¡ç”¨ï¼Ÿï¼Ÿï¼Ÿ)ï¼š\n updating\u0026hellip;. test.html:20 WeakMap {Array(1) =\u0026gt; Map(3)} \u0026ldquo;dep\u0026rdquo; test.html:21 Hello 1 test.html:17 updating\u0026hellip;. test.html:24 hello 2\n åœ¨ list.push('World!') å¤„æ‰“ä¸ªæ–­ç‚¹ï¼š\nå…ˆè§¦å‘çš„æ˜¯list çš„ get push :\nç„¶åå†æ˜¯è§¦å‘çš„ length get\nè§¦å‘ key: 1 çš„ updaterï¼Œä½†æœ€åæ²¡æœ‰ä»»ä½•ä¾èµ–è¢«å‘ç°ï¼Ÿï¼Ÿï¼Ÿ\nçœ‹æœ€åçš„å›¾å‘ç°é—®é¢˜ï¼Œé¦–å…ˆï¼Œæ•°ç»„å°±ä¸€ä¸ªå…ƒç´ ï¼Œé•¿åº¦ä¸º1ï¼Œæœ€å¤§ç´¢å¼•ä¸º0ï¼Œåœ¨ push ä¹‹åï¼Œé•¿åº¦ä¸º2ï¼Œæœ€å¤§ç´¢å¼•ä¸º1ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–°çš„ç´¢å¼•å³æ–°çš„ keyï¼Œå±äºæ–°å¢å±æ€§æ“ä½œï¼Œåº”è¯¥è¦èµ°åˆ° trigger:add ï¼Œä½†æ˜¯å®é™…èµ°äº† trigger:set é‡Œé¢å»äº†ã€‚\né—®é¢˜å°±åœ¨ if(!target.hasOwnProperty(key)) è¿™ä¸€è¡Œï¼Œå®ƒä¸åº”è¯¥å– Reflect.set(...) ä¹‹åçš„ target å› ä¸ºè¿™æ˜¯æ›´æ–°ä¹‹åçš„ï¼Œè‚¯å®šæœ‰ key: 1äº†ã€‚\nä¿®æ”¹ï¼š\nåœ¨ Reflect.set(...) ä¹‹å‰å…ˆ hadKey = target.hasOwnProperty(key) ç„¶åä½¿ç”¨ç¼“å­˜çš„ hadKey è¿›è¡Œåˆ¤æ–­ if(!hadKey) {...}ã€‚\nä¿®æ”¹ä¹‹åæµ‹è¯•é€šè¿‡ï¼š\n â˜ vue-next-code-read [master] âš¡ jest PASS packages/tests/reactive/reactive.spec.js PASS packages/tests/reactive/effect.spec.js\nTest Suites: 2 passed, 2 total Tests: 26 passed, 26 total Snapshots: 0 total Time: 7.645 s Ran all test suites.\n   â— reactivity/effect â€º should not observe well-known symbol keyed properties\njs å†…ç½®çš„ç¬¦å·å±æ€§ï¼Œä¸èƒ½è¢« observeï¼Œè¿™æ˜¯å› ä¸º createGetter é‡Œé¢è¿˜æ²¡å®Œæˆ Symbol ç±»å‹çš„æ£€æµ‹ï¼Œä¸‹é¢åŠ ä¸Šå°±OKäº†ã€‚\néœ€è¦å¢åŠ ä»¥ä¸‹å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // 1. ç¬¦å·ç±»å‹æ£€æµ‹ const isSymbol = (val) =\u0026gt; typeof val === \u0026#39;symbol\u0026#39; // 2. Symbol ä¸Šçš„æ‰€æœ‰ç¬¦å·å±æ€§ const builtInSymbols = new Set( Object.getOwnPropertyNames(Symbol) .map(key =\u0026gt; (Symbol)[key]) .filter(isSymbol) ) // 3. createGetterä¸­å¢åŠ åˆ¤æ–­ function createGetter(...arg) { // ...  if (isSymbol(key) \u0026amp;\u0026amp; builtInSymbols.has(key) || key === \u0026#39;__proto__\u0026#39;) { return res } // .... }   é‡æµ‹ jest é€šè¿‡ã€‚\n  â— reactivity/effect â€º scheduler çœŸæ€€ç–‘å½“æ—¶è‡ªå·±æ˜¯æ•…æ„çš„ï¼Œå°½æ˜¯äº›åœ°çº§é”™è¯¯ï¼ˆæ‚è„¸ï¼ŒğŸ¤¦â€â™€ï¸ï¼Œ(/Ï‰ï¼¼)ï¼‰ï¼ï¼ï¼\n1 2 3 4  // ä¿®æ”¹å‰ï¼š // if (effect.options \u0026amp;\u0026amp; effect.options.shecduler) { // ä¿®æ”¹åï¼š if (effect.options \u0026amp;\u0026amp; effect.options.scheduler) {     â— reactivity/effect â€º events: onTrack\n  â— reactivity/effect â€º events: onTrigger\nä¸¤ä¸ªæ˜¯åœ¨ DEV æ¨¡å¼ä¸‹æ‰ä¼šæ‰§è¡Œçš„ï¼Œæ²¡æœ‰å®Œæˆï¼Œç°åœ¨ç»™åŠ ä¸Šå»å§ã€‚\nTrack é‡Œé¢ï¼Œåœ¨ if dep.has æœ€åé¢å¢åŠ ç»Ÿè®¡äº‹ä»¶ onTrackï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function track(target, type, key) { // ...  if (!dep.has(activeEffect)) { // ...  if (__DEV__ \u0026amp;\u0026amp; activeEffect.options \u0026amp;\u0026amp; activeEffect.options.onTrack) { activeEffect.options.onTrack({ effect: activeEffect, target, type, key }) } } }   Trigger é‡Œé¢ï¼Œåœ¨æ‰§è¡Œ updaters çš„å¼€å¤´å¢åŠ  onTrigger äº‹ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function trigger(target, type, key, newValue, oldValue, oldTarget) { // ...  const run = (effect) =\u0026gt; { const hasOpt = !!effect.options if (__DEV__ \u0026amp;\u0026amp; hasOpt \u0026amp;\u0026amp; effect.options.onTrigger) { effect.options.onTrigger({ effect, target, key, type, newValue, oldValue, oldTarget }) } // ...  } }   åŠ å®Œï¼Œjest é€šè¿‡ã€‚\n  â— stop å¢åŠ  stop å‡½æ•°ï¼Œåœæ­¢ effect è¡Œä¸ºï¼Œä¸»è¦é€šè¿‡ effect.activeï¼Œæ¸…ç† effect.deps æ¥æ§åˆ¶ï¼Œé˜»æ­¢è§¦å‘ depsã€‚\n1 2 3 4 5 6 7 8 9  function stop(effect) { if (effect.active) { cleanup(effect) if (effect.options \u0026amp;\u0026amp; effect.options.onStop) { effect.options.onStop() } effect.active = false } }     åˆ°æ­¤ effect.spec.ts ä¸­é™¤äº† ref æœ‰å…³çš„æµ‹è¯•ç”¨ä¾‹å…¨éƒ¨æµ‹è¯•é€šè¿‡ï¼Œ\nä¸‹é¢æ¥é€ä¸ªåˆ†æ \u0026raquo;\u0026gt; go go go\u0026hellip;\næµ‹è¯•ç”¨ä¾‹ç»“æœåˆ†æ é€šè¿‡è¿è¡Œ jest --verbose å°†æ‰€æœ‰ç”¨ä¾‹æµ‹è¯•ç»“æœåˆ—å‡ºï¼š\n  âœ“ should run the passed function once (wrapped by a effect) (4 ms)\n1 2 3 4 5  it(\u0026#39;should run the passed function once (wrapped by a effect)\u0026#39;, () =\u0026gt; { const fnSpy = jest.fn(() =\u0026gt; {}) effect(fnSpy) // effect() å®ç°é‡Œé¢ï¼Œå¦‚æœæ²¡æœ‰ä¼  options.lazy å°±ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡  expect(fnSpy).toHaveBeenCalledTimes(1) // å› æ­¤è¿™é‡Œ fnSpy ä¼šè¢«è°ƒç”¨ä¸€æ¬¡  })     âœ“ should observe basic properties (1 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13  it(\u0026#39;should observe basic properties\u0026#39;, () =\u0026gt; { let dummy const counter = reactive({ num: 0 }) // updater: dummy = counter.num  // è¢«ç«‹å³è°ƒç”¨ï¼Œ dummy = 0  // ç”±äº counter.num è§¦å‘ trigger:get ï¼Œæ”¶é›†dep: \u0026#39;num\u0026#39;-\u0026gt;Set(1): updater  effect(() =\u0026gt; (dummy = counter.num)) expect(dummy).toBe(0) // true  counter.num = 7 // èµ‹å€¼ï¼Œtrigger: set è§¦å‘ updaterï¼Œèµ‹å€¼ dummy  expect(dummy).toBe(7) // true  })     âœ“ should observe multiple properties\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  it(\u0026#39;should observe multiple properties\u0026#39;, () =\u0026gt; { let dummy // obj ={num1: 0, num2: 0}  const counter = reactive({ num1: 0, num2: 0 }) // updater: ...  // updater è¢«ç«‹å³è°ƒç”¨ï¼Œcounter çš„ num1, num2 è¢«è®¿é—®ï¼Œåˆ†åˆ«è§¦å‘ä»–ä»¬çš„ trigger:get  // æ”¶é›†ä¾èµ–ï¼Œä¸‰æ¬¡è®¿é—®ï¼Œä¸‰æ¬¡æ”¶é›†åŒä¸€ä¸ª updater  // ç”±äº targetMap -\u0026gt; depsMap -\u0026gt; dep: new Set() æ˜¯ä¸ªé›†åˆç±»å‹  // å› æ­¤è™½ç„¶æ˜¯ä¸‰æ¬¡è®¿é—®ï¼Œä½†æ”¶é›†çš„éƒ½æ˜¯ updaterï¼Œå› æ­¤æ¯ä¸ª dep é‡Œé¢ä¿å­˜çš„æ˜¯åŒä¸€ä¸ª updater  effect(() =\u0026gt; (dummy = counter.num1 + counter.num1 + counter.num2)) expect(dummy).toBe(0) // é¦–æ¬¡è°ƒç”¨ updater æ—¶å€™èµ‹å€¼äº† 0 + 0 + 0 = 0  // è¿™é‡Œå…ˆåèµ‹å€¼äº† num1, num2ï¼Œè§¦å‘äº†ä¸¤æ¬¡ updater  // first: 0 + 0 + 7  // second: 7 + 7 + 7 = 21  // æµ‹è¯•å¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç   counter.num1 = counter.num2 = 7 expect(dummy).toBe(21) // true  })   æµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8  let dummy, n = 0 const counter = reactive({ num1: 0, num2: 0 }) effect(() =\u0026gt; (n++, (dummy = counter.num1 + counter.num1 + counter.num2))) console.log({ dummy, n }, 1) counter.num1 = counter.num2 = 7 console.log({ dummy, n }, 2)   ç»“æœå›¾ç¤ºï¼š\n depsMap æœ‰ä¸¤ä¸ª mapï¼Œåˆ†åˆ«æ˜¯ num1, num2ï¼Œ trigger: set è§¦å‘äº†ä¸¤æ¬¡ï¼Œä¸” num2 å…ˆè§¦å‘ num1 ç´§éšå…¶åï¼Œå› ä¸ºèµ‹å€¼æ“ä½œæ˜¯ä»å³åˆ°å·¦çš„é¡ºåºè¿›è¡Œã€‚    âœ“ should handle multiple effects (1 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  it(\u0026#39;should handle multiple effects\u0026#39;, () =\u0026gt; { let dummy1, dummy2 const counter = reactive({ num: 0 }) effect(() =\u0026gt; (dummy1 = counter.num)) // æ”¶é›† updater1ï¼Œæ‰§è¡Œä¸€æ¬¡ï¼Œdummy1 = 0  effect(() =\u0026gt; (dummy2 = counter.num)) // æ”¶é›† updater2, æ‰§è¡Œä¸€æ¬¡ï¼Œdummy2 = 0  expect(dummy1).toBe(0) // true  expect(dummy2).toBe(0) // true  // trigger:set å–å‡º targetMap-depsMap-num:dep:Set(2) å³ updater1, updater2  // æ‰§è¡Œ updaters ä¹‹åï¼Œé‡æ–°å¤åˆ¶dummy1, dummy2 = 1  counter.num++ expect(dummy1).toBe(1) // true  expect(dummy2).toBe(1) // true })     âœ“ should observe nested properties (1 ms) \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  it(\u0026#39;should observe nested properties\u0026#39;, () =\u0026gt; { let dummy // åµŒå¥—çš„ reactive æ˜¯åœ¨ createReativeObject é‡Œé¢å®Œæˆçš„  // åœ¨æœ€å return ç»“æœçš„æ—¶å€™æ£€æµ‹äº†æ˜¯å¦æ˜¯ isObject ï¼Œå¦‚æœæ˜¯è¿›ä¸€æ­¥æ£€æµ‹  // isReadonly ä¸å¦ï¼Œéåªè¯»è¿”å› reactive(res) å¯¹ç»“æœé€’å½’è°ƒç”¨ä¸€æ¬¡  // å‰ææ˜¯æ²¡æœ‰è®¾ç½®shallow æ ‡å¿—ï¼Œè¯¥æ ‡è¯†è¡¨æ˜åªå¯¹ç›®å‰çš„å¯¹è±¡åªåšæµ…reactive  // å³åªåšå¯¹è±¡çš„ä¸€çº§å“åº”å¼ï¼Œé‡Œé¢åµŒå¥—çš„å¯¹è±¡åŸæ ·è¿”å›ã€‚  // è¿™é‡Œè°ƒç”¨çš„æ˜¯ reactive æ˜¾ç„¶æ˜¯é€’å½’ reactive çš„ã€‚  // obj = { nested: {num: 0 }}  const counter = reactive({ nested: { num: 0 } }) // è¿™é‡Œä¼šè§¦å‘ä¸¤æ¬¡ getterï¼Œä¸€æ¬¡æ˜¯ counter.nestedï¼Œä¸€æ¬¡æ˜¯ nested.num  // targetMap{ obj -\u0026gt; map, nested -\u0026gt; map } å­˜æ”¾äº†ä¸¤ä¸ªå¯¹è±¡çš„æ˜ å°„  // obj:map -\u0026gt; \u0026#39;nested\u0026#39;:Set(1), nested:map -\u0026gt; \u0026#39;num\u0026#39;:Set(1)  // Set(1) éƒ½æ˜¯ä¸‹é¢çš„ updater  effect(() =\u0026gt; (dummy = counter.nested.num)) expect(dummy).toBe(0) // true  counter.nested.num = 8 // åªä¼šè§¦å‘ \u0026#39;num\u0026#39;:Set(1)  expect(dummy).toBe(8) // true })   è½¬æµ‹è¯•ä»£ç ç»“æœï¼š\n1 2 3 4 5 6 7  let dummy const counter = reactive({ nested: { num: 0 } }) effect(() =\u0026gt; (dummy = counter.nested.num)) console.log({ dummy }, 1) counter.nested.num = 7 console.log({ dummy }, 2)   â€‹\n1.\tLoc1 : è®¿é—® counter.nested æ”¶é›†çš„ `{counter:{nested:{num:0}}} -\u0026gt; Map{'nested' -\u0026gt; Set(1)}` ä¾èµ–ã€‚ 2.\tLoc2: è®¿é—® nested.num æ”¶é›†çš„ {num:7}-\u0026gt;Map{'num'-\u0026gt;Set(1)} ä¾èµ–ã€‚ 3.\tLoc2: æ³¨æ„çœ‹è¿™é‡Œï¼Œå½“ç»™ counter.nested.num = 7 èµ‹å€¼çš„æ—¶å€™åªä¼šè§¦å‘ 'num' -\u0026gt; Set(1)ã€‚    âœ“ should observe delete operations (1 ms)\n1 2 3 4 5 6 7 8 9 10  it(\u0026#39;should observe delete operations\u0026#39;, () =\u0026gt; { let dummy const obj = reactive({ prop: \u0026#39;value\u0026#39; }) effect(() =\u0026gt; (dummy = obj.prop)) // æ”¶é›†ä¾èµ– updater  expect(dummy).toBe(\u0026#39;value\u0026#39;) // true  // å¯¹è±¡å±æ€§çš„åˆ é™¤æ“ä½œï¼Œåªä¼šè§¦å‘ trigger é‡Œé¢çš„ if (key !== void 0) æ”¶é›†ä¾èµ–è¿› effects: []  delete obj.prop // è§¦å‘ updater é‡æ–°å¤åˆ¶ dummy: undefined  expect(dummy).toBe(undefined) // true })     âœ“ should observe has operations (1 ms)\n  âœ“ should observe properties on the prototype chain (9 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  t(\u0026#39;should observe properties on the prototype chain\u0026#39;, () =\u0026gt; { let dummy const counter = reactive({ num: 0 }) const parentCounter = reactive({ num: 2 }) Object.setPrototypeOf(counter, parentCounter) effect(() =\u0026gt; (dummy = counter.num))// æ”¶é›† updater  expect(dummy).toBe(0) // true  // è¿™é‡Œåˆ é™¤æ“ä½œè§¦å‘ deleteProperty proxy handler  // trigger: delete -\u0026gt; run deps -\u0026gt; è§¦å‘ updater  // ç”±äº updater é‡Œé¢è®¿é—®äº† counter.num ï¼Œè€Œ counter è‡ªèº«çš„ num åœ¨è¿™æ—¶å€™å·²ç»è¢«åˆ é™¤äº†  // æ³¨æ„ï¼šdeletePropery é‡Œé¢æ˜¯å…ˆæ‰§è¡Œäº† Reflect.deleteProperty(...)  // ç„¶åå†è§¦å‘çš„ trigger:deleteçš„ï¼Œå› æ­¤åœ¨ updater æ‰§è¡Œçš„æ—¶å€™ counter.num å·²ç»ä¸å­˜åœ¨  // ä½†æ˜¯æ ¹æ®å¯¹è±¡å±æ€§çš„è®¿é—®åŸç†ï¼Œä¼šå»æ£€æŸ¥åŸå‹é“¾ä¸Šçˆ¶çº§å¯¹è±¡çš„ï¼Œæœ€åä¼šæ‰¾åˆ° parentCounter.num  // ç„¶åå–å‡ºå®ƒçš„å€¼ï¼šnum: 2 èµ‹å€¼ç»™ dummyï¼Œæ‰€ä»¥ä¸‹é¢ dummy toBe(2) ä¸º true  delete counter.num expect(dummy).toBe(2) // è¿™é‡Œæ”¹å˜ parent num æ—¶å€™ä¹Ÿä¼šè§¦å‘ updater  // æ˜¯å› ä¸ºä¸Šé¢çš„ delete æ“ä½œå¯¼è‡´å»æ£€æŸ¥äº†åŸå‹é“¾ï¼Œè®¿é—®äº† parentCounter.num ï¼Œè¿™ä¸ªæ—¶å€™  // ä¹Ÿç›¸å½“äºè§¦å‘äº† parentCounter.num çš„ get ï¼Œæ”¶é›†äº† updater  parentCounter.num = 4 expect(dummy).toBe(4) // true  // è¿™é‡Œé‡æ–°å¤åˆ¶ï¼Œè§¦å‘ counter.num çš„ set(createSetter)ï¼Œ  // æ£€æµ‹åˆ°è‡ªèº«æ²¡æœ‰è¯¥å±æ€§(åœ¨Reflect.set()ä¹‹å‰)  // ç„¶åè§¦å‘ trigger:add å¢åŠ å±æ€§çš„æ“ä½œ  // åœ¨ trigger é‡Œé¢ï¼Œè§¦å‘ä¹‹å‰æ”¶é›†åˆ°çš„ updater  // (æ³¨æ„ï¼šcounter.num çš„ dep è¿™ä¸ªæ—¶å€™å¹¶æ²¡æœ‰è¢«ç§»é™¤çš„)  counter.num = 3 expect(dummy).toBe(3) })     âœ“ should observe has operations on the prototype chain\n  âœ“ should observe inherited property accessors (2 ms)\nè®¿é—®å™¨å±æ€§ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚\n  âœ“ should observe function call chains (1 ms)\n  âœ“ should observe iteration (1 ms)\n  âœ“ should observe implicit array length changes\n  âœ“ should observe sparse array mutations (1 ms)\n  âœ“ should observe enumeration (2 ms)\n  âœ“ should observe symbol keyed properties (2 ms)\n  âœ“ should not observe well-known symbol keyed properties (2 ms)\nå·²çŸ¥çš„ç¬¦å·å±æ€§ï¼Œåœ¨ createReactiveObject é‡Œé¢å°±è¢«è¿‡æ»¤æ‰äº†\nif (isSymbol(res) \u0026amp;\u0026amp; builtInSymbols.has(res) || res === '__proto__')ã€‚\n  âœ“ should observe function valued properties (1 ms)\n  âœ“ should observe chained getters relying on this (1 ms)\n  âœ“ should observe methods relying on this (1 ms)\n  âœ“ should not observe set operations without a value change (1 ms)\nå€¼æ²¡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¸ä¼šé‡å¤è§¦å‘ udpatersï¼ŒcreateSetter é‡Œé¢å°±å·²ç»æœ‰äº†åˆ¤æ–­ï¼š\nif (value !== oldValue \u0026amp;\u0026amp; (value === value || oldValue === oldValue))\nå€¼æ²¡å˜ä¸ä¼š trigger: setï¼Œåé¢çš„æ˜¯ä¸ºäº†è¿‡æ»¤æ‰ NaN çš„æƒ…å†µã€‚\n  âœ“ should not observe raw mutations (1 ms)\ntoRaw å°±æ˜¯å°† observed è½¬æˆåŸå§‹çš„é‚£ä¸ªå¯¹è±¡ï¼Œå°±ä¸å†æ˜¯å“åº”å¼çš„äº†ï¼Œå½“ç„¶ä¸ä¼šæœ‰å•¥ä½œç”¨ã€‚\n  âœ“ should not be triggered by raw mutations\nåŒä¸Šã€‚\n  âœ“ should not be triggered by inherited raw setters (1 ms)\nåŒä¸Šã€‚\n  âœ“ should avoid implicit infinite recursive loops with itself (1 ms)\n1 2 3 4 5 6 7 8 9 10 11  const counter = reactive({ num: 0 }) let n = 0 const counterSpy = () =\u0026gt; { n++ counter.num++ } effect(counterSpy) console.log(counter, n, \u0026#39;1\u0026#39;) counter.num = 4 console.log(counter, n, \u0026#39;2\u0026#39;)   è¿è¡Œç»“æœï¼š\n // è¿™é‡Œæ˜¯ updater é‡Œé¢çš„ counter.num++ è§¦å‘çš„get\n{num: 0} {type: \u0026ldquo;get\u0026rdquo;, key: \u0026ldquo;num\u0026rdquo;, shouldTrack: true, activeEffect: Æ’} \u0026ldquo;track\u0026rdquo;\n// å› ä¸º counter.num++ è§¦å‘çš„ set\nMap(1) {\u0026ldquo;num\u0026rdquo; =\u0026gt; Set(1)} {type: \u0026ldquo;set\u0026rdquo;, key: \u0026ldquo;num\u0026rdquo;, newValue: 1, oldValue: 0} \u0026ldquo;trigger\u0026rdquo; Proxy {num: 1} 1 \u0026ldquo;1\u0026rdquo; // log\n// èµ‹å€¼æ“ä½œå¼•å‘çš„ trigger:set\nMap(1) {\u0026ldquo;num\u0026rdquo; =\u0026gt; Set(1)} {type: \u0026ldquo;set\u0026rdquo;, key: \u0026ldquo;num\u0026rdquo;, newValue: 4, oldValue: 1} \u0026ldquo;trigger\u0026rdquo;\n// set è§¦å‘äº†updater -\u0026gt; trigger:get\n{num: 4} {type: \u0026ldquo;get\u0026rdquo;, key: \u0026ldquo;num\u0026rdquo;, shouldTrack: true, activeEffect: Æ’} \u0026ldquo;track\u0026rdquo;\n// counter.num++ -\u0026gt; trigger:set\nMap(1) {\u0026ldquo;num\u0026rdquo; =\u0026gt; Set(1)} {type: \u0026ldquo;set\u0026rdquo;, key: \u0026ldquo;num\u0026rdquo;, newValue: 5, oldValue: 4} \u0026ldquo;trigger\u0026rdquo; Proxy {num: 5} 2 \u0026ldquo;2\u0026rdquo;\n å¥½åƒæ²¡å‘ç°å“ªé‡Œæ‹¦æˆªäº†ï¼Œä½†æ˜¯é€šè¿‡ä¸‹é¢çš„ä¾‹å­ï¼Œç¡®å®åˆä¼šæ­»å¾ªç¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  let dummy const counter = { num: 0 } let ob function update() { // ob.num = ob.num + 1  dummy = ob.num++ console.log({ dummy }, ob) } ob = new Proxy(counter, { set(target, key, value, receiver) { const res = Reflect.set(...arguments) update() return res }, get(target, key, receiver) { return Reflect.get(...arguments) } }) ob.num = 2   node è¿è¡Œä¹‹åï¼š\n /Users/simon/github/vuejs/vue-next-code-read/test/test.js:10 dummy = ob.num++ ^\nRangeError: Maximum call stack size exceeded\n æ‰€ä»¥è‚¯å®šè¿˜æ˜¯æœ‰å“ªé‡Œåšäº†å¤„ç†ï¼Œé˜²æ­¢æ­»å¾ªç¯ã€‚\nç»è¿‡ä¸€é€š console.log ä¹‹åå‘ç°å…³é”®ç‚¹å°±åœ¨ trigger çš„ add å‡½æ•°é‡Œé¢ï¼Œå®ƒåœ¨æŸ¥æ‰¾ä¾èµ–æ·»åŠ åˆ°å°†è¦æ‰§è¡Œçš„ effects é›†åˆä¸­çš„æ—¶å€™æœ‰ä¸¤ä¸ªå‰ææ¡ä»¶ï¼š\n !shouldTrack effect !== activeEffect  å›¾ä¸­è¾“å‡ºçš„ä¸»è¦å…³é”®ç‚¹åœ¨çº¢è‰² éƒ¨åˆ†ï¼Œè¿™é‡Œæ£€æµ‹åˆ°æ­£åœ¨ add çš„ effect ä¸å½“å‰æ¿€æ´»çŠ¶æ€çš„ activeEffect æ˜¯åŒä¸€ä¸ªæ‰€ä»¥ç»“æŸè§¦å‘ trigger:setï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆ shouldTrack = true ä¸” effect === activeEffectå‘¢ï¼Ÿï¼Ÿï¼Ÿ\né‚£ä¹ˆå°±è¦å›å¤´å»çœ‹ effect() çš„å…·ä½“å®ç°äº†ï¼Œé‡ç‚¹åœ¨ try...finallyã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  try { enableTracking() effectStack.push(_effect) activeEffect = _effect // è¿™é‡Œçš„ _effect å°±æ˜¯åœ¨ trigger é‡Œç”¨æ¥ä¸ activeEffect æ¯”è¾ƒçš„  console.log({ ..._effect }, \u0026#39;effect 1\u0026#39;) return fn(...args) // trigger set æ£€æµ‹ shouldTrack å’Œ activeEffect } finally { effectStack.pop() // è€Œ shouldTrck å’Œ activeEffect é‡ç½®å·¥ä½œåœ¨è¿™é‡Œï¼Œå› æ­¤é˜»æ­¢äº† fn é‡Œé¢ ++ æ“ä½œå¼•èµ·çš„æ­»å¾ªç¯  // å› ä¸º trigger -\u0026gt; add éœ€è¦æ£€æµ‹ if (!shouldTrack || effect !== activeEffect)  // æ‰ä¼šå°†æ‰¾åˆ°çš„ dep:updater åŠ å…¥åˆ° run è¦æ‰§è¡Œçš„ effects: [] ä¸­å»  resetTracking() activeEffect = effectStack[effectStack.length - 1] console.log({ ..._effect }, \u0026#39;effect 2\u0026#39;) }   è¿™æ®µä»£ç å«ä¹‰å¦‚ä¸‹ï¼š\n  å½“æ‰§è¡Œ effect(updater) æ—¶ï¼Œæ‰§è¡Œä¸Šé¢çš„ä¸€æ®µä»£ç ã€‚\n  enableTracking() åªè¦çŸ¥é“å®ƒæ˜¯å°† shouldTrack = true äº†ã€‚\n  æ¥ä¸‹æ¥ç¼“å­˜ï¼Œèµ‹å€¼ effect\n  é‡ç‚¹æ¥äº†ï¼Œæ‰§è¡Œ updaterï¼Œè¿™é‡Œæ‰§è¡Œçš„ updateré‡Œé¢æ˜¯ counter.num++ ä¼šä¾æ¬¡è§¦å‘ get -\u0026gt; set\nGet å°±æ˜¯æ”¶é›†ä¾èµ–ï¼ŒåŒä¸€ä¸ª updater åªä¼šæœ‰ä¸€ä¸ª (Set(1))ã€‚\nSet è¿™é‡Œä¼šè§¦å‘ trigger:set é‚£ä¹ˆè¿™é‡Œä¼šæ£€æµ‹ shouldTrack å’Œ activeEffectï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ä¸¤è€…çš„å€¼å¹¶æ²¡æœ‰é‡ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´å‘Šè¯‰ triggerï¼Œ effect(updater) æˆ‘è¿˜æ²¡æ‰§è¡Œå®Œå‘¢ï¼Œä½ ä¸èƒ½é‡å¤ trigger:setï¼Œä½†æ˜¯æˆ‘ä»€ä¹ˆæ—¶å€™æ‰èƒ½ç»§ç»­ triggerå‘¢ï¼Ÿï¼Ÿï¼Ÿè¿™å°±æ˜¯ä¸‹é¢ç¬¬5æ¡è¯¥åšçš„äº‹æƒ…äº†ã€‚\n  finally åœ¨ udpater é¦–æ¬¡æ‰§è¡Œå®Œæˆä¹‹åæ¢å¤shouldTrack å’ŒactiveEffectçš„å€¼ï¼Œä»è€Œç»§ç»­å®Œæˆ effect(updater) çš„ä»»åŠ¡ç›´åˆ° finally çš„ä»£ç æ‰§è¡Œå®Œæ¯•ã€‚\n  å³è¿™ä¸ªé—®é¢˜çš„å…³é”®ç‚¹åœ¨äº 4å’Œ5ï¼Œæ­£æ˜¯è¿™é‡Œçš„é€»è¾‘é˜²æ­¢äº† updater é‡Œé¢å¯¼è‡´ set æ­»å¾ªç¯ã€‚\n  âœ“ should allow explicitly recursive raw function loops (1 ms)\n1 2 3 4 5 6 7 8 9 10 11 12  it(\u0026#39;should allow explicitly recursive raw function loops\u0026#39;, () =\u0026gt; { const counter = reactive({ num: 0 }) const numSpy = jest.fn(() =\u0026gt; { counter.num++ if (counter.num \u0026lt; 10) { numSpy() } }) effect(numSpy) expect(counter.num).toEqual(10) expect(numSpy).toHaveBeenCalledTimes(10) })   æœ‰äº†å‰é¢ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹çš„åˆ†æï¼Œè¿™é‡Œçš„åŸç†å°±ä¸€ç›®äº†ç„¶äº†ã€‚\né¦–å…ˆ counter.num++ è¿˜æ˜¯ä¼šå› ä¸º effect(updater) æ²¡æœ‰å®Œå…¨ç»“æŸè€Œä¸­æ–­ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ +1 æ“ä½œã€‚\nç´§è·Ÿç€çš„ if ç›¸å½“äºåœ¨ try { return fn(...args) } } è¿”å›ç»“æœä¹‹å‰åˆè°ƒç”¨äº†ä¸‹è‡ªå·±ï¼Œä¹Ÿå°±æ˜¯è¯´ num+1 ä¼šæ‰§è¡ŒçŸ¥é“ num = 10 ï¼Œæ‰€ä»¥æœ€åç»“æœæ˜¯ num=10, updater è¢«è°ƒç”¨äº† 10ï¼Œæ‰è¿›å…¥äº† effect -\u0026gt; finally ç»“æŸå½“å‰çš„ effect()ã€‚\n  âœ“ should avoid infinite loops with other effects (1 ms)\nåŸç†å¦‚ä¸Šä¸Šã€‚\n  âœ“ should return a new reactive version of the function (1 ms)\nå› ä¸º effect(fn) æœ€ç»ˆéƒ½ä¼šè¢«å°è£…æˆ ReactiveEffect ç±»å‹çš„å¯¹è±¡ï¼Œæ‰€ä»¥è‚¯å®šä¸ç›¸ç­‰äº†ã€‚\n  âœ“ should discover new branches while running automatically (1 ms)\n  âœ“ should discover new branches when running manually (1 ms)\nè¿™ä¸¤ä¸ªåŸç†éƒ½ä¸€æ ·ï¼Œåœ¨äº ?: æ‰§è¡Œçš„æ—¶å€™æ ¹æ®æ¡ä»¶çš„çœŸå‡æ˜¯å¦æœ‰è§¦å‘ getã€‚\n  âœ“ should not be triggered by mutating a property, which is used in an inactive branch (1 ms)\n  âœ“ should not double wrap if the passed function is a effect (1 ms)\nfunction effect(fn) çš„ç¬¬ä¸€å¥å°±æ˜¯ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œæ£€æµ‹æ˜¯ä¸æ˜¯ _isEffect ï¼Œæ˜¯çš„è¯ä¼šå°† fn = fn.raw æå–å‡ºæ¥ã€‚\n  âœ“ should not run multiple times for a single mutation (1 ms)\n  âœ“ should allow nested effects (4 ms)\nä¸ç®¡åµŒå¥—ä¸åµŒå¥—åªè¦ effect å®Œæ•´æ‰§è¡Œå®Œæˆï¼Œå°±èƒ½é¡ºåˆ©çš„è¿›è¡Œä¸‹ä¸€ä¸ª effect()ã€‚\n  âœ“ should observe json methods\n1 2 3 4 5 6 7 8 9  let dummy = {} const obj = reactive({}) effect(() =\u0026gt; { dummy = JSON.parse(JSON.stringify(obj)) }) console.log(targetMap, dummy, \u0026#39;before\u0026#39;) /* obj.a = 1 */ /* console.log(targetMap, dummy, \u0026#39;after\u0026#39;) */   æ³¨é‡Šæœ€åä¸¤è¡Œï¼Œçœ‹è¾“å‡º\næ³¨æ„è¿™é‡Œçš„ä¸€ä¸ªè¿­ä»£å™¨ä¸º key çš„ depï¼Œä¹Ÿå°±æ˜¯ JSON.stringify(obj) çš„æ—¶å€™è¯´æ˜æœ‰å¯¹ obj è¿›è¡Œéå†(è¿­ä»£å™¨æ“ä½œï¼Œè§¦å‘äº† ownKeys proxy handler)ã€‚\nå»çœ‹ä¸‹ https://tc39.es/ecma262/ JSON.stringify å®ç°åŸç†ï¼š\n æœ€åä¸€æ­¥ï¼š Return ? SerializeJSONProperty(state, the empty String, wrapper). è¿›å…¥åˆ° SerializeJSONProperty\nStep2: æ£€æµ‹åˆ°æ˜¯å¯¹è±¡ä¼šå»å–å®ƒ çš„ toJson å€¼ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ æœ€åæ”¶é›†åˆ°çš„ä¾èµ– depsMap é‡Œé¢ä¼šæœ‰ä¸€ä¸ª key ä¸º toJSON çš„é¡¹äº†ï¼š\nType(value) is Object or BigInt, then\n Let toJSON be ? GetV(value, \u0026ldquo;toJSON\u0026rdquo;).  ç„¶åæ£€æµ‹åˆ°æ˜¯å¯¹è±¡ä¼šè¿›å…¥ï¼šSerializeJSONObject ( state, value )\n  let partial be a new empty List.\n  For each elemen P of K , do\n  // è¿™é‡Œä¼šæœ‰ä¸€ä¸ªè¿­ä»£å™¨æ“ä½œï¼Œéå†å¯¹è±¡å±æ€§ï¼Œè§¦å‘ ITERATE_KEY ä¾èµ–æ”¶é›†\n Let strP be ? SerializeJSONProperty(state, P, value).   ç»“æœå°±æ˜¯è¯´ JSON.stringify ä¼šæœ‰å¯¹ obj æœ‰è¿­ä»£å™¨æ“ä½œï¼Œè§¦å‘äº† ownkeys proxy handler è°ƒç”¨ track:ITERATE_KEY è§¦å‘æ”¶é›†ä¾èµ–ã€‚\n  âœ“ should observe class method invocations (1 ms)\n  âœ“ lazy (5 ms)\n  âœ“ scheduler (1 ms)\n  âœ“ events: onTrack (1 ms)\n  âœ“ events: onTrigger (3 ms)\n  âœ“ stop (1 ms)\n  âœ“ stop with scheduler (2 ms)\næ¥çœ‹ä¸‹ stop ç»“åˆ scheduler è°ƒåº¦å™¨æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  it(\u0026#39;stop with scheduler\u0026#39;, () =\u0026gt; { let dummy const obj = reactive({ prop: 1 }) const queue = [] const runner = effect( () =\u0026gt; { // updater  dummy = obj.prop // è¿™é‡Œä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡æ”¶é›†ä¾èµ–  }, { scheduler: (e) =\u0026gt; queue.push(e) } ) // è¿™é‡Œè®¾ç½®è§¦å‘ trigger:setï¼Œä½†æ˜¯å› ä¸ºæœ‰ scheduler çš„å­˜åœ¨ï¼Œæ‰€ä»¥æ²¡æœ‰ç«‹å³è°ƒç”¨ effect  // è€Œæ˜¯æ‰§è¡Œäº† scheduler å°† effect æ¨å…¥äº†é˜Ÿåˆ— queue  obj.prop = 2 // æ‰€ä»¥è¿™é‡Œè¿˜æ˜¯ 1  expect(dummy).toBe(1) // true  // å› ä¸ºä¸Šé¢çš„èµ‹å€¼è§¦å‘ scheduler ç¼˜æ•…  expect(queue.length).toBe(1) // true  // æ¸…ç†ä¾èµ–ï¼ŒtargetMap-\u0026gt;depsMap-\u0026gt;dep é‡Œé¢çš„æ‰€æœ‰ä¾èµ–æ¸…ç†æ‰  // ä¸” effect.active = false  stop(runner) // a scheduled effect should not execute anymore after stopped  // è¿™é‡Œæ‰§è¡Œçš„å…¶å®æ˜¯ updater -\u0026gt; ReactiveEffect åŒ–ä¹‹åçš„ effect  // ä½†æ˜¯åœ¨ stop ä¹‹å effect.active å·²ç»æ˜¯ FALSE äº†  // æ‰€ä»¥ä¼šç›´æ¥æ£€æµ‹åˆ° effect.options.scheduler å­˜åœ¨ï¼Œè¿”å› undefined  // çœŸæ­£ try é‡Œé¢çš„ æ‰§è¡Œ fn:updater å®é™…æ²¡æœ‰åˆ°ã€‚æ‰€ä»¥è¿™é‡Œç›¸å½“äºä»€ä¹ˆéƒ½æ²¡å¹²  queue.forEach((e) =\u0026gt; e()) // æ‰€ä»¥è¿™é‡Œå€¼ä¹Ÿå°±ä¸ä¼šæœ‰ä»»ä½•å˜åŒ–äº†  // å¦‚æœè¦è¿™é‡Œ updater è¢«è°ƒç”¨åªè¦å»æ‰ stop é‚£å¥å³å¯ï¼Œactive = true è¿›å…¥æ­£å¸¸  // çš„ effect{try...finaylly} æ‰§è¡Œæµç¨‹è§¦å‘ updater  expect(dummy).toBe(1) }     âœ“ events: onStop (1 ms)\n  âœ“ stop: a stopped effect is nested in a normal effect (1 ms)\n  âœ“ markRaw (1 ms)\n  âœ“ should not be trigger when the value and the old value both are NaN (1 ms)\n  âœ“ should trigger all effects when array length is set 0 (1 ms)\n  é˜¶æ®µä»£ç é“¾æ¥ï¼šreactive_with_effect_spec_passed_jsÂ ä»£ç \nå°ç»“ 2 åˆæ˜¯ä¸€ä¸ªå‘¨ä¸€äº†ï¼Œå‘¨æœ«åˆè’åºŸä¸­åº¦è¿‡\u0026hellip;\u0026hellip;ï¼Œå›é¡¾ä¸‹ä¹‹å‰çš„å†…å®¹(é¡ºåºæŒ‰ç…§å½“æ—¶å®ç°å‰åé¡ºåºæ’åˆ—)ï¼š\nreactive - createReactiveObject  å‚æ•°ï¼š [target, toProxy, toRaw, baseHandlers, collectionHandlers]ï¼› new Proxy(target, handlers)ï¼› æ ¹æ®ç±»å‹é€‰æ‹© handlers ï¼Œé›†åˆç±»å‹(Map, Set)ç”¨collectionï¼Œå…¶ä»–å¯¹è±¡ç±»å‹ç”¨ baseï¼› ç¼“å­˜ proxy-target ç»“æœ(toProxy: target -\u0026gt; observed, toRaw: observed -\u0026gt; target)ï¼› è¿‡æ»¤æ¡ä»¶(å·²ç» proxy æˆ– toProxy ä¸­å·²ç»å­˜åœ¨çš„ä¸ç”¨é‡å¤ new )ï¼› éå¯¹è±¡åˆ¤æ–­ï¼Œèƒ½ proxy çš„å¿…é¡»æ˜¯å¼•ç”¨ç±»å‹ï¼› è¿‡æ»¤æ‰ 5 ä¸­éæ³•æƒ…å†µ(_isVue, _isVNode, rawValues, isFrozen, é observable äº”ç§æƒ…å†µ)ã€‚  createGetter å–å€¼ï¼Œé€’å½’ reactiveï¼Œè°ƒç”¨ track æ”¶é›†ä¾èµ–ï¼Œæ•°ç»„æ£€æµ‹(includes, indexOf, lastIndex ç‰¹æ®Šå¤„ç†)ï¼Œç­‰ç­‰ã€‚\n å‚æ•°ï¼š [isReadonly, shallow]ï¼› Reflect.get() å…ˆå–å€¼ åˆ¤æ–­ç»“æœæ˜¯ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¦‚æœæ˜¯è°ƒç”¨ reactive å°†ç»“æœè½¬å“åº”å¼(åµŒå¥—çš„å¯¹è±¡) æ£€æµ‹æ˜¯ä¸æ˜¯åªè¯»ï¼Œå¦‚æœæ˜¯å°±è¿”å›åªè¯»ç‰ˆæœ¬(å…¶å®å·®åˆ«å°±æ˜¯åœ¨ handlers) shallow = true æƒ…å†µï¼Œåª reactive å¯¹è±¡ä¸€çº§(åµŒå¥—ä¸å¤„ç†) éåªè¯»æƒ…å†µè°ƒç”¨ track() æ”¶é›†ä¾èµ– æ£€æµ‹ key æ˜¯ä¸æ˜¯æ•°ç»„çš„ä¸‰ä¸ªç´¢å¼•æ–¹æ³•(includes, indexOf, lastIndexOf)ï¼Œå•ç‹¬å¤„ç†(arrayInstrumentations)  createSetter è®¾ç½®ï¼Œè°ƒç”¨ trigger è§¦å‘ deps(targetMap -\u0026gt; depsMap -\u0026gt; dep)ï¼Œè¿”å› Reflect.set() ç»“æœã€‚\n  å‚æ•°ï¼š[shallow]\n  oldValue = target[key]\n  äº‹å…ˆ hasOwnProperty æ£€æµ‹ï¼Œç¼“å­˜ç»“æœ(æ·»åŠ å±æ€§çš„æ—¶å€™éœ€è¦)\n  è°ƒç”¨ Reflect.set(...) è®¾ç½®ä¸‹å»\n  è°ƒç”¨ trigger(target, type, key, newValue, oldValue, oldTarget) è§¦å‘ deps\n  å¢åŠ æ¡ä»¶åˆ¤æ–­ï¼Œä¸æ˜¯ä»€ä¹ˆæƒ…å†µéƒ½å¯ä»¥è°ƒç”¨ triggerçš„\na) target - receiver å¿…é¡»æ˜¯å¯¹åº”å…³ç³»\nb) hasOwn æ£€æµ‹ç»“æœå¤±è´¥åˆ™ä¸º add æ“ä½œï¼Œå¦åˆ™ä¸º set æ“ä½œï¼Œä¸” set æ“ä½œå¿…é¡»æ˜¯åœ¨å€¼å‘ç”Ÿæ”¹å˜çš„æƒ…å†µ(æ’é™¤ NaN)\n  track createGetter é‡Œé¢è°ƒç”¨ï¼Œç”¨æ¥æ”¶é›†ä¾èµ–çš„ï¼Œä¾èµ–éƒ½å­˜å‚¨åœ¨ targetMap é‡Œé¢ï¼Œåˆ†ä¸ºä¸¤çº§ï¼Œ\nç¬¬ä¸€çº§æ˜¯ Map{target -\u0026gt; Map} ç±»å‹\nç¬¬äºŒçº§ä¹Ÿæ˜¯ Map{key -\u0026gt; Set(deps)}\n å‚æ•°ï¼š[target, type, key] ä» targetMap ä¸­å– depsMap è¯¥ target å¯¹è±¡å¯¹åº”çš„æ‰€æœ‰ä¾èµ–ä»“åº“ï¼Œæ²¡æœ‰å°±åˆå§‹åŒ– new Map() ä» depsMap å–å¯¹åº” key çš„æ‰€æœ‰ä¾èµ–ä»“åº“ depï¼Œæ²¡æœ‰å°±åˆå§‹åŒ– new Set() æ£€æµ‹ä¾èµ–æ˜¯å¦å­˜åœ¨(activeEffect)ï¼Œç¡®ä¿ä¸ä¼šé‡å¤æ·»åŠ  dep.add(activeEffect) -\u0026gt; activeEffect.deps.push(dep) å¢åŠ åˆ¤æ–­ï¼Œå¦‚æœå½“å‰ activeEffect æœªå…·å¤‡æ”¶é›†æ¡ä»¶(shouldTrack: true, activeEffectä¸ä¸ºç©º)ï¼Œå°±é€€å‡ºä¾èµ–æ”¶é›†ã€‚  trigger createSetter é‡Œè°ƒç”¨æ¥ï¼Œè§¦å‘ä¾èµ–è°ƒç”¨çš„ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªå†…éƒ¨å‡½æ•°(add, run)ï¼š\nAdd: å°†äºå½“å‰è¦ update çš„ deps æ”¶é›†åˆ°ä¸€ä¸ªå†…éƒ¨å˜é‡ effects: Set() é‡Œã€‚\nRun: ä½¿ç”¨ runå»æ‰§è¡Œ effects é‡Œé¢çš„ dep\n  å‚æ•°ï¼š [target, type, key, newValue, oldValue, oldTarget]\n  æ£€æµ‹ targetMap -\u0026gt; target æ²¡æœ‰ä¾èµ–ç›´æ¥é€€å‡º\n  å®ç° addï¼Œæ·»åŠ æ¡ä»¶ï¼šshouldTrack = false, effect !== activeEffect è¿™ä¸¤ä¸ªæ¡ä»¶èƒ½é˜²æ­¢æ ˆæº¢å‡ºçš„é—®é¢˜(æ¯”å¦‚åœ¨ effect(fn) çš„ fn é‡Œé¢åš ob.prop++ æ“ä½œï¼Œä¹‹å‰æœ‰åˆ†æã€‚)\n  ä½¿ç”¨ add æ”¶é›† depsï¼Œä¸‰ç§æƒ…å†µ\na) å¦‚æœ type: clear å°†æ‰€æœ‰ depsMap æ·»åŠ è¿›å»\nb) å¦‚æœ key: length ä¸” target æ˜¯æ•°ç»„ï¼Œè¯´æ˜æ˜¯æ•°ç»„çš„å¢åŠ å’Œåˆ é™¤æ“ä½œï¼Œå°† depsMap ä¸­ key ä¸º \u0026lsquo;length\u0026rsquo; æˆ–è€… key \u0026gt; newValue æƒ…å†µçš„ dep æ·»åŠ \nc) å…¶ä»–ä¸ºå¯¹è±¡æƒ…å†µå¤„ç†(Mapç±»å‹æˆ–Objectæ“ä½œ)\n  æœ€åå»æ‰§è¡Œ runï¼Œflush æ‰æ‰€æœ‰ deps(effects, computedEffects)ã€‚\n  effect æ„é€  dep ç±»å‹ ReactiveEffectï¼Œå…¶ä¸­åŒ…å« [_isEffect, active, raw, deps, options, id]ç±»å‹çš„å¯¹è±¡ã€‚\n å‚æ•°ï¼š[fn, options] æ£€æµ‹ fn._isEffect å¦‚æœæœ¬èº«å·²ç»æ˜¯ä¸ª ReactiveEffectï¼Œå–å‡º fn = fn.rawï¼Œé‡æ–°å°è£… å®šä¹‰ _effect å‡½æ•°ï¼Œæ‰€ä»¥ vue3 é‡Œé¢æ¯ä¸ª dep éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œä¸Šé¢è¿½åŠ äº†è‹¥å¹²å‚æ•° _effect å‡½æ•°çš„å®ç°é‡ç‚¹æ˜¯ effectStack å’Œ try\u0026hellip;finallyï¼Œtry é‡Œé¢ enable effect æ‰§è¡Œ fnï¼Œfinally é‡Œé¢ disable effectã€‚æ‰€ä»¥è¿™é‡Œç»“åˆ trigger é‡Œé¢çš„ shouldTrack å’Œ activeEffect åˆ¤æ–­æ¥ååŒé˜²æ­¢æ ˆæº¢å‡ºé—®é¢˜ã€‚ _effect ä¸Šè¿½åŠ  ReactiveEffect å¿…å¤‡çš„å‚æ•°ã€‚ æ‰§è¡Œä¸€æ¬¡ _effect() (å‰ææ˜¯æ²¡æœ‰è®¾ç½® options.lazy å±æ€§ä¸º true)  ownKeys, has, delete è¿™ä¸‰ä¸ªçš„å®ç°éå¸¸ç®€å•\n ownKeys è°ƒç”¨ track æ”¶é›†ä¾èµ– has è°ƒç”¨ track æ”¶é›†ä¾èµ– delete è°ƒç”¨ trigger è§¦å‘ delete æ“ä½œ æœ€åéƒ½è¦è¿”å›å¯¹åº”çš„ Reflect\u0026hellip; æ“ä½œç»“æœ  å…¶ä»– åˆ°æ­¤ï¼Œç¬¬ä¸€é˜¶æ®µçš„å·¥ä½œåŸºæœ¬å·²ç»å®Œæˆäº†ï¼Œæˆ‘ä»¬ä¹Ÿå¾—åˆ°äº†ä¸€ä¸ªåŸºæœ¬å¯ä»¥è·‘èµ·æ¥ï¼Œä½œç”¨èµ·æ¥çš„ reactive ã€‚\næ¥ä¸‹çš„å†…å®¹ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š\n é›†åˆç±»å‹çš„ collectionHandlers å®ç°ï¼Œä¹‹å‰éƒ½æ˜¯å®ç°äº† baseHandlersï¼Œæ—¢ç„¶ vue3 ä¸­ç‹¬ç«‹æˆä¸¤ä¸ªæ–‡ä»¶äº†ï¼Œè‚¯å®šæœ‰ä¸å°çš„å·®åˆ«ï¼Œä½†æ˜¯æœ‰äº†ä¹‹å‰çš„åŸºç¡€ï¼Œç›¸ä¿¡ç†è§£ collectionHandlers ä¸ä¼šé‚£ä¹ˆå›°éš¾ã€‚ ref çš„å®ç°ï¼Œè¿™å—ç›®å‰è¿›åº¦å‡ ä¹ä¸º0ï¸âƒ£ï¼Œæœ‰å¾…ç ”ç©¶ã€‚ æœ€åå°±æ˜¯å…¶ä»–å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹æ–‡ä»¶çš„æµ‹è¯•äº†ã€‚  æ¼«æ¼«æºç è·¯å…¶ä¿®è¿œå…®ï¼Œå¾å°†å‰åå·¦å³ä»¥è´¯ä¹‹ï¼ŒåŠ æ²¹íŒŒì´íŒ…ğŸ¤œğŸ¤›ï¼ï¼ï¼\nä¹¦å¤§åé˜µï¼Œç¨³~~~~~~\næ›´æ–°(2020-05-25 10:54:40) å‰ä¸¤å¤©æ›´æ–°äº†ä¸‹ vue ä»“åº“æºç ï¼Œå‘ç°æœ‰ä¸å°çš„æ”¹åŠ¨ï¼Œè¿™é‡Œæå‰æŠŠè¿™äº›æ”¹åŠ¨åˆå¹¶åˆ°ä¹‹å‰çš„é˜…è¯»ä¸Šå»ï¼Œä»¥é˜²æ­¢åé¢è¶Šèµ°è¶Šè¿œï¼Œå¯¼è‡´è¶Šéš¾åˆå¹¶ã€‚\n 5a3b44ca master origin/master chore: fix typo in comment (#1217) 2b2beb91 build(deps-dev): bump @types/puppeteer from 2.1.0 to 2.1.1 8e945c97 build(deps-dev): bump @microsoft/api-extractor from 7.8.1 to 7.8.2 91c4e9b8 build(deps-dev): bump rollup from 2.10.4 to 2.10.5 96a9d5c6 build(deps-dev): bump rollup from 2.10.2 to 2.10.4 42e48b83 build(deps-dev): bump @types/jest from 25.2.2 to 25.2.3 32b3f78a v3.0.0-beta.14 release: v3.0.0-beta.14\n æœ¬èŠ‚çº¦å®šï¼š\n å…ˆåˆ—å‡ºå˜æ›´å¯¹æ¯”ä»£ç  æœªå˜æ›´çš„ç¯‡å¹…è¾ƒå¤šçš„ä»£ç å°†çœç•¥ï¼Œå¦‚æ³¨é‡Šï¼š// \u0026hellip;. çœç•¥  reactive.ts é¦–å…ˆæ–°å¢äº†ä¸¤ä¸ªç±»å‹ï¼š   ReactiveFlags æšä¸¾å¯¹è±¡ï¼Œç”¨æ¥è®°å½•å¯¹è±¡ç‰¹å¾çš„ï¼Œæ¯”å¦‚ï¼šæ˜¯å¦åªè¯»ç­‰ç­‰\n1 2 3 4 5 6 7 8  export const enum ReactiveFlags { skip = \u0026#39;__v_skip\u0026#39;, isReactive = \u0026#39;__v_isReactive\u0026#39;, isReadonly = \u0026#39;__v_isReadonly\u0026#39;, raw = \u0026#39;__v_raw\u0026#39;, reactive = \u0026#39;__v_reactive\u0026#39;, readonly = \u0026#39;__v_readonly\u0026#39; }     Target æ¥å£ç±»å‹\n1 2 3 4 5 6 7 8 9 10 11  // ä¼šå‘ç°è¿™ä¸ªå’Œä¸Šé¢çš„ ReactiveFlags æ˜¯ç›¸å¯¹åº”çš„ï¼Œä¸Šé¢çš„ enum ä»£è¡¨çš„æ˜¯ key å€¼å­—ç¬¦ä¸² // è¿™é‡Œå£°æ˜äº†ä¸€ä¸ª Target ç±»å‹ï¼Œé‡Œé¢åŒ…å«çš„å°±æ˜¯ä¸Šé¢æ‰€æœ‰ key å­—ç¬¦ä¸²å¯¹åº”å€¼ä¸º boolean çš„ä¸€ä¸ªå¯¹è±¡ // éƒ½æ˜¯äº›æ ‡è¯†ï¼Œæ ‡è¯†è¿™å¯¹è±¡çš„å„ç§ç‰¹æ€§ interface Target { __v_skip?: boolean __v_isReactive?: boolean __v_isReadonly?: boolean __v_raw?: any __v_reactive?: any __v_readonly?: any }     canObserve å®ç°å˜åŒ– æ›´æ–°å\n1 2 3 4 5 6 7 8 9  // å°±æ˜¯æŠŠä¸‰ç§éæ³•ç±»å‹(_isVue, _isVNode, rawValues)è¿›è¡Œåˆå¹¶äº†ï¼Œä½¿ç”¨ä¸€ä¸ª__v_skip æ¥æ£€æµ‹ // æ‰€ä»¥å…³é”®æˆ‘ä»¬è¦å…³æ³¨çš„å°†æ˜¯è¿™ä¸ª __v_skip æ˜¯åœ¨å“ªé‡Œç»™åˆå§‹åŒ–çš„å€¼(é¢„æƒ³åº”è¯¥æ˜¯åœ¨ createGetter é‡Œé¢) const canObserve = (value: Target): boolean =\u0026gt; { return ( !value.__v_skip \u0026amp;\u0026amp; isObservableType(toRawType(value)) \u0026amp;\u0026amp; !Object.isFrozen(value) ) }   æ›´æ–°å‰\n1 2 3 4 5 6 7 8 9  const canObserve = (value) =\u0026gt; { return ( !value._isVue \u0026amp;\u0026amp; !value._isVNode \u0026amp;\u0026amp; isObservableType(toRawType(value)) \u0026amp;\u0026amp; !rawValues.has(value) \u0026amp;\u0026amp; !Object.isFrozen(value) ) }   reactive(target) æ›´æ–°å\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  export function reactive(target: object) { // if trying to observe a readonly proxy, return the readonly version.  // å˜åŒ–1 ï¼š ä½¿ç”¨äº† __v_isReadonly ä»£æ›¿äº† readonlyToRaw: WeakMap  if (target \u0026amp;\u0026amp; (target as Target).__v_isReadonly) { return target } // å˜åŒ–2ï¼šè¿™é‡Œç°åœ¨åªéœ€è¦å››ä¸ªå‚æ•°äº†ï¼Œå°† toProxy å’Œ toRaw åˆå¹¶äº†ï¼Ÿï¼Ÿï¼Ÿ  // åªèƒ½åé¢å†è¯´äº†  return createReactiveObject( target, false, mutableHandlers, mutableCollectionHandlers ) }   æ›´æ–°å‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // reactivity start function reactive(target) { if (readonlyToRaw.has(target)) { return target } return createReactiveObject( target, rawToReactive, reactiveToRaw, mutableHandlers, mutableCollectionHandlers ) }   createReactiveObject(target, isReadonly, baseHandlers, collectionHandlers) å»æ‰äº† toProxy å’Œ toRawï¼Œæ”¹æˆäº† isReadonlyï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ä¸ªå‡½æ•°çš„æ›´æ–°ï¼Œéœ€è¦æ¢ç©¶å»æ‰è¿™ä¸¤è€…ä¹‹åæ˜¯å¦‚ä½•å®ç°è¯¥åŠŸèƒ½çš„ï¼Œæˆ–è€…æ²¡æœ‰è¯¥åŠŸèƒ½äº†ï¼Ÿï¼Ÿï¼Ÿ\næ›´æ–°åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  // å˜åŒ–1ï¼šå‚æ•°å˜å°‘äº† function createReactiveObject( target: Target, isReadonly: boolean, baseHandlers: ProxyHandler\u0026lt;any\u0026gt;, collectionHandlers: ProxyHandler\u0026lt;any\u0026gt; ) { if (!isObject(target)) { if (__DEV__) { console.warn(`value cannot be made reactive: ${String(target)}`) } return target } // target is already a Proxy, return it.  // exception: calling readonly() on a reactive object  // å˜åŒ–2ï¼šç›´æ¥é€šè¿‡ä¸¤ä¸ª __v_raw å’Œ __v_isReactive è¿‡æ»¤  if (target.__v_raw \u0026amp;\u0026amp; !(isReadonly \u0026amp;\u0026amp; target.__v_isReactive)) { return target } // å˜åŒ–3ï¼šç›´æ¥è¿”å›å¯¹åº”çš„ target ç‰ˆæœ¬  // target already has corresponding Proxy  // è¿™é‡Œåº”è¯¥æ˜¯ç›´æ¥è¿”å›äº† target ä¸Šçš„åªè¯»å’Œreactive ç‰ˆæœ¬  // æ‰€ä»¥è¿™é‡Œå°±å¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¡Œä¸ºï¼Œå°†åªè¯»å’Œ reactive ç‰ˆæœ¬èµ‹å€¼åˆ° __v_readonlyï¼Œ__v_reactive  // ä¸¤ä¸ªå±æ€§ä¸Šå»ï¼Œç»§ç»­\u0026gt;\u0026gt;\u0026gt;  if ( hasOwn(target, isReadonly ? ReactiveFlags.readonly : ReactiveFlags.reactive) ) { return isReadonly ? target.__v_readonly : target.__v_reactive } // only a whitelist of value types can be observed.  // è¿™é‡Œå°±ä¸è¯´äº†ï¼Œå˜åŠ¨å­˜åœ¨äº canObserve å‡½æ•°å†…éƒ¨  if (!canObserve(target)) { return target } const observed = new Proxy( target, collectionTypes.has(target.constructor) ? collectionHandlers : baseHandlers ) // å˜åŒ–4ï¼šä½¿ç”¨äº† def å‡½æ•°ï¼Œä¼°è®¡ç¼“å­˜targetä¸¤ä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯åœ¨è¿™é‡Œå®ç°çš„  // æœ¬æ¬¡æ›´æ–°é‡ç‚¹åº”è¯¥å°±æ˜¯è¿™ä¸ª def äº†ï¼Œç¦»çœŸç›¸è¶Šæ¥è¶Šè¿‘äº†......  def( target, isReadonly ? ReactiveFlags.readonly : ReactiveFlags.reactive, observed ) return observed }   æ›´æ–°å‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  // å˜åŒ–1ï¼šå‚æ•°å˜å°‘äº† function createReactiveObject( target, toProxy, toRaw, baseHandlers, collectionHandlers ) { if (!target || typeof target !== \u0026#39;object\u0026#39;) { return target } // å˜åŒ–2  let observed = toProxy.get(target) if (observed !== void 0) { return observed } if (toRaw.has(target)) { return target } // å˜åŒ–2 end  // å˜åŒ–3ï¼š... æ–°å¢  if (!canObserve(target)) { return target } const handlers = collectionTypes.has(target.constructor) ? collectionHandlers : baseHandlers observed = new Proxy(target, handlers) // å˜åŒ–4ï¼šä½¿ç”¨ def ä»£æ›¿  toProxy.set(target, observed) toRaw.set(observed, target) return observed }   ä¸‹é¢å°±ä¸ç»§ç»­æ›´äº†ï¼Œéƒ½æ˜¯äº›å°å‡½æ•°å›´ç»• def, Target, ReactiveFlags çš„æ›´æ–°ã€‚\nbaseHandlers.ts createGetter(isReadonly = false, shallow = false)  æ›´æ–°å(åªæœ‰ä¸€ä¸ªå˜åŒ–ï¼Œæ ‡è¯†æ€§å±æ€§çš„è¯»å–å¤„ç†)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function createGetter(isReadonly = false, shallow = false) { return function get(target: object, key: string | symbol, receiver: object) { // å˜åŒ–1ï¼šæ–°å¢å¯¹æ ‡è¯†æ€§çš„å±æ€§è¯»å–ï¼Œvue ç»™å¢åŠ çš„ä¸€äº›å±æ€§  if (key === ReactiveFlags.isReactive) { return !isReadonly } else if (key === ReactiveFlags.isReadonly) { return isReadonly } else if (key === ReactiveFlags.raw) { return target } const targetIsArray = isArray(target) // ... ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæœªå˜åŒ–çš„å°±çœç•¥å§ï¼Œåç»­çš„ä¹Ÿå¦‚æ­¤ }   æ›´æ–°å‰ï¼š\n1 2 3 4 5 6 7 8 9  function createGetter(isReadonly = false, shallow = false) { return function get(target, key, receiver) { // å˜åŒ–1ï¼šæ–°å¢  /* ... */ const targetIsArray = Array.isArray(target) // ... ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæœªå˜åŒ–çš„å°±çœç•¥å§ï¼Œåç»­çš„ä¹Ÿå¦‚æ­¤ }   effect.ts å˜é‡åŠç±»å‹å£°æ˜å˜æ›´ï¼š\n1 2 3  type Dep = Set\u0026lt;ReactiveEffect\u0026gt; // æ–°å¢ Dep ç±»å‹ type KeyToDepMap = Map\u0026lt;any, Dep\u0026gt; // æ–°å¢å¯¹è±¡çš„ key -\u0026gt; Dep const targetMap = new WeakMap\u0026lt;any, KeyToDepMap\u0026gt;()   jest 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  â˜ vue-next-code-read [master] jest FAIL packages/__tests__/reactive/reactive.spec.js (5.447 s) â— reactivity/reactive â€º markRaw expect(received).toBe(expected) // Object.is equality Expected: false Received: true 106 | }) 107 | expect(isReactive(obj.foo)).toBe(true) \u0026gt; 108 | expect(isReactive(obj.bar)).toBe(false) \u0026gt; | ^ \u0026gt; 109 | }) \u0026gt; 110 | \u0026gt; 111 | test(\u0026#39;should not observe frozen objects\u0026#39;, () =\u0026gt; { at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/reactive.spec.js:108:33) FAIL packages/__tests__/reactive/effect.spec.js (5.589 s) â— reactivity/effect â€º markRaw expect(received).toBe(expected) // Object.is equality Expected: 0 Received: 1 744 | expect(dummy).toBe(0) 745 | obj.foo.prop++ \u0026gt; 746 | expect(dummy).toBe(0) \u0026gt; | ^ \u0026gt; 747 | obj.foo = { prop: 1 } \u0026gt; 748 | expect(dummy).toBe(1) \u0026gt; 749 | }) at Object.\u0026lt;anonymous\u0026gt; (packages/__tests__/reactive/effect.spec.js:746:19) Test Suites: 2 failed, 2 total Tests: 2 failed, 59 passed, 61 total Snapshots: 0 total Time: 9.857 s Ran all test suites.   è¿™ä¸¤ä¸ªåŸå› å…¶å®éƒ½æ˜¯å› ä¸º canObserve è¿˜æ²¡æ›´æ–°è¿‡æ¥ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7  const canObserve = (value) =\u0026gt; { return ( !value.__v_skip \u0026amp;\u0026amp; isObservableType(toRawType(value)) \u0026amp;\u0026amp; !Object.isFrozen(value) ) }   é‡æ–° jest é€šè¿‡ï¼š\n â˜ vue-next-code-read [master] âš¡ jest PASS packages/tests/reactive/reactive.spec.js (5.311 s) PASS packages/tests/reactive/effect.spec.js (5.429 s)\nTest Suites: 2 passed, 2 total Tests: 61 passed, 61 total Snapshots: 0 total Time: 9.612 s Ran all test suites. â˜ vue-next-code-read [master] âš¡\n Reactive.js\n collectionHandlers.ts ä¹Ÿè¯¥å¼€å§‹é›†åˆç±»å‹æ”¯æŒäº†ï¼Œè¿™éƒ¨åˆ†çš„ä¿®æ”¹ä¸»è¦é›†ä¸­åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œå› ä¸ºä¹‹å‰ reactive.ts, effect.ts é‡Œé¢éƒ½å·²ç»æŠŠé›†åˆç±»å‹ä»£ç åˆå¹¶è¿›å»äº†(å…¶å®é™¤äº† trigger é‡Œé¢æœ‰éƒ¨åˆ†çš„ map ç›¸å…³åŒºåˆ†ä¹‹åï¼Œç»å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€æ ·çš„)ã€‚\nè¿™é‡Œå¯èƒ½å¾—åšä¸ªäº‹æƒ…ï¼Œå¦‚æœè¿˜æƒ³åšæŒä½¿ç”¨ä¸€ä¸ª js æ–‡ä»¶æ¥å®ŒæˆåŠŸèƒ½ï¼Œé‚£åªèƒ½è€ƒè™‘ä½¿ç”¨ä½œç”¨åŸŸå¯¹è±¡æ¥å¤„ç†äº†ï¼Œå³å°† baseHandlers å’Œ collectionHandlers åˆ†åˆ«ç”¨å•ç‹¬ä¸€ä¸ªå¯¹è±¡æ¥æ‰¿è½½ï¼Œå› ä¸ºé‡Œé¢çš„å‡½æ•°åéƒ½æ˜¯åŒä¸€ä¸ªï¼Œä¸ç„¶å°±åªèƒ½æ‹†åˆ†æˆå¤šä¸ªæ–‡ä»¶äº†ã€‚\næ€è€ƒä¸­ â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡â˜¡\u0026hellip;\u0026hellip;\nè¿˜æ˜¯æ‹†åˆ†å§ï¼Œå’Œ vue æºç ç»“æ„ä¿æŒä¸€è‡´ï¼Œå¢åŠ  reactive ç›®å½•æ¥æ‰¿è½½ã€‚\nåˆ†ç¦»ä¹‹åçš„ç›®å½•å¤‡ä»½ bakups/reactive_files_v\nä¸‹é¢è¿›å…¥æ­£é¢˜ \u0026raquo;\u0026raquo;\u0026raquo;\u0026raquo;\næ–°å»º collectionHandlers.js ç”¨æ¥å®šä¹‰é›†åˆç±»å‹æœ‰å…³çš„ proxy handlersã€‚\næŠŠ reactive.js é‡Œé¢çš„\n1 2 3 4  // TODO export const mutableCollectionHandlers = {} export const readonlyCollectionHandlers = {} export const shallowCollectionHandlers = {}   ç§»åˆ° collectionHandler.js é‡Œï¼Œè¿™èŠ‚æ¥ä¸‹æ¥æ‰€æœ‰çš„å·¥ä½œéƒ½æ˜¯ä¸ºäº†æ„å»ºè¿™ä¸‰ä¸ª handlersã€‚\nå°†æŒ‰ get -\u0026gt; set -\u0026gt; size -\u0026gt; add -\u0026gt; deleteEntry -\u0026gt; has -\u0026gt; clear é¡ºåºæ¥ä¸€æ­¥æ­¥å®ç°ã€‚\nå‡†å¤‡å·¥ä½œ æœ‰äº† baseHandlers.ts å®ç°çš„åŸºç¡€ï¼Œå°±æ²¡å¿…è¦å†é‚£ä¹ˆè¯¦ç»†çš„æ­¥éª¤å»å®ç°äº†ï¼Œè¿™é‡Œå°†æ‰€æœ‰å‡†å¤‡å·¥ä½œåšè¶³ï¼Œä¸»è¦å°±æ˜¯ä¸€äº›åŸºç¡€å˜é‡çš„å£°æ˜ï¼Œåœ¨ç†è§£å®ƒçš„åŸºç¡€ä¸Šå…ˆå£°æ˜å¥½ï¼Œè€Œä¸æ˜¯ç”¨çš„æ—¶å€™å†å»å£°æ˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  // reactive åŒ– const toReactive = \u0026lt;T extends unknown\u0026gt;(value: T): T =\u0026gt; isObject(value) ? reactive(value) : value // readonly reactive const toReadonly = \u0026lt;T extends unknown\u0026gt;(value: T): T =\u0026gt; isObject(value) ? readonly(value) : value // shallow reactive const toShallow = \u0026lt;T extends unknown\u0026gt;(value: T): T =\u0026gt; value // å–åŸå‹åŸå­æ“ä½œ Reflect const getProto = \u0026lt;T extends CollectionTypes\u0026gt;(v: T): any =\u0026gt; Reflect.getPrototypeOf(v) // ä¸‰ä¸ª handlers å¯¹åº”çš„ instrumentations const mutableInstrumentations: Record\u0026lt;string, Function\u0026gt; = {/*...*/} const shallowInstrumentations: Record\u0026lt;string, Function\u0026gt; = {/*...*/} const readonlyInstrumentations: Record\u0026lt;string, Function\u0026gt; = {/*...*/} // é›†åˆç±»å‹å‡ ä¸ªè¿­ä»£æ–¹æ³•å’Œè¿­ä»£å™¨ const iteratorMethods = [\u0026#39;keys\u0026#39;, \u0026#39;values\u0026#39;, \u0026#39;entries\u0026#39;, Symbol.iterator] // ä¸‰ä¸ª handlers åªéœ€è¦ä¸€ä¸ª get ???????????? export const mutableCollectionHandlers: ProxyHandler\u0026lt;CollectionTypes\u0026gt; = { get: createInstrumentationGetter(false, false) } export const shallowCollectionHandlers: ProxyHandler\u0026lt;CollectionTypes\u0026gt; = { get: createInstrumentationGetter(false, true) } export const readonlyCollectionHandlers: ProxyHandler\u0026lt;CollectionTypes\u0026gt; = { get: createInstrumentationGetter(true, false) }   createInstrumentationGetter ç”±äºä¸‰ä¸ª handlers éƒ½æ˜¯ç”±è¿™ä¸ªç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¾—ä¸ä»¥è¿™ä¸ªå‡½æ•°ä½œä¸ºåˆ‡å…¥ç‚¹ã€‚\nåœ¨è¿™ä¹‹å‰å¿…é¡»çš„å®Œæˆå‡†å¤‡å·¥ä½œï¼ŒæŠŠéœ€è¦çš„å˜é‡éƒ½å®ç°å‡†å¤‡å¥½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  // proxy handlers å¯¹è±¡ const mutableInstrumentations = {} const shallowInstrumentations = {} const readonlyInstrumentations = {} function createInstrumentationGetter(isReadonly, shallow) { // å†³å®šä½¿ç”¨å“ªç§ç±»å‹çš„ instru...  const instrumentations = shallow ? shallowInstrumentations : isReadonly ? readonlyInstrumentations : mutableInstrumentations // Reflect.get ç±»å‹çš„ proxy handler  return (target, key, receiver) =\u0026gt; { switch (key) { case ReactiveFlags.isReactive: return !isReadonly case ReactiveFlags.isReadonly: return isReadonly case ReactiveFlags.raw: return target default: break } } // éš¾é“é›†åˆç±»å‹çš„ proxy handler ç»Ÿç»Ÿèµ°çš„éƒ½æ˜¯ proxy get ???  return Reflect.get( hasOwn(instrumentations, key) \u0026amp;\u0026amp; key in target ? instrumentations : target, key, receiver ) }   è¿™é‡Œå¯¹äºé›†åˆç±»å‹åªæä¾›ä¸€ä¸ª get proxy handler å’Œä¹‹å‰ç¢°åˆ°è¿‡çš„æŠ¥é”™ VM1029:1 Uncaught TypeError: Method Map.prototype.get called on incompatible receiver [object Object] é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼Œç½‘ä¸Šè¯´çš„æ˜¯ä¸¢å¤±äº†ä½œç”¨åŸŸï¼Œçœ‹æŠ¥é”™çš„æç¤ºä¹Ÿç¡®å®æ˜¯è¿™ä¸ªåŸå› ã€‚\næ ¹æºåœ¨äºä½ ä½¿ç”¨ observed-\u0026gt;Map çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ observed.get() å»è°ƒç”¨ï¼Œä½† observed æ˜¯ä¸ª Proxy ç±»å‹ï¼Œåœ¨ proxy handler é‡Œé¢ Reflect éœ€è¦è°ƒç”¨çš„åˆæ˜¯ Map ç±»å‹ä¸Šé¢çš„ get æ–¹æ³•(å› ä¸ºå®ƒæ˜¯ target çš„åŸå­æ“ä½œå•Š)ï¼Œå› æ­¤å°±å‡ºç°äº† Proxy -\u0026gt; è°ƒç”¨ Map.prototype.get å¯¼è‡´å¤±è´¥æŠ¥é”™ ã€‚\nè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ€ç®€å•æ˜¯æ”¹å˜ Reflect.get çš„è°ƒç”¨ä½œç”¨ï¼Œå¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11  var m = new Map([ [\u0026#39;foo\u0026#39;, 1], [\u0026#39;bar\u0026#39;, 2] ]) var ob = new Proxy(m, { get(target, key, receiver) { console.log({ key }, target, \u0026#39;111 get proxy\u0026#39;) return Reflect.get.call(target, target, key, receiver) } })   æ—¢ç„¶ç°åœ¨çŸ¥é“äº† map çš„æ“ä½œéƒ½éœ€è¦é€šè¿‡ get æ¥è¿›è¡Œè¿›ä¸€æ­¥\u0026quot;ä»£ç†\u0026rdquo;ï¼ŒcreateInstrumentationGetter ä¹Ÿå®ç°äº†ï¼Œè¿™ä¸ªä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ®ç‰¹æ€§åˆ¤æ–­é‡‡ç”¨é‚£ä¸€ä¸ª instrumentationsï¼Œç„¶åè¿”å› Reflect.get ç»“æœï¼Œä¸­é—´åŠ ä¸Šäº† ReactiveFlags çš„ä¸€äº›åˆ¤æ–­è€Œå·²ã€‚\nä¸‰ä¸ª handlers ï¼š\n1 2 3 4 5 6 7 8 9  export const mutableCollectionHandlers = { get: createInstrumentationGetter(false, false) } export const readonlyCollectionHandlers = { get: createInstrumentationGetter(true, false) } export const shallowCollectionHandlers = { get: createInstrumentationGetter(false, true) }   get(target, key, wrap) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function get(target, key, wrap) { target = toRaw(target) const rawKey = toRaw(key) console.log({ target, key, rawKey }, \u0026#39;get\u0026#39;) if (key !== rawKey) { track(target, \u0026#39;get\u0026#39;, key) } track(target, \u0026#39;get\u0026#39;, rawKey) const { has, get } = getProto(target) if (has.call(target, key)) { return wrap(get.call(target, key)) } else if (has.call(target, rawKey)) { return wrap(get.call(target, rawKey)) } }   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  var or = new Map([ [\u0026#39;foo\u0026#39;, 1], [\u0026#39;bar\u0026#39;, 2] ]) var ob = reactive(or) console.log(isReactive(ob), \u0026#39;is reactive\u0026#39;) console.log(or instanceof Map, \u0026#39;or is map\u0026#39;) console.log(ob instanceof Map, \u0026#39;ob is map\u0026#39;) console.log(\u0026#39;=============================\u0026#39;) let dummy effect(() =\u0026gt; { dummy = ob.get(\u0026#39;key\u0026#39;) }) console.log({ dummy }, \u0026#39;1\u0026#39;) ob.set(\u0026#39;foo\u0026#39;, 2)   ç»“æœï¼š\næ³¨æ„çœ‹ createInstrumentationGetter è¿”å›çš„ç®­å¤´å‡½æ•°é‡Œè¿”å›çš„å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  return Reflect.get( hasOwn(instrumentations, key) \u0026amp;\u0026amp; key in target ? instrumentations : target, key, receiver ) // ä¸Šé¢çš„å‡è®¾æ˜¯ mutableInstrumentationsï¼Œé‚£ä¹ˆä¸Šé¢çš„ä»£ç å°±ç›¸å½“äº // å‡è®¾è°ƒç”¨çš„æ˜¯ observed.get(key, ...)ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå‚æ•° key = \u0026#39;get\u0026#39; return Reflect.get({ get() { /* mutableInstrumentations é‡Œé¢çš„ get æ–¹æ³•*/ } }, \u0026#39;get\u0026#39;, receiver)   ç»è¿‡ä¸Šé¢çš„è½¬æ¢ä¹‹åå°±æ¯”è¾ƒæœ‰æ„æ€äº†ï¼Œä¸ç®¡ä½ é€šè¿‡ observed è°ƒç”¨ä»€ä¹ˆæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«è½¬æˆ Reflect.get å–å€¼æ“ä½œï¼Œè€Œå–å€¼çš„å…³é”®åœ¨äºä¸¤ç‚¹ï¼š\n è¢«å–å€¼çš„å¯¹è±¡è¿™é‡Œå°±æ˜¯æˆ‘ä»¬çœŸæ­£å®šä¹‰çš„ proxy handler å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†æŒ‡å®šç‰¹æ€§éœ€è¦çš„å‡½æ•° key ä¸º observed è°ƒç”¨çš„é‚£ä¸ªæ–¹æ³•åç§°ï¼Œå¿…é¡»å–å€¼ observed.get é‚£ä¹ˆ key å°±æ˜¯ \u0026lsquo;get\u0026rsquo;ï¼Œobserved.set ï¼Œé‚£ä¹ˆ key å°±æ˜¯ \u0026lsquo;set\u0026rsquo;  æœ€ç»ˆ observed.get \u0026mdash;\u0026gt; å…¶å®å°±æ˜¯ mutableInstrumentations.get ã€‚\nTODO ç–‘é—®ï¼Ÿï¼Ÿ   Get é‡Œçš„ ä¸¤æ¬¡ toRaw æ˜¯å•¥æ„æ€ï¼Ÿï¼Ÿï¼Ÿ\n1 2 3 4 5 6 7 8 9  function get(target, key, wrap) { // è¿™é‡Œä¸ºå•¥è¦å–ä¸¤æ¬¡ toRawï¼Œç„¶åå¯èƒ½ä¼šè§¦å‘ä¸¤æ¬¡ track???  target = toRaw(target) const rawKey = toRaw(key) if (key !== rawKey) { track(target, \u0026#39;get\u0026#39;, key) } track(target, \u0026#39;get\u0026#39;, rawKey) }     åœ¨å®ç° get çš„æ—¶å€™ vue æºç é‡Œæ˜¯è¿™æ ·çš„ï¼š get(this: MapTypes, ...) ä½†å®é™…è¿™ç§è¯­æ³•åœ¨ js ä¸­è‚¯å®šæ˜¯ä¸æ”¯æŒçš„\nç„¶åè‡ªå·±å°±æ”¹å†™äº†ä¸‹ï¼š\n1 2 3 4 5 6 7  // proxy handlers å¯¹è±¡ const mutableInstrumentations = { get(scope, key) { return get(this, key, toReactive) }, set }   ç»“æœå‘ç°ä¸å¤ªå¯¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  var or = new Map() var ob = reactive(or) let dummy effect(() =\u0026gt; { dummy = ob.get(\u0026#39;key\u0026#39;) console.log({ dummy }, \u0026#39;effect\u0026#39;) }) console.log({ dummy }, \u0026#39;1\u0026#39;) /* ob.set(\u0026#39;key\u0026#39;, \u0026#39;value\u0026#39;) */ /* console.log({ dummy }, \u0026#39;2\u0026#39;) */ console.log(targetMap.get(or))   ç»“æœï¼š\nè¿™é‡Œæ”¶é›†çš„ä¾èµ–çš„ key ç«Ÿç„¶æ˜¯ undefinedï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ å…¥ç»™ get(target, key, wrap) çš„ key ä¸¢å¤±äº†ã€‚\nè™½ç„¶çŸ¥é“åŸå› ï¼šå°±æ˜¯ä¸Šé¢çš„ mutableInstrumentations çš„ get å¤šäº†ä¸€ä¸ªå‚æ•°å•Šï¼Œè¿™è²Œä¼¼å“ªé‡Œä¸å¤ªå¯¹ï¼Œæ— å¥ˆå»çœ‹äº†ä¸‹ vue.global.js æ‰“åŒ…ä¹‹åçš„ä»£ç ï¼Œæ‰å‘ç°ç«¯å€ªã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  // æ‰“åŒ…ä¹‹åçš„ get const readonlyInstrumentations = { get(key) { // è¯·çœ‹è¿™é‡Œï¼Œæ‰“åŒ…ä¹‹åç¬¬ä¸€ä¸ª this æ²¡æœ‰äº†  return get$1(this, key, toReadonly) }, } // æ‰“åŒ…ä¹‹å‰çš„ getï¼Œtsè¯­æ³• const mutableInstrumentations: Record\u0026lt;string, Function\u0026gt; = { get(this: MapTypes, key: unknown) { return get(this, key, toReactive) } }   ç”±äº js æ˜¯ä¸æ”¯æŒç”¨ this åšå‡½æ•°å‚æ•°çš„ï¼Œæ‰€ä»¥åªèƒ½ä» TypeScript å»æ–¹å‘ç€æ‰‹äº†\u0026hellip;\u0026hellip;ï¼Œç„¶åï¼Œç„¶åå°±æœ‰äº†ç»“æœï¼š\nts ä¸­çš„ this ä½œä¸ºå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°çš„è¯­æ³•è¯´æ˜\nè¢«åœˆåœˆçš„ä¸¤ä¸ªå•è¯æ˜¯å…³é”®ï¼Œå®ƒå°±æ˜¯ä¸ªå‡çš„å‚æ•°ï¼Œä½œç”¨ä¹Ÿå°±æ˜¯è®©å‡½æ•°èƒ½å£°æ˜å®ƒè¢«è°ƒç”¨çš„é‚£ä¸ªå¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Œå› æ­¤ä¹Ÿå°±æ˜ç™½ä¸ºä½•æ‰“åŒ…ä¹‹å‰å’Œæ‰“åŒ…ä¹‹åä»£ç çš„å·®å¼‚äº†ã€‚\næ‰€ä»¥è¯¥é—®é¢˜è§£å†³æ–¹æ³•å°±æ˜¯å»æ‰ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•° key ï¼Œå¦‚ï¼š\n1 2 3 4 5 6  const mutableInstrumentations = { get(key) { return get(this, key, toReactive) }, set }     set(this, key, value) å¼„æ¸…æ¥š TypeScript çš„ this argument ä¹‹åï¼Œè§£å†³äº† get ä¹Ÿå°±è§£å†³äº† set é—®é¢˜äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  function set(key, value) { value = toRaw(value) // å–è°ƒç”¨ set çš„é‚£ä¸ªå¯¹è±¡ï¼Œå–å‡ºå®ƒåŸå‹ä¸Šçš„ has, get, setï¼Œ  // ä¹Ÿå°±æ˜¯ target: Map  const target = toRaw(this) const { has, get, set } = getProto(target) let hadKey = has.call(target, key) if (!hadKey) { // key æ˜¯ä¸æ˜¯æœ‰å¯èƒ½ä¹Ÿæ˜¯ä¸ª observed ???  // Map çš„ key ä¸ä»…é™äºæ™®é€šç±»å‹ï¼Œå¯ä»¥æ˜¯ä»»æ„ç±»å‹  key = toRaw(key) // é‚£ä¹ˆé‡æ–°å–ä¸€æ¬¡å€¼  hadKey = has.call(target, key) } else if (__DEV__) { // TODO  } // å–æ—§å€¼  const oldValue = get.call(target, key) // æŠŠå€¼è®¾ç½®åˆ° observed ä¹‹å‰çš„å¯¹è±¡ä¸Šï¼Œå¯å‚è€ƒä¸‹é¢çš„ç»“æœå›¾  const result = set.call(target, key, value) // ä¸‹é¢å°±æ˜¯è·Ÿ basehandler ä¸€æ ·çš„å¢åŠ æˆ–è®¾ç½®æ“ä½œäº†  if (!hadKey) { trigger(target, \u0026#39;add\u0026#39;, key, value) } else if (hasChanged(value, oldValue)) { trigger(target, \u0026#39;set\u0026#39;, key, value, oldValue) } // è®°å¾—è¿”å›è®¾ç½®ç»“æœ  return result }   æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  var or = new Map() var ob = reactive(or) let dummy effect(() =\u0026gt; { dummy = ob.get(\u0026#39;key\u0026#39;) }) console.log({ dummy }, \u0026#39;1\u0026#39;) ob.set(\u0026#39;key\u0026#39;, \u0026#39;value\u0026#39;) console.log({ dummy }, \u0026#39;2\u0026#39;) console.log(targetMap.get(or))   ç»“æœï¼š\næœ‰äº† get å’Œ set å®ç°æ‰“åŸºç¡€ä¸‹é¢çš„å®ç°å°±ğŸŒ¾æ¸ æˆäº†ï¼Œä½†é©å‘½è¿˜æœªæˆåŠŸï¼Œä¾æ—§éœ€è¦åŠªåŠ›è°¨æ…ï¼ŒğŸ©ğŸ©ğŸ©\u0026hellip;\u0026hellip;\nsize(target) Map çš„ size å±æ€§æ˜¯ä¸€ä¸ªåŸå‹æ˜¯ä¸Šçš„å±æ€§ï¼š Map.prototype.sizeï¼Œ è‡³äºä¸ºä»€ä¹ˆè¦ç”¨ITERATE_KEY é‚£å°±éœ€è¦çœ‹ä¸‹\nè¿™é‡Œäº†\nå®ç°çš„æ—¶å€™æ˜¯éœ€è¦å¯¹ Map è¿›è¡Œè¿­ä»£çš„(for [key, value] of map)ï¼Œå› æ­¤ä¼šè§¦å‘ iterate è¡Œä¸ºæ¥æ”¶é›†ä¾èµ–ã€‚\n1 2 3 4 5 6  function size(target) { target = toRaw(target) track(target, \u0026#39;iterate\u0026#39;, ITERATE_KEY) // size æ˜¯åœ¨ Map åŸå‹ä¸Šçš„ä¸€ä¸ªå±æ€§  return Reflect.get(getProto(target), \u0026#39;size\u0026#39;, target) }   æ›´æ–° mutableInstrumentations:\n1 2 3 4 5 6 7 8 9 10  // proxy handlers å¯¹è±¡ const mutableInstrumentations = { get(key) { return get(this, key, toReactive) }, set, get size() { return size(this) } }   add(value) é™äº Set ç±»å‹ä½¿ç”¨ï¼Œä½†æ˜¯ä¸ºå•¥ä¸åŠ ä¸ªåˆ¤æ–­å‘¢ï¼Ÿï¼Ÿï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11  function add(value) { value = toRaw(value) const target = toRaw(this) const proto = getProto(target) // Set.prototype ....  const hadKey = proto.has.call(target, value) // Set.prototype.has  const result = proto.add.call(target, value) // Set.prototype.add  if (!hadKey) { trigger(target, \u0026#39;add\u0026#39;, value, value) } return result }   æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12  var or = new Set() var ob = reactive(or) const fn = () =\u0026gt; {} let dummy effect(() =\u0026gt; { dummy = ob.has(fn) }) console.log({ dummy }, \u0026#39;before\u0026#39;) ob.add(fn) console.log({ dummy }, \u0026#39;after\u0026#39;)   ç»“æœï¼š\n {dummy: false} \u0026ldquo;before\u0026rdquo; {dummy: true} \u0026ldquo;after\u0026rdquo;\n deleteEntry(key) Map/Set.prototype.delete çš„ proxy handler\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function deleteEntry(key) { const target = toRaw(this) const { has, get, delete: del } = getProto(target) const hadKey = has.call(target, key) if (!hadKey) { key = toRaw(key) hadKey = has.call(target, key) } else if (__DEV__) { // TODO  } const oldValue = get ? get.call(target, key) : undefined const result = del.call(target, key) if (hadKey) { trigger(target, \u0026#39;delete\u0026#39;, key, undefined, oldValue) } return result }   æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  var or = new Map() var ob = reactive(or) const fn = () =\u0026gt; {} let dummy effect(() =\u0026gt; { dummy = ob.has(fn) }) console.log({ dummy }, \u0026#39;before\u0026#39;) // false ob.set(fn, true) // å¢åŠ ï¼Œè§¦å‘ fn -\u0026gt; updater console.log({ dummy }, \u0026#39;after\u0026#39;) // true ob.clear() // æ¸…ç©ºï¼Œtrigger: clear console.log({ dummy }, \u0026#39;cleared\u0026#39;) // false ob.set(fn, false) // trigger: add console.log({ dummy }, \u0026#39;add\u0026#39;) // true ob.delete(fn) // trigger: delete console.log({ dummy }, \u0026#39;deleted\u0026#39;) // false   ç»“æœ\n {dummy: false} \u0026ldquo;before\u0026rdquo; {dummy: true} \u0026ldquo;after\u0026rdquo; {dummy: false} \u0026ldquo;cleared\u0026rdquo; {dummy: true} \u0026ldquo;add\u0026rdquo; {dummy: false} \u0026ldquo;deleted\u0026rdquo;\n has(key) 1 2 3 4 5 6 7 8 9 10 11  function has(key) { const target = toRaw(this) const rawKey = toRaw(key) if (key !== rawKey) { track(target, \u0026#39;has\u0026#39;, key) } track(target, \u0026#39;has\u0026#39;, rawKey) const has = getProto(target).has return has.call(target, key) || has.call(target, rawKey) }\t  æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  var or = new Map() var ob = reactive(or) let dummy, has effect(() =\u0026gt; { dummy = ob.size has = ob.has(\u0026#39;a\u0026#39;) }) console.log({ dummy, has }, \u0026#39;before\u0026#39;) ob.set(\u0026#39;a\u0026#39;, 1) // æ”¹å˜äº† size console.log({ dummy, has }, \u0026#39;after\u0026#39;)   ç»“æœï¼š\n {dummy: 0, has: false} \u0026ldquo;before\u0026rdquo; {dummy: 1, has: true} \u0026ldquo;after\u0026rdquo;\n clear() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function clear() { const target = toRaw(this) const hadItems = target.size !== 0 const oldTarget = __DEV__ ? target instanceof Map ? new Map(target) : new Set(target) : undefined const result = getProto(target).clear.call(target) if (hadItems) { trigger(target, \u0026#39;clear\u0026#39;, undefined, undefined, oldTarget) } return result }   æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  var or = new Set() var ob = reactive(or) const fn = () =\u0026gt; {} let dummy effect(() =\u0026gt; { dummy = ob.has(fn) }) console.log({ dummy }, \u0026#39;before\u0026#39;) ob.add(fn) console.log({ dummy }, \u0026#39;after\u0026#39;) ob.clear() console.log({ dummy }, \u0026#39;cleared\u0026#39;)   ç»“æœ\n {dummy: false} \u0026ldquo;before\u0026rdquo; {dummy: true} \u0026ldquo;after\u0026rdquo; {dummy: false} \u0026ldquo;cleared\u0026rdquo;\n forEach(isReadonly, shallow) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  return function forEach(callback, thisArg) { const observed = this const target = toRaw(observed) const wrap = isReadonly ? toReadonly : shallow ? toShallow : toReactive !isReadonly \u0026amp;\u0026amp; track(target, \u0026#39;iterate\u0026#39;, ITERATE_KEY) // å°è£…çš„ç›®çš„ï¼š  // 1. ç¡®ä¿åœ¨ thisArg ä½œç”¨åŸŸä¸‹è°ƒç”¨  // 2. ç¡®ä¿ä¼ é€’ç»™ callback çš„å€¼éƒ½æ˜¯ creative çš„  function wrappedCallback(value, key) { return callback.call(thisArg, wrap(value), wrap(key), observed) } return getProto(target).forEach.call(target, wrappedCallback) }   æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  var or = new Map() var ob = reactive(or) const fn = () =\u0026gt; {} let dummy effect(() =\u0026gt; { ob.forEach((key, val) =\u0026gt; { dummy++ }) }) console.log({ dummy }, 0) ob.set(1, 1) console.log({ dummy }, 1) ob.set(2, 2) console.log({ dummy }, 2) ob.set(3, 3) console.log({ dummy }, 3)   æœªå®ç°ä¹‹å‰ç»“æœ\n {dummy: 0} 0 {dummy: 0} 1 {dummy: 0} 2 {dummy: 0} 3\n å®ç°ä¹‹åç»“æœ\n {dummy: 0} 0 {dummy: 1} 1 {dummy: 3} 2 {dummy: 6} 3\n ä¸‰ä¸ªå°çŸ®äºº(handlers, createIterableMethod) åªè¯»æ“ä½œçš„ handlers ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  // åªè¯»å‡½æ•°ï¼Œä¼šæ”¹å˜å¯¹è±¡çš„æ“ä½œå‡ä¸å“åº” function createReadonlyMethod(type) { return function (...args) { if (__DEV__) { const key = args[0] ? `on key \u0026#34;${args[0]}\u0026#34; ` : `` console.warn( `${type}operation ${key}failed: target is readonly.`, toRaw(this) ) } return type === \u0026#39;delete\u0026#39; ? false : this } }   ä¸‰ä¸ªå°ä¸»äººå…¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  // proxy handlers å¯¹è±¡ const mutableInstrumentations = { get(key) { return get(this, key, toReactive) }, set, get size() { return size(this) }, has, add, clear, delete: deleteEntry, forEach: createForEach(false, false) } const shallowInstrumentations = { get(key) { return get(this, key, toShallow) }, get size() { return size(this) }, has, add, set, delete: deleteEntry, clear, forEach: createForEach(false, true) } const readonlyInstrumentations = { get(key) { return get(this, key, toReadonly) }, get size() { return size(this) }, has, add: createReadonlyMethod(\u0026#39;add\u0026#39;), set: createReadonlyMethod(\u0026#39;set\u0026#39;), delete: createReadonlyMethod(\u0026#39;delete\u0026#39;), clear: createReadonlyMethod(\u0026#39;clear\u0026#39;), forEach: createForEach(true, false) }   é’ˆå¯¹è¿­ä»£å™¨æ“ä½œï¼Œåˆ›å»ºè¿­ä»£å™¨ä»£ç† handler:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  function createIterableMethod(method, isReadonly, shallow) { return function (...args) { const target = toRaw(this) const isMap = target instanceof Map // æ£€æµ‹æ˜¯ä¸æ˜¯ Set æˆ– Mapï¼ŒMapè¿­ä»£çš„æ—¶å€™è¿”å›çš„æ˜¯for [key, value] of map  // Set è¿­ä»£çš„æ—¶å€™è¿”å›çš„æ—¶å€™æ˜¯ for value of set  // Object.entries()  const isPair = method === \u0026#39;entries\u0026#39; || (method === Symbol.iterator \u0026amp;\u0026amp; isMap) // Object.keys()  const isKeyOnley = method === \u0026#39;keys\u0026#39; \u0026amp;\u0026amp; isMap // å–å‡ºåŸç”Ÿçš„ è¿­ä»£å™¨  const innerIterator = getProto(target)[method].apply(target, args) // åµŒå¥— reactive  const wrap = isReadonly ? toReadonly : shallow ? toShallow : toReactive // è§¦å‘è¿­ä»£å™¨ æ”¶é›†ä¾èµ–  !isReadonly \u0026amp;\u0026amp; track(target, \u0026#39;iterate\u0026#39;, isKeyOnley ? MAP_KEY_ITERATE_KEY : ITERATE_KEY) return { // å°è£…ä¸€å±‚ï¼Œè¿­ä»£å™¨çš„ä¸¤ä¸ªå¿…å¤‡æ¡ä»¶ï¼š1. next()ï¼Œ2. Symbol.iterator å¿…é¡»å®ç°  next() { // åŸæœ¬çš„è¿­ä»£å™¨  const { value, done } = innerIterator.next() return done ? { value, done } : { // å¤„ç† entries æˆ– keys, valuesï¼Œå¯¹åµŒå¥—çš„å¯¹è±¡è¿›è¡Œ reactiv  value: isPair ? [wrap(value[0]), wrap(value[1])] : wrap(value), done } }, // å¯è¿­ä»£å¯¹è±¡å®ç°åŸºç¡€  [Symbol.iterator]() { return this } } } }   æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  var or = new Map() var ob = reactive(or) const fn = () =\u0026gt; {} let keys, values, entries effect(() =\u0026gt; { keys = ob.keys() values = ob.values() entries = ob.entries() }) console.log(keys.next(), values.next(), entries.next(), 0) ob.set(\u0026#39;a\u0026#39;, 1) console.log(keys.next(), values.next(), entries.next(), 1)   ç»“æœ\njest ç»“æœï¼š\n â˜ vue-next-code-read [master] âš¡ jest PASS packages/tests/reactive/reactive.spec.js PASS packages/tests/reactive/effect.spec.js PASS packages/tests/reactive/collection/WeakSet.spec.js PASS packages/tests/reactive/collection/Map.spec.js PASS packages/tests/reactive/collection/WeakMap.spec.js PASS packages/tests/reactive/collection/Set.spec.js\nTest Suites: 6 passed, 6 total Tests: 132 passed, 132 total Snapshots: 0 total Time: 5.278 s Ran all test suites.\n åˆ†æ\n  âœ“ instanceof (3 ms)\næ³¨æ„ Proxy ä¹‹åçš„ observed çš„ proto å€¼æ˜¯ Map ï¼Œæ‰€ä»¥å¯¹ observed ä½¿ç”¨ instanceof Map(æŸ¥æ‰¾åŸå‹é“¾) ç»“æœè‚¯å®šæ˜¯ trueã€‚\n  âœ“ should observe mutations (2 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  it(\u0026#39;should observe mutations\u0026#39;, () =\u0026gt; { let dummy const map = reactive(new Map()) effect(() =\u0026gt; { // è¿™é‡Œè§¦å‘çš„æ˜¯ map å¯¹è±¡çš„ \u0026#39;get\u0026#39; proxy handler  // key = \u0026#39;get\u0026#39;, æœ€åé€šè¿‡ Reflect.get(instrumentations{...}, \u0026#39;get\u0026#39;, receiver)  // å³æœ€åè°ƒç”¨ \u0026#39;get\u0026#39; æ–¹æ³•çš„æ˜¯ instrumentations è¿™äº›å¯¹è±¡  // å¦‚ï¼š mutableInstrmentations çš„ get(key) { return get(this, key, toReactive) }  // ç„¶å get(key) çš„ key = \u0026#39;key\u0026#39;ï¼Œä¼ é€’ç»™ `get(this, ...)`  // ç„¶ååœ¨ get(this, ...) é‡Œé¢é€šè¿‡ call-\u0026gt;proto å»è°ƒç”¨åŸå‹ä¸Šçš„æ–¹æ³•ï¼Œè§£å†³ä½œç”¨åŸŸä¸¢å¤±çš„é—®é¢˜  dummy = map.get(\u0026#39;key\u0026#39;) }) expect(dummy).toBe(undefined) // true  // è°ƒç”¨çš„æ˜¯ instrumentations çš„ set =\u0026gt; set(this, ...)  map.set(\u0026#39;key\u0026#39;, \u0026#39;value\u0026#39;) // map{\u0026#39;key\u0026#39; =\u0026gt; \u0026#39;value\u0026#39;}, trigger: add  expect(dummy).toBe(\u0026#39;value\u0026#39;) // true  map.set(\u0026#39;key\u0026#39;, \u0026#39;value2\u0026#39;) // trigger: set  expect(dummy).toBe(\u0026#39;value2\u0026#39;) // true  map.delete(\u0026#39;key\u0026#39;) // trigger: delete  expect(dummy).toBe(undefined) })     âœ“ should observe mutations with observed value as key (1 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13  let dummy const key = reactive({}) const value = reactive({}) const map = reactive(new Map()) effect(() =\u0026gt; { dummy = map.get(key) }) expect(dummy).toBe(undefined) map.set(key, value) // ç”¨ observe å¯¹è±¡ä½œä¸º key å’Œ value expect(dummy).toBe(value) // trueï¼Œéƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œéå€¼ä¼ é€’ map.delete(key) expect(dummy).toBe(undefined)     âœ“ should observe size mutations (1 ms)\n  âœ“ should observe for of iteration (2 ms)\n  âœ“ should observe forEach iteration (1 ms)\n  âœ“ should observe keys iteration (3 ms)\n  âœ“ should observe values iteration (3 ms)\n  âœ“ should observe entries iteration (5 ms)\n  âœ“ should be triggered by clearing (3 ms)\n  âœ“ should not observe custom property mutations (6 ms)\n  âœ“ should not observe non value changing mutations (4 ms)\n  âœ“ should not observe raw data (1 ms)\n  âœ“ should not pollute original Map with Proxies (7 ms)\n  âœ“ should return observable versions of contained values (1 ms)\n  âœ“ should observed nested data (2 ms)\n  âœ“ should observe nested values in iterations (forEach) (1 ms)\n  âœ“ should observe nested values in iterations (values) (1 ms)\n  âœ“ should observe nested values in iterations (entries) (2 ms)\n  âœ“ should observe nested values in iterations (for\u0026hellip;of) (2 ms)\n  âœ“ should not be trigger when the value and the old value both are NaN (1 ms)\n  âœ“ should work with reactive keys in raw map (1 ms)\n  âœ“ should track set of reactive keys in raw map\n  âœ“ should track deletion of reactive keys in raw map (1 ms)\n  âœ“ should warn when both raw and reactive versions of the same object is used as key\n  âœ“ should not trigger key iteration when setting existing keys (4 ms)\n  å°ç»“ è¿™èŠ‚å·¥ä½œä¹ŸåŸºæœ¬å®Œæˆäº†ï¼Œæ‰€æœ‰ collection ç›¸å…³çš„å››ä¸ªæµ‹è¯•ç”¨ä¾‹éƒ½æµ‹è¯•é€šè¿‡ï¼Œè¯´æ˜ä»£ç ç…§æŠ„(ğŸ¤¦â€â™‚ï¸)çš„ç»“æœä¹Ÿæ­£å¸¸ã€‚é‚£ç°åœ¨ä¹Ÿåº”è¯¥åŸºæœ¬äº†è§£å¯¹äºé›†åˆç±»å‹çš„ proxy å¤„ç†ï¼Œvue æ˜¯æ€ä¹ˆä¸ªå®ç°çš„ã€‚\né¦–å…ˆï¼Œproxy æ˜¯æ²¡æœ‰æä¾›å’Œé›†åˆç±»å‹æœ‰å…³çš„åŸå­æ“ä½œä»£ç†çš„ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ new Proxy(map) æ˜¯æ²¡æ³•å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½çš„ï¼ŒåŒæ—¶ä¹Ÿä¼šå‡ºç°æ–¹æ³•åº”ç”¨ä¸å½“çš„æŠ¥é”™(ä¸¢å¤±æ–¹æ³•çš„ä½œç”¨åŸŸäº†ï¼ŒæŠŠ Map.prototype.method çš„æ–¹æ³•åº”ç”¨åˆ°äº† Proxy ç±»å‹)ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œvue é‡Œé¢ collection æœ‰å…³çš„æ“ä½œå…¨éƒ¨éƒ½æ˜¯é€šè¿‡ get proxy ä»£ç†æ¥å®ç°ï¼Œä¸‹é¢æ˜¯å‡ ä¸ªå…³é”®ç‚¹å’Œç–‘é—®ç‚¹ï¼š\n  æ‰€æœ‰æ¥å£å…¨éƒ¨ä½¿ç”¨ get proxy é€šé“è½¬å‘ï¼Œè°ƒç”¨ Reflect.get(instrumentations, key, receiver)\n  åœ¨æ‰€æœ‰çš„å®é™… proxy handleré‡Œé¢(å¦‚ï¼šset, get, delete, \u0026hellip;)ï¼Œè§£å†³ä½œç”¨åŸŸé—®é¢˜ï¼Œå–target ä¸Šçš„åŸå‹æ–¹æ³•\n  å¹¶ä¸”æ‰€æœ‰çš„åŸå‹ä¸Šçš„æ–¹æ³•(å¦‚ï¼šhas, get, set)éƒ½é€šè¿‡ has.call(target) è§£å†³è°ƒç”¨åŸŸçš„é—®é¢˜\n  Key å’Œ rawKey çš„é—®é¢˜(get ä¸­)ï¼Œç›´æ¥çœ‹æµ‹è¯•ä»£ç åˆ†æğŸ¥µ\n1 2 3 4 5 6 7 8 9 10 11 12 13  const key1 = {} const key11 = reactive(key1) const ob = reactive(new Map()) let n1, n2 effect(() =\u0026gt; { n1 = ob.get(key1) n2 = ob.get(key11) }) ob.set(key1, \u0026#39;1\u0026#39;) console.log({ n1, n2 }, ob, \u0026#39;1\u0026#39;) ob.set(key11, \u0026#39;11\u0026#39;) console.log({ n1, n2 }, ob, \u0026#39;2\u0026#39;)   ç»“æœ\nGet æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // key -\u0026gt; \u0026#39;key11\u0026#39; function get(target, key, wrap) { target = toRaw(target) // è¿™é‡Œä¼šå¯¹ key æœ‰ä¸ª toRaw æ“ä½œï¼Œå°±æ˜¯é’ˆå¯¹ key æ˜¯ proxy çš„å¯èƒ½  // æœ€å key11 ä¼ è¿›æ¥å®é™… rawKey = key1ï¼Œå¹¶ä¸”è§¦å‘ track çš„æ—¶å€™  // rawKey æ˜¯å¿…å®šä¼šè§¦å‘çš„ï¼Œè¿™ä¿è¯äº† key é proxy æ—¶çš„èƒ½æ­£å¸¸æ”¶é›†ä¾èµ–  // è€Œ key !== rawKey -\u0026gt; trigger: get-key å°±æ˜¯é’ˆå¯¹ proxy key11 çš„æƒ…å†µä¹Ÿä¼š  // è§¦å‘ track:get æ”¶é›†ä¾èµ–ï¼Œå› ä¸º proxy key11 è‚¯å®šæ˜¯ä¸ä¼šç­‰äº key1 çš„ã€‚  // æ‰€ä»¥ key1, key11 åœ¨ map.get(key1) æˆ– map.get(key11) çš„æ—¶å€™éƒ½èƒ½æ­£å¸¸æ”¶é›†åˆ°ä¾èµ–  const rawKey = toRaw(key) if (key !== rawKey) { track(target, \u0026#39;get\u0026#39;, key) } track(target, \u0026#39;get\u0026#39;, rawKey) // ... }   ç„¶ååœ¨ set çš„æ—¶å€™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function set(key, value) { // ...  // è¿™ä¸€æ®µæ“ä½œå°±æ˜¯ä¸ºäº†ç¡®ä¿ï¼Œkey1 å’Œ proxy key11 éƒ½èƒ½æ­£ç¡®å–åˆ°ä¾èµ–  // æ‰€ä»¥è¯´ get é‡Œé¢çš„ rawKey å’Œ key çš„æ“ä½œå’Œè¿™é‡Œçš„ toRaw æ“ä½œæ˜¯ç›¸å¯¹åº”çš„  // å¦‚æœæ²¡æœ‰ get é‡Œçš„ rawKey-key æ“ä½œï¼Œè¿™é‡Œå¦‚æœä¼ å…¥ proxy key11 å°±ä¸ä¼šæœ‰ä¾èµ–è§¦å‘  // å› ä¸º get é‡Œé¢æ ¹æœ¬ä¸ä¼šè§¦å‘ track:get  // å¦‚æœ set è¿™é‡Œä¸åŠ è¿™ä¸€æ®µå¤„ç†ï¼Œå°±ç®— get-track:get äº†ï¼Œè¿™é‡Œä¹Ÿä¼šæ‰¾ä¸åˆ° proxy key11 å¯¼è‡´  // ä¼šè§¦å‘éæ­£å¸¸çš„ trigger:add æ“ä½œã€‚  let hadKey = has.call(target, key) if (!hadKey) { key = toRaw(key) hadKey = has.call(target, key) } else if (__DEV__) { // TODO  } // ... }     ä¸ºä»€ä¹ˆ key1 å’Œ toReactive(key1) åçš„ key11 å‰å set ä¼šæ”¹å˜ key1 å¯¹åº”çš„å€¼ï¼Ÿï¼Ÿï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const key1 = {} const key2 = {} const ob = reactive(new Map()) ob.set(key1, \u0026#39;1\u0026#39;) // è¿™é‡Œ key1 è¢«è½¬æˆäº† Proxyï¼Œåœ¨ createIterableMethod é‡Œé¢åšçš„ // è¿”å› iterable çš„ next() é‡Œé¢çš„è¡Œä¸ºï¼Œä¼šæŠŠæ‰€æœ‰ value éƒ½å˜æˆ wrap(value) // reactive çš„ï¼Œä¸‹é¢çš„ key11 å…¶å®å°±æ˜¯ key1 ç»è¿‡ reactive ä¹‹åçš„ proxy const key11 = ob.keys().next().value // éªŒè¯ key11 ä¸ key1 å…³ç³»çš„çŒœæµ‹ï¼š // console.log(key11, key1, toRaw(key11) === key1) // code1  // éªŒè¯ key11 ä¸ key1 å…³ç³»çš„çŒœæµ‹ï¼š console.log(toRaw(key11) === key1, ob, \u0026#39;1\u0026#39;) // ç„¶åæˆ‘ä»¬å°† key11 ä½œä¸º key è®¾ç½®ç»™ ob ob.set(key11, \u0026#39;11\u0026#39;) console.log(toRaw(key11) === key1, ob, \u0026#39;11\u0026#39;)   ç›´æ¥çœ‹ç»“æœå›¾ï¼š\næŠŠ code1 æ³¨é‡Šæ‰ï¼ŒåŠ ä¸Šä¸‹é¢çš„ä»£ç ï¼Œçœ‹ä¸‹ç»“æœ:\nä¿®æ­£ï¼šâ€œå‘½åâ€ -\u0026gt; â€œæ˜æ˜â€ã€‚\nä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬é€šè¿‡è®¾ç½® key1 çš„ proxy ç‰ˆæœ¬ key11 å´èƒ½è®© key1 çš„å€¼å‘ç”Ÿå˜åŒ–ã€‚é‚£å¾—åˆ†æåˆ†æè¿™æ˜¯ä¸ºä»€ä¹ˆäº†ï¼Ÿï¼Ÿï¼ŸåŸå› å…¶å®å¾ˆç®€å•ï¼Œè¯·çœ‹ set(key, value) æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // key -\u0026gt; key11, value -\u0026gt; \u0026#39;11\u0026#39; function set(key, value) { // ...  // é¦–å…ˆæ˜¯æ£€æµ‹æœ‰æ²¡æœ‰ key11ï¼Œå’¦ï¼Œå‘ç°æ²¡æœ‰è¯¶ï¼Œ  // é‚£æœ‰æ²¡å¯èƒ½å®ƒæ˜¯ä¸ª proxy ???  let hadKey = has.call(target, key) if (!hadKey) { // å¥½å§ï¼Œé‚£å°±è¿˜åŸä¸‹å§ï¼Œå–å‡º proxy ä¹‹å‰çš„é‚£ä¸ª target  key = toRaw(key) // è¿”ç° key11 ä½ ä¸å°±æ˜¯ key1 è½¬è¿‡æ¥çš„å—ï¼Ÿï¼Ÿï¼Ÿ  // key1 æˆ‘æœ‰å•Š ï¼Œæ‰€ä»¥è¿™é‡Œçš„ hadKey å°±æˆäº† true  // key å°±æˆäº† key1  hadKey = has.call(target, key) } else if (__DEV__) { // TODO  } // å› æ­¤ä¸‹é¢å…¶å®å°±æ˜¯é€šè¿‡ proxy:key11 çš„åŸç‰ˆ key1 å»è§¦å‘ trigger: set \t// ... }   æ›´ç›´è§‚ç‚¹çš„æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10  const key1 = {} const key11 = reactive(key1) const ob = reactive(new Map()) ob.set(key1, \u0026#39;1\u0026#39;) // éªŒè¯ key11 ä¸ key1 å…³ç³»çš„çŒœæµ‹ï¼š console.log(toRaw(key11) === key1, ob, \u0026#39;1\u0026#39;) // ç„¶åæˆ‘ä»¬å°† key11 ä½œä¸º key è®¾ç½®ç»™ ob ob.set(key11, \u0026#39;11\u0026#39;) console.log(toRaw(key11) === key1, ob, \u0026#39;11\u0026#39;)     ref.ts å‰é¢å·²ç»å®Œæˆäº† reactive æ¨¡å—å¤§éƒ¨åˆ†ä¸”æœ€åŸºæœ¬çš„åŠŸèƒ½äº†ï¼Œè¿™èŠ‚å°†å®Œæˆå‰©ä½™ä¸¤å¤§å—computed å’Œ ref å…¶ä¸­çš„ ref.tsï¼Œ\næ¥æ­éœ²å…¶çœŸå®çš„é¢ç›®ã€‚\nRef ç±»å‹å®šä¹‰(unique symbol ç±»å‹å®šä¹‰)ï¼š\n1 2 3 4 5 6 7 8  declare const RefSymbol: unique symbol // Ref ç±»å‹ä¸»è¦æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ª å€¼ä¸º true çš„å”¯ä¸€çš„ç¬¦å·å±æ€§ // ä¸€ä¸ªæ˜¯ value å€¼ export interface Ref\u0026lt;T = any\u0026gt; { [RefSymbol]: true value: T }   å†…å®¹åˆ—è¡¨    å˜é‡/å‡½æ•° æè¿°     convert(val) å°†å¯¹è±¡è½¬æˆ reactive   isRef(r) åˆ¤æ–­æ˜¯ä¸æ˜¯ Ref ç±»å‹ï¼Œä¾æ®æ˜¯ r.__v_isRef æ ‡è¯†çš„å€¼   ref(value) åˆ›å»º Ref ç±»å‹ï¼Œè°ƒç”¨ createRef(value)   shallowRef(value) åˆ›å»º Ref ç±»å‹ï¼Œè°ƒç”¨ createRef(value, true)   createRef(rawValue, shallow) åˆ›å»º Ref ç±»å‹   triggerRef(ref: Ref) trigger Ref çš„ value å€¼å˜æ›´ deps   unref(ref) å–æ¶ˆ Refï¼Œå³è¿”å› ref.value åŸå§‹å€¼   customRef(factory) ç”±åˆ›å»ºè€…å»å®šä¹‰ get, set åº”è¯¥åšå“ªäº›äº‹æƒ…   toRefs(object) å°†å¯¹è±¡çš„æ‰€æœ‰ key çš„å€¼è½¬æˆ Ref   toRef(object, key) è¢« toRefs è°ƒç”¨    å®Œæ•´çš„ ref.js(é™¤äº†ç±»å‹å®šä¹‰ï¼Œä¸åˆ°100è¡Œï¼ŒğŸ‚ğŸ‘ƒ)\næºç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89  import { isObject, hasChanged } from \u0026#39;../util.js\u0026#39; import { reactive, isProxy, toRaw, collectionTypes } from \u0026#39;./reactive.js\u0026#39; import { track, trigger, __DEV__ } from \u0026#39;./effect.js\u0026#39; export const convert = (val) =\u0026gt; (isObject(val) ? reactive(val) : val) export function ref(value) { return createRef(value) } export function shallowRef(value) { return createRef(value, true) } // get track, set trigger export function createRef(rawValue, shallow = false) { if (isRef(rawValue)) { return rawValue } let value = shallow ? rawValue : convert(rawValue) const r = { __v_isRef: true, get value() { track(r, \u0026#39;get\u0026#39;, \u0026#39;value\u0026#39;) return value }, set value(newVal) { if (hasChanged(toRaw(newVal), rawValue)) { rawValue = newVal value = shallow ? newVal : convert(newVal) trigger(r, \u0026#39;set\u0026#39;, \u0026#39;value\u0026#39;, __DEV__ ? { newValue: newVal } : void 0) } } } return r } // æ‰‹åŠ¨è§¦å‘ ref: set export function triggerRef(ref) { trigger(ref, \u0026#39;set\u0026#39;, \u0026#39;value\u0026#39;, __DEV__ ? { newValue: ref.value } : void 0) } export function isRef(r) { return r ? r.__v_isRef === true : false } export function unref(ref) { return isRef(ref) ? ref.value : ref } export function customRef(factory) { const { get, set } = factory( () =\u0026gt; track(r, \u0026#39;get\u0026#39;, \u0026#39;value\u0026#39;), () =\u0026gt; trigger(r, \u0026#39;set\u0026#39;, \u0026#39;value\u0026#39;) ) const r = { __v_isRef: true, get value() { return get() }, set value(v) { set(v) } } } export function toRefs(object) { const ret = {} for (const key in object) { ret[key] = toRef(object, key) } return ret } export function toRef(object, key) { return { __v_isRef: true, get value() { return object[key] }, set value(newVal) { object[key] = newVal } } }   ç»™ä¹‹å‰çš„ä»£ç åŠ ä¸Š ref åŠŸèƒ½ï¼š\n baseHandlers.js  æµ‹è¯• ref(value) 1 2 3 4 5 6 7 8  // å°† 100 å˜æˆ reactive çš„ r -\u0026gt; { __v_isRef: true, get value() {}, set value() {} } const r = ref(100) let dummy effect(() =\u0026gt; { dummy = r.value }) console.log(targetMap.get(r), \u0026#39;deps\u0026#39;)   è¾“å‡ºï¼š\neffect é‡Œé¢ä½¿ç”¨åˆ°äº† r.value è§¦å‘ get value() è®¿é—®å™¨ï¼Œé‡Œé¢ä½¿ç”¨ track(r, 'get', 'value', void 0) æ”¶é›†ä¾èµ–ï¼Œæ‰€ä»¥ä» targetMap.get(r) å¯ä»¥å–åˆ° \u0026lsquo;value\u0026rsquo; =\u0026gt; Set(1) è¿™ä¸ª Depã€‚\næ›´æ–° ref å€¼ï¼š\n1 2 3 4 5 6 7 8 9  const r = ref(100) let dummy effect(() =\u0026gt; { dummy = r.value }) console.log({ dummy }, \u0026#39;1\u0026#39;) r.value = 200 console.log({ dummy }, \u0026#39;2\u0026#39;)   ç»“æœ:\n {dummy: 100} \u0026ldquo;1\u0026rdquo; {dummy: 200} \u0026ldquo;2\u0026rdquo;\n æ‰€ä»¥è¯´ï¼ŒRef çš„å­˜åœ¨å°±æ˜¯è®©æ™®é€šç±»å‹çš„å€¼ä¹Ÿèƒ½ reactiveã€‚\nåº”ç”¨åˆ°å¯¹è±¡ä¸Š\n1 2 3 4 5 6 7 8 9 10  const r = ref({ nested: { num: 0 } }) console.log(r) let dummy effect(() =\u0026gt; { dummy = r.value.nested.num }) console.log({ dummy }, \u0026#39;1\u0026#39;) r.value.nested.num = 100   ç»“æœï¼š\n {__v_isRef: true} Map(1) {\u0026ldquo;value\u0026rdquo; =\u0026gt; Set(1)} {dummy: 0} \u0026ldquo;1\u0026rdquo; {dummy: 100} \u0026ldquo;2\u0026rdquo;\n shallowRef(value) shallowRef å°±æ˜¯é’ˆå¯¹å¯¹è±¡ç±»å‹ä½¿ç”¨ Ref çš„æ—¶å€™æ˜¯å¦éœ€è¦å¯¹å¯¹è±¡é‡Œé¢çš„åµŒå¥—å¯¹è±¡è¿›è¡Œ reactive åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10  const r = shallowRef({ nested: { num: 0 } }) console.log(r) let dummy effect(() =\u0026gt; { dummy = r.value.nested.num }) console.log({ dummy }, \u0026#39;1\u0026#39;) r.value.nested.num = 100   ç»“æœï¼š\nå¯¹è±¡æœ€ç»ˆä¼šè¢«æ•´ä¸ªæˆä¸º valueï¼Œå› ä¸ºæ˜¯ç”¨çš„ shallowRefï¼Œæ‰€ä»¥æ”¹å˜ r.value.nested.num çš„å€¼æ˜¯ä¸ä¼šè§¦å‘ dummy æ›´æ–°çš„ã€‚\nå…¶ä»–ç”¨æ³•ç›´æ¥çœ‹ä¸‹é¢çš„æµ‹è¯•ç”¨ä¾‹è§£æå§ï¼ï¼ï¼\njest ç»“æœ:\n â˜ vue-next-code-read [master] âš¡ jest PASS packages/tests/reactive/reactive.spec.js PASS packages/tests/reactive/ref.spec.js PASS packages/tests/reactive/effect.spec.js PASS packages/tests/reactive/collection/WeakSet.spec.js PASS packages/tests/reactive/collection/Set.spec.js PASS packages/tests/reactive/collection/Map.spec.js PASS packages/tests/reactive/collection/WeakMap.spec.js\nTest Suites: 7 passed, 7 total Tests: 149 passed, 149 total Snapshots: 0 total Time: 5.94 s Ran all test suites. â˜ vue-next-code-read [master] âš¡\n   âœ“ should hold a value (8 ms)\n1 2 3 4 5 6  it(\u0026#39;should hold a value\u0026#39;, () =\u0026gt; { const a = ref(1) // a -\u0026gt; { get value() {}, set value(val) {}, __v_isRef: true }  expect(a.value).toBe(1) // true  a.value = 2 // åœ¨æ„é€  set value(val) { trigger(r, \u0026#39;set\u0026#39;, \u0026#39;value\u0026#39;, void 0) }  expect(a.value).toBe(2) // true })     âœ“ should be reactive (2 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  it(\u0026#39;should be reactive\u0026#39;, () =\u0026gt; { const a = ref(1) // { get value(), set value(), __v_isRef: true }  let dummy let calls = 0 effect(() =\u0026gt; { calls++ // 1  dummy = a.value // 1  }) expect(calls).toBe(1) // trueï¼Œeffectä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡  expect(dummy).toBe(1) // trueï¼ŒåŒä¸Š  a.value = 2 // èµ‹å€¼è§¦å‘ set value -\u0026gt; trigger: set  expect(calls).toBe(2) // å› ä¸ºèµ‹å€¼ trigger: set è§¦å‘ updater  expect(dummy).toBe(2) // same value should not trigger  a.value = 2 // å€¼æ²¡å˜ï¼Œè¢« hasChanged() é˜»æ‹¦ï¼Œä¸ trigger  // if (hasChanged(toRaw(newVal), rawValue)) {  expect(calls).toBe(2) expect(dummy).toBe(2) })     âœ“ should make nested properties reactive (2 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  it(\u0026#39;should make nested properties reactive\u0026#39;, () =\u0026gt; { const a = ref({ count: 1 }) let dummy effect(() =\u0026gt; { // a.value è§¦å‘ä¸€æ¬¡ ref track  // a.value.count è§¦å‘ä¸€æ¬¡æ™®é€šçš„ reactive track  // æ‰€ä»¥è¿™é‡Œä¼šæœ‰ä¸¤æ¬¡ track  dummy = a.value.count }) expect(dummy).toBe(1) // true  a.value.count = 2 // è¿™é‡Œä¾æ—§ä¼šè§¦å‘ä¸¤æ¬¡ get  expect(dummy).toBe(2) // true })   æµ‹è¯•ï¼š  âœ“ should work without initial value (1 ms)\ncreateRef(undefined) å¹¶ä¸å½±å“å®ƒçš„ä½¿ç”¨ï¼Œåªä¼šåˆå§‹å€¼æ˜¯ undefinedã€‚\n  âœ“ should work like a normal property when nested in a reactive object (2 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  it(\u0026#39;should work like a normal property when nested in a reactive object\u0026#39;, () =\u0026gt; { const a = ref(1) // è¿™é‡Œ ref ç±»å‹çš„a è¢«ä½œä¸ºå¯¹è±¡æˆå‘˜ä¼ é€’ç»™ reactive ä¹‹åï¼Œä¼šè¢«è½¬æˆæ­£å¸¸çš„å€¼  // å› ä¸º baseHandlers.js é‡Œé¢çš„ createGetter çš„æ—¶å€™ï¼Œæœ‰æ£€æµ‹ isRef æ˜¯ä¸æ˜¯ Ref ç±»å‹ ?  // å¦‚æœæ˜¯ä¸”éæ•°ç»„çš„è¯ä¼šç›´æ¥è¿”å› res.value ï¼Œå…¶å®å°±æ˜¯è¢«æ™®é€šåŒ–äº†(unref)ä¹‹åå°†ç»“æœè¿”å›  // ä¹Ÿå°±æ˜¯è¯´å®ƒåªå½±å“åœ¨ get çš„æ—¶å€™è¿”å›çš„å€¼ï¼Œå®é™…ä¸Šåœ¨åµŒå¥—çš„å¯¹è±¡é‡Œé¢ a è¿˜æ˜¯ Ref: a ç±»å‹çš„é‚£ä¸ª a  /* if (isRef(res)) { if (targetIsArray) { !isReadonly \u0026amp;\u0026amp; track(target, \u0026#39;get\u0026#39;, key) return res } return res.value } */ // æ‰€æœ‰åé¢å¯ä»¥ç›´æ¥ obj.a++ æ“ä½œ  const obj = reactive({ a, b: { c: a } }) let dummy1 let dummy2 effect(() =\u0026gt; { // è¿™ä¸ªæ—¶å€™çš„ a å’Œ c è™½ç„¶ä¸€å¼€å§‹éƒ½æ˜¯ aï¼Œä½†æ˜¯ç”±äºä¼ é€’ç»™  // reactive ä¹‹åè¢«è¿˜åŸæˆæœ€åŸå§‹çš„å€¼ 1 äº†ï¼Œæ‰€ä»¥è¿™é‡Œ dummy1,2 éƒ½æ˜¯ 1  // è€Œéè¡¨é¢ä¸Šçš„ Ref(1)  dummy1 = obj.a dummy2 = obj.b.c }) const assertDummiesEqualTo = (val) =\u0026gt; [dummy1, dummy2].forEach((dummy) =\u0026gt; expect(dummy).toBe(val)) // æœ‰äº†ä¸Šé¢çš„ç»“è®ºä¸‹é¢ç»“æœå°±å¾ˆæ˜æ˜¾äº†ï¼Œä¹Ÿå¾ˆå¥½ç†è§£äº†  assertDummiesEqualTo(1) // trueï¼Œè¢«è¿˜åŸçš„ Ref(1)  a.value++ // ++ ä¹‹åæ”¹å˜çš„æ˜¯ Ref:aï¼Œå¼•ç”¨ç±»å‹  // ä½†æ˜¯è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯ 2 å‘¢ï¼Ÿï¼Ÿï¼Ÿ  // åŸå› å…¶å®å°±æ˜¯ä¸Šé¢ reactive çš„æ—¶å€™ åªæ˜¯åœ¨ trigger:get çš„æ—¶å€™è¿”å›çš„æ˜¯ ref.value  // å®é™…ä¸Šå¹¶æ²¡æœ‰æ”¹å˜ Ref:a è‡ªèº«ï¼Œåªæ˜¯å½±å“äº† get çš„è¿”å›å€¼è€Œå·²  assertDummiesEqualTo(2) // ä½†æ˜¯è¿™é‡Œ obj.a++ \u0026lt;=\u0026gt; obj.a = obj.a + 1  obj.a++ assertDummiesEqualTo(3) obj.b.c++ assertDummiesEqualTo(4) })   çœ‹ä¸‹æœ€å obj å˜æˆå•¥äº†ï¼Ÿ\næœ€åå¯ä»¥çœ‹åˆ° Ref:a åœ¨ obj é‡Œé¢å°½ç®¡æ‰§è¡Œäº† obj.a++ å’Œ obj.b.c++ ä¾æ—§è¿˜æ˜¯ Ref: aï¼Ÿï¼Ÿï¼Ÿï¼Ÿ\n  âœ“ should unwrap nested ref in types (1 ms)\nåœ¨ createRef ç¬¬ä¸€è¡Œå°±åŠ äº†æ£€æµ‹æ˜¯ä¸æ˜¯ Ref å¦‚æœæ˜¯å°±ç›´æ¥è¿”å›äº†ã€‚\n  âœ“ should unwrap nested values in types (1 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  it(\u0026#39;should unwrap nested values in types\u0026#39;, () =\u0026gt; { const a = { b: ref(0) // è¿™é‡Œè™½ç„¶æ˜¯ Ref  } const c = ref(a) // å‘ç”ŸåµŒå¥—äº†  // ä½†æ˜¯åœ¨è®¿é—®çš„æ—¶å€™ï¼Œè¿˜è®°å¾—ä¹‹å‰é‚£ä¸ªæµ‹è¯•ç”¨ä¾‹ç¢°åˆ°çš„é—®é¢˜å—ï¼Ÿ  // createGetter é‡Œé¢è¿”å› Ref ä¼šç›´æ¥ è¿”å› ref.value  // æ‰€ä»¥è¿™é‡Œè®¿é—® c.value.b å…¶å®ç›¸å½“äº c.value.b.value  // æ‰€ä»¥ + 1 çš„ç»“æœè‚¯å®šæ˜¯ number ç±»å‹  expect(typeof (c.value.b + 1)).toBe(\u0026#39;number\u0026#39;) })     âœ“ should NOT unwrap ref types nested inside arrays\nè¿™ä¸ªç”¨ä¾‹å’Œä¸Šä¸€ä¸ªæ˜¯ä¸€æ ·çš„åŸç†ï¼Œæœ‰ä¸ªä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œtarget æ˜¯æ•°ç»„ï¼ŒcreateGetter ä¸æ˜¯è¿”å› res.value äº†ï¼Œè€Œæ˜¯ç›´æ¥è¿”å› resï¼Œå› ä¸ºæ˜¯æ•°ç»„ç±»å‹ä¸”å–çš„æ˜¯æ•´ä¸ªæ•°ç»„å¯¹è±¡ã€‚\nè€Œåé¢é€šè¿‡ arr[i] å–å€¼å°±å’Œä¸Šä¸€ä¸ªç”¨ä¾‹ä¸€æ ·äº†ï¼Œä¸€æ ·ä¼šæ£€æµ‹åˆ°æ•°ç»„å…ƒç´ å¦‚æœæ˜¯ Ref ç…§æ ·ä¼šè¿”å› res.valueï¼Œæ‰€ä»¥åœ¨æ•°ç»„ä¸­ä½¿ç”¨ Ref(val) åšæ•°ç»„æˆå‘˜ï¼Œç„¶å ref æ•°ç»„æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\n  âœ“ should keep tuple types (6 ms)\nä¸ç®¡ä½ æ˜¯ä»€ä¹ˆç±»å‹å…ƒç´ ï¼Œæ•°ç»„ç±»å‹é¦–å…ˆæ˜¯æ•´ä¸ªæ•°ç»„è®¿é—®ç›´æ¥è¿”å› refï¼Œç„¶åå¦‚æœæ˜¯æ•°ç»„å…ƒç´ ä¼šæ£€æµ‹æ˜¯ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¦‚æœæ˜¯å°± reactive ï¼Œä¸æ˜¯ç›´æ¥è¿”å›ç»“æœã€‚\n  âœ“ should keep symbols (4 ms)\n  âœ“ unref\n  âœ“ shallowRef (2 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  test(\u0026#39;shallowRef\u0026#39;, () =\u0026gt; { const sref = shallowRef({ a: 1 }) // shallowï¼Œé‚£ä¹ˆé‡Œé¢çš„ {a:1} å¯¹è±¡æ˜¯ä¸ä¼šè¢« reactive çš„  expect(isReactive(sref.value)).toBe(false)// æ‰€ä»¥è¿™é‡Œå°±æ˜¯ False  let dummy effect(() =\u0026gt; { // è¿™é‡Œä¾ç„¶ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œä¸”åªä¼šè§¦å‘ä¸€æ¬¡ track:getï¼Œå› ä¸ºæœ‰ sref.value å–å€¼æ“ä½œ  // ä½†æ˜¯ç”±äº {a: 1} å¹¶ä¸æ˜¯ Reactive ï¼Œæ‰€ä»¥å¯¹ a çš„å–å€¼æ˜¯ä¸ä¼šè§¦å‘ track:get çš„  dummy = sref.value.a }) expect(dummy).toBe(1) // true  sref.value = { a: 2 } // è¿™é‡Œé‡æ–°èµ‹å€¼æ•´ä¸ª value  expect(isReactive(sref.value)).toBe(false) // è™½ç„¶æ”¹å˜äº† value ä½†çš„å€¼ä¾æ—§æ˜¯æ™®é€šå¯¹è±¡  expect(dummy).toBe(2) // å› ä¸ºæ”¹å˜äº† valueï¼Œè€Œ sref è¿˜æ˜¯ ref ç±»å‹ï¼Œä¼šè§¦å‘ set value })     âœ“ shallowRef force trigger (1 ms)\næ‰‹åŠ¨è°ƒç”¨ triggerRef è§¦å‘ trigger(r, 'set', 'value', void 0) æ‰§è¡Œä»¥æ¥ deps\n  âœ“ isRef (1 ms)\n  âœ“ toRef (2 ms)\n  âœ“ toRefs (1 ms)\n  âœ“ customRef è‡ªå®šä¹‰ Ref åŠŸèƒ½æœ€ä¸»è¦çš„å°±æ˜¯å°†æ§åˆ¶æƒäº¤ç»™ä½¿ç”¨è€…ï¼Œæ¯”å¦‚ä½•æ—¶ track depï¼Œä½•æ—¶ trigger dep æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  test(\u0026#39;customRef\u0026#39;, () =\u0026gt; { let value = 1 let _trigger const custom = customRef((track, trigger) =\u0026gt; ({ get() { track() // æ ¹æ®å®é™…æƒ…å†µè°ƒç”¨æ¥æ”¶é›†ä¾èµ–  return value }, set(newValue) { value = newValue _trigger = trigger // å¯ç¼“å­˜ trigger ä¸ä¸€å®šè¦ç«‹å³è§¦å‘ deps  } })) expect(isRef(custom)).toBe(true) // customRef ä¾æ—§è¿”å›çš„æ˜¯ Ref  let dummy effect(() =\u0026gt; { dummy = custom.value }) expect(dummy).toBe(1) custom.value = 2 // should not trigger yet  expect(dummy).toBe(1) _trigger() expect(dummy).toBe(2) })     ref ç‰ˆ reactive.js\ncomputed.ts æœ€åä¸€ä¸ªäº†ï¼Œä¸¤å‘¨çš„åšæŒæ€»ç®—å¿«ç»“æŸäº†ã€‚\nè¿™å—çš„å®ç°å°±æ›´ç®€å•äº†ï¼Œå°±ä¸€ä¸ª computed() å‡½æ•°ï¼Œç»“åˆ effect() + ref æ¥å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  export function computed(getterOrOptions) { let getter, setter if (typeof getterOrOptions === \u0026#39;function\u0026#39;) { getter = getterOrOptions setter = __DEV__ ? () =\u0026gt; console.warn(\u0026#39;è®¡ç®—å±æ€§åªè¯»ã€‚\u0026#39;) : noop } else { getter = getterOrOptions.get setter = getterOrOptions.set } let dirty = true // è„ä½æ£€æŸ¥ï¼Œä¸º true è¡¨ç¤ºå€¼æœ‰å˜åŒ–ï¼Œé‡æ–°å–å€¼  let value let computed // runner ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œç›´åˆ°è®¡ç®—å±æ€§å–å€¼åœ¨ get value ä¸­æ‰‹åŠ¨è°ƒç”¨  // æ¥è§¦å‘æ‰€æœ‰æœ‰å…³çš„ä¾èµ–ï¼Œé‡æ–°è®¡ç®—å¾—åˆ°æœ€æ–°çš„å€¼ value  const runner = effect(getter, { lazy: true, computed: true, // ç„¶åè¿™é‡Œæä¾›è°ƒåº¦å™¨ï¼Œä¸ç›´æ¥  scheduler: () =\u0026gt; { if (!dirty) { dirty = true trigger(computed, \u0026#39;set\u0026#39;, \u0026#39;value\u0026#39;) } } }) computed = { __v_isRef: true, effect: runner, get value() { // å–å€¼æ—¶ï¼Œæ£€æµ‹ dirty ï¼Œå¦‚æœè„äº†(æœ‰å˜)ï¼Œå°±é‡æ–° runner å–å€¼ï¼Œè¿è¡Œæ‰€æœ‰ depsï¼Œå¾—åˆ°æœ€æ–°çš„å€¼  if (dirty) { value = runner() dirty = false // é‡æ–°è®¡ç®—åçš„é‡ç½®  } track(computed, \u0026#39;get\u0026#39;, \u0026#39;value\u0026#39;) // æ”¶é›†ä¾èµ–  return value }, set value(newValue) { setter(newValue) } } return computed }   æµ‹è¯•ä¸€ï¼šä¾èµ–æ”¶é›† 1 2 3 4 5 6 7  const value = reactive({}) const cValue = computed(() =\u0026gt; value.foo) cValue.value console.log( cValue.effect.deps[0].values().next().value === cValue.effect, value ) // true ProxyÂ {__v_reactive: Proxy}   å½“ cValue.value æ‰§è¡Œå¯¹ Ref è¿›è¡Œå–å€¼(get value())è§¦å‘ï¼Œæ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  computed = { // ...  effect: runner, get value() { if (dirty) { // æ£€æµ‹åˆ° dirty = true  // æ‰§è¡Œ effect -\u0026gt; æ‰§è¡Œ getter: () =\u0026gt; value.foo  // è®¡ç®—æ–°å€¼ undefined èµ‹å€¼ç»™ value  value = runner() dirty = false } track(computed, \u0026#39;get\u0026#39;, \u0026#39;value\u0026#39;) // è§¦å‘ \t} // ... }   cValue.value é¦–å…ˆè¿™ä¸€å¥ä¼šè§¦å‘ä¸¤ä¸ª track\n {shouldTrack: true, type: \u0026ldquo;get\u0026rdquo;, key: \u0026ldquo;foo\u0026rdquo;, target: {â€¦}, activeEffect: Æ’} {shouldTrack: true, activeEffect: undefined, type: \u0026ldquo;get\u0026rdquo;, key: \u0026ldquo;value\u0026rdquo;, target: {â€¦}}\n  get value() é‡Œé¢æ‰§è¡Œäº† runner() -\u0026gt; value.foo å–äº†ä¸€æ¬¡ foo ï¼Œæ‰€ä»¥ type: get, key: foo get value() é‡Œæ‰‹åŠ¨æ‰§è¡Œäº†ä¸€æ¬¡ track(computed, 'get', 'value')ï¼Œä½†æ˜¯ç”±äº activeEffect æ˜¯ undefined æ‰€ä»¥ä¸ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œ  å› æ­¤ï¼Œè™½ç„¶è°ƒç”¨äº†ä¸¤æ¬¡ track ï¼Œä½†åªæœ‰ value.foo çš„ track ä¼šå»å¾€ä¸‹æ”¶é›† effect:runner è¿™ä¸ªä¾èµ–ã€‚æ‰€ä»¥ï¼š\ncValue.effect.deps[0].values().next().value === cValue.effect // --\u0026gt; true\néšåï¼Œ value.foo = 1 ä¼šè§¦å‘ä¸Šé¢æ”¶é›†åˆ°çš„ä¾èµ–ï¼Œæ‰§è¡Œä¸€æ¬¡ runner() å– value.foo çš„æœ€æ–°å€¼ï¼š 1ã€‚\næ³¨æ„å›¾ä¸­åœˆèµ·æ¥çš„ï¼Œå…¶å®æˆ‘æƒ³çŸ¥é“åœ¨è°ƒç”¨ value.foo = 1 ä¹‹å cValue.value çš„å€¼ä¼šä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼ŒæŒ‰ç…§ä»£ç é€»è¾‘æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œä¹Ÿå°±è¿˜æ˜¯ undefinedã€‚ä½†æ˜¯ç›´æ¥ç‚¹å‡» ... æµè§ˆå™¨ä¼šç›¸å½“äºè§¦å‘ä¸€æ¬¡ getter æ“ä½œï¼Œæœ€åç»“æœä¼šæ˜¯ 1ï¼Œä½†æ˜¯è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œä¸èƒ½è®©å®ƒè§¦å‘ã€‚\né‚£ä¹ˆå°±å¾—æƒ³åŠæ³•åœ¨å®ƒè§¦å‘ä¹‹å‰å°†è€çš„å€¼è¾“å‡ºå‡ºæ¥æ‰è¡Œï¼Œç»“åˆä»£ç åªæœ‰åœ¨ get value() ä¸€å¼€å§‹åŠ ä¸Šæ‰“å°æ‰è¡Œï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  computed = { // ...  get value() { // å› ä¸ºç‚¹å‡»çœç•¥å·ä¼šè§¦å‘ getter ï¼Œä¼šè¿›å…¥åˆ°è¿™é‡Œ  // æ‰€ä»¥åªéœ€è¦æå‰å°†å€¼æ‰“å°å‡ºæ¥å°±çŸ¥é“åœ¨ value.foo è®¾ç½®ä¸‹å»ä¹‹å  // cValue.value å…¶å®æ˜¯æ²¡æœ‰å‘ç”Ÿä»»ä½•æ”¹å˜çš„ï¼Œä¾æ—§è¿˜æ˜¯ undefined  console.log({ value }, \u0026#39;before runner\u0026#39;) if (dirty) { value = runner() dirty = false } track(computed, \u0026#39;get\u0026#39;, \u0026#39;value\u0026#39;) return value }, }   ç„¶åä¿®æ”¹ä¸‹è¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const value = reactive({}) const cValue = computed(() =\u0026gt; value.foo) console.log(cValue.value, \u0026#39;1\u0026#39;) // undefinedï¼Œè§¦å‘ runner() æ‰§è¡Œ () =\u0026gt; value.foo // åœ¨è¿™é‡Œå¹¶ä¸ä¼šç«‹å³è§¦å‘ runner() è°ƒç”¨ () =\u0026gt; value.foo æ›´æ–° cValue.value çš„å€¼ // æ‰€ä»¥åœ¨è¿™é‡Œè®¾ç½®ä¹‹ååˆ°æœ€åçš„ log ä¹‹å‰ cValue.value ä¾æ—§æ˜¯ undefined // ä½†æ˜¯è¿™é‡Œä¼šæœ‰ä¸ªåŠ¨ä½œå’Œ computed æœ‰å…³ï¼Œé‚£å°±æ˜¯è®¡ç®—å±æ€§é‡Œé¢çš„ scheduler() // é‡Œé¢ä¼šæ£€æµ‹ dirty = false(å› ä¸ºä¸Šé¢ get value è¿‡ï¼Œæ‰€ä»¥æ˜¯ false)ï¼Œ // è§¦å‘ trigger(computed, \u0026#39;set\u0026#39;, \u0026#39;value\u0026#39;)ï¼Œè¿™é‡Œä¼šè§¦å‘æ‰€æœ‰å’Œ computed-value æœ‰å…³çš„ä¾èµ– // è¿˜æœ‰ä¸ªé‡è¦çš„å°±æ˜¯å°† dirty = trueï¼Œè¿™æ ·ï¼Œåé¢å½“è®¿é—®è®¡ç®—å±æ€§çš„æ—¶å€™æ‰ä¼šè§¦å‘ runner() æ›´æ–°å€¼ value.foo = 1 // ç„¶åè®¿é—®ä¸€æ¬¡ cValue.value è§¦å‘å…¶ get value() æ£€æµ‹åˆ° dirty æ˜¯ true // ç„¶åè§¦å‘ runner() è°ƒç”¨ () =\u0026gt; value.foo æ›´æ–° value çš„å€¼ // æ‰€ä»¥ä¸‹é¢çš„è¾“å‡ºå€¼å°±æ˜¯ value.foo çš„å€¼ console.log(cValue.value, \u0026#39;2\u0026#39;) // 1   jest   âœ“ should return updated value (5 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  it(\u0026#39;should return updated value\u0026#39;, () =\u0026gt; { const value = reactive({}) // æä¾›çš„æ˜¯å‡½æ•°ï¼Œæ‰€ä»¥åªæœ‰ getterï¼Œä¸”ä¸ä¼šç«‹å³æ‰§è¡Œ(è®¡ç®—å±æ€§æœ‰è®¾ç½®ï¼šlazy: true)  // è¿”å›ä¸€ä¸ª Ref ç±»å‹å€¼  // ä¾èµ–å±æ€§ï¼švalue.foo  const cValue = computed(() =\u0026gt; value.foo) // å–å€¼æ”¶é›† value çš„ä¾èµ–ï¼Œæ­¤æ—¶ dirty = trueï¼Œæ‰§è¡Œ runner() å¾—åˆ° undefined  expect(cValue.value).toBe(undefined) // èµ‹å€¼è§¦å‘ value.foo çš„ trigger: setï¼Œç„¶åæ£€æµ‹åˆ°è¯¥ effect æœ‰æä¾› scheduler  // å› æ­¤è°ƒç”¨ cValue.options.scheduer  // æ­¤æ—¶çš„ dirty = false(get value çš„æ—¶å€™ç½®ä¸º false çš„)ï¼Œ  // è§¦å‘ cValue çš„ trigger: set -\u0026gt; value è°ƒç”¨ set value()  value.foo = 1 expect(cValue.value).toBe(1) })     âœ“ should compute lazily (3 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  it(\u0026#39;should compute lazily\u0026#39;, () =\u0026gt; { const value = reactive({}) const getter = jest.fn(() =\u0026gt; value.foo) const cValue = computed(getter) // lazy  expect(getter).not.toHaveBeenCalled() // è®¡ç®—å±æ€§é»˜è®¤æ˜¯ lazy çš„æ‰€ä»¥ä¸ä¼šç«‹å³æ‰§è¡Œ  expect(cValue.value).toBe(undefined) // get value() -\u0026gt; runner() -\u0026gt; è§¦å‘ä¸€æ¬¡ getter  expect(getter).toHaveBeenCalledTimes(1) // true  // should not compute again  cValue.value // å› ä¸ºä¸Šé¢å–è¿‡ä¸€æ¬¡å€¼äº†æ‰€æœ‰ dirty = false ï¼Œä¸ä¼šé‡å¤ runner()  expect(getter).toHaveBeenCalledTimes(1) // should not compute until needed  // ä¸ä¼šç«‹å³é‡æ–°è®¡ç®—ï¼Œæ­¤æ—¶ cValue.value å€¼ä¾æ—§æ˜¯ undefinedï¼Œä¸Šé¢æœ‰åˆ†æè¿‡äº†  // ç”±äº foo æœ‰æ”¶é›†åˆ° computed.effect è¿™ä¸ªä¾èµ–ï¼Œä¸€æ¬¡èµ‹å€¼çš„æ—¶å€™ä¼šè§¦å‘å®ƒæ‰§è¡Œ  // è€Œ computed.effect.options.scheduler åˆå­˜åœ¨ï¼Œå› æ­¤ä¼šæ‰§è¡Œ scheduler  // é‡Œé¢é‡ç½® dirty = trueï¼Œæ ‡è¯†å€¼ç”±å˜åŒ–  value.foo = 1 // å› ä¸ºä¸ä¼šè§¦å‘ get value() å°±ä¸ä¼š runner()ï¼Œä¹Ÿå°±ä¸ä¼šé‡æ–° getter()  expect(getter).toHaveBeenCalledTimes(1) // now it should compute  // å‘ç”Ÿå–å€¼æ“ä½œï¼Œä¼šè§¦å‘ get value() æ­¤æ—¶ dirty = true(value.foo = 1çš„æ—¶å€™è§¦å‘çš„ scheduler)  // å› æ­¤è¿™é‡Œå–å€¼çš„æ—¶å€™ä¼šå‘ç°å€¼å˜åŒ–äº†ï¼Œæ‰€ä»¥éœ€è¦é‡æ–° runner() å–æ–°å€¼ï¼Œç„¶ååˆç½® dirty = false  expect(cValue.value).toBe(1) // ä¸Šé¢å–å€¼ï¼Œrunn() -\u0026gt; getter()  expect(getter).toHaveBeenCalledTimes(2) // should not compute again  cValue.value // ä¸€æ ·çš„é“ç†ï¼Œdirty = false äº†ï¼Œæ‰€ä»¥ä¸ä¼šé‡æ–° runner()  expect(getter).toHaveBeenCalledTimes(2) })     âœ“ should trigger effect (1 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const value = reactive({}) const cValue = computed(() =\u0026gt; value.foo) let dummy effect(() =\u0026gt; { // è¿™ä¸ªä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œè§¦å‘ get value() æ‰§è¡Œ runner() -\u0026gt; getter()  // ä½†æ˜¯ value.foo æ˜¯æ²¡æœ‰æŒ‡å®š æ‰€ä»¥æ˜¯ undefined  dummy = cValue.value }) expect(dummy).toBe(undefined) // è¿™é‡Œè®¾ç½®ä¸ºä»€ä¹ˆä¼šè§¦å‘ effect(fn) é‡Œé¢çš„ fn å‘¢ï¼Ÿï¼Ÿï¼Ÿ // 1. computed(updater1) æ‰§è¡Œå®Œä¹‹åï¼Œeffect:runner() å¹¶æœªç«‹å³æ‰§è¡Œ // æ‰€ä»¥ shouldTrack = true å’Œ activeEffect = undefined å¹¶æ²¡æœ‰ä»»ä½•æ”¹å˜ // 2. effect(fn) æ‰§è¡Œå®Œä¼šç«‹å³æ‰§è¡Œ fnï¼Œé‡Œé¢è®¿é—®äº† cValue.value è§¦å‘ get value() // æ‰§è¡Œ effect:runner() -\u0026gt; getter(): () =\u0026gt; value.foo æ­¤æ—¶ value.foo å–å€¼è§¦å‘å…¶æ”¶é›†ä¾èµ– // æ­¤æ—¶çš„ activeEffect å…¶å®è¿˜æ˜¯ fnï¼Œå› ä¸º fn æ²¡æœ‰æ‰§è¡Œå®Œå°±ä¸ä¼šé‡ç½®(try...finally) // 3. æ‰€ä»¥ä¸‹é¢æ‰§è¡Œ value.foo = 1 çš„æ—¶å€™æ˜¯ä¼šè§¦å‘ fn æ‰§è¡Œçš„ï¼Œå› ä¸ºåœ¨ 2 ä¸­å·²ç»å°†å®ƒæ”¶é›†åˆ°äº† // 4. æ‰§è¡Œ fn å¯¼è‡´ cValue.value å–å€¼ï¼Œè§¦å‘ get value() æ‰§è¡Œ runner() -\u0026gt; getter() å–æœ€æ–°çš„ // å€¼ 1ï¼Œå› æ­¤ dummy çš„å€¼å°±æ˜¯ 1 äº†ã€‚ value.foo = 1 expect(dummy).toBe(1)   æ‰€ä»¥ä¸Šè¿™ä¸ªç”¨ä¾‹çš„å…³é”®ç‚¹åœ¨äº**ç†è§£Â value.fooÂ æ˜¯å¦‚ä½•æ”¶é›†åˆ°Â effect(fn)Â é‡Œé¢çš„fn**ï¼Œå› ä¸º fn é‡Œé¢å¹¶æ²¡æœ‰ç›´æ¥è®¿é—® value.foo ï¼Œè€Œæ˜¯è®¿é—®çš„ cValue.valueã€‚\n  âœ“ should work when chained (1 ms)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  it(\u0026#39;should work when chained\u0026#39;, () =\u0026gt; { const value = reactive({ foo: 0 }) const c1 = computed(() =\u0026gt; value.foo) const c2 = computed(() =\u0026gt; c1.value + 1) // 1. c2:runner() -\u0026gt; c2:getter() -\u0026gt; c1.value -\u0026gt; c1:runner() -\u0026gt; c1.getter() -\u0026gt; 0 + 1 = 1  // ä¸”æ­¤æ—¶ value.foo æ”¶é›†åˆ°äº† c1.effect  // ä¸” c1.value åœ¨è§¦å‘ get value() æ—¶å€™æ”¶é›†åˆ°äº† c2.effect  expect(c2.value).toBe(1) // 2. å› ä¸ºä¸Šé¢è§¦å‘äº† c1:runner() æ‰€ä»¥ c1.value = 0  expect(c1.value).toBe(0) // 3. å› ä¸ºåœ¨ step1 value.foo æ”¶é›†åˆ°äº† c1:effectï¼Œæ‰€ä»¥è¿™é‡Œæ”¹å˜ value.foo  // ä¼šè§¦å‘ c1:effectï¼Œæ‰§è¡Œ runner()ï¼Œå°† c1:dirty ç½®ä¸º true  value.foo++ // 4. c2.value -\u0026gt; c2: get value() -\u0026gt; c2 runner() -\u0026gt; c1.value: get value()  // -\u0026gt; c1 runner() -\u0026gt; value.foo = 1 + 1 = 2  expect(c2.value).toBe(2) // 5. c1.value æ­¤æ—¶å°±ç®—ä¸è®¿é—® c1.value è§¦å‘ get value() è¿™é‡Œ c1.value ä¹Ÿæ˜¯ 1  expect(c1.value).toBe(1) })   ä¸ºäº†æ–¹ä¾¿åŒºåˆ†ï¼Œè¿™é‡Œç»™ computed(getterOrOptions, id) åŠ ä¸ª id å‚æ•°ï¼Œæ–¹ä¾¿è·Ÿè¸ªå½“å‰æ˜¯æŒ‰ä¸ª computed .\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  // ä»ç»“æœç›´æ¥åˆ†æåŸå› ï¼Œå°†ä¸‹é¢çš„è¾“å‡ºè¡Œç”¨ Pn æ ‡è®° const value = reactive({ foo: 0 }) const c1 = computed(() =\u0026gt; value.foo, \u0026#39;c1\u0026#39;) const c2 = computed(() =\u0026gt; c1.value + 1, \u0026#39;c2\u0026#39;) // é¦–å…ˆä¸Šé¢ä¸‰è¡Œä¸ä¼šè§¦å‘ä»»ä½•è¾“å‡º // 1. log1 ä¼šè§¦å‘ P1,P2,P3ï¼ŒåŸå› ï¼š // c2.value -\u0026gt; c2:get value()è¾“å‡ºP1, dirty = true -\u0026gt; // runner() + track + dirty = false -\u0026gt; // æ‰§è¡Œ c2:getter(), c1.value + 1 -\u0026gt; è®¿é—® c1.value // c1.value -\u0026gt; c1:get value()è¾“å‡ºP2, dirty = true -\u0026gt; // runner() + track + dirty = false -\u0026gt; // æ‰§è¡Œ c1:getter(), c1.value = value.foo = 0 // ç„¶åå¾€å›æ¨ï¼š c1.value -\u0026gt; c1.value + 1 = 1 -\u0026gt; c2.value -\u0026gt; è¾“å‡º P3ï¼Œc2.value å€¼ä¸º 1 // 2. ç¬¬ä¸€æ­¥ç»“æŸä¹‹åçš„çŠ¶æ€ï¼š // value.foo, deps[c1.effect]ï¼Œvalue.foo = 1 // å› ä¸ºéƒ½è§¦å‘äº† get value() æ‰€ä»¥å„è‡ªæ”¶é›†åˆ°äº†è‡ªèº«çš„ effect // c1, deps[c1.effect], c1.value = 0, dirty = falseï¼Œç­‰å¾… scheduler è°ƒç”¨ç½®ä¸º true // c2, deps[c2.effect], c2.value = 1, dirty = falseï¼Œç­‰å¾… scheduler è°ƒç”¨ç½®ä¸º true console.log(c2.value, \u0026#39;c2.value 1\u0026#39;) // log1, 1 // 3. log2 ä¼šè§¦å‘ P4, P5ï¼ŒåŸå› ï¼š // åªæ˜¯ c1.value å–å€¼ï¼Œä¼šè§¦å‘ get value()ï¼Œå› æ­¤æœ‰äº† P4 è¾“å‡º // ä½†å› ä¸ºæ­¤æ—¶çš„ dirty = false ä¸ä¼šé‡å¤æ‰§è¡Œ runner()ï¼Œæ‰€ä»¥å€¼ä¾æ—§æ˜¯ 0ï¼Œæœ€åè¾“å‡º P5 console.log(c1.value, \u0026#39;c1.value 1\u0026#39;) // log2, 0  // å¢åŠ ä¸‹é¢ä¸‰ä¸ªè¾“å‡ºï¼Œè®©ä¾èµ–æ”¶é›†ç»“æœæ›´æ¸…æ™° const dep = targetMap.get(toRaw(value)) // è¿™é‡Œæ”¶é›†åˆ°çš„æ˜¯ c1.effectï¼Œå› ä¸º c1.value -\u0026gt;get value() æ‰§è¡Œäº† runner() è§¦å‘ // value.foo å°† c1.effect æ”¶è¿› deps console.log(dep, dep.get(\u0026#39;foo\u0026#39;).values().next().value === c1.effect) // , true console.log( c1.effect.deps, c1.effect.deps[0].values().next().value === c1.effect, // true  \u0026#39;c1 deps\u0026#39; ) console.log( c2.effect.deps, c2.effect.deps[0].values().next().value === c2.effect, // true  \u0026#39;c2 deps\u0026#39; ) // è¿™é‡Œ++ï¼Œä¼šè§¦å‘ c1.effectï¼Œå› ä¸º c1:dirty = falseï¼Œæ‰€ä»¥è°ƒç”¨ c1.options.schedulerï¼Œ // c1.dirty = trueï¼Œtrigger-c1:set-value // è®°ä½ä¸€ç‚¹ï¼šcomputed å±æ€§æ²¡æœ‰å–å€¼å°±ä¸ä¼šè§¦å‘ runner()ï¼Œæ‰€ä»¥è¿™å¥æ‰§è¡Œä¹‹å // c1.value ä¾æ—§æ˜¯ 0ï¼Œc2.value ä¾æ—§æ˜¯ 1 // é€šè¿‡ä¹‹å‰çš„æ–¹å¼å¯æµ‹è¯•å‡ºç»“æœï¼Œå¦‚ä¸‹å›¾ä¸­ç»“æœ value.foo++ // 4. log3 ä¼šè¾“å‡º P9, P10, P11 // c2.value å–å€¼ï¼Œè§¦å‘ c2:runner() é‡æ–°è®¡ç®—å€¼ï¼Œc1.value + 1ï¼Œè§¦å‘ // c1.value å–å€¼ï¼Œè§¦å‘ c1:runner() é‡æ–°è®¡ç®—å€¼ï¼Œå¾—åˆ° c1.value = value.foo(++ä¹‹åçš„å€¼ä¸º1) = 1 // ç„¶åï¼šc2.value = c1.value + 1 = 1 + 1 = 2 // æ‰€ä»¥è¿™é‡Œä¼šè¾“å‡º2ï¼Œè¯·çœ‹ä¸‹é¢çš„ï¼ŒP9,P10,P11ï¼Œå…¶å®è¿™å¥ä¹‹å c1.value å·²ç»æ˜¯ 1äº† // å› ä¸ºè¿™é‡Œè§¦å‘äº† c1.value å–å€¼ console.log(c2.value, \u0026#39;c2.value 2\u0026#39;) // log3, 2 // 5. log4ä¼šè¾“å‡º P12,P13ï¼Œå…¶å®è¿™é‡Œæ— è®ºç”¨ä¸ç”¨ c1.value å®ƒçš„å€¼éƒ½å·²ç»æ˜¯ 1 äº† // æ‰€ä»¥è¿™é‡Œçº¯ç²¹åªæ˜¯å–å€¼ï¼Œä¸ä¼šé‡å¤ runner()ï¼Œå› ä¸º step 4-log3 è§¦å‘è¿‡ get value() diry = false // äº†ã€‚ console.log(c1.value, \u0026#39;c1.value 2\u0026#39;) // log4, 1   è¾“å‡ºï¼š\n P1: {id: \u0026ldquo;c2\u0026rdquo;, value: undefined} \u0026ldquo;before runner\u0026rdquo; P2: {id: \u0026ldquo;c1\u0026rdquo;, value: undefined} \u0026ldquo;before runner\u0026rdquo; P3: 1 \u0026ldquo;c2.value 1\u0026rdquo; P4: {id: \u0026ldquo;c1\u0026rdquo;, value: 0} \u0026ldquo;before runner\u0026rdquo; P5: 0 \u0026ldquo;c1.value 1\u0026rdquo;\nP6: Map(1) {\u0026ldquo;foo\u0026rdquo; =\u0026gt; Set(1)} true P7: [Set(1)] true \u0026ldquo;c1 deps\u0026rdquo; P8: [Set(1)] true \u0026ldquo;c2 deps\u0026rdquo;\n// æ–°å¢ Log3 ä¹‹åçš„è¾“å‡º\nP9: {id: \u0026ldquo;c2\u0026rdquo;, value: 1} \u0026ldquo;before runner\u0026rdquo; P10: {id: \u0026ldquo;c1\u0026rdquo;, value: 0} \u0026ldquo;before runner\u0026rdquo; P11: 2 \u0026ldquo;c2.value 2\u0026rdquo;\n// æ–°å¢ log4 ä¹‹åçš„è¾“å‡º\nP12: {id: \u0026ldquo;c1\u0026rdquo;, value: 1} \u0026ldquo;before runner\u0026rdquo; P13: 1 \u0026ldquo;c1.value 2\u0026rdquo;\n ç‚¹å‡»çœç•¥å·è¾“å‡ºï¼š\n  âœ“ should trigger effect when chained (3 ms)\nè¯·çœ‹ä¸Šä¸€ä¸ªç”¨ä¾‹çš„åˆ†æ\u0026mdash;-\u0026raquo;\n  âœ“ should trigger effect when chained (mixed invocations) (3 ms)\nè¯·çœ‹ä¸Šä¸Šä¸€ä¸ªç”¨ä¾‹çš„åˆ†æ\u0026mdash;-\u0026raquo;\n  âœ“ should no longer update when stopped (2 ms)\nåŒä¸Šã€‚ä½†æ˜¯æœ‰ä¸€ç‚¹éœ€è¦çŸ¥é“ï¼Œstop() ä¸»è¦å¹²ä¸¤ä»¶äº‹ï¼š\n cleanup(effect) -\u0026gt; deps = [] æ¸…ç©ºä¾èµ– effect.active = false  é‚£ä¹ˆé—®é¢˜å°±å¾ˆæ¸…æ™°äº†ï¼Œstop ä¹‹å active ä¸º falseï¼Œåœ¨æ‰§è¡Œ effect() çš„æ—¶å€™ä¸€å¼€å§‹å°±æ˜¯æ£€æµ‹æ˜¯ä¸æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ä¼šè¿”å› undefined(æœ‰ scheduleræ¸…ç©º)æˆ–è€… fn(\u0026hellip;args) æ‰§è¡Œç»“æœã€‚ä¸ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œ try\u0026hellip;finallyã€‚\n1 2 3  if (!_effect.active) { return options.scheduler ? undefined : fn(...args) }   æ‰€ä»¥è¯´è¿™é‡Œ stop ä¹‹åå†èµ‹å€¼ï¼Œè°ƒç”¨ effect.scheduler() ç›¸å½“äºä»€ä¹ˆéƒ½æ²¡å¹²ã€‚\n  âœ“ should support setter (2 ms)\n  âœ“ should trigger effect w/ setter\nplusOne.value = 0ä¼šè§¦å‘ setter è°ƒç”¨ options.set:n.value = val - 1`ã€‚\né‚£ä¹ˆ n.value å˜äº† å°±ä¼šè§¦å‘ effect(fn) é‡Œé¢çš„ dep:fn æ›´æ–° dummy å€¼ã€‚\n  âœ“ should warn if trying to set a readonly computed\n  æ€»ç»“ OverğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥.\nç»ˆäºç»“æŸäº†ï¼Œç»è¿‡ä¸¤å‘¨çš„åšæŒï¼Œç»ˆäºå°† vue3.0 reactivity æ¨¡å—æºç â€œæŠ„å®Œâ€äº†ã€‚\næ­¤æ—¶æ­¤åˆ»ï¼Œè²Œä¼¼æ²¡ä»€ä¹ˆè¯è¦å†™çš„äº†\u0026hellip;\u0026hellip;ï¼Œå”¯æœ‰\nè·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ï¼ï¼ï¼\nä¸¤å‘¨ä»¥æ¥ï¼Œæ¯å¤©è„‘å­ç©ºé—²äº†é‡Œé¢éƒ½æ˜¯ vue3.0 reactivity ä»£ç ï¼Œç”šè‡³ç¡è§‰éƒ½åœ¨åšæ¢¦æ•²è¿™å—çš„ä»£ç ï¼Œåšæ¢¦éƒ½åœ¨æ€è€ƒæ‰€ç»å†çš„ä»£ç æµç¨‹å’Œç»†èŠ‚ã€‚\næ€»çš„ä¸‹æ¥ï¼Œåªæœ‰æ„Ÿå¹è‡ªå·±èƒ½åŠ›ä¸è¶³ï¼Œè¶Šå­¦ä¹ è¶Šè§‰å¾—è‡ªå·±åƒåœ¾ï¼ï¼ï¼\nè·¯è¿˜å¾ˆé•¿ï¼Œä¸èƒ½æ”¾å¼ƒï¼Œå›æ¥è¿™å‡ å¹´æ€»æ„Ÿè§‰å¿ƒæœ‰åŠ›è€Œä½™ä¸è¶³ï¼Œæ›´æ˜¯æ„Ÿå¹å¤§å­¦æ²¡å¥½å¥½å­¦å¥½åŸºç¡€ï¼Œæ›´ä½“ä¼šåˆ°ä¹¦åˆ°ç”¨æ—¶æ–¹æ¨å°‘æ–¹æ¨å°‘ï¼Œ(âŠ™oâŠ™)â€¦ï¼Œæœ‰ç‚¹æ‰¯è¿œäº†ï¼ï¼ï¼\n è¿˜æ˜¯è€è€å®å®çš„æ¥å¤ç›˜â‘§ ï¼ˆå¼€å§‹ -\u0026gt; ğŸ”šï¼‰ï¼š\n**ç¬¬ä¸€é˜¶æ®µï¼šreactive() ** reactive(target) -\u0026gt; createObjectReactive(target, isReadonly, baseHandlers, collectionHandlers)\nåˆ›å»º reactive å¯¹è±¡ï¼Œä¹‹å‰çš„ toProxy, toRaw æ”¹æˆäº† ReactiveFlags æ ‡è®°æ–¹å¼å­˜å‚¨åˆ° target å’Œ observed å¯¹è±¡ä¸Šäº†ï¼Œè€Œä¸æ˜¯å•ç‹¬çš„å£°æ˜ä¸¤ä¸ªæ¨¡å—éå†æ¥ä¸“é—¨å­˜å‚¨ target -\u0026gt; observed å’Œ observed -\u0026gt; target çš„å…³ç³»ã€‚\nbaseHandlers: åŸºæœ¬å¯¹è±¡ç±»å‹çš„ proxy handlerï¼ŒåŸç”Ÿçš„ Reflect åŸºæœ¬éƒ½æä¾›äº†å¯¹åº”çš„èƒ½åŠ›ã€‚\ncollectionHandlersï¼šé›†åˆç±»å‹(Map, Set, WeakMap, WeakSet) å¯¹è±¡çš„ proxy handlersï¼Œç”±äºåŸç”Ÿ Reflect å¹¶æ²¡æœ‰æ”¯æŒå®ƒä»¬çš„åŸå­æ“ä½œï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡å¯¹è±¡çš„ proxy get ï¼Œæ¥è·å–æ‰€è°ƒç”¨çš„æ–¹æ³•åå»å¯¹åº”çš„ instrumentations é‡Œé¢æŸ¥æ‰¾ä¸ä¹‹ç›¸å…³çš„ handler æ¥æ¨¡æ‹Ÿé›†åˆç±»å‹çš„æ‰€æœ‰æ“ä½œã€‚\nå¯è¿›è¡Œ reactive çš„çš„æ¡ä»¶\n _isVue: false è¡¨ç¤º Vue å®ä¾‹ç±»å‹ _VNode: false è™šæ‹ŸèŠ‚ç‚¹ç±»å‹ !rawValues ä¸­çš„ç±»å‹æˆ–å€¼ å¯ observable ç±»å‹(é™¤Map, Set, WeakMap, WeakSet, Object, Arrayæ„å¤–çš„ç±»å‹) é Object.isFrozen ç±»å‹  ç»è¿‡æ›´æ–°ä¹‹åå‰é¢ä¸‰ç§éƒ½åˆå¹¶åˆ°äº† ReactiveFlags.__v_skip é‡Œé¢äº†(ç»“åˆ markRaw(value) å°†ä¸èƒ½è¢«è§‚å¯Ÿçš„å€¼ç½®ä¸º __v_skip: true)ã€‚\næœ€åå˜æˆäº†ä¸‰ç§æ£€æµ‹ï¼š\n __v_skip = false observable ç±»å‹ é frozen å¯¹è±¡  å–æ¶ˆ toProxy, toRaw ä¹‹åä½¿ç”¨ target.__v_readonly å’Œ target.__v_reactive æ¥ä¿å­˜ observed, target.__v_raw æ¥ä¿å­˜ proxy ä¹‹å‰çš„å¯¹è±¡ã€‚\næ‰€ä»¥ä¸€æ—¦æ£€æµ‹åˆ° __v_readonly å’Œ __v_reactive å€¼å­˜åœ¨å°±ç›´æ¥è¿”å›è¿™ä¸ªç¼“å­˜çš„ proxyã€‚\nç¬¬äºŒé˜¶æ®µï¼šbaseHandlers createGetter -\u0026gt; åˆ›å»º proxy getï¼š\nè¿”å›çš„æ—¶å€™æ£€æµ‹ isReadonly å†³å®šä½¿ç”¨ readonly() è¿˜æ˜¯ reactive() åšæ·±å±‚çš„ reactiveã€‚\nå¦‚æœæŒ‡å®šäº† shallow = true å‚æ•°ï¼Œé‚£ä¹ˆåªä¼šé’ˆå¯¹å¯¹è±¡çš„ç¬¬ä¸€å±‚åš reactiveã€‚\nå¦‚æœæ˜¯æ•°ç»„çš„ä¸‰ä¸ªç´¢å¼•æ“ä½œï¼Œç›´æ¥è¿›å…¥ arrayInstrumentations å¤„ç†ï¼Œè°ƒç”¨å°è£…ä¹‹åçš„ includes, indexOf, lastIndexOfã€‚\nå¦‚æœæ˜¯ Ref ç±»å‹ç›´æ¥è¿”å› res.valueï¼Œå¦‚æœåˆæ˜¯æ•°ç»„ï¼Œæ‰‹åŠ¨ track ä¸€æ¬¡æ•°ç»„å…ƒç´ çš„ \u0026lsquo;get\u0026rsquo; æ“ä½œï¼Œç›´æ¥è¿”å›è¯¥æ•°ç»„ resã€‚\ncreateSetter -\u0026gt; åˆ›å»º proxy setï¼š\nå¦‚æœæ˜¯ Ref ç±»å‹è¦å°†å€¼è®¾ç½®åˆ° oldValue.value ä¸Šï¼Œè€Œä¸æ˜¯ç›´æ¥å°†å€¼é€šè¿‡ Reflect.set() è®¾ç½®ä¸‹å»ã€‚\nç„¶åæ ¹æ® oldValue å’Œ newValue è¿›è¡Œæ¯”è¾ƒï¼Œæ’é™¤ NaN çš„å¯èƒ½ä¹‹åï¼Œå¦‚æœæœ‰å‘ç”Ÿå˜åŒ–å°±è°ƒç”¨ triggerï¼Œå¦‚æœ target ä¸Šæ²¡æœ‰çš„ key å°±æ˜¯ trigger: addï¼Œå¦åˆ™ trigger:setã€‚\ndeleteProperty -\u0026gt; åˆ›å»º proxy deleteï¼š\ntrigger deleteã€‚\nhas -\u0026gt; åˆ›å»º proxy hasï¼š\ntrack has æ”¶é›†ä¾èµ–ã€‚\nownKeys -\u0026gt; åˆ›å»º proxy ownKeys ï¼š\ntrack ITERATE_KEY è¿­ä»£å™¨æ”¶é›†ä¾èµ–ã€‚\nç¬¬ä¸‰é˜¶æ®µï¼šeffect() æ„å»º Dep effect(fn, options) æ˜¯å°† fn æ„é€ æˆ Dep ç±»å‹ï¼Œæ‰€ä»¥ï¼Œå…¶å®Vueé‡Œé¢æ‰€æœ‰çš„ä¾èµ–éƒ½æ˜¯ä¸€ä¸ª effect å‡½æ•°ï¼Œå‡½æ•°ä¸ŠæŒ‚äº†è‹¥å¹²ä¸ªå±æ€§(_isEffect, active, id, deps, options, raw)ã€‚\nè¿™é‡Œçš„é‡ç‚¹åœ¨äº reactiveEffect å‡½æ•°çš„å®ç°é‡Œé¢æœ‰ä¸ª try\u0026hellip;finally å®ƒç»“åˆ shouldTrack å’Œ activeEffect ä¿è¯äº†åœ¨ Dep é‡Œé¢æ‰§è¡Œ value.n++ ä¸ä¼šå‡ºç°æ­»å¾ªç¯ï¼Œå› ä¸º trigger é‡Œé¢çš„ add æ“ä½œä¼šæ£€æµ‹è¿™ä¸¤ä¸ªå€¼ï¼Œå¦‚æœ activeEffect !== effect(å½“å‰çš„è¿™ä¸ª Dep) æˆ–è€… shouldTrack = false æ‰ä¼šæ”¶é›†è¦æ‰§è¡Œçš„ä¾èµ–ã€‚\n1 2 3 4 5 6 7 8  try { // enable effect  return fn(...) // è¿™ä¸ªå°±æ˜¯ effect(() =\u0026gt; {}) ä¼ å…¥çš„å‡½æ•° } catch { // ç»“æŸå½“å‰ effect æ„å»º \t// shouldTrack = false \t// activeEffect = undefined }   ç¬¬å››é˜¶æ®µï¼šcollectionHandlers è¿™é‡Œå°±æœ‰æ„æ€äº†\u0026hellip;\u0026hellip;\nå› ä¸ºæ²¡æœ‰é›†åˆç±»å‹çš„ç›´æ¥ proxy å¯¹åº”çš„ Reflectï¼Œå› æ­¤åªèƒ½é‡‡å–å¦ç±»çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nä¸ç®¡ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œobj.fn éƒ½å±äºå±æ€§å€¼çš„è®¿é—®ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä½¿ç”¨ obj.fn() çš„æ—¶å€™ï¼Œæ— è®ºå¦‚ä½•éƒ½ä¼šå‡ºå‘ obj å¯¹ fn å±æ€§çš„ get æ“ä½œã€‚\næ‰€ä»¥å¯¹äº collectionHandlers é‡Œé¢å°±åªæœ‰ä¸€ä¸ª getã€‚\nç„¶åé€šè¿‡ obj.fn -\u0026gt; å‡ºå‘ get, key ä¸º fn -\u0026gt; Reflect.get(instrumentations, 'fn', ...)ï¼Œç„¶åé€šè¿‡ fn å³å‡½æ•°åç§°å» instrumentations é‡Œé¢æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°(æ¯”å¦‚ï¼šset, get, add, has, ç­‰ç­‰\u0026hellip;)ã€‚\næœ€åæ ¹æ®è°ƒç”¨ obj.fn(...args) æ—¶ä¼ é€’çš„å‚æ•°è½¬æ¥åˆ° instrumentations é‡Œé¢å¯¹åº”çš„å‡½æ•°å‚æ•°ä¸Šã€‚\nè¿™éƒ¨åˆ†çš„é‡ç‚¹åœ¨äº instrumentations é‡Œé¢å‡½æ•°çš„è°ƒç”¨æ—¶ä½œç”¨åŸŸé—®é¢˜çš„è§£å†³ï¼š\n ä» target.prototype åŸå‹ä¸Šå–å‡ºå¯¹åº”çš„æ–¹æ³•(å¦‚ï¼šhas, get, set, add) ç„¶åé€šè¿‡ has.call(target) ç„¶åå°†è°ƒç”¨åŸŸæŒ‡å›ç»™ target(Map, Set\u0026hellip;)  ä¸ç„¶ä¼šå‡ºç° Map.prototype.has åœ¨ Proxy ç±»å‹ä¸Šè°ƒç”¨è€Œæ‰¾ä¸åˆ°å‡½æ•°çš„é—®é¢˜ã€‚\nå¦ä¸€ä¸ªéœ€è¦å…³æ³¨çš„æ˜¯ key, rawKey çš„é—®é¢˜ï¼Œè¿™é‡Œçš„æ„ä¹‰åœ¨äºï¼š\nâ€‹\tå¦‚æœ key-\u0026gt; proxyKey ï¼Œå¦‚æœåŒæ—¶ç”¨ key å’Œ proxyKey å– get å€¼çš„æ—¶å€™ä¼šå‘ç°æœ€ç»ˆ proxyKey ä¼šè¢«è½¬æˆ keyå†å–å€¼ã€‚è¿™é‡Œåº”è¯¥æ˜¯ä¸ºäº†é¿å… proxyKey å’Œ key ä¼šåŒæ—¶è¢«æ·»åŠ å¦‚ Map æˆ– Set é—®é¢˜ã€‚\nç¬¬å››é˜¶æ®µï¼šRef Ref ç±»å‹ï¼Œä¸»è¦æä¾›äº†å°†åŸå§‹ç±»å‹å€¼è½¬æˆ reactive çš„èƒ½åŠ›ã€‚\nå®ƒé€šè¿‡å°†å€¼å°è£…æˆ ï¼š {__v_isRef: true, get value(){}, set value() {} } å¯¹è±¡æ¥å®Œæˆ reactive åŠŸèƒ½ã€‚\nè¿™é‡Œé‡ç‚¹æ˜¯å‡ ä¸ªå‡½æ•°ï¼š\n ref(value) å°†å€¼è½¬æˆ Ref ç±»å‹ createRef(value, shallow) è¢« ref æˆ– shallowRef è°ƒç”¨æ¥åˆ›å»º Ref triggerRef(ref) è§¦å‘ Ref ä¸Šçš„ deps customRef(factory) æä¾›å¤–éƒ¨è‡ªå®šä¹‰ Ref èƒ½åŠ› toRef(object) å°†å¯¹è±¡è½¬æˆ Ref ç±»å‹  Ref ç±»å‹å…³é”®ï¼š\n get value() -\u0026gt; track æ”¶é›†ä¾èµ– set value(val) -\u0026gt; trigger ä¾èµ–  ç¬¬äº”é˜¶æ®µï¼šcomputed(getterOrOptions) computed å®ç°åŸç†ï¼š\n Ref ç±»å‹ dirty è„æ£€æŸ¥ä½  æ‰€ä»¥è®¡ç®—å±æ€§å°±æ˜¯ä¸ª Ref ç±»å‹ç»“æœå¯¹è±¡ï¼ŒåŒ…å«(__v_isRef, get value(), set value())ï¼Œæœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼\n getterOrOptions æ˜¯å‡½æ•°é‚£ä¹ˆå°±åªä¼šæœ‰ getter getterOrOptions æ˜¯å¯¹è±¡å¯ä»¥æä¾›è‡ªå®šä¹‰çš„ setter å’Œ getter  æ¯ä¸ª computed éƒ½æœ‰ä¸€ä¸ªåä¸º runner çš„ effectï¼Œç”¨æ¥å¤„ç†è®¡ç®—å±æ€§æ‰€ä¾èµ–çš„å€¼çš„å˜æ›´æ‰€éœ€è¦ä½œå‡ºçš„è¡Œä¸ºã€‚\nä¸€ä¸ªè®¡ç®—å±æ€§ä½¿ç”¨æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š\n  å–å€¼è§¦å‘ get value()\n  æ£€æŸ¥ dirtyï¼Œå¦‚æœä¸º trueï¼Œè¡¨ç¤ºå€¼ç”±è¾¹åˆ™è°ƒç”¨ runner() é‡æ–°è®¡ç®—æ–°å€¼\n  å¦‚æœä¾èµ–çš„å€¼å‘ç”Ÿå˜æ›´ï¼Œä¹Ÿä¼šè§¦å‘ runner()\nå› ä¸º runner æ˜¯ä¸ª effectï¼Œåœ¨ fn é‡Œé¢ä½¿ç”¨å…¶ä»–å€¼(æ¯”å¦‚ï¼šobj.foo)ä¼šè§¦å‘è¿™äº›å€¼æ¥æ”¶é›†è¿™ä¸ª effect:runner æ‰€ä»¥è¿™äº›å€¼æ”¹å˜ä¼šè§¦å‘ runnerã€‚\n  å³ obj.foo++ æ”¹å˜ï¼Œè°ƒç”¨ trigger:setï¼Œtriggerçš„æ—¶å€™æ£€æµ‹åˆ° runner æœ‰schudler æ‰€æœ‰è°ƒç”¨å®ƒ\næ­¤æ—¶ runner: dirty å¦‚æœæ˜¯ false æƒ…å†µä¸‹å°±ä¼šè§¦å‘ trigger(computed, \u0026lsquo;set\u0026rsquo;, \u0026lsquo;value\u0026rsquo;)ï¼Œé‡ç‚¹æ˜¯ä¼šå°†è„ä½æ ‡è¯†ç½®ä¸º dirty = trueï¼Œé‚£ä¹ˆä¸‹æ¬¡å–å€¼çš„æ—¶å€™å°±ä¼šçŸ¥é“å€¼å‘ç”Ÿæ”¹å˜äº†ï¼Œå°±ä¼šè§¦å‘ runner() é‡æ–°è®¡ç®—å€¼ã€‚\n  ç»è¿‡ç¬¬å››éƒ¨ä¹‹åï¼Œ computed.value å¹¶æ²¡æœ‰çœŸæ­£çš„æ›´æ–°ï¼Œå¿…é¡»å®ƒè¢«å®é™…è®¿é—®çš„æ—¶å€™æ‰ä¼šå»è§¦å‘ runner() é‡æ–°è®¡ç®—å€¼ã€‚\n  æ‰€ä»¥è¯´è®¡ç®—å±æ€§å¹¶ä¸æ˜¯åœ¨ä¾èµ–å€¼æ›´æ–°ä¹‹åå°±ä¼šç«‹å³å‘ç”Ÿå˜åŒ–ï¼Œå¿…é¡»åœ¨ä¾èµ–å€¼å˜æ›´ä¹‹åè¢«è®¿é—®äº†ä¹‹åè§¦å‘ get value() æ‰ä¼šé‡æ–°è®¡ç®—å€¼ã€‚\n ä¸¥æ ¼æ¥è¯´åº”è¯¥ä¸æ˜¯æŒ‰ç…§è¿™äº”ä¸ªé˜¶æ®µæ¥å®Œæˆçš„ï¼Œå…¶å®æœ€è€—æ—¶é—´çš„æ˜¯åœ¨ç¬¬ä¸€å’Œç¬¬äºŒé˜¶æ®µï¼Œå°¤å…¶æ˜¯ç¬¬äºŒé˜¶æ®µã€‚\nç¬¬äºŒé˜¶æ®µè€—æ—¶é—´çš„åœ°æ–¹æœ‰ä¸¤ä¸ª\n createGetter -\u0026gt; track createSetter -\u0026gt; trigger  ä¸»è¦æ—¶é—´èŠ±åœ¨è¿™ä¸¤ä¸ªä¸Šäº†ï¼Œæ‰€ä»¥å¦‚æœè¿˜å¯ä»¥æ‹†åˆ†é˜¶æ®µè‚¯å®šæ˜¯è¿™é‡Œã€‚\n","permalink":"https://www.cheng92.com/vue/vue3-source-code-reactivity/","tags":["vue","vue3","vuenext","reactivity"],"title":"Vue3.0æºç ç³»åˆ—ï¼ˆä¸€ï¼‰å“åº”å¼åŸç† - Reactivity"},{"categories":["javascript"],"contents":" å‚è€ƒé“¾æ¥ï¼šhttps://leanpub.com/understandinges6/read\n ç®€ä»‹ JavaScript æ ¸å¿ƒç‰¹æ€§åœ¨ ECMA-262 æ ‡å‡†ä¸­è¢«å®šä¹‰ï¼Œä¹Ÿå«åš ECMAScript ï¼Œæˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„åœ¨æµè§ˆå™¨ç«¯å’Œ Node.js å®é™…ä¸Šæ˜¯ ECMAScript çš„ä¸€ä¸ªè¶…é›†ã€‚\næœ¬æ–‡åŒ…å« es6+ æ–°å¢ç‰¹æ€§ã€‚\nES6 æ¼”å˜ä¹‹è·¯ 1999 å‘å¸ƒ v3 1999.TC39 å¹´å‘å¸ƒäº† ECMA-262 ç¬¬ä¸‰ç‰ˆã€‚\nç›´åˆ° 2007 ä¹‹å‰éƒ½æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚\n2007 å‘å¸ƒ v4, v3.1 2007 å¹´å‘å¸ƒäº†ç¬¬å››ç‰ˆï¼ŒåŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š\n æ–°è¯­æ³•(new syntax) æ¨¡å—(modules) ç±»æ¦‚å¿µ(classes) ç±»ç»§æ‰¿æ¦‚å¿µ(classical inheritance) å¯¹è±¡ç§æœ‰å±æ€§(private object members) æ›´å¤šç±»å‹ å…¶ä»–  ç”±äºç¬¬å››ç‰ˆæ¶‰åŠçš„å†…å®¹å¤ªå¤šï¼Œå› æ­¤é€ æˆåˆ†æ­§ï¼Œéƒ¨åˆ†æˆå‘˜ç”±æ­¤åˆ›å»ºäº†\n3.1 ç‰ˆæœ¬ï¼ŒåªåŒ…å«å°‘éƒ¨åˆ†çš„è¯­æ³•å˜åŒ–ï¼Œèšç„¦åœ¨ï¼š\n å±æ€§ åŸç”Ÿ JSON æ”¯æŒ å·²æœ‰å¯¹è±¡å¢åŠ æ–¹æ³•  ä½†æ˜¯ä¸¤æ‹¨äººåœ¨ v4 å’Œ v3.1 ç‰ˆæœ¬ä¹‹é—´å¹¶æ²¡æœ‰è¾¾æˆå…±è¯†ï¼Œå¯¼è‡´æœ€åä¸äº†äº†ä¹‹ã€‚\n2008 JavaScript åˆ›å§‹äººå†³å®š Brendan Eich å†³å®šå°†ç€åŠ›äº v3.1 ç‰ˆæœ¬ã€‚\næœ€å v3.1 ä½œä¸º ECMA-262 çš„ç¬¬äº”ä¸ªç‰ˆæœ¬è¢«æ ‡å‡†åŒ–ï¼Œå³ï¼š ECMASCript 5\n2015 å¹´å‘å¸ƒ ECMAScript 6 ä¹Ÿå« ECMAScript 2015 å³æœ¬ä¹¦è¦è®²çš„å†…å®¹(ES6)ã€‚\nå—çº§ç»‘å®š(var, let, const) Var å£°æ˜å’Œæå‡ ä½¿ç”¨ var æ¥å£°æ˜å˜é‡æ—¶ï¼Œåœ¨ä¸€ä¸ªä½œç”¨åŸŸå†…ï¼Œæ— è®ºå®ƒåœ¨å“ªé‡Œå£°æ˜çš„ï¼Œéƒ½ä¼šè¢«å‡åˆ°åˆ°è¯¥ä½œ\nç”¨åŸŸçš„é¡¶éƒ¨ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function getValue(condition) { // æ¯”å¦‚ï¼š var value; // undefined  if (condition) { // è™½ç„¶åœ¨è¿™é‡Œå£°æ˜çš„ï¼Œå…¶å®ä¼šè¢«æå‡åˆ°å‡½æ•°é¡¶ç«¯  var value = \u0026#39;blue\u0026#39; // code  return value } else { // è¿™é‡Œä¾æ—§å¯ä»¥è®¿é—®å˜é‡ `value` åªä¸è¿‡å®ƒçš„å€¼æ˜¯ `undefined`  return null } } console.log(getValue(false)) // \u0026#39;null\u0026#39;   ä¸Šé¢çš„ getValue ç›¸å½“äºä¸‹é¢çš„å˜é‡å£°æ˜ç‰ˆæœ¬ï¼ˆæå‡ä¹‹åï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function getValue(condition) { var value; // undefined  if (condition) { value = \u0026#39;blue\u0026#39; // code  return value } else { return null } } console.log(getValue(false)) // \u0026#39;null\u0026#39;    +RESULTS:\nnull  å—çº§å£°æ˜ let/const å£°æ˜ å—çº§ä½œç”¨åŸŸï¼Œå¦‚ï¼šå‡½æ•°ï¼Œ*{ â€¦ }* å¤§æ‹¬å·ï¼Œç­‰ç­‰éƒ½å±äºå—çº§ä½œç”¨åŸŸï¼Œåœ¨è¯¥ä½œç”¨åŸŸä¸‹ä½¿\nç”¨ let å£°æ˜çš„å˜é‡åªåœ¨\nè¯¥ä½œç”¨åŸŸä¸‹å¯è®¿é—®ã€‚\nå£°æ˜æå‡é—®é¢˜ let å£°æ˜ä¸ä¼šè¢«æå‡ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¦ä¸€ç§è¯´æ³•æ˜¯ let ä¼šæå‡ï¼Œå¹¶ä¸”åœ¨å¦‚æœåœ¨æå‡å¤„\nåˆ°èµ‹å€¼çš„ä¸­é—´èŒƒå›´å†…ä½¿ç”¨äº†è¯¥å˜é‡ï¼Œ\nä¼šä½¿è¯¥åŒºåŸŸæˆä¸ºä¸€å—ä¸´æ—¶æ­»åŒº(TDZ)ã€‚\nåœ¨å£°æ˜ä¹‹å‰ä½¿ç”¨ let å˜é‡ï¼š\nVM88:4 Uncaught ReferenceError: Cannot access \u0026lsquo;value\u0026rsquo; before\ninitialization\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function getValue(cond) { if (cond) { console.log(value) let value = \u0026#39;blue\u0026#39; // code  return value } else { // value åœ¨è¯¥ä½œç”¨åŸŸä¸å­˜åœ¨  return null } // value åœ¨è¯¥ä½œç”¨åŸŸä¸å­˜åœ¨ } getValue(true)   ä¸èƒ½é‡å¤å£°æ˜ ä½¿ç”¨ var çš„æ—¶å€™æ˜¯å¯ä»¥é‡å¤å£°æ˜çš„ï¼š\nvar count = 39; var count;\nè¿™æ ·æ˜¯ä¸ä¼šæœ‰é—®é¢˜çš„ï¼Œåªä¸è¿‡å®ƒçš„å£°æ˜åªä¼šè¢«è®°å½•ä¸€æ¬¡è€Œå·²ï¼Œå³åªä¼šè®°å½• var count = 39; è¿™é‡Œå£°æ˜ï¼Œä½†æ˜¯ä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚\nå¦‚æœä½¿ç”¨ let å°±ä¸ä¸€æ ·äº†ï¼Œå¦‚æœå‡ºç°é‡å¤å£°æ˜åˆ™ä¼šå¼‚å¸¸ï¼š\nvar count = 39;let count;\nå¼‚å¸¸ç»“æœï¼š*SyntaxError: Identifier \u0026lsquo;count\u0026rsquo; has already been declared*\nä¸¤è€…å·®åˆ« let å£°æ˜çš„å€¼å¯å˜ï¼Œconst å£°æ˜çš„æ˜¯ä¸ªå¸¸é‡ï¼Œå€¼æ˜¯ä¸èƒ½å‘ç”Ÿæ”¹å˜çš„ã€‚\n1 2 3 4 5 6 7  let name = \u0026#39;xxx\u0026#39;; name = \u0026#39;yyy\u0026#39;; // ok  const age = 100; age = 88; // error   ä¸´æ—¶æ­»åŒº(TDZ) ä½¿ç”¨ let/const å£°æ˜çš„å˜é‡ï¼Œä»»ä½•æ—¶å€™è¯•å›¾åœ¨å…¶å£°æ˜ä¹‹å‰ä½¿ç”¨å˜é‡éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\nå³ä½¿æ˜¯åœ¨å£°æ˜ä¹‹å‰ä½¿ç”¨ typeof ä¹Ÿä¼šå‡ºç°å¼•ç”¨å¼‚å¸¸(ReferenceError)ã€‚\n1 2 3 4 5  if (true) { console.log(typeof value) let value = \u0026#39;blue\u0026#39; }   å¾ªç¯ä¸­ä½¿ç”¨å—çº§å£°æ˜ æˆ‘ä»¬éƒ½çŸ¥é“ä½¿ç”¨ var å£°æ˜çš„å˜é‡æ˜¯ä¸å­˜åœ¨å—çº§ä½œç”¨åŸŸçš„ï¼Œå³åœ¨ if/for çš„ {} ä½œ\nç”¨åŸŸå†…ä½¿ç”¨ var\nå£°æ˜çš„å˜é‡å…¶å®æ˜¯è¯¥å…¨å±€ä½œç”¨ä¸‹çš„å…¨å±€å˜é‡ã€‚\næ¯”å¦‚ï¼šæˆ‘ä»¬å¸¸è§çš„ for å¾ªç¯ä¸­çš„ i çš„å€¼\n1 2 3 4 5  for (var i = 0; i \u0026lt; 10; i++) { // ... } console.log(i) // 10   +RESULTS:\n10  ç»“æœä¸º 10 è¡¨æ˜åœ¨ console.log(i) å¤„æ˜¯å¯ä»¥è®¿é—® i å˜é‡çš„ï¼Œå› ä¸º var i = 0; çš„å£°æ˜\nè¢«æå‡æˆäº†å…¨å±€å˜é‡ï¼Œå³å¾ªç¯ä½“ä¸­ä½¿ç”¨çš„ä¸€ç›´æ˜¯è¿™ä¸€ä»½å…¨å±€å˜é‡ã€‚\nå¦‚æœæ˜¯åŒæ­¥ä»£ç ï¼Œå¯èƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†è¦æ˜¯å¼‚æ­¥ä»£ç å°±ä¼šå‡ºç°é—®é¢˜ï¼Œå¦‚ä¸‹ç»“æœï¼š\n1 2 3  for (var i = 0; i \u0026lt; 5; i++) { setTimeout(() =\u0026gt; console.log(i)) }   +RESULTS:\n5 5 5 5 5  å¾ˆé—æ†¾æœ€åç»“æœéƒ½æˆäº† 5ï¼Œå› ä¸ºå¾ªç¯ä½“æ˜¯ä¸ªå¼‚æ­¥ä»£ç  setTimeout\nè§£å†³æ–¹æ³•æœ‰ï¼š\n é—­åŒ…:  å½¢æˆä¸€ä¸ªå°é—­çš„ä½œç”¨åŸŸï¼Œå°†å½“å‰çš„ i å€¼ä¼ é€’è¿›å»ã€‚\n1 2 3 4 5 6  for (var i = 0; i \u0026lt; 5; i++) { (v =\u0026gt; { // è¿™é‡Œçš„ v å€¼å³ä¼ é€’è¿›æ¥çš„å½“å‰æ¬¡å¾ªç¯çš„ i çš„å€¼  setTimeout(() =\u0026gt; console.log(v)) })(i) }   +RESULTS:\n0 1 2 3 4   let  æ¯æ¬¡å¾ªç¯ç›¸å½“äºæ–°åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ï¼Œå› æ­¤å˜é‡çš„å€¼éƒ½å¾—ä»¥ä¿å­˜ã€‚\n1 2 3  for (let i = 0; i \u0026lt; 5; i++) { setTimeout(() =\u0026gt; console.log(i)) }   +RESULTS:\n0 1 2 3 4  å…¨å±€ä½œç”¨åŸŸå£°æ˜ var, let, const å¦ä¸€ä¸ªåŒºåˆ«æ˜¯åœ¨å…¨å±€ç¯å¢ƒä¸‹çš„å£°æ˜ä½œç”¨åŸŸä¹Ÿæ˜¯ä¸ä¸€æ ·ï¼Œ\næˆ‘ä»¬éƒ½çŸ¥é“åœ¨å…¨å±€ä½œç”¨åŸŸä¸‹ä½¿ç”¨ var å£°æ˜çš„è¯ï¼Œæµè§ˆå™¨ç«¯æ˜¯å¯ä»¥é€šè¿‡ window.name\næ¥è®¿é—®è¯¥å˜é‡çš„ï¼Œä½†æ˜¯ let, const å´ä¸è¡Œã€‚\n1 2 3 4 5 6  var age = 100 let name = \u0026#39;xxx\u0026#39; console.log(window.name) console.log(window.age)   ç»“æœï¼š\næµè§ˆå™¨ç«¯ä½œç”¨åŸŸï¼š\nç»“è®ºï¼š\næ— è®º let åœ¨é‚£é‡Œå£°æ˜çš„å®ƒéƒ½æ˜¯ä¸ªå—çº§ä½œç”¨åŸŸå˜é‡ï¼Œåªåœ¨å…¶å£°æ˜åˆ°è¯¥ä½œç”¨åŸŸä¹‹åæ‰èƒ½\nä½¿ç”¨ã€‚\nè€Œ var å£°æ˜çš„å§‹ç»ˆç›¸å¯¹äºå½“å‰ä½œç”¨åŸŸä¸‹æ˜¯å…¨å±€å˜é‡ã€‚\næ€»ç»“(var, let, const) åœ¨ es6 ä¹‹åå°½é‡ä½¿ç”¨ let å’Œ const å»å£°æ˜å˜é‡ï¼Œä¸¥æ ¼æ§åˆ¶å˜é‡çš„ä½œç”¨åŸŸã€‚\n var å˜é‡å£°æ˜ä¼šæå‡ï¼Œå¯é‡å¤å£°æ˜ï¼Œä¸”åœ¨è¯¥ä½œç”¨åŸŸå†…ä¸ºå…¨å±€å˜é‡ let/const å˜é‡å£°æ˜ä¸ä¼šæå‡ï¼Œä¸å¯é‡å¤å£°æ˜ï¼Œå±€éƒ¨å˜é‡ï¼Œä¸”åœ¨ DTZ èŒƒå›´å†…ä½¿ç”¨å³\nä½¿æ˜¯ typeof ä¹Ÿä¼šæŠ¥é”™ let/const åŒºåˆ«åœ¨äº const å£°æ˜çš„å˜é‡å€¼ä¸èƒ½å‘ç”Ÿæ”¹å˜     å…³é”®è¯ æå‡ ä½œç”¨åŸŸ å€¼å±æ€§     var æœ‰æå‡ï¼Œå£°æ˜æå‡(å‘½åå‡½æ•°å®šä¹‰ä¹Ÿæå‡) èŒƒå›´å†…å…¨å±€ å¯å˜   let æ— æå‡ å±€éƒ¨å˜é‡ï¼Œä½œç”¨åŸŸå†…å£°æ˜å¤„å¼€å§‹å¾€ä¸‹ å¯å˜   const æ— æå‡ å±€éƒ¨å˜é‡ï¼Œä½œç”¨åŸŸå†…å£°æ˜å¤„å¼€å§‹å¾€ä¸‹ ä¸å¯å˜    å­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼(String\u0026amp;Regex) æ›´å¥½çš„ Unicode ç¼–ç æ”¯æŒ UTF-16 ç¼–ç  æ–°å¢ str.codePointAt(n) å’Œ String.fromCodePoint(str) å·²æœ‰çš„ç¼–ç æŸ¥è¯¢å‡½æ•°ï¼š str.charCodeAt å’Œ String.fromCodeAt ç”¨æ¥åº”å¯¹å•å­—ç¬¦ä¸€ä¸ª\nå­—èŠ‚çš„æƒ…å†µã€‚\næ–°å¢çš„ä¸¤ä¸ªå‡½æ•°å¯ä»¥å¤„ç†å•ä¸ªå­—ç¬¦ä¸²å ä¸¤ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œæ¯”å¦‚ä¸€äº›ç‰¹æ®Šå­—ç¬¦â€œğ ®·â€éœ€è¦ç”¨\nåˆ°ä¸¤ä¸ªå­—èŠ‚æ¥å­˜å‚¨ã€‚\nå³ 2bytes = 16bits å¤§å°ã€‚\ncharCodeAt å’Œ fromCodeAt æ˜¯ä»¥ä¸€ä¸ªå­—èŠ‚ä¸ºå•ä½æ¥å¤„ç†å­—ç¬¦ä¸²çš„ï¼Œå› æ­¤å¦‚æœé‡åˆ°è¿™äº›\nå­—å°±æ²¡æ³•æ­£å¸¸å¤„ç†ã€‚\n1 2 3 4 5 6 7  var name = \u0026#39;ğ ®·\u0026#39; console.log(name.charCodeAt(0)) console.log(name.codePointAt(0)) console.log(String.fromCharCode(name.charCodeAt(0))) console.log(String.fromCodePoint(name.codePointAt(0)))   +RESULTS:\n55362 134071 ï¿½ ğ ®·  å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä»¬è¿˜ç”¨åŸæ¥çš„å‡½æ•° charCodeAt å’Œ fromCharCode å»å¤„ç†è¿™ä¸ªå­—å¾—åˆ°ç»“\næœæ˜¯ä¸æ­£ç¡®çš„ã€‚\nnormalize() å‡½æ•° å‚è€ƒé“¾æ¥ï¼šhttps://www.cnblogs.com/hahazexia/p/9257409.html\nrepeat(n) å‡½æ•° å°†ä¸€ä¸ªå­—ç¬¦ä¸²é‡å¤ n æ¬¡åè¿”å›ã€‚\n1 2 3 4 5  var c = \u0026#39;x\u0026#39; var b = c.repeat(3) console.log(b, c, b === c)   +RESULTS:\nxxx x false  æ­£åˆ™è¡¨è¾¾å¼ y æ ‡è®° s(dotAll)flag2018 1 2  console.log(/one.two/.test(\u0026#39;one\\ntwo\u0026#39;)); // â†’ false console.log(/one.two/s.test(\u0026#39;one\\ntwo\u0026#39;)); // â†’ true   å‘½åæ•è·ç»„(Named Caputre Groups)2018 æ ¼å¼ï¼š ?\u0026lt;name\u0026gt;\nå¼•ç”¨ï¼š match.groups ä¸€ä¸ªåŒ…å«æ•è·ç»„åç§°çš„å¯¹è±¡\n1 2 3 4 5 6 7 8  const re = /(\\d{4})-(\\d{2})-(\\d{2})/ const match = re.exec(\u0026#39;2019-10-10\u0026#39;) console.log(match[0]) // -\u0026gt; 2019-10-10 console.log(match[1]) // -\u0026gt; 2019 console.log(match[2]) // -\u0026gt; 10 console.log(match[3]) // -\u0026gt; 10    å‘½åæ•è·ç»„ï¼š\n1 2 3 4 5 6 7  const namedRe = /(?\u0026lt;year\u0026gt;\\d{4})-(?\u0026lt;month\u0026gt;\\d{2})-(?\u0026lt;date\u0026gt;\\d{2})/ const namedMatch = namedRe.exec(\u0026#39;2019-10-10\u0026#39;) console.log(namedMatch.groups) // { year: \u0026#39;2019\u0026#39;, month: \u0026#39;10\u0026#39;, date: \u0026#39;10\u0026#39; } console.log(namedMatch.groups.year) // 2019 console.log(namedMatch.groups.month) // 10 console.log(namedMatch.groups.date) // 10   JSON JSON.stringify2019 æ›´å¥½çš„å¤„ç†ä¸æ”¯æŒçš„å­—ç¬¦åºåˆ—ã€‚\nå­—ç¬¦ä¸²æ–¹æ³• String.prototype.trimStart()2019 String.prototype.trimEnd()2019 String.prototype.toString()2019 æ›´å¥½çš„å¤„ç†ç©ºæ ¼ï¼Œæ¢è¡Œç¬¦ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œæ¯”å¦‚ï¼šå­—ç¬¦ä¸²åŒ–å‡½æ•°çš„æ—¶å€™ï¼Œä¼šå°†å‡½æ•°åŸæ ·è¾“å‡ºã€‚\nå¦‚ï¼š\næ¨¡æ¿å­—ç¬¦ä¸² åŸºæœ¬è¯­æ³• 1 2 3 4 5  let msg = `hello world` console.log(msg) console.log(typeof msg) console.log(msg.length)   +RESULTS:\nhello world string 11  å¦‚æœéœ€è¦ç”¨åˆ°åå¼•å·ï¼Œåˆ™éœ€è¦ä½¿ç”¨è½¬ä¹‰å­—ç¬¦ï¼š \\`\nå¤šè¡Œå­—ç¬¦ä¸² é¿å…ä¸€è¡Œå¤ªé•¿ï¼Œè¿›è¡Œæ¢è¡Œä¹¦å†™ï¼Œä½†æ˜¯ä¸å½±å“æœ€ç»ˆç»“æœæ˜¾ç¤ºåœ¨ä¸€è¡Œï¼Œå¯ä»¥ä½¿ç”¨åæ–œæ \n1 2 3 4  var msg = `multiline \\ string` console.log(msg)   +RESULTS:\nmultiline string  å¤šè¡Œå­—ç¬¦ä¸²æƒ…å†µï¼š\n1 2 3  var msg = \u0026#34;multiline \\n string\u0026#34; console.log(msg)   +RESULTS:\nmultiline string  ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œä¼šæŒ‰ç…§æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„æ ¼å¼åŸæ ·è¾“å‡ºï¼Œè€Œä¸å†éœ€è¦æ˜¾ç¤ºä½¿ç”¨ `\\n` æ¥\nè¿›è¡Œæ¢è¡Œï¼š\n1 2 3 4  var msg = `multiline string` console.log(msg)   +RESULTS:\nmultiline string  åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­ç©ºæ ¼ä¹Ÿä¼šæ˜¯å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†\n1 2 3 4 5 6 7 8  var msg1 = `multiline string` var msg2 = `multiline string` console.log(`len1: ${msg1.length}`) console.log(`len2: ${msg2.length}`)   +RESULTS:\nlen1: 19 len2: 16  æ‰€ä»¥åœ¨ä¹¦å†™æ¨¡æ¿å­—ç¬¦ä¸²çš„æ—¶å€™å¿…é¡»æ…é‡ä½¿ç”¨ç¼©è¿›ã€‚\næ¨¡æ¿å­—ç¬¦ä¸²æ’å€¼ 1 2 3 4 5 6  var name = \u0026#39;xxx\u0026#39; const getAge = () =\u0026gt; 100 console.log(`my name is ${name}`) // æ™®é€šå­—ç¬¦ä¸² console.log(`3 + 4 = ${3 + 4}`) // å¯æ‰§è¡Œè®¡ç®— console.log(`call function to get age : ${getAge()}`) // å¯è°ƒç”¨å‡½æ•°   +RESULTS:\nmy name is xxx 3 + 4 = 7 call function to get age : 100  æ ‡ç­¾æ¨¡æ¿ å…è®¸ä½¿ç”¨æ ‡ç­¾æ¨¡æ¿ï¼Œè¯¥æ ‡ç­¾å¯¹åº”çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåé¢çš„æ¨¡æ¿å­—ç¬¦ä¸²ä¼šè¢«è§£ææˆå‚æ•°ä¼ é€’\nç»™è¯¥å‡½æ•°å»è¿›è¡Œå¤„ç†ï¼Œæœ€åè¿”å›å¤„ç†çš„ç»“æœã€‚\næ¯”å¦‚ï¼š let msg = tag`Hello World`\nå®šä¹‰æ ‡ç­¾ï¼š\n1 2 3  function tag(literals, ...substitutions) { // è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸² }   ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let count = 10, price = 0.25, msg = passthru`${count}items cost $${(count * price).toFixed(2)}.` function passthru(literals, ...subs) { console.log(literals.join(\u0026#39;--\u0026#39;)) console.log(subs) // å°†ç»“æœæ‹¼èµ·æ¥  return subs.map((s, i) =\u0026gt; literals[i] + subs[i]).join(\u0026#39;\u0026#39;) + literals[literals.length - 1] } console.log(msg)   +RESULTS:\n-- items cost $--. [ 10, '2.50' ] 10 items cost $2.50.  ä»ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæ ‡ç­¾å‡½æ•°å‚æ•°çš„å†…å®¹åˆ†åˆ«ä¸º:\n literals è¢«æ’å€¼(${})åˆ†å‰²æˆçš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œæ¯”å¦‚ä¸Šä¾‹çš„ç»“æœä¸ºï¼š [\u0026quot;\u0026quot;, \u0026quot; items const $\u0026quot;, \u0026quot;.\u0026quot;] subs ä¸ºæ’å€¼è®¡ç®—çš„ç»“æœå€¼ä½œä¸ºç¬¬2, â€¦ ç¬¬ n ä¸ªå‚æ•°ä¼ é€’ç»™äº† passthru  æ ‡ç­¾æ¨¡æ¿åŸå§‹å€¼(String.raw()) æœ‰æ—¶å€™éœ€è¦åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­ç›´æ¥ä½¿ç”¨å¸¦æœ‰è½¬ä¹‰å­—ç¬¦çš„å†…å®¹ï¼Œæ¯”å¦‚ï¼š `\\n` è€Œä¸æ˜¯ä½¿ç”¨å…¶\nè½¬ä¹‰ä¹‹åçš„å«ä¹‰ã€‚\nè¿™ä¸ªæ—¶å€™åˆ™å¯ä»¥ä½¿ç”¨æ–°å¢çš„å†…ç½® tag å‡½æ•°æ¥å¤„ç†ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5  let msg1 = `multiline\\nstring` let msg2 = String.raw`multileline\\nstring` console.log(msg1) console.log(msg2)   +RESULTS:\nmultiline string multileline\\nstring  å¯çœ‹åˆ°åœ¨æˆ‘ä»¬ä½¿ç”¨ String.raw ä¹‹åçš„ \\n å¹¶æ²¡æœ‰è¢«è½¬ä¹‰æˆæ¢è¡Œç¬¦ï¼Œè€Œæ˜¯æŒ‰ç…§å…¶åŸ\nå§‹çš„æ ·å­è¾“å‡ºã€‚\nå¦‚æœåœ¨ä¸é€‚ç”¨å†…ç½®çš„ Strng.raw è¯¥æ€ä¹ˆåšï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12  function raw(literals, ...subs) { // å°†ç»“æœæ‹¼èµ·æ¥  return subs.map((s, i) =\u0026gt; literals.raw[i] + subs[i]).join(\u0026#39;\u0026#39;) + literals.raw[literals.length - 1] } let msg = raw`multiline\\nstring` console.log(msg)   +RESULTS:\nmultiline\\nstring  nodejs ç¯å¢ƒå¯èƒ½çœ‹èµ·æ¥ä¸ç›´è§‚ï¼Œé€šè¿‡ä¸‹å›¾æˆ‘ä»¬æ¥ç›´è§‚çš„æŸ¥çœ‹ä¸‹æ ‡ç­¾å‡½æ•°æ˜¯æ€ä¹ˆå¤„ç†å¸¦\nè½¬ä¹‰å­—ç¬¦çš„å­—ç¬¦ä¸²çš„ï¼š\nä¼šå‘ç°å…¶å® literals çš„å€¼ä¾æ—§æ˜¯è½¬ä¹‰ä¹‹åçš„ï¼Œçœ‹æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„å­—ç¬¦ä¸²ä¸­æ˜¯æœ‰\nä¸€ä¸ªå›è½¦æ ‡è¯†çš„ã€‚\næ­¤å¤–è¯¥æ•°ç»„å¯¹è±¡æœ¬èº«ä¸Šé¢å¤šäº†ä¸€ä¸ª raw å±æ€§ï¼Œå…¶å€¼ä¸ºæ²¡æœ‰è½¬ä¹‰çš„å†…å®¹ã€‚\nä»è¿™é‡Œæˆ‘ä»¬å¾—å‡ºï¼Œæ ‡ç­¾æ¨¡æ¿æ˜¯æ€ä¹ˆå¤„ç†å¸¦è½¬ä¹‰å­—ç¬¦ä¸²çš„æ¨¡æ¿çš„ã€‚\nå°ç»“  å®Œæ•´çš„ç¼–ç æ”¯æŒèµ‹äºˆäº† JavaScript å¤„ç† UTF-16 å­—ç¬¦çš„èƒ½åŠ›(é€šè¿‡\ncodePointAt() å’Œ String.fromCodePoint() æ¥è½¬æ¢) u æ–°å¢çš„æ ‡è®°ä½¿å¾—æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥é€šè¿‡ç ç‚¹æ¥ä»£æ›¿ UTF-16 å­—ç¬¦ normalize() æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œæ”¯æŒåŸå§‹å­—ç¬¦ä¸²ï¼Œæ’å€¼æ”¯æŒè®¡ç®—è¡¨è¾¾å¼æˆ–å‡½æ•°è°ƒç”¨ æ ‡ç­¾æ¨¡æ¿ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåˆ†å‰²åçš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œåé¢çš„å‚æ•°åˆ†åˆ«ä¸ºæ’å€¼ç»“æœ è½¬ä¹‰æ ‡ç­¾æ¨¡æ¿ï¼Œè½¬ä¹‰æ ‡ç­¾çš„ç¬¬ä¸€ä¸ªå‚æ•°æ•°ç»„å¯¹è±¡ä¸ŠåŒ…å«ä¸€ä¸ª raw æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«\näº†åŸå§‹å€¼åˆ—è¡¨  å‡½æ•°(Function) å‚æ•°é»˜è®¤å€¼ 1 2 3  function makeRequest(url, timeout = 2000, callback = () =\u0026gt; {}) { // ... }   é»˜è®¤å‚æ•°å€¼æ˜¯å¦‚ä½•å½±å“ arguments å¯¹è±¡çš„ï¼Ÿ\nä¸¥æ ¼éä¸¥æ ¼æ¨¡å¼ä¸‹çš„ arguments åªè¦è®°ä½ä¸€æ—¦ä½¿ç”¨äº†é»˜è®¤å€¼ï¼Œé‚£ä¹ˆ arguments å¯¹è±¡çš„è¡Œä¸ºå°†å‘ç”Ÿæ”¹å˜ã€‚\nåœ¨ ECMAScript5 çš„éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œarguments å¯¹è±¡çš„å†…å®¹æ˜¯ä¼šéšç€å‡½æ•°å†…éƒ¨å‡½æ•°å‚æ•°å€¼å¾—å˜åŒ–è€Œå‘ç”Ÿå˜åŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒ\nå¹¶ä¸æ˜¯åœ¨è°ƒç”¨å‡½æ•°ä¹‹åˆå€¼å°±å›ºå®šäº†ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10  function maxArgs(first, second) { console.log(first === arguments[0]) console.log(second === arguments[1]) first = \u0026#39;c\u0026#39; second = \u0026#39;d\u0026#39; console.log(first === arguments[0]) console.log(second === arguments[1]) } maxArgs(\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;)   +RESULTS:\ntrue true true true  ä»ç»“æœæˆ‘ä»¬ä¼šå‘ç°ï¼Œå‚æ•°å€¼å‘ç”Ÿå˜åŒ–ä¹Ÿä¼šå¯¼è‡´ arguments å¯¹è±¡è·Ÿç€å˜åŒ–ï¼Œè¿™ç§æƒ…å†µåªä¼šåœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹äº§ç”Ÿï¼Œ\nåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œ arguments å¯¹è±¡æ˜¯ä¸ä¼šéšç€å‚æ•°å€¼æ”¹å˜è€Œæ”¹å˜çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  function maxArgs(first, second) { \u0026#39;use strict\u0026#39;; console.log(first === arguments[0]) console.log(second === arguments[1]) first = \u0026#39;c\u0026#39; second = \u0026#39;d\u0026#39; console.log(first === arguments[0]) console.log(second === arguments[1]) } maxArgs(\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;)   +RESULTS:\ntrue true false false  å–ï¼Œåé¢ç»“æœä¸º false ã€‚\nå¸¦é»˜è®¤å‚æ•°å€¼æƒ…å†µä¸‹ arguments åœ¨ es6 ä¹‹åï¼Œarguments çš„è¡Œä¸ºå’Œä¹‹å‰ä¸¥æ ¼æ¨¡å¼ä¸‹æ˜¯ä¸€æ ·çš„ï¼Œå³ä¸ä¼šæ˜ å°„å‚æ•°å€¼å¾—å˜åŒ–ã€‚\n  å¸¦é»˜è®¤å€¼å¾—å‚æ•°ï¼Œå¦‚æœåœ¨è°ƒç”¨çš„æ—¶å€™ä¸ä¼ é€’ï¼Œæ˜¯ä¸ä¼šè®¡å…¥åˆ° arguments å¯¹è±¡å½“ä¸­\nå³ arguments çš„å®é™…ä¸ªæ•°æ˜¯æ ¹æ®è°ƒç”¨çš„æ—¶å€™æ‰€ä¼ é€’çš„å‚æ•°ä¸ªæ•°æ¥å†³å®šçš„ã€‚\n  arguments å¯¹è±¡ä¸å†å“åº”å‚æ•°å€¼å¾—å˜åŒ–\n  1 2 3 4 5 6 7 8 9 10 11  function mixArgs(first, second = \u0026#39;b\u0026#39;) { console.log(arguments.length) console.log(first === arguments[0]) // true  console.log(second === arguments[1]) // false  first = \u0026#39;c\u0026#39; second = \u0026#39;d\u0026#39; console.log(first === arguments[0]) // false  console.log(second === arguments[1]) // false } mixArgs(\u0026#39;a\u0026#39;)   +RESULTS:\n1 true false false false  é»˜è®¤å‚æ•°è¡¨è¾¾å¼ å‚æ•°é»˜è®¤å€¼ä¸ä»…å¯ä»¥ä½¿ç”¨é™æ€å€¼ï¼Œè¿˜å¯ä»¥èµ‹å€¼ä¸ºè°ƒç”¨å‡½æ•°çš„ç»“æœ\n1 2 3 4 5 6 7 8 9 10 11  function getValue() { console.log(\u0026#39;get value...\u0026#39;) return 5 } function add(first, second = getValue()) { return first + second } console.log(add(1, 1)) // 2 console.log(add(1)) // 6   +RESULTS:\n2 get value... 6  ä»ç»“æœæ˜¾ç¤ºï¼š\n å¦‚æœ second æ²¡ä¼ ï¼Œä¼šåœ¨è°ƒç”¨ add() æ—¶å€™æ‰§è¡Œ getValue() è·å–é»˜è®¤å€¼ å¦‚æœä¼ é€’äº† secondï¼Œé‚£ä¹ˆ getValue() æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„  å³åœ¨é»˜è®¤å‚æ•°ä¸­è°ƒç”¨çš„å‡½æ•°ï¼Œæ˜¯ç”±åœ¨è°ƒç”¨æ—¶è¯¥å¯¹åº”çš„å‡½æ•°å‚æ•°æ˜¯å¦æœ‰ä¼ é€’æ¥å†³å®šæ˜¯å¦è°ƒç”¨ã€‚\nè€Œä¸æ˜¯ä¼ é€’äº† secondï¼Œå…ˆè°ƒç”¨ getValue() å¾—åˆ°å€¼ï¼Œç„¶åç”¨ä¼ é€’çš„ second å€¼å»è¦†ç›–ã€‚\nä¹Ÿå°±æ˜¯è¯´ getValue() è¿”å›çš„å€¼ä¸ç”¨æ¯æ¬¡éƒ½ä¸€æ ·ï¼Œæ˜¯å¯ä»¥åœ¨æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™å‘ç”Ÿå˜åŒ–çš„ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  var n = 5 function getValue() { return n++ } function add(first, second = getValue()) { return first + second } console.log(add(1, 1)) // 2 console.log(add(1)) // 6 console.log(add(1)) // 7   +RESULTS:\n2 6 7  ç”±äºä¸Šé¢çš„ç‰¹æ€§ï¼Œå‚æ•°é»˜è®¤å€¼å¯ä»¥æ˜¯åŠ¨æ€çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å‰é¢å‚æ•°å€¼ä½œä¸ºåé¢å‚æ•°çš„é»˜è®¤å€¼æ¥ä½¿ç”¨ï¼Œ\næ¯”å¦‚ï¼š\n1 2 3 4 5 6  function add(first, second = first) { return first + second } console.log(add(1, 1)) // 2 console.log(add(1)) // 2   +RESULTS:\n2 2  ç”šè‡³è¿˜å¯ä»¥å°† first ä½œä¸ºå‚æ•°ä¼ é€’ç»™ getValue(first) è·å–æ–°å€¼ä½œä¸ºé»˜è®¤å€¼æ¥ç”¨ã€‚\né»˜è®¤å‚æ•°å€¼çš„ä¸´æ—¶æ­»åŒº(TDZ) è¿™é‡Œä¸´æ—¶æ­»åŒºçš„æ„æ€æ˜¯æŒ‡ï¼Œç¬¬äºŒä¸ªå‚æ•°åœ¨ä½¿ç”¨ä¹‹å‰æœªè¿›è¡Œå£°æ˜ï¼Œå› ä¸ºå‚æ•°çš„å£°æ˜ç›¸å½“äºä½¿ç”¨äº† let ã€‚\næ ¹æ® let çš„ç‰¹æ€§ï¼Œåœ¨ä¸ºå£°æ˜ä¹‹å‰ä½¿ç”¨å±äºåœ¨ TDZ èŒƒå›´ï¼Œä¼šæŠ›å¼‚å¸¸ã€‚\nå®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11  function add(first = second, second) { return first + second } console.log(add(1, 1)) // 2  try { add(undefined, 1) // error } catch (e) { console.log(e.message) }   +RESULTS:\n2 second is not defined  æ—¢ç„¶éƒ½å­˜åœ¨ TDZ é‚£ä¸ºä»€ä¹ˆç¬¬ä¸€æ¬¡è°ƒç”¨å°±æ²¡äº‹äº†ï¼Œä¸‹é¢æ¥åˆ†æä¸‹çœ‹çœ‹ï¼š\nè®°ä½ä¸Šä¸€èŠ‚æ‰€è®²çš„ï¼š\né»˜è®¤å€¼çš„è°ƒç”¨(å¦‚ï¼š getValue() )åªæœ‰åœ¨å‚æ•°æœªä¼ é€’çš„æƒ…å†µä¸‹æ‰ä¼šå‘ç”Ÿï¼Œè¿™é‡Œ first=second çš„æƒ…å†µä¾æ—§é€‚ç”¨ã€‚\né‚£ä¹ˆå°†è¿™å¥è¯åº”ç”¨åˆ°è¿™é‡Œï¼š\n  add(1, 1) è¿™é‡Œ first ä¼ é€’äº† 1\né‚£ä¹ˆ first åœ¨ add è¢«è°ƒç”¨çš„æ—¶å€™ä¼šè¢«åˆå§‹åŒ–æˆ 1ï¼Œæ ¹æ®ä¸Šé¢é‚£å¥è¯ï¼Œå³æ­¤æ—¶ first=second è¿™å¥ç›¸å½“äºå¹¶æ²¡æœ‰è¢«æ‰§è¡Œ\nå› æ­¤å°±ä¸ä¼šå»æ£€æµ‹ second ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°æœªå®šä¹‰äº†ï¼Œä»è€Œèƒ½å¾—å‡ºæ­£ç¡®ç»“æœï¼š2ã€‚\n  add(undefined, 1) ä¼ é€’äº† `undefined` ç›¸å½“äºæ²¡ä¼ è¿™ä¸ªå‚æ•°ï¼Œåªæ˜¯å äº†ä¸ªä½\né‚£ä¹ˆæ—¢ç„¶æ²¡ä¼ ï¼Œ first=second å°±ä¼šè¢«æ‰§è¡Œï¼Œ second å°±ä¼šè¢«æ£€æµ‹æ˜¯å¦å®šä¹‰ï¼Œç„¶è€Œæ£€æµ‹çš„ç»“æœå°±æ˜¯â€œæœªå®šä¹‰â€ï¼Œ\nå› æ­¤æŠ›å‡ºå¼‚å¸¸ã€‚\n  å°† add å‡½æ•°å‚æ•°çš„å˜åŒ–ç”¨ä¸‹æ¥è½¬å£°æ˜æ¥è¡¨ç¤ºï¼Œé—®é¢˜å°±ä¼šæ›´æ˜æ˜¾äº†ï¼š\n1 2 3 4 5 6 7 8  // add(1, 1)  let first = 1 // first = second æœªæ‰§è¡Œï¼Œä¸æ£€æµ‹ let second = 1 // add(undefined, 1) let first = second // è¿™å¥è¢«æ‰§è¡Œï¼Œç›¸å½“äºè¿™é‡Œæå‰ä½¿ç”¨äº† second å˜é‡ï¼Œlet ç‰¹æ€§ç”Ÿæ•ˆ let second = 1    å‡½æ•°å‚æ•°æ˜¯æœ‰å®ƒè‡ªå·±çš„ä½œç”¨åŸŸå’ŒTDZçš„ï¼Œå¹¶ä¸”å’Œå‡½æ•°ä½“ä½œç”¨åŸŸæ˜¯åŒºåˆ†å¼€çš„ï¼Œ\nè¿™å°±æ„å‘³ç€å‡½æ•°å‚æ•°æ˜¯æ— æ³•è®¿é—®å‡½æ•°ä½“å†…çš„ä»»ä½•å˜é‡çš„ï¼Œå› ä¸ºæ ¹æ®å°±æ˜¯ä¸¤ä¸ªä¸åŒçš„ä½œç”¨åŸŸã€‚\n æœªå‘½åå‚æ•° ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æœªå‘½åå‚æ•°ï¼Ÿ\nå› ä¸º JavaScript æ˜¯æ²¡æœ‰é™åˆ¶è°ƒç”¨å‡½æ•°çš„æ—¶å€™ä¼ é€’å‚æ•°ä¸ªæ•°çš„ã€‚\næ¯”å¦‚ï¼šå£°æ˜äº†ä¸€ä¸ªå‡½æ•° function add() {} æ²¡ä»»ä½•å‚æ•°ï¼Œä½†æ˜¯è°ƒç”¨çš„æ—¶å€™æ˜¯å¯ä»¥è¿™æ ·\nçš„ add(1, 2, 3, ...)\né‚£ä¹ˆè¿™äº›è°ƒç”¨çš„æ—¶å€™ä¼ é€’ç»™ add çš„å‚æ•°å¯¹åº”çš„å‡½æ•°å‚æ•°å°±å«åšæœªå‘½åå‚æ•°ã€‚\n1 2 3 4 5 6 7 8  function add() { let n = 0 ;[].slice.call(arguments).forEach(v =\u0026gt; n += v) return n } console.log(add(1, 2, 3, 4, 5))   +RESULTS:\n15  å‚æ•°å±•å¼€ç¬¦(â€¦) æœªå‘½åå‚æ•°ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨ï¼Œå› ä¸ºè¿™è®©ä½¿ç”¨è€…ä¼šå¾ˆè¿·æƒ‘è¯¥å‡½æ•°çš„ä½œç”¨ï¼Œå› æ­¤å‚æ•°æ²¡ä»»ä½•æ˜\næ˜¾ç‰¹å¾è¡¨ç¤ºå®ƒæ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Œ\nåœ¨ es6 ä¸­å¢åŠ äº†ä¸€ä¸ªå±•å¼€ç¬¦å·(â€¦)ï¼Œåœ¨å‡½æ•°å‚æ•°ä¸­çš„ä½œç”¨æ˜¯å°†ä¼ é€’è¿›çš„å‚æ•°åˆ—è¡¨åˆå¹¶\næˆä¸€ä¸ªå‚æ•°æ•°ç»„ã€‚\né€‚ç”¨äºä¸€ä¸ªå‡½æ•°å‚æ•°ä¸ªæ•°æœªçŸ¥çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  function pick(object, ...keys) { // è¿™é‡Œ keys ä¼šæˆä¸ºä¸€ä¸ªåŒ…å«ä¼ å…¥çš„å…¶ä½™å‚æ•°å€¼çš„æ•°ç»„  let result = Object.create(null) console.log(arguments.length) for (let i = 0; i \u0026lt; keys.length; i++) { result[keys[i]] = object[keys[i]] } return result } const book = { author: \u0026#39;xxx\u0026#39;, name: \u0026#39;yyy\u0026#39;, pages: 300 } const res = pick(book, \u0026#39;author\u0026#39;, \u0026#39;name\u0026#39;) console.log(JSON.stringify(res))   +RESULTS:\n3 {\u0026quot;author\u0026quot;:\u0026quot;xxx\u0026quot;,\u0026quot;name\u0026quot;:\u0026quot;yyy\u0026quot;}  åˆ©ç”¨ â€¦keys å°†ä¼ å…¥çš„ (\u0026lsquo;author\u0026rsquo;, \u0026lsquo;name\u0026rsquo;) åˆå¹¶æˆäº†ä¸€ä¸ªæ•°ç»„ï¼š ['author', 'name'] ï¼Œæ–¹ä¾¿åº”å¯¹\nå‡½æ•°å‚æ•°ä¸ªæ•°å¯å˜çš„æƒ…å†µã€‚\nå‚æ•°å±•å¼€ç¬¦ä¸¤ç§å¼‚å¸¸ä½¿ç”¨æƒ…å†µ   å±•å¼€ç¬¦å‚æ•°å¿…é¡»æ˜¯æœ€åä¸€ä¸ªï¼Œä¸èƒ½åœ¨å…¶åé¢è¿˜æœ‰å…¶ä»–å‚æ•°\næ¯”å¦‚ï¼š function add(n, ...vals, more) {} è¿™ä¼šå‡ºç°å¼‚å¸¸\n  ä¸èƒ½ç”¨åœ¨å¯¹è±¡çš„ setter å‡½æ•°ä¸Š\n  å®ä¾‹ï¼š\n1 2 3  const obj = { set name(...val) {} }   1 2 3  function add(n, ...vals, more) { }   å‚æ•°å±•å¼€ç¬¦å¯¹ arguments çš„å½±å“ è®°ä½ä¸€ç‚¹ï¼š\narguments æ€»æ˜¯ç”±å‡½æ•°è°ƒç”¨æ—¶ä¼ é€’è¿›æ¥çš„å‚æ•°å†³å®š\n1 2 3 4 5 6 7 8  function checkArgs(...args) { console.log(args.length); console.log(arguments.length); console.log(args[0], arguments[0]); console.log(args[1], arguments[1]); } checkArgs(\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;);   +RESULTS:\n2 2 a a b b  å‡½æ•°æ„é€ å‡½æ•°èƒ½åŠ›å¢å¼º åœ¨å®é™…ç¼–ç è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¾ˆå°‘ç›´æ¥ä½¿ç”¨ Function() æ„é€ å‡½æ•°å»åˆ›å»ºä¸€ä¸ªå‡½æ•°ã€‚\næ¯”å¦‚è¿™ä¹ˆä½¿ç”¨ï¼š\n1 2 3 4  // å‚æ•°ï¼šå‚æ•°ä¸€åç§° first, å‚æ•°äºŒåç§° secondï¼Œ... æœ€åä¸€ä¸ªæ˜¯å‡½æ•°ä½“ var add = new Function(\u0026#39;first\u0026#39;, \u0026#39;second\u0026#39;, \u0026#39;return first + second\u0026#39;) console.log(add(1, 2))   +RESULTS:\n3  åœ¨ es6 ä¸­å¯¹æ„é€ å‡½æ•°çš„ä½¿ç”¨èƒ½åŠ›å¢å¼ºäº†ï¼Œç»™å…¶èµ‹äºˆäº†æ›´å¤šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚\n é»˜è®¤å‚æ•°å€¼ å±•å¼€ç¬¦  1 2 3 4 5 6 7 8 9  var add = new Function(\u0026#34;first\u0026#34;, \u0026#34;second = first\u0026#34;, \u0026#34;return first + second\u0026#34;); console.log(add(1, 1)); // 2 console.log(add(1)); // 2  var pickFirst = new Function(\u0026#34;...args\u0026#34;, \u0026#34;return args[0]\u0026#34;); console.log(pickFirst(1, 2)); // 1   +RESULTS:\n2 2 1  å±•å¼€ç¬¦(â€¦) åœ¨ä¹‹å‰æˆ‘ä»¬åœ¨å‡½æ•°å‚æ•°ä¸­ç”¨åˆ°äº†å±•å¼€ç¬¦ï¼Œè¿™ä¸ªæ—¶å€™çš„ç”¨é€”æ˜¯å°†å‚æ•°åˆå¹¶æˆæ•°ç»„æ¥ç”¨ã€‚\næ™®é€šå‚æ•°ä¼ é€’ æˆ‘ä»¬ä¸€èˆ¬è°ƒç”¨å‡½æ•°çš„æ—¶å€™éƒ½æ˜¯å°†å‚æ•°é€ä¸ªä¼ é€’ï¼š\n1 2 3 4  let v1 = 20, v2 = 30 console.log(Math.max(v1, v2))   +RESULTS:\n30  è¿™ä»…ä»…ä¸¤ä¸ªå‚æ•°ï¼Œæ¯”è¾ƒå¥½ä¹¦å†™ï¼Œä¸€æ—¦å‚æ•°å¤šäº†èµ·æ¥å°±æ¯”è¾ƒéº»çƒ¦ï¼Œåœ¨ es6 ä¹‹å‰çš„åšæ³•å¯ä»¥åˆ©ç”¨ Function.prototype.apply å»å®ç°ï¼š\napply ä¼ é€’å¤šä¸ªå‚æ•° 1 2 3  let vs = [1, 2, 3, 4, 5] console.log(Math.max.apply(Math, vs))   +RESULTS:\n5  å› ä¸º apply ä¼šå°†æ•°ç»„è¿›è¡Œå±•å¼€ä½œä¸ºå‡½æ•°çš„å‚æ•°ä¼ é€’ä¸ªè°ƒç”¨å®ƒçš„å‡½æ•°ã€‚\nes6 ä¹‹åå±•å¼€ç¬¦ä¼ é€’ åœ¨ es6 ä¹‹åæˆ‘ä»¬å°†ä½¿ç”¨å±•å¼€ç¬¦å»å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè®©ä»£ç æ›´ç®€æ´å’Œä¾¿äºç†è§£ã€‚\n1 2 3  let vs = [1, 2, 3, 4] console.log(Math.max(...vs))   +RESULTS:\n4  å±•å¼€ç¬¦ï¼Œä¼ ç»Ÿæ–¹å¼ç›¸ç»“åˆ 1 2 3 4 5  let vs = [1, 2, 3, 4] console.log(Math.max(10, ...vs)) // 10 console.log(Math.max(...vs, 0)) // 4 console.log(Math.max(3, ...vs, 10)) // 10   +RESULTS:\n10 4 10  å‡½æ•°åå­—å±æ€§ ä»¥å¾€ï¼Œç”±äºå‡½æ•°çš„å„ç§ä½¿ç”¨æ–¹å¼ä½¿ JavaScript åœ¨è¯†åˆ«å‡½æ•°çš„æ—¶å€™æˆä¸ºä¸€ç§æŒ‘æˆ˜ï¼Œå¹¶ä¸”\nåŒ¿åå‡½æ•°çš„é¢‘ç¹ä½¿ç”¨ä½¿å¾—ç¨‹åºçš„ debugging è¿‡ç¨‹å¼‚å¸¸ç—›è‹¦ï¼Œç»å¸¸é€ æˆè¿½è¸ªæ ˆå¾ˆéš¾ç†è§£ã€‚\nå› æ­¤åœ¨ es6 ä¸­ç»™æ‰€æœ‰å‡½æ•°æ·»åŠ äº†ä¸€ä¸ª name å±æ€§ã€‚\n name å±æ€§åªæ˜¯å¯¹å‡½æ•°çš„ä¸€ç§æè¿°ç‰¹æ€§ï¼Œå¹¶ä¸ä¼šæœ‰å®é™…çš„å¼•ç”¨ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´\nåœ¨å®é™…ç¼–ç¨‹ä¸­ä¸å¯èƒ½é€šè¿‡å‡½æ•°çš„ name å±æ€§å»å¹²ç‚¹å•¥ã€‚\n é€‰æ‹©åˆé€‚çš„åç§° JavaScript ä¼šæ ¹æ®å‡½æ•°çš„å£°æ˜æ–¹å¼å»ç»™å…¶é€‰æ‹©åˆé€‚çš„åç§°ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function doSomething() { // ... } var doAnotherThing = function() { // ... }; var doThirdThing = function do3rdThing() { } console.log(doSomething.name); // \u0026#34;doSomething\u0026#34; console.log(doAnotherThing.name); // \u0026#34;doAnotherThing\u0026#34; console.log(doThirdThing.name); // \u0026#34;do3rdThing\u0026#34;   +RESULTS:\ndoSomething doAnotherThing do3rdThing    å¦‚æœæ˜¯å‘½åå‡½æ•°å¼å£°æ˜æ–¹å¼ï¼Œåˆ™ä½¿ç”¨çš„å°±æ˜¯å®ƒçš„åå­—ä½œä¸º name å±æ€§å€¼ï¼Œå¦‚ï¼š doSomething\n  å¦‚æœæ˜¯è¡¨è¾¾å¼åŒ¿åæ–¹å¼å£°æ˜å‡½æ•°ï¼Œåˆ™å°†ä½¿ç”¨è¡¨è¾¾å¼ä¸­å·¦è¾¹çš„å˜é‡åç§°æ¥ä½œä¸º name å±æ€§å€¼ï¼Œå¦‚ï¼š doAnotherThing\n  è¡¨è¾¾å¼å‘½åæ–¹å¼å£°æ˜å‡½æ•°ï¼Œåˆ™å°†ä½¿ç”¨å‘½åå‡½æ•°çš„åç§°ä½œä¸º name å±æ€§ï¼Œå¦‚ï¼š doThridThing çš„åå­—æ˜¯ï¼š do3rdThing\n   é€šè¿‡ç¬¬ä¸‰ä¸ªè¾“å‡ºå¯çŸ¥ï¼Œå‘½åå‡½æ•°çš„ä¼˜å…ˆçº§é«˜äºè¡¨è¾¾å¼çš„å˜é‡åã€‚\n name å±æ€§çš„ç‰¹æ®Šæƒ…å†µ  å¯¹è±¡çš„å‡½æ•°åç§°ï¼Œå³è¯¥å‡½æ•°çš„åå­— å¯¹è±¡çš„è®¿é—®å™¨å‡½æ•°åç§°ï¼Œé€šè¿‡ Object.getOwnPropertyDescriptor(obj, 'keyname') è·å–è®¿é—®å™¨å¯¹è±¡ è°ƒç”¨ bind() ä¹‹åçš„å‡½æ•°åç§°ï¼Œæ€»æ˜¯åœ¨åŸå§‹å‡½æ•°åå‰åŠ ä¸Š bound ä½¿ç”¨ new Function() åˆ›å»ºçš„å‡½æ•°åç§°ï¼Œæ€»æ˜¯è¿”å› anonymous  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  var doSth = function() {} var person = { get firstName() { return \u0026#39;Nicholas\u0026#39; }, sayName: function() { console.log(this.name) } } console.log(person.sayName.name) // sayName // è®¿é—®å™¨å±æ€§ï¼Œåªèƒ½é€šè¿‡ getOwnPropertyDescriptor å»è·å– var descriptor = Object.getOwnPropertyDescriptor(person, \u0026#39;firstName\u0026#39;) console.log(descriptor.get.name) // get firstName  // è°ƒç”¨ bind ä¹‹åçš„å‡½æ•°åç§°æ€»æ˜¯ä¼šåœ¨åŸå§‹çš„å‡½æ•°åç§°ä¹‹å‰åŠ ä¸Š `bound fname` console.log(doSth.bind().name) // bound doSth console.log((new Function()).name) // anonymous   +RESULTS:\nsayName get firstName bound doSth anonymous  æ¾„æ¸…å‡½æ•°åŒé‡ç›®çš„ å‡½æ•°ä½¿ç”¨æ–¹å¼   ç›´æ¥è°ƒç”¨ï¼Œå½“åšå‡½æ•°æ¥ä½¿ç”¨ Person()\n  ä½¿ç”¨ new çš„æ—¶å€™å½“åšæ„é€ å‡½æ•°æ¥ä½¿ç”¨åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡\n  åœ¨ es6 ä¹‹åä¸ºäº†ææ¸…æ¥šè¿™ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œæ·»åŠ äº†ä¸¤ä¸ªå†…ç½®å±æ€§ï¼š [[Call]] å’Œ [[Constructor]]\nå½“å½“åšå‡½æ•°ç›´æ¥è°ƒç”¨æ—¶ï¼Œå…¶å®å†…éƒ¨æ˜¯è°ƒç”¨äº† [[Call]] æ‰§è¡Œäº†å‡½æ•°ä½“ï¼Œ\nå½“ç»“åˆ new æ¥ä½¿ç”¨æ˜¯ï¼Œè°ƒç”¨çš„æ˜¯ [[Contructor]] æ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤ï¼š\n  åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ newObj\n  å°† this ç»‘å®šåˆ° newObj\n  å°† newObj å¯¹è±¡è¿”å›ä½œä¸ºè¯¥æ„é€ å‡½æ•°çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡\n  ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­å»æ”¹å˜å®ƒçš„è¡Œä¸ºï¼Œå¦‚æœå®ƒæ²¡æœ‰æ˜¾ç¤ºçš„ return ä¸€ä¸ªåˆ\næ³•çš„å¯¹è±¡ï¼Œåˆ™ä¼šé»˜è®¤èµ° #3 æ­¥ï¼Œå¦‚æœæˆ‘ä»¬æ˜¾ç¤ºçš„å»è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆæœ€åå¾—åˆ°çš„å®\nä¾‹å¯¹è±¡å³è¿™ä¸ªæ˜¾ç¤ºè¿”å›çš„å¯¹è±¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  function Person1(name) { this.name = name || \u0026#39;xxx\u0026#39; } // æ²¡æœ‰æ˜¾ç¤ºçš„ return ä¸€ä¸ªåˆæ³•å¯¹è±¡ // è¿”å›çš„æ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œå¹¶ä¸” this è¢«ç»‘å®šåˆ°è¿™ä¸ªå¿ƒå¯¹è±¡ä¸Š const p1 = new Person1(\u0026#39;å¼ ä¸‰\u0026#39;) // å› æ­¤è¿™é‡Œè®¿é—®çš„ name å³æ„é€ å‡½æ•°ä¸­çš„ this.name console.log(p1.name) function Person2(name) { this.name = name || \u0026#39;xxx\u0026#39; return { name: \u0026#39;æå››\u0026#39; } } // æŒ‰ç…§æ„é€ å‡½æ•°çš„ä½¿ç”¨å®šä¹‰ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯ // æ˜¾ç¤º return çš„é‚£ä¸ªå¯¹è±¡ï¼š { name: \u0026#39;æå››\u0026#39; } const p2 = new Person2(\u0026#39;å¼ ä¸‰\u0026#39;) // å› æ­¤è¿™é‡Œè¾“å‡ºçš„ç»“æœä¸ºï¼šæå›› console.log(p2.name)   +RESULTS:\nå¼ ä¸‰ æå››   å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‡½æ•°éƒ½æœ‰ [[Constructor]] ï¼Œæ¯”å¦‚ç®­å¤´å‡½æ•°å°±æ²¡æœ‰ï¼Œå› æ­¤ç®­å¤´å‡½æ•°\nä¹Ÿå°±ä¸èƒ½è¢«ç”¨æ¥ new å¯¹è±¡å®ä¾‹ã€‚\n åˆ¤æ–­å‡½æ•°è¢«å¦‚ä½•ä½¿ç”¨ï¼Ÿ æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦çŸ¥é“å‡½æ•°æ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„ï¼Œæ˜¯å½“åšæ„é€ å‡½æ•°ï¼Ÿè¿˜æ˜¯å•çº¯å½“åšå‡½æ•°ç›´æ¥è°ƒç”¨ï¼Ÿ\nè¿™ä¸ªæ—¶å€™ instanceof å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç”¨æ¥æ£€æµ‹ä¸€ä¸ªå¯¹è±¡æ˜¯å¦åœ¨å½“å‰å¯¹è±¡çš„\nåŸå‹é“¾ä¸Šå‡ºç°è¿‡ã€‚\næ¯”å¦‚ï¼šåœ¨ es5 ä¸­å¼ºåˆ¶ä¸€ä¸ªå‡½æ•°åªèƒ½å½“åšæ„é€ å‡½æ•°æ¥ä½¿ç”¨ï¼Œä¸€èˆ¬è¿™ä¹ˆåš\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function Person(name) { if (this instanceof Person) { this.name = name } else { throw new Error(\u0026#39;å¿…é¡»ä½¿ç”¨ new æ¥åˆ›å»ºå®ä¾‹å¯¹è±¡ã€‚\u0026#39;) } } var person = new Person(\u0026#39;å¼ ä¸‰\u0026#39;) // è¿™ç§è°ƒç”¨ï¼Œå†…éƒ¨çš„ `this` è¢«ç»‘å®šåˆ°äº†å…¨å±€å¯¹è±¡ // è€Œå…¨å±€å¯¹è±¡å¹¶é Person åŸå‹é“¾ä¸Šçš„å¯¹è±¡ï¼Œå› æ­¤ä¼š // æ‰§è¡Œ else æŠ›å‡ºå¼‚å¸¸ var notAPerson = Person(\u0026#39;æå››\u0026#39;)   ä½†æ˜¯æœ‰ä¸€ç§ç›´æ¥è°ƒç”¨çš„æƒ…å†µï¼Œä¸ä¼šèµ° else ï¼Œå³é€šè¿‡ call è°ƒç”¨æŒ‡å®š person å®\nä¾‹ä¸ºè°ƒç”¨å…ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function Person(name) { if (this instanceof Person) { this.name = name } else { throw new Error(\u0026#39;å¿…é¡»ä½¿ç”¨ new æ¥åˆ›å»ºå®ä¾‹å¯¹è±¡ã€‚\u0026#39;) } } var person = new Person(\u0026#39;å¼ ä¸‰\u0026#39;) // è¿™æ ·æ˜¯åˆæ³•çš„ï¼Œè¯· this instanceof Person æˆç«‹ // å› ä¸º Person.call(person, ...) æŒ‡å®šäº†ä½œç”¨åŸŸä¸ºå®ä¾‹å¯¹è±¡ person // å› æ­¤å‡½æ•°å†…éƒ¨çš„ this ä¼šè¢«ç»‘å®šåˆ°è¿™ä¸ªå®ä¾‹å¯¹è±¡ person ä¸Šï¼Œ // è€Œ person ç¡®å®æ˜¯ Person çš„å®ä¾‹å¯¹è±¡ï¼Œå› æ­¤ä¸ä¼šæŠ¥é”™ var notAPerson = Person.call(person, \u0026#39;æå››\u0026#39;)   æ­£å¸¸è¿è¡Œçš„ç»“æœ\n+RESULTS:\nundefined  å› æ­¤ï¼Œå¦‚æœæ˜¯ Person.call(person, ...) è¿™ç§æƒ…å†µè°ƒç”¨ï¼Œå‡½æ•°å†…éƒ¨åŒæ ·æ— æ³•åˆ¤æ–­å®ƒçš„è¢«ä½¿ç”¨æ–¹å¼æ˜¯å¦‚ä½•ã€‚\nnew.target å…ƒå±æ€§ ä¸ºäº†è§£å†³ä¸Šä¸€èŠ‚çš„â€œå‡½æ•°è°ƒç”¨æ–¹å¼â€åˆ¤æ–­çš„é—®é¢˜ï¼Œ es6 ä¸­å¼•å…¥äº† new.target å…ƒå±æ€§ã€‚\n å…ƒå±æ€§ï¼šä¸€ä¸ªéå¯¹è±¡çš„å±æ€§ï¼Œç”¨æ¥ä¸ºä»–çš„ç›®æ ‡ï¼ˆæ¯”å¦‚ï¼š new )æä¾›é¢å¤–çš„ç›¸å…³ä¿¡æ¯ã€‚\n new.target çš„å–å€¼ï¼Ÿï¼Ÿ\n  å¦‚æœå‡½æ•°å½“åšæ„é€ å‡½æ•°\nä½¿ç”¨ new æ¥è°ƒç”¨ï¼Œå†…éƒ¨è°ƒç”¨ [[Constructor]] çš„æ—¶å€™ï¼Œ new.target ä¼šè¢«å¡«å……\nä¸º new æ“ä½œç¬¦æŒ‡å®šçš„ç›®æ ‡å¯¹è±¡ï¼Œè¿™ä¸ªç›®æ ‡å¯¹è±¡é€šå¸¸æ˜¯æ‰§è¡Œå†…éƒ¨æ„é€ å‡½æ•°çš„æ—¶å€™æ–°\nåˆ›å»ºçš„é‚£ä¸ªå¯¹è±¡å®ä¾‹(åœ¨å‡½æ•°ä½“é‡ä¸€èˆ¬æ˜¯ this ï¼‰ã€‚\n  å¦‚æœå‡½æ•°å½“åšæ™®é€šå‡½æ•°ç›´æ¥è°ƒç”¨ï¼Œé‚£ä¹ˆ new.target çš„å€¼ä¸º undefined\n  ä»ä¸Šé¢ä¸¤ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åœ¨å‡½æ•°å†…éƒ¨åˆ¤æ–­ new.target æ¥åˆ¤æ–­å‡½æ•°çš„ä½¿ç”¨æ–¹\nå¼äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  function Person(name) { if (typeof new.target !== \u0026#39;undefined\u0026#39;) { this.name = name } else { throw new Error(\u0026#39;å¿…é¡»ä½¿ç”¨ new åˆ›å»ºå®ä¾‹ã€‚\u0026#39;) } } var person = new Person(\u0026#39;å¼ ä¸‰\u0026#39;) console.log(person.name, \u0026#39;new\u0026#39;) var notAPerson = Person.call(person, \u0026#39;æå››\u0026#39;) console.log(notAPerson.name, \u0026#39;call\u0026#39;)   ç”±å›¾ä¸­çš„è¾“å‡ºè¯æ˜ä¸Šé¢ #1 å’Œ #2 çš„ç»“è®ºï¼Œä¹Ÿç”±æ­¤ç»“è®ºæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ new.target === Person ä½œä¸ºåˆ¤å®šæ¡ä»¶ã€‚\nå‡½æ•°å¤–éƒ¨ä½¿ç”¨ new.target :\n1 2 3 4 5 6 7 8  function Person() { } if (new.target === Person) { // ... } console.log(new.target)   å—çº§å‡½æ•° \u0026lt;= es3 è¡Œä¸º åœ¨ es3 æˆ–æ›´æ—©äº›æ—¶å€™ï¼Œåœ¨å—çº§ä½œç”¨åŸŸä¸­å£°æ˜å‡½æ•°ä¼šå‡ºç°è¯­æ³•é”™è¯¯ï¼Œè™½ç„¶åœ¨ä¹‹åé»˜è®¤å…\nè®¸è¿™æ ·ä½¿ç”¨ï¼ˆä¸ä¼šæŠ¥é”™äº†ï¼‰ï¼Œä½†æ˜¯å„ä¸ªæµè§ˆå™¨ä¹‹é—´çš„å¤„ç†æ–¹å¼ä¾æ—§ä¸åŒï¼Œå› æ­¤åœ¨å®é™…å¼€\nå‘è¿‡ç¨‹ä¸­ï¼Œåº”è¯¥å°½é‡é¿å…è¿™ä¹ˆä½¿ç”¨ï¼Œå¦‚æœéè¦åœ¨å—çº§ä½œç”¨åŸŸå£°æ˜å‡½æ•°å¯ä»¥è€ƒè™‘ä½¿ç”¨å‡½æ•°\nè¡¨è¾¾å¼æ–¹å¼ã€‚\nes5 è¡Œä¸º å¦å¤–ï¼Œä¸ºäº†å°è¯•å»å…¼å®¹è¿™ç§æ€ªå¼‚æƒ…å†µï¼Œåœ¨ es5 çš„ä¸¥æ ¼æ¨¡å¼ä¸‹å¦‚æœåœ¨å—çº§ä½œç”¨åŸŸå£°æ˜å‡½\næ•°ï¼Œä¼šçˆ†å‡ºå¼‚å¸¸ã€‚\n1 2 3 4 5 6  \u0026#39;use strict\u0026#39;; if (true) { // åœ¨ es5 ä¸­ä¼šæŠ¥è¯­æ³•é”™è¯¯ï¼Œ es6 ä¸­ä¸ä¼š  function doSth() {} }   es6 è¡Œä¸º åœ¨ es6 ä¹‹åï¼Œè¿™ç§å‡½æ•°å£°æ˜å°†ä¼šå˜çš„åˆæ³•ï¼Œä¸”å£°æ˜ä¹‹å doSth() å°±æˆäº†ä¸€ä¸ªå±€éƒ¨å‡½\næ•°å˜é‡ï¼Œå³åªèƒ½åœ¨ if (true) { ... } è¿™ä¸ªä½œç”¨åŸŸå†…éƒ¨è®¿é—®ï¼Œå¤–éƒ¨æ— æ³•è®¿é—®ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  \u0026#39;use strict\u0026#39;; if (true) { // å› ä¸ºæœ‰æå‡ï¼Œä¸”å‘½åå‡½æ•°çš„æå‡åŒ…å«å£°æ˜å’Œå®šä¹‰éƒ½ä¼šè¢«æå‡  console.log(typeof doSth) // function  function doSth() {} doSth() } // es6 ä¹‹åå­˜åœ¨å—çº§ä½œç”¨åŸŸï¼Œå› æ­¤ doSth æ˜¯ä¸ªå±€éƒ¨å˜é‡ï¼Œåœ¨ // å®ƒçš„ä½œç”¨åŸŸèŒƒå›´ä¹‹å¤–æ— æ³•è®¿é—® console.log(typeof doSth); // undefined   +RESULTS:\nfunction undefined  å†³å®šä»€ä¹ˆæ—¶å€™è¯¥ç”¨å—çº§å‡½æ•° åœ¨ 4.7.3 ä¸€èŠ‚ä¸­ä½¿ç”¨çš„æ˜¯å‘½åå¼å‡½æ•°å£°æ˜æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å£°æ˜å’Œå®šä¹‰å‡è¢«æå‡ï¼Œ\nå› æ­¤åœ¨å£°æ˜å¤„è‡³ä¸Šè®¿é—®èƒ½å¾—åˆ°æ­£å¸¸ç»“æœã€‚\nå¦‚æœä½¿ç”¨è¡¨è¾¾å¼ + let æ–¹å¼ï¼Œåˆ™ç»“æœä¼šå’Œç”¨ let å£°æ˜ä¸€æ ·å­˜åœ¨ TDZ çš„é—®é¢˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  \u0026#39;use strict\u0026#39;; if (true) { // TDZ åŒºåŸŸï¼Œè®¿é—®ä¼šå¼‚å¸¸  console.log(typeof doSth) // error  let doSth = function () {} doSth() } console.log(typeof doSth) // undefined   å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€æ±‚å»å†³å®šè¯¥ä½¿ç”¨å“ªç§æ–¹å¼å»å£°æ˜å—çº§å‡½æ•°ï¼Œå¦‚æœéœ€è¦æœ‰æå‡åˆ™åº”\nè¯¥ä½¿ç”¨â€œå‘½åå¼å‡½æ•°â€ï¼Œå¦‚æœä¸éœ€è¦æå‡ï¼Œåªéœ€è¦åœ¨å£°æ˜ä¹‹åçš„èŒƒå›´ä½¿ç”¨åº”è¯¥ä½¿ç”¨â€œå‡½æ•°\nè¡¨è¾¾å¼â€æ–¹å¼å»å£°æ˜å‡½æ•°ã€‚\néä¸¥æ ¼æ¨¡å¼å—çº§å‡½æ•° åœ¨ es6 ä¸­çš„éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œå—çº§å‡½æ•°çš„æå‡ä¸å†æ˜¯é’ˆå¯¹å—çº§ä½œç”¨åŸŸï¼Œè€Œæ˜¯å‡½æ•°ä½“æˆ–å…¨\nå±€ç¯å¢ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  // ç›¸å½“äºæå‡åˆ°äº†è¿™é‡Œ  if (true) { console.log(typeof doSth) // éä¸¥æ ¼æ¨¡å¼ï¼Œå…¨å±€æå‡  function doSth() {} doSth() } console.log(typeof doSth) // function   +RESULTS:\nfunction function  ç»“æœæ˜¾ç¤ºå¤–é¢çš„ typeof doSth ä¹Ÿæ˜¯ \u0026lsquo;function\u0026rsquo; ã€‚\nå› æ­¤ï¼Œåœ¨ es6 ä¹‹åå‡½æ•°çš„å£°æ˜åªéœ€è¦åŒºåˆ†ä¸¥æ ¼æˆ–éä¸¥æ ¼æ¨¡å¼ï¼Œè€Œä¸å†éœ€è¦è€ƒè™‘æµè§ˆå™¨\nçš„å…¼å®¹é—®é¢˜ï¼Œç›¸å½“äºç»Ÿä¸€äº†æ ‡å‡†ã€‚\nç®­å¤´å‡½æ•° ç®­å¤´å‡½æ•°ç‰¹æ€§ åœ¨ es6 ä¸­å¼•å…¥äº†ç®­å¤´å‡½æ•°ï¼Œå¤§å¤§çš„ç®€åŒ–äº†å‡½æ•°çš„ä¹¦å†™ï¼Œæ¯”å¦‚\nå£°æ˜ä¸€ä¸ªå‡½æ•°ï¼š function run() {}\nç°åœ¨ï¼š const run = () =\u0026gt; {} æˆ–è€… const getName = () =\u0026gt; 'å¼ ä¸‰'\nè™½ç„¶ç”¨èµ·æ¥æ–¹ä¾¿äº†ï¼Œä½†æ˜¯ç®­å¤´å‡½æ•°ä¸æ™®é€šå‡½æ•°åˆå¾ˆå¤§çš„ä¸åŒï¼Œä½¿ç”¨çš„æ—¶å€™å¿…é¡»è¦æ³¨æ„ä»¥\nä¸‹å‡ ç‚¹ï¼š\n   åº ç‰¹æ€§ è¯´æ˜     1 æ—  this å‡å°‘é—®é¢˜ï¼Œä¾¿äºä¼˜åŒ–   2 æ—  super    3 æ—  arguments ç®­å¤´å‡½æ•°å¿…é¡»ä¾èµ–å‘½åå‚æ•°æˆ– rest å‚æ•°å»è®¿é—®å‡½æ•°çš„å‚æ•°åˆ—è¡¨   4 æ—  new.target å…ƒå±æ€§ ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼ŒåŠŸèƒ½æ— æ­§ä¹‰ï¼Œä¸éœ€è¦è¿™ä¸ªå±æ€§   5 ä¸èƒ½ new å®ä¾‹åŒ–    6 æ— åŸå‹ å› ä¸ºä¸èƒ½ç”¨ new å› æ­¤ä¹Ÿä¸éœ€è¦åŸå‹   7 ä¸èƒ½æ”¹å˜ this æŒ‡å‘ æ­¤æ—¶æŒ‡å‘ä¸å†å—å‡½æ•°æœ¬èº«é™åˆ¶   8 ä¸èƒ½æœ‰é‡å¤çš„å‘½åå‚æ•° ä¹‹å‰éä¸¥æ ¼æ¨¡å¼ä¸‹æ™®é€šå‡½æ•°æ˜¯å¯ä»¥æœ‰çš„     ç®­å¤´å‡½æ•°ä¸­å¦‚æœå¼•ç”¨ arguments ï¼Œå®ƒæŒ‡å‘çš„ä¸å†æ˜¯è¯¥ç®­å¤´å‡½æ•°çš„å‚æ•°åˆ—è¡¨ï¼Œ\nè€Œæ˜¯åŒ…å«è¯¥ç®­å¤´å‡½æ•°çš„é‚£ä¸ªéç®­å¤´å‡½æ•°çš„å‚æ•°åˆ—è¡¨(4.8.6)ã€‚\n æ²¡æœ‰ this ç»‘å®šä¸»è¦æœ‰ä¸¤ç‚¹ç†ç”±ï¼š\n  ä¸æ˜“è¿½è¸ªï¼Œæ˜“é€ æˆæœªçŸ¥è¡Œä¸ºï¼Œä¼—å¤šé”™è¯¯æ¥æº\nå‡½æ•°å†…éƒ¨ this çš„å€¼éå¸¸ä¸å®¹æ˜“è¿½è¸ªï¼Œç»å¸¸ä¼šé€ æˆæœªçŸ¥çš„å‡½æ•°è¡Œä¸ºï¼Œç®­å¤´å‡½æ•°å»\næ‰å®ƒå¯ä»¥é¿å…è¿™äº›çƒ¦æ¼\n  ä¾¿äºå¼•æ“ä¼˜åŒ–\né™åˆ¶ç®­å¤´å‡½æ•°å†…éƒ¨ä½¿ç”¨ this å»æ‰§è¡Œä»£ç ä¹Ÿæœ‰åˆ©äº JavaScript å¼•æ“æ›´å®¹æ˜“å»ä¼˜\nåŒ–å†…éƒ¨æ“ä½œï¼Œè€Œä¸åƒæ™®é€šå‡½æ•°ä¸€æ ·ï¼Œå‡½æ•°æœ‰å¯èƒ½ä¼šå½“åšæ„é€ å‡½æ•°ä½¿ç”¨æˆ–å…¶ä»–ç”¨é€”ã€‚\n   åŒæ ·ï¼Œç®­å¤´å‡½æ•°ä¹Ÿæœ‰è‡ªå·±çš„ name å±æ€§ï¼Œç”¨æ¥æè¿°å‡½æ•°çš„åç§°ç‰¹å¾ã€‚\n 1 2 3 4 5 6 7 8 9  const print = msg =\u0026gt; { console.log(arguments.length, \u0026#39;arguments\u0026#39;) console.log(this, \u0026#39;this\u0026#39;) console.log(msg) } console.log(print.name) print(\u0026#39;...end\u0026#39;)   +RESULTS:\nprint 0 'arguments' Object [global] { // ... çœç•¥ { [Function: setImmediate] [Symbol(util.promisify.custom)]: [Function] } } 'this' ...end undefined  å› ä¸ºæ˜¯ nodejs ç¯å¢ƒï¼Œå› æ­¤ this è¢«ç»‘å®šåˆ°äº† global å¯¹è±¡ä¸Šã€‚\nç¬¬äºŒè¡Œè¾“å‡ºç»“æœæ˜¯ 0 'arguments' è¯´æ˜å·²ç»ä¸èƒ½ä½¿ç”¨ arguments å»æ­£ç¡®è·å–ä¼ å…¥\nçš„å‚æ•°äº†ã€‚\nç®­å¤´å‡½æ•°è¯­æ³• ç®­å¤´å‡½æ•°è¯­æ³•éå¸¸çµæ´»ï¼Œå…·ä½“å¦‚ä½•ä½¿ç”¨æ ¹æ®ä½¿ç”¨åœºæ™¯å’Œå®é™…æƒ…å†µå†³å®šã€‚\næ¯”å¦‚ï¼š\nvar reflect = value =\u0026gt; value; ç›´æ¥è¿”å›åŸå€¼\nç›¸å½“äº\nvar reflect = function(value) { return value; }\nå½“åªæœ‰ä¸€ä¸ªå‚æ•°æ—¶åˆ»çœç•¥å°æ‹¬å· ()\nå¤šä¸ªå‚æ•°æ—¶å€™ï¼š\nvar sum = (n1, n2) =\u0026gt; n1 + n2;\nå‡½æ•°ä½“æ›´å¤šå†…å®¹æ—¶å€™ï¼š\n1 2 3 4  var sum = (n1, n2) =\u0026gt; { // do more...  return n1 + n2; }   ç©ºå‡½æ•°ï¼š\nvar empty = () =\u0026gt; {}\nè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼š\nvar getTempItem = id =\u0026gt; ({ id: id, name: 'Temp' })\nç­‰ç­‰ã€‚ã€‚ã€‚\nç®­å¤´ç«‹å³å‡½æ•°è¡¨è¾¾å¼ åœ¨ es6 ä¹‹å‰æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œä¸€èˆ¬è¿™æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10  let person = function(name) { return { getName: function() { return name } } // ç›´æ¥åœ¨å‡½æ•°åé¢åŠ ä¸Šå°æ‹¬å·å³æˆä¸ºç«‹å³æ‰§è¡Œå‡½æ•° }(\u0026#39;å¼ ä¸‰\u0026#39;) console.log(person.getName()) // å¼ ä¸‰   +RESULTS:\nå¼ ä¸‰  PS: ä½†æ˜¯ä¸ºäº†ä»£ç å¯è¯»æ€§ï¼Œå»ºè®®ç»™å‡½æ•°åŠ ä¸Šå°æ‹¬å·ã€‚\nç®­å¤´å‡½æ•°å½¢å¼çš„ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œä¸å¯ä»¥ç›´æ¥åœ¨ } åé¢ä½¿ç”¨å°æ‹¬å·æ–¹å¼ï¼š\n1 2 3 4 5 6 7 8 9 10  let person = ((name) =\u0026gt; { return { getName: function() { return name } } })(\u0026#39;å¼ ä¸‰\u0026#39;) console.log(person.getName()) // å¼ ä¸‰   +RESULTS:\nå¼ ä¸‰  æ²¡æœ‰ this å¯¹è±¡ åœ¨ä¹‹å‰æˆ‘ä»¬ç»å¸¸é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜å†™æ³•æ˜¯äº‹ä»¶çš„ç›‘å¬å›è°ƒå‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ this ï¼Œè¿™å°†\nå¯¼è‡´å¼•ç”¨é”™è¯¯é—®é¢˜ï¼Œå› ä¸ºäº‹ä»¶çš„å›è°ƒå±äºè¢«åŠ¨è§¦å‘çš„ï¼Œè€Œè§¦å‘è°ƒç”¨è¯¥å›è°ƒçš„å¯¹è±¡æ˜¯ä¸ç¡®\nå®šçš„ï¼Œè¿™å°±ä¼šå¯¼è‡´å„ç§é—®é¢˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  var PageHandler = { id: \u0026#34;123456\u0026#34;, init: function() { document.addEventListener(\u0026#34;click\u0026#34;, function(event) { // è¿™é‡Œç”¨äº† this ï¼Œæ„å›¾æ˜¯æƒ³åœ¨ç‚¹å‡»äº‹ä»¶è§¦å‘çš„æ—¶å€™å»è°ƒç”¨ PageHandler çš„  // doSomething è¿™ä¸ªå‡½æ•°ï¼Œä½†å®é™…å´æ˜¯äº‹ä¸æ„¿è¿çš„  // å› ä¸ºè¿™é‡Œçš„ this å¹¶éæŒ‡å‘ Pagehandler è€Œæ˜¯äº‹ä»¶è§¦å‘è°ƒç”¨å›è°ƒæ—¶å€™çš„é‚£ä¸ªç›®æ ‡å¯¹è±¡  this.doSomething(event.type); // error  }, false); }, doSomething: function(type) { console.log(\u0026#34;Handling \u0026#34; + type + \u0026#34; for \u0026#34; + this.id); } };   ä»¥å¾€è§£å†³æ–¹æ³•ï¼šé€šè¿‡ bind(this) æ‰‹åŠ¨æŒ‡å®šå‡½æ•°è°ƒç”¨å¯¹è±¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  var PageHandler = { id: \u0026#34;123456\u0026#34;, init: function() { // ç»è¿‡ bind ä¹‹åï¼Œå›è°ƒå‡½æ•°çš„è°ƒç”¨ä¸Šä¸‹æ–‡å°±è¢«ç»‘å®šåˆ°äº† PageHandler è¿™ä¸ªå¯¹è±¡  // çœŸæ­£ç»‘å®šåˆ° click äº‹ä»¶çš„å‡½æ•°å…¶å®æ˜¯æ‰§è¡Œ bind(this) ä¹‹åç»‘å®šäº†ä¸Šä¸‹æ–‡çš„ä¸€ä¸ªå‡½æ•°å‰¯æœ¬  // ä»è€Œæ‰§è¡Œèƒ½å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœ  document.addEventListener(\u0026#34;click\u0026#34;, (function(event) { this.doSomething(event.type); // no error  }).bind(this), false); }, doSomething: function(type) { console.log(\u0026#34;Handling \u0026#34; + type + \u0026#34; for \u0026#34; + this.id); } };   è™½ç„¶é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯ä½¿ç”¨ bind(this) æ— ç–‘å¤šåˆ›å»ºäº†ä¸€ä»½å‡½æ•°å‰¯æœ¬ï¼Œå¤šå°‘éƒ½ä¼šæœ‰\näº›å¥‡æ€ªã€‚\nç„¶åï¼Œåœ¨ es6 ä¹‹åè¿™ä¸ªé—®é¢˜å°±å¾ˆå¥½çš„è¢«ç®­å¤´å‡½æ•°è§£å†³æ‰ï¼š\næ ¹æ®ç®­å¤´å‡½æ•°æ²¡æœ‰ this ç»‘å®šçš„ç‰¹æ€§ï¼Œåœ¨å…¶å†…éƒ¨ä½¿ç”¨ this çš„æ—¶å€™è¿™ä¸ªæŒ‡å‘å°†æ˜¯åŒ…\nå«è¯¥ç®­å¤´å‡½æ•°çš„éç®­å¤´å‡½æ•°æ‰€åœ¨çš„ä¸Šä¸‹æ–‡ï¼Œå³ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  var PageHandler = { id: \u0026#34;123456\u0026#34;, init: function() { document.addEventListener( \u0026#34;click\u0026#34;, // ç®­å¤´å‡½æ•°æ—  this ç»‘å®šï¼Œå†…éƒ¨ä½¿ç”¨ this  // è¿™ä¸ª this çš„ä¸Šä¸‹æ–‡å°†æœ‰åŒ…å«è¯¥ç®­å¤´å‡½æ•°çš„ä¸Šä¸€ä¸ªéç®­å¤´å‡½æ•°  // è¿™é‡Œå³ init() å‡½æ•°ï¼Œè€Œ init() å‡½æ•°çš„ä¸Šä¸‹æ–‡ä¸º PageHandler å¯¹è±¡  // ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œç®­å¤´å‡½æ•°å†…éƒ¨çš„ this æŒ‡å‘çš„å°±æ˜¯ Pagehandler è¿™ä¸ªå¯¹è±¡  // ä»è€Œè®©ä»£ç æŒ‰ç…§é¢„æœŸè¿è¡Œ  event =\u0026gt; this.doSomething(event.type), false); }, doSomething: function(type) { console.log(\u0026#34;Handling \u0026#34; + type + \u0026#34; for \u0026#34; + this.id); } };   ç®­å¤´å‡½æ•°å’Œæ•°ç»„ åœ¨ä½¿ç”¨æ•°ç»„çš„ä¸€äº›å†…ç½®å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç¢°åˆ°éœ€è¦ä¼ é€’ä¸€ä¸ªå‚è€ƒå‡½æ•°ç»™ä»–ä»¬ï¼Œæ¯”å¦‚ï¼Œ\næ’åºå‡½æ•° Array.prototype.sort å°±éœ€è¦æˆ‘ä»¬ä¼ é€’ä¸€ä¸ªæ¯”è¾ƒå‡½æ•°ç”¨æ¥å†³å®šæ˜¯å‡åºè¿˜æ˜¯\né™åºç­‰ç­‰ã€‚\nå¦‚æœç”¨ç®­å¤´å‡½æ•°å°†å¤§å¤§ç®€åŒ–ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  // es6 ä¹‹å‰ const values = [1, 10, 2, 5, 3] var res1 = values.sort(function(a, b) { // æŒ‡å®šä¸ºå‡åº  return a - b; }) // es6 ä¹‹å var res2 = values.sort((a, b) =\u0026gt; a - b) console.log(res1.toString(), res2.toString())   +RESULTS:\n1,2,3,5,10 1,2,3,5,10  æˆ–è€… map(), reduce() ç­‰ç­‰ç”¨èµ·æ¥ä¼šæ›´æ–¹ä¾¿æ›´ç®€æ´è®¸å¤šã€‚\næ— å‚æ•°ç»‘å®š(arguments) çœ‹å®ä¾‹ï¼š\n1 2 3 4 5 6 7  function createArrowFunctionReturningFirstArg() { return () =\u0026gt; arguments[0] } var arrowFunction = createArrowFunctionReturningFirstArg(5) console.log(arrowFunction()) // 5   +RESULTS:\n5  ä»ç»“æœçœ‹å‡ºï¼Œè¿”å›çš„ arrowFunction() ç®­å¤´å‡½æ•°è°ƒç”¨çš„æ—¶å€™å¹¶æ²¡æœ‰ä¼ é€’ä»»ä½•å‚æ•°ï¼Œ\nä½†æ˜¯æ‰§è¡Œç»“æœå¾—åˆ°äº†ç»“æœè¿™ä¸ªç»“æœæ­£æ˜¯åŒ…å«å®ƒçš„é‚£ä¸ªéç®­å¤´å‡½æ•°\n(createArrowFunctionReturingFirstArt())æ‰€æ¥å—çš„å‚æ•°å€¼ã€‚\nå› æ­¤ç®­å¤´å‡½æ•°å†…éƒ¨å¦‚æœè®¿é—® arguments å¯¹è±¡ï¼Œæ­¤æ—¶è¯¥å¯¹è±¡æŒ‡å‘çš„æ˜¯åŒ…å«å®ƒçš„é‚£ä¸ªéç®­å¤´å‡½æ•°çš„å‚æ•°åˆ—è¡¨å¯¹è±¡ã€‚\nç®­å¤´å‡½æ•°çš„è¯†åˆ« è·Ÿæ™®é€šå‡½æ•°ä¸€æ ·ï¼Œ typeof å’Œ instanceof å¯¹é½ä¾ç„¶ä½¿ç”¨ã€‚\n1 2 3 4  var comparator = (a, b) =\u0026gt; a - b; console.log(typeof comparator) // function console.log(comparator instanceof Function) // true   +RESULTS:\nfunction true  åœ¨ 4.8.1 ä¸€èŠ‚æåˆ°è¿‡ç®­å¤´å‡½æ•°æ˜¯ä¸èƒ½æ”¹å˜ this æŒ‡å‘çš„ï¼Œä½†æ˜¯\nå¹¶ä¸ä»£è¡¨æˆ‘ä»¬å°±å®Œå…¨ä¸èƒ½ä½¿ç”¨ call, apply, bind\næ¯”å¦‚ï¼š\n1 2 3 4  var sum = (n1, n2) =\u0026gt; (this.n1 || 0) + n2 console.log(sum.call(null, 1, 2)) // 3 console.log(sum.call({ n1: 10 }, 1, 2)) // 3   +RESULTS:\n2 2  ä»è¿™ä¸ªä¾‹å­ä¸­å¯ä»¥éªŒè¯ï¼Œç®­å¤´å‡½æ•°æ˜¯æ— æ³•ä¿®æ”¹å®ƒçš„ this æŒ‡å‘çš„ï¼Œå¦‚æœå¯ä»¥ä¿®æ”¹\nç¬¬äºŒä¸ªç»“æœå€¼å°±åº”è¯¥æ˜¯ 12 è€Œä¸æ˜¯å’Œç¬¬ä¸€ä¸ªä¸€æ ·ä¸º 2 ï¼Œå› ä¸ºåœ¨ç¬¬äºŒä¸ªä¸­\næˆ‘ä»¬æ‰‹åŠ¨å°† sum æ‰§è¡Œä¸Šä¸‹æ–‡ç»‘å®šåˆ°äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ä¸Š {n1: 10} ã€‚\n ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶éä¸èƒ½ä½¿ç”¨ï¼Œè€Œæ˜¯ç”¨äº†ä¹Ÿä¸ä¼šæœ‰ä»»ä½•å˜åŒ–è€Œå·²ã€‚\n ä½¿ç”¨ bind ä¿ç•™å‚æ•°ï¼š\n1 2 3 4 5 6 7 8 9  var sum = (n1, n2) =\u0026gt; n1 + n2 console.log(sum.call(null, 1, 2)) // 3 console.log(sum.apply(null, [1, 2])) // 3  // äº§ç”Ÿæ–°çš„å‡½æ•°ï¼Œè¿™ç§å’Œæ™®é€šå‡½æ•°ä½¿ç”¨æ–¹å¼ä¸€æ · var boundSum = sum.bind(null, 1, 2) console.log(boundSum())   +RESULTS:\n3 3 3  å°¾è°ƒç”¨ä¼˜åŒ– å°¾è°ƒç”¨ï¼šå°†ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨æ”¾åœ¨ä¸¤ä¸€ä¸ªå‡½æ•°çš„æœ€åä¸€è¡Œã€‚\næˆ–è®¸åœ¨ es6 ä¸­å¯¹äºå‡½æ•°ç›¸å…³çš„æœ€æ„Ÿå…´è¶£çš„æ”¹åŠ¨å°±æ˜¯å¼•æ“çš„ä¼˜åŒ–äº†ï¼Œå®ƒæ”¹å˜äº†å‡½æ•°çš„å°¾è°ƒ\nç”¨ç³»ç»Ÿã€‚\n1 2 3  function doSth() { return doSthElse() // tail call }   åœ¨ es6 ä¹‹å‰ï¼Œå®ƒå’Œæ™®é€šçš„å‡½æ•°è°ƒç”¨ä¸€æ ·è¢«å¤„ç†ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ç„¶åå°†å®ƒæ¨åˆ°è°ƒç”¨æ ˆ\nçš„æ ˆé¡¶ç­‰å¾…è¢«æ‰§è¡Œ, ä¹Ÿå°±æ„å‘³ç€ä¹‹å‰çš„æ¯ä¸€ä¸ªæ ˆå¸§éƒ½åœ¨å†…å­˜é‡Œé¢ä¿ç•™ç€ï¼Œå¦‚æœè°ƒç”¨æ ˆè¿‡\nå¤§é‚£è¿™å°†å¯èƒ½æ˜¯é—®é¢˜çš„æ¥æºã€‚\næœ‰ä»€ä¹ˆä¸åŒï¼Ÿ åœ¨ es6 ä¹‹åä¼˜åŒ–äº†å¼•æ“ï¼ŒåŒ…å«å°¾è°ƒç”¨ç³»ç»Ÿçš„ä¼˜åŒ–ï¼ˆä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œéä¸¥æ ¼æ¨¡å¼ä¸‹ä¾æ—§æœª\nå‘ç”Ÿæ”¹å˜ï¼‰ã€‚\nä¼˜åŒ–ä¹‹åï¼Œä¸å†ä¼šä¸ºå°¾éƒ¨è°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œè€Œæ˜¯å°†å½“å‰çš„æ ˆå¸§æƒ…å†µï¼Œç„¶åå°†å…¶å¤\nç”¨åˆ°å°¾éƒ¨è°ƒç”¨ï¼Œå‰ææ˜¯æ»¡è¶³ä¸‹é¢å‡ ä¸ªæ¡ä»¶ï¼š\n  å°¾è°ƒç”¨å‡½æ•°ä¸éœ€è¦è®¿é—®å½“å‰æ ˆå¸§ä¸­çš„ä»»ä½•å˜é‡(å³å°¾è°ƒç”¨çš„å‡½æ•°ä¸èƒ½æ˜¯é—­åŒ…ï¼Œé—­åŒ…çš„\nä½œç”¨å°±æ˜¯ç”¨æ¥æŒæœ‰å˜é‡)\n  å³åœ¨å°¾è°ƒç”¨çš„å‡½æ•°ä¹‹åä¸èƒ½æœ‰å…¶ä»–çš„ä»£ç ï¼Œå³å°¾è°ƒç”¨å‡½æ•°å¿…é¡»æ˜¯å‡½æ•°ä½“çš„æœ€åä¸€è¡Œ\n  å°¾è°ƒç”¨å‡½æ•°çš„è°ƒç”¨ç»“æœè¦ä½œä¸ºå½“å‰å‡½æ•°çš„è¿”å›å€¼è¿”å›\n  æ¯”å¦‚ï¼šä¸‹é¢çš„å‡½æ•°å°±æ»¡è¶³å°¾è°ƒç”¨ä¼˜åŒ–çš„æ¡ä»¶\n1 2 3 4 5 6 7 8 9 10 11  \u0026#39;use strict\u0026#39;; // 1. ä¸¥æ ¼æ¨¡å¼  function doSth() { // 2. æ²¡æœ‰å¼•ç”¨ä»»ä½•å†…éƒ¨å˜é‡ï¼Œéé—­åŒ…  // 3. æœ€åä¸€è¡Œ  // 4. è°ƒç”¨ç»“æœè¢«ä½œä¸º doSth çš„è¿”å›å€¼è¿”å›  return doSthElse() }   ä»¥ä¸‹æƒ…å†µä¸ä¼šè¢«ä¼˜åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  \u0026#39;use strict\u0026#39;; function doSth() { doSthElse() // è¿”å›ä½œä¸ºè¿”å›å€¼ï¼Œä¸ä¼šä¼˜åŒ– } function doSth1() { return 1 + doSthElse() // åœ¨å°¾è°ƒç”¨å‡½æ•°è¿”å›ä¹‹åä¸èƒ½æœ‰å…¶ä»–æ“ä½œï¼Œä¸ä¼šä¼˜åŒ– } function doSth2() { var res = doSthElse() return res // ä¸æ˜¯æœ€åä¸€è¡Œï¼Œå³ä¸æ˜¯å°†ç»“æœç«‹å³è¿”å›ï¼Œä¸ä¼šä¼˜åŒ– } function doSth3() { var num = 1, func = () =\u0026gt; num return func() // é—­åŒ…ï¼Œä¸ä¼šä¼˜åŒ– }   å¦‚ä½•åˆ©ç”¨å°¾è°ƒç”¨ä¼˜åŒ–ï¼Ÿ å°¾è°ƒç”¨æœ€ç»å…¸çš„è«è¿‡äºé€’å½’è°ƒç”¨äº†ï¼Œæ¯”å¦‚æ–æ³¢é‚£å¥‘æ•°åˆ—é—®é¢˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function factorial(n) { if (n \u0026lt;= 1) { return 1; } else { // ä¸ä¼šè¢«ä¼˜åŒ–ï¼Œå› ä¸ºå‡½æ•°è¿”å›ä¹‹åè¿˜éœ€è¦è¿›è¡Œä¹˜ç§¯è®¡ç®—æ‰è¿”å›  return n * factorial(n - 1); } } console.log(factorial(10))   +RESULTS:\n3628800  ä¸Šé¢çš„å¹¶ä¸ä¼šè¢«ä¼˜åŒ–ï¼Œå› ä¸ºå°¾è°ƒç”¨å‡½æ•°å¹¶ä¸æ˜¯ç«‹å³è¿”å›çš„ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function factorial(n, p = 1) { if (n \u0026lt;= 1) { return 1 * p; } else { let res = n * p // è¢«ä¼˜åŒ–  return factorial(n - 1, res); } } console.log(factorial(10))   +RESULTS:\n3628800  å°¾è°ƒç”¨ä¼˜åŒ–åº”è¯¥æ˜¯æˆ‘ä»¬åœ¨ä¹¦å†™ä»£ç çš„æ—¶å€™æ—¶å¸¸åº”è¯¥è€ƒè™‘çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯ä¹¦å†™é€’å½’çš„æ—¶å€™ï¼Œ\nå½“ä½¿ç”¨é€’å½’æ¶‰åŠåˆ°å¤§é‡çš„è®¡ç®—çš„æ—¶å€™ï¼Œ\nå°¾è°ƒç”¨ä¼˜åŒ–çš„ä¼˜åŠ¿å°†ä¼šå¾ˆæ˜æ˜¾ã€‚\nå°ç»“    é€‰é¡¹ åŠŸèƒ½ æè¿° å…¶ä»–     arguments       ES6ä¹‹å‰éä¸¥æ ¼æ¨¡å¼ å€¼ä¼šéšç€å‡½æ•°ä½“å†…å‚æ•°çš„æ”¹å˜è€Œæ”¹å˜     ES6ä¹‹å‰ä¸¥æ ¼æ¨¡å¼ ä¸ä¼šå“åº”æ”¹å˜ï¼Œè°ƒç”¨ä¹‹åˆå°±å®šäº†     ES6ä¹‹åè¡Œä¸ºç»Ÿä¸€ ä¸ä¼šå“åº”æ”¹å˜ï¼Œå†…å®¹ç”±å®é™…è°ƒç”¨è€…ä¼ é€’ä¸ªæ•°å†³å®š    å‡½æ•°é»˜è®¤å‚æ•° å¯ä»¥æ˜¯å¸¸é‡å€¼ function add(f, s = 3) {}     å¯ä»¥æ˜¯å˜é‡ var n = 10; function add(f, s = n) {}     å¯ä»¥æ˜¯å‡½æ•°è°ƒç”¨ function getVal() {}; function add(f, s = getVal) {}     é»˜è®¤å€¼å‚æ•°çš„æ‰§è¡Œ è°ƒç”¨æ—¶æœ‰ä¼ é€’åˆ™ä¸ä¼šæ£€æµ‹æˆ–æ‰§è¡Œï¼Œæœªä¼ é€’åˆ™ä¼šæ£€æµ‹å’Œæ‰§è¡Œ     ç›¸äº’å¼•ç”¨ åé¢çš„å‚æ•°å¯ä»¥å¼•ç”¨å‰é¢çš„å‚æ•°å˜é‡ function add(f, s = f) {}     ä¸´æ—¶æ­»åŒº(TDZ)     å‚æ•° rest ç¬¦å· æ¥å—å¤šä¸ªå‚æ•°ï¼Œåˆå¹¶æˆæ•°ç»„ä¾›å‡½æ•°å†…éƒ¨ä½¿ç”¨ function add(f, ...a) {}     å¼‚å¸¸ä½¿ç”¨ä¸€ ä¸èƒ½ç”¨åœ¨è®¿é—®å™¨å‡½æ•° obj = { set name(...val) {} } éæ³•ã€‚    å¼‚å¸¸ä½¿ç”¨äºŒ å¿…é¡»ä½œä¸ºå‡½æ•°æœ€åä¸€ä¸ªå‚æ•°ä½¿ç”¨ function add(f, ...s, t) {} éæ³•ã€‚    å¯¹argumentså½±å“ éç®­å¤´å‡½æ•°æ²¡ä»€ä¹ˆå½±å“ argumentsæ€»æ˜¯ç”±è°ƒç”¨è€…ä¼ é€’çš„å‚æ•°å†³å®šä¸ªæ•°   æ„é€ å‡½æ•° new Function() å¯ä»¥ä½¿ç”¨é»˜è®¤å€¼ï¼Œrestç¬¦å·ç­‰åŠŸèƒ½    å±•å¼€ç¬¦(â€¦) æ™®é€šå¤šå‚æ•°å‡½æ•° Math.max(1, 2, 3, 4, ...)     æ™®é€šå¤šå‚æ•°å‡½æ•°apply Math.max.apply(Math, [1, 2, 3, 4])     ES6å±•å¼€ç¬¦ Math.max(...[1, 2, 3, 4, ...])    name å±æ€§ å‡½æ•°åç§° ä»…è¾…åŠ©æè¿°åŠŸèƒ½ï¼Œæ˜“äºè·Ÿè¸ªå‡½æ•°     ç‰¹æ®Šæƒ…å†µ: è®¿é—®å™¨å‡½æ•° get fnName     ç‰¹æ®Šæƒ…å†µï¼šbind() å‡½æ•° bound fnName     ç‰¹æ®Šæƒ…å†µï¼šnew Function() åŒ¿åå‡½æ•° anonymous    new.target å‡½æ•°å¯ç›´æ¥è°ƒç”¨å¯newæ„é€ å®ä¾‹ å› æ­¤é€ æˆå‡½æ•°å†…éƒ¨å¦‚ä½•è¯†åˆ«ä½¿ç”¨é‡Šæ”¾é—®é¢˜ï¼Ÿ     å¦‚æœä½œä¸ºå‡½æ•°è°ƒç”¨ [[Call]] new.target = undefined     å¦‚æœæ˜¯ new æ„é€ å‡½æ•° [[Constructor]] new.target = Person æ„é€ å‡½æ•°æœ¬èº«    å—çº§å‡½æ•° åœ¨ es6ä¹‹æƒ…å—çº§å‡½æ•°çš„å£°æ˜å¤„ç†å¹¶æ²¡æœ‰ç»Ÿä¸€ ä¸¥æ ¼æ¨¡å¼å¿…å‡ºå¼‚å¸¸ï¼Œéä¸¥æ ¼ä¸å¥½è¯´     es6ä¹‹åç»Ÿä¸€æ ‡å‡† ä¸¥æ ¼æ¨¡å¼ï¼šå—çº§å‡½æ•°åªæ˜¯å±€éƒ¨å‡½æ•° åªåœ¨ä½œç”¨åŸŸå†…æœ‰æ•ˆ     éä¸¥æ ¼æ¨¡å¼ï¼šå—çº§å‡½æ•°ä¼šæå‡åˆ°å‡½æ•°é¡¶éƒ¨æˆ–å…¨å±€ç¯å¢ƒ å…¨å±€æˆ–å‡½æ•°ä½“ç”Ÿæ•ˆ   ç®­å¤´å‡½æ•°ç‰¹æ€§ æ—  this ä¸æ˜“è¿½è¸ªï¼Œæ˜“äºå¼•æ“ä¼˜åŒ– å†…éƒ¨å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒæŒ‡å‘çš„æ˜¯å½“å‰ç®­å¤´å‡½æ•°æ‰€åœ¨çš„éç®­å¤´å‡½æ•°æ‰€åœ¨çš„ä¸Šä¸‹æ–‡     æ—  super æ²¡æœ‰åŸå‹ï¼Œç»§æ‰¿ç­‰ï¼Œä¸éœ€è¦ super     æ—  arguments å†…éƒ¨è®¿é—®çš„è¯¥å¯¹è±¡ï¼Œå…¶å®æ˜¯å½“å‰ç¯å¢ƒå‡½æ•°çš„å‚æ•°ï¼Œè€Œéç®­å¤´å‡½æ•°æœ¬èº«çš„å‚æ•°åˆ—è¡¨     æ—  new.target ä¸æ”¯æŒ new å°±ä¸å­˜åœ¨ä½¿ç”¨æ–¹å¼é—®é¢˜     æ— åŸå‹ ä¸æ”¯æŒ new     ä¸èƒ½æ”¹å˜ this æŒ‡å‘ å…¶å†…éƒ¨çš„ this å·²ç»ä¸æ˜¯å®ƒç®¡è¾–ï¼Œå¯ä»¥è°ƒç”¨ call, apply, bind ä¹‹æµï¼Œä½†æ˜¯ä¸ä¼šæœ‰ä»»ä½•ä½œç”¨     ä¸èƒ½æœ‰é‡å¤å‘½åå‚æ•° éä¸¥æ ¼æ¨¡å¼ä¸‹ES6ä¹‹å‰çš„æ™®é€šå‚æ•°å¯ä»¥ç”¨     ç®­å¤´å‡½æ•°è¯­æ³• ä½¿ç”¨æ–¹å¼çµæ´»å¤šå˜     ç«‹å³è¡¨è¾¾å¼ å¿…é¡»æ‹¬å·åŒ…èµ·æ¥å†æ‰§è¡Œï¼Œæ™®é€šå‡½æ•°å¯ç›´æ¥åœ¨ } åæ‰§è¡Œ (() =\u0026gt; {})(), function(name){}('xxx')    typeof, instanceof å¯¹ç®­å¤´å‡½æ•°ä¾æ—§æœ‰æ•ˆï¼Œ typeof fn = \u0026lsquo;function\u0026rsquo;, fn instanceof Function (true)    å°¾è°ƒç”¨ä¼˜åŒ– å¿…é¡»æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ ä¸æ»¡è¶³æ¡ä»¶ä¸ä¼šä¼˜åŒ–ï¼Œå…¸å‹çš„é€’å½’è°ƒç”¨     1. éé—­åŒ…ï¼Œå°¾å‡½æ•°ä½“å†…ä¸èƒ½è®¿é—®æ­£å‡½æ•°ä½“å†…ä»»ä½•å˜é‡      2. ç»“æœå€¼å¿…é¡»ç«‹å³è¿”å›ï¼Œä¸èƒ½å‚ä¸å…¶ä»–è®¡ç®—åå†è¿”å›      3. å¿…é¡»æ˜¯æ­£å‡½æ•°çš„æœ€åä¸€ä¸ªè¯­å¥      ä¼˜åŒ–ä¹‹å‰ å°¾å‡½æ•°æ–°å»ºæ ˆå¸§ï¼Œæ”¾åœ¨è°ƒç”¨æ ˆé¡¶ç­‰å¾…è°ƒç”¨     ä¼˜åŒ–ä¹‹å æ¸…ç©ºè°ƒç”¨æ ˆï¼Œå°†å®ƒä½œä¸ºå°¾è°ƒç”¨å‡½æ•°çš„æ ˆå¸§å¤ç”¨     å¯¹è±¡æ‰©å±•(Object) å¯¹è±¡åˆ†ç±»    ç±»å‹ è¯´æ˜     æ™®é€šå¯¹è±¡(Ordinary) æ‹¥æœ‰æ‰€æœ‰å¯¹è±¡çš„é»˜è®¤è¡Œä¸º   å¼‚ç±»å¯¹è±¡(Exotic) å’Œé»˜è®¤è¡Œä¸ºæœ‰æ‰€å·®å¼‚   æ ‡å‡†å¯¹è±¡(Standard) é‚£äº›ç”± ECMAScript 6 å®šä¹‰çš„ï¼Œå¦‚ï¼š Array, Date ç­‰ç­‰   å†…ç½®å¯¹è±¡(Built-in) è„šæœ¬å½“å‰æ‰§è¡Œç¯å¢ƒä¸­çš„å¯¹è±¡ï¼Œæ‰€æœ‰æ ‡å‡†å¯¹è±¡éƒ½æ˜¯å†…ç½®å¯¹è±¡    å¯¹è±¡å­—é¢é‡(literal)è¯­æ³•æ‰©å±• å­—é¢é‡è¯­æ³•åœ¨ JavaScript ä¸­ä½¿ç”¨éå¸¸æ™®é\n ä¹¦å†™æ–¹ä¾¿ ç®€æ´æ˜“æ‡‚ JSON å°±æ˜¯åŸºäºå­—é¢é‡è¯­æ³•æ¼”å˜è€Œæ¥  es6 çš„æ¥åˆ°æ˜¯çš„å¯¹è±¡å­—é¢é‡è¯­æ³•æ›´åŠ å¼ºå¤§ç®€æ´æ˜“ç”¨ã€‚\nå¯¹è±¡å±æ€§ç®€å†™ \u0026lt;= es5:\n1 2 3 4 5 6  function createPerson(name, age) { return { name: name, age: age } }   es6:\n1 2 3 4 5 6  function createPerson(name, age) { return { name, age } }   ç®€æ´å‡½æ•°å†™æ³• \u0026lt;= es5:\n1 2 3 4 5 6  var person = { name: \u0026#39;å¼ ä¸‰\u0026#39;, sayName: function() { console.log(this.name) } }   es6:\n1 2 3 4 5 6  var person = { name: \u0026#39;å¼ ä¸‰\u0026#39;, sayName() { console.log(this.name) } }   è®¡ç®—å±æ€§ åœ¨ es6 ä¹‹å‰ä¹¦å†™å¯¹è±¡å­—é¢é‡çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¤šä¸ªå­—ç¬¦ä¸²ç»„æˆçš„å­—ç¬¦ä¸²ä½œä¸º\nkey ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼åœ¨å®é™…ä½¿ç”¨ä¸­æ˜¯éå¸¸ä¸æ–¹ä¾¿çš„ï¼Œå‡å¦‚è¯´ key æ˜¯ä¸ªå¾ˆé•¿çš„ä¸²å‘¢ï¼Ÿï¼Ÿ\n1 2 3 4 5  var person = { \u0026#39;first name\u0026#39;: \u0026#39;å¼ ä¸‰\u0026#39; } console.log(person[\u0026#39;first name\u0026#39;]) // å¼ ä¸‰   +RESULTS:\nå¼ ä¸‰  å› æ­¤ï¼Œ es6 ä¸­æ”¯æŒäº†å˜é‡ä½œä¸ºå¯¹è±¡å±æ€§åå»è®¿é—®ï¼Œæ ¹æ®å˜é‡çš„å€¼åŠ¨æ€å†³å®šä½¿ç”¨ä»€ä¹ˆ\nkey å»è®¿é—®å¯¹è±¡çš„å±æ€§å€¼ï¼Œè¿™æ ·ä¸ç®¡ key å¤šé•¿ï¼Œåªéœ€è¦ä½¿ç”¨å˜é‡å°†å®ƒå­˜å‚¨èµ·æ¥ï¼Œ\nç›´æ¥ä½¿ç”¨å˜é‡åå»ä½¿ç”¨å°†æ›´åŠ æ–¹ä¾¿ã€‚\n1 2 3 4 5 6 7 8  var person = {}, lastName = \u0026#34;last name\u0026#34;; person[\u0026#34;first name\u0026#34;] = \u0026#34;å¼ ä¸‰\u0026#34;; person[lastName] = \u0026#34;æå››\u0026#34;; console.log(person[\u0026#34;first name\u0026#34;]); // \u0026#34;å¼ ä¸‰\u0026#34; console.log(person[lastName]); // \u0026#34;æå››\u0026#34;   +RESULTS:\nå¼ ä¸‰ æå››  æ”¯æŒè¡¨è¾¾å¼è®¡ç®—å±æ€§åï¼š\n1 2 3 4 5 6 7 8 9  var suffix = \u0026#39; name\u0026#39; var person = { [\u0026#39;first\u0026#39; + suffix]: \u0026#39;å¼ ä¸‰\u0026#39;, [\u0026#39;last\u0026#39; + suffix]: \u0026#39;æå››\u0026#39; } console.log(person[\u0026#39;first name\u0026#39;]) // å¼ ä¸‰ console.log(person[\u0026#39;last name\u0026#39;]) // æå››   +RESULTS:\nå¼ ä¸‰ æå››  æ–°æ–¹æ³• Object.fromEntries(iterable)2019 å°†ä¸€ç»„ map ç±»å‹æˆ–ä¼¼ map ç±»å‹çš„æ•°ç»„è½¬æˆå¯¹è±¡ã€‚\nå¦‚ï¼š [ ['key1', 'value1' ], ['key2', 'value2'] ]\nè½¬æ¢ä¹‹åï¼š { key1: 'value1', key2: 'value2' }\nObject.is(value1, value2) åœ¨ä»¥å¾€æˆ‘ä»¬åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œç»å¸¸ä½¿ç”¨çš„æ˜¯ == å’Œ === ï¼Œä¸€èˆ¬æ¨èä½¿ç”¨åè€…\nå› ä¸ºå‰è€…ä¼šæœ‰éšå¼å¼ºè½¬ï¼Œä¼šåœ¨æ¯”è¾ƒä¹‹å‰å°†ä¸¤ä¸ªå€¼è¿›è¡Œå¼ºåˆ¶è½¬æ¢æˆåŒä¸€ä¸ªç±»å‹å†æ¯”è¾ƒã€‚\n1 2 3 4 5 6  console.log(\u0026#39;\u0026#39; == false) // true console.log(0 == false) // true console.log(0 == \u0026#39;\u0026#39;) // true console.log(5 == \u0026#39;5\u0026#39;) // true console.log(-0 == +0) // true console.log(NaN == NaN) // true   +RESULTS:\ntrue true true true true false  å¯¹äº +0 å’Œ -0 ä½¿ç”¨ === çš„ç»“æœæ˜¯ true ï¼Œä½†å®é™…ä¸Šä»–ä»¬æ˜¯æœ‰ç¬¦å·çš„ï¼Œç†è®º\nä¸Šåº”è¯¥æ˜¯ä¸ç›¸ç­‰çš„ã€‚\nè€Œä¸¤ä¸ª NaN äº”è·¯ä½ æ˜¯ == æˆ– === éƒ½åˆ¤å®šä»–ä»¬æ˜¯ä¸ç›¸ç­‰çš„ã€‚\nä¸ºäº†è§£å†³è¿™äº›å·®å¼‚ï¼Œ es6 ä¸­åŠ å…¥äº† Object.is() æ¥å£ï¼Œæ„æŒ‡å°†ç­‰å¼çš„åˆ¤æ–­æ›´åŠ åˆç†\nåŒ–ï¼Œå®ƒçš„å«ä¹‰æ˜¯ä¸¤ä¸ªå€¼æ˜¯å¦æ˜¯åŒä¸€ä¸ªå€¼ã€‚\næˆ‘ä»¬çœ‹ä¸‹å„å¯¹å€¼ä½¿ç”¨ Object.is() æ¯”è¾ƒçš„ç»“æœ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const is = Object.is const log = console.log // +0, -0 log(\u0026#39;+0 == -0\u0026#39;, +0 == -0) log(\u0026#39;+0 === -0\u0026#39;, +0 === -0) log(\u0026#39;+0 is -0: \u0026#39;, is(+0, -0)) // NaN log(\u0026#39;NaN == NaN: \u0026#39;, NaN == NaN) log(\u0026#39;NaN === NaN: \u0026#39;, NaN === NaN) log(\u0026#39;NaN is NaN: \u0026#39;, is(NaN, NaN)) // number, string log(\u0026#39;5 == \u0026#34;5\u0026#34;: \u0026#39;, 5 == \u0026#39;5\u0026#39;) log(\u0026#39;5 == 5: \u0026#39;, 5 == 5) log(\u0026#39;5 === \u0026#34;5\u0026#34;: \u0026#39;, 5 === \u0026#39;5\u0026#39;) log(\u0026#39;5 === 5: \u0026#39;, 5 === 5) log(\u0026#39;5 is \u0026#34;5\u0026#34;: \u0026#39;, is(5, \u0026#39;5\u0026#39;)) log(\u0026#39;5 is 5: \u0026#39;, is(5, 5))   +RESULTS:\n+0 == -0 true +0 === -0 true +0 is -0: false NaN == NaN: false NaN === NaN: false NaN is NaN: true 5 == \u0026quot;5\u0026quot;: true 5 == 5: true 5 === \u0026quot;5\u0026quot;: false 5 === 5: true 5 is \u0026quot;5\u0026quot;: false 5 is 5: true  å› æ­¤ï¼Œ Object.is èƒ½å¤Ÿå¼¥è¡¥ï¼Œ === æ— æ³•åˆ¤æ–­å‡º +0, -0, NaN, Nan ç›¸ç­‰çš„ç»“\næœã€‚\nObject.assign(target, source, source1, source2, â€¦) å‚æ•°ï¼š\n target æ¥å—æ‹·è´çš„å¯¹è±¡ï¼Œä¹Ÿå°†è¿”å›è¿™ä¸ªå¯¹è±¡ source æ‹·è´å†…å®¹çš„æ¥æºå¯¹è±¡ æ¥æºå¯¹è±¡å‚æ•°å¯ä»¥æœ‰å¤šä¸ªï¼Œå¦‚æœå­˜åœ¨åŒåå±æ€§å€¼ï¼Œæœ€åçš„å€¼ç”±æœ€åä¸€ä¸ªæ‹¥æœ‰åŒåå±\næ€§å¯¹è±¡ä¸­çš„å€¼ä¸ºå‡†  TC39.ECMA262 å®ç°åŸç†å›¾ï¼š\nåˆå¹¶å¯¹è±¡ï¼Œå°† source ä¸­è‡ªèº«çš„å¯æšä¸¾çš„å±æ€§æµ…æ‹·è´åˆ° target å¯¹è±¡ä¸­ï¼Œè¿”å›\ntarget å¯¹è±¡ã€‚\næ··åˆå™¨(Mixins)åœ¨ JavaScript ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œåœ¨ä¸€ä¸ª mixin ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥ä»\nå¦ä¸ªå¯¹è±¡ä¸­æ¥å—ä»–ä»¬çš„å±æ€§å’Œæ–¹æ³•ï¼Œå³æµ…æ‹·è´ï¼Œè®¸å¤š JavaScript åº“éƒ½ä¼šæœ‰ä¸€ä¸ªä¸ä¸‹é¢\nç±»ä¼¼çš„ mixin å‡½æ•°:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  const mixin = (receiver, supplier) =\u0026gt; { Object.keys(supplier).forEach( key =\u0026gt; receiver[key] = supplier[key]) return receiver } function EventTarget() {} EventTarget.prototype = { constructor: EventTarget, get name() { return \u0026#39;EventTarget.prototype\u0026#39; }, emit: function(msg) { console.log(msg, \u0026#39;in EventTarget.prototype\u0026#39;) }, on: function(msg) { console.log(msg, \u0026#39;on EventTarget.prototype\u0026#39;) } } const myObj1 = {} mixin(myObj1, EventTarget.prototype) myObj1.emit(\u0026#39;something changed from myObj1\u0026#39;) console.log(myObj1.name, \u0026#39;obj1 name\u0026#39;) const myObj2 = {} Object.assign(myObj2, EventTarget.prototype) myObj2.on(\u0026#39;listen from myObj1\u0026#39;) console.log(myObj2.name, \u0026#39;obj2 name\u0026#39;) console.log(EventTarget.prototype, myObj1, myObj2)   +RESULTS:\nsomething changed from myObj1 in EventTarget.prototype EventTarget.prototype obj1 name listen from myObj1 on EventTarget.prototype EventTarget.prototype obj2 name  ç”±äº mixin(), Object.assign çš„å®ç°éƒ½æ˜¯é‡‡ç”¨çš„ = æ“ä½œç¬¦ï¼Œå› æ­¤æ˜¯æ²¡æ³•æ‹·è´\nè®¿é—®å™¨å±æ€§çš„ï¼Œæˆ–è€…è¯´æ‹·è´è¿‡æ¥ä¹‹åå°±ä¸ä¼šå†æ˜¯è®¿é—®å™¨å±æ€§äº†ï¼Œçœ‹ä¸Šé¢ä»£ç çš„è¿è¡Œç»“æœå¯¹æ¯”å›¾ï¼š\nå¤šä¸ªæ¥æºå¯¹è±¡æ”¯æŒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  const receiver = {} const res = Object.assign(receiver, { name: \u0026#39;xxx\u0026#39;, age: 100 }, { height: 180 }, { color: \u0026#39;yellow\u0026#39;, age: 80 }) console.log(receiver === res) console.log(res)   +RESULTS:\ntrue { name: 'xxx', age: 80, height: 180, color: 'yellow' }  æœ€å age: 80 å€¼æ˜¯æœ€åä¸€ä¸ªæ¥æºå¯¹è±¡ä¸­çš„å€¼ï¼Œè¿”å›å€¼å³ç¬¬ä¸€ä¸ªå‚æ•°å¯¹è±¡ã€‚\né‡å¤å±æ€§ \u0026lt;= es5 ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œé‡å¤å±æ€§ä¼šå‡ºç°è¯­æ³•é”™è¯¯ï¼š\n1 2 3 4 5 6  \u0026#39;use strict\u0026#39;; var person = { name: \u0026#39;xxx\u0026#39;, name: \u0026#39;yyy\u0026#39; // syntax error in es5 strict mode }   es6 æ— è®ºä¸¥æ ¼æˆ–éä¸¥æ ¼æ¨¡å¼ä¸‹éƒ½å±åˆæ³•æ“ä½œï¼Œå…¶å€¼ä¸ºæœ€åä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼š\n1 2 3 4 5 6 7 8  \u0026#39;use strict\u0026#39;; var person = { name: \u0026#39;xxx\u0026#39;, name: \u0026#39;yyy\u0026#39; // no error } console.log(person.name)   +RESULTS:\nyyy  è‡ªæœ‰å±æ€§æšä¸¾é¡ºåº \u0026lt;= es5 ä¸­æ˜¯ä¸ä¼šå®šä¹‰å¯¹è±¡å±æ€§çš„æšä¸¾é¡ºåºçš„ï¼Œå®ƒçš„æšä¸¾é¡ºåºæ˜¯åœ¨å®é™…è¿è¡Œæ—¶å–å†³äºæ‰€å¤„\nçš„ JavaScript å¼•æ“ã€‚\nes6 ä¸­ä¸¥æ ¼å®šä¹‰äº†æšä¸¾æ—¶è¿”å›çš„å±æ€§é¡ºåºï¼Œè¿™å°†ä¼šå½±å“åœ¨ä½¿ç”¨\nObjct.getOwnPropertyNames() å’Œ Reflect.ownKeys æ—¶å±æ€§è¯¥å¦‚ä½•è¿”å›ã€‚\næšä¸¾æ—¶åŸºæœ¬é¡ºåºéµå¾ªï¼š\n  æ‰€æœ‰æ•°å­—ç±»å‹çš„ keys ä¸ºå‡åºæ’åº\n  æ‰€æœ‰å­—ç¬¦ä¸²ç±»å‹çš„ keys æŒ‰ç…§å®ƒæ·»åŠ çš„æ—¶æœºæ’åº\n  æ‰€æœ‰ç¬¦å·ç±»å‹(Symbols)çš„ keys æŒ‰ç…§å®ƒæ·»åŠ çš„æ—¶æœºæ’åº\n  ä¸‰è€…çš„ä¼˜å…ˆçº§ä¸ºï¼š numbers \u0026gt; strings \u0026gt; symbols\n1 2 3 4 5 6 7 8 9 10 11 12  var obj = { a: 1, 0: 1, c: 1, 2: 1, b: 1, 1: 1 } obj.d = 1 console.log(Object.getOwnPropertyNames(obj).join(\u0026#39;\u0026#39;)) // 012acbd   +RESULTS:\n012acbd   ç”±äºå¹¶éæ‰€æœ‰ JavaScript å¼•æ“å¹¶éç»Ÿä¸€å®ç°æ–¹å¼ï¼Œå¯¼è‡´ for-in å¾ªç¯ä¾æ—§æ— æ³•ç¡®å®š\næšä¸¾çš„é¡ºåºã€‚\nå¹¶ä¸” Object.keys() å’Œ JSON.stringify() é‡‡ç”¨çš„æšä¸¾é¡ºåºå’Œ for-in ä¸€æ ·ã€‚\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14  var obj = { a: 1, 0: 1, c: 1, 2: 1, b: 1, 1: 1 } obj.d = 1 for (let prop in obj) { console.log(prop) }   åŠŸèƒ½æ›´å¼ºçš„åŸå‹å¯¹è±¡ åŸå‹æ˜¯ JavaScript ä¸­å®ç°ç»§æ‰¿çš„åŸºçŸ³ï¼Œæ—©èµ·çš„ç‰ˆæœ¬ä¸­ä¸¥é‡é™åˆ¶äº†åŸå‹èƒ½åšçš„äº‹æƒ…ï¼Œ\nç„¶åéšç€ JavaScript çš„é€æ¸æˆç†Ÿç¨‹åºå‘˜ä»¬å¼€å§‹è¶Šæ¥è¶Šä¾èµ–åŸå‹ï¼Œæˆ‘ä»¬ç°åœ¨èƒ½å¾ˆæ¸…æ™°\nåœ°æ„Ÿå—åˆ°å¼€å‘è€…ä»¬å¯¹åŸå‹æ§åˆ¶ä¸Šå’Œæ˜“ç”¨æ€§çš„æ¸´æœ›è¶Šæ¥è¶Šå¼ºçƒˆï¼Œç”±æ­¤ ES6 å¯¹é½è¿›è¡Œäº†åŠ å¼ºã€‚\næ”¹å˜å¯¹è±¡åŸå‹ æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¯¹è±¡é€šè¿‡æ„é€ å‡½æ•°æˆ– Object.create() åˆ›å»ºçš„åŒæ—¶åŸå‹ä¹Ÿå°±è¢«åˆ›å»ºäº†ã€‚\nES5 ä¸­å¯ä»¥é€šè¿‡ Object.getPrototypeof() æ–¹æ³•å»è·å–å¯¹è±¡åŸå‹ï¼Œä½†æ˜¯ä¾ç„¶\nç¼ºå°‘ä¸€ä¸ªæ ‡å‡†çš„æ–¹å¼å»è·å–å¤±åˆ©ä¹‹åçš„å¯¹è±¡åŸå‹ã€‚\nES6 å¢åŠ äº† Object.setPrototypeof(source, target) ç”¨æ¥æ”¹å˜å¯¹è±¡çš„åŸå‹æŒ‡å‘ï¼Œ\næŒ‡å°† source.prototype æŒ‡å‘ target å¯¹è±¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let person = { getGreeting() { return \u0026#34;Hello\u0026#34;; } }; let dog = { getGreeting() { return \u0026#34;Woof\u0026#34;; } }; // prototype is person let friend = Object.create(person); console.log(friend.getGreeting()); // \u0026#34;Hello\u0026#34; console.log(Object.getPrototypeOf(friend) === person); // true  // set prototype to dog Object.setPrototypeOf(friend, dog); console.log(friend.getGreeting()); // \u0026#34;Woof\u0026#34; console.log(Object.getPrototypeOf(friend) === dog); // true   å®é™…ä¸Šï¼Œä¸€ä¸ªå¯¹è±¡çš„åŸå‹æ˜¯å­˜å‚¨åœ¨å®ƒçš„å†…éƒ¨å±æ€§ [[Prototype]] ä¸Šçš„ï¼Œ Object.getPrototypeOf()\nè·å–çš„ä¹Ÿæ˜¯è¿™ä¸ªå±æ€§çš„å€¼ï¼Œ Object.setPrototypeOf() è®¾ç½®ä¹Ÿæ˜¯æ”¹å˜è¿™ä¸ªå±æ€§çš„å€¼ã€‚\næ—§ç‰ˆåŸå‹çš„è®¿é—® æ¯”å¦‚ï¼šå¦‚æœæƒ³åœ¨å®ä¾‹ä¸­é‡å†™åŸå‹çš„æŸä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œéœ€è¦åœ¨é‡å†™çš„æ–¹æ³•å†…è°ƒç”¨åŸå‹æ–¹æ³•\næ—¶å€™ï¼Œä»¥å¾€æ˜¯è¿™æ ·æ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  let person = { getGreeting() { return \u0026#34;Hello\u0026#34;; } }; let dog = { getGreeting() { return \u0026#34;Woof\u0026#34;; } }; let friend = { getGreeting() { return Object.getPrototypeOf(this).getGreeting.call(this) + \u0026#34;, hi!\u0026#34;; } }; // set prototype to person Object.setPrototypeOf(friend, person); console.log(friend.getGreeting()); // \u0026#34;Hello, hi!\u0026#34; console.log(Object.getPrototypeOf(friend) === person); // true  // set prototype to dog Object.setPrototypeOf(friend, dog); console.log(friend.getGreeting()); // \u0026#34;Woof, hi!\u0026#34; console.log(Object.getPrototypeOf(friend) === dog); // true   é€šè¿‡ Object.getPrototypeOf(this).getGreeting.call(this) â€¦ å»è·å–åŸå‹ä¸­çš„\næ–¹æ³•\né€šè¿‡ super å¼•ç”¨ç®€åŒ–åŸå‹çš„è®¿é—® å¦‚ä¹‹å‰æ‰€æï¼ŒåŸå‹æ˜¯ JavaScript ä¸­ä¸€ä¸ªå¾ˆé‡è¦ä¹Ÿå¾ˆå¸¸ç”¨çš„ä¸€ä¸ªå¯¹è±¡ï¼ŒES6 å¯¹ä»–ä»¬çš„ä½¿\nç”¨è¿›è¡Œäº†ç®€åŒ–ã€‚\nå¦å¤– es6 å¯¹åŸå‹çš„å¦ä¸€ä¸ªæ”¹å˜æ˜¯ super çš„å¼•ç”¨ï¼Œè¿™è®©å¯¹è±¡è®¿é—®åŸå‹å¯¹è±¡æ›´åŠ æ–¹ä¾¿ã€‚\nè€Œåœ¨ es6 å¢åŠ  super ä¹‹åå°±å˜å¾—å¼‚å¸¸ç®€æ´äº†ï¼š\n1 2 3 4 5 6 7  let friend = { getGreeting() { // in the previous example, this is the same as:  // Object.getPrototypeOf(this).getGreeting.call(this)  return super.getGreeting() + \u0026#34;, hi!\u0026#34;; } };   ç±»ä¼¼å…¶ä»–è¯­è¨€çš„ç»§æ‰¿ï¼Œ friend æ˜¯å®ä¾‹ï¼Œå®ƒçš„åŸå‹æ˜¯å®ƒçš„çˆ¶ç±»ï¼Œåœ¨å®ä¾‹ä¸­çš„ super\nå…¶å®æ˜¯æŒ‡å‘çˆ¶ç±»çš„å¼•ç”¨ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨å­ç±»ä¸­ç›´æ¥ä½¿ç”¨ super å»ä½¿ç”¨çˆ¶ç±»çš„æ–¹æ³•ã€‚\nåªèƒ½åœ¨ç®€å†™å‡½æ•°ä¸­è®¿é—® super ä½†æ˜¯ super åªèƒ½åœ¨å¯¹è±¡çš„ç®€å†™æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ â€œfunctionâ€ å…³é”®è¯å£°æ˜çš„\nå‡½æ•°ä¸­ä½¿ç”¨ä¼šå‡ºç°\nsyntax error\næ¯”å¦‚ï¼šä¸‹é¢çš„æ–¹å¼æ˜¯éæ³•çš„\n1 2 3 4 5 6  let friend = { getGreeting: function() { // syntax error  return super.getGreeting() + \u0026#34;, hi!\u0026#34;; } };   å› ä¸º super åœ¨è¿™ç§å‡½æ•°çš„ä¸Šä¸‹æ–‡ä¸­ä¸­ä¸å­˜åœ¨çš„ã€‚\nObject.getPrototypeOf() å¹¶ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½èƒ½ä½¿ç”¨çš„ å› ä¸º this çš„æŒ‡å‘æ˜¯æ ¹æ®å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡æ¥å†³å®šäº†ï¼Œå› æ­¤ä½¿ç”¨ this æ˜¯å®Œå…¨é è°±\nçš„ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let person = { getGreeting() { return \u0026#34;Hello\u0026#34;; } }; // prototype is person let friend = { getGreeting() { return Object.getPrototypeOf(this).getGreeting.call(this) + \u0026#34;, hi!\u0026#34;; } }; Object.setPrototypeOf(friend, person); // prototype is friend let relative = Object.create(friend); console.log(person.getGreeting()); // \u0026#34;Hello\u0026#34; console.log(friend.getGreeting()); // \u0026#34;Hello, hi!\u0026#34; console.log(relative.getGreeting()); // error!   ä¸Šé¢çš„ relative.getGreeting()) ä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯ relative æœ¬èº«æ˜¯ä¸ªæ–°çš„å˜é‡ï¼Œ\nè¿™ä¸ªå˜é‡æŒ‡å‘ç”± Object.create(friend) åˆ›å»ºçš„ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå…¶åŸå‹ä¸º friend ï¼Œ\nå³ reletive.getGreeting() çš„è°ƒç”¨é¦–å…ˆåœ¨ friend ä¸­æ‰¾ä½†æ²¡æ‰¾åˆ°ï¼Œæœ€ååœ¨\nfriend ä¸­æ‰¾åˆ°äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯åŸå‹ä¸Šçš„ getGreeting() ç„¶ååŸ\nå‹æ–¹æ³•é‡Œé¢åˆæ˜¯é€šè¿‡ this å»è°ƒç”¨äº†åŸå‹çš„æ–¹æ³•(ä¹Ÿå°±è‡ªèº«)ï¼Œç”±äº this å§‹ç»ˆæ˜¯æ ¹\næ®å½“å‰ä¸Šä¸‹æ–‡å‘ç”Ÿå˜åŒ–çš„ï¼Œæ­¤æ—¶å®ƒçš„æŒ‡å‘æ˜¯ friend ï¼Œæœ€ç»ˆä¼šå¯¼è‡´å¾ªç¯è°ƒç”¨ã€‚\nè€Œç”¨ super å°±ä¸ä¼šæœ‰ä¸Šé¢çš„é—®é¢˜ï¼Œå› ä¸º super æŒ‡å‘æ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯æŒ‡å‘å½“å‰å¯¹è±¡\nçš„åŸå‹å¯¹è±¡ï¼ˆçˆ¶å¯¹è±¡ï¼‰ï¼Œå³è¿™é‡ŒæŒ‡å‘çš„æ˜¯ person ã€‚\nsuper å¼•ç”¨çš„è¿‡ç¨‹ ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ²¡ä»€ä¹ˆåŒºåˆ«çš„ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬åšç»§æ‰¿æˆ–è€…è·å–å¯¹è±¡çš„åŸå‹çš„æ—¶å€™å°±å¾ˆæœ‰ç”¨äº†ï¼Œ\nå› ä¸º super çš„æŒ‡å‘æ˜¯å’Œ [[HomeObject]] å¯†åˆ‡ç›¸å…³çš„ï¼Œ super è·å–æŒ‡å‘çš„è¿‡ç¨‹ï¼š\n  é€šè¿‡åœ¨å½“å‰æ–¹æ³•çš„å†…éƒ¨å±æ€§ [[HomeObject]] ä¸Šé¢è°ƒç”¨ Object.getPrototypeOf()\nå»è·å–è¿™ä¸ªæ–¹æ³•æ‰€åœ¨å¯¹è±¡çš„åŸå‹å¯¹è±¡ï¼›\n  åœ¨åŸå‹å¯¹è±¡ä¸Šæœä¸è¿™ä¸ªå‡½æ•°åŒåå‡½æ•°ï¼›\n  æœ€åå°†è¿™ä¸ªåŒåå‡½æ•°ç»‘å®šå½“å‰çš„ this æ‰§è¡Œï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let person = { getGreeting() { return \u0026#34;Hello\u0026#34;; } }; // prototype is person let friend = { getGreeting() { return super.getGreeting() + \u0026#34;, hi!\u0026#34;; } }; Object.setPrototypeOf(friend, person); console.log(friend.getGreeting()); // \u0026#34;Hello, hi!\u0026#34;   æ¯”å¦‚ï¼Œä¸Šé¢çš„ä»£ç \n  å°† person è®¾ç½®ä¸º friend çš„åŸå‹ï¼Œæˆä¸ºå®ƒçš„çˆ¶å¯¹è±¡\n  è°ƒç”¨ friend.getGreeting() æ‰§è¡Œä¹‹ååœ¨å…¶å†…éƒ¨ä½¿ç”¨ super.getGreeting() è¿™\nä¸ªä¸€å¼€å§‹ä¼šæ‰¾åˆ° friend.getGreeting è¿™ä¸ªæ–¹æ³•çš„ [[HomeObject]] ä¹Ÿå°±æ˜¯ friend\n  ç„¶åæ ¹æ®æ‰åˆ°çš„ friend ï¼Œé€šè¿‡ Object.getPrototypeOf() ï¼Œå»æ‰¾åˆ°åŸå‹å¯¹è±¡ï¼Œ\nå³ person ï¼Œæ‰¾åˆ°ä¹‹åå†å»è¿™é‡Œé¢æ‰¾åŒåå‡½æ•° getGreeting\n  æ‰¾åˆ°ä¹‹åå°†è¯¥å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ç»‘å®šåˆ° this (å³ friend æ‰€åœ¨çš„ä¸Šä¸‹æ–‡ï¼‰ã€‚\n  æ‰§è¡ŒåŒåå‡½æ•°ï¼Œæ­¤æ—¶è¿™ä¸ªè™½æ˜¯åŸå‹(person)ä¸Šçš„å‡½æ•°ï¼Œä½†æ˜¯ä¸Šä¸‹æ–‡å·²ç»è¢«ç»‘å®šåˆ°\näº† friend ä¸Š\n  è¿‡ç¨‹ç®€å•æè¿°å°±æ˜¯ï¼š\nè®¾ç½®ç»§æ‰¿\n=\u0026gt; é‡å†™æ–¹æ³•\n=\u0026gt; super è°ƒç”¨çˆ¶çº§æ–¹æ³•\n=\u0026gt; æ‰¾å½“å‰å‡½æ•°çš„ [[HomeObject]]\n=\u0026gt; Object.getPrototypeOf([[HomeObject]]) æ‰¾åŸå‹\n=\u0026gt; æ‰¾åŸå‹ä¸ŠåŒåå‡½æ•°\n=\u0026gt; ç»‘å®šæ‰¾åˆ°çš„åŒåå‡½æ•°åˆ°å½“å‰çš„ this\n=\u0026gt; æ‰§è¡ŒåŒåå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  var person = { fnName: \u0026#39;person\u0026#39;, getName() { return this.fnName } } var child = { fnName: \u0026#39;child\u0026#39;, getName() { return super.getName() + \u0026#39;,\u0026#39; + this.fnName } } Object.setPrototypeOf(child, person) console.log(child.getName()) // child child   æ–¹æ³•å®šä¹‰ åœ¨ es6 ä¹‹å‰æ˜¯æ²¡æœ‰â€œæ–¹æ³•â€è¿™ä¸ªè¯çš„å®šä¹‰çš„ï¼Œä½†åœ¨ es6 ä¹‹åå¯¹æ–¹æ³•çš„å®šä¹‰æ‰æ­£å¼æœ‰äº†è§„å®šã€‚\nå‡½æ•°å’Œæ–¹æ³•å®šä¹‰ åœ¨å¯¹è±¡ä¸­çš„å‡½æ•°æ‰å«åšæ–¹æ³•ï¼Œéå¯¹è±¡ä¸­çš„å«åšå‡½æ•°ï¼Œä¸” es6 ç»™æ–¹æ³•å¢åŠ äº†ä¸€ä¸ª\n[[HomeObject]] å†…ç½®å±æ€§ï¼Œ å®ƒæŒ‡å‘çš„æ˜¯åŒ…å«è¿™ä¸ªæ–¹æ³•çš„é‚£ä¸ªå¯¹è±¡ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11  let person = { // method  getGreeting() { return \u0026#39;xxx\u0026#39; } } // not method function shareGreeting() { return \u0026#39;yyy\u0026#39; }   getGreeting å«åšæ–¹æ³•ï¼Œä¸”å…¶æœ‰ä¸ªå†…éƒ¨å±æ€§ [[HomeObject]] æŒ‡å‘äº† person è¯´æ˜è¿™\nä¸ªå¯¹è±¡æ‹¥æœ‰å®ƒã€‚\nshareGreeting å«åšå‡½æ•°ï¼Œä¸æ˜¯æ–¹æ³•\næ€»ç»“ æ›´æ–°å†…å®¹\n   å†…å®¹ ç¤ºä¾‹/è¯´æ˜     å±æ€§ç®€å†™ {name, age} \u0026lt;=\u0026gt; {name: name, age: age}   è®¡ç®—å±æ€§ { [first + 'name']: 'å¼ ä¸‰' }, { ['first name']: 'å¼ ä¸‰' }   ç®€å†™æ–¹æ³• { getName() {} }   é‡å¤å±æ€§ååˆæ³•åŒ– { age: 10, age: 100 } \u0026lt;=\u0026gt; { age: 100 }   Object.assign åˆå¹¶å¯¹è±¡ æµ…æ‹·è´ï¼Œå†…éƒ¨ = å®ç°æ‹·è´   Object.is åŠ å¼ºåˆ¤æ–­ï¼Œå¼¥è¡¥ === ä¸èƒ½åˆ¤æ–­ +0, -0 å’Œ NaN, NaN é—®é¢˜   å›ºå®šå¯¹è±¡å±æ€§æšä¸¾é¡ºåº number \u0026gt; string \u0026gt; symbol, string å’Œ symbol æŒ‰ç…§å¢åŠ å…ˆåé¡ºåºæ’åˆ—   Object.setPrototypeOf å¯æ”¹å˜å¯¹è±¡åŸå‹   super æŒ‡å‘åŸå‹å¯¹è±¡ï¼Œå¯é€šè¿‡å®ƒå»è®¿é—®åŸå‹å¯¹è±¡ä¸­çš„æ–¹æ³•    æ•°æ®è§£æ„ è§£æ„ä¼˜åŠ¿ åœ¨ es5 åŠä¹‹å‰å¦‚æœæˆ‘ä»¬æƒ³è¦ä»å¯¹è±¡ä¸­å–å‡ºå±æ€§çš„å€¼ï¼Œåªèƒ½é€šè¿‡æ™®é€šçš„èµ‹å€¼è¡¨è¾¾å¼æ¥å®ç°ï¼Œ\nä¸€ä¸ªè¿˜å¥½ï¼Œå¦‚æœæ˜¯å¤šä¸ªçš„è¯å°±ä¼šå‡ºç°å¾ˆé‡å¤çš„ä»£ç ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10  let options = { repeat: true, save: false } let repeat = options.repeat, save = options.save // if more ???   ä¸Šé¢åªæ˜¯å–ä¸¤ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå¦‚æœå¾ˆå¤šå‘¢ï¼Œåå‡ ä¸ªäºŒåå‡ ä¸ªï¼Ÿï¼Ÿ\nä¸ä»…ä»£ç é‡å¤§ï¼Œè¿˜ä¸ç¾è§‚ã€‚\nå› æ­¤ es6 åŠ å…¥äº†è§£æ„ç³»ç»Ÿï¼Œè®©è¿™äº›æ“ä½œå˜çš„å¾ˆå®¹æ˜“ï¼Œå¾ˆç®€æ´ã€‚\nå¯¹è±¡è§£æ„ å¯¹è±¡è§£æ„çš„æ—¶å€™ï¼Œç­‰å·å³è¾¹ä¸èƒ½æ˜¯ null æˆ– undefined ï¼Œè¿™æ ·ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯å› ä¸ºï¼Œ\næ— è®ºä»€ä¹ˆæ—¶å€™å»è¯»å– null æˆ– undefined çš„å±æ€§éƒ½ä¼šå‡ºå‘è¿è¡Œæ—¶é”™è¯¯ã€‚\nå£°æ˜å¼è§£æ„ è§£æ„çš„åŒæ—¶å£°æ˜è§£æ„åèµ‹å€¼çš„å˜é‡ï¼š\n1 2 3 4 5 6 7 8 9  let node = { type: \u0026#39;Identifier\u0026#39;, name: \u0026#39;foo\u0026#39; } let { type, name } = node console.log(type) // Identifier console.log(name) // foo   åœ¨ä½¿ç”¨è§£æ„çš„è¿‡ç¨‹ä¸­å¿…é¡»è¦æœ‰å³è¾¹çš„åˆå§‹å€¼ï¼Œè€Œä¸èƒ½åªæ˜¯ç”¨æ¥å£°æ˜å˜é‡ï¼Œè¿™æ˜¯ä¸åˆæ³•çš„\næ“ä½œ, æ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8  // syntax error! var { type, name }; // syntax error! let { type, name }; // syntax error! const { type, name };   å…ˆå£°æ˜åè§£æ„ æœ‰æ—¶å€™æœ‰äº›å˜é‡æ—©å·²ç»å­˜åœ¨äº†ï¼Œåªæ˜¯åé¢æˆ‘ä»¬éœ€è¦å°†å®ƒçš„å€¼æ”¹å˜ï¼Œä¹Ÿæ­£å¥½æ˜¯éœ€è¦ä»å¯¹è±¡\nä¸­å»å–å€¼ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯å…ˆå£°æ˜åè§£æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34; }, // è¿™é‡Œå˜é‡å·²ç»å£°æ˜å¥½äº†  type = \u0026#34;Literal\u0026#34;, name = 5; // assign different values using destructuring ({ type, name } = node); console.log(type); // \u0026#34;Identifier\u0026#34; console.log(name); // \u0026#34;foo\u0026#34;   è¿™ä¸ªæ—¶å€™å¿…é¡»ç”¨ () å°†è§£æ„è¯­å¥åŒ…èµ·æ¥ï¼Œè®©å…¶æˆä¸ºä¸€ä¸ªæ‰§è¡Œè¯­å¥ï¼Œå¦‚æœä¸ï¼Œå·¦è¾¹å°±ç›¸\nå½“äºä¸€ä¸ªå—çº§è¯­å¥ï¼Œç„¶è€Œå—çº§è¯­å¥æ˜¯ä¸èƒ½å‡ºç°åœ¨ç­‰å¼çš„å·¦è¾¹çš„ã€‚\nåœ¨è¿™åŸºç¡€ä¸Šï¼Œå¦ä¸€ç§æƒ…å†µæ˜¯å°† {type, name} = node ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°çš„æ—¶å€™ï¼Œ\nè¿™ä¸ªæ—¶å€™ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°å…¶å®å°±æ˜¯ node æœ¬èº«ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34; }, type = \u0026#34;Literal\u0026#34;, name = 5; function outputInfo(value) { console.log(value === node); } outputInfo({ type, name } = node); // true  console.log(type); // \u0026#34;Identifier\u0026#34; console.log(name); // \u0026#34;foo\u0026#34;   è§£æ„é»˜è®¤å€¼ åœ¨è§£æ„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å·¦è¾¹å£°æ˜çš„å˜é‡åœ¨å³è¾¹çš„å¯¹è±¡ä¸­å¹¶ä¸å­˜åœ¨æˆ–è€…å€¼ä¸º undefined\nçš„æ—¶å€™ï¼Œè¿™ä¸ªå˜é‡çš„å€¼å°†ä¼šèµ‹å€¼ä¸º undefined ï¼Œå› æ­¤è¿™ä¸ªæ—¶å€™å°±éœ€è¦é’ˆå¯¹è¿™ç§æƒ…å†µ\næœ‰ä¸ªé»˜è®¤å¤„ç†ï¼Œå³è¿™é‡Œçš„è§£æ„é»˜è®¤å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34; }; let { type, name, value } = node; console.log(type); // \u0026#34;Identifier\u0026#34; console.log(name); // \u0026#34;foo\u0026#34; console.log(value); // undefined   å±æ€§å€¼ä¸º undefined çš„æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34;, value: undefined }; let { type, name, value = 0 } = node; console.log(type); // \u0026#34;Identifier\u0026#34; console.log(name); // \u0026#34;foo\u0026#34; console.log(value); // 0   å±æ€§å˜é‡é‡å‘½å è§£æ„å‡ºæ¥ä¹‹åï¼Œå¯èƒ½ä¸æƒ³æ²¿ç”¨å³è¾¹å¯¹è±¡ä¸­çš„å±æ€§åï¼Œå› æ­¤éœ€è¦å°†å·¦è¾¹çš„å˜é‡åç§°é‡å‘½åï¼š\n1 2 3 4 5 6 7 8 9  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34; }; let { type: localType, name: localName } = node; console.log(localType); // \u0026#34;Identifier\u0026#34; console.log(localName); // \u0026#34;foo\u0026#34;   é‡å‘½å + é»˜è®¤å€¼:\n1 2 3 4 5 6 7 8 9  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34; }; let { type: localType, name: localName = \u0026#39;xxx\u0026#39; } = node; console.log(localType); // \u0026#34;Identifier\u0026#34; console.log(localName); // \u0026#34;foo\u0026#34;   å¤šçº§å¯¹è±¡è§£æ„ å³è¾¹å¯¹è±¡ä¸­çš„å±æ€§çš„å€¼ä¸ä¸€å®šæ˜¯æ™®é€šç±»å‹ï¼Œå¯èƒ½æ˜¯å¯¹è±¡ï¼Œæˆ–å¯¹è±¡ä¸­åŒ…å«å¯¹è±¡ï¼Œæ•°ç»„ç­‰ç­‰\nç±»å‹ï¼Œæ¬¡æ•°å¯ä»¥ä½¿ç”¨å†…åµŒå¯¹è±¡è§£æ„æ¥è¿›è¡Œè§£æ„ï¼š\nåŸåˆ™å°±æ˜¯å·¦è¾¹çš„å˜é‡çš„ç»“æ„è¦å’Œå³è¾¹å®é™…å¯¹è±¡ä¸­çš„ç»“æ„ä¿æŒä¸€è‡´\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34;, loc: { start: { line: 1, column: 1 }, end: { line: 1, column: 4 } } }; let { loc: { start }} = node; console.log(start.line); // 1 console.log(start.column); // 1   å¤šå±‚è§£æ„é‡å‘½åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34;, loc: { start: { line: 1, column: 1 }, end: { line: 1, column: 4 } } }; // é‡å‘½å let { loc: { start: localStart }} = node; console.log(start.line); // 1 console.log(start.column); // 1    #+BEGINQUOTE\nè¯­æ³•é™·é˜± 1 2  // no variables declared! let { loc: {} } = node;   è¿™ç§å½¢å¼å®é™…ä¸Šæ˜¯æ²¡ä»»ä½•ä½œç”¨çš„ï¼Œå› ä¸ºå·¦è¾¹çš„ loc åªæ˜¯èµ·åˆ°äº†ç«™ä½çš„ä½œç”¨ï¼Œå®é™…èµ·\nä½œç”¨çš„æ˜¯åœ¨ {} é‡Œé¢ï¼Œä½†æ˜¯é‡Œé¢æ²¡ä»»ä½•ä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä¸ä¼šè§£æ„å‡ºä»»ä½•ä¸œè¥¿ï¼Œä¹Ÿ\nä¸ä¼šäº§ç”Ÿä»»ä½•æ–°çš„å˜é‡ã€‚\n#+ENDQUOTE\næ•°ç»„è§£æ„ æ•°ç»„è§£æ„å’Œå¯¹è±¡è§£æ„ç”¨æ³•åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œæ— éå°±æ˜¯è®² {} æ”¹æˆæ•°ç»„çš„ [] ï¼Œå’Œå¯¹è±¡\nä¸€æ ·ï¼Œå³è¾¹ä¸å¯ä»¥æ˜¯ null å’Œ undefined\n   è¡¨è¾¾å¼ ç»“æœ è¯´æ˜     let [first, second] = [1, 2] first = 1, first = 2 æ™®é€šè§£æ„   let [ , , third] = [1, 2, 3] third = 3 ç©ºç½®è§£æ„ï¼ŒåªæŒ‡å®šæŸä¸ªä½ç½®è§£æ„   let first = 1, second = 2 =\u0026gt; [first, second] = [11, 22] first = 11, second = 22 å…ˆå£°æ˜å†è§£æ„   let a = 1, b = 2 =\u0026gt; [a, b] = [b, a] a = 2, b = 1 æ›¿æ¢å€¼å¿«æ·æ–¹å¼   let [a = 1, b] = [11, 22] a = 11, b = 22 é»˜è®¤å€¼   let [a = 1, b] = [, 22] a = 1, b = 22 é»˜è®¤å€¼   let [a, b = 2] = [ 1 ] a = 1, b = 2 é»˜è®¤å€¼   let [a, [b]] = [1, [2]] a = 1, b = 2 åµŒå¥—è§£æ„   let [a, [b]] = [1, [2, 3], 4] a = 1, b = 2 åµŒå¥—è§£æ„   let [a, [b], c] = [1, [2, 3], 4] a = 1, b = 2, c = 4 å¤æ‚è§£æ„   let [a, ...bs] = [1, 2, 3, 4, 5] a = 1, bs = [2, 3, 4, 5] rest ç¬¦å·è§£æ„   [1, 2, 3].concat() =\u0026gt; [1, 2, 3] =\u0026gt; es6: [...as] = [1, 2, 3] as = [1, 2, 3] å…‹éš†æ•°ç»„    æ··åˆè§£æ„ æ··åˆè§£æ„æ„å‘³ç€è¢«è§£æ„çš„å¯¹è±¡ä¸­å¯èƒ½æ—¢åŒ…å«å¯¹è±¡ç”±åŒ…å«æ•°ç»„ï¼Œä¹Ÿæ˜¯æŒ‰ç…§å¯¹è±¡å’Œæ•°ç»„çš„è§£\næ„åŸç†è¿›è¡Œè§£æ„å°±OKã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  let node = { type: \u0026#34;Identifier\u0026#34;, name: \u0026#34;foo\u0026#34;, loc: { start: { line: 1, column: 1 }, end: { line: 1, column: 4 } }, range: [0, 3] }; let { loc: { start }, range: [ startIndex ] } = node; console.log(start.line); // 1 console.log(start.column); // 1 console.log(startIndex); // 0   å‚æ•°è§£æ„ å‚æ•°è§£æ„ï¼Œå³å‡½æ•°åœ¨å£°æ˜çš„æ—¶å€™ï¼Œå‚æ•°æ˜¯é‡‡ç”¨è§£æ„ç­‰å¼å·¦è¾¹çš„å½¢å¼ä¹¦å†™ï¼Œè¿™ç§å°±éœ€è¦è¦\næ±‚åœ¨è°ƒç”¨çš„æ—¶å€™, è¿™ä¸ªå‚æ•°ä½ç½®å¿…é¡»æœ‰ä¸ªé null å’Œ Undefined å€¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼ŒåŸå› \nä¸€æ ·è§£æ„æ—¶å€™æ— æ³•ä» null æˆ– undefined è¯»å–å±æ€§ã€‚\nè¢«è§£æ„çš„å‚æ•°å±æ€§åˆ—è¡¨ å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9  function setCookie(name, value, { secure, path, domain, expires }) { // code to set the cookie } setCookie(\u0026#34;type\u0026#34;, \u0026#34;js\u0026#34;, { secure: true, expires: 60000 })   ä¸ä¼ å€¼å¾—éæ³•æ“ä½œï¼š\n1 2  // Error! setCookie(\u0026#34;type\u0026#34;, \u0026#34;js\u0026#34;);   è¿™æ ·ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ undefined æŠ¥é”™ã€‚\nä¼˜åŒ–å‚æ•°è§£æ„å†™æ³•æœ‰ä¸¤ç§ï¼š\n å‡½æ•°ä½“å†…è§£æ„ è§£æ„ä½“é»˜è®¤å€¼æ–¹å¼(æ¨è)  å‡½æ•°ä½“å†…è§£æ„ï¼š 1 2 3 4 5 6 7  function setCookie(name, value, options) { // å‡½æ•°ä½“å†…è§£æ„ï¼Œç»™ä¸ªé»˜è®¤å€¼ || {} ï¼Œæˆ–è€…åœ¨å‚æ•°é‚£é‡Œè¿™æ ·ï¼š (name, value, options = {})  let { secure, path, domain, expires } = options || {}; // code to set the cookie }   æˆ–è€…ï¼š\n1 2 3 4 5 6 7  function setCookie(name, value, options = {}) { let { secure, path, domain, expires } = options; // code to set the cookie }   ç›´æ¥å‚æ•°è§£æ„ä½“ç»™é»˜è®¤å€¼ï¼š 1 2 3 4  function setCookie(name, value, { secure, path, domain, expires } = {}) { // ... }   é»˜è®¤å€¼ï¼Œå¦‚æœä¸ä¼ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå®ƒçš„é»˜è®¤å€¼å°±æ˜¯ {} é¿å…è§£æ„å‡ºé”™ã€‚\nè§£æ„çš„å‚æ•°é»˜è®¤å€¼ å’Œæ™®é€šå¯¹è±¡ä¸€æ ·ï¼Œè§£æ„å‡ºæ¥çš„å‚æ•°æˆ‘ä»¬è¿˜å¯ä»¥ç»™ä»–ä»¬ä¸€ä¸ªé»˜è®¤å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11  function setCookie(name, value, { secure = false, path = \u0026#34;/\u0026#34;, domain = \u0026#34;example.com\u0026#34;, expires = new Date(Date.now() + 360000000) } = {} ) { // ... }    ç¬¬ä¸‰ä¸ªå‚æ•°æ²¡ä¼ ï¼Œå››ä¸ªå‚æ•°éƒ½å–é»˜è®¤å€¼ ç¬¬ä¸‰ä¸ªå‚æ•°æœ‰ä¼ é€’ï¼Œæ ¹æ®æ™®é€šå¯¹è±¡å®šä¹‰è§£æ„  æ€»ç»“  å¯¹è±¡ï¼Œå…ˆå£°æ˜å†è§£æ„ï¼Œè¡¨è¾¾å¼å¿…é¡»ç”¨ () åŒ…èµ·æ¥ï¼Œä½œä¸ºè¡¨è¾¾å¼æ‰§è¡Œ å¯¹è±¡æ•°ç»„è§£æ„éƒ½å¯ä»¥ç»™é»˜è®¤å€¼ï¼Œé‡å‘½åï¼Œå¤šå±‚è§£æ„ï¼Œæ··åˆè§£æ„ è§£æ„éµå¾ªå·¦ä¾§æœ€å†…å±‚çš„å˜é‡å£°æ˜ï¼Œå¦‚æœå·¦ä¾§æœ€å†…å±‚æ— ä»»ä½•å˜é‡ï¼Œåˆ™è§£æ„è¡¨è¾¾å¼æ— ä»»ä½•æ„ä¹‰ å‚æ•°è§£æ„ï¼Œè¦ä¹ˆç»™å½“å‰å‚æ•°é»˜è®¤å€¼ï¼Œè¦ä¹ˆä¿è¯è°ƒç”¨æ—¶è¯¥å‚æ•°éƒ½æœ‰ä¼ å…¥é null æˆ–\nundefined çš„å€¼ï¼Œæ¨èå‚æ•°é»˜è®¤å€¼  ç¬¦å·å’Œç¬¦å·å±æ€§(Symbols) ç¬¦å·ç±»å‹å€¼(Symbol())æ˜¯ es6 æ–°å¢çš„ä¸€ç§åŸå§‹æ•°æ®ç±»å‹å’Œ strings, numbers,\nbooleans, null å’Œ undefined å±äºåŸå§‹å€¼ç±»å‹ã€‚\nå®ƒç›¸å½“äºæ•°å­—çš„ 42 æˆ–å­—ç¬¦ä¸²çš„ \u0026ldquo;hello\u0026rdquo; ä¸€æ ·ï¼Œåªæ˜¯å•ç©¿çš„ä¸€äº›å€¼ï¼Œå› æ­¤ä¸èƒ½å¯¹å…¶ä½¿\nç”¨ new Symbol() å¦åˆ™ä¼šæŠ¥é”™ã€‚\nç¬¦å·ç±»å‹æ˜¯ä½œä¸ºä¸€ç§åˆ›å»ºç§æœ‰å¯¹è±¡æˆå‘˜çš„ç±»å‹ï¼Œåœ¨ es6 ä¹‹å‰æ˜¯æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥åŒºåˆ†æ™®\né€šå±æ€§å’Œç§æœ‰å±æ€§çš„ã€‚\næ–°å¢å±æ€§æˆ–æ–¹æ³• Symbol.description2019 è¿”å›ç¬¦å·å˜é‡çš„æè¿°ã€‚\nå¦‚ï¼š Symbol('my symbol') çš„ Symbol.description å€¼ä¸º \u0026lsquo;my symbol\u0026rsquo;ã€‚\nä¹Ÿå°±æ˜¯è¿”å›å†…ç½®å±æ€§ [[Description] ] çš„å€¼ã€‚\nåˆ›å»ºç¬¦å· ç¬¦å·ç±»å‹ä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«å”¯ä¸€å€¼å¾—ç¬¦å·å˜é‡ï¼Œè¿™äº›å˜é‡æ˜¯æ²¡æœ‰å®é™…å­—é¢é‡è¡¨ç¤ºçš„ï¼Œä¹Ÿå°±\næ˜¯è¯´ä¸€æ—¦ç¬¦å·å˜é‡åˆ›å»ºä¹‹åï¼Œåªèƒ½é€šè¿‡è¿™ä¸ªå˜é‡å»è®¿é—®ä½ æ‰€åˆ›å»ºçš„è¿™ä¸ªç¬¦å·ç±»å‹ã€‚\nåˆ›å»ºç¬¦å· é€šè¿‡ Symbol([ description ]) æ¥åˆ›å»ºç¬¦å·ï¼Œåˆ›å»ºè¿‡ç¨‹ï¼š\n å¦‚æœ description æ˜¯ undefined, è®© descString = undefined å¦åˆ™ descString = ToString(description) è®©å†…éƒ¨å€¼ [[Description]] ä¸º descString è¿”å›ä¸€ä¸ªå”¯ä¸€çš„ Symbol å€¼  1 2 3 4 5 6 7 8 9 10 11 12  let firstName = Symbol(); let secondName = Symbol(); let person = {}; person[firstName] = \u0026#34;Nicholas\u0026#34;; console.log(person[firstName]); // \u0026#34;Nicholas\u0026#34;  console.log(firstName) console.log(secondName) console.log(firstName == secondName) console.log(firstName === secondName) console.log(Object.is(firstName, secondName))   +RESULTS:\nNicholas Symbol() Symbol() false false false  firstName æ˜¯å­˜æ”¾äº†ä¸€ä¸ªå”¯ä¸€å€¼å¾—ç¬¦å·ç±»å‹å˜é‡ï¼Œå¹¶ä¸”ç”¨æ¥ä½œä¸º person å¯¹è±¡çš„ä¸€\nä¸ªå±æ€§ä½¿ç”¨ã€‚\nå› æ­¤ï¼Œå¦‚æœè¦è®¿é—®å¯¹è±¡ä¸­çš„å¯¹åº”çš„è¿™ä¸ªå±æ€§çš„å€¼ï¼Œæ¯æ¬¡éƒ½å¿…é¡»ä½¿ç”¨ firstName è¿™ä¸ª\nç¬¦å·å˜é‡å»è®¿é—®ã€‚\n å¦‚æœéœ€è¦å®åœ¨éœ€è¦ç¬¦å·ç±»å‹å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ new Object(Symbol()) å»åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œ\nè€Œä¸èƒ½ç›´æ¥ new Symbol() å› ä¸º Symbol() å¾—åˆ°çš„æ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œå°±åƒä½ ä¸èƒ½ç›´æ¥\nnew 42 ä¸€ä¸ªé“ç†ã€‚\n å¸¦å‚æ•°çš„ Symbol(arg) æœ‰æ—¶å€™å¯èƒ½éœ€è¦å¯¹åˆ›å»ºçš„ç¬¦å·åšä¸€äº›ç®€å•çš„åŒºåˆ†ï¼Œæˆ–è€…è®©å…¶æ›´åŠ è¯­ä¹‰åŒ–ï¼Œå¯ä»¥åœ¨åˆ›å»ºçš„\næ—¶å€™ç»™ Symbol() å‡½æ•°\nä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°æœ¬èº«å¹¶æ²¡æœ‰å®é™…çš„ç”¨é€”ï¼Œä½†æ˜¯æœ‰åˆ©äºä»£ç è°ƒè¯•ã€‚\n1 2 3 4 5 6 7 8 9 10  let firstName = Symbol(\u0026#34;first name\u0026#34;); let person = {}; person[firstName] = \u0026#34;Nicholas\u0026#34;; console.log(\u0026#34;first name\u0026#34; in person); // false console.log(person[firstName]); // \u0026#34;Nicholas\u0026#34; console.log(firstName); // \u0026#34;Symbol(first name)\u0026#34; console.log(firstName.description) // undefined console.log(Symbol(\u0026#39;xxx\u0026#39;).description) // undefined   +RESULTS:\nfalse Nicholas Symbol(first name) undefined undefined  å¦‚è¾“å‡ºï¼Œå‚æ•°ä¼šä¸€å¹¶è¾“å‡ºï¼Œå› æ­¤æ¨èä½¿ç”¨çš„æ—¶å€™åŠ ä¸Šå‚æ•°ï¼Œè¿™æ ·åœ¨è°ƒè¯•çš„æ—¶å€™ä½ å°±èƒ½åŒº\nåˆ†å¼€å“ªä¸ªç¬¦å·æ¥è‡ªå“ªé‡Œï¼Œè€Œä¸è‡³äºè¾“å‡ºéƒ½æ˜¯ Symbol() æ— æ³•åŒºåˆ†ã€‚\nå‚æ•°ä½œä¸ºç¬¦å·çš„ä¸€ç§æè¿°æ€§è´¨ç‰¹å¾è¢«å‚¨å­˜åœ¨äº†å†…éƒ¨ [[Description]] å±æ€§ä¸­ï¼Œè¿™ä¸ªå±æ€§\nä¼šåœ¨å¯¹ç¬¦å·è°ƒç”¨ toString() (éšå¼æˆ–æ˜¾ç¤ºè°ƒç”¨)çš„æ—¶å€™å»è¯»å–å®ƒçš„å€¼ï¼Œé™¤äº†è¿™ä¸ªæ²¡æœ‰\nå…¶ä»–æ–¹æ³•å¯ä»¥ç›´æ¥å»è®¿é—® [[Description]] ã€‚\nç¬¦å·ç±»å‹æ£€æµ‹(typeof) ç”±äºç¬¦å·å±äºåŸå§‹å€¼ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡ typeof å°±å¯ä»¥å»åˆ¤æ–­å˜é‡æ˜¯ä¸æ˜¯ç¬¦å·ç±»å‹ï¼Œ\nes6 å¯¹ typeof è¿›è¡Œäº†æ‰©å±•ï¼Œå¦‚æœæ˜¯ç¬¦å·ç±»å‹æ£€æµ‹çš„ç»“æœå€¼æ˜¯â€œsymbolâ€\n1 2 3  let symbol = Symbol(\u0026#34;test symbol\u0026#34;) console.log(typeof symbol) // \u0026#34;symbol\u0026#34;   +RESULTS:\nsymbol  ä½¿ç”¨ç¬¦å· ä¹‹å‰çš„ä¾‹å­ä¸­ä½¿ç”¨å˜é‡ä½œä¸ºå¯¹è±¡å±æ€§åçš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ç¬¦å·æ¥æ›¿ä»£ï¼Œå¹¶ä¸”è¿˜å¯ä»¥å¯¹ç¬¦å·\nç±»å‹çš„å±æ€§è¿›è¡Œå®šåˆ¶ï¼Œè®©å…¶å˜æˆåªè¯»çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  // åˆ›å»ºç¬¦å·ï¼Œå”¯ä¸€ let firstName = Symbol(\u0026#39;first name\u0026#39;) let person = { // ç›´æ¥å½“åšè®¡ç®—å±æ€§ä½¿ç”¨  [firstName]: \u0026#39;å¼ ä¸‰\u0026#39; } // è®©å±æ€§åªè¯» Object.defineProperty(person, firstName, { writable: false }) let lastName = Symbol(\u0026#39;last name\u0026#39;) Object.defineProperties(person, { [lastName]: { value: \u0026#39;æå››\u0026#39;, writable: false } }) console.log(person[firstName]) console.log(person[lastName])   +RESULTS:\nå¼ ä¸‰ æå››  åˆ†äº«ç¬¦å· åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼š\nå‡è®¾æŸä¸ªåœ°æ–¹å£°æ˜äº†ä¸€ä¸ªç¬¦å·ç±»å‹åŠä¸€ä¸ªä½¿ç”¨äº†è¿™ä¸ªç¬¦å·ä½œä¸ºå±æ€§ key çš„å¯¹è±¡ï¼Œå“ªå¤©\nå¦‚æœæˆ‘æƒ³åœ¨å…¶ä»–åœ°æ–¹å»ä½¿ç”¨å®ƒï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿï¼Ÿ\nå¦‚ä»Šæ¨¡å—åŒ–å¾—åˆ°æ™®åŠï¼Œç°åœ¨ç»å¸¸éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªæ¨¡å—ï¼Œç”¨çš„æ—¶å€™å¯¼å…¥è¿™ä¸ªæ–‡ä»¶å¾—åˆ°ç›¸åº”çš„å¯¹è±¡\nä½†ç”±äºç¬¦å·å€¼æ˜¯å”¯ä¸€çš„ï¼Œé‚£å¤–éƒ¨æ¨¡å—åˆæ€ä¹ˆçŸ¥é“å¦ä¸€ä¸ªæ¨¡å—å†…éƒ¨ç”¨äº†æ€æ ·çš„ç¬¦å·å€¼ä½œä¸ºå¯¹è±¡ï¼Ÿï¼Ÿ\nè¿™å°±æ˜¯ä¸‹é¢è¦è®²çš„â€œç¬¦å·åˆ†äº«â€é—®é¢˜ã€‚\n å…¨å±€ç¬¦å·æ³¨å†Œè¡¨(Global Symbol Registry) ä¼šåœ¨æ‰€æœ‰ä»£ç æ‰§è¡Œä¹‹å‰å°±åˆ›å»ºå¥½ï¼Œä¸”åˆ—è¡¨ä¸ºç©ºã€‚\nå®ƒå’Œå…¨å±€å¯¹è±¡ä¸€æ ·å±äºç¯å¢ƒå˜é‡ï¼Œå› æ­¤ä¸è¦å»å‡è®¾å®ƒæ˜¯ä»€ä¹ˆæˆ–å®ƒä¸å­˜åœ¨ä¹‹ç±»çš„ï¼Œå› æ­¤å®ƒåœ¨æ‰€æœ‰ä»£ç æ‰§è¡Œä¹‹å‰\nå°±åˆ›å»ºå¥½äº†ï¼Œæ‰€ä»¥å®ƒæ˜¯ç¡®ç¡®å®å®å­˜åœ¨çš„ã€‚\n Symbol.for() åœ¨ä¹‹å‰æˆ‘ä»¬é€šè¿‡ let firstName = Symbol('first name'); æ¥åˆ›å»ºä¸€ä¸ªç¬¦å·å˜é‡ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™å¿…é¡»çš„ç”¨\nfirstName å»ä½¿ç”¨è¿™ä¸ªå˜é‡ï¼Œè€Œç°åœ¨æˆ‘ä»¬æƒ³å°†ç¬¦å·åˆ†äº«å‡ºå»éœ€è¦ç”¨åˆ° Symbol.for() ã€‚\nSymbol.for(description) ä¼šé’ˆå¯¹ description å»åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ç¬¦å·å€¼ï¼š\n1 2 3 4 5 6 7  let uid = Symbol.for(\u0026#34;uid\u0026#34;); let object = {}; object[uid] = \u0026#34;12345\u0026#34;; console.log(object[uid]); // \u0026#34;12345\u0026#34; console.log(uid); // \u0026#34;Symbol(uid)\u0026#34;   Symbol.for(desc) åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå»â€œå…¨å±€ç¬¦å·æ³¨å†Œè¡¨(global symbol registry)â€ ä¸­å»æŸ¥æ‰¾\nè¿™ä¸ª desc å¯¹åº”çš„ç¬¦å·å€¼ï¼Œæ‰¾åˆ°äº†å°±è¿”å›è¿™ä¸ªç¬¦å·å€¼ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç¬¦å·å€¼å¹¶ä¸”å°†å®ƒæ³¨å†Œåˆ°å…¨å±€ç¬¦å·æ³¨å†Œè¡¨ä¸­ï¼Œ\nä¾›ä¸‹æ¬¡è°ƒç”¨æ—¶ä½¿ç”¨ã€‚\n-â€”\nSymbol.for(key) å†…éƒ¨å®ç°æ­¥éª¤(ä¼ªä»£ç )ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  Symbol.for = function (key) { // 1 key è½¬å­—ç¬¦ä¸²  let stringKey = ToString(key); // 2. éå† GlobalSymbolRegistryList æ³¨å†Œè¡¨  for (let e in GlobalSymbolRegistryList) { // ç¬¦å·å€¼å·²ç»å­˜åœ¨  if (SameValue(e.[[Key]], stringKey)) { return e.[[Symbol]]; } } // 3. æ³¨å†Œè¡¨ä¸­ä¸å« `stringKey` çš„ç¬¦å·å€¼ï¼Œåˆ™åˆ›å»ºæ–°çš„ç¬¦å·å€¼  // 3.1 æ–°å»ºç¬¦å·å€¼  let newSymbol = Symbol(stringKey); // 3.1 ç»™ [[Description]] èµ‹å€¼  newSymbol.[[Description]] = stringKey; // 4. æ³¨å†Œåˆ°ç¬¦å·æ³¨å†Œè¡¨ä¸­å»  GlobalSymbolRegistryList.push({ [[Key]]: stringKey, [[Symbol]]: newSymbol }); // 5. è¿”å›æ–°å»ºçš„ç¬¦å·å€¼  return newSymbol; }   æ€»ç»“èµ·æ¥ä¸º3ä¸ªæ­¥éª¤ï¼š æŸ¥æ‰¾ -\u0026gt; æ–°å»º -\u0026gt; æ³¨å†Œ\næ³¨å†Œè¡¨ä¸­çš„æ¯ä¸ªç¬¦å·ç‰‡æ®µæ˜¯ä»¥å¯¹è±¡å½¢å¼å­˜åœ¨(å¯¹è±¡ä¸­åŒ…å« Key å’Œ Symbol ä¸¤ä¸ªå±æ€§åˆ†åˆ«è¡¨ç¤ºåˆ›å»ºæ—¶çš„æè¿°å’Œç¬¦å·å€¼)ã€‚\nä½¿ç”¨åˆ†äº«ç¬¦å· åœ¨ä¸Šä¸€èŠ‚7.4.1 ä¸­æˆ‘ä»¬æè¿°è¿‡äº†ç”¨æ¥åˆ›å»ºåˆ†äº«ç¬¦å·çš„ Symbol.for(desc) æ¥å£ï¼Œè¿™é‡Œå°†æ¢è®¨å¦‚ä½•å…·ä½“ä½¿ç”¨å®ƒæ¥åˆ†äº«ç¬¦å·å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  let uid = Symbol.for(\u0026#34;uid\u0026#34;); let object = { [uid]: \u0026#34;12345\u0026#34; }; console.log(object[uid]); // \u0026#34;12345\u0026#34; console.log(uid); // \u0026#34;Symbol(uid)\u0026#34;  let uid2 = Symbol.for(\u0026#34;uid\u0026#34;); console.log(uid === uid2); // true console.log(object[uid2]); // \u0026#34;12345\u0026#34; console.log(uid2); // \u0026#34;Symbol(uid)   åœ¨å½“å‰ä»£ç è¿è¡Œçš„å…¨å±€ä½œç”¨åŸŸä¸­éƒ½å¯ä»¥åˆ†äº«åˆ°ä¸€ä»½ Symbol.for(\u0026quot;uid\u0026quot;) ç¬¦å·ï¼Œåªéœ€è¦è°ƒç”¨å®ƒå°±å¯ä»¥æ‹¿åˆ°é‚£ä¸ª\nå”¯ä¸€çš„å€¼ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  function createObj1() { let uid = Symbol.for(\u0026#34;uid\u0026#34;); let object = { [uid]: \u0026#34;12345\u0026#34; }; return object } function createObj2() { let uid = Symbol.for(\u0026#34;uid\u0026#34;); let object = { [uid]: \u0026#34;67890\u0026#34; }; return object } let uid1 = Symbol.for(\u0026#34;uid\u0026#34;); const obj1 = createObj1() let uid2 = Symbol.for(\u0026#34;uid\u0026#34;); const obj2 = createObj2() console.log(uid1 === uid2); console.log(obj1[uid1]); console.log(obj1[uid2]); console.log(obj2[uid1]); console.log(obj2[uid2]);   +RESULTS:\ntrue 12345 12345 67890 67890  Symbol.keyFor(symbolValue) æˆ‘ä»¬å¦‚æœæƒ³åˆ›å»ºæˆ–è·å–å…¨å±€æ³¨å†Œè¡¨ä¸­çš„ç¬¦å·æ˜¯å¯ä»¥é€šè¿‡ 7.4.1 ä¸­çš„ Symbol.for(key) ï¼Œä½†æ˜¯\nå¦‚æœæˆ‘ä»¬åªçŸ¥é“ä¸€ä¸ªç¬¦å·å€¼å˜é‡çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Symbol.for(key) å°±æ²¡æ³•ä»æ³¨å†Œè¡¨ä¸­å–å€¼äº†ã€‚\nå› æ­¤ï¼Œè¿™é‡Œå°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Symbol.keyFor(symbolValue) å»æ ¹æ®ç¬¦å·å˜é‡æŸ¥æ‰¾æ³¨å†Œè¡¨ä¸­çš„å€¼ã€‚\nåœ¨è¿™ä¹‹å‰éœ€è¦çŸ¥é“\n Symbol.for(key) åˆ›å»ºçš„ç¬¦å·æ‰ä¼šè¿›å…¥å…¨å±€æ³¨å†Œè¡¨ Symbol() ç›´æ¥åˆ›å»ºçš„æ˜¯ä¸ä¼šåŠ å…¥å…¨å±€æ³¨å†Œè¡¨çš„  ä¹Ÿå°±æœ‰äº†ä¸‹é¢çš„ä»£ç åŠç»“æœï¼š\n1 2 3 4 5 6 7 8  let uid = Symbol.for(\u0026#34;uid\u0026#34;); console.log(Symbol.keyFor(uid)); // \u0026#34;uid\u0026#34;  let uid2 = Symbol.for(\u0026#34;uid\u0026#34;); console.log(Symbol.keyFor(uid2)); // \u0026#34;uid\u0026#34;  let uid3 = Symbol(\u0026#34;uid\u0026#34;); console.log(Symbol.keyFor(uid3)); // undefined   +RESULTS:\nuid uid undefined  å› æ­¤ Symbol(\u0026quot;uid\u0026quot;); ç»“æœä¸ä¼šåŠ å…¥æ³¨å†Œè¡¨ï¼Œå› æ­¤ç»“æœæ˜¯ undefined ã€‚\nç¬¦å·å¼ºåˆ¶è½¬æ¢ åœ¨ JavaScript ä¸­ç±»å‹å¼ºåˆ¶è½¬æ¢æ˜¯ç»å¸¸ä¼šè¢«ç”¨åˆ°çš„ä¸€ä¸ªç‰¹æ€§ï¼Œä¹Ÿè®© JavaScript ä½¿ç”¨èµ·\næ¥ä¼šå¾ˆçµæ´»åœ°å¯ä»¥å°†ä¸€ä¸ªæ•°æ®ç±»å‹è½¬æˆå¦ä¸€ç§æ•°æ®ç±»å‹ã€‚\nä½†æ˜¯ç¬¦å·ç±»å‹ä¸æ”¯æŒå¼ºåˆ¶è½¬æ¢ã€‚\n1 2 3 4 5  let uid = Symbol.for(\u0026#34;uid\u0026#34;) console.log(uid) // Symbol(uid)  // åœ¨è¾“å‡ºçš„æ—¶å€™å®é™…ä¸Šæ˜¯è°ƒç”¨äº† uid.toString()   +RESULTS:\nSymbol(uid)  å½“æˆ‘ä»¬å°†ç¬¦å·å˜é‡åŠ å…¥è®¡ç®—æˆ–å­—ç¬¦ä¸²æ“ä½œæ—¶ä¼šæŠ¥é”™ï¼Œå› ä¸ºä¸¤ä¸ªä¸åŒç±»å‹çš„å€¼è¿›è¡Œæ“ä½œä¼š\nå‘ç”Ÿéšå¼è½¬æ¢ï¼Œä½†æ˜¯ç¬¦å·ç±»å‹ä¸æ”¯æŒå¼ºè½¬çš„ï¼Œå› æ­¤ä¼šæŠ¥å¼‚å¸¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let uid = Symbol.for(\u0026#39;uid\u0026#39;), desc = \u0026#39;\u0026#39;, sum = 0 try { desc = uid + \u0026#34;\u0026#34; } catch (e) { console.log(e.message) } try { sum = uid / 1 } catch (e) { console.log(e.message) }   +RESULTS: å¼‚å¸¸ä¿¡æ¯\nCannot convert a Symbol value to a string Cannot convert a Symbol value to a number  è·å–å¯¹è±¡ç¬¦å·å±æ€§ è·å–å¯¹è±¡å±æ€§çš„æ–¹æ³•ï¼š\n Object.keys() ä¼šè·å–æ‰€æœ‰å¯æšä¸¾çš„å±æ€§ Object.getOwnPropertyNames() è·å–æ‰€æœ‰å±æ€§ï¼Œå¿½ç•¥å¯æšä¸¾æ€§  ä½†æ˜¯ä¸ºäº†å…¼å®¹ es5 åŠä»¥å‰çš„ç‰ˆæœ¬ï¼Œä»–ä»¬éƒ½ä¸ä¼šå»è·å–ç¬¦å·å±æ€§ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨\nObject.getOwnPropertySymbols() å»å•ç‹¬è·å–å¯¹è±¡æ‰€æœ‰çš„ç¬¦å·å±æ€§ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«æ‰€\næœ‰ç¬¦å·å±æ€§çš„æ•°ç»„ã€‚\n1 2 3 4 5 6 7 8 9 10 11  let uid = Symbol.for(\u0026#34;uid\u0026#34;); let object = { [uid]: \u0026#34;12345\u0026#34;, [Symbol.for(\u0026#34;uid2\u0026#34;)]: \u0026#34;67890\u0026#34; }; let symbols = Object.getOwnPropertySymbols(object); console.log(symbols.length); // 1 console.log(symbols[0]); // \u0026#34;Symbol(uid)\u0026#34; console.log(object[symbols[0]]); // \u0026#34;12345\u0026#34;   +RESULTS:\n2 Symbol(uid) 12345  ç¬¦å·å†…éƒ¨æ“ä½œ(æ–¹æ³•) åœ¨ es6 ä¸­ JavaScript çš„è®¸å¤šç‰¹æ€§ä¸­å…¶å†…éƒ¨çš„å®ç°éƒ½æ˜¯ä½¿ç”¨åˆ°äº†ç¬¦å·å†…éƒ¨æ–¹æ³•ã€‚\næ¯”å¦‚ä¸‹è¡¨æ¶‰åŠåˆ°çš„å†…å®¹ï¼š\n   ç¬¦å·æ–¹æ³• ç±»å‹ JavaScript ç‰¹æ€§ æè¿°     Symbol.hasInstance boolean instanceof 7.7.1 å®ä¾‹(åŸå‹é“¾)æ£€æµ‹   Symbol.isConcatSpreadable boolean Array.prototype.concat 7.7.2 æ£€æµ‹å‚æ•°åˆæ³•æ€§   Symbol.iterator function è°ƒç”¨åå¾—åˆ°è¿­ä»£å™¨ éå†å¯¹è±¡æˆ–æ•°ç»„(ç­‰å¯è¿­ä»£çš„å¯¹è±¡)çš„æ—¶å€™ä¼šç”¨åˆ°   Symbol.asyncIterator function è°ƒç”¨åå¾—åˆ°å¼‚æ­¥è¿­ä»£å™¨(è¿”å›ä¸€ä¸ª Promise ) éå†å¯¹è±¡æˆ–æ•°ç»„(ç­‰å¯è¿­ä»£çš„å¯¹è±¡)çš„æ—¶å€™ä¼šç”¨åˆ°   Symbol.match function String.prototype.match 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.matchAll function String.prototype.matchAll 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.replace function String.prototype.replace 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.search function String.prototype.search 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.split function String.prototype.split 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.species constructor - æ´¾ç”Ÿå¯¹è±¡ç”Ÿæˆ   Symbol.toPrimitive function - 7.7.4 è¿”å›ä¸€ä¸ªå¯¹è±¡çš„åŸå§‹å€¼   Symbol.toStringTag string Object.prototype.toString() 7.7.5 è¿”å›ä¸€ä¸ªå¯¹è±¡çš„å­—ç¬¦ä¸²æè¿°   Symbol.unscopables object with 7.7.8 ä¸èƒ½å‡ºç°åœ¨ with è¯­å¥ä¸­çš„ä¸€ä¸ªå¯¹è±¡     é€šè¿‡æ”¹å˜å¯¹è±¡çš„ä¸Šé¢çš„å†…éƒ¨ç¬¦å·å±æ€§çš„å®ç°ï¼Œå¯ä»¥è®©æˆ‘ä»¬å»ä¿®æ”¹å¯¹è±¡çš„ä¸€äº›\né»˜è®¤è¡Œä¸ºï¼Œæ¯”å¦‚ instanceof ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™å¯ä»¥æ”¹å˜å®ƒçš„è¡Œä¸ºè®©å®ƒè¿”å›ä¸€ä¸ªéé¢„æœŸå€¼ã€‚\n Symbol.hasInstance æ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ªå†…éƒ¨ Symbol.hasInstance æ–¹æ³•ç”¨æ¥åˆ¤æ–­ç»™å®šçš„å¯¹è±¡æ˜¯ä¸æ˜¯è¿™ä¸ªå‡½\næ•°çš„ä¸€ä¸ªå®ä¾‹ã€‚\nè¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨ Function.prototype ä¸Šï¼Œå› æ­¤æ‰€æœ‰çš„å‡½æ•°éƒ½ä¼šç»§æ‰¿ instanceof\nå±æ€§çš„é»˜è®¤è¡Œä¸ºï¼Œ\nå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æ˜¯ nonwritable, nonconfigurable, å’Œ nonenumerable çš„ï¼Œç¡®ä¿\nå®ƒä¸ä¼šè¢«é”™è¯¯çš„é‡å†™ã€‚\nå› æ­¤ä¸‹é¢çš„ä¸­çš„ä¸¤å¥ obj instanceof Array å’Œ\nArray[Symbol.hasInstance](obj) æ˜¯ç­‰ä»·çš„ã€‚\n1 2 3 4 5 6 7 8 9 10  const obj = {} let v1 = obj instanceof Array; // ç­‰ä»·äº  let v2 = Array[Symbol.hasInstance](obj); console.log(v1, v2)   +RESULTS:\nfalse false  åœ¨ es6 ä¸­å®é™…ä¸Šå·²ç»å¯¹ instanceof æ“ä½œåšäº†é‡å®šä¹‰ï¼Œå…¶å†…éƒ¨è¿˜è®©å®ƒæ”¯æŒäº†å‡½æ•°è°ƒ\nç”¨æ–¹å¼ï¼Œå³å…¶å†…éƒ¨çš„ Symbol.hasInstance ä¸å†é™å®šåªæ˜¯ boolean ç±»å‹ï¼Œå®ƒè¿˜å¯\nä»¥æ˜¯å‡½æ•°ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•æ¥æ”¹å˜ instanceof çš„é»˜è®¤è¡Œä¸ºã€‚\næ¯”å¦‚ï¼šè®©ä¸€ä¸ªå¯¹è±¡çš„ instanceof æ“ä½œæ€»æ˜¯è¿”å› false\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function MyObj() { // ... } Object.defineProperty(MyObj, Symbol.hasInstance, { value: function(v) { console.log(\u0026#39;override method\u0026#39;) return false; } }) let obj = new MyObj(); console.log(obj instanceof MyObj); // false   +RESULTS:\noverride method false  ç”±äº Symbol.hasInstance å±æ€§æ˜¯ nonwritable çš„å› æ­¤éœ€è¦é€šè¿‡\nObject.defineProperty å»é‡æ–°å®šä¹‰è¿™ä¸ªå±æ€§ã€‚\n#+BIGINQUOTE\nè™½ç„¶ es6 èµ‹äºˆäº†è¿™ç§å¯ä»¥é‡å†™ä¸€äº› JavaScript ç‰¹æ€§çš„é»˜è®¤è¡Œä¸ºçš„èƒ½åŠ›ï¼Œä½†æ˜¯ä¾æ—§ä¸\næ¨èå»è¿™ä¹ˆåšï¼Œå¾ˆå¯èƒ½è®©ä½ çš„ä»£ç å˜å¾—å¾ˆä¸å¯æ§ï¼Œä¹Ÿä¸å®¹æ˜“è®©äººç†è§£ä½ çš„ä»£ç ã€‚\n#+ENDQUOTE\nSymbol.isConcatSpreadable å¯¹åº”ç€ Array.prototype.concat çš„å†…éƒ¨ä½¿ç”¨ Symbol.isConcatSpreadable ã€‚\nconcat ä½¿ç”¨ç¤ºä¾‹ï¼š\n1 2 3 4 5  let colors1 = [ \u0026#34;red\u0026#34;, \u0026#34;green\u0026#34; ], colors2 = colors1.concat([ \u0026#34;blue\u0026#34;, \u0026#34;black\u0026#34; ]); console.log(colors2.length); // 4 console.log(colors2); // [\u0026#34;red\u0026#34;,\u0026#34;green\u0026#34;,\u0026#34;blue\u0026#34;,\u0026#34;black\u0026#34;]   +RESULTS:\n4 [ 'red', 'green', 'blue', 'black' ]  æˆ‘ä»¬ä¸€èˆ¬ç”¨ concat å»æ‰©å±•ä¸€ä¸ªæ•°ç»„ï¼ŒæŠŠä»–ä»¬åˆå¹¶åˆ°ä¸€ä¸ªæ–°çš„æ•°ç»„ä¸­å»ã€‚\næ ¹æ® Array.prototype.concat(value1, ...valueNs) çš„å®šä¹‰ï¼Œå®ƒæ˜¯å¯ä»¥æ¥å— n\nå¤šä¸ªå‚æ•°çš„ï¼Œæ¯”å¦‚ï¼š\n[].concat(1, 2, 3, ...) \u0026gt; =[1, 2, 3, ...]\nå¹¶ä¸”å¹¶æ²¡æœ‰é™å®šå‚æ•°çš„ç±»å‹ï¼Œå³è¿™äº› value1, ...valuesNs å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„å€¼\nï¼ˆæ•°ç»„ï¼Œå¯¹è±¡ï¼Œçº¯å€¼ç­‰ç­‰ï¼‰ã€‚\nå¦å¤–ï¼Œå¦‚æœå‚æ•°æ˜¯æ•°ç»„çš„è¯ï¼Œå®ƒä¼šå°†æ•°ç»„é¡¹ä¸€ä¸€å±•å¼€åˆå¹¶åˆ°æºæ•°ç»„ä¸­åŒº(ä¸”åªä¼šåšä¸€çº§\nå±•å¼€ï¼Œæ•°ç»„ä¸­çš„æ•°ç»„ä¸ä¼šå±•å¼€)ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7  let colors1 = [ \u0026#34;red\u0026#34;, \u0026#34;green\u0026#34; ], colors2 = colors1.concat( [ \u0026#34;blue\u0026#34;, \u0026#34;black\u0026#34;, [ \u0026#34;white\u0026#34; ] ], \u0026#34;brown\u0026#34;, { color: \u0026#34;red\u0026#34; }); console.log(colors1 === colors2) console.log(colors2.length); // 5 console.log(colors2); // [\u0026#34;red\u0026#34;,\u0026#34;green\u0026#34;,\u0026#34;blue\u0026#34;,\u0026#34;black\u0026#34;,\u0026#34;brown\u0026#34;]   +RESULTS:\nfalse 7 [ 'red', 'green', 'blue', 'black', [ 'white' ], 'brown', { color: 'red' } ]  ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦çš„æ˜¯å°† { color: 'red' } ä¸­çš„å±æ€§å€¼ 'red' åˆå¹¶åˆ°æ•°ç»„æœ«\nå°¾ï¼Œè¯¥å¦‚ä½•åšï¼Ÿï¼Ÿ\n-\u0026raquo;\u0026gt; Symbol.isConcatSpreadable å°±æ˜¯å®ƒ\nå’Œå…¶ä»–å†…ç½®ç¬¦å·ä¸ä¸€æ ·ï¼Œè¿™ä¸ªåœ¨æ‰€æœ‰çš„å¯¹è±¡ä¸­é»˜è®¤æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬éœ€è¦å°±å¾—\næ‰‹åŠ¨å»æ·»åŠ ï¼Œè®©è¿™ä¸ªå¯¹è±¡\nå˜æˆ concatable åªéœ€è¦å°†è¿™ä¸ªå±æ€§å€¼ç½®ä¸º true å³å¯:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  let collection = { 0: \u0026#39;aaa\u0026#39;, \u0026#39;1\u0026#39;: \u0026#39;bbb\u0026#39;, length: 2, [Symbol.isConcatSpreadable]: true } let objNoLength = { 0: \u0026#39;xxx\u0026#39;, 1: \u0026#39;yyy\u0026#39;, [Symbol.isConcatSpreadable]: true } let objNoNumberAttrs = { a: \u0026#39;www\u0026#39;, b: \u0026#39;vvv\u0026#39;, length: 2, [Symbol.isConcatSpreadable]: true } let words = [ \u0026#39;somthing\u0026#39; ]; console.log(words.concat(collection).toString()) console.log(words.concat(objNoLength).toString()) console.log(words.concat(objNoNumberAttrs).toString())   +RESULTS:\nsomthing,aaa,bbb somthing somthing,,  åˆ†æç»“æœå¾—å‡ºï¼Œå¯¹è±¡è¦å˜çš„å¯ä»¥è¢« Array.prototype.concat ä½¿ç”¨ï¼Œ\néœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\n å¿…é¡»æœ‰ length å±æ€§ï¼Œå¦åˆ™å¯¹ç»“æœæ²¡ä»»ä½•å½±å“ï¼Œå¦‚ç»“æœç¬¬äºŒè¡Œè¾“å‡ºï¼š somthing å¿…é¡»æœ‰ä»¥æ•°å­—ä¸º key çš„å±æ€§ï¼Œå¦åˆ™æ•°ç»„ä¸­å°†ä½¿ç”¨ç©ºå€¼ä»£æ›¿è¿½åŠ çš„å€¼è¿½åŠ åˆ°æ•°ç»„ä¸­\nå»ï¼Œå¦‚ç¬¬ä¸‰è¡Œè¾“å‡ºï¼š somthing,, å¿…é¡»å¢åŠ ç¬¦å·å±æ€§ Symbol.isConcatSpreadable ä¸”å€¼ä¸º true  åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°ç»„å¯¹è±¡çš„ Symbol.isConcatSpreadable ç¬¦å·å±æ€§ç½®ä¸º false\næ¥é˜»æ­¢æ•°ç»„çš„ concatable è¡Œä¸ºã€‚\nSymbol.match, Symbol.replace, Symbol.search, Symbol.split å’Œå­—ç¬¦ä¸²ï¼Œæ­£åˆ™è¡¨è¾¾å¼æœ‰å…³çš„ä¸€äº›ç¬¦å·ï¼Œå¯¹åº”ç€å­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼çš„æ–¹æ³•ï¼š\n match(regex) å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…æ­£åˆ™ replace(regex, replacement) å­—ç¬¦ä¸²æ›¿æ¢ search(regex) å­—ç¬¦ä¸²æœç´¢ split(regex) å­—ç¬¦ä¸²åˆ‡å‰²  è¿™äº›éƒ½éœ€è¦ç”¨åˆ°æ­£åˆ™è¡¨è¾¾å¼ regex\nåœ¨ es6 ä¹‹å‰è¿™äº›æ–¹æ³•ä¸æ­£åˆ™è¡¨è¾¾å¼çš„äº¤äº’è¿‡ç¨‹å¯¹äºå¼€å‘è€…è€Œå·²éƒ½æ˜¯éšè—äº†å…¶å†…éƒ¨ç»†èŠ‚\nçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¼€å‘è€…æ— æ³•é€šè¿‡è‡ªå·±å®šä¹‰çš„å¯¹è±¡å»è¡¨ç¤ºä¸€ä¸ªæ­£åˆ™ã€‚\nåœ¨ es6 ä¸­å®šä¹‰äº†å››ä¸ªç¬¦å·ä¾¿æ˜¯ç”¨æ¥å®ç° RegExp å†…éƒ¨å®ç°å¯¹è±¡ï¼Œå³å¯ä»¥é€šè¿‡å¯¹è±¡çš„\næ–¹å¼å»å®ç°ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼è§„åˆ™ã€‚\nè¿™å››ä¸ªç¬¦å·å±æ€§æ˜¯åœ¨ RegExp.prototype åŸå‹ä¸Šè¢«å®šä¹‰çš„ï¼Œä½œä¸ºä»¥ä¸Šæ–¹æ³•çš„é»˜è®¤å®ç°ã€‚\n æ„æ€å°±æ˜¯ math, replace, search, split è¿™å››ä¸ªæ–¹æ³•çš„ regex æ­£åˆ™\nè¡¨è¾¾å¼çš„å†…éƒ¨å®ç°åŸºäºå¯¹åº”çš„å››ä¸ªç¬¦å·å±æ€§å‡½æ•° Symbol.math, Symbol.replace,\nSymbol.search, Symbol.split ã€‚\n  Symbol.match æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¦‚æœåŒ¹é…ä¼šè¿”å›ä¸€ä¸ªåŒ¹é…çš„æ•°ç»„ï¼ŒæœªåŒ¹é…è¿”å› null ã€‚ Symbol.replace æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°å’Œä¸€ä¸ªç”¨æ¥æ›¿æ¢çš„å­—ç¬¦ä¸²ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚ Symbol.search æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›åŒ¹é…åˆ°çš„æ•°å­—æ‰€ä»¥å‘¢ï¼ŒæœªåŒ¹é…è¿”å› -1ã€‚ Symbol.split æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›ä»¥åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²ä½ç½®åˆ†å‰²æˆçš„ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  // ç­‰ä»·äº /^.${10}$/ let hasLengthOf10 = { [Symbol.match]: function(value) { return value.length === 10 ? [value] : null }, [Symbol.replace]: function(value, replacement) { return value.length === 10 ? replacement : value }, [Symbol.search]: function(value) { return value.length === 10 ? 0 : -1 }, [Symbol.split]: function(value) { return value.length === 10 ? [\u0026#34;\u0026#34;, \u0026#34;\u0026#34;] : [value] } } let msg1 = \u0026#34;Hello World\u0026#34;, // 11 chars  msg2 = \u0026#34;Hello John\u0026#34;; // 10 chars  let m1 = msg1.match(hasLengthOf10) let m2 = msg2.match(hasLengthOf10) console.log(m1) console.log(m2) let r1 = msg1.replace(hasLengthOf10, \u0026#34;Howdy!\u0026#34;) let r2 = msg2.replace(hasLengthOf10, \u0026#34;Howdy!\u0026#34;) console.log(r1) console.log(r2) let s1 = msg1.search(hasLengthOf10) let s2 = msg2.search(hasLengthOf10) console.log(s1) console.log(s2) let sp1 = msg1.split(hasLengthOf10) let sp2 = msg2.split(hasLengthOf10) console.log(sp1) console.log(sp2)   +RESULTS:\nnull [ 'Hello John' ] Hello World Howdy! -1 0 [ 'Hello World' ] [ '', '' ]  é€šè¿‡è¿™å‡ ä¸ªæ­£åˆ™å¯¹è±¡çš„å†…éƒ¨ç¬¦å·å±æ€§ï¼Œä½¿å¾—æˆ‘ä»¬æœ‰èƒ½åŠ›æ ¹æ®éœ€è¦å»å®Œæˆæ›´å¤æ‚çš„æ­£åˆ™åŒ¹é…è§„åˆ™ã€‚\nSymbol.toPrimitive åœ¨ es6 ä¹‹å‰ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ == å»æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå…¶å†…éƒ¨éƒ½ä¼šè®²å¯¹è±¡è½¬æˆ\nåŸå§‹å€¼ä¹‹åå†å»æ¯”è¾ƒï¼Œä¸”æ­¤æ—¶çš„è½¬æ¢å±äºå†…éƒ¨æ“ä½œï¼Œæˆ‘ä»¬æ˜¯æ— æ³•çŸ¥æ™“æ›´æ— æ³•å¹²æ¶‰çš„ã€‚\nä½†åœ¨ es6 å‡ºç°ä¹‹åï¼Œè¿™ç§å†…éƒ¨å®ç°é€šè¿‡ Symbol.toPrimitvie è¢«æš´éœ²å‡ºæ¥äº†ï¼Œä»è€Œ\nä½¿å¾—æˆ‘ä»¬æœ‰èƒ½åŠ›å–æ”¹å˜ä»–ä»¬çš„é»˜è®¤è¡Œä¸ºã€‚\nSymbol.toPrimitvie æ˜¯å®šä¹‰åœ¨æ‰€æœ‰çš„æ ‡å‡†ç±»å‹å¯¹è±¡çš„åŸå‹ä¹‹ä¸Šï¼Œç”¨æ¥æè¿°åœ¨å¯¹è±¡è¢«\nè½¬æ¢æˆåŸå§‹å€¼ä¹‹å‰çš„éƒ½åšäº†äº›ä»€ä¹ˆè¡Œä¸ºã€‚\nå½“ä¸€ä¸ªå¯¹è±¡å‘ç”ŸåŸå§‹å€¼è½¬æ¢çš„æ—¶å€™ï¼Œ Symbol.toPrimitive å°±ä¼šå¸¦ä¸Šä¸€ä¸ªå‚æ•°\n(hint)è¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‚æ•°å€¼ä¸º \u0026ldquo;number\u0026rdquo;, \u0026ldquo;string\u0026rdquo;, \u0026ldquo;default\u0026rdquo; ä¸­çš„ä¸€ä¸ª(å€¼æ˜¯ç”±\nJavaScript å¼•æ“æ‰€å†³å®šçš„)ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼š\n \u0026ldquo;number\u0026rdquo; ï¼šè¡¨ç¤º Symbol.toPrimitive åº”è¯¥è¿”å›ä¸€ä¸ªæ•°å­—ã€‚ \u0026ldquo;string\u0026rdquo; ï¼šè¡¨ç¤º Symbol.toPrimitvie åº”è¯¥è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ \u0026ldquo;default\u0026rdquo; ï¼š è¡¨ç¤ºåŸæ ·è¿”å›ã€‚  åœ¨å¤§éƒ¨åˆ†çš„æ ‡å‡†å¯¹è±¡ä¸­ï¼Œ number æ¨¡å¼çš„è¡Œä¸ºæŒ‰ç…§ä»¥ä¸‹çš„ä¼˜å…ˆçº§æ¥è¿”å›ï¼š\n å…ˆè°ƒç”¨ valueOf() å¦‚æœç»“æœæ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œè¿”å›å®ƒã€‚ ç„¶åè°ƒç”¨ toString() å¦‚æœç»“æœæ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œè¿”å›å®ƒã€‚ å¦åˆ™ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚  åŒæ ·ï¼Œ string æ¨¡å¼çš„è¡Œä¸ºä¼˜å…ˆçº§å¦‚ä¸‹ï¼š\n å…ˆè°ƒç”¨ toString() å¦‚æœç»“æœæ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œè¿”å›å®ƒã€‚ ç„¶åè°ƒç”¨ valueOf() å¦‚æœç»“æœæ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œè¿”å›å®ƒã€‚ å¦åˆ™ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚  åœ¨æ­¤ï¼Œå¯ä»¥é€šè¿‡é‡å†™ Symbol.toPrimitive æ–¹æ³•ï¼Œå¯ä»¥æ”¹å˜ä»¥ä¸Šçš„é»˜è®¤è¡Œä¸ºã€‚\n \u0026ldquo;default\u0026rdquo; æ¨¡å¼ä»…åœ¨ä½¿ç”¨ ==, + æ“ä½œç¬¦ï¼Œä»¥åŠè°ƒç”¨ Date æ„é€ å‡½æ•°çš„æ—¶å€™\nåªä¼ é€’ä¸€ä¸ªå‚æ•°çš„æ—¶å€™æ‰ä¼šç”¨åˆ°ã€‚å¤§éƒ¨åˆ†çš„æ“ä½œéƒ½æ˜¯é‡‡ç”¨çš„ \u0026ldquo;number\u0026rdquo; æˆ– \u0026ldquo;string\u0026rdquo; æ¨¡å¼ã€‚\n å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9  function Temperature(degrees) { this.degrees = degrees } let freezing = new Temperature(32) console.log(freezing + \u0026#34;!\u0026#34;) // [object Object]! console.log(freezing / 2) // NaN console.log(String(freezing)) // [object Object]   è¾“å‡ºç»“æœï¼š\nå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªå¯¹è±¡å­—ç¬¦ä¸²åŒ–ä¹‹åä¼šå˜æˆ [object Object] è¿™æ˜¯å…¶å†…éƒ¨çš„é»˜è®¤\nè¡Œä¸ºã€‚\né€šè¿‡é‡å†™åŸå‹ä¸Šçš„ Symbol.toPrimitive å‡½æ•°å¯ä»¥æ”¹å†™è¿™ç§é»˜è®¤è¡Œä¸ºã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function Temperature(degrees) { this.degrees = degrees } Temperature.prototype[Symbol.toPrimitive] = function(hint) { switch (hint) { case \u0026#39;string\u0026#39;: return this.degrees + \u0026#39;\\u00b0\u0026#39; case \u0026#39;number\u0026#39;: return this.degrees case \u0026#39;default\u0026#39;: return this.degrees + \u0026#34; degrees\u0026#34; } } let freezing = new Temperature(32) console.log(freezing + \u0026#34;!\u0026#34;) console.log(freezing / 2) console.log(String(freezing))   +RESULTS:\n32 degrees! 16 32Â°  ç»“æœå°±åƒæˆ‘ä»¬ä¹‹å‰åˆ†æçš„ï¼Œ åªæœ‰ == å’Œ + æ‰§è¡Œçš„æ˜¯ â€œdefault\u0026quot; æ¨¡å¼ï¼Œ\nå…¶ä»–æƒ…å†µæ‰§è¡Œçš„è¦ä¹ˆæ˜¯ \u0026ldquo;number\u0026rdquo; æ¨¡å¼(å¦‚ï¼š freezing / 2)\nè¦ä¹ˆæ˜¯ \u0026ldquo;string\u0026rdquo; æ¨¡å¼(å¦‚ï¼š String(freezing))\nSymbol.toStringTag ä»‹ç» åœ¨ JavaScript çš„ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æ˜¯ï¼Œèƒ½åŒæ—¶æ‹¥æœ‰å¤šä¸ªå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡çš„èƒ½åŠ›ã€‚\nè¿™ä¸ªå‘ç”Ÿåœ¨ web æµè§ˆå™¨ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªé¡µé¢å¯èƒ½åŒ…å«ä¸€ä¸ª iframe ï¼Œå› æ­¤å½“å‰é¡µé¢å’Œ\nè¿™ä¸ª iframe å„è‡ªéƒ½æ‹¥æœ‰è‡ªå·±çš„æ‰§è¡Œç¯èŠ‚ã€‚\né€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™å¹¶ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºæ•°æ®å¯ä»¥é€šè¿‡ä¸€äº›æ‰‹æ®µè®©å…¶å®ƒå½“å‰é¡µå’Œ\niframe ä¹‹é—´è¿›è¡Œä¼ é€’ï¼Œé—®é¢˜æ˜¯å¦‚ä½•å»è¯†åˆ«è¿™ä¸ªè¢«ä¼ é€’çš„å¯¹è±¡æ˜¯æºè‡ªå“ªä¸ªæ‰§è¡Œç¯å¢ƒï¼Ÿï¼Ÿ\næ¯”å¦‚ï¼Œä¸€ä¸ªå…¸å‹çš„é—®é¢˜æ˜¯åœ¨ page å’Œ iframe ä¹‹é—´äº’ç›¸ä¼ é€’ä¸€ä¸ªæ•°ç»„ã€‚åœ¨ es6 çš„\næœ¯è¯­ä¸­ï¼Œ é¡µé¢å’Œiframe æ¯ä¸€ä¸ªéƒ½ä»£è¡¨ç€ä¸€ä¸ªä¸åŒçš„é¢†åŸŸ(realm, JavaScript æ‰§è¡Œ\nç¯å¢ƒ)ã€‚æ¯ä¸ªé¢†åŸŸéƒ½æœ‰å®ƒè‡ªå·±çš„å…¨å±€ä½œç”¨åŸŸåŒ…å«äº†å®ƒè‡ªå·±çš„ä¸€ä»½å…¨å±€å¯¹è±¡çš„å‰¯æœ¬ã€‚\næ— è®ºï¼Œæ•°ç»„åœ¨å“ªä¸ªé¢†åŸŸè¢«åˆ›å»ºï¼Œå®ƒéƒ½å¾ˆæ˜ç¡®çš„æ˜¯ä¸€ä¸ªæ•°ç»„å¯¹è±¡ï¼Œå½“å®ƒè¢«ä¼ é€’åˆ°å¦ä¸€ä¸ªé¢†\nåŸŸçš„æ—¶å€™ï¼Œä½¿ç”¨ instanceof Array çš„ç»“æœéƒ½æ˜¯ false ï¼Œå› ä¸ºæ•°ç»„æ˜¯é€šè¿‡æ„é€ å‡½\næ•°åœ¨åˆ«çš„é¢†åŸŸæ‰€åˆ›å»ºçš„ï¼Œè€Œ\nArray ä»£è¡¨çš„ä»…ä»…æ˜¯å½“å‰é¢†åŸŸä¸‹çš„æ„é€ å‡½æ•°ï¼Œå³ä¸¤ä¸ªé¢†åŸŸä¸‹çš„ Array ä¸æ˜¯ä¸€å›äº‹ã€‚\nè¿™å°±é€ æˆäº†åœ¨å½“å‰é¢†åŸŸä¸‹å»åˆ¤æ–­å¦ä¸€ä¸ªé¢†åŸŸä¸‹çš„ä¸€ä¸ªæ•°ç»„å˜é‡æ˜¯ä¸æ˜¯æ•°ç»„ï¼Œå¾—åˆ°çš„ç»“\næœå°†æ˜¯ false ã€‚\nSymbol.toStringTag å»¶ä¼¸(ä¸åŒ realm ä¸‹çš„å¯¹è±¡è¯†åˆ«)  å¯¹è±¡è¯†åˆ«çš„åº”å¯¹ä¹‹ç­–(Object.prototype.toString.call(obj))\n1 2 3 4 5  function isArray(value) { return Object.prototype.toString.call(value) === \u0026#34;[object Array]\u0026#34;; } console.log(isArray([])); // true   +RESULTS:\ntrue  è¿™ç§æ–¹å¼è™½ç„¶æ¯”è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯å´æ˜¯æœ€é è°±çš„æ–¹æ³•ã€‚\nå› ä¸ºæ¯ä¸ªç±»å‹çš„ toString() å¯èƒ½æœ‰è‡ªå·±çš„å®ç°ï¼Œè¿”å›çš„å€¼æ˜¯æ— æ³•ç»Ÿä¸€çš„ï¼Œä½†æ˜¯\nObject.prototype.toString è¿”å›çš„å†…å®¹å§‹ç»ˆæ˜¯ [object Array] è¿™ç§ï¼Œåé¢æ˜¯è¢«\næ£€æµ‹æ•°æ®ä»£è¡¨çš„ç±»å‹çš„æ„é€ å‡½æ•°ï¼Œå®ƒæ€»æ˜¯èƒ½å¾—åˆ°æ­£ç¡®ä¸”ç²¾ç¡®çš„\nç»“æœã€‚\nObject.prototype.toString å†…éƒ¨å®ç°çš„ä¼ªä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  // toString(object)  function toString(obj) { // 1. åˆ¤æ–­ undefined å’Œ null  if (this === undefined) { return \u0026#39;[object Undefined]\u0026#39;; } if (this === null) { return \u0026#39;[object Null]\u0026#39;; } let O = ToObject(this); // ä¸Šä¸‹æ–‡å˜é‡å¯¹è±¡åŒ–  let isArray = IsArray(O); // å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯æ•°ç»„ç±»å‹  let builtinTag = \u0026#39;\u0026#39; let has = builtinName =\u0026gt; !!O.builtinName; // 2. æ ¹æ®å†…ç½®å±æ€§ï¼Œæ£€æµ‹å„å¯¹è±¡çš„ç±»å‹  if (isArray === true) { // æ•°ç»„ç±»å‹  builtinTag = \u0026#39;Array\u0026#39;; } else if ( has([[ParameterMap]]) ) { // å‚æ•°åˆ—è¡¨ï¼Œå‡½æ•°å‚æ•°å¯¹è±¡  // å‡½æ•°çš„å‚æ•° arguments å¯¹è±¡  builtinTag = \u0026#39;Arguments\u0026#39;; } else if ( has([[Call]]) ) { // å‡½æ•°  builtinTag = \u0026#39;Function\u0026#39;; } else if ( has([[ErrorData]]) ) { // Errorå¯¹è±¡  builtinTag = \u0026#39;Error\u0026#39;; } else if ( has([[BooleanData]]) ) { // Boolean å¸ƒå°”å¯¹è±¡  builtinTag = \u0026#39;Boolean\u0026#39;; } else if ( has([[StringData]]) ) { // String å¯¹è±¡  builtinTag = \u0026#39;String\u0026#39;; } else if ( has([[DateValue]]) ) { // Date å¯¹è±¡  builtinTag = \u0026#39;Date\u0026#39;; } else if ( has([[RegExpMatcher]]) ) { // RegExp æ­£åˆ™å¯¹è±¡  builtinTag = \u0026#39;RegExp\u0026#39;; } else { builtinTag = \u0026#39;Object\u0026#39; // å…¶ä»–  } // 3. æœ€åæ£€æµ‹ @@toStringTag - Symbol.toStringTag çš„å€¼  let tag = Get(O, @@toStringTag); if (Type(tag) !== \u0026#39;string\u0026#39;) { tag = builtinTag; } return `[object ${tag}]`; }   ä»ä¼ªä»£ç ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œæœ€åçš„å®ç°ä¸­ä½¿ç”¨åˆ°äº† @@toStringTag å³å¯¹åº”è¿™é‡Œçš„\nSymbol.toStringTag å±æ€§å€¼,\nå¹¶ä¸”è¿™ä¸ªæ”¾åœ¨æœ€ååˆ¤æ–­ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œå³å¦‚æœæˆ‘ä»¬é‡å†™äº† Symbol.toStringTag é‚£ä¹ˆ\né‡å†™ä¹‹åçš„è¿”å›å€¼å°†æœ€ä¼˜å…ˆè¿”å›ã€‚\nSymbol.toStringTag çš„ ES6 å®ç° æ­£å¦‚ 7.7.6 ä¸­çš„ä¼ªä»£ç æ‰€ç¤ºï¼Œåœ¨ es6 ä¸­å¯¹äº\nObject.prototype.toString.call(obj) çš„å®ç°ä¸­åŠ å…¥äº† @@toStringTag å†…éƒ¨å±\næ€§çš„æ£€æµ‹ï¼Œå³å¯¹åº”ç€è¿™é‡Œçš„ Symbol.toStringTag ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿\nå¯ä»¥é€šè¿‡æ”¹å˜è¿™ä¸ªå€¼æ¥ä¿®æ”¹å®ƒçš„é»˜è®¤è¡Œä¸ºï¼Œä»è€Œå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç±»å‹å€¼ã€‚\næ¯”å¦‚ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ª Person æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ä½¿ç”¨ toString() çš„æ—¶å€™å¾—åˆ°ç»“\næœæ˜¯ [object Person]\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function Person(name) { this.name = name } Person.prototype[Symbol.toStringTag] = \u0026#39;Person\u0026#39; let me = new Person(\u0026#39;xxx\u0026#39;) Person.prototype.toString = () =\u0026gt; \u0026#39;[object Test]\u0026#39; console.log(me.toString()) // [object Person] console.log(Object.prototype.toString.call(me)) // [object Person] console.log(me.toString === Object.prototype.toString) // true    +RESULTS: æœªé‡å†™ Person.prototype.toString ç»“æœ\n[object Person] [object Person] true  +RESULTS: é‡å†™ Person.prototype.toString çš„ç»“æœ\n[object Test] [object Person] false  æˆ‘ä»¬å‘ç°å°±ç®—é‡å†™äº† Person.prototype.toString ä¹Ÿä¸ä¼šå½±å“\nSymbol.toStringTag èµ‹å€¼åçš„è¿è¡Œç»“æœï¼Œå¦‚åé¢è°ƒç”¨\nObject.prototype.toString.call(me) ç»“æœä¾æ—§æ˜¯ [object Person] ã€‚\nå› ä¸ºæˆ‘ä»¬é‡å†™äº† Symbol.toStringTag å±æ€§å€¼ï¼Œå› æ­¤7.7.6å®ç°éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8  // 3. æœ€åæ£€æµ‹ @@toStringTag - Symbol.toStringTag çš„å€¼ let tag = Get(O, @@toStringTag); // è¿™é‡Œçš„ç»“æœå°±æˆäº† \u0026#39;Person\u0026#39;  if (Type(tag) !== \u0026#39;string\u0026#39;) { tag = builtinTag; } return `[object ${tag}]`   å› æ­¤å¾—åˆ° [object Person] è¿”å›ç»“æœã€‚\næˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡é‡å†™ Person è‡ªèº«çš„ toString() çš„å®ç°è®©å…¶æ‹¥æœ‰è‡ªå·±çš„é»˜è®¤è¡Œä¸ºï¼Œ\nä¸Šé¢çš„ç¬¬ä¸‰è¡Œ\nç»“æœè¡¨æ˜ me.toString() æœ€ç»ˆè°ƒç”¨çš„æ˜¯ Object.prototype.toString ã€‚\nSymbol.unscopables with è¯­å¥åœ¨ JavaScript ä¸–ç•Œä¸­æ˜¯æœ€å…·äº‰è®®çš„ä¸€é¡¹ç‰¹æ€§ä¹‹ä¸€ã€‚\nåŸæœ¬è®¾è®¡çš„åˆè¡·æ˜¯é¿å…é‡å¤ä¹¦å†™ä¸€æ ·çš„ä»£ç ï¼Œä½†æ˜¯åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå´æ˜¯è®©ä»£ç æ›´éš¾\nç†è§£ï¼Œå¾ˆå®¹æ˜“å‡ºé”™ï¼Œä¹Ÿæœ‰æ€§èƒ½ä¸Šçš„å½±å“ã€‚\nè™½ç„¶ï¼ŒæåŠ›ä¸æ¨èä½¿ç”¨å®ƒï¼Œä½†æ˜¯åœ¨ es6 ä¸­ä¸ºäº†è€ƒè™‘å‘åå…¼å®¹æ€§é—®é¢˜ï¼Œåœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹\nä¾æ—§å¯¹å®ƒåšäº†æ”¯æŒã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10  let values = [1, 2, 3], colors = [\u0026#34;red\u0026#34;, \u0026#34;green\u0026#34;], color = \u0026#34;black\u0026#34;; with(colors) { push(color); push(...values); } console.log(colors.toString())   +RESULTS:\nred,green,black,1,2,3  ä¸Šé¢ä»£ç ï¼Œåœ¨ with é‡Œé¢è°ƒç”¨çš„ä¸¤æ¬¡ push ç­‰ä»·äº colors.push è°ƒç”¨ï¼Œ\nå› ä¸º with å°†æœ¬åœ°æ‰§è¡Œä¸Šä¸‹æ–‡ç»‘å®šåˆ°äº† colors ä¸Šã€‚\nvalues, color æŒ‡å‘çš„å‡æ˜¯åœ¨ with è¯­å¥å¤–é¢åˆ›å»ºçš„ values å’Œ color ã€‚\nä½†æ˜¯åœ¨ ES6 ä¸­ç»™æ•°ç»„å¢åŠ äº†ä¸€ä¸ª values æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›å½“å‰æ•°ç»„çš„è¿­ä»£å™¨\nå¯¹è±¡ï¼š Array Iterator {}\nè¿™å°±æ„å‘³ç€åœ¨ ES6 çš„ç¯å¢ƒä¸­ï¼Œ values æŒ‡å‘çš„å°†æ˜¯æ•°ç»„æœ¬èº«çš„ values() æ–¹æ³•è€Œ\nä¸æ˜¯å¤–é¢å£°æ˜çš„ values = [1, 2, 3] è¿™ä¸ªæ•°ç»„ï¼Œå°†ç ´åæ•´ä¸ªä»£ç çš„è¿è¡Œã€‚\nè¿™å°±æ˜¯ Symbol.unscopables å­˜åœ¨çš„åŸå› ã€‚\nSymbol.unscopables è¢«ç”¨åœ¨ Array.prototype ä¸Šç”¨æ¥æŒ‡å®šé‚£äº›å±æ€§ä¸èƒ½åœ¨\nwith ä¸­åˆ›å»ºç»‘å®šï¼š\n1 2 3 4 5 6 7 8 9 10 11  // built into ECMAScript 6 by default Array.prototype[Symbol.unscopables] = Object.assign(Object.create(null), { copyWithin: true, entries: true, fill: true, find: true, findIndex: true, keys: true, values: true });   ä¸Šé¢æ˜¯é»˜è®¤æƒ…å†µä¸‹ ES6 å†…ç½®çš„è®¾å®šï¼Œå³æ•°ç»„ä¸­çš„ä¸Šåˆ—å±æ€§ä¸å…è®¸åœ¨ with ä¸­åˆ›å»ºç»‘\nå®šï¼Œä»åˆ—è¡¨èƒ½å‘ç°è¿™äº›è¢«ç½®ä¸º true çš„å±æ€§éƒ½æ˜¯ es6 ä¸­æ–°èµ çš„æ–¹æ³•ï¼Œè¿™ä¸»è¦æ˜¯ä¸º\näº†å…¼å®¹ä»¥å‰çš„ä»£ç åªé’ˆå¯¹æ–°å¢çš„å±æ€§è¿™ä¹ˆä½¿ç”¨ã€‚\n#+BIGINQUOTE\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é‡æ–°å®šä¹‰ Symbol.unscopables ï¼Œé™¤éä»£ç ä¸­å­˜åœ¨ with è¯­å¥å¹¶ä¸”\néœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†çš„æ—¶å€™ï¼Œä½†æ˜¯å»ºè®®å°½é‡é¿å…ä½¿ç”¨ with ã€‚\n#+ENDQUOTE\næ€»ç»“  Symbols æ˜¯ä¸€ç§æ–°çš„åŸå§‹å€¼ç±»å‹ï¼Œç”¨æ¥åˆ›å»ºä¸€äº›å±æ€§ï¼Œè¿™äº›å±æ€§åªèƒ½ä½¿ç”¨å¯¹åº”çš„ç¬¦å·\næˆ–ç¬¦å·å˜é‡å»è®¿é—®ã€‚ Symbol([description]) ç”¨æ¥åˆ›å»ºä¸€ä¸ªç¬¦å·ï¼Œæ¨èä¼ å…¥æè¿°ï¼Œä¾¿äºè¯†åˆ«ã€‚ Symbol.for(key) é¦–å…ˆæŸ¥æ‰¾æ³¨å†Œè¡¨(GSR)ï¼Œå¦‚æœ key å¯¹åº”çš„ç¬¦å·å­˜åœ¨ç›´æ¥è¿”å›ï¼Œ\nå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç¬¦å·å¹¶åŠ å…¥åˆ°æ³¨å†Œè¡¨ï¼Œç„¶åè¿”å›æ–°åˆ›å»ºçš„ç¬¦å·ã€‚ Symbol.keyFor(symbolValue) é€šè¿‡ç¬¦å·å˜é‡ä»æ³¨å†Œè¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ç¬¦å·å€¼ï¼Œæ²¡æœ‰\nè¿”å› undefined ã€‚ ç¬¦å·å…±äº«é€šè¿‡ Symbol.for(key) å’Œ Symbol.keyFor(symbolValue) å¯ä»¥è®©ç¬¦å·\nè¾¾åˆ°å…±äº«çš„ç›®çš„ï¼Œå› ä¸ºå…¨å±€æ³¨å†Œè¡¨åœ¨æ‰€æœ‰ä»£ç è¿è¡Œä¹‹å‰å°±å·²ç»åˆ›å»ºå¥½äº†ã€‚ ç¬¦å·ä¸å…è®¸ç±»å‹è½¬æ¢(æˆ–éšå¼è½¬æ¢)ã€‚ Object.keys() å’Œ Object.getOwnPropertyNames() ä¸èƒ½è·å–åˆ°ç¬¦å·å±æ€§ã€‚ Object.getOwnPropertySymbols(obj) èƒ½è·å–åˆ°å¯¹è±¡çš„æ‰€æœ‰ç¬¦å·å±æ€§ã€‚ Object.defineProperty() å’Œ Object.defineProperties() å¯¹ç¬¦å·å±æ€§ä¹Ÿæœ‰æ•ˆã€‚ çŸ¥åç¬¦å·7.7ï¼Œä»¥å¾€çš„å†…éƒ¨å®ç°æ˜¯ä¸å¯¹å¼€å‘è€…å¼€æ”¾çš„ï¼Œå¦‚ä»Šæœ‰äº†è¿™äº›çŸ¥å\nç¬¦å·å±æ€§ï¼Œå¯ä»¥è®©å¼€å‘è€…è‡ªä¿¡æ”¹å˜ä¸€äº›åŠŸèƒ½å’Œæ¥å£çš„é»˜è®¤è¡Œä¸ºã€‚  Sets å’Œ Maps  set é›†åˆæ˜¯ä¸€ç»„æ²¡æœ‰é‡å¤å…ƒç´ çš„ä¸€ä¸ªåºåˆ—ã€‚ map key å€¼å¾—é›†åˆï¼ŒæŒ‡å‘å¯¹åº”çš„å€¼  ECMAScript 5 ä¸­çš„ Sets å’Œ Maps åœ¨ es6 ä¹‹å‰ä¼šæœ‰å„ç§ sets/maps çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯å¤§éƒ½æˆ–å¤šæˆ–å°‘æœ‰æ‰€ç¼ºé™·ã€‚\nèƒŒæ™¯ æ¯”å¦‚ï¼š ä½¿ç”¨å¯¹è±¡å±æ€§å®ç°\n1 2 3 4 5 6 7  let st = Object.create(null) set.foo = true if (set.foo) { // sth }   åœ¨å°†å¯¹è±¡ä½œä¸º set æˆ– map ä½¿ç”¨çš„æ—¶å€™å”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼š\nmap é‡Œé¢çš„ key æœ‰å­˜å‚¨å¯¹åº”çš„å…·ä½“å†…å®¹ï¼Œè€Œä¸åƒ set ä»…ä»…ç”¨æ¥å­˜å‚¨ true or false,\nç”¨æ¥æ ‡è¯† key æ˜¯å¦å­˜åœ¨ã€‚\n1 2 3 4 5 6 7  let map = Object.create(null) map.foo = \u0026#39;bar\u0026#39; let value = map.foo console.log(value) // \u0026#39;bar\u0026#39;   +RESULTS:\nbar  æ½œåœ¨é—®é¢˜ ä½¿ç”¨å¯¹è±¡å®ç° set/map çš„é—®é¢˜ï¼š\n æ— æ³•é¿å…å­—ç¬¦ä¸² key çš„å”¯ä¸€æ€§é—®é¢˜ æ— æ³•é¿å…å¯¹è±¡ä½œä¸º key çš„å”¯ä¸€æ€§é—®é¢˜  å­—ç¬¦ä¸²ä½œä¸º key :\n1 2 3 4 5  let map = Object.create(null) map[5] = \u0026#39;foo\u0026#39; console.log(map[\u0026#34;5\u0026#34;]) // \u0026#39;foo\u0026#39;   +RESULTS:\nfoo  å› ä¸ºå¯¹äºå¯¹è±¡æ¥è¯´ï¼Œä½¿ç”¨æ•°å­—ä¸‹è¡¨å»è®¿é—®çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯å°†ä¸‹æ ‡æ•°å€¼è½¬æˆå­—ç¬¦ä¸²å»è®¿é—®äº†ï¼Œ\nå³ç›¸å½“äº map[5] ç­‰ä»·äº map['5'] å› æ­¤ï¼Œæœ‰ä¸Šé¢çš„ç»“æœè¾“å‡ºã€‚\nä½†æ˜¯ï¼Œä½ ååæƒ³ä½¿ç”¨ 5 å’Œ \u0026lsquo;5\u0026rsquo; å»æ ‡è¯†ä¸¤ä¸ª key çš„æ—¶å€™å°±æ— æ³•è¾¾åˆ°ç›®çš„äº†ã€‚\nå¯¹è±¡ä½œä¸º key :\n1 2 3 4 5 6 7  let map = Object.create(null), key1 = {}, key2 = {} map[key1] = \u0026#39;foo\u0026#39; console.log(map[key2]) // \u0026#39;foo\u0026#39;   +RESULTS:\nfoo  å¯¹è±¡ä½œä¸º key å€¼å¾—æ—¶å€™ï¼Œå†…éƒ¨ä¼šå‘ç”Ÿç±»å‹è½¬æ¢ï¼Œå°†å¯¹è±¡è½¬æˆ \u0026quot;[object Object]\u0026quot;\nå› æ­¤æ— è®ºç”¨ key1 è¿˜æ˜¯ key2 å»è®¿é—® map ï¼Œæœ€åçš„ç»“æœéƒ½æ˜¯ map[\u0026quot;[object Object]\u0026quot;] å»è®¿é—®äº†\nå› æ­¤ï¼Œç»“æœéƒ½æ˜¯ \u0026lsquo;foo\u0026rsquo;ã€‚\nSets é›†åˆ  åˆ›å»ºä½¿ç”¨ new Set() åˆ›å»ºå®ä¾‹ã€‚ æ·»åŠ ä½¿ç”¨ set.add() æ–¹æ³•ã€‚ é›†åˆåŒºåˆ†æ•°å€¼çš„æ•°å­—ç±»å‹å’Œå­—ç¬¦ä¸²ç±»å‹ï¼Œä¸ä¼šå‘ç”Ÿç±»å‹å¼ºè½¬ã€‚ -0 å’Œ +0 åœ¨é›†åˆä¸­ä¼šè¢«å½“åšä¸€æ ·å¤„ç† å¯¹è±¡å¯ä»¥ä½œä¸º set çš„å…ƒç´ ï¼Œä¸”ä¸¤ä¸ª {} ä¼šè¢«å½“åšä¸¤ä¸ªä¸åŒçš„å…ƒç´ å¤„ç†  set åˆå§‹åŒ– new Set() åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„ set\nå¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªæ•°ç»„ã€‚\n å®é™…ä¸Šï¼Œ Set æ„é€ å‡½æ•°å¯ä»¥æ¥å—ä»»æ„ä¸€ä¸ª iterable å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚\n 1 2 3  let set = new Set([1, 2, 3, 4]) console.log(set.size) // 4   +RESULTS:\n4  æ·»åŠ å…ƒç´  set.add() æ·»åŠ çš„å…ƒç´ åŒºåˆ†ç±»å‹ï¼Œä¸ä¼šåšç±»å‹è½¬æ¢ï¼Œå³ 5 å’Œ '5' æ˜¯ä¸ä¸€æ ·çš„ï¼Œé‡å¤æ·»åŠ ä¹Ÿåª\nä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œ=set= çš„å…ƒç´ æ˜¯ä¸ä¼šé‡å¤çš„ã€‚\n1 2 3 4 5 6 7  let set = new Set() set.add(5) set.add(\u0026#39;5\u0026#39;) set.add(5) console.log(set.size, set)   +RESULTS:\n2 Set { 5, '5' }  å¯¹è±¡å…ƒç´ ï¼š\n1 2 3 4 5 6 7 8 9  let set = new Set(), key1 = {}, key2 = {} set.add(key1) set.add(key2) set.add(key1) console.log(set.size) // 2   +RESULTS:\n2  set apis  set.has(v) åˆ¤æ–­ set ä¸­æ˜¯å¦æœ‰å…ƒç´  v ï¼Œè¿”å› true/false set.add(v) æ·»åŠ å…ƒç´  set.size é›†åˆå¤§å° set.delete(v) åˆ é™¤å…ƒç´  set.clear() æ¸…ç©ºé›†åˆ  é›†åˆè¿­ä»£(forEach) å¯¹é›†åˆä½¿ç”¨ forEach å’Œå¯¹æ•°ç»„ä½¿ç”¨çš„æ–¹æ³•ä¸€æ ·ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ï¼ŒæŠ“ä¸ªå‡½æ•°åˆä¸‰ä¸ª\nå‚æ•°ï¼š\n ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé›†åˆçš„å½“å‰å€¼ ç¬¬äºŒä¸ªå‚æ•°ï¼šå’Œç¬¬ä¸€ä¸ªå‚æ•°ä¸€æ ·æ˜¯å½“å‰å…ƒç´ çš„å€¼ï¼Œè·Ÿæ•°ç»„ä¸ä¸€æ ·ï¼Œæ•°ç»„ä½¿ç”¨\nforEach è¿™ä¸ªå‚æ•°æ˜¯å½“å‰ç´¢å¼•å€¼ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šè¢«éå†çš„é›†åˆæœ¬èº«ã€‚  Sets æ²¡æœ‰ Key å€¼ã€‚\n1 2 3 4 5 6  let set = new Set([\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;, \u0026#39;d\u0026#39;, \u0026#39;e\u0026#39;]) console.log(set[0]) // undefined, æ²¡æœ‰ä¸‹æ ‡å€¼ set.forEach(function(idx, v, ownerSet) { console.log(idx, v, ownerSet === set, ownerSet) })   +RESULTS:\nundefined a a true Set { 'a', 'b', 'c', 'd', 'e' } b b true Set { 'a', 'b', 'c', 'd', 'e' } c c true Set { 'a', 'b', 'c', 'd', 'e' } d d true Set { 'a', 'b', 'c', 'd', 'e' } e e true Set { 'a', 'b', 'c', 'd', 'e' }  ç»“æœæ‰€ç¤ºï¼š\n é›†åˆçš„ key å°±æ˜¯ valueã€‚ éå†çš„å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•° ownerSet å°±æ˜¯è¢«éå†çš„ set é›†åˆæœ¬èº«ã€‚  åœ¨ä½¿ç”¨ forEach å¯ä»¥ç»™å®ƒä¼ é€’ä¸€ä¸ªä¸Šä¸‹æ–‡å‚æ•°ï¼Œè®©ç»‘å®šå›è°ƒå‡½æ•°é‡Œé¢çš„ this\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let set = new Set([1,2]) let processor = { output(value) { console.log(\u0026#39;output from processor: \u0026#39; + value) }, process(dataSet, scope = 1) { const obj = { output(value) { console.log(\u0026#39;output from obj: \u0026#39; + value) } } dataSet.forEach(function(value) { this.output(value) }, scope === 1 ? this : obj) } } processor.process(set) // scope: processor processor.process(set, 2) // scope: obj   +RESULTS:\noutput from processor: 1 output from processor: 2 output from obj: 1 output from obj: 2   å°† this ä¼ é€’ç»™å›è°ƒï¼Œä»è€Œ output æ¥è‡ª processor ã€‚ å°† obj ä¼ é€’ç»™å›è°ƒï¼Œä»è€Œ output æ¥è‡ª obj ã€‚  ç»“è®ºï¼š*æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™ forEach ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°æ¥æ”¹å˜å›è°ƒå‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚*\nä½¿ç”¨ç®­å¤´å‡½æ•°è§£å†³ this æŒ‡å‘é—®é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let set = new Set([1,2]) let processor = { output(value) { console.log(\u0026#39;output from processor: \u0026#39; + value) }, process(dataSet) { // this æ€»æ˜¯ç»‘å®šåˆ° processor  dataSet.forEach(value =\u0026gt; this.output(value), {}) } } processor.process(set) // scope: processor    +RESULTS:\noutput from processor: 1 output from processor: 2  æ— è®ºç¬¬äºŒä¸ªå‚æ•° {} ä¼ æˆ–ä¸ä¼ ç»“æœéƒ½ä¸€æ ·ï¼Œç®­å¤´å‡½æ•°é‡Œçš„ this æŒ‡å‘ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚\n é›†åˆä¸èƒ½ç›´æ¥ä½¿ç”¨ç´¢å¼•è®¿é—®å…ƒç´ ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨åˆ°ç´¢å¼•è®¿é—®å…ƒç´ ï¼Œé‚£æœ€å¥½å°†é›†åˆè½¬æˆæ•°ç»„æ¥ä½¿ç”¨ã€‚\n Set å’Œ Array ä¹‹é—´çš„è½¬æ¢  é›†åˆè½¬æ•°ç»„ let set = new Set([1, 2, 3, 2]); ï¼Œä¸”ä¼šå°†é‡å¤çš„å…ƒç´ å»æ‰åªä½™\nä¸€ä¸ªã€‚ æ•°ç»„è½¬é›†åˆï¼Œæœ€ç®€å•çš„å°±æ˜¯å±•å¼€ç¬¦äº† let arr = [...set];  å±•å¼€ç¬¦(â€¦)å¯ä»¥ä½œç”¨åŸŸä»»ä½• iterable çš„å¯¹è±¡ã€‚å³ä»»ä½•å¯ iterable çš„å¯¹è±¡éƒ½å¯ä»¥é€š\nè¿‡ ... è½¬æˆæ•°ç»„ã€‚\nä¹Ÿå› ä¸ºæœ‰äº† Set å’Œ ... ä»è€Œæ˜¯æ•°ç»„çš„å»é‡å˜å¾—å¼‚å¸¸ç®€å•:\n1 2 3 4 5  const eleminateDuplicates = items =\u0026gt; [...new Set(items)] let nums = [1, 2, 3, 2, 4, 3, 4] console.log(eleminateDuplicates(nums).toString())   +RESULTS:\n1,2,3,4  å¼±é›†(Weak Sets) å› ä¸ºå®ƒå­˜å‚¨å¯¹è±¡å¼•ç”¨çš„æ–¹å¼ï¼Œé›†åˆç±»å‹ä¹Ÿå¯ä»¥å«åšå¼ºé›†åˆç±»å‹ã€‚\nå³é›†åˆä¸­å¯¹äºå¯¹è±¡çš„å­˜å‚¨æ˜¯å­˜å‚¨äº†è¯¥å¯¹è±¡çš„å¼•ç”¨è€Œä¸æ˜¯è¢«æ·»åŠ åˆ°é›†åˆæ˜¯çš„é‚£ä¸ªå˜é‡åè€Œ\nå·²ï¼Œç±»ä¼¼å¯¹è±¡çš„å±æ€§çš„å€¼ä¸ºå¯¹è±¡ä¸€æ ·ï¼Œå°±ç®—æ”¹å˜äº†è¿™ä¸ªå±æ€§çš„å€¼ï¼Œé‚£ä¸ªå¯¹è±¡å¦‚æœæœ‰å…¶ä»–\nå˜é‡æŒ‡å‘å®ƒï¼Œé‚£ä»–ä¸€æ ·å­˜åœ¨ï¼ˆç±»ä¼¼ C çš„æŒ‡é’ˆæ¦‚å¿µï¼Œä¸¤ä¸ªæŒ‡é’ˆåŒæ—¶æŒ‡å‘ä¸€å—å†…å­˜ï¼Œä¸€ä¸ª\næŒ‡é’ˆçš„æŒ‡å‘å‘ç”Ÿå˜åŒ–å¹¶ä¸ä¼šå½±å“å¦ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è¿™å—å†…å­˜ï¼‰ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let animal = { dog: { name: \u0026#39;xxx\u0026#39;, age: 10 } } let dog1 = animal.dog console.log(dog1.name) // \u0026#39;xxx\u0026#39; // å¼•ç”¨å‘ç”Ÿå˜åŒ– animal.dog = null // å¹¶ä¸å½±å“åˆ«çš„å˜é‡æŒ‡å‘ { name: \u0026#39;xxx\u0026#39;, age: 10 } è¿™ä¸ªå¯¹è±¡ console.log(dog1.age) // 10  // æŒ‡å›å»ï¼Œä¾æ—§æ˜¯å®ƒåŸæ¥æŒ‡å‘çš„é‚£ä¸ªå¯¹è±¡ animal.dog = dog1 console.log(animal.dog.name) // \u0026#39;xxx\u0026#39; console.log(animal.dog.age) // 10    +RESULTS:\nxxx 10 xxx 10  æ ¹æ®å¼•ç”¨çš„ç‰¹æ€§ï¼Œå¯¹äºé›†åˆå…ƒç´ ä¹Ÿä¸€æ ·å®ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  let set = new Set(); let key = {}; set.add(key) // å®é™…å°†å¯¹è±¡çš„å¼•ç”¨åŠ åˆ°é›†åˆä¸­  console.log(set) // 1 console.log(set.size) // 1  key = null // æ”¹å˜äº†å˜é‡å€¼è€Œå·²ï¼Œå®é™…å¼•ç”¨çš„é‚£ä¸ªå¯¹è±¡è¿˜åœ¨ console.log(set.size) // 1  key = [...set][0] console.log(key)// {}   +RESULTS:\nSet { {} } 1 1 {} undefined  è¿™ç§å¼ºå¼•ç”¨åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆå¯èƒ½ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚ï¼Œåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­\né›†åˆä¸­ä¿å­˜äº†ä¸€äº› DOM å…ƒç´ çš„å¼•ç”¨ï¼Œè€Œè¿™äº›å…ƒç´ æœ¬èº«å¯èƒ½ä¼šè¢«å…¶ä»–åœ°æ–¹çš„\nä»£ç ä» DOM æ ‘ä¸­ç§»é™¤ï¼ŒåŒæ—¶ä½ ä¹Ÿä¸æƒ³å†ä¿æœ‰è¿™äº› DOM å…ƒç´ çš„å¼•ç”¨äº†ï¼Œæˆ–è€…è¯´ä»¥å\néƒ½ä¸ä¼šç”¨åˆ°å®ƒäº†ï¼Œåº”è¯¥è¢«é‡Šæ”¾å›æ”¶æ‰å¯¹ï¼Œä½†æ˜¯å®é™…ä¸Šé›†åˆä¸­ä»ç„¶ä¿æœ‰è¿™äº›å…ƒç´ çš„å¼•ç”¨\n(å®é™…å·²ç»ä¸å­˜åœ¨çš„ä¸œè¥¿)ï¼Œè¿™ç§æƒ…å†µå°±å«åšå†…å­˜æ³„æ¼(memory leak)ã€‚\nä¸ºäº†è§£å†³è¿™ç§æƒ…å†µï¼Œ ECMAScript 6 ä¸­å¢åŠ äº†ä¸€ç§é›†åˆç±»å‹ï¼š weak sets ,å¼±å¼•ç”¨åª\nä¼šä¿å­˜å¯¹è±¡çš„å¼±å¼•ç”¨ ã€‚\nåˆ›å»º Weak Sets(WeakSet) å¼±å¼•ç”¨é›†åˆæ„é€ å‡½æ•°ï¼š WeakSet\n1 2 3 4 5 6 7 8 9 10 11  let set = new WeakSet(), key = {}, key1 = key set.add(key) console.log(set) key = null console.log(set.has(key)) console.log(set.has(key1)) console.log(set.has(null)) console.log(set)   +RESULTS:\nWeakSet { [items unknown] } false true false WeakSet { [items unknown] } undefined  æµè§ˆå™¨ç¯å¢ƒè¾“å‡ºç»“æœï¼š\nSet å’Œ WeakSet å¯¹æ¯” Set ä¸­æ·»åŠ å¯¹è±¡ï¼Œæ·»åŠ çš„æ˜¯å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œå› æ­¤ä¿å­˜è¯¥å¯¹è±¡çš„å˜é‡å€¼å‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸\nå½±å“è¯¥å¯¹è±¡åœ¨é›†åˆä¸­çš„äº‹å®ã€‚\nWeakSet ä¸­æ·»åŠ çš„æ˜¯è¯¥å˜é‡çš„åŸå§‹å€¼ï¼Ÿï¼Ÿå˜é‡å€¼ä¸€æ—¦æ”¹å˜ï¼Œé›†åˆä¸­çš„å†…å®¹å°†éšä¹‹æ”¹å˜(ç”±\nJavaScript å¼•æ“å¤„ç†)ã€‚\n TODO: Set ä¿å­˜å¼•ç”¨ï¼ŸWeekSet ä¿å­˜åŸå§‹å€¼ï¼Ÿï¼Ÿæœ‰å•¥åŒºåˆ«ï¼Ÿï¼Ÿ\n è¿™é‡Œæˆ‘ä»¬å°†å¯¹æ¯”ä¸¤ç§é›†åˆåœ¨ä¸åŒå½¢å¼ä¸‹çš„è¿è¡Œç»“æœï¼Œé€šè¿‡å¯¹æ¯”åˆ†ææ¥ææ¸…æ¥šé›†åˆä¸­å¼•ç”¨\nå’ŒåŸå§‹å€¼çš„æ¦‚å¿µã€‚\nSet, WeakSet æ·»åŠ å¯¹è±¡çš„ç»“æœ 1 2 3 4 5 6 7 8 9 10 11 12 13  let set = new Set() let key = { a: 1 } set.add(key) console.log(set) console.log(set.has(key)) // true  let wset = new WeakSet() let wkey = { a: 1 } wset.add(wkey) console.log(wset) console.log(wset.has(wkey))   +RESULTS:\nSet { { a: 1 } } true WeakSet { [items unknown] } true undefined  è¿™é‡Œ WeakSet ç»“æœä¸ç›´è§‚ï¼Œä¸‹é¢æ˜¯æµè§ˆå™¨ç»“æœï¼š\nä»æµè§ˆå™¨ç«¯çš„ç»“æœåˆ†æï¼š\n ä¸¤è€…åœ¨å†…éƒ¨å±æ€§ Entries ä¸­éƒ½æœ‰ä¸€ä¸ªæˆ‘ä»¬æ·»åŠ çš„ {a : 1} å¯¹è±¡å…ƒç´ ã€‚ WeakSet æ²¡æœ‰ size å±æ€§ï¼Œ Set æœ‰ size å±æ€§ã€‚  æ”¹å˜å¯¹è±¡ key/wkey çš„å€¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  let set = new Set() let key = { a: 1 } set.add(key) console.log(set) // æ”¹å˜ä¹‹å‰ key = null console.log(set) // æ”¹å˜ä¹‹å console.log(set.has(key)) // true  let wset = new WeakSet() let wkey = { a: 1 } wset.add(wkey) console.log(wset) // weak key æ”¹å˜ä¹‹å‰ wkey = null console.log(wset) // weak key æ”¹å˜ä¹‹å console.log(wset.has(wkey))   +RESULTS: emacs nodejs\nSet { { a: 1 } } Set { { a: 1 } } false WeakSet { [items unknown] } WeakSet { [items unknown] } false undefined  æµè§ˆå™¨ç¯å¢ƒè¾“å‡ºç»“æœï¼š\nç»“æœï¼š\n  å¯¹äº Set å¯¹è±¡å˜é‡ key å€¼å¾—æ”¹å˜å¹¶ä¸ä¼šå½±å“ Set ä¸­ {a:1} å¯¹è±¡\nSet å­˜æ”¾çš„æ˜¯å¯¹è±¡ {a:1} çš„å¼•ç”¨ï¼Œå³åœ¨ set.add(key) ä¹‹åï¼Œå®é™…ä¸Šæ˜¯æœ‰ä¸¤ä¸ªå¼•ç”¨æŒ‡å‘äº†\n{a:1} å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯ key è¿™ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯é›†åˆ set ä¸­çš„æŸä¸ªä½ç½®ä¸Šçš„å˜é‡(å‡è®¾ä¸º: fkey)ã€‚\næ ¹æ®å¼•ç”¨çš„ç‰¹æ€§ï¼Œ key çš„é‡Šæ”¾å¹¶ä¸ä¼šå½±å“ {a:1} è¿™ä¸ªå¯¹è±¡æœ¬èº«åœ¨å†…å­˜ä¸­çš„å­˜åœ¨ï¼Œå³ä¸ä¼šå½±å“ fkey\nå¯¹è¿™ä¸ªå¯¹è±¡çš„å½±å“ï¼Œä»è€Œå¹¶ä¸å½±å“ set çš„å†…å®¹ã€‚\n  WeakSet ä¸­çš„ {a:1} æ²¡æœ‰äº†\nWeakSet æˆ‘ä»¬è¯´å®ƒæ·»åŠ çš„æ˜¯ wkey çš„åŸå§‹å€¼ï¼Œå³ä½¿ç›´æ¥å’Œ wkey è¿™ä¸ªå˜é‡çš„åŸå§‹å€¼æŒ‚é’©çš„ï¼Œ\næ‰§è¡Œ wkey = null å°±æ˜¯è®²å®ƒçš„åŸå§‹å€¼å‘ç”Ÿæ”¹å˜ï¼Œæœ€ç»ˆå°†å½±å“ WeakSet ã€‚\n  é’ˆå¯¹ #2 ä¸­çš„ WeakSet æƒ…å†µï¼Œå°†ç¨‹åºæ”¹é€ ä¸€ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let set = new Set() let key = { a: 1 } let key1 = key set.add(key) console.log(set) // æ”¹å˜ä¹‹å‰ key = null console.log(set) // æ”¹å˜ä¹‹å console.log(set.has(key)) // true  console.log(\u0026#39;-------- æ¥šæ²³æ±‰ç•Œ ---------\u0026#39;) let wset = new WeakSet() let wkey = { a: 1 } let wkey1 = wkey wset.add(wkey) console.log(wset) // weak key æ”¹å˜ä¹‹å‰ wkey = null console.log(wset) // weak key æ”¹å˜ä¹‹å console.log(wset.has(wkey)) console.log(wset.has(wkey1))   +RESULTS:\nSet { { a: 1 } } Set { { a: 1 } } false -------- æ¥šæ²³æ±‰ç•Œ --------- WeakSet { [items unknown] } WeakSet { [items unknown] } false true undefined  å†æ¥çœ‹çœ‹è¾“å‡ºç»“æœï¼š\næˆ‘ä»¬å¾—åˆ°äº†ä»¤äººæ„å¤–çš„ç»“æœï¼š\n å¹¶æ²¡æœ‰æ˜¾ç¤ºçš„ wset.add(wkey1) ä½†æ˜¯æœ€åçš„ wset.has(wkey1) çš„ç»“æœå´æ˜¯ true ã€‚ wset é›†åˆä¸­çš„ {a:1} ä¾ç„¶å­˜åœ¨ã€‚  è¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œåˆ™éœ€è¦çŸ¥é“â€œå¼ºå¼•ç”¨â€å’Œâ€œå¼±å¼•ç”¨â€çš„åŒºåˆ«ï¼š\nå¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ æˆ‘ä»¬éƒ½çŸ¥é“ JavaScript çš„åƒåœ¾å›æ”¶æœºåˆ¶ä¸­æœ‰ä¸€ä¸ªç›¸å…³çŸ¥è¯†ç‚¹å°±å«åšå¼•ç”¨è®¡æ•°ï¼Œå³ä¸€ä¸ª\nå¯¹è±¡å¦‚æœæœ‰è¢«å…¶ä»–å˜é‡\nå¼•ç”¨é‚£ä¹ˆè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°± +1 å¦‚æœè¿™ä¸ªå˜é‡è¢«é‡Šæ”¾è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°± -1\nä¸€æ—¦å¼•ç”¨è®¡æ•°ä¸º 0 åƒåœ¾å›æ”¶æœºåˆ¶å°±ä¼šå°†è¿™ä¸ªå¯¹è±¡å›æ”¶æ‰ï¼Œå› ä¸ºæ²¡æœ‰äººå†ä½¿ç”¨å®ƒäº†ã€‚\nå¼ºå¼•ç”¨(Set) ï¼šç›¸å½“äºè®©è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•° +1 ï¼Œå¦‚ Set é›†åˆä¿å­˜äº†å¯¹è±¡çš„å¼•ç”¨å¯¼\nè‡´å¼•ç”¨è®¡æ•° +1 ï¼Œåœ¨æ‹¥æœ‰è¯¥å¯¹è±¡çš„å˜é‡ key çš„å€¼æ€ä¹ˆå˜åŒ–éƒ½ä¸ä¼šå¯¼è‡´å¼•ç”¨è®¡æ•°ä¸º\n0 ä»è€Œé˜»æ­¢äº†åƒåœ¾å›æ”¶å™¨å°†å…¶å›æ”¶æ‰ã€‚\nå¼±å¼•ç”¨(WeakSet): å¯¹å¯¹è±¡çš„å¼•ç”¨ä¸ä¼šè®¡å…¥åˆ°å¼•ç”¨è®¡æ•°ä¸­ï¼Œå³å°† wkey åŠ å…¥åˆ°\nWeakSet ä¸­ï¼Œå¹¶ä¸ä¼šå¼•èµ· wkey æŒ‡å‘çš„é‚£ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•° +1 ï¼Œå› æ­¤åªè¦é‡Šæ”¾äº†\nwkey å¯¹å…¶çš„å¼•ç”¨ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±å˜æˆ 0 äº†ï¼Œå› æ­¤æ­¤æ—¶åªæœ‰ wkey æŒ‡å‘ {a:1}\nè¿™ä¸ªå¯¹è±¡ï¼Œæ”¹å˜ wkey å°±ä¼šæ”¹å˜ WeakSet ä¸­çš„å†…å®¹ï¼Œå› ä¸ºè¿™ä¸ªå†…å®¹å·²ç»è¢«å›æ”¶æ‰äº†ã€‚\n/æ ¹æ®ä¸Šé¢çš„ç»“è®ºï¼Œæˆ‘ä»¬å°±çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬å¢åŠ äº†ä¸€è¡Œ let key1 = key ä¹‹åï¼Œ\n{a:1} å¯¹è±¡ä¾ç„¶ä¼šåœ¨ wset ä¸­å› ä¸ºæ­¤æ—¶ {a:1} å¼•ç”¨è®¡æ•°ä¸ä¸º 0 å¹¶æ²¡æœ‰è¢«é‡Šæ”¾\næ‰ã€‚/\nMaps es6 çš„ Map ç±»å‹æ˜¯ä¸€ä¸ªæœ‰åºçš„é”®å€¼å¯¹åˆ—è¡¨ï¼Œ key å’Œ value å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œå¹¶ä¸” key\nä¸ä¼šå‘ç”Ÿç±»å‹å¼ºè½¬ï¼Œä¹Ÿå°±æ˜¯è¯´ 5 å’Œ \u0026quot;5\u0026quot; å±äºä¸åŒçš„ä¸¤ä¸ªé”®ï¼Œå’Œå¯¹è±¡ä¸ä¸€æ ·(å¯¹è±¡æŠŠä»–\nä»¬å½“åšä¸€ä¸ªé”®ï¼Œå› ä¸ºå¯¹è±¡çš„ key æœ€ç»ˆè¡¨ç¤ºå½¢å¼ä¸º string å†…éƒ¨æœ‰å‘ç”Ÿå¼ºåˆ¶è½¬æ¢)ã€‚\nMap åˆå§‹åŒ– ä¸€ä¸ª map å®ä¾‹å¿…é¡»é€šè¿‡æ„é€ å‡½æ•°æ¥åˆ›å»º new Map() ï¼ŒåŒæ—¶å¯ä»¥ç»™æ„é€ å‡½æ•°ä¼ é€’ä¸€ä¸ª\niterable çš„å¯¹è±¡ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™åˆå§‹åŒ–ï¼Œè¿™ä¸ª iterable å¯¹è±¡ä¼šè¢«è½¬æˆ mapã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  let map = new Map([[\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;], [\u0026#39;age\u0026#39;, 25]]) console.log(map) console.log(map.has(\u0026#39;name\u0026#39;)) // true console.log(map.get(\u0026#39;name\u0026#39;)) // å¼ ä¸‰ console.log(map.has(\u0026#39;age\u0026#39;)) // true console.log(map.get(\u0026#39;age\u0026#39;)) // 25 console.log(map.size) // 2  try { // ä¸€ç»´æ•°ç»„ï¼Œä¸ç¬¦åˆ entry object  let map1 = new Map([1, 2, 3]) console.log(map1) } catch (e) { console.log(e.message) } try { // å¯¹è±¡é iterable  let map2 = new Map({a: 1, b: 2, length: 2}) console.log(map2) } catch (e) { console.log(e.message) } try { let map3 = new Map(new Set([[\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;, 1], [\u0026#39;age\u0026#39;, 25, 2]])) console.log(map3) } catch (e) { console.log(e.message) } try { let map4 = new Map(new Set([\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;])) console.log(map4) } catch (e) { console.log(e.message) } try { let map5 = new Map(new Set([[\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;], [\u0026#39;age\u0026#39;, 25]])) console.log(map5) } catch (e) { console.log(e.message) }   +RESULTS:\nMap { 'name' =\u0026gt; 'å¼ ä¸‰', 'age' =\u0026gt; 25 } true å¼ ä¸‰ true 25 2 Iterator value 1 is not an entry object #\u0026lt;Object\u0026gt; is not iterable Map { 'name' =\u0026gt; 'å¼ ä¸‰', 'age' =\u0026gt; 25 } Iterator value name is not an entry object Map { 'name' =\u0026gt; 'å¼ ä¸‰', 'age' =\u0026gt; 25 } undefined  å› æ­¤èƒ½è¢«è½¬æˆ map çš„å¯¹è±¡éœ€è¦æ»¡è¶³ï¼š\n å¿…é¡»æ˜¯ iterable å¿…é¡»æœ‰é”®å€¼å¯¹ç±»å‹çš„åˆ—è¡¨å¯¹è±¡ï¼Œæ¯”å¦‚äºŒç»´æ•°ç»„ã€‚  Map çš„ key å’Œ value å¯ä»¥æ˜¯ä»»æ„å¯¹è±¡ã€‚\n\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  let map = new Map() map.set({}, \u0026#39;EmptyObject\u0026#39;) // è™½ç„¶éƒ½æ˜¯ {} ä½†æ˜¯å¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ˜¯ä¸èƒ½ç­‰åŒçš„ console.log(map.get({})) // undefined  map.clear() let emptyObj = {} map.set(emptyObj, \u0026#39;EmptyObject\u0026#39;) console.log(map) console.log(map.get(emptyObj)) // \u0026#39;EmptyObject\u0026#39; console.log(map.size) // 1  emptyObj = null console.log(map) console.log(map.get(emptyObj)) // \u0026#39;undefined\u0026#39; console.log(map.size) // 1, å› ä¸º Map æ˜¯å¼ºå¼•ç”¨ï¼ŒemptyObj = null å¹¶ä¸ä¼šæ”¹å˜   +RESULTS:\nundefined Map { {} =\u0026gt; 'EmptyObject' } EmptyObject 1 Map { {} =\u0026gt; 'EmptyObject' } undefined 1 undefined  map.set(key, value) å’Œ map.get(key) Map å®ä¾‹å¯ä»¥é€šè¿‡ set å’Œ get æ–¹æ³•å»è®¾ç½®é”®å€¼å¯¹ç„¶åè·å–è¯¥å€¼ã€‚\n1 2 3 4 5 6 7 8  let map = new Map() map.set(\u0026#39;title\u0026#39;, \u0026#39;u es6\u0026#39;) map.set(\u0026#39;year\u0026#39;, 2019) console.log(map) console.log(map.get(\u0026#39;title\u0026#39;)) console.log(map.get(\u0026#39;year\u0026#39;)) console.log(map[0])   +RESULTS:\nMap { 'title' =\u0026gt; 'u es6', 'year' =\u0026gt; 2019 } u es6 2019 undefined undefined  map æ•°æ®çš„å†…éƒ¨å­˜å‚¨æ ¼å¼({ 'key' =\u0026gt; value })ï¼š\næ–¹æ³•  map.has(key) æ£€æµ‹ map ä¸­æ˜¯å¦å­˜åœ¨ key map.delete(key) åˆ é™¤ key å¯¹åº”çš„å€¼ map.clear() æ¸…ç©ºæ‰€æœ‰é”®å€¼å¯¹ map.size map çš„å¤§å°ï¼Œé”®å€¼å¯¹çš„ä¸ªæ•°  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  let map = new Map() map.set(\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;) map.set(\u0026#39;age\u0026#39;, 22) console.log(\u0026#39;-------- init ---------\u0026#39;) console.log(map) console.log(map.size) // 2 console.log(map.has(\u0026#39;name\u0026#39;)) // true console.log(map.get(\u0026#39;name\u0026#39;)) // å¼ ä¸‰ console.log(map.has(\u0026#39;age\u0026#39;)) // true console.log(map.get(\u0026#39;age\u0026#39;)) // 22  console.log(\u0026#39;-------- delete ---------\u0026#39;) map.delete(\u0026#39;name\u0026#39;) console.log(map) console.log(map.has(\u0026#39;name\u0026#39;)) // false console.log(map.get(\u0026#39;name\u0026#39;)) // undefined console.log(map.size) // 1  console.log(\u0026#39;-------- clear ---------\u0026#39;) map.clear() console.log(map) console.log(map.has(\u0026#39;name\u0026#39;)) // false console.log(map.get(\u0026#39;name\u0026#39;)) // undefined console.log(map.has(\u0026#39;age\u0026#39;)) // false console.log(map.get(\u0026#39;age\u0026#39;)) // undefined console.log(map.size) // 0   +RESULTS:\n-------- init --------- Map { 'name' =\u0026gt; 'å¼ ä¸‰', 'age' =\u0026gt; 22 } 2 true å¼ ä¸‰ true 22 -------- delete --------- Map { 'age' =\u0026gt; 22 } false undefined 1 -------- clear --------- Map {} false undefined false undefined 0 undefined  forEach forEach åœ¨ map ä¸Šçš„ä½¿ç”¨æ–¹å¼è·Ÿé›†åˆå’Œæ•°ç»„ç±»ä¼¼ï¼Œå›è°ƒæ¥å—ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨ï¼š\n value: ä»£è¡¨å½“å‰å¾ªç¯ map ä¸­å…ƒç´ é”®å€¼ä¸­çš„å€¼ key: ä»£è¡¨ map å…ƒç´ é”®å€¼ä¸­çš„é”® map: å½“å‰çš„ map è‡ªèº«  å› æ­¤ï¼Œ map çš„ forEach çœ‹èµ·æ¥ä¸æ•°ç»„æ›´åƒï¼Œæœ‰ value, key, map ï¼Œå¹¶ä¸” value\nä»£è¡¨å€¼ï¼Œkey è¡¨ç¤ºé”®ï¼ˆæ•°ç»„ä¸­çš„ç´¢å¼•ï¼‰ï¼Œmap ä»£è¡¨è‡ªèº«ã€‚\n1 2 3 4 5 6  let map = new Map([[\u0026#39;name\u0026#39;, \u0026#39;å¼ ä¸‰\u0026#39;], [\u0026#39;age\u0026#39;, 22]]) map.forEach(function(value, key, ownerMap) { console.log(`${key}: ${value}`) console.log(ownerMap === map) })   +RESULTS:\nname: å¼ ä¸‰ true age: 22 true undefined  å’Œ Set ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥å°† this ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ï¼Œç»‘å®šå›è°ƒå‡½æ•°çš„ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…ç›´æ¥\nä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œå°±å¯ä»¥çœç•¥è¿™ä¸ªå‚æ•°äº†ã€‚\nWeakMap WeakMap ç±»ä¼¼ WeakSet ä¸€æ ·ï¼Œæ˜¯ä¸€ç§å¼±å¼•ç”¨ç±»å‹ã€‚\næœ‰äº†8.3çš„è¯´æ˜ï¼Œç†è§£å°†è®©æˆ‘ä»¬å¾ˆå®¹æ˜“ç†è§£ WeakMap ã€‚\n**WeakMap å¼±å¼•ç”¨ï¼Œå³å®ƒé‡Œé¢çš„å¼•ç”¨ç±»å‹ï¼Œä¸è®¡å…¥å¼•ç”¨è®¡æ•°ç»Ÿè®¡ï¼Œä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚**  çœ‹ä¸‹ 8.4.1 çš„ç¤ºä¾‹ï¼Œå°† Map æ”¹æˆ WeakMap çœ‹ä¸‹ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  let map = new WeakMap() try { map.clear() } catch (e) { console.log(e.message) } let emptyObj = {} map.set(emptyObj, \u0026#39;EmptyObject\u0026#39;) console.log(map.get(emptyObj)) // \u0026#39;EmptyObject\u0026#39; console.log(map.size) // undefined  emptyObj = null console.log(map.get(emptyObj)) // \u0026#39;undefined\u0026#39; console.log(map.size) // undefined  map.delete(emptyObj) let obj = {a: 1, b: 2} map.set(obj, \u0026#39;NormalObject\u0026#39;) console.log(map.get(obj)) map.delete(obj) console.log(map.get(obj))   +RESULTS:\nmap.clear is not a function EmptyObject undefined undefined undefined NormalObject undefined   WeakMap ä¸­æ²¡æœ‰ map.clear() WeakMap æ²¡æœ‰ size å±æ€§ï¼Œå’Œ WeakSet ä¸€æ · å¼±å¼•ç”¨ï¼Œ emptyObj = null ä¼šä½¿ map ä¸­çš„ emptyObj è¢«åˆ é™¤  è¿­ä»£å™¨å’Œç”Ÿæˆå™¨(Iterators \u0026amp; Generators) ä»€ä¹ˆæ˜¯è¿­ä»£å™¨(Iterators)ï¼Ÿ è¿­ä»£å™¨ï¼šæ‹¥æœ‰ç‰¹æ®Šæ¥å£(ç”¨æ¥éå†è¯¥å¯¹è±¡)çš„ä¸€äº›å¯¹è±¡ã€‚\næ‰€æœ‰è¿­ä»£å™¨å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª next() æ–¹æ³•è¿”å›ä¸€ä¸ªç»“æœå¯¹è±¡ã€‚\nè¯¥ç»“æœå¯¹è±¡åŒ…å«ä¸¤ä¸ªå±æ€§ï¼š\n value è¿­ä»£è¿‡ç¨‹ä¸­ä¸‹ä¸€ä¸ªå€¼ done , boolean æ˜¯å¦æ˜¯æœ€åä¸€ä¸ª  è¿­ä»£å™¨æ‹¥æœ‰ä¸€ä¸ªå†…éƒ¨æŒ‡é’ˆæŒ‡å‘æ€»æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå€¼ã€‚\nåˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨ï¼š\n è¿”å›å¯¹è±¡ä¸­å¿…é¡»æœ‰ next() æ–¹æ³• å¿…é¡»æœ‰ç»ˆç»“æ¡ä»¶å±æ€§ done  \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  function createIterator(items) { var i = 0; return { next: function() { var done = ( i \u0026gt;= items.length); var value = !done ? items[i++] : undefined; return { done, value }; } } } var iterator = createIterator([1, 2, 3]); console.log(iterator.next()); // { value: 1, done: false } console.log(iterator.next()); // { value: 2, done: false } console.log(iterator.next()); // { value: 3, done: false } console.log(iterator.next()); // { value: undefined, done: true } console.log(iterator.next()); // { value: undefined, done: true } console.log(iterator.next()); // { value: undefined, done: true }    +RESULTS:\n{ done: false, value: 1 } { done: false, value: 2 } { done: false, value: 3 } { done: true, value: undefined } { done: true, value: undefined } { done: true, value: undefined }  ä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨(Generators)ï¼Ÿ ç”Ÿæˆå™¨ï¼šä¸€ä¸ªè¿”å›è¿­ä»£å™¨çš„å‡½æ•°ã€‚\nç”Ÿæˆå™¨å£°æ˜æ–¹å¼ï¼š function *createIterator() {} ï¼Œä½¿ç”¨ *fnName æ–¹å¼ã€‚\nå®ƒçš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼Œé‡Œé¢ä½¿ç”¨ yield å…³é”®è¯æš‚åœè¯­å¥ã€‚\n\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function *createIterator() { yield 1; yield 2; yield 3; } let iterator = createIterator(); console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next()) // { value: 2, done: false } console.log(iterator.next()) // { value: 3, done: false } console.log(iterator.next()) // { value: undefined, done: true } console.log(iterator.next()) // { value: undefined, done: true } console.log(iterator.next()) // { value: undefined, done: true }   +RESULTS:\n{ value: 1, done: false } { value: 2, done: false } { value: 3, done: false } { value: undefined, done: true } { value: undefined, done: true } { value: undefined, done: true }  è·Ÿ 9.1 ç»“æœä¸€æ ·ã€‚\nç”Ÿæˆå™¨å‡½æ•°ä¸æ™®é€šå‡½æ•°åŒºåˆ«ï¼š\n ä½¿ç”¨æ˜Ÿå·(*) åŠ åå­—å£°æ˜ è¿”å›å€¼æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ iterator åªæœ‰ä½¿ç”¨è¿­ä»£å™¨è°ƒç”¨äº† next() æ‰ä¼šè¿”å›å€¼ï¼Œè¯¥å€¼ä¸ºå‡½æ•°ä¸­ yield å…³é”®è¯è¯­å¥å¯¹åº”  yield å‘Šè¯‰å¼•æ“ï¼Œæˆ‘åœ¨è¿™é‡Œè¦æš‚åœä¸‹ï¼Œå¦‚æœè¦æˆ‘ç»§ç»­ä¸‹å»ï¼Œå°±è¯·ç”¨æˆ‘è¿”å›çš„è¿­ä»£å™¨è°ƒç”¨ä¸‹\nnext() è·å–å½“å‰ yield æš‚åœåœ°æ–¹çš„è¿”å›ç»“æœã€‚\nå¾ªç¯ä¸­çš„ yield yield å…³é”®è¯å¯ä»¥ç”¨äºä»»æ„å€¼æˆ–è¯­å¥ï¼Œæ¯”å¦‚ï¼šå¾ªç¯ä¸­ä½¿ç”¨ yield\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function *createIterator(items) { for (let i = 0; i \u0026lt; items.length; i++) { yield items[i]; } } const iterator = createIterator([1, 2, 3]); console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next()) // { value: 2, done: false } console.log(iterator.next()) // { value: 3, done: false } console.log(iterator.next()) // { value: undefined, done: true } console.log(iterator.next()) // { value: undefined, done: true } console.log(iterator.next()) // { value: undefined, done: true }   +RESULTS:\n{ value: 1, done: false } { value: 2, done: false } { value: 3, done: false } { value: undefined, done: true } { value: undefined, done: true } { value: undefined, done: true }  ä¸¤ä¸ª yield ä¹‹é—´æœ‰å¤šä¸ªè¯­å¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function *createIterator(items) { for (let i = 0; i \u0026lt; items.length; i++) { console.log(i, \u0026#39;i\u0026#39;); yield items[i]; } } const iterator = createIterator([1, 2, 3]); console.log(iterator.next()) // { value: 1, done: false } //console.log(iterator.next()) // { value: 2, done: false } //console.log(iterator.next()) // { value: 3, done: false } // console.log(iterator.next()) // { value: undefined, done: true } // console.log(iterator.next()) // { value: undefined, done: true } // console.log(iterator.next()) // { value: undefined, done: true }    yield åœ¨ console.log è¯­å¥ä¹‹åçš„ç»“æœåˆ†æï¼š\n1 2  console.log(i, \u0026#39;i\u0026#39;); yield items[i];      next() ä¸ªæ•° ç»“æœ     console.log(iterator.next()) * 0 :   console.log(iterator.next()) * 1 : 0 \u0026lsquo;i\u0026rsquo;    : { value: 1, done: false }   console.log(iterator.next()) * 2 : 0 \u0026lsquo;i\u0026rsquo;    : { value: 1, done: false }    : 1 \u0026lsquo;i\u0026rsquo;    : { value: 2, done: false }   console.log(iterator.next()) * 3 : 0 \u0026lsquo;i\u0026rsquo;    : { value: 1, done: false }    : 1 \u0026lsquo;i\u0026rsquo;    : { value: 2, done: false }    : 2 \u0026lsquo;i\u0026rsquo;    : { value: 3, done: false }    yield åœ¨ console.log è¯­å¥ä¹‹å‰çš„ç»“æœåˆ†æï¼š\n1 2  yield items[i]; console.log(i, \u0026#39;i\u0026#39;);      next() ä¸ªæ•° ç»“æœ     console.log(iterator.next()) * 1 : { value: 1, done: false }   console.log(iterator.next()) * 2 : { value: 1, done: false }    : 0 \u0026lsquo;i\u0026rsquo;    : { value: 2, done: false }   console.log(iterator.next()) * 3 : { value: 1, done: false }    : 0 \u0026lsquo;i\u0026rsquo;    : { value: 2, done: false }    : 1 \u0026lsquo;i\u0026rsquo;    : { value: 3, done: false }    ä»ä¸Šé¢ä¸‰ç§ç»“æœå¾—å‡ºï¼š yield åœ¨è°ƒç”¨ next() ä¹‹åæ‰§è¡Œçš„è¯­å¥èŒƒå›´æ˜¯ï¼šå½“å‰ yield\nä¸ä¸Šä¸€ä¸ª yield ä¹‹é—´çš„è¯­å¥ã€‚\nå¾—å‡ºä¸Šè¿°ç»“æœçš„åŸå› ï¼šæ‰§è¡Œç”Ÿæˆå™¨å‡½æ•°æœ¬èº«çš„æ—¶å€™ï¼Œå®ƒåªæ˜¯è¿”å›äº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œæœ¬èº«çš„å‡½æ•°\nä½“æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œé™¤éè°ƒç”¨äº† next() æ‰ä¼šå»æ‰§è¡Œå‡½æ•°ä½“ã€‚\nè¯æ˜ï¼š\n1 2 3 4 5 6 7 8 9  function *createIterator(items) { console.log(\u0026#39;generator called...\u0026#39;) for (let i = 0; i \u0026lt; items.length; i++) { console.log(i, \u0026#39;i\u0026#39;); yield items[i]; } } const iterator = createIterator([1, 2, 3]);   +RESULTS: ç»“æœä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œç¬¬ä¸€ä¸ª console.log å¹¶æ²¡æœ‰è¢«æ‰§è¡Œã€‚\nundefined  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function *createIterator(items) { console.log(\u0026#39;generator called...\u0026#39;) for (let i = 0; i \u0026lt; items.length; i++) { console.log(i, \u0026#39;i\u0026#39;); yield items[i]; } } const iterator = createIterator([1, 2, 3]); console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next()) // { value: 2, done: false } console.log(iterator.next()) // { value: 3, done: false } console.log(iterator.next()) // { value: undefined, done: true } console.log(iterator.next()) // { value: undefined, done: true } console.log(iterator.next()) // { value: undefined, done: true }   +RESULTS:\ngenerator called... 0 'i' { value: 1, done: false } 1 'i' { value: 2, done: false } 2 'i' { value: 3, done: false } { value: undefined, done: true } { value: undefined, done: true } { value: undefined, done: true } undefined  ç”Ÿæˆå™¨å‡½æ•°è¡¨è¾¾å¼(Generator Function Expressions) é™¤äº†å¯ä»¥åœ¨å£°æ˜å¼å‘½åå‡½æ•°ç”Ÿæˆè¿­ä»£å™¨å‡½æ•°ï¼Œè¿˜å¯ä»¥é€šè¿‡è¡¨è¾¾å¼çš„æ–¹å¼åˆ›å»ºç”Ÿæˆå™¨å‡½æ•°ï¼š\n å³è¾¹å¸¦åå­—çš„ var createIterator = function *createIterator() {} å³è¾¹ä¸åå­—çš„ var createIterator = function *() {}  ä½¿ç”¨å’Œæ•ˆæœå’Œæ™®é€šç”Ÿæˆå™¨å‡½æ•° 9.2ä¸€æ ·ã€‚\n ç®­å¤´å‡½æ•°ä¸èƒ½ç”¨æ¥ç”Ÿæˆç”Ÿæˆå™¨å‡½æ•°ã€‚\n1 2 3  let createIterator = *() =\u0026gt; { yield 1; }   æ‰§è¡Œåé”™è¯¯ç»“æœï¼š\n/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI/js-script-4JzlJj:3 let createIterator = *() =\u0026gt; { ^\nSyntaxError: Unexpected token * at Module._compile (internal/modules/cjs/loader.js:721:23) at Object.Module._extensions..js (internal/modules/cjs/loader.js:787:10) at Module.load (internal/modules/cjs/loader.js:653:32) at tryModuleLoad (internal/modules/cjs/loader.js:593:12) at Function.Module._load (internal/modules/cjs/loader.js:585:3) at Function.Module.runMain (internal/modules/cjs/loader.js:829:12) at startup (internal/bootstrap/node.js:283:19) at bootstrapNodeJSCore (internal/bootstrap/node.js:622:3)\n å¯¹è±¡ä¸­çš„ç”Ÿæˆå™¨æ–¹æ³•æˆå‘˜ ECMAScript 5 é£æ ¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11  let o = { createIterator: function *(items) { for (let i = 0; i \u0026lt; items.length; i++) { yield items[i]; } } } let iterator = o.createIterator([1, 2, 3]); console.log(iterator.next()); // { value: 1, done: false }   +RESULTS:\n{ value: 1, done: false }  ECMAScript 6 æ–¹æ³•ç®€å†™é£æ ¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  let o = { *createIterator(items) { for (let i = 0; i \u0026lt; items.length; i++) { yield items[i]; } } } let iterator = o.createIterator([1, 2, 3]); console.log(iterator.next()); // { value: 1, done: false }    +RESULTS:\n{ value: 1, done: false }  å¯è¿­ä»£æ€§å’Œ for-of ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡å¿…é¡»æœ‰ä¸€ä¸ª Symbol.iterator å±æ€§ã€‚\nåƒæˆ‘ä»¬åœ¨è¿­ä»£é›†åˆå¯¹è±¡(arrays, sets, maps)å’Œå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œåœ¨å†…éƒ¨å…¶å®æ˜¯ä½¿ç”¨äº†åˆ°äº†ä»–\nä»¬é»˜è®¤çš„ Symbol.iterator è¿­ä»£å™¨çš„ã€‚\n æ‰€æœ‰ç”±ç”Ÿæˆå™¨åˆ›å»ºçš„è¿­ä»£å™¨éƒ½æ˜¯å¯ä»¥è¿­ä»£çš„ï¼Œå› ä¸ºç”Ÿæˆå™¨ä¹Ÿæœ‰é»˜è®¤çš„ Symbol.iterator\nå†…éƒ¨å±æ€§ã€‚\n for-of for-of ä¼šåœ¨æ¯æ¬¡è¿­ä»£çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ next() è¿›å…¥ä¸‹ä¸€æ¬¡è¿­ä»£ï¼Œå¹¶ä¸”å°† value çš„å€¼\nä¿å­˜åˆ°ä¸€ä¸ªå˜é‡å½“ä¸­ä»¥ä¾›ä½¿ç”¨ã€‚\n1 2 3 4 5  let values = [1, 2, 3]; for (let num of values) { console.log(num); }   +RESULTS:\n1 2 3  å¦‚æœï¼Œåœ¨è¿­ä»£è¿‡ç¨‹ä¸­åªéœ€è¦ç”¨åˆ°è¯¥è¢«è¿­ä»£å¯¹è±¡çš„å…ƒç´ å€¼å¾—æ—¶å€™ï¼Œæ¨èä½¿ç”¨ for-of å› ä¸ºå®ƒ\nä¾èµ–å’Œæ£€æµ‹çš„æ¡ä»¶æ›´å°‘ã€‚\n for-of è¯­å¥ä½¿ç”¨åœ¨ non-iterable å¯¹è±¡ï¼Œ null æˆ– undefined ä¸Šçš„æ—¶å€™ä¼šæŠ¥é”™ã€‚\n è®¿é—®é»˜è®¤è¿­ä»£å™¨ ä¹‹å‰æˆ‘ä»¬è®²è¿‡ï¼Œä»»ä½•ä¸€ä¸ªå¯ä»¥è¿­ä»£çš„å¯¹è±¡ï¼Œéƒ½å¿…é¡»æœ‰ Symbol.iterator å±æ€§ï¼Œæ— è®ºæ˜¯å†…\néƒ¨å®ç°è¿˜æ˜¯ç”¨æˆ·å®ç°ä¹Ÿå¥½ã€‚\nè¿™é‡Œå°†æ¢è®¨å¦‚æœä½¿ç”¨å’Œè®¿é—®é»˜è®¤è¿­ä»£å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10  let values = [1, 2, 3]; // å¾—åˆ°æ•°ç»„å†…éƒ¨çš„è¿­ä»£å™¨ let iterator = values[Symbol.iterator]() console.log(iterator.next()); // { value: 1, done: false } console.log(iterator.next()); // { value: 2, done: false } console.log(iterator.next()); // { value: 3, done: false } console.log(iterator.next()); // { value: undefined, done: true } console.log(iterator.next()); // { value: undefined, done: true }   +RESULTS:\n{ value: 1, done: false } { value: 2, done: false } { value: 3, done: false } { value: undefined, done: true } { value: undefined, done: true }  å’Œæˆ‘ä»¬è‡ªå®šä¹‰æ–¹å¼åˆ›å»ºçš„è¿­ä»£å™¨9.1ç»“æœä¸€æ ·ã€‚\næ£€æµ‹ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯å¯è¿­ä»£çš„ï¼Œæ ¹æ®æ¯ä¸ªå¯è¿­ä»£çš„å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª Symbol.iterator å±\næ€§(å†…éƒ¨æˆ–è‡ªå®šä¹‰)ï¼Œä¸”æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚\nåˆ™æœ‰ï¼š\n1 2 3 4 5 6 7 8 9 10  function isIterable(object) { return typeof object[Symbol.iterator] === \u0026#39;function\u0026#39;; } console.log(isIterable([1, 2, 3,])); // true console.log(isIterable(\u0026#39;string\u0026#39;)); // true console.log(isIterable(new Map())); // true console.log(isIterable(new Set())); // true console.log(isIterable(new WeakMap())); // false console.log(isIterable(new WeakSet())); // false   +RESULTS:\ntrue true true true false false  åˆ›å»ºæˆ–é‡å†™è¿­ä»£å™¨ é€šè¿‡ Symbol.iterator å±æ€§åŠ ä¸Šç”Ÿæˆå™¨å‡½æ•°å¯ä»¥å¾ˆå®¹æ˜“çš„è®©ä¸€ä¸ª non-iterable å¯¹è±¡å˜æˆ\niterable :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let collection = { items: [], *[Symbol.iterator]() { for (let item of this.items) { yield item; } } } collection.items.push(...[1, 2, 3]); for (let x of collection) { // äº‹å®ä¸Šæ˜¯è°ƒç”¨äº†è‡ªå®šä¹‰å®ç°çš„ `*[Symbol.iterator]() {}` å‡½æ•°  console.log(x); }   +RESULTS:\n1 2 3  å†…ç½®è¿­ä»£å™¨ è¿­ä»£å™¨æ˜¯ ECMASCript 6 çš„å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤ä½ ä¸å†éœ€è¦ä¸ºè®¸å¤šå†…ç½®ç±»å‹å»æ„å»ºè‡ªå·±çš„\nçš„è¿­ä»£å™¨ï¼Œå› ä¸ºä»ç°åœ¨å¼€å§‹ä»–ä»¬è‡ªå·±å†…éƒ¨å°±å·²ç»åŒ…å«äº†ä¸€ä¸ªé»˜è®¤çš„è¿­ä»£å™¨ã€‚\né›†åˆè¿­ä»£å™¨(for-of) ä» ECMAScript 6 å¼€å§‹æœ‰ä¸‰ç§ç±»å‹çš„é›†åˆå¯¹è±¡ï¼š arrays, maps å’Œ setsã€‚å¹¶ä¸”ä»–ä»¬éƒ½æœ‰å†…\nç½®çš„è¿­ä»£å™¨å¸®åŠ©æˆ‘ä»¬éå†æ“ä½œå†…ä¸­çš„å…ƒç´ ã€‚\n entries() è¿”å›ä¸€ä¸ªè¿­ä»£å™¨çš„ key-value é”®å€¼å¯¹ values() è¿”å›ä¸€ä¸ªè¿­ä»£å™¨çš„æ‰€æœ‰å€¼çš„é›†åˆ keys() è¿”å›ä¸€ä¸ªè¿­ä»£å™¨æ‰€æœ‰é”®çš„é›†åˆ  entries() è¿­ä»£å™¨:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let colors = [\u0026#39;red\u0026#39;, \u0026#39;green\u0026#39;, \u0026#39;blue\u0026#39;]; let tracking = new Set([123, 456, 789]); let data = new Map(); data.set(\u0026#39;title\u0026#39;, \u0026#39;xxx\u0026#39;); data.set(\u0026#39;format\u0026#39;, \u0026#39;yyy\u0026#39;); console.log(\u0026#39;------ array.entries() ---------\u0026#39;) for (let entry of colors.entries()) { console.log(entry) } console.log(\u0026#39;------ set.entries() ---------\u0026#39;) for (let entry of tracking.entries()) { console.log(entry) } console.log(\u0026#39;------ map.entries() ---------\u0026#39;) for (let entry of data.entries()) { console.log(entry) }   +RESULTS:\n------ array.entries() --------- [ 0, 'red' ] [ 1, 'green' ] [ 2, 'blue' ] ------ set.entries() --------- [ 123, 123 ] [ 456, 456 ] [ 789, 789 ] ------ map.entries() --------- [ 'title', 'xxx' ] [ 'format', 'yyy' ]   æ•°ç»„ key - keyï¼Œ value - value set key - value, value - value map key - key, value - value  é€šè¿‡ entries() è·å–åˆ°çš„ array, set, map è¿­ä»£å™¨ï¼š\nvalues() è¿­ä»£å™¨:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  let colors = [\u0026#39;red\u0026#39;, \u0026#39;green\u0026#39;, \u0026#39;blue\u0026#39;]; let tracking = new Set([123, 456, 789]); let data = new Map(); data.set(\u0026#39;title\u0026#39;, \u0026#39;xxx\u0026#39;); data.set(\u0026#39;format\u0026#39;, \u0026#39;yyy\u0026#39;); console.log(\u0026#39;------ array.values() ---------\u0026#39;) for (let value of colors.values()) { console.log(value) } console.log(\u0026#39;------ set.entries() ---------\u0026#39;) for (let value of tracking.values()) { console.log(value) } console.log(\u0026#39;------ map.entries() ---------\u0026#39;) for (let value of data.values()) { console.log(value) }   +RESULTS:\n------ array.values() --------- red green blue ------ set.entries() --------- 123 456 789 ------ map.entries() --------- xxx yyy  keys() è¿­ä»£å™¨:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  let colors = [\u0026#39;red\u0026#39;, \u0026#39;green\u0026#39;, \u0026#39;blue\u0026#39;]; colors.name = \u0026#39;colors\u0026#39;; let tracking = new Set([123, 456, 789]); let data = new Map(); data.set(\u0026#39;title\u0026#39;, \u0026#39;xxx\u0026#39;); data.set(\u0026#39;format\u0026#39;, \u0026#39;yyy\u0026#39;); console.log(\u0026#39;------ array.keys() ---------\u0026#39;) for (let key of colors.keys()) { console.log(key) } console.log(\u0026#39;------ set.entries() ---------\u0026#39;) for (let key of tracking.keys()) { console.log(key) } console.log(\u0026#39;------ map.entries() ---------\u0026#39;) for (let key of data.keys()) { console.log(key) }   +RESULTS:\n------ array.keys() --------- 0 1 2 ------ set.entries() --------- 123 456 789 ------ map.entries() --------- title format   å¦‚ä¸Šï¼Œæ•°ç»„ä¸­çš„ name å±æ€§å¹¶æ²¡æœ‰è¾“å‡ºï¼Œè¿™æ˜¯å› ä¸º for-of åªä¼šé’ˆå¯¹æ•°ç»„çš„æ•°å­—ç´¢å¼•å±\næ€§ï¼Œå¯¹äºéæ•°å­—çš„å±æ€§ä¼šå¿½ç•¥æ‰ï¼Œå› æ­¤å¦‚æœéœ€è¦éå†åˆ°éæ•°å­—å±æ€§å°±éœ€è¦ç”¨åˆ° for-in å»\néå†ã€‚\n for-in æ˜¯æ ¹æ®è¯¥å¯¹è±¡çš„å±æ€§éå†çš„ï¼Œå®ƒä¼šå°†å¯¹è±¡ä¸­çš„æ‰€æœ‰å±æ€§éå†å‡ºæ¥ï¼š\n1 2 3 4 5 6 7  let colors = [\u0026#39;red\u0026#39;, \u0026#39;green\u0026#39;, \u0026#39;blue\u0026#39;]; colors.name = \u0026#39;colors\u0026#39;; for (let key in colors) { console.log(key) }   +RESULTS:\n0 1 2 name  é›†åˆç±»å‹é»˜è®¤è¿­ä»£å™¨ :\nä¸Šé¢æ‰€æœ‰ä½¿ç”¨åˆ° for-of åŠ ä¸Š entries(), values(), keys(), çš„æƒ…å†µéƒ½å¯ä»¥ä½¿ç”¨\né»˜è®¤çš„è¿­ä»£å™¨æ¥æ›¿ä»£ï¼Œå…¶å®è¿™äº›è¿­ä»£å™¨æ–¹æ³•æœ€ç»ˆå–å¾—ä¹Ÿæ˜¯é›†åˆçš„é»˜è®¤è¿­ä»£å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  let colors = [\u0026#39;red\u0026#39;, \u0026#39;green\u0026#39;, \u0026#39;blue\u0026#39;]; colors.name = \u0026#39;colors\u0026#39;; let tracking = new Set([123, 456, 789]); let data = new Map(); data.set(\u0026#39;title\u0026#39;, \u0026#39;xxx\u0026#39;); data.set(\u0026#39;format\u0026#39;, \u0026#39;yyy\u0026#39;); console.log(\u0026#39;------ array ---------\u0026#39;) for (let value of colors) { // ç›¸å½“äºä½¿ç”¨äº† colors.values()  console.log(value) } console.log(\u0026#39;------ set ---------\u0026#39;) for (let value of tracking) { // ç›¸å½“äºä½¿ç”¨äº† tracking.values()  console.log(value) } console.log(\u0026#39;------ map ---------\u0026#39;) for (let entry of data) { // ç›¸å½“äº data.entries()  console.log(entry) }   +RESULTS:\n------ array --------- red green blue ------ set --------- 123 456 789 ------ map --------- [ 'title', 'xxx' ] [ 'format', 'yyy' ]  for-of å¾ªç¯çš„è§£æ„ åœ¨é›†åˆç±»å‹é»˜è®¤è¿­ä»£å™¨9.4.1ä¸­æˆ‘ä»¬è®²äº†ï¼Œåœ¨å¯¹ arrays, sets,\nmaps ä½¿ç”¨ for-in çš„æ—¶å€™ï¼Œå…¶å®éƒ½æ˜¯åˆ†åˆ«ä½¿ç”¨äº†ä»–ä»¬çš„é»˜è®¤è¿­ä»£å™¨(arrays.values(),\nsets.values(), maps.entries()) ã€‚\né‚£é’ˆå¯¹ maps å…¶å†…éƒ¨ç”¨åˆ°çš„æ˜¯ entries() è¿­ä»£å™¨ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ï¼š [key, value] ç±»\nå‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å†å¾ªç¯ä½“å†…ä½¿ç”¨ï¼Œå¯ä»¥ç»“åˆ ECMAScript 6 çš„è§£æ„åŠŸèƒ½ï¼Œå¾ˆæ–¹ä¾¿çš„å»ä½¿ç”¨\nä»–ä»¬ï¼š\n1 2 3 4 5 6 7 8 9 10  let data = new Map([ [\u0026#39;title\u0026#39;, \u0026#39;xxxx\u0026#39;], [\u0026#39;format\u0026#39;, \u0026#39;yyyy\u0026#39;] ]); for (let [key, value] of data) { console.log(`${key}= ${value}`); }   +RESULTS:\ntitle = xxxx format = yyyy  å­—ç¬¦ä¸²è¿­ä»£å™¨ åœ¨æˆ‘ä»¬å­—ç¬¦ä¸²çš„ä½¿ç”¨å½“ä¸­ç»å¸¸ä¼šçœ‹åˆ° str[0] å’Œæ•°ç»„ä¸€æ ·é€šè¿‡ä¸‹æ ‡æ–¹å¼å»è®¿é—®å­—ç¬¦ä¸²ä¸­çš„\nå­—ç¬¦ã€‚\nä½†æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼šå­—ç¬¦ä¸²ä¸­æ‹¬å·ç´¢å¼•æ–¹å¼çš„è®¿é—®ä¸æ˜¯åŸºäºå­—ç¬¦çš„è€Œæ˜¯åŸºäºç¼–ç å•å…ƒçš„\n(å³å•ä¸ªå­—èŠ‚çš„)ã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5  var message = \u0026#34;A Ã° Â®Â· B\u0026#34;; for (let i=0; i \u0026lt; message.length; i++) { console.log(message[i]); }   ECMAScript 6 ä¹‹å‰çš„è¾“å‡ºç»“æœï¼š\nA (blank) (blank) (blank) (blank) B  ECMAScript 6 ä¹‹åçš„è¾“å‡ºç»“æœï¼š\n+RESULTS:\nA Ã° Â® Â· B  ECMASCript 6 ä¹‹åèƒ½æ­£ç¡®è¾“å‡ºæ˜¯å› ä¸ºï¼Œåœ¨å­—ç¬¦ä¸²ä¸€ç« 3.1æ–°å¢çš„ 16 å­—èŠ‚çš„ç¼–ç æ”¯\næŒï¼Œä¸”å­—ç¬¦ä¸²çš„é»˜è®¤è¿­ä»£å™¨æ˜¯åŸºäºå­—ç¬¦è€Œä¸æ˜¯ç¼–ç å­—èŠ‚å»éå†çš„ï¼Œæ‰€ä»¥é€šè¿‡ for å¯ä»¥å¾—\nåˆ°æ­£ç¡®çš„ç»“æœã€‚\nåŒæ ·ï¼ŒES6 çš„ for-of ä¹Ÿä¸€æ ·èƒ½è·å¾—æ­£ç¡®ç»“æœï¼š\n1 2 3 4 5  var message = \u0026#34;A Ã° Â®Â· B\u0026#34;; for (let c of message) { console.log(c) }   +RESULTS:\nA Ã° Â® Â· B  NodeList è¿­ä»£å™¨(DOMå…ƒç´ åˆ—è¡¨è¿­ä»£å™¨) 1 2 3 4 5  var divs = document.getElementsByTagName(\u0026#34;div\u0026#34;); for (let div of divs) { console.log(div.id); }   æµè§ˆå™¨å®ä¾‹ï¼š\nå±•å¼€ç¬¦(â€¦)å’Œéæ•°ç»„ç±»å¯è¿­ä»£å¯¹è±¡ å±•å¼€ç¬¦å°†é›†åˆè½¬æˆæ•°ç»„ï¼š\n1 2 3  let set = new Set([1, 2, 3]); let array = [...set]; console.log(array)   å°† maps è½¬æˆæ•°ç»„ï¼š\n1 2 3 4 5 6 7  let map = new Map([ [\u0026#39;name\u0026#39;, \u0026#39;xxx\u0026#39;], [\u0026#39;age\u0026#39;, 100] ]) let array = [...map]; console.log(JSON.stringify(array))   +RESULTS:\n[[\u0026quot;name\u0026quot; (\\, \u0026quot;xxx\u0026quot;)] (\\, [\u0026quot;age\u0026quot; (\\, 100)])]  æ•°ç»„çš„åˆå¹¶:\n1 2 3 4 5  let nums = [1, 2, 3]; let moreNums = [0, ...nums, ...[4, 5, 6]] console.log(moreNums.toString())   +RESULTS:\n0,1,2,3,4,5,6  NodeList9.4.4ä¸€èŠ‚ä¸­æåˆ°è¿‡åœ¨æ–°çš„ HTML æ ‡å‡†ä¸­ NodeList ä¹Ÿæœ‰è‡ªå·±çš„é»˜è®¤è¿­ä»£å™¨ï¼Œ\nå› æ­¤å±•å¼€ç¬¦ä¹Ÿå¯¹ NodeList æœ‰æ•ˆã€‚\nå¦‚å›¾ç¤ºä¾‹ï¼š(æµè§ˆå™¨ç¯å¢ƒ)\né«˜çº§è¿­ä»£å™¨åŠŸèƒ½ ä¹‹å‰çš„ç« èŠ‚è®²è¿°äº†ä½¿ç”¨è¿­ä»£å™¨å’Œç”Ÿæˆå™¨å¦‚ä½•å»å®ç°ä¸€äº›åŸºæœ¬çš„åŠŸèƒ½ï¼Œè¿™ä¸€ç« èŠ‚å°†è®²è¿°å¦‚ä½•å»\nä½¿ç”¨è¿­ä»£å™¨å’Œç”Ÿæˆå»å»å®ç°ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚\nç»™è¿­ä»£å™¨ä¼ é€’å‚æ•° ä¹‹å‰ä½¿ç”¨è¿­ä»£å™¨ï¼Œä½¿ç”¨ iterator.next() éƒ½æ˜¯æ²¡æœ‰ä¼ é€’å‚æ•°çš„ï¼Œå…¶å®å®ƒæ˜¯å¯ä»¥ä¼ é€’å‚æ•°\nçš„ï¼Œå…¶å®å°±è·Ÿæ™®é€šçš„å‡½æ•°å‚æ•°ä¼ é€’æ˜¯ä¸€æ ·çš„ã€‚\nç»“åˆç”Ÿæˆå™¨ä½¿ç”¨æ—¶å€™çš„ç‰¹æ®Šæ€§ï¼š next(v) ä¸­çš„å‚æ•° v çš„å€¼ä¼šå½“åšå½“å‰ yield çš„è¿”\nå›å€¼è¿”å›ï¼Œä¸ç®¡è¯¥ yield åé¢è¡¨è¾¾å¼çš„ç»“æœæ˜¯ä»€ä¹ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  function *createIterator() { let first = yield 1; // ä¸ä¼ å€¼ç†åº”æ˜¯ï¼š first + 2 =\u0026gt; 1 + 2 =\u0026gt; 3  // ä½† next(4) æœ‰å‚æ•°ï¼Œåˆ™è¯¥å‚æ•°å°±æ˜¯ yield è¡¨è¾¾å¼çš„å€¼ï¼Œå› æ­¤ç»“æœä¼šæ˜¯ï¼š 4 + 2  let second = yield first + 2; // å¦‚ä¸Šï¼Œç»“æœæ˜¯ 5 + 3 = 8  yield second + 3; } let iterator = createIterator(); console.log(iterator.next()); // { value: 1, done: false } console.log(iterator.next(4)); // { value: 6, done: false } console.log(iterator.next(5)); // { value: 8, done: false } console.log(iterator.next()); // { value: undefined, done: true }   +RESULTS:\n{ value: 1, done: false } { value: 6, done: false } { value: 8, done: false } { value: undefined, done: true }  ä¸Šé¢ä»£ç æ‰§è¡Œè¿‡ç¨‹ï¼š\nè¿­ä»£å™¨ä¸­è§¦å‘å¼‚å¸¸ ç”±äºç»™ next() ä¼ é€’çš„å‚æ•°ä¸ç®¡æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œå®ƒéƒ½ä¼šä½œä¸ºå½“å‰ yield è¡¨è¾¾å¼çš„è¿”å›å€¼\nç»™è¿”å›ã€‚\nè¿­ä»£å™¨å¯¹è±¡æœ‰ä¸€ä¸ªæ–¹æ³•ï¼š iterator.throw(Error) å¯ä»¥ç»™å½“å‰çš„ yield å¤„æŠ›å‡ºä¸€ä¸ªå¼‚\nå¸¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function * createIterator() { let first = yield 1; let second = yield first + 2; yield second + 3; } let iterator = createIterator() console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next(4)) // { value: 6, done: false } console.log(iterator.throw(new Error(\u0026#39;Boom\u0026#39;))) // å¼‚å¸¸    +RESULTS:\n: { value: 1, done: false } : { value: 6, done: false } /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI/js-script-bSJrfN:4 let second = yield first + 2; ^ Error: Boom at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI/js-script-bSJrfN:12:28 at Object.\u0026lt;anonymous\u0026gt; (/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI/js-script-bSJrfN:14:2)  ä»£ç ä¸­ï¼Œå‰é¢ä¸¤ä¸ª next() ä¼šæ­£å¸¸æ‰§è¡Œå¾—åˆ°ç»“æœï¼Œä½†å½“ throw() è°ƒç”¨çš„æ—¶å€™ï¼Œè¿­ä»£å™¨\nä¼šåœ¨æ‰§è¡Œ let second = ä¹‹å‰æŠ›å‡ºå¼‚å¸¸(yield first + 2; å·²ç»è¿”å›ç»“æœäº†)ã€‚\nå¦‚å›¾ï¼š\næ•è·å¼‚å¸¸ :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function * createIterator() { let first = yield 1; let second; try { second = yield first + 2; } catch (e) { console.log(e.message) second = 6; } yield second + 3; } let iterator = createIterator() console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next(4)) // { value: 6, done: false } console.log(iterator.throw(new Error(\u0026#39;Boom\u0026#39;))) // { value: 9, done: true }    +RESULTS:\n{ value: 1, done: false } { value: 6, done: false } Boom { value: 9, done: false }  ä»ç»“æœä¼šæƒŠå¥‡çš„å‘ç°ï¼Œè°ƒç”¨ throw() ä¹‹åï¼Œè¿”å›äº†ä¸‹ä¸€ä¸ª yield çš„æ‰§è¡Œç»“æœã€‚\nåŸå› ï¼š iterator.throw() è°ƒç”¨ä¹‹åï¼Œç”Ÿæˆå™¨å°†è¿™ä¸ªå¼‚å¸¸æ•è·åˆ°äº†ï¼Œå¹¶ä¸”ç»§ç»­å¾€ä¸‹æ‰§è¡Œäº†ï¼Œ\nä»è§¦å‘äº†ä¸‹ä¸€ä¸ª yield çš„æ‰§è¡Œã€‚\n next() å’Œ throw() éƒ½å¯ä»¥è®©ç”Ÿæˆå™¨ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œåªä¸è¿‡æ‰§è¡Œæ–¹å¼ä¸ä¸€æ ·ï¼Œå‰è€…ä¼šä»\nä¸‹ä¸€ä¸ª yield ä½ç½®æ‰§è¡Œè¿”å›ç»“æœï¼Œåè€…æ˜¯åœ¨ä¸Šä¸€ä¸ª yield æ‰§è¡Œä¹‹åçš„ä½ç½®è§¦å‘ä¸€ä¸ªå¼‚\nå¸¸ï¼Œå¦‚æœè¿™ä¸ªå¼‚å¸¸è¢«æ•è·å°±ç»§ç»­å¾€ä¸‹æ‰§è¡Œå¼‚å¸¸å¤„ç†åŠåé¢çš„ä»£ç ï¼Œå¦‚æœæ²¡æœ‰è¢«æ•è·å°±æŠ›å‡ºä¸€\nä¸ªå¼‚å¸¸ä¸­æ–­æ•´ä¸ªç”Ÿæˆå™¨çš„æ‰§è¡Œã€‚\n ç”Ÿæˆå™¨å‡½æ•°ä¸­ä½¿ç”¨ return è¯­å¥ åœ¨ç”Ÿæˆå™¨ä¸­çš„ return è¯­å¥è¡¨ç¤ºè¯¥è¿­ä»£å™¨ç»“æŸäº†ï¼Œåé¢ä¸ä¼šå†æœ‰å€¼è¿‡æ¥äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11  function *createIterator() { yield 1; return; // è¿™é‡Œç»“æŸè¿­ä»£å™¨  yield 2; // ä¸ä¼šæ‰§è¡Œ  yield 3; // ä¸ä¼šæ‰§è¡Œ } let iterator = createIterator() console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next()) // { value: undefined, done: true }   +RESULTS:\n{ value: 1, done: false } { value: undefined, done: true }  å› æ­¤ return è¯­å¥åœ¨ç”Ÿæˆå™¨ä¸­çš„æ•ˆæœå°±æ˜¯ç»ˆç»“è¿­ä»£å™¨ï¼Œåœ¨å®ƒåé¢çš„ yield éƒ½æ— æ•ˆï¼Œ\nè¿˜å¯ä»¥ return ä¸€ä¸ªå€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  function *createIterator() { yield 1; return 42; // è¿™é‡Œç»“æŸè¿­ä»£å™¨  yield 2; // ä¸ä¼šæ‰§è¡Œ  yield 3; // ä¸ä¼šæ‰§è¡Œ } let iterator = createIterator() console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next()) // { value: 42, done: true } console.log(iterator.next()) // { value: undefined, done: true }    +RESULTS:\n{ value: 1, done: false } { value: 42, done: true } { value: undefined, done: true }  è¿™é‡Œæœ‰ç‚¹ç‰¹æ®Šï¼Œä¹‹å‰è¿­ä»£å™¨ç»“æŸäº†ï¼Œæœ€åä¸€ä¸ª done: true çš„å€¼æ˜¯ undefined è¿™é‡Œä½¿\nç”¨ return è¿”å›äº†ä¸€ä¸ªå€¼ä¼šå½“åšè¿­ä»£å™¨ç»“æŸä¹‹è¿”å›ã€‚\n åœ¨ä½¿ç”¨å±•å¼€ç¬¦å’Œ for-of æ—¶å€™å¦‚æœæœ‰ return è¯­å¥ï¼Œè¯¥è¯­å¥ä¸­çš„ value ä¼šè¢«å¿½ç•¥æ‰ï¼Œå› \nä¸ºå®ƒä¸€æ—¦å‘ç°äº† done: true å°±ä¼šç»“æŸã€‚\n å§”æ‰˜ç”Ÿæˆå™¨(Delegating Generators) åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå°†ä¸¤ä¸ªè¿­ä»£å™¨çš„å€¼ç»“åˆæˆä¸€ä¸ªé€šå¸¸ä¼šå¾ˆæœ‰ç”¨ã€‚ç”Ÿæˆå™¨å¯ä»¥é€šè¿‡ yield å’Œ\n* ä¸€èµ·ä½¿ç”¨æ¥å®ç°ä»£ç†åˆ°å…¶ä»–è¿­ä»£å™¨ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  function *createNumIterator() { yield 1; yield 2; } function *createColorIterator() { yield \u0026#39;red\u0026#39;; yield \u0026#39;blue\u0026#39;; } function *createCombineIterator() { yield *createNumIterator(); yield *createColorIterator(); yield true; } var iterator = createCombineIterator(); console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next()) // { value: 2, done: false } console.log(iterator.next()) // { value: \u0026#39;red\u0026#39;, done: false } console.log(iterator.next()) // { value: \u0026#39;blue\u0026#39;, done: false } console.log(iterator.next()) // { value: true, done: false } console.log(iterator.next()) // { value: undefined, done: true }   +RESULTS:\n{ value: 1, done: false } { value: 2, done: false } { value: 'red', done: false } { value: 'blue', done: false } { value: true, done: false } { value: undefined, done: true }  ç»“åˆ return ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šè¿­ä»£å™¨ B ä¾èµ–è¿­ä»£å™¨ A çš„è¿”å›ç»“æœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  function *createNumIterator() { yield 1; yield 2; return 3; // #1 } function *createRepeatingIterator(count) { for (let i = 0; i \u0026lt; count; i++) { yield \u0026#39;repeat\u0026#39;; } } function *createCombinedIterator() { // #2  let result = yield *createNumIterator(); // #2.1  yield result; // #3  // è¿™é‡Œå¾—åˆ° createNumIterator ä¸­ return 3 è¿”å›çš„ç»“æœ 3  yield *createRepeatingIterator(result); } let iterator = createCombinedIterator(); console.log(iterator.next()) // { value: 1, done: false } console.log(iterator.next()) // { value: 2, done: false } console.log(iterator.next()) // { value: 3, done: false } console.log(iterator.next()) // { value: \u0026#39;repeat\u0026#39;, done: false } console.log(iterator.next()) // { value: \u0026#39;repeat\u0026#39;, done: false } console.log(iterator.next()) // { value: \u0026#39;repeat\u0026#39;, done: false } console.log(iterator.next()) // { value: undefined, done: true }   +RESULTS: å¢åŠ  #2.1 å°† #2 ç»“æœè¾“å‡ºåï¼š\n{ value: 1, done: false } { value: 2, done: false } { value: 3, done: false } { value: 'repeat', done: false } { value: 'repeat', done: false } { value: 'repeat', done: false } { value: undefined, done: true }  +RESULTS: æœ‰ return 3; çš„è¿”å›ç»“æœ\n{ value: 1, done: false } { value: 2, done: false } { value: 'repeat', done: false } { value: 'repeat', done: false } { value: 'repeat', done: false } { value: undefined, done: true }  +RESULTS: æ²¡æœ‰ return 3; çš„è¿”å›ç»“æœ\n{ value: 1, done: false } { value: 2, done: false } { value: undefined, done: true } { value: undefined, done: true } { value: undefined, done: true } { value: undefined, done: true }  å› ä¸ºå¦‚æœæ²¡æœ‰ return 3; é‚£ä¹ˆæœ€å #2 å¤„çš„çš„ yield è¿”å›ç»“æœä¼šæ˜¯\ncreateNumiterator() æ‰§è¡Œåè¿”å›çš„ç»“æœ undefined\nå¦‚æœæœ‰ return 3; #2 å¤„çš„å‡½æ•°åˆè‡ªå·±çš„è¿”å›å€¼ï¼Œä½œä¸º #2 å¤„ yield ä»£ç†å®Œæˆçš„\nç»“æœä¿å­˜åˆ°äº† result ä¸­ï¼Œä¸‹ä¸€æ¬¡ next() ä¼šæ‰§è¡Œ #3 å¤„çš„ yield è¿›å…¥ä¸‹ä¸€ä¸ªä»£\nç†è¿­ä»£å™¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  function *createIterator() { yield * \u0026#39;hello\u0026#39;; } let it = createIterator() console.log(it.next()) // { value: \u0026#39;h\u0026#39;, done: false } console.log(it.next()) // { value: \u0026#39;e\u0026#39;, done: false } console.log(it.next()) // { value: \u0026#39;l\u0026#39;, done: false } console.log(it.next()) // { value: \u0026#39;l\u0026#39;, done: false } console.log(it.next()) // { value: \u0026#39;o\u0026#39;, done: false } console.log(it.next()) // { value: undefined, done: true }   +RESULTS: å› ä¸ºå­—ç¬¦ä¸²æœ¬èº«æœ‰è‡ªå·±çš„é»˜è®¤è¿­ä»£å™¨ï¼Œå› æ­¤ yield * 'hello'; ç»“æœä¼šå»è°ƒç”¨\né»˜è®¤è¿­ä»£å™¨å¯¹æ¯ä¸ªå­—ç¬¦è¿›è¡Œè¿­ä»£ã€‚\n{ value: 'h', done: false } { value: 'e', done: false } { value: 'l', done: false } { value: 'l', done: false } { value: 'o', done: false } { value: undefined, done: true }  å¼‚æ­¥è¿­ä»£å™¨ for-await-of2019 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  const promise = (timeout) =\u0026gt; new Promise((resolve, reject) =\u0026gt; { setTimeout(() =\u0026gt; { resolve() }, timeout * 1000) }) function delay(time) { setTimeout(() =\u0026gt; { console.log(time) }, time * 1000) } async function test() { for await (const x of [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;]) { console.log(x) } }   å¼‚æ­¥ä»»åŠ¡ ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨ç”Ÿæˆå™¨å’Œè¿­ä»£å™¨æœ€å¸¸ç”¨ï¼Œä¹Ÿç”¨èµ·æ¥æœ€çˆ½çš„ä¼°è®¡å°±æ˜¯å¼‚æ­¥ä»»åŠ¡äº†å§!!!\næ¯”å¦‚ï¼šå¼‚æ­¥è¯»å–ä¸€ä¸ªæ–‡ä»¶\n1 2 3 4 5 6 7 8 9  let fs = require(\u0026#39;fs\u0026#39;) console.log(__dirname); fs.readFile(__dirname + \u0026#39;/config.json\u0026#39;, (err, cnt) =\u0026gt; { if (err) throw err; console.log(cnt); console.log(\u0026#39;Done\u0026#39;); })   +RESULTS: é€šè¿‡å¼‚æ­¥æ¥å£å–æ–‡ä»¶å†…å®¹\n/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI \u0026lt;Buffer 7b 20 22 6e 61 6d 65 22 3a 20 22 78 78 78 22 20 7d 0a\u0026gt; Done  æ¥ä¸‹æ¥æˆ‘ä»¬å°†è®²è¿°å¦‚ä½•ä½¿ç”¨ generator æ¥å®ç°å¼‚æ­¥ä»»åŠ¡ã€‚\nä¸€ä¸ªç®€å•çš„ä»»åŠ¡æ‰§è¡Œå™¨ è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå™¨çš„ä½œç”¨å°±æ˜¯ï¼š\n å¯åŠ¨è¿­ä»£å™¨ å¾ªç¯è°ƒç”¨ next() çŸ¥é“ç»“æŸ  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  function run(taskDef) { // åˆ›å»ºè¿­ä»£å™¨ï¼Œé¦–å…ˆç¡®ä¿ taskDef æ˜¯ä¸€ä¸ª generator å‡½æ•°  let task = taskDef(); // å¯åŠ¨è¿­ä»£å™¨  let result = task.next(); const step = () =\u0026gt; { if (!result.done) { // #1  // result = task.next();  // #2 å°†ä¸Šä¸€ä¸ª yield çš„ç»“æœä½œä¸ºä¸‹ä¸€ä¸ª yield çš„è¿”å›å€¼  result = task.next(result.value); step() } } // å¯åŠ¨å¾ªç¯é€’å½’ï¼ŒçŸ¥é“è¿­ä»£å™¨ç»“æŸ  step(); } // ä½¿ç”¨  function *log() { console.log(\u0026#39;------- log --------\u0026#39;) console.log(1); yield; console.log(2); yield; console.log(3); } function *logVal() { console.log(\u0026#39;------- logVal --------\u0026#39;) let val = yield 1; console.log(val); // 1  val = yield val + 3; console.log(val) // 3 } run(log) run(logVal)   +RESULTS: #2 æ‰§è¡Œç»“æœ\n------- log -------- 1 2 3 ------- logVal -------- 1 4 undefined  +RESULTS: #1 çš„æ‰§è¡Œç»“æœ\n------- log -------- 1 2 3  é€šè¿‡ #2 çš„æ”¹é€ ï¼Œè®©æ¯æ¬¡ yield çš„è¡¨è¾¾å¼å€¼ä¾èµ–ä¸Šä¸€æ¬¡ next() çš„ç»“æœå€¼ã€‚\nå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨ æˆ‘ä»¬å¯ä»¥å°†ä¸Šä¸€å±Š9.8.1ä¸­çš„ run è¿›è¡Œæ”¹é€ è®©å…¶æ”¯æŒå¼‚æ­¥ä»»åŠ¡:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  function run(taskDef) { let task = taskDef() let result = task.next() function step() { if (!result.done) { if (typeof result.value === \u0026#39;function\u0026#39;) { // å¦‚æœ yield è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æ‰§è¡Œè¿™ä¸ªå‡½æ•°(å¼‚æ­¥ä»»åŠ¡)  // ç»“æŸä¹‹åï¼Œè¿›è¡Œä¸‹ä¸€æ¬¡ next() -\u0026gt; yield  result.value(function(err, data) { if (err) { result = task.throw(err) return; } result = task.next(data) step(); }) } else { result = task.next(result.value); step(); } } } step(); } let fs = require(\u0026#39;fs\u0026#39;) function readFile(filename) { return function(callback) { setTimeout(() =\u0026gt; { fs.readFile(__dirname + filename, callback) }, 1000) } } run(function *() { let result = yield readFile(\u0026#39;/config.json\u0026#39;) console.log(result) console.log(\u0026#39;Done\u0026#39;) })   +RESULTS:\n\u0026lt;Buffer 7b 20 22 6e 61 6d 65 22 3a 20 22 78 78 78 22 20 7d 0a\u0026gt; Done  Generator å†…éƒ¨æŠ½è±¡æ“ä½œ(ä¼ªç ) å°ç»“  Symbol.iterator ç”¨æ¥å®šä¹‰å¯¹è±¡çš„é»˜è®¤è¿­ä»£å™¨ for-of å¯ä»¥ç”¨æ¥éå†å¯è¿­ä»£çš„å¯¹è±¡ï¼Œå³åŒ…å« Symbol.iterator å‡½æ•°çš„å¯¹è±¡  entries() è¿­ä»£å™¨ï¼Œå– [key, value] é”®å€¼å¯¹ï¼Œå¦‚ for-of-map é»˜è®¤å°±æ˜¯ç”¨çš„\nè¿™ä¸ªè¿­ä»£å™¨ values() è¿­ä»£å™¨ï¼Œå– value å€¼ï¼Œå¦‚æœæ˜¯æ•°ç»„ for-of-array åªä¼šå»ç´¢å¼•ä¸ºæ•°\nå€¼çš„å…ƒç´ ï¼Œå¿½ç•¥éæ•°å€¼ç´¢å¼•çš„å…ƒç´ ï¼Œæ¯”å¦‚ï¼š arr.name = 'xxx' è¿™ä¸ª name æ˜¯ä¸\nä¼šè¢«éå†åˆ°çš„(é»˜è®¤ç”¨ values() è¿­ä»£å™¨çš„æœ‰ï¼š arrays å’Œ sets)ã€‚   ... å±•å¼€ç¬¦å…¶å®å†…éƒ¨å®ç°ä¹Ÿæ˜¯å»è°ƒç”¨äº†å¯¹è±¡å†…éƒ¨çš„ Symbol.iterator ã€‚ Generator è°ƒç”¨ä¼šç”Ÿæˆä¸€ä¸ªè¿­ä»£å™¨ï¼Œé€šè¿‡ it.next() è§¦å‘ yield è¯­å¥æ‰§è¡Œå¹¶å¾—åˆ°\nç»“æœ  å¤šä¸ª generator çš„åµŒå¥—è°ƒç”¨å¯å®ç°äº’ç›¸ä¹‹é—´çš„ä»£ç†(å†…éƒ¨ä½¿ç”¨ yield *generatorFn() è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°) generator å†…éƒ¨ä½¿ç”¨ return 42; ç»ˆæ­¢è¿­ä»£å¹¶è¿”å› { value: 42, done: true}\nï¼Œè¿”å›å€¼ç”± return è¿”å›å€¼å†³å®šï¼Œä½†è¯¥å€¼ä¸ä¼šè¢« for-of éå†åˆ°ï¼Œå› ä¸º for-of\næ£€æµ‹åˆ° done: true äº†å°±å³åˆ»ç»“æŸã€‚ å¯ä»¥é€šè¿‡ return ç‰¹æ€§çµæ´»è¿ç”¨ generator ä»£ç†ã€‚ ç”±äºå­—ç¬¦ä¸²æœ¬èº«æ˜¯æœ‰è¿­ä»£å™¨çš„ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ï¼š yield * 'hello'; ä½¿ç”¨ã€‚ generator + iterator å®ç°åŒæ­¥ä»»åŠ¡ runner ã€‚ generator + iterator + callback å®ç°å¼‚æ­¥ä»»åŠ¡ runnerã€‚    ç±»(Classes) ç±»å£°æ˜ åŸºæœ¬ç±»å£°æ˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  class PersonClass { constructor(name) { this.name = name } sayName() { console.log(this.name) } } let person = new PersonClass(\u0026#39;xxx\u0026#39;); person.sayName(); // xxx  console.log(person instanceof PersonClass) // true console.log(person instanceof Object) // true  console.log(typeof PersonClass); // function console.log(typeof PersonClass.prototype.sayName); // function   å®é™…ä¸Š class å£°æ˜åªæ˜¯ä¸ªè¯­æ³•ç³–è€Œå·²ï¼Œå®ƒæœ€ç»ˆäº§ç”Ÿçš„ PersonClass ä¾æ—§æ˜¯ä¸ªå‡½æ•°ï¼Œä¸”è¿™\nä¸ªå‡½æ•°è¡Œä¸ºå’Œ constructor ä¸€è‡´ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢ typeof PersonClass è¾“å‡ºç»“æœ\næ˜¯ \u0026lsquo;function\u0026rsquo; ã€‚\nç»è¿‡ babel è½¬æ¢ä¹‹åçš„ä»£ç ï¼š\n\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  function _defineProperties(target, props) { for (var i = 0; i \u0026lt; props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\u0026#34;value\u0026#34; in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; } function () { function PersonClass(name) { _classCallCheck(this, PersonClass); this.name = name; } _createClass(PersonClass, [{ key: \u0026#34;sayName\u0026#34;, value: function sayName() { console.log(this.name); } }]); return PersonClass; }(); var person = new PersonClass(\u0026#39;xxx\u0026#39;); person.sayName(); // xxx  console.log(_instanceof(person, PersonClass)); // true console.log(_instanceof(person, Object)); // true console.log(_typeof(PersonClass)); // function console.log(_typeof(PersonClass.prototype.sayName)); // function   éœ€è¦å…³æ³¨çš„ç‚¹ï¼š\n  constructor ä¸­çš„ this.name ä¾æ—§æ˜¯åœ¨ PersonClass è¿™é€‚ç”¨äºå‡½æ•°çš„ new ç‰¹æ€§\næœ€ç»ˆ name ä¼šè¢«ç»‘å®šåˆ° new PersonClass() ä¹‹åçš„å®ä¾‹ä¸Šã€‚\n  sayName() ç±»ä¸­çš„æ–¹æ³•éƒ½ä¼šè¢«ç»‘å®šåˆ° PersonClass() çš„åŸå‹ä¸Šã€‚\nå¦‚ï¼š _createClass é‡Œé¢çš„ protoProps ã€‚\n  é™æ€å±æ€§ä¼šè¢«ç»‘å®šåˆ°å‡½æ•°å(å³ç±»åï¼Œæ„é€ å‡½æ•°ä¸Š)\nå¦‚ï¼š _createClass é‡Œé¢çš„ staticProps ã€‚\n  æœ€åå°†å‡½æ•° PersonClass è¿”å›ã€‚\n  ç±»è¯­æ³•çš„å¥½å¤„ ç±»å’Œå…¶ä»–ç±»å‹ä¹‹é—´ï¼Œæœ‰å¾ˆå¤šé‡è¦çš„åŒºåˆ«ï¼š\n  ç±»å£°æ˜ä¸ä¼šè¢«æå‡(hoisted)ï¼Œå’Œ let å£°æ˜æ€§è´¨ä¸€æ ·ï¼Œä¹Ÿå­˜åœ¨ TDZ é—®é¢˜ã€‚\n  æ‰€æœ‰åœ¨ç±»å£°æ˜é‡Œé¢çš„ä»£ç é»˜è®¤å¯ç”¨ strict mode ï¼Œå¹¶ä¸”æ— æ³•æ”¹å˜ã€‚\n  æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ä¸å¯æšä¸¾çš„ï¼Œ babel è½¬æ¢ä¹‹å enumerable é»˜è®¤å€¼å°±æ˜¯ false\nå¦‚ä¸Šä¸€èŠ‚ babel è½¬æ¢ä¹‹åçš„ä»£ç  10.1.1 ã€‚\n  æ‰€æœ‰çš„æ–¹æ³•éƒ½æ²¡æœ‰ [ [Constructor]] å†…éƒ¨å±æ€§ï¼Œå› æ­¤ä¸èƒ½ new ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\n  ä¸èƒ½ç›´æ¥è°ƒç”¨ç±»çš„æ„é€ å‡½æ•°ã€‚\n  åœ¨ç±»æ–¹æ³•é‡Œé¢è¯•å›¾é‡å†™ç±»åå°†æŠ›å‡ºå¼‚å¸¸ã€‚\n  æ ¹æ®ä¸Šé¢ 6 ä¸ªé‡è¦å·®å¼‚ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰‹åŠ¨å»æ¨¡æ‹Ÿä¸€ä¸ªç±»äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  // 1. let å£°æ˜ï¼Œä¸å­˜åœ¨æå‡ï¼ŒTDZ let PersonType = (function() { // 2. å¿…é¡»æ˜¯ä¸¥æ ¼æ¨¡å¼  \u0026#39;use strict\u0026#39;; // 6. å› ä¸ºæ˜¯ç”¨ const å£°æ˜çš„ç±»åï¼Œå› æ­¤åœ¨ç±»å†…éƒ¨ä¸èƒ½å¯¹ç±»åé‡æ–°èµ‹å€¼  const PersonType = function(name) { // 5. ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå¿…é¡»ä½¿ç”¨ new  // è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªæ–°çš„å±æ€§ï¼Œ new.target ï¼Œåªèƒ½åœ¨éç®­å¤´å‡½æ•°  // å†…éƒ¨ä½¿ç”¨ï¼Œè¡¨ç¤ºï¼š  // å¦‚æœæ˜¯é€šè¿‡ new è°ƒç”¨çš„ new.target å°±æ˜¯ PersonType è‡ªèº«  // å¦‚æœä¸æ˜¯é€šè¿‡ new è°ƒç”¨çš„ new.target å°±æ˜¯ undefined  // è¿™ä¹Ÿå°±å¾ˆå¥½çš„åŒºåˆ†äº†ä¸€ä¸ªå‡½æ•°æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼è°ƒç”¨çš„  if (typeof new.target === \u0026#39;undefined\u0026#39;) { throw new Error(\u0026#39;ç±»åå¿…é¡»é€šè¿‡ new è°ƒç”¨ã€‚\u0026#39;) } // ç±»å®ä¾‹å±æ€§  this.name = name } // æ‰€æœ‰æ–¹æ³•éƒ½æŒ‚åœ¨åŸå‹ä¸Š  Object.defineProperty(PersonType.prototype, \u0026#39;sayName\u0026#39;, { value: function() { // 4. å‰é¢è¯´è¿‡äº† new.target ä½œç”¨  if (typeof new.target !== \u0026#39;undefined\u0026#39;) { // èƒ½è¿›è¿™é‡Œï¼Œè¡¨ç¤ºç”¨ new è°ƒç”¨äº†  throw new Error(\u0026#39;ç±»æ–¹æ³•ä¸èƒ½é€šè¿‡ new è°ƒç”¨\u0026#39;); } console.log(this.name) }, // 3. æ‰€æœ‰æ–¹æ³•éƒ½ä¸èƒ½æšä¸¾  enumerable: false, writable: true, configurable: true }) return PersonType; }())   å¦‚ä¸Šä¾‹ï¼Œç±»å†…éƒ¨æ˜¯ä¸èƒ½å¯¹ PersonType é‡æ–°å¤åˆ¶çš„ï¼Œå› ä¸ºå®ƒæ˜¯ç”¨ const æ–¹å¼å£°æ˜çš„ï¼Œ\nä½†æ˜¯åœ¨å¤–éƒ¨æ˜¯å¯ä»¥é‡å†™çš„ï¼Œå› ä¸ºå¤–éƒ¨æ˜¯ç”¨çš„ let å£°æ˜çš„ã€‚\nå› æ­¤ï¼š\n1 2 3 4 5 6 7  class Foo { constructor() { Foo = \u0026#39;bar\u0026#39;; // é”™è¯¯ï¼Œéæ³•  } } Foo = \u0026#39;bar\u0026#39;; // OK   ç±»è¡¨è¾¾å¼ ç±»ä¹Ÿå¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼çš„æ–¹å¼å£°æ˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11  let PersonClass = class { // ç­‰ä»·äº PersonType çš„æ„é€ å‡½æ•°  constructro(name) { this.name = name } // ç­‰ä»·äº PersonType.prototype.sayName  sayName() { console.log(this.name) } }   å‘½åå¼è¡¨è¾¾å¼ï¼šè·Ÿå‘½åå¼å‡½æ•°è¡¨è¾¾å¼æ˜¯ä¸€æ ·çš„ï¼Œ class åé¢å¯ä»¥è·Ÿä¸€ä¸ªç±»åï¼š\nlet PersonClass = class PersonClass2 {...}\nä½†æ˜¯ class åé¢çš„ç±»åï¼Œåªèƒ½åœ¨ç±»çš„å†…éƒ¨ä½¿ç”¨ï¼Œåœ¨å¤–éƒ¨æ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  let PersonClass = class PersonClass2 { // ç­‰ä»·äº PersonType çš„æ„é€ å‡½æ•°  constructor(name) { this.name = name console.log(typeof PersonClass2); // \u0026#39;function\u0026#39;  } // ç­‰ä»·äº PersonType.prototype.sayName  sayName() { console.log(this.name) } } new PersonClass(\u0026#39;xxx\u0026#39;).sayName(); console.log(typeof PersonClass2); // \u0026#39;undefined\u0026#39;   +RESULTS:\nfunction xxx undefined  PersonClass2 å°†ä½œä¸ºç±»å†…éƒ¨çš„å‡½æ•°åç§°ã€‚\n1 2 3 4 5 6 7 8 9  let PersonClass = (function() { const PersonClass2 = function(name) { ... } Object.defineProperty(PersonClass2, ...) return PersonClass2; }())   ç±»ä½œä¸ºä¸€ç­‰å…¬æ°‘ å½“ä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«å½“åšå€¼ï¼Œæ„å‘³ç€å¯ä»¥ï¼š\n å½“åšå‚æ•°ä¼ é€’ç»™å‡½æ•° ä»ä¸€ä¸ªå‡½æ•°è¿”å› èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡  æ¯”å¦‚å‡½æ•°å°±æ˜¯ JavaScript ä¸­çš„ä¸€ç­‰å…¬æ°‘ã€‚\nä½œä¸ºå‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function createObject(classDef) { return new classDef() } let obj1 = createObject(class { sayHi() { console.log(\u0026#39;Hi!\u0026#39;) } }) let obj2 = createObject(class PersonClass { sayHi() { console.log(\u0026#39;Hi!\u0026#39;) } }) obj1.sayHi(); // \u0026#39;Hi!\u0026#39; obj2.sayHi(); // \u0026#39;Hi!\u0026#39;    +RESULTS:\nHi! Hi!  åŒ¿åç±»å’Œå‘½åç±»ä½œä¸ºå‚æ•°ä¼ é€’ã€‚\nç«‹å³æ‰§è¡Œå®ç°å•ä¾‹ 1 2 3 4 5 6 7 8 9 10 11  let person = new class { constructor(name) { this.name = name } sayName() { console.log(this.name) } }(\u0026#39;xxx\u0026#39;) person.sayName(); // \u0026#39;xxx\u0026#39;   +RESULTS:\nxxx   åŒ¿åç±» ç«‹å³æ‰§è¡Œ person ä¸ºä¸€ä¸ªå•ä¾‹ï¼Œå£°æ˜æ—¶å°±å·²ç»å†³å®šäº†æ˜¯ä¸€ä¸ªç±»(åŒ¿åç±»ï¼Œåªä¼šåœ¨è¿™é‡Œä½¿ç”¨ä¸€æ¬¡)å®ä¾‹ã€‚  è®¿é—®å™¨å±æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  class CustomHTMLElement { constructor(element) { this.element = element } get html() { return this.element.innerHTML } set html(value) { this.element.innerHTML = value } } var descriptor = Object.getOwnPropertyDescriptor(CustomHTMLElement.prototype, \u0026#39;html\u0026#39;) console.log(descriptor) console.log(\u0026#39;get\u0026#39; in descriptor); // true console.log(\u0026#39;set\u0026#39; in descriptor); // true console.log(descriptor.enumerable); // false   +RESULTS:\n{ get: [Function: get html], set: [Function: set html], enumerable: false, configurable: true } true true false  æ³¨æ„è¦ä» CustomHTMLElement.prototype åŸå‹ä¸Šå»å– html ï¼Œå› ä¸ºç±»çš„æ–¹æ³•éƒ½ä¼šè¢«æŒ‚\nåˆ°åŸå‹ä¸Šã€‚\nè®¡ç®—æˆå‘˜åç§° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let methodName = \u0026#39;sayName\u0026#39; class PersonClass { constructor(name) { this.name = name } [methodName]() { console.log(this.name) } } let me = new PersonClass(\u0026#39;xx\u0026#39;) me.sayName(); // \u0026#39;xx\u0026#39;   +RESULTS:\nxx  è®¡ç®—æˆå‘˜åç§°ï¼Œå¯ä»¥è®©ç±»æˆ–å¯¹è±¡çš„æˆå‘˜ååŠ¨æ€ç”Ÿæˆï¼Œè¿™èµ‹äºˆäº†ç±»å’Œå¯¹è±¡æ›´åŠ çµæ´»çš„ä½¿ç”¨æ–¹å¼ã€‚\nä¸”è®¿é—®å™¨å±æ€§åç§°ä¹Ÿå¯ä»¥ä½¿ç”¨å˜é‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  let propertyName = \u0026#39;html\u0026#39; class CustomHTMLElement { constructor(element) { this.element = element } get [propertyName]() { return this.element.innerHTML } set [propertyName](value) { this.element.innerHTML = value } }   ç”Ÿæˆå™¨æ–¹æ³•(Generator Methods) ç±»å†…éƒ¨æ–¹æ³•è¿˜å¯ä»¥æ˜¯ç”Ÿæˆå™¨æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  class MyClass { *createIterator() { yield 1 yield 2 yield 3 } } const ins = new MyClass() const it = ins.createIterator() console.log(it.next()); // { value: 1, done: false } console.log(it.next()); // { value: 2, done: false } console.log(it.next()); // { value: 3, done: false } console.log(it.next()); // { value: undefined, done: true }   +RESULTS:\n{ value: 1, done: false } { value: 2, done: false } { value: 3, done: false } { value: undefined, done: true }  è¿­ä»£å™¨å’Œç”Ÿæˆå™¨9æè¿°è¿‡ï¼Œä¸€ä¸ªå®ç°äº† Symbol.iterator æˆ–å†…ç½®å®ƒ\nçš„ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥è¢«è¿­ä»£ï¼Œä¹Ÿå°±å¯ä»¥ä½¿ç”¨ for...of å»éå†å®ƒï¼Œæœ€ç»ˆè°ƒç”¨çš„éƒ½ä¼šæ˜¯\nSymbol.iterator è¿™ä¸ªå†…éƒ¨æˆ–è‡ªå®šä¹‰çš„å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  class Collection { constructor() { this.items = [] } *[Symbol.iterator]() { yield *this.items.values() } } var c = new Collection() c.items.push(...[1, 2, 3]) for (let x of c) { console.log(x) }   +RESULTS:\n1 2 3  å›é¡¾ä»£ç†ç”Ÿæˆå™¨å’Œé›†åˆå†…ç½®è¿­ä»£å™¨çš„å†…å®¹ï¼Œæˆ‘ä»¬åˆ†æè¿™ä¸€å¥ï¼š\nyield *this.items.values()\n é¦–å…ˆ values() ä¸ºé›†åˆå†…ç½®çš„å€¼å¾—è¿­ä»£å™¨ yield *iterator() è¿™ç§æ–¹å¼ä¸ºç”Ÿæˆå™¨ä»£ç†ï¼Œå³ä¸€ä¸ªç”Ÿæˆå™¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªç”Ÿæˆå™¨  ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬ for (let x of c) {} çš„æ—¶å€™ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨äº† Collection ç±»å†…éƒ¨å®\nç°çš„ *[Symbol.iterator]() è¿­ä»£å™¨ï¼Œç„¶ååœ¨è¿­ä»£å™¨å†…éƒ¨ç”±è°ƒç”¨äº†ç±»æˆå‘˜çš„ items æ•°\nç»„çš„å†…ç½®è¿­ä»£å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸€å¥æœ€ç»ˆå…¶å®å°±æ˜¯å»éå† items æ•°ç»„ï¼Œè¾“å‡ºæ¯ä¸ªå…ƒç´ å€¼ã€‚\né™æ€æˆå‘˜ é™æ€æˆå‘˜ï¼Œå³åªå±äºæ„é€ å‡½æ•°çš„å±æ€§ï¼Œåªèƒ½é€šè¿‡ç±»åå»è®¿é—®çš„æˆå‘˜ã€‚\n\u0026lt; ECMAScript 6 ä¹‹å‰çš„åšæ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function Person(name) { this.name = name } Person.create = function(name) { return new Person(name); } Person.prototype.sayName = function() { console.log(this.name) } var person = Person.create(\u0026#39;xxx\u0026#39;) person.sayName(); // \u0026#39;xxx\u0026#39;   +RESULTS:\nxxx  ç›´æ¥åœ¨å‡½æ•°åç§°ä¸ŠæŒ‚ä¸€ä¸ªå±æ€§ï¼Œå› ä¸ºå‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„å±æ€§ï¼Œå’Œå¯¹è±¡ä¸€æ ·\nå¯ä»¥é€šè¿‡ obj[attrName] è®¿é—®æˆ–æ–°å¢å±æ€§ã€‚\n = ECMAScript 6 å¼€å§‹å¯ä»¥ä½¿ç”¨ç±»é™æ€æˆå‘˜æ–¹å¼ï¼š\n é€šè¿‡ static å…³é”®è¯å£°æ˜ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†æˆä¸ºç±»çš„é™æ€å±æ€§ï¼Œåªèƒ½é€šè¿‡ç±»åè®¿é—®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  class Person { constructor(name) { this.name = name } sayName() { console.log(this.name) } static create(name) { return new Person(name); } } let p = Person.create(\u0026#39;xx\u0026#39;); p.sayName(); // \u0026#39;xx\u0026#39;   +RESULTS:\nxx  ç±»ç»§æ‰¿ \u0026lt; ECMAScript 6 ä¹‹å‰çš„ç±»ç»§æ‰¿ ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨åŸå‹çš„æ–¹å¼å»å®ç°ç»§æ‰¿\næ„é€ å‡½æ•°-å®ä¾‹-å‡½æ•°ä¸‰è€…ä¹‹é—´çš„å…³ç³»ç®€å›¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  function Rectangle(l, w) { this.len = l this.width = w } Rectangle.prototype.getArea = function() { return this.len * this.width } function Square(l) { // è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œå°†å®ä¾‹å±æ€§æ‹·è´ä¸€ä»½åˆ°å­ç±»ä¸­  Rectangle.call(this, l, l) } // #1 Square.prototype = /* Object.create(Rectangle.prototype, { constructor: { value: Square, enumerable: false, writable: true, configurable: true } }) */ Object.create(Rectangle.prototype) // Rectangle.prototype  var s = new Square(3) console.log(s.getArea()); // 9 console.log(s instanceof Square); // true console.log(s.constructor === Square.prototype.constructor); // true console.log(Square === Square.prototype.constructor); // true console.log(Square.prototype.constructor); // true console.log(s instanceof Rectangle); // true   +RESULTS: #1 è¢«æ³¨é‡Šï¼Œæ„å‘³ç€æ²¡æœ‰é‡æ–°å®šä¹‰æ„é€ å‡½æ•°çš„è¾“å‡º\n9 true true false [Function: Rectangle] true  è¿™é‡Œ Square çš„æ„é€ å‡½æ•°ä¸å†æ˜¯è‡ªèº«äº†ï¼Œå› ä¸ºå®ƒçš„åŸå‹è¢«é‡å†™äº†ï¼Œè€Œæ„é€ å‡½æ•°å¯¹è±¡åˆæ˜¯æŒ‚\nåœ¨åŸå‹å¯¹è±¡ä¸Šçš„ Square.prototype.constructor å› æ­¤ä½¿ç”¨åŸå‹ç»§æ‰¿çš„æ—¶å€™å°¤å…¶è¦è®°å¾—é‡\næ–°å®šä¹‰æ„é€ å‡½æ•°ï¼Œæ‰èƒ½å¾—åˆ°ä¸‹é¢çš„æ­£ç¡®ç»§æ‰¿æ•ˆæœï¼š\n+RESULTS: #1 æ²¡æœ‰æ³¨é‡Šï¼Œæœ‰é‡æ–°å®šä¹‰æ„é€ å‡½æ•°çš„è¾“å‡ºç»“æœ\n9 true true true [Function: Square] true  ä¸Šé¢ä»£ç å¯¹äºåˆå­¦è€…æ¥è¯´ä¸å¤ªå®¹æ˜“æ˜ç™½çš„ä¸€èˆ¬æœ‰ä¸¤ç‚¹ï¼š\n  Rectangle.call(this, l, l) è¿™ä¸€æ­¥ï¼Œè¿™é‡Œæ˜¯æ‹·è´ä¸€ä»½æ˜¯å®ä¾‹å±æ€§åˆ°å­ç±»ä¸Š\nè¿™é‡Œç›¸å½“äºè®© Square ä¹Ÿæœ‰äº†è‡ªå·±çš„ len å’Œ width å®ä¾‹å±æ€§ã€‚\n  Square.prototype åŸå‹èµ‹å€¼çš„ä¸€æ­¥æ„é€ å‡½æ•°è¢«è¦†ç›–äº†ï¼Œéœ€è¦é‡æ–°å®šä¹‰æ„é€ å‡½æ•°\n  æ³¨æ„ç‚¹ï¼š é‡å†™ Square çš„åŸå‹ï¼Œä¸”éœ€è¦é‡æ–°å®šä¹‰æ„é€ å‡½æ•°ï¼Œå› ä¸ºæ„é€ å‡½æ•°æ˜¯åœ¨åŸå‹ä¹‹ä¸Šçš„ï¼Œ\nå¦‚æœå°†åŸå‹è¦†ç›–äº†ï¼Œé‚£ä¹ˆ Square å°†æ²¡æœ‰è‡ªå·±çš„æ„é€ å‡½æ•°äº†ï¼Œå°†æ²¡æ³•åˆ›å»ºå®ä¾‹ï¼Œå› æ­¤åœ¨ä½¿ç”¨\nObject.create() (Object.createä¼ªç å®ç°)çš„æ—¶å€™éœ€è¦æŠŠæ„é€ å‡½æ•°å±æ€§ç»™åŠ ä¸Šå»ã€‚\n\u0026gt;= ECMAScript 6 ä¹‹åçš„ class ç±»ç»§æ‰¿ åœ¨æœ‰äº† class è¯­æ³•ç³–ä¹‹åï¼Œè®© JavaScript ä¸­çš„ç»§æ‰¿å˜å¾—ç®€å•æ˜“æ‡‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  class Rectangle { constructor(l, w) { this.len = l this.width = w } getArea() { return this.len * this.width } } class Square extends Rectangle { constructor(l) { super(l, l) } } var s = new Square(3) console.log(s.getArea()); // 9 console.log(s instanceof Square); // true console.log(s instanceof Rectangle); // true   +RESULTS:\n9 true true  å°†ä¸Šé¢çš„ä»£ç  babel è½¬æ¢ï¼Œåˆ é™¤ä¸€äº›ä¸å…³å¿ƒçš„ä»£ç ä¹‹åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66  \u0026#34;use strict\u0026#34;; // ... çœç•¥  function _inherits(subClass, superClass) { if (typeof superClass !== \u0026#34;function\u0026#34; \u0026amp;\u0026amp; superClass !== null) { throw new TypeError(\u0026#34;Super expression must either be null or a function\u0026#34;); } subClass.prototype = Object.create( superClass \u0026amp;\u0026amp; superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); } // ... çœç•¥  var Rectangle = /*#__PURE__*/ function () { function Rectangle(l, w) { _classCallCheck(this, Rectangle); this.len = l; this.width = w; } _createClass(Rectangle, [{ key: \u0026#34;getArea\u0026#34;, value: function getArea() { return this.len * this.width; } }]); return Rectangle; }(); var Square = /*#__PURE__*/ function (_Rectangle) { _inherits(Square, _Rectangle); function Square(l) { _classCallCheck(this, Square); return _possibleConstructorReturn(this, _getPrototypeOf(Square).call(this, l, l)); } return Square; }(Rectangle); var s = new Square(3); console.log(s.getArea()); // 9  console.log(_instanceof(s, Square)); // true  console.log(_instanceof(s, Rectangle)); // true   æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„åº”è¯¥æ˜¯ _inherits è¿™ä¸ªå‡½æ•°ï¼Œå…¶å®å®ƒé‡Œé¢å®ç°çš„å°±å’Œæˆ‘ä»¬ ECMAScript6\nä¹‹å‰çš„ç‰ˆæœ¬10.8.1ä¸€æ ·ã€‚\nç±» super() ä½¿ç”¨æ³¨æ„ç‚¹ åœ¨ä½¿ç”¨ es6 çš„ç±»çš„ super() éœ€è¦æ³¨æ„å‡ ç‚¹ï¼š\n åªèƒ½åœ¨å­ç±»çš„æ–¹æ³•ä¸­ä½¿ç”¨ super() ï¼Œå¦‚æœè¯•å›¾åœ¨ä¸€ä¸ªéç»§æ‰¿çš„ç±»(ä¸æ˜¯ç”¨ extends\nå®ç°çš„ç»§æ‰¿çš„å­ç±»)ä¸­ä½¿ç”¨éƒ½ä¼šæŠ¥é”™ã€‚ å¿…é¡»åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ this ä¹‹å‰è°ƒç”¨ super() å› ä¸º super() ä¼šå¯¹ this åš\nä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œæ¯”å¦‚æ‹·è´å®ä¾‹å±æ€§ç­‰ç­‰ã€‚ å”¯ä¸€ä¸€ä¸ªé¿å…è°ƒç”¨ super() çš„é€”å¾„å°±æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­è¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚  ç¬¬ä¸€ç‚¹: ä¸èƒ½éç»§æ‰¿è°ƒç”¨ super()\n1 2 3 4 5 6 7 8  class Person { constructor(name) { super(name) this.name = name } } const p = new Person(\u0026#39;xxx\u0026#39;)   +RESULTS: æŠ¥é”™ç»“æœï¼Œè¡¨æ˜ä¸èƒ½åœ¨éç»§æ‰¿çš„å­ç±»ä¸­ç›´æ¥è°ƒç”¨ super ï¼Œå› ä¸ºå®ƒè¢«å®šä¹‰æŒ‡å‘\nçš„æ˜¯ extends çš„çˆ¶ç±»é‚£ä¸ªå¯¹è±¡ã€‚\n/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-UZ7NKG:4 super(name) ^^^^^ SyntaxError: 'super' keyword unexpected here at Module._compile (internal/modules/cjs/loader.js:721:23) at Object.Module._extensions..js (internal/modules/cjs/loader.js:787:10)  ç¬¬äºŒç‚¹: å¿…é¡»åœ¨ä½¿ç”¨ this ä¹‹å‰è°ƒç”¨ super() åˆå§‹åŒ– this\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  class Person { constructor(name) { this.name = name } } class Man extends Person { constructor(name) { console.log(this.name) super(name); } sayName() { console.log(this.name) } } const m = new Man(\u0026#39;xxx\u0026#39;); // undefined   +RESULTS: ç›´æ¥æŠ¥é”™ï¼Œä¸èƒ½åœ¨ä½¿ç”¨ this ä¹‹åè°ƒç”¨ super() ,å¿…é¡»åœ¨ä¹‹å‰è°ƒç”¨\n/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-c51Wqa:10 console.log(this.name) ^ ReferenceError: Must call super constructor in derived class before accessing 'this' or returning from derived constructor at new Man (/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-c51Wqa:10:17) at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-c51Wqa:19:11  é‡å†™çˆ¶ç±»æ–¹æ³•(Shadowing Class Methods) é‡å†™çˆ¶ç±»æ–¹æ³•ï¼Œé€šè¿‡å®ä¾‹è°ƒç”¨è¯¥æ–¹æ³•æ—¶å€™ï¼Œä¼šå…ˆä»å½“å‰ç±»ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å°±ä¼šå»çˆ¶ç±»ä¸­\næ‰¾ã€‚\nå› æ­¤ï¼Œå¦‚æœæƒ³å­ç±»æ‹¥æœ‰æŸç§è‡ªå·±çš„è¡Œä¸ºï¼Œå¯ä»¥é€šè¿‡é‡å†™æ–¹æ³•æ¥å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  class Human { run() { console.log(\u0026#39;human running.\u0026#39;) } } class Person extends Human { run() { console.log(\u0026#39;person running.\u0026#39;) } } const p = new Person() p.run(); // \u0026#39;human running.\u0026#39;   +RESULTS: é‡å†™ä¹‹å\nperson running.  +RESULTS: é‡å†™ä¹‹å‰\nhuman running.  Babel ç¼–è¯‘ä¹‹åçš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  var Human = /*#__PURE__*/ function () { function Human() { _classCallCheck(this, Human); } _createClass(Human, [{ key: \u0026#34;run\u0026#34;, value: function run() { console.log(\u0026#39;human running.\u0026#39;); } }]); return Human; }(); var Person = /*#__PURE__*/ function (_Human) { _inherits(Person, _Human); function Person() { _classCallCheck(this, Person); return _possibleConstructorReturn(this, _getPrototypeOf(Person).apply(this, arguments)); } _createClass(Person, [{ key: \u0026#34;run\u0026#34;, value: function run() { console.log(\u0026#39;person running.\u0026#39;); } }]); return Person; }(Human); var p = new Person(); p.run(); // \u0026#39;human running.\u0026#39;   _inherits è®© Person.prototype æŒ‡å‘äº† Human.prototype,\nä¸¤ä¸ª _createClass ï¼Œå‰ä¸€ä¸ªè®© run æŒ‚åˆ°äº† Human çš„åŸå‹ä¸Šï¼Œåä¸€ä¸ªåˆåœ¨ Person çš„\nåŸå‹ä¸Šé‡æ–°æŒ‚äº†ä¸€ä¸ªåŒåçš„ run æ–¹æ³•ï¼Œä½†ç”±äºç»§æ‰¿ _inherits çš„åŸå‹\nPerson.prototype å®é™…ä¸Šæ˜¯æŒ‡å‘ Human.prototype çš„ï¼Œå› æ­¤ä¸¤ä¸ª _createClass å®é™…ä¸Š\næ˜¯è¦†ç›–äº†å‰ä¸€ä¸ª _createClass çš„ run æ–¹æ³•ã€‚\nç»§æ‰¿é™æ€æˆå‘˜ é™æ€æˆå‘˜åœ¨ extends ç»§æ‰¿è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šè¢«ç»§æ‰¿åˆ°å­ç±»å½“ä¸­ï¼Œä½†æ˜¯ä¹Ÿåªèƒ½é€šè¿‡æ„é€ å‡½æ•°è®¿\né—®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  class Rectangle { constructor(l, w) { this.len = l this.width = w } getArea() { return this.len * this.width } static create(l, w) { return new Rectangle(l, w) } } class Square extends Rectangle { constructor(l) { super(l, l) } } var rect = Square.create(3, 4) console.log(rect instanceof Rectangle); // true console.log(rect.getArea()); // true console.log(rect instanceof Square); // false   +RESULTS:\ntrue 12 false  åŠ¨æ€çˆ¶ç±» å³ extends åé¢çš„å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œåªè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š\n æœ‰ [ [Constructor]] å¯ä»¥æ„å»ºå®ä¾‹(ä½¿ç”¨ new) æœ‰è‡ªå·±çš„åŸå‹  æ™®é€šæ„é€ å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  function Rectangle(l, w) { this.len = l this.width = w } Rectangle.prototype.getArea = function() { return this.len * this.width } class Square extends Rectangle { constructor(l) { super(l, l) } } var x = new Square(3) console.log(x.getArea()); // 9 console.log(x instanceof Rectangle); // true   +RESULTS:\n9 true  å‡½æ•°è°ƒç”¨æ–¹å¼ï¼šåªè¦è¿”å›å€¼æ»¡è¶³æœ‰æ„é€ å™¨å’ŒåŸå‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  function Rectangle(l, w) { this.len = l this.width = w } Rectangle.prototype.getArea = function() { return this.len * this.width } function getBase() { return Rectangle } class Square extends getBase() { constructor(l) { super(l, l) } } var x = new Square(3) console.log(x.getArea()); // 9 console.log(x instanceof Rectangle); // true    +RESULTS:\n9 true  æ ¹æ®çˆ¶ç±»å¯ä»¥åŠ¨æ€å†³å®šçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€äº›æ¯”è¾ƒæœ‰ç”¨çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ï¼šæ··åˆå™¨ç±»å‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  let SerializableMixin = { serialize() { return JSON.stringify(this) } } let AreaMixin = { getArea() { return this.length * this.width } } function mixin(...mixins) { let base = function() {} Object.assign(base.prototype, ...mixins) return base } class Square extends mixin(SerializableMixin, AreaMixin) { constructor(l) { super() this.length = l this.width = l } } const x = new Square(3) console.log(x.getArea()) console.log(x.serialize())   +RESULTS:\n9 {\u0026quot;length\u0026quot;:3,\u0026quot;width\u0026quot;:3}  è®© Square åŒæ—¶å…·å¤‡å¤šä¸ªæ··åˆå™¨çš„èƒ½åŠ›ï¼Œä½¿ç”¨å¤šä¸ªæ··åˆå™¨æ„å»ºä¸€ä¸ªå‡½æ•°ç±»ã€‚\n è®°ä½ï¼šåªè¦æ»¡è¶³æœ‰åŸå‹å’Œæ„é€ å‡½æ•°éƒ½å¯ä»¥æ”¾åœ¨ extends å³è¾¹ä½œä¸ºè¢«ç»§æ‰¿çš„çˆ¶ç±»ã€‚\né™¤ä¸‹é¢ä¸¤é’Ÿç±»å‹ä¸èƒ½ä¹‹å¤–ï¼š\n null ç”Ÿæˆå™¨å‡½æ•°  å› ä¸ºä»–ä»¬æ²¡æœ‰ [[Constructor] ] å±æ€§ã€‚\n ç»§æ‰¿å†…ç½®å¯¹è±¡ å¯ä»¥é€šè¿‡åŸå‹ç»§æ‰¿çš„æ–¹å¼æ¥åŸºäºå†…ç½®å¯¹è±¡å®šä¹‰ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†æœ‰ç”¨å†…ç½®å¯¹è±¡çš„ç›¸åŒ\nçš„åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  function MyArray() { // è°ƒç”¨ Array çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ– this  Array.apply(this, arguments) } MyArray.prototype = Object.create(Array.prototype, { constructor: { value: MyArray, writable: true, configurable: true, enumerable: true } }) var colors = new MyArray() colors[0] = \u0026#39;red\u0026#39; console.log(colors.length) colors.length = 0 console.log(colors[0])   +RESULTS:\n0 red  ç»“æœå¹¶éå¦‚æˆ‘ä»¬æ‰€é¢„æœŸã€‚ length å±æ€§å’Œæ•°å€¼å±æ€§å¹¶æ²¡æœ‰åƒå†…ç½®æ•°ç»„ç±»å‹ä¸€æ ·å‘ç”Ÿå˜åŒ–ï¼Œ\nè¿™æ˜¯å› ä¸ºè¿™ä¸ªåŠŸèƒ½æ— æ³•é€šè¿‡ Array.apply() æˆ–èµ‹å€¼åŸå‹ç±»å®ç°ã€‚\nåœ¨ ECMAScript5 çš„ç±»ç»§æ‰¿ä¸­ï¼Œ this çš„å€¼ä¼šåœ¨è°ƒç”¨ Array.apply ä¹‹å‰ä¼šè¢«æ–°çš„ç±»å‹\n(æ¯”å¦‚ï¼š MyArray)åˆ›å»ºå¥½äº†ï¼Œç„¶ååŸºç¡€ç±»å‹çš„æ„é€ å‡½æ•°æ‰ä¼šè¢«è°ƒç”¨ï¼Œè¿™å°±æ„å‘³ç€ this\nåªæ˜¯ç»‘å®šåˆ°äº† MyArray çš„æœ¬ èº«çš„å®ä¾‹ä¸Šè€Œå·²ï¼Œæ­¤æ—¶å¹¶ä¸å…·å¤‡æ•°ç»„çš„ä¸€äº›åŸºç¡€ç‰¹æ€§ï¼Œè€Œå\nçš„åŸºç¡€ç±»å‹æ„é€ å‡½æ•°çš„è°ƒç”¨åªä¸è¿‡æ˜¯å¯¹æ–°ç±»å‹åšäº†ä¸€ç‚¹æ‰©å±•è€Œå·²ã€‚\nè€Œåœ¨ ECMAScript6 çš„åŸºäºç±»çš„ç»§æ‰¿å½“ä¸­ï¼Œ this ä¼šä¼˜å…ˆè¢« Array å†…ç½®ç±»å‹çš„æ„é€ å‡½æ•°\nè°ƒç”¨ï¼Œç„¶åæ‰æ˜¯è¢«æ–°ç±»å‹ MyArray çš„æ„é€ å‡½æ•°ä¿®æ”¹ï¼Œä¿®é¥°æ–°ç±»å‹çš„ä¸€äº›å†…å®¹ã€‚ç»“æœå°±æ˜¯\nthis å°†æ‹¥æœ‰åŸºç¡€ç±»å‹çš„å†…ç½®åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10  class MyArray extends Array { // empty } var colors = new MyArray(); colors[0] = \u0026#34;red\u0026#34;; console.log(colors.length); // 1  colors.length = 0; console.log(colors[0]); // undefined   +RESULTS:\n1 undefined  ä¹Ÿå°±æ˜¯è¯´è¦ç»§æ‰¿åŸºç¡€ç±»å‹ï¼Œå¿…é¡»â€œå…ˆä½¿ç”¨åŸºç¡€ç±»å‹æ„é€ å‡½æ•°å»åˆ›å»º this ï¼Œç„¶åå¯¹æ–°ç±»å‹\nåšè¿›ä¸€æ­¥æ‰©å……â€ï¼Œå¦åˆ™ï¼Œå¦‚æœç›¸åçš„è¯ï¼Œ this ç”±æ–°ç±»å‹åˆ›å»ºï¼Œé‚£åªä¼šæ‹¥æœ‰æ–°ç±»å‹çš„ä¸€äº›\nåŸºæœ¬ç‰¹å¾ï¼Œåé¢æ‰è°ƒç”¨åŸºç¡€ç±»å‹çš„è¯åªæ˜¯åšäº†ä¸€ä¸ªç²‰é¥°è€Œå·²ã€‚\nSymbol.species ç¬¦å·å±æ€§ 1 2 3 4 5 6 7 8 9  class MyArray extends Array { } let items = new MyArray(1, 2, 3, 4), subItems = items.slice(1, 3) console.log(items instanceof MyArray); // true console.log(subItems instanceof MyArray); // true   +RESULTS:\ntrue true  é€šè¿‡ class-extends çš„ç»§æ‰¿ï¼Œä¸ä»…èƒ½è®©æ–°ç±»å‹å®ç°åŸç”Ÿç±»å‹çš„èƒ½åŠ›ï¼Œè€Œä¸”ä¹Ÿä¼šæ”¹å˜ä¸€äº›é»˜\nè®¤è¡Œä¸ºï¼Œæ¯”å¦‚ä¸Šé¢çš„ subItems instanceof MyArray çš„ç»“æœä¼šæ˜¯ true ï¼Œè¿™æ˜¯å› ä¸º\nSymbol.species åœ¨ç»§æ‰¿è¿‡ç¨‹ä¸­å½±å“äº†å®ƒçš„é»˜è®¤è¡Œä¸ºã€‚\nSymbol.species ç¬¦å·å±æ€§ç”¨æ¥å®šä¹‰ä¸€ä¸ªé™æ€çš„è®¿é—®å™¨å±æ€§ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ã€‚è¯¥å‡½æ•°è¢«å½“åšä¸€ä¸ª\næ„é€ å‡½æ•°ä½¿ç”¨ï¼Œæ¯å½“ä¸€ä¸ªç±»çš„å®ä¾‹å¿…é¡»åœ¨ä¸€ä¸ªå®ä¾‹æ–¹æ³•ä¸­è¢«åˆ›å»ºçš„æ—¶å€™(è€Œä¸æ˜¯ä½¿ç”¨æ„é€ å‡½\næ•°)ã€‚\nä»¥ä¸‹å†…ç½®ç±»å‹å®šä¹‰äº† Symbol.species :\n Array ArrayBuffer Map Promise RegExp Set Typed Arrays  ä¸Šé¢æ¯ä¸ªç±»å‹éƒ½æœ‰ä¸€ä¸ªé»˜è®¤çš„ Symbol.species å±æ€§ï¼Œè¿”å› this ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ€»æ˜¯ä¼š\nè¿”å›æ„é€ å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8  class Person { getSpecies() { const descriptor = Object.getOwnPropertyDescriptor(Person, Symbol.species) console.log(descriptor, \u0026#39;11\u0026#39;) } } console.log(new Person().getSpecies())   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  class MyClass { // ä¸Šé¢å†…ç½®ç±»å‹çš„ Symbol.species é»˜è®¤å®ç°ï¼Œç±»ä¼¼è¿™é‡Œçš„å®ç°  static get [Symbol.species]() { console.log(\u0026#39;get spcies\u0026#39;) return this } constructor(value) { this.value = value } clone() { // this.constructor[Symbol.species] ä¼šè¿”å› MyClass æ„é€ å‡½æ•°  // å› æ­¤è¿™é‡Œä¹Ÿç›¸å½“äºæ˜¯ new MyClass(this.value)  return new this.constructor[Symbol.species](this.value) } }   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  class A { static get [Symbol.species]() { return this; } constructor(value) { this.value = value; } clone() { return new this.constructor[Symbol.species](this.value); } } class B extends A { // empty } class C extends A { static get [Symbol.species]() { return A; } } let b = new B(\u0026#34;foo\u0026#34;), a1 = instance1.clone(), c = new C(\u0026#34;bar\u0026#34;), a2 = instance2.clone(); console.log(b instanceof A); // #1: true console.log(a1 instanceof B); // #2: true console.log(c instanceof A); // #3: true console.log(a2 instanceof C); // #4: false   +RESULTS:\ntrue true true false  #1: true å› ä¸º A æ˜¯ B çš„çˆ¶ç±»ï¼Œåœ¨ B å®ä¾‹çš„åŸå‹é“¾ä¹‹ä¸Šï¼Œå› æ­¤è¿™é‡Œç»“æœä¸º trueã€‚\n#2: true å› ä¸º B ç»§æ‰¿ A ï¼Œä¸” B çš„å®ä¾‹ b ä¸­å¹¶æ²¡æœ‰é‡å†™ Symbol.species å› æ­¤ä»–ä¼š\nè¿”å›é»˜è®¤çš„ Symbol.species å®ç°ä¹Ÿå°±æ˜¯è¯¥ç±»è‡ªèº«çš„æ„é€ å‡½æ•°ã€‚\n#3: true å› ä¸º C ç»§æ‰¿ Aï¼ŒåŒ #1 ã€‚\n#4: false è¿™é‡Œç»“æœæ„å‘³ç€ C å¹¶ä¸åœ¨å®ä¾‹ a2 çš„åŸå‹é“¾ä¸Šï¼Œè¿™æ˜¯å› ä¸º C ä¸­é‡å†™äº†\nSymbol.species æ”¹å˜äº†ç»§æ‰¿çš„é»˜è®¤è¡Œä¸ºã€‚\nnew.target å±æ€§ åœ¨ç±»ä¸­ new.target æ°¸è¿œä¸ä¼šæ˜¯ undefined å› ä¸ºç±»åä¸èƒ½ç›´æ¥è¢«è°ƒç”¨ã€‚\nåˆ©ç”¨ new.target çš„ç‰¹æ€§ï¼šå¦‚æœæ˜¯é€šè¿‡ new è°ƒç”¨å®ƒçš„å€¼å°±æ˜¯å½“å‰ç±»çš„æ„é€ å‡½æ•°\næˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªç±»å˜æˆçš„æŠ½è±¡åŒ–ï¼Œè®©å®ƒä¸èƒ½è¢«ç”¨æ¥åˆ›å»ºå®ä¾‹ï¼Œåªèƒ½è¢«å…¶ä»–ç±»ç»§æ‰¿ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  class Shape { constructor() { if (new.target === Shape) { throw new Error(\u0026#39;ä¸èƒ½è¢«å®ä¾‹åŒ–ã€‚\u0026#39;) } } } class Rect extends Shape { // ... } var x = new Shape(); // æŠ¥é”™ï¼Œä¸èƒ½è¢«å®ä¾‹åŒ–  var y = new Rect(); // ok   å°ç»“   ç±»å£°æ˜ï¼Œæ”¯æŒæ™®é€šæ–¹å¼ï¼Œè¡¨è¾¾å¼æ–¹å¼ï¼Œä¸æå‡ï¼Œæ€§è´¨å’Œ let ä¸€æ ·ï¼Œå­˜åœ¨ TDZã€‚\n  ç±»å¯ä»¥ç›´æ¥ä½œä¸ºè¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥è·Ÿå‡½æ•°ä¸€æ ·ç«‹å³æ‰§è¡Œï¼Œè¿˜å¯ä»¥ç›´æ¥å½“åšå‚æ•°ä¼ \né€’ï¼Œå¯ç”¨æ¥å®ç°å•ä¾‹ã€‚\n  ç±»æˆå‘˜çš„åç§°å’Œæ™®é€šå¯¹è±¡ä¸€æ ·ä½¿ç”¨è®¡ç®—å±æ€§ï¼ŒåŠ¨æ€å†³å®šå…¶å±æ€§åç§°ã€‚\n  ç±»æ–¹æ³•å¯ä»¥æ˜¯ç”Ÿæˆå™¨æ–¹æ³•ï¼Œè¿”å›è¿­ä»£å™¨ã€‚\n  ç±»çš„é™æ€æ–¹æ³•(é€šè¿‡ static ä¿®é¥°çš„æ–¹æ³•)ä¼šè¢«å­ç±»ç»§æ‰¿åˆ°æ„é€ å‡½æ•°ä¸Šã€‚\n  super() åªèƒ½åœ¨ç»§æ‰¿å¼çš„å­ç±»æ„é€ å‡½æ•°ä¸­è°ƒç”¨ï¼Œä¸”å¿…é¡»åœ¨ä½¿ç”¨ this ä¹‹å‰è°ƒç”¨ï¼Œå¦\nåˆ™ä¼šæŠ¥é”™ã€‚\n  çˆ¶ç±»ï¼Œå³ extends å³è¾¹å¯ä»¥æ˜¯åŠ¨æ€çš„ï¼Œåªéœ€è¦æ»¡è¶³å®ƒçš„è¿”å›ç»“æœå¿…é¡»æœ‰\n[[Constructor] ] å’Œè‡ªå·±çš„åŸå‹å¯¹è±¡ã€‚\n  å†…ç½®å¯¹è±¡çš„ç»§æ‰¿ï¼ŒES5çš„ç»§æ‰¿æœ‰ç¼ºé™·ï¼Œå› ä¸º this ç»‘å®šçš„å…ˆåé—®é¢˜\nes5 å…ˆç»‘å®šæ–°ç±»å‹ç„¶åæ˜¯åŸºç¡€ç±»å‹ä¿®é¥°ï¼Œes6 æ˜¯å…ˆç»‘å®šåŸºç¡€ç±»å‹ï¼Œç„¶åæ˜¯æ–°ç±»å‹çš„ä¿®é¥°ï¼Œ\nè¿™æ ·å°†æ˜¯è¯¥æ–°ç±»å‹å…·å¤‡åŸºç¡€ç±»å‹çš„åŠŸèƒ½ã€‚\n  Symbol.species åªèƒ½åœ¨ç±»æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œä¸èƒ½é€šè¿‡æ„é€ å‡½æ•°è°ƒç”¨ï¼Œè¿”å›å½“å‰ç±»çš„æ„é€ \nå‡½æ•°ã€‚\n  new.target ç±»çš„è¯¥å±æ€§åªä¼šæ˜¯æ„é€ å‡½æ•°ï¼Œå› ä¸ºç±»æœ¬èº«æ˜¯ä¸å¯ä»¥ç›´æ¥è°ƒç”¨çš„ï¼Œé€šè¿‡å®ƒ\nçš„ç‰¹æ€§å¯ä»¥è®©ä¸€ä¸ªç±»æŠ½è±¡åŒ–ï¼Œä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œåªèƒ½è¢«å…¶ä»–ç±»ç»§æ‰¿ã€‚\n  æå‡æ•°ç»„èƒ½åŠ›(Array) åˆ›å»ºæ•°ç»„ Array.of(â€¦items) ECMAScript5 ä¸­æ„å»ºæ•°ç»„ï¼šé€šè¿‡ Array() æ„é€ å‡½æ•°ï¼Œä½†æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼å¾ˆå®¹æ˜“äº§ç”Ÿç–‘æƒ‘ï¼Œ\næ¯”å¦‚ï¼š\nå€¼ä¼ é€’ä¸€ä¸ªæ•°å€¼ï¼š new Array(2) åˆ™ä¼šåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 2 çš„æ•°ç»„ã€‚\nä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²æ•°å€¼ï¼š new Array('2') åˆ™ä¼šå½“åšä¸€ä¸ªæ•°ç»„å…ƒç´ ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå…ƒç´ çš„æ•°ç»„ã€‚\nä¼ é€’å¤šä¸ªå‚æ•°çš„æ—¶å€™ï¼š new Array(3, '2') åˆ™å‚æ•°åˆ—è¡¨ä¸­çš„å…ƒç´ éƒ½ä¼šè¢«å½“åšæ•°ç»„å…ƒç´ ã€‚\nè¿™å¯¹æˆ‘ä»¬çš„ä½¿ç”¨å¹¶ä¸æ˜¯ä»€ä¹ˆå¥½äº‹ï¼Œæœ‰æ—¶å€™ä½ å¯èƒ½åªæ˜¯æƒ³åˆ›å»ºä¸€ä¸ª 2 å…ƒç´ çš„æ•°ç»„è€Œå·²ï¼Œä½†\næ˜¯å®é™…ä¸Šæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 2 çš„ç©ºæ•°ç»„ã€‚\nECMAScript6 ä¸­åˆ™æ–°å¢äº† Array.of() å°±ä¸ä¼šæœ‰è¿™ç§æ··æ·†ï¼Œå®ƒåªä¼šå°†å‚æ•°å½“åšæ•°ç»„å…ƒç´ æ¥\nåˆ›å»ºæ•°ç»„ï¼Œæ¯”å¦‚ï¼š\nArray.of(1, 2) ï¼šä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œ arr[0] = 1, arr[1] = 2ã€‚\nArray.of(2) : ä¸€ä¸ªå…ƒç´ æ•°ç»„ï¼Œ arr[0] = 2ã€‚\nArray.of('2') ï¼šä¸€ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œarr[0] = \u0026lsquo;2\u0026rsquo;ã€‚\n Array.of() ä¸ä½¿ç”¨ Symbol.species å†³å®šè¿”å›å€¼å¾—ç±»å‹ï¼Œå®ƒä½¿ç”¨çš„æ˜¯å½“å‰æ„é€ å‡½æ•°(åœ¨\nof() å‡½æ•°é‡Œé¢çš„ this)æ¥å†³å®šè¿”å›çš„æ­£ç¡®æ•°æ®ç±»å‹ã€‚\n Array.from(items[, mapFn[, thisArg]]) Array.from å†…éƒ¨ä¼ªç å®ç°-\u0026gt;\nå°†ç±»æ•°ç»„çš„å¯¹è±¡è½¬æ¢æˆæ•°ç»„ç±»å‹ï¼Œç±»æ•°ç»„å¯¹è±¡ï¼š\n æœ‰é•¿åº¦å±æ€§ æœ‰æ•°å€¼ç´¢å¼•  1 2 3 4 5 6 7 8 9  let obj = { length: 2 } const objArr = Array.from(obj) console.log(objArr.length) console.log(Array.isArray(objArr)) console.log(objArr[0])   +RESULTS:\n2 true undefined  å¯¹äºç±»æ•°ç»„å¯¹è±¡å¦‚æœæƒ³ä½¿ç”¨æ•°ç»„çš„æ–¹æ³•ï¼Œä»¥å¾€éƒ½æ˜¯é€šè¿‡ call(arrayLike) æ–¹å¼æ¥è°ƒç”¨çš„ï¼Œ\næ¯”å¦‚ï¼š Array.prototype.slice.call(arrayLike) ç›¸å½“äº arrayLike.slice() å€Ÿç”¨ä¸€\nä¸‹æ•°ç»„çš„ slice æ–¹æ³•å› ä¸ºè¯¥æ–¹æ³•åªè¦å¯¹è±¡æœ‰æ•°å€¼ç´¢å¼•å’Œé•¿åº¦å±æ€§å°±å¯ä»¥äº†ã€‚\nå‚æ•° mapFn ï¼šè®©è½¬æ¢è¿‡ç¨‹ä¸­å¯ä»¥æ”¹å˜è¢«è½¬æ¢å…ƒç´ çš„ç»“æœå€¼ï¼Œæ„æ€å°±æ˜¯å¦‚æœ mapFn ä¼ é€’\nä¸¤ä¸ªåˆæ³•çš„å‡½æ•°ï¼Œéå†è¿‡ç¨‹ä¸­å…ƒç´ çš„å€¼ä¼šè¿›è¿‡ mapFn å…ˆå¤„ç†ä¸€éç„¶ååœ¨è¿”å›åˆ°æ–°çš„æ•°ç»„\nåˆ—è¡¨ä¸­ã€‚\n1 2 3 4 5 6 7 8 9  var obj = { length: 2, \u0026#39;0\u0026#39;: 100, \u0026#39;1\u0026#39;: 200 } var arr = Array.from(obj, v =\u0026gt; v * v); console.log(arr[0], arr[1]); // 10000, 40000   +RESULTS:\n10000 40000  å‚æ•° thisArg ï¼šæŒ‡å®š mapFn çš„ this æŒ‡å‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  var helper = { add: v =\u0026gt; v * v } var obj = { length: 2, \u0026#39;0\u0026#39;: 10, \u0026#39;1\u0026#39;: 20 } var arr = Array.from(obj, helper.add, helper); console.log(arr[0], arr[1]); // 100, 400   +RESULTS:\n100 400  ç”¨äºå¯è¿­ä»£çš„å¯¹è±¡ :\nåœ¨ä¼ªç ä¸­å¯ä»¥çŸ¥é“ Array.from å¯ä»¥å¤„ç†æœ‰è¿­ä»£å™¨çš„ä¹Ÿå¯ä»¥å¤„ç†æ— è¿­ä»£å™¨çš„ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥\nä½¿ç”¨ä¸è‡ªå®šä¹‰è¿­ä»£å™¨çš„å¯¹è±¡ï¼Œè€Œä¸éœ€è¦å…·å¤‡ç±»æ•°ç»„å¯¹è±¡çš„ç‰¹å¾(å¿…é¡»æœ‰ length å’Œæ•°å€¼ç´¢\nå¼•å€¼)\n1 2 3 4 5 6 7 8 9 10 11  var nums = { *[Symbol.iterator]() { yield 1; yield 2; yield 3; } } let nums2 = Array.from(nums, v =\u0026gt; v + 1); console.log(nums2[0], nums2[1], nums2[2]); // 2, 3, 4   +RESULTS:\n2 3 4  å¯¹åº”ä¼ªç ä¸­çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  // åˆ—è¡¨ç±»å‹ï¼Œæœ‰è‡ªå·±çš„è¿­ä»£å™¨ if (usingIterator) { // å–å‡ºåŒæ­¥è¿­ä»£å™¨  let iteratorRecord = GetIterator(items, sync, usingIterator); let k = 0, error; while(1) { // å¾ªç¯å¯åŠ¨è¿­ä»£å™¨ï¼Œç›¸å½“äºè‡ªåŠ¨è°ƒç”¨äº† iterator.next()  // ... çœç•¥  // #1 è°ƒç”¨ iterator.next() å¯åŠ¨è¿­ä»£å™¨ï¼Œå–ä¸‹ä¸€ä¸ª yield å€¼  let next = IteratorStep(iteratorRecord); // ... çœç•¥  // #2 å–å‡ºå½“å‰è¿­ä»£ { value: xxx, done: false } ä¸­çš„ value å€¼  let nextValue = IteratorValue(next); // ... çœç•¥  // #3 å°†è¿­ä»£å‡ºçš„å€¼ï¼Œæ·»åŠ åˆ°æ•°ç»„ Pk ä½ç½®ä¸Šã€‚  let defineStatus = CreateDataPropertyOrThrow(A, Pk, mappedValue); // ... çœç•¥  // #4 è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚  k++; } }   å¦‚ä¸Šï¼Œæˆ‘ä»¬çœç•¥äº†éƒ¨åˆ†ä»£ç ï¼Œåªä¿ç•™æˆ‘æˆ‘ä»¬éœ€è¦å…³æ³¨çš„åœ°æ–¹ï¼š\n GetIterator(items, sync, usingIterator) ä¼šå–å‡º items å¯¹è±¡çš„è¿­ä»£å™¨ while(1) ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œç”¨æ¥è§¦å‘è¿­ä»£å™¨ï¼Œç›¸å½“äº iterator.next() IteratorValue(next) å–å‡ºè¿­ä»£å™¨ {value: xx, done: false} ä¸­ value çš„å€¼ æœ€åå°†å€¼æ·»åŠ åˆ°æ–°æ•°ç»„ A ä¸Šï¼Œ k++ è¿›å…¥ä¸‹ä¸€æ¬¡ iterator.next()  ç”¨äºç±»æ•°ç»„ä¸”å¯è¿­ä»£çš„å¯¹è±¡ :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  let nums = { length: 2, \u0026#39;0\u0026#39;: 100, \u0026#39;1\u0026#39;: 200, *[Symbol.iterator]() { yield 1; yield 2; yield 3; } } var nums2 = Array.from(nums); console.log(nums2.length, nums2[0], nums2[1], nums2[2]);   +RESULTS:\n3 1 2 3  ä»ç»“æœçœ‹å‡ºä½¿ç”¨çš„æ˜¯ Symbol.iterator è¿­ä»£å™¨ä¼˜å…ˆï¼Œè¿™ä»ä¼ªç çš„å¤„ç†è¿‡ç¨‹ä¸­ä¹Ÿå¯ç¡®å®šä¼˜\nå…ˆçº§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  Array.from = function(items[, mapFn[, thisArg]]) { // ...  // å–å‡ºç±»æ•°ç»„å¯¹è±¡çš„è¿­ä»£å™¨ï¼Œå°†ç”¨æ¥å–å‡ºæœ‰æ•ˆçš„æ•°ç»„å…ƒç´   let usingIterator = GetMethod(items, @@iterator); // åˆ—è¡¨ç±»å‹ï¼Œæœ‰è‡ªå·±çš„è¿­ä»£å™¨  if (usingIterator) { // è¿­ä»£å™¨åˆ¤æ–­åœ¨å‰  // .... return  } // éåˆ—è¡¨ç±»å‹ï¼Œæ²¡æœ‰è‡ªå·±çš„è¿­ä»£å™¨ï¼Œå¯èƒ½æ˜¯ä¸ªç±»æ•°ç»„å¯¹è±¡  let arrayLike = ToObject(items); // å¿…é¡»å…·å¤‡é•¿åº¦å±æ€§ï¼Œæ‰èƒ½è½¬æ•°ç»„ï¼Œè¿™ä¹Ÿæ˜¯ç±»æ•°ç»„å¯¹è±¡å¿…å¤‡æ¡ä»¶ä¹‹ä¸€  let len = ToLength(Get(arrayLike, \u0026#39;length\u0026#39;)) // ...  let k = 0; while (k \u0026lt; len) { // ç±»æ•°ç»„å¯¹è±¡çš„åˆ¤æ–­åœ¨å  // ...  } Set(A, \u0026#39;length\u0026#39;, len, true); return A; }   åŸå‹ä¸Šæ–°å¢çš„æ–¹æ³• flat([depth])2019 æ‰å¹³åŒ–æ•°ç»„ï¼Œé™ç»´ã€‚ depth è¡¨ç¤ºé™å¤šå°‘æ¬¡ï¼Œå¦‚æœæ˜¯ Infinity åˆ™æŠŠæ•°ç»„é™ç»´åˆ°ä¸€ç»´æ•°\nç»„ã€‚\n1 2 3  const nums = [1, 2, 3, [4, 5]] console.log(nums.flat()) // [ 1, 2, 3, 4, 5 ]   flatMap()2019 find(mapFn[, thisArg]) \u0026amp; findIndex(mapFn[, thisArg]) æŸ¥æ‰¾å…ƒç´ ï¼Œå†…éƒ¨å®ç°ä¼ªç ã€‚\nä»¥å¾€å¹¶æ²¡æœ‰ä»€ä¹ˆå†…ç½®çš„æ–¹æ³•ç”¨æ¥æŸ¥æ‰¾æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨ indexOf å’Œ\nlastIndexOf æˆ–è€…åˆ©ç”¨ä»–ä»¬å®ç°è‡ªå·±çš„è‡ªå®šä¹‰æ–¹æ³•ã€‚\nECMAScript 6 ä¸­æ–°å¢äº†ä¸¤ä¸ªä¸“é—¨ç”¨æ¥æŸ¥æ‰¾å…ƒç´ çš„ä¸¤ä¸ªæ–¹æ³•ï¼š\n find(mapFn[, thisArg]) è¿”å›æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ å€¼ findIndex(mapFn[, thisArg]) è¿”å›æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ å€¼çš„ç´¢å¼•  ä¸¤ä¸ªæ–¹æ³•çš„ mapFn æ¥å—çš„å‚æ•°ä¸ map() å’Œ forEach() ä¸€æ ·ï¼Œæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š\n value éå†å½“å‰å€¼ index å½“å‰ç´¢å¼• array æ•°ç»„æœ¬èº«  1 2 3 4  let nums = [1, 2, 3, 4]; console.log(nums.find(n =\u0026gt; n \u0026gt; 2)); console.log(nums.findIndex(n =\u0026gt; n \u0026gt; 2));   fill(value[, start[, end]]) fill å†…éƒ¨å®ç°ä¼ªç ã€‚\nä»æŒ‡å®šèµ·å§‹ç»“æŸä½ç½®å°†æ•°ç»„å…ƒç´ æ›¿æ¢æˆ value ã€‚\nå‚æ•°ï¼š\n value required æ›¿æ¢çš„å€¼ start optional, é»˜è®¤(0)ï¼Œ èµ·å§‹ä½ç½® end optional, é»˜è®¤(length)ï¼Œç»“æŸä½ç½®  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  let nums = [1, 2, 3, 4]; nums.fill(1); // 1, 1, 1, 1 console.log(nums.toString()); nums.fill(2, 1); // 1,2,2,2 console.log(nums.toString()); nums.fill(3, 2, 4); // 1,2,3,3 console.log(nums.toString()); // è´Ÿæ•°ï¼Œlen + (-1) = 3 =\u0026gt; fill(1, 3); nums.fill(1, -1); // 1,2,3,1 console.log(nums.toString()); // è´Ÿæ•°ï¼Œlen + (-2) = 2 =\u0026gt; fill(1, 2); nums.fill(1, -2); // 1,2,1,1 console.log(nums.toString()); // è´Ÿæ•°ï¼Œstart: len + -2 = 2 =\u0026gt; fill(1, 2, 1) // 2 \u0026lt; 1 =\u0026gt; start \u0026lt; end =\u0026gt; æ— æ•ˆ nums.fill(1, -2, 1); // 1,2,1,1 console.log(nums.toString()); // start: len + -2 = 2 // end: len + -1 = 3 // =\u0026gt; fill(1, 2, 3) nums.fill(4, -2, -1); // 1,2,4,1 console.log(nums.toString());   +RESULTS:\n1,1,1,1 1,2,2,2 1,2,3,3 1,2,3,1 1,2,1,1 1,2,1,1 1,2,4,1  copyWithin(target, start[, end]) copyWithin å†…éƒ¨å®ç°ä¼ªç ã€‚\næ–¹æ³•åŠŸèƒ½ï¼šæ‹·è´ count = start:0 - end:length ä¹‹é—´çš„å…ƒç´ ï¼Œç”¨è¿™äº›å…ƒç´ ä»\ntarget(num = target:0 - len ) ä½ç½®å¼€å§‹æ›¿æ¢æ•°ç»„å†…çš„å…ƒç´ ï¼Œå®é™…è¢«æ›¿æ¢çš„å…ƒç´ ä¸ªæ•°ç”±\nnum å†³å®šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  let nums = [1, 2, 3, 4, 5, 6, 7, 8, 9]; let res = nums.copyWithin(0, 3, 5); console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; æ‹·è´å…ƒç´ ä¸ªæ•° \u0026lt;= len - èµ·å§‹ä½ç½®\u0026#39;) console.log(res.toString(), \u0026#39;res\u0026#39;) console.log(nums.toString(), \u0026#39;nums\u0026#39;) console.log(nums === res, \u0026#39;res === nums ?\u0026#39;) console.log(\u0026#39;\u0026gt;\u0026gt;\u0026gt; æ‹·è´å…ƒç´ ä¸ªæ•° \u0026gt; len - èµ·å§‹ä½ç½®\u0026#39;) nums = [1, 2, 3, 4, 5, 6, 7, 8, 9]; res = nums.copyWithin(6, 3); console.log(res.toString(), \u0026#39;res\u0026#39;) console.log(nums.toString(), \u0026#39;nums\u0026#39;) console.log(nums === res, \u0026#39;res === nums ?\u0026#39;)   +RESULTS:\n\u0026gt;\u0026gt;\u0026gt; æ‹·è´å…ƒç´ ä¸ªæ•° \u0026lt;= len - èµ·å§‹ä½ç½® 4,5,3,4,5,6,7,8,9 res 4,5,3,4,5,6,7,8,9 nums true 'res === nums ?' \u0026gt;\u0026gt;\u0026gt; æ‹·è´å…ƒç´ ä¸ªæ•° \u0026gt; len - èµ·å§‹ä½ç½® 1,2,3,4,5,6,4,5,6 res 1,2,3,4,5,6,4,5,6 nums true 'res === nums ?'   å¦‚æœ end - start \u0026gt; len - target åˆ™åªæ›¿æ¢ len - target ä¸ªå…ƒç´  å¦‚æœ end - start \u0026lt; len - target åˆ™åªæ›¿æ¢ end - start ä¸ªå…ƒç´   è¢«æ›¿æ¢çš„å…ƒç´ ä¸ªæ•°å†³å®šå› ç´ ï¼š Math.min(end - start, len - target) å–æœ€å°å€¼å¾—ä¸ªæ•°ã€‚\nTODO ç±»å‹åŒ–æ•°ç»„(Typed Arrays) TODO ç±»å‹åŒ–æ•°ç»„å’Œæ™®é€šæ•°ç»„çš„ç›¸ä¼¼ç‚¹ TODO ç±»å‹åŒ–æ•°ç»„å’Œæ™®é€šæ•°ç»„çš„ä¸åŒç‚¹ TODO å°ç»“ Promiseså’Œå¼‚æ­¥ç¼–ç¨‹ Nodejs å¼‚æ­¥ç¼–ç¨‹ï¼šäº‹ä»¶è§¦å‘ + å›è°ƒã€‚\nPromise: æŒ‡å®šä¸€äº›ä»£ç å»¶æ—¶æ‰§è¡Œï¼Œå¹¶ä¸”å¯çŸ¥é“ä»£ç æ˜¯å¦æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ã€‚\nä¸ºäº†æ›´å¥½çš„ç†è§£ Promise å¦‚ä½•å·¥ä½œï¼Œæœ‰å¿…è¦äº†è§£ä¸€äº›ä¸å¼‚æ­¥ç›¸å…³çš„åŸºæœ¬æ¦‚å¿µã€‚\nPromise Apis Promise.prototype.finally(onFinally) ä¸ç®¡å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æœå¦‚ä½•ï¼Œéƒ½ä¼šåœ¨ä»»åŠ¡éƒ½å®Œæˆä¹‹åè¢«æ‰§è¡Œçš„ä»£ç ã€‚\n1 2 3 4 5 6 7 8 9 10  new Promise((resolve, reject) =\u0026gt; { setTimeout(() =\u0026gt; { resolve() }, 2000) }).then(() =\u0026gt; { console.log(\u0026#39;p then\u0026#39;) }).finally(() =\u0026gt; { console.log(\u0026#39;p finally\u0026#39;) })   å¼‚æ­¥ç¼–ç¨‹èƒŒæ™¯ JavaScript å¼•æ“åŸºäºäº‹ä»¶å¾ªç¯çš„å•çº¿ç¨‹ï¼Œå•çº¿ç¨‹æ„å‘³ç€ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»£ç ç‰‡æ®µã€‚\nå› æ­¤ JavaScript å¼•æ“å°±éœ€è¦å»è·Ÿè¸ªå’Œç®¡ç†è¿™äº›ä»£ç ç‰‡æ®µï¼Œè€Œè¿™äº›ä»£ç ç‰‡æ®µä¼šè¢«ä¸€ä¸ªå«â€œä»»\nåŠ¡é˜Ÿåˆ—â€çš„ä¸œè¥¿æ‰€æŒæœ‰ï¼Œæ— è®ºä»€ä¹ˆæ—¶å€™å¦‚æœä»£ç å‡†å¤‡æ‰§è¡Œï¼Œå®ƒå°±ä¼šè¢«æ·»åŠ åˆ°â€œä»»åŠ¡é˜Ÿåˆ—â€ï¼Œå½“\nä»£ç è¢«æ‰§è¡Œå®Œæˆï¼Œï¼Œäº‹ä»¶å¾ªç¯å°±ä¼šå¼€å§‹æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚\nåœ¨é˜Ÿåˆ—ä¸­ï¼Œä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ€»æ˜¯ä»ç¬¬ä¸€ä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œåˆ°æœ€åä¸€ä¸ªäººä»»åŠ¡æ‰§è¡Œç»“æŸã€‚\näº‹ä»¶æ¨¡å‹ æ¯”å¦‚ï¼Œç”¨æˆ·ç‚¹å‡»äº†ä¸€ä¸ªé”®ç›˜ä¸Šçš„æŒ‰é”®ï¼Œè§¦å‘ç‚¹å‡»(onclick)äº‹ä»¶ï¼Œé‚£ä¹ˆå¼•æ“ä¼šé€šè¿‡åœ¨ä»»åŠ¡\né˜Ÿåˆ—çš„æœ«å°¾æ·»åŠ ä¸€ä¸ªæ–°çš„ä»»åŠ¡æ¥å“åº”è¿™ä¸ªäº‹ä»¶ï¼Œè¿™ä¹Ÿæ˜¯ JavaScript ä¸­æœ€åŸºæœ¬çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡\nå‹ï¼Œè¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„äº‹ä»¶çš„å›è°ƒå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œç›´åˆ°äº‹ä»¶è¢«è§¦å‘ï¼Œä¸”è¢«è§¦å‘æ‰§è¡Œå›è°ƒæ—¶\nå€™ä¼šæ‹¥æœ‰è‡ªå·±åˆé€‚çš„ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒã€‚\næ¯”å¦‚ï¼š\n1 2 3 4  let button = document.getElementById(\u0026#34;my-btn\u0026#34;); button.onclick = function(event) { console.log(\u0026#34;Clicked\u0026#34;); };   ä¸Šé¢çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨æŒ‰é’®ç‚¹å‡»ä¹‹å‰æ˜¯ä¸ä¼šè¢«æ‰§è¡Œï¼Œä¸€æ—¦æŒ‰é’®è¢«ç‚¹å‡»ï¼Œé‚£ä¹ˆèµ‹å€¼ç»™\nonclick çš„ä»£ç ç‰‡æ®µ(æˆ–å«â€œä»»åŠ¡â€)å°±ä¼šç«‹å³è¢«æ·»åŠ åˆ°â€œä»»åŠ¡é˜Ÿåˆ—â€çš„æœ«å°¾ï¼Œç­‰å¾…å®ƒå‰é¢çš„å…¶\nä»–ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œ(ä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¸€å®šç‚¹å‡»ä¹‹åç«‹å³æ‰§è¡Œï¼Œå‰é¢å¯èƒ½è¿˜æœ‰å…¶ä»–ä»»åŠ¡\nåœ¨ç­‰å¾…æ‰§è¡Œ)ã€‚\nå›è°ƒæ¨¡å¼ åœ¨ JavaScript ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å¼‚æ­¥è«è¿‡äºå›è°ƒçš„ä½¿ç”¨äº†ï¼Œæ¯”å¦‚åœ¨è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œ\nè¯»å–å®Œæˆä¹‹åè¦åšä¸€äº›å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šç”¨åˆ°å›è°ƒå‡½æ•°ï¼Œå› ä¸ºè¯»å–æ–‡ä»¶ç›¸å¯¹æ¥è¯´æ˜¯ä¸€ä¸ªæ¯”\nè¾ƒè€—æ—¶çš„æ“ä½œï¼Œä¸å¤ªå¯èƒ½ä½¿ç”¨åŒæ­¥è¿›è¡Œå¤„ç†ï¼Œå› æ­¤é€šè¿‡å›è°ƒæ¥å¤„ç†å¼‚æ­¥è¯»å–æ–‡ä»¶æ˜¯ä¸ªéå¸¸ä¸\né”™çš„ä½“éªŒã€‚\næ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8  readFile(\u0026#34;example.txt\u0026#34;, function(err, contents) { if (err) { throw err; } console.log(contents); }); console.log(\u0026#34;Hi!\u0026#34;);   åœ¨è¯»å– example.txt æ–‡ä»¶å†…å®¹ä¹‹åå°†å…¶ç«‹å³ç­”åº”å‡ºæ¥ï¼Œè¿™é‡Œçš„å›è°ƒå‡½æ•°å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œ\nè€Œæ˜¯åœ¨æ–‡ä»¶è¯»å–å®Œæˆä¹‹åï¼Œä¼šç«‹å³è¢«æ·»åŠ åˆ°â€œä»»åŠ¡é˜Ÿåˆ—â€çš„åˆ—å°¾ï¼Œåœ¨å…¶ä»–åœ¨å®ƒå‰é¢çš„ä»»åŠ¡æ‰§è¡Œ\nå®Œæˆä¹‹åä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œè¿™å’Œä¸Šé¢è®²çš„â€œäº‹ä»¶æ¨¡å‹â€æ˜¯ä¸€æ ·çš„åŸç†ã€‚\nè¿™ç›¸å¯¹æ¥è¯´è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œè¾“å‡ºè¿™ç§ç®—æ˜¯æ¯”è¾ƒç®€å•çš„åº”ç”¨åœºæ™¯ï¼Œè€Œç°å®ä¸­å¾€å¾€å¹¶ä¸\næ˜¯è¿™æ ·çš„ï¼Œç°å®ä¸­å¾€å¾€æ˜¯å¤šä¸ªäº‹æƒ…ä¹‹é—´æœ‰å…¶å…³è”æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å·¥äººåœ¨æµæ°´çº¿ä¸Šå·¥ä½œçš„æ—¶å€™ï¼Œ\nå°±å¿…é¡»ä¾èµ–äºä¸Šä¸€ä¸ªäººå·¥ä½œçš„ä¼ é€’æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè¿™å¦‚æœä½“ç°åœ¨ä»£ç ä½¿ç”¨å›è°ƒå®Œæˆè¿™å°†\nä¼šä¸å¯æ€è®®(è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å›è°ƒåœ°ç‹±é—®é¢˜)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  method1(function(err, result) { if (err) { throw err; } method2(function(err, result) { if (err) { throw err; } method3(function(err, result) { if (err) { throw err; } method4(function(err, result) { if (err) { throw err; } method5(result); }); }); }); });   method4 å¿…é¡»ç­‰å¾… method3 æ‰§è¡Œå®Œæˆï¼Œ\nmethod3 å¿…é¡»ç­‰å¾… method2 æ‰§è¡Œå®Œæˆï¼Œ\nâ€¦\nä¸€ç›´åˆ° method1 æ‰§è¡Œå®Œæˆï¼Œè¿™æ— è®ºæ˜¯åœ¨é€»è¾‘è¿˜æ˜¯ä»£ç é˜…è¯»æ€§ä¸Šéƒ½å°†ä¼šè®©äººå´©æºƒã€‚\nä¸€ç›´åˆ° Promise çš„å‡ºç°æ‰æ¯”è¾ƒæœ‰æ•ˆçš„è§£å†³äº†è¿™å›è°ƒåœ°ç‹±åŠä»£ç å¯è¯»æ€§çš„é—®é¢˜ã€‚\nPromise åŸºç¡€ ä¸€ä¸ª promise å®ä¾‹ä½œä¸ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœè¿”å›ï¼Œè€Œä¸å†ä½¿ç”¨æ—¶é—´ç»‘å®šæˆ–å°†å›è°ƒä½œä¸ºå‚æ•°\nä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°çš„æ–¹å¼ï¼Œç°åœ¨ä¸€ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥è¿”å›ä¸€ä¸ª promise ï¼Œæ¯”å¦‚ï¼š\n1  let promise = readFile(\u0026#39;example.txt\u0026#39;);   ä¸Šé¢çš„ä»£ç ä¸­è¯»å–æ–‡ä»¶æ“ä½œå®é™…ä¸Šå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›äº†ä¸€ä¸ª promise å¯ä»¥è®©ä½ å†³\nå®šå¦‚ä½•å»å“åº”è¿™ä¸ªè¯»å–æ–‡ä»¶æ“ä½œã€‚\nPromise çš„ç”Ÿå‘½å‘¨æœŸ   pending, è¡¨ç¤ºå¼‚æ­¥æ“ä½œå°šæœªå®Œæˆï¼Œä¹Ÿè¢«æ ‡è®°ä¸º unsettled ã€‚\næ¯”å¦‚ let promise = readFile('example.txt'); æ‰§è¡Œä¹‹åï¼Œè¿™ä¸ª promise çŠ¶æ€å°±\næˆä¸ºäº† pending ä¸€æ—¦æ–‡ä»¶è¯»å–æ“ä½œå®Œæˆï¼Œè¯¥ promise å°±ä¼šè¢«è®¾ç½®ä¸º settled ï¼Œéš\nåè¿›å…¥ä¸‹é¢ä¸¤ç§çŠ¶æ€çš„ä¸€ç§ï¼Œä¸”ä¸å¯é€†ã€‚\n  Fulfilled : è¡¨ç¤ºè¯¥ promise ä»£è¡¨çš„å¼‚æ­¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ\n  Rejected : è¡¨ç¤ºè¯¥ promise ä»£ç çš„å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥äº†æˆ–è€…æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ç­‰å…¶\nå®ƒéæ­£å¸¸ç»“æœã€‚\n  ä¸” promise æœ‰ä¸ªå†…éƒ¨å±æ€§ [[PromiseState] ] ç”¨æ¥è®°å½•äº†æ•´ä¸ª promise çŠ¶æ€çš„å˜åŒ–ï¼Œ\nå®ƒçš„å€¼ç”±ä¸‰ä¸ªï¼š pending, fulfilled, rejected å¯¹åº”ç€ promise çš„ä¸‰ç§ä¸åŒçŠ¶æ€ã€‚\nè¯¥å†…éƒ¨å±æ€§æ²¡æœ‰å¯¹å¤–çš„æ¥å£ï¼Œå› æ­¤æ˜¯æ— æ³•ç›´æ¥å»è®¿é—®æˆ–æ“ä½œå®ƒçš„ï¼Œä½†æ˜¯ promise æä¾›äº†ä¸€\nä¸ª then() æ–¹æ³•ï¼Œå¯ä»¥æ¥å—å¤„ç†çš„ç»“æœ(fulfilled æˆ– rejected)ã€‚\nthen(fulfilled, rejected) æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸ºå‡½æ•°ç±»å‹ï¼Œç¬¬ä¸€ä¸ªä¼šåœ¨\npromise çŠ¶æ€å˜æˆ fulfilled çš„æ—¶å€™è°ƒç”¨ï¼Œç¬¬äºŒä¸ªåˆ™ä¼šåœ¨ rejected çŠ¶æ€ä¸‹è°ƒç”¨ã€‚\nfulfilled(data) : å‡½æ•°ä¼šæ¥å— promise æˆåŠŸä¹‹åä¼ é€’å‡ºæ¥çš„æ•°æ®ã€‚\nrejected(error) : å‡½æ•°ä¼šæ¥å— promise å¤±è´¥ä¹‹åè§¦å‘çš„å¼‚å¸¸æ•°æ®ã€‚\n ä»»æ„å¯¹è±¡åªè¦å®ç°äº† then() æ–¹æ³•éƒ½å¯ä»¥å«åšä¸€ä¸ª thenable ï¼Œæ‰€æœ‰çš„ promises éƒ½æ˜¯\nthenable çš„ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ thenable éƒ½æ˜¯ promises ã€‚\n ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  let fs = require(\u0026#39;fs\u0026#39;) let promise = new Promise(function(resolve, reject) { fs.readFile(__dirname + \u0026#39;/config.json\u0026#39;, (err, data) =\u0026gt; { if (err) { reject(err) } else { resolve(data) } }) }) console.log(promise)   +RESULTS: ä¸Šé¢ä»£ç æˆ‘ä»¬åªæ˜¯å°†è¯»å–æ–‡ä»¶æ“ä½œåŒ…è£…æˆäº†ä¸€ä¸ª promise ä½†æ˜¯å¹¶æ²¡æœ‰ç«‹å³å»è¯»\nå–æ–‡ä»¶ï¼Œä¸”æ­¤åˆ» promise çš„çŠ¶æ€æ˜¾ç¤ºä¸º pending ã€‚\nPromise { \u0026lt;pending\u0026gt; }  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  let fs = require(\u0026#39;fs\u0026#39;) let promise = new Promise(function(resolve, reject) { fs.readFile(__dirname + \u0026#39;/config.json\u0026#39;, (err, data) =\u0026gt; { if (err) { reject(err) } else { resolve(data) } }) }) // å°†è§¦å‘ promise çŠ¶æ€å‘ç”Ÿæ”¹å˜ promise.then(data =\u0026gt; { console.log(promise) console.log(data) }, err =\u0026gt; { console.log(promise) console.log(err) }) console.log(promise)   +RESULTS: promise æˆåŠŸä¹‹åçš„è¾“å‡ºï¼ŒçŠ¶æ€å°†æˆä¸º fulfilled (è¿™é‡Œæ²¡è¾“å‡ºå‡ºæ¥ï¼Œo(â•¯â–¡â•°)o)ã€‚\nPromise { \u0026lt;pending\u0026gt; } Promise { \u0026lt;Buffer 49 27 6d 20 61 20 70 72 6f 6d 69 73 65 20 65 78 61 6d 70 6c 65 2e 2e 2e 2e 2e 2e 0a\u0026gt; } \u0026lt;Buffer 49 27 6d 20 61 20 70 72 6f 6d 69 73 65 20 65 78 61 6d 70 6c 65 2e 2e 2e 2e 2e 2e 0a\u0026gt;  +RESULTS: è¯»å–å¤±è´¥ä¹‹åçŠ¶æ€ä¸º rejected çš„è¾“å‡ºã€‚\nPromise { \u0026lt;pending\u0026gt; } Promise { \u0026lt;rejected\u0026gt; { Error: ENOENT: no such file or directory, open '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json' errno: -2, code: 'ENOENT', syscall: 'open', path: '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json' } } { [Error: ENOENT: no such file or directory, open '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json'] errno: -2, code: 'ENOENT', syscall: 'open', path: '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json' }  promise ä¹Ÿæä¾›äº†ä¸€ä¸ª catch() æ¥å£ç»™æˆ‘ä»¬ç”¨æ¥æ•è·å¼‚å¸¸ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­è¿˜å¯ä»¥è¿™æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  let fs = require(\u0026#39;fs\u0026#39;) let promise = new Promise(function(resolve, reject) { fs.readFile(__dirname + \u0026#39;/config.json\u0026#39;, (err, data) =\u0026gt; { if (err) { reject(err) } else { resolve(data) } }) }) // å°†è§¦å‘ promise çŠ¶æ€å‘ç”Ÿæ”¹å˜ promise.then(data =\u0026gt; { console.log(promise) console.log(data) }, err =\u0026gt; { console.log(\u0026#39;error in then\u0026#39;) console.log(err) }).catch(function(err) { console.log(\u0026#39;error in catch\u0026#39;) console.log(err) }) console.log(promise)   +RESULTS: ç»“æœæ˜¯ then ä¸­å’Œ catch ä¸­éƒ½æœ‰æ‰§è¡Œ\nPromise { \u0026lt;pending\u0026gt; } error in then { [Error: ENOENT: no such file or directory, open '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json'] errno: -2, code: 'ENOENT', syscall: 'open', path: '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json' }  ä½¿ç”¨ promise æœ‰ä¸ªå¥½å¤„å°±æ˜¯ï¼Œæ¯”å¦‚ä¸Šé¢çš„é‡åˆ°æ‰§è¡Œå¼‚å¸¸ï¼Œå®ƒä¼šå°†å¼‚å¸¸æ•è·å¹¶å¤„æš´éœ²å‡ºæ¥ï¼Œ\nä¸€æ—¦å‡ºç°å¼‚å¸¸ï¼Œæˆ–æ‰§è¡Œå¤±è´¥ promise çš„çŠ¶æ€ä¼šç«‹å³æˆä¸º rejected ï¼Œä¸”æ— æ³•é€†è½¬ï¼Œå³è¯¥\npromise å·²ç»å½»åº•å®Œæˆ(æ— å…³æˆåŠŸæˆ–å¤±è´¥)ã€‚\nè€Œäº‹ä»¶æ¨¡å‹ä¸­å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¯¥äº‹ä»¶å°±ä¸ä¼šè¢«è§¦å‘ï¼Œè€Œåœ¨å›è°ƒä¸­ä½ å°±å¿…é¡»æ—¶å¸¸è®°ä½å»æ£€æŸ¥å¼‚\nå¸¸æƒ…å†µçš„å‡ºç°å¯èƒ½æ€§ï¼Œå¹¶ä½œå‡ºç›¸åº”çš„å¤„ç†ã€‚\nè€Œåœ¨ promise ä¸­å¼‚å¸¸ä¼šè¢«æ•è·ï¼Œå¦‚æœä½ æƒ³é’ˆå¯¹å¼‚å¸¸åšå¤„ç†å¯ä»¥ä½¿ç”¨ then-reject æˆ–\ncatch() éƒ½è¡Œï¼Œå¦‚æœä¸æƒ³å¤„ç†å°±é™é»˜ç»“æŸ promise å³å¯ï¼Œè€Œä¸ç”¨å…³å¿ƒæ˜¯å¦ä¼šå¯¼è‡´ä»»åŠ¡å¤±\nè´¥è€Œä¸­æ–­ä¸šåŠ¡ã€‚\nä¸€ä¸ª fufillment æˆ– rejection çš„ä»»åŠ¡ï¼Œå¦‚æœåœ¨ promise çŠ¶æ€å·²ç»å‘ç”Ÿæ”¹å˜(settled,\næˆä¸º fulfilled æˆ– rejected )çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶æ·»åŠ äº†æ–°çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå®ƒä¾æ—§ä¼šç»§ç»­æ‰§\nè¡Œã€‚å…¶å®è¿™ä¹Ÿå°±ç›¸å½“äºç»™å…¶èµ‹äºˆäº†ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  let promise = readFile(\u0026#34;example.txt\u0026#34;); // original fulfillment handler promise.then(function(contents) { console.log(contents); // #1 now add another  promise.then(function(contents) { console.log(contents); }); });   #1 å¤„ç›¸å½“äºé’ˆå¯¹ promise åˆåœ¨ä»»åŠ¡é˜Ÿåˆ—æœ«å°¾æ–°å¢äº†ä¸€ä¸ªä»»åŠ¡ï¼Œç­‰å¾…è¢«æ‰§è¡Œã€‚\nåˆ›å»º unsettled Promises é€šè¿‡ Promise æ„é€ å‡½æ•°å¯ä»¥åˆ›å»ºä¸€ä¸ª unsettled çŠ¶æ€çš„ promise å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  let fs = require(\u0026#39;fs\u0026#39;) function readFile(name) { return new Promise(function(resolve, reject) { console.log(\u0026#39;...outer\u0026#39;) fs.readFile(__dirname + \u0026#39;/config.json\u0026#39;, (err, data) =\u0026gt; { console.log(\u0026#39;...inner\u0026#39;) if (err) { reject(err) } else { resolve(data) } }) }) } // å¾—åˆ°äº†ä¸€ä¸ª pending - unsettled çš„ promise let promise = readFile() // è§¦å‘ promise ä»»åŠ¡ï¼ŒçŠ¶æ€å°†å˜æˆ settled: fulfilled æˆ– rejected // #1 promise.then(data =\u0026gt; console.log(data), err =\u0026gt; console.log(err)) console.log(promise)   +RESULTS: #1 æ³¨é‡Šä¹‹åçš„è¾“å‡ºç»“æœï¼ŒPromise çš„å‚æ•°å‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚\n...outer Promise { \u0026lt;pending\u0026gt; } ...inner  +RESULTS: fulfilled ç»“æœ\nPromise { \u0026lt;pending\u0026gt; } \u0026lt;Buffer 49 27 6d 20 61 20 70 72 6f 6d 69 73 65 20 65 78 61 6d 70 6c 65 2e 0a\u0026gt;  +RESULTS: rejected ç»“æœ\nPromise { \u0026lt;pending\u0026gt; } { [Error: ENOENT: no such file or directory, open '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/config.json'] errno: -2, code: 'ENOENT', syscall: 'open', path: '/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/config.json' }   Promise éœ€è¦ä¸€ä¸ªå‚æ•°ä½œä¸ºå‚æ•° è¯¥å‡½æ•°çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼š1ï¼‰resolve ä»»åŠ¡æ‰§è¡ŒæˆåŠŸä¹‹åè°ƒç”¨ï¼Œ2ï¼‰reject ä»»åŠ¡å¤±è´¥è°ƒç”¨ åˆ›å»ºæˆåŠŸä¹‹åä¼ é€’ç»™ Promise çš„å‡½æ•°ä¼šç«‹å³æ‰§è¡Œï¼Œå¹¶ä¸”å°†ä¼šåœ¨ä»»åŠ¡é˜Ÿåˆ—æœ«å°¾æ·»åŠ ä¸€ä¸ªä»»\nåŠ¡å»å¤„ç†è¿™ä¸ª promiseï¼Œè¿™è¢«ç§°ä¸ºâ€œä»»åŠ¡è°ƒåº¦â€ã€‚ å‚æ•°å‡½æ•°ç«‹å³æ‰§è¡Œï¼Œä½†æ˜¯ resolve å’Œ reject ä¼šè¢«å½“åšå¼‚æ­¥ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—æœ«å°¾å»\nç­‰å¾…æ‰§è¡Œã€‚  åˆ›å»º settled Promises  Promise.resolve() ä¼šåˆ›å»ºä¸€ä¸ªçŠ¶æ€å¿…å®šæ˜¯ fullfilled çš„ promise Promise.reject() ä¼šåˆ›å»ºä¸€ä¸ªçŠ¶æ€å¿…å®šæ˜¯ rejected çš„ promise  1 2 3 4 5  let promise = Promise.resolve(42); promise.then(function(value) { console.log(value) })   +RESULTS:\n42  Promise.resolve() åˆ›å»ºçš„ promise çŠ¶æ€æ°¸è¿œåªä¼šæ˜¯ fulfilled å› æ­¤ï¼Œ reject å‡½æ•°\næ˜¯æ°¸è¿œä¸ä¼šæ‰§è¡Œçš„ï¼ŒåŒç† =Promise.reject()=ã€‚\n1 2 3 4 5 6 7 8  let promise = Promise.reject(100) promise.then(null, function(value) { console.log(value, \u0026#39;1\u0026#39;) }) promise.catch(function(value) { console.log(vlaue, \u0026#39;2\u0026#39;) })   +RESULTS:\n100 '1'   å¦‚æœç»™ Promise.resolve() æˆ– Promise.reject() ä¼ é€’äº†ä¸€ä¸ª promise é‚£ä¹ˆå®ƒä»€ä¹ˆéƒ½\nä¸ä¼šåšï¼Œç›´æ¥åŸæ ·è¿”å›è¿™ä¸ª promise ã€‚\n é Promise çš„ Thenables é Promise çš„ Thenable : å¯¹è±¡æœ‰è‡ªå·±çš„ then(resolve,reject) æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿\nç”¨ Promise.resolve() æˆ– Promise.reject() å°†è¯¥ thenable è½¬å˜æˆä¸€ä¸ª\nfulfilled æˆ– rejected çš„ promiseï¼Œè‡³äºåˆ°åº•æ˜¯å“ªä¸ªçŠ¶æ€çš„è¦å–å†³äº thenable å‡½æ•°\nå†…éƒ¨æ˜¯æ‰§è¡Œäº† resolve() è¿˜æ˜¯ reject() ã€‚\n1 2 3 4 5 6 7 8 9 10 11  let thenable = { then: function(resolve, reject) { resolve(42) } } // å˜æˆäº†ä¸€ä¸ª Fulfilled promise let p1 = Promise.resolve(thenable) p1.then(function(value) { console.log(value) })   +RESULTS:\n42  1 2 3 4 5 6 7 8 9 10 11 12  let thenable = { then: function(resolve, reject) { reject(42) } } // å˜æˆäº†ä¸€ä¸ª Fulfilled promise let p1 = Promise.resolve(thenable) p1.catch(function(value) { console.log(value) })   +RESULTS:\n42  æ‰§è¡Œå¼‚å¸¸ Promise ä¼šåœ¨å…¶å†…éƒ¨å°†ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä½¿ç”¨ try...catch æ•è·åˆ°å¼‚å¸¸ï¼Œç„¶åé€šè¿‡\nthen(null, reject) æˆ– catch(function(error){}) å°†å¼‚å¸¸æš´éœ²å‡ºæ¥ã€‚\n1 2 3 4 5 6 7 8  let promise = new Promise(function(resolve, reject) { throw new Error(\u0026#39;Explosion!\u0026#39;) }) promise.catch(function(error) { console.log(error) })   +RESULTS:\nError: Explosion! at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/js-script-7ANcUx:3:9 at new Promise (\u0026lt;anonymous\u0026gt;) at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/js-script-7ANcUx:2:15  ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ•è·å¼‚å¸¸è°ƒç”¨ reject() :\n1 2 3 4 5 6 7 8 9 10 11 12 13  let promise = new Promise(function(resolve, reject) { try { throw new Error(\u0026#39;Explosion!\u0026#39;) } catch(err) { reject(err) } }) promise.catch(function(error) { console.log(error) })   +RESULTS: ç»“æœæ˜¯ä¸€æ ·çš„\nError: Explosion! at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/js-script-oIepKJ:4:11 at new Promise (\u0026lt;anonymous\u0026gt;)  å…¨å±€ Promise Rejection å¤„ç† åœ¨ä¹‹å‰çš„ç« èŠ‚æˆ‘ä»¬è®²è¿‡ï¼Œå¦‚æœ promise ä¸­çš„çŠ¶æ€å˜æˆ rejected ï¼Œå¯èƒ½æ˜¯ä»»åŠ¡å¤±è´¥ï¼Œæˆ–\nä»£ç æ‰§è¡Œå¼‚å¸¸äº†ï¼Œè€Œè¿™äº›å¼‚å¸¸å®é™…ä¸Šè¢«æ•è·äº†ï¼Œå¯ä»¥é€šè¿‡ then(null, reject) çš„\nreject æ¥æ¥å—æˆ–ä½¿ç”¨ catch(function(err){} æ•è·ã€‚\næ­£å¼ç”±äºè¿™ç§çµæ´»æ€§å¯¼è‡´æˆ‘ä»¬å¾ˆéš¾å†³å®šè¿™äº›å¼‚å¸¸ä»€ä¹ˆæ—¶å€™åº”è¯¥è¢«å¤„ç†ï¼Œå“ªäº›æœ‰è¢«å¤„ç†ï¼Œå“ªäº›\næ²¡æœ‰è¢«å¤„ç†ï¼Œå“ªäº›åˆæ˜¯ä»€ä¹ˆæ—¶å€™è¢«å¤„ç†äº†???\næ¯”å¦‚ promise çŠ¶æ€å·²ç» rejected å®Œæˆäº†ï¼Œä½†æ˜¯ rejection ç›¸å…³çš„å¤„ç†å´å¹¶æ²¡æœ‰åœ¨åˆ\né€‚çš„æ—¶å€™å¾—åˆ°å¤„ç†ï¼Œå› ä¸ºè¿™å®Œå…¨å–å†³äºç¼–ç¨‹è€…æ„¿ä¸æ„¿æ„æˆ–ä»€ä¹ˆæ—¶å€™å»è°ƒç”¨ then(null, reject) æˆ– catch(function(err){} å»å¤„ç†ã€‚\nåœ¨ ECMAScript6 ç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰æ¶‰åŠåˆ°è¯¥é—®é¢˜çš„è§£å†³ã€‚\nåœ¨æµè§ˆå™¨ç«¯å’Œ Node.js å·²ç»æ›´æ–°è§£å†³äº†è¯¥ç—›ç‚¹é—®é¢˜ï¼Œä½†è¿™å¹¶éæ˜¯ ECMAScript 6 çš„ä¸€éƒ¨åˆ†ã€‚\nNode.js Rejection å¤„ç† åœ¨ Node.js ä¸­æœ‰ä¸¤ä¸ª process å¯¹è±¡ä¸Šçš„äº‹ä»¶ä¸ promise rejection å¤„ç†ç›¸å…³ï¼š\n unhandledRejection: åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ä¸€ä¸ª promise çŠ¶æ€å·²ç» rejected äº†ï¼Œä½†\næ˜¯æ²¡æœ‰ä»»ä½• rejection æ“ä½œè¢«è°ƒç”¨çš„æ—¶å€™è§¦å‘ã€‚ rejectionHandled: ä¸ä¸Šé¢çš„ç›¸åï¼Œè¡¨ç¤ºçŠ¶æ€ rejected äº†ï¼Œä¸”æœ‰ç›¸å…³çš„ rejection\næ“ä½œè¢«è°ƒç”¨ã€‚  unahdnledRejection äº‹ä»¶çš„å›è°ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ reason å¤±è´¥åŸå› ï¼Œä¸€ä¸ªæ˜¯è¯¥\npromise å¯¹è±¡æœ¬èº«ï¼Œå¦‚ï¼š\n1 2 3 4 5 6 7 8  let rejected process.on(\u0026#39;unhandledRejection\u0026#39;, function(reason, promise) { console.log(reason.message) console.log(rejected === promise) }) rejected = Promise.reject(new Error(\u0026#39;Explosion!\u0026#39;))   +RESULTS:\nExplosion! true  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  let rejected process.on(\u0026#39;unhandledRejection\u0026#39;, function(reason, promise) { console.log(reason.message, \u0026#39;unhandledrejection\u0026#39;) console.log(rejected === promise, \u0026#39;unhandledrejection\u0026#39;) }) process.on(\u0026#39;rejectionHandled\u0026#39;, function(promise) { console.log(rejected === promise, \u0026#39;rejectionHandled\u0026#39;) }) rejected = Promise.reject(new Error(\u0026#39;Explosion!\u0026#39;)) setTimeout(() =\u0026gt; rejected.catch(function(err) { console.log(err.message, \u0026#39;catch\u0026#39;) }), 1000)   +RESULTS:\nExplosion! unhandledrejection true 'unhandledrejection' Explosion! catch true 'rejectionHandled'  å¦‚ä¸Šç»“æœï¼Œé¦–å…ˆè§¦å‘çš„æ˜¯ unhandledRejection äº‹ä»¶ï¼Œ1 ç§’ä¹‹å rejection è¢«\ncatch() å¤„ç†æ‰äº†ï¼Œè§¦å‘ rejectionHandled äº‹ä»¶ã€‚\næœ‰äº†ä¸Šé¢çš„åŸºç¡€ï¼Œæˆ‘ä»¬è¿™é‡Œå°±å¯ä»¥å®ç°ä¸€ä¸ªç®€æ˜“çš„ unhandled rejections tracker ï¼Œæ¥\nè·Ÿè¸ªå“ªäº› promise çš„ rejection æœ‰è¢«å¤„ç†ï¼Œå“ªäº›æ²¡æœ‰è¢«å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥é’ˆå¯¹è¿™äº›\nrejection åšäº›ä»€ä¹ˆäº‹æƒ…ã€‚\n ä½¿ç”¨ Map ç»“æ„ä¿å­˜ promise =\u0026gt; reason å½“å‰ Promise å’Œå®ƒçš„ rejection æ²¡æœ‰è¢«\nå¤„ç†çš„åŸå› ã€‚ ç›‘å¬ unhandledRejection äº‹ä»¶ï¼Œåœ¨è¿™é‡Œé¢å°† promise=\u0026gt;reason æ·»åŠ åˆ° mapã€‚ ç›‘å¬ rejectionHandled äº‹ä»¶ï¼Œè¿™é‡Œæ‰§è¡Œåˆ é™¤ï¼Œå› ä¸º rejection å·²ç»è¢«å¤„ç†ï¼Œä¸éœ€è¦\nå†ä¿ç•™äº†ã€‚  è¿™é‡Œä½¿ç”¨çš„æ˜¯å¼ºå¼•ç”¨ç±»å‹çš„ Map ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿç”¨åˆ°çš„ promise å¼•ç”¨å»è·å–å½“å‰çš„\npromise æ‰§è¡Œè®¾ç½®æˆ–åˆ é™¤å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  // éœ€è¦ä½¿ç”¨ Map å¼ºå¼•ç”¨ç±»å‹ï¼Œå› ä¸º unhandledRejection å’Œ rejectionHandled // éœ€è¦ç”¨åˆ°åŒä¸€ä¸ª promise let possiblyUnhandledRejections = new Map() process.on(\u0026#39;unhandledRejection\u0026#39;, function(reason, promise) { possiblyUnhandledRejections.set(promise, reason) }) process.on(\u0026#39;rejectionHandled\u0026#39;, function(promise) { possiblyUnhandledRejections.delete(promise) }) function handleRejection(promise, reason) { // ... å¯¹æ¯ä¸ª promise çš„ rejection è¿›è¡Œå¤„ç† } setInterval(function() { // æ¯éš” 6 ç§’æ£€æŸ¥ä¸€æ¬¡ rejections ï¼Œå¦‚æœæœ‰æœªå¤„ç†çš„ rejection å°±ç«‹å³å¤„ç†æ‰  possiblyUnhandledRejections.forEach(function(reason, promise) { console.log(reason.message || reason) handleRejection(promise, reason) }) // å¤„ç†å®Œæˆä¹‹åæ¸…ç©º rejections  possiblyUnhandledRejections.clear() }, 6000)   ä¸Šé¢çš„ä»£ç åŠŸèƒ½ï¼šæ¯éš” 6 ç§’ç›‘å¬ä¸€æ¬¡æœªå¤„ç†çš„ promise rejections çš„æƒ…å†µï¼Œå¦‚æœæœ‰æœªå¤„\nç†çš„ï¼Œå°±ç«‹å³å°†å®ƒå¤„ç†æ‰ï¼Œç„¶åæ¸…ç©º map ï¼Œè¿™æ ·å°±ä¸ä¼šå­˜åœ¨æ²¡æœ‰è¢«å¤„ç†çš„ rejections\näº†ã€‚\næµè§ˆå™¨ Rejection å¤„ç† åœ¨æµè§ˆå™¨ç«¯ä¹Ÿæ˜¯é€šè¿‡ç›‘å¬ä¸¤ä¸ªåŒåçš„äº‹ä»¶æ¥å¤„ç†è¿™äº› rejections ï¼Œä½¿ç”¨æ–¹å¼åŸºæœ¬ç›¸åŒï¼Œåª\néœ€è¦æ³¨æ„å‡ ç‚¹ï¼š\n unhandledRejection å’Œ rejectionHandled ä¸¤ä¸ªäº‹ä»¶æ˜¯åœ¨ window å¯¹è±¡ä¸Š äº‹ä»¶çš„å¤„ç†å¥æŸ„çš„å‚æ•°åªæœ‰ä¸€ä¸ª event ï¼ŒæŒ‡å‘çš„æ˜¯å½“å‰äº‹ä»¶å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å†…åŒ…å«ä¸‰ä¸ª\næˆ‘ä»¬æ„Ÿå…´è¶£çš„å†…å®¹ï¼š  type : äº‹ä»¶ç±»å‹ï¼Œ unhandledRejection æˆ– rejectionHandled promise : å½“å‰çš„ promise å¯¹è±¡ reason : å½“å‰çš„ rejection äº§ç”Ÿçš„åŸå›     1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let rejected; window.onunhandledrejection = function(event) { console.log(event.type); // \u0026#34;unhandledrejection\u0026#34;  console.log(event.reason.message); // \u0026#34;Explosion!\u0026#34;  console.log(rejected === event.promise); // true }; window.onrejectionhandled = function(event) { console.log(event.type); // \u0026#34;rejectionhandled\u0026#34;  console.log(event.reason.message); // \u0026#34;Explosion!\u0026#34;  console.log(rejected === event.promise); // true }; rejected = Promise.reject(new Error(\u0026#34;Explosion!\u0026#34;));   unhandled rejections tracking ä»£ç å’Œ Node.js å®ç°ä¸€æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  let possiblyUnhandledRejections = new Map(); // when a rejection is unhandled, add it to the map // ä¸ nodejs ç‰ˆæœ¬ä¸åŒç‚¹ï¼šè¿™é‡Œåªæœ‰ä¸€ä¸ªäº‹ä»¶å‚æ•°ï¼Œè€Œä¸æ˜¯ reason,promise window.onunhandledrejection = function(event) { possiblyUnhandledRejections.set(event.promise, event.reason); }; // ä¸ nodejs ç‰ˆæœ¬ä¸åŒç‚¹ï¼šè¿™é‡Œå‚æ•°ä¸å†æ˜¯ promise è€Œæ˜¯äº‹ä»¶å¯¹è±¡ window.onrejectionhandled = function(event) { possiblyUnhandledRejections.delete(event.promise); }; setInterval(function() { possiblyUnhandledRejections.forEach(function(reason, promise) { console.log(reason.message ? reason.message : reason); // do something to handle these rejections  handleRejection(promise, reason); }); possiblyUnhandledRejections.clear(); }, 60000);   é“¾å¼ Promises å®é™…ä¸Šï¼Œæ¯æ¬¡è°ƒç”¨ then() æˆ– catch() éƒ½æ˜¯åˆ›å»ºå¹¶è¿”å›äº†å¦ä¸€ä¸ª promise ï¼Œç¬¬äºŒä¸ª\npromise åªä¼šåœ¨ç¬¬ä¸€ä¸ªçš„çŠ¶æ€å·²ç» settled ä¹‹å(æ— è®ºæ˜¯ fulfilled æˆ– rejected)æ‰ä¼š\nresolvedã€‚\né“¾å¼ Promise è¯­æ³• 1 2 3 4 5 6 7 8 9  let p1 = new Promise(function(resolve, reject) { resolve(42) }) p1.then(function(value) { console.log(value) }).then(function() { console.log(\u0026#39;finished.\u0026#39;) })   +RESULTS:\n42 finished.  å®é™…ä¸Šè°ƒç”¨ç¬¬äºŒä¸ª then() çš„ promise æ˜¯ä¸€ä¸ªå…¨æ–°çš„ Promise ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  let p1 = new Promise(function(resolve, reject) { resolve(42) }) let p2 = p1.then(function(value) { console.log(value) }) p2.then(function() { console.log(\u0026#39;finished.\u0026#39;) }) console.log(p1 === p2)   +RESULTS:\nfalse 42 finished.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  let p1 = new Promise(function(resolve, reject) { resolve(42) }) let p3 = null let p2 = p1.then(function(value) { console.log(value) p3 = Promise.resolve(100) return p3 }).then(function(val) { console.log(val, \u0026#39;p3\u0026#39;) console.log(p3 === p2, \u0026#39;p3 is not p2\u0026#39;) }) console.log(p1 === p2, \u0026#39;p2 is not p1\u0026#39;)   +RESULTS: æˆ‘ä»¬ä¹Ÿå¯ä»¥æ˜¾ç¤ºçš„åœ¨ä¸Šä¸€ä¸ª then() é‡Œé¢è¿”å›ä¸€ä¸ª promiseï¼Œä»ä¸‹é¢çš„ç¬¬ä¸‰è¡Œ\nè¾“å‡ºå¯çŸ¥ï¼Œä¸‹ä¸€ä¸ª then() å¤„ç†çš„å³ä¸Šä¸€ä¸ª then() é‡Œé¢è¿”å›çš„ promiseï¼Œå¦‚æœæ²¡æœ‰æ˜¾\nå¼è¿”å›ä¸€ä¸ª promise é»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Promise è¿”å›ã€‚\nfalse 'p2 is not p1' 42 100 'p3' false 'p3 is not p2'  æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½† p1 å’Œ p2 å¹¶éåŒä¸€ä¸ª promiseã€‚\nå¼‚å¸¸æ•è· é€šè¿‡é“¾å¼è°ƒç”¨å¯ä»¥ä½¿ç”¨ catch() æ•è·ä¸Šä¸€ä¸ª promise ä¸­çš„å¼‚å¸¸ã€‚\n\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  let p1 = new Promise(function(resolve, reject) { resolve(42) }) p1.then(function(value) { console.log(\u0026#39;first then.\u0026#39;) }).then(function(value) { throw new Error(\u0026#39;Boom!\u0026#39;) }).then(function(value) { console.log(\u0026#39;third then.\u0026#39;) }).catch(function(error) { console.log(error.message) return Promise.resolve(\u0026#39;100\u0026#39;) }).then(function(value) { console.log(value, \u0026#39;four then.\u0026#39;) })   +RESULTS: åœ¨ç¬¬ä¸€ä¸ª catch() ä¸­è¿”å›ä¸€ä¸ª Promise.resolve('100') ç»“æœï¼Œè¿™ä¹Ÿè¯´æ˜\n`four then` æ¥è‡ª catch() é‡Œé¢çš„ promise.resolveã€‚\nfirst then. Boom! 100 four then.  +RESULTS: four then æœ‰è¾“å‡ºï¼Œè¿™æ˜¯å› ä¸ºä¹‹å‰çš„å¼‚å¸¸å·²ç»è¢«ä¸Šä¸€ä¸ª catch() æ•è·å¹¶å¤„ç†\näº†ï¼Œ promise æ¢å¤æ­£å¸¸çŠ¶æ€ã€‚\nfirst then. Boom! four then.  +RESULTS: æ–°å¢ first then ç»“æœï¼Œå¼‚å¸¸ä¹‹åå¾— thenable ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºè¯¥ promise\nå·²ç»ç»ˆç»“ã€‚\nfirst then. Boom!  +RESULTS: æ–°å¢ third then è¾“å‡ºå’Œä¹‹å‰çš„ä¸€æ ·ï¼Œå› ä¸ºå‰é¢çš„å‘ç”Ÿäº†å¼‚å¸¸åé¢çš„å°±æ— æ³•å†\nç»§ç»­äº†ã€‚\nBoom!  +RESULTS:\nBoom!  ä»ä»¥ä¸Šç»“æœï¼Œä¸éš¾çœ‹å‡ºï¼Œå¦‚æœé“¾å¼ promise å½“ä¸­æœ‰ä¸€å¤„å‘ç”Ÿå¼‚å¸¸ï¼Œä¼šç»ˆç»“è¿™ä¸ª promise é“¾ï¼Œ\né™¤éåé¢æœ‰ä¸€ä¸ª catch() å°†è¯¥å¼‚å¸¸æ•è·å¹¶å¤„ç†æ‰äº†ï¼Œæ‰èƒ½ç»§ç»­åœ¨é“¾åé¢è¿½åŠ  then()\nã€‚\n é€šå¸¸æƒ…å†µä¸‹ï¼Œæœ€å¥½æ˜¯åœ¨é“¾å¼è°ƒç”¨çš„ç»“æŸæœ‰ä¸€ä¸ª rejection å¤„ç†(reject æˆ– catch)ï¼Œç¡®\nä¿é“¾å¼è°ƒç”¨ä¸­å‡ºç°çš„å¼‚å¸¸èƒ½å¾—åˆ°é€‚å½“çš„å¤„ç†ã€‚\n Promise é“¾å¼è°ƒç”¨ä¸­è¿”å›å€¼ å…¶å®åœ¨ä¸Šä¸€èŠ‚çš„å®ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°±å·²ç»ç”¨åˆ°äº†åœ¨ thenable ä¸­è¿”å›ä¸€ä¸ªå€¼ï¼Œè¯¥ä¾‹ä¸­æ˜¯ç›´æ¥è¿”\nå›äº†ä¸€ä¸ª Promise.resolve() å…¶æœ¬èº«å°±æ˜¯è¿”å›äº†ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼Œå…¶å®æˆ‘ä»¬è¿˜å¯\nä»¥ç›´æ¥è¿”å›ä¸€ä¸ªæ™®é€šçš„è¡¨è¾¾å¼æˆ–è€…å…¶ä»–ç±»å‹çš„å€¼ï¼Œå®ƒçš„ç»“æœæœ€ç»ˆä¹Ÿä¼šè¢«å°è£…æˆä¸€ä¸ªæ–°çš„\nPromise å®ä¾‹è¿”å›å‡ºæ¥ã€‚\nè¿”å›å€¼ï¼š\n æ™®é€šç±»å‹å€¼æˆ–è¡¨è¾¾å¼ Promise.resolve() æˆ– Promise.reject() æˆ–è€…ç›´æ¥ new Promise() è¿”å›ä¸€ä¸ªå…¨æ–°çš„ promise è¿˜å¯ä»¥è¿”å›å¦ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ promise å®ä¾‹ å‰é¢å‡ºç°çš„å¼‚å¸¸å³å¯ä»¥ç”¨ rejection æ¥æ¥æ”¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ catch() æ¥æ¥å—ï¼Œå®é™…æ ¹\næ®éœ€è¦ä½œå‡ºé€‰æ‹©  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  let p1 = new Promise(function(resolve, reject) { resolve(42) }) p1.then(function(value) { console.log(value) // 42  return value + 1 }).then(function(value) { console.log(value) // 43  return Promise.resolve(value + 1) }).then(function(value) { console.log(value); // 44  throw new Error(\u0026#39;Boom!\u0026#39;) }).catch(function(error) { console.log(error.message); // Boom!  let p2 = new Promise(function(resolve, reject) { resolve(100) }) return p2 }).then(function(value) { console.log(value); // 100  return Promise.reject(\u0026#39;end here.\u0026#39;) }).then(null, function(reason) { // ä¸Šä¸€ä¸ªçš„å¼‚å¸¸å¯ä»¥ä½¿ç”¨ rejection æ¥å—  console.log(reason); // end here.  return Promise.reject(\u0026#39;end end here.\u0026#39;) }).catch(function(error) { // ä¹Ÿå¯ä»¥ç”¨ catch æ¥æ¥å—  console.log(error) })   +RESULTS:\n42 43 44 Boom! 100 end here. end end here.  è¿”å›å€¼ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ª rejectionï¼Œæ¯”å¦‚ catch() ä¸­ä½¿ç”¨ã€‚\nå“åº”å¤šä¸ª Promises åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ‰€ä½¿ç”¨çš„å®ä¾‹éƒ½æ˜¯ä¸€æ¬¡åªèƒ½æ¥å—å¤„ç†ä¸€ä¸ª promiseï¼Œä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³\nè¦åŒæ—¶å»æ¥æ”¶å¤šä¸ª promise ä¸”ä¸‹ä¸€æ­¥çš„è¡Œä¸ºç”±è¿™äº›å¤šä¸ª promise å…±åŒå†³å®šçš„æ—¶å€™ï¼Œå°±éœ€è¦\nè€ƒè™‘ä½¿ç”¨ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚\n Promise.all() æ‰€æœ‰çš„ promise çŠ¶æ€å®Œæˆäº†ï¼Œæ‰ä¼šè¢«è§†ä¸º resolvedã€‚ Promise.race() å¤šä¸ª promise åªè¦æœ‰ä¸€ä¸ªçŠ¶æ€å®Œæˆäº†ï¼Œé‚£ä¹ˆ race() å°±è¢«è§†ä¸ºå·²ç»\nå®Œæˆ  Promise.all(iterable) å‚æ•° iterable æ˜¯ä¸€ä¸ªå…ƒç´ ä¸º promise çš„åˆ—è¡¨ï¼Œè¯¥æ¥å£çš„å«ä¹‰æ˜¯åªæœ‰ iterable ä¸­æ‰€æœ‰çš„\npromise çŠ¶æ€éƒ½ä¸º resolved äº†ï¼Œè¿™ä¸ªæ¥å£è¿”å›çš„ promise æ‰ä¼šæ˜¯ resolved ï¼Œå¦åˆ™åªè¦\næœ‰ä¸€ä¸ª rejected äº†ï¼Œè¿”å›çš„ promise å°±ä¼šæ˜¯ rejectedã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  let p1 = new Promise(function(resolve, reject) { resolve(42) }) let p2 = new Promise(function(resolve, reject) { resolve(43) }) let p3 = new Promise(function(resolve, reject) { resolve(44) }) let p4 = Promise.all([p1 , p2, p3]) p4.then(function(value) { // ç»“æœæ˜¯ç”± p1, p2, p3 çš„ç»“æœå€¼ç»„æˆçš„æ•°ç»„  console.log(Array.isArray(value)); // true  console.log(value.toString()); // 42, 43, 44 })   +RESULTS:\ntrue 42,43,44   Promise.all() æ˜¯ï¼šä¸€è£ä¿±è£(resolved)ï¼Œä¸€æŸä¿±æŸ(rejected)ï¼Œå¤§å®¶éƒ½åœ¨ä¸€æ¡èˆ¹ä¸Šï¼Œä¸€æ ¹\nç»³ä¸Šçš„èš‚èš±ï¼Œè°ä¹Ÿåˆ«æƒ³å·æ‡’ã€‚\n åªè¦æœ‰ä¸€ä¸ª rejected çš„äº†ï¼Œé‚£ä¹ˆç«‹å³ rejected ä¸ä¼šå¾—åˆ°å…¶ä»–çš„ promise å®Œæˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  let p1 = new Promise(function(resolve, reject) { resolve(42) }) let p2 = new Promise(function(resolve, reject) { reject(43) }) let p3 = new Promise(function(resolve, reject) { resolve(44) }) let p4 = Promise.all([p1 , p2, p3]) p4.catch(function(value) { // ç»“æœæ˜¯ç”± p1, p2, p3 çš„ç»“æœå€¼ç»„æˆçš„æ•°ç»„  console.log(Array.isArray(value)); // true  console.log(value.toString()); // 42, 43, 44 })   +RESULTS: å› ä¸ºåªè¦æœ‰ä¸€ä¸ª rejected äº†ï¼Œå°±ä¼šç«‹å³ rejected å› æ­¤å¼‚å¸¸çš„ç»“æœå€¼åªä¼šæ˜¯æ‰€\næœ‰ promises ä¸­çš„ä¸€ä¸ªã€‚\nfalse 43  Promise.race(iterable) iterable ä¸­çš„æ‰€æœ‰ promises å±äºç«äº‰å…³ç³»ï¼Œåˆ©å·±ä¸»ä¹‰è€…ï¼Œå¹¶ä¸”ä¸ç®¡ç¬¬ä¸€ä¸ªçŠ¶æ€å®Œæˆçš„çŠ¶\næ€æ˜¯ fulfilled æˆ– rejected åªè¦æ˜¯ settled é‚£ä¹ˆ race() å°±ä¼šç«‹å³ settledã€‚\nrace() ä¸­çš„æ¯ä¸ª promise éƒ½æ˜¯è‡ªç§é¬¼ï¼Œå®æ„¿è‡ªå·±å¤±è´¥ä¹Ÿè¦èµ¶åœ¨ç¬¬ä¸€æ—¶é—´å°†å¤§ä¼™æ¶ˆç­(ä¸»ä½“\npromise éƒ½ç»“æŸäº†)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  let p1 = Promise.resolve(42) let p2 = new Promise(function(resolve, reject) { resolve(43) }) let p3 = new Promise(function(resolve, reject) { resolve(44) }) let p4 = Promise.race([p1 , p2, p3]) p4.then(function(value) { console.log(value); })   +RESULTS:\n42  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  let delay = (fn, timeout) =\u0026gt; setTimeout(fn, timeout) let p1 = new Promise(function(resolve, reject) { delay(() =\u0026gt; resolve(42), 100) }) let p2 = new Promise(function(resolve, reject) { resolve(43) }) let p3 = new Promise(function(resolve, reject) { delay(() =\u0026gt; resolve(44), 50) }) let p4 = Promise.race([p1 , p2, p3]) p4.then(function(value) { console.log(value); // 43 })   +RESULTS:\n43  å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨ åœ¨ä¹‹å‰çš„ç« èŠ‚9.8.1ä¸­æˆ‘ä»¬æœ‰ä½¿ç”¨ iterator + generator å®ç°ä¸€ä¸ªç®€æ˜“çš„å¼‚\næ­¥ä»»åŠ¡æ‰§è¡Œå‡½æ•°ï¼Œä¼šåœ¨ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆä¹‹åç«‹å³å¯åŠ¨ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚æ­¤å¾€å¤ç›´åˆ°æ‰€æœ‰ä»»åŠ¡éƒ½\nå®Œæˆä¸ºæ­¢ã€‚\nåœ¨è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨ Promise æ¥å®ç°å®ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  let fs = require(\u0026#39;fs\u0026#39;) function run(taskDef) { let task = taskDef(); let result = task.next(); function step() { if (!result.done) { // è¿™é‡Œä¸ç”¨åˆ¤æ–­å€¼æ˜¯ä»€ä¹ˆç±»å‹ï¼Œpromise.resolve ç»Ÿç»Ÿè½¬æˆ promise  let promise = Promise.resolve(result.value) promise.then(function(value) { result = task.next(value) step() }).catch(function(error) { result = task.throw(error) step(); }) } } step(); } function readFile(filename) { return new Promise(function(resolve, reject) { fs.readFile(filename, function(err, contents) { if (err) { reject(err) } else { resolve(contents) } }) }) } run(function *() { let contents = yield readFile(__dirname + \u0026#39;/config.json\u0026#39;) // do something with response data  console.log(contents) console.log(\u0026#39;Done\u0026#39;) })   Promise ç‰ˆæœ¬éœ€è¦æ³¨æ„çš„ç‚¹ï¼š\n readFile å³ä»»åŠ¡å‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ åœ¨ step() é‡Œé¢è®²è¿­ä»£å™¨çš„å€¼æ— è®ºä»€ä¹ˆç±»å‹ï¼Œè®©å®ƒå˜æˆä¸€ä¸ª promise ï¼Œé€šè¿‡\nthen() å»æ¥å—æ‰§è¡Œç»“æœï¼Œ catch() å»æ•è·å¹¶å¤„ç†å¼‚å¸¸ã€‚  Promise ç‰ˆæœ¬ç›¸å¯¹äº iterator + generator ç‰ˆæœ¬æœ‰ç‚¹ï¼š\n ä¸ç”¨å…³å¿ƒè¿­ä»£å™¨ä¸­ value çš„å€¼æ˜¯ä»€ä¹ˆç±»å‹ï¼Œåªè¦è½¬æˆ promise èƒ½æœ‰æ•ˆçš„å¤„ç†å¼‚å¸¸ï¼Œä½¿ç”¨ catch() æ•è·å¼‚å¸¸ï¼Œä¸ç”¨ä¸­æ–­ç¨‹åº ä¸ç”¨ä½¿ç”¨å›è°ƒä¼ é€’(readFile è¿”å›ä¸€ä¸ªå¸¦æœ‰å›è°ƒçš„å‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒä¼šè¢«ä¼ é€’åˆ°è¿­ä»£å™¨çš„\nvalue å€¼ï¼Œä½†å®é™…æœ€åè¢«ä½¿ç”¨çš„æ˜¯ readFile ä¸­çš„ fs.readFile())ï¼Œè€Œä½¿ç”¨ Promise\nå°±ä¸éœ€è¦å…³å¿ƒå›è°ƒæ˜¯å¦‚ä½•è¢«ä¼ é€’å’Œæ‰§è¡Œäº†ã€‚  æœªæ¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨(asyncâ€¦await) åœ¨ ECMAScript 2017(es8) ä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„è¯­æ³•ç³–ï¼š async...await è¿™è®©å¼‚æ­¥ä»»åŠ¡å˜\nå¾—å¼‚å¸¸ç®€å•ï¼Œå…¶å†…éƒ¨å®ç°ä¹Ÿæ˜¯åŸºäº Promise æ¥å®ç°çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  let fs = require(\u0026#39;fs\u0026#39;) function readFile(filename) { return new Promise(function(resolve, reject) { fs.readFile(filename, function(err, data) { if (err) { reject(err) } else { resolve(data) } }) }) } (async function() { let contents = await readFile(__dirname + \u0026#39;/config.json\u0026#39;) console.log(contents) console.log(\u0026#39;Done\u0026#39;) })()   +RESULTS:\n\u0026lt;Buffer 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 0a 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 ... \u0026gt; Done  å°ç»“   Promise æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼š pending(åˆ›å»ºä¹‹åˆæ—¶), fulfilled(æ‰§è¡ŒæˆåŠŸ) å’Œ rejected(æ‰§è¡Œ\nå¤±è´¥æˆ–å¼‚å¸¸)ï¼Œä¸”çŠ¶æ€ä¸€æ—¦æ”¹å˜å°±æ— æ³•é€†è½¬ã€‚\n  promise.then(resolve, reject) ç”¨å›è°ƒæ¥æ¥æ”¶ä¸Šä¸€ä¸ª promise æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥çš„ç»“\næœ\n  catch(rejection) å¤±è´¥æˆ–å¼‚å¸¸å¤„ç†å¯ä»¥ç”¨ then(null, reject) æ¥æ¥å—ä¹‹å¤–ä¹Ÿå¯ä»¥\nä½¿ç”¨ catch ï¼Œå¹¶ä¸”å»ºè®®åœ¨æ¯ä¸ªé“¾å¼ promise è°ƒç”¨ç»“å°¾ä¿è¯æ€»æœ‰ä¸€ä¸ª catch() æ¥ä¿\nè¯å¼‚å¸¸èƒ½è¢«æ•è·åˆ°å¹¶å¾—åˆ°å¤„ç†\n  Promise.all(iterable) æ‰€æœ‰çš„ promise resolved æ‰èƒ½ resolved\n  Promise.race(iterable) æ‰€æœ‰çš„ promise ä¹‹é—´å¤„äºç«äº‰å…³ç³»ï¼Œåªè¦æœ‰ä¸€ä¸ªé¦–å…ˆ\nsettled ä¹‹åè¯¥ race() å°±ç»“æŸï¼ŒçŠ¶æ€ç”±ç¬¬ä¸€ä¸ª settled çš„ promise å†³å®šã€‚\n  Promise é“¾å¼è°ƒç”¨ï¼Œä¸­æ¯ä¸€ä¸ª then() ä¸­éƒ½ä¼šé»˜è®¤è¿”å›ä¸€ä¸ªæ–°çš„ promise ç»™åé¢çš„\nthen() ä¹Ÿå¯ä»¥æ˜¾ç¤ºè¿”å›ï¼Œå¦‚æœæ˜¾ç¤ºè¿”å›çš„æ˜¯ä¸€ä¸ªæ™®é€šå€¼æˆ–è¡¨è¾¾å¼åˆ™ä¼šè¢«å°è£…æˆä¸€ä¸ª\npromiseï¼Œå¦‚æœæ˜¯ä¸€ä¸ª promise åˆ™ä¼šè¢«åŸæ ·è¿”å›ã€‚\n  ç»“åˆ promise å’Œ generator å°†è®©å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨æ›´åŠ å®¹æ˜“\n  es8 ä¸­çš„ asyncâ€¦await è¯­æ³•ç³–å°†è®©å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæ›´åŠ ç®€æ˜“\n  Proxies å’Œ Reflection Api ECMAScript 5 å’Œ ECMAScript 6 å‡ºç°çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†ç®€åŒ– JavaScript çš„ä½¿ç”¨ï¼Œåœ¨\nECMAScript 5 ä¹‹å‰åœ¨ JavaScript ç¯å¢ƒä¸­åŒ…å«ä¸€äº›æ‹¥æœ‰ä¸èƒ½æšä¸¾(nonenumerable)å’Œä¸èƒ½å†™\nå…¥(nonwritable)çš„å¯¹è±¡å±æ€§ï¼Œä½†æ˜¯å¼€å‘è€…å´ä¸èƒ½ç»™è‡ªå·±å£°æ˜çš„å¯¹è±¡æ·»åŠ ä¸èƒ½æšä¸¾å’Œä¸èƒ½å†™\nå…¥çš„å±æ€§ï¼Œå› ä¸ºå¹¶æ²¡æœ‰ä»»åŠ¡æ¥å£èƒ½ä½¿ç”¨ï¼ŒçŸ¥é“ ECMAScript 5 å‡ºç°ä¹‹åå¢åŠ äº†\nObject.defineProperty() æ–¹æ³•ï¼Œå¯ä»¥è®©å¼€å‘è€…ä¸ºè‡ªå·±çš„å¯¹è±¡å±æ€§ä¿®æ”¹å…¶æè¿°ç¬¦å¯¹è±¡ï¼Œä»\nè€Œå¢åŠ ä¸å¯å†™æˆ–ä¸å¯æšä¸¾çš„å±æ€§ç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  const obj = {} Object.defineProperty(obj, \u0026#39;count\u0026#39;, { value: \u0026#39;100\u0026#39;, enumerable: false, // ä¸å¯æšä¸¾  writable: false, // ä¸å¯èµ‹å€¼æ”¹å˜  configurable: true, }) obj.count = 3 console.log(obj.count, \u0026#39;count\u0026#39;) for (let prop in obj) { console.log(prop, \u0026#39;prop\u0026#39;) }   +RESULTS:\n100 count   è¾“å‡º 100 è¡¨ç¤º obj.count = 3 å¹¶æ²¡æœ‰ç”Ÿæ•ˆ for..in ä¸­æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜ count ä¸èƒ½è¢«æšä¸¾  ECMAScript 6 ä¸­èµ‹äºˆäº†å¼€å‘è€…æ›´å¤šå¹²æ¶‰ JavaScript å¼•æ“å·¥ä½œçš„èƒ½åŠ›ï¼Œå®ƒé€šè¿‡ proxies\nå°†ä¸€äº›å†…éƒ¨æ“ä½œæš´éœ²å‡ºæ¥ï¼Œ proxies æ˜¯ä¸€äº›åŒ…å¯ä»¥ä¸­æ–­æˆ–æ‹¦æˆªå¼•æ“çš„ä¸€äº›æ“ä½œåŒ…è£…å™¨ã€‚\nè¿™ä¸€ç« èŠ‚å°†å¼€å§‹äº proxies ç›¸å…³çš„çŸ¥è¯†å’Œä½¿ç”¨ã€‚\næ•°ç»„é—®é¢˜(Array Problem) æ¯”å¦‚ï¼Œé•¿åº¦çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶å‚æ•°ç»„çš„é•¿åº¦æ¥è¾¾åˆ°æ§åˆ¶æ•°ç»„å†…å®¹çš„ç›®çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  let colors = [\u0026#39;red\u0026#39;, \u0026#39;green\u0026#39;, \u0026#39;blue\u0026#39;] console.log(colors.length); // 3  colors[3] = \u0026#39;black\u0026#39; console.log(colors.length); // 4 console.log(colors[3]) // \u0026#39;black\u0026#39;  colors.length = 2; // ç›¸å½“äºæˆªå–äº†æ•°ç»„ï¼Œåé¢çš„å…ƒç´ å°†è¢«ä¸¢å¼ƒ console.log(colors.length); // 2 console.log(colors[3]); // undefined console.log(colors[2]); // undefined console.log(colors[1]); // \u0026#39;green\u0026#39;   +RESULTS:\n3 4 black 2 undefined undefined green   è¿™ä¸€éæ ‡å‡†çš„è¡Œä¸ºä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ•°ç»„åœ¨ ECMAScript 6 ä¸­è¢«è§†ä¸ºå¼‚ç±»äº†ã€‚\n ä»€ä¹ˆæ˜¯ Proxies å’Œ Reflection æˆ‘ä»¬å¯ä»¥é€šè¿‡ new Proxy() åˆ›å»ºä¸€ä¸ª proxy ç”¨æ¥ä»£æ›¿å¦ä¸€ä¸ªå¯¹è±¡(å‡è®¾å«ï¼š\ntarget)ä½¿ç”¨ã€‚è¿™ä¸ª proxy ä¼šè™šæ‹ŸåŒ–è¿™ä¸ª target ä»¥è‡³äº proxy å’Œ target èƒ½å¥½ä¼¼ä¸€ä¸ª\nä¸œè¥¿ä¸€æ ·è¢«ä½¿ç”¨ã€‚\nå°±ç›¸å½“äºç»™ target ç”Ÿäº†ä¸ªå­ªç”Ÿå…„å¼Ÿï¼Œç”¨æ³•åŠŸèƒ½éƒ½å·®ä¸å¤šï¼Œç”šè‡³å¯ä»¥å½“åšæ˜¯ä¸€ä¸ªäººã€‚\nProxies å…è®¸ä½ å¯ä»¥ä¸­æ–­ä½çº§å¯¹è±¡æ“ä½œ(ååº•å±‚çš„æ“ä½œ, low-level object operations)ï¼Œ\nè¿™äº›æ“ä½œå¯ä»¥è¢« trap å‡½æ•°(ä¸€ä¸ªå¯å“åº”ç‰¹å®šæ“ä½œçš„å‡½æ•°)ä¸­æ–­\nRelect å¯¹è±¡ï¼Œæ˜¯ä¸€ç»„æ–¹æ³•çš„é›†åˆï¼Œä¸ºä¸€äº›ä½çº§æ“ä½œæä¾›äº†é»˜è®¤è¡Œä¸º(è¿™äº›è¡Œä¸ºå¯ä»¥é€šè¿‡\nproxies é‡å†™)ã€‚å¯¹äºæ¯ä¸€ä¸ª proxy trap éƒ½æœ‰ä¸€ä¸ª Relect æ–¹æ³•ä¸ä¹‹å¯¹åº”ï¼Œä¸”è¿™äº›æ–¹æ³•\nå’Œä»–ä»¬çš„ proxy traps æœ‰ä¸€æ ·çš„åå­—ä¸”ä¼ é€’äº†ä¸€æ ·çš„å‚æ•°ã€‚\nä¸‹è¡¨åˆ—å‡ºäº†ä¸€äº›é»˜è®¤è¡Œä¸ºå’Œ proxy trap çš„å¯¹åº”å…³ç³»ï¼š\n   proxy trap é‡å†™çš„è¡Œä¸º é»˜è®¤è¡Œä¸º     get 13.3.3 è¯»å–ä¸€ä¸ªå¯¹è±¡å±æ€§å€¼ Reflect.get()   set 13.3.2 è®¾ç½®å±æ€§å€¼ Reflect.set()   has æ˜¯å¦åŒ…å« Reflect.has()   deleteProperty delete obj.name åˆ é™¤å¯¹è±¡å±æ€§æ“ä½œ Reflect.deleteProperty()   getPrototypeOf Object.getPrototypeOf() Reflect.getPrototypeOf()   setPrototypeOf Object.setPrototypeOf() Reflect.setPrototypeOf()   isExtensible Object.isExtensible() Reflect.isExtensible()   preventExtensions Object.preventExtensions() Reflect.preventExtensions()   getOwnPropertyDescriptor Object.getOwnPropertyDescriptor() Reflect.getOwnPropertyDescriptor()   defineProperty Object.definePropery() Reflect.definePropery()   ownKeys Object.keys(), Object.getOwnPropertyNames(), Object.getOwnPropertySymbols() Reflect.ownKeys()   apply fn.apply(thisArg, argsArr) Reflect.apply()   construct new Ctor() Reflect.construct()    æ¯ä¸€ä¸ª trap é‡å†™äº† JavaScript å¯¹è±¡çš„å†…ç½®è¡Œä¸ºï¼Œå…è®¸ä¸­æ–­å’Œä¿®æ”¹è¿™äº›è¡Œä¸ºã€‚å¦‚æœä¾ç„¶éœ€\nè¦ç”¨åˆ°å†…ç½®è¡Œä¸ºï¼Œå¯ä»¥ä½¿ç”¨å¯¹åº”çš„ reflection api æ–¹æ³•ã€‚\n åŸæ¥ ECMAScript 6 è§„èŒƒä¸­æœ‰ä¸€ä¸ªå« enumerate çš„ trapï¼Œè¢«è®¾è®¡ç”¨æ¥æ”¹å˜ for...in\nå’Œ Object.keys() æšä¸¾å¯¹è±¡å±æ€§çš„è¡Œä¸ºã€‚ä½†æ˜¯åœ¨ ECMAScript 7 ä¸­éšå³è¢«ç§»é™¤ï¼ŒåŸå› æ˜¯\nå®ç°èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œå› æ­¤ä»¥åéƒ½ä¸ä¼šæœ‰ enumerate äº†ã€‚\n ä½¿ç”¨ Proxies å’Œ Reflection Proxy ç®€å•åº”ç”¨ ä½¿ç”¨ new Proxy(target, handler) åˆ›å»ºä¸€ä¸ª proxy æ—¶å€™éœ€è¦ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼š\n target éœ€è¦è¢«ä»£ç†çš„é‚£ä¸ªå¯¹è±¡ handler ä¸€ä¸ªå®šä¹‰äº†ä¸€ä¸ªæˆ–å¤šä¸ª proxy traps çš„å¯¹è±¡  proxy å°†ä½¿ç”¨æ‰€æœ‰æ“ä½œçš„é»˜è®¤è¡Œä¸ºï¼Œé™¤éåœ¨ handler ä¸­å®šä¹‰äº†å¯¹åº”çš„ proxy trapã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  let target = {} let proxy = new Proxy(target, {}) proxy.name = \u0026#39;proxy\u0026#39; console.log(proxy.name); // \u0026#39;proxy\u0026#39; console.log(target.name); // \u0026#39;proxy\u0026#39;  target.name = \u0026#39;target\u0026#39;; console.log(proxy.name); // \u0026#39;target\u0026#39; console.log(target.name); // \u0026#39;target\u0026#39;   +RESULTS: target å’Œ proxy å¯¹è±¡ä¹‹é—´äº’ç›¸å½±å“\nproxy proxy target target  åœ¨è¿™ä¸ªä¾‹å­ä¸Šï¼Œ proxy ä»£ç†äº† target å¯¹è±¡çš„æ‰€æœ‰é»˜è®¤è¡Œä¸º(å› ä¸ºä¼ å…¥äº†ä¸€ä¸ªç©ºçš„ {} å¯¹\nè±¡ç»™ Proxy() )ã€‚ä¹Ÿå°±æ˜¯è¯´å¯¹ target å’Œ proxy å¯¹è±¡çš„æ‰€æœ‰è¡Œä¸ºéƒ½ä¼šåœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Šæœ‰æ‰€\nä½“ç°ï¼Œå½¢åŒæ“ä½œå¯¹æ–¹æœ¬èº«ä¸€æ ·ã€‚\nåƒè¿™ä¸ªç®€å•çš„ proxy ä¾‹å­ï¼Œä»£ç†äº† target ä½†æ˜¯å´æ²¡æœ‰æä¾›ä»»ä½• trapsï¼Œè¿™å¹¶æ²¡æœ‰ä»»ä½•æ„ä¹‰\nç”¨ set(trapTarget, key, value, receiver) trap éªŒè¯å±æ€§ å‡è®¾ä½ æƒ³åˆ›å»ºä¸€ä¸ªå±æ€§å€¼å¿…é¡»æ˜¯æ•°å€¼ç±»å‹çš„å¯¹è±¡ï¼Œè¿™æ„å‘³ç€æ¯ä¸€ä¸ªæ–°å¢çš„å±æ€§å¿…é¡»è¦æœ‰ä¸€ä¸ª\néªŒè¯æœºåˆ¶å»ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªæ•°å€¼ç±»å‹ï¼Œå¦åˆ™å°±è¦æŠ›å‡ºå¼‚å¸¸ã€‚\nä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ proxy çš„ set trap å»é‡å†™èµ‹å€¼çš„é»˜è®¤è¡Œä¸ºã€‚\nset trap æ¥å—å››ä¸ªå‚æ•°ï¼š\n trapTarget é‚£ä¸ªè¢«ä»£ç†çš„å¯¹è±¡ targetï¼Œä¹Ÿæ˜¯å³å°†è¢«æ–°å¢å±æ€§çš„é‚£ä¸ªå¯¹è±¡ key æ–°å¢å±æ€§çš„ key å€¼(å­—ç¬¦ä¸²æˆ–ç¬¦å·ç±»å‹) value æ–°å¢å±æ€§çš„å€¼ï¼Œå°†è¦è¢«æ£€æµ‹çš„å†…å®¹ receiver è¯¥æ“ä½œçš„ç›®æ ‡å¯¹è±¡(ä¸€èˆ¬å°±æ˜¯ target çš„ä»£ç†å®ä¾‹ proxy)  set =\u0026gt; èµ‹å€¼æ“ä½œ =\u0026gt; Reflect.set()\nåœ¨â€œä»€ä¹ˆæ˜¯ Proxies å’Œ Reflectionâ€ä¸€èŠ‚å°±å°†è¿‡ proxy trap å’Œ reflect å¯¹åº”çš„æ“ä½œå‡½æ•°\nåç§°å’Œå‚æ•°éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Reflect.set() ä¹Ÿå°†æ¥å— set trap ä¸€æ ·çš„å››\nä¸ªå‚æ•°ï¼š trapTarget, key, value, receiver ä¸”å«ä¹‰ä¸€æ ·ã€‚\nReflect.set() çš„è¿”å›å€¼ä¸º true/false ï¼ŒæˆåŠŸä¸º true å¤±è´¥ä¸º falseï¼Œä¸”åœ¨ set\ntrap ä¸­ä¹Ÿåº”è¯¥è¦è¿”å›ä¸€ä¸ª boolean å€¼è¡¨ç¤ºè¯¥ trap æ˜¯å¦æˆåŠŸæˆ–å¤±è´¥äº†ï¼Œä¸€èˆ¬ç›´æ¥è¿”å›\nReflect.set() çš„è¿”å›å€¼å³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  let target = { name: \u0026#39;target\u0026#39; } let proxy = new Proxy(target, { set(trapTarget, key, value, receiver) { console.log(trapTarget === target, \u0026#39;trapTarget is target\u0026#39;) if (!trapTarget.hasOwnProperty(key)) { if (isNaN(value)) { throw new TypeError(\u0026#39;å±æ€§å¿…é¡»æ˜¯ `number` ç±»å‹ï¼\u0026#39;) } } return Reflect.set(trapTarget, key, value, receiver) } }) // æ·»åŠ ä¸€ä¸ªå±æ€§ proxy.count = 1 console.log(proxy.count) console.log(target.count) proxy.name = \u0026#39;proxy\u0026#39; console.log(proxy.name) console.log(target.name)   +RESULTS:\ntrue 'trapTarget is target' 1 1 true 'trapTarget is target' proxy proxy undefined  å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæ“ä½œ proxy å°±åƒç›´æ¥æ“ä½œ target ä¸€æ ·ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½èƒ½åœ¨ target ä¸Šé¢\næœ‰æ‰€ä½“ç°ï¼Œä½†æ˜¯ä½¿ç”¨ proxy \u0026amp; reflect å’Œç›´æ¥æ“ä½œ target çš„å¥½å¤„æ˜¯ï¼Œå…è®¸æˆ‘ä»¬æ‹¦æˆªè¿™ä¸€\nåº•å±‚æ“ä½œï¼Œä»è€Œå¯¹å…¶è¿›è¡Œä¸€äº›é¢å¤–çš„å¤„ç†ã€‚\nget(trapTarget, key, receiver) trap è·å–å¯¹è±¡å±æ€§å€¼çš„æ“ä½œä»£ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  let proxy = new Proxy({}, { get(trapTarget, key, receiver) { if (!(key in receiver)) { throw new TypeError(\u0026#39;é”™è¯¯ï¼šå±æ€§ \u0026#39; + key + \u0026#39; ä¸å­˜åœ¨ã€‚\u0026#39;) } return Reflect.get(trapTarget, key, receiver) } }) // proxy.name = \u0026#39;proxy\u0026#39; try { console.log(proxy.name) } catch (e) { console.log(e.message) } proxy.name = \u0026#39;proxy\u0026#39; console.log(proxy.name)   +RESULTS:\né”™è¯¯ï¼šå±æ€§ name ä¸å­˜åœ¨ã€‚ proxy  has(trapTarget, key) trap   trapTarget è¢«ä»£ç†çš„é‚£ä¸ªå¯¹è±¡(æ¯”å¦‚ï¼š target) key è¢«æ£€æµ‹çš„å±æ€§çš„åç§°  in æ“ä½œç¬¦å¯ä»¥ç”¨æ¥æ£€æµ‹ä¸€ä¸ªå±æ€§æ˜¯å¦å­˜åœ¨äºæŒ‡å®šå¯¹è±¡æˆ–è€…å®ƒçš„åŸå‹ä¸Šï¼Œå¦‚æœèƒ½æ‰¾åˆ°è¿”å› true\n1 2 3 4 5 6  let target = { value: 42 } console.log(\u0026#39;value\u0026#39; in target) console.log(\u0026#39;toString\u0026#39; in target)   +RESULTS:\ntrue true  in æ“ä½œç¬¦åœ¨ Proxy ä¸­å¯¹åº”çš„æ˜¯ has -\u0026gt; Reflect.has(trapTarget, key) æ¥å£ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  let target = { name: \u0026#39;target\u0026#39;, value: 42 } let proxy = new Proxy(target, { has(trapTarget, key) { return key === \u0026#39;value\u0026#39; ? false : Reflect.has(trapTarget, key) } }) console.log(\u0026#39;value\u0026#39; in proxy) console.log(\u0026#39;name\u0026#39; in proxy) console.log(\u0026#39;toString\u0026#39; in proxy)   +RESULTS:\nfalse true true  deleteProperty(trapTarget, key) trap åˆ é™¤å¯¹è±¡å±æ€§(delete å…³é”®è¯çš„ä½¿ç”¨)  delete æ“ä½œç¬¦ä¼šå°†å¯¹è±¡ä¸­çš„å±æ€§ä»è¿™ä¸ªå¯¹è±¡ä¸­ç§»é™¤ï¼Œå¦‚æœæˆåŠŸè¿”å› true å¦åˆ™è¿”å›\nfalse ï¼Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹è¯•å›¾åˆ é™¤ä¸€ä¸ª non-configurable çš„å±æ€§ä¼šæŠ¥é”™ï¼Œéä¸¥æ ¼æ¨¡å¼ä¸‹\nä¼šè¿”å› false ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  let target = { name: \u0026#39;target\u0026#39;, value: 42 } Object.defineProperty(target, \u0026#39;name\u0026#39;, { configurable: false }) console.log(\u0026#39;value\u0026#39; in target) // true  let res1 = delete target.value console.log(res1) // true console.log(\u0026#39;value\u0026#39; in target) // false  let res2 = delete target.name // error ä¸¥æ ¼æ¨¡å¼ console.log(res2, \u0026#34;ä¸¥æ ¼æ¨¡å¼\u0026#34;) console.log(\u0026#39;name\u0026#39; in target, \u0026#34;åˆ é™¤å¤±è´¥\u0026#34;) // true åˆ é™¤å¤±è´¥   é€šè¿‡ proxy çš„ deleteProperty -\u0026gt; deleteProperty(trapTarget, key) ä»£ç† delete\nè¡Œä¸ºï¼š\n trapTarget è¢«ä»£ç†çš„å¯¹è±¡ key è¢«åˆ é™¤çš„å±æ€§åç§°  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  let target = { name: \u0026#39;target\u0026#39;, value: 42 } let proxy = new Proxy(target, { deleteProperty(trapTarget, key) { return key === \u0026#39;value\u0026#39; ? false : Reflect.deleteProperty(trapTarget, key) } }) console.log(\u0026#39;value\u0026#39; in proxy) let res1 = delete proxy.value console.log(res1) console.log(\u0026#39;value\u0026#39; in proxy, \u0026#39;åˆ é™¤å¤±è´¥\u0026#39;) // true, åˆ é™¤å¤±è´¥  console.log(\u0026#39;name\u0026#39; in proxy) // true console.log(delete proxy.name, \u0026#39;name\u0026#39; in proxy) // true false   +RESULTS:\ntrue false true 'åˆ é™¤å¤±è´¥' true true false  åŸå‹ä»£ç†Traps(Prototype Proxy Traps) ä¸åŸå‹æœ‰å…³çš„ traps :\n getPrototypeOf(trapTarget) -\u0026gt; Object.getPrototypeOf(trapTarget) -\u0026gt;\nReflect.getPrototypeOf(trapTarget) setPrototypeOf(trapTarget, proto) -\u0026gt; Object.setPrototypeOf(trapTarget, proto) -\u0026gt;\nReflect.setPrototypeOf(trapTarget, proto)  åŸå‹ä»£ç† Traps å·¥ä½œåŸç† åœ¨ä½¿ç”¨åŸå‹ trap çš„æ—¶å€™æœ‰ä¸€äº›ä¸¥æ ¼çš„è§„å®šï¼š\n getPrototypeOf trap å¿…é¡»è¿”å›ä¸€ä¸ªå¯¹è±¡æˆ–è€… null ,å¦‚æœæ˜¯å…¶ä»–å€¼å°±ä¼šå‘ç”Ÿè¿è¡Œæ—¶\né”™è¯¯ setPrototypeOf åœ¨å¤±è´¥çš„æ—¶å€™å¿…é¡»è¿”å› false ï¼Œå¦‚æœä¸æ˜¯é‚£ä¹ˆé»˜è®¤ä¼šè¢«å½“åšæˆåŠŸ\nå¤„ç†  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  let target = {} let proxy = new Proxy(target, { getPrototypeOf(trapTarget) { return null }, setPrototypeOf(trapTarget, proto) { return false } }) let targetProto = Object.getPrototypeOf(target) let proxyProto = Object.getPrototypeOf(proxy) console.log(targetProto === Object.prototype) // true console.log(proxyProto === Object.prototype) // false console.log(proxyProto) // null  Object.setPrototypeOf(target, {}) // succeed try { Object.setPrototypeOf(proxy, {}) // error } catch (error) { console.log(error.message) }   +RESULTS:\ntrue false null 'setPrototypeOf' on proxy: trap returned falsish  ä½¿ç”¨é»˜è®¤è¡Œä¸º(Reflect.get/setPrototypeOf())\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  let target = {} let proxy = new Proxy(target, { getPrototypeOf(trapTarget) { return Reflect.getPrototypeOf(trapTarget) }, setPrototypeOf(trapTarget, proto) { return Reflect.setPrototypeOf(trapTarget, proto) } }) let targetProto = Object.getPrototypeOf(target) let proxyProto = Object.getPrototypeOf(proxy) console.log(targetProto === Object.prototype) // true console.log(proxyProto === Object.prototype) // false console.log(proxyProto) // null  Object.setPrototypeOf(target, {}) // succeed try { Object.setPrototypeOf(proxy, {}) // error } catch (error) { console.log(error.message) }   +RESULTS:\ntrue true {}  ä¸ºä»€ä¹ˆæœ‰ä¸¤ç§æ–¹æ³•?(Reflect å’Œ Object ä¸Šéƒ½æœ‰ get/setPrototypeOf) ç›¸åŒç‚¹ ï¼š\næœ€ç»ˆéƒ½æ˜¯æ“ä½œçš„å†…éƒ¨å±æ€§ï¼š [[GetPrototypeOf] ] å’Œ [[setPrototypeOf] ]\nä¸åŒç‚¹ :\n    getPrototypeOf setPrototypeOf     Object å‚æ•°ä¼šè¢«å¼ºè½¬æˆå¯¹åº”çš„å¯¹è±¡ å¤±è´¥æŠ›å¼‚å¸¸ï¼ŒæˆåŠŸè¿”å› trapTarget   Reflect å‚æ•°åªèƒ½æ˜¯å¯¹è±¡ï¼Œå¦åˆ™æŠ¥é”™ å¤±è´¥è¿”å› false , æˆåŠŸè¿”å› true         å‚æ•°ä¸åŒç‚¹ï¼š\n1 2 3 4 5 6 7 8 9  let res = Object.getPrototypeOf(1) console.log(res === Number.prototype) // true  try { Reflect.getPrototypeOf(1) } catch (e) { console.log(e.message) }   +RESULTS:\ntrue Reflect.getPrototypeOf called on non-object  è¿”å›å€¼ä¸åŒç‚¹ï¼š\n1 2 3 4 5 6 7 8 9  let target1 = {} let res1 = Object.setPrototypeOf(target1, {}) console.log(res1 === target1) // true  let target2 = {} let res2 = Reflect.setPrototypeOf(target2, {}) console.log(res2 === target2) // false console.log(res2) // true   +RESULTS:\ntrue false true  å¯¹è±¡æ‰©å±•æ€§ Traps(Object Extensibility Traps) åœ¨ ECMAScript 5 ä¸­æ–°å¢äº†ä¸¤ä¸ªæ–¹æ³•ï¼š Object.preventExtensions() å’Œ\nObject.isExtensible() ç”¨æ¥é˜»æ­¢å¯¹è±¡è¢«æ‰©å±•å’Œæ£€æµ‹å¯¹è±¡çš„æ‰©å±•æ€§ï¼Œè¿™ä¸¤ä¸ª api éƒ½åª\næœ‰ä¸€ä¸ªå‚æ•° trapTarget è¡¨ç¤ºä½œç”¨çš„å¯¹è±¡ï¼Œè¿”å›å€¼éƒ½æ˜¯ boolean å‰è€…è¡¨ç¤ºé˜»æ­¢æ˜¯å¦\næˆåŠŸï¼Œåè€…è¡¨ç¤ºå¯¹è±¡æ˜¯å¦å¯æ‰©å±•ï¼Œåœ¨ proxy-reflect ä¸­ä¹Ÿæœ‰ç›¸åº”çš„ api ä¸ä¹‹å¯¹åº”ï¼Œä¸”\nå‚æ•°å’Œè¿”å›å€¼å‡ä¸€æ ·ã€‚\nObject.preventExtensions() é˜»æ­¢ç»™å¯¹è±¡å¢åŠ å±æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  let target = { value: 42 } let res = Object.isExtensible(target) target.name = \u0026#39;xxx\u0026#39; console.log(res, target) // true  Object.preventExtensions(target) target.age = \u0026#39;100\u0026#39; try { Object.defineProperty(target, \u0026#39;height\u0026#39;, { value: \u0026#39;166\u0026#39; }) } catch(e) { console.log(e.message) } res = Object.isExtensible(target) console.log(res, target) // false   +RESULTS: age å¹¶æ²¡æœ‰è¢«æ·»åŠ , height æ·»åŠ æŠ¥é”™\ntrue { value: 42, name: 'xxx' } Cannot define property height, object is not extensible false { value: 42, name: 'xxx' } undefined  ä»£ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  let target = {} let proxy = new Proxy(target, { isExtensible(trapTarget) { console.log(\u0026#39;is extensible ...\u0026#39;) return Reflect.isExtensible(trapTarget) }, preventExtensions(trapTarget) { console.log(\u0026#39;preventing extension\u0026#39;) return Reflect.preventExtensions(trapTarget) } }) console.log(Object.isExtensible(target), \u0026#39;before\u0026#39;) // true console.log(Object.isExtensible(proxy), \u0026#39;before\u0026#39;) // true  Object.preventExtensions(proxy) console.log(Object.isExtensible(target), \u0026#39;after\u0026#39;) // false console.log(Object.isExtensible(proxy), \u0026#39;after\u0026#39;) // false    +RESULTS: å› ä¸ºä½¿ç”¨äº† Reflect.xxx æ‰€ä»¥ä½œç”¨åœ¨ proxy ä¸Šçš„æ“ä½œä¹Ÿå°†ä½“ç°åœ¨ target ä¸Š\ntrue 'before' is extensible ... true 'before' preventing extension false 'after' is extensible ... false 'after'  å¦‚æœæ€»æ˜¯å…è®¸ä»£ç†å¯¹è±¡èƒ½è¢«æ‰©å±•ï¼Œåªéœ€è¦åœ¨ä»£ç†çš„ preventExtensions trap ä¸­ç›´æ¥è¿”å›\nfalse å°±è¡Œäº†ï¼Œä½†æ˜¯å¹¶ä¸å½±å“ target é™¤éè°ƒç”¨äº† reflect ã€‚\nReflect å’Œ Object ä¸Šçš„åŒºåˆ«ï¼š\n    isExtensible preventExtensions     Reflect å‚æ•°éå¯¹è±¡ï¼Œè§¦å‘å¼‚å¸¸ å‚æ•°éå¯¹è±¡ï¼Œè§¦å‘å¼‚å¸¸   Object å‚æ•°éå¯¹è±¡ï¼Œæ€»æ˜¯è¿”å› false å‚æ•°éå¯¹è±¡ï¼Œä¼šè¿”å›è¯¥å‚æ•°è‡ªèº«    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  let res1 = Object.isExtensible(1) console.log(res1) // false  try { Reflect.isExtensible(1) } catch(e) { console.log(e.message) } let res2 = Object.preventExtensions(1) console.log(res2) // true  try { Reflect.preventExtensions(1) } catch(e) { console.log(e.message) }   +RESULTS:\nfalse Reflect.isExtensible called on non-object 1 Reflect.preventExtensions called on non-object  å±æ€§æè¿°ç¬¦ Traps(Property Descriptor Traps) ECMAScript 5 æ›´æ–°ä¸­åŒ…å«äº†å¯ä»¥é€šè¿‡ Object.defineProperty(obj, key, descObj) è‡ª\nå®šä¹‰å±æ€§çš„åŠŸèƒ½ï¼Œè¿™è®©å¼€å‘è€…å¯ä»¥è‡ªå·±å®šä¹‰ä¸€äº›ç‰¹å®šåŠŸèƒ½çš„å¯¹è±¡å±æ€§ï¼Œæ¯”å¦‚ï¼šåªè¯»ã€åªå†™ã€\næˆ–ä¸å¯æšä¸¾ç­‰ç­‰ç‰¹æ€§ï¼Œç„¶åå¯ä»¥é€šè¿‡ Object.getOwnPropertyDescriptor() æ¥è·å–å¯¹è±¡\nå±æ€§çš„æè¿°ç¬¦å¯¹è±¡ã€‚\nObject.defineProperty() è¯¦ç»†ä½¿ç”¨\nå±æ€§æè¿°ç¬¦ä»£ç† åœ¨ proxy-reflect ä¸­å¯¹åº”ç€ï¼š\n defineProperty -\u0026gt; Reflect.defineProperty(trapTarget, key, descriptor) getOwnPropertyDescriptor -\u0026gt; Reflect.getOwnPropertyDescriptor(trapTarget, key)  è¿”å›å€¼ï¼š\ndefineProperty æˆåŠŸè¿”å› true, å¤±è´¥è¿”å› false\ngetOwnPropertyDescriptor æˆåŠŸè¿”å›æè¿°ç¬¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  let target = {} let proxy = new Proxy(target, { definePropery(trapTarget, key, descriptor) { return Reflect.defineProperty(trapTarget, key, descriptor) }, getOwnPropertyDescriptor(trapTarget, key) { return Reflect.getOwnPropertyDescriptor(trapTarget, key) } }) Object.defineProperty(proxy, \u0026#39;name\u0026#39;, { value: \u0026#39;proxy\u0026#39; }) console.log(proxy.name) // \u0026#39;proxy\u0026#39;  let descriptor = Object.getOwnPropertyDescriptor(proxy, \u0026#39;name\u0026#39;) console.log(descriptor.value) // \u0026#39;proxy\u0026#39;   +RESULTS:\nproxy proxy  é˜»æ­¢ç»™å¯¹è±¡æ‰©å±•ç¬¦å·å±æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  let target = {} let proxy = new Proxy(target, { defineProperty(trapTarget, key, descriptor) { if (typeof key === \u0026#39;symbol\u0026#39;) { return false; } return Reflect.defineProperty(trapTarget, key, descriptor) } }) Object.defineProperty(proxy, \u0026#39;name\u0026#39;, { value: \u0026#39;proxy\u0026#39; }) console.log(proxy.name) // \u0026#39;proxy\u0026#39; let nameSymbol = Symbol(\u0026#39;name\u0026#39;); // error try { Object.defineProperty(proxy, nameSymbol, { value: \u0026#39;symbol-proxy\u0026#39; }) } catch(e) { console.log(e.message) }   +RESULTS:\nproxy 'defineProperty' on proxy: trap returned falsish for property 'Symbol(name)'  å› ä¸º Object.defineProperty() è¿”å› false çš„è¯ä¼šè§¦å‘å¼‚å¸¸è¡¨ç¤ºæ‰©å±•å¤±è´¥ã€‚\nå¦‚æœæƒ³è¦æ‰©å±•å¤±è´¥éšè—å¼‚å¸¸ï¼Œå¯ä»¥åœ¨ trap ä¸­ä¸æ»¡è¶³æ¡ä»¶çš„æ—¶å€™ä¹Ÿè®©å®ƒè¿”å› true\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  let target = {} let proxy = new Proxy(target, { defineProperty(trapTarget, key, descriptor) { if (typeof key === \u0026#39;symbol\u0026#39;) { return true; } return Reflect.defineProperty(trapTarget, key, descriptor) } }) Object.defineProperty(proxy, \u0026#39;name\u0026#39;, { value: \u0026#39;proxy\u0026#39; }) console.log(proxy.name) // \u0026#39;proxy\u0026#39; let nameSymbol = Symbol(\u0026#39;name\u0026#39;); // error Object.defineProperty(proxy, nameSymbol, { value: \u0026#39;symbol-proxy\u0026#39; })   +RESULTS: è¿è¡Œç»“æœæ— é”™è¯¯æç¤ºï¼Œå› ä¸º key === 'symbol' æ¡ä»¶ä¸­ä¾æ—§è¿”å›äº† true\nproxy  æ ‡å‡†ä¸­å¤±è´¥æŠ›å¼‚å¸¸ï¼š  æè¿°ç¬¦å¯¹è±¡çº¦æŸ(Descriptor Object Restrictions) åœ¨ä¸Šä¸€èŠ‚ä¸­æè¿°äº†å±æ€§æè¿°ç¬¦ä»£ç†çš„ä½¿ç”¨ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯¹æè¿°ç¬¦å¯¹è±¡çš„å®šä¹‰æœ‰ä¸€å®šçš„çº¦æŸ\næ¡ä»¶ï¼Œæ¯”å¦‚ defineProperty(trapTarget, key, descriptor) ç¬¬ä¸‰ä¸ªå‚æ•°å°±å¹¶éæ˜¯å®Œæ•´\nçš„ä¼ å…¥çš„æè¿°ç¬¦å¯¹è±¡ Object.defineProperty(obj, key, descObj) ã€‚\nåœ¨ trap çš„ descriptor ä¼šå¿½ç•¥æ‰é™¤ä¸‹é¢å±æ€§ä»¥å¤–çš„å±æ€§,\n enumerable configurable value writable get set  é™¤äº†ä¸Šé¢ 6 ä¸ªå±æ€§ä¹‹å¤–ï¼Œå…¶ä»–çš„å±æ€§éƒ½ä¼šè¢«å¿½ç•¥æ‰ï¼Œå³ä½¿ä½ è°ƒç”¨\nObject.defineProperty çš„æ—¶å€™ä¼ å…¥äº†æ›´å¤šçš„å±æ€§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  let proxy = new Proxy({}, { defineProperty(trapTarget, key, descriptor) { console.log(descriptor.value) // \u0026#39;proxy\u0026#39;  console.log(descriptor.name) // undefined  return Reflect.defineProperty(trapTarget, key, descriptor); } }) Object.defineProperty(proxy, \u0026#39;name\u0026#39;, { value: \u0026#39;proxy\u0026#39;, name: \u0026#39;custom\u0026#39; })   +RESULTS: ç»“æœæ˜¾ç¤ºå®é™…ä¼ å…¥çš„ {value: 'proxy', name: 'custom'} åœ¨ trap ä¸­å¹¶æ²¡æœ‰\nname ã€‚\nproxy undefined  è¿™æ˜¯å› ä¸º trap ä¸­çš„ descriptor å‚æ•°å¹¶éæ˜¯ {value: 'proxy', name: 'custom'} å¯¹\nè±¡çš„å¼•ç”¨ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œåªä¼šåŒ…å«æ ‡å‡†çš„ 6 ä¸ªå±æ€§å€¼ï¼Œå…¶ä»–çš„å‡ä¸ä¼šæ”¶è—ã€‚\nåŒæ ·ï¼Œ Reflect.defineProperty() ä¹Ÿä¸€æ ·ä¼šå¿½ç•¥æ‰éæ ‡å‡†çš„å±æ€§ã€‚\nåœ¨ getOwnPropertyDescriptor() æ–¹æ³•ä¸­ä¹Ÿæœ‰æ­¤ç±»çº¦æŸï¼Œè¿™ä¸ªæ–¹æ³•è¦æ±‚å®ƒçš„è¿”å›å€¼å¿…é¡»æ˜¯\nnull, undefined æˆ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå°±ä¼šéµå¾ªè¿™ä¸ªçº¦æŸï¼Œå³è¿”å›çš„\nå¯¹è±¡ä¸­åªèƒ½åŒ…å«æ ‡å‡†çš„å±æ€§(enumerable, configurable, value, writable,\nget, set)\n1 2 3 4 5 6 7 8 9 10 11 12 13  let proxy = new Proxy({}, { getOwnPropertyDescriptor(trapTarget, key) { return { name: \u0026#39;proxy\u0026#39; } } }) try { let descriptor = Object.getOwnPropertyDescriptor(proxy, \u0026#39;name\u0026#39;) } catch(e) { console.log(e) }   +RESULTS:\nTypeError: 'getOwnPropertyDescriptor' on proxy: trap reported non-configurability for property 'name' which is either non-existant or configurable in the proxy target  é‡å¤çš„æè¿°ç¬¦æ–¹æ³• ä¸ä¹‹å‰æè¿°çš„ä¸€æ ·åœ¨ Object å’Œ Reflect éƒ½åŒæ—¶æœ‰ defineProperty() å’Œ\ngetOwnPropertyDescriptor() æ–¹æ³•ï¼Œä½†åŒæ–¹éƒ½æœ‰ä¸€ç‚¹å·®å¼‚ã€‚\n Object.defineProperty(target) è¿”å› target å¯¹è±¡ Reflect.defineProperty(trapTarget, key, descriptor) è¿”å› true æˆ– false\nè¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥  1 2 3 4 5 6 7 8 9 10 11 12  let target = {} let res1 = Object.defineProperty(target, \u0026#39;name\u0026#39;, { value: \u0026#39;target\u0026#39;, configurable: true }) console.log(res1 === target) // true  let res2 = Reflect.defineProperty(target, \u0026#39;name\u0026#39;, { value: \u0026#39;reflect\u0026#39; }) console.log(res2) // true   +RESULTS:\ntrue true   Object.getOwnPropertyDescriptor(obj, key) å¦‚æœ obj æ˜¯åŸå§‹ç±»å‹ä¼šå¼ºåˆ¶è½¬æ¢æˆ\nå¯¹è±¡åå†è·å–æè¿°ç¬¦å¯¹è±¡ï¼Œæ²¡æœ‰å°±è¿”å› undefined Reflect.getOwnPropertyDescriptor(obj, key) å’Œä¸Šé¢çš„ä¸ä¸€æ ·ï¼Œå¦‚æœä¸ºéå¯¹è±¡ç±»å‹\nåˆ™ä¼šè§¦å‘å¼‚å¸¸ã€‚  1 2 3 4 5 6 7 8  let res1 = Object.getOwnPropertyDescriptor(2, \u0026#39;name\u0026#39;) console.log(res1) // undefined  try { let res2 = Reflect.getOwnPropertyDescriptor(2, \u0026#39;name\u0026#39;) } catch(e) { console.log(e.message) }   +RESULTS:\nundefined Reflect.getOwnPropertyDescriptor called on non-object  ownKeys Trap ownKeys -\u0026gt; Reflect.ownKeys(trapTarget)\nè¿™ä¸ª trap çš„ç”¨é€”æ˜¯ç”¨æ¥ä¸­æ–­ [[OwnPropertyKeys] ] çš„æ“ä½œï¼Œç„¶åå…è®¸åœ¨ trap é‡Œé¢é‡\nå†™â€œè¿”å›ä¸€ä¸ªå€¼çš„æ•°ç»„â€çš„åŠ¨ä½œã€‚\næœ‰å››ä¸ªå†…ç½®æ–¹æ³•ç”¨åˆ°è¿™ä¸ªæ•°ç»„(ownKeys)\n Object.keys() ä¼šè¿‡æ»¤æ‰ ownKeys ä¸­çš„ç¬¦å·ç±»å‹ key Object.getOwnPropertyNames() ä¼šè¿‡æ»¤æ‰ ownKeys ä¸­çš„ç¬¦å·ç±»å‹ key Object.getOwnPropertySymbols() ä¼šè¿‡æ»¤æ‰ ownKeys ä¸­çš„å­—ç¬¦ä¸²ç±»å‹ key Object.assign() ç”¨ ownKeys æ¥å†³å®šå“ªäº›å±æ€§ä¼šè¢«æ‹·è´ï¼Œå­—ç¬¦ä¸²å’Œç¬¦å· key éƒ½ä¼šç”¨\nåˆ°  å¯¹åº”é»˜è®¤è¡Œä¸ºçš„ trap æ˜¯ï¼š Reflect.ownKeys() è¿”å›ä¸€ä¸ªæ‰€æœ‰è‡ªèº«å±æ€§çš„ keyï¼ŒåŒ…å«ç¬¦\nå·å±æ€§ã€‚\næ¥å—ä¸€ä¸ªå¯¹è±¡å‚æ•°ï¼Œä¸”è¿”å›æ•°ç»„æˆ–ç±»æ•°ç»„å¯¹è±¡å¦åˆ™ä¼šæŠ¥é”™ï¼Œä½¿ç”¨ ownKeys trap å¯ä»¥è®©æˆ‘ä»¬\nåœ¨å¯¹è¯¥å¯¹è±¡ä½¿ç”¨è¯¸å¦‚ Object.keys(), Object.getOwnPropertyNames(), ç­‰ç­‰è¿™äº›æ–¹æ³•\nçš„æ—¶å€™å»è¿‡æ»¤ä¸€äº›æˆ‘ä»¬ä¸æƒ³è®©äººè·å–åˆ°çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„å†…éƒ¨æ–¹æ³•(ä¸€èˆ¬ä½¿\nç”¨ä¸‹åˆ’çº¿å¼€å¤´çš„æ”¾è¡¨ç¤ºå†…éƒ¨æ–¹æ³•)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  let proxy = new Proxy({}, { ownKeys(trapTarget) { return Reflect .ownKeys(trapTarget) // è¿‡æ»¤æ‰ _xxx() {} çš„æ–¹æ³•  .filter(key =\u0026gt; typeof key !== \u0026#39;string\u0026#39; || key[0] !== \u0026#39;_\u0026#39;) } }) let nameSymbol = Symbol(\u0026#39;name\u0026#39;) proxy.name = \u0026#39;proxy\u0026#39; proxy._name = \u0026#39;private\u0026#39; proxy[nameSymbol] = \u0026#39;symbol\u0026#39; let names = Object.getOwnPropertyNames(proxy), // ä¼šè¿‡æ»¤ç¬¦å·key  keys = Object.keys(proxy), // ä¼šè¿‡æ»¤ç¬¦å· key  symbols = Object.getOwnPropertySymbols(proxy) console.log(names.length) // 1 console.log(names[0]) // \u0026#39;name\u0026#39;  console.log(keys.length) // 1 console.log(keys[0]) // \u0026#39;name\u0026#39;  console.log(symbols.length) // 1 console.log(symbols[0]) // \u0026#34;Symbol(name)\u0026#34;   +RESULTS: å‰ä¸¤ä¸ªä¸º 1 æ˜¯å› ä¸º Object.getOwnPropertyNames() å’Œ Object.keys() é»˜\nè®¤ä¼šè¿‡æ»¤æ‰ç¬¦å·å±æ€§ã€‚\n1 name 1 name 1 Symbol(name)   ownKeys å¯¹ for-in å¾ªç¯ä¸­ä¹Ÿæœ‰æ•ˆï¼Œå®ƒä¼šè°ƒç”¨ ownKeys trap æ¥å†³å®šå“ªäº›é”®å¯ä»¥è¢«éå†ã€‚\n å‡½æ•°ä»£ç†(applyå’Œconstruct traps) åœ¨æ‰€æœ‰çš„ traps ä¸­ï¼Œåªæœ‰ apply å’Œ construct trap å¿…é¡»è¦æ±‚ trapTarget æ˜¯ä¸€ä¸ª\nå‡½æ•°ã€‚\nè¿™ä¸¤ä¸ª trap åˆ†åˆ«å¯¹åº” [[Call] ] å’Œ [[Construct] ] ä½çº§æ“ä½œï¼Œè€Œè¿™ä¸¤ä¸ªå†…éƒ¨å±æ€§\nå¯¹åº”çš„æ˜¯å‡½æ•°çš„ä¸¤ç§è°ƒç”¨æ–¹å¼(1. å‡½æ•°æ–¹å¼è°ƒç”¨ï¼Œ2. é€šè¿‡ new è°ƒç”¨)ï¼Œé€šè¿‡ apply å’Œ\nconstruct è¿™ä¸¤ä¸ª trap å¯ä»¥æ‹¦æˆªè¿™ä¸¤ç§è°ƒç”¨æ“ä½œã€‚\napply -\u0026gt; Reflect.apply(trapTarget, thisArg, argumentsList)\nconstruct -\u0026gt; Reflect.construct(trapTarget, argumentsList[, newTarget])\n trapTarget è¢«ä»£ç†çš„é‚£ä¸ªå‡½æ•°å¯¹è±¡ thisArg è°ƒç”¨ apply æ—¶æŒ‡å®šçš„ä½œç”¨åŸŸå¯¹è±¡ argumentsList ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°åˆ—è¡¨ newTarget æŒ‡å‘å‡½æ•°å†…éƒ¨ new.target çš„å€¼  ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  let target = function() { return 42 } let proxy = new Proxy(target, { apply(trapTarget, thisArg, argList) { console.log(thisArg, \u0026#39;applied\u0026#39;) return Reflect.apply(trapTarget, thisArg, argList) }, construct(trapTarget, argList, newTarget) { console.log(newTarget, \u0026#39;newTarget\u0026#39;) return Reflect.construct(trapTarget, argList) } }) console.log(typeof proxy) // function console.log(proxy()) // 42  var ins = new proxy() console.log(ins instanceof proxy) console.log(ins instanceof target) proxy.apply({a:1}) target.apply({a:1})   +RESULTS: apply å’Œ construct åˆ†åˆ«ä»£ç†äº†å‡½æ•°çš„ä¸¤ç§ä¸ç”¨ä½¿ç”¨æ–¹å¼(apply å’Œ new)ã€‚\nfunction undefined 'applied' 42 [Function: target] 'newTarget' true true { a: 1 } 'applied' undefined  ä»ç»“æœå¯çŸ¥ newTarget å‚æ•°æŒ‡å‘çš„æ˜¯è¢«ä»£ç†çš„é‚£ä¸ªåŸå§‹å¯¹è±¡ trapTarget ã€‚\nä¸‹é¢å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ä¸ªä»£ç†åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚éªŒè¯å‚æ•°æˆ–éªŒè¯å‡½æ•°è°ƒç”¨æ–¹å¼ã€‚\néªŒè¯å‡½æ•°å‚æ•° æ£€æŸ¥å‡½æ•°å‚æ•°çš„åˆæ³•æ€§ï¼Œæˆ–é™å®šå‡½æ•°åªèƒ½ä»¥æ™®é€šæ–¹å¼è°ƒç”¨ä¸èƒ½é€šè¿‡ new è°ƒç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  function sum(...values) { return values.reduce((prev, next) =\u0026gt; prev + next, 0) } let sumProxy = new Proxy(sum, { apply(trapTarget, thisArg, argList) { argList.forEach(arg =\u0026gt; { if (typeof arg !== \u0026#39;number\u0026#39;) { throw new TypeError(\u0026#39;æ‰€æœ‰å‚æ•°å¿…é¡»æ˜¯æ•°å­—ã€‚\u0026#39;) } }) return Reflect.apply(trapTarget, thisArg, argList) }, construct(trapTarget, argList) { throw new TypeError(\u0026#39;è¿™ä¸ªå‡½æ•°ä¸èƒ½è¢« new å®ä¾‹åŒ–ã€‚\u0026#39;) } }) console.log(sumProxy(1, 2, 3, 4)) try { console.log(sumProxy(1, \u0026#39;2\u0026#39;, 3, 4)) } catch(e) { console.log(e.message) } try { let res = new sumProxy() } catch(e) { console.log(e.message) }   +RESULTS:\n10 æ‰€æœ‰å‚æ•°å¿…é¡»æ˜¯æ•°å­—ã€‚ è¿™ä¸ªå‡½æ•°ä¸èƒ½è¢« new å®ä¾‹åŒ–ã€‚  ä¸Šé¢ä¾‹å­ä¹Ÿå¯ä»¥åè¿‡æ¥åªå…è®¸ new å®ä¾‹åŒ–ï¼Œä¸èƒ½è¢«ç›´æ¥è°ƒç”¨ã€‚\næ—  new ç›´æ¥è°ƒç”¨æ„é€ å‡½æ•°æ£€æµ‹ æ ¹æ® construct trap çš„ç¬¬ä¸‰ä¸ªå¯é€‰å‚æ•° newTarget è¿™ä¸ªå€¼æŒ‡å‘çš„æ˜¯å‡½æ•°çš„\nnew.target å€¼(new.target)ã€‚\nè¿™ä¸ªå€¼ç”±ä¸¤ç§å€¼ï¼š 1. å‡½æ•°è°ƒç”¨æ—¶å€¼ä¸º undefined , 2. new å®ä¾‹åŒ–æ—¶ä¸ºå½“å‰æ„é€ å‡½æ•°\næœ¬èº«ã€‚\nä½¿ç”¨ apply å’Œ construct ä¸¤ä¸ª trap ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥åšåˆ°è®©ä¸€ä¸ªå‡½æ•°æ—  new æƒ…å†µä¸‹ç›´\næ¥è°ƒç”¨æ„é€ å‡½æ•°å°±å¯ä»¥å®ä¾‹åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function Nums(...values) { if (new.target === \u0026#39;undefined\u0026#39;) { throw new TypeError(\u0026#39;è¯¥å‡½æ•°å¿…é¡»é€šè¿‡ `new` è°ƒç”¨ã€‚\u0026#39;) } this.values = values } let NumsProxy = new Proxy(Nums, { apply: function(trapTarget, thisArg, argList) { console.log(argList.toString()) return Reflect.construct(trapTarget, argList) } }) let ins = NumsProxy(1, 2, 3, 4) console.log(ins.values)   +RESULTS:\n1,2,3,4 [ 1, 2, 3, 4 ]  é‡å†™æŠ½è±¡åŸºç±»(Abstract Base Class)æ„é€ å‡½æ•° è®©ä¸€ä¸ªç±»æ™ºèƒ½è¢«ç»§æ‰¿ï¼Œä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°å†…éƒ¨çš„ new.target æ¥æ£€æµ‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  class AbstractNums { constructor(...values) { if (new.target === AbstractNums) { throw new TypeError(\u0026#39;è¯¥ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œåªèƒ½è¢«ç»§æ‰¿ã€‚\u0026#39;) } this.values = values } } class Nums extends AbstractNums { } let ins = new Nums(1, 2, 3, 4) console.log(ins.values.toString()) try { new AbstractNums(1, 2, 3, 4) } catch(e) { console.log(e.message) }   +RESULTS:\n1,2,3,4 è¯¥ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œåªèƒ½è¢«ç»§æ‰¿ã€‚  é€šè¿‡ä»£ç†å®ç°å±è”½è¿™é‡Œçš„å¼‚å¸¸ï¼Œå³è®© AbstractNums æ„é€ å‡½æ•°ä¸­çš„æ£€æµ‹å¤±è´¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  class AbstractNums { construct(...values) { if (new.target === AbstractNums) { throw new TypeError(\u0026#39;è¯¥ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œåªèƒ½è¢«ç»§æ‰¿ã€‚\u0026#39;) } this.values = values console.log(this.values.toString(), \u0026#39;this.values\u0026#39;) } } let AbstractNumsProxy = new Proxy(AbstractNums, { construct: function(trapTarget, argList) { console.log(argList.toString(), \u0026#39;proxy\u0026#39;); // å› ä¸ºç¬¬ä¸‰ä¸ªå‚æ•°å³ new.target å€¼ï¼Œè¿™é‡Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’ä¸ªç©ºå‡½æ•°  return Reflect.construct(trapTarget, argList, function() {}) } }) /// è¿™é‡Œå°±ä¸ä¼šæŠ¥é”™äº† let ins = new AbstractNumsProxy(1, 2, 3, 4) console.log(ins.values, \u0026#39;eee\u0026#39;)   å¯è°ƒç”¨çš„ç±»çš„æ„é€ å‡½æ•° ç±»çš„ä½¿ç”¨ï¼Œåœ¨ä»£ç†å‡ºç°ä¹‹å‰æ˜¯æ— æ³•ç›´æ¥è°ƒç”¨çš„ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„ [[Call] ] å±æ€§è¢«ç»‘å®šåˆ°\nå¼‚å¸¸ä¸Šï¼Œåªè¦å‘ç”Ÿè°ƒç”¨å°±ä¼šè§¦å‘å¼‚å¸¸ã€‚\nä½†æ˜¯æœ‰äº†ä»£ç†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»£ç†å»å®ç°ä¸€ä¸ªå¯ç›´æ¥è°ƒç”¨çš„ç±»å»åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œå®é™…ä¸Š\nè¿˜æ˜¯ä»£ç†é‡Œé¢å»åˆ›å»ºäº†å®ä¾‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  class Person { constructor(name) { this.name = name } } let PersonProxy = new Proxy(Person, { apply: function(trapTarget, thisArg, argList) { return new trapTarget(...argList) } }) let me = PersonProxy(\u0026#39;xxx\u0026#39;) console.log(me.name) // xxx console.log(me instanceof Person) // true console.log(me instanceof PersonProxy) // true   +RESULTS:\nxxx true true  å¯æ’¤é”€çš„ä»£ç†(Revocable) é€šå¸¸æƒ…å†µä¸‹ï¼Œä»£ç†ä¸€æ—¦è¢«åˆ›å»ºå°±æ— æ³•ä¸ target è§£ç»‘ï¼Œä½†æ˜¯æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚ä»£ç†å¯\nèƒ½ä¸å†éœ€è¦äº†ï¼Œéœ€è¦å°†å…¶è§£ç»‘æ‰ã€‚\nåœ¨è¿™ä¹‹å‰é€šè¿‡ new Proxy() åˆ›å»ºçš„éƒ½æ˜¯ä¸å¯æ’¤é”€çš„ä»£ç†ï¼Œå¦‚æœéœ€è¦åˆ›å»ºå¯æ’¤é”€çš„ä»£ç†å¾—\nä½¿ç”¨ Proxy.revocable() æ¥å£ã€‚\nå‚æ•°å’Œ Proxy() ä¸€æ ·ï¼Œéœ€è¦ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡å’Œä¸€ä¸ªä»£ç† traps å¯¹è±¡ï¼š\nProxy.revocable(target, trapObj)\nè°ƒç”¨ä¹‹åçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼š\n proxy ä¸€ä¸ªå¯è¢«æ’¤é”€çš„ä»£ç† revoke ç”¨æ¥æ’¤é”€ä»£ç†çš„å‡½æ•°  ä»»ä½•æ—¶å€™æ‰§è¡Œäº† revoke() é‚£å°±è¡¨ç¤º proxy ä¸å†å¯ç”¨ï¼Œä»»æ„è¯•å›¾å»é€šè¿‡ proxy trap\nå»ä¸­æ–­ä½çº§æ“ä½œçš„è¡Œä¸ºéƒ½å°†è§¦å‘å¼‚å¸¸ï¼Œå› ä¸º proxy å·²ç»è¢«æ’¤é”€äº†æ²¡æ³•ç”¨äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let target = { name: \u0026#39;target\u0026#39; } let { proxy, revoke } = Proxy.revocable(target, {}) console.log(proxy.name) revoke(); try { console.log(proxy.name) } catch(e) { console.log(e.message) }   +RESULTS:\ntarget Cannot perform 'get' on a proxy that has been revoked  è§£å†³æ•°ç»„é—®é¢˜ proxy-reflect çš„å‡ºç°åŒæ ·èµ‹äºˆäº†å¼€å‘è€…è·Ÿè¸ªæ•°ç»„å˜åŒ–çš„èƒ½åŠ›ï¼Œæ¯”å¦‚æ•°ç»„é•¿åº¦å˜åŒ–å¯ä»¥åšä¸€\näº›ç‰¹æ®Šå¤„ç†ã€‚\nå¯¹æ•°ç»„çš„è®¿é—®å’Œè®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ä¹‹å‰è®²è¿‡çš„ get-trap(13.3.3) å’Œ set-trap(13.3.2)ï¼Œ\nç”¨æ¥ç›‘å¬æ•°ç»„çš„è®¿é—®ã€é•¿åº¦æˆ–å†…å®¹çš„å˜åŒ–ã€‚\nç›‘å¬æ•°ç»„é•¿åº¦çš„å˜åŒ– é€šè¿‡æ•°ç»„å¯¹è±¡çš„ä»£ç†ï¼Œå¯ä»¥ç›‘å¬æ•°ç»„å¯¹è±¡é•¿åº¦æˆ–å€¼çš„å˜åŒ–ï¼Œä»è€Œè§¦å‘ä¸€äº›è‡ªå®šä¹‰çš„è¡Œä¸ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  const toUnit32 = v =\u0026gt; Math.floor(Math.abs(Number(v))) % Math.pow(2, 32) const isArrayIndex = key =\u0026gt; { let numericKey = toUnit32(key) return String(numericKey) == key \u0026amp;\u0026amp; numericKey \u0026lt; (Math.pow(2, 32) - 1) } function createArray(length = 0) { return new Proxy({ length }, { set(trapTarget, key, value) { let currLen = Reflect.get(trapTarget, \u0026#39;length\u0026#39;) if (isArrayIndex(key)) { let numericKey = Number(key) if (numericKey \u0026gt;= currLen) { Reflect.set(trapTarget, \u0026#39;length\u0026#39;, numericKey + 1) } } return Reflect.set(trapTarget, key, value) } }) } let colors = createArray(3) console.log(colors.length) colors[0] = \u0026#39;red\u0026#39; colors[1] = \u0026#39;green\u0026#39; colors[2] = \u0026#39;blue\u0026#39; console.log(colors.length) colors[3] = \u0026#39;black\u0026#39; console.log(colors.length) console.log(colors[3])   +RESULTS:\n3 3 4 black undefined  åˆ é™¤æ•°ç»„å…ƒç´  åœ¨ä»¥å¾€ï¼Œè¦åˆ é™¤æ•°ç»„å…ƒç´ (ç¼©å‡æ•°ç»„)ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„é•¿åº¦çš„è®¾ç½®æ¥è¾¾åˆ°ç›®çš„ï¼Œæ•°ç»„å¤šä½™çš„å…ƒç´ ä¼šè¢«æŠ›å¼ƒæ‰ã€‚\n1 2 3 4 5 6  let nums = [1, 2, 3] console.log(nums.toString()) nums.length = 1 console.log(nums.toString()) nums.length = 3 console.log(nums.toString())   +RESULTS:\n1,2,3 1 1,,  ä½¿ç”¨ä»£ç†ä¹Ÿå¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå¹¶ä¸”å¯ä»¥ç›‘å¬æ•°ç»„çš„å˜åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  const toUnit32 = v =\u0026gt; Math.floor(Math.abs(Number(v))) % Math.pow(2, 32) const isArrayIndex = key =\u0026gt; { let numericKey = toUnit32(key) return String(numericKey) == key \u0026amp;\u0026amp; numericKey \u0026lt; (Math.pow(2, 32) - 1) } function createArray(length = 0) { return new Proxy({ length }, { set(trapTarget, key, value) { let currLen = Reflect.get(trapTarget, \u0026#39;length\u0026#39;) if (isArrayIndex(key)) { let numericKey = Number(key) if (numericKey \u0026gt;= currLen) { Reflect.set(trapTarget, \u0026#39;length\u0026#39;, numericKey + 1) } } else if (key == \u0026#39;length\u0026#39;) { if (value \u0026lt; currLen) { for (let i = currLen - 1; i \u0026gt;= value; i--) { Reflect.deleteProperty(trapTarget, i) } } } return Reflect.set(trapTarget, key, value) } }) } let colors = createArray(3) console.log(colors.length) colors[0] = \u0026#39;red\u0026#39; colors[1] = \u0026#39;green\u0026#39; colors[2] = \u0026#39;blue\u0026#39; colors[3] = \u0026#39;black\u0026#39; console.log(colors.length) colors.length = 2 console.log(colors.length) console.log(colors[3]) // undefined console.log(colors[2]) // undefined console.log(colors[1]) // \u0026#39;green\u0026#39; console.log(colors[0]) // \u0026#39;black\u0026#39;   +RESULTS:\n3 4 2 undefined undefined green red  ä¸Šé¢ä»£ç ä¸­å®ç°äº†ä¸¤ç§å˜åŒ–ï¼š\n key ä¸ºæ•°ç»„ä¸‹æ ‡ï¼Œå³æ•°ç»„å…ƒç´ å€¼çš„å˜åŒ–ï¼Œä¼šå°†é•¿åº¦åŸºäºå®ƒçš„ç´¢å¼•åŠ  1 length å±æ€§å€¼çš„å˜åŒ–ï¼Œå¦‚æœæ–°çš„é•¿åº¦å€¼å°äºåŸæœ‰çš„å…ƒç´ é•¿åº¦ï¼Œå¤šä½™çš„å…ƒç´ ä¼šè¢«åˆ é™¤æ‰  å®ç°æ•°ç»„ç±» æœ€ç®€å•çš„å®ç°æ–¹å¼æ˜¯æŒ‰ç…§æ™®é€šç±»å®šä¹‰ç„¶ååœ¨æ„é€ å‡½æ•°ä¸­è¿”å›ä¸€ä¸ªä»£ç†ã€‚\n1 2 3 4 5 6 7 8  class Thing { constructor() { return new Proxy(this, {}) } } let myTh = new Thing() console.log(myTh instanceof Thing) // true   è¿”å›çš„ new Proxy(this, {}) æœ‰ä¸¤ä¸ªå‚æ•°ï¼š\n this ä¸º Thing ç±»çš„å®ä¾‹ {} ä¸º Thing å®ä¾‹çš„ä»£ç† trap å¯¹è±¡  myTh æ˜¯ Thing å®ä¾‹çš„ä»£ç†å¯¹è±¡ã€‚\nè¿™é‡Œçš„å®ç°å’Œâ€œåˆ é™¤æ•°ç»„å…ƒç´ 13.10.2â€ä¸€èŠ‚ä¸­åŸºæœ¬ä¸€æ ·ï¼Œä¸åŒç‚¹åœ¨äº new Proxy() åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­è¿”å›ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  const toUnit32 = v =\u0026gt; Math.floor(Math.abs(Number(v))) % Math.pow(2, 32) const isArrayIndex = key =\u0026gt; { let numericKey = toUnit32(key) return String(numericKey) == key \u0026amp;\u0026amp; numericKey \u0026lt; (Math.pow(2, 32) - 1) } class MyArray { constructor(length = 0) { return new Proxy({ length }, { set(trapTarget, key, value) { let currLen = Reflect.get(trapTarget, \u0026#39;length\u0026#39;) if (isArrayIndex(key)) { let numericKey = Number(key) if (numericKey \u0026gt;= currLen) { Reflect.set(trapTarget, \u0026#39;length\u0026#39;, numericKey + 1) } } else if (key == \u0026#39;length\u0026#39;) { if (value \u0026lt; currLen) { for (let i = currLen - 1; i \u0026gt;= value; i--) { Reflect.deleteProperty(trapTarget, i) } } } return Reflect.set(trapTarget, key, value) } }) } } let colors = new MyArray(3) console.log(colors.length) colors[0] = \u0026#39;red\u0026#39; colors[1] = \u0026#39;green\u0026#39; colors[2] = \u0026#39;blue\u0026#39; colors[3] = \u0026#39;black\u0026#39; console.log(colors.length) colors.length = 2 console.log(colors.length) console.log(colors[3]) // undefined console.log(colors[2]) // undefined console.log(colors[1]) // \u0026#39;green\u0026#39; console.log(colors[0]) // \u0026#39;black\u0026#39;    +RESULTS:\n3 4 2 undefined undefined green red  Proxy ä½œä¸ºåŸå‹ä½¿ç”¨ï¼Œä»è€Œå®ä¾‹å…±äº«ä»£ç† åŸå‹ get trap åŸå‹ä»£ç†åœ¨ä½¿ç”¨ä¸Šæœ‰ä¸€å®šçš„é™åˆ¶ï¼Œå®ƒåªèƒ½å“åº”åŸå‹è‡³ä¸Šçš„æ“ä½œï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  let target = {} let newTarget = Object.create(new Proxy(target, { defineProperty(trapTarget, name, descriptor) { // æ­£å¸¸çš„è¯è¿™é‡Œè¿”å› false ä¼šè§¦å‘å¼‚å¸¸  return false; } })) Object.defineProperty(newTarget, \u0026#39;name\u0026#39;, { value: \u0026#39;newTarget\u0026#39; }) console.log(newTarget.name) // \u0026#39;newTarget\u0026#39; console.log(newTarget.hasOwnProperty(\u0026#39;name\u0026#39;)) // true   +RESULTS:\nnewTarget true  ä¸Šé¢çš„ä»£ç†å¹¶æ²¡æœ‰å“åº” name å±æ€§å¢åŠ æ“ä½œï¼Œå› ä¸º new Proxy() åœ¨\nObject.create(proxy) ä½œä¸ºå‚æ•°ä¼ é€’ç»“æœä¼šæ˜¯æ–°åˆ›å»ºå¯¹è±¡çš„åŸå‹ï¼Œä¹Ÿå°±æ˜¯è¯´\nnewTarget çš„åŸå‹æ˜¯ new Proxy() çš„ä»£ç†ï¼Œè€ŒåŸå‹ä»£ç†æ˜¯æ²¡æ³•å“åº”å¯¹è±¡æœ¬èº«çš„å˜åŒ–ã€‚\nä½†æ˜¯åœ¨æœ‰äº›æƒ…å†µä¸‹åŸå‹ä»£ç†è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œæ¯”å¦‚è·å–å¯¹è±¡å±æ€§æ“ä½œï¼Œå› ä¸ºå¯¹è±¡çš„è·å–éµå¾ªåŸ\nå‹é“¾æŸ¥æ‰¾ï¼Œå¦‚æœå¯¹è±¡æœ¬èº«æ‰¾ä¸åˆ°è¯¥å±æ€§å°±ä¼šå¾€ä¸ŠæŸ¥æ‰¾åŸå‹å¯¹è±¡ï¼Œæ­¤æ—¶å¦‚æœåŸå‹å¯¹è±¡æ˜¯ä»£ç†çš„\nè¯å°±å¯ä»¥ç›‘å¬åˆ°è¯¥å±æ€§å€¼çš„è·å–æ“ä½œï¼Œä»è€Œåšå‡ºå“åº”ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  let target = {} let thing = Object.create(new Proxy(target, { get(trapTarget, key, receiver) { throw new ReferenceError(`${key}doesn\u0026#39;t exist.`) } })) thing.name = \u0026#39;thing\u0026#39; console.log(thing.name) // \u0026#39;thing\u0026#39;  try { console.log(thing.unknown) // error } catch(e) { console.log(e.message) }   +RESULTS:\nthing unknown doesn't exist.  ç»™ thing æ–°å¢äº†ä¸€ä¸ª name å±æ€§ï¼Œè·å–çš„æ—¶å€™æ‹¿åˆ°çš„æ˜¯è¯¥å¯¹è±¡æœ¬èº«çš„ name å±æ€§ï¼Œ\nå› æ­¤æ­£å¸¸ï¼Œä½†æ˜¯å½“è·å– thiing.unknown çš„æ—¶å€™å¯¹è±¡æœ¬èº«æ²¡æ‰¾åˆ°ä¼šåˆ°åŸå‹ä¸Šå»æ‰¾ï¼Œè€ŒåŸå‹\næ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œ get trap ä¸­é˜»æ­¢äº†ä»»ä½•åŸå‹å±æ€§çš„è·å–æ“ä½œï¼Œå› æ­¤æŠ¥é”™å¼‚å¸¸ã€‚\nåŸå‹ set trap å¯¹è±¡æ“ä½œçš„ set å’Œ get ä¸€æ ·é¦–å…ˆæŸ¥æ‰¾æœ¬èº«ï¼Œå¦‚æœæ²¡æœ‰å°±å¾€åŸå‹æŸ¥æ‰¾ï¼Œå› æ­¤è¿™é‡Œä¹Ÿå¯ä»¥\né€šè¿‡ set trap å»å¯¹åŸå‹å±æ€§çš„è®¾ç½®æ“ä½œåšä¸€å®šçš„å“åº”å’Œæ‹¦æˆªã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  let target = {} let thing = Object.create(new Proxy(target, { set(trapTarget, key, value, receiver) { console.log(\u0026#39;key: \u0026#39; + key, \u0026#39;value: \u0026#39; + value) return Reflect.set(trapTarget, key, value, receiver) } })) console.log(thing.hasOwnProperty(\u0026#39;name\u0026#39;)) // false  thing.name = \u0026#39;thing\u0026#39; // è¿™é‡Œä¼šè§¦å‘ `set` ä»£ç†ï¼Œå› ä¸º thing ä¸­æ²¡æœ‰ `name` å±æ€§ console.log(thing.name) // \u0026#39;thing\u0026#39; console.log(thing.hasOwnProperty(\u0026#39;name\u0026#39;)) // true  thing.name = \u0026#39;boo\u0026#39; // è¿™ä¸ªæ—¶å€™ thing ä¸­å·²ç»æœ‰ `name` äº†ï¼Œå› æ­¤ä¸ä¼šè§¦å‘ `set` trap  console.log(thing.name)   +RESULTS:\nfalse key: name value: thing thing true boo  åŸå‹ has trap key in obj å¯¹äº in æ“ä½œç¬¦ï¼Œå®ƒä¸ä»…ä¼šæ£€æµ‹å¯¹è±¡æœ¬èº«ï¼Œè¿˜ä¼šæ£€æŸ¥åŸå‹é“¾ï¼Œä¸å…¶å¯¹åº”çš„\nproxy-trap ä¸º has trapï¼Œå³æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ª trap æ¥å¯¹ in æ“ä½œåšä¸€å®šçš„å¤„ç†ï¼Œæ¯”\nå¦‚è®©å®ƒé’ˆå¯¹è¢«ä»£ç†çš„å¯¹è±¡åœ¨åŸå‹ä¸Šçš„æŸ¥æ‰¾éƒ½å¤±æ•ˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  let target = {} let thing = Object.create(new Proxy(target, { has(trapTarget, key) { // return false è®©åŸå‹çš„æŸ¥æ‰¾å¤±æ•ˆ  return Reflect.has(trapTarget, key) } })) console.log(\u0026#39;name\u0026#39; in thing) // è§¦å‘ä»£ç†ï¼Œå› ä¸º target æ²¡ name å±æ€§ï¼Œä¼šå»æŸ¥æ‰¾åŸå‹  thing.name = \u0026#39;thing\u0026#39; console.log(\u0026#39;name\u0026#39; in thing) // ä¸ä¼šè§¦å‘   +RESULTS:\nfalse true  ä»£ç†ä½œä¸ºåŸå‹ä½œç”¨åŸŸç±»ä¸Šé¢ ç±»æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨ä»£ç†ä½œä¸ºåŸå‹ï¼Œå› ä¸ºç´¯çš„åŸå‹å±æ€§æ˜¯ non-writable çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥\né€šè¿‡ç±»çš„ç»§æ‰¿æ¥å˜ç›¸å®ç°ä»£ç†åŸå‹.\næ„é€ å‡½æ•°é£æ ¼çš„åŸå‹ä»£ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function NoSuchProperty() { // ... } NoSuchProperty.prototype = new Proxy({}, { get(trapTarget, key, receiver) { throw new ReferenceError(`${key}doesn\u0026#39;t exist`) } }) let thing = new NoSuchProperty() try { let res = thing.name } catch(e) { console.log(e.message) }   +RESULTS:\nname doesn't exist  æœ‰äº†ä¸Šé¢çš„ NoSuchProperty æ„é€ å‡½æ•°ä¹‹åï¼Œå°±å¯ä»¥è®©ä¸€ä¸ªç±»å»ç»§æ‰¿å®ƒï¼Œä»è€Œè®©ç±»çš„åŸå‹\næˆä¸ºä»£ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  function NoSuchProperty() { // ... } NoSuchProperty.prototype = new Proxy({}, { get(trapTarget, key, receiver) { throw new ReferenceError(`${key}doesn\u0026#39;t exist`) } }) class Square extends NoSuchProperty { constructor(length, width) { super() this.length = length this.width = width } } let shape = new Square(2, 6) let area1 = shape.length * shape.width console.log(area1) try { // error, no `wdth` property, ä¼šå»åŸå‹æŸ¥æ‰¾  let area2 = shape.length * shape.wdth } catch(e) { console.log(e.message) }   +RESULTS:\n12 wdth doesn't exist  ä¸Šé¢çš„å®ä¾‹ä¸­ new Proxy() ä»£ç†å®é™…ä¸Šæ˜¯ NoSuchProperty çš„åŸå‹ï¼Œè€Œé Square\nçš„ï¼Œä½†æ˜¯ä¾ç„¶æœ‰æ•ˆæ˜¯å› ä¸ºåŸå‹é“¾ç‰¹å¾çš„åŸå› ï¼ŒåŸå‹é“¾æŸ¥æ‰¾ä¸å•å•æ˜¯æŸ¥æ‰¾çˆ¶çº§å¯¹è±¡è¿˜ä¼šå¾€ä¸Šä¸€\nç›´æŸ¥æ‰¾åŸå‹ï¼Œç›´åˆ° Object.prototype ç»“æŸæŸ¥æ‰¾ã€‚\nä¸Šä¾‹ä¸­å„å¯¹è±¡åŸå‹é—´çš„å…³ç³»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  function NoSuchProperty() { // ... } let proxy = new Proxy({}, { get(trapTarget, key, receiver) { throw new ReferenceError(`${key}doesn\u0026#39;t exist`) } }) NoSuchProperty.prototype = proxy class Square extends NoSuchProperty { constructor(length, width) { super() this.length = length this.width = width } } let shape = new Square(2, 6) let shapeProto = Object.getPrototypeOf(shape) console.log(proxy === shapeProto) // false  let secondLevelProto = Object.getPrototypeOf(shapeProto) console.log(secondLevelProto === proxy) // true    +RESULTS:\nfalse true  å°ç»“ Proxy : å…è®¸æ‹¦æˆªåº•å±‚æ“ä½œï¼Œç»™è¿™äº›æ“ä½œå®šä¹‰ä¸€äº›éæ ‡å‡†çš„è¡Œä¸ºï¼Œæ¯”å¦‚ç›‘å¬æ•°ç»„é•¿åº¦å˜åŒ–ï¼Œ\nå¯¹è±¡å±æ€§çš„åˆ é™¤æ“ä½œã€‚\nReflect : é’ˆå¯¹æ¯ä¸ª proxy trap æ‰§è¡Œå®ƒä»¬çš„é»˜è®¤è¡Œä¸ºï¼Œæ¯ä¸€ä¸ª proxy trap éƒ½æœ‰ä¸€ä¸ªç›¸\nå¯¹åº”ä¸”åŒåçš„ Reflect æ–¹æ³•ä¸ä¹‹å¯¹åº”ï¼Œå¦‚å¯¹åº”è¡¨ã€‚\nrevocable proxy : å…è®¸è§£ç»‘çš„ proxy ã€‚\nåŸå‹ä»£ç†ï¼šå¯ä»¥è®©ä¸€ä¸ªä»£ç†æˆä¸ºä¸€ä¸ªå¯¹è±¡çš„åŸå‹ï¼Œä»è€Œå¯ä»¥å¯¹è¯¥å¯¹è±¡çš„åŸå‹çš„æ“ä½œè¿›è¡Œæ‹¦\næˆªï¼Œæ¯”å¦‚ get, set, has proxy trapsã€‚\nä»£ç æ¨¡å—åŒ– ä»€ä¹ˆæ˜¯æ¨¡å—ï¼Ÿ æ¨¡å—ä¸æ™®é€šçš„ scripts ä½¿ç”¨æœ‰å¾ˆå¤§çš„ä¸åŒï¼š\n æ¨¡å—ä»£ç é»˜è®¤ä¸¥æ ¼æ¨¡å¼è¿è¡Œï¼Œå¹¶ä¸”ä¸èƒ½æ”¹å˜ å½“å‰æ¨¡å—åˆ›å»ºçš„å…¨å±€å˜é‡åªé’ˆå¯¹äºè¯¥æ¨¡å—è€Œè¨€ï¼Œä½œç”¨åŸŸä»…é™äºè¯¥æ¨¡å—å†… ä¸€ä¸ªæ¨¡å—çš„ this å€¼ä¸º undefined æ¨¡å—å†…çš„ä»£ç ä¸å…è®¸åŒ…å« html æ ¼å¼çš„æ³¨é‡Š æ¨¡å—å†…å¿…é¡»æœ‰å¯¼å‡ºï¼Œæä¾›ç»™æ¨¡å—å¤–éƒ¨ä½¿ç”¨ æ¨¡å—å†…é€šè¿‡ import å¯ä»¥å¯¼å…¥å…¶ä»–æ¨¡å—ä»£ç   æ¨¡å—èµ‹äºˆäº†æŒ‡å®šéœ€è¦çš„ä»£ç å¯¼å…¥å¯¼å‡ºçš„èƒ½åŠ›.\nåŸºæœ¬å¯¼å‡º(export) ä½ å¯ä»¥ä½¿ç”¨ export å…³é”®å­—å»å°†æ¨¡å—å†…çš„æŒ‡å®šå†…å®¹å¯¼å‡ºç»™å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  // å¯¼å‡ºå˜é‡ export var color = \u0026#39;red\u0026#39; export let name = \u0026#39;xx\u0026#39; export const magicNumber = 7 // å¯¼å‡ºå‡½æ•° export function sum(n1, n2) { return n1 + n2 } // å¯¼å‡ºç±» export class Rect { constructor(len, width) { this.len = len this.width = width } } function subtract(n1, n2) { return n1 - n2 } function multiply(n1, n2) { return n1 * n2 } // å…ˆå®šä¹‰åå¯¼å‡º export { multiply }    å˜é‡ã€å‡½æ•°ã€ç±»çš„å¯¼å‡ºéƒ½å¿…é¡»æ˜ç¡®æŒ‡å®šä¸€ä¸ªåå­—ï¼Œå› ä¸ºå¤–éƒ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦é€šè¿‡è¿™ä¸ªå\nå­—å»ä½¿ç”¨ multiply å¹¶æ²¡æœ‰åœ¨å®šä¹‰çš„æ—¶å€™å¯¼å‡ºï¼Œä¹Ÿå°±æ˜¯è¯´ä¸éœ€è¦æ€»æ˜¯å¯¼å‡ºå®šä¹‰ä¹Ÿå¯ä»¥åªå¯¼å‡ºå¼•ç”¨ subtract å¹¶æ²¡æœ‰è¢«å¯¼å‡ºï¼Œå°±æ„å‘³ç€æ¨¡å—å¤–æ— æ³•è®¿é—®å®ƒï¼Œä½†æ˜¯æ¨¡å—å†…éƒ¨åªè¦æ»¡è¶³ä½œç”¨åŸŸ\nå°±å¯ä»¥è®¿é—®  åŸºæœ¬å¯¼å…¥(import) ä¸€æ—¦æ‹¥æœ‰ä½¿ç”¨ exports å¯¼å‡ºçš„æ¨¡å—äº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨å…¶ä»–æ¨¡å—é€šè¿‡ import å…³é”®è¯æ¥\nå¯¼å…¥è¿™äº›å†…å®¹ï¼Œæ¯”å¦‚ï¼š\nimport { identifier1, identifier2 } from './example.js';\nå¯ä»¥ä» example.js (ä¸€ä¸ªæ–‡ä»¶è§†ä¸ºä¸€ä¸ªæ¨¡å—)ï¼Œå°† identifier1 å¯¼å…¥ã€‚\næ¨¡å—å¯¼å…¥è¯­æ³•å¯¼å…¥çš„å˜é‡é»˜è®¤ä½¿ç”¨çš„æ˜¯ const å®šä¹‰çš„ï¼Œä¹Ÿå°±æ„å‘³ç€å¯¼å…¥ä¹‹åä¸èƒ½æ”¹å˜å˜\né‡çš„å€¼ã€‚\nä½†æ˜¯å¯ä»¥é€šè¿‡ import { a as b } from './c.js'; è¯­æ³•æ¥é‡æ–°å®šä¹‰å‘½ä»¤åç§°ã€‚\nå¯¼å…¥æœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚ï¼šåªå¯¼å…¥ä¸€ä¸ªï¼Œå¯¼å…¥å¤šä¸ªï¼Œå¯¼å…¥å…¨éƒ¨ç­‰ç­‰ã€‚\nå¯¼å…¥å•ä¸ª 1 2 3 4 5 6  import { sum } from \u0026#39;./example.js\u0026#39; console.log(sum(1, 2)) // import å¯¼å…¥é»˜è®¤ const ä¸èƒ½æ”¹å˜ sum = 1; // error   å¯¼å…¥æ—¶å€™çš„è·¯å¾„å¿…é¡»ä¸ä½¿ç”¨å¯¼å…¥æ¨¡å—çš„æ–‡ä»¶è·¯å¾„æƒ³åŒ¹é…ï¼Œå³å¿…é¡»è¦èƒ½æ‰¾åˆ°æ¨¡å—æ–‡ä»¶çš„æ­£ç¡®è·¯\nå¾„ã€‚\nå¯¼å…¥å¤šä¸ª 1 2 3 4  import { sum, multiply, magicNumber } from \u0026#39;./example.js\u0026#39; console.log(sum(1, magicNumber)) // 8 console.log(multiply(1, 2)); // 2   å¯¼å…¥æ‰€æœ‰ å¯ä»¥é€šè¿‡\nimport * as example from './example.js';\nå°† example.js æ¨¡å—å¯¼å‡ºçš„æ‰€æœ‰ç»‘å®šå¯¼å‡ºåˆ° example å¯¹è±¡ä¸­ï¼Œç„¶åå¯ä»¥é€šè¿‡\nexample.sum() æ–¹å¼å»è®¿é—®æ¨¡å—ä¸­çš„å†…å®¹ã€‚\nå¯¹åŒä¸€ä¸ªæ¨¡å—ä½¿ç”¨å¤šä¸ª import æœ€ç»ˆæ¨¡å—éƒ½ä¼šåªæ‰§è¡Œä¸€æ¬¡ï¼Œå®ƒä¼šåœ¨ç¬¬ä¸€æ¬¡å¯¼å…¥çš„æ—¶å€™å°±å­˜\nåœ¨äºå†…å­˜ä¸­ç­‰å¾…å¤ç”¨ï¼Œå…¶ä»–åé¢çš„ä½¿ç”¨çš„ import è¯­å¥éƒ½åªæ˜¯æœç”¨å†…å­˜ä¸­çš„æ¨¡å—ã€‚\nä¸ä»…ä»…ä¸€ä¸ªæ¨¡å—ä¸­å¤šæ¬¡ä½¿ç”¨ import å¯¼å…¥ä¸€ä¸ªæ¨¡å—å¤šæ¬¡åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå°±æ˜¯å¤šä¸ªæ¨¡å—åŒæ—¶\nå¤šæ¬¡å¯¼å…¥åŒä¸€ä¸ªæ¨¡å—ä¹Ÿåªä¼šåœ¨å†…å­˜ä¸­ä¿å­˜ä¸€ä»½å¼•ç”¨ï¼Œä¸”æ‰€æœ‰æ¨¡å—å¯¹è¯¥æ¨¡å—çš„å¯¼å…¥éƒ½åªä¼šä½¿ç”¨\nè¿™ä¸€ä»½å¼•ç”¨ã€‚\nä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€ä¸ªåº”ç”¨å®ä¾‹ä¸­ï¼Œå•ä¸ªæ¨¡å—åªä¼šæœ‰ä¸€ä»½ï¼Œå°½ç®¡ä¼šè¢«å¤šä¸ªæ¨¡å—å¤šæ¬¡å¯¼å…¥ã€‚\n æ¨¡å—è¯­æ³•é™åˆ¶ï¼š\nexport å’Œ import ä¸èƒ½åœ¨å‡½æ•°æˆ–è¯­å¥è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š\nif (flag) { export flag; } è¯­æ³•é”™è¯¯ã€‚\nå¯¼å‡ºåªèƒ½åœ¨æ¨¡å—çš„é¡¶çº§ä½œç”¨åŸŸæ‰èƒ½ä½¿ç”¨ï¼Œå‡½æ•°æˆ–å—çº§ä½œç”¨åŸŸä¸­ä¸å…è®¸ä½¿ç”¨ã€‚\nåŒæ ·ï¼Œ import åªèƒ½åœ¨æ–‡ä»¶é¡¶éƒ¨æ‰§è¡Œå¯¼å…¥ã€‚\n é‡å‘½åå¯¼å…¥å¯¼å‡º å¯¼å‡ºé‡å‘½åï¼š\n1 2 3 4 5 6 7 8 9 10  // example.js function sum(n1, n2) { return n1 + n2 } export { sum as add } // a.js import { add } from \u0026#39;./example.js\u0026#39;   å¯¼å…¥é‡å‘½åï¼š\n1 2 3 4 5 6 7 8 9  // example.js function sum(n1, n2) { return n1 + n2 } export { sum } // a.js import { sum as add } from \u0026#39;./example.js\u0026#39;   æ¨¡å—é»˜è®¤å€¼ å¯¼å‡ºé»˜è®¤å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // example.js // å¯¼å‡ºé»˜è®¤å€¼ä¸éœ€è¦å˜é‡å export default function(n1, n2) { return n1 + n2 } // å˜é‡åæ–¹å¼ function sum(n1, n2) { return n1 + n2 } export { sum as default }   å¯¼å…¥é»˜è®¤å€¼ï¼š\n1 2 3 4  // a.js import sum from \u0026#39;./example.js\u0026#39; console.log(sum(1, 2)); // 3   å°† example.js ä¸­ export default å†…å®¹å¯¼å‡ºä¸”èµ‹äºˆåç§°ä¸º sum ã€‚\næ··åˆä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12  // a.js export let color = \u0026#39;red\u0026#39; export default function(n1, n2) { return n1 + n2 } // b.js import sum, { color } from \u0026#39;./example.js\u0026#39; console.log(sum(1, 2)); // 3 console.log(color); // \u0026#39;red\u0026#39;   å¯¼å‡ºé»˜è®¤é‡å‘½åï¼š\nimport { default as sum, color } from './example.js'\nå¯¼å…¥ä¹‹åå¯¼å‡º å³ä»ä¸€ä¸ªæ¨¡å—å¯¼å‡ºä¸€ä¸ªå†…å®¹ï¼Œç„¶ååœ¨å½“å‰æ¨¡å—ä¸­åˆå°†è¿™ä¸ªå†…å®¹å¯¼å‡ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  import { sum } from \u0026#39;./a.js\u0026#39; export { sum } // ç®€å†™ export { sum } from \u0026#39;./a.js\u0026#39; // å¯¼å…¥-å¯¼å‡º-é‡å‘½å export { sum as add } from \u0026#39;./a.js\u0026#39; // å¯¼å…¥æ‰€æœ‰å¯¼å‡ºæ‰€æœ‰ export * from \u0026#39;./a.js\u0026#39;   æ— å¯¼å‡ºçš„æ¨¡å—å¯¼å…¥ å³è¢«å¯¼å…¥çš„æ¨¡å—ä¸­å¹¶æ²¡æœ‰è¦å¯¼å‡ºçš„å†…å®¹ï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦å¯¼å…¥è¿™ä¸ªæ¨¡å—å¹¶ä¸”æ‰§è¡Œå®ƒå³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  // a.js Array.prototype.pushAll = function(items) { // ... } // b.js import \u0026#39;./a.js\u0026#39; let colors = [\u0026#39;red\u0026#39;, \u0026#39;green\u0026#39;, \u0026#39;blue\u0026#39;] let items = [] items.pushAll(colors)   ä¸Šé¢çš„ä»£ç ä¼šå°† a.js çš„å†…å®¹ç›´æ¥åœ¨ b.js ä¸­å¯¼å…¥æ‰§è¡Œï¼Œè¿™æ · Array ä¸Šæœ‰äº†\npushAll æ–¹æ³•ã€‚\n æ— å¯¼å‡ºçš„æ¨¡å—é€šå¸¸ç”¨æ¥åˆ›å»º polyfills å’Œ shimsï¼Œæ¨¡å—ä»£ç åªå¸Œæœ›å¯¼å…¥æ—¶ç«‹å³æ‰§è¡Œã€‚\n åŠ è½½æ¨¡å— æµè§ˆå™¨ä¸­ä½¿ç”¨æ¨¡å— ECMAScript 6ä¸­è™½ç„¶å®šä¹‰äº†æ¨¡å—è¯­æ³•ï¼Œä½†å¹¶æ²¡æœ‰å®šä¹‰å¦‚ä½•å»åŠ è½½ä»–ä»¬ã€‚\n é€šè¿‡ \u0026lt;script\u0026gt; æ ‡ç­¾çš„ src å±æ€§åŠ è½½ä¸€ä¸ªè„šæœ¬æ–‡ä»¶æ‰§è¡Œé‡Œé¢çš„ä»£ç  é€šè¿‡åµŒå…¥ \u0026lt;script\u0026gt; æ ‡ç­¾ï¼Œåœ¨æ ‡ç­¾é‡Œé¢ç›´æ¥ä¹¦å†™ js ä»£ç  åŠ è½½ js ä»£ç æ”¾åˆ°ä¸€ä¸ª worker é‡Œé¢æ‰§è¡Œ  ä¸ºäº†å®Œå…¨æ”¯æŒæ¨¡å—ï¼Œæµè§ˆå™¨ä¸å¾—ä¸æ›´æ–°è¿™äº›æœºåˆ¶ã€‚\nscriptæ ‡ç­¾ä¸­ä½¿ç”¨æ¨¡å—ï¼Œscript æ ‡ç­¾çš„é»˜è®¤è¡Œä¸ºæ˜¯å½“ type å±æ€§ä¸æŒ‡å®šæˆ–æŒ‡å®šä¸ºä¸€ä¸ª JavaScript è„šæœ¬ç±»å‹çš„æ—¶\nå€™(æ¯”å¦‚ï¼š text/javascript)ï¼Œä¼šåŠ è½½ä¸€ä¸ª JavaScript ä½œä¸ºè„šæœ¬å»æ‰§è¡Œå®ƒè€Œéæ¨¡å—ã€‚\nscript æ ‡ç­¾ä¼šæ‰§è¡Œ src åŠ è½½çš„æ–‡ä»¶å†…çš„ä»£ç æˆ–è€… \u0026lt;script\u0026gt; ä¸ \u0026lt;/script\u0026gt; ä¹‹é—´çš„\nä»£ç ã€‚\nä¸ºäº†æ”¯æŒæ¨¡å—ï¼Œ type ç±»å‹æ–°å¢äº†ä¸€ä¸ª \u0026quot;module\u0026quot; ç±»å‹å€¼ï¼Œé€šè¿‡è®¾ç½® type=\u0026quot;module\u0026quot;\nå‘Šè¯‰æµè§ˆå™¨ï¼Œè¯¥è„šæœ¬åŒ…å«çš„æ˜¯ä¸€ä¸ªæ¨¡å—ä»£ç ã€‚\n1 2 3 4 5 6  \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;module.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34;\u0026gt; import { sum } from \u0026#39;./example.js\u0026#39;; var result = sum(1,2); \u0026lt;/script\u0026gt;   ç¬¬ä¸€ä¸ª \u0026lt;script\u0026gt; æ ‡ç­¾åŠ è½½äº†ä¸€ä¸ª src æŒ‡å®šçš„å¤–éƒ¨æ–‡ä»¶ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯æŒ‡å®šçš„ç±»å‹ä¸º\n\u0026quot;module\u0026quot; ã€‚\nç¬¬äºŒä¸ª \u0026lt;scrpt\u0026gt; æ ‡ç­¾ç›´æ¥åµŒå…¥äº†ä¸€æ®µä»£ç é€šè¿‡ import å¯¼å…¥äº†ä¸€ä¸ªå¤–éƒ¨è„šæœ¬æ–‡ä»¶ï¼Œå› \næ­¤ result å˜é‡ä¸ä¼šè¢«åŠ å…¥åˆ° window å¯¹è±¡ä¸Šå»ï¼Œå› ä¸ºå®ƒåªåœ¨è¿™ä¸ª \u0026lt;script\u0026gt; æ¨¡å—ä¸­\nç”Ÿæ•ˆã€‚\næµ‹è¯•å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;\u0026lt;/title\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;a.html\u0026lt;/h1\u0026gt; \u0026lt;script src=\u0026#34;./a.js\u0026#34; type=\u0026#34;module\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; var globalResult = 1000; \u0026lt;/script\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34;\u0026gt; import { sum } from \u0026#39;./a.js\u0026#39;; var result = sum(1,2); console.log(\u0026#39;module result 1\u0026#39;, result); \u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; console.log(\u0026#39;global result\u0026#39;, window.globalResult); console.log(\u0026#39;module result 2\u0026#39;, window.result); // undefined  \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;   chrome æµè§ˆå™¨æ‰§è¡Œç»“æœï¼š\nä»ç»“æœæ‰€ç¤ºï¼š\n type='module' çš„ script æœ€åè¢«åŠ è½½æ‰§è¡Œï¼Œå› ä¸ºå…¶é»˜è®¤åº”ç”¨äº† defer å±æ€§ æ¨¡å—å†…éƒ¨çš„å˜é‡ä¸ä¼šæ·»åŠ åˆ° window å¯¹è±¡ä¸Š  Webæµè§ˆå™¨ä¸­çš„æ¨¡å—åŠ è½½åºåˆ— \u0026lt;script type=\u0026quot;module\u0026quot;\u0026gt; çš„æ ‡ç­¾é»˜è®¤åº”ç”¨äº† defer å±æ€§ï¼Œæ„å‘³ç€å®ƒä¼šè¢«ä¸‹è½½ä½†ä¸ä¼šè¢«\nç«‹å³æ‰§è¡Œï¼Œåªæœ‰å½“ DOM è¢«å®Œå…¨è§£æå®Œæˆä¹‹åæ‰ä¼šè¢«æ‰§è¡Œï¼Œå¤šä¸ªæ¨¡å—çš„æ—¶å€™ä¼šæŒ‰ç…§å®ƒä»¬åœ¨\nDOM ç»“æ„ä¸­çš„é¡ºåºæ¥æ‰§è¡Œï¼Œä¸åŒºåˆ†æ˜¯ src å¼•å…¥æ¨¡å—æ–‡ä»¶è¿˜æ˜¯ç›´æ¥åµŒå…¥ä»£ç æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;a.html\u0026lt;/h1\u0026gt; \u0026lt;script src=\u0026#34;./a.js\u0026#34; type=\u0026#34;module\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; var globalResult = 1000; \u0026lt;/script\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34;\u0026gt; import { sum } from \u0026#39;./a.js\u0026#39;; var result = sum(1,2); console.log(\u0026#39;module result 1\u0026#39;, result); const testEl1 = document.getElementById(\u0026#39;test\u0026#39;); console.log(testEl1, \u0026#39;test el 1\u0026#39;); \u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; console.log(\u0026#39;global result\u0026#39;, window.globalResult); console.log(\u0026#39;module result 2\u0026#39;, window.result); // undefined  const testEl2 = document.getElementById(\u0026#39;test\u0026#39;); console.log(testEl2, \u0026#39;test el 2\u0026#39;); \u0026lt;/script\u0026gt; \u0026lt;div id=\u0026#34;test\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt;   ç»“æœï¼š\nå¯ä»¥çœ‹åˆ°åœ¨æ™®é€šçš„ script æ ‡ç­¾ä¸­ \u0026lsquo;test el 2\u0026rsquo; ç»“æœæ˜¯ undefined å› ä¸ºè¿™ä¸ªæ—¶å€™\ndiv#test å¹¶æ²¡æœ‰å¹¶åˆ›å»ºï¼Œå› ä¸ºå®ƒåœ¨æ‰€æœ‰çš„ script ä¹‹åã€‚\nä½†æ˜¯ \u0026lsquo;test el 1\u0026rsquo; å¾—åˆ°äº†æ­£ç¡®çš„ç»“æœèƒ½è·å–åˆ° div#test å…ƒç´ ï¼Œè¿™æ°æ°è¯´æ˜äº†ç±»å‹ä¸º\n\u0026lsquo;module\u0026rsquo; çš„ script æ ‡ç­¾åœ¨ DOM è§£æå®Œæˆä¹‹åæ‰§è¡Œã€‚\n å¤šä¸ª script#module æ ‡ç­¾ï¼Œä¼šåŒæ­¥ä¸‹è½½æ–‡ä»¶ä»¥åŠæ¯ä¸ª script é‡Œé¢çš„ import çš„æ–‡\nä»¶ï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œåªæœ‰å½“ document è§£æå®Œæˆä¹‹åæ‰ä¼šå»æ‰§è¡Œå®ƒä»¬ï¼Œæ‰§è¡Œé¡ºåºä¸ºå…ˆ\nscript å script ä¸­çš„ import, ç„¶åä¸‹ä¸€ä¸ª script åŠå…¶é‡Œé¢çš„ importï¼Œå¦‚æ­¤çŸ¥é“æ‰§è¡Œ\nå®Œæˆã€‚\n æµè§ˆå™¨ä¸­çš„å¼‚æ­¥æ¨¡å—åŠ è½½ \u0026lt;script type=\u0026quot;module\u0026quot; async src=\u0026quot;module1.js\u0026quot;\u0026gt;\u0026lt;/script\u0026gt;\nasync è¡¨ç¤º module1.js ä¸€æ—¦ä¸‹è½½å®Œæˆå°±ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œä¸”ä¸å½±å“å…¶ä»–è„šæœ¬çš„ä¸‹è½½å’Œæ‰§\nè¡Œï¼Œå“ªä¸ªä¸‹è½½å®Œæˆè°å°±å…ˆæ‰§è¡Œã€‚\nWorker åŠ è½½æ¨¡å— æˆ‘ä»¬éƒ½çŸ¥é“ JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬åˆéœ€è¦åšä¸€äº›ç¹ççš„å·¥ä½œï¼Œå´ä¸å¸Œæœ›\nå½±å“åˆ°ä¸»çº¿ç¨‹çš„è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨åˆ° Worker å®ƒç›¸å½“äºé‡æ–°èµ·äº†ä¸€ä¸ªçº¿ç¨‹ç»™æŒ‡å®šçš„\nè„šæœ¬å»æ‰§è¡Œï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œè¿˜æä¾›äº†ä¸ä¹‹é€šä¿¡çš„æ¥å£ã€‚\nè„šæœ¬ Worker : new Worker('script.js');\næ¨¡å— Worker : new Worker('module.js', { type: 'module' });\næ¨¡å—å’Œè„šæœ¬ Worker å·®å¼‚ï¼š\n è„šæœ¬ Worker åªèƒ½åŠ è½½åŒæºè„šæœ¬æ–‡ä»¶ï¼Œå³ä¸æ”¯æŒè·¨åŸŸï¼Œä½†æ˜¯æ¨¡å— Worker æ²¡æœ‰æ‰¾ä¸ªé™åˆ¶ è„šæœ¬ Worker å¯ä»¥ä½¿ç”¨ self.importScripts() æ–¹æ³•å»åŠ è½½å…¶ä»–çš„è„šæœ¬ï¼Œè€Œåœ¨æ¨¡å—\nWorker ä¸­åªèƒ½ä½¿ç”¨ import å»åŠ è½½å…¶ä»–è„šæœ¬æ–‡ä»¶  åŠ è½½æ–‡ä»¶è·¯å¾„é™åˆ¶ åœ¨æ¨¡å—å¼•å…¥çš„æ—¶å€™çš„è·¯å¾„åªèƒ½æ˜¯ /, ./, ../ è¿™ç§ç›¸å¯¹è·¯å¾„æˆ–è€…ç›´æ¥æ˜¯åŒ…å«åŸŸåçš„ç»\nå¯¹è·¯å¾„ï¼Œæ¯”å¦‚ï¼š http://x.x.x.x/path/to/file.js (éœ€è¦é…ç½® CORS å…è®¸è·¨åŸŸè®¿é—®)ã€‚\nå…¶ä»–æƒ…å†µä¸è¢«å…è®¸ï¼Œæ¯”å¦‚ï¼š\nimport { first } from 'a.js'; // error\nimport { second } from 'path/a.js'; // error\nä¸Šé¢ä¸¤ç§éƒ½ä¸ä¼šè¢«æµè§ˆå™¨ä¸‹è½½ï¼Œå› ä¸ºæ¨¡å—æ–‡ä»¶çš„è·¯å¾„ä¸åˆæ³•ï¼Œå°½ç®¡åœ¨ script çš„ src\nå±æ€§å€¼ä¸­å¯ä»¥è¿™ä¹ˆä½¿ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ script å’Œ import çš„ä¸€ä¸ªåŒºåˆ«ã€‚\nå¼‚å¸¸å¤„ç† tryâ€¦catch ç®€å†™2019 try {} catch {} ç°åœ¨å¯ä»¥çœç•¥ catch(e) ï¼Œç›´æ¥å°† catch å˜æˆä¸€ä¸ªå…³é”®å­—ã€‚\né™„å½• Aï¼š æ›´å°çš„å˜æ›´ Integers æ•´å‹æ•°æ® JavaScript ä½¿ç”¨äº† IEEE 754 ç¼–ç ç³»ç»Ÿæ¥è¡¨ç¤ºæ•´å‹å’Œæµ®ç‚¹æ•°ï¼Œè¿™åœ¨ä»¥å¾€å¼•èµ·ä¸å°‘å›°æƒ‘ã€‚\nECMAScript 6 ä¸­ä¸æ•°å€¼æœ‰å…³çš„æ›´æ–°è®©æ•´å‹çš„è¡¨ç¤ºå’Œä½¿ç”¨æ›´åŠ ä¾¿åˆ©ã€‚\nNumber.isInteger() åˆ¤æ–­æ•°å€¼æ˜¯å¦æ˜¯æ•´å‹æ•°å€¼ï¼š\n1 2 3 4 5 6 7 8  const isInt = v =\u0026gt; Number.isInteger(v) console.log(isInt(\u0026#39;1\u0026#39;)) console.log(isInt(1)) console.log(isInt(1.0)) console.log(isInt(1.8)) console.log(isInt(\u0026#39;\u0026#39;)) console.log(isInt(\u0026#39;a\u0026#39;))   +RESULTS:\nfalse true true false false false  1.0 ä¼šè¢«å½“åšæ•´å‹å€¼ 1 å­˜å‚¨ï¼Œå› æ­¤è¿™é‡Œå¾—åˆ°çš„ç»“æœæ˜¯ true ,\nNumber.isInteger() å¦‚æœé‡åˆ°æ•°å€¼å‹æ•°æ®ï¼Œåœ¨åˆ¤æ–­çš„æ—¶å€™ä¼šä¾æ®è¿™äº›æ•°å€¼å‹æ•°æ®åœ¨å†…å­˜\nä¸­çš„å­˜å‚¨å½¢å¼æ¥å†³å®šæœ€ç»ˆç»“æœ(æµ®ç‚¹ã€æ•´å‹å­˜å‚¨æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„)ã€‚\nå®‰å…¨æ•´å‹å€¼ IEEE754 çš„å®‰å…¨æ•´å‹å€¼èŒƒå›´ä¸ºï¼š -253 ~ 253ï¼Œè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„å€¼éƒ½è¢«è§†ä¸ºéå®‰å…¨æ•°\nå€¼ã€‚\n1 2  console.log(Math.pow(2, 53)) console.log(Math.pow(2, 53) + 1)   +RESULTS:\n9007199254740992 9007199254740992  ç¬¬äºŒä¸ª +1 ä¹‹åè¶…å‡ºäº†èŒƒå›´ï¼Œå¾—çš„ç»“æœç›¸å½“äºæ²¡æœ‰æ‰§è¡ŒåŠ æ³•æ“ä½œçš„ç»“æœå€¼ã€‚\nNumber.isSafeInteger() æ£€æµ‹æ˜¯å¦æ˜¯å®‰å…¨æ•´å‹å€¼ã€‚\nNumber.MAX_SAFE_INTEGER å¾—åˆ°å½“å‰æœºå™¨ä¸Šçš„æœ€å¤§å®‰å…¨æ•´å‹å€¼ã€‚\nNumber.MIN_SAFE_INTEGER å¾—åˆ°å½“å‰æœºå™¨ä¸Šçš„æœ€å°å®‰å…¨æ•´å‹å€¼ã€‚\n1 2 3 4 5 6 7 8  var inside = Number.MAX_SAFE_INTEGER, outside = inside + 1 console.log(Number.isInteger(inside)) // true console.log(Number.isSafeInteger(inside)) // true  console.log(Number.isInteger(outside)) // true console.log(Number.isSafeInteger(outside)) // false   +RESULTS:\ntrue true true false  æ–° Math æ–¹æ³•    æ–¹æ³•å åŠŸèƒ½     Math.acosh(x)    Math.asinh(x)    Math.atanh(x)    Math.cbrt(x)    Math.clz32(x)    Math.cosh(x)    Math.expm1(x)    Math.fround(x) x æœ€è¿‘çš„å•ç²¾åº¦æµ®ç‚¹æ•°   Math.hypot(...values) å‚æ•°åˆ—è¡¨å¹³æ–¹å’Œçš„å¹³æ–¹æ ¹   Math.imul(x, y)    Math.log1p(x) 1 + x çš„è‡ªç„¶å¯¹æ•°   Math.log10(x) 10 ä¸ºåº• x çš„å¯¹æ•°   Math.log2(x) 2 ä¸ºåº• x çš„å¯¹æ•°   Math.sign(x) æ£€æŸ¥æ•°å€¼ç¬¦å·    -1 : x è´Ÿæ•°    0 : x ä¸º +0 æˆ– -0    1 : x æ­£æ•°   Math.sigh(x) x çš„åŒæ›²æ­£å¼¦   Math.tanh(x) x çš„åŒæ›²æ­£åˆ‡   Math.trunc(x) æµ®ç‚¹æ•°å–æ•´    1 2 3 4  console.log(Math.acosh(30), \u0026#39;cos\u0026#39;) console.log(Math.sinh(1), \u0026#39;sinh\u0026#39;) console.log(Math.tanh(30), \u0026#39;tanh\u0026#39;) console.log(Math.trunc(30.112), \u0026#39;trunc\u0026#39;) // 30   Unicode æ ‡è¯†ç¬¦ ç”¨ Unicode æ ‡è¯†ç¬¦åšå˜é‡åç§°ï¼š\n1 2 3 4 5 6  var \\u0061 = \u0026#39;abc\u0026#39; console.log(\\u0061) // ç­‰ä»·äº console.log(a)   +RESULTS:\nabc abc  æ­£è§„åŒ– __proto__ å±æ€§ é™„å½• Bï¼šç†è§£ ECMAScript 7 (2016) ä¸ºäº†æ›´å¥½çš„è®°å½•è§„èŒƒï¼Œæœ€ç»ˆå°†é‡‡ç”¨ç‰ˆæœ¬å·+å¹´ä»½æ–¹å¼æ¥è®°å½•ï¼Œæ¯”å¦‚\nECMAScript 6 ä¸º ECMAScript 2015ï¼Œè¡¨ç¤º 2015 å¹´å‘å¸ƒçš„æ ‡å‡†ã€‚\nECMAScript 7 ä¸º ECMAScript 2016ï¼Œè¡¨ç¤º 2016 å¹´å‘å¸ƒçš„æ ‡å‡†\nECMAScript 7 å‘å¸ƒä¸ 2016å¹´3æœˆï¼Œå®ƒå€¼åŒ…å¥½äº†ä¸‰ä¸ªæ–°å¢å†…å®¹ï¼š\n ** å¹‚è¿ç®—æ“ä½œç¬¦ï¼Œç­‰åŒäº Math.pow(x, y) æ–¹æ³• Array.prototype.includes() æ–¹æ³•ï¼Œç”¨æ¥æ£€æµ‹æ•°ç»„æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼Œè¿”å›\ntrue/false æ”¯æŒå‡½æ•°åŸŸçš„ä¸¥æ ¼æ¨¡å¼  ** å¹‚è¿ç®—æ“ä½œç¬¦ 1 2 3 4  let res = 5 ** 2 console.log(res) // 25 console.log(res === Math.pow(5, 2)) // true   +RESULTS:\n25 true  ä¼˜å…ˆçº§ : é«˜äºæ‰€æœ‰çš„äºŒå…ƒå…ƒç®—æ³•ï¼Œä½äºä¸€å…ƒè¿ç®—ç¬¦ã€‚\n1 2 3 4 5 6 7  let res = 2 * 5 ** 2; // ** é«˜äº * console.log(res) // 50  console.log(5 ** -2) // 0.04    +RESULTS:\n50 0.04  ä½†æ˜¯ä¸å…è®¸ä¸€å…ƒè¿ç®—ç¬¦å‡ºç°åœ¨ ** çš„å·¦ä¾§ï¼Œå› ä¸ºè¿™æ ·å°±æ²¡æ³•åˆ¤å®šå“ªä¸ªä¼˜å…ˆçº§æ›´é«˜ï¼Œå®¹æ˜“é€ \næˆæ··æ·†ï¼Œå¦‚æœéè¦ä½¿ç”¨å°±å¿…é¡»ä½¿ç”¨ () æ‹¬èµ·æ¥ã€‚\n1 2 3 4  let res1 = -(5 ** 2) // -25 let res2 = (-5) ** 2 // 25  console.log(res1, res2)   +RESULTS:\n-25 25  ++ å’Œ -- åœ¨ ** ä¸­è¡¨è¾¾å¼ä¸­çš„ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9  let n1 = 2, n2 = 2 console.log(++n1 ** 2) // 9 console.log(n1) // 3  console.log(n2-- ** 2) // 4 console.log(n2) // 1   +RESULTS:\n9 3 4 1  ä½†æ˜¯ä¸å…è®¸ç›´æ¥åœ¨æ•°å­—ä¸Šä½¿ç”¨ ++ å’Œ --\n1 2  let res = ++5 ** 2 console.log(res)   +RESULTS:\nReferenceError: Invalid left-hand side expression in prefix operation  Array.prototype.includes(val[, startIdx]) includes å†…éƒ¨å®ç°ä¼ªç ã€‚\næŸ¥æ‰¾ val æ˜¯å¦åœ¨æ•°ç»„ä¸­ï¼Œ startIdx æŒ‡å®šæŸ¥æ‰¾çš„å…¶å®ç´¢å¼•ï¼Œæ‰¾åˆ°è¿”å› true å¦åˆ™è¿”\nå› false ã€‚\nincludes() ä¼šå°† NaN è§†ä¸ºåŒä¸€ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ¯”è¾ƒçš„æ—¶å€™ NaN å’Œ NaN æ¯”è¾ƒçš„\nç»“æœæ˜¯çœŸå€¼ï¼Œè€Œ indexOf() ä¸­ä½¿ç”¨çš„æ˜¯ === åˆ¤æ–­ï¼Œ NaN === NaN ç»“æœæ˜¯ false\næ‰€ä»¥ä½¿ç”¨ includes() æ›´åˆç†æ›´å®‰å…¨ï¼Œå¦‚æœä¸éœ€è¦è¢«æŸ¥æ‰¾å…ƒç´ çš„ç´¢å¼•å€¼çš„è¯ã€‚\n1 2 3 4  let vals = [1, NaN, 2] console.log(vals.indexOf(NaN)) console.log(vals.includes(NaN))   +RESULTS:\n-1 true  å®ç°å†…éƒ¨å¯¹äºé›¶å€¼çš„æ¯”è¾ƒå®ç”¨çš„æ˜¯æŠ½è±¡æ“ä½œ SameValueZeroå†…ä¸­å¯¹ NaN çš„åˆ¤æ–­å¹¶éæ˜¯ç­‰\nå¼åˆ¤æ–­è€Œæ˜¯é€šè¿‡ isNaN() æ–¹å¼çš„åˆ¤æ–­ï¼Œå¯¹äºé›¶å€¼æœ‰æ­£è´Ÿé›¶å€¼çš„åˆ¤æ–­(1/0 === Infinity, 1/-0 === Infinity)ï¼Œæ›´å¤šè¯¦æƒ…è¯·æŸ¥çœ‹å®ç°ä¼ªç ã€‚\nå‡½æ•°åŸŸçš„ä¸¥æ ¼æ¨¡å¼ å³å¯ä»¥åœ¨å‡½æ•°é¡¶éƒ¨ä½¿ç”¨ \u0026quot;use strict\u0026quot;; æ¥æŒ‡å®šå½“å‰å‡½æ•°æ‰§è¡Œæ¨¡å¼ä¸ºä¸¥æ ¼æ¨¡å¼ï¼Œä¸å½±å“å‡½\næ•°å¤–çš„ä»£ç ã€‚\nç›¸å…³é“¾æ¥  new-es2018-features-every-javascript-developer-should-know  æ–°å¢å†…å®¹åˆ—è¡¨ Object å’Œ Reflect é‡å¤å‡½æ•°æ¯”è¾ƒ     Object Reflect     getOwnPropertyDescriptor(obj, key) obj åŸå§‹ç±»å‹å¼ºè½¬ obj åŸå§‹ç±»å‹ä¼šæŠ›å¼‚å¸¸    ä»£ç†å’Œæ˜ å°„    Proxy Traps Reflect Apis åŸç”ŸåŠŸèƒ½ æè¿°     get 13.3.3 Reflect.get(trapTarget, key, receiver) å¯¹è±¡å±æ€§è¯»å– è®¿é—®å¯¹è±¡å±æ€§çš„æ—¶å€™è§¦å‘   set 13.3.2 Reflect.set(trapTarget, key, value, receiver) å¯¹è±¡å±æ€§èµ‹å€¼æ“ä½œ æ”¹å˜å¯¹è±¡å±æ€§çš„å€¼æ—¶è§¦å‘   has 13.3.4 Reflect.has(trapTarget, key) key in obj æ£€æµ‹å­˜åœ¨æ€§   deleteProperty 13.3.5 Reflect.deleteProperty(trapTarget, key) delete obj.name åˆ é™¤å±æ€§   getPrototypeOf 13.4 Reflect.getPrototypeOf(trapTarget) è·å–å¯¹è±¡åŸå‹ Object.getPrototypeOf()   setPrototypeOf 13.4 Reflect.setPrototypeOf(trapTarget, proto) è®¾ç½®å¯¹è±¡åŸå‹ Object.setPrototypeOf()   isExtensible 13.5 Reflect.isExtensible(trapTarget) æ‰©å±•æ€§ Object.isExtensible()   preventExtensions 13.5 Reflect.preventExtensions(trapTarget) æ‰©å±•å¯¹è±¡ Object.preventExtensions()   definePropery 13.6.3 Reflect.definePropery(trapTarget, key, descriptor) å±æ€§æè¿°ç¬¦ä»£ç† Object.defineProperty(obj, key, desc)   getOwnPropertyDescriptor 13.6.3 Reflect.getOwnPropertyDescriptor(trapTarget, key) è·å–å±æ€§æè¿°ç¬¦å¯¹è±¡ Object.getOwnPropertyDescriptor(trapTarget, key   ownKeys 13.7 Reflect.ownKeys(trapTarget) è¿”å›è‡ªèº«å±æ€§ Object.keys(), Object.getOwnPropertyNames()     Object.keys() ä¸åŒ…å«ç¬¦å·å±æ€§     =Object.getOwnPropertyNames()= ä¸åŒ…å«ç¬¦å·å±æ€§     Object.getOwnPropertySymbols() ä¸åŒ…å«ç¬¦å·å±æ€§     Object.assign() åŒ…å«ç¬¦å·å±æ€§   apply 13.8 Reflect.apply(trapTarget, thisArg, argumentsList) å‡½æ•°çš„è°ƒç”¨ -   construct 13.8 Reflect.construct(trapTarget, argList[, newTarget] å‡½æ•°å®ä¾‹åŒ–(new) -   Proxy.revocable(target, trapObj) 13.9 - å¯æ’¤é”€çš„ä»£ç† è¿”å›ä»£ç†å®ä¾‹å’Œ revoke() æ’¤é”€å‡½æ•°          è¡¨ä¸­å‚æ•°è¯´æ˜ï¼š\n   å‚æ•°å ç±»å‹ è¯´æ˜     trapTarget Object è¢«ä»£ç†çš„å¯¹è±¡   key - è¦æ“ä½œçš„å¯¹è±¡å±æ€§å   value - å¯¹è±¡å±æ€§å€¼   receiver Proxy ä»£ç†å¯¹è±¡    ç¬¦å·    ç¬¦å·æ–¹æ³• ç±»å‹ JavaScript ç‰¹æ€§ æè¿°     Symbol.hasInstance boolean instanceof 7.7.1 å®ä¾‹(åŸå‹é“¾)æ£€æµ‹   Symbol.isConcatSpreadable boolean Array.prototype.concat 7.7.2 æ£€æµ‹å‚æ•°åˆæ³•æ€§   Symbol.iterator function è°ƒç”¨åå¾—åˆ°è¿­ä»£å™¨ éå†å¯¹è±¡æˆ–æ•°ç»„(ç­‰å¯è¿­ä»£çš„å¯¹è±¡)çš„æ—¶å€™ä¼šç”¨åˆ°   Symbol.asyncIterator function è°ƒç”¨åå¾—åˆ°å¼‚æ­¥è¿­ä»£å™¨(è¿”å›ä¸€ä¸ª Promise ) éå†å¯¹è±¡æˆ–æ•°ç»„(ç­‰å¯è¿­ä»£çš„å¯¹è±¡)çš„æ—¶å€™ä¼šç”¨åˆ°   Symbol.match function String.prototype.match 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.matchAll function String.prototype.matchAll 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.replace function String.prototype.replace 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.search function String.prototype.search 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.split function String.prototype.split 7.7.3 æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡å†…éƒ¨å±æ€§   Symbol.species constructor new this.constructor[Symbol.species](value) symbol-species è¿”å›æ„é€ å‡½æ•°ï¼Œç±»å†…éƒ¨ä½¿ç”¨ï¼Œä¸èƒ½æ„é€ å‡½æ•°è°ƒç”¨   Symbol.toPrimitive function - 7.7.4 è¿”å›ä¸€ä¸ªå¯¹è±¡çš„åŸå§‹å€¼   Symbol.toStringTag string Object.prototype.toString() 7.7.5 è¿”å›ä¸€ä¸ªå¯¹è±¡çš„å­—ç¬¦ä¸²æè¿°   Symbol.unscopables object with 7.7.8 ä¸èƒ½å‡ºç°åœ¨ with è¯­å¥ä¸­çš„ä¸€ä¸ªå¯¹è±¡    å‡½æ•°    åˆ†ç±» å‡½æ•°å æè¿° å…¶ä»–     Promise Promise.all(iterable) æ‰€æœ‰çš„ promise resolved     Promise.race(iterable) åªè¦æœ‰ä¸€ä¸ª promise settled é‚£ä¹ˆ race ç«‹å³ settled(æ— è®ºæ˜¯ rejected è¿˜æ˜¯ fulfilled)    Array Array.of(...items) å°†å‚æ•°äº†åˆ—è¡¨ä¸­çš„å€¼ç»„åˆæˆæ•°ç»„ å’Œæ„é€ å‡½æ•°ä¸ä¸€æ ·ï¼Œè¯¥æ–¹æ³•ä¼šå°†å‚æ•°åªå½“åšå…ƒç´ å¤„ç†ï¼Œè€Œä¸ä¼šåƒ Array() ä¼ ä¸€ä¸ªå‚æ•°å½“åšé•¿åº¦å¤„ç†ã€‚    Array.from(items[, mapFn[, thisArg]]) å°†æ»¡è¶³æ¡ä»¶çš„å¯¹è±¡è½¬æˆæ•°ç»„ æ¡ä»¶ï¼š1. å¿…é¡»æœ‰é•¿åº¦å±æ€§ï¼Œ2. è¦æœ‰æ•°å€¼ç´¢å¼•å…ƒç´ ã€‚å¯è¿­ä»£çš„å¯¹è±¡ä¼šç›´æ¥è®¿é—®è¿­ä»£å™¨ã€‚    Array.prototype.find(mapFn[, thisArg]) æŸ¥æ‰¾ mapFn è¿”å› true æ¡ä»¶çš„å…ƒç´ ï¼Œè¿”å›è¯¥å…ƒç´ å€¼ -    Array.prototype.findIndex(mapFn[, thisArg]) æŸ¥æ‰¾ mapFn è¿”å› true æ¡ä»¶çš„å…ƒç´ ï¼Œè¿”å›è¯¥å…ƒç´ ç´¢å¼• -    Array.prototype.fill(value[, start[, end]]) ç”¨ value æ›¿æ¢åŒºé—´ [start, end) ä¹‹é—´çš„å…ƒç´ å€¼ è¿”å›å€¼æ˜¯åŸæ•°ç»„(å…ƒç´ è¢«æ›¿æ¢ä¹‹åçš„)    Array.prototype.copyWithin(target, start[, end]) æ‹·è´åŒºé—´ [start, end) çš„å…ƒç´ æ›¿æ¢ [target, len) åŒºé—´çš„å…ƒç´  å®é™…æ›¿æ¢çš„åŒºé—´é•¿åº¦ç”± min(end - start, len - target) å†³å®šã€‚   Function      Object Object.is(v1, v2) v1 æ˜¯å¦æ˜¯ v2 å¼¥è¡¥ === ä¸èƒ½åˆ¤æ–­ +0ï¼Œ-0 å’Œ NaNï¼ŒNaN    Object.assign(target, ...sources) åˆå¹¶å¯¹è±¡ï¼Œæµ…æ‹·è´ï¼Œèµ‹å€¼è¿ç®—     Object.getPrototypeOf(obj) å–åŸå‹å¯¹è±¡     Object.setPrototypeOf(obj, protoObj) è®¾ç½®åŸå‹å¯¹è±¡     Object.getOwnPropertySymbols(obj) è·å–å¯¹è±¡æ‰€æœ‰ç¬¦å·å±æ€§ Object.keys, Object.getOwnPropertyNames ä¸èƒ½å–ç¬¦å·å±æ€§    Object.getOwnPropertyDescriptor(obj, key) è·å–å¯¹è±¡çš„æè¿°ç¬¦å¯¹è±¡     Object.preventExtensions() é˜»æ­¢å¯¹è±¡å‘—æ‰©å±• -    Object.isExtensible() å¯¹è±¡æ˜¯å¦å¯è¢«æ‰©å±• -   String str.codePointAt(n) Unicodeç¼–ç å€¼ str.charCodeAt(n)    str.fromCodePoint(s) æ ¹æ®ç¼–ç è½¬å­—ç¬¦ str.fromCharCode(s)    str.normalize() å°†å­—ç¬¦çš„ä¸åŒè¡¨ç¤ºæ–¹å¼ç»Ÿä¸€æˆä¸€ç§è¡¨ç¤ºå½¢å¼ undefined, \u0026ldquo;NFC\u0026rdquo;, \u0026ldquo;NFD\u0026rdquo;, \u0026ldquo;NFKC\u0026rdquo;, or \u0026ldquo;NFKD\u0026rdquo;    str.repeat(n) å°†å­—ç¬¦ä¸²é‡å¤ n éï¼Œä½œä¸ºæ–°å­—ç¬¦ä¸²è¿”å› \u0026lsquo;x\u0026rsquo;.repeat(3) =\u0026gt; \u0026lsquo;xxx\u0026rsquo;    ","permalink":"https://www.cheng92.com/web/javascript-ecma-6-plus/","tags":["javascript","es6"],"title":"Javascript ECMA 6 Plus"},{"categories":["algorithm,","string"],"contents":" åŸºäº leetcode çš„ç®—æ³•å­¦ä¹ è®°å½•æ–‡ç« ï¼Œä½¿ç”¨è¯­è¨€ä¸»è¦æ˜¯ JavaScriptï¼Œå¯èƒ½ä¼šæœ‰å°‘äº C/Python å®ç°ï¼Œåœ¨æ²¡æ ‡æ˜çš„æƒ…å†µä¸‹é»˜è®¤éƒ½æ˜¯ JavaScript å®ç°ã€‚\nçº¦å®š ï¼š\n1. æœ‰æ¯æ—¥ è§’æ ‡çš„æ ‡è¯†æ˜¯æ¯æ—¥ä¸€é¢˜çš„é¢˜ç›® 2. æœ‰leetcodeè§’æ ‡çš„æ ‡è¯†æ˜¯è¯¥æ–¹æ¡ˆæ˜¯Leetcode ç½‘ç«™ä¸Šçš„é¢˜è§£ åˆ é™¤å­—ç¬¦ä¸²ä¸­é‡å¤çš„å­—ç¬¦  https://leetcode.com/articles/remove-all-adjacent-duplicates-in-string/\n é¢˜è§£ï¼šåˆ é™¤é ç€çš„é‡å¤å­—ç¬¦ï¼Œç„¶åå¯¹åˆ é™¤åçš„å­—ç¬¦æ‰§è¡ŒåŒæ ·çš„æ“ä½œï¼Œç›´åˆ°æ²¡æœ‰ç´§é ç€çš„é‡å¤å­—ç¬¦ä¸ºæ­¢ã€‚\n æ¯”å¦‚ï¼š abbaca =\u0026gt; del, bb =\u0026gt; aaca =\u0026gt; del, aa =\u0026gt; ca\n æœ€ç»ˆ abbaca ç»è¿‡å¤„ç†å¾—åˆ° ca ã€‚\nwhile å¾ªç¯ç‰ˆæœ¬  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  const del = str =\u0026gt; str.replace(/([a-z])\\1{1,}/gi, \u0026#39;\u0026#39;); function rmDupsWithWhile(current) { let last = \u0026#39;\u0026#39; while (last !== current) { last = current current = del(current) } return current } console.time(\u0026#39;Time\u0026#39;) console.log(\u0026#39;result:\u0026#39;, rmDupsWithWhile(\u0026#39;abbaca\u0026#39;)) console.timeEnd(\u0026#39;Time\u0026#39;)    result: ca Time: 7.468ms undefined   åŸç†å«ç®€å•ï¼Œå°±æ˜¯ä¸æ–­çš„ä½¿ç”¨æ­£åˆ™å»é‡å¤æ›¿æ¢æ‰é‡å¤çš„è¿ç»­å­—ç¬¦ï¼Œç›´åˆ°æœ€å last === current ä¸ºæ­¢ï¼Œ\n å› ä¸ºä¸€æ—¦æ²¡æœ‰é‡å¤è¿ç»­å­—ç¬¦äº†ï¼Œ replace çš„ç»“æœéƒ½æœ€ç»ˆä¸€æ ·ã€‚\n  æ­£åˆ™é€’å½’ç‰ˆæœ¬(å°¾è°ƒç”¨æœªä¼˜åŒ–)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  const str = \u0026#39;abbaca\u0026#39; const del = s =\u0026gt; s.replace(/([a-z])\\1{1,}/gi, \u0026#39;\u0026#39;) function rmDupsWithRecursionNoOptimized(current, last) { if (last == current) return current last = current current = del(current) const res = rmDupsWithRecursionNoOptimized(current, last) // ä¸æ»¡è¶³å°¾è°ƒç”¨ä¼˜åŒ–ï¼šæœªç«‹å³è¿”å›æ‰§è¡Œç»“æœï¼Œéæœ€åä¸€ä¸ªè¯­å¥  return res } console.time(\u0026#39;Time\u0026#39;) const res = rmDupsWithRecursionNoOptimized(str) console.timeEnd(\u0026#39;Time\u0026#39;) console.log(res)    Time: 0.336ms ca undefined    æ­£åˆ™é€’å½’ç‰ˆæœ¬(å°¾è°ƒç”¨ä¼˜åŒ–)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  const str = \u0026#39;abbaca\u0026#39; const del = s =\u0026gt; s.replace(/([a-z])\\1{1,}/gi, \u0026#39;\u0026#39;) function rmDupsWithRecursionOptimized(current, last) { if (last == current) return current last = current current = del(current) // å°¾è°ƒç”¨ä¼˜åŒ–æ¡ä»¶ï¼š 1. ç«‹å³è¿”å›ç»“æœï¼Œ2. æ— å˜é‡å¼•ç”¨ï¼Œ3. æœ€åä¸€è¡Œ  return rmDupsWithRecursionOptimized(current, last) } console.time(\u0026#39;Time\u0026#39;) const res = rmDupsWithRecursionOptimized(str) console.timeEnd(\u0026#39;Time\u0026#39;) console.log(res)    Time: 0.604ms ca undefined      ","permalink":"https://www.cheng92.com/algo/algo-leetcode-string-01/","tags":["algorithm,","leetcode,","javascript,","string"],"title":"Algorithm On Leetcode\u003cString\u003e 1 (Easy Level)"},{"categories":["emacs"],"contents":" ob-jq  1 2 3  {\u0026#34;a\u0026#34;: \u0026#34;test\u0026#34;} .a      Restclient  åŸºç¡€ç”¨æ³•  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  # -*- restclient -*- # # Gets all Github APIs, formats JSON, shows response status and headers underneath. # Also sends a User-Agent header, because the Github API requires this. # GET https://api.github.com User-Agent: Emacs Restclient # # It can even show an image! # GET http://upload.wikimedia.org/wikipedia/commons/6/63/Wikipedia-logo.png # # A bit of json GET, you can pass headers too # GET http://jira.atlassian.com/rest/api/latest/issue/JRA-9 User-Agent: Emacs24 Accept-Encoding: compress, gzip # # Post works too, entity just goes after an empty line. Same is for PUT. # è¯·æ±‚æ•°æ® # POST https://jira.atlassian.com/rest/api/2/search Content-Type: application/json { \u0026#34;jql\u0026#34;: \u0026#34;project = HCPUB\u0026#34;, \u0026#34;startAt\u0026#34;: 0, \u0026#34;maxResults\u0026#34;: 15, \u0026#34;fields\u0026#34;: [ \u0026#34;summary\u0026#34;, \u0026#34;status\u0026#34;, \u0026#34;assignee\u0026#34; ] }     åˆ é™¤ï¼š\n1 2 3 4  # # And delete, will return not-found error... # DELETE https://jira.atlassian.com/rest/api/2/version/20     è®¾ç½®å˜é‡ï¼š\n1 2 3  # Set a variable to the value of your ip address using a jq expression GET http://httpbin.org/ip -\u0026gt; jq-set-var :my-ip .origin      å˜é‡  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  # :myvar = the value # :myvar := (some (artbitrary \u0026#39;elisp) # å¤šè¡Œ :myvar = \u0026lt;\u0026lt; Authorization: :my-auth Content-Type: application/json User-Agent: SomeApp/1.0 # # æˆ–ä½¿ç”¨ lispï¼Œè¦ä»¥ # ç»“æŸ :myvar := \u0026lt;\u0026lt; (some-long-elisp (code spanning many lines) #     ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  # Some generic vars :my-auth = 319854857345898457457 :my-headers = \u0026lt;\u0026lt; Authorization: :my-auth Content-Type: application/json User-Agent: SomeApp/1.0 # # Update a user\u0026#39;s name :user-id = 7 :the-name := (format \u0026#34;%s %s %d\u0026#34; \u0026#39;Neo (md5 \u0026#34;The Chosen\u0026#34;) (+ 100 1)) PUT http://localhost:4000/users/:user-id/ :my-headers { \u0026#34;name\u0026#34;: \u0026#34;:the-name\u0026#34; }     æµ‹è¯•ï¼š\n å–å•ä¸ªç”¨æˆ·\n1 2 3 4  :origin = https://reqres.in # get single user by id=2 GET :origin/api/users/2     åˆ›å»ºç”¨æˆ·\n1 2 3 4 5 6  # create user :origin = https://reqres.in POST :origin/api/users { \u0026#34;name\u0026#34;: \u0026#34;test\u0026#34;, \u0026#34;job\u0026#34;: \u0026#34;test\u0026#34; }        Verb   Examples\n Response Buffer   Response Buffer çš„å†…å®¹ç±»å‹ä¸»è¦ç”± Content-Type å’Œ verb-content-type-handlers çš„ å†…å®¹å†³å®šï¼Œè€Œå­—ç¬¦ç¼–ç è¦ä¹ˆæ˜¯ç”¨ Content-Type ä¸­æŒ‡å®šçš„è¦ä¹ˆæ˜¯ verb-default-response-charset çš„å€¼ï¼Œé»˜è®¤æ˜¯ utf-8 ã€‚\n è€Œç±»å‹ä¸»è¦å°±ä¸¤ç§ï¼Œ Text å’Œ Binary, æ–‡æœ¬ä¼šæ ¹æ® charset æ¥è¿›è¡Œè§£ç åæ˜¾ç¤ºï¼Œå¯¹äºäºŒ è¿›åˆ¶å†…å®¹åˆ™ä½¿ç”¨ emacs å†…ç½®èƒ½åŠ›ç›´æ¥æ˜¾ç¤ºã€‚\n verb-content-type-handlers çš„å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  ;; Value (setq verb-content-type-handlers \u0026#39;((\u0026#34;text/html\u0026#34; html-mode) (\u0026#34;\\\\(application\\\\|text\\\\)/xml\u0026#34; xml-mode) (\u0026#34;application/xhtml\\\\+xml\u0026#34; xml-mode) (\u0026#34;application/json\u0026#34; verb-handler-json) (\u0026#34;application/javascript\u0026#34; js-mode) (\u0026#34;application/css\u0026#34; css-mode) (\u0026#34;text/plain\u0026#34; text-mode) (\u0026#34;application/pdf\u0026#34; doc-view-mode t) (\u0026#34;image/png\u0026#34; image-mode t) (\u0026#34;image/svg\\\\+xml\u0026#34; image-mode t) (\u0026#34;image/x-windows-bmp\u0026#34; image-mode t) (\u0026#34;image/gif\u0026#34; image-mode t) (\u0026#34;image/jpe?g\u0026#34; image-mode t)))     å…³é—­ Response Buffer ä¸¤ä¸ªå‡½æ•°ï¼š\n verb-kill-response-buffer-and-window, \u0026lt;C-c C-r C-k\u0026gt; å…³é—­å½“å‰ã€‚\n verb-kill-all-response-buffers, \u0026lt;C-c C-r C-a\u0026gt; å…³é—­æ‰€æœ‰ã€‚\n é‡æ–°å‘é€è¯·æ±‚ï¼š verb-re-send-request, \u0026lt;C-c C-r r\u0026gt;\n å¦‚æœåœ¨ Response Buffer ä¸­æƒ³æŸ¥çœ‹è¯·æ±‚å†…å®¹å¯ä»¥ä½¿ç”¨ï¼š\n verb-show-request, \u0026lt;C-c C-r C-q\u0026gt;\n verb-toggle-show-headers, \u0026lt;C-c C-r C-h\u0026gt;\n  Request Headers\u0026#xa0;\u0026#xa0;\u0026#xa0;verb  1 2 3  get https://reqres.in/api/users Accept: application/json Content-Language: de-DE     å¤´éƒ¨ä¿¡æ¯å¿…é¡»ç´§éš url åé¢ï¼Œä¸­é—´å¯ä»¥æœ‰ç©ºè¡Œæˆ–æ³¨é‡Š(# æ³¨é‡Š)ã€‚\n æœ‰äº›å­—æ®µæœ‰è‡ªå·±çš„é»˜è®¤å€¼\n1 2 3 4 5 6 7  MIME-Version: 1.0 Connection: close or keep-alive Content-Length: number of bytes in request body (only when body is present) Host: URL host Accept: */* (default value, but may be overwritten by the user) Accept-Encoding: gzip Extension: Security/Digest Security/SSL     ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8  post https://reqres.in/api/users Accept: application/json Content-Type: application/json; charset=utf-8 { \u0026#34;name\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;age\u0026#34;: 42 }    1  (Request timed out after 10.03 seconds)     å¦å¤–è¯·æ±‚çš„æ•°æ®ä½“è¿˜å¯ä»¥ç”¨\n1 2 3 4  { \u0026#34;name\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;age\u0026#34;: 42 }     å½¢å¼è¡¨ç¤ºã€‚\n  Verb Variables\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://reqres.in/api/users Accept: application/json Authentication: {{(verb-var token)}}\n {{(verb-var token)}}\n è¿™ç­‰äºæ˜¯æ‰§è¡Œçš„æ—¶å€™è¦æ±‚ä½ è¾“å…¥ä¸€ä¸ª token å€¼ï¼Œå¦‚æœæƒ³è®¾ç½®é»˜è®¤çš„å€¼å°±è¿™æ ·ï¼š\n {{(verb-var token \u0026#34;default value\u0026#34;)}}\nGet users list  get Content-Language: de-DE\n  Create a user  post Content-Type: application/json; charset=utf-8\n { \u0026#34;name\u0026#34;: \u0026#34;{{(user-full-name)}}\u0026#34;, \u0026#34;age\u0026#34;: \u0026#34;{{(read-string \u0026#34;Age: \u0026#34;)}}\u0026#34; }\n    Org Header Properties\u0026#xa0;\u0026#xa0;\u0026#xa0;verb  :properties: :test: è¿™æ˜¯ä¸ªæ ‡é¢˜å±æ€§ ğŸ”š\n é™¤äº† Verb-Store ä¹‹å¤–çš„å…¶å®ƒä»¥ Verb- å¼€å§‹çš„éƒ½ä¼šè¢«å½“ä½œ metadata æ·»åŠ åˆ°è¯·æ±‚ä¸­å»ã€‚\nVerb-Map-Request  :properties: :Verb-Map-Request: remove-body-newlines ğŸ”š\n post /{{(verb-var user-id)}}/upload Content-Type: text/plain; charset=utf-8\n foo, bar, baz\n å¦‚ä¸Šé¢çš„æ•°æ®åœ¨å‘é€ä¹‹å‰ä¼šè¢« remove-body-newlines å¤„ç†ä¹‹åè¿”å›ï¼Œå³å®é™…å‘é€ç»™æœåŠ¡ å™¨çš„å˜æˆäº†ï¼š foo,bar,baz\n1 2 3 4  (defun remove-body-newlines (rs) ;; RS is of type `verb-request-spec\u0026#39; (oset rs body (replace-regexp-in-string \u0026#34;\\n\u0026#34; \u0026#34; \u0026#34; (oref rs body))) rs)     å¯ä»¥é€šè¿‡ç»™ org head å¢åŠ  Verb-Map-Request æ¥æŒ‡å®šä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨è¯·æ±‚å‘å‡º æˆ–å¯¼å‡ºä¹‹å‰æ‰§è¡Œã€‚\n  Verb-Store\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://reqres.in/api Accept: application/json Content-Type: application/json; charset=utf-8\n è¿™ä¸ªå±æ€§å¾ˆç‰¹æ®Šï¼Œå½“æŒ‡å®šäº†è¿™ä¸ªä¹‹åï¼Œè¯·æ±‚çš„ç»“æœä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¿™å®ƒæŒ‡å®šçš„å˜é‡ä¸Šå»ã€‚\n ç„¶åå¯ä»¥é€šè¿‡ verb-stored-response å‡½æ•°å»å–åˆ°è¿™ä¸ªå˜é‡çš„å€¼ã€‚\n å¦‚ï¼š\nCreate a user  :properties: :Verb-Store: new-user ğŸ”š\n post Content-Type: application/json; charset=utf-8\n { \u0026#34;name\u0026#34;: \u0026#34;{{(user-full-name)}}\u0026#34;, \u0026#34;age\u0026#34;: \u0026#34;{{(read-string \u0026#34;Age: \u0026#34;)}}\u0026#34; }\n è¿™é‡Œçš„ç»“æœä¿å­˜åˆ°äº† new-user\n  Get last created user  get /{{(verb-json-get (oref (verb-stored-response \u0026#34;new-user\u0026#34;) body) \u0026#34;id\u0026#34;)}} Accept: application/json\n è¿™é‡Œå»å–ä¿å­˜çš„ç»“æœã€‚\n  Get IP  :properties: :Verb-Store: new-person ğŸ”š\n post /users\n { \u0026#34;name\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;age\u0026#34;: 42 }\n  get Stored IP   get /users/{{(verb-json-get (oref (verb-stored-response \u0026#34;new-person\u0026#34;) body) \u0026#34;id\u0026#34;)}}\n  Get Last Response   get /users/{{(verb-json-get (oref verb-last body) \u0026#34;id\u0026#34;)}}\n å–ä¸Šä¸€ä¸ªè¯·æ±‚çš„å“åº”æ•°æ®ã€‚\n      Org Source Block Properties  :wrap   :wrap src ob-verb-response\n æŒ‡å®šç»“æœç”¨ src block å°†ç»“æœåŒ…èµ·æ¥ã€‚\n1  get https://api.ipify.org?format=json    1 2 3 4 5 6 7 8 9 10 11 12  HTTP/1.1 200 OK Server: Cowboy Connection: keep-alive Content-Type: application/json Vary: Origin Date: Sat, 24 Jul 2021 11:15:56 GMT Content-Length: 22 Via: 1.1 vegur { \u0026#34;ip\u0026#34;: \u0026#34;27.38.254.246\u0026#34; }      :op   æ²¡æœ‰æŒ‡å®š :op çš„æ—¶å€™é»˜è®¤æ˜¯ :op send\nTIP\n å¯ä»¥ä½¿ç”¨ :var keyword æ¥ç»™ verb src block ä¼ é€’å‚æ•°ï¼Œç„¶ååœ¨ä»£ç å—ä¸­ç”¨\n (verb-var \u0026lt;variable-name\u0026gt;) ä½¿ç”¨ã€‚\n   :op send get-headers: åªæ˜¾ç¤ºå“åº”å¤´ä¿¡æ¯ã€‚\n1  get https://api.ipify.org?format=json    1 2 3 4 5 6 7  Server: Cowboy Connection: keep-alive Content-Type: application/json Vary: Origin Date: Sat, 24 Jul 2021 11:11:31 GMT Content-Length: 22 Via: 1.1 vegur      :op send get-body: åªæ˜¾ç¤ºå“åº”ä½“ä¿¡æ¯ã€‚\n1  get https://api.ipify.org?format=json    1 2 3  { \u0026#34;ip\u0026#34;: \u0026#34;27.38.254.246\u0026#34; }      :op export curl å°†è¯·æ±‚å¯¼å‡ºä¸º CURL æ ¼å¼ã€‚\n1  get https://api.ipify.org?format=json    curl \u0026#39;https://api.ipify.org/?format=json\u0026#39;    :op export verb å°†è¯·æ±‚å¯¼å‡ºä¸º verb æ ¼å¼ã€‚\n1  get https://api.ipify.org?format=json    GET https://api.ipify.org/?format=json        Upload File  1 2 3 4  post /{{(verb-var user-id)}}/upload Content-Type: text/markdown; charset=utf-8 {{(verb-read-file \u0026#34;~/Desktop/test.md\u0026#34;)}}     ä¸‹é¢ä¸ºä»€ä¹ˆå†…å®¹å‰é¢è¦åŠ ä¸Š {{}} ï¼Œå› ä¸º org-mode é»˜è®¤ ** æ˜¯æ ‡é¢˜ï¼ŒåŠ ä¸ªç©ºçš„ {{}} å¯é¿å…é—®é¢˜ã€‚\n1 2 3 4 5 6 7  post /{{(verb-var user-id)}}/upload Content-Type: text/markdown; charset=utf-8 # Sample Markdown file {{}}**This text is bold.** {{}}*This text is italicized.*      Upload Multiple Files   post www.example.com Accept: / Content-Type: multipart/form-data; boundary={{(verb-boundary)}}\n {{(verb-part \u0026#34;file\u0026#34; \u0026#34;1.txt\u0026#34;)}} Content-Type: text/plain\n {{(verb-read-file \u0026#34;/path/to/1.txt\u0026#34;)}} {{(verb-part \u0026#34;file\u0026#34; \u0026#34;2.html\u0026#34;)}} Content-Type: text/html\n {{(verb-read-file \u0026#34;/path/to/2.html\u0026#34;)}} {{(verb-part)}}\n  Binary content type tests\u0026#xa0;\u0026#xa0;\u0026#xa0;verb  template https://www.gnu.org\nPDF  get /licenses/quick-guide-gplv3.pdf\n  Images  template /graphics\nPNG image  get /gnu-head.png\n  JPG image  get /bokma-gnu.jpg\n  SVG image  get /logo-fsf.org.svg\n      /dev/null as a Service\u0026#xa0;\u0026#xa0;\u0026#xa0;verb  #\n post https://devnull-as-a-service.com/dev/null Content-Type: text/plain; charset=utf-8\n Hello!\n  Hacker News API\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://hacker-news.firebaseio.com/v0 Accept: application/json\nItem   get /item/{{(read-string \u0026#34;Item ID: \u0026#34;)}}.json?print=pretty\n  User   get /user/{{(read-string \u0026#34;User ID: \u0026#34;)}}.json\n  Live Data  Max Item ID  get /maxitem.json\n  Top Stories  get /topstories.json\n  New Stories  get /newstories.json\n  Best Stories  get /beststories.json\n      Export to EWW example\u0026#xa0;\u0026#xa0;\u0026#xa0;verb  get http://neverssl.com Accept: text/html\n  ipify API\u0026#xa0;\u0026#xa0;\u0026#xa0;verb  IPv4  template https://api.ipify.org\nJSON  get ?format=json\n  Text  get ?format=text\n    IPv6  template https://api6.ipify.org\nJSON  get ?format=json\n  Text  get ?format=text\n      Kanye REST API\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://api.kanye.rest\nGet quotes text response (Babel)  :properties: :Verb-Store: kanye ğŸ”š\n1  get ?format=text    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  HTTP/1.1 200 OK Date: Sat, 24 Jul 2021 05:29:44 GMT Content-Type: application/json Transfer-Encoding: chunked Connection: keep-alive Access-Control-Allow-Origin: * Access-Control-Allow-Headers: Content-Type Access-Control-Allow-Methods: GET Expect-CT: max-age=604800, report-uri=\u0026#34;https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct\u0026#34; Report-To: {\u0026#34;endpoints\u0026#34;:[{\u0026#34;url\u0026#34;:\u0026#34;https:\\/\\/a.nel.cloudflare.com\\/report\\/v3?s=yHwX2nlypygqT90DSvEtAsrxWQU9YjDmSajgfG9hzsmYqNFvKAAZRP0CqOKVhvgSZ4b1cdLk1d%2BF8gxrow4rkKyy1xnIxtB9qUv4XfU2Ls6GETgSh7uthXVNf5T6oz3V2g%3D%3D\u0026#34;}],\u0026#34;group\u0026#34;:\u0026#34;cf-nel\u0026#34;,\u0026#34;max_age\u0026#34;:604800} NEL: {\u0026#34;report_to\u0026#34;:\u0026#34;cf-nel\u0026#34;,\u0026#34;max_age\u0026#34;:604800} Vary: Accept-Encoding Server: cloudflare CF-RAY: 673ac0a53ce6eb3d-LAX alt-svc: h3-27=\u0026#34;:443\u0026#34;; ma=86400, h3-28=\u0026#34;:443\u0026#34;; ma=86400, h3-29=\u0026#34;:443\u0026#34;; ma=86400, h3=\u0026#34;:443\u0026#34;; ma=86400 { \u0026#34;quote\u0026#34;: \u0026#34;I don\u0026#39;t wanna see no woke tweets or hear no woke raps ... it\u0026#39;s show time ... it\u0026#39;s a whole different energy right now\u0026#34; }      Get JSON quotes, body only (Babel)  1  get    1 2 3  { \u0026#34;quote\u0026#34;: \u0026#34;The thought police want to suppress freedom of thought\u0026#34; }      Get JSON quotes  1  get    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  HTTP/1.1 200 OK Date: Sun, 25 Jul 2021 06:37:39 GMT Content-Type: application/json Transfer-Encoding: chunked Connection: keep-alive Access-Control-Allow-Origin: * Access-Control-Allow-Headers: Content-Type Access-Control-Allow-Methods: GET Expect-CT: max-age=604800, report-uri=\u0026#34;https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct\u0026#34; Report-To: {\u0026#34;endpoints\u0026#34;:[{\u0026#34;url\u0026#34;:\u0026#34;https:\\/\\/a.nel.cloudflare.com\\/report\\/v3?s=b%2Bwjrw%2BO3AfKcLJXXQYyedGb%2BGEF%2BOrodpiucCNhs2kiJRw4kI6axDCBz6uIXKsMajdiiL2FLSy34eVmH0HyBQ22Vt6zK91I4aeHHXQ2bJYC4OQs6tj34Cc3x4Y93xOplg%3D%3D\u0026#34;}],\u0026#34;group\u0026#34;:\u0026#34;cf-nel\u0026#34;,\u0026#34;max_age\u0026#34;:604800} NEL: {\u0026#34;report_to\u0026#34;:\u0026#34;cf-nel\u0026#34;,\u0026#34;max_age\u0026#34;:604800} Vary: Accept-Encoding Server: cloudflare CF-RAY: 67436180ffac3131-LAX alt-svc: h3-27=\u0026#34;:443\u0026#34;; ma=86400, h3-28=\u0026#34;:443\u0026#34;; ma=86400, h3-29=\u0026#34;:443\u0026#34;; ma=86400, h3=\u0026#34;:443\u0026#34;; ma=86400 { \u0026#34;quote\u0026#34;: \u0026#34;If I got any cooler I would freeze to death\u0026#34; }        Open Library API\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template http://openlibrary.org User-Agent: Verb/Emacs Emacs/{{emacs-version}} Accept: application/json\nSearch  template /search.json\nBy Title  1  get ?title={{(verb-var title)}}      By Author  get ?author={{(verb-var author \u0026#34;Frank Herbert\u0026#34;)}}\n    Subjects  get /subjects/{{(verb-var subject)}}.json\n  Books  :properties: :Verb-Store: book ğŸ”š\n get /api/books?bibkeys=ISBN:{{(verb-var isbn)}}\u0026amp;format=json\n  Book Cover  get {{(verb-json-get (oref (verb-stored-response \u0026#34;book\u0026#34;) body) (concat \u0026#34;ISBN:\u0026#34; (verb-var isbn)) \u0026#34;thumbnail_url\u0026#34;)}} Accept: image/jpeg\n    Postman Echo API\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://postman-echo.com\nGZIP test  get /gzip Accept-Encoding: gzip\n  Stream test  get /stream/5\n  Post  post /post Content-Type: application/json\n { \u0026#34;hello\u0026#34;: 1, \u0026#34;bye\u0026#34;: {} }\nPost (raw text)  template Content-Type: text/plain\n {{(verb-read-file \u0026#34;../test/test.txt\u0026#34;)}}\n    Status code  get /status/{{(read-number \u0026#34;Status: \u0026#34;)}}\n    REQ|RES\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://reqres.in/api?delay=0 Content-Type: application/json\nUsers   template /users\nGet endpoint headers  head\n  Get endpoint options  options\n  List users   get ?page=1\n  Create user  post Content-Type: application/json\n { \u0026#34;name\u0026#34;: \u0026#34;{{(user-login-name)}}\u0026#34;, \u0026#34;age\u0026#34;: 55 }\n  Operate on a single user   template /2\nGet a single user  get\n  Replace a user  put\n { \u0026#34;name\u0026#34;: \u0026#34;Bob\u0026#34; }\n  Update a user  patch\n { \u0026#34;name\u0026#34;: \u0026#34;Bob\u0026#34; }\n  Delete a user  delete\n      Login   post /login\n1 2 3 4  { \u0026#34;email\u0026#34;: \u0026#34;eve.holt@reqres.in\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;hello\u0026#34; }        Scryfall REST API\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://api.scryfall.com\nCards list   get /cards\nSingle card by ID   get /{{(read-string \u0026#34;Card ID: \u0026#34; \u0026#34;4b332e3d-dcf4-4f62-8130-124ec5d23b90\u0026#34;)}}?format=text\n  Get a random card image   get /random?format=image\n    Sets   get /sets\nSingle set by ID   get /{{(read-string \u0026#34;Set ID: \u0026#34; \u0026#34;914a6c6d-cb3b-45e8-a2db-9978a2339faf\u0026#34;)}}\n      API2 convert\u0026#xa0;\u0026#xa0;\u0026#xa0;verb   template https://api2.online-convert.com x-oc-api-key: d89c39a23d8f41ca8fd13ef85297b9a7 Cache-Control: no-cache\n api documents\nget id and server  :properties: :Verb-Store: convert-response ğŸ”š\n post /jobs\n { \u0026#34;conversion\u0026#34;: [{ \u0026#34;category\u0026#34;: \u0026#34;image\u0026#34;, \u0026#34;target\u0026#34;: \u0026#34;png\u0026#34; }] }\n  base64 -\u0026gt; image  :properties: :Verb-Store: image-response ğŸ”š\n POST {{(verb-json-get (oref (verb-stored-response \u0026#34;convert-response\u0026#34;) body) \u0026#34;server\u0026#34;)}}/upload-base64/{{(verb-json-get (oref (verb-stored-response \u0026#34;convert-response\u0026#34;) body) \u0026#34;id\u0026#34;)}} Content-Type: image/png\n { \u0026#34;content\u0026#34;: \u0026#34;data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=\u0026#34;, \u0026#34;filename\u0026#34;: \u0026#34;black-pixel\u0026#34; }\n  get the upload image   POST /jobs\n { \u0026#34;input\u0026#34;: [{ \u0026#34;type\u0026#34;: \u0026#34;input_id\u0026#34;, \u0026#34;source\u0026#34;: \u0026#34;{{(verb-json-get (oref (verb-stored-response \u0026#34;image-response\u0026#34;) body) \u0026#34;id\u0026#34; \u0026#34;input\u0026#34;)}}\u0026#34; }], \u0026#34;conversion\u0026#34;: [{ \u0026#34;target\u0026#34;: \u0026#34;png\u0026#34; }] }\n  multiple image   POST /dl/web2/upload-base64/a6f691e2-839e-49e5-829d-dc2d97486fe1 Content-Type: application/json\n [{ \u0026#34;content\u0026#34;: \u0026#34;data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=\u0026#34;, \u0026#34;filename\u0026#34;: \u0026#34;black_pixel.gif\u0026#34; },{ \u0026#34;content\u0026#34;: \u0026#34;data:text/plain;base64,dGVzdCBzdHJpbmc=\u0026#34;, \u0026#34;filename\u0026#34;: \u0026#34;example_string.txt\u0026#34; }]\n      tables  åˆ—å®½å’Œå¯¹é½(Column width and alignment)     1 one some   2 two boring   3 this is a long text column        keybindings  é€—å·(,)  , s trees/subtrees æ“ä½œ     key function description     , s h org-premote-subtree å‡çº§, h4 -\u0026gt; h3   , s l org-demote-subtree é™çº§, h3 -\u0026gt; h4   , s n org-narrow-to-subtree å®šä½åˆ°å½“å‰çš„æ ‡é¢˜è¯•å›¾ï¼Œéšè—å…¶ä»–   , s N widen æ¢å¤éšè—   , s j org-move-subtree-down å½“å‰æ ‘ä¸‹ç§»   , s k org-move-subtree-up å½“å‰æ ‘ä¸Šç§»      , b org-babel-* æ“ä½œ     key function description     , b p org-babel-previous-src-block è·³è½¬åˆ°ä¸Šä¸€ä¸ªä»£ç å—   , b n org-babel-next-src-block è·³è½¬åˆ°ä¸‹ä¸€ä¸ªä»£ç å—          Hyperlinks(è¶…é“¾æ¥)  Internal Links(å†…éƒ¨é“¾æ¥)    org file link target: \u0026lt;\u0026lt;target\u0026gt;\u0026gt; link source: target\n è¿™ç§æ–¹å¼åœ¨ hugo ä¸­æ— æ³•æ—¶å€™ç”¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ç¬¬äºŒç§æ–¹å¼çš„ PROP: CUSTOM_ID æ¥å®ç°ã€‚\n  in hugo link target: doc_header å¿…é¡»åœ¨æŸä¸ªæ ‡é¢˜ä¸‹é¢å£°æ˜å±æ€§ï¼Œæ‰èƒ½å…¶æ•ˆæœã€‚\n:PROPERTIES: :COLUMNS: %CUSTOM_ID[(Custom Id)] :CUSTOM_ID: doc_header :END:   link source: C-c C-l æˆ–è€… org-insert-link æˆ–è€…ç›´æ¥ [[#doc_header][æ–‡æ¡£å¼€ å¤´ä½ç½®]] ï¼Œè¯·ç‚¹å‡»ï¼šæ–‡æ¡£å¼€å¤´ä½ç½®\n    å®ç°éæ ‡é¢˜é¡¹å†…éƒ¨è·³è½¬   æ·»åŠ  meta: @@html:\u0026lt;span id=\u0026#34;test-link\u0026#34;\u0026gt;\u0026lt;/span\u0026gt;\n æ·»åŠ é“¾æ¥è·³è½¬åˆ°ä¸Šé¢çš„ metaï¼š @@html:\u0026lt;a href=\u0026#34;#test-link\u0026#34;\u0026gt;some thing\u0026lt;/a\u0026gt;\n è¿™æ ·ç‚¹å‡» some thing ä¼šå æ»¡åˆ° id ä¸º test-link çš„é‚£ä¸ªå…ƒç´ ä½ç½®ã€‚\n å¦‚ï¼š è¯·ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥è·³å›åˆ°æˆ‘è¿™é‡Œæ¥ã€‚ã€‚ã€‚ã€‚\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n some thing !!!\n ğŸ”—ç‚¹æˆ‘è·³å›åˆ°ä¸Šé¢ï¼ï¼\n    Markup for Rich Contents(å¯Œæ–‡æœ¬)  Literal Examples(æ–‡æœ¬æ¨¡æ¿)   é€‚åˆé•¿æ–‡æœ¬å†…å®¹çš„ï¼š\n* some example from a text file   å¦‚æœåªæ˜¯ç®€çŸ­çš„è¯­å¥ï¼Œå¯ç›´æ¥ä½¿ç”¨ `:`(å†’å·)ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·æ•ˆæœï¼š\n* some short example from a text file   ä»£ç æ¨¡æ¿ï¼š\n1 2 3  (defun org-xor (a b) (ref:sc) \u0026#34;Exclusive or.\u0026#34; (ref:jump) (if a (not b) b))     é…ç½®é€‰é¡¹: -n ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­åŠ å…¥å¼•ç”¨ (ref:sc) ï¼Œç„¶ååœ¨æ–‡ç« ä»»æ„åœ°æ–¹ä½¿ç”¨ [[(sc)]] åˆ›å»ºä¸€ä¸ªé“¾æ¥ï¼Œç‚¹å‡»åå¯ä»¥å®šä½åˆ°ä»£ç ä¸­è¯¥å‡ºã€‚\n In line (sc) we remember the current position. Line (jump) jumps to point-min.\n link: literal_eg\n    16 Miscellaneous(æ‚é¡¹)  16.2 Structure Templates(ç»“æ„åŒ–æ¨¡æ¿)  a\tâ€˜#+BEGIN_EXPORT asciiâ€™ â€¦ â€˜#+END_EXPORTâ€™ c\tâ€˜#+BEGIN_CENTERâ€™ â€¦ â€˜#+END_CENTERâ€™ C\tâ€˜#+BEGIN_COMMENTâ€™ â€¦ â€˜#+END_COMMENTâ€™ e\tâ€˜#+BEGIN_EXAMPLEâ€™ â€¦ â€˜#+END_EXAMPLEâ€™ E\tâ€˜#+BEGIN_EXPORTâ€™ â€¦ â€˜#+END_EXPORTâ€™ h\tâ€˜#+BEGIN_EXPORT htmlâ€™ â€¦ â€˜#+END_EXPORTâ€™ l\tâ€˜#+BEGIN_EXPORT latexâ€™ â€¦ â€˜#+END_EXPORTâ€™ q\tâ€˜#+BEGIN_QUOTEâ€™ â€¦ â€˜#+END_QUOTEâ€™ s\tâ€˜#+BEGIN_SRCâ€™ â€¦ â€˜#+END_SRCâ€™ v\tâ€˜#+BEGIN_VERSEâ€™ â€¦ â€˜#+END_VERSEâ€™    16.7 Summary of In-Buffer Settings(æ–‡ä»¶è®¾ç½®)    `#+STARTUP:`\n   option function     indent å¼€å¯è‡ªåŠ¨ç¼©è¿›   noindent å…³é—­è¥¿ä¸œç¼©è¿›          Org-mode in hugo   ç»™å›¾ç‰‡å¢åŠ å±æ€§(ä½¿ç”¨ #+attr_html)ï¼š\n#+attr_html: :width 100 :height 200 [[/images/some-img.png]]  #+ å¼€å¤´çš„å±æ€§    #+caption: è®¾ç½®è¡¨åç§°\n  #+attr_html å¢åŠ  html å±æ€§ï¼Œæ¯”å¦‚ï¼š\n  å¢åŠ æ ·å¼åï¼š #+attr_html: :class classname\n  è®¾ç½®å®½é«˜ï¼š #+attr_html: :width 100 :height 100\n    #+attr_css å¢åŠ  css æ ·å¼ï¼Œæ¯”å¦‚ï¼š\n  è®¾ç½®å®½é«˜ï¼š #+attr_css: :width 100px :height 200px :text-align center ï¼Œæ³¨æ„å’Œ html å±æ€§åŒº åˆ†å¼€\n        snippets  é¦–å­—æ¯å¤§å†™   æ–°å¢å‡½æ•°ï¼š\n1 2 3 4 5 6  (defun my/capitalize-first-char (\u0026amp;optional string) \u0026#34;Capitalize only the first character of the input STRING.\u0026#34; (when (and string (\u0026gt; (length string) 0)) (let ((first-char (substring string nil 1)) (rest-str (substring string 1))) (concat (capitalize first-char) rest-str))))     ç„¶ååœ¨ snippet æ–‡ä»¶ä¸­è°ƒç”¨ï¼š\n# -*- mode: snippet -*- # name: intro # key: zname # -- Hi, my name is ${1:$$(my/capitalize-first-char yas-text)}. $0      org-html-themes   ","permalink":"https://www.cheng92.com/emacs/emacs-org-mode/","tags":["emacs,","org-mode"],"title":"My Emacs Org-Mode Document"},{"categories":["algorithm,","array"],"contents":" åŸºäº leetcode çš„ç®—æ³•å­¦ä¹ è®°å½•æ–‡ç« ï¼Œä½¿ç”¨è¯­è¨€ä¸»è¦æ˜¯ JavaScriptï¼Œå¯èƒ½ä¼šæœ‰å°‘äº C/Python å®ç°ï¼Œåœ¨æ²¡æ ‡æ˜çš„æƒ…å†µä¸‹é»˜è®¤éƒ½æ˜¯ JavaScript å®ç°ã€‚\nçº¦å®š ï¼š\n1. æœ‰æ¯æ—¥ è§’æ ‡çš„æ ‡è¯†æ˜¯æ¯æ—¥ä¸€é¢˜çš„é¢˜ç›® 2. æœ‰leetcodeè§’æ ‡çš„æ ‡è¯†æ˜¯è¯¥æ–¹æ¡ˆæ˜¯Leetcode ç½‘ç«™ä¸Šçš„é¢˜è§£ 01. æ•°ç»„ä¸­é‡å¤çš„æ•°å­—  æ–¹æ¡ˆä¸€ï¼š reduce + Object.keys + map + filter  ä¸‹é¢è¿™ç§æ–¹æ¡ˆé€‚åˆäºå°†æ‰€æœ‰é‡å¤çš„æ•°å­—éƒ½æ‰¾å‡ºæ¥çš„æ¡ˆä¾‹ï¼Œå¦‚æœåªéœ€è¦æ‰¾åˆ°ç¬¬ä¸€ä¸ªï¼Œè¯¥æ–¹æ¡ˆæœ‰å¤šä½™çš„å¤„ç†æ­¥éª¤ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  /** ,* @param {number[]} nums ,* @return {number} ,*/ var findRepeatNumber = function (nums) { if (!Array.isArray(nums)) return [] // é€šè¿‡ reduce å¾—åˆ° { val: times } ç»“æœ  // å¦‚æœé‡å¤å‡ºç°è¿‡ times \u0026gt; 0 å¦åˆ™ times === 0  let res = nums.reduce((acc, num) =\u0026gt; { const k = num + \u0026#34;\u0026#34; let v = acc[num + \u0026#34;\u0026#34;] || 0 if (acc.hasOwnProperty(k)) { acc[k] = ++v } else { acc[k] = 0 } return acc }, {}) // ç„¶åé€šè¿‡ keys, map æ•´ç†ç»“æœ times \u0026gt; 0 çš„å€¼  // æœ€å filter è¿‡æ»¤æ‰ 0 å€¼å¾—åˆ°çš„æ•°ç»„å°±æ˜¯æºæ•°ç»„ä¸­é‡å¤çš„æ•°é›†åˆ  const found = +Object.keys(res) .map(k =\u0026gt; (res[k] ? k : 0)) .filter(Boolean)[0] return found !== found ? -1 : found } console.log(findRepeatNumber([2, 3, 1, 0, 2, 5, 3]))    2 undefined   æ‰§è¡Œç»“æœï¼š\n æ‰§è¡Œç”¨æ—¶ï¼š152 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 24.41%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š51.9 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 100.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 152 ms 51.9 MB Javascript      æ–¹æ¡ˆäºŒ: for  ä½¿ç”¨ for è¯­æ³•ï¼Œæ˜æ˜¾ä¼šæ¯”ä½¿ç”¨ reduce å¿«ï¼Œå› ä¸ºå®ƒåªè¦é‡åˆ°é‡å¤çš„ç«‹å³é€€å‡ºå‡½æ•°ï¼Œè€Œ reduce ç‰ˆæœ¬æ— è®ºä»€ä¹ˆæ—¶å€™éƒ½éœ€è¦å°†æ•°ç»„æ‰€æœ‰å…ƒç´ éå†å®Œï¼Œæ–¹æ¡ˆä¸€æ›´é€‚åˆäºæŸ¥æ‰¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  var findRepeatNumber = function (nums) { if (!Array.isArray(nums)) return -1 let res = {} for (let i = 0, len = nums.length; i \u0026lt; len; i++) { let k = nums[i] + \u0026#34;\u0026#34;, v = res[k] if (res.hasOwnProperty(k)) { return k } else { res[k] = 0 } } return -1 }     æäº¤ç»“æœ ï¼š\n æ‰§è¡Œç”¨æ—¶ï¼š88 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 57.41%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š43.1 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 100.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ \u0026lt;font color=\u0026#34;red\u0026#34;\u0026gt;88 ms\u0026lt;/font\u0026gt; 43.1 MB Javascript   3 åˆ†é’Ÿå‰ é€šè¿‡ 104 ms 43 MB Javascript   1 å¤©å‰ é€šè¿‡ 152 ms 51.9 MB Javascript      æ–¹æ¡ˆä¸‰: é€’å½’  è¿™ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡ï¼Œä½†æ•ˆç‡ä¸Šé¢æ„Ÿè§‰å¹¶æ²¡ä»€ä¹ˆä¼˜åŠ¿ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æ‰¾å‡ºçš„å¹¶ä¸æ˜¯ç¬¬ä¸€ä¸ªé‡å¤çš„å…ƒç´ ã€‚\n å¯¹æ¯”[æ–¹æ¡ˆäºŒ]ï¼š\n  é‡å¤å…ƒç´ åœ¨ä¸­å¿ƒç‚¹ä¸¤è¾¹ï¼ŒåŒæ ·éœ€è¦éå†ç›¸åŒçš„æ¬¡æ•°æ‰èƒ½æ‰¾åˆ°è¿™ä¸ªé‡å¤å…ƒç´ (å› ä¸ºå·¦è¾¹çš„é€’å½’å¿…é¡»å…ˆå®Œæˆ)\n  é‡å¤å…ƒç´ åœ¨å·¦è¾¹ï¼Œå·¦è¾¹é€’å½’æ¬¡æ•°å’Œæ–¹æ¡ˆäºŒå¾ªç¯æ¬¡æ•°æ˜¯ä¸€æ ·çš„\n  é‡å¤å…ƒç´ åœ¨å³è¾¹ï¼Œå·¦è¾¹å¿…é¡»é€’å½’å®Œï¼Œå³è¾¹çš„ä¹Ÿå¿…é¡»é€’å½’ç›´åˆ°ä¸¤ä¸ªé‡å¤å…ƒç´ å‡ºç°(åŒæ–¹æ¡ˆä¸€ä¸€æ ·)\n  èƒ½å¦é’ˆå¯¹ä¸Šé¢çš„æƒ…å†µè¿›è¡Œä¼˜åŒ–( text è€ƒè™‘ä¸­å¿ƒç‚¹ä¸¤è¾¹åŒ æ—¶è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯ç­‰ä¸€è¾¹å®Œæˆå†å¤„ç†å¦ä¸€è¾¹ï¼Œé‚£è²Œä¼¼å°±ä¸é€‚ç”¨é€’å½’äº† )???\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  findRepeatNumber = function _(nums, res = {}) { if (!Array.isArray(nums)) return -1 // è¿‡æ»¤æ‰éæ•°ç»„çš„æƒ…å†µ  let len = nums.length, mid = ~~(len / 2) const v = nums[0] const val = res[v] if (v !== void 0) { // è¿™é‡Œåº”è¯¥å¯ä»¥å†ä¼˜åŒ–ä¸‹ï¼Œç©ºæ•°ç»„ä¸åº”è¯¥ä¼šåˆ°è¿™é‡Œ  res[v] = val \u0026gt;= 0 ? val + 1 : 0 // console.log(v, \u0026#34;-------\u0026#34;, res)  if (res[v] \u0026gt; 0) { return v // è¿™é‡Œçš„è¿”å›å€¼ä¼šè¢«ä¸‹é¢é€’å½’æ˜¯çš„ x å˜é‡æ¥å—  } } let x = null if (mid \u0026gt; 0) {// è¿™é‡Œä¼˜åŒ–ç©ºæ•°ç»„æƒ…å†µï¼Œä¸åº”è¯¥ç»§ç»­å¾€ä¸‹åˆ†è§£äº†  x = _(nums.slice(1, mid), res) if (x \u0026gt; -1) return x x = _(nums.slice(mid), res) if (x \u0026gt; -1) return x } return -1 }     æ‰§è¡Œç”¨æ—¶ï¼š112 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 28.43%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š49.8 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 100.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 112 ms 49.8 MB Javascript   3 å¤©å‰ é€šè¿‡ 92 ms 45.5 MB Javascript   3 å¤©å‰ é€šè¿‡ 104 ms 45.1 MB Javascript   4 å¤©å‰ é€šè¿‡ 88 ms 43.1 MB Javascript   4 å¤©å‰ é€šè¿‡ 104 ms 43 MB Javascript   6 å¤©å‰ é€šè¿‡ 152 ms 51.9 MB Javascript      æ–¹æ¡ˆå››ï¼šäºŒåˆ† for  è¿™ä¸ªæ–¹æ¡ˆå¥½å¤„å°±æ˜¯å½“ä¸¤ä¸ªæ•°åˆ†å¸ƒåœ¨ä¸­å¿ƒç‚¹çš„ä¸¤è¾¹çš„æ—¶å€™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  var findRepeatNumber = function _(nums) { if (!Array.isArray(nums)) return -1 const len = nums.length const mid = ~~(len / 2) let res = {} for (let i = 0, j = mid + 1; i \u0026lt;= mid || j \u0026lt; len; i++, j++) { const v1 = nums[i] if (v1 !== void 0) { res[v1] = res[v1] === void 0 ? 0 : res[v1] + 1 } if (res[v1] \u0026gt; 0) return v1 const v2 = nums[j] if (v2 !== void 0) { res[v2] = res[v2] === void 0 ? 0 : res[v2] + 1 } if (res[v2] \u0026gt; 0) return v2 } return -1 }     ç»“æœå¥½åƒå¹¶æ²¡å•¥ä¼˜åŠ¿ï¼ŒğŸ˜…!!!\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 104 ms 45.4 MB Javascript   1 åˆ†é’Ÿå‰ é€šè¿‡ 108 ms 45.6 MB Javascript   1 åˆ†é’Ÿå‰ é€šè¿‡ 116 ms 45.6 MB Javascript   1 åˆ†é’Ÿå‰ é€šè¿‡ 88 ms 45.7 MB Javascript      å…¶ä»–æ–¹æ¡ˆ(leetcoders)  å…¶ä»– leetcode ä¸Šçš„æ–¹æ¡ˆï¼Œè§‰å¾—æœ‰è¶£æŒºå¥½çš„æ–¹æ¡ˆåˆ—è¡¨ï¼š\n  set.has é€šè¿‡é›†åˆç‰¹æ€§æ£€æµ‹æ˜¯å¦å­˜åœ¨\n  1 2 3 4 5 6 7 8 9 10  var findRepeatNumber = function _(nums) { let s = new Set() for (let i = 0, len = nums.length; i \u0026lt; len; i++) { const val = nums[i] // è¿™é‡Œè¿˜å¯ä»¥æ”¹é€ ä¸‹ï¼Œé€šè¿‡æ£€æµ‹é•¿åº¦å˜åŒ–æ¥åšä¸ºé€€å‡ºæ¡ä»¶  if (s.has(val)) return val else s.add(val) } return -1 }        02. ä¸¤æ•°ä¹‹å’Œ II - è¾“å…¥æœ‰åºæ•°ç»„  æ–¹æ¡ˆä¸€ï¼šä¸¤ä¸ª forï¼ŒO(n2)   è¿™ç§æ–¹æ³•æœ€ç®€å•æš´åŠ›ï¼Œä½†æ˜¯æ—¶é—´å¤æ‚åº¦ä¸º O(n^2)\n1 2 3 4 5 6 7 8 9 10 11 12 13  // æœ€åŸºæœ¬çš„éå† O(n^2)  var twoSum = function(numbers, target) { let len = numbers.length for (let i = 0; i \u0026lt; len; i++) { for (let j = i + 1; j \u0026lt; len; j++) { if (numbers[i] + numbers[j] === target) { return [i + 1, j + 1] } } } return -1 };     æ‰§è¡Œç”¨æ—¶ï¼š444 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 5.30%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 444 ms 38 MB Javascript     è¯¥æ–¹æ¡ˆåŸºç¡€ä¸Šå¯ä»¥åšç‚¹ä¼˜åŒ–ï¼Œæ’é™¤éæ³•å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  // æŠŠä¸Šé¢çš„å®ç°ï¼Œé¢†å‡ºæ¥ä½œä¸ºä¸€ä¸ªå‡½æ•°  function base(numbers, target) { let len = numbers.length for (let i = 0; i \u0026lt; len; i++) { for (let j = i + 1; j \u0026lt; len; j++) { if (numbers[i] + numbers[j] === target) { return [i + 1, j + 1] } } } return [] } // è¿™é‡ŒåŠ ä¸€å±‚è¿‡æ»¤ã€‚  // è¿‡æ»¤ä¸åˆæ³•çš„å€¼ï¼Œå› ä¸ºNumbers æ˜¯å·²æ’åºçš„æ•°ç»„ï¼Œæ‰€ä»¥ numbers[0] è‚¯å®šæ˜¯æœ€å°çš„  // é€šè¿‡å’Œè¿™ä¸ªæ•°ç›¸åŠ å¦‚æœå¤§äº target é‚£è‚¯å®šæ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ï¼Œå¯ä»¥ç›´æ¥æ’é™¤  // æ—¶é—´å¤æ‚åº¦ä¾æ—§æ˜¯ O(n^2)  var twoSum = function(numbers, target) { let len = numbers.length // è¿‡æ»¤æ‰ä¸åˆæ³•çš„å€¼ï¼Œæ¯”å¦‚ï¼š\u0026gt; target  let n = -1, min = numbers[0] for (let i = 1; i \u0026lt; len; i++) { if (numbers[i] + min \u0026gt; target) { n = i break } } if (n \u0026gt; -1) { numbers = numbers.slice(0, n) } return base(numbers, target) }     è¿™ç§ä¼˜åŒ–åªé’ˆå¯¹åé¢åˆå¤§é‡çš„æ¯” target å¤§çš„å€¼çš„å…ƒç´ æƒ…å†µï¼Œå¦åˆ™å‡ ä¹æ²¡ä»»ä½•æ”¹å–„ã€‚\n æ‰§è¡Œç”¨æ—¶ï¼š200 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 23.08%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š37.9 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 200 ms 37.9 MB Javascript      æ–¹æ¡ˆäºŒ: æ’é™¤ + äºŒåˆ†(O(n2), O(1))   ä¼˜åŒ–åçš„ä»£ç ï¼Œä¾æ—§éœ€è¦æ‰¾å‡º midIdxï¼Œç»è¿‡ä¸¤æ¬¡å¾ªç¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n2)ï¼Œè¿‡ç¨‹ä¸­ä¸éœ€è¦å¼€è¾Ÿæ–°çš„æ•°ç»„ï¼Œå®Œå…¨æ˜¯åœ¨ç´¢å¼•ä¸Šè¿›è¡Œæ“ä½œçš„ï¼Œå› æ­¤ç©º é—´å¤æ‚åº¦æ˜¯ O(1)\n  è¿™ä¸ªæ–¹æ¡ˆæ˜¯åŸºäºæ–¹æ¡ˆä¸€å®ç°ï¼Œåœ¨å®ƒçš„åŸºç¡€ä¸Šå°†æ•°ç»„äºŒåˆ†ä¹‹ååšåŠ æ³•æ¯” è¾ƒï¼Œå› ä¸ºéå†çš„æ˜¯æœ‰åºæ•°ç»„ï¼Œåœ¨æ’é™¤ä¸åˆæ³•çš„å€¼ä¹‹å(`min + max \u0026gt; target`çš„æœ€å¤§å€¼)æœ‰æ•ˆ æ•°å­—çš„ç´¢å¼•æ˜¯ä¸ä¼šå‘ç”Ÿæ”¹å˜çš„ã€‚\n è¿™ä¸ªæ–¹æ¡ˆçš„é‡ç‚¹åœ¨äºäºŒåˆ†ï¼Œå‡å°‘éå†çš„æ¬¡æ•°ï¼Œæœ€åçš„æƒ…å†µæ˜¯æ’é™¤çš„æ—¶ å€™æ²¡ä»»ä½•å˜åŒ–ï¼Œå³æ•°ç»„å…ƒç´ éƒ½æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œä¸”è¾ƒå°å€¼åœ¨å·¦ä¾§æœ«å°¾ï¼Œè¾ƒå¤§å€¼ä¹Ÿåœ¨å·¦ä¾§æœ«å°¾ï¼Œè¿™ æ ·ä¼šå¯¼è‡´åŒå±‚éå†éƒ½éœ€è¦èµ°å®Œæ‰èƒ½æ‰¾åˆ°æœ‰æ•ˆä¸¤ä¸ªå€¼ã€‚\n æ¯”å¦‚ï¼š[-1, 2, 3, 10, 12, 13] -\u0026gt; 16 ç»è¿‡ä¸¤æ­¥\n  æ’é™¤è¾ƒå¤§å€¼æ— å˜åŒ–\n  äºŒåˆ†æ•°ç»„æˆ: `[-1, 2, 3]` å’Œ `[10, 12, 13]` å³è¦æ‰¾åˆ° 3 + 13 = 16 å°±å¾—å°†ä¸¤ä¸ªæ•°ç»„éå†åˆ°æœ€å(3x3=9 æ¬¡)ã€‚\n  *å†™åˆ°è¿™é‡Œä¼šå‘ç°å…¶å®æ¯æ¬¡éå†å¹¶ä¸éœ€è¦éƒ½éå†å®Œï¼Œè€ƒè™‘ä¸‹å°†å³è¾¹æ•°å­—å€’åºéå†ï¼Œé‚£ä¹ˆå°±ä¼š æœ‰å¦‚æœ leftval + rightval \u0026lt; target çš„æ—¶å€™é‚£ä¹ˆå®ƒä¹‹åçš„æ•°éƒ½ä¸å¯èƒ½ç­‰äº target ä¾¿å¯ ä»¥é€€å‡ºæœ¬æ¬¡å¾ªç¯ï¼Œå‡å°‘æ¯”è¾ƒæ¬¡æ•°ã€‚*\n æ¯”å¦‚ï¼š left = -1, right = 13 ç›¸åŠ  \u0026lt; 16 é‚£ä¹ˆ -1 + 12/10/â€¦ éƒ½ä¸å¯èƒ½ç­‰äº target å› æ­¤å¯ä»¥ç›´æ¥æ’é™¤æ‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  // å–ä¸­é—´å€¼ï¼Œç„¶åæœç´¢å·¦å€¼å’Œå³å€¼ï¼Œéœ€è¦å¼€è¾Ÿ ä¸¤ä¸ªæ•°ç»„ç©ºé—´æ€»å¤§å°æœ€å¤§ä¸º numbers.length  var twoSum = function (numbers, target) { numbers = filterLarger(numbers, target) const len = numbers.length const min = numbers[0], max = numbers[len - 1] // ç›®æ ‡çš„ä¸­é—´å€¼ä½œä¸ºåŸºå‡†ï¼Œåˆ†å‰²å‡ºå·¦å³å°-å¤§ä¸¤ä¸ªæ•°ç»„å…ƒç´ åŒº  const mid = Math.floor(target / 2) let midIdx = -1 // æ‰¾å‡ºå¤§å€¼èµ·å§‹ç´¢å¼•  for (let i = 0; i \u0026lt; len; i++) { const val = numbers[i] if (val \u0026gt; mid) { midIdx = i break } else if (val === mid) { midIdx = i + 1 break } } //console.log({ mid, midIdx }, numbers)  // å¦‚æœ midIdx === -1 è¯´æ˜æœ‰ä¸¤ç§æƒ…å†µï¼š  // 1. ä½™ä¸‹çš„å…ƒç´ éƒ½æ˜¯æ¯” mid å°çš„æ•°ï¼Œè¿™ç§æƒ…å†µå°±ä¸ä¼šå­˜åœ¨ä¸¤ä¸ªæ•°ç›¸åŠ ç­‰äº target  // 2. ä½™ä¸‹çš„å…ƒç´ éƒ½æ˜¯ç­‰äº mid çš„æ•°ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½æ€§åªæœ‰ mid ä¸º 0æƒ…å†µ  if (midIdx === -1) { if (target === 0) { // q2  // è¿™ç§æƒ…å†µåªè¦æ‰¾å‡ºä¸¤ä¸ªå€¼ä¸º 0 çš„å…ƒç´ ç´¢å¼•  let res = [] for (let i = 0; i \u0026lt; len; i++) { if (res.length \u0026lt; 2) { numbers[i] === 0 \u0026amp;\u0026amp; res.push(i + 1) } if (res.length === 2) { return res } } } else { // q1  return -1 } } // åˆ°è¿™é‡Œè¯´æ˜ midIdx \u0026gt; -1ï¼Œä¸¤è¾¹éƒ½æœ‰å€¼ä¸”ä¸€å¤§ä¸€å°  let count = 0 for (let i = 0; i \u0026lt; midIdx; i++) { // è¾ƒå°æ•°  for (let j = midIdx; j \u0026lt; len; j++) { ++count // è¾ƒå¤§æ•°  if (numbers[i] + numbers[j] === target) { console.log(count, \u0026#34;two sum 1\u0026#34;) return [i + 1, j + 1] } } } return -1 }     ä¸Šé¢ç¤ºä¾‹æäº¤ç»“æœï¼š æ‰§è¡Œç”¨æ—¶ï¼š96 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 28.05%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38.3 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä½¿ç¬¬äºŒä¸ª for å€’åºéå†ï¼Œå‡å°‘éå†æ¬¡æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69  // å–ä¸­é—´å€¼ï¼Œç„¶åæœç´¢å·¦å€¼å’Œå³å€¼ï¼Œéœ€è¦å¼€è¾Ÿ ä¸¤ä¸ªæ•°ç»„ç©ºé—´æ€»å¤§å°æœ€å¤§ä¸º numbers.length  var twoSum2 = function (numbers, target) { numbers = filterLarger(numbers, target) const len = numbers.length const min = numbers[0], max = numbers[len - 1] // ç›®æ ‡çš„ä¸­é—´å€¼ä½œä¸ºåŸºå‡†ï¼Œåˆ†å‰²å‡ºå·¦å³å°-å¤§ä¸¤ä¸ªæ•°ç»„å…ƒç´ åŒº  const mid = Math.floor(target / 2) let midIdx = -1 // æ‰¾å‡ºå¤§å€¼èµ·å§‹ç´¢å¼•  for (let i = 0; i \u0026lt; len; i++) { const val = numbers[i] if (val \u0026gt; mid) { midIdx = i break } else if (val === mid) { midIdx = i + 1 break } } //console.log({ mid, midIdx }, numbers)  // å¦‚æœ midIdx === -1 è¯´æ˜æœ‰ä¸¤ç§æƒ…å†µï¼š  // 1. ä½™ä¸‹çš„å…ƒç´ éƒ½æ˜¯æ¯” mid å°çš„æ•°ï¼Œè¿™ç§æƒ…å†µå°±ä¸ä¼šå­˜åœ¨ä¸¤ä¸ªæ•°ç›¸åŠ ç­‰äº target  // 2. ä½™ä¸‹çš„å…ƒç´ éƒ½æ˜¯ç­‰äº mid çš„æ•°ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½æ€§åªæœ‰ mid ä¸º 0æƒ…å†µ  if (midIdx === -1) { if (target === 0) { // q2  // è¿™ç§æƒ…å†µåªè¦æ‰¾å‡ºä¸¤ä¸ªå€¼ä¸º 0 çš„å…ƒç´ ç´¢å¼•  let res = [] for (let i = 0; i \u0026lt; len; i++) { if (res.length \u0026lt; 2) { numbers[i] === 0 \u0026amp;\u0026amp; res.push(i + 1) } if (res.length === 2) { return res } } } else { // q1  return -1 } } // åˆ°è¿™é‡Œè¯´æ˜ midIdx \u0026gt; -1ï¼Œä¸¤è¾¹éƒ½æœ‰å€¼ä¸”ä¸€å¤§ä¸€å°  let count = 0 for (let i = 0; i \u0026lt; midIdx; i++) { // è¾ƒå°æ•°  for (let j = len - 1; j \u0026gt;= midIdx; j--) { const lval = numbers[i], rval = numbers[j] ++count if (lval + rval \u0026lt; target) { // ç›´æ¥é€€å‡º j å¾ªç¯  break } // è¾ƒå¤§æ•°  if (lval + rval === target) { console.log(count, \u0026#34;two sum 2\u0026#34;) return [i + 1, j + 1] } } } return -1 }     æµ‹è¯•ï¼š\nconsole.log(twoSum([-1, 2, 3, 10, 12, 13], 16), \u0026#34;result1\u0026#34;) console.log(twoSum2([-1, 2, 3, 10, 12, 13], 16), \u0026#34;result2\u0026#34;) // è¾“å‡ºç»“æœ: âœ algo git:(master) âœ— node test.js node test.js 9 two sum 1 [ 3, 6 ] result1 3 two sum 2 [ 3, 6 ] result2 âœ algo git:(master) âœ—   ä»ä¸Šç»“æœçœ‹å‡ºï¼Œä¼˜åŒ–ä¹‹å‰ count = 9ï¼Œä¼˜åŒ–ä¹‹å count = 3ï¼Œå¾ˆæ˜æ˜¾å¤§å¤§å‡å°‘äº†éå†æ¬¡æ•°ã€‚\n æäº¤ç»“æœ 1 ï¼š\n æ‰§è¡Œç”¨æ—¶ï¼š96 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 28.05%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38.1 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n æäº¤ç»“æœ 2 ï¼š\n æ‰§è¡Œç”¨æ—¶ï¼š76 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 51.90%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38.1 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n æäº¤å¤šæ¬¡åçš„ç»“æœ ï¼š\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 76 ms 38.5 MB Javascript   å‡ ç§’å‰ é€šè¿‡ 92 ms 38.1 MB Javascript   1 åˆ†é’Ÿå‰ é€šè¿‡ 76 ms 38.1 MB Javascript   1 åˆ†é’Ÿå‰ é€šè¿‡ 96 ms 38.1 MB Javascript   26 åˆ†é’Ÿå‰ é€šè¿‡ 96 ms 38.3 MB Javascript     PSï¼šç»“æœå¥½åƒå¹¶æ²¡ä»€ä¹ˆæ”¹å–„ï¼Œä½¿ç”¨åŒå±‚å¾ªç¯å§‹ç»ˆä¸å®Œç¾ï¼Œèƒ½å¦åªæ˜¯ç”¨ä¸€ä¸ªå±‚å¾ªç¯å°±èƒ½è§£å†³é—®é¢˜å‘¢ï¼Ÿï¼Ÿï¼Ÿ\n  æ–¹æ¡ˆä¸‰ï¼šè®¡ç®—ï¼Œå­˜å‚¨å·®å€¼æ–¹å¼(O(n), O(n))  å·®å€¼è®¡ç®—åŸç†\n  ç¼“å­˜ä¸æ»¡è¶³æ¡ä»¶çš„å€¼(ä½œä¸ºç´¢å¼•)ï¼Œå…¶ç´¢å¼•ä½œä¸ºå€¼ï¼Œç”¨æ¥å¾…æŸ¥è¯¢\n  ä½¿ç”¨æ’å€¼ä½œä¸ºç´¢å¼•å»å–å€¼ï¼Œèƒ½å–åˆ°è¯´æ˜è¿™ä¸ªå€¼è¢«éå†ä¸”è¢«å­˜å‚¨å»ï¼Œå±äºæœ‰ æ•ˆå€¼ï¼Œæœ€ç»ˆè¿”å›å…¶ä½œä¸ºç´¢å¼•å¯¹åº”çš„å€¼(å³å®ƒçš„ç´¢å¼•å€¼)ï¼Œå’Œå½“å‰çš„å€¼ç´¢å¼•ï¼Œå³ æœ€åæ»¡è¶³æ¡ä»¶çš„ä¸¤ä¸ªå€¼çš„ç´¢å¼•\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  var twoSum = function (numbers, target) { // è¿™é‡Œå¯ä»¥å·¦ä¸€å±‚è¿‡æ»¤ï¼Œè¿‡æ»¤æ‰éæ³•çš„å€¼  // numbers = filterLarger(numbers, target)  const deltas = [] const len = numbers.length for (let i = 0; i \u0026lt; len; i++) { const val = numbers[i] // è®°å½•å½“å‰çš„å€¼  const delta = target - numbers[i] // è®¡ç®—å·®å€¼  if (deltas[delta] !== void 0) { // è¿›å…¥è¿™é‡Œè¯´æ˜å½“å‰å€¼çš„å·®å€¼åœ¨ deltas ä¸­å­˜åœ¨è¿‡  return [deltas[delta] + 1, i + 1] } // ä¿å­˜å½“å‰å€¼å’Œå®ƒçš„ç´¢å¼•  // è¿™é‡Œä¿å­˜çš„ç›®çš„æ˜¯ä¸ºäº†ä½¿ç”¨ä¸Šé¢çš„ delta èµ°ä½ç´¢å¼•æ¥æ‰¾å·®å€¼  // åˆ°è¿™é‡Œè¯´æ˜å¹¶æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å·®å€¼  deltas[val] = i } //console.log(deltas, \u0026#34;0\u0026#34;)  return -1 }     ä½¿ç”¨æ•°ç»„å­˜å‚¨éå†è¿‡å¾…æ¯”è¾ƒçš„å€¼ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœè¿™äº›å€¼å¾ˆå¤§çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªé•¿åº¦å¾ˆå¤§çš„é‡Œé¢æœ‰å¾ˆå¤šç©ºç½®çš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«å¾ˆå¤šæ— æ„ä¹‰å…ƒç´ çš„æ•°ç»„ï¼Œåœ¨æŸç§æƒ…å†µä¸‹å¯¹æµªè´¹å·¨å¤§çš„å†…å­˜ã€‚ ææ¸…æ¥šæˆ‘ä»¬è¦å­˜å‚¨çš„å†…å®¹ï¼Œå…¶å®æœ€ä¸»è¦çš„æ˜¯æ»¡è¶³æ¡ä»¶çš„ä¸¤ä¸ªå€¼çš„ç´¢å¼•ï¼Œè€Œåˆéœ€è¦å¾ˆæ–¹ä¾¿çš„æ‰¾åˆ°è¿™ä¸ªå€¼ï¼Œå…¶å®å¯ä»¥è€ƒè™‘ä½¿ç”¨ `Map` æ¥å®ç°ã€‚ \n æ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // æ’å€¼ + map å‡å°‘ç©ºé—´æµªè´¹  var twoSum = function (numbers, target) { // å¯ä»¥è¿‡æ»¤ä¸€å±‚ä¸åˆæ³•å€¼  // numbers = filterLarger(numbers, target)  const deltas = new Map() const len = numbers.length for (let i = 0; i \u0026lt; len; i++) { const val = numbers[i] const delta = target - numbers[i] if (deltas.has(delta)) { return [deltas.get(delta) + 1, i + 1] } // ä¿å­˜å½“å‰å€¼å’Œå®ƒçš„ç´¢å¼•  deltas.set(val, i) } // console.log(deltas, \u0026#34;0\u0026#34;)  return -1 }     æ‰§è¡Œç»“æœï¼šå¥½åƒä¹Ÿä¸æ€ä¹ˆç†æƒ³\n æ‰§è¡Œç”¨æ—¶ï¼š84 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 36.05%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38.1 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 84 ms 38.1 MB Javascript   1 åˆ†é’Ÿå‰ é€šè¿‡ 92 ms 38.1 MB Javascript      æ–¹æ¡ˆå››: å¯¹æ’åŒæŒ‡é’ˆ   è¿™ç§æ–¹æ¡ˆæ˜¯åœ¨ leetcode è§£é¢˜ç­”æ¡ˆä¸­çœ‹åˆ°çš„ï¼Œè¿™ä½ä½œè€…è¯´æ˜¯å‡»è´¥ 80%ï¼Œä½†å®é™…æˆ‘è¯•è¿‡å‡ æ¬¡ç»“æœå…¶å®å¹¶ä¸ç†æƒ³ï¼Œ\n æ‰§è¡Œç”¨æ—¶ï¼š92 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 29.67%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š37.9 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n ä¸Šä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // å¯¹æ’åŒæŒ‡é’ˆ  var twoSum = function (numbers, target) { let i = 0, j = numbers.length - 1 let lval = -1, rval = -1 while (i \u0026lt; j) { ;(lval = numbers[i]), (rval = numbers[j]) if (lval + rval \u0026lt; target) { i++ } else if (lval + rval \u0026gt; target) { j-- } else { return [i + 1, j + 1] } } return -1 }     è¿™ç§æ–¹æ¡ˆè¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œå› ä¸ºæ˜¯æœ‰åºæ•°ç»„ï¼Œæ‰€ä»¥ï¼š\n  åªè¦ä¸¤ä¸ªæ•°å°äº target è¯´æ˜éœ€è¦å¢åŠ å€¼å¤§å°ï¼Œç”±äº j æ˜¯ä»æœ€å³è¾¹å¼€å§‹æ²¡æœ‰å¯åŠ ç©º é—´äº†ï¼Œé‚£ä¹ˆåªèƒ½ i++ å–æ–°çš„æ›´å¤§çš„å€¼å»å¼¥è¡¥ç©ºç¼ºã€‚\n  åªè¦ä¸¤ä¸ªæ•°å¤§äº target è¯´æ˜éœ€è¦å‡å°å’Œçš„å€¼ï¼Œä½†ç”±äºåœ¨æ­¤æ—¶å·¦è¾¹çš„å€¼ä¹Ÿæ²¡å‡å°çš„ ç©ºé—´äº†ï¼Œå› æ­¤åªèƒ½ jâ€“ å–æ–°çš„æ›´å°çš„å€¼å»å‰”é™¤å¤šä½™çš„å€¼\n  è¿™ç§æ–¹æ¡ˆï¼Œä¸éœ€è¦å¦å¼€è¾Ÿç©ºé—´ï¼Œwhile é‡Œé¢æ˜¯ logn æ˜¯å› ä¸ºå°†ç¬¬ä¸€ä¸ªæ•°å³è¾¹çš„æ‰€æœ‰æ•°é€šè¿‡ä¸æ–­äºŒåˆ†æ’é™¤å·¦è¾¹æˆ–å³è¾¹ä¸€ç³»åˆ—ä¸åˆæ³•çš„å€¼ã€‚\n å®æµ‹ç»“æœï¼š\n æ‰§è¡Œç”¨æ—¶ï¼š80 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 41.01%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 10.00%çš„ç”¨æˆ·\n  äºŒåˆ†æŸ¥æ‰¾(O(nlogn), O(1)) leetcode  å…ˆç”¨ç¬¬ä¸€å±‚çš„ for å›ºå®šç¬¬ä¸€ä¸ªæ•°ï¼Œç„¶ååœ¨ for é‡Œé¢ä½¿ç”¨ while äºŒåˆ†æŸ¥æ‰¾ç¬¬äºŒä¸ªæ•°ï¼Œ ç¬¬ä¸€ä¸ª for æ˜¯ O(n) ç¬¬äºŒä¸ª while æ˜¯ logn å› æ­¤æœ€åçš„æ—¶é—´å¤æ‚åº¦æ˜¯ (O(nlogn))ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  // äºŒåˆ†æ³•[å®˜æ–¹]  var twoSum = function (numbers, target) { let len = numbers.length for (let i = 0; i \u0026lt; len; i++) { const first = numbers[i] let left = 0, right = len - 1 while (left \u0026lt;= right) { // å–ä¸­é—´çš„é‚£ä¸ªç´¢å¼•å€¼  const mid = Math.ceil((right - left) / 2) + left const val = numbers[mid], delta = target - first if (val === delta) { return [i + 1, mid + 1] } else if (val \u0026gt; delta) { // å¦‚æœå€¼å¤§äº†ï¼Œæ’é™¤ mid å³è¾¹çš„æ‰€æœ‰å…ƒç´ å€¼  right = mid - 1 } else { // å¦‚æœå°äº†ï¼Œæ’é™¤ mid å·¦è¾¹çš„æ‰€æœ‰å…ƒç´ å€¼  left = mid + 1 } } } return -1 }      å¯¹æ’åŒæŒ‡é’ˆæ³•(O(n), O(1)) leetcode  å¦‚ï¼šæ–¹æ¡ˆå››ï¼Œé‡‡ç”¨ä¸¤ç«¯æŒ‡é’ˆåˆ†åˆ«å³ç§»å’Œå·¦ç§»æ–¹å¼æ¥å®šä½å”¯ä¸€è§£ï¼Œ è¿™ç§æ–¹æ¡ˆåœ¨ä½ç§»è¿‡ç¨‹ä¸­ä¸ä¼šå‡ºç°è¿‡æ»¤æ‰å”¯ä¸€è§£çš„æƒ…å†µï¼Œå› ä¸ºå¤´ç«¯å³ç§»çš„å‰ææ˜¯ value \u0026lt; targetï¼Œéœ€è¦è¡¥å€¼(å°±ç®—å°¾ç«¯å…ˆè¾¾åˆ°æ¡ä»¶ï¼Œåªè¦å€¼å°å°¾ç«¯å°±ä¸ä¼šå‘ç”Ÿä½ç§»)ï¼Œå°¾ç«¯å·¦ç§»å‰ ææ˜¯ value \u0026gt; target ï¼Œéœ€è¦å‡å€¼(å°±ç®—å¤´ç«¯å…ˆè¾¾åˆ°æ¡ä»¶ï¼Œåªè¦å€¼å¤§å°¾ç«¯å°±ä¸ä¼šå‘ç”Ÿä½ ç§»)ï¼Œå› æ­¤ä¿è¯äº†å·¦å³ä¸¤ç«¯ä»»ä¸€ä¸€ç«¯å…ˆè¾¾åˆ°ç¬¦åˆæ¡ä»¶çš„å€¼è¯¥å€¼éƒ½ä¸ä¼šè¢«è¿‡æ»¤æ‰ï¼Œä»è€Œå½“ ä¸¤ç«¯å€¼éƒ½æ»¡è¶³æ¡ä»¶çš„æ—¶å€™é€€å‡ºå¾ªç¯ã€‚\n    03. å‰‘æŒ‡ Offer 11. æ—‹è½¬æ•°ç»„çš„æœ€å°æ•°å­—æ¯æ—¥  æ–¹æ¡ˆä¸€ï¼šfor å¾ªç¯ç›´æ¥éå†æŸ¥æ‰¾(O(n), O(1))  æ˜ç¡®é—®é¢˜å«ä¹‰ä¹‹åï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯é€šè¿‡éå†æ‰¾åˆ°æ¯”å‰é¢æ›´å°çš„æ•°å³å¯ã€‚\n é—®é¢˜?ï¼šæ—¢ç„¶ target å‰é¢çš„æ•°éƒ½æ˜¯å‡åºåˆ—è¡¨ï¼Œè¯´æ˜æˆ‘ä»¬åªè¦æ¯”è¾ƒç›®æ ‡ å€¼å’Œæ•°ç»„ç¬¬ä¸€ä¸ªæ•°å°±å¯ä»¥äº†ï¼Œç¬¬ä¸€ä¸ªæ•°åˆ°ç›®æ ‡å€¼ä¹‹é—´çš„æ•°çš„æ¯”è¾ƒå…¶å®éƒ½æ˜¯å¤šä½™çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  /** ,* @param {number[]} numbers ,* @return {number} ,*/ var minArray = function(numbers) { let min = numbers[0], len = numbers.length if (len === 0) return -1 if (len \u0026lt; 2) return min for (let i = 1; i \u0026lt; len; i++) { let val = numbers[i] if (val \u0026lt; min) { return val } } return min };     ç»“æœï¼š\n æ‰§è¡Œç”¨æ—¶ï¼š92 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 12.99%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 100.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 92 ms 38 MB Javascript      æ–¹æ¡ˆäºŒ leetcode ï¼šäºŒåˆ†æ³•(O(logn))  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  // äºŒåˆ†æ³•  var minArray = function (numbers) { let len = numbers.length, i = 0, j = len - 1 if (len === 0) return -1 if (len === 1) return numbers[0] if (numbers[0] \u0026gt; numbers[1]) return numbers[1] while ( i \u0026lt; j) { let lVal = numbers[i], rVal = numbers[j] let mid = Math.floor((j - i) / 2) + i, midVal = numbers[mid] // ä¸­é—´å€¼æ¯”å³è¾¹çš„å€¼å¤§ï¼Œè¯´æ˜åœ¨æ—‹è½¬çš„æ•°ç»„èŒƒå›´å†…ï¼Œå·¦ä¾§æŒ‡é’ˆå³ç§»  if (midVal \u0026gt; rVal) { i = mid + 1 } else if (midVal \u0026lt; rVal) { // ä¸­é—´å€¼æ¯”å³è¾¹å€¼å°ï¼Œè¯´æ˜åœ¨éæ—‹è½¬æ•°ç»„èŒƒå›´å†…ï¼Œå³ä¾§æŒ‡é’ˆå·¦ç§»  // ä½†æ˜¯ä¸ºäº†ä¸è¿‡æ»¤æ‰ç›®æ ‡å€¼ï¼Œè¿™é‡Œä¸èƒ½ mid - 1ï¼Œå› ä¸ºæˆ‘è¦æ‰¾çš„å€¼  // è‚¯å®šæ˜¯åœ¨éæ—‹è½¬çš„æ•°ç»„èŒƒå›´å†…çš„  j = mid } else { // è¿™é‡ŒæŒ‡é’ˆä¸€æ­¥ä¸€æ­¥å·¦ç§»ï¼Œæ˜¯ä¸ºäº†åº”å¯¹ç›¸åŒå€¼çš„æƒ…å†µï¼Œå³ midVal === rVal çš„æ—¶å€™  // è¿™é‡Œä¸ºä½•ä¸éœ€è¦è€ƒè™‘ i++ çš„æƒ…å†µ???  // ----\u0026gt; å› ä¸ºlowæŒ‡é’ˆå³ç§»çš„å‰ææ˜¯ midVal \u0026gt; rValï¼Œå³æ­¤æ—¶çš„ midVal ä¸€å®šæ˜¯åœ¨  // æ—‹è½¬æ•°ç»„èŒƒå›´å†…ï¼Œåªè¦è¿›è¡Œ mid + 1 å°†å·¦ä¾§çš„å€¼å…¨éƒ¨è¿‡æ»¤æ‰ï¼Œå°±ç®—æœ‰ç›¸åŒçš„å€¼ï¼Œé‚£ä¸€å®š  // éƒ½è¿˜æ˜¯åœ¨æ—‹è½¬æ•°ç»„èŒƒå›´å†…ï¼Œå› æ­¤ç›´æ¥è¿‡æ»¤å³å¯ã€‚  j-- } } // æœ€åå¾ªç¯ç»“æŸçš„æ—¶å€™ï¼Œè‚¯å®šå°±æ˜¯æœ€å°å€¼çš„ä½ç½®  return numbers[i] }     æ‰§è¡Œç”¨æ—¶ï¼š112 ms, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 6.90%çš„ç”¨æˆ·\n å†…å­˜æ¶ˆè€—ï¼š38.1 MB, åœ¨æ‰€æœ‰ JavaScript æäº¤ä¸­å‡»è´¥äº† 100.00%çš„ç”¨æˆ·\n   æäº¤æ—¶é—´ æäº¤ç»“æœ è¿è¡Œæ—¶é—´ å†…å­˜æ¶ˆè€— è¯­è¨€     å‡ ç§’å‰ é€šè¿‡ 112 ms 38.1 MB Javascript        04. ä¸¤æ•°ä¹‹å’Œ   ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªç›®æ ‡å€¼ targetï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡ºå’Œä¸ºç›®æ ‡å€¼çš„é‚£ ä¸¤ä¸ª æ•´æ•°ï¼Œå¹¶è¿”å›ä»–ä»¬çš„æ•°ç»„ä¸‹æ ‡ã€‚\n ä½ å¯ä»¥å‡è®¾æ¯ç§è¾“å…¥åªä¼šå¯¹åº”ä¸€ä¸ªç­”æ¡ˆã€‚ä½†æ˜¯ï¼Œæ•°ç»„ä¸­åŒä¸€ä¸ªå…ƒç´ ä¸èƒ½ä½¿ç”¨ä¸¤éã€‚\n è¿™ä¸€é¢˜å’Œ 02. ä¸¤æ•°ä¹‹å’Œ II - è¾“å…¥æœ‰åºæ•°ç»„ è§£æ³•ç›¸å·®ä¸å¤§ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ 02 ä¸­æ˜¯è¾“å…¥çš„æœ‰åºæ•°ç»„ï¼Œè¿™é‡Œçš„æ•°ç»„é¡ºåºæ˜¯æœªçŸ¥çš„ï¼Œå¯èƒ½æœ‰åºå¯èƒ½ä¹±åºã€‚\n å› æ­¤è§£æ³•ä¸Šçš„å·®å¼‚ä» 4 ä¸ªæ–¹æ¡ˆ+ä¸¤ä¸ªå®˜æ–¹æ–¹æ¡ˆæ¥åˆ†æçš„è¯ä¼šæœ‰å¦‚ä¸‹ç»“æœï¼š\n  æ–¹æ¡ˆä¸€ ä¸¤ä¸ª for å¾ªç¯ï¼Œä¸éœ€è¦æ”¹åŠ¨å•¥ï¼Œæš´åŠ›è§£æ³•ä¸åœ¨ä¹æ˜¯å¦æœ‰åº\n  æ–¹æ¡ˆäºŒ äºŒåˆ†æ³•ï¼Œä¼šæ ¹æ®æœ‰åºæ•°ç»„è¿›è¡Œæ’é™¤ï¼Œå› æ­¤åœ¨è¿™é‡Œä¸é€‚ç”¨ï¼Œä½†äºŒåˆ†æ³•ä¾æ—§æœ‰ç”¨\n  æ–¹æ¡ˆä¸‰ å·®å€¼æ³•ï¼Œä¾æ—§é€‚ç”¨ï¼Œè¯¥æ–¹æ¡ˆä¸åŒºåˆ†æ˜¯å¦æœ‰åº\n  æ–¹æ¡ˆå›› å¯¹æ’æ³•ï¼Œä¾æ—§é€‚ç”¨\n  â€¦ å®˜æ–¹æ–¹æ¡ˆäºŒåˆ†æŸ¥æ‰¾é‡‡ç”¨äº†æœ‰åºæ•°ç»„è¿‡æ»¤ç±»ä¼¼æ–¹æ¡ˆäºŒï¼Œå¯¹æ’æ³•å°±æ˜¯æ–¹æ¡ˆä¸‰ã€‚\n    ","permalink":"https://www.cheng92.com/algo/algo-leetcode-array-01/","tags":["algorithm,","leetcode,","programming,","javascript,","array"],"title":"Algorithm On Leetcode\u003cArray\u003e 1 (Easy Level)"},{"categories":["vue"],"contents":"  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚  \n  --  insertCssLink(\"https://unpkg.com/element-plus/lib/theme-chalk/index.css\");    TODO ShapeFlags çš„æº¯æºå’Œç”¨é€”ï¼Ÿ  æ¶‰åŠæ¨¡å—ï¼š runtime-core\n  æ ‡ç­¾(ç»„ä»¶)ç§ç±»(element, component, slot, template)   æ ‡ç­¾è§£ææ—¶çš„ TagType æ£€æµ‹\n  elementï¼ŒåŸç”Ÿæ ‡ç­¾ç±»å‹ï¼Œé»˜è®¤å€¼(å¦‚ï¼š div ï¼Œç»“åˆ options.isNativeTag())\n  component ç±»å‹\n  !options.isNativeTag() ç±»å‹\n  æœ‰ v-is æŒ‡ä»¤çš„\n  core component ç±»å‹çš„([Teleport, Suspense, KeepAlive BaseTransition])\n  options.isBuiltInComponent() æŒ‡å®šçš„ç±»å‹\n  å¤§å†™å­—æ¯å¼€å¤´çš„æ ‡ç­¾(å¦‚ï¼š \u0026lt;Comp\u0026gt;\u0026lt;/Comp\u0026gt;)\n  æ ‡ç­¾åç›´æ¥æ˜¯ component çš„(\u0026lt;component\u0026gt;\u0026lt;/component\u0026gt;)\n    slot ç±»å‹\n  template ç±»å‹\n  è¿™äº›ç±»å‹çš„å®šä¹‰å’Œè§£æå‡åœ¨ parseTag(context, type, parent) å‡½æ•°ä¸­å®Œæˆ\n æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  function parseTag( context: ParserContext, type: TagType, parent: ElementNode | undefined ): ElementNode { // ...çœç•¥ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹‹å…³ç³» tagType  let tagType = ElementTypes.ELEMENT const options = context.options if (!context.inVPre \u0026amp;\u0026amp; !options.isCustomElement(tag)) { const hasVIs = props.some( p =\u0026gt; p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; p.name === \u0026#39;is\u0026#39; ) if (options.isNativeTag \u0026amp;\u0026amp; !hasVIs) { // 1. å¦‚æœéåŸç”Ÿ(isNativeTag èŒƒç•´å†…çš„)ï¼Œè§†ä¸ºç»„ä»¶ç±»å‹ï¼Œä¼˜å…ˆçº§æœ€é«˜  if (!options.isNativeTag(tag)) tagType = ElementTypes.COMPONENT } else if ( // 2. æœ‰ v-is æŒ‡ä»¤çš„ç›´æ¥è§†ä¸ºç»„ä»¶ç±»å‹  hasVIs || // 3. vue å†…ç½®çš„æ ¸å¿ƒç»„ä»¶\u0026lt;Teleport, Suspense, KeepAlive BaseTransition\u0026gt;  isCoreComponent(tag) || // 4. å†…ç½®ç»„ä»¶ï¼Œç”±å¼€å‘è€…å®šä¹‰çš„å†…ç½®ç±»å‹ï¼Ÿ  (options.isBuiltInComponent \u0026amp;\u0026amp; options.isBuiltInComponent(tag)) || // 5. æ ‡ç­¾åä»¥å¤§å†™å­—æ¯å¼€å¤´çš„è§†ä¸º ç»„ä»¶ç±»å‹  /^[A-Z]/.test(tag) || // 6. æ ‡ç­¾åç›´æ¥æ˜¯ component çš„  tag === \u0026#39;component\u0026#39; ) { tagType = ElementTypes.COMPONENT } if (tag === \u0026#39;slot\u0026#39;) { tagType = ElementTypes.SLOT } else if ( tag === \u0026#39;template\u0026#39; \u0026amp;\u0026amp; props.some(p =\u0026gt; { return ( p.type === NodeTypes.DIRECTIVE \u0026amp;\u0026amp; isSpecialTemplateDirective(p.name) ) }) ) { tagType = ElementTypes.TEMPLATE } } return { type: NodeTypes.ELEMENT, ns, tag, tagType, props, isSelfClosing, children: [], loc: getSelection(context, start), codegenNode: undefined // to be created during transform phase  } }      æŒ‡ä»¤è§£æè¿‡ç¨‹   parseChildren(context, mode, ancestors) -\u0026gt; parseElement(context, mode) -\u0026gt; è§£æå‡ºæ•´ä¸ª element parseTag(context, type, parent) -\u0026gt; è§£æå‡ºæ ‡ç­¾ parseAttributes(context, type) -\u0026gt; è§£ææ‰€æœ‰å±æ€§ parseAttribute(context, nameSet) -\u0026gt; è§£æå•ä¸ªå±æ€§ï¼Œç»“æœè¿”å›åˆ° props ä¸­\n è§£æçš„æ—¶å€™ä¼šæ ¹æ®æ˜ å°„å…³ç³»ï¼Œå°†ç¼©å†™è½¬æ¢æˆåç§°ã€‚\n å¦‚ï¼š\n   abbrev name     : bind   @ on   # slot     å¤„ç†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79  // function: parseAttribute(...)  // v-dir æˆ– ç¼©å†™  if (!context.inVPre \u0026amp;\u0026amp; /^(v-|:|@|#)/.test(name)) { // ?: éæ•è·ç»„  // 1. (?:^v-([a-z0-9]+))? -\u0026gt; åŒ¹é… v-dir æŒ‡ä»¤ï¼Œéè´ªå©ªåŒ¹é…ï¼Œæ•è·æŒ‡ä»¤å  // ç§°([a-z0=9]+)  // 2. (?:(?::|^@|^#)([^\\.]+))? -\u0026gt; åŒ¹é… :,@,#  // 3. (.+)?$ åŒ¹é…ä»»æ„å­—ç¬¦  const match = /(?:^v-([a-z0-9]+))?(?:(?::|^@|^#)([^\\.]+))?(.+)?$/i.exec( name ) let arg // ([a-z0-9]+), ([^\\.]+)  if (match[2]) { const startOffset = name.indexOf(match[2]) const loc = getSelection( context, getNewPosition(context, start, startOffset), getNewPosition(context, start, startOffset + match[2].length) ) let content = match[2] let isStatic = true // é™æ€å±æ€§å  // åŠ¨æ€å±æ€§åè§£æ  if (content.startsWith(\u0026#39;[\u0026#39;)) { isStatic = false if (!content.endsWith(\u0026#39;]\u0026#39;)) { // å¦‚æœæ˜¯åŠ¨æ€å±æ€§åï¼Œå¿…é¡»æ˜¯ [varName] å½¢å¼  emitError( context, ErrorCodes.X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END ) } content = content.substr(1, content.length - 2) } arg = { type: NodeTypes.SIMPLE_EXPRESSION, content, isStatic, isConstant: isStatic, loc } } // å±æ€§æ˜¯å¦è¢«å¼•å·åŒ…èµ·æ¥  if (value \u0026amp;\u0026amp; value.isQuoted) { const valueLoc = value.loc valueLoc.start.offset++ valueLoc.start.column++ valueLoc.end = advancePositionWithClone(valueLoc.start, value.content) // å–å¼•å·å†…çš„æ‰€æœ‰å†…å®¹  valueLoc.source = valueLoc.source.slice(1, -1) } return { type: NodeTypes.DIRECTIVE, // : -\u0026gt; v-bind, @ -\u0026gt; v-on, # -\u0026gt; v-slot çš„ç¼©å†™  name: match[1] || (name.startsWith(\u0026#39;:\u0026#39;) ? \u0026#39;bind\u0026#39; : name.startsWith(\u0026#39;@\u0026#39;) ? \u0026#39;on\u0026#39; : \u0026#39;slot\u0026#39;), exp: value \u0026amp;\u0026amp; { type: NodeTypes.SIMPLE_EXPRESSION, content: value.content, isStatic: false, isConstant: false, loc: value.loc }, arg, // ä¿®é¥°ç¬¦å¤„ç†, v-bind.m1.m2 -\u0026gt; .m1.m2 -\u0026gt; [\u0026#39;m1\u0026#39;, \u0026#39;m2\u0026#39;]  modifiers: match[3] ? match[3].substr[1].split(\u0026#39;.\u0026#39;) : [], loc } }     å±æ€§è§£æçš„é¡ºåºæ˜¯ï¼Œå…ˆè§£æå±æ€§å€¼ï¼Œç„¶åè§£ææŒ‡ä»¤åç§°(name)ï¼Œå‚æ•°(arg)ï¼Œä¿®é¥°ç¬¦(modifiers)ã€‚\n è¿™é‡Œæœ‰å®Œæ•´çš„è§£ææµç¨‹å›¾ï¼Œå¯ä»¥æ¸…æ™°å®Œæ•´çš„çŸ¥é“å±æ€§ï¼ŒæŒ‡ä»¤è§£ææ•´ä¸ªè¿‡ç¨‹ã€‚\n  RCDATA/CDATA ç±»å‹è§£æ   ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  const ast = baseParse(code, { getNamespace: (tag, parent) =\u0026gt; { const ns = parent ? parent.ns : Namespaces.HTML; if (ns === Namespaces.HTML) { // åœ¨ parseChildren while ä¸­å°†è¿›å…¥  // if (ns !== Namespaces.HTML) {  // node = parseCDATA(context, ancestors);  // }  if (tag === \u0026#34;svg\u0026#34;) { return Namespaces.HTML + 1; } } return ns; }, getTextMode: ({ tag }) =\u0026gt; { if (tag === \u0026#34;textarea\u0026#34;) { // RCDATA æ ‡ç­¾å†…çš„å†…å®¹ä¼šç›´æ¥è¿›å…¥ parsText å½“åšæ–‡æœ¬è§£æ  return TextModes.RCDATA; } if (tag === \u0026#34;script\u0026#34;) { return TextModes.RAWTEXT; } return TextModes.DATA; }, ...options, onError: spy, });     è¿™ä¸¤ç§ç±»å‹æ•°æ®çš„è§£æå…³é”®æœ‰å‡ ç‚¹(è¯¦æƒ…è¯·ç§»æ­¥ ğŸ›¬ğŸ›¬ğŸ›¬ )ï¼š\n  é‡å†™ getTextMode åœ¨é‡Œé¢å¯¹æœ‰éœ€è¦çš„ tag ç±»å‹æŒ‡å®šå…¶æ˜¯ä»€ä¹ˆ mode\n1 2 3 4 5 6 7 8 9 10  function parseElement(...) { // ...  const mode = context.options.getTextMode(element, parent); // RCDATA æ¨¡å¼ï¼Œå®ƒçš„å†…å®¹éƒ½ä¼šè¢«å½“åšæ–‡æœ¬æ¥å¤„ç†  // å¦‚ï¼š\u0026lt;textarea\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/textarea\u0026gt; ä¸­çš„ `\u0026lt;/div\u0026gt;` åªæ˜¯ä¸ªæ–‡æœ¬å†…å®¹  const children = parseChildren(context, mode, ancestors); // ...  }      é‡å†™ getNamespace å‘ŠçŸ¥ parseChildren èµ°å“ªä¸ªåˆ†æ”¯\n1 2 3 4 5 6 7 8  else if (s.startsWith(\u0026#34;\u0026lt;![CDATA[\u0026#34;)) { if (ns !== Namespaces.HTML) { node = parseCDATA(context, ancestors); } else { emitError(context, ErrorCodes.CDATA_IN_HTML_CONTENT); node = parseBogusComment(context); } }        ä¸€ä¸ªè¾ƒå®Œæ•´çš„ AST ç»“æ„ï¼š  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124  { \u0026#34;type\u0026#34;:0, // root èŠ‚ç‚¹  \u0026#34;children\u0026#34;:[ // èŠ‚ç‚¹çš„å­ç»„ä»¶åˆ—è¡¨  { \u0026#34;type\u0026#34;:1, // æ ‡ç­¾ div  \u0026#34;ns\u0026#34;:0, // html  \u0026#34;tag\u0026#34;:\u0026#34;div\u0026#34;, // æ ‡ç­¾å  \u0026#34;tagType\u0026#34;:0, // æ ‡ç­¾ç±»å‹ï¼šstart-0, end-1  \u0026#34;props\u0026#34;:[ // æ ‡ç­¾çš„å±æ€§åˆ—è¡¨ï¼Œå¦‚ï¼š v-bind:keyup.prevent.enter  { // å±æ€§æœ‰å‡ ä¸ªé‡è¦çš„å±æ€§ï¼š  // 1. name, æŒ‡ä»¤åç§°ï¼Œv- åŠç¼©å†™(#, @, :) ä¼šè½¬æ¢æˆå±æ€§åç§°ï¼Œå¦‚ï¼šbind  // 2. exp è¡¨è¾¾å¼å³=å·åè¾¹çš„å€¼ï¼Œ  // 3. arg å‚æ•°åï¼Œç»‘å®šçš„å˜é‡åï¼Œå¯èƒ½æ˜¯åŠ¨æ€çš„  // 4. ä¿®é¥°ç¬¦ï¼Œmodifiers  \u0026#34;type\u0026#34;:7, \u0026#34;name\u0026#34;:\u0026#34;bind\u0026#34;, \u0026#34;exp\u0026#34;:{ \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;ok\u0026#34;, // è¡¨è¾¾å¼å†…å®¹ï¼Œ  \u0026#34;isStatic\u0026#34;:false, \u0026#34;isConstant\u0026#34;:false, \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:34, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:33 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:36, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:35 }, \u0026#34;source\u0026#34;:\u0026#34;ok\u0026#34; } }, \u0026#34;arg\u0026#34;:{ // å‚æ•°ï¼Œç»‘å®šçš„äº‹ä»¶æˆ–å˜é‡  \u0026#34;type\u0026#34;:4, \u0026#34;content\u0026#34;:\u0026#34;keyup\u0026#34;, \u0026#34;isStatic\u0026#34;:true, // æ”¯æŒ v-bind:[varname] åŠ¨æ€å±æ€§  \u0026#34;isConstant\u0026#34;:true, \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:13, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:12 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:18, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:17 }, \u0026#34;source\u0026#34;:\u0026#34;keyup\u0026#34; } }, \u0026#34;modifiers\u0026#34;:[ \u0026#34;prevent\u0026#34;, \u0026#34;enter\u0026#34; ], \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:6, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:5 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:37, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:36 }, \u0026#34;source\u0026#34;:\u0026#34;v-bind:keyup.prevent.enter=\u0026#34;ok\u0026#34;\u0026#34; } } ], \u0026#34;isSelfClosing\u0026#34;:false, \u0026#34;children\u0026#34;:[ // å¦‚æœ \u0026lt;div\u0026gt;...\u0026lt;/div\u0026gt; è¿˜æœ‰å†…å®¹è¿™é‡Œä¼šé€’å½’è§£æå‡ºå­èŠ‚ç‚¹ ast  ], \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:1, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:0 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:44, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:43 }, \u0026#34;source\u0026#34;:\u0026#34;\u0026lt;div v-bind:keyup.prevent.enter=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#34; } } ], \u0026#34;loc\u0026#34;:{ \u0026#34;start\u0026#34;:{ \u0026#34;column\u0026#34;:1, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:0 }, \u0026#34;end\u0026#34;:{ \u0026#34;column\u0026#34;:44, \u0026#34;line\u0026#34;:1, \u0026#34;offset\u0026#34;:43 }, \u0026#34;source\u0026#34;:\u0026#34;\u0026lt;div v-bind:keyup.prevent.enter=\u0026#34;ok\u0026#34;\u0026gt;\u0026lt;/div\u0026gt;\u0026#34; }, \u0026#34;helpers\u0026#34;:[ ], \u0026#34;components\u0026#34;:[ ], \u0026#34;directives\u0026#34;:[ ], \u0026#34;hoists\u0026#34;:[ ], \u0026#34;imports\u0026#34;:[ ], \u0026#34;cached\u0026#34;:0, \u0026#34;temps\u0026#34;:0 }      è¾…åŠ©ä»£ç    è¿™ç« ä¸»è¦æ˜¯ä¸€äº›è¾…åŠ©ä»£ç ã€‚\nparseUrl(url)   parseUrl å®ç°æ¨¡æ‹Ÿï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  const { parse: uriParse } = require(\u0026#39;url\u0026#39;) function parseUrl(url) { const firstChar = url.charAt(0) if (firstChar === \u0026#39;~\u0026#39;) { const secondChar = url.charAt(1) url = url.slice(secondChar === \u0026#39;/\u0026#39; ? 2 : 1) } return parseUriParts(url) } function parseUriParts(urlString) { // A TypeError is thrown if urlString is not a string  // @see https://nodejs.org/api/url.html#url_url_parse_urlstring_parsequerystring_slashesdenotehost  return uriParse(typeof urlString === \u0026#39;string\u0026#39; ? urlString : \u0026#39;\u0026#39;, false, true) } console.log(\u0026#39;1. ~/ccc/tmp -\u0026gt; \u0026#39;, parseUrl(\u0026#39;~/ccc/tmp\u0026#39;)) console.log(\u0026#39;2. ~ccc/tmp/test.png -\u0026gt; \u0026#39;, parseUrl(\u0026#39;~ccc/tmp/test.png\u0026#39;)) console.log(\u0026#39;3. /ccc/tmp -\u0026gt;\u0026#39;, parseUrl(\u0026#39;/ccc/tmp\u0026#39;)) console.log(\u0026#39;4. @ccc/tmp -\u0026gt;\u0026#39;, parseUrl(\u0026#39;@ccc/tmp\u0026#39;)) console.log(\u0026#39;5. ~@svg/file.svg#fragment -\u0026gt; \u0026#39;, parseUrl(\u0026#39;~@svg/file.svg#fragment\u0026#39;)) console.log(\u0026#39;6. https://www.cheng92.com -\u0026gt;\u0026#39;, parseUrl(\u0026#39;https://www.cheng92.com\u0026#39;))    1. ~/ccc/tmp -\u0026gt; Url { protocol: null, slashes: null, auth: null, host: null, port: null, hostname: null, hash: null, search: null, query: null, pathname: \u0026#39;ccc/tmp\u0026#39;, path: \u0026#39;ccc/tmp\u0026#39;, href: \u0026#39;ccc/tmp\u0026#39; } 2. ~ccc/tmp/test.png -\u0026gt; Url { protocol: null, slashes: null, auth: null, host: null, port: null, hostname: null, hash: null, search: null, query: null, pathname: \u0026#39;ccc/tmp/test.png\u0026#39;, path: \u0026#39;ccc/tmp/test.png\u0026#39;, href: \u0026#39;ccc/tmp/test.png\u0026#39; } 3. /ccc/tmp -\u0026gt; Url { protocol: null, slashes: null, auth: null, host: null, port: null, hostname: null, hash: null, search: null, query: null, pathname: \u0026#39;/ccc/tmp\u0026#39;, path: \u0026#39;/ccc/tmp\u0026#39;, href: \u0026#39;/ccc/tmp\u0026#39; } 4. @ccc/tmp -\u0026gt; Url { protocol: null, slashes: null, auth: null, host: null, port: null, hostname: null, hash: null, search: null, query: null, pathname: \u0026#39;@ccc/tmp\u0026#39;, path: \u0026#39;@ccc/tmp\u0026#39;, href: \u0026#39;@ccc/tmp\u0026#39; } 5. ~@svg/file.svg#fragment -\u0026gt; Url { protocol: null, slashes: null, auth: null, host: null, port: null, hostname: null, hash: \u0026#39;#fragment\u0026#39;, search: null, query: null, pathname: \u0026#39;@svg/file.svg\u0026#39;, path: \u0026#39;@svg/file.svg\u0026#39;, href: \u0026#39;@svg/file.svg#fragment\u0026#39; } 6. https://www.cheng92.com -\u0026gt; Url { protocol: \u0026#39;https:\u0026#39;, slashes: true, auth: null, host: \u0026#39;www.cheng92.com\u0026#39;, port: null, hostname: \u0026#39;www.cheng92.com\u0026#39;, hash: null, search: null, query: null, pathname: \u0026#39;/\u0026#39;, path: \u0026#39;/\u0026#39;, href: \u0026#39;https://www.cheng92.com/\u0026#39; } undefined      ","permalink":"https://www.cheng92.com/vue/vue3-source-picking-shell/","tags":["vue,","vue3,","vuenext"],"title":"Vue3.0æºç ç³»åˆ— -- çŸ¥è¯†ç‚¹åŠé—®é¢˜æ±‡æ€»"},{"categories":["emacs"],"contents":"  Emacsç›¸å…³ä¸­æ–‡é—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆ\n åœ¨ doom-emacs ä¸­ä½¿ç”¨ spacemacs çš„ layers\n Doom-emacs   æ„Ÿè§‰ Spacemacs ç”¨èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹å¡ï¼Œä¸”å¯åŠ¨æ…¢ï¼Œç”¨ä¹…äº†æ›´å¡äº†ï¼Œåªèƒ½æ€ªè‡ªå·±å¤ªèœäº†ï¼Œæ‰€ä»¥ä»Šå¤©å¼€å§‹å°è¯•è½¬å‘ doom-emacs\n é…ç½®åˆ—è¡¨ï¼š\n  https://github.com/rschmukler/doom.d\n  https://github.com/forrestchang/.doom.d\n  https://rgoswami.me/dotdoom/config.html\n  https://github.com/hlissner/doom-emacs-private\n  https://github.com/sunnyhasija/Academic-Doom-Emacs-Config\n  https://emacs.nasy.moe/\n  ä¸»é¢˜ï¼šhttps://github.com/hlissner/emacs-doom-themes\n  https://github.com/tecosaur/emacs-config/blob/master/config.org\n  å¸¸ç”¨æŒ‰é”®     key function     \u0026lt;f12\u0026gt; smerge-vc-next-conflict   \u0026lt;f11\u0026gt; +vc/smerge-hydra/body   \u0026lt;f10\u0026gt; ebuku   C-s-, parrot previous   C-s-. parrot next   SPC * +default/search-project-for-symbol-at-point   SPC \u0026#39; ivy-resume   SPC , +ivy/switch-workspace-buffer   SPC . counsel-find-file, find file in current dir   SPC / +default/search-project   SPC \u0026lt; ivy-switch-buffer   SPC RET counsel-bookmark   SPC v o ivy-pop-view   SPC v p ivy-push-view   SPC a l leetcode   SPC b m set bookmark   SPC b M delete bookmark      Base Configuration/Operation  é‡æ–°åŠ è½½é…ç½®     key mode function     gr evil é€‰ä¸­æ¨¡å¼ä¸‹ æ‰§è¡Œé€‰ä¸­ä»£ç    C-x C-e - eval-last-sexp   SPC c e - M-x +eval/buffer-or-region        packages  ebuku, browser bookmarks management   install buku: https://github.com/jarun/buku\n  web-mode  hydra:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  (defhydra hydra-web-mode (:color blue :quit-key \u0026#34;q\u0026#34; :hint nil :columns 4) \u0026#34; ^Element^ ^Element^ ^Attribute^ ^Block\u0026amp;Other ^^^^^^^^--------------------------------------------------------------------------------------------- _a_ : Select content _r_ : Rename _0_ : Start _\u0026lt;_ : Begin _b_ : Start _s_ : Select _9_ : End _\u0026gt;_ : End _C_ : Clone _t_ : Move Down _*_ : Insert _-_ : Select _e_ : End _u_ : Parent _N_ : Next _f_ : Fold/unfold children _v_ : Delete without content _P_ : Previous _i_ : Insert _w_ : Wrap Element _S_ : Select _I_ : Insert cursor _t_ : Last(open/close) _K_ : Delete _k_ : Delete _T_ : Next(open/close) _n_ : Next _._ : Wrap Markup _p_ : Previous \u0026#34; (\u0026#34;a\u0026#34; web-mode-element-content-select) (\u0026#34;b\u0026#34; web-mode-element-beginning) (\u0026#34;e\u0026#34; web-mode-element-end) (\u0026#34;f\u0026#34; web-mode-element-children-fold-or-unfold) (\u0026#34;F\u0026#34; web-mode-fold-unfold) (\u0026#34;i\u0026#34; web-mode-element-insert) (\u0026#34;I\u0026#34; web-mode-element-insert-at-point) (\u0026#34;k\u0026#34; web-mode-element-kill) (\u0026#34;m\u0026#34; web-mode-element-mute-blanks) (\u0026#34;n\u0026#34; web-mode-element-next :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;p\u0026#34; web-mode-element-previous :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;r\u0026#34; web-mode-element-rename) (\u0026#34;s\u0026#34; web-mode-element-select) (\u0026#34;t\u0026#34; web-mode-element-transpose) (\u0026#34;u\u0026#34; web-mode-element-parent :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;v\u0026#34; web-mode-element-vanish) (\u0026#34;w\u0026#34; web-mode-element-wrap) (\u0026#34;t\u0026#34; web-mode-tag-previous :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;T\u0026#34; web-mode-tag-next :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;.\u0026#34; emmet-wrap-with-markup) ;; attribute (\u0026#34;0\u0026#34; web-mode-attribute-beginning) (\u0026#34;9\u0026#34; web-mode-attribute-end) (\u0026#34;*\u0026#34; web-mode-attribute-insert) (\u0026#34;K\u0026#34; web-mode-attribute-kill) (\u0026#34;N\u0026#34; web-mode-attribute-next :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;P\u0026#34; web-mode-attribute-previous :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;S\u0026#34; web-mode-attribute-select) ;; block (\u0026#34;\u0026lt;\u0026#34; web-mode-block-next :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;\u0026gt;\u0026#34; web-mode-block-previous :exit nil :color \u0026#34;pink\u0026#34;) (\u0026#34;-\u0026#34; web-mode-block-select) )        key functions desc     [t web-mode-tag-previous ä¸Šä¸€ä¸ªæ ‡ç­¾(åŒ…å«å¼€é—­æ ‡ç­¾)   ]t web-mode-tag-next ä¸‹ä¸€ä¸ªæ ‡ç­¾(åŒ…å«å¼€é—­æ ‡ç­¾)     z     z. emmet-wrap-with-markup      C-c     C-s web-mode-snippet-insert æ’å…¥snippets   C-f web-mode-fold-or-unfold -     C-c C-d DOM æ“ä½œ    d web-mode-dom-errors-show æ˜¾ç¤ºDOMé”™è¯¯ä¿¡æ¯ï¼Œæ ‡ç­¾æ˜¯å¦é—­åˆç­‰ç­‰     C-c C-e elementæ“ä½œ    a web-mode-element-content-select é€‰æ‹©æ ‡ç­¾å†…å®¹   b web-mode-element-beginning -   e web-mode-element-end -   f web-mode-element-children-fold-or-unfold fold/unfold children element   i web-mode-element-insert æ’å…¥æ ‡ç­¾æ ¹æ®è¾“å…¥æ ‡ç­¾å   I web-mode-element-insert-at-point æ ¹æ®å…‰æ ‡å¤„çš„åå­—æ’å…¥æ ‡ç­¾   k web-mode-element-kill åˆ é™¤å½“å‰æ ‡ç­¾   m web-mode-element-mute-blanks ?   n web-mode-element-next    p web-mode-element-previous -   r web-mode-element-rename    s web-mode-element-select é€‰ä¸­æ ‡ç­¾åŠå…¶å†…å®¹   t web-mode-element-transpose å°†å½“å‰æ ‡ç­¾ç§»åˆ°ä¸‹ä¸€ä¸ªæ ‡ç­¾åé¢   u web-mode-element-parent -   v web-mode-element-vanish åˆ é™¤æ ‡ç­¾åªä¿ç•™æ ‡ç­¾å†…å®¹ï¼Œå¦‚ï¼š \u0026lt;div\u0026gt;{{xx}}\u0026lt;/div\u0026gt; å˜æˆï¼š {{xx}}   w web-mode-element-wrap wrap with tag     C-c C-b block æ“ä½œ    n web-mode-block-next ä¸‹ä¸€ä¸ªblock   p web-mode-block-previous ä¸Šä¸€ä¸ª block   s web-mode-block-select é€‰ä¸­å½“å‰block     C-c C-a attribute æ“ä½œ    b web-mode-attribute-beginning å®šä½åˆ°å±æ€§å¼€å§‹   e web-mode-attribute-end å®šä½åˆ°å±æ€§ç»“å°¾   i web-mode-attribute-insert æ’å…¥å±æ€§   k web-mode-attribute-kill åˆ é™¤å±æ€§   n web-mode-attribute-next    p web-mode-attribute-previous    s web-mode-attribute-select    t web-mode-attribute-transpose      web-mode Keybindings     lsp-mode   leetcode   https://github.com/kaiwk/leetcode.el\n1 2 3 4 5 6 7 8 9  (:prefix (\u0026#34;l\u0026#34; . \u0026#34;Leetcode\u0026#34;) \u0026#34;l\u0026#34; #\u0026#39;leetcode \u0026#34;s\u0026#34; #\u0026#39;leetcode-submit \u0026#34;t\u0026#34; #\u0026#39;leetcode-try \u0026#34;r\u0026#34; #\u0026#39;leetcode-refresh \u0026#34;R\u0026#34; #\u0026#39;leetcode-refresh-fetch \u0026#34;f\u0026#34; #\u0026#39;leetcode-set-filter-difficulty \u0026#34;.\u0026#34; #\u0026#39;leetcode-reset-filter )     keybinds:\n   key function     SPC a l l leetcode   SPC a l s leetcode-submit   SPC a l t leetcode-try   SPC a l T leetcode-set-filter-tags   SPC a l r leetcode-refresh   SPC a l R leetcode-refresh-fetch   SPC a l f leetcode-set-filter-difficulty   SPC a l . leetcode-reset-filter   SPC a l x leetcode-set-filter-regex   SPC a l p leetcode-show-current-problem     hydra/body:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  (defhydra hydra-leetcode (:columns 3) \u0026#34; ^^^^Leetcode^^^^ ---------------------------------------------------------------------- \u0026#34; (\u0026#34;s\u0026#34; leetcode-submit \u0026#34;sumbit\u0026#34;) (\u0026#34;t\u0026#34; leetcode-try \u0026#34;try\u0026#34;) (\u0026#34;r\u0026#34; leetcode-refresh \u0026#34;refresh\u0026#34;) (\u0026#34;R\u0026#34; leetcode-refresh-fetch \u0026#34;refresh fetch\u0026#34;) (\u0026#34;s\u0026#34; leetcode-show-current-problem \u0026#34;show current problem\u0026#34;) (\u0026#34;f\u0026#34; leetcode-set-filter-difficulty \u0026#34;filter by difficulty\u0026#34;) (\u0026#34;g\u0026#34; leetcode-set-filter-tag \u0026#34;filter by tag\u0026#34;) (\u0026#34;e\u0026#34; leetcode-set-filter-regex \u0026#34;filter by regexp\u0026#34;) (\u0026#34;0\u0026#34; leetcode-reset-filter \u0026#34;reset filter\u0026#34;) )      go-mode   install: https://www.mdeditor.tw/pl/2KAi\n  no such file or directory gocode ?\n    smart-hungry-delete   https://github.com/hrehfeld/emacs-smart-hungry-delete\n1 2 3 4 5 6 7  (use-package smart-hungry-delete :ensure t :bind ((\u0026#34;\u0026lt;backspace\u0026gt;\u0026#34; . smart-hungry-delete-backward-char) (\u0026#34;C-d\u0026#34; . smart-hungry-delete-forward-char)) :defer nil ;; dont defer so we can add our functions to hooks  :config (smart-hungry-delete-add-default-hooks) )      string-inflection ä»£ç é£æ ¼åˆ‡æ¢(python/java/ruby/â€¦)   github link-\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  (defun gcl/string-inflection-cycle-auto () \u0026#34;switching by major-mode\u0026#34; (interactive) (cond ;; for emacs-lisp-mode ((eq major-mode \u0026#39;emacs-lisp-mode) (string-inflection-all-cycle)) ;; for python ((eq major-mode \u0026#39;python-mode) (string-inflection-python-style-cycle)) ;; for java ((eq major-mode \u0026#39;java-mode) (string-inflection-java-style-cycle)) (t ;; default (string-inflection-java-style-cycle))))      parrot(C-s)   https://github.com/dp12/parrot\n rotate textï¼Œåœ¨çº¦å®šçš„å‡ ä¸ªå­—ç¬¦ä¸²ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  (setq parrot-rotate-dict \u0026#39;( (:rot (\u0026#34;alpha\u0026#34; \u0026#34;beta\u0026#34;) :caps t :lower nil) ;; =\u0026gt; rotations are \u0026#34;Alpha\u0026#34; \u0026#34;Beta\u0026#34; (:rot (\u0026#34;snek\u0026#34; \u0026#34;snake\u0026#34; \u0026#34;stawp\u0026#34;)) ;; =\u0026gt; rotations are \u0026#34;snek\u0026#34; \u0026#34;snake\u0026#34; \u0026#34;stawp\u0026#34; (:rot (\u0026#34;yes\u0026#34; \u0026#34;no\u0026#34;) :caps t :upcase t) ;; =\u0026gt; rotations are \u0026#34;yes\u0026#34; \u0026#34;no\u0026#34;, \u0026#34;Yes\u0026#34; \u0026#34;No\u0026#34;, \u0026#34;YES\u0026#34; \u0026#34;NO\u0026#34; (:rot (\u0026#34;\u0026amp;\u0026#34; \u0026#34;|\u0026#34;)) ;; =\u0026gt; rotations are \u0026#34;\u0026amp;\u0026#34; \u0026#34;|\u0026#34; ;; default dictionary starts here (\u0026#39;v\u0026#39;) (:rot (\u0026#34;begin\u0026#34; \u0026#34;end\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;enable\u0026#34; \u0026#34;disable\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;enter\u0026#34; \u0026#34;exit\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;forward\u0026#34; \u0026#34;backward\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;front\u0026#34; \u0026#34;rear\u0026#34; \u0026#34;back\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;get\u0026#34; \u0026#34;set\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;high\u0026#34; \u0026#34;low\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;in\u0026#34; \u0026#34;out\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;left\u0026#34; \u0026#34;right\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;min\u0026#34; \u0026#34;max\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;on\u0026#34; \u0026#34;off\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;prev\u0026#34; \u0026#34;next\u0026#34;)) (:rot (\u0026#34;start\u0026#34; \u0026#34;stop\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;true\u0026#34; \u0026#34;false\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;\u0026amp;\u0026amp;\u0026#34; \u0026#34;||\u0026#34;)) (:rot (\u0026#34;==\u0026#34; \u0026#34;!=\u0026#34;)) (:rot (\u0026#34;.\u0026#34; \u0026#34;-\u0026gt;\u0026#34;)) (:rot (\u0026#34;if\u0026#34; \u0026#34;else\u0026#34; \u0026#34;elif\u0026#34;)) (:rot (\u0026#34;ifdef\u0026#34; \u0026#34;ifndef\u0026#34;)) (:rot (\u0026#34;int8_t\u0026#34; \u0026#34;int16_t\u0026#34; \u0026#34;int32_t\u0026#34; \u0026#34;int64_t\u0026#34;)) (:rot (\u0026#34;uint8_t\u0026#34; \u0026#34;uint16_t\u0026#34; \u0026#34;uint32_t\u0026#34; \u0026#34;uint64_t\u0026#34;)) (:rot (\u0026#34;1\u0026#34; \u0026#34;2\u0026#34; \u0026#34;3\u0026#34; \u0026#34;4\u0026#34; \u0026#34;5\u0026#34; \u0026#34;6\u0026#34; \u0026#34;7\u0026#34; \u0026#34;8\u0026#34; \u0026#34;9\u0026#34; \u0026#34;10\u0026#34;)) (:rot (\u0026#34;1st\u0026#34; \u0026#34;2nd\u0026#34; \u0026#34;3rd\u0026#34; \u0026#34;4th\u0026#34; \u0026#34;5th\u0026#34; \u0026#34;6th\u0026#34; \u0026#34;7th\u0026#34; \u0026#34;8th\u0026#34; \u0026#34;9th\u0026#34; \u0026#34;10th\u0026#34;)) ))     é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13  (use-package! parrot :init (progn (define-key global-map (kbd \u0026#34;C-s ,\u0026#34;) \u0026#39;parrot-rotate-prev-word-at-point) (define-key global-map (kbd \u0026#34;C-s .\u0026#34;) \u0026#39;parrot-rotate-next-word-at-point)) :config (parrot-mode) (setq parrot-ratate-dict \u0026#39;( (:rot (\u0026#34;alpha\u0026#34; \u0026#34;beta\u0026#34;) :caps t :lower nil) ;; =\u0026gt; Alpha, Beta (:rot (\u0026#34;yes\u0026#34; \u0026#34;no\u0026#34;) :caps t :upcase t) ;; =\u0026gt; yes,no,No,YES,NO (:rot (\u0026#34;\u0026amp;\u0026#34; \u0026#34;|\u0026#34;)) )))        Keybindings  æ‰€æœ‰å¸¸ç”¨æŒ‰é”®å‡é€šè¿‡ hydra æ³¨é‡Šæ–¹å¼å±•ç°ï¼Œæ–¹ä¾¿æŸ¥è¯¢ï¼š\ntest  key ç»‘å®šå‡½æ•°ï¼š\n  define-key\n  global-set-key\n  map!\n  undefined-key!\n  define-key!\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64  ;; bind a global key (global-set-key (kbd \u0026#34;C-x y\u0026#34;) #\u0026#39;do-something) (map! \u0026#34;C-x y\u0026#34; #\u0026#39;do-something) ;; bind a key on a keymap (define-key emacs-lisp-mode-map (kbd \u0026#34;C-c p\u0026#34;) #\u0026#39;do-something) (map! :map emacs-lisp-mode-map \u0026#34;C-c p\u0026#34; #\u0026#39;do-something) ;; unbind a key defined elsewhere (define-key lua-mode-map (kbd \u0026#34;SPC m b\u0026#34;) nil) (map! :map lua-mode-map \u0026#34;SPC m b\u0026#34; nil) ;; bind multiple keys (global-set-key (kbd \u0026#34;C-x x\u0026#34;) #\u0026#39;do-something) (global-set-key (kbd \u0026#34;C-x y\u0026#34;) #\u0026#39;do-something-else) (global-set-key (kbd \u0026#34;C-x z\u0026#34;) #\u0026#39;do-another-thing) (map! \u0026#34;C-x x\u0026#34; #\u0026#39;do-something \u0026#34;C-x y\u0026#34; #\u0026#39;do-something-else \u0026#34;C-x z\u0026#34; #\u0026#39;do-another-thing) ;; bind global keys in normal mode (evil-define-key* \u0026#39;normal \u0026#39;global (kbd \u0026#34;C-x x\u0026#34;) #\u0026#39;do-something (kbd \u0026#34;C-x y\u0026#34;) #\u0026#39;do-something-else (kbd \u0026#34;C-x z\u0026#34;) #\u0026#39;do-another-thing) (map! :n \u0026#34;C-x x\u0026#34; #\u0026#39;do-something :n \u0026#34;C-x y\u0026#34; #\u0026#39;do-something-else :n \u0026#34;C-x z\u0026#34; #\u0026#39;do-another-thing) ;; or on a deferred keymap (evil-define-key \u0026#39;normal emacs-lisp-mode-map (kbd \u0026#34;C-x x\u0026#34;) #\u0026#39;do-something (kbd \u0026#34;C-x y\u0026#34;) #\u0026#39;do-something-else (kbd \u0026#34;C-x z\u0026#34;) #\u0026#39;do-another-thing) (map! :map emacs-lisp-mode-map :n \u0026#34;C-x x\u0026#34; #\u0026#39;do-something :n \u0026#34;C-x y\u0026#34; #\u0026#39;do-something-else :n \u0026#34;C-x z\u0026#34; #\u0026#39;do-another-thing) ;; or multiple maps (dolist (map (list emacs-lisp-mode go-mode-map ivy-minibuffer-map)) (evil-define-key \u0026#39;(normal insert) map \u0026#34;a\u0026#34; #\u0026#39;a \u0026#34;b\u0026#34; #\u0026#39;b \u0026#34;c\u0026#34; #\u0026#39;c)) (map! :map (emacs-lisp-mode go-mode-map ivy-minibuffer-map) :ni \u0026#34;a\u0026#34; #\u0026#39;a :ni \u0026#34;b\u0026#34; #\u0026#39;b :ni \u0026#34;c\u0026#34; #\u0026#39;c) ;; or in multiple states (order of states doesn\u0026#39;t matter) (evil-define-key* \u0026#39;(normal visual) emacs-lisp-mode-map (kbd \u0026#34;C-x x\u0026#34;) #\u0026#39;do-something) (evil-define-key* \u0026#39;insert emacs-lisp-mode-map (kbd \u0026#34;C-x x\u0026#34;) #\u0026#39;do-something-else) (evil-define-key* \u0026#39;(visual normal insert emacs) emacs-lisp-mode-map (kbd \u0026#34;C-x z\u0026#34;) #\u0026#39;do-another-thing) (map! :map emacs-lisp-mode :nv \u0026#34;C-x x\u0026#34; #\u0026#39;do-something ; normal+visual :i \u0026#34;C-x y\u0026#34; #\u0026#39;do-something-else ; insert :vnie \u0026#34;C-x z\u0026#34; #\u0026#39;do-another-thing) ; visual+normal+insert+emacs ;; You can nest map! calls: (evil-define-key* \u0026#39;(normal visual) emacs-lisp-mode-map (kbd \u0026#34;C-x x\u0026#34;) #\u0026#39;do-something) (evil-define-key* \u0026#39;normal go-lisp-mode-map (kbd \u0026#34;C-x x\u0026#34;) #\u0026#39;do-something-else) (map! (:map emacs-lisp-mode :nv \u0026#34;C-x x\u0026#34; #\u0026#39;do-something) (:map go-lisp-mode :n \u0026#34;C-x x\u0026#34; #\u0026#39;do-something-else))      æ‰€æœ‰æŒ‰é”®è¡¨   C-Control, s-Command, S-Shift, M-option/alt\n   prefix key function mode description     g å­—æ¯ g       ~~        z å­—æ¯ z       - sp-splice-sexp  å–æ¶ˆæ‹¬å·     C Control       ( sp-backward-slurp-sexp  å·¦æ‹¬å·å·¦ç§»    ) sp-forward-slurp-sexp  å³æ‹¬å·å³ç§»    + cnfonts-increase-fontsize  -    - cnfonts-decrease-fontsize  -     M Option/Alt       u upcase-word      l downcase-word      c capitalize-word       s Command       \u0026lt; move-text-up      \u0026gt; move-text-down      ( sp-forward-barf-sexp  å·¦æ‹¬å·å³ç§»    ) sp-backward-barf-sexp  å³æ‹¬å·å·¦ç§»    q +workspace/kill-session-and-quit  save-buffers-kill-terminal     C-s        , parrot-rotate-prev-word-at-point  -    . parrot-rotate-next-word-at-point  -     C-c        d insert-current-date-time      t insert-current-time      r vr/replace  -    q vr/query-replace      u crux-view-url      U browse-url-at-point       C-S Control + Shift        SPC        b f osx-lib-reveal-in-finder  -    b O kill-other-buffers  -    c e +eval/buffer-or-region  -    l m lsp-ui-imenu  -    l t treemacs  -    n n org-capture      n N org-goto-capture      m r intant-rename-tag web-mode åŒæ­¥ä¿®æ”¹æ ‡ç­¾å    w - evil-window-split  æ°´å¹³åˆ†å‰²    w v evil-window-vsplit  å‚ç›´åˆ†å‰²      ä¸»é¢æ¿  1 2 3 4 5 6 7 8 9 10 11 12 13 14  (defhydra hydra-main (:color blue :exit t :hint nil) \u0026#34; all hydra apps: ------------------------------------------------------------------ [_a_] Tip [_h_] Launcher [_m_] Multiple Cursors [_w_] Window [_t_] Text Zoom [_o_] Org Agenda \u0026#34; (\u0026#34;a\u0026#34; hydra-tip/body) (\u0026#34;h\u0026#34; hydra-launcher/body) (\u0026#34;m\u0026#34; hydra-multiple-cursors/body) (\u0026#34;w\u0026#34; +hydra/window-nav/body) (\u0026#34;t\u0026#34; +hydra/text-zoom/body) (\u0026#34;o\u0026#34; hydra-org-agenda-view/body) )      æç¤ºé¢æ¿å…¥å£  1 2 3 4 5 6 7 8 9 10 11 12  ;; æç¤ºé¢æ¿ (defhydra hydra-tip (:color blue :hint nil) \u0026#34; Tips for modes or kyes. ------------------------------------------------------------------ [_m_] M-Cursors [_e_] Evil [_u_] å¸¸ç”¨ [_q_] Quit \u0026#34; (\u0026#34;m\u0026#34; hydra-tip-mcursors/body) (\u0026#34;u\u0026#34; hydra-tip-useful/body) (\u0026#34;e\u0026#34; hydra-tip-evil/body) (\u0026#34;q\u0026#34; nil) )      å¸¸ç”¨æŒ‰é”®æç¤ºé¢æ¿  1 2 3 4 5 6 7 8 9 10 11 12 13 14  (defhydra hydra-tip-useful (:color blue :hint nil) \u0026#34; å¸¸ç”¨æ“ä½œæç¤º(C-Control, s-Command, M-option/alt)ï¼š ------------------------------------------------------------------ æ‹¬å·æ“ä½œ æ–‡æœ¬æ“ä½œ æœç´¢/æ›¿æ¢ ------------------------------------------------------------------ [C-(] å·¦æ‹¬å·å·¦ç§» [s-\u0026lt;] move-text-up [C-c r] æ›¿æ¢ [C-)] å³æ‹¬å·å³ç§» [s-\u0026gt;] move-text-down [C-c q] æœç´¢æ›¿æ¢ [s-)] å·¦æ‹¬å·å³ç§» [C-+] æ”¾å¤§å­—ä½“ [s-(] å³æ‹¬å·å·¦ç§» [C--] ç¼©å°å­—ä½“ [z--] å–æ¶ˆæ‹¬å· [M-u] å¤§å†™åŒ– [M-l] å°å†™åŒ– [M-c] é¦–å­—æ¯å¤§å†™ \u0026#34;)      SPC å¼€å§‹æŒ‰é”®æç¤ºé¢æ¿  1 2 3 4 5 6 7 8 9 10 11  (defhydra hydra-tip-spc (:hint nil) \u0026#34; SPC æŒ‰é”®åˆ—è¡¨ ------------------------------------------------------------------ \u0026lt;a~l\u0026gt; ------------------------------------------------------------------ [SPC b O] kill-other-buffers [SPC l m] lsp-ui-imenu [SPC l t] treemacs \u0026#34;)      Org-mode æŒ‰é”®æç¤ºé¢æ¿  1 2 3 4 5 6 7 8 9 10 11  (defhydra hydra-tip-org (:hint nil) \u0026#34; Org-mode æŒ‰é”®æç¤º ------------------------------------------------------------------ Table æ“ä½œ è·³è½¬ ------------------------------------------------------------------ [M-l] åˆ—å³ç§» [gj] ä¸Šä¸€ä¸ªåŒçº§æ ‡é¢˜ [M-h] åˆ—å·¦ç§» [gk] ä¸‹ä¸€ä¸ªåŒçº§æ ‡é¢˜ [M-j] è¡Œä¸‹ç§» [gh] çˆ¶çº§æ ‡é¢˜ [M-k] è¡Œä¸Šç§» \u0026#34;)      evil-modeæŒ‰é”®æç¤ºé¢æ¿  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  (defhydra hydra-tip-evil (:hint nil) \u0026#34; evil æ¨¡å¼ä¸‹æ“ä½œå‘½ä»¤æç¤ºã€‚ ------------------------------------------------------------------ ç¬¦å·/å­—æ¯ \u0026lt;z\u0026gt; ------------------------------------------------------------------ [+] æ•°å­—+1 [z-] å–æ¶ˆæ‹¬å· [-] æ•°å­—-1 [z.] wrap æ ‡ç­¾ [K] æŸ¥æ–‡æ¡£ [za] fold æ‰€æœ‰ [s/S] wrap å­—ç¬¦(é€‰ä¸­) [zo] open å½“å‰ [s/S] æ–‡ä»¶å†…å­—ç¬¦å®šä½ [zj] fold ä¸‹ä¸€ä¸ª [f/F] è¡Œå†…å­—ç¬¦å®šä½ [zk] fold ä¸Šä¸€ä¸ª [t/T] è¡Œå†…å­—ç¬¦å®šä½ [zr] openæ‰€æœ‰ [;] å‘åé‡å¤æŸ¥æ‰¾ [zm] closeæ‰€æœ‰ [,] å‘å‰é‡å¤æŸ¥æ‰¾ [zt] å½“å‰è¡Œå®šä½åˆ°é¡¶éƒ¨ [zx] kill å½“å‰buffer ------------------------------------------------------------------ \u0026lt;g\u0026gt; ------------------------------------------------------------------ [_g[_] å‡½æ•°å¼€å¤´ [_gd_] æŸ¥æ‰¾å®šä¹‰(definition) [_g0_] è¡Œé¦– [_g]_] å‡½æ•°ç»“å°¾ [_gD_] æŸ¥æ‰¾å¼•ç”¨(reference) [_gsj_] æŒ‰å­—ç¬¦å¾€åå®šä½ [_gr_] æ‰§è¡Œé€‰ä¸­å†…å®¹ [_gss_] æŒ‰ä¸¤ä¸ªå­—ç¬¦å®šä½ [_gt_] åˆ‡æ¢ä¸‹ä¸€ä¸ªworkspace [_gs/_] æŒ‰å•ä¸ªå­—ç¬¦å®šä½ [_gx_] äº¤æ¢ä¸¤ä¸ªé€‰ä¸­åŒºå†…å®¹ [_gsk_] æŒ‰å­—ç¬¦å¾€å‰å®šä½ [_gf_] æŸ¥æ‰¾å…‰æ ‡å¤„åç§°çš„æ–‡ä»¶ [_gs[[_] æŒ‰æ®µé¦–å‘å‰å®šä½ [_gs[]_] æŒ‰æ–­å°¾å‘å‰å®šä½ [_gs]]_] æŒ‰æ®µé¦–å‘åå®šä½ [_gs][_] æŒ‰æ–­å°¾å‘åå®šä½ \u0026#34; (\u0026#34;g[\u0026#34; beginning-of-defun) (\u0026#34;g]\u0026#34; end-of-defun) (\u0026#34;g0\u0026#34; evil-beginning-of-visual-line) (\u0026#34;gd\u0026#34; xref-find-definitions) (\u0026#34;gD\u0026#34; xref-find-references) (\u0026#34;gb\u0026#34; xref-pop-marker-stack) (\u0026#34;gr\u0026#34; +eval:region) (\u0026#34;gjj\u0026#34; dumb-jump-go) (\u0026#34;gjb\u0026#34; dumb-jump-back) (\u0026#34;gt\u0026#34; +workspace:switch-next) (\u0026#34;gx\u0026#34; evil-exchange) (\u0026#34;gf\u0026#34; +lookup/file) (\u0026#34;gss\u0026#34; evil-avy-goto-char-2) (\u0026#34;gs/\u0026#34; evil-avy-goto-char-timer) (\u0026#34;gsj\u0026#34; evilem-motion-next-line) (\u0026#34;gsk\u0026#34; evilem-motion-previous-line) (\u0026#34;gs[[\u0026#34; evilem-motion-backward-section-begin) (\u0026#34;gs[]\u0026#34; evilem-motion-backward-section-end) (\u0026#34;gs][\u0026#34; evilem-motion-forward-section-end) (\u0026#34;gs]]\u0026#34; evilem-motion-forward-section-begin) )      multiple cursors(C-S-c, Control-Shift-c)     key function description     C-\u0026gt; mc/mark-next-like-this -   C-\u0026lt; mc/mark-previous-like-this -   C-c C-\u0026lt; mc/mark-all-like-this -   C-S-c C-S-c mc/edit-lines S: Shift Key   C-S-c 0 mc/insert-numbers -   C-S-c 1 mc/insert-letters -   C-S-c s mc/mark-all-in-region -   C-S-c S mc/mark-all-in-region-regexp -   C-j - insert newline    1 2 3 4 5 6 7 8 9 10  (defhydra hydra-tip-mcursors (:color blue :hint nil) \u0026#34; Multiple Cursors Mode Tip(C-Control, S-Shift). [C-S-c 0] insert numbers [C-\u0026gt;] next [C-S-c 1] insert letters [C-\u0026gt;] previous [C-S-c s] region [C-c C-\u0026lt;] all [C-S-c S] region regexp [C-S-c C-S-c] edit lines \u0026#34;)      Launcher æŒ‰é”®é¢æ¿  1 2 3 4 5 6 7 8 9 10 11 12 13  (defhydra hydra-launcher (:color blue :hint nil :exit t) \u0026#34; all hydra apps or browse urls: ------------------------------------------------------------------ [_h_] Man [_r_] Reddit [_w_] EmacsWiki [_z_] Zhihu [_s_] Shell [_q_] Cancel \u0026#34; (\u0026#34;h\u0026#34; man) (\u0026#34;r\u0026#34; (browse-url \u0026#34;http://www.reddit.com/r/emacs\u0026#34;)) (\u0026#34;w\u0026#34; (browse-url \u0026#34;http://www.emacswiki.org/\u0026#34;)) (\u0026#34;z\u0026#34; (browse-url \u0026#34;https://www.zhihu.com/\u0026#34;)) (\u0026#34;s\u0026#34; shell) (\u0026#34;q\u0026#34; nil))      crux tool(C-c)     key function description     C-c o crux-open-with open with specific application   C-c u crux-view-url open the url under cursor   C-c D crux-delete-file-and-buffer SPC f D -\u0026gt; doom/delete-this-file   C-c S crux-find-shell-init-file -    ä¸­æ–‡å¯¹é½ï¼Ÿï¼Ÿ       window operations     key function description     SPC w L +evil/window-move-right -   SPC w H +evil/window-move-left    SPC w J +evil/window-move-down    SPC w K +evil/window-move-up       smartparen æ‹¬å·æ“ä½œ     key function description     z [ sp-wrap-square replace with S   z ( sp-wrap-round replace with S   z { sp-wrap-curly replace with S   z - sp-splice-sexp -   z . emmet-wrap-with-markup -     C-( sp-backward-slurp-sexp    C-) sp-forward-slurp-sexp    s-( sp-backward-barf-sexp    s-) sp-forward-barf-sexp    C-{ sp-backward-sexp    C-} sp-forward-sexp       +workspace     key function description     SPC TAB 0-9 - +workspaces switch to(0-9)   SPC TAB . +workspace/switch -   SPC TAB [ +workspace/previous -   SPC TAB ] +workspace/next -   SPC TAB ` +workspace/last -   SPC TAB d +workspace/delete delete this workspace   SPC TAB l +workspace/load -   SPC TAB n +workspace/new -   SPC TAB r +workspace/rename -   SPC TAB s +workspace/save -   SPC TAB x +workspace/kill-session -   SPC TAB R +workspace/restore-last -          Spaceamcs  æˆ‘çš„ Spacemacs é…ç½®æ–‡ä»¶ï¼Œå‚è€ƒé…ç½®æ¥æºäº å­é¾™å±±äºº çš„é…ç½®æ–¹æ¡ˆ(è¿›è¡Œäº†éƒ¨åˆ†åˆ å‡)ï¼Œæˆ‘çš„å®Œæ•´é…ç½®æ–‡æ¡£é“¾æ¥ğŸ›¬ğŸ›¬ğŸ›¬ã€‚\nAwesome/æœ‰è¶£/å®ç”¨     key function description     SPC i s ivy-yas æ’å…¥ snippet å®æ—¶æ˜¾ç¤ºè¦æ’å…¥çš„å†…å®¹   C-c i m helm-imenu å‡½æ•°ï¼Œå˜é‡åˆ—è¡¨     SPC i s\n   Key bindings   æˆ‘çš„è‡ªå®šä¹‰æŒ‰é”®ï¼š\n   Key Binding Description     SPC a m n emms-next   SPC a m p emms-previous     SPC b i ibuffer   SPC b D spacemacs/kill-other-buffers   SPC b m s bookmark-set   SPC b m r bookmark-rename   SPC b m d bookmark-delete   SPC b m j counsel-bookmark     SPC d d dash-at-point     SPC e n flycheck-next-error   SPC e p flycheck-previous-error     SPC f d projectile-find-file-dwim-other-window     SPC g g magit   SPC g L magit-log-buffer-file, show git logs   SPC g n smerge-next   SPC g p smerge-prev   SPC g M git-messenger:popup-message, show git log message, with `f\u0026#39; open in browser.     SPC h h zilongshanren/highlight-dwim   SPC h c zilongshanren/clearn-highlight, TODO     SPC o o zilongshanren/helm-hotspots   SPC o x org-open-at-point-global, open link   SPC o r zilongshanren/browser-refreshâ€“chrome-applescript   SPC o s spacemacs/search-engine-select, open search engine list to search   SPC o g my-git-timemachine, git record   SPC o ! zilongshanren/iterm-shell-command, go current dir \u0026amp; run command   SPC o e tiny-expand   SPC o i org-mode insert command   SPC o i t org-set-tags-command, â€“\u0026gt; :done:     SPC p b counsel-projectile-switch-to-buffer   SPC p t my-simple-todo   SPC p f zilongshanren/open-file-with-projectile-or-counsel-git     SPC r l ivy-resume, resume last search result     SPC s j counsel-jump-in-buffer     SPC y i yas/insert-snippet   SPC y d youdao-dictionary-search-at-point+     C-c l zilongshanren/insert-chrome-current-tab-url   C-c t org-capture   C-c r vr/replace   C-c q vr/query-replace     M-- zilongshanren/goto-match-paren   M-i string-inflection-java-style-cycle   M-\u0026#39; avy-goto-char-2     s-p find-file-in-project     , \u0026#39; ielm, lisp-repl   , g d xref-find-definition   , g b xref-pop-marker-stack     + evil-numbers/inc-at-ptï¼Œnumber +1   - evil-numbers/dec-at-pt, number -1     g [ beginning-of-defun   g ] end-of-defun     z [ sp-wrap-square   z ( sp-wrap-round   z { sp-wrap-curly   z - sp-splice-sexp   z . emmet-wrap-with-markup    vue-mode  vue-mode-key-bindings\n  smartparens(æ‹¬å·æ“ä½œ)     key function     C-( sp-backward-slurp-sexp   s-( sp-backward-barf-sexp   C-) sp-forward-slurp-sexp   s-) sp-forward-barf-sexp   C-{ sp-backward-sexp   C-} sp-forward-sexp      move-text, up/down     key function     s-\u0026lt; move-text-up   s-\u0026gt; move-text-down        Modes  emms, play music  1 2 3 4 5 6 7 8 9  (spacemacs/set-leader-keys \u0026#34;ama\u0026#34; \u0026#39;emms-add-directory-tree) (spacemacs/set-leader-keys \u0026#34;ame\u0026#34; \u0026#39;emms-smart-browse) (spacemacs/set-leader-keys \u0026#34;aml\u0026#34; \u0026#39;emms-play-playlist) (spacemacs/set-leader-keys \u0026#34;amn\u0026#34; \u0026#39;emms-next) (spacemacs/set-leader-keys \u0026#34;amp\u0026#34; \u0026#39;emms-previous) (spacemacs/set-leader-keys \u0026#34;amP\u0026#34; \u0026#39;emms-pause) (spacemacs/set-leader-keys \u0026#34;ams\u0026#34; \u0026#39;emms-start) (spacemacs/set-leader-keys \u0026#34;amS\u0026#34; \u0026#39;emms-stop) (spacemacs/set-leader-keys \u0026#34;amt\u0026#34; \u0026#39;emms-toggle-repeat-playlist)       key function     SPC a m a \u0026#39;emms-add-directory-tree   SPC a m e \u0026#39;emms-smart-browse   SPC a m l \u0026#39;emms-play-playlist   SPC a m n \u0026#39;emms-next   SPC a m p \u0026#39;emms-previous   SPC a m P \u0026#39;emms-pause   SPC a m s \u0026#39;emms-start   SPC a m S \u0026#39;emms-stop   SPC a m t \u0026#39;emms-toggle-repeat-playlist      DONE ranger  CLOSED: [2020-08-27 Thu 21:14]\n  State \u0026#34;DONE\u0026#34; from [2020-08-27 Thu 21:14]\n     key function     SPC a r open ranger   q quit   j move down   k move up   l into current directory   h up to parent dir     file manangement:\n   key function     r revert buffer   R rename   D delete   yy copy   pp paste   f search file names   i toggle showing literal / full-text previews   zh toggle dot files   o sort options   H search through history   z- or z+ reduce/increase parents   C-SPC mark a file or directory   v toggle mark   V visually select lines   ;C copy / move directory   ;+ create directory   SPC a d deer   C-j scroll preview window down   C-k scroll preview window up   S enter shell      org-mode   ref: https://practicalli.github.io/spacemacs/org-mode/\n   key function     , i p set property    text-style   code: , x c\n italic: , x i\n line-throught: , x s\n underline: , x u\n verbatim: , x v\n bold: , x b\n  checkbox   todo one, C-c C-c change status\n todo two, done\n todo three\n    todos  TODO todo one  SCHEDULED: \u0026lt;2020-08-27 Thu\u0026gt;\n  WAITING todo two waiting    State \u0026#34;WAITING\u0026#34; from \u0026#34;TODO\u0026#34; [2020-08-25 Tue 14:46] â€“\n    todo scheduler  SCHEDULED: \u0026lt;2020-08-25 Tue\u0026gt;\n      TODO tiny, SPC o e  https://github.com/abo-abo/tiny\n  TODO multiple-cursors   TODO prodigy  blog settings.\n  TODO wrap-region   https://github.com/rejeep/wrap-region.el/blob/master/wrap-region.el\n    Misc Settings   è¶…è¿‡ 80 åˆ—è‡ªåŠ¨æ¢è¡Œ ï¼š\n1 2  (add-hook \u0026#39;org-mode-hook \u0026#39;turn-on-auto-fill) (setq-default fill-column 80)     è‡ªåŠ¨ç¼©è¿›:\n (global-aggressive-indent-mode)\n  Issues  Points  org-mode ç®€ä»‹    Jump to inner link: \u0026lt;\u0026lt;text\u0026gt;\u0026gt; \u0026lt;- [[test][text]]\n          ","permalink":"https://www.cheng92.com/emacs/my-emacs-configuration/","tags":["emacs"],"title":"My Emacs Configuration[å·²åºŸå¼ƒ]"},{"categories":null,"contents":";; -- mode: emacs-lisp --\n;; pandoc-mode project settings file ;; saved on 2021.07.22 14:15\n((master-file . â€œ/Users/simon/blog/cheng92.com/content/post/my-first-post.orgâ€))\n","permalink":"https://www.cheng92.com/post/project./","tags":null,"title":""},{"categories":null,"contents":"  ç”¨ config.org æ–‡ä»¶æ¥ç»´æŠ¤ doom emacs é…ç½®ã€‚\n View on GitHub  ä»–äººé…ç½®åˆ—è¡¨ï¼š\n    name\u0026amp;link brief     dot-doom/doom.org at master Â· zzamboni/dot-doom -   Sacha Chua\u0026#39;s Emacs configuration -   daedreth/UncleDavesEmacs: My personal ~/.emacs.d -   PythonNut/quark-emacs: An incredible wonderland of code -   Mastering Emacs -   Doom Emacs Configuration -   GitHub - KaratasFurkan/.emacs.d: My literate Emacs configuration -   eggcaker/.doom.d: My private doom-emacs configurations rime + pyim   https://www.gtrun.org/custom/config.html#org57b461c     Update Logs  [2021-05-30]\n  add gcl/async-shell-command-silently\n  [2021-07-02]\n  upgrade emacs27 to emacs28 native\n    Function declaration  mine  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97  ;;;###autoload (defun gcl/edit-zsh-configuration () (interactive) (find-file \u0026#34;~/.zshrc\u0026#34;)) ;;;###autoload (defun gcl/use-eslint-from-node-modules () \u0026#34;Set local eslint if available.\u0026#34; (let* ((root (locate-dominating-file (or (buffer-file-name) default-directory) \u0026#34;node_modules\u0026#34;)) (eslint (and root (expand-file-name \u0026#34;node_modules/eslint/bin/eslint.js\u0026#34; root)))) (when (and eslint (file-executable-p eslint)) (setq-local flycheck-javascript-eslint-executable eslint)))) ;;;###autoload (defun gcl/goto-match-paren (arg) \u0026#34;Go to the matching if on (){}[], similar to vi style of % .\u0026#34; (interactive \u0026#34;p\u0026#34;) (cond ((looking-at \u0026#34;[\\[\\(\\{]\u0026#34;) (evil-jump-item)) ((looking-back \u0026#34;[\\]\\)\\}]\u0026#34; 1) (evil-jump-item)) ((looking-at \u0026#34;[\\]\\)\\}]\u0026#34;) (forward-char) (evil-jump-item)) ((looking-back \u0026#34;[\\[\\(\\{]\u0026#34; 1) (backward-char) (evil-jump-item)) (t nil))) ;;;###autoload (defun gcl/string-inflection-cycle-auto () \u0026#34;switching by major-mode\u0026#34; (interactive) (cond ;; for emacs-lisp-mode ((eq major-mode \u0026#39;emacs-lisp-mode) (string-inflection-all-cycle)) ;; for python ((eq major-mode \u0026#39;python-mode) (string-inflection-python-style-cycle)) ;; for java ((eq major-mode \u0026#39;java-mode) (string-inflection-java-style-cycle)) (t ;; default (string-inflection-all-cycle)))) ;; Current time and date (defvar current-date-time-format \u0026#34;%a %b %d %H:%M:%S %Z %Y\u0026#34; \u0026#34;Format of date to insert with `insert-current-date-time\u0026#39;func See help of `format-time-string\u0026#39;for possible replacements\u0026#34;) (defvar current-time-format \u0026#34;%H:%M\u0026#34; \u0026#34;Format of date to insert with `insert-current-time\u0026#39;func. Note the weekly scope of the command\u0026#39;s precision.\u0026#34;) ;;;###autoload (defun insert-current-date-time () \u0026#34;insert the current date and time into current buffer. Uses `current-date-time-format\u0026#39;for the formatting the date/time.\u0026#34; (interactive) (insert (format-time-string current-date-time-format (current-time))) ) ;;;###autoload (defun insert-current-time () \u0026#34;insert the current time (1-week scope) into the current buffer.\u0026#34; (interactive) (insert (format-time-string current-time-format (current-time))) ) ;;;###autoload (defun my/capitalize-first-char (\u0026amp;optional string) \u0026#34;Capitalize only the first character of the input STRING.\u0026#34; (when (and string (\u0026gt; (length string) 0)) (let ((first-char (substring string nil 1)) (rest-str (substring string 1))) (concat (capitalize first-char) rest-str)))) ;;;###autoload (defun my/lowcase-first-char (\u0026amp;optional string) \u0026#34;Capitalize only the first character of the input STRING.\u0026#34; (when (and string (\u0026gt; (length string) 0)) (let ((first-char (substring string nil 1)) (rest-str (substring string 1))) (concat first-char rest-str)))) ;;;###autoload (defun gcl/async-shell-command-silently (command) \u0026#34;async shell command silently.\u0026#34; (interactive) (let ((display-buffer-alist (list (cons \u0026#34;\\\\*Async Shell Command\\\\*.*\u0026#34; (cons #\u0026#39;display-buffer-no-window nil))))) (async-shell-command command)))      aj(AloisJanicek)  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  ;;;###autoload (defun aj-fix-buffer-file-name-for-indirect-buffers-a (orig-fn \u0026amp;rest args) \u0026#34;Advice for functions expecting `buffer-file-name\u0026#39;to work.\u0026#34; (let ((buffer-file-name buffer-file-truename)) (cl-letf (((symbol-function \u0026#39;buffer-file-name) (lambda (\u0026amp;optional buffer) \u0026#34;Return value of `buffer-file-truename\u0026#39;.\u0026#34; (with-current-buffer (or buffer (current-buffer)) buffer-file-truename)))) (apply orig-fn args)))) ;;;###autoload (defun aj-zeal-at-point-run-search-on-wsl-a (search) \u0026#34;Launch Windows Zeal from WSL emacs. Use `call-process\u0026#39;instead of `start-process\u0026#39;. Use in conjunction with https://github.com/Konfekt/wsl-gui-bins/blob/master/zeal \u0026#34; (call-process (executable-find \u0026#34;zeal\u0026#34;) nil 0 nil search))      org-mode  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  ;;;###autoload (defun gcl/indent-org-block-automatically () (interactive) (when (org-in-src-block-p) (org-edit-special) (indent-region (point-min) (point-max)) (org-edit-src-exit))) ;;;###autoload (defun aj-org-agenda-save-and-refresh-a (\u0026amp;rest _) \u0026#34;Save org files and refresh. Only org files contributing to `org-agenda\u0026#39;are saved. Refreshed are `org-agenda\u0026#39;org `org-ql-view\u0026#39;, depending on which one is currently active.\u0026#34; (org-save-all-org-buffers) (if (string-match \u0026#34;Org QL\u0026#34; (buffer-name)) (org-ql-view-refresh) (org-agenda-redo))) ;;;###autoload (defun aj-org-roam-setup-dailies-file-h () \u0026#34;Setup org-roam dailies file to my taste. Initialy create id inside top-level \\\u0026#34;:PROPERTIES:\\\u0026#34; drawer. Finally save buffer. \u0026#34; (let ((fname (or (buffer-file-name) (buffer-file-name (buffer-base-buffer)))) hstub) ;; Run this only when file is newly created (hasn\u0026#39;t been saved yet) (unless (file-exists-p fname) (org-id-get-create) (save-buffer)) (goto-char (point-max)) (newline) ;; prompt for HH:MM if we are not in present day file (if (string-equal (format-time-string \u0026#34;%Y-%m-%d\u0026#34;) (file-name-sans-extension (file-name-nondirectory (or (buffer-file-name) (buffer-file-name (buffer-base-buffer)))))) (setq hstub (format-time-string \u0026#34;* %H:%M \u0026#34; (current-time))) (setq hstub (concat \u0026#34;* \u0026#34; (ivy-read \u0026#34;Time of the day (HH:MM): \u0026#34; nil) \u0026#34; \u0026#34;))) (insert hstub) (evil-insert 0)))      quick-find  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  ;;;###autoload (defun dired-timesort (filename \u0026amp;optional wildcards) (let ((dired-listing-switches \u0026#34;-lhat\u0026#34;)) (dired filename wildcards))) ;;;###autoload (defmacro quick-find (key file \u0026amp;optional path find-args) `(bind-key ,key (cond ((stringp ,find-args) \u0026#39;(lambda (\u0026amp;optional arg) (interactive) (find-dired (expand-file-name ,file ,path) ,find-args))) ((and ;; (not (tramp-tramp-file-p (expand-file-name ,file ,path))) (or (file-directory-p (expand-file-name ,file ,path)) (not (file-exists-p (expand-file-name ,file ,path))))) \u0026#39;(lambda (\u0026amp;optional arg) (interactive) (dired-timesort (expand-file-name ,file ,path)))) (t \u0026#39;(lambda (\u0026amp;optional arg) (interactive) (find-file (expand-file-name ,file ,path)))))))      embrace  1 2 3 4 5 6 7 8 9  ;;;###autoload (defun gcl/embrace-prog-mode-hook () (dolist (lst \u0026#39;((?` \u0026#34;`\u0026#34; . \u0026#34;`\u0026#34;))) (embrace-add-pair (car lst) (cadr lst) (cddr lst)))) ;;;###autoload (defun gcl/embrace-org-mode-hook () (dolist (lst \u0026#39;((?c \u0026#34;@@html:\u0026lt;font color=\\\u0026#34;red\\\u0026#34;\u0026gt;\u0026#34; . \u0026#34;\u0026lt;/font\u0026gt;@@\u0026#34;))) (embrace-add-pair (car lst) (cadr lst) (cddr lst))))        Init.el  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198  ;;; init.el -*- lexical-binding: t; -*- (doom! :input ;;chinese ;;japanese ;;layout ; auie,ctsrnm is the superior home row :completion company ; the ultimate code completion backend ;;helm ; the *other* search engine for love and life ;;ido ; the other *other* search engine... (ivy ; a search engine for love and life +icons +prescient) :ui ;;deft ; notational velocity for Emacs doom ; what makes DOOM look the way it does doom-dashboard ; a nifty splash screen for Emacs doom-quit ; DOOM quit-message prompts when you quit Emacs (emoji +ascii +github) ; ğŸ™‚ fill-column ; a `fill-column\u0026#39; indicator hl-todo ; highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW hydra ;;indent-guides ; highlighted indent columns (ligatures ; ligatures and symbols to make your code pretty again +extra) ;;minimap ; show a map of the code on the side modeline ; snazzy, Atom-inspired modeline, plus API nav-flash ; blink cursor line after big motions ;;neotree ; a project drawer, like NERDTree for vim ophints ; highlight the region an operation acts on (popup +all +defaults) ; tame sudden yet inevitable temporary windows ;;tabs ; a tab bar for Emacs ;; (treemacs +lsp) ; a project drawer, like neotree but cooler ;; unicode ; extended unicode support for various languages vc-gutter ; vcs diff in the fringe vi-tilde-fringe ; fringe tildes to mark beyond EOB (window-select +numbers) ; visually switch windows workspaces ; tab emulation, persistence \u0026amp; separate workspaces ;;zen ; distraction-free coding or writing :editor (evil +everywhere); come to the dark side, we have cookies file-templates ; auto-snippets for empty files fold ; (nigh) universal code folding (format +onsave) ; automated prettiness ;;god ; run Emacs commands without modifier keys ;;lispy ; vim for lisp, for people who don\u0026#39;t like vim multiple-cursors ; editing in many places at once ;; objed ; text object editing for the innocent ;;parinfer ; turn lisp into python, sort of rotate-text ; cycle region at point between text candidates snippets ; my elves. They type so I don\u0026#39;t have to word-wrap ; soft wrapping with language-aware indent :emacs (dired +icons) ; making dired pretty [functional] electric ; smarter, keyword-based electric-indent (ibuffer +icons) ; interactive buffer management ;; (undo +tree) ; persistent, smarter undo for your inevitable mistakes vc ; version-control and Emacs, sitting in a tree :term ;;eshell ; the elisp shell that works everywhere ;;shell ; simple shell REPL for Emacs ;;term ; basic terminal emulator for Emacs vterm ; the best terminal emulation in Emacs :checkers syntax ; tasing you for every semicolon you forget ;; (:if (executable-find \u0026#34;aspell\u0026#34;) spell +flyspell) ; tasing you for misspelling mispelling grammar ; tasing grammar mistake every you make :tools ;;ansible ;;debugger ; FIXME stepping through code, to help you add bugs ;;direnv ;;docker editorconfig ; let someone else argue about tabs vs spaces ;;ein ; tame Jupyter notebooks with emacs (eval +overlay) ; run code, run (also, repls) ;;gist ; interacting with github gists (lookup ; navigate your code and its documentation +dictionary +docsets) (lsp +peek) (magit +forge) ; a git porcelain for Emacs make ; run make tasks from Emacs ;;pass ; password manager for nerds pdf ; pdf enhancements ;;prodigy ; FIXME managing external services \u0026amp; code builders rgb ; creating color strings ;;taskrunner ; taskrunner for all your projects ;;terraform ; infrastructure as code ;;tmux ; an API for interacting with tmux upload ; map local to remote projects via ssh/ftp :os (:if IS-MAC macos) ; improve compatibility with macOS tty ; improve the terminal Emacs experience :lang ;;agda ; types of types of types of types... ;;beancount ; mind the GAAP (cc +lsp) ; C \u0026gt; C++ == 1 ;;clojure ; java with a lisp ;;common-lisp ; if you\u0026#39;ve seen one lisp, you\u0026#39;ve seen them all ;;coq ; proofs-as-programs ;;crystal ; ruby at the speed of c ;;csharp ; unity, .NET, and mono shenanigans data ; config/data formats (dart +flutter +lsp) ; paint ui and not much else ;;elixir ; erlang done right ;;elm ; care for a cup of TEA? emacs-lisp ; drown in parentheses ;;erlang ; an elegant language for a more civilized age ;;ess ; emacs speaks statistics ;;factor ;;faust ; dsp, but you get to keep your soul ;;fsharp ; ML stands for Microsoft\u0026#39;s Language ;;fstar ; (dependent) types and (monadic) effects and Z3 ;;gdscript ; the language you waited for (go +lsp) ; the hipster dialect ;;(haskell +dante) ; a language that\u0026#39;s lazier than I am ;;hy ; readability of scheme w/ speed of python ;;idris ; a language you can depend on (json +lsp) ; At least it ain\u0026#39;t XML (java +meghanada +lsp) ; the poster child for carpal tunnel syndrome (javascript +lsp) ; all(hope(abandon(ye(who(enter(here)))))) ;;julia ; a better, faster MATLAB ;;kotlin ; a better, slicker Java(Script) (latex ; writing papers in Emacs has never been so fun +latexmk +cdlatex +lsp +fold) ;;lean ; for folks with too much to prove ;;ledger ; be audit you can be (lua +lsp) ; one-based indices? one-based indices markdown ; writing docs for people to ignore ;;nim ; python + lisp at the speed of c nix ; I hereby declare \u0026#34;nix geht mehr!\u0026#34; ;;ocaml ; an objective camel (org ; organize your plain life in plain text +attach +babel +capture +dragndrop +hugo ;; +jupyter +export +pandoc +gnuplot +pretty +present +protocol +pomodoro +roam2 +noter) (php +lsp) ; perl\u0026#39;s insecure younger brother plantuml ; diagrams for confusing people more ;;purescript ; javascript, but functional (python +lsp +pyright) ; beautiful is better than ugly ;;qt ; the \u0026#39;cutest\u0026#39; gui framework ever ;;racket ; a DSL for DSLs ;;raku ; the artist formerly known as perl6 rest ; Emacs as a REST client ;;rst ; ReST in peace (ruby +rails +lsp) ; 1.step {|i| p \u0026#34;Ruby is #{i.even? ? \u0026#39;love\u0026#39; : \u0026#39;life\u0026#39;}\u0026#34;} (rust +lsp) ; Fe2O3.unwrap().unwrap().unwrap().unwrap() ;;scala ; java, but good (scheme +guile) ; a fully conniving family of lisps (sh +lsp +powershell) ; she sells {ba,z,fi}sh shells on the C xor ;;sml ;;solidity ; do you need a blockchain? No. ;;swift ; who asked for emoji variables? ;;terra ; Earth and Moon in alignment for performance. (web +lsp) ; the tubes (yaml +lsp) ; JSON, but readable ;;zig ; C, but simpler :email (mu4e +gmail) ;;notmuch ;;(wanderlust +gmail) :app calendar emms everywhere ; *leave* Emacs!? You must be joking irc ; how neckbeards socialize (rss +org) ; emacs as an RSS reader ;;twitter ; twitter client https://twitter.com/vnought :config literate (default +bindings +smartparens))      Theme Settings  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  (setq doom-theme \u0026#39;doom-vibrant) ;; (setq doom-font (font-spec :family \u0026#34;JetBrains Mono\u0026#34; :size 16)) (setq doom-font (font-spec :family \u0026#34;Fira Code\u0026#34; :size 15)) ;; (setq doom-font (font-spec :family \u0026#34;Source Code Pro\u0026#34; :size 15)) ;; set title ;; (setq frame-title-format ;; \u0026#39;(\u0026#34;\u0026#34; ;; ;; (:eval ;; ;; (if (s-contains-p org-roam-directory (or buffer-file-name \u0026#34;\u0026#34;)) ;; ;; (replace-regexp-in-string ;; ;; \u0026#34;.*/[0-9]*-?\u0026#34; \u0026#34;â˜° \u0026#34; ;; ;; (subst-char-in-string ?_ ? buffer-file-name)) ;; ;; \u0026#34;%b\u0026#34;)) ;; (:eval ;; (let ((project-name (projectile-project-name))) ;; (unless (string= \u0026#34;-\u0026#34; project-name) ;; (format (if (buffer-modified-p) \u0026#34; â—‰ %s\u0026#34; \u0026#34; â—â€†%s\u0026#34;) project-name))))))      Basic Settings   auto generate code into config.el, init.el, packages.el, â€¦, and run `cp-config-org.sh`\n to bakup some of my private things.\n1 2 3 4 5 6 7 8 9 10 11  (doom-load-envvars-file \u0026#34;~/.doom.d/env\u0026#34; ) (defadvice! +literate-tangle-async-h () \u0026#34;A very simplified version of `+literate-tangle-h\u0026#39;, but async.\u0026#34; :override #\u0026#39;+literate-tangle-h (let ((default-directory doom-private-dir)) (gcl/async-shell-command-silently (format \u0026#34;emacs --batch --eval \\\u0026#34;(progn \\ (require \u0026#39;org) (setq org-confirm-babel-evaluate nil) \\ (org-babel-tangle-file \\\\\\\u0026#34;%s\\\\\\\u0026#34;))\\\u0026#34; \\ \u0026amp;\u0026amp; /bin/bash ~/.gclrc/bin/rsync-doom-config\u0026#34; +literate-config-file))))     private:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67  ;; å¯åŠ¨å…¨å± (add-to-list \u0026#39;initial-frame-alist \u0026#39;(fullscreen . maximized)) (add-hook \u0026#39;org-mode-hook \u0026#39;turn-on-auto-fill) ;; ä¸ªäººä¿¡æ¯é…ç½® (setq user-full-name \u0026#34;Zhicheng Lee\u0026#34; user-mail-address \u0026#34;gccll.love@gmail.com\u0026#34; user-blog-url \u0026#34;https://www.cheng92.com\u0026#34; read-process-output-max (* 1024 1024) display-line-numbers-type t ;; web, js, css css-indent-offset 2 js2-basic-offset 2 js-switch-indent-offset 2 js-indent-level 2 js2-mode-show-parse-errors nil js2-mode-show-strict-warnings nil web-mode-attr-indent-offset 2 web-mode-code-indent-offset 2 web-mode-css-indent-offset 2 web-mode-markup-indent-offset 2 web-mode-enable-current-element-highlight t web-mode-enable-current-column-highlight t ;; org org-roam-v2-ack t ; close v2 warning org-roam-directory \u0026#34;~/.gclrc/roam/\u0026#34; org-directory \u0026#34;~/.gclrc/org/\u0026#34; org-log-done \u0026#39;time ; having the time a item is done sounds convenient org-list-allow-alphabetical t ; have a. A. a) A) list bullets org-export-in-background t ; run export processes in external emacs process org-catch-invisible-edits \u0026#39;smart ; try not to accidently do weird stuff in invisible regions org-fontify-done-headline t ; å·²å®Œæˆçš„åŠ ä¸Šåˆ é™¤çº¿ ;; scroll behavior redisplay-dont-pause t scroll-margin 1 scroll-step 1 scroll-conservatively 10000 scroll-preserve-screen-position 1 ;; mouse wheel mouse-wheel-follow-mouse \u0026#39;t mouse-wheel-scroll-amount \u0026#39;(1 ((shift) . 1)) vc-log-view-type nil ;; mu4e +mu4e-backend \u0026#39;offlineimap ;; osx ;; browse-url-browser-function \u0026#39;browse-url-default-macosx-browser ) (setq-default fill-column 80 undo-limit 80000000 delete-by-moving-to-trash t window-combination-resize t delete-trailing-lines t x-stretch-cursor t typescript-indent-level 2 custom-file (expand-file-name \u0026#34;.custom.el\u0026#34; doom-private-dir)) (when (file-exists-p custom-file) (load custom-file))      Keybindings   Keybindings reference:\n evil-bindings.el\n editor/evil/config.el\nUnbindings  To Unbind\n1 2 3 4 5 6 7 8 9 10 11 12 13  (global-set-key (kbd \u0026#34;C-d\u0026#34;) nil) ; ns-print-buffer (global-set-key (kbd \u0026#34;s-p\u0026#34;) nil) ; ns-print-buffer (global-set-key (kbd \u0026#34;\u0026lt;f1\u0026gt;\u0026#34;) nil) ; ns-print-buffer (global-set-key (kbd \u0026#34;\u0026lt;f2\u0026gt;\u0026#34;) nil) ; ns-print-buffer (define-key evil-normal-state-map (kbd \u0026#34;,\u0026#34;) nil) (define-key evil-visual-state-map (kbd \u0026#34;,\u0026#34;) nil) ;; (global-set-key (kbd \u0026#34;,\u0026#34;) nil) (map! \u0026#34;C-e\u0026#34; nil :n \u0026#34;C-t\u0026#34; nil) ;; (undefine-key! \u0026#34;SPC :\u0026#34; \u0026#34;SPC ~\u0026#34; \u0026#34;SPC .\u0026#34; \u0026#34;SPC X\u0026#34; \u0026#34;C-c C-r\u0026#34; \u0026#34;,\u0026#34;) ;; (undefine-key! evil-normal-state-map \u0026#34;,\u0026#34;) (undefine-key! org-mode-map \u0026#34;C-c C-r\u0026#34;)      F1~12(kbd)  1 2 3 4 5 6 7 8 9  (global-set-key (kbd \u0026#34;\u0026lt;f1\u0026gt;\u0026#34;) \u0026#39;gcl-everything/body) (global-set-key (kbd \u0026#34;\u0026lt;f5\u0026gt;\u0026#34;) \u0026#39;deadgrep) (global-set-key (kbd \u0026#34;\u0026lt;M-f5\u0026gt;\u0026#34;) \u0026#39;deadgrep-kill-all-buffers) (global-set-key (kbd \u0026#34;\u0026lt;f8\u0026gt;\u0026#34;) \u0026#39;quickrun) (global-set-key (kbd \u0026#34;\u0026lt;f12\u0026gt;\u0026#34;) \u0026#39;smerge-vc-next-conflict) (global-set-key (kbd \u0026#34;\u0026lt;f11\u0026gt;\u0026#34;) \u0026#39;+vc/smerge-hydra/body) (global-set-key (kbd \u0026#34;C-t\u0026#34;) \u0026#39;+vterm/toggle) (global-set-key (kbd \u0026#34;C-S-t\u0026#34;) \u0026#39;+vterm/here) (global-set-key (kbd \u0026#34;C-d\u0026#34;) \u0026#39;kill-current-buffer)      Global  M(Option/Alt)  1 2 3 4 5 6 7 8 9  (map! ;; \u0026#34;M-1\u0026#34; #\u0026#39;bm-toggle ;; \u0026#34;M-2\u0026#34; #\u0026#39;bm-next ;; \u0026#34;M-@\u0026#34; #\u0026#39;bm-previous \u0026#34;M--\u0026#34; #\u0026#39;gcl/goto-match-paren \u0026#34;M-i\u0026#34; #\u0026#39;parrot-rotate-next-word-at-point \u0026#34;M-TAB\u0026#34; #\u0026#39;gcl-everything/body ;; \u0026#34;S-M-SPC\u0026#34; #\u0026#39;counsel-osx-app )      C(Control)  1 2 3 4 5 6 7  (map! :niv \u0026#34;C-e\u0026#34; #\u0026#39;evil-end-of-line :niv \u0026#34;C-=\u0026#34; #\u0026#39;er/expand-region \u0026#34;C-a\u0026#34; #\u0026#39;crux-move-beginning-of-line \u0026#34;C-s\u0026#34; #\u0026#39;+default/search-buffer )    C-c  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52  (map! ;; a -\u0026gt; applications, ... \u0026#34;C-c a\u0026#34; #\u0026#39;org-agenda ;; b -\u0026gt; bookmark, buffer ... \u0026#34;C-c b l\u0026#34; #\u0026#39;bm-show-all \u0026#34;C-c b s\u0026#34; #\u0026#39;bm-buffer-save ;; i -\u0026gt; date, time, ... \u0026#34;C-c i d\u0026#34; #\u0026#39;insert-current-date-time \u0026#34;C-c i t\u0026#34; #\u0026#39;insert-current-time ;; f -\u0026gt; file, directory, ... \u0026#34;C-c f o\u0026#34; #\u0026#39;crux-open-with ;; h -\u0026gt; help \u0026#34;C-c h d\u0026#34; #\u0026#39;dash-at-point \u0026#34;C-c h D\u0026#34; #\u0026#39;dash-at-point-with-docset ;; n -\u0026gt; network utils ;; \u0026#34;C-c n x\u0026#34; #\u0026#39;xxx ;; s -\u0026gt; search/engine ... ;; \u0026#34;C-c s r\u0026#34; ;; ... ;; s -\u0026gt; replace \u0026#34;C-c r r\u0026#34; #\u0026#39;vr/replace \u0026#34;C-c r q\u0026#34; #\u0026#39;vr/query-replace ;; u -\u0026gt; url, ... \u0026#34;C-c u u\u0026#34; #\u0026#39;crux-view-url \u0026#34;C-c u o\u0026#34; #\u0026#39;link-hint-open-link \u0026#34;C-c u c\u0026#34; #\u0026#39;link-hint-copy-link \u0026#34;C-c u a\u0026#34; #\u0026#39;link-hint-open-link-at-point \u0026#34;C-c u C\u0026#34; #\u0026#39;link-hint-copy-link-at-point ;; y -\u0026gt; youdao, ... \u0026#34;C-c y y\u0026#34; #\u0026#39;youdao-dictionary-search-at-point+ \u0026#34;C-c C-r C-r\u0026#34; #\u0026#39;verb-send-request-on-point-other-window-stay \u0026#34;C-c C-r C-s\u0026#34; #\u0026#39;verb-send-request-on-point-other-window \u0026#34;C-c C-r C-f\u0026#34; #\u0026#39;verb-send-request-on-point \u0026#34;C-c C-r C-m\u0026#34; #\u0026#39;verb-send-request-on-point-no-window \u0026#34;C-c C-r C-k\u0026#34; #\u0026#39;verb-kill-response-buffer-and-window \u0026#34;C-c C-r C-a\u0026#34; #\u0026#39;verb-kill-all-response-buffers \u0026#34;C-c C-r C-u\u0026#34; #\u0026#39;verb-export-request-on-point-curl \u0026#34;C-c C-r C-b\u0026#34; #\u0026#39;verb-export-request-on-point-verb \u0026#34;C-c C-r C-w\u0026#34; #\u0026#39;verb-export-request-on-point-eww \u0026#34;C-c C-r C-l\u0026#34; #\u0026#39;verb-show-vars ; æŸ¥çœ‹å·²å­˜åœ¨çš„å˜é‡å€¼åˆ—è¡¨ \u0026#34;C-c C-r C-v\u0026#34; #\u0026#39;verb-set-var )      C-x  1 2 3 4 5  (map! ;; \u0026#34;C-x p\u0026#34; #\u0026#39;vmd-mode ;; \u0026#34;C-x d\u0026#34; #\u0026#39;dash-at-point ;; \u0026#34;C-x D\u0026#34; #\u0026#39;dash-at-point-with-docset )        s(Command)  1 2 3 4 5 6 7 8 9 10 11 12 13  (map! \u0026#34;s-\u0026lt;\u0026#34; #\u0026#39;move-text-up \u0026#34;s-\u0026gt;\u0026#34; #\u0026#39;move-text-down ;; \u0026#34;s-\u0026#39;\u0026#34; #\u0026#39;cycle-quotes \u0026#34;s-i\u0026#34; #\u0026#39;gcl/string-inflection-cycle-auto ;; projector --- --- ;; \u0026#34;s-p b\u0026#34; #\u0026#39;projector-switch-to-shell-buffer ;; \u0026#34;s-p B\u0026#34; #\u0026#39;projector-run-shell-command-current-directory-background ;; \u0026#34;s-p c\u0026#34; #\u0026#39;projector-run-shell-command-current-directory ;; \u0026#34;s-p d\u0026#34; #\u0026#39;projector-run-default-shell-command ;; \u0026#34;s-p r\u0026#34; #\u0026#39;projector-run-shell-command-project-root ;; \u0026#34;s-p R\u0026#34; #\u0026#39;projector-rerun-buffer-process )      Evil  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  (evil-define-minor-mode-key \u0026#39;(normal motion) \u0026#39;evil-snipe-local-mode \u0026#34;s\u0026#34; #\u0026#39;avy-goto-char \u0026#34;S\u0026#34; #\u0026#39;avy-goto-char-2 \u0026#34;w\u0026#34; #\u0026#39;avy-goto-word-1 \u0026#34;W\u0026#34; #\u0026#39;avy-goto-word-0 ) (evil-define-key \u0026#39;(normal motion visual) map \u0026#34;s\u0026#34; #\u0026#39;avy-goto-char \u0026#34;S\u0026#34; #\u0026#39;avy-goto-char-2 \u0026#34;w\u0026#34; #\u0026#39;avy-goto-word-1 \u0026#34;W\u0026#34; #\u0026#39;avy-goto-word-0 ) (map! :n \u0026#34;+\u0026#34; #\u0026#39;evil-numbers/inc-at-pt :n \u0026#34;-\u0026#34; #\u0026#39;evil-numbers/dec-at-pt ;; g :n \u0026#34;g[\u0026#34; #\u0026#39;beginning-of-defun :n \u0026#34;g]\u0026#34; #\u0026#39;end-of-defun :n \u0026#34;gd\u0026#34; #\u0026#39;xref-find-definitions :n \u0026#34;gD\u0026#34; #\u0026#39;xref-find-references :n \u0026#34;gb\u0026#34; #\u0026#39;xref-pop-marker-stack ;; z :n \u0026#34;z-\u0026#34; #\u0026#39;sp-splice-sexp :n \u0026#34;z.\u0026#34; #\u0026#39;emmet-wrap-with-markup :n \u0026#34;gi\u0026#34; nil (:prefix (\u0026#34;gi\u0026#34; . \u0026#34;mine\u0026#34;) :n \u0026#34;f\u0026#34; #\u0026#39;+org/attach-file-and-insert-link) :nv \u0026#34;,\u0026#34; nil (:prefix (\u0026#34;,\u0026#34; . \u0026#34;gccll\u0026#34;) :nv \u0026#34;`\u0026#34; #\u0026#39;gcl-everything/body ;; embrace (:prefix (\u0026#34;e\u0026#34; . \u0026#34;embrace\u0026#34;) :n \u0026#34;a\u0026#34; #\u0026#39;embrace-add :n \u0026#34;c\u0026#34; #\u0026#39;embrace-change :n \u0026#34;d\u0026#34; #\u0026#39;embrace-delete ) ) ) ;; remap gs-\u0026gt; keybinding (map! :after evil-easymotion :map evilem-map \u0026#34;c\u0026#34; #\u0026#39;avy-goto-char \u0026#34;C\u0026#34; #\u0026#39;avy-goto-char-2 \u0026#34;w\u0026#34; #\u0026#39;avy-goto-word-1 \u0026#34;W\u0026#34; #\u0026#39;avy-goto-word-0 \u0026#34;ll\u0026#34; #\u0026#39;avy-goto-line \u0026#34;lu\u0026#34; #\u0026#39;avy-goto-line-above \u0026#34;ld\u0026#34; #\u0026#39;avy-goto-line-below )      SPC  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  (map! :leader :nv \u0026#34;SPC\u0026#34; #\u0026#39;execute-extended-command (:prefix (\u0026#34;a\u0026#34; . \u0026#34;Applications\u0026#34;) :n \u0026#34;e\u0026#34; #\u0026#39;emms :n \u0026#34;E\u0026#34; #\u0026#39;emms-smart-browse ) ;; b -\u0026gt; Buffer :n \u0026#34;bf\u0026#34; #\u0026#39;osx-lib-reveal-in-finder ;; f -\u0026gt; File :n \u0026#34;fo\u0026#34; #\u0026#39;crux-open-with :n \u0026#34;fj\u0026#34; #\u0026#39;dired-jump ;; d -\u0026gt; directory :n \u0026#34;dd\u0026#34; #\u0026#39;deft ;; d -\u0026gt; edit :n \u0026#34;es\u0026#34; #\u0026#39;sudo-edit ;; i -\u0026gt; Insert, Imenu :n \u0026#34;ia\u0026#34; #\u0026#39;+org/attach-file-and-insert-link :n \u0026#34;im\u0026#34; #\u0026#39;imenu-list :n \u0026#34;iM\u0026#34; #\u0026#39;lsp-ui-imenu ;; l -\u0026gt; load, ... :n \u0026#34;lr\u0026#34; #\u0026#39;ranger :n \u0026#34;ld\u0026#34; #\u0026#39;dired ;; r -\u0026gt; Run ;; :n \u0026#34;rp\u0026#34; #\u0026#39;projector-run-shell-command-project-root ;; :n \u0026#34;rP\u0026#34; #\u0026#39;projector-run-default-shell-command ;; s -\u0026gt; search ? (:map (scss-mode-map css-mode-map) :n \u0026#34;si\u0026#34; #\u0026#39;counsel-css ) ;; / -\u0026gt; Search ;; :n \u0026#34;/r\u0026#34; #\u0026#39;deadgrep )        Org-mode  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  (map! :map org-mode-map (:prefix \u0026#34;t\u0026#34; :n \u0026#34;t\u0026#34; #\u0026#39;org-todo :n \u0026#34;T\u0026#34; #\u0026#39;counsel-org-tag (:prefix (\u0026#34;c\u0026#34; . \u0026#34;checkbox\u0026#34;) :n \u0026#34;c\u0026#34; #\u0026#39;org-toggle-checkbox :n \u0026#34;u\u0026#34; #\u0026#39;org-update-checkbox-count ) (:prefix (\u0026#34;p\u0026#34; . \u0026#34;priority\u0026#34;) :n \u0026#34;p\u0026#34; #\u0026#39;org-priority :n \u0026#34;u\u0026#34; #\u0026#39;org-priority-up :n \u0026#34;d\u0026#34; #\u0026#39;org-priority-down )) (:prefix \u0026#34;C-c\u0026#34; (:prefix ( \u0026#34;d\u0026#34; . \u0026#34;Do\u0026#34; ) \u0026#34;f\u0026#34; #\u0026#39;gcl/indent-org-block-automatically ) (:prefix (\u0026#34;e\u0026#34; . \u0026#34;Emoji\u0026#34;) \u0026#34;e\u0026#34; #\u0026#39;all-the-icons-insert \u0026#34;a\u0026#34; #\u0026#39;all-the-icons-insert-faicon \u0026#34;f\u0026#34; #\u0026#39;all-the-icons-insert-fileicon \u0026#34;w\u0026#34; #\u0026#39;all-the-icons-insert-wicon \u0026#34;o\u0026#34; #\u0026#39;all-the-icons-insert-octicon \u0026#34;m\u0026#34; #\u0026#39;all-the-icons-insert-material \u0026#34;i\u0026#34; #\u0026#39;all-the-icons-insert-alltheicon ) (:prefix (\u0026#34;c\u0026#34; . \u0026#34;Org Clock\u0026#34;) \u0026#34;i\u0026#34; #\u0026#39;org-clock-in \u0026#34;o\u0026#34; #\u0026#39;org-clock-out \u0026#34;h\u0026#34; #\u0026#39;counsel-org-clock-history \u0026#34;g\u0026#34; #\u0026#39;counsel-org-clock-goto \u0026#34;c\u0026#34; #\u0026#39;counsel-org-clock-context \u0026#34;r\u0026#34; #\u0026#39;counsel-org-clock-rebuild-history ) (:prefix (\u0026#34;i\u0026#34; . \u0026#34;Insert\u0026#34;) \u0026#34;u\u0026#34; #\u0026#39;org-mac-chrome-insert-frontmost-url \u0026#34;c\u0026#34; #\u0026#39;copyright ) ;; org-roam, C-c r \u0026lt;x\u0026gt; (:prefix (\u0026#34;C-r\u0026#34; . \u0026#34;Verb\u0026#34;) \u0026#34;C-r\u0026#34; #\u0026#39;verb-send-request-on-point-other-window-stay \u0026#34;C-s\u0026#34; #\u0026#39;verb-send-request-on-point-other-window \u0026#34;C-f\u0026#34; #\u0026#39;verb-send-request-on-point \u0026#34;C-m\u0026#34; #\u0026#39;verb-send-request-on-point-no-window \u0026#34;C-k\u0026#34; #\u0026#39;verb-kill-response-buffer-and-window \u0026#34;C-a\u0026#34; #\u0026#39;verb-kill-all-response-buffers \u0026#34;C-u\u0026#34; #\u0026#39;verb-export-request-on-point-curl \u0026#34;C-b\u0026#34; #\u0026#39;verb-export-request-on-point-verb \u0026#34;C-w\u0026#34; #\u0026#39;verb-export-request-on-point-eww \u0026#34;C-l\u0026#34; #\u0026#39;verb-show-vars ; æŸ¥çœ‹å·²å­˜åœ¨çš„å˜é‡å€¼åˆ—è¡¨ ) ) )      Web-mode   QuickFind  1 2 3 4  (quick-find \u0026#34;C-h C-x C-s\u0026#34; \u0026#34;~/.ssh/config\u0026#34;) (quick-find \u0026#34;C-h C-x C-z\u0026#34; \u0026#34;~/.zshrc\u0026#34;) (quick-find \u0026#34;C-h C-x C-d\u0026#34; \u0026#34;~/.gclrc/org/todo.org\u0026#34;) (quick-find \u0026#34;C-h C-x C-o\u0026#34; \u0026#34;~/.offlineimaprc\u0026#34;)        Package Settings  Autoinsert  1 2 3  (use-package! autoinsert :hook (find-file . auto-insert))      Avy  1 2 3 4 5 6  (global-set-key (kbd \u0026#34;M-g f\u0026#34;) \u0026#39;avy-goto-line) (global-set-key (kbd \u0026#34;M-g w\u0026#34;) \u0026#39;avy-goto-word-1) (after! avy ;; home row priorities: 8 6 4 5 - - 1 2 3 7 (setq avy-keys \u0026#39;(?n ?e ?i ?s ?t ?r ?i ?a)))      Bm, bookmark  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  (use-package! bm :bind (\u0026#34;M-1\u0026#34; . bm-toggle) (\u0026#34;M-2\u0026#34; . bm-next) (\u0026#34;M-@\u0026#34; . bm-previous) :custom (bm-cycle-all-buffers t) :config (add-hook \u0026#39;after-init-hook \u0026#39;bm-repository-load) (add-hook \u0026#39;kill-buffer-hook #\u0026#39;bm-buffer-save) (add-hook \u0026#39;kill-emacs-hook #\u0026#39;(lambda nil (bm-buffer-save-all) (bm-repository-save))) (add-hook \u0026#39;after-save-hook #\u0026#39;bm-buffer-save) (add-hook \u0026#39;find-file-hooks #\u0026#39;bm-buffer-restore) (add-hook \u0026#39;after-revert-hook #\u0026#39;bm-buffer-restore) (setq bm-repository-file \u0026#34;~/.doom.d/bm-repository\u0026#34;) (setq-default bm-buffer-persistence t) )      Color-rg  1 2 3 4 5 6 7  (use-package! color-rg :commands (color-rg-search-input color-rg-search-symbol color-rg-search-input-in-project) :bind (:map isearch-mode-map (\u0026#34;M-s M-s\u0026#34; . isearch-toggle-color-rg)))      Company  1 2 3 4  (after! company (setq company-idle-delay 0.5 company-minimum-prefix-length 2) (add-hook \u0026#39;evil-normal-state-entry-hook #\u0026#39;company-abort)) ;; make aborting less annoying.      Counsel-osx-app  1 2 3 4 5 6 7 8 9 10 11  (use-package! counsel-osx-app :bind* (\u0026#34;S-M-SPC\u0026#34; . counsel-osx-app) :commands counsel-osx-app :config (setq counsel-osx-app-location (list \u0026#34;/Applications\u0026#34; \u0026#34;/Applications/Misc\u0026#34; \u0026#34;/Applications/Utilities\u0026#34; (expand-file-name \u0026#34;~/Applications\u0026#34;) (expand-file-name \u0026#34;~/.nix-profile/Applications\u0026#34;) \u0026#34;/Applications/Xcode.app/Contents/Applications\u0026#34;)))      Cycle-quotes  1 2 3  (use-package! cycle-quotes :bind (\u0026#34;s-\u0026#39;\u0026#34; . cycle-quotes))      EAF  1 2 3 4 5 6  ;; (use-package! eaf ;; :commands (eaf-open-browser eaf-open find-file) ;; :config ;; (use-package! ctable) ;; (use-package! deferred) ;; (use-package! epc))      Emacs-everywhere  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  (use-package! emacs-everywhere :if (daemonp) :config (require \u0026#39;spell-fu) (setq emacs-everywhere-major-mode-function #\u0026#39;org-mode emacs-everywhere-frame-name-format \u0026#34;Edit âˆ· %s â€” %s\u0026#34;) (defadvice! emacs-everywhere-raise-frame () :after #\u0026#39;emacs-everywhere-set-frame-name (setq emacs-everywhere-frame-name (format emacs-everywhere-frame-name-format (emacs-everywhere-app-class emacs-everywhere-current-app) (truncate-string-to-width (emacs-everywhere-app-title emacs-everywhere-current-app) 45 nil nil \u0026#34;â€¦\u0026#34;))) ;; need to wait till frame refresh happen before really set (run-with-timer 0.1 nil #\u0026#39;emacs-everywhere-raise-frame-1)) (defun emacs-everywhere-raise-frame-1 () (call-process \u0026#34;wmctrl\u0026#34; nil nil nil \u0026#34;-a\u0026#34; emacs-everywhere-frame-name)))      Embrace  1 2  (add-hook \u0026#39;org-mode-hook \u0026#39;gcl/embrace-org-mode-hook) (add-hook \u0026#39;prog-mode-hook \u0026#39;gcl/embrace-prog-mode-hook)      Engine-mode  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  (use-package! engine-mode :config (engine/set-keymap-prefix (kbd \u0026#34;C-c s\u0026#34;)) ;; (setq engine/browser-function \u0026#39;eww-browse-url) (defengine amazon \u0026#34;http://www.amazon.com/s/ref=nb_sb_noss?url=search-alias%3Daps\u0026amp;field-keywords=%s\u0026#34; :keybinding \u0026#34;a\u0026#34;) (defengine baidu \u0026#34;https://www.baidu.com/s?wd=%s\u0026#34; :keybinding \u0026#34;bb\u0026#34;) (defengine baidu-image \u0026#34;https://image.baidu.com/search/index?tn=baiduimage\u0026amp;word=%s\u0026#34; :keybinding \u0026#34;bi\u0026#34;) (defengine ctan \u0026#34;http://www.ctan.org/search/?x=1\u0026amp;PORTAL=on\u0026amp;phrase=%s\u0026#34; :docstring \u0026#34;Search the Comprehensive TeX Archive Network (ctan.org)\u0026#34; :keybinding \u0026#34;c\u0026#34;) (defengine duckduckgo \u0026#34;https://duckduckgo.com/?q=%s\u0026#34; :keybinding \u0026#34;d\u0026#34;) (defengine github \u0026#34;https://github.com/search?ref=simplesearch\u0026amp;q=%s\u0026#34; :keybinding \u0026#34;g\u0026#34;) (defengine qwant \u0026#34;https://www.qwant.com/?q=%s\u0026#34; :docstring \u0026#34;ä»€ä¹ˆéƒ½èƒ½æœåˆ°å“¦~~ğŸ˜ğŸ˜\u0026#34; :keybinding \u0026#34;q\u0026#34;) (defengine rfcs \u0026#34;http://pretty-rfc.herokuapp.com/search?q=%s\u0026#34; :keybinding \u0026#34;r\u0026#34;) (defengine stack-overflow \u0026#34;https://stackoverflow.com/search?q=%s\u0026#34; :keybinding \u0026#34;s\u0026#34;) (defengine twitter \u0026#34;https://twitter.com/search?q=%s\u0026#34; :keybinding \u0026#34;t\u0026#34;) (defengine wolfram-alpha \u0026#34;http://www.wolframalpha.com/input/?i=%s\u0026#34; :docstring \u0026#34;æ•°å­¦æœç´¢å¼•æ“ï¼Œå…¬å¼ï¼Œåæ ‡å›¾ç­‰ã€‚\u0026#34; :keybinding \u0026#34;w\u0026#34;) ; æ•°å­¦æœç´¢å¼•æ“ï¼Œå…¬å¼ï¼Œåæ ‡å›¾ç­‰ (defengine youtube \u0026#34;http://www.youtube.com/results?aq=f\u0026amp;oq=\u0026amp;search_query=%s\u0026#34; :keybinding \u0026#34;y\u0026#34;) (defengine google-images \u0026#34;http://www.google.com/images?hl=en\u0026amp;source=hp\u0026amp;biw=1440\u0026amp;bih=795\u0026amp;gbv=2\u0026amp;aq=f\u0026amp;aqi=\u0026amp;aql=\u0026amp;oq=\u0026amp;q=%s\u0026#34; :keybinding \u0026#34;/i\u0026#34;) (defengine google-maps \u0026#34;http://maps.google.com/maps?q=%s\u0026#34; :docstring \u0026#34;Mappin\u0026#39; it up.\u0026#34; :keybinding \u0026#34;/m\u0026#34;) (defengine google \u0026#34;http://www.google.com/search?ie=utf-8\u0026amp;oe=utf-8\u0026amp;q=%s\u0026#34; :keybinding \u0026#34;//\u0026#34;) (engine-mode 1))      Dash-at-point  1 2 3 4  (use-package! dash-at-point :bind ((\u0026#34;C-x d\u0026#34; . dash-at-point) (\u0026#34;C-x D\u0026#34; . dash-at-point-with-docset)))      Deadgrep   æ­£åˆ™æœç´¢è¦åœ¨æœç´¢çš„ç»“æœä¸­ï¼Œé€‰ä¸­ regexp æ¥ç­›é€‰ã€‚\n æŒ‰é”®ç»‘å®šï¼š\n   key func     \u0026lt;f5\u0026gt; deadgrep   M-\u0026lt;f5\u0026gt; deadgrep-kill-all-buffers     RET æŸ¥çœ‹ç»“æœ   o åœ¨å¦ä¸€ä¸ªçª—å£æ‰“å¼€   n/p ç»“æœä¸­ä¸Šä¸‹ç§»åŠ¨   M-n/M-p æ–‡ä»¶å¤´å°¾ä¹‹é—´ç§»åŠ¨   g é‡æ–°æœç´¢   TAB å±•å¼€/é—­åˆç»“æœ   C-c C-k åœæ­¢æ­£åœ¨æ‰§è¡Œçš„æœç´¢      Delsel  1 2 3  (use-package! delsel :config (delete-selection-mode t))      Dotenv-mode  1 2  (use-package! dotenv-mode :mode (\u0026#34;\\\\.env\\\\.?.*\\\\\u0026#39;\u0026#34; . dotenv-mode))      Emoji  â€¦\n  Evil  1 2 3 4 5 6 7 8 9 10 11 12  ;; (defalias \u0026#39;ex! \u0026#39;evil-ex-define-cmd) ;; å¿«æ·æ“ä½œï¼Œé€šè¿‡ : å†’å·è¿›å…¥ evil å‘½ä»¤æ¨¡å¼ ;; File operations ;; (ex! \u0026#34;cp\u0026#34; #\u0026#39;+evil:copy-this-file) ;; (ex! \u0026#34;mv\u0026#34; #\u0026#39;+evil:move-this-file) ;; (ex! \u0026#34;rm\u0026#34; #\u0026#39;+evil:delete-this-file) ;; window æ“ä½œ (setq evil-split-window-below t evil-vsplit-window-right t)      Flycheck   ä½¿ç”¨é¡¹ç›®æœ¬èº«çš„ eslint, node_modules/.bin/eslint\n1 2 3 4  (use-package! flycheck :config (add-hook \u0026#39;after-init-hook \u0026#39;global-flycheck-mode) (add-hook \u0026#39;flycheck-mode-hook \u0026#39;gcl/use-eslint-from-node-modules))      (Ma)git  1 2 3  (use-package! git-gutter :config (global-git-gutter-mode \u0026#39;t))      Hungry-delete  1 2 3 4  (use-package! hungry-delete :config (add-hook! \u0026#39;after-init-hook #\u0026#39;global-hungry-delete-mode) (global-hungry-delete-mode 1))      Hydra   scimax-hydra.el\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  (map! :map dired-mode-map \u0026#34;\u0026lt;f2\u0026gt;\u0026#34; #\u0026#39;gcl-dired/body :map ranger-mode-map \u0026#34;\u0026lt;f2\u0026gt;\u0026#34; #\u0026#39;gcl-dired/body :map org-agenda-mode-map \u0026#34;\u0026lt;f2\u0026gt;\u0026#34; #\u0026#39;gcl-agenda-view/body :map web-mode-map \u0026#34;\u0026lt;f2\u0026gt;\u0026#34; #\u0026#39;hydra-web-mode/body ) (defhydra gcl-jump-hydra (:color blue :columns 3 :hint nil) \u0026#34;Jump -\u0026gt; Body\u0026#34; (\u0026#34;a\u0026#34; gcl-agenda-view/body \u0026#34;Org-Agenda\u0026#34;) (\u0026#34;c\u0026#34; gcl-jump-char/body \u0026#34;Char Jump\u0026#34;) (\u0026#34;l\u0026#34; gcl-jump-line/body \u0026#34;Line Jump\u0026#34;) (\u0026#34;w\u0026#34; gcl-jump-word/body \u0026#34;Word Jump\u0026#34;) ) (defhydra gcl-repl-hydra (:color blue :columns 3 :hint nil) \u0026#34;REPL ï¡\u0026#34; (\u0026#34;e\u0026#34; ielm \u0026#34;î¤¦ ELisp\u0026#34;) (\u0026#34;h\u0026#34; httprepl \u0026#34;îŒ¨ HTTP\u0026#34;) (\u0026#34;j\u0026#34; jq-interactivly \u0026#34;î¥˜ JSON\u0026#34;) (\u0026#34;l\u0026#34; +lua/open-repl \u0026#34;î¤› Lua\u0026#34;) (\u0026#34;n\u0026#34; nodejs-repl \u0026#34;î¤¥ Node.js\u0026#34;) (\u0026#34;p\u0026#34; +python/open-repl \u0026#34;î¤¨ Python\u0026#34;) (\u0026#34;s\u0026#34; skewer-repl \u0026#34;î¤† Skewer\u0026#34;) ) (defhydra gcl-everything (:color blue :columns 3 :hint nil) \u0026#34;ğŸ—¯ åšä»»ä½•ä½ æƒ³ä¸åˆ°çš„äº‹æƒ…~~~~ ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘ ğŸŒ»\u0026#34; (\u0026#34;j\u0026#34; gcl-jump-hydra/body \u0026#34;Avy\u0026#34;) (\u0026#34;r\u0026#34; gcl-repl-hydra/body \u0026#34;REPL\u0026#34;) (\u0026#34;v\u0026#34; gcl-verb-hydra/body \u0026#34;Verb\u0026#34;) )    Avy   Char:\n1 2 3 4 5 6 7 8 9  (defhydra gcl-jump-char (:color blue :columns 3 :hint nil) \u0026#34;Jump By Char -\u0026gt;\u0026#34; (\u0026#34;c\u0026#34; avy-goto-char \u0026#34;Char\u0026#34;) (\u0026#34;l\u0026#34; avy-goto-char-in-line \u0026#34;In line\u0026#34;) (\u0026#34;t\u0026#34; avy-goto-char-timer \u0026#34;Timer\u0026#34;) (\u0026#34;2\u0026#34; avy-goto-char-2 \u0026#34;Char2\u0026#34;) (\u0026#34;a\u0026#34; avy-goto-char-2-above \u0026#34;Above\u0026#34;) (\u0026#34;b\u0026#34; avy-goto-char-2-below \u0026#34;Below\u0026#34;) )     Line:\n1 2 3 4 5 6 7  (defhydra gcl-jump-line (:color blue :columns 3 :hint nil) \u0026#34;Jump To Line -\u0026gt;\u0026#34; (\u0026#34;u\u0026#34; avy-goto-line-above \u0026#34;Above\u0026#34;) (\u0026#34;d\u0026#34; avy-goto-line-below \u0026#34;Below\u0026#34;) (\u0026#34;s\u0026#34; avy-goto-line \u0026#34;Line Start\u0026#34;) (\u0026#34;e\u0026#34; avy-goto-end-of-line \u0026#34;Line End\u0026#34;) )     Word:\n1 2 3 4 5 6 7 8 9 10 11 12 13  (defhydra gcl-jump-word (:color blue :columns 3 :hint nil) \u0026#34;Jump By Word -\u0026gt;\u0026#34; (\u0026#34;l\u0026#34; avy-jump-to-word-in-line \u0026#34;in line\u0026#34;) (\u0026#34;w\u0026#34; avy-goto-word-1 \u0026#34;word1\u0026#34;) (\u0026#34;0\u0026#34; avy-goto-word-0 \u0026#34;word0\u0026#34;) (\u0026#34;a\u0026#34; avy-goto-word-0-above \u0026#34;above-0\u0026#34;) (\u0026#34;A\u0026#34; avy-goto-word-1-above \u0026#34;above-1\u0026#34;) (\u0026#34;b\u0026#34; avy-goto-word-0-below \u0026#34;below0\u0026#34;) (\u0026#34;B\u0026#34; avy-goto-word-1-below \u0026#34;below1\u0026#34;) (\u0026#34;o\u0026#34; avy-goto-word-or-subword-1 \u0026#34;word or subword\u0026#34;) (\u0026#34;s\u0026#34; avy-subword-0 \u0026#34;subword-0\u0026#34;) (\u0026#34;S\u0026#34; avy-subword-1 \u0026#34;subword-1\u0026#34;) )      Dired  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53  (defhydra gcl-dired (:color blue :hint nil) \u0026#34; Mark Operate Misc Navigate ---- ------- ---- -------- _fd_: flag del _C_: copy _+_: mkdir _\u0026lt;up\u0026gt;_: up directory _f#_: autosave _R_: rename _o_: open other _f~_: backups _D_: delete _f\u0026amp;_: garbage _F_: open marks _fe_: extension ---- _m_: mark _T_: touch _/_: directories _M_: chmod _@_: symlinks _G_: chgrp _O_: omitted _O_: chown ---- _U_: unmark all _A_: find regx _t_: toggle marks _Q_: find/rep \u0026#34; ;; marking (\u0026#34;t\u0026#34; dired-toggle-marks) (\u0026#34;m\u0026#34; dired-mark :exit nil) (\u0026#34;u\u0026#34; dired-unmark :exit nil) (\u0026#34;fd\u0026#34; dired-flag-file-deletion) (\u0026#34;f#\u0026#34; dired-flag-auto-save-files) (\u0026#34;f~\u0026#34; dired-flag-backup-files) (\u0026#34;f\u0026amp;\u0026#34; dired-flag-garbage-files) (\u0026#34;fe\u0026#34; dired-flag-extension) (\u0026#34;/\u0026#34; dired-mark-directories) (\u0026#34;@\u0026#34; dired-mark-symlinks) (\u0026#34;.\u0026#34; dired-mark-extension) (\u0026#34;O\u0026#34; dired-mark-omitted) (\u0026#34;U\u0026#34; dired-unmark-all-marks) (\u0026#34;C\u0026#34; dired-do-copy) (\u0026#34;R\u0026#34; dired-do-rename) (\u0026#34;D\u0026#34; dired-do-delete :exit nil) (\u0026#34;F\u0026#34; dired-do-find-marked-files) (\u0026#34;!\u0026#34; dired-do-shell-command) (\u0026#34;\u0026amp;\u0026#34; dired-do-async-shell-command) (\u0026#34;T\u0026#34; dired-do-touch) (\u0026#34;M\u0026#34; dired-do-chmod) (\u0026#34;G\u0026#34; dired-do-chgrp) (\u0026#34;O\u0026#34; dired-do-chown) (\u0026#34;A\u0026#34; dired-do-find-regexp) (\u0026#34;Q\u0026#34; dired-do-find-regexp-and-replace) (\u0026#34;+\u0026#34; dired-create-directory) (\u0026#34;o\u0026#34; dired-find-file-other-window) (\u0026#34;\u0026lt;up\u0026gt;\u0026#34; dired-up-directory) )      Movement  1 2 3 4 5  (defhydra hydra-movement () (\u0026#34;j\u0026#34; next-line \u0026#34;down\u0026#34; :column \u0026#34;Vertical\u0026#34;) (\u0026#34;k\u0026#34; previous-line \u0026#34;up\u0026#34;) (\u0026#34;l\u0026#34; forward-char \u0026#34;forward\u0026#34; :column \u0026#34;Horizontal\u0026#34;) (\u0026#34;h\u0026#34; backward-char \u0026#34;back\u0026#34;))      Org-agenda  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  (defun org-agenda-cts () (and (eq major-mode \u0026#39;org-agenda-mode) (let ((args (get-text-property (min (1- (point-max)) (point)) \u0026#39;org-last-args))) (nth 2 args)))) (defhydra gcl-agenda-view (:color blue :columns 3 :hint none) \u0026#34; _d_: ?d? day _g_: time grid=?g? _a_: arch-trees _w_: ?w? week _[_: inactive _A_: arch-files _t_: ?t? fortnight _f_: follow=?f? _r_: clock report=?r? _m_: ?m? month _e_: entry text=?e? _D_: include diary=?D? _y_: ?y? year _q_: quit _L__l__c_: log = ?l?\u0026#34; (\u0026#34;SPC\u0026#34; org-agenda-reset-view) (\u0026#34;d\u0026#34; org-agenda-day-view (if (eq \u0026#39;day (org-agenda-cts)) \u0026#34;[x]\u0026#34; \u0026#34;[ ]\u0026#34;)) (\u0026#34;w\u0026#34; org-agenda-week-view (if (eq \u0026#39;week (org-agenda-cts)) \u0026#34;[x]\u0026#34; \u0026#34;[ ]\u0026#34;)) (\u0026#34;t\u0026#34; org-agenda-fortnight-view (if (eq \u0026#39;fortnight (org-agenda-cts)) \u0026#34;[x]\u0026#34; \u0026#34;[ ]\u0026#34;)) (\u0026#34;m\u0026#34; org-agenda-month-view (if (eq \u0026#39;month (org-agenda-cts)) \u0026#34;[x]\u0026#34; \u0026#34;[ ]\u0026#34;)) (\u0026#34;y\u0026#34; org-agenda-year-view (if (eq \u0026#39;year (org-agenda-cts)) \u0026#34;[x]\u0026#34; \u0026#34;[ ]\u0026#34;)) (\u0026#34;l\u0026#34; org-agenda-log-mode (format \u0026#34;% -3S\u0026#34; org-agenda-show-log)) (\u0026#34;L\u0026#34; (org-agenda-log-mode \u0026#39;(4))) (\u0026#34;c\u0026#34; (org-agenda-log-mode \u0026#39;clockcheck)) (\u0026#34;f\u0026#34; org-agenda-follow-mode (format \u0026#34;% -3S\u0026#34; org-agenda-follow-mode)) (\u0026#34;a\u0026#34; org-agenda-archives-mode) (\u0026#34;A\u0026#34; (org-agenda-archives-mode \u0026#39;files)) (\u0026#34;r\u0026#34; org-agenda-clockreport-mode (format \u0026#34;% -3S\u0026#34; org-agenda-clockreport-mode)) (\u0026#34;e\u0026#34; org-agenda-entry-text-mode (format \u0026#34;% -3S\u0026#34; org-agenda-entry-text-mode)) (\u0026#34;g\u0026#34; org-agenda-toggle-time-grid (format \u0026#34;% -3S\u0026#34; org-agenda-use-time-grid)) (\u0026#34;D\u0026#34; org-agenda-toggle-diary (format \u0026#34;% -3S\u0026#34; org-agenda-include-diary)) (\u0026#34;!\u0026#34; org-agenda-toggle-deadlines) (\u0026#34;[\u0026#34; (let ((org-agenda-include-inactive-timestamps t)) (org-agenda-check-type t \u0026#39;timeline \u0026#39;agenda) (org-agenda-redo) (message \u0026#34;Display now includes inactive timestamps as well\u0026#34;))) (\u0026#34;q\u0026#34; (message \u0026#34;Abort\u0026#34;) :exit t) (\u0026#34;v\u0026#34; nil) )      Verb  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  (defhydra gcl-verb-hydra (:colors yellow :columns 3 :hint nil) (\u0026#34;r\u0026#34; verb-send-request-on-point-other-window-stay \u0026#34;Send Focus\u0026#34;) (\u0026#34;s\u0026#34; verb-send-request-on-point-other-window \u0026#34;Send Blur\u0026#34;) (\u0026#34;f\u0026#34; verb-send-request-on-point \u0026#34;Fullscreen\u0026#34;) (\u0026#34;m\u0026#34; verb-send-request-on-point-no-window \u0026#34;No Window\u0026#34;) (\u0026#34;K\u0026#34; verb-kill-all-response-buffers \u0026#34;Kill All\u0026#34;) (\u0026#34;vl\u0026#34; verb-show-vars \u0026#34;Show Vars\u0026#34;) (\u0026#34;vl\u0026#34; verb-set-var \u0026#34;Set Var\u0026#34;) (\u0026#34;vu\u0026#34; verb-unset-vars \u0026#34;Unset Vars\u0026#34;) (\u0026#34;ec\u0026#34; verb-export-request-on-point-curl \u0026#34;Export Curl\u0026#34;) (\u0026#34;ev\u0026#34; verb-export-request-on-point-verb \u0026#34;Export Verb\u0026#34;) (\u0026#34;ew\u0026#34; verb-export-request-on-point-verb \u0026#34;Export EWW\u0026#34;) )        Imenu  1  (global-set-key (kbd \u0026#34;C-\u0026#39;\u0026#34;) \u0026#39;imenu-list-smart-toggle)      JS Doc  1 2 3 4 5 6 7 8 9  (use-package! js-doc :bind (:map js2-mode-map (\u0026#34;C-c i\u0026#34; . js-doc-insert-function-doc) (\u0026#34;@\u0026#34; . js-doc-insert-tag)) :config (setq js-doc-mail-address user-mail-address js-doc-author (format \u0026#34;%s\u0026lt;%s\u0026gt;\u0026#34; user-full-name js-doc-mail-address) js-doc-url user-blog-url js-doc-license \u0026#34;MIT\u0026#34;))      Leetcode  1 2 3 4 5  (after! leetcode (setq leetcode-prefer-language \u0026#34;javascript\u0026#34; leetcode-prefer-sql \u0026#34;mysql\u0026#34; leetcode-save-solutions t leetcode-directory \u0026#34;~/github/make-leetcode\u0026#34;))      Link-hint  1 2 3 4 5 6 7  ;; (use-package! link-hint ;; :config ;; (setq ;; browse-url-browser-function \u0026#39;browse-url ;; ;; browse-url-generic-args \u0026#39;(\u0026#34;--target\u0026#34; \u0026#34;tab\u0026#34;) ;; ) ;; )      Lsp  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  (use-package! lsp-mode :hook ((web-mode . lsp) (rjsx-mode . lsp) (typescript-mode . lsp) ;; (vue-mode . lsp) (python-mode . lsp) (go-mode . lsp) (css-mode . lsp) (js2-mode . lsp) (bibtex-mode . lsp) (tex-mode . lsp) (latex-mode . lsp)) :commands lsp :config (setq lsp-idle-delay 0.2 lsp-enable-file-watchers nil)) (use-package! lsp-ui :commands lsp-ui-mode :config (setq lsp-headerline-breadcrumb-enable t ; å·¦ä¸Šè§’æ˜¾ç¤ºæ–‡ä»¶è·¯å¾„ lsp-lens-enable t ; æ˜¾ç¤ºè¢«å¼•ç”¨æ¬¡æ•° ) :bind (:map lsp-ui-mode-map ([remap xref-find-definitions] . lsp-ui-peek-find-definitions) ([remap xref-find-references] . lsp-ui-peek-find-references) ([remap xref-pop-marker-stack] . lsp-ui-peek-jump-backward) )) ;; å…³é—­è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œå…¨å±€å…³é—­ ;; (setq +form-with-lsp nil) ;; æŒ‡å®šæ¨¡å¼ ;; (setq-hook! \u0026#39;typescript-mode-hook +format-with-lsp nil) ;; (setq-hook! \u0026#39;typescript-tsx-mode-hook +format-with-lsp nil)     open Lsp in org source block:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  (cl-defmacro lsp-org-babel-enable (lang) \u0026#34;Support LANG in org source code block.\u0026#34; (setq centaur-lsp \u0026#39;lsp-mode) (cl-check-type lang stringp) (let* ((edit-pre (intern (format \u0026#34;org-babel-edit-prep:%s\u0026#34; lang))) (intern-pre (intern (format \u0026#34;lsp--%s\u0026#34; (symbol-name edit-pre))))) `(progn (defun ,intern-pre (info) (let ((file-name (-\u0026gt;\u0026gt; info caddr (alist-get :file)))) (unless file-name (setq file-name (make-temp-file \u0026#34;babel-lsp-\u0026#34;))) (setq buffer-file-name file-name) (lsp-deferred))) (put \u0026#39;,intern-pre \u0026#39;function-documentation (format \u0026#34;Enable lsp-mode in the buffer of org source block (%s).\u0026#34; (upcase ,lang))) (if (fboundp \u0026#39;,edit-pre) (advice-add \u0026#39;,edit-pre :after \u0026#39;,intern-pre) (progn (defun ,edit-pre (info) (,intern-pre info)) (put \u0026#39;,edit-pre \u0026#39;function-documentation (format \u0026#34;Prepare local buffer environment for org source block (%s).\u0026#34; (upcase ,lang)))))))) (defvar org-babel-lang-list \u0026#39;(\u0026#34;go\u0026#34; \u0026#34;python\u0026#34; \u0026#34;ipython\u0026#34; \u0026#34;bash\u0026#34; \u0026#34;sh\u0026#34; \u0026#34;js\u0026#34; \u0026#34;typescript\u0026#34; \u0026#34;css\u0026#34;)) (dolist (lang org-babel-lang-list) (eval `(lsp-org-babel-enable ,lang)))      Markdown  Grip-mode   issue: Error (after-save-hook): Error running hook \u0026#34;grip-org-to-md\u0026#34; because: (void-variable vc-log-view-type)\n1 2 3 4 5  ;; (use-package! grip-mode ;; :hook ((markdown-mode org-mode) . grip-mode) ;; :config ;; (setq grip-github-user \u0026#34;gcclll\u0026#34; ;; grip-github-password \u0026#34;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\u0026#34;))      Pandoc-mode  1 2 3 4 5  (use-package! pandoc-mode :after (markdown-mode org-mode) :hook (markdown-mode org-mode) (pandoc-mode . pandoc-load-default-settings))      Vmd-mode  1 2 3 4  (use-package! vmd-mode :after markdown-mode :bind (:map markdown-mode-map (\u0026#34;C-x p\u0026#34; . vmd-mode)))        Maple-iedit  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  (use-package! maple-iedit :commands (maple-iedit-match-all maple-iedit-match-next maple-iedit-match-previous) :config (delete-selection-mode t) (setq maple-iedit-ignore-case t) (defhydra maple/iedit () (\u0026#34;n\u0026#34; maple-iedit-match-next \u0026#34;next\u0026#34;) (\u0026#34;t\u0026#34; maple-iedit-skip-and-match-next \u0026#34;skip and next\u0026#34;) (\u0026#34;T\u0026#34; maple-iedit-skip-and-match-previous \u0026#34;skip and previous\u0026#34;) (\u0026#34;p\u0026#34; maple-iedit-match-previous \u0026#34;prev\u0026#34;)) :bind (:map evil-visual-state-map (\u0026#34;n\u0026#34; . maple/iedit/body) (\u0026#34;C-n\u0026#34; . maple-iedit-match-next) (\u0026#34;C-p\u0026#34; . maple-iedit-match-previous) (\u0026#34;C-t\u0026#34; . map-iedit-skip-and-match-next) (\u0026#34;C-T\u0026#34; . map-iedit-skip-and-match-previous)))      Mu4e   README.org -\u0026gt;\n  Net-utils  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  (use-package! net-utils :bind (:map mode-specific-map :prefix-map net-utils-prefix-map ; C-c n x :prefix \u0026#34;n\u0026#34; (\u0026#34;p\u0026#34; . ping) (\u0026#34;i\u0026#34; . ifconfig) (\u0026#34;w\u0026#34; . iwconfig) (\u0026#34;n\u0026#34; . netstat) (\u0026#34;p\u0026#34; . ping) (\u0026#34;a\u0026#34; . arp) (\u0026#34;r\u0026#34; . route) (\u0026#34;h\u0026#34; . nslookup-host) (\u0026#34;d\u0026#34; . dig) (\u0026#34;s\u0026#34; . smbclient) (\u0026#34;t\u0026#34; . traceroute))) (use-package! browse-at-remote :config (setq browse-at-remote-remote-type-domains \u0026#39;((\u0026#34;bitbucket.org\u0026#34; . \u0026#34;bitbucket\u0026#34;) (\u0026#34;github.com\u0026#34; . \u0026#34;github\u0026#34;) (\u0026#34;gitlab.com\u0026#34; . \u0026#34;gitlab\u0026#34;) (\u0026#34;git.savannah.gnu.org\u0026#34; . \u0026#34;gnu\u0026#34;) (\u0026#34;gist.github.com\u0026#34; . \u0026#34;gist\u0026#34;) (\u0026#34;git.sr.ht\u0026#34; . \u0026#34;sourcehut\u0026#34;) (\u0026#34;vs-ssh.visualstudio.com\u0026#34; . \u0026#34;ado\u0026#34;) (\u0026#34;pagure.io\u0026#34; . \u0026#34;pagure\u0026#34;) (\u0026#34;src.fedoraproject.org\u0026#34; . \u0026#34;pagure\u0026#34;) (\u0026#34;code.aliyun.com\u0026#34; . \u0026#34;aliyun\u0026#34;) ) ))      Org-mode  Basic  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66  ;; (org-hide-emphasis-markers t) (setq org-list-demote-modify-bullet \u0026#39;((\u0026#34;+\u0026#34; . \u0026#34;-\u0026#34;) (\u0026#34;-\u0026#34; . \u0026#34;+\u0026#34;) (\u0026#34;*\u0026#34; . \u0026#34;+\u0026#34;) (\u0026#34;1.\u0026#34; . \u0026#34;a.\u0026#34;))) ;; (use-package! org ;; :hook ( ;; ;; (verb-mode . org-mode) ;; (+org-pretty-mode . org-mode))) (after! org (add-hook \u0026#39;org-mode-hook (lambda () (visual-line-mode -1))) (org-babel-do-load-languages \u0026#39;org-babel-load-languages (append org-babel-load-languages \u0026#39;((restclient . t) (verb . t)) )) (setq org-todo-keywords \u0026#39;((sequence \u0026#34;TODO(t)\u0026#34; \u0026#34;PROJECT(p)\u0026#34; \u0026#34;NEXT(n)\u0026#34; \u0026#34;WAIT(w)\u0026#34; \u0026#34;HOLD(h)\u0026#34; \u0026#34;IDEA(i)\u0026#34; \u0026#34;SOMEDAY(s)\u0026#34; \u0026#34;MAYBE(m)\u0026#34; \u0026#34;|\u0026#34; \u0026#34;DONE(d)\u0026#34; \u0026#34;CANCELLED(c)\u0026#34;) (sequence \u0026#34;[ ](T)\u0026#34; \u0026#34;[-](S)\u0026#34; \u0026#34;[?](W)\u0026#34; \u0026#34;|\u0026#34; \u0026#34;[X](D)\u0026#34;) ;; (sequence \u0026#34;|\u0026#34; \u0026#34;OKAY(o)\u0026#34; \u0026#34;YES(y)\u0026#34; \u0026#34;NO(x)\u0026#34;) ) org-todo-keyword-faces `((\u0026#34;NEXT\u0026#34; . ,(doom-color \u0026#39;green)) (\u0026#34;TODO\u0026#34; . ,(doom-color \u0026#39;yellow)) (\u0026#34;PROJECT\u0026#34; . ,(doom-color \u0026#39;tan)) (\u0026#34;WAIT\u0026#34; . ,(doom-color \u0026#39;teal)) (\u0026#34;HOLD\u0026#34; . ,(doom-color \u0026#39;red)) (\u0026#34;IDEA\u0026#34; . ,(doom-color \u0026#39;tomato)) ;; (\u0026#34;OKAY\u0026#34; . ,(doom-color \u0026#39;cyan)) ;; ,(if (eq doom-theme \u0026#39;doom-vibrant) ;; (cons \u0026#34;OKAY\u0026#34; (doom-color \u0026#39;base7)) ;; (cons \u0026#34;OKAY\u0026#34; (doom-color \u0026#39;base5))) ;; (\u0026#34;YES\u0026#34; . ,(doom-color \u0026#39;blue)) (\u0026#34;SOMEDAY\u0026#34; . ,(doom-color \u0026#39;base7)) (\u0026#34;MAYBE\u0026#34; . ,(doom-color \u0026#39;base5)) (\u0026#34;[ ]\u0026#34; . ,(doom-color \u0026#39;green)) (\u0026#34;[-]\u0026#34; . ,(doom-color \u0026#39;yellow)) (\u0026#34;[?]\u0026#34; . ,(doom-color \u0026#39;red)) ) ;; org-enforce-todo-dependencies nil ;; if t, it hides todo entries with todo children from agenda ;; org-enforce-todo-checkbox-dependencies nil org-provide-todo-statistics t org-pretty-entities t org-hierarchical-todo-statistics t ;; org-startup-with-inline-images t org-hide-emphasis-markers t ;; org-fontify-whole-heading-line nil org-src-fontify-natively t org-imenu-depth 9 org-use-property-inheritance t org-log-done \u0026#39;time org-log-redeadline \u0026#39;time org-log-reschedule \u0026#39;time org-log-into-drawer \u0026#34;LOGBOOK\u0026#34; ;; org-columns-default-format \u0026#34;%50ITEM(Task) %10CLOCKSUM %16TIMESTAMP_IA\u0026#34; ) )      counsel-org-clock  1 2 3 4 5 6  (use-package! counsel-org-clock :commands (counsel-org-clock-context counsel-org-clock-history counsel-org-clock-goto) :config (setq counsel-org-clock-history-limit 20))      engrave-faces-latex  1 2  (use-package! engrave-faces-latex :after ox-latex)      valign  1 2 3 4 5  (use-package! valign :custom (valign-fancy-bar t) :hook (org-mode . valign-mode))      Verb  1 2 3 4 5 6 7 8 9 10 11 12  ;; (setq verb-base-headers \u0026#39;((\u0026#34;User-Agent\u0026#34; . \u0026#34;my-user-agent\u0026#34;))) ;; unused: b,d,f,g,j,k,m,n,o,p,r,t,u,v,w,x,y,z (use-package! verb :after org :config (setq tempo-template-org-verb \u0026#39;(\u0026#34;#+begin_src verb :wrap src ob-verb-response\u0026#34; nil \u0026#39;\u0026gt; n p n \u0026#34;#+end_src\u0026#34; \u0026gt;) verb-auto-kill-response-buffers t) )    1  get https://api.ipify.org/?format=json     Demos\n  org-clock  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  (after! org-clock (advice-add #\u0026#39;org-clock-in :after (lambda (\u0026amp;rest _) \u0026#34;Save all opened org-mode files.\u0026#34; (org-save-all-org-buffers))) (advice-add #\u0026#39;org-clock-out :after (lambda (\u0026amp;rest _) \u0026#34;Save all opened org-mode files.\u0026#34; (org-save-all-org-buffers))) (advice-add #\u0026#39;org-clock-load :around #\u0026#39;doom-shut-up-a) (advice-add #\u0026#39;org-clock-report :after (lambda (\u0026amp;rest _) \u0026#34;Save all opened org-mode files.\u0026#34; (org-save-all-org-buffers))) (advice-add #\u0026#39;org-clock-goto :after (lambda (\u0026amp;rest _) \u0026#34;Narrow view after switching.\u0026#34; (interactive) (widen) (+org-narrow-and-show))) (doom-store-persist \u0026#34;custom\u0026#34; \u0026#39;(org-clock-out-time)) (setq org-clock-clocked-in-display nil org-clock-history-length 50 org-clock-in-resume t org-clock-out-remove-zero-time-clocks t org-clock-persist t org-clock-persist-query-resume nil org-clock-report-include-clocking-task t ) )      org-chef  1 2  (use-package! org-chef :commands (org-chef-insert-recipe org-chef-get-recipe-from-url))      org-appear  1 2 3 4 5 6 7  (use-package! org-appear :hook (org-mode . org-appear-mode) :config (setq org-appear-autoemphasis t org-appear-autosubmarkers t org-appear-autolinks nil) )      org-fancy-priorities  1 2 3 4 5 6  (use-package! org-fancy-priorities :diminish :hook (org-mode . org-fancy-priorities-mode) :config (setq org-fancy-priorities-list \u0026#39;(\u0026#34;ğŸ…°\u0026#34; \u0026#34;ğŸ…±\u0026#34; \u0026#34;ğŸ…²\u0026#34; \u0026#34;ğŸ…³\u0026#34; \u0026#34;ğŸ…´\u0026#34;)))      org-fragtog  1  (add-hook \u0026#39;org-mode-hook \u0026#39;org-fragtog-mode)      ox-gfm  1  (use-package! ox-gfm :after org)      org-pandoc-import  1  (use-package! org-pandoc-import :after org)      org-ol-tree ç›®å½•æ ‘  1 2 3 4 5 6 7  (use-package! org-ol-tree :commands org-ol-tree) (map! :map org-mode-map :after org :localleader :desc \u0026#34;Outline\u0026#34; \u0026#34;O\u0026#34; #\u0026#39;org-ol-tree)      org-pretty-capture  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108  (defun org-capture-select-template-prettier (\u0026amp;optional keys) \u0026#34;Select a capture template, in a prettier way than default Lisp programs can force the template by setting KEYS to a string.\u0026#34; (let ((org-capture-templates (or (org-contextualize-keys (org-capture-upgrade-templates org-capture-templates) org-capture-templates-contexts) \u0026#39;((\u0026#34;t\u0026#34; \u0026#34;Task\u0026#34; entry (file+headline \u0026#34;\u0026#34; \u0026#34;Tasks\u0026#34;) \u0026#34;* TODO %?\\n %u\\n %a\u0026#34;))))) (if keys (or (assoc keys org-capture-templates) (error \u0026#34;No capture template referred to by \\\u0026#34;%s\\\u0026#34; keys\u0026#34; keys)) (org-mks org-capture-templates \u0026#34;Select a capture template\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\u0026#34; \u0026#34;Template key: \u0026#34; `((\u0026#34;q\u0026#34; ,(concat (all-the-icons-octicon \u0026#34;stop\u0026#34; :face \u0026#39;all-the-icons-red :v-adjust 0.01) \u0026#34;\\tAbort\u0026#34;))))))) (advice-add \u0026#39;org-capture-select-template :override #\u0026#39;org-capture-select-template-prettier) (defun org-mks-pretty (table title \u0026amp;optional prompt specials) \u0026#34;Select a member of an alist with multiple keys. Prettified. TABLE is the alist which should contain entries where the car is a string. There should be two types of entries. 1. prefix descriptions like (\\\u0026#34;a\\\u0026#34; \\\u0026#34;Description\\\u0026#34;) This indicates that `a\u0026#39;is a prefix key for multi-letter selection, and that there are entries following with keys like \\\u0026#34;ab\\\u0026#34;, \\\u0026#34;ax\\\u0026#34;â€¦ 2. Select-able members must have more than two elements, with the first being the string of keys that lead to selecting it, and the second a short description string of the item. The command will then make a temporary buffer listing all entries that can be selected with a single key, and all the single key prefixes. When you press the key for a single-letter entry, it is selected. When you press a prefix key, the commands (and maybe further prefixes) under this key will be shown and offered for selection. TITLE will be placed over the selection in the temporary buffer, PROMPT will be used when prompting for a key. SPECIALS is an alist with (\\\u0026#34;key\\\u0026#34; \\\u0026#34;description\\\u0026#34;) entries. When one of these is selected, only the bare key is returned.\u0026#34; (save-window-excursion (let ((inhibit-quit t) (buffer (org-switch-to-buffer-other-window \u0026#34;*Org Select*\u0026#34;)) (prompt (or prompt \u0026#34;Select: \u0026#34;)) case-fold-search current) (unwind-protect (catch \u0026#39;exit (while t (setq-local evil-normal-state-cursor (list nil)) (erase-buffer) (insert title \u0026#34;\\n\\n\u0026#34;) (let ((des-keys nil) (allowed-keys \u0026#39;(\u0026#34;\\C-g\u0026#34;)) (tab-alternatives \u0026#39;(\u0026#34;\\s\u0026#34; \u0026#34;\\t\u0026#34; \u0026#34;\\r\u0026#34;)) (cursor-type nil)) ;; Populate allowed keys and descriptions keys ;; available with CURRENT selector. (let ((re (format \u0026#34;\\\\`%s\\\\(.\\\\)\\\\\u0026#39;\u0026#34; (if current (regexp-quote current) \u0026#34;\u0026#34;))) (prefix (if current (concat current \u0026#34; \u0026#34;) \u0026#34;\u0026#34;))) (dolist (entry table) (pcase entry ;; Description. (`(,(and key (pred (string-match re))) ,desc) (let ((k (match-string 1 key))) (push k des-keys) ;; Keys ending in tab, space or RET are equivalent. (if (member k tab-alternatives) (push \u0026#34;\\t\u0026#34; allowed-keys) (push k allowed-keys)) (insert (propertize prefix \u0026#39;face \u0026#39;font-lock-comment-face) (propertize k \u0026#39;face \u0026#39;bold) (propertize \u0026#34;â€º\u0026#34; \u0026#39;face \u0026#39;font-lock-comment-face) \u0026#34; \u0026#34; desc \u0026#34;â€¦\u0026#34; \u0026#34;\\n\u0026#34;))) ;; Usable entry. (`(,(and key (pred (string-match re))) ,desc . ,_) (let ((k (match-string 1 key))) (insert (propertize prefix \u0026#39;face \u0026#39;font-lock-comment-face) (propertize k \u0026#39;face \u0026#39;bold) \u0026#34; \u0026#34; desc \u0026#34;\\n\u0026#34;) (push k allowed-keys))) (_ nil)))) ;; Insert special entries, if any. (when specials (insert \u0026#34;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\u0026#34;) (pcase-dolist (`(,key ,description) specials) (insert (format \u0026#34;%s %s\\n\u0026#34; (propertize key \u0026#39;face \u0026#39;(bold all-the-icons-red)) description)) (push key allowed-keys))) ;; Display UI and let user select an entry or ;; a sub-level prefix. (goto-char (point-min)) (unless (pos-visible-in-window-p (point-max)) (org-fit-window-to-buffer)) (let ((pressed (org--mks-read-key allowed-keys prompt (not (pos-visible-in-window-p (1- (point-max))))))) (setq current (concat current pressed)) (cond ((equal pressed \u0026#34;\\C-g\u0026#34;) (user-error \u0026#34;Abort\u0026#34;)) ;; Selection is a prefix: open a new menu. ((member pressed des-keys)) ;; Selection matches an association: return it. ((let ((entry (assoc current table))) (and entry (throw \u0026#39;exit entry)))) ;; Selection matches a special entry: return the ;; selection prefix. ((assoc current specials) (throw \u0026#39;exit current)) (t (error \u0026#34;No entry available\u0026#34;))))))) (when buffer (kill-buffer buffer)))))) (advice-add \u0026#39;org-mks :override #\u0026#39;org-mks-pretty)      org-capture  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219  (use-package! doct :commands (doct)) (after! org-capture (defun +doct-icon-declaration-to-icon (declaration) \u0026#34;Convert :icon declaration to icon\u0026#34; (let ((name (pop declaration)) (set (intern (concat \u0026#34;all-the-icons-\u0026#34; (plist-get declaration :set)))) (face (intern (concat \u0026#34;all-the-icons-\u0026#34; (plist-get declaration :color)))) (v-adjust (or (plist-get declaration :v-adjust) 0.01))) (apply set `(,name :face ,face :v-adjust ,v-adjust)))) (defun +doct-iconify-capture-templates (groups) \u0026#34;Add declaration\u0026#39;s :icon to each template group in GROUPS.\u0026#34; (let ((templates (doct-flatten-lists-in groups))) (setq doct-templates (mapcar (lambda (template) (when-let* ((props (nthcdr (if (= (length template) 4) 2 5) template)) (spec (plist-get (plist-get props :doct) :icon))) (setf (nth 1 template) (concat (+doct-icon-declaration-to-icon spec) \u0026#34;\\t\u0026#34; (nth 1 template)))) template) templates)))) (setq doct-after-conversion-functions \u0026#39;(+doct-iconify-capture-templates)) (defvar +org-capture-recipies \u0026#34;~/.gclrc/org/recipies.org\u0026#34;) (defun set-org-capture-templates () (setq org-capture-templates (doct `((\u0026#34;Personal todo\u0026#34; :keys \u0026#34;t\u0026#34; :icon (\u0026#34;checklist\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;green\u0026#34;) :file +org-capture-todo-file :prepend t :headline \u0026#34;Inbox\u0026#34; :type entry :template (\u0026#34;* TODO %?\u0026#34; \u0026#34;%i %a\u0026#34;) ) (\u0026#34;Personal note\u0026#34; :keys \u0026#34;n\u0026#34; :icon (\u0026#34;sticky-note-o\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;green\u0026#34;) :file +org-capture-todo-file :prepend t :headline \u0026#34;Notes\u0026#34; :type entry :template (\u0026#34;* %?\u0026#34; \u0026#34;%i %a\u0026#34;)) (\u0026#34;Emacs\u0026#34; :keys \u0026#34;e\u0026#34; :icon (\u0026#34;emacs\u0026#34; :set \u0026#34;fileicon\u0026#34; :color \u0026#34;purple\u0026#34;) :file +org-capture-todo-file :prepend t :headline \u0026#34;Emacs\u0026#34; :type entry :template (\u0026#34;* TODO %? :emacs:\u0026#34; \u0026#34;%i %a\u0026#34;)) (\u0026#34;Email\u0026#34; :keys \u0026#34;E\u0026#34; :icon (\u0026#34;envelope\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;blue\u0026#34;) :file +org-capture-todo-file :prepend t :headline \u0026#34;Inbox\u0026#34; :type entry :template (\u0026#34;* TODO %^{type|reply to|contact} %\\\\3 %? âœ‰ï¸\u0026#34; \u0026#34;Send an email %^{urgancy|soon|ASAP|anon|at some point|eventually} to %^{recipiant}\u0026#34; \u0026#34;about %^{topic}\u0026#34; \u0026#34;%U %i %a\u0026#34;)) (\u0026#34;Web\u0026#34; :keys \u0026#34;w\u0026#34; :icon (\u0026#34;web\u0026#34; :set \u0026#34;material\u0026#34; :color \u0026#34;yellow\u0026#34;) :file +org-capture-todo-file :prepend t :headline \u0026#34;Web\u0026#34; :type entry :template (\u0026#34;* TODO %{desc}%? :%{i-type}:\u0026#34; \u0026#34;%i %a\u0026#34;) :children ((\u0026#34;Vue\u0026#34; :keys \u0026#34;v\u0026#34; :icon (\u0026#34;vue\u0026#34; :set \u0026#34;fileicon\u0026#34; :color \u0026#34;green\u0026#34;) :desc \u0026#34;\u0026#34; :headline \u0026#34;Vue\u0026#34; :i-type \u0026#34;web:vue\u0026#34;) (\u0026#34;React\u0026#34; :keys \u0026#34;r\u0026#34; :icon (\u0026#34;react\u0026#34; :set \u0026#34;alltheicon\u0026#34; :color \u0026#34;blue\u0026#34;) :desc \u0026#34;\u0026#34; :headline \u0026#34;React\u0026#34; :i-type \u0026#34;web:react\u0026#34; ) (\u0026#34;JavaScript\u0026#34; :keys \u0026#34;j\u0026#34; :icon (\u0026#34;javascript-shield\u0026#34; :set \u0026#34;alltheicon\u0026#34; :color \u0026#34;yellow\u0026#34;) :desc \u0026#34;\u0026#34; :i-type \u0026#34;web:javascript\u0026#34; ) (\u0026#34;HTML\u0026#34; :keys \u0026#34;h\u0026#34; :icon (\u0026#34;html5\u0026#34; :set \u0026#34;alltheicon\u0026#34; :color \u0026#34;orange\u0026#34;) :desc \u0026#34;\u0026#34; :i-type \u0026#34;web:html\u0026#34; ) (\u0026#34;CSS\u0026#34; :keys \u0026#34;c\u0026#34; :icon (\u0026#34;css3\u0026#34; :set \u0026#34;alltheicon\u0026#34; :color \u0026#34;blue\u0026#34;) :desc \u0026#34;\u0026#34; :i-type \u0026#34;web:css\u0026#34; )) ) (\u0026#34;Interesting\u0026#34; :keys \u0026#34;i\u0026#34; :icon (\u0026#34;eye\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;lcyan\u0026#34;) :file +org-capture-todo-file :prepend t :headline \u0026#34;Interesting\u0026#34; :type entry :template (\u0026#34;* [ ] %{desc}%? :%{i-type}:\u0026#34; \u0026#34;%i %a\u0026#34;) :children ((\u0026#34;Webpage\u0026#34; :keys \u0026#34;w\u0026#34; :icon (\u0026#34;globe\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;green\u0026#34;) :desc \u0026#34;%(org-cliplink-capture) \u0026#34; :i-type \u0026#34;read:web\u0026#34; ) (\u0026#34;Links\u0026#34; :keys \u0026#34;l\u0026#34; :icon (\u0026#34;link\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;blue\u0026#34;) :desc \u0026#34;%(org-cliplink-capture) \u0026#34; :i-type \u0026#34;link:web\u0026#34; ) (\u0026#34;Article\u0026#34; :keys \u0026#34;a\u0026#34; :icon (\u0026#34;file-text\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;yellow\u0026#34;) :desc \u0026#34;\u0026#34; :i-type \u0026#34;read:reaserch\u0026#34; ) (\u0026#34;\\tRecipie\u0026#34; :keys \u0026#34;r\u0026#34; :icon (\u0026#34;spoon\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;dorange\u0026#34;) :file +org-capture-recipies :headline \u0026#34;Unsorted\u0026#34; :template \u0026#34;%(org-chef-get-recipe-from-url)\u0026#34; ) (\u0026#34;Information\u0026#34; :keys \u0026#34;i\u0026#34; :icon (\u0026#34;info-circle\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;blue\u0026#34;) :desc \u0026#34;\u0026#34; :i-type \u0026#34;read:info\u0026#34; ) (\u0026#34;Idea\u0026#34; :keys \u0026#34;I\u0026#34; :icon (\u0026#34;bubble_chart\u0026#34; :set \u0026#34;material\u0026#34; :color \u0026#34;silver\u0026#34;) :desc \u0026#34;\u0026#34; :i-type \u0026#34;idea\u0026#34; ))) (\u0026#34;Tasks\u0026#34; :keys \u0026#34;k\u0026#34; :icon (\u0026#34;inbox\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;yellow\u0026#34;) :file +org-capture-todo-file :prepend t :headline \u0026#34;Tasks\u0026#34; :type entry :template (\u0026#34;* TODO %? %^G%{extra}\u0026#34; \u0026#34;%i %a\u0026#34;) :children ((\u0026#34;General Task\u0026#34; :keys \u0026#34;k\u0026#34; :icon (\u0026#34;inbox\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;yellow\u0026#34;) :extra \u0026#34;\u0026#34; ) (\u0026#34;Task with deadline\u0026#34; :keys \u0026#34;d\u0026#34; :icon (\u0026#34;timer\u0026#34; :set \u0026#34;material\u0026#34; :color \u0026#34;orange\u0026#34; :v-adjust -0.1) :extra \u0026#34;\\nDEADLINE: %^{Deadline:}t\u0026#34; ) (\u0026#34;Scheduled Task\u0026#34; :keys \u0026#34;s\u0026#34; :icon (\u0026#34;calendar\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;orange\u0026#34;) :extra \u0026#34;\\nSCHEDULED: %^{Start time:}t\u0026#34; ) )) (\u0026#34;Project\u0026#34; :keys \u0026#34;p\u0026#34; :icon (\u0026#34;repo\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;silver\u0026#34;) :prepend t :type entry :headline \u0026#34;Inbox\u0026#34; :template (\u0026#34;* %{time-or-todo} %?\u0026#34; \u0026#34;%i\u0026#34; \u0026#34;%a\u0026#34;) :file \u0026#34;\u0026#34; :custom (:time-or-todo \u0026#34;\u0026#34;) :children ((\u0026#34;Project-local todo\u0026#34; :keys \u0026#34;t\u0026#34; :icon (\u0026#34;checklist\u0026#34; :set \u0026#34;octicon\u0026#34; :color \u0026#34;green\u0026#34;) :time-or-todo \u0026#34;TODO\u0026#34; :file +org-capture-project-todo-file) (\u0026#34;Project-local note\u0026#34; :keys \u0026#34;n\u0026#34; :icon (\u0026#34;sticky-note\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;yellow\u0026#34;) :time-or-todo \u0026#34;%U\u0026#34; :file +org-capture-project-notes-file) (\u0026#34;Project-local changelog\u0026#34; :keys \u0026#34;c\u0026#34; :icon (\u0026#34;list\u0026#34; :set \u0026#34;faicon\u0026#34; :color \u0026#34;blue\u0026#34;) :time-or-todo \u0026#34;%U\u0026#34; :heading \u0026#34;Unreleased\u0026#34; :file +org-capture-project-changelog-file)) ) (\u0026#34;\\tCentralised project templates\u0026#34; :icon (\u0026#34;ionic-project\u0026#34; :set \u0026#34;fileicon\u0026#34; :color \u0026#34;cyan\u0026#34;) :keys \u0026#34;o\u0026#34; :type entry :prepend t :template (\u0026#34;* %{time-or-todo} %?\u0026#34; \u0026#34;%i\u0026#34; \u0026#34;%a\u0026#34;) :children ((\u0026#34;Project todo\u0026#34; :keys \u0026#34;t\u0026#34; :prepend nil :time-or-todo \u0026#34;TODO\u0026#34; :heading \u0026#34;Tasks\u0026#34; :file +org-capture-central-project-todo-file) (\u0026#34;Project note\u0026#34; :keys \u0026#34;n\u0026#34; :time-or-todo \u0026#34;%U\u0026#34; :heading \u0026#34;Notes\u0026#34; :file +org-capture-central-project-notes-file) (\u0026#34;Project changelog\u0026#34; :keys \u0026#34;c\u0026#34; :time-or-todo \u0026#34;%U\u0026#34; :heading \u0026#34;Unreleased\u0026#34; :file +org-capture-central-project-changelog-file)) ))))) (set-org-capture-templates) (unless (display-graphic-p) (add-hook \u0026#39;server-after-make-frame-hook (defun org-capture-reinitialise-hook () (when (display-graphic-p) (set-org-capture-templates) (remove-hook \u0026#39;server-after-make-frame-hook #\u0026#39;org-capture-reinitialise-hook))))))     org-capture bin\n1 2 3 4 5 6 7  (setf (alist-get \u0026#39;height +org-capture-frame-parameters) 15) ;; (alist-get \u0026#39;name +org-capture-frame-parameters) \u0026#34;â– Capture\u0026#34;) ;; ATM hardcoded in other places, so changing breaks stuff (setq +org-capture-fn (lambda () (interactive) (set-window-parameter nil \u0026#39;mode-line-format \u0026#39;none) (org-capture)))      org-agenda  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53  (after! org-agenda (advice-add #\u0026#39;org-agenda-archive :after #\u0026#39;org-save-all-org-buffers) (advice-add #\u0026#39;org-agenda-archive-default :after #\u0026#39;org-save-all-org-buffers) (advice-add #\u0026#39;org-agenda-refile :after (lambda (\u0026amp;rest _) \u0026#34;Refresh view.\u0026#34; (if (string-match \u0026#34;Org QL\u0026#34; (buffer-name)) (org-ql-view-refresh) (org-agenda-redo)))) (advice-add #\u0026#39;org-agenda-redo :around #\u0026#39;doom-shut-up-a) (advice-add #\u0026#39;org-agenda-set-effort :after #\u0026#39;org-save-all-org-buffers) (advice-add #\u0026#39;org-schedule :after (lambda (\u0026amp;rest _) (org-save-all-org-buffers))) (advice-add #\u0026#39;org-deadline :after (lambda (\u0026amp;rest _) (org-save-all-org-buffers))) (advice-add #\u0026#39;+org-change-title :after (lambda (\u0026amp;rest _) (org-save-all-org-buffers))) (advice-add #\u0026#39;org-cut-special :after #\u0026#39;org-save-all-org-buffers) (advice-add #\u0026#39;counsel-org-tag :after #\u0026#39;org-save-all-org-buffers) (advice-add #\u0026#39;org-agenda-todo :after #\u0026#39;aj-org-agenda-save-and-refresh-a) (advice-add #\u0026#39;org-todo :after (lambda (\u0026amp;rest _) (org-save-all-org-buffers))) (advice-add #\u0026#39;org-agenda-kill :after #\u0026#39;aj-org-agenda-save-and-refresh-a) (setq org-agenda-prefix-format \u0026#39;((agenda . \u0026#34; %-6t %6e \u0026#34;) (timeline . \u0026#34; %-6t %6e \u0026#34;) (todo . \u0026#34; %-6t %6e \u0026#34;) (tags . \u0026#34; %-6t %6e \u0026#34;) (search . \u0026#34;%l\u0026#34;) ) org-agenda-tags-column 80 org-agenda-skip-scheduled-if-done t org-agenda-skip-deadline-if-done t org-agenda-skip-timestamp-if-done t ;; org-agenda-todo-ignore-scheduled t ;; org-agenda-todo-ignore-deadlines t ;; org-agenda-todo-ignore-timestamp t ;; org-agenda-todo-ignore-with-date t org-agenda-start-on-weekday nil ; ä»ä»Šå¤©å¼€å§‹ org-agenda-todo-list-sublevels t org-agenda-include-deadlines t org-agenda-log-mode-items \u0026#39;(closed clock state) org-agenda-block-separator nil org-agenda-compact-blocks t org-agenda-breadcrumbs-separator \u0026#34; â± \u0026#34; org-agenda-current-time-string \u0026#34;â° â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ now\u0026#34; org-agenda-sorting-strategy \u0026#39;((agenda habit-down time-up effort-up priority-down category-keep) (todo priority-up effort-up todo-state-up category-keep) (tags priority-down category-keep) (search category-keep)) ) )      org-super-agenda  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  (use-package! org-super-agenda :commands (org-super-agenda-mode)) (after! org-agenda (org-super-agenda-mode)) (setq org-agenda-custom-commands \u0026#39;((\u0026#34;o\u0026#34; \u0026#34;Overview\u0026#34; ((agenda \u0026#34;\u0026#34; ((org-agenda-span \u0026#39;day) (org-super-agenda-groups \u0026#39;((:name \u0026#34;Today\u0026#34; :time-grid t :date today :todo \u0026#34;TODAY\u0026#34; :scheduled today :order 1))))) (alltodo \u0026#34;\u0026#34; ((org-agenda-overriding-header \u0026#34;\u0026#34;) (org-super-agenda-groups \u0026#39;((:name \u0026#34;Next(æ¥ä¸‹æ¥)\u0026#34; :todo \u0026#34;NEXT\u0026#34; :order 1) (:name \u0026#34;Important(é‡è¦)\u0026#34; :tag \u0026#34;Important\u0026#34; :order 2 :priority \u0026#34;A\u0026#34;) (:name \u0026#34;Due Today(ä»Šå¤©å®Œæˆ)\u0026#34; :deadline today :order 3) (:name \u0026#34;Due Soon(å¾ˆå¿«è¿‡æœŸ)\u0026#34; :deadline future :order 8) (:name \u0026#34;Overdue(è¿‡æœŸ)\u0026#34; :deadline past :order 9 :face error) (:name \u0026#34;Emacs\u0026#34; :tag \u0026#34;Emacs\u0026#34; :order 10) (:name \u0026#34;Vue\u0026#34; :tag \u0026#34;Vue\u0026#34; :order 15) (:name \u0026#34;React\u0026#34; :tag \u0026#34;React\u0026#34; :order 18) (:name \u0026#34;Assignments(ä½œä¸š)\u0026#34; :tag \u0026#34;Assignment\u0026#34; :order 20) (:name \u0026#34;Waiting(ç­‰å¾…)\u0026#34; :todo \u0026#34;WAITING\u0026#34; :order 21) (:name \u0026#34;To read(é˜…è¯»)\u0026#34; :tag \u0026#34;Read\u0026#34; :order 25) (:name \u0026#34;Issues(é—®é¢˜)\u0026#34; :tag \u0026#34;Issue\u0026#34; :order 30) (:name \u0026#34;Projects(é¡¹ç›®)\u0026#34; :tag \u0026#34;Project\u0026#34; :order 40) (:name \u0026#34;Research(ç ”ç©¶)\u0026#34; :tag \u0026#34;Research\u0026#34; :order 50) (:name \u0026#34;University(ç»¼åˆ)\u0026#34; :tag \u0026#34;uni\u0026#34; :order 60) (:name \u0026#34;Trivial(ä¸é‡è¦)\u0026#34; :priority\u0026lt;= \u0026#34;E\u0026#34; :tag (\u0026#34;Trivial\u0026#34; \u0026#34;Unimportant\u0026#34;) :todo (\u0026#34;SOMEDAY\u0026#34; ) :order 90) (:discard (:tag (\u0026#34;Chore\u0026#34; \u0026#34;Routine\u0026#34; \u0026#34;Daily\u0026#34;)))))))))))      org-roam  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  ;; (use-package! org-roam-lib ;; :after org-roam) (use-package! org-roam :config (setq org-roam-file-extensions \u0026#39;(\u0026#34;txt\u0026#34; \u0026#34;org\u0026#34;) org-roam-capture-templates (quote ((\u0026#34;d\u0026#34; \u0026#34;default\u0026#34; plain (function org-roam-capture--get-point) \u0026#34;%?\u0026#34; :file-name \u0026#34;%\u0026lt;%Y_%m%d\u0026gt;_${slug}\u0026#34; :head \u0026#34;#+TITLE: ${title}\\n\\n\u0026#34; :unnarrowed t))) ) (org-roam-setup) :bind ((\u0026#34;C-c r l\u0026#34; . org-roam-buffer-toggle) (\u0026#34;C-c r f\u0026#34; . org-roam-node-find) (\u0026#34;C-c r g\u0026#34; . org-roam-graph) (\u0026#34;C-c r i\u0026#34; . org-roam-node-insert) (\u0026#34;C-c r c\u0026#34; . org-roam-capture) (\u0026#34;C-c r j\u0026#34; . org-roam-dailies-capture-today) ))      org-preview-html  1 2  (use-package! org-preview-html :after org)      org-download  1 2 3 4 5 6 7  (use-package! org-download :after org :bind (:map org-mode-map ((\u0026#34;s-Y\u0026#34; . org-download-screenshot) (\u0026#34;s-y\u0026#34; . org-download-yank))) )      mathpix.el   mathpix.el uses Mathpixâ€™s API to convert clips into latex equations:\n è¦æ”¶è´¹~ã€‚\n1 2 3 4 5  ;; (use-package! mathpix.el ;; :custom ((mathpix-app-id \u0026#34;app-id\u0026#34;) ;; (mathpix-app-key \u0026#34;app-key\u0026#34;)) ;; :bind ;; (\u0026#34;C-x m\u0026#34; . mathpix-screenshot))        OSX   Keybindings:\n  Parrot  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  (use-package! parrot :config (parrot-mode)) (setq parrot-rotate-dict \u0026#39;( (:rot (\u0026#34;alpha\u0026#34; \u0026#34;beta\u0026#34;) :caps t :lower nil) ;; =\u0026gt; rotations are \u0026#34;Alpha\u0026#34; \u0026#34;Beta\u0026#34; (:rot (\u0026#34;snek\u0026#34; \u0026#34;snake\u0026#34; \u0026#34;stawp\u0026#34;)) ;; =\u0026gt; rotations are \u0026#34;snek\u0026#34; \u0026#34;snake\u0026#34; \u0026#34;stawp\u0026#34; (:rot (\u0026#34;yes\u0026#34; \u0026#34;no\u0026#34;) :caps t :upcase t) ;; =\u0026gt; rotations are \u0026#34;yes\u0026#34; \u0026#34;no\u0026#34;, \u0026#34;Yes\u0026#34; \u0026#34;No\u0026#34;, \u0026#34;YES\u0026#34; \u0026#34;NO\u0026#34; (:rot (\u0026#34;\u0026amp;\u0026#34; \u0026#34;|\u0026#34;)) ;; =\u0026gt; rotations are \u0026#34;\u0026amp;\u0026#34; \u0026#34;|\u0026#34; ;; default dictionary starts here (\u0026#39;v\u0026#39;) (:rot (\u0026#34;begin\u0026#34; \u0026#34;end\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;enable\u0026#34; \u0026#34;disable\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;enter\u0026#34; \u0026#34;exit\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;forward\u0026#34; \u0026#34;backward\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;front\u0026#34; \u0026#34;rear\u0026#34; \u0026#34;back\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;get\u0026#34; \u0026#34;set\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;high\u0026#34; \u0026#34;low\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;in\u0026#34; \u0026#34;out\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;left\u0026#34; \u0026#34;right\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;min\u0026#34; \u0026#34;max\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;on\u0026#34; \u0026#34;off\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;prev\u0026#34; \u0026#34;next\u0026#34;)) (:rot (\u0026#34;start\u0026#34; \u0026#34;stop\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;true\u0026#34; \u0026#34;false\u0026#34;) :caps t :upcase t) (:rot (\u0026#34;\u0026amp;\u0026amp;\u0026#34; \u0026#34;||\u0026#34;)) (:rot (\u0026#34;==\u0026#34; \u0026#34;!=\u0026#34;)) (:rot (\u0026#34;===\u0026#34; \u0026#34;!==\u0026#34;)) (:rot (\u0026#34;.\u0026#34; \u0026#34;-\u0026gt;\u0026#34;)) (:rot (\u0026#34;if\u0026#34; \u0026#34;else\u0026#34; \u0026#34;elif\u0026#34;)) (:rot (\u0026#34;ifdef\u0026#34; \u0026#34;ifndef\u0026#34;)) ;; javascript (:rot (\u0026#34;var\u0026#34; \u0026#34;let\u0026#34; \u0026#34;const\u0026#34;)) (:rot (\u0026#34;null\u0026#34; \u0026#34;undefined\u0026#34;)) (:rot (\u0026#34;number\u0026#34; \u0026#34;object\u0026#34; \u0026#34;string\u0026#34; \u0026#34;symbol\u0026#34;)) ;; c/... (:rot (\u0026#34;int8_t\u0026#34; \u0026#34;int16_t\u0026#34; \u0026#34;int32_t\u0026#34; \u0026#34;int64_t\u0026#34;)) (:rot (\u0026#34;uint8_t\u0026#34; \u0026#34;uint16_t\u0026#34; \u0026#34;uint32_t\u0026#34; \u0026#34;uint64_t\u0026#34;)) (:rot (\u0026#34;1\u0026#34; \u0026#34;2\u0026#34; \u0026#34;3\u0026#34; \u0026#34;4\u0026#34; \u0026#34;5\u0026#34; \u0026#34;6\u0026#34; \u0026#34;7\u0026#34; \u0026#34;8\u0026#34; \u0026#34;9\u0026#34; \u0026#34;10\u0026#34;)) (:rot (\u0026#34;1st\u0026#34; \u0026#34;2nd\u0026#34; \u0026#34;3rd\u0026#34; \u0026#34;4th\u0026#34; \u0026#34;5th\u0026#34; \u0026#34;6th\u0026#34; \u0026#34;7th\u0026#34; \u0026#34;8th\u0026#34; \u0026#34;9th\u0026#34; \u0026#34;10th\u0026#34;)) ;; org (:rot (\u0026#34;DONE\u0026#34; \u0026#34;DOING\u0026#34; \u0026#34;WAITING\u0026#34; \u0026#34;PENDING\u0026#34;)) (:rot (\u0026#34;increment\u0026#34;, \u0026#34;decrement\u0026#34;)) ))      PDF   Popper  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  (use-package! popper :bind (\u0026#34;C-`\u0026#34; . popper-toggle-latest) (\u0026#34;C-~\u0026#34; . popper-cycle) (\u0026#34;C-s-`\u0026#34; . popper-kill-latest-popup) :custom (popper-reference-buffers \u0026#39;(\u0026#34;*eshell*\u0026#34; \u0026#34;*vterm*\u0026#34; \u0026#34;*color-rg*\u0026#34; \u0026#34;Output\\\\*$\u0026#34; \u0026#34;*Process List*\u0026#34; \u0026#34;COMMIT_EDITMSG\u0026#34; embark-collect-mode deadgrep-mode grep-mode rg-mode rspec-compilation-mode inf-ruby-mode nodejs-repl-mode ts-comint-mode compilation-mode)) :config (defun zero-point-thirty-seven () 0.37) (advice-add \u0026#39;popper-determine-window-height :override #\u0026#39;zero-point-thirty-seven) :init (popper-mode) )      Projectile   ignore some directories.\n1 2 3 4  (setq projectile-ignored-projects \u0026#39;(\u0026#34;~/\u0026#34; \u0026#34;/tmp\u0026#34; \u0026#34;~/.emacs.d/.local/straight/repos/\u0026#34;)) (defun projectile-ignored-project-function (filepath) \u0026#34;Return t if FILEPATH is within any of `projectile-ignored-projects\u0026#39;\u0026#34; (or (mapcar (lambda (p) (s-starts-with-p p filepath)) projectile-ignored-projects)))      Projector  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  (use-package! projector :after (projectile vterm)) (map! (:prefix \u0026#34;s-p\u0026#34; \u0026#34;b\u0026#34; #\u0026#39;projector-switch-to-shell-buffer \u0026#34;-\u0026#34; #\u0026#39;projector-rerun-buffer-process (:prefix (\u0026#34;r\u0026#34; . \u0026#34;Run\u0026#34;) \u0026#34;c\u0026#34; #\u0026#39;projector-run-shell-command-current-directory-background \u0026#34;C\u0026#34; #\u0026#39;projector-run-shell-command-current-directory \u0026#34;r\u0026#34; #\u0026#39;projector-run-shell-command-project-root-background \u0026#34;R\u0026#34; #\u0026#39;projector-run-shell-command-project-root ) ) )      Ranger  1 2 3  (after! ranger :config (setq ranger-show-literal nil))      Restclient  1 2 3 4 5 6 7 8 9 10 11 12  (use-package! restclient :mode ((\u0026#34;\\\\.rest\\\\\u0026#39;\u0026#34; . restclient-mode) (\u0026#34;\\\\.restclient\\\\\u0026#39;\u0026#34; . restclient-mode))) (use-package! restclient-jq :after restclient) (use-package! ob-restclient :after org restclient :init (org-babel-do-load-languages \u0026#39;org-babel-load-languages \u0026#39;((restclient . t))))      Smartparen  1 2 3 4 5 6 7 8 9 10 11 12 13  (sp-local-pair \u0026#39;(org-mode) \u0026#34;\u0026lt;\u0026lt;\u0026#34; \u0026#34;\u0026gt;\u0026gt;\u0026#34; :actions \u0026#39;(insert)) (use-package! smartparens :init (map! :map smartparens-mode-map \u0026#34;C-)\u0026#34; #\u0026#39;sp-forward-slurp-sexp \u0026#34;C-(\u0026#34; #\u0026#39;sp-forward-barf-sexp \u0026#34;C-{\u0026#34; #\u0026#39;sp-backward-slurp-sexp \u0026#34;C-}\u0026#34; #\u0026#39;sp-backward-barf-sexp ))      Server  å¡æ­»äº†â€¦\n1 2 3 4 5 6 7 8 9 10  ;; (use-package! server ;; :unless (or noninteractive ;; alternate-emacs) ;; :no-require ;; :config ;; (unless (file-exists-p \u0026#34;/tmp/gcl-emacs\u0026#34;) ;; (make-directory \u0026#34;/tmp/gcl-emacs\u0026#34;) ;; (chmod \u0026#34;/tmp/gcl-emacs\u0026#34; 448)) ;; (setq server-socket-dir \u0026#34;/tmp/gcl-emacs\u0026#34;) ;; :hook (after-init . server-start))      Sudo-edit  1 2  (map! )      Treemacs  1 2 3 4 5 6 7 8  (after! treemacs (setq evil-treemacs-state-cursor \u0026#39;box treemacs-project-follow-cleanup t treemacs-width 25 ) (treemacs-follow-mode +1) )      Visual-regexp  1 2 3 4 5  (use-package! visual-regexp :commands (vr/select-replace vr/select-query-replace)) (use-package! visual-regexp-steriods :commands (vr/select-replace vr/select-query-replace))      Which-key   Doom Emacs default configuration is too slow, letâ€™s speed it up.\n1 2 3 4 5 6 7 8 9 10 11 12  (after! which-key (setq! which-key-idle-delay 0.1 which-key-idle-secondary-delay 0.2)) ;; dont display evilem-... (setq which-key-allow-multiple-replacements t) (after! which-key (pushnew! which-key-replacement-alist \u0026#39;((\u0026#34;\u0026#34; . \u0026#34;\\\\`+?evil[-:]?\\\\(?:a-\\\\)?\\\\(.*\\\\)\u0026#34;) . (nil . \u0026#34;â—‚\\\\1\u0026#34;)) \u0026#39;((\u0026#34;\\\\`g s\u0026#34; . \u0026#34;\\\\`evilem--?motion-\\\\(.*\\\\)\u0026#34;) . (nil . \u0026#34;â—ƒ\\\\1\u0026#34;)) ))      YASnippets  1 2 3 4 5 6 7  (setq yas-triggers-in-field t) (use-package! doom-snippets ; hlissner :after yasnippet) (use-package! yasnippet-snippets ; AndreaCrotti :after yasnippet)        Development Settings  1 2 3 4 5 6 7 8  (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;\\\\.js\\\\(x\\\\)?\\\\\u0026#39;\u0026#34; . rjsx-mode)) (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;\\\\.vue\\\\\u0026#39;\u0026#34; . web-mode)) (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;\\\\.[a-z]+rc$\u0026#34; . conf-mode)) (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;\\\\.vim\\\\(rc\\\\)?\\\\\u0026#39;\u0026#34; . vimrc-mode)) (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;[Mm]akefile\u0026#34; . makefile-gmake-mode)) (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;\\\\.mak$\u0026#34; . makefile-gmake-mode)) (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;\\\\.make$\u0026#34; . makefile-gmake-mode)) (add-to-list \u0026#39;auto-mode-alist \u0026#39;(\u0026#34;[._]bash.*\u0026#34; . shell-script-mode))    Web   Use `.prettierrc` file for prettier.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  (defun maybe-use-prettier () \u0026#34;Enable prettier-js-mode if an rc file is located.\u0026#34; (if (locate-dominating-file default-directory \u0026#34;.prettierrc\u0026#34;) (prettier-js-mode +1))) (add-hook \u0026#39;typescript-mode-hook \u0026#39;maybe-use-prettier) (add-hook \u0026#39;js2-mode-hook \u0026#39;maybe-use-prettier) (add-hook \u0026#39;web-mode-hook \u0026#39;maybe-use-prettier) (add-hook \u0026#39;rjsx-mode-hook \u0026#39;maybe-use-prettier) ;; set docsets (after! (:any js-mode js2-mode rjsx-mode web-mode typescript-mode) (set-docsets! \u0026#39;(js-mode js2-mode rjsx-mode web-mode typescript-mode) \u0026#34;JavaScript\u0026#34; \u0026#34;AngularJS\u0026#34; \u0026#34;Bootstrap_4\u0026#34; \u0026#34;jQuery\u0026#34; \u0026#34;NodeJS\u0026#34; \u0026#34;React\u0026#34; \u0026#34;VueJS\u0026#34; \u0026#34;TypeScript\u0026#34;))    jest  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  (use-package! jest :after js2-mode :config (advice-add #\u0026#39;jest--project-root :around (lambda (orig-fn \u0026amp;rest args) (if (string-match \u0026#34;exercism\u0026#34; (projectile-project-name)) (cl-letf (((symbol-function \u0026#39;projectile-project-root) (lambda (\u0026amp;rest _) (file-name-directory buffer-file-name)))) (apply orig-fn args)) (apply orig-fn args)))) (setq jest-pdb-track nil) (add-hook \u0026#39;jest-mode-hook (lambda () (evil-motion-state) )) (set-popup-rule! \u0026#34;*jest\\*\u0026#34; :size 20 :side \u0026#39;bottom :select t :quit t :modeline nil) )      react  1 2  (use-package! js-react-redux-yasnippets :after yasnippet)        Python  1 2 3 4 5 6 7 8 9 10 11 12 13 14  (after! python (set-docsets! \u0026#39;python-mode \u0026#34;Python_3\u0026#34;) (set-popup-rule! \u0026#34;*Python*\u0026#34; :size 16 :vslot -2 :side \u0026#39;bottom :select t :quit t :ttl nil :modeline nil) ) (after! python-pytest (advice-add #\u0026#39;python-pytest--find-test-file :around (lambda (orig-fn \u0026amp;rest args) (if (string-match \u0026#34;exercism\u0026#34; (projectile-project-name)) (concat (file-name-sans-extension (buffer-file-name)) \u0026#34;_test.py\u0026#34;) (apply orig-fn args)))) )      Java  Jdee ?       My Packages  Development  1 2 3 4 5 6 7 8 9  (package! dotenv-mode) (package! leetcode) (package! ob-restclient) ;; FIX: jq-set-var not found (package! restclient-jq :recipe (:host github :repo \u0026#34;pashky/restclient.el\u0026#34; :files (\u0026#34;restclient-jq.el\u0026#34;))) ;; (package! ob-jq)    WEB  1 2 3 4 5 6 7 8 9 10 11 12 13 14  (package! instant-rename-tag :recipe (:host github :repo \u0026#34;manateelazycat/instant-rename-tag\u0026#34;)) (package! js-doc) (package! js-react-redux-yasnippets) (package! jest) (package! phpactor) (package! prettier-js) (package! ob-typescript) (package! web-beautify) ;; (package! ts-comint) (package! dash-at-point :recipe (:host github :repo \u0026#34;waymondo/dash-at-point\u0026#34;))        F\u0026amp;D   File and directory management packages.\n1 2 3 4 5  (package! crux) (package! deft) (package! autoinsert) (package! ranger) (package! sudo-edit)      Window   Window management packages.\n1 2  (package! popper :recipe (:host github :repo \u0026#34;waymondo/popper\u0026#34;) :disable t)      Funny  1 2  (package! selectric-mode :pin \u0026#34;1840de71f7414b7cd6ce425747c8e26a413233aa\u0026#34;)      MacOS  1 2 3 4 5 6 7 8  (package! osx-lib) (package! emacs-everywhere :recipe (:host github :repo \u0026#34;tecosaur/emacs-everywhere\u0026#34;)) (package! systemd :pin \u0026#34;b6ae63a236605b1c5e1069f7d3afe06ae32a7bae\u0026#34;) (package! counsel-osx-app) (package! prodigy)      Markdown   Network  1 2 3 4 5 6  (package! counsel-tramp) (package! net-utils) (package! engine-mode) ;; (package! server) (package! verb) (package! httprepl)      Org  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  (package! counsel-org-clock) (package! doct :recipe (:host github :repo \u0026#34;progfolio/doct\u0026#34;)) ;; hightlight latex export results (package! engrave-faces :recipe (:host github :repo \u0026#34;tecosaur/engrave-faces\u0026#34;)) (package! org-appear) (package! org-chef) (package! org-fancy-priorities) (package! org-fragtog) (package! graphviz-dot-mode) (package! org-pandoc-import :recipe (:host github :repo \u0026#34;tecosaur/org-pandoc-import\u0026#34; :files (\u0026#34;*.el\u0026#34; \u0026#34;filters\u0026#34; \u0026#34;preprocessors\u0026#34;))) (package! org-super-agenda) (package! ox-gfm) (package! org-ol-tree :recipe (:host github :repo \u0026#34;Townk/org-ol-tree\u0026#34;)) (package! org-sort-tasks :recipe (:host github :repo \u0026#34;felipelalli/org-sort-tasks\u0026#34;)) (package! org-preview-html :disable t) (package! org-download) (package! org-roam) ;; (package! mathpix.el ;; :recipe ((:host github :repo \u0026#34;jethrokuan/mathpix.el\u0026#34;))) (package! lsp-latex)      PDF   Projectile  1 2 3 4 5  (package! bm) (package! imenu-list) (package! git-gutter) (package! projector) (package! yasnippet-snippets)      Search  1 2 3 4 5 6 7  (package! anzu) (package! deadgrep) (package! color-rg :recipe (:host github :repo \u0026#34;manateelazycat/color-rg\u0026#34;)) (package! visual-regexp) (package! visual-regexp-steriods :recipe (:host github :repo \u0026#34;benma/visual-regexp-steroids.el\u0026#34;)) (package! youdao-dictionary)      Text Operation  1 2 3 4 5 6 7 8 9 10 11 12 13  (package! cycle-quotes) (package! delsel) (package! hungry-delete) (package! move-text) (package! pangu-spacing) (package! pandoc-mode) (package! parrot) (package! string-inflection) (package! maple-iedit :recipe (:host github :repo \u0026#34;honmaple/emacs-maple-iedit\u0026#34;)) (package! vmd-mode) (package! vimrc-mode)      EAF  1 2 3 4 5 6 7 8  ;; (when (package! eaf :recipe (:host github ;; :repo \u0026#34;manateelazycat/emacs-application-framework\u0026#34; ;; :files (\u0026#34;*.el\u0026#34; \u0026#34;*.py\u0026#34; \u0026#34;app\u0026#34; \u0026#34;core\u0026#34;) ;; :build (:not compile))) ;; (package! ctable :recipe (:host github :repo \u0026#34;kiwanami/emacs-ctable\u0026#34;)) ;; (package! deferred :recipe (:host github :repo \u0026#34;kiwanami/emacs-deferred\u0026#34;)) ;; (package! epc :recipe (:host github :repo \u0026#34;kiwanami/emacs-epc\u0026#34;)))      Disabled  1  (disable-packages! bookmark tide eldoc valign grip-mode)        Practices  Evil-mode   å¸¸ç”¨çš„æŒ‰é”®ç»ƒä¹  1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ ğŸƒâ€â™‚ï¸ ã€‚\n å¯ä»¥é‡å†™çš„é”®å€¼ï¼Œç”¨å¤„ä¸å¤§ï¼š\n g _, g ^, g a, g A, g e/E, g i/I, g J, g l/L, g m, g n/N\n g o/O, g u/U, g v/V, g y/Y\n g [x]    å‡½æ•°å¤´å°¾è·³è½¬\n g [, beginning-of-defun\n g ], end-of-defun\n  æ³¨é‡Šå‰åä¸€è¡Œ\n g c -\u0026gt; [n] j/k, nc-comment-operator, [n] å¯ä»¥è¾“å…¥æ•°å­—æ¥è¯´æ˜å°†è¦è¢«æ³¨é‡Šçš„è¡Œæ•°\n  æŸ¥æ‰¾å¹¶æ‰“å¼€æ–‡ä»¶\n g f, +lookup/file, æ”¯æŒé“¾æ¥\n g F, evil-find-file-at-point-with-line, æ‰“å¼€æ–‡ä»¶å¹¶è·³åˆ°å¯¹åº”çš„è¡Œ\n å¦‚ï¼š ~/github/tmp/test/a.js:10 æŒ‰ä¸‹ g f/F åä¼šç›´æ¥åœ¨å½“å‰çª—å£å†…æ‰“å¼€è¯¥\n æ–‡ä»¶å¹¶ä¸”è·³è½¬åˆ°ç¬¬ 10 è¡Œã€‚\n  è·³åˆ°æ ‡é¢˜ä½ç½®\n g h, org-up-element, å½“å‰çš„æ ‡é¢˜å¤„\n g H, org-top, å½“å‰çš„ä¸€çº§æ ‡é¢˜å¤„, æ¯”å¦‚åœ¨è¿™é‡ŒæŒ‰ä¼šè·³åˆ° Practices\n g j, org-forward-element, ä¸‹ä¸€ä¸ªåŒçº§å…ƒç´ (æ ‡é¢˜ï¼Œæ®µï¼Œè¡Œï¼Œç­‰)\n g k, org-backward-element, ä¸Šä¸€ä¸ªåŒçº§å…ƒç´ (æ ‡é¢˜ï¼Œæ®µï¼Œè¡Œï¼Œç­‰)\n  imenu\n g O, imenu\n  ç²˜è´´æ›¿æ¢\n g p, /alt-paste , é€‰ä¸­çŠ¶æ€ï¼ŒæŒ‰ä¸‹åå°†ç²˜è´´æ¿ä¸Šçš„å†…å®¹æ›¿æ¢é€‰ä¸­çš„å†…å®¹\n  å¡«å……æ–‡æœ¬\n g w/W, evil-fill\n g q, fill-and-move, å°†æŒä¸­å†…å®¹å˜æˆä¸€è¡Œï¼Ÿ\n g Q, org-fill-paragraph\n å®ç”¨æ¡ˆä¾‹ï¼Œå¦‚ï¼š\ntest1 test2 test3 test4 test5 test6 test7 test8 test9   é€‰ä¸­ä¸Šé¢çš„ test1-9 æŒ‰ä¸‹ g q åå˜æˆï¼š\ntest1 test2 test3 test4 test5 test6 test7 test8 test9   è¿™å¯¹æ–‡æœ¬æ ¼å¼åŒ–æŒºæœ‰ç”¨çš„ã€‚\n  æ‰§è¡Œä»£ç \n g r, +eval:region, æ‰§è¡Œé€‰ä¸­åŒºåŸŸä»£ç \n g R, +eval/buffer, æ‰§è¡Œæ•´ä¸ª Buffer\n  åˆ‡æ¢å·¥ä½œåŒº\n g t/T, +workspace:switch-next/previous åˆ‡æ¢å·¥ä½œåŒº\n  äº¤æ¢ï¼Œéœ€è¦å…ˆé€‰ä¸­\n g x/X, evil-exchange\n å¦‚ï¼š aaa - bbb\n -\u0026gt; é€‰ä¸­ aaa -\u0026gt; gx -\u0026gt; é€‰ä¸­ bbb -\u0026gt; gx\n ç»“æœï¼š bbb - aaa\n    g s, æœç´¢å®šä½   é€šè¿‡æŒ‰ä¸‹ç»„åˆé”®ä¹‹åï¼Œæ ¹æ®æ˜¾ç¤ºçš„å­—ç¬¦æ¥å°†å…‰æ ‡å®šä½åˆ°è¾“å…¥çš„å­—ç¬¦ä½ç½®ã€‚\n  æ‰€æœ‰çª—å£\n gs -\u0026gt; SPC, closure\n  å—ï¼Œå‰åŠéƒ¨åˆ†\n gs -\u0026gt; [[, backward-section-begin, å®šä½å½“å‰ä½ç½®å‰åŠéƒ¨åˆ†å—é¦–\n gs -\u0026gt; [], backward-section-end, å®šä½å½“å‰ä½ç½®å‰åŠéƒ¨åˆ†å—å°¾\n  å—ï¼ŒååŠéƒ¨åˆ†\n gs -\u0026gt; ][, forward-section-begin, å®šä½å½“å‰ä½ç½®ååŠéƒ¨åˆ†å—é¦–\n gs -\u0026gt; ]], forward-section-end, å®šä½å½“å‰ä½ç½®ååŠéƒ¨åˆ†å—å°¾\n  search\n gs -\u0026gt; #, search-word-backward\n gs -\u0026gt; *, search-word-forward\n  éç©ºè¡Œ\n gs -\u0026gt; -, previous-line-first-non-blank, å‘å‰\n gs -\u0026gt; +, next-line-first-non-blank, å‘å\n  avy\n gs -\u0026gt; /,, avy-goto-char-timer\n gs -\u0026gt; l, avy-goto-char-0, é›¶å­—ç¬¦æœç´¢\n gs -\u0026gt; s, avy-goto-char-2, ä¸¤ä¸ªå­—ç¬¦æœç´¢\n  å•è¯å¼€å§‹å’Œç»“æŸ\n gs -\u0026gt; b/B, backward-word|WORD-begin, å‘å\n gs -\u0026gt; [g] e/E, backward-word|WORD-end, å‘å\n gs -\u0026gt; w/W, forward-word|WORD-begin, å‘å‰\n  æŸ¥æ‰¾å­—ç¬¦\n gs -\u0026gt; f, find-char, å‘å‰\n gs -\u0026gt; F, find-char-backward, å‘å\n gs -\u0026gt; t, find-char-to\n gs -\u0026gt; T, find-char-to-backward\n  å¯è§†è¡Œ, å³å¿½ç•¥æŠ˜å çš„è¡Œ\n gs -\u0026gt; gj, next-visual-line\n gs -\u0026gt; gk, previous-visual-line\n  ä¸Šä¸‹è¡Œ\n gs -\u0026gt; j, next-line\n gs -\u0026gt; k, previous-line\n      Embrace(,e)   practices placeâ€¦\nembrach-add(,ea)   embrach-change(,ec)   embrach-delete(,ed)     Emms     ","permalink":"https://www.cheng92.com/emacs/doom-emacs-with-org/","tags":null,"title":"Doom Emacs Configuration"},{"categories":null,"contents":"","permalink":"https://www.cheng92.com/search/","tags":null,"title":"Search Results"}]