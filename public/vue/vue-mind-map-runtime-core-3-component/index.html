<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 源码头脑风暴之 7 ☞ runtime-core(3) - render component - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 本文为" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-runtime-core-3-component/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.9d6c07951e716411e0fdd9d1d7616cb41ced57b53993154c49ea809e194527af.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 源码头脑风暴之 7 ☞ runtime-core(3) - render component" />
<meta property="og:description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 本文为" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-runtime-core-3-component/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2021-03-16T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-03-16T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 源码头脑风暴之 7 ☞ runtime-core(3) - render component">
<meta itemprop="description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 本文为"><meta itemprop="datePublished" content="2021-03-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="19527">
<meta itemprop="keywords" content="vue,,vue3,,runtime-core,,render,,component," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 源码头脑风暴之 7 ☞ runtime-core(3) - render component"/>
<meta name="twitter:description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 本文为"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 源码头脑风暴之 7 ☞ runtime-core(3) - render component</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-03-16 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> 约 19527 字 </span>
          <span class="more-meta"> 预计阅读 39 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#mindmap">流程图(脑图)</a>
</li>
<li><a href="#render-component">processComponent(如何patch组件的？)</a>
<ul>
<li><a href="#headline-3">effect update component</a>
</li>
<li><a href="#norm-props-opt">normalize props options</a>
</li>
<li><a href="#component-props">component props</a>
</li>
<li><a href="#setup">component setup</a>
</li>
<li><a href="#comp-update">component update</a>
</li>
<li><a href="#comp-slots">component slots</a>
<ul>
<li><a href="#init-slots">初始化(<code>initSlots()</code>)：</a>
</li>
<li><a href="#update-slots">更新(<code>updateSlots()</code>)</a>
</li>
</ul>
</li>
<li><a href="#headline-11">props tests</a>
</li>
<li><a href="#headline-12">component unmount</a>
</li>
<li><a href="#headline-13">normalize emits options</a>
</li>
<li><a href="#headline-14">问题</a>
<ul>
<li><a href="#q-allow-recurse">TypeError: Cannot read property &#39;allowRecurse&#39; of null</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#render-text">processText|Comment|Static</a>
<ul>
<li><a href="#Text">Text</a>
</li>
<li><a href="#Comment">Comment</a>
</li>
<li><a href="#Static">Static</a>
</li>
</ul>
</li>
<li><a href="#render-fragment">processFragment</a>
</li>
<li><a href="#teleport">TELEPORT</a>
<ul>
<li><a href="#headline-22">新增代码:</a>
</li>
<li><a href="#teleport-process">process()</a>
</li>
<li><a href="#headline-24">测试</a>
</li>
</ul>
</li>
<li><a href="#suspense">SUSPENSE</a>
<ul>
<li><a href="#headline-26">SuspenseBoundary 数据结构</a>
</li>
<li><a href="#suspense-mount">mountSuspense()</a>
</li>
<li><a href="#suspense-resolve">suspense.resolve()</a>
</li>
<li><a href="#suspense-move">suspense.move()</a>
</li>
<li><a href="#suspense-register-dep">suspense.registerDep()</a>
</li>
<li><a href="#headline-31">patchSuspense()</a>
</li>
<li><a href="#suspense-other">suspense.unmount&amp;fallback&amp;其他</a>
</li>
<li><a href="#headline-33">Suspense 组件测试</a>
</li>
<li><a href="#headline-34">小结</a>
</li>
</ul>
</li>
<li><a href="#keep-alive">KEEP_ALIVE</a>
<ul>
<li><a href="#keep-alive-activate">activate()</a>
</li>
<li><a href="#keep-alive-deactivate">deactivate()</a>
</li>
<li><a href="#keep-alive-unmount">unmount()</a>
</li>
<li><a href="#keep-alive-include-exclude">include &amp; exclude props</a>
</li>
<li><a href="#keep-alive-cache-subtree">cache subtree</a>
</li>
<li><a href="#keep-alive-setup-render">setup() -&gt; render 函数</a>
</li>
<li><a href="#keep-alive-tests">测试</a>
</li>
</ul>
</li>
<li><a href="#ref">set ref</a>
</li>
<li><a href="#dir-hooks">direcitve hooks</a>
</li>
<li><a href="#component-props">component props</a>
</li>
<li><a href="#testing">测试</a>
<ul>
<li><a href="#headline-47">脑图 &amp; 测试结果 GIF</a>
</li>
</ul>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<script src="/js/utils.js"></script>
<script src="/js/vue/vue-next.js"></script>
<!--<script src="https://unpkg.com/vue@next"></script>-->
<script>
insertCssLink("https://unpkg.com/element-plus/lib/theme-chalk/index.css");
</script>
<script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> 完全拷贝于 <a href="https://github.com/vuejs/vue-next">vue-next</a> ，主要目的用于学习。</strong>
</kbd></p>
<blockquote>
<p>本文为 runtime-core(2) 续集，上篇： <a href="/vue/vue-mind-map-runtime-core-2-render/">Vue3 源码头脑风暴之 7 ☞ runtime-core(2) - render</a></p>
</blockquote>
<div id="outline-container-mindmap" class="outline-2">
<h2 id="mindmap">
流程图(脑图)
</h2>
<div id="outline-text-mindmap" class="outline-text-2">
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-render-component.svg" alt="/img/vue3/runtime-core/vue-runtime-core-render-component.svg" title="/img/vue3/runtime-core/vue-runtime-core-render-component.svg" /></p>
<p>
这一节新增内容较多，主要新增以下几个函数</p>
<ol>
<li>
<p><code>processComponent()</code> 在 patch() 中执行 switch default 分支，满足
<code>ShapeFlags.COMPONENT</code> 条件</p>
</li>
<li>
<p><code>mountComponent(n2,...)</code> 首次加载组件时调用的函数</p>
</li>
<li>
<p><code>setupComponent(instance)</code> 建立组件实例，做一些结构初始化操作(如：props和
slots)等</p>
</li>
<li>
<p><code>setupStatefulComponent(instance,isSSR)</code> 创建有状态组件，执行 <code>setup()</code> 函数</p>
</li>
<li>
<p><code>setupRenderEffect()</code> 通过 <a href="/vue/vue-mind-map-reactivity/#fn-effect">effect()</a> 函数返回 <code>instance.update</code> 创建一个监听-
更新函数。</p>
</li>
<li>
<p><code>finishComponentSetup(instance,isSSR)</code> 这个函数在 <code>setupStatefulComponent()</code>
中调用，主要做的事情是处理 SSR，没有 render 函数有 template 时调用 compile 编
译出 render 函数，兼容 2.x 的 options api</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-render-component" class="outline-2">
<h2 id="render-component">
processComponent(如何patch组件的？)
</h2>
<div id="outline-text-render-component" class="outline-text-2">
<p>
问题修复： <a href="#q-allow-recurse">TypeError: Cannot read property &#39;allowRecurse&#39; of null</a></p>
<p>
<code>processComponent(n1,n2,...)</code> 函数主要分三种情况</p>
<ol>
<li>
<p>mount, 没有 n1 old 时候，属于纯 mount 操作</p>
<ol>
<li>
<p>keep-alive 类型，只需要重新激活 activate</p>
</li>
<li>
<p>否则执行 mountComponent(n2, ….) 首次加载组件</p>
</li>
</ol>
</li>
<li>
<p>update, 非首次加载执行更新操作</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">parentVnode</span><span class="p">,</span> <span class="nx">childVnode1</span><span class="p">,</span> <span class="nx">childVnode2</span><span class="p">;</span>

    <span class="kr">const</span> <span class="nx">Parent</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// return h(&#34;div&#34;, &#34;测试...&#34;);
</span><span class="c1"></span>        <span class="k">return</span> <span class="p">(</span><span class="nx">parentVnode</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Child</span><span class="p">));</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">Child</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">value</span>
          <span class="o">?</span> <span class="p">(</span><span class="nx">childVnode1</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;child 1&#34;</span><span class="p">))</span>
          <span class="o">:</span> <span class="p">(</span><span class="nx">childVnode2</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;span&#34;</span><span class="p">,</span> <span class="s2">&#34;child 2&#34;</span><span class="p">));</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Parent</span><span class="p">);</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">root</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedroot:
component stateful ? 4
call setup
no setup
[Function: render] render
mount component
normalize vnode
patch component
component stateful ? 4
call setup
no setup
[Function: render] render
mount component
normalize vnode
patch component
root: &lt;div&gt;child 1&lt;/div&gt;
root: &lt;div&gt;child 1&lt;/div&gt;
component update
</pre>
<p>
流程简图：</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-render-component-brief.svg" alt="/img/vue3/runtime-core/vue-runtime-core-render-component-brief.svg" title="/img/vue3/runtime-core/vue-runtime-core-render-component-brief.svg" /></p>
<p>
这里执行就是 <code>mountComponent(n2,...)</code> 行为，首次加载组件，完成：</p>
<ol>
<li>
<p><code>setupComponent(instance)</code> 执行 setup 函数，初始化 props&amp;slots 等</p>
</li>
<li>
<p><code>setupRenderEffect(instance,...)</code> 注册 instance.update effect</p>
<p>
当实例状态发生改变时执行这个 effect fn，如果是首次(父级调用 processComponent)
执行!isMounted 分支进行组件首次加载，否则当组件自身状态改变是触发的 update 操
作</p>
</li>
</ol>
<p>
在 <code>setupComponent</code> 中，主要完成</p>
<ol>
<li>
<p>initProps</p>
</li>
<li>
<p>initSlots</p>
</li>
<li>
<p>setupStatefulComponent(instance,isSSR) 有状态组件(非函数组件)</p>
</li>
</ol>
<p>
紧接着 <code>setupStatefulComponent(instance,isSSR)</code> 中检测 setup 函数，并执行它，如
果没有 setup 函数就进入 finishComponentSetup(instance) 检测 render 或 template
最终目的是获得 render 函数，如果没有 render 会通过 compile(template) 编译出
render 函数，最后在 instance.update 中执行 render 函数(在这前后会触发
beforeMount 和 mounted 周期函数)。</p>
<blockquote>
<p>所以，一套流程下来可以简单描述为</p>
<p>
mount -&gt; props&amp;slots 初始化 -&gt; setup() -&gt; 有状态组件处理得到 render 函数 -&gt; 最后
通过 instance.update effect 来监听实例状态变化，触发 mount 或者 update。</p>
<p>
在 effect mount 阶段会触发生命周期函数：</p>
<ol>
<li>
<p>beforeMount + mounted</p>
</li>
<li>
<p>onVnodeBeforeMount + onVnodeMounted(针对 vnode 结构变化而言)</p>
</li>
<li>
<p>activated(如果是 keep-alive 的话)</p>
</li>
</ol>
<p>组件的渲染就发生在 beforeMount 之后 mounted 之前的 renderComponentRoot() 得到
vnode 交给 patch 去进行渲染。</p>
</blockquote>
<p>
示例代码中，后面修改了 <code>value.value=false</code> 后面 dom 并没改变，但是输出了
<em>component update</em> 说明进入了 <code>instance.update effect</code> 的 else 分支，因为不是第
一次，所以这里需要实现更新组件部分。</p>
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
effect update component
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<p>
因为 instance.update 是通过 <code>effect()</code> 封装的函数，且这个函数中使用到了 instance
实例而这个实例又在 setupComponent 中有做过代理，因此对它的访问会触发 effect
track，状态更新会触发 effect trigger(响应式原理)。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/12544657c05c740c09a3632e0e2cf9ec9e29ca67">feat(add): component update · gcclll/stb-vue-next@1254465</a></p>
<p>
涉及的修改：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">instance</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(</span>
  <span class="kd">function</span> <span class="nx">componentEffect() {</span>
    <span class="c1">// 监听更新
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// updateComponent
</span><span class="c1"></span>      <span class="c1">// 当组件自身的状态或父组件调用 processComponent 时触发
</span><span class="c1"></span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;component update&#34;</span><span class="p">);</span>
      <span class="kd">let</span> <span class="p">{</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">bu</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">vnode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">originNext</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">vnodeHook</span>: <span class="kt">VNodeHook</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
        <span class="nx">updateComponentPreRender</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">optimized</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">next</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// beforeUpdate hook
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">bu</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">invokeArrayFns</span><span class="p">(</span><span class="nx">bu</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// onVnodeBeforeUpdate
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">((</span><span class="nx">vnodeHook</span> <span class="o">=</span> <span class="nx">next</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">onVnodeBeforeUpdate</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">invokeVNodeHook</span><span class="p">(</span><span class="nx">vnodeHook</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">//render
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">nextTree</span> <span class="o">=</span> <span class="nx">renderComponentRoot</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">prevTree</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">subTree</span><span class="p">;</span>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">subTree</span> <span class="o">=</span> <span class="nx">nextTree</span><span class="p">;</span>

      <span class="nx">patch</span><span class="p">(</span>
        <span class="nx">prevTree</span><span class="p">,</span>
        <span class="nx">nextTree</span><span class="p">,</span>
        <span class="c1">// 如果在 teleport 中，parent 可能会发生改变
</span><span class="c1"></span>        <span class="nx">hostParentNode</span><span class="p">(</span><span class="nx">prevTree</span><span class="p">.</span><span class="nx">el</span><span class="o">!</span><span class="p">)</span><span class="o">!</span><span class="p">,</span>
        <span class="c1">// anchor may have changed if it&#39;s in a fragment
</span><span class="c1"></span>        <span class="nx">getNextHostNode</span><span class="p">(</span><span class="nx">prevTree</span><span class="p">),</span>
        <span class="nx">instance</span><span class="p">,</span>
        <span class="nx">parentSuspense</span><span class="p">,</span>
        <span class="nx">isSVG</span>
      <span class="p">);</span>

      <span class="nx">next</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">nextTree</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">originNext</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// self-triggered update. In case of HOC, update parent component
</span><span class="c1"></span>        <span class="c1">// vnode el. HOC is indicated by parent instance&#39;s subTree pointing
</span><span class="c1"></span>        <span class="c1">// to child component&#39;s vnode
</span><span class="c1"></span>        <span class="c1">// TODO
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="c1">// updated hook
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">u</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// onVnodeUpdated
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">((</span><span class="nx">vnodeHook</span> <span class="o">=</span> <span class="nx">next</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">onVnodeUpdated</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">queuePostRenderEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">invokeVNodeHook</span><span class="p">(</span><span class="nx">vnodeHook</span><span class="o">!</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">next</span><span class="o">!</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">__DEV__</span>
    <span class="o">?</span> <span class="c1">// 提供 onTrack/onTrigger 选项执行 rtc&amp;rtg 两个周期函数
</span><span class="c1"></span>      <span class="nx">createDevEffectOptions</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
    <span class="o">:</span> <span class="nx">prodEffectOptions</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
和 updateComponentPreRender 实现这个函数让 instance.update 在 nextTick() 之后执
行 pre 优先于 post 和 job 任务(<a href="/vue/vue-mind-map-runtime-core/#scheduler">详情查看任务调度-&gt;</a>)：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">updateComponentPreRender</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
    <span class="nx">nextVNode</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">optimized</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">nextVNode</span><span class="p">.</span><span class="nx">component</span> <span class="o">=</span> <span class="nx">instance</span>
    <span class="c1">// const prevProps = instance.vnode.props
</span><span class="c1"></span>    <span class="nx">instance</span><span class="p">.</span><span class="nx">vnode</span> <span class="o">=</span> <span class="nx">nextVNode</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="c1">// TODO update props
</span><span class="c1"></span>    <span class="c1">// TODO update slots
</span><span class="c1"></span>
    <span class="c1">// props update may have triggered pre-flush watchers.
</span><span class="c1"></span>    <span class="c1">// flush them before the render update.
</span><span class="c1"></span>    <span class="nx">flushPreFlushCbs</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">update</span><span class="p">)</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
之前的用例再测试一遍：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="kr">async</span> <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">parentVnode</span><span class="p">,</span> <span class="nx">childVnode1</span><span class="p">,</span> <span class="nx">childVnode2</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">idValue</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="s2">&#34;parent&#34;</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">Parent</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;parent render&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">parentVnode</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">idValue</span><span class="p">.</span><span class="nx">value</span> <span class="p">},</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Child</span><span class="p">)));</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">Child</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;child render&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">value</span>
          <span class="o">?</span> <span class="p">(</span><span class="nx">childVnode1</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;child 1&#34;</span><span class="p">))</span>
          <span class="o">:</span> <span class="p">(</span><span class="nx">childVnode2</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;span&#34;</span><span class="p">,</span> <span class="s2">&#34;child 2&#34;</span><span class="p">));</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Parent</span><span class="p">);</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">root</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before change value&#34;</span><span class="p">);</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after change value&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before id change&#39;</span><span class="p">);</span>
    <span class="nx">idValue</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;parent-id&#39;</span>
    <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;after id change&#39;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">()</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedroot:
component stateful ? 4
call setup
no setup
[Function: render] render
mount component
normalize vnode
parent render
patch component
component stateful ? 4
call setup
no setup
[Function: render] render
mount component
normalize vnode
child render
patch component
root: &lt;div id=&#34;parent&#34;&gt;&lt;div&gt;child 1&lt;/div&gt;&lt;/div&gt;
before change value
component update
normalize vnode
child render
after change value
root: &lt;div id=&#34;parent&#34;&gt;&lt;span&gt;child 2&lt;/span&gt;&lt;/div&gt;
before id change
component update
normalize vnode
parent render
after id change
root: &lt;div id=&#34;parent&#34;&gt;&lt;span&gt;child 2&lt;/span&gt;&lt;/div&gt;
</pre>
<p>
这里要让输出达到效果，需要将 resolve 改成 async function 并且要在 nextTick() 后
输出更新后的结果，因为 instance.update 调用了 <code>flushPreFlushCbs(null,
instane.update)</code> 也就是说这个函数是个异步更新，且会在 <code>nextTick()</code> 后触发，详情
分析查看“<a href="/vue/vue-mind-map-runtime-core/#scheduler">任务调度机制分析</a>”</p>
<blockquote>
<p>问题： 如上面的结果，当我们改变 <code>idValue.value=&#34;parent-id&#34;</code> 的时候，实际结果并没
有改变？</p>
<p>
答： 因为在 <code>setupComponent()</code> 中的 <code>initProps()</code> 以及 <code>updateComponentPreRender()</code>
中的 <code>updateProps()</code> 还没实现，下一节揭晓。</p>
</blockquote>
</div>
</div>
<div id="outline-container-norm-props-opt" class="outline-3">
<h3 id="norm-props-opt">
normalize props options
</h3>
<div id="outline-text-norm-props-opt" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7d6ac555be06253f6dab5af8d6a0c2df8b46b656">feat(add): normalize props options · gcclll/stb-vue-next@7d6ac55</a></p>
<p>
对应官方文档内容： <a href="https://v3.vuejs.org/guide/component-props.html#prop-types">Props | Vue.js</a></p>
<blockquote>
<p>这里作用简单描述就是，将 props 的定义在组件加载初始化时解析成具体的值，如：
<code>props: [&#39;foo&#39;]</code> 解析成 <code>foo={}</code> 因为字符串数组的 props 会给每个属性初始化一个空
对象。</p>
</blockquote>
<p>
比如：</p>
<ol>
<li>
<p>数组： <code>props: [&#39;foo&#39;, &#39;bar&#39;, &#39;foo-bar&#39;]</code></p>
<p>
 转成 <code>{foo: {}, bar: {}, fooBar: {}}</code></p>
</li>
<li>
<p>对象: <code>props: { foo: [Boolean, String], bar: Function }</code></p>
<p>
表示 foo 可以是布尔值或字符串，bar 是个函数</p>
<p>
转换过程(0: <code>BooleanFlags.shouldCast</code>, 1: <code>BooleanFlags.shouldCastTrue</code>)</p>
<p>
<code>foo = { type: [Boolean, String] }</code> -&gt; 找 Boolean</p>
<p>
<code>foo = { type: [Boolean, String], 0: true }</code> -&gt;</p>
<p>
找 String 需满足 <code>stringIndex &lt; 0 || booleanIndex &lt; stringIndex</code></p>
<p>
<code>foo = { type: [Boolean, String], 0: true, 1: true }</code></p>
<p>
最后决定 <code>foo</code> 是不是应该进行 cast ? 条件是布尔类型或者有 default 默认值。</p>
</li>
</ol>
<p>
源码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizePropsOptions</span><span class="p">(</span>
  <span class="nx">comp</span>: <span class="kt">ConcreteComponent</span><span class="p">,</span>
  <span class="nx">appContext</span>: <span class="kt">AppContext</span><span class="p">,</span>
  <span class="nx">asMixin</span>: <span class="kt">false</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">NormalizedPropsOptions</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">appContext</span><span class="p">.</span><span class="nx">deopt</span> <span class="o">&amp;&amp;</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">__props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">__props</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">props</span>
  <span class="kr">const</span> <span class="nx">normalized</span>: <span class="kt">NormalizedPropsOptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kr">const</span> <span class="nx">needCastKeys</span>: <span class="kt">NormalizedPropsOptions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1">// mixin/extends props 应用
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">hasExtends</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="c1">// 必须开支 2.x options api 支持，且不是函数式组件
</span><span class="c1"></span>  <span class="c1">// 继承来的属性，用法： ~CompA = { extends: CompB, ... }~
</span><span class="c1"></span>  <span class="c1">// CompA 会继承 CompB 的 props
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_OPTIONS_API__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">comp</span><span class="p">))</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">extendProps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">raw</span>: <span class="kt">ComponentOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">hasExtends</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="kr">const</span> <span class="p">[</span><span class="nx">props</span><span class="p">,</span> <span class="nx">keys</span><span class="p">]</span> <span class="o">=</span> <span class="nx">normalizePropsOptions</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">appContext</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">extend</span><span class="p">(</span><span class="nx">normalized</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">needCastKeys</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">keys</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Comp: { extends: CompA } 处理
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="kr">extends</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">extendProps</span><span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="kr">extends</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Comp: { mixins: [mixin] } 处理
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">asMixin</span> <span class="o">&amp;&amp;</span> <span class="nx">appContext</span><span class="p">.</span><span class="nx">mixins</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">appContext</span><span class="p">.</span><span class="nx">mixins</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">extendProps</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 既没有自身的 props 也没有 extends 继承来的 props 初始化为 []
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">raw</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasExtends</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">__props</span> <span class="o">=</span> <span class="nx">EMPTY_ARR</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">raw</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 当 props 是数组的时候，必须是字符类型，如: props: [&#39;foo&#39;, &#39;bar&#39;, &#39;foo-bar&#39;]
</span><span class="c1"></span>    <span class="c1">// &#39;foo-bar&#39; 会转成 &#39;fooBar&#39;，不允许 &#39;$xxx&#39; 形式的变量名
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">raw</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">normalizedKey</span> <span class="o">=</span> <span class="nx">camelize</span><span class="p">(</span><span class="nx">raw</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="c1">// 组件的属性名不能是以 $xx 开头的名称，这个是作为内部属性的
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">validatePropName</span><span class="p">(</span><span class="nx">normalizedKey</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">normalized</span><span class="p">[</span><span class="nx">normalizedKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">EMPTY_OBJ</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">raw</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 对象类型 props: { foo: 1, bar: 2, ... }
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">raw</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// &#39;foo-bar&#39; -&gt; &#39;fooBar&#39;
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">normalizedKey</span> <span class="o">=</span> <span class="nx">camelize</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="c1">// 检查 $xxx 非法属性
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">validatePropName</span><span class="p">(</span><span class="nx">normalizedKey</span><span class="p">))</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">raw</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="c1">// ? 值为数组或函数变成： { type: opt } ?
</span><span class="c1"></span>        <span class="c1">// 这里含义其实是： ~props: { foo: [Boolean, Function] }~
</span><span class="c1"></span>        <span class="c1">// 可以用数组定义该属性可以是多种类型的其中一种
</span><span class="c1"></span>        <span class="kr">const</span> <span class="nx">prop</span>: <span class="kt">NormalizedProp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">normalized</span><span class="p">[</span><span class="nx">normalizedKey</span><span class="p">]</span> <span class="o">=</span>
          <span class="nx">isArray</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="o">?</span> <span class="p">{</span> <span class="kr">type</span><span class="o">:</span> <span class="nx">opt</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">opt</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// 找到 Boolean 在 foo: [Boolean, Function] 中的索引
</span><span class="c1"></span>          <span class="kr">const</span> <span class="nx">booleanIndex</span> <span class="o">=</span> <span class="nx">getTypeIndex</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">,</span> <span class="nx">prop</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span>
          <span class="kr">const</span> <span class="nx">stringIndex</span> <span class="o">=</span> <span class="nx">getTypeIndex</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nx">prop</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span>
          <span class="nx">prop</span><span class="p">[</span><span class="nx">BooleanFlags</span><span class="p">.</span><span class="nx">shouldCast</span><span class="p">]</span> <span class="o">=</span> <span class="nx">booleanIndex</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
          <span class="c1">// [String, Boolean] 类型，String 在 Boolean 前面
</span><span class="c1"></span>          <span class="nx">prop</span><span class="p">[</span><span class="nx">BooleanFlags</span><span class="p">.</span><span class="nx">shouldCastTrue</span><span class="p">]</span> <span class="o">=</span>
            <span class="nx">stringIndex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">booleanIndex</span> <span class="o">&lt;</span> <span class="nx">stringIndex</span>
          <span class="c1">// 如果是布尔类型的值或者有默认值的属性需要转换
</span><span class="c1"></span>          <span class="c1">// 转换是根据 type 和 default 值处理
</span><span class="c1"></span>          <span class="c1">// type非函数，default是函数，执行 default() 得到默认值
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="nx">booleanIndex</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">prop</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">needCastKeys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">normalizedKey</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">__props</span> <span class="o">=</span> <span class="p">[</span><span class="nx">normalized</span><span class="p">,</span> <span class="nx">needCastKeys</span><span class="p">])</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
然后这个处理之后的 props，会被保存到组件的 <code>comp.__props=[normalied,
needCastKeys]</code> 上，而这个会在 <code>resolvePropValue()</code> 中进一步处理，这里的
<code>needCastKeys</code> 非常重要，它会决定最后的值应该如何被处理(<code>resolvePropValue</code> 中处
理)。</p>
<p>
比如： <code>{ type: String, default: () =&gt; &#39;xxx&#39; }</code> 那么满足 <code>type!==Function &amp;&amp;
isFunction(dfault)</code> 则会直接执行 default() 得到属性默认值。</p>
<p>
如果属性的 <code>opt[BooleanFlags.shouldCast]</code> 为 <code>true</code> 如<a href="#norm-props-opt">最开始的说明</a>，其实就是
<code>prop[&#34;0&#34;]</code> 的值，只要 prop 的类型中有 <code>Boolean</code> 这个值就是 <code>true</code> 。</p>
<p>
此时需要将属性的值转成</p>
<ol>
<li>
<p><strong>true</strong> : 类型声明中有 <code>Boolean</code> 且有 <code>String</code> 的时候，它的值如果是 <code>&#39;&#39;</code> 或者
<code>key === value</code> 情况下转成 <code>true</code>, 因为指定了可以是 <code>String</code> 类型，所以空字符
串是允许的。</p>
</li>
<li>
<p><strong>false</strong> : <code>(!hasOwn(props, key) &amp;&amp; !hasDefault)</code>, raw props 中没有这个属性且
没有 <code>default</code> 默认值的时候转成 <code>false</code>, 等于是假值类型。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-component-props" class="outline-3">
<h3 id="component-props">
component props
</h3>
<div id="outline-text-component-props" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9a6aa70c2109179a884b1496eea09af50a6efdb5">feat(add): init component props · gcclll/stb-vue-next@9a6aa70</a></p>
<p>
新增代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// component.ts &gt; setupComponent()
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">setupComponent</span><span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">isSSR</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// init props &amp; slots
</span><span class="c1"></span>  <span class="nx">initProps</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">isStateful</span><span class="p">,</span> <span class="nx">isSSR</span><span class="p">);</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">setupResult</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>componentProps.ts &gt; initProps()</strong></p>
<ol>
<li>
<p>def -&gt; attrs.__vInterval = 1</p>
</li>
<li>
<p>setFullProps 处理 rawProps 将结果反馈到 props 和 attrs</p>
</li>
<li>
<p>有状态组件？将 props reactive 化，SSR下不支持属性响应式其实就是服务器返回的属
性都是带有最终值的而不是在客户端动态能改变的</p>
</li>
<li>
<p>函数组件的 props 可选属性和必须属性？可选用  attrs 否则用 props</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">initProps</span><span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">rawProps</span>: <span class="kt">Data</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">isStateful</span>: <span class="kt">number</span><span class="p">,</span>
  <span class="nx">isSSR</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">props</span>: <span class="kt">Data</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kr">const</span> <span class="nx">attrs</span>: <span class="kt">Data</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">def</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">InternalObjectKey</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nx">setFullProps</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">rawProps</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">);</span>
  <span class="c1">// TODO validation
</span><span class="c1"></span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isStateful</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">isSSR</span> <span class="o">?</span> <span class="nx">props</span> : <span class="kt">shallowReactive</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span><span class="p">.</span><span class="kr">type</span><span class="p">.</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// functional optional props, props === attrs
</span><span class="c1"></span>      <span class="nx">instance</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// functional declared props
</span><span class="c1"></span>      <span class="nx">instance</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">instance</span><span class="p">.</span><span class="nx">attrs</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>componentProps.ts &gt; setFullProps()</strong>
这个函数目的是将 rawProps 组件的 props 解析出来根据各自特性
分派到 props 或 attrs</p>
<ol>
<li>
<p>key, ref 属性不保留，因为组件更新时 key 可能发生改变，ref引用也会变好指向更新后的 DOM 元素</p>
</li>
<li>
<p>options 啥意思？</p>
</li>
<li>
<p>事件属性(<code>onClick</code>)会存放到 attrs !</p>
</li>
<li>
<p>needCastKeys ? 这是做啥呢 resolvePropValue？</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">setFullProps</span><span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">rawProps</span>: <span class="kt">Data</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">props</span>: <span class="kt">Data</span><span class="p">,</span>
  <span class="nx">attrs</span>: <span class="kt">Data</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">options</span><span class="p">,</span> <span class="nx">needCastKeys</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">propsOptions</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rawProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">rawProps</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">rawProps</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="c1">// key, ref 保留，不往下传
</span><span class="c1"></span>      <span class="c1">// 即这两个属性不会继承给 child
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">isReservedProp</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nx">camelKey</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">camelKey</span> <span class="o">=</span> <span class="nx">camelize</span><span class="p">(</span><span class="nx">key</span><span class="p">))))</span> <span class="p">{</span>
        <span class="nx">props</span><span class="p">[</span><span class="nx">camelKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmitListener</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">emitsOptions</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">attrs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">needCastKeys</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">rawCurrentProps</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">needCastKeys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">needCastKeys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">props</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">resolvePropValue</span><span class="p">(</span>
        <span class="nx">options</span><span class="o">!</span><span class="p">,</span>
        <span class="nx">rawCurrentProps</span><span class="p">,</span>
        <span class="nx">key</span><span class="p">,</span>
        <span class="nx">rawCurrentProps</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span>
        <span class="nx">instance</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>componentProps.ts -&gt; resolvePropValue()</strong></p>
<ol>
<li>
<p><code>props:{name: {default: v=&gt; myname }, type: String}</code></p>
<p>
当 type 非函数时，说明 <code>name</code> 是个字符串类型，但是它的 <code>default</code> 又是个函数？
那么这种情况会在这里被处理，最后将 name 的值赋值为 <code>default(props)</code> 执行之后的结果</p>
</li>
<li>
<p><code>props:{name: {default: v=&gt; myname }, type: Function}</code></p>
<p>
这种情况，说明 <code>name</code> 本身就是函数，不需要执行 default。</p>
</li>
<li>
<p><code>props:{name: value, type: String|Number}</code> 普通类型情况</p>
</li>
<li>
<p>boolean 类型的值处理，最后都会转成 <code>true</code> 或 <code>false</code></p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">resolvePropValue</span><span class="p">(</span>
  <span class="nx">options</span>: <span class="kt">NormalizedProps</span><span class="p">,</span>
  <span class="nx">props</span>: <span class="kt">Data</span><span class="p">,</span>
  <span class="nx">key</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="cm">/*
</span><span class="cm">   * 这里面的处理是针对 props: { name: { ... } } 类型而言
</span><span class="cm">   * 1. 默认值的处理， default 可能是函数或普通类型值，如果是函数应该得到
</span><span class="cm">   * 函数执行的结果作为它的值，注意下面的检测函数时前置条件是该类型不是函数，
</span><span class="cm">   * 如果类型也是函数，默认值就是该函数本身，而非执行后的结果值
</span><span class="cm">   * 2. 布尔值的处理，值转成 true or false
</span><span class="cm">   */</span>
  <span class="kr">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">hasDefault</span> <span class="o">=</span> <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">opt</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
    <span class="c1">// 默认值
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">hasDefault</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">defaultValue</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="k">default</span>
      <span class="c1">// props: { name: { default: (props) =&gt; &#39;xxx&#39; } }
</span><span class="c1"></span>      <span class="c1">// 类型不是函数？但是默认值是函数，执行得到结果
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nb">Function</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">setCurrentInstance</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">defaultValue</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
        <span class="nx">setCurrentInstance</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// props: { name: { default: &#39;xxx&#39; } }
</span><span class="c1"></span>        <span class="nx">value</span> <span class="o">=</span> <span class="nx">defaultValue</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// boolean casting
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">[</span><span class="nx">BooleanFlags</span><span class="p">.</span><span class="nx">shouldCast</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasOwn</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasDefault</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
        <span class="nx">opt</span><span class="p">[</span><span class="nx">BooleanFlags</span><span class="p">.</span><span class="nx">shouldCastTrue</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">hyphenate</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">value</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>❓ 然后与 props 有关的 propsOptions 是来自哪里？</p>
</blockquote>
<p>
回顾下 component render 过程：</p>
<p>
patch -&gt; switch default -&gt; PatchFlags.COMPONENT -&gt;</p>
<p>
processComponent -&gt; mountComponent -&gt;</p>
<p>
createComponentInstance -&gt; setupComponent -&gt; setupRenderEffect</p>
<p>
有了？</p>
<p>
是的，就是它 -&gt; <code>createComponentInstance</code> 创建组件实例中，进行了初始化，其中组织
的结构里面就有一个</p>
<p>
<code>propsOptions: normalizePropsOptions(type, appContext)</code></p>
<p>
和</p>
<p>
<code>emitsOptions: normalizeEmitsOptions(type, appContext)</code></p>
</div>
</div>
<div id="outline-container-setup" class="outline-3">
<h3 id="setup">
component setup
</h3>
<div id="outline-text-setup" class="outline-text-3">
<ol>
<li>
<p>setup 如果返回值是函数直接是 render 函数</p>
</li>
<li>
<p>setup 返回值是对象，则当做和 data 一样的组件状态处理</p>
</li>
</ol>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-setup-result.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-setup-result.jpg" title="/img/vue3/runtime-core/vue-runtime-core-setup-result.jpg" /></p>
<p>
更多分析见注释，相关代码:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 如果组件是个对象，而非函数是组件是会经过这个函数
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">setupStatefulComponent</span><span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">isSSR</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Component</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ComponentOptions</span><span class="p">;</span>

  <span class="c1">// 0. create render proxy property access cache
</span><span class="c1"></span>  <span class="c1">// 这个是针对 instance 上属性的 get 操作类型进行了 key 值缓存
</span><span class="c1"></span>  <span class="c1">// 比如：当你对 setupState 或 data的属性 进行了 get 访问，
</span><span class="c1"></span>  <span class="c1">// 那么该属性的key值会记录为该类型(accessCache[key]=AccessTypes.SETUP)
</span><span class="c1"></span>  <span class="c1">// 当你下次再在 instance 上访问这个key 的时候，那么这个时候就会知道这个 key
</span><span class="c1"></span>  <span class="c1">// 是在 setupState 上，那么就直接返回 setupState[key] 就行了
</span><span class="c1"></span>  <span class="c1">// 而不用去重复进行 if...elseif...else 去 setupData, data, context
</span><span class="c1"></span>  <span class="c1">// 或 props 判断然后决定去哪个上面取值，加快求值速度。
</span><span class="c1"></span>  <span class="c1">// 如： setupState={foo:1}, data={bar:2}
</span><span class="c1"></span>  <span class="c1">// 取值： this.foo 触发 get 操作，这个时候第一次取值的时候会进行
</span><span class="c1"></span>  <span class="c1">// if setupState else if data 检测&#39;foo&#39;在哪个对象上，发现在
</span><span class="c1"></span>  <span class="c1">// setupState 上，然后将 &#39;foo&#39; 缓存到 accessCache[&#39;foo&#39;] =&#39;setup&#39;
</span><span class="c1"></span>  <span class="c1">// 下次再次取值this.foo，那么本次就会直接返回 setupState[&#39;foo&#39;]
</span><span class="c1"></span>  <span class="nx">instance</span><span class="p">.</span><span class="nx">accessCache</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

  <span class="c1">// 1. create public instance / render proxy
</span><span class="c1"></span>  <span class="c1">// also mark it raw so it&#39;s never observed
</span><span class="c1"></span>  <span class="c1">// 代理目的：让取值操作能在 setupState, data, ctx, props 及
</span><span class="c1"></span>  <span class="c1">// appContext.config.globalProperties 上依次查找对应的属性值
</span><span class="c1"></span>  <span class="c1">// 优先级：
</span><span class="c1"></span>  <span class="c1">// 1. 非 $xxx 属性， setupState &gt; data &gt; ctx &gt; props
</span><span class="c1"></span>  <span class="c1">// 2. this.$xxx 取值， public 属性: $,$el,$data,$props,$attrs
</span><span class="c1"></span>  <span class="c1">//  ,$slots,$refs,$parent,$root,$emit,$options,$forceUpdate,
</span><span class="c1"></span>  <span class="c1">//  ,$nextTick,$watch
</span><span class="c1"></span>  <span class="c1">// &gt; cssModule 属性 vue-loader 注入的css 变量
</span><span class="c1"></span>  <span class="c1">// &gt; instance.ctx
</span><span class="c1"></span>  <span class="c1">// &gt; appContext.config.globalProperties, 如： this.$router
</span><span class="c1"></span>  <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Proxy</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">PublicInstanceProxyHandlers</span><span class="p">);</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;call setup&#34;</span><span class="p">);</span>
  <span class="c1">// 2. call setup()
</span><span class="c1"></span>  <span class="kr">const</span> <span class="p">{</span> <span class="nx">setup</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Component</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">setup</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 传递给 setup(props, setupContext) 的第二个参数
</span><span class="c1"></span>    <span class="c1">// setupContext: { attrs, slots, emit, expose }
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">setupContext</span> <span class="o">=</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">setupContext</span> <span class="o">=</span>
      <span class="nx">setup</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">createSetupContext</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>

    <span class="nx">currentInstance</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
    <span class="c1">// 实例初始化期间，禁止 track 操作，get 收集依赖
</span><span class="c1"></span>    <span class="nx">pauseTracking</span><span class="p">();</span>
    <span class="c1">// 执行 setup 函数
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">setupResult</span> <span class="o">=</span> <span class="nx">callWithErrorHandling</span><span class="p">(</span>
      <span class="nx">setup</span><span class="p">,</span>
      <span class="nx">instance</span><span class="p">,</span>
      <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">SETUP_FUNCTION</span><span class="p">,</span>
      <span class="p">[</span><span class="nx">__DEV__</span> <span class="o">?</span> <span class="nx">shallowReadonly</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">props</span><span class="p">)</span> <span class="o">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span> <span class="nx">setupContext</span><span class="p">]</span>
    <span class="p">);</span>
    <span class="nx">resetTracking</span><span class="p">();</span>
    <span class="nx">currentInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="c1">// 对setup 结果处理，返回值只能是对象或函数
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">setupResult</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isSSR</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// return the promise so server-renderer can wait on it
</span><span class="c1"></span>        <span class="k">return</span> <span class="nx">setupResult</span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">resolvedResult</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">handleSetupResult</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">resolvedResult</span><span class="p">,</span> <span class="nx">isSSR</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_SUSPENSE__</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// async setup returned Promise.
</span><span class="c1"></span>        <span class="c1">// bail here and wait for re-entry.
</span><span class="c1"></span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">asyncDep</span> <span class="o">=</span> <span class="nx">setupResult</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO warn
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// setup() 执行结果只能是函数或对象
</span><span class="c1"></span>      <span class="c1">// 1. 如果是对象，返回对象的所有属性当做状态处理，和 data 性质相同
</span><span class="c1"></span>      <span class="c1">// 2. 如果是函数，视为组件的 render 函数
</span><span class="c1"></span>      <span class="c1">// 即，支持在 setup 中直接手写 render 函数
</span><span class="c1"></span>      <span class="nx">handleSetupResult</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">setupResult</span><span class="p">,</span> <span class="nx">isSSR</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// handleSetupResult
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">handleSetupResult</span><span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">setupResult</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">isSSR</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 1. 如果是函数当做render函数处理
</span><span class="c1"></span>  <span class="c1">// 2. 如果是对象
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">setupResult</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 返回内联 render 函数
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">__NODE_JS__</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ComponentOptions</span><span class="p">).</span><span class="nx">__ssrInlineRender</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// SSR 服务端渲染，替换 ssrRender 函数
</span><span class="c1"></span>      <span class="c1">// when the function&#39;s name is `ssrRender` (compiled by SFC inline mode),
</span><span class="c1"></span>      <span class="c1">// set it as ssrRender instead.
</span><span class="c1"></span>      <span class="nx">instance</span><span class="p">.</span><span class="nx">ssrRender</span> <span class="o">=</span> <span class="nx">setupResult</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">setupResult</span> <span class="kr">as</span> <span class="nx">InternalRenderFunction</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">setupResult</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 返回 bindings，这些变量可以直接在模板中使用
</span><span class="c1"></span>    <span class="c1">// 注意这里的 state 是 shallow ref，即非递归 reactive 的
</span><span class="c1"></span>    <span class="nx">instance</span><span class="p">.</span><span class="nx">setupState</span> <span class="o">=</span> <span class="nx">proxyRefs</span><span class="p">(</span><span class="nx">setupResult</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// warn 必须返回对象
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="c1">// 最后完成render函数检查
</span><span class="c1"></span>  <span class="c1">// 可能是 SFC情况的 模板语法，没有直接的render函数，需要进行
</span><span class="c1"></span>  <span class="c1">// compile 操作生成 instance.rendder = Component.render函数
</span><span class="c1"></span>  <span class="c1">// render 执行不是这里，而是在 instance.update 的 effect 函数中的
</span><span class="c1"></span>  <span class="c1">// renderComponentRoot 中
</span><span class="c1"></span>  <span class="nx">finishComponentSetup</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">isSSR</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="kr">async</span> <span class="p">({</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
    <span class="nx">defineComponent</span><span class="p">,</span>
  <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt;component setup return object&#34;</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="nx">defineComponent</span><span class="p">({</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;bar&#34;</span><span class="p">],</span>
        <span class="nx">setup</span><span class="p">(</span><span class="mi">_</span><span class="nx">props</span><span class="p">,</span> <span class="p">{</span> <span class="nx">attrs</span><span class="o">:</span> <span class="mi">_</span><span class="nx">attrs</span> <span class="p">})</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;setup...&#34;</span><span class="p">);</span>
          <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">props</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">props</span><span class="p">;</span>
            <span class="nx">attrs</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">attrs</span><span class="p">;</span>
          <span class="p">};</span>
        <span class="p">},</span>
      <span class="p">});</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">([</span><span class="nx">props</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">]);</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">fooBar</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">fooBaz</span><span class="o">:</span> <span class="mi">4</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">([</span><span class="nx">props</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">]);</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">qux</span><span class="o">:</span> <span class="mi">5</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">([</span><span class="nx">props</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedroot:
&gt;&gt;&gt;component setup return object
component stateful ? 4
call setup
setup...
[Function (anonymous)] render
mount component
normalize vnode
patch component
{ bar: 2 } { foo: 1 }
{ bar: 2 } { foo: 1 }
{ bar: 2 } { foo: 1 }
root:
</pre>
</div>
</div>
<div id="outline-container-comp-update" class="outline-3">
<h3 id="comp-update">
component update
</h3>
<div id="outline-text-comp-update" class="outline-text-3">
<p>
需要修改点：</p>
<ol>
<li>
<p>在 <code>processComponent</code> 中增加 <code>updateComponent</code> 更新组件</p>
</li>
<li>
<p>在 instance.update effect 函数中增加 <code>updateProps()</code> diff-&gt;update props</p>
</li>
</ol>
<p>
这里主要包含了 props 的更新规则，对于 children 的 diff 和 update 规则分析可以查
看 <a href="/vue/vue-mind-map-runtime-core-2-render/#keyed-children">patchKeyedChildren diff 和 更新原理分析！</a></p>
<p>
组件更新，代码执行流程：</p>
<p>
状态变更 -&gt; instance.update effect 执行 -&gt;</p>
<p>
如果有 next vnode 触发 <code>updateComponentPreRender()</code> 更新 props 和 slots</p>
<p>
执行 beforeUpdate hook</p>
<p>
执行 onVnodeBeforeUpdate hook</p>
<p>
得到新树🌲 nextTree = renderComponentRoot(instance)</p>
<p>
老树🌲 prevTree = instance.subTree</p>
<p>
进行 patch(prevTree, nextTree) 操作</p>
<p>
执行 updated hook 和 onVnodeUpdated hook</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="kr">async</span> <span class="p">({</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
    <span class="nx">defineComponent</span><span class="p">,</span>
  <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>
    <span class="kd">let</span> <span class="nx">oa</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="nx">ob</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">defaultFn</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`fn called </span><span class="si">${</span><span class="o">++</span><span class="nx">i</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span> <span class="nx">oa</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">defaultBaz</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`baz called </span><span class="si">${</span><span class="o">++</span><span class="nx">j</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span> <span class="nx">ob</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">proxy</span><span class="p">;</span>
    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">foo</span><span class="o">:</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
          <span class="nx">bar</span><span class="o">:</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">defaultFn</span> <span class="p">},</span>
          <span class="nx">baz</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">Function</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="nx">defaultBaz</span> <span class="p">},</span>
        <span class="p">},</span>
        <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">proxy</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>
      <span class="p">};</span>
      <span class="kr">const</span> <span class="nx">print</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">);</span>
        <span class="kr">const</span> <span class="nx">prevBar</span> <span class="o">=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">bar</span><span class="p">;</span>
        <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;proxy.foo = &#34;</span> <span class="o">+</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span>
        <span class="c1">// 因为无 type，而 default 是个函数，会被执行得到结果
</span><span class="c1"></span>        <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;prevBar === oa: &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">prevBar</span> <span class="o">===</span> <span class="nx">oa</span><span class="p">));</span>
        <span class="c1">// 因为 type Function ，所以default 是 Function 的话不会被执行
</span><span class="c1"></span>        <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;proxy.baz === defaultBaz, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">baz</span> <span class="o">===</span> <span class="nx">defaultBaz</span><span class="p">));</span>
        <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;proxy.bar === prevBar, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">bar</span> <span class="o">===</span> <span class="nx">prevBar</span><span class="p">));</span>
      <span class="p">};</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">);</span>
      <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;first&#34;</span><span class="p">);</span>
      <span class="c1">// update
</span><span class="c1"></span>      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">);</span>
      <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;update&#34;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedroot:
{
  type: {
    props: { foo: [Object], bar: [Object], baz: [Object] },
    render: [Function: render]
  },
  shapeFlag: 4
}
fn called 1
component stateful ? 4
call setup
no setup
[Function: render] render
mount component
update effect
normalize vnode
patch component
{ type: Symbol(Comment), shapeFlag: 0 }
&gt;&gt;&gt; first
proxy.foo = 2
prevBar === oa: true
proxy.baz === defaultBaz, true
proxy.bar === prevBar, true
{
  type: {
    props: { foo: [Object], bar: [Object], baz: [Object] },
    render: [Function: render],
    __props: [ [Object], [Array] ]
  },
  shapeFlag: 4
}
update component
should update component
has changed props
should update component....
normal update
update effect
component update
update comp pre render
normalize vnode
Cannot read property &#39;parentNode&#39; of null
</pre>
<blockquote>
<p>❓ 没有触发 <code>instance.update</code> ?</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3771bfb42adaee8d3f84388d3d8d654ca44678fd">fix: props update invalid · gcclll/stb-vue-next@3771bfb</a></p>
<p>
修复后，回去重新测试。</p>
</blockquote>
<p>
FIX 增加代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">updateComponent</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n1</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">optimized</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;update component&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">component</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">component</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">shouldUpdateComponent</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">optimized</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;should update component....&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="nx">__FEATURE_SUSPENSE__</span> <span class="o">&amp;&amp;</span>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">asyncDep</span> <span class="o">&amp;&amp;</span> <span class="c1">// async setup
</span><span class="c1"></span>      <span class="nx">instance</span><span class="p">.</span><span class="nx">asyncResolved</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 新增代码》》》》》》》》
</span><span class="c1"></span>      <span class="c1">// 正常更新
</span><span class="c1"></span>      <span class="nx">instance</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">n2</span><span class="p">;</span>
      <span class="c1">// 考虑到 child 组件可能正在队列中排队，移除它避免
</span><span class="c1"></span>      <span class="c1">// 在同一个 flush tick 重复更新同一个子组件
</span><span class="c1"></span>      <span class="c1">// 当下一次更新来到时，之前的一次更新取消？
</span><span class="c1"></span>      <span class="nx">invalidateJob</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
      <span class="c1">// instance.update 是在 setupRenderEffect 中
</span><span class="c1"></span>      <span class="c1">// 定义的一个 reactive effect runner
</span><span class="c1"></span>      <span class="c1">// 主动触发更新
</span><span class="c1"></span>      <span class="nx">instance</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>❓ Cannot read property &#39;parentNode&#39; of null</p>
<p>
这个报错发生在 instance.update effect 的 else 更新组件中，</p>
<p>
patch(… hostParentNode(prevTree.el!)!, …)</p>
<p>
的时候，去取值 prevTree.el 得到的是空值，进入 hostParentNode 调用
node.parentNode 报错的。</p>
<p>
这里为什么 prevTree.el 是 null ? 更新的话之前的 node 不应该已经加载好了吗？</p>
</blockquote>
</div>
</div>
<div id="outline-container-comp-slots" class="outline-3">
<h3 id="comp-slots">
component slots
</h3>
<div id="outline-text-comp-slots" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a7884300c10c3cb3f0f5812ff2a6621651421e39">feat(add): init&amp;update slots · gcclll/stb-vue-next@a788430</a></p>
<p>
修改点：</p>
<ol>
<li>
<p>初始化， <code>setupComponent()</code> 中的 <code>initSlots()</code></p>
</li>
<li>
<p><code>updateComponent()</code> -&gt; <code>updateComponentPreRender()</code> 中 <code>updateSlots()</code> 更新 slots</p>
</li>
</ol>
<p>
对应动作： init -&gt; update</p>
<p>
对应组件阶段： 初始化(initSlots()) -&gt; 更新(updateSlots())</p>
<div id="outline-container-init-slots" class="outline-4">
<h4 id="init-slots">
初始化(<code>initSlots()</code>)：
</h4>
<div id="outline-text-init-slots" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">initSlots</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">children</span>: <span class="kt">VNodeNormalizedChildren</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="kr">type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">RawSlots</span><span class="p">).</span><span class="nx">_</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">slots</span> <span class="o">=</span> <span class="nx">children</span> <span class="kr">as</span> <span class="nx">InternalSlots</span>
      <span class="c1">// make compiler marker non-enumerable
</span><span class="c1"></span>      <span class="nx">def</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">InternalSlots</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="kr">type</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">normalizeObjectSlots</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">RawSlots</span><span class="p">,</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">slots</span> <span class="o">=</span> <span class="p">{}))</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">slots</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">normalizeVNodeSlots</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">children</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">def</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">slots</span><span class="p">,</span> <span class="nx">InternalObjectKey</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
要分析整个，需要回顾下 <a href="/vue/vue-mind-map-runtime-core-1/#normalize-children">normalizeChildren(vnode, children)</a> 处理逻辑，要搞清楚什么
情况下会是 <code>SLOTS_CHILDREN</code> 。</p>
<p>
根据 <code>normalizeChildren()</code> 的实现中，可知需要满足下面几个条件：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isTELEPORT</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// default slot
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 非 ELEMENT 或 TELEPORT 类型
</span><span class="c1"></span>    <span class="c1">// 如： &lt;Comp&gt;&lt;template v-slot:named&gt;&lt;div/&gt;&lt;/template&gt;&lt;/Comp&gt;
</span><span class="c1"></span>    <span class="c1">// children 只有一个 template 会被解析成一个 vnode 对象
</span><span class="c1"></span>    <span class="c1">// 且 vnode type 是 template
</span><span class="c1"></span>    <span class="nx">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// children 是个函数
</span><span class="c1"></span>  <span class="c1">// 函数式组件 Comp = { render() {
</span><span class="c1"></span>  <span class="c1">//   return h(&#39;div&#39;, null, () =&gt; h(&#39;div&#39;) /* slot */)
</span><span class="c1"></span>  <span class="c1">// }}
</span><span class="c1"></span>  <span class="nx">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p><code>children = { _: ... }</code> 内部插槽？</p>
</li>
<li>
<p>normalizeObjectSlots: children 是对象类型：</p>
<p>
 <code>{named: slotFn1, default: slotFn2 }</code></p>
<p>
 遍历所有 key-value =&gt;</p>
<p>
 (<strong>推荐</strong>)如果 value 是函数需要将 slotFn 用 withCtx 封装一层，让其在当前实例的上下文中正确✅执行。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">normalizeSlot</span> <span class="o">=</span> <span class="p">(</span>
   <span class="nx">key</span>: <span class="kt">string</span><span class="p">,</span>
   <span class="nx">rawSlot</span>: <span class="kt">Function</span><span class="p">,</span>
   <span class="nx">ctx</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">|</span> <span class="kc">undefined</span>
 <span class="p">)</span><span class="o">:</span> <span class="nx">Slot</span> <span class="o">=&gt;</span>
   <span class="nx">withCtx</span><span class="p">((</span><span class="nx">props</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="c1">// warn: 在 Render 函数外执行了 slot function
</span><span class="c1"></span>     <span class="k">return</span> <span class="nx">normalizeSlotValue</span><span class="p">(</span><span class="nx">rawSlot</span><span class="p">(</span><span class="nx">props</span><span class="p">));</span>
   <span class="p">},</span> <span class="nx">ctx</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 (<strong>不推荐</strong>)如果 value 不是函数，经过</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">normalizeSlotValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span><span class="p">[]</span> <span class="o">=&gt;</span>
<span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
    <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">normalizeVNode</span><span class="p">)</span>
    <span class="o">:</span> <span class="p">[</span><span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">value</span> <span class="kr">as</span> <span class="nx">VNodeChild</span><span class="p">)]</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 处理之后转成函数赋值 <code>slots[key] = () =&gt; normalized</code></p>
<p>
 最终都是将 slot value 转成一个函数保存到 <code>instance.slots{}</code> 中</p>
</li>
<li>
<p>非 <code>SLOTS_CHILDREN</code> ，那只有一种情况</p>
<p>
children 中没有 <code>&lt;template v-slot:named ...&gt;</code> ，此时它所有的 child 都会被当做
默认插槽来处理。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">normalizeVNodeSlots</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">children</span>: <span class="kt">VNodeNormalizedChildren</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="nx">normalizeSlotValue</span><span class="p">(</span><span class="nx">children</span><span class="p">);</span>
  <span class="nx">instance</span><span class="p">.</span><span class="nx">slots</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">normalized</span><span class="p">;</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
如：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="kr">async</span> <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">template</span><span class="o">:</span> <span class="s2">&#34;&lt;div/&gt;&#34;</span> <span class="p">};</span>
    <span class="kr">const</span> <span class="nx">slot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{};</span>
    <span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="nx">slot</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; 函数作为 children 解析为默认插槽&#34;</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">f</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;children&#34;</span><span class="p">,</span> <span class="s2">&#34;type&#34;</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

&gt;&gt;&gt; 函数作为 children 解析为默认插槽
{
  type: { template: &#39;&lt;div/&gt;&#39; },
  children: { default: [Function: slot], _ctx: null }
}
{ default: [Function: slot], _ctx: null }
</pre>
</li>
</ol>
</div>
</div>
<div id="outline-container-update-slots" class="outline-4">
<h4 id="update-slots">
更新(<code>updateSlots()</code>)
</h4>
<div id="outline-text-update-slots" class="outline-text-4">
<p>
更新插槽步骤：</p>
<ol>
<li>
<p>合并 instance.slots 和 children</p>
</li>
<li>
<p>然后删除 children 中没有的插槽</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">updateSlots</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">children</span>: <span class="kt">VNodeNormalizedChildren</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">slots</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">needDeletionCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">deletionComparisonTarget</span> <span class="o">=</span> <span class="nx">EMPTY_OBJ</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;update slots&#34;</span><span class="p">);</span>
  <span class="c1">// children 是 函数或对象类型(非数组)
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="kr">type</span> <span class="o">=</span> <span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">RawSlots</span><span class="p">).</span><span class="nx">_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;update slots type&#34;</span><span class="p">);</span>
      <span class="c1">// compiled slots.
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">isHmrUpdating</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">SlotFlags</span><span class="p">.</span><span class="nx">STABLE</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// compiled AND stable
</span><span class="c1"></span>        <span class="c1">// 不需要更新，跳过 slots 删除操作
</span><span class="c1"></span>        <span class="nx">needDeletionCheck</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// compiled but dynamic (v-if/v-for on slots)
</span><span class="c1"></span>        <span class="c1">// update slots, but skip normalization
</span><span class="c1"></span>        <span class="nx">extend</span><span class="p">(</span><span class="nx">slots</span><span class="p">,</span> <span class="nx">children</span> <span class="kr">as</span> <span class="nx">Slots</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;update slots no type&#34;</span><span class="p">);</span>
      <span class="nx">needDeletionCheck</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">RawSlots</span><span class="p">).</span><span class="nx">$stable</span><span class="p">;</span>
      <span class="nx">normalizeObjectSlots</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">RawSlots</span><span class="p">,</span> <span class="nx">slots</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 对象类型直接合并，这里记录需要进行删除操作的对象，children
</span><span class="c1"></span>    <span class="c1">// 上面只是进行了简单的对象合并操作
</span><span class="c1"></span>    <span class="c1">// 如： slots={a,b,d}, children = {a,b,c}
</span><span class="c1"></span>    <span class="c1">// 合并之后： slots={a,b,c,d},后面需要删除的是 d 这个插槽
</span><span class="c1"></span>    <span class="nx">deletionComparisonTarget</span> <span class="o">=</span> <span class="nx">children</span> <span class="kr">as</span> <span class="nx">RawSlots</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// &lt;Comp&gt;...这里没有 &lt;template #named ...&gt; 情况&lt;/Comp&gt;
</span><span class="c1"></span>    <span class="c1">// &lt;Comp&gt; 里面的所有内容都会被当做默认插槽来解析
</span><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;update slots children&#34;</span><span class="p">);</span>
    <span class="c1">// non slot object children (direct value)
</span><span class="c1"></span>    <span class="c1">// passed to a component
</span><span class="c1"></span>    <span class="c1">// 当做默认插槽来处理，解析后： slots.default = () =&gt; normalized
</span><span class="c1"></span>    <span class="nx">normalizeVNodeSlots</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
    <span class="c1">// 这里目的是为了只保留 default 其他都需要删除
</span><span class="c1"></span>    <span class="nx">deletionComparisonTarget</span> <span class="o">=</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="mi">1</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">needDeletionCheck</span> <span class="p">});</span>
  <span class="c1">// delete stale slots
</span><span class="c1"></span>  <span class="c1">// 删除旧的 slots
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">needDeletionCheck</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">slots</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 非 `_` 内部插槽，且不再新的 children 中的
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isInternalKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">deletionComparisonTarget</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">slots</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-11" class="outline-3">
<h3 id="headline-11">
props tests
</h3>
<div id="outline-text-headline-11" class="outline-text-3">
<p>
传入的 rawProps 和组件自身的 props 经过处理之后(setFullProps()) 会将 rawProps 根
据一定规则分派到组件 props 或 attrs 中去。</p>
<p>
这里的 rawProps 代表是 parent 在渲染子组件的时候传递给它的 props ，如：</p>
<p>
<code>render(h(Child, { foo:1, bar:2}),root)</code></p>
<p>
中的 <code>{foo:1,bar:2}</code> 即 parent props，然后组件可以定义自身的 props 属性：</p>
<p>
<code>defineComponent({ props: [&#39;foo&#39;] })</code> 意味着，该子组件只接受 <code>&#39;foo&#39;</code> 作为 props
而其他的会被解析成 attrs 。</p>
<p>
component props 测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="kr">async</span> <span class="p">({</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
    <span class="nx">defineComponent</span><span class="p">,</span>
  <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt;stateful&#34;</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="nx">defineComponent</span><span class="p">({</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;fooBar&#34;</span><span class="p">,</span> <span class="s2">&#34;barBaz&#34;</span><span class="p">,</span> <span class="s2">&#34;foo-baz&#34;</span><span class="p">],</span>
        <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;comp render&#34;</span><span class="p">);</span>
          <span class="nx">props</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$props</span><span class="p">;</span>
          <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$attrs</span><span class="p">;</span>
          <span class="nx">proxy</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>
      <span class="p">});</span>

      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">fooBar</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">fooBaz</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;proxy.fooBar=&#34;</span> <span class="o">+</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">fooBar</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">([</span><span class="nx">props</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">]);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedroot:
&gt;&gt;&gt;stateful
{
  type: {
    props: [ &#39;fooBar&#39;, &#39;barBaz&#39;, &#39;foo-baz&#39; ],
    render: [Function: render]
  },
  shapeFlag: 4
}
component stateful ? 4
call setup
no setup
[Function: render] render
mount component
update effect
normalize vnode
comp render
patch component
{ type: Symbol(Comment), shapeFlag: 0 }
proxy.fooBar=1
{ fooBar: 1, fooBaz: 3 } { bar: 2 }
root:
</pre>
</div>
</div>
<div id="outline-container-headline-12" class="outline-3">
<h3 id="headline-12">
component unmount
</h3>
<div id="outline-text-headline-12" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/79c5061781235abffd5d744781857fd3cfa0008a">feat(add): add unmount component · gcclll/stb-vue-next@79c5061</a></p>
<p>
主要工作：</p>
<ol>
<li>
<p>执行 <code>beforeUnmount</code> 周期函数</p>
</li>
<li>
<p>停掉所有 effects 依赖</p>
</li>
<li>
<p>检查 update 函数，处理在异步 update 之前执行了 unmount</p>
</li>
<li>
<p>在 post queue 中执行 <code>unmounted</code> 周期函数</p>
</li>
<li>
<p>在 post queue 中标记 <code>instance.isUnmounted=true</code> 标记组件已经卸载了</p>
</li>
</ol>
<blockquote>
<p>三种队列任务， <code>pre, post, job</code> 执行顺序： pre &gt; job &gt; post，详情查看</p>
<p>
<a href="/vue/vue-mind-map-runtime-core-1/#scheduler">scheduler 任务调度机制</a></p>
</blockquote>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">unmountComponent</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">doRemove?</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">bum</span><span class="p">,</span> <span class="nx">effects</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">subTree</span><span class="p">,</span> <span class="nx">um</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
  <span class="c1">// beforeUnmount hook
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">bum</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">invokeArrayFns</span><span class="p">(</span><span class="nx">bum</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">effects</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">effects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stop</span><span class="p">(</span><span class="nx">effects</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// update may be null if a component is unmounted before its async
</span><span class="c1"></span>  <span class="c1">// setup has resolved.
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stop</span><span class="p">(</span><span class="nx">update</span><span class="p">);</span>
    <span class="nx">unmount</span><span class="p">(</span><span class="nx">subTree</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">,</span> <span class="nx">doRemove</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// unmounted hook
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">um</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">um</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">queuePostRenderEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">isUnmounted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">},</span> <span class="nx">parentSuspense</span><span class="p">);</span>

  <span class="c1">// TODO suspense
</span><span class="c1"></span><span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-3">
<h3 id="headline-13">
normalize emits options
</h3>
<div id="outline-text-headline-13" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b918dde38055d7e6faf6e2371647f805c10f2721">feat(add): props event init · gcclll/stb-vue-next@b918dde</a></p>
</div>
</div>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
问题
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<div id="outline-container-q-allow-recurse" class="outline-4">
<h4 id="q-allow-recurse">
TypeError: Cannot read property &#39;allowRecurse&#39; of null
</h4>
<div id="outline-text-q-allow-recurse" class="outline-text-4">
<pre class="example">
TypeError: Cannot read property &#39;allowRecurse&#39; of null
    at createReactiveEffect (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:251:39)
    at effect (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:199:22)
    at setupRenderEffect (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2738:29)
    at mountComponent (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2733:11)
    at processComponent (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2724:19)
    at patch (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:2616:23)
    at render (/Users/simon/blog/cheng92.com/static/js/vue/runtime-test.global.js:3099:15)
    at /private/var/folders/1n/xw58p9v90tn42m87q527fvgr0000gn/T/babel-orafVD/js-script-Vmw0ga:29:5
</pre>
<p>
因为实现问题：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">instance</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(</span><span class="kd">function</span> <span class="nx">componentEffect() {</span>
      <span class="c1">// 监听更新
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 还没加载完成，可能是第一次 mount 操作
</span><span class="c1"></span>        <span class="c1">// TODO
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// TODO
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">},</span> <span class="nx">__DEV__</span> <span class="o">?</span> <span class="cm">/* TODO */</span> <span class="p">(</span><span class="kc">null</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span> <span class="o">:</span> <span class="nx">prodEffectOptions</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
文字内的测试是基于 node development 环境测试的，这里 effect options 是 null 所以
报错。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/63675a485bf8223b3be8d76fa3ce28d397d8e726">fix: effect null options · gcclll/stb-vue-next@63675a4</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-render-text" class="outline-2">
<h2 id="render-text">
processText|Comment|Static
</h2>
<div id="outline-text-render-text" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/636e87099f5e1322cf2af0aeb82614e2fa6a7fe3">feat(add): processText updte · gcclll/stb-vue-next@636e870 · GitHub</a></p>
<p>
本节包含(主要源码，没啥好分析的)：</p>
<ol>
<li>
<p>文本节点</p>
</li>
<li>
<p>注释节点</p>
</li>
<li>
<p>静态节点</p>
</li>
</ol>
<div id="outline-container-Text" class="outline-3">
<h3 id="Text">
Text
</h3>
<div id="outline-text-Text" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">processText</span>: <span class="kt">ProcessTextOrCommentFn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span> <span class="cm">/* old */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 新节点，插入处理
</span><span class="c1"></span>    <span class="nx">hostInsert</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">hostCreateText</span><span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">)),</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="nx">anchor</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// has old vnode, need to diff
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">el</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">el</span><span class="o">!</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="o">!==</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hostSetText</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
因为在 compiler-core parse 阶段的文本处理中，如果是响铃的文本节点会被合并，如：</p>
<p>
<code>&lt;div&gt;{{ text1 }} {{ text2 }}&lt;/div&gt;</code> 最终会合并：</p>
<p>
<code>&lt;div&gt;{{ text1 + &#39; &#39; + text2 }}&lt;/div&gt;</code> 最终替换的是 <code>&lt;div/&gt;</code> 整个内容。</p>
</div>
</div>
<div id="outline-container-Comment" class="outline-3">
<h3 id="Comment">
Comment
</h3>
<div id="outline-text-Comment" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/448936662634690c5d2e5596e31d066b0f96cd63">feat(add): process comment node · gcclll/stb-vue-next@4489366 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">processCommentNode</span>: <span class="kt">ProcessTextOrCommentFn</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">n1</span><span class="p">,</span>
    <span class="nx">n2</span><span class="p">,</span>
    <span class="nx">container</span><span class="p">,</span>
    <span class="nx">anchor</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hostInsert</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">hostCreateComment</span><span class="p">((</span><span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
        <span class="nx">container</span><span class="p">,</span>
        <span class="nx">anchor</span>
      <span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// there&#39;s no support for dynamic comments
</span><span class="c1"></span>      <span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">el</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-Static" class="outline-3">
<h3 id="Static">
Static
</h3>
<div id="outline-text-Static" class="outline-text-3">
<p>
patch -&gt; case Static:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// case Static:
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">mountStaticNode</span><span class="p">(</span><span class="nx">n2</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">patchStaticNode</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// break
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
没有 old vnode -&gt; mount</p>
<p>
有 old node -&gt; patch</p>
<p>
<strong>mount</strong>:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">mountStaticNode</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">,</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
  <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">isSVG</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// static nodes are only present when used with compiler-dom/runtime-dom
</span><span class="c1"></span>  <span class="c1">// which guarantees presence of hostInsertStaticContent.
</span><span class="c1"></span>  <span class="p">[</span><span class="nx">n2</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">n2</span><span class="p">.</span><span class="nx">anchor</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hostInsertStaticContent</span><span class="o">!</span><span class="p">(</span>
    <span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">,</span>
    <span class="nx">container</span><span class="p">,</span>
    <span class="nx">anchor</span><span class="p">,</span>
    <span class="nx">isSVG</span>
  <span class="p">);</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
mount 时用到的 <code>hostInsertStaticContent()</code> 是在 runtime-dom 包中实现的，先预览下
代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">insertStaticContent</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">isSVG</span>
    <span class="o">?</span> <span class="nx">tempSVGContainer</span> <span class="o">||</span> <span class="p">(</span><span class="nx">tempSVGContainer</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="nx">svgNS</span><span class="p">,</span> <span class="s2">&#34;svg&#34;</span><span class="p">))</span>
    <span class="o">:</span> <span class="nx">tempContainer</span> <span class="o">||</span> <span class="p">(</span><span class="nx">tempContainer</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">));</span>
  <span class="nx">temp</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">firstChild</span> <span class="kr">as</span> <span class="nx">Element</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">node</span>: <span class="kt">Element</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">first</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">last</span>: <span class="kt">Element</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">last</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
    <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">);</span>
    <span class="nx">node</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">firstChild</span> <span class="kr">as</span> <span class="nx">Element</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">first</span><span class="p">,</span> <span class="nx">last</span><span class="p">];</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
可以看到 <code>temp.innerHTML = content</code> 一个简单的内容全替换操作。</p>
<p>
<strong>patchStaticNode</strong>: 因为静态节点在生产环境中会被提升，重用，因此不存在 patch 阶段。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">patchStaticNode</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">n1</span>: <span class="kt">VNode</span><span class="p">,</span>
  <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">,</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
  <span class="nx">isSVG</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// static nodes are only patched during dev for HMR
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="o">!==</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">anchor</span> <span class="o">=</span> <span class="nx">hostNextSibling</span><span class="p">(</span><span class="nx">n1</span><span class="p">.</span><span class="nx">anchor</span><span class="o">!</span><span class="p">);</span>
    <span class="c1">// remove existing
</span><span class="c1"></span>    <span class="nx">removeStaticNode</span><span class="p">(</span><span class="nx">n1</span><span class="p">);</span>
    <span class="c1">// insert new
</span><span class="c1"></span>    <span class="p">[</span><span class="nx">n2</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">n2</span><span class="p">.</span><span class="nx">anchor</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hostInsertStaticContent</span><span class="o">!</span><span class="p">(</span>
      <span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">,</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="nx">anchor</span><span class="p">,</span>
      <span class="nx">isSVG</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
    <span class="nx">n2</span><span class="p">.</span><span class="nx">anchor</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">anchor</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>moveStaticNode</strong>: 在 diff -&gt; update 阶段 move() 中触发</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">moveStaticNode</span> <span class="o">=</span> <span class="p">(</span>
  <span class="p">{</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">anchor</span> <span class="p">}</span><span class="o">:</span> <span class="nx">VNode</span><span class="p">,</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
  <span class="nx">nextSibling</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">next</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">el</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span> <span class="o">!==</span> <span class="nx">anchor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">next</span> <span class="o">=</span> <span class="nx">hostNextSibling</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
    <span class="nx">hostInsert</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">nextSibling</span><span class="p">);</span>
    <span class="nx">el</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">hostInsert</span><span class="p">(</span><span class="nx">anchor</span><span class="o">!</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">nextSibling</span><span class="p">);</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>removeStaticNode</strong>: <code>remove()</code> 中触发</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">removeStaticNode</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">anchor</span> <span class="p">}</span><span class="o">:</span> <span class="nx">VNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">next</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">el</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span> <span class="o">!==</span> <span class="nx">anchor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">next</span> <span class="o">=</span> <span class="nx">hostNextSibling</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
    <span class="nx">hostRemove</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
    <span class="nx">el</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">hostRemove</span><span class="p">(</span><span class="nx">anchor</span><span class="o">!</span><span class="p">);</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-render-fragment" class="outline-2">
<h2 id="render-fragment">
processFragment
</h2>
<div id="outline-text-render-fragment" class="outline-text-2">
<p>
Fragment 的情况： children 有多个 child 的时候，会用一个 fragment 事先包起来。</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-render-fragment.svg" alt="/img/vue3/runtime-core/vue-runtime-core-render-fragment.svg" title="/img/vue3/runtime-core/vue-runtime-core-render-fragment.svg" /></p>
<p>
<code>STABLE_FRAGMENT</code> 情况：</p>
<ol>
<li>
<p><code>v-if</code></p>
<p>
首先要满足 children.length !== 1 即有一个以上的 children, 如：</p>
<p>
<code>&lt;div&gt;&lt;p/&gt;&lt;p/&gt;&lt;/div&gt;</code></p>
<p>
或者非第一个 child ELEMENT 类型，如：</p>
<p>
<code>&lt;div&gt;&lt;Comp/&gt;&lt;/div&gt;</code></p>
<p>
其要满足 <code>(children.length === 1 &amp;&amp; firstChild.type === NodeTypes.FOR)</code> 如：</p>
<p>
<code>&lt;div v-for=&#34;item in list&#34;&gt;&lt;p/&gt;&lt;/div&gt;</code></p>
<p>
才会被当做 <code>PatchFlags.STABLE_FRAGMENT</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// vIf.ts
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">needFragmentWrapper</span> <span class="o">=</span>
   <span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">firstChild</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">;</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">needFragmentWrapper</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">firstChild</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">FOR</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// ...
</span><span class="c1"></span>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">createVNodeCall</span><span class="p">(</span>
       <span class="c1">// ...
</span><span class="c1"></span>       <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">STABLE_FRAGMENT</span> <span class="o">+</span>
         <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">?</span> <span class="sb">` /* </span><span class="si">${</span><span class="nx">PatchFlagNames</span><span class="p">[</span><span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">STABLE_FRAGMENT</span><span class="p">]</span><span class="si">}</span><span class="sb"> */`</span> <span class="o">:</span> <span class="sb">``</span><span class="p">),</span>
       <span class="c1">// ...
</span><span class="c1"></span>     <span class="p">);</span>
   <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>v-for</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// vFor.ts
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">isStableFragment</span> <span class="o">=</span>
     <span class="nx">forNode</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span> <span class="o">&amp;&amp;</span>
     <span class="nx">forNode</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">constType</span> <span class="o">&gt;</span> <span class="mi">0</span>
   <span class="kr">const</span> <span class="nx">fragmentFlag</span> <span class="o">=</span> <span class="nx">isStableFragment</span>
     <span class="o">?</span> <span class="nx">PatchFlags.STABLE_FRAGMENT</span>
     : <span class="kt">keyProp</span>
       <span class="o">?</span> <span class="nx">PatchFlags.KEYED_FRAGMENT</span>
       : <span class="kt">PatchFlags.UNKEYED_FRAGMENT</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
源码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">processFragment</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">n1</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
    <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
    <span class="nx">optimized</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">fragmentStartAnchor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">n1</span> <span class="o">?</span> <span class="nx">n1.el</span> : <span class="kt">hostCreateText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">!</span>
    <span class="kr">const</span> <span class="nx">fragmentEndAnchor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">anchor</span> <span class="o">=</span> <span class="nx">n1</span> <span class="o">?</span> <span class="nx">n1.anchor</span> : <span class="kt">hostCreateText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">!</span>

    <span class="kd">let</span> <span class="p">{</span> <span class="nx">patchFlag</span><span class="p">,</span> <span class="nx">dynamicChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">n2</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">patchFlag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">optimized</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">isHmrUpdating</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// HMR updated, force full diff
</span><span class="c1"></span>      <span class="nx">patchFlag</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">optimized</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">dynamicChildren</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hostInsert</span><span class="p">(</span><span class="nx">fragmentStartAnchor</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">)</span>
      <span class="nx">hostInsert</span><span class="p">(</span><span class="nx">fragmentEndAnchor</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">)</span>
      <span class="c1">// fragment 的 children 只会是 array children
</span><span class="c1"></span>      <span class="c1">// 因为他们要么是通过 compiler 生成的，要么是由数组创建的
</span><span class="c1"></span>      <span class="nx">mountChildren</span><span class="p">(</span>
        <span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNodeArrayChildren</span><span class="p">,</span>
        <span class="nx">container</span><span class="p">,</span>
        <span class="nx">fragmentEndAnchor</span><span class="p">,</span>
        <span class="nx">parentComponent</span><span class="p">,</span>
        <span class="nx">parentSuspense</span><span class="p">,</span>
        <span class="nx">isSVG</span><span class="p">,</span>
        <span class="nx">optimized</span>
      <span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">patchFlag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="nx">patchFlag</span> <span class="o">&amp;</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">STABLE_FRAGMENT</span> <span class="o">&amp;&amp;</span>
        <span class="nx">dynamicChildren</span> <span class="o">&amp;&amp;</span>
        <span class="c1">// #2715 the previous fragment could&#39;ve been a BAILed one as a result
</span><span class="c1"></span>        <span class="c1">// of renderSlot() with no valid children
</span><span class="c1"></span>        <span class="nx">n1</span><span class="p">.</span><span class="nx">dynamicChildren</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// a stable fragment (template root or &lt;template v-for&gt;) doesn&#39;t need to
</span><span class="c1"></span>        <span class="c1">// patch children order, but it may contain dynamicChildren.
</span><span class="c1"></span>        <span class="nx">patchBlockChildren</span><span class="p">(</span>
          <span class="nx">n1</span><span class="p">.</span><span class="nx">dynamicChildren</span><span class="p">,</span>
          <span class="nx">dynamicChildren</span><span class="p">,</span>
          <span class="nx">container</span><span class="p">,</span>
          <span class="nx">parentComponent</span><span class="p">,</span>
          <span class="nx">parentSuspense</span><span class="p">,</span>
          <span class="nx">isSVG</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">parentComponent</span> <span class="o">&amp;&amp;</span> <span class="nx">parentComponent</span><span class="p">.</span><span class="kr">type</span><span class="p">.</span><span class="nx">__hmrId</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">traverseStaticChildren</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
          <span class="c1">// #2080 if the stable fragment has a key, it&#39;s a &lt;template v-for&gt; that may
</span><span class="c1"></span>          <span class="c1">//  get moved around. Make sure all root level vnodes inherit el.
</span><span class="c1"></span>          <span class="c1">// #2134 or if it&#39;s a component root, it may also get moved around
</span><span class="c1"></span>          <span class="c1">// as the component is being moved.
</span><span class="c1"></span>          <span class="nx">n2</span><span class="p">.</span><span class="nx">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
          <span class="p">(</span><span class="nx">parentComponent</span> <span class="o">&amp;&amp;</span> <span class="nx">n2</span> <span class="o">===</span> <span class="nx">parentComponent</span><span class="p">.</span><span class="nx">subTree</span><span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
          <span class="nx">traverseStaticChildren</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="kc">true</span> <span class="cm">/* shallow */</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// keyed / unkeyed, or manual fragments.
</span><span class="c1"></span>        <span class="c1">// for keyed &amp; unkeyed, since they are compiler generated from v-for,
</span><span class="c1"></span>        <span class="c1">// each child is guaranteed to be a block so the fragment will never
</span><span class="c1"></span>        <span class="c1">// have dynamicChildren.
</span><span class="c1"></span>        <span class="nx">patchChildren</span><span class="p">(</span>
          <span class="nx">n1</span><span class="p">,</span>
          <span class="nx">n2</span><span class="p">,</span>
          <span class="nx">container</span><span class="p">,</span>
          <span class="nx">fragmentEndAnchor</span><span class="p">,</span>
          <span class="nx">parentComponent</span><span class="p">,</span>
          <span class="nx">parentSuspense</span><span class="p">,</span>
          <span class="nx">isSVG</span><span class="p">,</span>
          <span class="nx">optimized</span>
        <span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-teleport" class="outline-2">
<h2 id="teleport">
TELEPORT
</h2>
<div id="outline-text-teleport" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0fcfa324ac72cf74ff24677bfa2305dac2dde6ac">feat(init): Teleport · gcclll/stb-vue-next@0fcfa32 · GitHub</a></p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-render-teleport.svg" alt="/img/vue3/runtime-core/vue-runtime-core-render-teleport.svg" title="/img/vue3/runtime-core/vue-runtime-core-render-teleport.svg" /></p>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
新增代码:
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<p>
<strong>TeleportImpl</strong>: 组件模板</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">TeleportImpl</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">__isTeleport</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="nx">process() {</span><span class="p">},</span>
  <span class="nx">remove() {</span><span class="p">},</span>
  <span class="nx">move</span>: <span class="kt">moveTeleport</span><span class="p">,</span>
  <span class="nx">hydrate</span>: <span class="kt">hydrateTeleport</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>resolveTarget</strong>: 根据选择器找到目标元素</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">resolveTarget</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">RendererElement</span><span class="p">&gt;(</span>
  <span class="nx">props</span>: <span class="kt">TeleportProps</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">select</span>: <span class="kt">RendererOptions</span><span class="p">[</span><span class="s1">&#39;querySelector&#39;</span><span class="p">]</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">T</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">targetSelector</span> <span class="o">=</span> <span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">to</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">targetSelector</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">select</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 无效选择器
</span><span class="c1"></span>      <span class="k">return</span> <span class="kc">null</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">select</span><span class="p">(</span><span class="nx">targetSelector</span><span class="p">)</span>
      <span class="c1">// Teleport 设置失败
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">target</span> <span class="kr">as</span> <span class="kt">any</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 无效的 Teleport 目标
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">targetSelector</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>moveTeleport</strong>: 执行移动</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">moveTeleport</span><span class="p">(</span>
  <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">,</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
  <span class="nx">parentAnchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">o</span><span class="o">:</span> <span class="p">{</span> <span class="nx">insert</span> <span class="p">},</span> <span class="nx">m</span>: <span class="kt">move</span> <span class="p">}</span><span class="o">:</span> <span class="nx">RendererInternals</span><span class="p">,</span>
  <span class="nx">moveType</span>: <span class="kt">TeleportMoveTypes</span> <span class="o">=</span> <span class="nx">TeleportMoveTypes</span><span class="p">.</span><span class="nx">REORDER</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>hydrateTeleport</strong>:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">hydrateTeleport</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">Node</span><span class="p">,</span>
  <span class="nx">vnode</span>: <span class="kt">TeleportVNode</span><span class="p">,</span>
  <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">optimized</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">o</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextSibling</span><span class="p">,</span> <span class="nx">parentNode</span><span class="p">,</span> <span class="nx">querySelector</span> <span class="p">}</span>
  <span class="p">}</span><span class="o">:</span> <span class="nx">RendererInternals</span><span class="p">&lt;</span><span class="nt">Node</span><span class="err">,</span> <span class="na">Element</span><span class="p">&gt;,</span>
  <span class="nx">hydrateChildren</span><span class="o">:</span> <span class="p">(</span>
    <span class="nx">node</span>: <span class="kt">Node</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">container</span>: <span class="kt">Element</span><span class="p">,</span>
    <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">optimized</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Node</span> <span class="o">|</span> <span class="kc">null</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Node</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">anchor</span> <span class="o">&amp;&amp;</span> <span class="nx">nextSibling</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">anchor</span> <span class="kr">as</span> <span class="nx">Node</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
导出组件 ~Teleport~：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Force-casted public typing for h and TSX props inference
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">Teleport</span> <span class="o">=</span> <span class="p">(</span><span class="nx">TeleportImpl</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span> <span class="kr">as</span> <span class="p">{</span>
  <span class="nx">__isTeleport</span>: <span class="kt">true</span>
  <span class="k">new</span> <span class="p">()</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$props</span>: <span class="kt">VNodeProps</span> <span class="o">&amp;</span> <span class="nx">TeleportProps</span> <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-teleport-process" class="outline-3">
<h3 id="teleport-process">
process()
</h3>
<div id="outline-text-teleport-process" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">process</span><span class="p">(</span><span class="cm">/*省略参数*/</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>
  <span class="kr">const</span> <span class="nx">disabled</span> <span class="o">=</span> <span class="nx">isTeleportDisabled</span><span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">props</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">shapeFlag</span><span class="p">,</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">n2</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// insert anchors in the main view
</span><span class="c1"></span>    <span class="c1">// &lt;container&gt;&lt;placeholder/&gt;&lt;anchor/&gt;&lt;/container&gt;
</span><span class="c1"></span>    <span class="nx">insert</span><span class="p">(</span><span class="nx">placeholder</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">);</span>
    <span class="c1">// &lt;container&gt;&lt;main-anchor/&gt;&lt;anchor/&gt;&lt;/container&gt;
</span><span class="c1"></span>    <span class="nx">insert</span><span class="p">(</span><span class="nx">mainAnchor</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">);</span>
    <span class="c1">// 根据选择器 &lt;Teleport to=&#34;selector&#34;/&gt; selector
</span><span class="c1"></span>    <span class="c1">// 找到目标 DOM 元素
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">resolveTarget</span><span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span> <span class="nx">querySelector</span><span class="p">));</span>
    <span class="c1">// &lt;target&gt;&lt;!-- &#39;&#39; --&gt;&lt;/target&gt;，用来作为插入时的参考节点
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">targetAnchor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">targetAnchor</span> <span class="o">=</span> <span class="nx">createText</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">insert</span><span class="p">(</span><span class="nx">targetAnchor</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
      <span class="c1">// #2652 we could be teleporting from a non-SVG tree into an SVG tree
</span><span class="c1"></span>      <span class="nx">isSVG</span> <span class="o">=</span> <span class="nx">isSVG</span> <span class="o">||</span> <span class="nx">isTargetSVG</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
    <span class="p">}</span> <span class="cm">/* else if warn ... */</span>

    <span class="kr">const</span> <span class="nx">mount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span> <span class="nx">anchor</span>: <span class="kt">RendererNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// 将 vnode children 渲染到 target 元素内
</span><span class="c1"></span>      <span class="c1">// 会插入到 anchor 的前面,如： ~&lt;target&gt;&lt;children/&gt;&lt;!--&#39;&#39;--&gt;&lt;/target&gt;~
</span><span class="c1"></span>    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">disabled</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 失效状态，不直接渲染到目标元素中，而是挂在了 #app 内对应的
</span><span class="c1"></span>      <span class="c1">// 节点里面，等待状态 enable 再渲染回 target 元素
</span><span class="c1"></span>      <span class="nx">mount</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">mainAnchor</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 直接渲染进目标元素
</span><span class="c1"></span>      <span class="nx">mount</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">targetAnchor</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// update content
</span><span class="c1"></span>    <span class="c1">// 非首次渲染
</span><span class="c1"></span>    <span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
    <span class="c1">// 已经渲染到 tar
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">dynamicChildren</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 动态子节点 patch
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">optimized</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// patch n1|n2 children
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">disabled</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// n2 new teleport disabled -&gt; n1 old target enabled
</span><span class="c1"></span>      <span class="c1">// n2 直接移到 #app 结构中的 container 上，暂时不直接渲染到
</span><span class="c1"></span>      <span class="c1">// 目标元素上
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">wasDisabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// moveTeleport
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// target changed
</span><span class="c1"></span>      <span class="c1">// teleport 的 to 属性值发生了变化，找到新的目标
</span><span class="c1"></span>      <span class="c1">// 进行移动
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">((</span><span class="nx">n2</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">n2</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">!==</span> <span class="p">(</span><span class="nx">n1</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// 1. 找新目标
</span><span class="c1"></span>        <span class="c1">// 2. 将 n2 移动到新的目标中
</span><span class="c1"></span>        <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wasDisabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 状态变更
</span><span class="c1"></span>        <span class="c1">// disabled -&gt; enabled
</span><span class="c1"></span>        <span class="c1">// move into teleport target
</span><span class="c1"></span>        <span class="c1">// 从 container 中将 n2 移到目标元素中
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
对于 teleport 的 mount 和 update 两个共同点(也是重点)：</p>
<ol>
<li>
<p>当 new teleport 是 disabled 时，不直接渲染到目标元素中，而是挂在当前
container 中待用</p>
</li>
<li>
<p>当 new teleport 状态 enabled 时，不论 old 什么状态，都会讲新的 teleport
children 渲染到目标元素下面。</p>
</li>
</ol>
<p>
Teleport 的移动类型有：</p>
<ol>
<li>
<p><code>TARGET_CHANGE</code> 目标发生了变化， teleport 的 <code>to</code> 属性变化</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// move target anchor if this is a target change.
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">moveType</span> <span class="o">===</span> <span class="nx">TeleportMoveTypes</span><span class="p">.</span><span class="nx">TARGET_CHANGE</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">insert</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">targetAnchor</span><span class="o">!</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">parentAnchor</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>TOGGLE</code> 状态发生了变化 enable -&gt; disable 或 disable -&gt; enable</p>
</li>
<li>
<p><code>REORDER</code> 目标元素内进行重新排序 ?</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// move main view anchor if this is a re-order.
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isReorder</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">insert</span><span class="p">(</span><span class="nx">anchor</span><span class="o">!</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">parentAnchor</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-24" class="outline-3">
<h3 id="headline-24">
<span class="todo">TODO</span>
测试
</h3>
<div id="outline-text-headline-24" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">Teleport</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">render</span><span class="p">(</span>
        <span class="nx">h</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
          <span class="nx">h</span><span class="p">(</span><span class="nx">Teleport</span><span class="p">,</span> <span class="p">{</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">target</span> <span class="p">},</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;teleported&#34;</span><span class="p">)),</span>
          <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;root&#34;</span><span class="p">),</span>
        <span class="p">]),</span>
        <span class="nx">root</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; root&#34;</span><span class="p">,</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">)]);</span>
    <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; target&#34;</span><span class="p">,</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">target</span><span class="p">)]);</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedcomponent stateful ? 0
mount component
update effect
patch component
&gt;&gt;&gt; root
&gt;&gt;&gt; target
</pre>
<blockquote>
<p>❓ 没结果！！！！！！</p>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-suspense" class="outline-2">
<h2 id="suspense">
SUSPENSE
</h2>
<div id="outline-text-suspense" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fd651abed0f0bbfb4e41910909212faeca26e116">feat(add): suspense · gcclll/stb-vue-next@fd651ab</a></p>
<p>
Suspense 组件和 <a href="#teleport">Teleport</a> 一样的组织结构和使用方式</p>
<p>
结构：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">Tmpl</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">__</span><span class="nx">isSuspense</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">process</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
然后在 process 中处理 mount 或 patch 流程，这里面和普通标签或普通组件的处理是一
样的， mount or patch。</p>
<p>
下面来看下这个组件是如何实现的，功能又是如何？</p>
<p>
新增函数：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 1. 模板
</span><span class="c1">// 根据注释说明，之所以采用这种结构是为了能让 Suspense 适用 tree-shaking
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">SuspenseImpl</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">__isSuspense</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="nx">process</span><span class="p">(</span><span class="nx">n1</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">n2</span>: <span class="kt">VNode</span> <span class="cm">/*...*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// mount
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// patch
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">hydrate</span>: <span class="kt">hydrateSuspense</span><span class="p">,</span>
  <span class="nx">create</span>: <span class="kt">createSuspenseBoundary</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// 2. mountSuspense
</span><span class="c1">// 3. patchSuspense
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
列表：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SuspenseImpl</code></td>
<td>-</td>
</tr>
<tr>
<td><code>mountSuspense()</code></td>
<td>-</td>
</tr>
<tr>
<td><code>patchSuspense()</code></td>
<td>-</td>
</tr>
<tr>
<td><code>SuspenseBoundary</code></td>
<td>-</td>
</tr>
<tr>
<td><code>createSuspenseBoundary()</code></td>
<td>-</td>
</tr>
<tr>
<td><code>hydrateSuspense()</code></td>
<td>-</td>
</tr>
</tbody>
</table>
<p>
脑图：</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-suspense.svg" alt="/img/vue3/runtime-core/vue-runtime-core-suspense.svg" title="/img/vue3/runtime-core/vue-runtime-core-suspense.svg" /></p>
<blockquote>
<p>重点逻辑：</p>
<ol>
<li>
<p>Suspense 的渲染转折点发生在 <code>mountComponent</code> 中，将 <code>setupRenderEffect</code> 做了
一次封装，让其在 <code>setup()</code> 返回的 Promise 状态完成之后去执行</p>
</li>
<li>
<p>在整个 Suspense mount 或 patch 过程中，使用了 <code>suspense.deps</code> 来记录异步事件，
只有当这个值为 <code>0</code> 的时候说明可以进行解析并挂在到真实DOM上了(比如. 服务器端数
据请求完成)</p>
</li>
</ol>
</blockquote>
<div id="outline-container-headline-26" class="outline-3">
<h3 id="headline-26">
SuspenseBoundary 数据结构
</h3>
<div id="outline-text-headline-26" class="outline-text-3">
<p>
只列出部分与 Suspense 关联性强的字段：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>vnode</td>
<td>VNode 结构</td>
</tr>
<tr>
<td>hiddenContainer</td>
<td>-</td>
</tr>
<tr>
<td>activeBranch</td>
<td>请求完成之后显示的组件分支 <code>#default</code></td>
</tr>
<tr>
<td>pendingBranch</td>
<td>请求中显示的分支 <code>#fallback</code></td>
</tr>
<tr>
<td>deps</td>
<td>组件依赖</td>
</tr>
<tr>
<td>timeout</td>
<td>超时时间</td>
</tr>
<tr>
<td>isInFallback</td>
<td>-</td>
</tr>
<tr>
<td>isHydrating</td>
<td>-</td>
</tr>
<tr>
<td>effects</td>
<td>[] 依赖列表</td>
</tr>
<tr>
<td>resolve(force)</td>
<td>-</td>
</tr>
<tr>
<td>fallback()</td>
<td>参数： fallbackVnode</td>
</tr>
<tr>
<td>move()</td>
<td>-</td>
</tr>
<tr>
<td>next()</td>
<td>-</td>
</tr>
<tr>
<td>registerDep()</td>
<td>注册实例依赖</td>
</tr>
</tbody>
</table>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SuspenseBoundary</span> <span class="p">{</span>
  <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">&lt;</span><span class="nt">RendererNode</span><span class="err">,</span> <span class="na">RendererElement</span><span class="err">,</span> <span class="na">SuspenseProps</span><span class="p">&gt;;</span>
  <span class="nx">parent</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">;</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">;</span>
  <span class="nx">hiddenContainer</span>: <span class="kt">RendererElement</span><span class="p">;</span>
  <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">activeBranch</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">pendingBranch</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">deps</span>: <span class="kt">number</span><span class="p">;</span>
  <span class="nx">pendingId</span>: <span class="kt">number</span><span class="p">;</span>
  <span class="nx">timeout</span>: <span class="kt">number</span><span class="p">;</span>
  <span class="nx">isInFallback</span>: <span class="kt">boolean</span><span class="p">;</span>
  <span class="nx">isHydrating</span>: <span class="kt">boolean</span><span class="p">;</span>
  <span class="nx">isUnmounted</span>: <span class="kt">boolean</span><span class="p">;</span>
  <span class="nx">effects</span>: <span class="kt">Function</span><span class="p">[];</span>
  <span class="nx">resolve</span><span class="p">(</span><span class="nx">force?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">fallback</span><span class="p">(</span><span class="nx">fallbackVNode</span>: <span class="kt">VNode</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">move</span><span class="p">(</span>
    <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
    <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">MoveType</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">next</span><span class="p">()</span><span class="o">:</span> <span class="nx">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">registerDep</span><span class="p">(</span>
    <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span><span class="p">,</span>
    <span class="nx">setupRenderEffect</span>: <span class="kt">SetupRenderEffectFn</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">unmount</span><span class="p">(</span><span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">doRemove?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-suspense-mount" class="outline-3">
<h3 id="suspense-mount">
mountSuspense()
</h3>
<div id="outline-text-suspense-mount" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/802b9adfcebae8b9e0ba2f0ad7e9f995c3675920">feat(add): suspense mount · gcclll/stb-vue-next@802b9ad</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">mountSuspense() {</span>
  <span class="kr">const</span> <span class="p">{</span>
    <span class="nx">p</span>: <span class="kt">patch</span><span class="p">,</span>
    <span class="nx">o</span><span class="o">:</span> <span class="p">{</span> <span class="nx">createElement</span> <span class="p">},</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">rendererInternals</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">hiddenContainer</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">suspense</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">suspense</span> <span class="o">=</span> <span class="nx">createSuspenseBoundary</span><span class="p">(</span>
    <span class="nx">vnode</span><span class="p">,</span>
    <span class="nx">parentSuspense</span><span class="p">,</span>
    <span class="nx">parentComponent</span><span class="p">,</span>
    <span class="nx">container</span><span class="p">,</span>
    <span class="nx">hiddenContainer</span><span class="p">,</span>
    <span class="nx">anchor</span><span class="p">,</span>
    <span class="nx">isSVG</span><span class="p">,</span>
    <span class="nx">optimized</span><span class="p">,</span>
    <span class="nx">rendererInternals</span>
  <span class="p">));</span>

  <span class="c1">// start mounting the content subtree in an off-dom container
</span><span class="c1"></span>  <span class="nx">patch</span><span class="p">(</span>
    <span class="kc">null</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingBranch</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">ssContent</span><span class="o">!</span><span class="p">),</span>
    <span class="nx">hiddenContainer</span><span class="p">,</span>
    <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentComponent</span><span class="p">,</span>
    <span class="nx">suspense</span><span class="p">,</span>
    <span class="nx">isSVG</span>
  <span class="p">);</span>
  <span class="c1">// now check if we have encountered any async deps
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">suspense</span><span class="p">.</span><span class="nx">deps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// has async
</span><span class="c1"></span>    <span class="c1">// mount the fallback tree
</span><span class="c1"></span>    <span class="nx">patch</span><span class="p">(</span>
      <span class="kc">null</span><span class="p">,</span>
      <span class="nx">vnode</span><span class="p">.</span><span class="nx">ssFallback</span><span class="o">!</span><span class="p">,</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="nx">anchor</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="kc">null</span><span class="p">,</span> <span class="c1">// fallback tree will not have suspense context
</span><span class="c1"></span>      <span class="nx">isSVG</span>
    <span class="p">);</span>
    <span class="nx">setActiveBranch</span><span class="p">(</span><span class="nx">suspense</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">ssFallback</span><span class="o">!</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Suspense has no async deps. Just resolve.
</span><span class="c1"></span>    <span class="nx">suspense</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 设置激活的 branch
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">setActiveBranch</span><span class="p">(</span><span class="nx">suspense</span>: <span class="kt">SuspenseBoundary</span><span class="p">,</span> <span class="nx">branch</span>: <span class="kt">VNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">suspense</span><span class="p">.</span><span class="nx">activeBranch</span> <span class="o">=</span> <span class="nx">branch</span><span class="p">;</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">parentComponent</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">suspense</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">el</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">branch</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
  <span class="c1">// in case suspense is the root node of a component,
</span><span class="c1"></span>  <span class="c1">// recursively update the HOC el
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">parentComponent</span> <span class="o">&amp;&amp;</span> <span class="nx">parentComponent</span><span class="p">.</span><span class="nx">subTree</span> <span class="o">===</span> <span class="nx">vnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">parentComponent</span><span class="p">.</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span><span class="p">;</span>
    <span class="nx">updateHOCHostEl</span><span class="p">(</span><span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">el</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>创建一个 DOM 之后的 div，即还没渲染到 DOM 结构中的</p>
</li>
<li>
<p>构建 Suspense 组件结构，这个结构非 VNode ，而是挂在 vnode.suspense 上的一个
<code>SuspenseBoundary</code> 结构</p>
</li>
<li>
<p>开始 mount 内容里的子树</p>
</li>
<li>
<p>检测 Suspense 有没异步依赖，如果有，则需要先解析这些异步依赖，完成之后再激活 branch</p>
</li>
<li>
<p>没有异步依赖直接拿到结果解析出组件</p>
</li>
</ol>
<p>
也就是说这里面需要重点关注的其实是“有没异步依赖的问题”。</p>
<p>
没有依赖的时候用到了 <code>suspense.resolve()</code> 这个应该是将创建的 off-dom div 挂到真
实 DOM 上去。</p>
</div>
</div>
<div id="outline-container-suspense-resolve" class="outline-3">
<h3 id="suspense-resolve">
suspense.resolve()
</h3>
<div id="outline-text-suspense-resolve" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">resume</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span>
    <span class="nx">vnode</span><span class="p">,</span>
    <span class="nx">activeBranch</span><span class="p">,</span>
    <span class="nx">pendingBranch</span><span class="p">,</span>
    <span class="nx">pendingId</span><span class="p">,</span>
    <span class="nx">effects</span><span class="p">,</span>
    <span class="nx">parentComponent</span><span class="p">,</span>
    <span class="nx">container</span><span class="p">,</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">suspense</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">suspense</span><span class="p">.</span><span class="nx">isHydrating</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">suspense</span><span class="p">.</span><span class="nx">isHydrating</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">resume</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 1. transition 支持，将 move() 操作注册到 afterLeave 回调
</span><span class="c1"></span>    <span class="c1">// 2. 卸载当前的 subTree 可能是 fallback
</span><span class="c1"></span>    <span class="c1">// 3. 不是 transition dely enter 进行 move()
</span><span class="c1"></span>    <span class="c1">// 这里最后执行的操作就是 move() 如果是 transition delay enter
</span><span class="c1"></span>    <span class="c1">// 则将 move() 注册到 afterLeave，否则直接执行 move() 将 suspense
</span><span class="c1"></span>    <span class="c1">// 内容渲染到真实DOM上
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">delayEnter</span> <span class="o">=</span>
      <span class="nx">activeBranch</span> <span class="o">&amp;&amp;</span>
      <span class="nx">pendingBranch</span><span class="o">!</span><span class="p">.</span><span class="nx">transition</span> <span class="o">&amp;&amp;</span>
      <span class="nx">pendingBranch</span><span class="o">!</span><span class="p">.</span><span class="nx">transition</span><span class="p">.</span><span class="nx">mode</span> <span class="o">===</span> <span class="s2">&#34;out-in&#34;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">delayEnter</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">activeBranch</span><span class="o">!</span><span class="p">.</span><span class="nx">transition</span><span class="o">!</span><span class="p">.</span><span class="nx">afterLeave</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pendingId</span> <span class="o">===</span> <span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingId</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">move</span><span class="p">(</span><span class="nx">pendingBranch</span><span class="o">!</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">MoveType</span><span class="p">.</span><span class="nx">ENTER</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">}</span>
    <span class="c1">// this is initial anchor on mount
</span><span class="c1"></span>    <span class="kd">let</span> <span class="p">{</span> <span class="nx">anchor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">suspense</span><span class="p">;</span>
    <span class="c1">// unmount current active tree
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">activeBranch</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// if the fallback tree was mounted, it may have been moved
</span><span class="c1"></span>      <span class="c1">// as part of a parent suspense. get the latest anchor for insertion
</span><span class="c1"></span>      <span class="nx">anchor</span> <span class="o">=</span> <span class="nx">next</span><span class="p">(</span><span class="nx">activeBranch</span><span class="p">);</span>
      <span class="nx">unmount</span><span class="p">(</span><span class="nx">activeBranch</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">suspense</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">delayEnter</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// move content from off-dom container to actual container
</span><span class="c1"></span>      <span class="nx">move</span><span class="p">(</span><span class="nx">pendingBranch</span><span class="o">!</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">MoveType</span><span class="p">.</span><span class="nx">ENTER</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 标记当前激活状态的分支，此时是 #default
</span><span class="c1"></span>  <span class="nx">setActiveBranch</span><span class="p">(</span><span class="nx">suspense</span><span class="p">,</span> <span class="nx">pendingBranch</span><span class="o">!</span><span class="p">);</span>
  <span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingBranch</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">suspense</span><span class="p">.</span><span class="nx">isInFallback</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="c1">// flush buffered effects
</span><span class="c1"></span>  <span class="c1">// check if there is a pending parent suspense
</span><span class="c1"></span>  <span class="c1">// 注册的 effect 处理，这里的处理说明了 suspense 的父子依赖执行
</span><span class="c1"></span>  <span class="c1">// 的顺序问题， effects 是按照数组加入顺序执行的(详情可以查看 reactivity 文章)
</span><span class="c1"></span>  <span class="c1">// 所以 effects 的优先级是自上而下的，即 parent-parent &gt; parent &gt; children
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">suspense</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">hasUnresolvedAncestor</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">pendingBranch</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// found a pending parent suspense, merge buffered post jobs
</span><span class="c1"></span>      <span class="c1">// into that parent
</span><span class="c1"></span>      <span class="nx">parent</span><span class="p">.</span><span class="nx">effects</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">effects</span><span class="p">);</span>
      <span class="nx">hasUnresolvedAncestor</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// no pending parent suspense, flush all jobs
</span><span class="c1"></span>  <span class="c1">// 如果没有挂起的 parent suspense 直接 flush 掉所有任务
</span><span class="c1"></span>  <span class="c1">// 结合上面的 while 举例：
</span><span class="c1"></span>  <span class="c1">// CompA -&gt; CompB -&gt; CompC
</span><span class="c1"></span>  <span class="c1">// 当解析到 CompC 时，一直往上检测 B 和 A 如果 B 有挂起的任务
</span><span class="c1"></span>  <span class="c1">// C 这里的任务不会被 flush，而是加入到 B 的队列等待执行
</span><span class="c1"></span>  <span class="c1">// 然后 C 解析完成，回溯到 B 的解析，此时又遵循同一套规则检测 A 的
</span><span class="c1"></span>  <span class="c1">// 挂起任务，直到最后要么立即执行 B 的任务要么 B 的任务也加入到 A
</span><span class="c1"></span>  <span class="c1">// 最后由 A 执行所有的任务(包含子 suspense 的)
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasUnresolvedAncestor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">effects</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">suspense</span><span class="p">.</span><span class="nx">effects</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="c1">// invoke @resolve event
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">onResolve</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">onResolve</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">onResolve</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">onResolve</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
分析如上面的注释， <code>resolve()</code> 主要目的就是将 off-dom div 上的 suspense 组件在异
步事件完成后根据结果解析出对应的分支，将这个分支挂载到真实的 DOM 上去，同时激活
它(显示出来)。</p>
<p>
其他处理：</p>
<ol>
<li>
<p><code>transition</code> 的延迟进入处理，通过将 move() 操作注册到 <code>afterLeave()</code> 回调实现</p>
</li>
<li>
<p>effects 任务处理，这里的任务处理机制是：</p>
<p>
只有在 parent 没有任何挂起的任务时候才会立即得到执行，否则只会进行合并操作。</p>
</li>
</ol>
<p>
因为代码最后需要执行 <code>move()</code> 操作将 <code>#default</code> 替换 <code>#fallback</code> ，所以下面先实
现 <code>suspense.move()</code> 再来测试。</p>
</div>
</div>
<div id="outline-container-suspense-move" class="outline-3">
<h3 id="suspense-move">
suspense.move()
</h3>
<div id="outline-text-suspense-move" class="outline-text-3">
<p>
实现这个 move 有几个地方需要修改</p>
<ol>
<li>
<p>SuspenseBoundary 中的 move()</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">move</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">suspense</span><span class="p">.</span><span class="nx">activeBranch</span> <span class="o">&amp;&amp;</span>
      <span class="nx">move</span><span class="p">(</span><span class="nx">suspense</span><span class="p">.</span><span class="nx">activeBranch</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="kr">type</span><span class="p">);</span>
    <span class="nx">suspense</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="nx">container</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>renderer.ts 中的 move() 函数，实现 SUSPENSE 组件的处理</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">move</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// SUSPENSE
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_SUSPENSE__</span> <span class="o">&amp;&amp;</span> <span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SUSPENSE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;move suspense&#34;</span><span class="p">);</span>
    <span class="nx">vnode</span><span class="p">.</span><span class="nx">suspense</span><span class="o">!</span><span class="p">.</span><span class="nx">move</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">moveType</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>另外 mountComponent 中漏了对 SUSPENSE 的处理</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">mountComponent</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="c1">// ... create instance
</span><span class="c1"></span>   <span class="c1">// ... setupComponent
</span><span class="c1"></span>
   <span class="c1">// setup() 是个异步函数，返回了 promise ，在 setupComponent
</span><span class="c1"></span>   <span class="c1">// 中会将 setup 执行结果赋值给 instance.asyncDep，即 SUSPENSE 处理
</span><span class="c1"></span>   <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_SUSPENSE__</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">asyncDep</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// 将 setupRenderEffect 注册到 parent deps 这里的 deps
</span><span class="c1"></span>     <span class="c1">// 执行由一定的规则, 如果 parent suspense 没有结束，child deps
</span><span class="c1"></span>     <span class="c1">// 不会立即执行，而是将它们合并到 parent suspense deps 中等待 parent 状态完成了才会执行，对于
</span><span class="c1"></span>     <span class="c1">// parent deps 也遵循这个规则，直到没有未完成的 parent suspense为止
</span><span class="c1"></span>     <span class="nx">parentSuspense</span> <span class="o">&amp;&amp;</span> <span class="nx">parentSuspense</span><span class="p">.</span><span class="nx">registerDep</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">setupRenderEffect</span><span class="p">);</span>
     <span class="c1">// 这里等于是说先用一个注释节点占位，等异步完成之后替换
</span><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initialVNode</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
       <span class="kr">const</span> <span class="nx">placeholder</span> <span class="o">=</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">subTree</span> <span class="o">=</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Comment</span><span class="p">));</span>
       <span class="nx">processCommentNode</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">placeholder</span><span class="p">,</span> <span class="nx">container</span><span class="o">!</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// ... setupRenderEffect SUSPENSE 不会进入到这里
</span><span class="c1"></span> <span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="kr">async</span> <span class="p">({</span>
    <span class="nx">nextTick</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">Suspense</span><span class="p">,</span>
  <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">function</span> <span class="nx">defineAsyncComponent</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="p">{</span> <span class="nx">slots</span> <span class="p">})</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
              <span class="nx">resolve</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">comp</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">slots</span><span class="p">));</span>
            <span class="p">},</span> <span class="nx">delay</span><span class="p">);</span>
          <span class="p">});</span>
          <span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()));</span>
          <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
        <span class="p">},</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">Async</span> <span class="o">=</span> <span class="nx">defineAsyncComponent</span><span class="p">({</span>
      <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;async&#34;</span><span class="p">);</span>
      <span class="p">},</span>
    <span class="p">});</span>

    <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span>
          <span class="nx">h</span><span class="p">(</span><span class="nx">Suspense</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="k">default</span><span class="o">:</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Async</span><span class="p">),</span>
            <span class="nx">fallback</span><span class="o">:</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;fallback&#34;</span><span class="p">),</span>
          <span class="p">});</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before&#34;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
    <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after&#34;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

component stateful ? 4
call setup
[Function (anonymous)] render
mount component
update effect
normalize vnode
patch component
component stateful ? 4
call setup
mount component
process element
mount elment
{ shapeFlag: 9 }
before
&lt;div&gt;fallback&lt;/div&gt;
[Function (anonymous)] render
update effect
normalize vnode
patch component
component stateful ? 4
call setup
no setup
[Function: render] render
mount component
update effect
normalize vnode
patch component
process element
mount elment
{ shapeFlag: 9 }
moving...
move component
moving...
move component
moving...
move host insert
after
&lt;div&gt;async&lt;/div&gt;
</pre>
<blockquote>
<p>❓. 结果发现并没变化？？？</p>
<pre class="example">
before
&lt;!----&gt;
after
&lt;!----&gt;
</pre>
<p>
既没有渲染 fallback 也没有渲染 default 的，为何？</p>
</blockquote>
<p>
上面的第二点有说到在 <em>renderer.ts</em> 的 <code>mountComponent()</code> 中增加了对 <code>SUSPENSE</code>
的处理，这里面有个注册依赖的动作，这里注册的是 <code>setupRenderEffect</code> 函数，这个函
数正是用来 mount &amp; update 组件的，而在 <em>components/Suspense.ts</em> 中并没有实现，所
以问题就出在这里了！！！</p>
<p>
FIX： <a href="#suspense-register-dep">suspense.registerDep()</a></p>
</div>
</div>
<div id="outline-container-suspense-register-dep" class="outline-3">
<h3 id="suspense-register-dep">
suspense.registerDep()
</h3>
<div id="outline-text-suspense-register-dep" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e0fa81e82115f6a7e7f9b9f683061ef2c8886d0e">feat(add): suspense registerDeps · gcclll/stb-vue-next@e0fa81e</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">registerDep</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">setupRenderEffect</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">isInPendingSuspense</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingBranch</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isInPendingSuspense</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">suspense</span><span class="p">.</span><span class="nx">deps</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">hydratedEl</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
  <span class="c1">// 捕获 setup 执行的异常，或接受执行的结果
</span><span class="c1"></span>  <span class="nx">instance</span>
    <span class="p">.</span><span class="nx">asyncDep</span><span class="o">!</span><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">handleError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">SETUP_FUNCTION</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">asyncSetupResult</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// 当 setup() 的 promise 状态变更之后重试
</span><span class="c1"></span>      <span class="c1">// 因为在解析之前组件可能已经被卸载了
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">isUnmounted</span> <span class="o">||</span>
        <span class="nx">suspense</span><span class="p">.</span><span class="nx">isUnmounted</span> <span class="o">||</span>
        <span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingId</span> <span class="o">!==</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">suspenseId</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// 从该组件开始重试，状态标记为已经完成
</span><span class="c1"></span>      <span class="nx">instance</span><span class="p">.</span><span class="nx">asyncResolved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">vnode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
      <span class="nx">handleSetupResult</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">asyncSetupResult</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hydratedEl</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 虚拟节点可能在 async dep 状态完成之前被某个更新替换掉了
</span><span class="c1"></span>        <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">hydratedEl</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kr">const</span> <span class="nx">placeHolder</span> <span class="o">=</span> <span class="o">!</span><span class="nx">hydratedEl</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">subTree</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
      <span class="nx">setupRenderEffect</span><span class="p">(</span>
        <span class="nx">instance</span><span class="p">,</span>
        <span class="nx">vnode</span><span class="p">,</span>
        <span class="c1">// 组件可能在 resolve 之前被移除了
</span><span class="c1"></span>        <span class="c1">// 如果这个不是一个 hydration，instance.subTree 将会是个注释
</span><span class="c1"></span>        <span class="c1">// 占位节点
</span><span class="c1"></span>        <span class="nx">parentNode</span><span class="p">(</span><span class="nx">hydratedEl</span> <span class="o">||</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">subTree</span><span class="p">.</span><span class="nx">el</span><span class="o">!</span><span class="p">),</span>
        <span class="nx">hydratedEl</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">next</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">subTree</span><span class="p">),</span>
        <span class="nx">suspense</span><span class="p">,</span>
        <span class="nx">isSVG</span><span class="p">,</span>
        <span class="nx">optimized</span>
      <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">placeHolder</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">remove</span><span class="p">(</span><span class="nx">placeHolder</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">updateHOCHostEl</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      <span class="c1">// only decrease deps count if suspense is not already resolved
</span><span class="c1"></span>      <span class="c1">// 没有任何依赖了就开始解析 Suspense
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">isInPendingSuspense</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="nx">suspense</span><span class="p">.</span><span class="nx">deps</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">suspense</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这个函数主要实现点：</p>
<ol>
<li>
<p>接受 <code>setup()</code> 执行的结果(<code>Promise</code>) asyncSetupResult 并捕获异常，对结果进行
分析处理</p>
</li>
<li>
<p>检测组件是不是已经卸载了，或者 suspense 被移除，就不需要继续处理了，退出即可</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="k">if</span> <span class="p">(</span>
   <span class="nx">instance</span><span class="p">.</span><span class="nx">isUnmounted</span> <span class="o">||</span>
   <span class="nx">suspense</span><span class="p">.</span><span class="nx">isUnmounted</span> <span class="o">||</span>
   <span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingId</span> <span class="o">!==</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">suspenseId</span>
 <span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>使用 <code>handleSetupResult(instance, asyncSetupResult, false)</code> 处理 setup 执行结
果，到底是 render 还是状态，需要解析</p>
</li>
<li>
<p>然后执行 setupRenderEffect 执行组件的 mount 或 update 操作</p>
</li>
<li>
<p>移除占位的注释节点</p>
</li>
<li>
<p>suspense.deps 执行完成之后就可以开始解析 suspense 组件 进行 move 操作了。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-31" class="outline-3">
<h3 id="headline-31">
patchSuspense()
</h3>
</div>
<div id="outline-container-suspense-other" class="outline-3">
<h3 id="suspense-other">
suspense.unmount&amp;fallback&amp;其他
</h3>
<div id="outline-text-suspense-other" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/080898d17073b322a1d8c86fba2bf271bc25e82f">feat(add): suspense unmount &amp; fallback… · gcclll/stb-vue-next@080898d</a></p>
<p>
新增：</p>
<ol>
<li>
<p><code>patchSuspense()</code> 和其他普通类型的处理差不多，无非就是检测 old 和 new branch 的
类型，进行 patch()，期间触发 <code>onPending</code> 事件</p>
</li>
<li>
<p><code>suspense.fallback()</code> 处理，当异步事件未完成时显示的 <code>#fallback</code> 分支处理，期间
触发 <code>onFallback</code> 事件</p>
</li>
<li>
<p><code>suspense.unmount()</code> 检测 activeBranch 和 pendingBranch 先卸载 active 随后卸载
pending 分支(前提是存在的情况下)</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-33" class="outline-3">
<h3 id="headline-33">
Suspense 组件测试
</h3>
<div id="outline-text-headline-33" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// `/js/vue/tests/Suspense.js&#39;
</span><span class="c1"></span><span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/tests/Suspense.js&#34;</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-34" class="outline-3">
<h3 id="headline-34">
小结
</h3>
<div id="outline-text-headline-34" class="outline-text-3">
<p>
SUSPENSE 组件的大致执行流程</p>
<ol>
<li>
<p>patch 进入 switch default 检测到 shapeFlag 是 SUSPENSE</p>
</li>
<li>
<p>调用 type.process(n1,n2,…) 处理 Suspense 组件，根据 n1 决定是 mountSuspense
还是 patchSuspense 这里和其他类型组件处理逻辑一致</p>
</li>
<li>
<p>首次(mount), 进行 mountSuspense 创建 Suspense 组件，对 pendingBranch 进行 patch 操作
(挂在到一个非DOM树中的 &#39;div&#39; 元素(<em>off-dom</em>)，待用)，即异步操作还未完成时显示
的分支，如： <code>#fallback</code></p>
</li>
<li>
<p>非首次(update)，进行 patchSuspense 对比新旧的 branch 进行 patch</p>
</li>
</ol>
<p>
要点：在 <code>mountComponent()</code> 中不是直接调用 <code>setupRenderEffect()</code> 而是调
用 <code>suspense.registerDep()</code> 去处理 <code>setup</code> 执行的结果(<code>instance.asyncDep</code>)，它是
个Promise 在其后的 then() 中接受 setup 执行结果，然后开始调用 setupRenderEffect
mount 或 update 子树节点，待 suspense 上的所有依赖都完成之后开始 resolve()
Suspense 组件将其挂在到真实的 DOM 中。</p>
<blockquote>
<p>原理： setup() 返回 Promise，render 过程中注册渲染函数，待 promise 状态完成调用
then 接受异步结果来渲染 Suspense 组件(任务为 <code>post</code> 类型)。</p>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-keep-alive" class="outline-2">
<h2 id="keep-alive">
KEEP_ALIVE
</h2>
<div id="outline-text-keep-alive" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a192cb42020ae44aa150e1dc9decc20bb6b01b96">feat(add): keep-alive render · gcclll/stb-vue-next@a192cb4</a></p>
<p>
KeepAlive 组件的 render 入口在 <code>processComponent()</code> 中，当 <code>n1 == null</code> 情况下，
会去检测该组件是不是 <code>keep-alive</code> 类型，如果是直接调用 <code>activate()</code> 激活。</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">// 17. processComponent
  const processComponent = (
  /*...*/) =&gt; {
    if (n1 == null) {
      // mount
<span class="gd">-      if (false /* keep alive */) {
</span><span class="gd">-        // TODO
</span><span class="gd"></span><span class="gi">+      if (n2.shapeFlag &amp; ShapeFlags.COMPONENT_KEPT_ALIVE) {
</span><span class="gi">+        ;(parentComponent!.ctx as KeepAliveContext).activate(
</span><span class="gi">+          n2,
</span><span class="gi">+          container,
</span><span class="gi">+          anchor,
</span><span class="gi">+          isSVG,
</span><span class="gi">+          optimized
</span><span class="gi">+        )
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
unmount 操作时，如果是 keep-alive 直接调用 <code>deactivate()</code> 失效，而不是真正的从
DOM 移除。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/024b24b9812f70d962cd2056a9164d6504d1ddd7">feat(add): keep-alive render unmount · gcclll/stb-vue-next@024b24b</a></p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">const unmount: UnmountFn = (...) =&gt; {
// ...
<span class="gd">-    // TODO keep-alive
</span><span class="gd">-    // keep-alive
</span><span class="gd"></span><span class="gi">+    if (shapeFlag &amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE) {
</span><span class="gi">+      ;(parentComponent!.ctx as KeepAliveContext).deactivate(vnode)
</span><span class="gi">+      return
</span><span class="gi">+    }
</span><span class="gi"></span>// ...
}
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
在 <code>mountComponent()</code> 中：</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">  // 18. mountComponent
  const mountComponent: MountComponentFn = (...) =&gt; {
    const instance: ComponentInternalInstance = (initialVNode.component = createComponentInstance(
      initialVNode,
      parentComponent,
      parentSuspense
    ))

<span class="gi">+    if (isKeepAlive(initialVNode)) {
</span><span class="gi">+      ;(instance.ctx as KeepAliveContext).renderer = internals
</span><span class="gi">+    }
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里将 keep-alive 组件的 setup() 函数中用到的一些 renderer 函数保存引用到
ctx.renderer 上供后面 <code>setup()</code> 中使用。</p>
<div class="src src-text">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">instance.ctx.renderer: {
    p: patch,
    m: move,
    um: _unmount,
    o: { createElement }
}</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
keep-alive 作为内部组件，内置了 <code>setup()</code> 函数的实现，所以在</p>
<p>
patch -&gt; processComponent -&gt; mountComponent -&gt; setupComponent</p>
<p>
时调用的就是这个内置的 setup() 函数。</p>
<p>
setup() 函数体大致代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span>: <span class="kt">KeepAliveProps</span><span class="p">,</span> <span class="p">{</span> <span class="nx">slots</span> <span class="p">}</span><span class="o">:</span> <span class="nx">SetupContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">cache</span>: <span class="kt">Cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">keys</span>: <span class="kt">Keys</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">current</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">getCurrentInstance</span><span class="p">()</span><span class="o">!</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">parentSuspense</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">suspense</span><span class="p">;</span>

  <span class="kr">const</span> <span class="nx">sharedContext</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">ctx</span> <span class="kr">as</span> <span class="nx">KeepAliveContext</span><span class="p">;</span>
  <span class="kr">const</span> <span class="p">{</span>
    <span class="nx">renderer</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">p</span>: <span class="kt">patch</span><span class="p">,</span>
      <span class="nx">m</span>: <span class="kt">move</span><span class="p">,</span>
      <span class="nx">um</span>: <span class="kt">_unmount</span><span class="p">,</span>
      <span class="nx">o</span><span class="o">:</span> <span class="p">{</span> <span class="nx">createElement</span> <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">sharedContext</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">storageContainer</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>

  <span class="nx">sharedContext</span><span class="p">.</span><span class="nx">activate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">,</span> <span class="nx">optimized</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{};</span>

  <span class="nx">sharedContext</span><span class="p">.</span><span class="nx">deactivate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{};</span>

  <span class="c1">// 对 renderer unmount 的一次封装
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">unmount</span><span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// 过滤掉缓存
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">pruneCache</span><span class="p">(</span><span class="nx">filter</span><span class="o">?:</span> <span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kd">function</span> <span class="nx">pruneCacheEntry</span><span class="p">(</span><span class="nx">key</span>: <span class="kt">CacheKey</span><span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// TODO 监听 include/exclude 属性变化
</span><span class="c1"></span>  <span class="c1">// TODO 在 render 之后缓存子树(subTree)
</span><span class="c1"></span>  <span class="c1">// TODO 注册生命周期
</span><span class="c1"></span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 该函数解析出原始 VNode 节点返回
</span><span class="c1"></span>  <span class="p">};</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
上面代码提供了一下信息：</p>
<ol>
<li>
<p><code>activate</code> &amp; <code>deactivate()</code> 函数是挂在 VNode 的 ctx 上的，并且是在 setup() 调
用期间产生</p>
</li>
<li>
<p>缓存机制</p>
</li>
<li>
<p>只注册了 <code>mounted, unmounted, update</code> 声明周期</p>
</li>
<li>
<p>最后返回的函数可以得到最原始的 VNode 节点</p>
</li>
</ol>
<p>
注意看 <code>processComponent()</code> 中的判断:</p>
<p>
<code>if (n2.shapeFlag &amp; ShapeFlags.COMPONENT_KEPT_ALIVE) { activate() }</code></p>
<p>
而 <code>COMPONENT_KEPT_ALIVE</code> 标记的赋值又是发生在 <code>setup()</code> 函数中，也就是说对于
<code>keep-alive</code> 组件首次加载不会进入到 activate() 而是直接按照普通组件处理调用
<code>mountComponent()</code> 去调用 <code>setup()</code> 初始化该 <code>keep-alive</code> 组件的一些函数等(其中
就包含 <code>activate</code> 和 <code>deactivate()</code> 函数)</p>
<p>
当状态发生变化时根据特定条件最后执行激活才会去调用 <code>activate()</code> 而不是进入 <code>mountComponent()</code></p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-keep-alive.svg" alt="/img/vue3/runtime-core/vue-runtime-core-keep-alive.svg" title="/img/vue3/runtime-core/vue-runtime-core-keep-alive.svg" /></p>
<div id="outline-container-keep-alive-activate" class="outline-3">
<h3 id="keep-alive-activate">
activate()
</h3>
<div id="outline-text-keep-alive-activate" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/267fdbdddbcafe62ac93c476bd75d22bbf3d9552">feat(add): keep-alive ctx.activate · gcclll/stb-vue-next@267fdbd</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">sharedContext</span><span class="p">.</span><span class="nx">activate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">,</span> <span class="nx">optimized</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">;</span>
  <span class="nx">move</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">MoveType</span><span class="p">.</span><span class="nx">ENTER</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
  <span class="c1">// props 可能发生变化，这里执行一次 patch 操作
</span><span class="c1"></span>  <span class="nx">patch</span><span class="p">(</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">vnode</span><span class="p">,</span>
    <span class="nx">vnode</span><span class="p">,</span>
    <span class="nx">container</span><span class="p">,</span>
    <span class="nx">anchor</span><span class="p">,</span>
    <span class="nx">instance</span><span class="p">,</span>
    <span class="nx">parentSuspense</span><span class="p">,</span>
    <span class="nx">isSVG</span><span class="p">,</span>
    <span class="nx">optimized</span>
  <span class="p">);</span>
  <span class="nx">queuePostRenderEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">isDeactivated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// activated 周期函数
</span><span class="c1"></span>      <span class="nx">invokeArrayFns</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">vnodeHook</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">onVnodeMounted</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">vnodeHook</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">invokeVNodeHook</span><span class="p">(</span><span class="nx">vnodeHook</span><span class="p">,</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="nx">parentSuspense</span><span class="p">);</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
激活 <code>keep-alive</code> 组件的函数，只有当非首次的时候，状态发生变更时会被调用，注意上
面的任务类型 <code>post</code> ，周期函数的调用是异步发生的，会在下一个 tick 中赋值。</p>
</div>
</div>
<div id="outline-container-keep-alive-deactivate" class="outline-3">
<h3 id="keep-alive-deactivate">
deactivate()
</h3>
<div id="outline-text-keep-alive-deactivate" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b340d57b5f1888ff1a0c6aae84d946a2f867f8b2">feat(add): keep-alive ctx.deactivate · gcclll/stb-vue-next@b340d57</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">sharedContext</span><span class="p">.</span><span class="nx">deactivate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">;</span>
  <span class="nx">move</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">storageContainer</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">MoveType</span><span class="p">.</span><span class="nx">LEAVE</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
  <span class="nx">queuePostRenderEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">da</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">invokeArrayFns</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">da</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">vnodeHook</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">onVnodeUnmounted</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">vnodeHook</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">invokeVNodeHook</span><span class="p">(</span><span class="nx">vnodeHook</span><span class="p">,</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">isDeactivated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">},</span> <span class="nx">parentSuspense</span><span class="p">);</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
如果看这里失活状态下组件是如何进行更新的？</p>
<p>
<code>storageContainer</code> 是在 setup 中创建的一个空的 off-dom div 元素，这里等于是当组
件失活时会将 keep-alive 先挂载到这个 off-dom div 上去.</p>
</div>
</div>
<div id="outline-container-keep-alive-unmount" class="outline-3">
<h3 id="keep-alive-unmount">
unmount()
</h3>
<div id="outline-text-keep-alive-unmount" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/4ce0b9b43af304af28db7eae5d40211d3280459f">feat(add): keep-alive unmount · gcclll/stb-vue-next@4ce0b9b</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 对 renderer unmount 的一次封装
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">unmount</span><span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">resetShapeFlag</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
  <span class="nx">_unmount</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">resetShapeFlag</span><span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">shapeFlag</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_SHOULD_KEEP_ALIVE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">shapeFlag</span> <span class="o">-=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_SHOULD_KEEP_ALIVE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_KEPT_ALIVE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">shapeFlag</span> <span class="o">-=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_KEPT_ALIVE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">=</span> <span class="nx">shapeFlag</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-keep-alive-include-exclude" class="outline-3">
<h3 id="keep-alive-include-exclude">
include &amp; exclude props
</h3>
<div id="outline-text-keep-alive-include-exclude" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fdcc3060f9469256055d8dec39b6f46b3e6faa28">feat(add): keep-alive include &amp; exclude props · gcclll/stb-vue-next@fdcc306</a></p>
<p>
主要增加两个函数实现，一个监听动作(<code>watch([include, exclude],...)</code>):</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 过滤掉缓存
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">pruneCache</span><span class="p">(</span><span class="nx">filter</span><span class="o">?:</span> <span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">cache</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">getComponentName</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ConcreteComponent</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">filter</span> <span class="o">||</span> <span class="o">!</span><span class="nx">filter</span><span class="p">(</span><span class="nx">name</span><span class="p">)))</span> <span class="p">{</span>
      <span class="nx">pruneCacheEntry</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">pruneCacheEntry</span><span class="p">(</span><span class="nx">key</span>: <span class="kt">CacheKey</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">cached</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">current</span> <span class="o">||</span> <span class="nx">cached</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 新增或节点类型发生变化，直接卸载掉老的
</span><span class="c1"></span>    <span class="nx">unmount</span><span class="p">(</span><span class="nx">cached</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 重置标记就可以了？
</span><span class="c1"></span>    <span class="c1">// 当前激活的实例不该再是 kept-alive
</span><span class="c1"></span>    <span class="c1">// 我们不能立即卸载但是稍后会进行卸载，所以这里先重置其标记
</span><span class="c1"></span>    <span class="c1">// 不能立即卸载？
</span><span class="c1"></span>    <span class="c1">// 是因为在 activate 和 deactivate 中的周期函数调用
</span><span class="c1"></span>    <span class="c1">// 是采用的 post 类型异步执行的缘故吗？
</span><span class="c1"></span>    <span class="nx">resetShapeFlag</span><span class="p">(</span><span class="nx">current</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">cache</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="nx">keys</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 监听 include/exclude 属性变化
</span><span class="c1"></span><span class="nx">watch</span><span class="p">(</span>
  <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">props</span><span class="p">.</span><span class="nx">include</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">exclude</span><span class="p">],</span>
  <span class="p">([</span><span class="nx">include</span><span class="p">,</span> <span class="nx">exclude</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 支持三种类型
</span><span class="c1"></span>    <span class="c1">// 1. 字符串, &#39;a,b,c&#39;
</span><span class="c1"></span>    <span class="c1">// 2. 正则表达式， /a|b|c/
</span><span class="c1"></span>    <span class="c1">// 3. 数组， [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, /d|e/]
</span><span class="c1"></span>    <span class="nx">include</span> <span class="o">&amp;&amp;</span> <span class="nx">pruneCache</span><span class="p">((</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">include</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
    <span class="nx">exclude</span> <span class="o">&amp;&amp;</span> <span class="nx">pruneCache</span><span class="p">((</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nx">matches</span><span class="p">(</span><span class="nx">exclude</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">flush</span><span class="o">:</span> <span class="s2">&#34;post&#34;</span><span class="p">,</span> <span class="nx">deep</span>: <span class="kt">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>include</strong> 指定需要缓存的组件名称</p>
<p>
<strong>exclude</strong> 指定不需要进行缓存的组件名称</p>
<p>
类型： <code>String, RegExp, Array</code></p>
</div>
</div>
<div id="outline-container-keep-alive-cache-subtree" class="outline-3">
<h3 id="keep-alive-cache-subtree">
cache subtree
</h3>
<div id="outline-text-keep-alive-cache-subtree" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/efb757777be9f6c51a2fb1be56a33ee86fc42e43">feat(add): keep-alive cache subtree · gcclll/stb-vue-next@efb7577</a></p>
<p>
对  <code>&lt;keep-alive/&gt;</code> 的孩子节点🌲进行缓存。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 在 render 之后缓存子树(subTree)
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">pendingCacheKey</span>: <span class="kt">CacheKey</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">cacheSubtree</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">pendingCacheKey</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">pendingCacheKey</span><span class="p">,</span> <span class="nx">getInnerChild</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">subTree</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="c1">// 注册生命周期
</span><span class="c1"></span><span class="nx">onMounted</span><span class="p">(</span><span class="nx">cacheSubtree</span><span class="p">);</span>
<span class="nx">onUpdated</span><span class="p">(</span><span class="nx">cacheSubtree</span><span class="p">);</span>

<span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">cache</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">cached</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">subTree</span><span class="p">,</span> <span class="nx">suspense</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="nx">getInnerChild</span><span class="p">(</span><span class="nx">subTree</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cached</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 有缓存的节点
</span><span class="c1"></span>      <span class="c1">// 当前实例会成为 keep-alive 的 unmount 一部分
</span><span class="c1"></span>      <span class="nx">resetShapeFlag</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
      <span class="c1">// 但是在这里执行它的 deactivated 钩子函数
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">da</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">.</span><span class="nx">da</span><span class="p">;</span>
      <span class="nx">da</span> <span class="o">&amp;&amp;</span> <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">da</span><span class="p">,</span> <span class="nx">suspense</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 没有缓存的直接 unmount
</span><span class="c1"></span>    <span class="nx">unmount</span><span class="p">(</span><span class="nx">cached</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
在 <code>&lt;keep-alive/&gt;</code> 卸载之前将已经缓存 <code>deactivated</code> 钩子函数推入队列等待执行，没
有缓存的直接调用 <code>unmount()</code> 卸载掉。</p>
</div>
</div>
<div id="outline-container-keep-alive-setup-render" class="outline-3">
<h3 id="keep-alive-setup-render">
setup() -&gt; render 函数
</h3>
<div id="outline-text-keep-alive-setup-render" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9b75803d90f6e285c063fbbf41042dc381de3cfe">feat(add): keep-alive return render function · gcclll/stb-vue-next@9b75803</a></p>
<p>
在 <code>setupComponent()</code> 中，最后调用 setup() 得到 setupResult ，最后会将这个
setupResult 传递给 handleSetupResult() 去处理，返回结果，这里面当检测到
setupResult 是个函数的时候，那么这个函数会被当做是 <code>instance.render</code> 函数处理。</p>
<p>
即，这里的 setupResult 是 <code>&lt;keep-alive/&gt;</code> 组件 children 的 render 函数。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">setup() {</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 该函数解析出原始 VNode 节点返回
</span><span class="c1"></span>    <span class="c1">// 根据组件的执行流程，这个函数将会在 setupComponent() 中
</span><span class="c1"></span>    <span class="c1">// 执行 setup() 得到 setupResult ，传递给 handleSetupResult()
</span><span class="c1"></span>    <span class="c1">// 函数，这里面检测 setupResult 也就是这个匿名函数，如果它是函数
</span><span class="c1"></span>    <span class="c1">// 会直接被当做 render 函数处理(instance.render 或 instance.ssrRender)
</span><span class="c1"></span>    <span class="c1">// 结论就是，这个匿名函数是 render() 函数
</span><span class="c1"></span>
    <span class="nx">pendingCacheKey</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">slots</span><span class="p">.</span><span class="k">default</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 组件支持默认插槽使用方式
</span><span class="c1"></span>      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">slots</span><span class="p">.</span><span class="k">default</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">rawVNode</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// KeepAlive 组件只能包含一个组件作为 child
</span><span class="c1"></span>      <span class="c1">// 也就是说 ~&lt;keep-alive&gt;&lt;CompA/&gt;&lt;CompB/&gt;&lt;/keep-alive/&gt;~
</span><span class="c1"></span>      <span class="c1">// 是不合法的使用
</span><span class="c1"></span>      <span class="nx">current</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="c1">// warn...
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">children</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">isVNode</span><span class="p">(</span><span class="nx">rawVNode</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">rawVNode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">STATEFUL_COMPONENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="p">(</span><span class="nx">rawVNode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SUSPENSE</span><span class="p">))</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 1. 非 VNode 类型节点
</span><span class="c1"></span>      <span class="c1">// 2. 既不是有状态组件(对象类型组件)也不是 Suspense 的时候
</span><span class="c1"></span>      <span class="c1">// 相反意味着，节点必须满足下面几种情况
</span><span class="c1"></span>      <span class="c1">// 1. 是 VNode 类型且是有状态组件(非函数式组件)
</span><span class="c1"></span>      <span class="c1">// 2. 或者是 VNode 类型且是Suspense 组件
</span><span class="c1"></span>      <span class="nx">current</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">rawVNode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 也就是说 keep-alive 只接受有状态组件或者 Suspense 作为唯一的 child
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="nx">getInnerChild</span><span class="p">(</span><span class="nx">rawVNode</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">comp</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ConcreteComponent</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">getComponentName</span><span class="p">(</span><span class="nx">comp</span><span class="p">);</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">include</span><span class="p">,</span> <span class="nx">exclude</span><span class="p">,</span> <span class="nx">max</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span>
      <span class="c1">// 无缓存的节点
</span><span class="c1"></span>      <span class="p">(</span><span class="nx">include</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">name</span> <span class="o">||</span> <span class="o">!</span><span class="nx">matches</span><span class="p">(</span><span class="nx">include</span><span class="p">,</span> <span class="nx">name</span><span class="p">)))</span> <span class="o">||</span>
      <span class="c1">// 在不缓存的节点们之列
</span><span class="c1"></span>      <span class="p">(</span><span class="nx">exclude</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">exclude</span><span class="p">,</span> <span class="nx">name</span><span class="p">))</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nx">current</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">rawVNode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">comp</span> : <span class="kt">vnode.key</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">cachedVNode</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>

    <span class="c1">// 克隆一份如果它有被复用的话，因为我们即将修改它
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">vnode</span> <span class="o">=</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rawVNode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SUSPENSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rawVNode</span><span class="p">.</span><span class="nx">ssContent</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">pendingCacheKey</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">cachedVNode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">cachedVNode</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
      <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span> <span class="o">=</span> <span class="nx">cachedVNode</span><span class="p">.</span><span class="nx">component</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 在 subTree 上递归更新 transition 钩子函数
</span><span class="c1"></span>        <span class="nx">setTransitionHooks</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">transition</span><span class="o">!</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// 避免 vnode 正在首次 mount
</span><span class="c1"></span>      <span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">|=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_KEPT_ALIVE</span><span class="p">;</span>
      <span class="c1">// 标记 key 为最新的
</span><span class="c1"></span>      <span class="nx">keys</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="nx">keys</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 没有缓存的情况
</span><span class="c1"></span>      <span class="nx">keys</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="c1">// 删除最老的 entry，缓冲池已经满了，删除掉最老的那个
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">max</span> <span class="o">&amp;&amp;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">max</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// 因为 Set 没有直接取指定位置元素的值
</span><span class="c1"></span>        <span class="c1">// 这里的目的是变相的取 Set 中第一个元素，即最早 add 的那个 key
</span><span class="c1"></span>        <span class="c1">// 如： new Set([1,2,3,4]) =&gt; keys.values() =&gt; &lt;1,2,3,4&gt;
</span><span class="c1"></span>        <span class="c1">// next() 得到迭代器下一个值 { value: 1, done: false }
</span><span class="c1"></span>        <span class="c1">// .value 得到第一个集合元素的值
</span><span class="c1"></span>        <span class="nx">pruneCacheEntry</span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">values</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 避免 vnode 正在被卸载，在renderer unmount 中会检测
</span><span class="c1"></span>    <span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">|=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_SHOULD_KEEP_ALIVE</span><span class="p">;</span>

    <span class="nx">current</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">rawVNode</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
最后返回的是 <code>children[0]</code> 节点。</p>
<p>
里面有个置位标识值得注意： <code>ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE</code></p>
<p>
这个作用是啥？</p>
<ol>
<li>
<p><code>unmount()</code> 中调用 deactivate() 的条件</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// keep-alive
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_SHOULD_KEEP_ALIVE</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(</span><span class="nx">parentComponent</span><span class="o">!</span><span class="p">.</span><span class="nx">ctx</span> <span class="kr">as</span> <span class="nx">KeepAliveContext</span><span class="p">).</span><span class="nx">deactivate</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>instance.update</code> 的 effect 中触发 <code>activated</code> 周期函数的条件</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// activated hook for keep-alive roots.
</span><span class="c1">// #1742 activated hook must be accessed after first render
</span><span class="c1">// since the hook may be injected by a child keep-alive
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">a</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&amp;&amp;</span> <span class="nx">initialVNode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT_SHOULD_KEEP_ALIVE</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-keep-alive-tests" class="outline-3">
<h3 id="keep-alive-tests">
测试
</h3>
<div id="outline-text-keep-alive-tests" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// `/js/vue/tests/Suspense.js&#39;
</span><span class="c1"></span><span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/tests/KeepAlive.js&#34;</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

Cannot read property &#39;_vnode&#39; of undefined
</pre>
<blockquote>
<p>⚠ 有错误，待完成。。。vue-next 测试见最后一章节<a href="#testing">《测试》</a></p>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-ref" class="outline-2">
<h2 id="ref">
set ref
</h2>
<div id="outline-text-ref" class="outline-text-2">
<p>
官方使用文档: <a href="https://v3.vuejs.org/api/special-attributes.html#ref">Special Attributes | Vue.js</a></p>
<p>
官方示例：</p>
<div class="src src-html">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="c">&lt;!-- vm.$refs.p will be the DOM node --&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span> <span class="na">ref</span><span class="o">=</span><span class="s">&#34;p&#34;</span><span class="p">&gt;</span>hello<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="c">&lt;!-- vm.$refs.child will be the child component instance --&gt;</span>
<span class="p">&lt;</span><span class="nt">child-component</span> <span class="na">ref</span><span class="o">=</span><span class="s">&#34;child&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">child-component</span><span class="p">&gt;</span>

<span class="c">&lt;!-- When bound dynamically, we can define ref as a callback function, passing the element or component instance explicitly --&gt;</span>
<span class="p">&lt;</span><span class="nt">child-component</span> <span class="na">:ref</span><span class="o">=</span><span class="s">&#34;(el) =&gt; child = el&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">child-component</span><span class="p">&gt;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
patch() 函数中对 ref 属性的处理(set ref)：</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a0a1344a13ebf9d403aaefe845bd573ef3a8eda8">feat(add): set ref · gcclll/stb-vue-next@a0a1344</a></p>
<p>
源码实现主要有几个步骤：</p>
<ol>
<li>
<p>ref 支持数据?</p>
</li>
<li>
<p>是不是异步组件 value = null</p>
</li>
<li>
<p>有状态组件(<code>STATEFULL_COMPONENT</code>, 分函数组件)</p>
<p>
<code>value = vnode.component!.exposed || vnode.component!.proxy</code></p>
</li>
<li>
<p>其他情况下 value = vnode.el</p>
<p>
即 2,3,4 都是为了设置 value 指向哪个引用，比如 vnode.el 在渲染之后会被赋值为当
前 vnode 对应的那个 DOM 元素。</p>
</li>
<li>
<p>断开 oldRef 引用</p>
</li>
<li>
<p>设置 ref，分三种情况</p>
<ul>
<li>
<p>ref 是字符串直接 <code>refs[ref] = value</code> 取 key 设值</p>
</li>
<li>
<p>ref 是 Ref 类型， <code>ref.value = value</code></p>
</li>
<li>
<p>ref 是函数类型， <code>ref(value, refs)</code> 调用</p>
</li>
</ul>
</li>
</ol>
<p>
    在设值的时候会根据 value 是否为空值来控制是否进行异步设置，等 Render 执行完
    成之后再设置</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(</span><span class="nx">doSet</span> <span class="kr">as</span> <span class="nx">SchedulerCb</span><span class="p">).</span><span class="nx">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">doSet</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">doSet</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
源码:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">patch</span>: <span class="kt">PatchFn</span> <span class="o">=</span> <span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// set ref
</span><span class="c1"></span>  <span class="nx">setRef</span><span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">n1</span> <span class="o">&amp;&amp;</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">,</span> <span class="nx">n2</span><span class="p">);</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">setRef</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">rawRef</span>: <span class="kt">VNodeNormalizedRef</span><span class="p">,</span>
  <span class="nx">oldRawRef</span>: <span class="kt">VNodeNormalizedRef</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">vnode</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">rawRef</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">rawRef</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">r</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">setRef</span><span class="p">(</span>
        <span class="nx">r</span><span class="p">,</span>
        <span class="nx">oldRawRef</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">oldRawRef</span><span class="p">)</span> <span class="o">?</span> <span class="nx">oldRawRef</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">:</span> <span class="nx">oldRawRef</span><span class="p">),</span>
        <span class="nx">parentSuspense</span><span class="p">,</span>
        <span class="nx">vnode</span>
      <span class="p">)</span>
    <span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">value</span><span class="o">:</span>
    <span class="o">|</span> <span class="nx">ComponentPublicInstance</span>
    <span class="o">|</span> <span class="nx">RendererNode</span>
    <span class="o">|</span> <span class="nx">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span>
    <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="c1">// async 组件，可以通过 defineAsyncComponent 声明的组件
</span><span class="c1"></span>  <span class="c1">// loader 会赋给 __asyncLoader，如果是异步组件需要等组件渲染完成之后
</span><span class="c1"></span>  <span class="c1">// 再去设置 ref
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">vnode</span> <span class="o">||</span> <span class="nx">isAsyncWrapper</span><span class="p">(</span><span class="nx">vnode</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">STATEFUL_COMPONENT</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">.</span><span class="nx">exposed</span> <span class="o">||</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">.</span><span class="nx">proxy</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">i</span>: <span class="kt">owner</span><span class="p">,</span> <span class="nx">r</span>: <span class="kt">ref</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">rawRef</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// warn 丢失 ref owner 上下文
</span><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">oldRef</span> <span class="o">=</span> <span class="nx">oldRawRef</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">oldRawRef</span> <span class="kr">as</span> <span class="nx">VNodeNormalizedRefAtom</span><span class="p">).</span><span class="nx">r</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">refs</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">refs</span> <span class="o">===</span> <span class="nx">EMPTY_OBJ</span> <span class="o">?</span> <span class="p">(</span><span class="nx">owner</span><span class="p">.</span><span class="nx">refs</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">:</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">refs</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">setupState</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">.</span><span class="nx">setupState</span><span class="p">;</span>

  <span class="c1">// unset old ref
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">oldRef</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">oldRef</span> <span class="o">!==</span> <span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">oldRef</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">refs</span><span class="p">[</span><span class="nx">oldRef</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hasOwn</span><span class="p">(</span><span class="nx">setupState</span><span class="p">,</span> <span class="nx">oldRef</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">setupState</span><span class="p">[</span><span class="nx">oldRef</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">oldRef</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">oldRef</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">ref</span><span class="p">))</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">doSet</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">refs</span><span class="p">[</span><span class="nx">ref</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hasOwn</span><span class="p">(</span><span class="nx">setupState</span><span class="p">,</span> <span class="nx">ref</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">setupState</span><span class="p">[</span><span class="nx">ref</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="c1">// #1789: 非空值，在 render 结束后设置
</span><span class="c1"></span>    <span class="c1">// 控制意味着是 unmount，它不应该重写同key 的其他 ref
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">doSet</span> <span class="kr">as</span> <span class="nx">SchedulerCb</span><span class="p">).</span><span class="nx">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">doSet</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">doSet</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">ref</span><span class="p">))</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">doSet</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">ref</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">doSet</span> <span class="kr">as</span> <span class="nx">SchedulerCb</span><span class="p">).</span><span class="nx">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">doSet</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">doSet</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">ref</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">FUNCTION_REF</span><span class="p">,</span> <span class="p">[</span><span class="nx">value</span><span class="p">,</span> <span class="nx">refs</span><span class="p">]);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// warn ...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里可以简单理解为：将 <code>ref</code> 设值为 <code>vnode.el</code> 这是个引用，因此当它有值的时候也
等于是 ref 有值了，然后分为异步和同步，异步需要等 render 完成再去设置。</p>
</div>
</div>
<div id="outline-container-dir-hooks" class="outline-2">
<h2 id="dir-hooks">
direcitve hooks
</h2>
<div id="outline-text-dir-hooks" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1343be213f6f0b95b2b37b16733b722e8c465099">feat(add): directive hooks · gcclll/stb-vue-next@1343be2</a></p>
<p>
执行指令声明周期钩子函数：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">invokeDirectiveHook</span><span class="p">(</span>
  <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">,</span>
  <span class="nx">prevVNode</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">instance</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">name</span>: <span class="kt">keyof</span> <span class="nx">ObjectDirective</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">bindings</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">dirs</span><span class="o">!</span>
  <span class="kr">const</span> <span class="nx">oldBindings</span> <span class="o">=</span> <span class="nx">prevVNode</span> <span class="o">&amp;&amp;</span> <span class="nx">prevVNode</span><span class="p">.</span><span class="nx">dirs</span><span class="o">!</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bindings</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">binding</span> <span class="o">=</span> <span class="nx">bindings</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">oldBindings</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">binding</span><span class="p">.</span><span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">oldBindings</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">hook</span> <span class="o">=</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">dir</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">DirectiveHook</span> <span class="o">|</span> <span class="kc">undefined</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hook</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callWithAsyncErrorHandling</span><span class="p">(</span><span class="nx">hook</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">DIRECTIVE_HOOK</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span>
        <span class="nx">binding</span><span class="p">,</span>
        <span class="nx">vnode</span><span class="p">,</span>
        <span class="nx">prevVNode</span>
      <span class="p">])</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
给组件注册指令集：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">withDirectives</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">VNode</span><span class="p">&gt;(</span>
  <span class="nx">vnode</span>: <span class="kt">T</span><span class="p">,</span>
  <span class="nx">directives</span>: <span class="kt">DirectiveArguments</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">internalInstance</span> <span class="o">=</span> <span class="nx">currentRenderingInstance</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">internalInstance</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">warn</span><span class="p">(</span><span class="sb">`withDirectives can only be used inside render functions.`</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">vnode</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">internalInstance</span><span class="p">.</span><span class="nx">proxy</span>
  <span class="kr">const</span> <span class="nx">bindings</span>: <span class="kt">DirectiveBinding</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">dirs</span> <span class="o">||</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">dirs</span> <span class="o">=</span> <span class="p">[])</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">directives</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">[</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">modifiers</span> <span class="o">=</span> <span class="nx">EMPTY_OBJ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">directives</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">dir</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">dir</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">mounted</span>: <span class="kt">dir</span><span class="p">,</span>
        <span class="nx">updated</span>: <span class="kt">dir</span>
      <span class="p">}</span> <span class="kr">as</span> <span class="nx">ObjectDirective</span>
    <span class="p">}</span>
    <span class="nx">bindings</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">dir</span><span class="p">,</span>
      <span class="nx">instance</span><span class="p">,</span>
      <span class="nx">value</span><span class="p">,</span>
      <span class="nx">oldValue</span>: <span class="kt">void</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">arg</span><span class="p">,</span>
      <span class="nx">modifiers</span>
    <span class="p">})</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">vnode</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
created, befoureMounted, mounted 发生在 mountElement()</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 发生在 mountChildren 之后
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">dirs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">invokeDirectiveHook</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="s2">&#34;created&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ...
</span><span class="c1"></span>
<span class="c1">// 在插入DOM之前执行
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">dirs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">invokeDirectiveHook</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="s2">&#34;beforeMount&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//  hostInsert(el, container, anchor)
</span><span class="c1"></span>
<span class="c1">// 插入DOM之后执行，放入任务队列等待 render 结束
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span>
  <span class="p">(</span><span class="nx">vnodeHook</span> <span class="o">=</span> <span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">onVnodeMounted</span><span class="p">)</span> <span class="o">||</span>
  <span class="nx">needCallTransitionHooks</span> <span class="o">||</span>
  <span class="nx">dirs</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">queuePostRenderEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">vnodeHook</span> <span class="o">&amp;&amp;</span> <span class="nx">invokeVNodeHook</span><span class="p">(</span><span class="nx">vnodeHook</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">);</span>
    <span class="nx">needCallTransitionHooks</span> <span class="o">&amp;&amp;</span> <span class="nx">transition</span><span class="o">!</span><span class="p">.</span><span class="nx">enter</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
    <span class="nx">dirs</span> <span class="o">&amp;&amp;</span> <span class="nx">invokeDirectiveHook</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="s2">&#34;mounted&#34;</span><span class="p">);</span>
  <span class="p">},</span> <span class="nx">parentSuspense</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
beforeUpdate, updated 发生在 mountChildren()</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gi">+    if ((vnodeHook = newProps.onVnodeBeforeUpdate)) {
</span><span class="gi">+      invokeVNodeHook(vnodeHook, parentComponent, n2, n1)
</span><span class="gi">+    }
</span><span class="gi"></span>
<span class="gi">+ if (dirs) {
</span><span class="gi">+      invokeDirectiveHook(n2, n1, parentComponent, &#39;beforeUpdate&#39;)
</span><span class="gi">+    }
</span><span class="gi"></span>
<span class="gi">+   if ((vnodeHook = newProps.onVnodeUpdated) || dirs) {
</span><span class="gi">+      queuePostRenderEffect(() =&gt; {
</span><span class="gi">+        vnodeHook &amp;&amp; invokeVNodeHook(vnodeHook, parentComponent, n2, n1)
</span><span class="gi">+        dirs &amp;&amp; invokeDirectiveHook(n2, n1, parentComponent, &#39;updated&#39;)
</span><span class="gi">+      }, parentSuspense)
</span><span class="gi">+    }
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
unmounted 发生在 unmount()</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gi">+    if ((vnodeHook = props &amp;&amp; props.onVnodeUnmounted) || shouldInvokeDirs) {
</span><span class="gi">+      queuePostRenderEffect(() =&gt; {
</span><span class="gi">+        vnodeHook &amp;&amp; invokeVNodeHook(vnodeHook, parentComponent, vnode)
</span><span class="gi">+        shouldInvokeDirs &amp;&amp;
</span><span class="gi">+          invokeDirectiveHook(vnode, null, parentComponent, &#39;unmounted&#39;)
</span><span class="gi">+      }, parentSuspense)
</span><span class="gi">+    }
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">currentInstance</span><span class="p">,</span>
    <span class="nx">withDirectives</span><span class="p">,</span>
  <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kd">let</span> <span class="mi">_</span><span class="nx">vnode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="mi">_</span><span class="nx">prevVnode</span><span class="p">;</span>

    <span class="kr">const</span> <span class="nx">beforeMount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">prevVnode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; before mounted&#34;</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.tag = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.parentNode = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root.children.length = &#34;</span> <span class="o">+</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;vnode = _vnode, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;prev vnode = &#34;</span> <span class="o">+</span> <span class="nx">prevVnode</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">mounted</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">prevVnode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; mounted&#34;</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.tag = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.parentNode = root&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">===</span> <span class="nx">root</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root.children[0] = el&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">el</span><span class="p">));</span>

      <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;vnode = _vnode, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;prev vnode = &#34;</span> <span class="o">+</span> <span class="nx">prevVnode</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">beforeUpdate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">prevVnode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; before update&#34;</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.tag = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.parentNode = root&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">===</span> <span class="nx">root</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root.children[0] = el&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">el</span><span class="p">));</span>

      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;节点应该还没更新 el.children[0].text = &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;vnode = _vnode, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;prev vnode = _prevVnode&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">prevVNode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">prevVnode</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">updated</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">prevVnode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; updated&#34;</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.tag = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.parentNode = root&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">===</span> <span class="nx">root</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root.children[0] = el&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">el</span><span class="p">));</span>

      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;节点应该已经更新 el.children[0].text = &#34;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;vnode = _vnode, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;prev vnode = _prevVnode&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">prevVNode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">prevVnode</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">beforeUnmount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">prevVnode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; before unmount&#34;</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.tag = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.parentNode = root&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">===</span> <span class="nx">root</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root.children[0] = el&#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">el</span><span class="p">));</span>

      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;节点应该已经更新 el.children[0].text = &#34;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;vnode = _vnode, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;prev vnode = &#34;</span> <span class="o">+</span> <span class="nx">prevVNode</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="kr">const</span> <span class="nx">unmounted</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">binding</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">prevVnode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; unmounted&#34;</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.tag = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;el.parentNode = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root.children.length = &#34;</span> <span class="o">+</span> <span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;节点应该已经更新 el.children[0].text = &#34;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;vnode = _vnode, &#34;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">===</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">));</span>
      <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;prev vnode = &#34;</span> <span class="o">+</span> <span class="nx">prevVNode</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">dir</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">beforeMount</span><span class="p">,</span>
      <span class="nx">mounted</span><span class="p">,</span>
      <span class="nx">beforeUpdate</span><span class="p">,</span>
      <span class="nx">updated</span><span class="p">,</span>
      <span class="nx">beforeUnmount</span><span class="p">,</span>
      <span class="nx">unmounted</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="kd">let</span> <span class="mi">_</span><span class="nx">instance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
        <span class="mi">_</span><span class="nx">instance</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">;</span>
      <span class="p">},</span>
      <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">(</span><span class="mi">_</span><span class="nx">prevVnode</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">_</span><span class="nx">vnode</span> <span class="o">=</span> <span class="nx">withDirectives</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="p">[</span>
            <span class="p">[</span>
              <span class="nx">dir</span><span class="p">,</span> <span class="c1">// dir, v-dir
</span><span class="c1"></span>              <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="c1">// value, v-dir:foo.ok=value
</span><span class="c1"></span>              <span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="c1">// argument
</span><span class="c1"></span>              <span class="p">{</span> <span class="nx">ok</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="c1">// modifiers
</span><span class="c1"></span>            <span class="p">],</span>
          <span class="p">]));</span>
        <span class="k">return</span> <span class="mi">_</span><span class="nx">vnode</span><span class="p">;</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedcomponent stateful ? 4
call setup
[Function: render] render
normalize vnode
&gt;&gt;&gt; before mounted
el.tag = div
el.parentNode = null
root.children.length = 0
{
  dir: {
    beforeMount: [Function: beforeMount],
    mounted: [Function: mounted],
    beforeUpdate: [Function: beforeUpdate],
    updated: [Function: updated],
    beforeUnmount: [Function: beforeUnmount],
    unmounted: [Function: unmounted]
  },
  instance: {},
  value: 0,
  oldValue: undefined,
  arg: &#39;foo&#39;,
  modifiers: { ok: true }
}
vnode = _vnode, true
prev vnode = null
&gt;&gt;&gt; mounted
el.tag = div
el.parentNode = roottrue
root.children[0] = elfalse
{
  dir: {
    beforeMount: [Function: beforeMount],
    mounted: [Function: mounted],
    beforeUpdate: [Function: beforeUpdate],
    updated: [Function: updated],
    beforeUnmount: [Function: beforeUnmount],
    unmounted: [Function: unmounted]
  },
  instance: {},
  value: 0,
  oldValue: undefined,
  arg: &#39;foo&#39;,
  modifiers: { ok: true }
}
vnode = _vnode, true
prev vnode = null
</pre>
</div>
</div>
<div id="outline-container-component-props" class="outline-2">
<h2 id="component-props">
<span class="todo">TODO</span>
component props
</h2>
<div id="outline-text-component-props" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6f6a0bee8e84f93a5cdab83e4db87b9897b1e041">feat(add): patch props · gcclll/stb-vue-next@6f6a0be</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">currentInstance</span><span class="p">,</span>
    <span class="nx">withDirectives</span><span class="p">,</span>
    <span class="nx">defineComponent</span><span class="p">,</span>
  <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">props</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">attrs</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">proxy</span><span class="p">;</span>

    <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="nx">defineComponent</span><span class="p">({</span>
      <span class="nx">props</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;fooBar&#34;</span><span class="p">,</span> <span class="s2">&#34;barBaz&#34;</span><span class="p">],</span>
      <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">props</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$props</span><span class="p">;</span>
        <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$attrs</span><span class="p">;</span>
        <span class="nx">proxy</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">},</span>
    <span class="p">});</span>

    <span class="kr">const</span> <span class="mi">_</span><span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">([</span>
        <span class="s1">&#39;&gt;&gt;&gt; &#39;</span> <span class="o">+</span> <span class="nx">title</span><span class="p">,</span>
        <span class="s1">&#39;\nproxy.fooBar = &#39;</span> <span class="o">+</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">fooBar</span><span class="p">,</span>
        <span class="s1">&#39;\n&gt; props\n&#39;</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span>
        <span class="s1">&#39;\n&gt; attrs\n&#39;</span><span class="p">,</span> <span class="nx">attrs</span>
      <span class="p">])</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">fooBar</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">)</span>
    <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;foo-bar&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">baz</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">barBaz</span><span class="o">:</span> <span class="mi">5</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">)</span>
    <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;foo-bar 会转成 fooBar&#39;</span><span class="p">)</span>

    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">qux</span><span class="o">:</span> <span class="mi">5</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">)</span>
    <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;删除 camel case&#39;</span><span class="p">)</span>

    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n&gt;&gt;&gt; stateful with setup&#39;</span><span class="p">)</span>
  <span class="p">},</span>

  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedcomponent stateful ? 4
call setup
no setup
[Function: render] render
normalize vnode
&gt;&gt;&gt; test
proxy.fooBar = 1
&gt; props
 { fooBar: 1 }
&gt; attrs
 { bar: 2 }
should update component
has changed props
normalize vnode
&gt;&gt;&gt; foo-bar 会转成 fooBar
proxy.fooBar = 3
&gt; props
 { fooBar: 3, barBaz: 5 }
&gt; attrs
 { bar: 3, baz: 4 }
should update component
has changed props
normalize vnode
&gt;&gt;&gt; 删除 camel case
proxy.fooBar = undefined
&gt; props
 { fooBar: undefined, barBaz: undefined }
&gt; attrs
 { qux: 5 }
</pre>
</div>
</div>
<div id="outline-container-testing" class="outline-2">
<h2 id="testing">
测试
</h2>
<div id="outline-text-testing" class="outline-text-2">
<p style="font-weight:800;font-size:28px;">Teleport Testing...</p>
<div id="6MyGYf">
<p style="background:red;color:white;" id="p0"></p>
<p style="background:red;color:white;" id="p1"></p>
<p style="background:red;color:white;" id="p2"></p>
<p style="background:red;color:white;" id="p3"></p>
<p style="background:red;color:white;" id="p4"></p>
<p style="background:red;color:white;" id="p5"></p>
<p style="background:red;color:white;" id="p6"></p>
<p style="background:red;color:white;" id="p7"></p>
<div id="dzwrLeuq5V"></div>
<script src="/js/vue/tests/dzwrLeuq5V.js"></script>

<p style="font-weight:800;font-size:28px;">Suspense Testing...</p>
<div id="WTYoDwLIkv"></div>
<script src="/js/vue/tests/WTYoDwLIkv.js"></script>

<p style="font-weight:800;font-size:28px;">KeepAlive Testing...</p>
<div id="r9KorlFxQ9"></div>
<script src="/js/vue/tests/r9KorlFxQ9.js"></script>

<p style="font-weight:800;font-size:28px;">Directive Testing...</p>
<div id="VSkUTk5fho"></div>
<script src="/js/vue/tests/VSkUTk5fho.js"></script>
<div id="outline-container-headline-47" class="outline-3">
<h3 id="headline-47">
脑图 &amp; 测试结果 GIF
</h3>
<div id="outline-text-headline-47" class="outline-text-3">
<ol>
<li>
<p>keep-alive 测试变化 GIF(13M):</p>
<p>
 <img src="/img/vue3/runtime-core/gifs/test-keep-alive.gif" alt="/img/vue3/runtime-core/gifs/test-keep-alive.gif" title="/img/vue3/runtime-core/gifs/test-keep-alive.gif" /></p>
<p>
 结合<a href="#keep-alive-deactivate">源码</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// deactivate()
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">storageContainer</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="nx">move</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">storageContainer</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">MoveType</span><span class="p">.</span><span class="nx">LEAVE</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 即， deactivated 的 DOM 节点其实并非直接删除了，而是移到到了一个  <code>off-dom</code>
的元素上了，待重新激活的时候再移回来(在源码的 deactivate 和 activate 函数中增
加 <code>storageContainer</code> 打印).</p>
</li>
<li>
<p>测试脑图：</p>
<p>
 <img src="/img/vue3/runtime-core/vue-sample-runtime-core-suspense.svg" alt="/img/vue3/runtime-core/vue-sample-runtime-core-suspense.svg" title="/img/vue3/runtime-core/vue-sample-runtime-core-suspense.svg" /></p>
</li>
</ol>
</div>
</div>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-03-16
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/runtime-core/">runtime-core,</a>
          <a href="/tags/render/">render,</a>
          <a href="/tags/component/">component</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-teardown-2-sheduler/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 功能拆解② Scheduler 渲染机制</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/vue/vue-vuex/">
            <span class="next-text nav-default">vuex for vue3 源码分析(附.脑图)</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2021-03-16 00:00:00 \u002b0000 UTC',
        title: 'Vue3 源码头脑风暴之 7 ☞ runtime-core(3) - render component',
        clientID: '7251a6b30d0d6c0f4aa2',
        clientSecret: '320c43a98b0d5ae30535d8cf6cb3be7a05895c77',
        repo: 'cheng92-comments',
        owner: 'gcclll',
        admin: ['gcclll'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
