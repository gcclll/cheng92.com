<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>vue-router-next for vue3 æºç åˆ†æ(é™„.è„‘å›¾) - è‹¥å¶çŸ¥ç§‹</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ æ…å…¥ğŸ˜¢ vue-router-next æºç åˆ†ææµç¨‹å›¾ï¼Œæ­¤æ–‡é‡ç‚¹åœ¨å›¾ï¼Œé™„å¸¦ä¸€" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-router-next/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.06b20cf21b1dff0a19c6a6fd2770439ed0c003d544ece3c4e1fbfb34fc217e45.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="vue-router-next for vue3 æºç åˆ†æ(é™„.è„‘å›¾)" />
<meta property="og:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ æ…å…¥ğŸ˜¢ vue-router-next æºç åˆ†ææµç¨‹å›¾ï¼Œæ­¤æ–‡é‡ç‚¹åœ¨å›¾ï¼Œé™„å¸¦ä¸€" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-router-next/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2021-03-05T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-03-05T00:00:00&#43;00:00" />

<meta itemprop="name" content="vue-router-next for vue3 æºç åˆ†æ(é™„.è„‘å›¾)">
<meta itemprop="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ æ…å…¥ğŸ˜¢ vue-router-next æºç åˆ†ææµç¨‹å›¾ï¼Œæ­¤æ–‡é‡ç‚¹åœ¨å›¾ï¼Œé™„å¸¦ä¸€"><meta itemprop="datePublished" content="2021-03-05T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-05T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="4172">
<meta itemprop="keywords" content="vue,,vue3,,vue-router-next," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="vue-router-next for vue3 æºç åˆ†æ(é™„.è„‘å›¾)"/>
<meta name="twitter:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ æ…å…¥ğŸ˜¢ vue-router-next æºç åˆ†ææµç¨‹å›¾ï¼Œæ­¤æ–‡é‡ç‚¹åœ¨å›¾ï¼Œé™„å¸¦ä¸€"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">vue-router-next for vue3 æºç åˆ†æ(é™„.è„‘å›¾)</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-03-05 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 4172 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 9 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#vue-router">vue-router-next</a>
</li>
<li><a href="#flow">å®ˆå«å‡½æ•°å®Œæ•´æ‰§è¡Œæµç¨‹</a>
</li>
<li><a href="#h5-history">HTML5 history api</a>
</li>
<li><a href="#web-history">createWebHistory</a>
<ul>
<li><a href="#use-h5-history">useHistoryStateNavigation(base: string)</a>
<ul>
<li><a href="#headline-6">createCurrentLocation(base: string,location: Location)</a>
</li>
<li><a href="#headline-7">changeLocation(to,state,replace)</a>
</li>
<li><a href="#headline-8">replace(to, data?)</a>
</li>
<li><a href="#headline-9">push(to, data?)</a>
</li>
</ul>
</li>
<li><a href="#headline-10">useHistoryListeners()</a>
<ul>
<li><a href="#headline-11">popStateHandler({ state })</a>
</li>
<li><a href="#headline-12">pauseListeners()</a>
</li>
<li><a href="#headline-13">listen(callback)</a>
</li>
<li><a href="#headline-14">beforeUnloadListener()</a>
</li>
<li><a href="#headline-15">destroy() æ³¨é”€äº‹ä»¶</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#web-hash">createWebHashHistory</a>
</li>
<li><a href="#mem-his">createMemoryHistory</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<script src="/js/utils.js"></script>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<blockquote>
<p><strong>æ…å…¥ğŸ˜¢</strong></p>
<p>
vue-router-next æºç åˆ†ææµç¨‹å›¾ï¼Œæ­¤æ–‡é‡ç‚¹åœ¨å›¾ï¼Œé™„å¸¦ä¸€äº›æ€»ç»“æ€§çš„æ–‡å­—åˆ†
æå†…å®¹(å›¾ä¸€èˆ¬æ¯”è¾ƒå¤§ï¼Œåªä¿è¯è‡ªå·±èƒ½çœ‹æ‡‚ç³»åˆ—~~~~)ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­ä¸€äº›é›¶ç¢çš„ç¬”è®°ã€‚</p>
</blockquote>
<div id="outline-container-vue-router" class="outline-2">
<h2 id="vue-router">
vue-router-next
</h2>
<div id="outline-text-vue-router" class="outline-text-2">
<p>
è„‘å›¾ï¼š
<img src="/img/vue3/vue-router/vue-router-next-start.svg" alt="/img/vue3/vue-router/vue-router-next-start.svg" title="/img/vue3/vue-router/vue-router-next-start.svg" /></p>
<p>
ç®€è¦åˆ†æï¼š</p>
<p>
vue-router å®ç°ä»ä½¿ç”¨ä¸Šæ¥è¯´æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>
<p>è·¯ç”±æ³¨å†Œåˆå§‹åŒ–ï¼Œä»¥ <code>VueRouter.createRoute({history, routes})</code> ä¸ºæ‰§è¡Œå…¥å£</p>
<ul>
<li>
<p>åˆ›å»ºåŒ¹é…å™¨ matcher è·¯ç”±çš„ä¸€äº›åŒ¹é…ã€æ·»åŠ ã€æŸ¥æ‰¾å•Šä»€ä¹ˆçš„æ“ä½œéƒ½æ˜¯æœ‰è¿™ä¸ª matcher æ¥å®ç°çš„</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">RouterMatcher</span> <span class="p">{</span>
  <span class="nx">addRoute</span><span class="o">:</span> <span class="p">(</span><span class="nx">record</span>: <span class="kt">RouteRecordRaw</span><span class="p">,</span> <span class="nx">parent?</span>: <span class="kt">RouteRecordMatcher</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">removeRoute</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">(</span><span class="nx">matcher</span>: <span class="kt">RouteRecordMatcher</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
    <span class="p">(</span><span class="nx">name</span>: <span class="kt">RouteRecordName</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">getRoutes</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">RouteRecordMatcher</span><span class="p">[];</span>
  <span class="nx">getRecordMatcher</span><span class="o">:</span> <span class="p">(</span><span class="nx">name</span>: <span class="kt">RouteRecordName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">RouteRecordMatcher</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>

  <span class="nx">resolve</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 è€Œä¸Šé¢çš„æ¥å£æ“ä½œçš„æ— éå°±æ˜¯ä¸¤ä¸ªè·¯ç”±ä»“åº“ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// è¿™ä¸ªæ— è®ºæœ‰æ²¡æœ‰åå­—çš„è·¯ç”±è®°å½•éƒ½ä¼šè¢«å­˜å‚¨åˆ°è¿™ä¸ªæ•°ç»„ä¸­
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">matchers</span>: <span class="kt">RouteRecordMatcher</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
<span class="c1">// è¿™ä¸ªå­˜å‚¨çš„æ˜¯å¸¦ name å­—æ®µçš„è·¯ç”± &lt;name, record&gt; ç»“æ„
</span><span class="c1">// æ–¹ä¾¿ç›´æ¥å¯ä»¥é€šè¿‡ map.get(name) å°±å¯ä»¥å»åˆ°è·¯ç”±è®°å½•ï¼Œå‡å°‘æ•°ç»„æŸ¥æ‰¾æ¶ˆè€—
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">matcherMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">RouteRecordName</span><span class="err">,</span> <span class="na">RouteRecordMatcher</span><span class="p">&gt;();</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>åˆå§‹åŒ–è·¯ç”±å®ˆå«å­˜å‚¨å™¨ï¼Œå…¶å®å°±æ˜¯ä¸ªåŒ…å« <code>{list,add,result}</code> çš„ä¸€ä¸ªå¯¹è±¡</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// è¿›å…¥ä¹‹å‰çš„çš„å›è°ƒåˆ—è¡¨
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">beforeGuards</span> <span class="o">=</span> <span class="nx">useCallbacks</span><span class="p">&lt;</span><span class="nt">NavigationGuardWithThis</span><span class="err">&lt;</span><span class="na">undefined</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">();</span>
 <span class="c1">// è§£æè·¯ç”±ä¹‹å‰çš„å›è°ƒåˆ—è¡¨
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">beforeResolveGuards</span> <span class="o">=</span> <span class="nx">useCallbacks</span><span class="p">&lt;</span><span class="nt">NavigationGuardWithThis</span><span class="err">&lt;</span><span class="na">undefined</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">();</span>
 <span class="c1">// è¿›å…¥ä¹‹åçš„å›è°ƒåˆ—è¡¨
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">afterGuards</span> <span class="o">=</span> <span class="nx">useCallbacks</span><span class="p">&lt;</span><span class="nt">NavigationHookAfter</span><span class="p">&gt;();</span>

 <span class="kr">export</span> <span class="kd">function</span> <span class="nx">useCallbacks</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;()</span> <span class="p">{</span>
   <span class="kd">let</span> <span class="nx">handlers</span>: <span class="kt">T</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">handler</span>: <span class="kt">T</span><span class="p">)</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span> <span class="p">{}</span>
   <span class="kd">function</span> <span class="nx">reset() {</span>
     <span class="nx">handlers</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="p">{</span>
     <span class="nx">add</span><span class="p">,</span>
     <span class="nx">list</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">handlers</span><span class="p">,</span>
     <span class="nx">reset</span><span class="p">,</span>
   <span class="p">};</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><strong>currentRoute</strong> é‡è¦å˜é‡ï¼Œæ˜¯ä¸ª shallow ref å“åº”å¼ç±»å‹çš„å€¼ï¼Œä¸
 <code>&lt;router-view/&gt;</code> å½“å‰æ˜¾ç¤ºçš„è·¯ç”±æ¯æ¯ç›¸å…³ï¼Œæˆ–è€…è¯´å°±æ˜¯å®ƒï¼Œå› ä¸º <code>RouterView</code>
 ç»„ä»¶ä¸­æœ‰é—´æ¥çš„ç›‘å¬è¿™ä¸ªå€¼ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// RouterView.ts
</span><span class="c1"></span> <span class="c1">// å°±æ˜¯è¿™é‡Œçš„ matchedRouteRef
</span><span class="c1"></span> <span class="nx">watch</span><span class="p">(</span>
   <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">viewRef</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">matchedRouteRef</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="kr">as</span> <span class="kr">const</span><span class="p">,</span>
   <span class="p">([</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">name</span><span class="p">],</span> <span class="p">[</span><span class="nx">oldInstance</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">oldName</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="c1">// ...
</span><span class="c1"></span>   <span class="p">}</span>
 <span class="p">);</span>

 <span class="c1">// RouterView.ts &gt; ä¸ºä»€ä¹ˆè¯´æ˜¯é—´æ¥å‘¢ï¼Ÿçœ‹ä¸‹é¢  matchedRouteRef çš„ç”±æ¥
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">injectedRoute</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="nx">routerViewLocationKey</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
 <span class="kr">const</span> <span class="nx">routeToDisplay</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">route</span> <span class="o">||</span> <span class="nx">injectedRoute</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
 <span class="kr">const</span> <span class="nx">depth</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="nx">viewDepthKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 <span class="kr">const</span> <span class="nx">matchedRouteRef</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">RouteLocationMatched</span> <span class="err">|</span> <span class="na">undefined</span><span class="p">&gt;(</span>
   <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">routeToDisplay</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">matched</span><span class="p">[</span><span class="nx">depth</span><span class="p">]</span>
 <span class="p">);</span>

 <span class="c1">// router.ts &gt; routerViewLocationKey ???  ä¸è®°å¾—äº†å—? router.install... å•Š
</span><span class="c1"></span> <span class="nx">app</span><span class="p">.</span><span class="nx">provide</span><span class="p">(</span><span class="nx">routerKey</span><span class="p">,</span> <span class="nx">router</span><span class="p">);</span>
 <span class="nx">app</span><span class="p">.</span><span class="nx">provide</span><span class="p">(</span><span class="nx">routeLocationKey</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">reactiveRoute</span><span class="p">));</span>
 <span class="nx">app</span><span class="p">.</span><span class="nx">provide</span><span class="p">(</span><span class="nx">routerViewLocationKey</span><span class="p">,</span> <span class="nx">currentRoute</span><span class="p">);</span>

 <span class="c1">// çœ‹åˆ°æ²¡ï¼Œå…³è”ä¸Šäº†å§!!!
</span><span class="c1"></span> <span class="c1">// app.provide -&gt; currentRoute -&gt;
</span><span class="c1"></span> <span class="c1">// injectedRoute -&gt; routeToDisplay -&gt;
</span><span class="c1"></span> <span class="c1">// routeToDisplay.value.matched[depth]
</span><span class="c1"></span>
 <span class="cm">/*
</span><span class="cm">  å¹¶ä¸”æ³¨æ„çœ‹ ~RouterView~ ç»„ä»¶ä¸­ setupæœ€åè¿”å›çš„å€¼æ˜¯ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­æœ‰å¯¹
</span><span class="cm">  routeToDisplay, matchedRouteRefè¿›è¡Œå¼•ç”¨ä¹Ÿå°±æ˜¯åœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè§¦å‘ track æ“
</span><span class="cm">  ä½œå°†å®ƒæ”¶é›†åˆ°è¿™å†™å€¼çš„ä¾èµ–åˆ—è¡¨ä¸­ï¼Œåªè¦è¿™äº›å€¼å‘ç”Ÿå˜æ›´å°±ä¼š triggerè¿™ä¸ª setup
</span><span class="cm">  æ‰§è¡Œï¼Œæ¥æ›´æ–° ~&lt;router-view/&gt;~
</span><span class="cm"> ,*/</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>åˆå§‹åŒ– router å®ä¾‹</p>
<p>
 åŒ…å«ä¸€äº› api :</p>
<p>
 è·¯ç”±çš„å¢åˆ æ”¹æŸ¥ä¸»è¦æ¥æº matcherï¼š <code>{addRoute, currentRoute, removeRoute, hasRoute, getRoutes, resolv}</code></p>
<p>
 è·¯ç”±çš„è·³è½¬è¡Œä¸ºï¼š <code>{push, replace, go, back: () =&gt; go(-1), forward: () =&gt;
 go(1)}</code>, è¿™é‡Œçš„ push, replace å‡½æ•°æœ€ç»ˆè°ƒç”¨çš„éƒ½æ˜¯ <code>finalizeNavigation()</code> è€Œ
 è¿™é‡Œé¢ä¸»è¦æœ‰ä¸¤ä¸ªå…³é”®åœ°æ–¹ï¼Œä¸€æ˜¯ <code>routerHistory.push/replace</code>, äºŒæ˜¯æ›´æ–°äº†
 <code>currentRoute.value</code> è€Œæ­£æ˜¯è¿™ä¸ªæ›´æ–°ä¼šè§¦å‘ <code>&lt;router-view/&gt;</code> ç»„ä»¶çš„æ›´æ–°ã€‚go æ˜¯ç›´æ¥ä½¿ç”¨äº† <code>routerHistory.go(delta)</code> æ¥å£</p>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯ push/replace è¿˜æ˜¯ go æœ€åéƒ½æ˜¯ä½¿ç”¨äº† history çš„ api ã€‚</p>
</blockquote>
<p>
 è·¯ç”±æ’ä»¶çš„å®‰è£…å‡½æ•° <code>install(app/* vue app */)</code>, è¿™é‡Œéœ€è¦æ³¨æ„å®ƒåšäº†å‡ ä»¶äº‹æƒ…ï¼š</p>
<table>
<tbody>
<tr>
<td>æ³¨å†Œ <code>RouterLink</code>, <code>RouterView</code> ä¸¤ä¸ª vue ç»„ä»¶</td>
</tr>
<tr>
<td>å®šä¹‰äº†å…¨å±€å±æ€§ <code>$route</code> æŒ‡å‘ <code>currentRoute</code></td>
</tr>
<tr>
<td>provide routerKey -&gt; router å½“å‰ router å®ä¾‹</td>
</tr>
<tr>
<td>provide routeLocationKey -&gt; reactiveRoute location ç›¸å…³ä¿¡æ¯</td>
</tr>
<tr>
<td>provide routerViewLocationKey -&gt; currentRoute å½“å‰è·¯ç”±è®°å½•</td>
</tr>
<tr>
<td>é‡å†™ vue ç»„ä»¶çš„ unmount å‡½æ•°ï¼Œæ‰§è¡Œè·¯ç”±çš„æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚ï¼šç§»é™¤äº‹ä»¶ç›‘å¬ï¼Œé‡ç½®è·¯ç”±å±æ€§ç­‰</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li>
<p><code>&lt;router-view/&gt;</code> ç»„ä»¶çš„å®ç°åŸç†ï¼Œé€šè¿‡ <code>&lt;router-link to/&gt;</code> æˆ–
<code>router.push/replace/go</code> api è§¦å‘è·¯ç”±è·³è½¬åŠ¨ä½œå®ç°</p>
</li>
<li>
<p>history çš„å®ç°åŸç†(ç»“åˆ Ref + history hash/H5api)ï¼Œè¿™ä¸ªå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„</p>
</li>
</ol>
<p>
vue-router ç®€è¦å›¾ï¼š</p>
<p>
<img src="/img/vue3/vue-router/vue-router-next.svg" alt="/img/vue3/vue-router/vue-router-next.svg" title="/img/vue3/vue-router/vue-router-next.svg" /></p>
</div>
</div>
<div id="outline-container-flow" class="outline-2">
<h2 id="flow">
<span class="todo">TODO</span>
å®ˆå«å‡½æ•°å®Œæ•´æ‰§è¡Œæµç¨‹
</h2>
<div id="outline-text-flow" class="outline-text-2">
<p>
<img src="/img/vue3/vue-router/vue-router-next-parse-flow.svg" alt="/img/vue3/vue-router/vue-router-next-parse-flow.svg" title="/img/vue3/vue-router/vue-router-next-parse-flow.svg" /></p>
</div>
</div>
<div id="outline-container-h5-history" class="outline-2">
<h2 id="h5-history">
HTML5 history api
</h2>
<div id="outline-text-h5-history" class="outline-text-2">
<table>
<thead>
<tr>
<th>api</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pushState(state, title, url)</code></td>
<td>å‘å†å²è®°å½•ä¸­å¢åŠ ä¸€æ¡è®°å½•</td>
</tr>
<tr>
<td><code>replaceState(state, title, url)</code></td>
<td>æ›¿æ¢å½“å‰è®°å½•ï¼Œä¸æ–°å¢è®°å½•</td>
</tr>
<tr>
<td><code>back()</code></td>
<td>è¿”å›ä¸Šä¸€æ¡è®°å½•ï¼Œç­‰ä»·äº <code>go(-1)</code></td>
</tr>
<tr>
<td><code>go(n)</code></td>
<td>è·³è½¬åˆ°ç¬¬ n æ¡è®°å½•</td>
</tr>
<tr>
<td><code>forward()</code></td>
<td>ç­‰ä»·äº <code>go(1)</code></td>
</tr>
<tr>
<td><code>onpopstate</code></td>
<td>äº‹ä»¶ï¼Œå½“ä¸”æ‰§è¡Œ <code>history.back()</code> æˆ– <code>history.forward()</code> æˆ– <code>history.go(n)</code> çš„æ—¶å€™è§¦å‘</td>
</tr>
<tr>
<td><code>state</code></td>
<td>è®°å½•å½“å‰é¡µé¢çš„çŠ¶æ€ä¿¡æ¯ï¼Œåœ¨æ‰§è¡Œ pushState æˆ– replaceState ä¹‹å‰ä¸º null ï¼Œä¹‹åä¸ºç¬¬ä¸€ä¸ªä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ <code>onpopstate</code> å›è°ƒä¸­é€šè¿‡ <code>event.state</code> å–åˆ°è¯¥ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h1> changeLocation() æµ‹è¯•ã€‚ã€‚ã€‚ï¼Œ</h1>
<b>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®ï¼Œæ³¨æ„è§‚å¯Ÿ location å˜åŒ–å’Œ history.length é•¿åº¦å˜åŒ–ï¼</b>
<div class="c9OCH7YQX9g">
<button class="pushq">push ?q=1</button>
<button class="pushp">push ?p=2</button>
<button class="replace">replace ?r=3</button>
<button class="clear">clear</button>
<button class="forward">forward</button>
<button class="go">éšæœºè·³è½¬</button>
<button class="back">back</button>
<div class="debug"></div>
</div>
<script src="/js/vue/router/c9OCH7YQX9g.js"></script>
<hr>
<blockquote>
<p>é’ˆå¯¹ <code>onpopstate</code> åªæœ‰åœ¨æ‰§è¡Œå®é™…è·³è½¬åŠ¨ä½œçš„æ—¶å€™æ‰ä¼šè§¦å‘ï¼Œä»€ä¹ˆæ˜¯å®é™…è·³è½¬åŠ¨ä½œï¼Ÿ</p>
<p>
æ¯”å¦‚ï¼šæµè§ˆå™¨çš„åå°å‰è¿›æŒ‰é’®ï¼Œæˆ–è€…ç›´æ¥æ‰‹åŠ¨è°ƒç”¨ <code>history.back()</code>, <code>history.go(n)</code>,
<code>history.forward()</code> æ–¹æ³•è§¦å‘ã€‚</p>
</blockquote>
<p>
<span style="text-decoration: underline;">ç„¶å vue-router ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨ history å®ç°è·¯ç”±åŠŸèƒ½çš„ï¼Ÿ</span></p>
</div>
</div>
<div id="outline-container-web-history" class="outline-2">
<h2 id="web-history">
createWebHistory
</h2>
<div id="outline-text-web-history" class="outline-text-2">
<p>
H5 çš„ history api å°è£…ï¼Œè¿”å›çš„ç»“æ„ï¼š <code>RouterHistory</code> åŒ…å«ä»¥ä¸‹æˆå‘˜</p>
<table>
<thead>
<tr>
<th>æˆå‘˜å</th>
<th>æè¿°</th>
<th>-</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>base</code></td>
<td>ç«™åŸºåœ°å€ï¼Œä¼šæ·»åŠ åˆ°æ¯ä¸ª url å‰é¢</td>
<td>å¦‚ï¼š a.com/sub é‚£ä¹ˆ base æ˜¯ /sub</td>
</tr>
<tr>
<td><code>loation</code></td>
<td>å½“å‰ history location</td>
<td>éåŸç”Ÿçš„ location, å°è£…ä¹‹åçš„ï¼š <code>{value: location}</code></td>
</tr>
<tr>
<td><code>state</code></td>
<td>å½“å‰çš„ history state</td>
<td>éåŸç”Ÿ history state ï¼Œåˆå§‹å€¼æ˜¯è¿™ä¸ªï¼Œä½†åç»­çš„å€¼éœ€è¦å‡½æ•°æ‰‹åŠ¨ç®¡ç†</td>
</tr>
<tr>
<td><code>push(to,data?)</code></td>
<td>å¯¹åº” pushState æ“ä½œ</td>
<td>ä¸ä¼šè§¦å‘ popstate</td>
</tr>
<tr>
<td><code>replace(to,data?)</code></td>
<td>å¯¹åº” replaceState æ“ä½œ</td>
<td>ä¸ä¼šè§¦å‘ popstate</td>
</tr>
<tr>
<td><code>go(delta, triggerListeners?)</code></td>
<td>è°ƒç”¨ <code>history.go(delta)</code></td>
<td>ä¼šè§¦å‘ popstate äº‹ä»¶</td>
</tr>
<tr>
<td><code>listen(callback)</code></td>
<td>ç”¨æˆ·è°ƒç”¨æ·»åŠ çš„ç›‘å¬å‡½æ•°</td>
<td>popstate è§¦å‘æœŸé—´æ‰§è¡Œ</td>
</tr>
<tr>
<td><code>createHref(location)</code></td>
<td>æ„å»º href åœ°å€</td>
<td>-</td>
</tr>
<tr>
<td><code>destory()</code></td>
<td>æ³¨é”€ listen() æ³¨å†Œçš„äº‹ä»¶</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Router ä¸­çš„ <code>back()</code> å’Œ <code>forward()</code> åˆ†åˆ«æ˜¯è°ƒç”¨è¿™é‡Œçš„ <code>go(-1)</code> å’Œ <code>go(1)</code> å®ç°ã€‚</p>
</blockquote>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">base?</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">RouterHistory</span> <span class="p">{</span>
  <span class="nx">base</span> <span class="o">=</span> <span class="nx">normalizeBase</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">historyNavigation</span> <span class="o">=</span> <span class="nx">useHistoryStateNavigation</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">historyListeners</span> <span class="o">=</span> <span class="nx">useHistoryListeners</span><span class="p">(</span>
    <span class="nx">base</span><span class="p">,</span>
    <span class="nx">historyNavigation</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span>
    <span class="nx">historyNavigation</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
    <span class="nx">historyNavigation</span><span class="p">.</span><span class="nx">replace</span>
  <span class="p">)</span>
  <span class="kd">function</span> <span class="nx">go</span><span class="p">(</span><span class="nx">delta</span>: <span class="kt">number</span><span class="p">,</span> <span class="nx">triggerListeners</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">triggerListeners</span><span class="p">)</span> <span class="nx">historyListeners</span><span class="p">.</span><span class="nx">pauseListeners</span><span class="p">()</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="nx">delta</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">routerHistory</span>: <span class="kt">RouterHistory</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="c1">// it&#39;s overridden right after
</span><span class="c1"></span>      <span class="nx">location</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="nx">base</span><span class="p">,</span>
      <span class="nx">go</span><span class="p">,</span>
      <span class="nx">createHref</span>: <span class="kt">createHref.bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">base</span><span class="p">),</span>
    <span class="p">},</span>

    <span class="nx">historyNavigation</span><span class="p">,</span>
    <span class="nx">historyListeners</span>
  <span class="p">)</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">routerHistory</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">historyNavigation</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
  <span class="p">})</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">routerHistory</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">historyNavigation</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">routerHistory</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p><code>base = normalizeBase(base)</code></p>
<p>
è§£æç½‘ç«™åŸºè·¯å¾„</p>
<p>
<code>!base</code></p>
<p>
? æ— è‡ªå®šä¹‰åœ°å€é¦–å…ˆå– <code>&lt;base href=&#34;http://ip:port/path/to&#34; /&gt;</code> çš„ hrefï¼Œ
å–å‡º <code>/path/to</code> éƒ¨åˆ†ä½œä¸º base</p>
<p>
\: æœ‰è‡ªå®šä¹‰çš„æ—¶å€™ï¼ŒåŠ ä¸Šå¼€å¤´ <code>/</code> å’Œå»æ‰å°¾éƒ¨ <code>/</code> ï¼Œå¦‚ï¼š <code>path/to</code> å˜æˆ
<code>/path/to</code> , æˆ– <code>/path/to/</code> å˜æˆ <code>/path/to</code></p>
</li>
<li>
<p><code>const historyNavigation = useHistoryStateNavigation(base)</code></p>
<p>
å°† <code>window.location</code> å’Œ <code>window.history</code> è¿›è¡Œå°è£…ï¼Œè¿”å›</p>
<p>
<code>{location, state, push, replace}</code> å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œé‡ç‚¹å°±æ˜¯è¿™ä¸ªå‡½æ•°ã€‚</p>
</li>
<li>
<p><code>const historyListeners = useHistoryListeners(...)</code></p>
<p>
history å˜æ›´ç›‘å¬å™¨ã€‚</p>
</li>
<li>
<p><code>go(delta, triggerListeners)</code> å‡½æ•°</p>
<p>
åœ¨è°ƒç”¨ <code>history.go(delta)</code> ä¹‹å‰æ£€æµ‹æ˜¯å¦æš‚åœ history listeners</p>
</li>
<li>
<p>ç»„è£… <code>routerHistory</code></p>
<p>
åˆå¹¶ <code>{ location: &#39;&#39;, base, go, createHref }</code> å’Œ historyNavigation, historyListeners</p>
</li>
<li>
<p>åœ¨ routerHistory ä¸Šå®šä¹‰ä¸¤ä¸ª getter å±æ€§ <code>location</code> &amp; <code>state</code></p>
</li>
<li>
<p>è¿”å› routerHistory è¿™ä¸ªå°†æ¥ä¼šè¢« <code>createRouter({ history })</code> ç”¨åˆ°</p>
</li>
</ol>
<script>
insertFrame('', '2.js', '/js/vue/router/')
</script>
<div id="outline-container-use-h5-history" class="outline-3">
<h3 id="use-h5-history">
useHistoryStateNavigation(base: string)
</h3>
<div id="outline-text-use-h5-history" class="outline-text-3">
<p>
è§£æ„ window.history, window.location ç»„è£… <code>{location, state, push, replace}</code> ç»“
æ„è¿”å›ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">useHistoryStateNavigation</span><span class="p">(</span><span class="nx">base</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">history</span><span class="p">,</span> <span class="nx">location</span> <span class="p">}</span> <span class="o">=</span> <span class="nb">window</span><span class="p">;</span>

  <span class="c1">// private variables
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">currentLocation</span>: <span class="kt">ValueContainer</span><span class="p">&lt;</span><span class="nt">HistoryLocation</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">value</span>: <span class="kt">createCurrentLocation</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">location</span><span class="p">),</span>
  <span class="p">};</span>
  <span class="kd">let</span> <span class="nx">historyState</span>: <span class="kt">ValueContainer</span><span class="p">&lt;</span><span class="nt">StateEntry</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">value</span>: <span class="kt">history.state</span> <span class="p">};</span>
  <span class="c1">// build current history entry as this is a fresh navigation
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">historyState</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">changeLocation</span><span class="p">(</span>
      <span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="nx">back</span>: <span class="kt">null</span><span class="p">,</span>
        <span class="nx">current</span>: <span class="kt">currentLocation.value</span><span class="p">,</span>
        <span class="nx">forward</span>: <span class="kt">null</span><span class="p">,</span>
        <span class="c1">// the length is off by one, we need to decrease it
</span><span class="c1"></span>        <span class="nx">position</span>: <span class="kt">history.length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">replaced</span>: <span class="kt">true</span><span class="p">,</span>
        <span class="c1">// don&#39;t add a scroll as the user may have an anchor and we want
</span><span class="c1"></span>        <span class="c1">// scrollBehavior to be triggered without a saved position
</span><span class="c1"></span>        <span class="nx">scroll</span>: <span class="kt">null</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="kc">true</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">changeLocation</span><span class="p">(</span>
    <span class="nx">to</span>: <span class="kt">HistoryLocation</span><span class="p">,</span>
    <span class="nx">state</span>: <span class="kt">StateEntry</span><span class="p">,</span>
    <span class="nx">replace</span>: <span class="kt">boolean</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">to</span>: <span class="kt">HistoryLocation</span><span class="p">,</span> <span class="nx">data?</span>: <span class="kt">HistoryState</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">push</span><span class="p">(</span><span class="nx">to</span>: <span class="kt">HistoryLocation</span><span class="p">,</span> <span class="nx">data?</span>: <span class="kt">HistoryState</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">location</span>: <span class="kt">currentLocation</span><span class="p">,</span>
    <span class="nx">state</span>: <span class="kt">historyState</span><span class="p">,</span>

    <span class="nx">push</span><span class="p">,</span>
    <span class="nx">replace</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>è§£æ location { pathname, search, hash } è¿”å›ä¸å¸¦åŸŸåçš„çš„ path</p>
<p>
å¦‚ï¼š</p>
<p>
<code>http://ip:port/ui/#/a/b/?limit=10&amp;page=1</code> -&gt; base: <code>/ui/#</code> -&gt; <code>/a/b</code></p>
<p>
<code>http://ip:port/ui/a/b/?limit=10&amp;page=1</code> -&gt; base: <code>/ui</code> -&gt; <code>/a/b</code></p>
<p>
<code>http://ip:port/a/ui/b/?limit=10&amp;page=1</code> -&gt; base: <code>/ui</code> -&gt; <code>/a/ui/b</code></p>
<p>
ç»“æ„ï¼š <code>{value: url}</code></p>
</li>
<li>
<p><code>historyState = { value: history.state }</code></p>
<p>
å¦‚æœ <code>historyState.value</code> ä¸ºç©ºï¼Œéœ€è¦è¿›è¡Œåˆå§‹åŒ– -&gt; <code>changeLocation()</code></p>
</li>
<li>
<p><code>changeLocation(to, state, replace)</code> å‡½æ•°</p>
</li>
<li>
<p><code>replace(to, data?)</code> å‡½æ•°</p>
</li>
<li>
<p><code>push(to, data?)</code> å‡½æ•°</p>
</li>
<li>
<p>æœ€åè¿”å›ç»“æ„ <code>{location: currentLocation, state: historyState, push, replace}</code></p>
</li>
</ol>
<div id="outline-container-headline-6" class="outline-4">
<h4 id="headline-6">
createCurrentLocation(base: string,location: Location)
</h4>
<div id="outline-text-headline-6" class="outline-text-4">
<p>
å¯¹ <code>location { pathname, search, hash }</code> åŠ å·¥è¿”å›æ–°çš„ url</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createCurrentLocation</span><span class="p">(</span>
  <span class="nx">base</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">location</span>: <span class="kt">Location</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">HistoryLocation</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">pathname</span><span class="p">,</span> <span class="nx">search</span><span class="p">,</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">location</span>
  <span class="c1">// allows hash based url
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">hashPos</span> <span class="o">=</span> <span class="nx">base</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hashPos</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// prepend the starting slash to hash so the url starts with /#
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">pathFromHash</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pathFromHash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="nx">pathFromHash</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">pathFromHash</span>
    <span class="k">return</span> <span class="nx">stripBase</span><span class="p">(</span><span class="nx">pathFromHash</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">stripBase</span><span class="p">(</span><span class="nx">pathname</span><span class="p">,</span> <span class="nx">base</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">path</span> <span class="o">+</span> <span class="nx">search</span> <span class="o">+</span> <span class="nx">hash</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å‡½æ•°ä½œç”¨ï¼š base ä¸­å«æœ‰ <code>#</code> æ—¶ï¼Œç›´æ¥ä» location.hash ä¸­è§£æå‡º pathã€‚</p>
<p>
æ¯”å¦‚ï¼š</p>
<p>
<code>base=/ui/#/</code></p>
<p>
<code>url=https://ip:port/ui/#/base/industry/grouping?limit=10&amp;page=1&amp;tradeId=19&amp;times=1614652347338</code></p>
<p>
æœ€åè§£æå‡ºæ¥çš„</p>
<p>
<code>path=/base/industry/grouping?limit=10&amp;page=1&amp;tradeId=19&amp;times=1614652347338</code></p>
<p>
å¦‚æœ base ä¸å« <code>#</code> ç›´æ¥å–å‡º path ä¸­å»æ‰ base éƒ¨åˆ†çš„ urlï¼Œå¦‚ï¼š</p>
<p>
<code>base=/ui/</code> -&gt; <code>url=http://ip:port/ui/path/to...</code> å¾—åˆ° <code>/path/to</code></p>
<p>
å¦‚æœ base åœ¨ url pathname çš„ä¸­é—´ï¼Œç›´æ¥è¿”å› pathname å› ä¸ºè¿™ç§æƒ…å†µé base æƒ…å†µ
<code>http://ip:port/path/ui/to</code> ç›´æ¥è¿”å› <code>/path/ui/to</code></p>
</div>
</div>
<div id="outline-container-headline-7" class="outline-4">
<h4 id="headline-7">
changeLocation(to,state,replace)
</h4>
<div id="outline-text-headline-7" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">changeLocation</span><span class="p">(</span>
  <span class="nx">to</span>: <span class="kt">HistoryLocation</span><span class="p">,</span>
  <span class="nx">state</span>: <span class="kt">StateEntry</span><span class="p">,</span>
  <span class="nx">replace</span>: <span class="kt">boolean</span>
<span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="c1">//
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">hashIndex</span> <span class="o">=</span> <span class="nx">base</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;#&#34;</span><span class="p">);</span>
  <span class="c1">// to:list -&gt; /base/#/ui/ -&gt; /ui/list
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span>
    <span class="nx">hashIndex</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
      <span class="o">?</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;base&#34;</span><span class="p">)</span>
          <span class="o">?</span> <span class="nx">base</span>
          : <span class="kt">base.slice</span><span class="p">(</span><span class="nx">hashIndex</span><span class="p">))</span> <span class="o">+</span> <span class="nx">to</span>
  <span class="c1">// http://ip:port + base + to
</span><span class="c1"></span>      <span class="o">:</span> <span class="nx">createBaseLocation</span><span class="p">()</span> <span class="o">+</span> <span class="nx">base</span> <span class="o">+</span> <span class="nx">to</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// BROWSER QUIRK
</span><span class="c1"></span>    <span class="c1">// NOTE: Safari throws a SecurityError when calling this function 100 times in 30 seconds
</span><span class="c1"></span>    <span class="nx">history</span><span class="p">[</span><span class="nx">replace</span> <span class="o">?</span> <span class="s2">&#34;replaceState&#34;</span> <span class="o">:</span> <span class="s2">&#34;pushState&#34;</span><span class="p">](</span><span class="nx">state</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
    <span class="nx">historyState</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="s2">&#34;Error with push/replace State&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Force the navigation, this also resets the call count
</span><span class="c1"></span>    <span class="nx">location</span><span class="p">[</span><span class="nx">replace</span> <span class="o">?</span> <span class="s2">&#34;replace&#34;</span> <span class="o">:</span> <span class="s2">&#34;assign&#34;</span><span class="p">](</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å»æ‰ base hash éƒ¨åˆ†å°† <code>to</code> è·¯ç”±ç»„åˆæˆ url è°ƒç”¨ <code>history.replace|pushState(state,
title, url)</code> æ”¹å˜
urlï¼ŒåŒæ—¶ä¿®æ”¹ historyState.value å€¼ã€‚</p>
</div>
</div>
<div id="outline-container-headline-8" class="outline-4">
<h4 id="headline-8">
replace(to, data?)
</h4>
<div id="outline-text-headline-8" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">to</span>: <span class="kt">HistoryLocation</span><span class="p">,</span> <span class="nx">data?</span>: <span class="kt">HistoryState</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span>: <span class="kt">StateEntry</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span>
    <span class="nx">buildState</span><span class="p">(</span>
      <span class="nx">historyState</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">back</span><span class="p">,</span>
      <span class="c1">// keep back and forward entries but override current position
</span><span class="c1"></span>      <span class="nx">to</span><span class="p">,</span>
      <span class="nx">historyState</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">forward</span><span class="p">,</span>
      <span class="kc">true</span>
    <span class="p">),</span>
    <span class="nx">data</span><span class="p">,</span>
    <span class="c1">// æ›¿æ¢æ“ä½œï¼Œä½¿ç”¨è€çš„ position æ›¿ä»£æ–°çš„
</span><span class="c1"></span>    <span class="c1">// è¿™ä¸ªä¼šåœ¨ changeLocation ä¸­ç”¨æ¥è®¡ç®— delta åç§»é‡
</span><span class="c1"></span>    <span class="p">{</span> <span class="nx">position</span>: <span class="kt">historyState.value.position</span> <span class="p">}</span>
  <span class="p">);</span>

  <span class="c1">// æ‰§è¡Œ replaceState
</span><span class="c1"></span>  <span class="c1">// å– old historyState ç„¶åè®¾ç½® new historyState
</span><span class="c1"></span>  <span class="nx">changeLocation</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
push(to, data?)
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">push</span><span class="p">(</span><span class="nx">to</span>: <span class="kt">HistoryLocation</span><span class="p">,</span> <span class="nx">data?</span>: <span class="kt">HistoryState</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Add to current entry the information of where we are going
</span><span class="c1"></span>  <span class="c1">// as well as saving the current position
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">currentState</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="c1">// use current history state to gracefully handle a wrong call to
</span><span class="c1"></span>    <span class="c1">// history.replaceState
</span><span class="c1"></span>    <span class="c1">// https://github.com/vuejs/vue-router-next/issues/366
</span><span class="c1"></span>    <span class="nx">historyState</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">state</span> <span class="kr">as</span> <span class="nx">Partial</span><span class="p">&lt;</span><span class="nt">StateEntry</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="nx">forward</span>: <span class="kt">to</span><span class="p">,</span>
      <span class="nx">scroll</span>: <span class="kt">computeScrollPosition</span><span class="p">(),</span>
    <span class="p">}</span>
  <span class="p">);</span>

  <span class="c1">// ...
</span><span class="c1"></span>
  <span class="c1">// æ‰§è¡Œ pushState, è®°å½• old/new historyState
</span><span class="c1"></span>  <span class="nx">changeLocation</span><span class="p">(</span><span class="nx">currentState</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">currentState</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">state</span>: <span class="kt">StateEntry</span> <span class="o">=</span> <span class="nx">assign</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="nx">buildState</span><span class="p">(</span><span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="kc">null</span><span class="p">),</span>
    <span class="p">{</span> <span class="nx">position</span>: <span class="kt">currentState.position</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">},</span>
    <span class="nx">data</span>
  <span class="p">);</span>

  <span class="nx">changeLocation</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-10" class="outline-3">
<h3 id="headline-10">
useHistoryListeners()
</h3>
<div id="outline-text-headline-10" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">useHistoryListeners</span><span class="p">(</span>
  <span class="nx">base</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">historyState</span>: <span class="kt">ValueContainer</span><span class="p">&lt;</span><span class="nt">StateEntry</span><span class="p">&gt;,</span>
  <span class="nx">currentLocation</span>: <span class="kt">ValueContainer</span><span class="p">&lt;</span><span class="nt">HistoryLocation</span><span class="p">&gt;,</span>
  <span class="nx">replace</span>: <span class="kt">RouterHistory</span><span class="p">[</span><span class="s2">&#34;replace&#34;</span><span class="p">]</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 1. popstate äº‹ä»¶å¤„ç†å¥æŸ„
</span><span class="c1"></span>  <span class="c1">// 2. pause listeners
</span><span class="c1"></span>  <span class="c1">// 3. listen(callback)
</span><span class="c1"></span>  <span class="c1">// 4. beforeUnloadListener()
</span><span class="c1"></span>  <span class="c1">// 5. destory()
</span><span class="c1"></span>  <span class="c1">// 6. add event listenner: popstate + beforeunload
</span><span class="c1"></span>  <span class="c1">// setup the listeners and prepare teardown callbacks
</span><span class="c1"></span>  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;popstate&#34;</span><span class="p">,</span> <span class="nx">popStateHandler</span><span class="p">);</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;beforeunload&#34;</span><span class="p">,</span> <span class="nx">beforeUnloadListener</span><span class="p">);</span>

  <span class="c1">// 7. return { pauseListeners, listn, destory }
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
popStateHandler({ state })
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<p>
å› ä¸º history.state ä¿å­˜äº†æ‰§è¡Œè·³è½¬æ˜¯ pushState/replaceState ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å€¼ï¼Œ
æ‰€ä»¥å¯ä»¥é€šè¿‡  to/from ä¸Šçš„ state è¿›è¡Œå¯¹æ¯”å¾—åˆ°è·³è½¬çš„æ–¹å‘æ˜¯ forward è¿˜æ˜¯ backã€‚</p>
<p>
ä½†æ˜¯ history.state æ˜¯å®æ—¶çš„ï¼Œæ‰§è¡Œå®Œ push/replace å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œè¿™é‡Œæ€ä¹ˆå¤„ç†è¿™ä¸ª
é—®é¢˜å‘¢ï¼Œèƒ½è®© to&amp;from çŠ¶æ€å¾—ä»¥ä¿å­˜ï¼Ÿ</p>
<blockquote>
<p>ç­”. å› ä¸ºä½¿ç”¨ historyState = { value: history.state } åšäº†ä¸ªä¸­ä»‹ï¼Œ
è™½ç„¶ history.state å®æ—¶å˜åŒ–ï¼Œä½†æ˜¯è¿™ä¸ª historyState æ˜¯ä¸ä¼šçš„ï¼Œæ‰‹åŠ¨ç”¨å®ƒæ¥ç®¡ç† to &amp;
from çš„å‰åçŠ¶æ€ã€‚</p>
</blockquote>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">popStateHandler</span>: <span class="kt">PopStateListener</span> <span class="o">=</span> <span class="p">({</span>
    <span class="nx">state</span><span class="p">,</span>
  <span class="p">}</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">state</span>: <span class="kt">StateEntry</span> <span class="o">|</span> <span class="kc">null</span>
  <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">createCurrentLocation</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">location</span><span class="p">)</span>
    <span class="kr">const</span> <span class="kr">from</span><span class="o">:</span> <span class="nx">HistoryLocation</span> <span class="o">=</span> <span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span>
    <span class="c1">// è¿™é‡Œæ‹¿åˆ°çš„æ˜¯è·³è½¬ä¹‹å‰çš„ state
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">fromState</span>: <span class="kt">StateEntry</span> <span class="o">=</span> <span class="nx">historyState</span><span class="p">.</span><span class="nx">value</span>
    <span class="kd">let</span> <span class="nx">delta</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">to</span>
      <span class="c1">// è¿™é‡Œ state æ˜¯æ‰§è¡Œè·¯ç”±è·³è½¬ä¹‹åè§¦å‘äº† popstate äº‹ä»¶
</span><span class="c1"></span>      <span class="c1">// å»å¾—åˆ°çš„æœ€æ–°çŠ¶æ€ï¼Œå¯¹åº” to æ›´æ–°è€çŠ¶æ€å€¼
</span><span class="c1"></span>      <span class="nx">historyState</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">state</span>

      <span class="c1">// ignore the popstate and reset the pauseState
</span><span class="c1"></span>      <span class="c1">// æš‚åœï¼Ÿå¿½ç•¥äº‹ä»¶é‡ç½® pauseState ?
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">pauseState</span> <span class="o">&amp;&amp;</span> <span class="nx">pauseState</span> <span class="o">===</span> <span class="kr">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pauseState</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="c1">// æ ¹æ® to &amp; from state è®¡ç®—å‡ºè¦æ‰§è¡Œè·³è½¬çš„æ–¹å‘æˆ–åç§»
</span><span class="c1"></span>      <span class="nx">delta</span> <span class="o">=</span> <span class="nx">fromState</span> <span class="o">?</span> <span class="nx">state</span><span class="p">.</span><span class="nx">position</span> <span class="o">-</span> <span class="nx">fromState.position</span> : <span class="kt">0</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// æ²¡æœ‰æ–°çŠ¶æ€ï¼Œç›´æ¥æ›¿æ¢å†å²è®°å½•
</span><span class="c1"></span>      <span class="nx">replace</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// console.log({ deltaFromCurrent })
</span><span class="c1"></span>    <span class="c1">// Here we could also revert the navigation by calling history.go(-delta)
</span><span class="c1"></span>    <span class="c1">// this listener will have to be adapted to not trigger again and to wait for the url
</span><span class="c1"></span>    <span class="c1">// to be updated before triggering the listeners. Some kind of validation function would also
</span><span class="c1"></span>    <span class="c1">// need to be passed to the listeners so the navigation can be accepted
</span><span class="c1"></span>    <span class="c1">// call all listeners
</span><span class="c1"></span>    <span class="nx">listeners</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">listener</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">listener</span><span class="p">(</span><span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">delta</span><span class="p">,</span>
        <span class="kr">type</span><span class="o">:</span> <span class="nx">NavigationType</span><span class="p">.</span><span class="nx">pop</span><span class="p">,</span>
        <span class="nx">direction</span>: <span class="kt">delta</span>
          <span class="o">?</span> <span class="nx">delta</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="o">?</span> <span class="nx">NavigationDirection.forward</span>
            : <span class="kt">NavigationDirection.back</span>
          <span class="o">:</span> <span class="nx">NavigationDirection</span><span class="p">.</span><span class="kt">unknown</span><span class="p">,</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
pauseListeners()
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">pauseListeners() {</span>
  <span class="nx">pauseState</span> <span class="o">=</span> <span class="nx">currentLocation</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-4">
<h4 id="headline-13">
listen(callback)
</h4>
<div id="outline-text-headline-13" class="outline-text-4">
<p>
çº¯ç²¹çš„ add æ“ä½œï¼Œæ›´æ–° <code>listeners[]</code> å’Œå¯¹åº”çš„ç§»é™¤å‡½æ•°åˆ—è¡¨ <code>teardowns[]</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// æ·»åŠ ç›‘å¬å‡½æ•°ï¼Œè¿”å›å¯¹åº”çš„ teardown å‡½æ•°
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">listen</span><span class="p">(</span><span class="nx">callback</span>: <span class="kt">NavigationCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// setup the listener and prepare teardown callbacks
</span><span class="c1"></span>    <span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">teardown</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">teardowns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">teardown</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">teardown</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-14" class="outline-4">
<h4 id="headline-14">
beforeUnloadListener()
</h4>
<div id="outline-text-headline-14" class="outline-text-4">
<p>
æ•´ä¸ªé¡µé¢æ‰§è¡Œå¸è½½ä¹‹å‰çš„äº‹ä»¶ï¼Œå‘ç”Ÿåœ¨ <code>unload</code> ä¹‹å‰ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">beforeUnloadListener() {</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">history</span> <span class="p">}</span> <span class="o">=</span> <span class="nb">window</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">history</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="k">return</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">(</span>
      <span class="nx">assign</span><span class="p">({},</span> <span class="nx">history</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span> <span class="nx">scroll</span>: <span class="kt">computeScrollPosition</span><span class="p">()</span> <span class="p">}),</span>
      <span class="s1">&#39;&#39;</span>
    <span class="p">)</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-15" class="outline-4">
<h4 id="headline-15">
destroy() æ³¨é”€äº‹ä»¶
</h4>
<div id="outline-text-headline-15" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">destroy() {</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">teardown</span> <span class="k">of</span> <span class="nx">teardowns</span><span class="p">)</span> <span class="nx">teardown</span><span class="p">();</span>
  <span class="nx">teardowns</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&#34;popstate&#34;</span><span class="p">,</span> <span class="nx">popStateHandler</span><span class="p">);</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&#34;beforeunload&#34;</span><span class="p">,</span> <span class="nx">beforeUnloadListener</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-web-hash" class="outline-2">
<h2 id="web-hash">
createWebHashHistory
</h2>
<div id="outline-text-web-hash" class="outline-text-2">
<p>
<span style="text-decoration: underline;">/vue-router-next/src/history/hash.ts</span></p>
<p>
ä»æºç å¯ä»¥çœ‹å‡ºï¼Œè¯¥å‡½æ•°æ˜¯åŸºäº <code>createWebHistory(base)</code> å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä¹Ÿæ˜¯åŸº
äº history api å®Œæˆï¼Œåªä¸è¿‡åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå¯¹ hash å€¼è¿›è¡Œäº†æƒ…å†µåˆ†æå’Œæ£€æµ‹ï¼Œåšäº†è¿›ä¸€
æ­¥ä¼˜åŒ–å¤„ç†ã€‚</p>
<blockquote>
<p>å‚æ•° baseï¼Œå¯ä»¥å‡½æ•°è°ƒç”¨æ—¶æä¾›ï¼Œå¦‚æœå­˜åœ¨ <code>&lt;base href/&gt;</code> æ ‡ç­¾ä¼šä¼˜å…ˆå–è¿™ä¸ªæ ‡ç­¾çš„
href å€¼è§£æå‡º base å€¼ã€‚</p>
</blockquote>
<p>
å¦‚ï¼Œå‡½æ•°æ³¨é‡Šï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½æƒ…å†µ(å¦‚ï¼š <code>base=https://example.com/folder</code>)</p>
<ol>
<li>
<p><code>createWebHashHistory()</code> æ— å‚æ•°</p>
<p>
ç»“æœï¼š <a href="https://example.com/folder#">https://example.com/folder#</a></p>
</li>
<li>
<p><code>createWebHashHistory(&#39;/folder/&#39;)</code></p>
<p>
åŒ¹é… <code>/folder</code> æˆåŠŸï¼Œç»“æœï¼š <a href="https://example.com/folder/#">https://example.com/folder/#</a></p>
</li>
<li>
<p><code>createWebHashHistory(&#39;/folder/#/app&#39;)</code></p>
<p>
ä¸­é—´æœ‰ <code>#</code> ç¬¦å·çš„ï¼š</p>
<p>
åŒ¹é… <code>/folder</code> æˆåŠŸï¼Œç»“æœï¼š <a href="https://example.com/folder/#/app">https://example.com/folder/#/app</a></p>
</li>
<li>
<p><del>createWebHashHistory(&#39;<em>other-folder</em>&#39;)</del></p>
<p>
åŒ¹é…å¤±è´¥ï¼Œä¼šç›´æ¥æ›¿æ¢ï¼Œç»“æœï¼š <a href="https://example.com/other-folder/#">https://example.com/other-folder/#</a></p>
<p>
ä¸æ¨èè¿™ç§ï¼Œå› ä¸ºå®ƒä¼šæ”¹å˜æ ¹è·¯å¾„ã€‚</p>
</li>
<li>
<p>æ— ä¸»æœºçš„åœ°å€ï¼Œæ¯”å¦‚æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼š <a href="///usr/etc/folder/index.html">///usr/etc/folder/index.html</a></p>
<p>
<code>createWebHashHistory(&#39;/iAmIgnored&#39;)</code></p>
<p>
ç»“æœï¼š <a href="///usr/etc/folder/index.html#">///usr/etc/folder/index.html#</a></p>
<p>
æä¾›çš„ base ä¼šè¢«å¿½ç•¥ã€‚</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createWebHashHistory</span><span class="p">(</span><span class="nx">base?</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">RouterHistory</span> <span class="p">{</span>
  <span class="c1">// Make sure this implementation is fine in terms of encoding, specially for IE11
</span><span class="c1"></span>  <span class="c1">// for `file://`, directly use the pathname and ignore the base
</span><span class="c1"></span>  <span class="c1">// location.pathname contains an initial `/` even at the root: `https://example.com`
</span><span class="c1"></span>  <span class="nx">base</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">?</span> <span class="nx">base</span> <span class="o">||</span> <span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">search</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
  <span class="c1">// allow the user to provide a `#` in the middle: `/base/#/app`
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">base</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">base</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">base</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;#/&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">base</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`A hash base must end with a &#34;#&#34;:</span><span class="err">\</span><span class="sb">n&#34;</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">&#34; should be &#34;</span><span class="si">${</span><span class="nx">base</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
        <span class="sr">/#.*$/</span><span class="p">,</span>
        <span class="s1">&#39;#&#39;</span>
      <span class="p">)</span><span class="si">}</span><span class="sb">&#34;.`</span>
    <span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ›´å¤šè¯·æŸ¥çœ‹ <a href="#web-history">createWebHistory</a> ã€‚</p>
</div>
</div>
<div id="outline-container-mem-his" class="outline-2">
<h2 id="mem-his">
<span class="todo">TODO</span>
createMemoryHistory
</h2>
<div id="outline-text-mem-his" class="outline-text-2">
<p>
é€šè¿‡ä¸€ä¸ªé˜Ÿåˆ—æ¥ç®¡ç†è·¯ç”±ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createMemoryHistory</span><span class="p">(</span><span class="nx">base</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">:</span> <span class="nx">RouterHistory</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">listeners</span>: <span class="kt">NavigationCallback</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="kd">let</span> <span class="nx">queue</span>: <span class="kt">HistoryLocation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">START</span><span class="p">]</span>
  <span class="kd">let</span> <span class="nx">position</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="kd">function</span> <span class="nx">setLocation</span><span class="p">(</span><span class="nx">location</span>: <span class="kt">HistoryLocation</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">position</span><span class="o">++</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">===</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// we are at the end, we can simply append a new entry
</span><span class="c1"></span>      <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">location</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// we are in the middle, we remove everything from here in the queue
</span><span class="c1"></span>      <span class="nx">queue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span>
      <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">location</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">triggerListeners</span><span class="p">(</span>
    <span class="nx">to</span>: <span class="kt">HistoryLocation</span><span class="p">,</span>
    <span class="kr">from</span><span class="o">:</span> <span class="nx">HistoryLocation</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">direction</span><span class="p">,</span> <span class="nx">delta</span> <span class="p">}</span><span class="o">:</span> <span class="nx">Pick</span><span class="p">&lt;</span><span class="nt">NavigationInformation</span><span class="err">,</span> <span class="err">&#39;</span><span class="na">direction</span><span class="err">&#39;</span> <span class="err">|</span> <span class="err">&#39;</span><span class="na">delta</span><span class="err">&#39;</span><span class="p">&gt;</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">info</span>: <span class="kt">NavigationInformation</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">direction</span><span class="p">,</span>
      <span class="nx">delta</span><span class="p">,</span>
      <span class="kr">type</span><span class="o">:</span> <span class="nx">NavigationType</span><span class="p">.</span><span class="nx">pop</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">callback</span> <span class="k">of</span> <span class="nx">listeners</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">routerHistory</span>: <span class="kt">RouterHistory</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// rewritten by Object.defineProperty
</span><span class="c1"></span>    <span class="nx">location</span>: <span class="kt">START</span><span class="p">,</span>
    <span class="nx">state</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">base</span><span class="p">,</span>
    <span class="nx">createHref</span>: <span class="kt">createHref.bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">base</span><span class="p">),</span>

    <span class="nx">replace</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// remove current entry and decrement position
</span><span class="c1"></span>      <span class="nx">queue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">position</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nx">setLocation</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
    <span class="p">},</span>

    <span class="nx">push</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">data?</span>: <span class="kt">HistoryState</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setLocation</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
    <span class="p">},</span>

    <span class="nx">listen</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">destroy() {</span>
      <span class="nx">listeners</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">},</span>

    <span class="nx">go</span><span class="p">(</span><span class="nx">delta</span><span class="p">,</span> <span class="nx">shouldTrigger</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="kr">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">location</span>
      <span class="kr">const</span> <span class="nx">direction</span>: <span class="kt">NavigationDirection</span> <span class="o">=</span>
        <span class="c1">// we are considering delta === 0 going forward, but in abstract mode
</span><span class="c1"></span>        <span class="c1">// using 0 for the delta doesn&#39;t make sense like it does in html5 where
</span><span class="c1"></span>        <span class="c1">// it reloads the page
</span><span class="c1"></span>        <span class="nx">delta</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">NavigationDirection.back</span> : <span class="kt">NavigationDirection.forward</span>
      <span class="nx">position</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">position</span> <span class="o">+</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">shouldTrigger</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">triggerListeners</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> <span class="kr">from</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">direction</span><span class="p">,</span>
          <span class="nx">delta</span><span class="p">,</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">routerHistory</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">position</span><span class="p">],</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">routerHistory</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2021-03-05
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/vue-router-next/">vue-router-next</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-vuex/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">vuex for vue3 æºç åˆ†æ(é™„.è„‘å›¾)</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/vue/vue-my-plan/">
            <span class="next-text nav-default">Vue3 å‘¨è¾¹æºç å­¦ä¹ è®¡åˆ’è¡¨</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
