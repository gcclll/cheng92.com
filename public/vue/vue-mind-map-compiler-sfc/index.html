<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 æºç å¤´è„‘é£æš´ä¹‹ 5 â˜ compiler-sfc - è‹¥å¶çŸ¥ç§‹</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-compiler-sfc/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.9d6c07951e716411e0fdd9d1d7616cb41ced57b53993154c49ea809e194527af.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 5 â˜ compiler-sfc" />
<meta property="og:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-compiler-sfc/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2020-12-19T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-12-19T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 5 â˜ compiler-sfc">
<meta itemprop="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu"><meta itemprop="datePublished" content="2020-12-19T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-12-19T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="11708">
<meta itemprop="keywords" content="vue,,vue3,,compiler-sfc," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 5 â˜ compiler-sfc"/>
<meta name="twitter:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 5 â˜ compiler-sfc</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-12-19 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 11708 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 24 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">é‡ç‚¹ã€ç‰¹æ€§ã€é—®é¢˜</a>
</li>
<li><a href="#headline-2">f21c84c init åˆå§‹åŒ–å·¥ä½œ</a>
</li>
<li><a href="#parse-func">49ee210 parse function å®ç°éƒ¨åˆ†</a>
<ul>
<li><a href="#headline-4">e32d508 parse &lt;template&gt; case</a>
</li>
<li><a href="#headline-5">3160fed parse &lt;script&gt; case</a>
</li>
<li><a href="#headline-6">aa037fe parse &lt;style&gt; case</a>
</li>
</ul>
</li>
<li><a href="#headline-7">compile &lt;template&gt;</a>
<ul>
<li><a href="#headline-8">c26e76c init compileTemplate</a>
</li>
<li><a href="#headline-9">1b2965f coding compileTemplate</a>
</li>
<li><a href="#headline-10">7b49db4 coding doCompileTemplate å‡½æ•°å®ç°</a>
</li>
<li><a href="#headline-11">2d82400 coding transformAssetUrl è½¬æ¢èµ„æº url</a>
</li>
</ul>
</li>
<li><a href="#headline-12">56358a8 compile &lt;style&gt;</a>
</li>
<li><a href="#headline-13">4d66531 compile &lt;script&gt;<sup>é‡ç‚¹</sup></a>
<ul>
<li><a href="#headline-14">init compileScript function</a>
</li>
<li><a href="#script-0">0âƒ£ d7369ae æ—  &lt;script setup&gt; æ—¶</a>
</li>
<li><a href="#headline-16">819a413 export default {} è§£æ</a>
</li>
<li><a href="#headline-17">æµ‹è¯•</a>
</li>
<li><a href="#headline-18">1âƒ£ eb650ca è§£æ &lt;script&gt;</a>
<ul>
<li><a href="#headline-19">import â€¦ from å¤„ç†</a>
</li>
<li><a href="#headline-20">export default {} å¤„ç†</a>
</li>
<li><a href="#headline-21">export â€¦ [from] å¤„ç†</a>
</li>
</ul>
</li>
<li><a href="#headline-22">2âƒ£ 8edf0d7 è§£æ &lt;script setup&gt;</a>
<ul>
<li><a href="#headline-23">d4f6497 ref: n = 100</a>
</li>
<li><a href="#headline-24">db7cb02 ref: { n = 1 } = useFoo()</a>
</li>
<li><a href="#headline-25">af26553 ref: [a] = useFoo() æ•°æ®è§£æ„</a>
</li>
<li><a href="#headline-26">a9f4469 ref: ({â€¦foo} = useFoo()) å±•å¼€ç¬¦</a>
</li>
<li><a href="#headline-27">d52a6d0 _ref(â€¦) å¢åŠ  ref å£°æ˜</a>
</li>
<li><a href="#headline-28">168041c ref: a = 1, b = 2 å¤šæ¡è¯­å¥</a>
</li>
<li><a href="#headline-29">6e337c5 imports ç½®é¡¶ğŸ”</a>
</li>
<li><a href="#headline-30">68d4940 defineProps/Emit() å¤„ç†</a>
</li>
</ul>
</li>
<li><a href="#headline-31">3âƒ£ 5160a6d ref -&gt; ref.value</a>
</li>
<li><a href="#headline-32">4âƒ£ a6f4dae extract define props/emits</a>
</li>
<li><a href="#headline-33">5âƒ£ 480acf0 checkInvalidScopeReference</a>
</li>
<li><a href="#headline-34">6âƒ£ 25662c6 åˆ é™¤é script å†…å®¹</a>
</li>
<li><a href="#headline-35">7âƒ£ deed8c1 analyze binding metadata(bindingMetadata)</a>
</li>
<li><a href="#headline-36">8âƒ£ 9cd2fd5 inject useCssVars, css å˜é‡å¤„ç†</a>
<ul>
<li><a href="#headline-37">&lt;style&gt; v-bind css å˜é‡</a>
</li>
<li><a href="#headline-38">css å˜é‡é‡å†™ï¼š</a>
</li>
<li><a href="#headline-39">isProd option ä½¿ç”¨ hash å˜é‡å</a>
</li>
</ul>
</li>
<li><a href="#headline-40">9âƒ£ eef6fd5 setup() å‚æ•°ç­¾å</a>
</li>
<li><a href="#headline-41">ğŸ”Ÿ 9cedeab ç”Ÿæˆ return è¯­å¥</a>
</li>
<li><a href="#headline-42">1âƒ£1âƒ£ cfca9de finalize default export</a>
</li>
<li><a href="#headline-43">1âƒ£2âƒ£ 5810296 finalize Vue helper imports</a>
</li>
</ul>
</li>
<li><a href="#headline-44">61c3b7a transform src set</a>
</li>
<li><a href="#headline-45">æ€»ç»“</a>
<ul>
<li><a href="#headline-46">script[setup] æµ‹è¯•</a>
</li>
<li><a href="#headline-47">typescript è¯­è¨€</a>
</li>
</ul>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> å®Œå…¨æ‹·è´äº <a href="https://github.com/vuejs/vue-next">vue-next</a> ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚</strong>
</kbd></p>
<blockquote>
<p><strong>å£°æ˜</strong> ï¼švue-next compiler-sfc æ¨¡å—ï¼Œç›¸å…³çš„æ‰€æœ‰æµ‹è¯•ä»£ç å‡åœ¨ <code>/js/vue/</code> ç›®å½•ä¸‹é¢ã€‚</p>
<p>
<strong>æ›´æ–°æ—¥å¿—&amp;Todos</strong> ï¼š</p>
<ol>
<li>
<p>[2020-12-19 13:58:31] åˆ›å»º</p>
</li>
<li>
<p>[2021-01-04 19:47:10] å®Œæˆ</p>
</li>
<li>
<p>TODO defineProps å’Œ defineEmit åŸç†å’Œç”¨é€”</p>
</li>
<li>
<p>TODO inlineTemplate with ssr: true options</p>
</li>
<li>
<p>TODO more mind-maps</p>
</li>
</ol>
</blockquote>
<p>
<img src="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" alt="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" title="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" /></p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
é‡ç‚¹ã€ç‰¹æ€§ã€é—®é¢˜
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
<img src="/img/vue3/compiler-sfc/vue-compiler-sfc-keypoints.svg" alt="/img/vue3/compiler-sfc/vue-compiler-sfc-keypoints.svg" title="/img/vue3/compiler-sfc/vue-compiler-sfc-keypoints.svg" /></p>
<ol>
<li>
<p><a href="#parse-func">ğŸ”—</a> <code>&lt;style&gt;</code> æ ‡ç­¾ä¸­å¯é€šè¿‡ <code>v-bind()</code> å¼•ç”¨CSS æ¨¡å—åŒ–åçš„å˜é‡</p>
</li>
<li>
<p><code>&lt;script&gt;</code> å’Œ <code>&lt;script setup&gt;</code> ä¸­çš„ export default ä¼šåˆå¹¶ï¼Œä¸”æ˜¯ setup ä¼˜å…ˆçº§
æ›´é«˜ï¼Œå› æ­¤å°½é‡ä¸è¦å­˜åœ¨é‡å¤å±æ€§ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
f21c84c init åˆå§‹åŒ–å·¥ä½œ
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f21c84ca8a8488347aba243262be333f26ab2cef">feat(init): compiler-sfc Â· gcclll/stb-vue-next@f21c84c</a></p>
<p>
cp compiler-sfc form vue-next:/packages/compiler-dom</p>
<p>
åˆ é™¤ compiler-sfc/src/* ä¸‹æ‰€æœ‰æ–‡ä»¶</p>
<p>
æ–°å»º compiler-sfc/src/index.ts å…¥å£æ–‡ä»¶</p>
<p>
åˆå§‹åŒ– index.ts:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// API
</span><span class="c1"></span><span class="kr">export</span> <span class="p">{</span> <span class="nx">generateCodeFrame</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@vue/compiler-core&#39;</span>

<span class="c1">// Types
</span><span class="c1"></span><span class="kr">export</span> <span class="p">{</span>
  <span class="nx">CompilerOptions</span><span class="p">,</span>
  <span class="nx">CompilerError</span><span class="p">,</span>
  <span class="nx">BindingMetadata</span>
<span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@vue/compiler-core&#39;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<hr>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e7e1cc130e5c555b541be39b475b6546969b32dc">feat(init): parse function Â· gcclll/stb-vue-next@e7e1cc1</a></p>
<p>
å£°æ˜ä¸€äº›åŸºæœ¬ç±»å‹ï¼Œæ¯”å¦‚ï¼š <code>&lt;template&gt;, &lt;script&gt;, &lt;style&gt;</code> è¿™ä¹Ÿæ˜¯ <code>*.vue</code> æ–‡ä»¶çš„ä¸‰
å¤§è¦ç´ ï¼Œè¿™é‡Œéœ€è¦å¤šå…³æ³¨ä¸€ç‚¹å°±æ˜¯ä¼šå‘ç° <code>&lt;script&gt;</code> æ ‡ç­¾é‡Œé¢å¤šæœ‰ä¸€ä¸ª <code>setup</code> å±æ€§ï¼Œ
è¿™ä¸ªæ˜¯ vue è‡ªèº«å®šä¹‰çš„ä¸€ç§æ ‡ç­¾ç±»å‹ï¼Œæ¯”å¦‚åœ¨è¿™é‡Œé¢å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>ref</code> å£°æ˜å˜é‡ï¼Œè¿™é‡Œ
é¢çš„å˜é‡éƒ½ä¼šè‡ªåŠ¨å˜æˆå“åº”å¼çš„ç­‰ç­‰ã€‚</p>
<p>
SFC å—ç±»å‹å®šä¹‰ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="kt">string</span>
  <span class="nx">content</span>: <span class="kt">string</span>
  <span class="nx">attrs</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">string</span> <span class="err">|</span> <span class="na">true</span><span class="p">&gt;</span>
  <span class="nx">loc</span>: <span class="kt">SourceLocation</span>
  <span class="nx">map?</span>: <span class="kt">RawSourceMap</span>
  <span class="nx">lang?</span>: <span class="kt">string</span>
  <span class="nx">src?</span>: <span class="kt">string</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC <code>&lt;template&gt;</code> æ ‡ç­¾ç±»å‹å®šä¹‰ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCTemplateBlock</span> <span class="kr">extends</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;template&#39;</span>
  <span class="nx">ast</span>: <span class="kt">ElementNode</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC <code>&lt;script&gt;</code> è„šæœ¬æ ‡ç­¾ç±»å‹å®šä¹‰</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCScriptBlock</span> <span class="kr">extends</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;script&#39;</span>
  <span class="nx">setup?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kr">boolean</span>
  <span class="nx">bindings?</span>: <span class="kt">BindingMetadata</span>
  <span class="nx">scriptAst?</span>: <span class="kt">Statement</span><span class="p">[]</span>
  <span class="nx">scriptSetupAst?</span>: <span class="kt">Statement</span><span class="p">[]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC <code>&lt;style&gt;</code> æ ·å¼æ ‡ç­¾ç±»å‹å®šä¹‰</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCStyleBlock</span> <span class="kr">extends</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;style&#39;</span>
  <span class="nx">scoped?</span>: <span class="kt">boolean</span> <span class="c1">// æŒ‡å®šæ˜¯ä¸æ˜¯åªèƒ½ç”¨äºå½“å‰æ–‡ä»¶
</span><span class="c1"></span>  <span class="kr">module</span><span class="nx">?</span><span class="o">:</span> <span class="kt">string</span> <span class="o">|</span> <span class="kr">boolean</span> <span class="c1">// æ˜¯ä¸æ˜¯æ¨¡å—åŒ–æ ·å¼
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC æ–‡ä»¶ç±»å‹å®šä¹‰</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCDescriptor</span> <span class="p">{</span>
  <span class="nx">filename</span>: <span class="kt">string</span>
  <span class="nx">source</span>: <span class="kt">string</span>
  <span class="nx">template</span>: <span class="kt">SFCTemplateBlock</span> <span class="o">|</span> <span class="kc">null</span>
  <span class="nx">script</span>: <span class="kt">SFCScriptBlock</span> <span class="o">|</span> <span class="kc">null</span>
  <span class="nx">scriptSetup</span>: <span class="kt">SFCScriptBlock</span> <span class="o">|</span> <span class="kc">null</span>
  <span class="nx">styles</span>: <span class="kt">SFCStyleBlock</span><span class="p">[]</span>
  <span class="nx">customBlocks</span>: <span class="kt">SFCBlock</span><span class="p">[]</span>
  <span class="nx">cssVars</span>: <span class="kt">string</span><span class="p">[]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
parse å‡½æ•°å®šä¹‰ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span>
  <span class="nx">source</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">sourceMap</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">}</span><span class="o">:</span> <span class="nx">SFCParseOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">SFCParseResult</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">SFCParseResult</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-func" class="outline-2">
<h2 id="parse-func">
49ee210 parse function å®ç°éƒ¨åˆ†
</h2>
<div id="outline-text-parse-func" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/49ee210b898949dbc36dabb7b98555c6043c2a31">feat: sfc-&gt; code parse function Â· gcclll/stb-vue-next@49ee210</a></p>
<p>
å®ç° parse å‡½æ•°çš„åŸºæœ¬æ¶æ„:</p>
<ol>
<li>
<p><code>sourceToSFC&lt;key, source&gt;</code> ç”¨æ¥ç¼“å­˜ vueæ–‡ä»¶è§£æç»“æœï¼Œé¦–å…ˆå–ç¼“å­˜ç»“æœ</p>
</li>
<li>
<p>é€šè¿‡è°ƒç”¨ compiler-dom ä¸­çš„ compiler.parse å°†æ–‡ä»¶å†…å®¹ sourceè§£ææˆ AST</p>
</li>
<li>
<p>éå†æ‰€æœ‰ ast.children æ ¹æ® node.tag ç±»å‹å†³å®šèµ°ä»€ä¹ˆåˆ†æ”¯å¤„ç†</p>
<p>
<code>&lt;template&gt;</code> æ¨¡æ¿åˆ†æ”¯ï¼Œè¿™é‡Œé¢çš„æ‰€æœ‰å†…å®¹ä¼šè¢« parse ç»§ç»­è§£æå‡º ast</p>
<p>
<code>&lt;script [setup]&gt;</code> è„šæœ¬åˆ†æ”¯, å½“åš RAWDATA æ–‡æœ¬ç±»å‹å¤„ç†ï¼Œå¦‚æœæœ‰ <code>setup</code> å±æ€§ï¼Œ
åˆ™æ‰€æœ‰ script éƒ½ä¸èƒ½å¸¦ src å±æ€§ï¼Œå³ä¸èƒ½å¼•ç”¨å¤–éƒ¨æ–‡ä»¶ï¼Œå› ä¸ºæ‰€æœ‰ script å†…å®¹ä¼šåˆ
å¹¶åˆ°ä¸€èµ·å»å¤„ç†ã€‚</p>
<p>
<code>&lt;style [lang=&#34;&#34;]&gt;</code>  æ ·å¼åˆ†æ”¯ï¼Œå½“åš RAWDATA æ–‡æœ¬ç±»å‹å¤„ç†</p>
</li>
<li>
<p>é”™è¯¯ç”¨æ³•æ£€æµ‹ï¼Œä¸»è¦æ˜¯ <code>&lt;script setup&gt;</code> è„šæœ¬æ ‡ç­¾ä¸èƒ½æœ‰ src çš„æ£€æµ‹</p>
</li>
<li>
<p><code>souremap</code> çš„å¤„ç†</p>
</li>
<li>
<p><code>descriptor.cssVars = parseCssVars(descriptor)</code> CSS å˜é‡çš„è§£æï¼Œä¼šå…¨éƒ¨è§£æåˆ°
æ•°ç»„ <code>cssVars</code> é‡Œé¢å»</p>
</li>
<li>
<p>ç¼“å­˜è§£æåçš„ç»“æœåˆ° <code>sourceToSFC.set(sourceKey, result)</code></p>
</li>
<li>
<p>å¯¹äº†ï¼Œåœ¨ <code>switch case</code> åˆ†æ”¯é‡Œé¢é»˜è®¤èµ°çš„æ˜¯è‡ªå®šä¹‰å—çš„å¤„ç†(vue æ–‡ä»¶ä¸­è¿˜å¯ä»¥è‡ªå®š
ä¹‰ï¼Ÿ)</p>
</li>
</ol>
<p>
CSS vars å˜é‡å¤„ç†ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">CSS_VARS_HELPER</span> <span class="o">=</span> <span class="sb">`useCssVars`</span><span class="p">;</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">cssVarRE</span> <span class="o">=</span> <span class="sr">/\bv-bind\(\s*(?:&#39;([^&#39;]+)&#39;|&#34;([^&#34;]+)&#34;|([^&#39;&#34;][^)]*))\s*\)/g</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">parseCssVars</span><span class="p">(</span><span class="nx">sfc</span>: <span class="kt">SFCDescriptor</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">vars</span>: <span class="kt">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">sfc</span><span class="p">.</span><span class="nx">styles</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">style</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">match</span><span class="p">;</span>
    <span class="c1">// v-bind(&#39;xxx&#39;), v-bind(&#34;xxx&#34;), v-bind()
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">cssVarRE</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">style</span><span class="p">.</span><span class="nx">content</span><span class="p">)))</span> <span class="p">{</span>
      <span class="nx">vars</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">vars</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œæœ‰ä¸ª cssVarRE æ­£åˆ™ï¼Œæ¥çœ‹ä¸‹ï¼š</p>
<p>
<img src="/img/vue3/re/sfc-css-vars-re.svg" alt="/img/vue3/re/sfc-css-vars-re.svg" title="/img/vue3/re/sfc-css-vars-re.svg" /></p>
<p>
è¿™ä¸ªæ­£åˆ™å¯ä»¥åŒ¹é…ç»“æœï¼š <code>v-bind(&#39;...&#39;), v-bind(&#34;...&#34;), v-bind(...)</code></p>
<p>
ä» <code>compiler-src/__tests__/cssVars.spec.ts</code> ç”¨ä¾‹ä¸­å¯çª¥è§è¿™ç§ç”¨æ³•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;script&gt;const a = 1&lt;/script&gt;\n`</span> <span class="o">+</span>
   <span class="sb">`&lt;style&gt;div{
</span><span class="sb">     color: v-bind(color);
</span><span class="sb">     font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">   }&lt;/style&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>ğŸ’Ÿ  ç°åœ¨å¯ä»¥ç›´æ¥åœ¨ <code>&lt;style&gt;</code> å˜è¿é‡Œé¢é€šè¿‡ <code>v-bind()</code> æ¥ç›´æ¥ä½¿ç”¨å¼•å…¥çš„ CSS å˜é‡ã€‚</p>
</blockquote>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/afd8044321de2e4396b8b81bf6e837beeb4ef8b1">feat(add): sfc-&gt;parse add sourcemap Â· gcclll/stb-vue-next@afd8044</a></p>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
e32d508 parse &lt;template&gt; case
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e32d508809cb7c49e04e4bdac63c26d0101f31a7">feat: sfc-&gt; add &lt;template&gt; parse Â· gcclll/stb-vue-next@e32d508</a></p>
<p>
ä¸»è¦å¢åŠ ä»£ç ï¼š switch case -&gt; &#39;template&#39;:
<img src="http://qiniu.ii6g.com/img/20201219160507.png" alt="http://qiniu.ii6g.com/img/20201219160507.png" title="http://qiniu.ii6g.com/img/20201219160507.png" /></p>
<p>
å¢åŠ å‡½æ•°ï¼š <code>createBlock()</code> ç”¨æ¥å¤„ç† SFC æ ‡ç­¾çš„å±æ€§(å¦‚ï¼š <code>lang, setup, src,
scoped, module</code>)</p>
<p>
å›é¡¾ä¸‹ <a href="/vue/vue-mind-map-compiler-dom/">compiler-dom</a>, <a href="/vue/vue-mind-map-compiler-core-parser/">compiler-core</a> å…¶å®å¯¹äº <code>&lt;template&gt;</code> æ ‡ç­¾çš„å¤„ç†å·¥ä½œä¾ç„¶é›†ä¸­
åœ¨è¿™ä¸¤ä¸ªåŒ…é‡Œé¢ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†èµ˜è¿°æ¨¡æ¿ ast çš„è§£æäº†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">parse</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-sfc.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;template&gt;
</span><span class="sb">  &lt;div&gt;{{ test }}&lt;/div&gt;
</span><span class="sb">&lt;/template&gt;
</span><span class="sb">&lt;script&gt;&lt;/script&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">  div {
</span><span class="sb">    color:v-bind(&#39;fontColor&#39;);
</span><span class="sb">  }
</span><span class="sb">&lt;/style&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  descriptor: {
    filename: &#39;anonymous.vue&#39;,
    source: &#39;\n&#39; +
      &#39;&lt;template&gt;\n&#39; +
      &#39;  &lt;div&gt;{{ test }}&lt;/div&gt;\n&#39; +
      &#39;&lt;/template&gt;\n&#39; +
      &#39;&lt;script&gt;&lt;/script&gt;\n&#39; +
      &#39;&lt;style&gt;\n&#39; +
      &#39;  div {\n&#39; +
      &#34;    color:v-bind(&#39;fontColor&#39;);\n&#34; +
      &#39;  }\n&#39; +
      &#39;&lt;/style&gt;&#39;,
    template: {
      type: &#39;template&#39;,
      content: &#39;\n  &lt;div&gt;{{ test }}&lt;/div&gt;\n&#39;,
      loc: [Object],
      attrs: {},
      ast: [Object]
    },
    script: null,
    scriptSetup: null,
    styles: [],
    customBlocks: [],
    cssVars: []
  },
  errors: []
}
undefined
</pre>
<p>
å¦‚ä¸Šï¼šä¸€ä¸ªæœ€ç®€å•çš„ SFC è§£æåçš„ç»“æ„ã€‚</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
3160fed parse &lt;script&gt; case
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3160fedbf252ad5a71a16567ae44fa445a343fa8">feat(add): sfc-&gt; script parse Â· gcclll/stb-vue-next@3160fed</a></p>
<p>
å¢åŠ  switch case script é€»è¾‘ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">case</span> <span class="s1">&#39;script&#39;</span><span class="o">:</span> <span class="c1">// è„šæœ¬æ ‡ç­¾å¤„ç†
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">scriptBlock</span> <span class="o">=</span> <span class="nx">createBlock</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">pad</span><span class="p">)</span> <span class="kr">as</span> <span class="nx">SFCScriptBlock</span>
    <span class="kr">const</span> <span class="nx">isSetup</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">scriptBlock</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">setup</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isSetup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">descriptor</span><span class="p">.</span><span class="nx">scriptSetup</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">descriptor</span><span class="p">.</span><span class="nx">scriptSetup</span> <span class="o">=</span> <span class="nx">scriptBlock</span>
        <span class="k">break</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSetup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">descriptor</span><span class="p">.</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">descriptor</span><span class="p">.</span><span class="nx">script</span> <span class="o">=</span> <span class="nx">scriptBlock</span>
        <span class="k">break</span>
    <span class="p">}</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">createDuplicateBlockError</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">isSetup</span><span class="p">))</span>
    <span class="k">break</span>
<span class="k">break</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
createBlock() ä¸­å¢åŠ å„å±æ€§çš„è§£æå’Œè®¾ç½®ï¼š</p>
<p>
<code>lang</code> -&gt; <code>block.lang</code></p>
<p>
<code>src</code> -&gt; <code>block.src</code></p>
<p>
<code>style &gt; scoped</code> -&gt; <code>block.scoped</code></p>
<p>
<code>style &gt; module</code> -&gt; <code>block.module</code></p>
<p>
<code>script &gt; setup</code> -&gt; <code>block.setup</code></p>
<p>
å¦å¤–å¢åŠ äº† <code>padContent()</code> æ£€æµ‹å›è½¦æ¢è¡Œç¬¦æ›¿æ¢ï¼Ÿ</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">parse</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-sfc.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { x } from &#39;./x&#39;
</span><span class="sb">let a = 1
</span><span class="sb">const b = 2
</span><span class="sb">function c() {}
</span><span class="sb">class d {}
</span><span class="sb">&lt;/script&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">descriptor</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  filename: &#39;anonymous.vue&#39;,
  source: &#39;\n&#39; +
    &#39;&lt;script setup&gt;\n&#39; +
    &#34;import { x } from &#39;./x&#39;\n&#34; +
    &#39;let a = 1\n&#39; +
    &#39;const b = 2\n&#39; +
    &#39;function c() {}\n&#39; +
    &#39;class d {}\n&#39; +
    &#39;&lt;/script&gt;&#39;,
  template: null,
  script: null,
  scriptSetup: {
    type: &#39;script&#39;,
    content: &#39;\n&#39; +
      &#34;import { x } from &#39;./x&#39;\n&#34; +
      &#39;let a = 1\n&#39; +
      &#39;const b = 2\n&#39; +
      &#39;function c() {}\n&#39; +
      &#39;class d {}\n&#39;,
    loc: {
      source: &#39;\n&#39; +
        &#34;import { x } from &#39;./x&#39;\n&#34; +
        &#39;let a = 1\n&#39; +
        &#39;const b = 2\n&#39; +
        &#39;function c() {}\n&#39; +
        &#39;class d {}\n&#39;,
      start: [Object],
      end: [Object]
    },
    attrs: { setup: true },
    setup: true
  },
  styles: [],
  customBlocks: [],
  cssVars: []
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
aa037fe parse &lt;style&gt; case
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/aa037fef4476f27ce25a88480768cb81e10075da">feat(add): sfc-&gt; parse &lt;style&gt; Â· gcclll/stb-vue-next@aa037fe</a></p>
<p>
è§£æåçš„ç»“æœä¿å­˜åˆ° <code>descriptor.styles.push(styleBlock)</code> æ‰€ä»¥å¯ä»¥æœ‰å¤šä¸ª <code>&lt;style&gt;</code>
å­˜åœ¨ã€‚</p>
<blockquote>
<p><em>Tip</em>: è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª <code>styleBlock.attrs.vars</code> æ£€æµ‹ï¼Œéš¾ä¸æˆå°†æ¥ä¼šæ”¯æŒç›´æ¥ SFC é‡Œé¢
å£°æ˜ CSS å˜é‡?</p>
</blockquote>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">parse</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-sfc.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;style scoped&gt;
</span><span class="sb">h1 {
</span><span class="sb">  color: red;
</span><span class="sb">  font-size: v-bind(fontSize);
</span><span class="sb">  border: v-bind(&#39;border&#39;);
</span><span class="sb">}
</span><span class="sb">&lt;/style&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">descriptor</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  filename: &#39;anonymous.vue&#39;,
  source: &#39;\n&#39; +
    &#39;&lt;style scoped&gt;\n&#39; +
    &#39;h1 {\n&#39; +
    &#39;  color: red;\n&#39; +
    &#39;  font-size: v-bind(fontSize);\n&#39; +
    &#34;  border: v-bind(&#39;border&#39;);\n&#34; +
    &#39;}\n&#39; +
    &#39;&lt;/style&gt;&#39;,
  template: null,
  script: null,
  scriptSetup: null,
  styles: [
    {
      type: &#39;style&#39;,
      content: &#39;\n&#39; +
        &#39;h1 {\n&#39; +
        &#39;  color: red;\n&#39; +
        &#39;  font-size: v-bind(fontSize);\n&#39; +
        &#34;  border: v-bind(&#39;border&#39;);\n&#34; +
        &#39;}\n&#39;,
      loc: [Object],
      attrs: [Object],
      scoped: true
    }
  ],
  customBlocks: [],
  cssVars: [ &#39;fontSize&#39;, &#39;border&#39; ]
}
undefined
</pre>
<p>
å¯¹äº <code>v-bind()</code> å˜é‡çš„å¼•ç”¨ï¼Œä¸ç®¡æœ‰æ²¡å¼•å·ï¼Œéƒ½ä¼šå½“åšå˜é‡å¤„ç†ã€‚</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
compile &lt;template&gt;
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
c26e76c init compileTemplate
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c26e76cb4e7ef260f3c500aa693581fca175cab4">feat(init): sfc-&gt;compile &lt;template&gt; Â· gcclll/stb-vue-next@c26e76c</a></p>
<p>
å¢åŠ ä¸¤ä¸ªç±»å‹å’Œ compileTemplate å‡½æ•°å®šä¹‰ï¼š</p>
<p>
SFCTemplateCompileResults æ¨¡æ¿ä¾¿åçš„ç»“æœç±»å‹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCTemplateCompileResults</span> <span class="p">{</span>
  <span class="nx">code</span>: <span class="kt">string</span>
  <span class="nx">ast?</span>: <span class="kt">RootNode</span>
  <span class="nx">preamble?</span>: <span class="kt">string</span>
  <span class="nx">source</span>: <span class="kt">string</span>
  <span class="nx">tips</span>: <span class="kt">string</span><span class="p">[]</span>
  <span class="nx">errors</span><span class="o">:</span> <span class="p">(</span><span class="kt">string</span> <span class="o">|</span> <span class="nx">CompilerError</span><span class="p">)[]</span>
  <span class="nx">map?</span>: <span class="kt">RawSourceMap</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFCTemplateCompileOptions æ¨¡æ¿ç¼–è¯‘å™¨é€‰é¡¹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCTemplateCompileOptions</span> <span class="p">{</span>
  <span class="nx">source</span>: <span class="kt">string</span>
  <span class="nx">filename</span>: <span class="kt">string</span>
  <span class="nx">id</span>: <span class="kt">string</span>
  <span class="nx">scoped?</span>: <span class="kt">boolean</span>
  <span class="nx">isProd?</span>: <span class="kt">boolean</span>
  <span class="nx">ssr?</span>: <span class="kt">boolean</span>
  <span class="nx">ssrCssVars?</span>: <span class="kt">string</span><span class="p">[]</span>
  <span class="nx">inMap?</span>: <span class="kt">RawSourceMap</span>
  <span class="nx">compiler?</span>: <span class="kt">TemplateCompiler</span>
  <span class="nx">compilerOptions?</span>: <span class="kt">CompilerOptions</span>
  <span class="nx">preprocessLang?</span>: <span class="kt">string</span>
  <span class="nx">preprocessOptions?</span>: <span class="kt">any</span>
  <span class="cm">/**
</span><span class="cm">   * In some cases, compiler-sfc may not be inside the project root (e.g. when
</span><span class="cm">   * linked or globally installed). In such cases a custom `require` can be
</span><span class="cm">   * passed to correctly resolve the preprocessors.
</span><span class="cm">   */</span>
  <span class="nx">preprocessCustomRequire</span><span class="o">?:</span> <span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span>
  <span class="cm">/**
</span><span class="cm">   * Configure what tags/attributes to transform into asset url imports,
</span><span class="cm">   * or disable the transform altogether with `false`.
</span><span class="cm">   */</span>
  <span class="nx">transformAssetUrls?</span>: <span class="kt">AssetURLOptions</span> <span class="o">|</span> <span class="nx">AssetURLTagConfig</span> <span class="o">|</span> <span class="kr">boolean</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
åŠ compileTemplate å‡½æ•°</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">compileTemplate</span><span class="p">(</span>
  <span class="nx">options</span>: <span class="kt">SFCTemplateCompileOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">SFCTemplateCompileResults</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">SFCTemplateCompileResults</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-9" class="outline-3">
<h3 id="headline-9">
<span class="todo">TODO</span>
1b2965f coding compileTemplate
</h3>
<div id="outline-text-headline-9" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1b2965fb3d45c450f0b8af66c54834a0ecc8d219">feat: sfc-&gt;compile compileTemplate code Â· gcclll/stb-vue-next@1b2965f</a></p>
<p>
è¿™ä¸ªå‡½æ•°ç›¸å…³çš„å†…å®¹ï¼š</p>
<ol>
<li>
<p>preprocessLang</p>
</li>
<li>
<p>preprocessCustomRequire</p>
</li>
</ol>
<p>TODO æ¨¡æ¿é¢„å¤„ç†å™¨ï¼Œæ²¡ææ˜ç™½è¿™é‡Œæ˜¯è¦åšä»€ä¹ˆï¼Ÿ</p>
<p>
ä»£ç é€»è¾‘ï¼š</p>
<p>
if preprocessor -&gt; doCompileTemplate()</p>
<p>
elseif preprocessLang -&gt; â€¦</p>
<p>
else -&gt; doCompileTemplate()</p>
<blockquote>
<p>â¹ ç­‰å¾…æ¢ç´¢â€¦â€¦</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-10" class="outline-3">
<h3 id="headline-10">
7b49db4 coding doCompileTemplate å‡½æ•°å®ç°
</h3>
<div id="outline-text-headline-10" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7b49db43ed8b1535d423b9143b3019fd5556be8a">feat(add): sfc-&gt;compile doCompileTemplate Â· gcclll/stb-vue-next@7b49db4</a></p>
<p>
å‡½æ•°åŠŸèƒ½ï¼šæ”¶é›†ä¸¤ä¸ª transform ç»™ compiler.compile åœ¨æ¨¡æ¿ç¼–è¯‘æœŸé—´ä½¿ç”¨ã€‚</p>
<ol>
<li>
<p>asset url èµ„æºåœ°å€è½¬æ¢ç”¨çš„ transform</p>
<p>
è¦å¤„ç†çš„æ ‡ç­¾å’Œå¯¹åº”çš„åŒ…å« url çš„å±æ€§:</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>prop with url</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;video&gt;</code></td>
<td>&#39;src&#39;, &#39;poster&#39;</td>
</tr>
<tr>
<td><code>&lt;source&gt;</code></td>
<td>&#39;src&#39;</td>
</tr>
<tr>
<td><code>&lt;img&gt;</code></td>
<td>&#39;src&#39;</td>
</tr>
<tr>
<td><code>&lt;image&gt;</code></td>
<td>&#39;xlink:href&#39;, &#39;href&#39;</td>
</tr>
<tr>
<td><code>&lt;use&gt;</code></td>
<td>&#39;xlink:href&#39;, &#39;href&#39;</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>img/source æ ‡ç­¾ src åœ°å€è½¬æ¢</p>
</li>
</ol>
<p>
é‡ç‚¹ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">shortId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^data-v-/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">longId</span> <span class="o">=</span> <span class="sb">`data-v-</span><span class="si">${</span><span class="nx">shortId</span><span class="si">}</span><span class="sb">`</span>

  <span class="kd">let</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">preamble</span><span class="p">,</span> <span class="nx">map</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compiler</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span>
    <span class="nx">prefixIdentifiers</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">hoistStatic</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">cacheHandlers</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">ssrCssVars</span>:
      <span class="kt">ssr</span> <span class="o">&amp;&amp;</span> <span class="nx">ssrCssVars</span> <span class="o">&amp;&amp;</span> <span class="nx">ssrCssVars</span><span class="p">.</span><span class="nx">length</span>
        <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="cm">/* TODO genCssVarsFromList(ssrCssVars, shortId, isProd) */</span>
        <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="c1">// css å±€éƒ¨ä½¿ç”¨ï¼ŒåŠ ä¸Šå¯¹åº”çš„å”¯ä¸€ id
</span><span class="c1"></span>    <span class="nx">scopeId</span>: <span class="kt">scoped</span> <span class="o">?</span> <span class="nx">longId</span> : <span class="kt">undefined</span><span class="p">,</span>
    <span class="p">...</span><span class="nx">compilerOptions</span><span class="p">,</span>
    <span class="nx">nodeTransforms</span>: <span class="kt">nodeTransforms.concat</span><span class="p">(</span><span class="nx">compilerOptions</span><span class="p">.</span><span class="nx">nodeTransforms</span> <span class="o">||</span> <span class="p">[]),</span>
    <span class="nx">filename</span><span class="p">,</span>
    <span class="nx">sourceMap</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">onError</span>: <span class="kt">e</span> <span class="o">=&gt;</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å°† <code>nodeTransforms: [transformAssetUrl, transformSrcset]</code> ä¼ é€’ç»™ç¼–è¯‘å™¨å¤„ç†ã€‚</p>
<p>
æ³¨æ„è¿™é‡Œè®¾ç½®äº†å‡ ä¸ªå±æ€§ï¼š <code>mode = &#39;module&#39;, prefixIdentifiers = true</code> æ‰€ä»¥è¿™ä¸ªåº”
è¯¥åªèƒ½è¿è¡Œåœ¨éæµè§ˆå™¨ç¯å¢ƒã€‚</p>
<p>
ä¸‹é¢æ¥å®ç°ä¸€ä¸ªç›¸å¯¹ç®€å•çš„ <code>transformAssetUrl()</code> å‡½æ•° â€¦â€¦</p>
</div>
</div>
<div id="outline-container-headline-11" class="outline-3">
<h3 id="headline-11">
2d82400 coding transformAssetUrl è½¬æ¢èµ„æº url
</h3>
<div id="outline-text-headline-11" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2d8240089e6d7642a0f2234b6addff8e0d9885cd">feat(add): sfc-&gt;compile templateTransformAssetUrl Â· gcclll/stb-vue-next@2d82400</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e08f8059612591a6b38d6e813e305986fc7f646a">fix: sfc preprocess function Â· gcclll/stb-vue-next@e08f805</a></p>
<p>
å‡ ç§URLä½¿ç”¨æƒ…å†µå’Œè½¬æ¢ç»“æœå¦‚ä¸‹å®ä¾‹ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileTemplate</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compileTemplate</span><span class="p">({</span>
  <span class="nx">source</span><span class="o">:</span> <span class="sb">`&lt;template&gt;&lt;div id=&#34;test&#34;&gt;
</span><span class="sb">&lt;img src=&#34;./test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;./test/test.png&#34; /&gt;
</span><span class="sb">&lt;img :src=&#34;imgUrl&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;http://1.1.1.1:100/imgs/test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;data:....&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;#test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;~test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;~/test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;@test/test.png&#34; /&gt;
</span><span class="sb">&lt;video src=&#34;./test/video.mp4&#34; poster=&#34;./test/poster.png&#34; /&gt;
</span><span class="sb">&lt;div src=&#34;./test/test.png&#34; /&gt;
</span><span class="sb">
</span><span class="sb">&lt;/div&gt;&lt;/template&gt;`</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;test.vue&#39;</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;
import _imports_0 from &#39;./test/test.png&#39;
import _imports_1 from &#39;test/test.png&#39;
import _imports_2 from &#39;@test/test.png&#39;
import _imports_3 from &#39;./test/video.mp4&#39;
import _imports_4 from &#39;./test/poster.png&#39;


const _hoisted_1 = { id: &#34;test&#34; }
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_0 }, null, -1 /* HOISTED */)
const _hoisted_3 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_0 }, null, -1 /* HOISTED */)
const _hoisted_4 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;&#34; }, null, -1 /* HOISTED */)
const _hoisted_5 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;http://1.1.1.1:100/imgs/test/test.png&#34; }, null, -1 /* HOISTED */)
const _hoisted_6 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;data:....&#34; }, null, -1 /* HOISTED */)
const _hoisted_7 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;#test/test.png&#34; }, null, -1 /* HOISTED */)
const _hoisted_8 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_1 }, null, -1 /* HOISTED */)
const _hoisted_9 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_1 }, null, -1 /* HOISTED */)
const _hoisted_10 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_2 }, null, -1 /* HOISTED */)
const _hoisted_11 = /*#__PURE__*/_createVNode(&#34;video&#34;, {
  src: _imports_3,
  poster: _imports_4
}, null, -1 /* HOISTED */)
const _hoisted_12 = /*#__PURE__*/_createVNode(&#34;div&#34;, { src: &#34;./test/test.png&#34; }, null, -1 /* HOISTED */)

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(&#34;template&#34;, null, [
    _createVNode(&#34;div&#34;, _hoisted_1, [
      _hoisted_2,
      _hoisted_3,
      _createVNode(&#34;img&#34;, { src: _ctx.imgUrl }, null, 8 /* PROPS */, [&#34;src&#34;]),
      _hoisted_4,
      _hoisted_5,
      _hoisted_6,
      _hoisted_7,
      _hoisted_8,
      _hoisted_9,
      _hoisted_10,
      _hoisted_11,
      _hoisted_12
    ])
  ]))
}
undefined
</pre>
<p>
æ¨¡æ¿ä¸­èµ„æºURLä¸è½¬æ¢å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>
<p>å±æ€§ä¸æ˜¯é™æ€å±æ€§(<code>NodeTypes.ATTRIBUTE</code>)</p>
</li>
<li>
<p>éç‰¹å®šæ ‡ç­¾çš„ä¸è½¬æ¢(æˆ–è€…é€šè¿‡ <code>options.tags</code> é‡ŒæŒ‡å®šçš„æ ‡ç­¾)</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">tags:</span> <span class="p">{</span>
  <span class="err">video:</span> <span class="err">[&#39;src&#39;,</span> <span class="err">&#39;poster&#39;],</span>
  <span class="err">source:</span> <span class="err">[&#39;src&#39;],</span>
  <span class="err">img:</span> <span class="err">[&#39;src&#39;],</span>
  <span class="err">image:</span> <span class="err">[&#39;xlink:href&#39;,</span> <span class="err">&#39;href&#39;],</span>
  <span class="err">use:</span> <span class="err">[&#39;xlink:href&#39;,</span> <span class="err">&#39;href&#39;]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>æ²¡æœ‰å±æ€§å€¼çš„å±æ€§</p>
</li>
<li>
<p>å¤–éƒ¨é“¾æ¥çš„URL(<code>https</code> å¼€å¤´çš„)</p>
</li>
<li>
<p><code>data:</code> å¼€å¤´çš„èµ„æºåœ°å€</p>
</li>
<li>
<p>å±æ€§å€¼ä»¥ <code>#</code> å¼€å¤´çš„åœ°å€</p>
</li>
<li>
<p>éç»å¯¹è·¯å¾„ä¸”è´¹ç›¸å¯¹è·¯å¾„çš„(ä»¥ï¼Œ <code>.|~|@</code> å¼€å¤´çš„åœ°å€)</p>
</li>
</ol>
<p>
éœ€è¦å¤„ç†çš„åˆåˆ†ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>
<p>ç»™å®šäº† <code>options.base</code> åŸºåœ°å€çš„(<code>.|~|@</code> ä¸ºç¬¬ä¸€ä¸ªå­—ç¬¦çš„)</p>
<p>
ç›´æ¥ç”¨ <code>options.base + assert url</code> å¤„ç†</p>
</li>
<li>
<p>é1ä¸­æ¸…ç©ºçš„ä½¿ç”¨ <code>import imgName from &#39;...img url&#39;</code> å¼•å…¥</p>
</li>
</ol>
<blockquote>
<p>PS. å¯¹äº CSS ä¸­çš„URLå¼•ç”¨æ”¾åˆ°åç»­ compileStyle ä¸­å»å±•ç¤ºã€‚</p>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-12" class="outline-2">
<h2 id="headline-12">
56358a8 compile &lt;style&gt;
</h2>
<div id="outline-text-headline-12" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/56358a8b2cf95ef6a2df125c672a455690785a84">feat(add): sfc-&gt; compile style Â· gcclll/stb-vue-next@56358a8</a></p>
<p>
è¿™éƒ¨åˆ†ä»£ç éƒ½æ˜¯ç›´æ¥ Ctrl-c, Ctrl-v æ¥çš„ï¼Œä¹Ÿæ²¡æ·±å…¥ç ”ç©¶ï¼Œæ‰€ä»¥è¿™èŠ‚ä¹Ÿæ²¡ä»€ä¹ˆå¥½è®²è¿°çš„ã€‚</p>
<p>
å¾…åˆ°ä»¥åæœ‰æ—¶é—´å†æ¥ç ”ç©¶ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileStyle</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">option</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">=&gt;</span> <span class="nx">compileStyle</span><span class="p">({</span>
  <span class="nx">source</span><span class="p">,</span>
  <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;test.css&#39;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;data-v-test&#39;</span><span class="p">,</span>
  <span class="nx">scoped</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">...</span><span class="nx">option</span>
<span class="p">})</span>

<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="sb">`
</span><span class="sb">h1 { color: red; }
</span><span class="sb">.foo { color: red; }
</span><span class="sb">h1 .foo { color: red; }
</span><span class="sb">h1 .foo, .bar, .baz { color: red; }
</span><span class="sb">.foo:after { color: red; }
</span><span class="sb">::selection { display: none; }
</span><span class="sb">.abc, ::selection { color: red; }
</span><span class="sb">
</span><span class="sb">:deep(.foo) { color: red; }
</span><span class="sb">::v-deep(.foo) { color: red; }
</span><span class="sb">::v-deep(.foo .bar) { color: red; }
</span><span class="sb">.baz .qux ::v-deep(.foo .bar) { color: red; }
</span><span class="sb">
</span><span class="sb">:slotted(.foo) { color: red; }
</span><span class="sb">::v-slotted(.foo) { color: red; }
</span><span class="sb">::v-slotted(.foo .bar) { color: red; }
</span><span class="sb">.baz .qux ::v-slotted(.foo .bar) { color: red; }
</span><span class="sb">
</span><span class="sb">:global(.foo) { color: red; }
</span><span class="sb">::v-global(.foo) { color: red; }
</span><span class="sb">::v-global(.foo .bar) { color: red; }
</span><span class="sb">.baz .qux ::v-global(.foo .bar) { color: red; }
</span><span class="sb">
</span><span class="sb">@media print { .foo { color: red }}
</span><span class="sb">@supports(display: grid) { .foo { display: grid }}
</span><span class="sb">
</span><span class="sb">.anim {
</span><span class="sb">  animation: color 5s infinite, other 5s;
</span><span class="sb">}
</span><span class="sb">.anim-2 {
</span><span class="sb">  animation-name: color;
</span><span class="sb">  animation-duration: 5s;
</span><span class="sb">}
</span><span class="sb">.anim-3 {
</span><span class="sb">  animation: 5s color infinite, 5s other;
</span><span class="sb">}
</span><span class="sb">.anim-multiple {
</span><span class="sb">  animation: color 5s infinite, opacity 2s;
</span><span class="sb">}
</span><span class="sb">.anim-multiple-2 {
</span><span class="sb">  animation-name: color, opacity;
</span><span class="sb">  animation-duration: 5s, 2s;
</span><span class="sb">}
</span><span class="sb">
</span><span class="sb">@keyframes color {
</span><span class="sb">  from { color: red; }
</span><span class="sb">  to { color: green; }
</span><span class="sb">}
</span><span class="sb">@-webkit-keyframes color {
</span><span class="sb">  from { color: red; }
</span><span class="sb">  to { color: green; }
</span><span class="sb">}
</span><span class="sb">@keyframes opacity {
</span><span class="sb">  from { opacity: 0; }
</span><span class="sb">  to { opacity: 1; }
</span><span class="sb">}
</span><span class="sb">@-webkit-keyframes opacity {
</span><span class="sb">  from { opacity: 0; }
</span><span class="sb">  to { opacity: 1; }
</span><span class="sb">}
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

h1[data-v-test] { color: red;
}
.foo[data-v-test] { color: red;
}
h1 .foo[data-v-test] { color: red;
}
h1 .foo[data-v-test], .bar[data-v-test], .baz[data-v-test] { color: red;
}
.foo[data-v-test]:after { color: red;
}
[data-v-test]::selection { display: none;
}
.abc[data-v-test],[data-v-test]::selection { color: red;
}
[data-v-test] .foo { color: red;
}
[data-v-test] .foo { color: red;
}
[data-v-test] .foo .bar { color: red;
}
.baz .qux[data-v-test] .foo .bar { color: red;
}
.foo[data-v-test-s] { color: red;
}
.foo[data-v-test-s] { color: red;
}
.foo .bar[data-v-test-s] { color: red;
}
.baz .qux .foo .bar[data-v-test-s] { color: red;
}
.foo { color: red;
}
.foo { color: red;
}
.foo .bar { color: red;
}
.foo .bar { color: red;
}
@media print {
.foo[data-v-test] { color: red
}}
@supports(display: grid) {
.foo[data-v-test] { display: grid
}}
.anim[data-v-test] {
  animation: color-test 5s infinite, other 5s;
}
.anim-2[data-v-test] {
  animation-name: color-test;
  animation-duration: 5s;
}
.anim-3[data-v-test] {
  animation: 5s color-test infinite, 5s other;
}
.anim-multiple[data-v-test] {
  animation: color-test 5s infinite,opacity-test 2s;
}
.anim-multiple-2[data-v-test] {
  animation-name: color-test,opacity-test;
  animation-duration: 5s, 2s;
}
@keyframes color-test {
from { color: red;
}
to { color: green;
}
}
@-webkit-keyframes color-test {
from { color: red;
}
to { color: green;
}
}
@keyframes opacity-test {
from { opacity: 0;
}
to { opacity: 1;
}
}
@-webkit-keyframes opacity-test {
from { opacity: 0;
}
to { opacity: 1;
}
}

undefined
</pre>
<blockquote>
<p>PS. å¯¹äº CSS çš„è§£æéœ€è¦ postcss ä»¥åŠå„ç§é¢„å¤„ç†æ¥å¤„ç†ï¼Œè¿™é‡Œæš‚æ—¶ä¸å±•å¼€ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-13" class="outline-2">
<h2 id="headline-13">
4d66531 compile &lt;script&gt;<sup>é‡ç‚¹</sup>
</h2>
<div id="outline-text-headline-13" class="outline-text-2">
<p>
è¿™èŠ‚ä¼šæ˜¯é‡ç‚¹éƒ¨åˆ†ã€‚</p>
<p>
<img src="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" alt="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" title="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" /></p>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
init compileScript function
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<p>
åˆå§‹åŒ– <code>compileScript()</code> å‡½æ•°ä»¥åŠå‚æ•°é€‰é¡¹ç±»å‹ <code>SFCScriptCompileOptions</code></p>
<p>
SFCScriptCompileOptions:</p>
<ul>
<li>
<p><code>id: string</code>, ä¼ é€’ç»™ <code>compileStyle</code> ç”¨äºä½œä¸º injected CSS å˜é‡å‰ç¼€ç”¨</p>
</li>
<li>
<p><code>isProd?: boolean</code> å†³å®šç”Ÿæˆçš„ CSS å˜é‡æ˜¯å¦è¦åŠ ä¸Š hash å€¼</p>
</li>
<li>
<p><code>babelParserPlugins?: ParserPlugin[]</code></p>
</li>
<li>
<p><code>refSugar?: boolean</code> ä½¿èƒ½ <code>ref</code> è¯­æ³•ç³–</p>
</li>
<li>
<p><code>inlineTemplate?: boolean</code> å†…è”æ¨¡æ¿ï¼Ÿï¼Ÿï¼Ÿ</p>
</li>
</ul>
<p>
compileScript:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> * Compile `&lt;script setup&gt;`
</span><span class="cm"> * It requires the whole SFC descriptor because we need to handle and merge
</span><span class="cm"> * normal `&lt;script&gt;` + `&lt;script setup&gt;` if both are present.
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">compileScript</span><span class="p">(</span>
  <span class="nx">sfc</span>: <span class="kt">SFCDescriptor</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">SFCScriptCompileOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">SFCScriptBlock</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">SFCScriptBlock</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/54ea72a4fd3d2ccdce268714f0ef205fa9e9b976">feat(add): sfc-&gt;script, compileScript steps comment Â·
gcclll/stb-vue-next@54ea72a</a></p>
<p>
åˆ—å‡º compileScript() å°†è¦å®Œæˆçš„ä»»åŠ¡ï¼š</p>
<table>
<thead>
<tr>
<th class="align-right">No.</th>
<th>Desc</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="align-right">0</td>
<td>å‰ç½®å¤„ç†</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">1</td>
<td>å¤„ç†å­˜åœ¨çš„ &lt;script&gt; ä»£ç ä½“</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">2</td>
<td>è§£æ &lt;script setup&gt;ï¼Œéå†ç½®é¡¶çš„è¯­å¥</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">3</td>
<td>å°† refè®¿é—®è½¬æ¢æˆå¯¹ ref.value çš„å¼•ç”¨</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">4</td>
<td>é‡Šæ”¾ setup ä¸Šä¸‹æ–‡ç±»å‹çš„è¿è¡Œæ—¶ props/emits ä»£ç </td>
<td>-</td>
</tr>
<tr>
<td class="align-right">5</td>
<td>æ£€æŸ¥ç”¨æˆ·é€‰é¡¹(useOptions)å‚æ•°ï¼Œç¡®ä¿å®ƒæ²¡æœ‰å¼•ç”¨ setup ä¸‹çš„å˜é‡</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">6</td>
<td>åˆ é™¤ non-script çš„å†…å®¹</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">7</td>
<td>åˆ†æ binding metadata</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">8</td>
<td>æ³¨å…¥ `useCssVars` è°ƒç”¨</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">9</td>
<td>å®Œæˆ setup() å‚æ•°ç­¾å</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">10</td>
<td>ç”Ÿæˆè¿”å›è¯­å¥(return)</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">11</td>
<td>å®Œæˆ default export</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">12</td>
<td>å®Œæˆ Vue helpers imports</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>
æ¥ä¸‹æ¥å°±æ˜¯æŒ‰ç…§ä¸Šè¡¨çš„æ­¥éª¤æ¥ä¸€æ­¥æ­¥å®Œæˆ <code>compileScript()</code></p>
<blockquote>
<p>PS. ä¸‹é¢æ¯ä¸ªå¯¹åº”ç« èŠ‚éƒ½æœ‰å¯¹åº”çš„åŸç‰ˆè‹±æ–‡æ³¨é‡Šï¼Œè‹±è¯­ä¸å¥½~~~~~ã€‚</p>
</blockquote>
<p>
å¢åŠ ä¸€äº›é€»è¾‘æ— å…³çš„å˜é‡å£°æ˜ï¼š
<a href="https://github.com/gcclll/stb-vue-next/commit/06f1d95b352452cd2f3999e431b2a2bf60dc37c4">feat(add): sfc-&gt;script compileScript declarations Â· gcclll/stb-vue-next@06f1d95</a></p>
<p>
åœ¨è¿›å…¥æ­£å¼æ­¥éª¤ä¹‹å‰ï¼Œæ¥ç®€å•çœ‹çœ‹ä½¿ç”¨åˆ°çš„ <code>@babel/parser</code> è¿™ä¸ªæ’ä»¶æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œè¾“
å‡ºç»“æœåˆæ˜¯å•¥ï¼Ÿ</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BABEL_DIR</span> <span class="o">+</span> <span class="s1">&#39;/parser/lib/index.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
<span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">import { a } from &#39;./a.js&#39;;
</span><span class="sb">
</span><span class="sb">const value = 1 * 10 + 100 - 20 / 30 + 1
</span><span class="sb">export const name = a.getName();
</span><span class="sb">
</span><span class="sb">export default { name }
</span><span class="sb">`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">body</span> <span class="p">=&gt;</span> <span class="nx">body</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
ImportDeclaration
VariableDeclaration
ExportNamedDeclaration
ExportDefaultDeclaration
undefined
</pre>
<p>
ä»¥ä¸Šè¾“å‡ºæ˜¯æ¯ä¸ªè¯­å¥åœ¨ parser ä¸­å¯¹åº”çš„ AST ç±»å‹ã€‚</p>
</div>
</div>
<div id="outline-container-script-0" class="outline-3">
<h3 id="script-0">
0âƒ£ d7369ae æ—  &lt;script setup&gt; æ—¶
</h3>
<div id="outline-text-script-0" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d7369ae572e45ea9f6f32aa6bdfe534b1f5dda39">feat(add): script without setup-script parse Â· gcclll/stb-vue-next@d7369ae</a></p>
<p>
ä¸€å¼€å§‹ä¼šæ£€æµ‹æœ‰æ²¡æœ‰ <code>script setup</code> å¦‚æœæ²¡æœ‰ï¼Œç»§ç»­æ£€æµ‹ <code>&lt;script&gt;</code> æ™®é€šæ ‡ç­¾ï¼Œå¦‚æœä¸¤
è€…éƒ½ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>
å¦‚æœ <code>&lt;script&gt;</code> å­˜åœ¨ï¼Œåˆ™ç›´æ¥è°ƒç”¨ <code>@babel/parser</code> çš„ <a href="https://babeljs.io/docs/en/babel-parser#babelparserparsecode-options">parse</a> å‡½æ•°è¿›è¡Œè§£æï¼Œå› æ­¤åé¢
ä¸€å¨ä»£ç åœ¨è¿™ç§æƒ…å†µä¸‹(åªæœ‰æ™®é€šçš„ <code>script</code> æ—¶)æ˜¯ä¸éœ€è¦çš„ã€‚</p>
<p>
æ–°å¢ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">scriptAst</span> <span class="o">=</span> <span class="nx">_parse</span><span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">plugins</span><span class="p">,</span>
    <span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span>
<span class="p">}).</span><span class="nx">program</span><span class="p">.</span><span class="nx">body</span>
<span class="kr">const</span> <span class="nx">bindings</span> <span class="o">=</span> <span class="nx">analyzeScriptBindings</span><span class="p">(</span><span class="nx">scriptAst</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">needRewrite</span> <span class="o">=</span> <span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">hasInheritAttrsFlag</span>
<span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">content</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">needRewrite</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// TODO need rewrite
</span><span class="c1"></span><span class="p">}</span>
<span class="k">return</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">script</span><span class="p">,</span>
    <span class="nx">content</span><span class="p">,</span>
    <span class="nx">bindings</span><span class="p">,</span>
    <span class="nx">scriptAst</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">import { a } from &#39;./a.js&#39;;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">scriptAst</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
script
 [
  Node {
    type: &#39;ImportDeclaration&#39;,
    start: 1,
    end: 28,
    loc: SourceLocation {
      start: [Position],
      end: [Position],
      filename: undefined,
      identifierName: undefined
    },
    range: undefined,
    leadingComments: undefined,
    trailingComments: undefined,
    innerComments: undefined,
    extra: undefined,
    specifiers: [ [Node] ],
    source: Node {
      type: &#39;StringLiteral&#39;,
      start: 19,
      end: 27,
      loc: [SourceLocation],
      range: undefined,
      leadingComments: undefined,
      trailingComments: undefined,
      innerComments: undefined,
      extra: [Object],
      value: &#39;./a.js&#39;
    }
  }
]
undefined
</pre>
<p>
ç¤ºä¾‹ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">  export default {
</span><span class="sb">    props: [&#39;foo&#39;, &#39;bar&#39;]
</span><span class="sb">  }
</span><span class="sb">&lt;/script&gt;`</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">scriptAst</span><span class="o">:</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="c1">// é¦–å…ˆæ˜¯ä¸ª ExportDefaultDeclaration ç±»å‹
</span><span class="c1">// export çš„å€¼ä¸ºä¸€ä¸ª ObjectExpression ç±»å‹
</span><span class="c1"></span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; &lt;script&gt; è§£æåçš„ç±»å‹`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; export default è§£æåçš„ç±»å‹`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; { props : ... } è§£æåçš„ ast åŒ…å«çš„ keys`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">declaration</span><span class="p">))</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; properties ä¸º ObjectExpression å¯¹è±¡çš„æˆå‘˜åˆ—è¡¨ï¼Œå¦‚ï¼š props`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">elements</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: ç²¾ç®€ä¹‹åçš„è¾“å‡º</p>
<pre class="example">
&gt;&gt;&gt; &lt;script&gt; è§£æåçš„ç±»å‹
script
&gt;&gt;&gt; export default è§£æåçš„ç±»å‹
ExportDefaultDeclaration
&gt;&gt;&gt; { props : ... } è§£æåçš„ ast åŒ…å«çš„ keys
[
  &#39;type&#39;,
  &#39;start&#39;,
  &#39;end&#39;,
  &#39;loc&#39;,
  &#39;range&#39;,
  &#39;leadingComments&#39;,
  &#39;trailingComments&#39;,
  &#39;innerComments&#39;,
  &#39;extra&#39;,
  &#39;properties&#39;
]
&gt; properties ä¸º ObjectExpression å¯¹è±¡çš„æˆå‘˜åˆ—è¡¨ï¼Œå¦‚ï¼š props
{
  type: &#39;ObjectProperty&#39;,
  key: Node {
    type: &#39;Identifier&#39;,
    name: &#39;props&#39;
  },
  value: Node {
    type: &#39;ArrayExpression&#39;,
    elements: [ [Node], [Node] ]
  }
}
[
  Node {
    type: &#39;StringLiteral&#39;,
    extra: { rawValue: &#39;foo&#39;, raw: &#34;&#39;foo&#39;&#34; },
    value: &#39;foo&#39;
  },
  Node {
    type: &#39;StringLiteral&#39;,
    extra: { rawValue: &#39;bar&#39;, raw: &#34;&#39;bar&#39;&#34; },
    value: &#39;bar&#39;
  }
]
</pre>
</div>
</div>
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
819a413 export default {} è§£æ
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/819a413020da1584de0c73b7f67ed0aec0d9cb86">feat(add): sfc-&gt;script, parse export default members into bindings Â· gcclll/stb-vue-next@819a413</a></p>
<p>
<code>(property.type === &#39;ObjectMethod&#39; &amp;&amp;property.key.type === &#39;Identifier&#39; &amp;&amp;(property.key.name === &#39;setup&#39; || property.key.name === &#39;data&#39;))</code></p>
<p>
æˆå‘˜æœ€ååœ¨ <code>bindings</code> é‡Œé¢å­˜åœ¨ç±»å‹å€¼ï¼š</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type(<code>BindingTypes</code>)</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>props</code></td>
<td>&#39;PROPS&#39;</td>
<td>&#39;props&#39;</td>
</tr>
<tr>
<td><code>inject</code></td>
<td>&#39;PROPS&#39;</td>
<td>&#39;props&#39;</td>
</tr>
<tr>
<td><code>computed</code></td>
<td>&#39;OPTIONS&#39;</td>
<td>&#39;options&#39;</td>
</tr>
<tr>
<td><code>methods</code></td>
<td>&#39;OPTIONS&#39;</td>
<td>&#39;options&#39;</td>
</tr>
</tbody>
<tbody>
<tr>
<td><code>setup</code></td>
<td>SETUP_MAYBE_REF</td>
<td>&#39;setup-maybe-ref&#39;</td>
</tr>
<tr>
<td><code>data</code></td>
<td>SETUP_MAYBE_REF</td>
<td>&#39;setup-maybe-ref&#39;</td>
</tr>
</tbody>
</table>
<p>
åˆ°è¿™é‡Œè¿˜åªæ˜¯å€ŸåŠ© <code>@babel/parser</code> è¿›è¡Œäº†è§£æï¼Œvue è‡ªèº«çš„ä¸€äº›ç‰¹æ€§å¤„ç†åœ¨
<code>analyzeScriptBindings()</code> ä¸­ï¼Œè¿™ä¸ªå‡½æ•°è§£æçš„ç±»å‹æ˜¯ <code>ExportDefaultDeclaration</code> ä¹Ÿ
å°±æ˜¯ <code>export default {}</code> çš„ä»£ç éƒ¨åˆ†ã€‚</p>
<p>
ç„¶åè°ƒç”¨ <code>analyzeBindingsFromOptions(node.declaration)</code> è§£æå¯¹è±¡æˆå‘˜ï¼Œè¿™é‡Œè¦å¤„ç†
çš„ä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ol>
<li>
<p><code>ObjectProperty</code> å±æ€§ç±»å‹æˆå‘˜</p>
<p>
<code>(property.type === &#39;ObjectProperty&#39; &amp;&amp;!property.computed &amp;&amp;property.key.type === &#39;Identifier&#39;)</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span>
<span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default {
</span><span class="sb"> props: [&#39;firstName&#39;, &#39;secondName&#39;],
</span><span class="sb"> inject: { foo: {} },
</span><span class="sb"> computed: {
</span><span class="sb">   fullName() {
</span><span class="sb">     return this.firstName + this.secondName + this.thirdName
</span><span class="sb">   }
</span><span class="sb"> },
</span><span class="sb"> methods: {
</span><span class="sb">   getName() {
</span><span class="sb">     return this.fullName
</span><span class="sb">   }
</span><span class="sb"> }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  firstName: &#39;props&#39;,
  secondName: &#39;props&#39;,
  foo: &#39;options&#39;,
  fullName: &#39;options&#39;,
  getName: &#39;options&#39;
}
undefined
</pre>
</li>
<li>
<p><code>ObjectMethod</code> æ–¹æ³•ç±»å‹æˆå‘˜ï¼Œä¸”åªå¤„ç† <code>setup</code> å’Œ <code>data</code> æ–¹æ³•</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c7b617bdad949c6db98ab6eb71caa00dbc7dec26">feat(add): sfc-&gt;script, parse export default data&amp;setup into bingdings Â· gcclll/stb-vue-next@c7b617b</a></p>
<p>
éœ€è¦å¢åŠ ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span>
   <span class="nx">property</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ObjectMethod&#39;</span> <span class="o">&amp;&amp;</span>
   <span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;Identifier&#39;</span> <span class="o">&amp;&amp;</span>
   <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;setup&#39;</span> <span class="o">||</span> <span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
 <span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">bodyItem</span> <span class="k">of</span> <span class="nx">property</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// setup() {
</span><span class="c1"></span>     <span class="c1">//   return {
</span><span class="c1"></span>     <span class="c1">//     foo: null
</span><span class="c1"></span>     <span class="c1">//   }
</span><span class="c1"></span>     <span class="c1">// }
</span><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span>
       <span class="nx">bodyItem</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ReturnStatement&#39;</span> <span class="o">&amp;&amp;</span>
       <span class="nx">bodyItem</span><span class="p">.</span><span class="nx">argument</span> <span class="o">&amp;&amp;</span>
       <span class="nx">bodyItem</span><span class="p">.</span><span class="nx">argument</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ObjectExpression&#39;</span>
     <span class="p">)</span> <span class="p">{</span>
       <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">getObjectExpressionKeys</span><span class="p">(</span><span class="nx">bodyItem</span><span class="p">.</span><span class="nx">argument</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">bindings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>
           <span class="o">?</span> <span class="nx">BindingTypes.SETUP_MAYBE_REF</span>
           : <span class="kt">BindingTypes.DATA</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span>
<span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default {
</span><span class="sb">setup() {
</span><span class="sb"> return {
</span><span class="sb">   foo: null
</span><span class="sb"> }
</span><span class="sb">},
</span><span class="sb">data() {
</span><span class="sb"> return {
</span><span class="sb">   bar: null
</span><span class="sb"> }
</span><span class="sb">},
</span><span class="sb">props: [&#39;baz&#39;]
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{ foo: &#39;setup-maybe-ref&#39;, bar: &#39;setup-maybe-ref&#39;, baz: &#39;props&#39; }
undefined
</pre>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-17" class="outline-3">
<h3 id="headline-17">
æµ‹è¯•
</h3>
<div id="outline-text-headline-17" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span>
  <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; setup return`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">const bar = 2
</span><span class="sb">  export default {
</span><span class="sb">    setup() {
</span><span class="sb">    return {
</span><span class="sb">        foo: 1,
</span><span class="sb">        bar
</span><span class="sb">    }
</span><span class="sb">  }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; async setup return`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">const bar = 2
</span><span class="sb">  export default {
</span><span class="sb">    async setup() {
</span><span class="sb">      return {
</span><span class="sb">        foo: 1,
</span><span class="sb">        bar
</span><span class="sb">      }
</span><span class="sb">  }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; computeds`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">    &lt;script&gt;
</span><span class="sb">    export default {
</span><span class="sb">      computed: {
</span><span class="sb">        foo() {},
</span><span class="sb">        bar: {
</span><span class="sb">            get() {},
</span><span class="sb">            set() {},
</span><span class="sb">        }
</span><span class="sb">      }
</span><span class="sb">    }
</span><span class="sb">    &lt;/script&gt;
</span><span class="sb">`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; æ··åˆ bindings`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">    &lt;script&gt;
</span><span class="sb">    export default {
</span><span class="sb">      inject: [&#39;foo&#39;],
</span><span class="sb">        props: {
</span><span class="sb">        bar: String,
</span><span class="sb">      },
</span><span class="sb">      setup() {
</span><span class="sb">        return {
</span><span class="sb">            baz: null,
</span><span class="sb">        }
</span><span class="sb">      },
</span><span class="sb">      data() {
</span><span class="sb">        return {
</span><span class="sb">            qux: null
</span><span class="sb">        }
</span><span class="sb">      },
</span><span class="sb">      methods: {
</span><span class="sb">        quux() {}
</span><span class="sb">      },
</span><span class="sb">      computed: {
</span><span class="sb">        quuz() {}
</span><span class="sb">      }
</span><span class="sb">    }
</span><span class="sb">    &lt;/script&gt;
</span><span class="sb">`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
1âƒ£ eb650ca è§£æ &lt;script&gt;
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/eb650ca301b2e27f47ad53aa5ff8f16b3161b3f9">feat(add): sfc-&gt;script, export default handle Â· gcclll/stb-vue-next@eb650ca</a></p>
<div class="comment-block">
<p>process normal &lt;script&gt; first if it exists</p>
</div>
<p>
ç”¨åˆ°çš„æ’ä»¶ï¼š</p>
<table>
<thead>
<tr>
<th>Plugin</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://babeljs.io/docs/en/babel-parser">@babel/parser Â· Babel</a></td>
</tr>
</tbody>
</table>
<p>
è¿™ä¸€èŠ‚ä¸­çš„æ™®é€š &lt;script&gt; å‰ææ˜¯ï¼Œè‡³å°‘æœ‰ä¸€ä¸ª <code>&lt;script setup&gt;</code> å­˜åœ¨ï¼Œå¦åˆ™ä¼šç›´æ¥åœ¨
<a href="#script-0">ä¸Šä¸€èŠ‚</a> å°±é€€å‡ºè§£æäº†ã€‚</p>
<p>
@babel/parser è§£æ import ç»“æœå¯¹ç…§è¡¨</p>
<table>
<thead>
<tr>
<th>æ®µ</th>
<th>ç±»å‹</th>
<th>å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>import { a } from &#39;./x&#39;</code></td>
<td><code>ImportDeclaration</code></td>
<td>â€¦</td>
</tr>
<tr>
<td><code>a</code></td>
<td><code>ImportSpecifier</code></td>
<td><code>node.specifiers[i].imported.name</code></td>
</tr>
<tr>
<td><code>&#39;./x&#39;</code></td>
<td><code>StringLiteral</code></td>
<td><code>node.source.value</code></td>
</tr>
</tbody>
</table>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BABEL_DIR</span> <span class="o">+</span> <span class="s1">&#39;/parser/lib/index.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">import { a } from &#39;./x&#39;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span> <span class="p">}).</span><span class="nx">program</span><span class="p">.</span><span class="nx">body</span>
<span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">spec</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; node type &gt; </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; node source type &gt; </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; node source value &gt; </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; spec type &gt; </span><span class="si">${</span><span class="nx">spec</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; spec imported type &gt; </span><span class="si">${</span><span class="nx">spec</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; spec imported name &gt; </span><span class="si">${</span><span class="nx">spec</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; node type &gt; ImportDeclaration
&gt;&gt;&gt; node source type &gt; StringLiteral
&gt;&gt;&gt; node source value &gt; ./x
&gt;&gt;&gt; spec type &gt; ImportSpecifier
&gt;&gt;&gt; spec imported type &gt; Identifier
&gt;&gt;&gt; spec imported name &gt; a
</pre>
<p>
æ‰€ä»¥ vue-next ä¸­æ–°å¢çš„ä»£ç å¤„ç†é€»è¾‘ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// import ... from &#39;./x&#39; è¯­å¥ç±»å‹
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ImportDeclaration&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// record imports for dedupe
</span><span class="c1"></span>  <span class="c1">// import è¿›æ¥çš„å˜é‡åˆ—è¡¨
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">specifier</span> <span class="k">of</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å˜é‡å
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">imported</span> <span class="o">=</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ImportSpecifier&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;Identifier&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span>
    <span class="c1">// æ³¨å†Œåˆ° userImports[local] = { isType, imported, source } ä¸­
</span><span class="c1"></span>    <span class="nx">registerUserImport</span><span class="p">(</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="nx">imported</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">importKind</span> <span class="o">===</span> <span class="s1">&#39;type&#39;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç„¶å compileScript ä¸­æœ‰ä¸€æ®µå¤„ç†ä¸æ˜ç™½ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">scriptSetup</span> <span class="o">&amp;&amp;</span> <span class="nx">scriptSetupLang</span> <span class="o">!==</span> <span class="s1">&#39;ts&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do not process non js/ts script blocks
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">scriptSetup</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œæ˜¯è¯´å¦‚æœæœ‰ <code>&lt;script setup&gt;</code> ä½†æ˜¯ç±»å‹ä¸æ˜¯ <strong>ts</strong> å°±ç›´æ¥è¿”å› <code>scriptSetup</code> ?</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span>
  <span class="s2">&#34;/dist/compiler-sfc.cjs.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/utils.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;xxxx&#34;</span> <span class="p">});</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">import { a, a1, a2 } from &#39;./a&#39;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;
</span><span class="sb">import { b } from &#39;./b&#39;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
handling script ... with setup
userImports &gt;
 [Object: null prototype] {
  a: { isType: false, imported: &#39;a&#39;, source: &#39;./a&#39; },
  a1: { isType: false, imported: &#39;a1&#39;, source: &#39;./a&#39; },
  a2: { isType: false, imported: &#39;a2&#39;, source: &#39;./a&#39; }
}
userImportAlias &gt;
 [Object: null prototype] {}
undefined
</pre>
<p>
åˆ°æ­¤ï¼Œå› ä¸ºè¿˜æ²¡å®ç° <code>&lt;script setup&gt;</code> è§£æï¼Œæ‰€ä»¥åªèƒ½çœ‹åˆ°æ™®é€š script æ ‡ç­¾çš„å¤„ç†ç»“æœã€‚</p>
<div id="outline-container-headline-19" class="outline-4">
<h4 id="headline-19">
import â€¦ from å¤„ç†
</h4>
<div id="outline-text-headline-19" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">node</span> <span class="k">of</span> <span class="nx">scriptAst</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// import ... from &#39;...&#39;
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ImportDeclaration&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// record imports for dedupe
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">specifier</span> <span class="k">of</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">imported</span> <span class="o">=</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ImportSpecifier&#34;</span> <span class="o">&amp;&amp;</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;Identifier&#34;</span> <span class="o">&amp;&amp;</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">registerUserImport</span><span class="p">(</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">imported</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">importKind</span> <span class="o">===</span> <span class="s2">&#34;type&#34;</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;userImports &gt; \n&#34;</span><span class="p">,</span> <span class="nx">userImports</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;userImportAlias &gt; \n&#34;</span><span class="p">,</span> <span class="nx">userImportAlias</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¸Šé¢å¤„ç†ï¼šéå† script ä¸­æ‰€æœ‰ ast èŠ‚ç‚¹ï¼Œæ‰¾å‡º <code>import ... from ...</code> è¯­å¥ï¼Œå–å‡º</p>
<p>
å¼•å…¥çš„æ–‡ä»¶æºéƒ¨åˆ†ï¼š <code>node.source.value</code></p>
<p>
å¼•å…¥ä¹‹åçš„å˜é‡æˆ–è§£æ„åçš„å˜é‡ï¼š <code>imported.name</code></p>
<p>
ç»„æˆæ–°çš„ç»“æ„ <code>{ isType: false, imported: &#39;a&#39;, source: &#39;./a&#39;}</code> ä¿å­˜åˆ° <code>userImports</code> ä¸­</p>
<p>
ä¿®æ”¹ä¸‹ï¼Œå¼•å…¥å¤šä¸ªå˜é‡å‘¢ï¼Ÿç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="example">
userImports &gt;
 [Object: null prototype] {
  a: { isType: false, imported: &#39;a&#39;, source: &#39;./a&#39; },
  a1: { isType: false, imported: &#39;a1&#39;, source: &#39;./a&#39; },
  a2: { isType: false, imported: &#39;a2&#39;, source: &#39;./a&#39; }
</pre>
<p>
æ¯ä¸ªå˜é‡ä½œä¸ºä¸€é¡¹ä¿å­˜ã€‚</p>
</div>
</div>
<div id="outline-container-headline-20" class="outline-4">
<h4 id="headline-20">
export default {} å¤„ç†
</h4>
<div id="outline-text-headline-20" class="outline-text-4">
<p>
<code>export default {}</code> è¯­æ³•çš„å¤„ç†ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/* else */</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ExportDefaultDeclaration&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// export default
</span><span class="c1"></span>  <span class="nx">defaultExport</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span><span class="p">;</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">overwrite</span><span class="p">(</span>
    <span class="nx">start</span><span class="p">,</span>
    <span class="nx">start</span> <span class="o">+</span> <span class="sb">`export default`</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="sb">`const </span><span class="si">${</span><span class="nx">defaultTempVar</span><span class="si">}</span><span class="sb"> =`</span>
  <span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å˜é‡ <code>s</code> :</p>
<p>
<code>const s = new MagicString(source)</code></p>
<p>
ç­‰äºæ˜¯å°† export default å†…å®¹èµ‹å€¼ç»™ <code>__default__</code> å˜é‡ä¸Šã€‚</p>
<p>
<code>export default {...}</code> å¤„ç†æˆ <code>const __default__ =</code></p>
<p>
<a href="https://github.com/Rich-Harris/magic-string">GitHub - Rich-Harris/magic-string: Manipulate strings like a wizard</a></p>
<p>
ä»ä»“åº“ä»‹ç»:</p>
<blockquote>
<p>Suppose you have some source code. You want to make some light modifications to it - replacing a few characters here and thereâ€¦</p>
</blockquote>
<p>è¿™ä¸ªåº“çš„ä½œç”¨æ˜¯ç”¨æ¥æ›¿æ¢æºç ä¸­çš„éƒ¨åˆ†ä»£ç çš„(å­—ç¬¦ä¸²çš„ä¸€äº›æ“ä½œ)ã€‚</p>
<p>
å…ˆçœ‹æµ‹è¯•å§ï¼šè¾“å‡ºå¤„ç†å‰åçš„ <code>source -&gt; s</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">[</span><span class="nx">result</span><span class="p">]</span> <span class="o">=</span> <span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">export default {
</span><span class="sb">  data() {},
</span><span class="sb">  computed: {}
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;
</span><span class="sb">export default {}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
handling script ... with setup
----- before -----
&lt;script lang=&#34;ts&#34;&gt;
export default {
  data() {},
  computed: {}
}
&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;
export default {}
&lt;/script&gt;

----- after -----
&lt;script lang=&#34;ts&#34;&gt;
const __default__ = {
  data() {},
  computed: {}
}
&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;
export default {}
&lt;/script&gt;

undefined
</pre>
<p>
ç»“æœå¦‚ä¸Šã€‚</p>
<blockquote>
<p>Tip: è¯·å¿½ç•¥ setup éƒ¨åˆ†ï¼Œå› ä¸ºå¿…é¡»è¦æœ‰ä¸€ä¸ª <code>&lt;script setup&gt;</code> ä¸”å¿…é¡»æ˜¯ <strong>ts</strong> è¯­è¨€æ‰èƒ½è¿›
å…¥åˆ°è¿™éƒ¨åˆ†å¤„ç†ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-21" class="outline-4">
<h4 id="headline-21">
export â€¦ [from] å¤„ç†
</h4>
<div id="outline-text-headline-21" class="outline-text-4">
<p>
<code>export { ...} from &#39;...&#39;</code> çš„å¤„ç†ã€‚</p>
<p>
å¦‚ï¼š</p>
<p>
<code>export { x as default } from &#39;./x&#39;</code></p>
<p>
<code>export { x as default }</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/*else*/</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ExportNamedDeclaration&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">defaultSpecifier</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">exported</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;Identifier&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">exported</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;default&#34;</span>
  <span class="p">)</span> <span class="kr">as</span> <span class="nx">ExportSpecifier</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">defaultSpecifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">defaultExport</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
    <span class="c1">// 1. remove specifier
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span>
        <span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span><span class="p">,</span>
        <span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">end</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">end</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// export { x as default } from &#39;./x&#39;
</span><span class="c1"></span>      <span class="c1">// é‡å†™æˆ rewrite to `import { x as __default } from &#39;./x&#39;
</span><span class="c1"></span>      <span class="c1">// ç„¶åæ·»åŠ åˆ°é¡¶éƒ¨
</span><span class="c1"></span>      <span class="nx">s</span><span class="p">.</span><span class="nx">prepend</span><span class="p">(</span>
        <span class="sb">`import { </span><span class="si">${</span><span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb"> as </span><span class="si">${</span><span class="nx">defaultTempVar</span><span class="si">}</span><span class="sb"> } from &#39;</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">&#39;</span><span class="err">\</span><span class="sb">n`</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// export { x as default }
</span><span class="c1"></span>      <span class="c1">// é‡å†™æˆ `const __default__ = x` ä¸”ç§»åˆ°æœ€å
</span><span class="c1"></span>      <span class="nx">s</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="sb">`</span><span class="err">\</span><span class="sb">nconst </span><span class="si">${</span><span class="nx">defaultTempVar</span><span class="si">}</span><span class="sb"> = </span><span class="si">${</span><span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="err">\</span><span class="sb">n`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;export { a as default } from &#39;./x&#39;&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">const a = {}
</span><span class="sb">export { a as default }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
handling script ... with setup
----- s, source, before -----

&lt;script lang=&#34;ts&#34;&gt;export { a as default } from &#39;./x&#39;&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

----- s, source, after -----
import { a as __default__ } from &#39;./x&#39;

&lt;script lang=&#34;ts&#34;&gt;&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

handling script ... with setup
----- s, source, before -----

&lt;script lang=&#34;ts&#34;&gt;
const a = {}
export { a as default }
&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

----- s, source, after -----

&lt;script lang=&#34;ts&#34;&gt;
const a = {}

&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

const __default__ = a

undefined
</pre>
<p>
ä»æ–‡ä»¶å¯¼å…¥çš„ï¼Œæ”¾åˆ° <code>source</code> æœ€å‰é¢å»äº†</p>
<p>
ç”¨å˜é‡å¯¼å‡ºçš„ï¼Œæ”¾åˆ° <code>source</code> æœ€åé¢å»äº†</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
2âƒ£ 8edf0d7 è§£æ &lt;script setup&gt;
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/8edf0d7ad4c77fe9bbb08233f09a313eefa6ca9b">feat(add): sfc-&gt;script, setup ref process Â· gcclll/stb-vue-next@8edf0d7</a></p>
<p>
å¦‚æœåªä¿ç•™å…³é”®ä»£ç ï¼Œè¿™é‡Œçš„å¤„ç†ä¸»è¦åœ¨ <code>processRefExpression()</code> ä¸­</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// @babel/parser è§£æå‡º&lt;script setup&gt; çš„ ast
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">scriptSetupAst</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span>
  <span class="nx">scriptSetup</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">...</span><span class="nx">plugins</span><span class="p">,</span>
      <span class="c1">// allow top level await but only inside &lt;script setup&gt;
</span><span class="c1"></span>      <span class="s2">&#34;topLevelAwait&#34;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="nx">sourceType</span><span class="o">:</span> <span class="s2">&#34;module&#34;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">startOffset</span>
<span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">node</span> <span class="k">of</span> <span class="nx">scriptSetupAst</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ... çœç•¥
</span><span class="c1"></span>  <span class="c1">// å¤„ç† `ref: x` ç»‘å®šï¼Œè½¬æˆ refs
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;LabeledStatement&#34;</span> <span class="o">&amp;&amp;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">label</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;ref&#34;</span> <span class="o">&amp;&amp;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ExpressionStatement&#34;</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å¿…é¡»è¦å¼€å¯ ref åŠŸèƒ½
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">enableRefSugar</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warnExperimental</span><span class="p">(</span><span class="sb">`ref: sugar`</span><span class="p">,</span> <span class="mi">228</span><span class="p">);</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">overwrite</span><span class="p">(</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">label</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">startOffset</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">boy</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">startOffset</span><span class="p">,</span>
        <span class="s2">&#34;const &#34;</span>
      <span class="p">);</span>
      <span class="nx">processRefExpression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¸‹é¢æ˜¯ processRefExpression å¯¹ <code>ref:</code> è¯­æ³•ç³–çš„å„ç§ä½¿ç”¨æƒ…å†µåˆ†æã€‚</p>
<div id="outline-container-headline-23" class="outline-4">
<h4 id="headline-23">
d4f6497 ref: n = 100
</h4>
<div id="outline-text-headline-23" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d4f649729c860bcd7c3305a11258cb4ef2b803a2">feat(add): sfc-&gt;script, ref: in setup Â· gcclll/stb-vue-next@d4f6497</a></p>
<p>
å°† <code>ref: n = 100</code> ç¿»è¯‘æˆ <code>const n = _ref(100)</code></p>
<p>
æ–°å¢æ ¸å¿ƒå¤„ç†ä»£ç ï¼š
<img src="http://qiniu.ii6g.com/img/20201226211608.png" alt="http://qiniu.ii6g.com/img/20201226211608.png" title="http://qiniu.ii6g.com/img/20201226211608.png" /></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">const a = {}
</span><span class="sb">export { a as default }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;
</span><span class="sb">ref: n = 100
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-24" class="outline-4">
<h4 id="headline-24">
db7cb02 ref: { n = 1 } = useFoo()
</h4>
<div id="outline-text-headline-24" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/db7cb021defbc86adb8a2a825315c71359579f27">feat(add): sfc-&gt;script, ref: ({ b: 1} = {}) Â· gcclll/stb-vue-next@db7cb02</a></p>
<p>
å¯¹è±¡è§£æ„è¯­æ³•æ”¯æŒã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default { b: 2 }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({ b = 1, foo: bar, nested: { baz: bax } } = { count: 0, b: 2 })
</span><span class="sb">
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
ref: ({ b = 1, foo: bar, nested: { baz: bax } } = { count: 0, b: 2 })

&lt;/script&gt;

---- after ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
const { b: __b = 1, foo: __bar, nested: { baz: __bax } } = { count: 0, b: 2 }

&lt;/script&gt;

undefined
</pre>
<p>
æ”¯æŒè§£æ„åé‡å‘½åï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/e83d25a6ef9a6c2c3f708169fbd9517c96a87dcd">feat(add): sfc-&gt;script, ref: ({ b: bb} = {}) rename Â· gcclll/stb-vue-next@e83d25a</a></p>
<p>
å¯¹è±¡åµŒå¥—è§£æ„ï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/5c615d5c2905f8a50ec1729da4bde68b709ddc43">feat(add): sfc-&gt;script, ref deconstruct nested object Â· gcclll/stb-vue-next@5c615d5</a></p>
<p>
è§£æ„é‡å‘½åï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/e3ffe6f6cf95748654612cd70855f0818e7757e0">feat(add): sfc-&gt;script, ref deconstruct object rename Â· gcclll/stb-vue-next@e3ffe6f</a></p>
</div>
</div>
<div id="outline-container-headline-25" class="outline-4">
<h4 id="headline-25">
af26553 ref: [a] = useFoo() æ•°æ®è§£æ„
</h4>
<div id="outline-text-headline-25" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/af265536bcba6ad3f154b5b944317e4d38b28b2d">feat(add): sfc-&gt;script, ref deconstruct array Â· gcclll/stb-vue-next@af26553</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default { b: 2 }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({ foo: [bar], baz: [,,bax]} = useFoo())
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
ref: ({ foo: [bar], baz: [,,bax]} = useFoo())
&lt;/script&gt;

---- after ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
const { foo: [__bar], baz: [,,__bax]} = useFoo()
const bar = _ref(__bar);
const bax = _ref(__bax);
&lt;/script&gt;

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-26" class="outline-4">
<h4 id="headline-26">
a9f4469 ref: ({â€¦foo} = useFoo()) å±•å¼€ç¬¦
</h4>
<div id="outline-text-headline-26" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a9f4469f8b47a273b2de5165e59ebd9718f5a07d">feat(add): sfc-&gt;script, ref deconstruct with es6 rest element Â· gcclll/stb-vue-next@a9f4469</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default { b: 2 }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({...foo} = useFoo())
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
ref: ({...fo} = useFoo())
&lt;/script&gt;

---- after ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
const {...__fo} = useFoo()
&lt;/script&gt;

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-27" class="outline-4">
<h4 id="headline-27">
d52a6d0 _ref(â€¦) å¢åŠ  ref å£°æ˜
</h4>
<div id="outline-text-headline-27" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d52a6d006f3a741a4787220a3503572ad576d0ba">feat(add): sfc-&gt;script, ref all variables Â· gcclll/stb-vue-next@d52a6d0</a></p>
<p>
åœ¨è§£æå®Œæ‰€æœ‰ <code>ref: xxx</code> è¯­æ³•ä¹‹åï¼Œéœ€è¦å°†è§£æ„å‡ºæ¥çš„ç¼–ç ï¼Œè¿›è¡Œ ref åŒ–ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;export default {}&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({
</span><span class="sb">  a, b: { foo, bar: bax }, c = 1, d: [doo1,, doo3], e: e1 = 2
</span><span class="sb">} = useFoo());
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
ref: ({
  a, b: { foo, bar: bax }, c = 1, d: [doo1,, doo3], e: e1 = 2
} = useFoo());
&lt;/script&gt;

---- after ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
const {
  a: __a, b: { foo: __foo, bar: __bax }, c: __c = 1, d: [__doo1,, __doo3], e: __e1 = 2
} = useFoo();
const a = _ref(__a);
const foo = _ref(__foo);
const bax = _ref(__bax);
const c = _ref(__c);
const doo1 = _ref(__doo1);
const doo3 = _ref(__doo3);
const e1 = _ref(__e1);
&lt;/script&gt;

undefined
</pre>
<p>
åˆ°è¿™é‡Œ ref è¯­æ³•æ‰ç®—è§£æå®Œæˆäº†ã€‚</p>
<ol>
<li>
<p>å€ŸåŠ© <code>@babel/parser</code> å¾—åˆ° script[setup] ast å¤„ç† ref åŠè§£æ„è¯­æ³•</p>
</li>
<li>
<p>å°†è§£æ„ä¹‹åçš„å˜é‡è¿›è¡Œ ref è¯­æ³•åŒ–ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-28" class="outline-4">
<h4 id="headline-28">
168041c ref: a = 1, b = 2 å¤šæ¡è¯­å¥
</h4>
<div id="outline-text-headline-28" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/168041cafd719477b3904f5e6973547c8eb2fe2e">feat(add): sfc-&gt;script, multiple statements after ref: Â· gcclll/stb-vue-next@168041c</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;export default {}&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: a = 1, b = 2, c = 3
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
ref: a = 1, b = 2, c = 3
&lt;/script&gt;

---- after ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
const a = _ref(1), b = _ref(2), c = _ref(3)
&lt;/script&gt;

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-29" class="outline-4">
<h4 id="headline-29">
6e337c5 imports ç½®é¡¶ğŸ”
</h4>
<div id="outline-text-headline-29" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6e337c59b5c3c87925e1fe7d5efc3a671887c9af">feat(add): sfc-&gt;script, hoist imports to top Â· gcclll/stb-vue-next@6e337c5</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;export default {}&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { a } from &#39;./a&#39;
</span><span class="sb">import { b } from &#39;./b&#39;
</span><span class="sb">import { foo, bar } from &#39;./baz&#39;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- after ----
import { a } from &#39;./a&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- before ----
import { a } from &#39;./a&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- after ----
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- before ----
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- after ----
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
&lt;/script&gt;

undefined
</pre>
<p>
å¦‚ä¸Šï¼Œç»è¿‡å‡ è½®å¾ªç¯ï¼Œå°†ä¸‰ä¸ª import æå‡åˆ°äº†æœ€å¼€å§‹ä½ç½®ã€‚</p>
</div>
</div>
<div id="outline-container-headline-30" class="outline-4">
<h4 id="headline-30">
<span class="todo">TODO</span>
68d4940 defineProps/Emit() å¤„ç†
</h4>
<div id="outline-text-headline-30" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/68d4940a2725e809ab731a6998bc7b72e1131907">feat(add): sfc-&gt;script, defineProps/Emit Â· gcclll/stb-vue-next@68d4940</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span><span class="nx">content</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup lang=&#34;ts&#34;&gt;
</span><span class="sb">import { defineProps } from &#39;vue&#39;
</span><span class="sb">interface Test {}
</span><span class="sb">
</span><span class="sb">type Alias = number[]
</span><span class="sb">
</span><span class="sb">defineProps&lt;{
</span><span class="sb">string: string
</span><span class="sb">number: number
</span><span class="sb">boolean: boolean
</span><span class="sb">object: object
</span><span class="sb">objectLiteral: { a: number }
</span><span class="sb">fn: (n: number) =&gt; void
</span><span class="sb">functionRef: Function
</span><span class="sb">objectRef: Object
</span><span class="sb">array: string[]
</span><span class="sb">arrayRef: Array&lt;any&gt;
</span><span class="sb">tuple: [number, number]
</span><span class="sb">set: Set&lt;string&gt;
</span><span class="sb">literal: &#39;foo&#39;
</span><span class="sb">optional?: any
</span><span class="sb">recordRef: Record&lt;string, null&gt;
</span><span class="sb">interface: Test
</span><span class="sb">alias: Alias
</span><span class="sb">
</span><span class="sb">union: string | number
</span><span class="sb">literalUnion: &#39;foo&#39; | &#39;bar&#39;
</span><span class="sb">literalUnionMixed: &#39;foo&#39; | 1 | boolean
</span><span class="sb">intersection: Test &amp; {}
</span><span class="sb">}&gt;()
</span><span class="sb">&lt;/script&gt;`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-31" class="outline-3">
<h3 id="headline-31">
3âƒ£ 5160a6d ref -&gt; ref.value
</h3>
<div id="outline-text-headline-31" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/5160a6db9b1ab4eb8e0aae9adc0c4bbec6e44fa8">feat(add): sfc-&gt;script, ref -&gt; ref.value Â· gcclll/stb-vue-next@5160a6d</a></p>
<p>
å°†å¯¹ ref å˜é‡çš„è®¿é—®è½¬æˆå¯¹ <code>ref.value</code> çš„è®¿é—®ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">compile</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span>
  <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: a = 1
</span><span class="sb">console.log(a)
</span><span class="sb">function get() {
</span><span class="sb">  return a + 1
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span>
<span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  enableRefSugar: true,
  refBindings: [Object: null prototype] { a: &#39;setup-ref&#39; }
}
&lt;script setup&gt;
const a = _ref(1)
console.log(a.value)
function get() {
  return a.value + 1
}
&lt;/script&gt;
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-32" class="outline-3">
<h3 id="headline-32">
<span class="todo">TODO</span>
4âƒ£ a6f4dae extract define props/emits
</h3>
<div id="outline-text-headline-32" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a6f4dae87de524a4d9da3d375a001c8d67bffdaa">feat(add): sfc-&gt;script, extract props/emits Â· gcclll/stb-vue-next@a6f4dae</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
ExpressionStatement --
undefined {} xx

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-33" class="outline-3">
<h3 id="headline-33">
<span class="todo">TODO</span>
5âƒ£ 480acf0 checkInvalidScopeReference
</h3>
<div id="outline-text-headline-33" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/480acf01e9febdd804b39b580b572d19cc105a50">feat(add): sfc-&gt;script, check invalid scope references Â·
gcclll/stb-vue-next@480acf0</a></p>
<p>
æ£€æŸ¥ <code>useOptions</code> ï¼Œæ˜¯å¦åŒ…å« <code>&lt;setup&gt;</code> ä¸­å·²ç»å­˜åœ¨çš„å˜é‡ï¼Œå³ <code>useOptions</code> ä¸­ä¸èƒ½
æœ‰ setup ä¸­å£°æ˜çš„å˜é‡ã€‚</p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-3">
<h3 id="headline-34">
<span class="todo">TODO</span>
6âƒ£ 25662c6 åˆ é™¤é script å†…å®¹
</h3>
<div id="outline-text-headline-34" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/25662c6ea1a85076bfcd8b13e130063cb248b58f">feat(add): sfc-&gt;script, delete non-script content Â· gcclll/stb-vue-next@25662c6</a></p>
</div>
</div>
<div id="outline-container-headline-35" class="outline-3">
<h3 id="headline-35">
7âƒ£ deed8c1 analyze binding metadata(bindingMetadata)
</h3>
<div id="outline-text-headline-35" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/deed8c1e21d2ccf63c6174032b66669975d4aa6f">feat(add): sfc-&gt;script, analyze binding metadata Â· gcclll/stb-vue-next@deed8c1</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">const props = defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">ref: a = 1
</span><span class="sb">const b = 2
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">bindings</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  foo: &#39;props&#39;,
  props: &#39;setup-const&#39;,
  a: &#39;setup-ref&#39;,
  b: &#39;setup-const&#39;
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-36" class="outline-3">
<h3 id="headline-36">
8âƒ£ 9cd2fd5 inject useCssVars, css å˜é‡å¤„ç†
</h3>
<div id="outline-text-headline-36" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9cd2fd504a86e4b6a3484f00151a24ef7f719323">feat(add): sfc-&gt;script, inject useCssVars Â· gcclll/stb-vue-next@9cd2fd5</a></p>
<div id="outline-container-headline-37" class="outline-4">
<h4 id="headline-37">
&lt;style&gt; v-bind css å˜é‡
</h4>
<div id="outline-text-headline-37" class="outline-text-4">
<p>
å¤„ç† style ä¸­ä½¿ç”¨çš„ css å˜é‡</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// compileScript.ts
</span><span class="c1">// TODO 8. æ³¨å…¥ `useCssVars` è°ƒç”¨
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">helperImports</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">CSS_VARS_HELPER</span><span class="p">)</span>
    <span class="nx">helperImports</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;unref&#39;</span><span class="p">)</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">prependRight</span><span class="p">(</span>
      <span class="nx">startOffset</span><span class="p">,</span>
      <span class="sb">`</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="nx">genCssVarsCode</span><span class="p">(</span>
        <span class="nx">cssVars</span><span class="p">,</span>
        <span class="nx">bindingMetadata</span><span class="p">,</span>
        <span class="nx">scopeId</span><span class="p">,</span>
        <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isProd</span>
      <span class="p">)</span><span class="si">}</span><span class="err">\</span><span class="sb">n`</span>
    <span class="p">)</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;const a = 1&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineProps, ref } from &#39;vue&#39;
</span><span class="sb">const color = &#39;red&#39;
</span><span class="sb">const height = ref(&#39;10px&#39;)
</span><span class="sb">defineProps({
</span><span class="sb">  foo: Striing
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">div {
</span><span class="sb">  color: v-bind(color);
</span><span class="sb">  font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">  height: v-bind(height);
</span><span class="sb">  border: v-bind(foo)
</span><span class="sb">}
</span><span class="sb">&lt;/style&gt;
</span><span class="sb">`</span><span class="p">);</span>
<span class="c1">// 1. æœ¬åœ°å˜é‡ç»‘å®š
</span><span class="c1">// 2. æœ¬åœ° ref ç»‘å®š
</span><span class="c1">// 3. props ç»‘å®š
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { ref } from &#39;vue&#39;
const a = 1
_useCssVars(_ctx =&gt; ({
  &#34;xxxxxxxx-color&#34;: (color),
  &#34;xxxxxxxx-font_size&#34;: (_ctx.font.size),
  &#34;xxxxxxxx-height&#34;: (height.value),
  &#34;xxxxxxxx-foo&#34;: (__props.foo)
}))

const color = &#39;red&#39;
const height = ref(&#39;10px&#39;)
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-38" class="outline-4">
<h4 id="headline-38">
css å˜é‡é‡å†™ï¼š
</h4>
<div id="outline-text-headline-38" class="outline-text-4">
<p>
æºç å¤„ç†ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">needRewrite</span> <span class="o">=</span> <span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">hasInheritAttrsFlag</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">needRewrite</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">rewriteDefault</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="sb">`__default__`</span><span class="p">,</span> <span class="nx">plugins</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">+=</span> <span class="nx">genNormalScriptCssVarsCode</span><span class="p">(</span>
      <span class="nx">cssVars</span><span class="p">,</span>
      <span class="nx">bindings</span><span class="p">,</span>
      <span class="nx">scopeId</span><span class="p">,</span>
      <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isProd</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">hasInheritAttrsFlag</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`__default__.inheritAttrs = false`</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`</span><span class="err">\</span><span class="sb">nexport default __default__`</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compileStyle</span><span class="p">({</span>
  <span class="nx">source</span><span class="o">:</span> <span class="sb">`.foo {
</span><span class="sb">    color: v-bind(color);
</span><span class="sb">    font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">  }`</span><span class="p">,</span>
  <span class="nx">filename</span><span class="o">:</span> <span class="s2">&#34;test.css&#34;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;data-v-test&#34;</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
.foo {
    color: var(--test-color);
    font-size: var(--test-font_size);
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-39" class="outline-4">
<h4 id="headline-39">
isProd option ä½¿ç”¨ hash å˜é‡å
</h4>
<div id="outline-text-headline-39" class="outline-text-4">
<p>
ç”Ÿäº§æ¨¡å¼ï¼Œä½¿ç”¨éšæœº hash å€¼ä½œä¸ºåå­—ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// cssVars.ts
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">genVarName</span><span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">raw</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">isProd</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isProd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">id</span> <span class="o">+</span> <span class="nx">raw</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sb">`</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">raw</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^\w-])/g</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span>
  <span class="sb">`&lt;script&gt;const a = 1&lt;/script&gt;\n`</span> <span class="o">+</span>
    <span class="sb">`&lt;style&gt;div{
</span><span class="sb">          color: v-bind(color);
</span><span class="sb">          font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">        }&lt;/style&gt;`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">isProd</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const a = 1
const __default__ = {}
import { useCssVars as _useCssVars } from &#39;vue&#39;
const __injectCSSVars__ = () =&gt; {
_useCssVars(_ctx =&gt; ({
  &#34;4003f1a6&#34;: (_ctx.color),
  &#34;41b6490a&#34;: (_ctx.font.size)
}))}
const __setup__ = __default__.setup
__default__.setup = __setup__
  ? (props, ctx) =&gt; { __injectCSSVars__();return __setup__(props, ctx) }
  : __injectCSSVars__

export default __default__
undefined
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-40" class="outline-3">
<h3 id="headline-40">
<span class="todo">TODO</span>
9âƒ£ eef6fd5 setup() å‚æ•°ç­¾å
</h3>
<div id="outline-text-headline-40" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/eef6fd52f79f561d92a2914a3fdf74b998788640">feat(add): sfc-&gt;script, setup() å‚æ•°ç­¾å Â· gcclll/stb-vue-next@eef6fd5</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup lang=&#34;ts&#34;&gt;
</span><span class="sb">import { defineProps, defineEmit } from &#39;vue&#39;
</span><span class="sb">const props = defineProps({ foo: String })
</span><span class="sb">const emit = defineEmit([&#39;a&#39;, &#39;b&#39;])
</span><span class="sb">&lt;/script&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { defineComponent as _defineComponent } from &#39;vue&#39;


export default _defineComponent({
  expose: [],
  props: { foo: String },
  emits: [&#39;a&#39;, &#39;b&#39;],
  setup(__props, { emit }) {

const props = __props



return { props, emit }
}

})
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-41" class="outline-3">
<h3 id="headline-41">
ğŸ”Ÿ 9cedeab ç”Ÿæˆ return è¯­å¥
</h3>
<div id="outline-text-headline-41" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9cedeab1e337cb0e872d6ca19a83bf6d05856bd0">feat(add): sfc-&gt;script, process render function return Â· gcclll/stb-vue-next@9cedeab</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { x } from &#39;./x&#39;
</span><span class="sb">let a = 1
</span><span class="sb">const b = 2
</span><span class="sb">function c() {}
</span><span class="sb">class d {}
</span><span class="sb">&lt;/script&gt;`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { x } from &#39;./x&#39;

let a = 1
const b = 2
function c() {}
class d {}

return { a, b, c, d, x }
}
undefined
</pre>
<p>
å°†æ‰€æœ‰å˜é‡éƒ½è¿”å›å‡ºå»äº†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { ref } from &#39;vue&#39;
</span><span class="sb">const count = ref(0)
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;template&gt;
</span><span class="sb">    &lt;div&gt;{{ count }}&lt;/div&gt;
</span><span class="sb">    &lt;div&gt;static&lt;/div&gt;
</span><span class="sb">&lt;/template&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">div { color: v-bind(count) }
</span><span class="sb">&lt;/style&gt;`</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">inlineTemplate</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { toDisplayString as _toDisplayString, createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, &#34;static&#34;, -1 /* HOISTED */)

import { ref } from &#39;vue&#39;

_useCssVars(_ctx =&gt; ({
  &#34;xxxxxxxx-count&#34;: (count.value)
}))

const count = ref(0)

return (_ctx, _cache) =&gt; {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;div&#34;, null, _toDisplayString(count.value), 1 /* TEXT */),
    _hoisted_1
  ], 64 /* STABLE_FRAGMENT */))
}
}
undefined
</pre>
<p>
å¦‚æœè¦æ”¯æŒï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span>
   <span class="nx">inlineTemplate</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
   <span class="nx">templateOptions</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">ssr</span><span class="o">:</span> <span class="kc">true</span>
   <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿˜éœ€è¦å®ç° <code>compiler-ssr</code> æ¨¡å—ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// TODO 10. ç”Ÿæˆè¿”å›è¯­å¥(return)
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">returned</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">inlineTemplate</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">sfc</span><span class="p">.</span><span class="nx">template</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">sfc</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO éœ€è¦ compiler-ssr æ”¯æŒ
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">returned</span> <span class="o">=</span> <span class="sb">`() =&gt; {}`</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// return bindings from setup
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">allBindings</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">setupBindings</span> <span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">userImports</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userImports</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">isType</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">allBindings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">returned</span> <span class="o">=</span> <span class="sb">`{ </span><span class="si">${</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">allBindings</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;, &#34;</span><span class="p">)</span><span class="si">}</span><span class="sb"> }`</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">s</span><span class="p">.</span><span class="nx">appendRight</span><span class="p">(</span><span class="nx">endOffset</span><span class="p">,</span> <span class="sb">`</span><span class="err">\</span><span class="sb">nreturn </span><span class="si">${</span><span class="nx">returned</span><span class="si">}</span><span class="err">\</span><span class="sb">n}</span><span class="err">\</span><span class="sb">n</span><span class="err">\</span><span class="sb">n`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-42" class="outline-3">
<h3 id="headline-42">
<span class="todo">TODO</span>
1âƒ£1âƒ£ cfca9de finalize default export
</h3>
<div id="outline-text-headline-42" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cfca9de9bbd44451eb5f7269c89d702220a032cd">feat(add): sfc-&gt;script, finalize default export Â· gcclll/stb-vue-next@cfca9de</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">bindings</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineEmit } from &#39;vue&#39;
</span><span class="sb">const myEmit = defineEmit([&#39;foo&#39;, &#39;bar&#39;])
</span><span class="sb">const props = defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">  `</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
export default {
  expose: [],
  props: {
  foo: String
},
  emits: [&#39;foo&#39;, &#39;bar&#39;],
  setup(__props, { emit: myEmit }) {

const props = __props



return { myEmit, props }
}

}
undefined
</pre>
<blockquote>
<p>emits å“ªå»äº†??? -&gt; fix: <a href="https://github.com/gcclll/stb-vue-next/commit/d631810952131058b7ea474f66ac3d5fdeee3821">d631810</a></p>
</blockquote>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/d631810952131058b7ea474f66ac3d5fdeee3821">fix: sfc-&gt;script, expose indent Â· gcclll/stb-vue-next@d631810</a></p>
</div>
</div>
<div id="outline-container-headline-43" class="outline-3">
<h3 id="headline-43">
<span class="todo">TODO</span>
1âƒ£2âƒ£ 5810296 finalize Vue helper imports
</h3>
<div id="outline-text-headline-43" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/5810296d43519e902085cacf8ab95cbbada1fe70">feat(add): sfc-&gt;script, finalize vue helper imports Â· gcclll/stb-vue-next@5810296</a></p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-44" class="outline-2">
<h2 id="headline-44">
61c3b7a transform src set
</h2>
<div id="outline-text-headline-44" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/61c3b7aed514f0d9474da22cb4ed7a1dd60f0492">feat(add): sfc-&gt;srcset transform Â· gcclll/stb-vue-next@61c3b7a</a></p>
<p>
è½¬æ¢ <code>&lt;img&gt;</code> å’Œ <code>&lt;source&gt;</code> çš„ <code>srcset</code> å±æ€§ã€‚</p>
<p>
img srcset å±æ€§å€¼ï¼š <code>&lt;img srcset=&#34;url 1x, url2 2x, ...&#34;&gt;</code> æµè§ˆå™¨ä¼šæ ¹æ®å®é™…æƒ…å†µæ¥
é€‰ç”¨ srcset ä¸­åˆé€‚çš„å›¾ç‰‡åœ°å€æ¥æ˜¾ç¤ºã€‚</p>
<blockquote>
<p>æœ‰å…³ Reponsive Images è¯´æ˜: <a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images">Responsive images - Learn web development | MDN</a>ã€‚</p>
</blockquote>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileWithSrcset</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">src</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;
import _imports_0 from &#39;./logo.png&#39;


const _hoisted_1 = _imports_0
const _hoisted_2 = _imports_0 + &#39;2x&#39;
const _hoisted_3 = _imports_0 + &#39;2x&#39;
const _hoisted_4 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x&#39;
const _hoisted_5 = _imports_0 + &#39;2x, &#39; + _imports_0
const _hoisted_6 = _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_7 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_8 = &#34;/logo.png&#34; + &#39;, &#39; + _imports_0 + &#39;2x&#39;

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_1
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_2
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_3
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_4
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_5
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_6
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_7
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: &#34;/logo.png, /logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;https://example.com/logo.png&#34;,
      srcset: &#34;https://example.com/logo.png, https://example.com/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: _hoisted_8
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;data:image/png;base64,i&#34;,
      srcset: &#34;data:image/png;base64,i 1x, data:image/png;base64,i 2x&#34;
    })
  ], 64 /* STABLE_FRAGMENT */))
}
undefined
</pre>
<p>
æŒ‡å®š <code>options.base: &#39;/foo&#39;</code> æµ‹è¯•ç»“æœï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileWithSrcset</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">src</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="p">{</span> <span class="nx">base</span><span class="o">:</span> <span class="s1">&#39;/foo&#39;</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png, /foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x, /foo/logo.png&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x, /foo/logo.png 3x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png, /foo/logo.png 2x, /foo/logo.png 3x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: &#34;/logo.png, /logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;https://example.com/logo.png&#34;,
      srcset: &#34;https://example.com/logo.png, https://example.com/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: &#34;/logo.png, /foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;data:image/png;base64,i&#34;,
      srcset: &#34;data:image/png;base64,i 1x, data:image/png;base64,i 2x&#34;
    })
  ], 64 /* STABLE_FRAGMENT */))
}
undefined
</pre>
<p>
<code>options.includeAbsolute: true</code> é€‰é¡¹:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileWithSrcset</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">src</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="p">{</span> <span class="nx">includeAbsolute</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;
import _imports_0 from &#39;./logo.png&#39;
import _imports_1 from &#39;/logo.png&#39;


const _hoisted_1 = _imports_0
const _hoisted_2 = _imports_0 + &#39;2x&#39;
const _hoisted_3 = _imports_0 + &#39;2x&#39;
const _hoisted_4 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x&#39;
const _hoisted_5 = _imports_0 + &#39;2x, &#39; + _imports_0
const _hoisted_6 = _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_7 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_8 = _imports_1 + &#39;, &#39; + _imports_1 + &#39;2x&#39;
const _hoisted_9 = &#34;https://example.com/logo.png&#34; + &#39;, &#39; + &#34;https://example.com/logo.png&#34; + &#39;2x&#39;
const _hoisted_10 = _imports_1 + &#39;, &#39; + _imports_0 + &#39;2x&#39;
const _hoisted_11 = &#34;data:image/png;base64,i&#34; + &#39;1x, &#39; + &#34;data:image/png;base64,i&#34; + &#39;2x&#39;

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_1
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_2
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_3
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_4
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_5
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_6
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_7
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: _hoisted_8
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;https://example.com/logo.png&#34;,
      srcset: _hoisted_9
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: _hoisted_10
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;data:image/png;base64,i&#34;,
      srcset: _hoisted_11
    })
  ], 64 /* STABLE_FRAGMENT */))
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-45" class="outline-2">
<h2 id="headline-45">
æ€»ç»“
</h2>
<div id="outline-text-headline-45" class="outline-text-2">
<p>
SFC æ¨¡å—çš„ä½œç”¨ï¼š</p>
<ol>
<li>
<p>è§£æ Render å‡½æ•°ï¼Œæ›¿æ¢ ref å˜é‡</p>
</li>
<li>
<p>è§£æ &lt;script&gt; æ ‡ç­¾</p>
</li>
<li>
<p>è§£æ &lt;script setup&gt;</p>
</li>
<li>
<p>ref: è§£æï¼Œå°† ref: ç±»å‹è®¿é—®è½¬æˆå¯¹ ref.value çš„è®¿é—®</p>
</li>
<li>
<p>å°† ref: { â€¦ } è§£æ„åçš„å˜é‡è¿›è¡Œ ref(â€¦) åŒ–</p>
</li>
<li>
<p>defineProps({ foo: String })  è§£æï¼Œåˆå¹¶åˆ° export default { props: {â€¦} }</p>
</li>
<li>
<p>defineEmit({ â€¦ }) è§£æï¼Œåˆå¹¶åˆ° export default { emits: {â€¦} }</p>
</li>
<li>
<p>cssVar v-bind å˜é‡ä½¿ç”¨ï¼Œè½¬æ¢ï¼ŒåŒ…å« ref å˜é‡å¼•ç”¨è½¬æ¢</p>
</li>
<li>
<p>asset url è½¬æ¢(ç›¸å¯¹è·¯å¾„ï¼Œç»å¯¹è·¯å¾„ï¼Œ <code>~@path/...</code>, <code>@path/..</code> è½¬æ¢)</p>
</li>
<li>
<p><code>&lt;img&gt;, &lt;source&gt;</code> çš„ <code>srcset</code> URLè½¬æ¢</p>
</li>
</ol>
<p>
ç»¼åˆæµ‹è¯•ï¼š</p>
<div id="outline-container-headline-46" class="outline-4">
<h4 id="headline-46">
script[setup] æµ‹è¯•
</h4>
<div id="outline-text-headline-46" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">compileWithSrcset</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">,</span> <span class="nx">attrs</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compileSFCScript</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;template&gt;
</span><span class="sb">  &lt;div&gt;
</span><span class="sb">    &lt;img src=&#34;./logo.png&#34; srcset=&#34;./logo.png, ./logo.png 2x, ./logo.png 3x&#34;/&gt;
</span><span class="sb">  &lt;/div&gt;
</span><span class="sb">  &lt;div&gt;{{ count }}&lt;/div&gt;
</span><span class="sb">  &lt;div&gt;static&lt;/div&gt;
</span><span class="sb">&lt;/template&gt;
</span><span class="sb">&lt;script&gt;
</span><span class="sb">  const a = 1
</span><span class="sb">export default {
</span><span class="sb">  props: [&#39;foo&#39;, &#39;bar&#39;],
</span><span class="sb">  data() {
</span><span class="sb">    return { foo: null, bar }
</span><span class="sb">  },
</span><span class="sb">  setup() {
</span><span class="sb">    return { foo: 1, a }
</span><span class="sb">  },
</span><span class="sb">  computed: {
</span><span class="sb">    fcc() {},
</span><span class="sb">    bcc: {
</span><span class="sb">      get() {},
</span><span class="sb">      set() {}
</span><span class="sb">    }
</span><span class="sb">  },
</span><span class="sb">  inject: [&#39;fjj&#39;, &#39;bjj&#39;], // { fjj: {}, bjj: {} },
</span><span class="sb">  methods: {
</span><span class="sb">    quux() {}
</span><span class="sb">  },
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineProps, ref } from &#39;vue&#39;
</span><span class="sb">let a, b, c, d
</span><span class="sb">ref: aa = 1 + (await foa)
</span><span class="sb">ref: height = 100
</span><span class="sb">// å¯¹è±¡è§£æ„è¦ç”¨æ‹¬å·åŒ…è£¹èµ·æ¥
</span><span class="sb">ref: ({ foo, bar: bar, baz: { bax } } = useFoo());
</span><span class="sb">ref: [ar, br] = useFoo()
</span><span class="sb">ref: count = 0
</span><span class="sb">const color = &#39;red&#39;
</span><span class="sb">const size = ref(&#39;10px&#39;)
</span><span class="sb">defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">defineEmit([&#39;fox&#39;, &#39;foy&#39;])
</span><span class="sb">
</span><span class="sb">// ref åœ¨å‡½æ•°ä¸­è¢«è®¿é—®
</span><span class="sb">function test() {
</span><span class="sb">  const { a } = aa
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">div {
</span><span class="sb">  color: v-bind(color);
</span><span class="sb">  font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">  border: v-bind(foo);
</span><span class="sb">  height: v-bind(height);
</span><span class="sb">}
</span><span class="sb">&lt;/style&gt;
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; content è¾“å‡ºç»“æœï¼š`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; bindings è¾“å‡ºç»“æœï¼š`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; content è¾“å‡ºç»“æœï¼š
import { ref as _ref, useCssVars as _useCssVars, unref as _unref } from &#39;vue&#39;
import { ref } from &#39;vue&#39;

  const a = 1
const __default__ = {
  props: [&#39;foo&#39;, &#39;bar&#39;],
  data() {
    return { foo: null, bar }
  },
  setup() {
    return { foo: 1, a }
  },
  computed: {
    fcc() {},
    bcc: {
      get() {},
      set() {}
    }
  },
  inject: [&#39;fjj&#39;, &#39;bjj&#39;], // { fjj: {}, bjj: {} },
  methods: {
    quux() {}
  },
}

async function setup(__props) {

_useCssVars(_ctx =&gt; ({
  &#34;xxxxxxxx-color&#34;: (color),
  &#34;xxxxxxxx-font_size&#34;: (_ctx.font.size),
  &#34;xxxxxxxx-foo&#34;: (foo.value),
  &#34;xxxxxxxx-height&#34;: (height.value)
}))

let a, b, c, d
const aa = _ref(1 + (await foa))
const height = _ref(100)
// å¯¹è±¡è§£æ„è¦ç”¨æ‹¬å·åŒ…è£¹èµ·æ¥
const { foo: __foo, bar: __bar, baz: { bax: __bax } } = useFoo();
const foo = _ref(__foo);
const bar = _ref(__bar);
const bax = _ref(__bax);
const [__ar, __br] = useFoo()
const ar = _ref(__ar);
const br = _ref(__br);
const count = _ref(0)
const color = &#39;red&#39;
const size = ref(&#39;10px&#39;)



// ref åœ¨å‡½æ•°ä¸­è¢«è®¿é—®
function test() {
  const { a } = aa.value
}

return { a, b, c, d, aa, height, foo, bar, bax, ar, br, count, color, size, test, ref }
}


export default /*#__PURE__*/ Object.assign(__default__, {
  expose: [],
  props: {
  foo: String
},
  emits: [&#39;fox&#39;, &#39;foy&#39;],
  setup
})
&gt;&gt;&gt; bindings è¾“å‡ºç»“æœï¼š
{
  foo: &#39;setup-ref&#39;,
  bar: &#39;setup-ref&#39;,
  a: &#39;setup-let&#39;,
  fcc: &#39;options&#39;,
  bcc: &#39;options&#39;,
  fjj: &#39;options&#39;,
  bjj: &#39;options&#39;,
  quux: &#39;options&#39;,
  ref: &#39;setup-const&#39;,
  b: &#39;setup-let&#39;,
  c: &#39;setup-let&#39;,
  d: &#39;setup-let&#39;,
  aa: &#39;setup-ref&#39;,
  height: &#39;setup-ref&#39;,
  bax: &#39;setup-ref&#39;,
  ar: &#39;setup-ref&#39;,
  br: &#39;setup-ref&#39;,
  count: &#39;setup-ref&#39;,
  color: &#39;setup-const&#39;,
  size: &#39;setup-ref&#39;,
  test: &#39;setup-const&#39;
}
undefined
</pre>
<p>
<strong>ç»“æœç®€æï¼š</strong></p>
<ol>
<li>
<p><code>&lt;script setup&gt;</code> æ ‡ç­¾å†…çš„ä»£ç éƒ½ä¼šè¢«è§£æåˆ° <code>setup() {...}</code> å‡½æ•°ä¸­</p>
<p>
å³å®ƒå’Œ <code>&lt;script&gt;</code> ä¸­ä»£ç æ˜¯ä¸å†²çªçš„ï¼Œæ¯”å¦‚ <code>&lt;script&gt;</code> é‡Œé¢çš„å˜é‡ <code>a</code> å’Œ
<code>&lt;script setup&gt;</code> ä¸­çš„åŒåå˜é‡ <code>a</code> äº’ä¸å½±å“ã€‚</p>
</li>
<li>
<p>åœ¨ <code>&lt;style&gt;</code> ä¸­ä½¿ç”¨çš„ v-bind æŒ‡ä»¤ä¼šä½¿ç”¨ <code>_useCssVars</code> è¿›è¡Œæ³¨å†Œæ›¿æ¢æˆå®é™…çš„æ ·
å¼å€¼</p>
</li>
<li>
<p><code>defineProps</code> ä¸­å®šä¹‰çš„å˜é‡å¯¹åº” export default -&gt; props</p>
</li>
<li>
<p><code>defineEmits</code> ä¸­å®šä¹‰çš„å˜é‡å¯¹åº” export default -&gt; emits</p>
</li>
<li>
<p><code>ref: height = 100</code> ä¸­çš„ <code>ref:</code> è¯­æ³•æœ€ç»ˆä¼šè½¬æˆå¯¹åº”çš„ <code>_ref(100)</code> reactive å˜
é‡(è¯­æ³•ç³–ï¼Œvue&gt;compile-sfcè§£æ)</p>
<p>
å¹¶ä¸”æ”¯æŒå¤šç§ç”¨æ³•ï¼Œè§£æ„/å¤šä¸ªå£°æ˜ç»„åˆ/è§£æ„é»˜è®¤å€¼ï¼Œå¯¹äºè§£æ„åçš„å˜é‡è¿›è¡Œ
<code>_ref(...)</code> ç„¶å setup return ä¸­è¿”å›ã€‚</p>
<p>
ref: è¯­å¥ä¸­å¦‚æœæœ‰è§£æ„(å¯¹è±¡è§£æ„)æ“ä½œï¼Œé‚£ä¹ˆåé¢çš„è§£æ„è¡¨è¾¾å¼å¿…é¡»ç”¨æ‹¬å·(<code>({ a } = useFoo())</code>)åŒ…èµ·æ¥ã€‚</p>
<p>
<em>Imp. ref: è§£æ„ä¸­çš„å˜é‡åä¸èƒ½ä»¥ <code>$</code> å¼€å¤´ã€‚</em></p>
</li>
<li>
<p>å¦‚æœ <code>script</code> å’Œ <code>script setup</code> ä¸­çš„ export default ä¸­åŒæ—¶åŒ…å«åŒåå±æ€§ï¼Œä¼šè¢«
<code>script setup</code> ä¸­çš„æ›¿æ¢æ‰ã€‚</p>
<p>
å› ä¸ºç”Ÿæˆçš„ä»£ç ä¸­æ˜¯å°† script setup å¾€ script ä¸Šåˆå¹¶ã€‚</p>
<blockquote>
<p>PS. &lt;script&gt; å’Œ &lt;script setup&gt; ä¸­ export default çš„å†…å®¹å°½é‡ä¸è¦é‡å¤ã€‚</p>
</blockquote>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-47" class="outline-4">
<h4 id="headline-47">
typescript è¯­è¨€
</h4>
<div id="outline-text-headline-47" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">scriptAst</span><span class="p">,</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">import { Options, Vue } from &#39;vue-class-component&#39;;
</span><span class="sb">@Options({
</span><span class="sb">    components: {
</span><span class="sb">    HelloWorld,
</span><span class="sb">    },
</span><span class="sb">    props: [&#39;foo&#39;, &#39;bar&#39;]
</span><span class="sb">})
</span><span class="sb">export default class Home extends Vue {}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

import { Options, Vue } from &#39;vue-class-component&#39;;
@Options({
    components: {
    HelloWorld,
    },
    props: [&#39;foo&#39;, &#39;bar&#39;]
})
export default class Home extends Vue {}

undefined
</pre>
</div>
</div>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2020-12-19
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/compiler-sfc/">compiler-sfc</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-compiler-ssr/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 6 â˜compiler-ssr</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-compiler-dom/">
            <span class="next-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 4 â˜compiler-dom</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2020-12-19 00:00:00 \u002b0000 UTC',
        title: 'Vue3 æºç å¤´è„‘é£æš´ä¹‹ 5 â˜ compiler-sfc',
        clientID: '7251a6b30d0d6c0f4aa2',
        clientSecret: '320c43a98b0d5ae30535d8cf6cb3be7a05895c77',
        repo: 'cheng92-comments',
        owner: 'gcclll',
        admin: ['gcclll'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
