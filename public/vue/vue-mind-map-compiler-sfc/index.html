<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 源码头脑风暴之 5 ☞ compiler-sfc - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-compiler-sfc/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.9d6c07951e716411e0fdd9d1d7616cb41ced57b53993154c49ea809e194527af.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 源码头脑风暴之 5 ☞ compiler-sfc" />
<meta property="og:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-compiler-sfc/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2020-12-19T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-12-19T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 源码头脑风暴之 5 ☞ compiler-sfc">
<meta itemprop="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu"><meta itemprop="datePublished" content="2020-12-19T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-12-19T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="11708">
<meta itemprop="keywords" content="vue,,vue3,,compiler-sfc," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 源码头脑风暴之 5 ☞ compiler-sfc"/>
<meta name="twitter:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 源码头脑风暴之 5 ☞ compiler-sfc</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-12-19 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> 约 11708 字 </span>
          <span class="more-meta"> 预计阅读 24 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">重点、特性、问题</a>
</li>
<li><a href="#headline-2">f21c84c init 初始化工作</a>
</li>
<li><a href="#parse-func">49ee210 parse function 实现部分</a>
<ul>
<li><a href="#headline-4">e32d508 parse &lt;template&gt; case</a>
</li>
<li><a href="#headline-5">3160fed parse &lt;script&gt; case</a>
</li>
<li><a href="#headline-6">aa037fe parse &lt;style&gt; case</a>
</li>
</ul>
</li>
<li><a href="#headline-7">compile &lt;template&gt;</a>
<ul>
<li><a href="#headline-8">c26e76c init compileTemplate</a>
</li>
<li><a href="#headline-9">1b2965f coding compileTemplate</a>
</li>
<li><a href="#headline-10">7b49db4 coding doCompileTemplate 函数实现</a>
</li>
<li><a href="#headline-11">2d82400 coding transformAssetUrl 转换资源 url</a>
</li>
</ul>
</li>
<li><a href="#headline-12">56358a8 compile &lt;style&gt;</a>
</li>
<li><a href="#headline-13">4d66531 compile &lt;script&gt;<sup>重点</sup></a>
<ul>
<li><a href="#headline-14">init compileScript function</a>
</li>
<li><a href="#script-0">0⃣ d7369ae 无 &lt;script setup&gt; 时</a>
</li>
<li><a href="#headline-16">819a413 export default {} 解析</a>
</li>
<li><a href="#headline-17">测试</a>
</li>
<li><a href="#headline-18">1⃣ eb650ca 解析 &lt;script&gt;</a>
<ul>
<li><a href="#headline-19">import … from 处理</a>
</li>
<li><a href="#headline-20">export default {} 处理</a>
</li>
<li><a href="#headline-21">export … [from] 处理</a>
</li>
</ul>
</li>
<li><a href="#headline-22">2⃣ 8edf0d7 解析 &lt;script setup&gt;</a>
<ul>
<li><a href="#headline-23">d4f6497 ref: n = 100</a>
</li>
<li><a href="#headline-24">db7cb02 ref: { n = 1 } = useFoo()</a>
</li>
<li><a href="#headline-25">af26553 ref: [a] = useFoo() 数据解构</a>
</li>
<li><a href="#headline-26">a9f4469 ref: ({…foo} = useFoo()) 展开符</a>
</li>
<li><a href="#headline-27">d52a6d0 _ref(…) 增加 ref 声明</a>
</li>
<li><a href="#headline-28">168041c ref: a = 1, b = 2 多条语句</a>
</li>
<li><a href="#headline-29">6e337c5 imports 置顶🔝</a>
</li>
<li><a href="#headline-30">68d4940 defineProps/Emit() 处理</a>
</li>
</ul>
</li>
<li><a href="#headline-31">3⃣ 5160a6d ref -&gt; ref.value</a>
</li>
<li><a href="#headline-32">4⃣ a6f4dae extract define props/emits</a>
</li>
<li><a href="#headline-33">5⃣ 480acf0 checkInvalidScopeReference</a>
</li>
<li><a href="#headline-34">6⃣ 25662c6 删除非 script 内容</a>
</li>
<li><a href="#headline-35">7⃣ deed8c1 analyze binding metadata(bindingMetadata)</a>
</li>
<li><a href="#headline-36">8⃣ 9cd2fd5 inject useCssVars, css 变量处理</a>
<ul>
<li><a href="#headline-37">&lt;style&gt; v-bind css 变量</a>
</li>
<li><a href="#headline-38">css 变量重写：</a>
</li>
<li><a href="#headline-39">isProd option 使用 hash 变量名</a>
</li>
</ul>
</li>
<li><a href="#headline-40">9⃣ eef6fd5 setup() 参数签名</a>
</li>
<li><a href="#headline-41">🔟 9cedeab 生成 return 语句</a>
</li>
<li><a href="#headline-42">1⃣1⃣ cfca9de finalize default export</a>
</li>
<li><a href="#headline-43">1⃣2⃣ 5810296 finalize Vue helper imports</a>
</li>
</ul>
</li>
<li><a href="#headline-44">61c3b7a transform src set</a>
</li>
<li><a href="#headline-45">总结</a>
<ul>
<li><a href="#headline-46">script[setup] 测试</a>
</li>
<li><a href="#headline-47">typescript 语言</a>
</li>
</ul>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> 完全拷贝于 <a href="https://github.com/vuejs/vue-next">vue-next</a> ，主要目的用于学习。</strong>
</kbd></p>
<blockquote>
<p><strong>声明</strong> ：vue-next compiler-sfc 模块，相关的所有测试代码均在 <code>/js/vue/</code> 目录下面。</p>
<p>
<strong>更新日志&amp;Todos</strong> ：</p>
<ol>
<li>
<p>[2020-12-19 13:58:31] 创建</p>
</li>
<li>
<p>[2021-01-04 19:47:10] 完成</p>
</li>
<li>
<p>TODO defineProps 和 defineEmit 原理和用途</p>
</li>
<li>
<p>TODO inlineTemplate with ssr: true options</p>
</li>
<li>
<p>TODO more mind-maps</p>
</li>
</ol>
</blockquote>
<p>
<img src="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" alt="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" title="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" /></p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
重点、特性、问题
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
<img src="/img/vue3/compiler-sfc/vue-compiler-sfc-keypoints.svg" alt="/img/vue3/compiler-sfc/vue-compiler-sfc-keypoints.svg" title="/img/vue3/compiler-sfc/vue-compiler-sfc-keypoints.svg" /></p>
<ol>
<li>
<p><a href="#parse-func">🔗</a> <code>&lt;style&gt;</code> 标签中可通过 <code>v-bind()</code> 引用CSS 模块化后的变量</p>
</li>
<li>
<p><code>&lt;script&gt;</code> 和 <code>&lt;script setup&gt;</code> 中的 export default 会合并，且是 setup 优先级
更高，因此尽量不要存在重复属性。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
f21c84c init 初始化工作
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f21c84ca8a8488347aba243262be333f26ab2cef">feat(init): compiler-sfc · gcclll/stb-vue-next@f21c84c</a></p>
<p>
cp compiler-sfc form vue-next:/packages/compiler-dom</p>
<p>
删除 compiler-sfc/src/* 下所有文件</p>
<p>
新建 compiler-sfc/src/index.ts 入口文件</p>
<p>
初始化 index.ts:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// API
</span><span class="c1"></span><span class="kr">export</span> <span class="p">{</span> <span class="nx">generateCodeFrame</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@vue/compiler-core&#39;</span>

<span class="c1">// Types
</span><span class="c1"></span><span class="kr">export</span> <span class="p">{</span>
  <span class="nx">CompilerOptions</span><span class="p">,</span>
  <span class="nx">CompilerError</span><span class="p">,</span>
  <span class="nx">BindingMetadata</span>
<span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@vue/compiler-core&#39;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<hr>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e7e1cc130e5c555b541be39b475b6546969b32dc">feat(init): parse function · gcclll/stb-vue-next@e7e1cc1</a></p>
<p>
声明一些基本类型，比如： <code>&lt;template&gt;, &lt;script&gt;, &lt;style&gt;</code> 这也是 <code>*.vue</code> 文件的三
大要素，这里需要多关注一点就是会发现 <code>&lt;script&gt;</code> 标签里面多有一个 <code>setup</code> 属性，
这个是 vue 自身定义的一种标签类型，比如在这里面可以直接使用 <code>ref</code> 声明变量，这里
面的变量都会自动变成响应式的等等。</p>
<p>
SFC 块类型定义：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="kt">string</span>
  <span class="nx">content</span>: <span class="kt">string</span>
  <span class="nx">attrs</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">string</span> <span class="err">|</span> <span class="na">true</span><span class="p">&gt;</span>
  <span class="nx">loc</span>: <span class="kt">SourceLocation</span>
  <span class="nx">map?</span>: <span class="kt">RawSourceMap</span>
  <span class="nx">lang?</span>: <span class="kt">string</span>
  <span class="nx">src?</span>: <span class="kt">string</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC <code>&lt;template&gt;</code> 标签类型定义：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCTemplateBlock</span> <span class="kr">extends</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;template&#39;</span>
  <span class="nx">ast</span>: <span class="kt">ElementNode</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC <code>&lt;script&gt;</code> 脚本标签类型定义</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCScriptBlock</span> <span class="kr">extends</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;script&#39;</span>
  <span class="nx">setup?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kr">boolean</span>
  <span class="nx">bindings?</span>: <span class="kt">BindingMetadata</span>
  <span class="nx">scriptAst?</span>: <span class="kt">Statement</span><span class="p">[]</span>
  <span class="nx">scriptSetupAst?</span>: <span class="kt">Statement</span><span class="p">[]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC <code>&lt;style&gt;</code> 样式标签类型定义</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCStyleBlock</span> <span class="kr">extends</span> <span class="nx">SFCBlock</span> <span class="p">{</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;style&#39;</span>
  <span class="nx">scoped?</span>: <span class="kt">boolean</span> <span class="c1">// 指定是不是只能用于当前文件
</span><span class="c1"></span>  <span class="kr">module</span><span class="nx">?</span><span class="o">:</span> <span class="kt">string</span> <span class="o">|</span> <span class="kr">boolean</span> <span class="c1">// 是不是模块化样式
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFC 文件类型定义</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCDescriptor</span> <span class="p">{</span>
  <span class="nx">filename</span>: <span class="kt">string</span>
  <span class="nx">source</span>: <span class="kt">string</span>
  <span class="nx">template</span>: <span class="kt">SFCTemplateBlock</span> <span class="o">|</span> <span class="kc">null</span>
  <span class="nx">script</span>: <span class="kt">SFCScriptBlock</span> <span class="o">|</span> <span class="kc">null</span>
  <span class="nx">scriptSetup</span>: <span class="kt">SFCScriptBlock</span> <span class="o">|</span> <span class="kc">null</span>
  <span class="nx">styles</span>: <span class="kt">SFCStyleBlock</span><span class="p">[]</span>
  <span class="nx">customBlocks</span>: <span class="kt">SFCBlock</span><span class="p">[]</span>
  <span class="nx">cssVars</span>: <span class="kt">string</span><span class="p">[]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
parse 函数定义：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span>
  <span class="nx">source</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">sourceMap</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">}</span><span class="o">:</span> <span class="nx">SFCParseOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">SFCParseResult</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">SFCParseResult</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-func" class="outline-2">
<h2 id="parse-func">
49ee210 parse function 实现部分
</h2>
<div id="outline-text-parse-func" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/49ee210b898949dbc36dabb7b98555c6043c2a31">feat: sfc-&gt; code parse function · gcclll/stb-vue-next@49ee210</a></p>
<p>
实现 parse 函数的基本架构:</p>
<ol>
<li>
<p><code>sourceToSFC&lt;key, source&gt;</code> 用来缓存 vue文件解析结果，首先取缓存结果</p>
</li>
<li>
<p>通过调用 compiler-dom 中的 compiler.parse 将文件内容 source解析成 AST</p>
</li>
<li>
<p>遍历所有 ast.children 根据 node.tag 类型决定走什么分支处理</p>
<p>
<code>&lt;template&gt;</code> 模板分支，这里面的所有内容会被 parse 继续解析出 ast</p>
<p>
<code>&lt;script [setup]&gt;</code> 脚本分支, 当做 RAWDATA 文本类型处理，如果有 <code>setup</code> 属性，
则所有 script 都不能带 src 属性，即不能引用外部文件，因为所有 script 内容会合
并到一起去处理。</p>
<p>
<code>&lt;style [lang=&#34;&#34;]&gt;</code>  样式分支，当做 RAWDATA 文本类型处理</p>
</li>
<li>
<p>错误用法检测，主要是 <code>&lt;script setup&gt;</code> 脚本标签不能有 src 的检测</p>
</li>
<li>
<p><code>souremap</code> 的处理</p>
</li>
<li>
<p><code>descriptor.cssVars = parseCssVars(descriptor)</code> CSS 变量的解析，会全部解析到
数组 <code>cssVars</code> 里面去</p>
</li>
<li>
<p>缓存解析后的结果到 <code>sourceToSFC.set(sourceKey, result)</code></p>
</li>
<li>
<p>对了，在 <code>switch case</code> 分支里面默认走的是自定义块的处理(vue 文件中还可以自定
义？)</p>
</li>
</ol>
<p>
CSS vars 变量处理：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">CSS_VARS_HELPER</span> <span class="o">=</span> <span class="sb">`useCssVars`</span><span class="p">;</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">cssVarRE</span> <span class="o">=</span> <span class="sr">/\bv-bind\(\s*(?:&#39;([^&#39;]+)&#39;|&#34;([^&#34;]+)&#34;|([^&#39;&#34;][^)]*))\s*\)/g</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">parseCssVars</span><span class="p">(</span><span class="nx">sfc</span>: <span class="kt">SFCDescriptor</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">vars</span>: <span class="kt">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">sfc</span><span class="p">.</span><span class="nx">styles</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">style</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">match</span><span class="p">;</span>
    <span class="c1">// v-bind(&#39;xxx&#39;), v-bind(&#34;xxx&#34;), v-bind()
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">cssVarRE</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">style</span><span class="p">.</span><span class="nx">content</span><span class="p">)))</span> <span class="p">{</span>
      <span class="nx">vars</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">vars</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里有个 cssVarRE 正则，来看下：</p>
<p>
<img src="/img/vue3/re/sfc-css-vars-re.svg" alt="/img/vue3/re/sfc-css-vars-re.svg" title="/img/vue3/re/sfc-css-vars-re.svg" /></p>
<p>
这个正则可以匹配结果： <code>v-bind(&#39;...&#39;), v-bind(&#34;...&#34;), v-bind(...)</code></p>
<p>
从 <code>compiler-src/__tests__/cssVars.spec.ts</code> 用例中可窥见这种用法：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;script&gt;const a = 1&lt;/script&gt;\n`</span> <span class="o">+</span>
   <span class="sb">`&lt;style&gt;div{
</span><span class="sb">     color: v-bind(color);
</span><span class="sb">     font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">   }&lt;/style&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>💟  现在可以直接在 <code>&lt;style&gt;</code> 变迁里面通过 <code>v-bind()</code> 来直接使用引入的 CSS 变量。</p>
</blockquote>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/afd8044321de2e4396b8b81bf6e837beeb4ef8b1">feat(add): sfc-&gt;parse add sourcemap · gcclll/stb-vue-next@afd8044</a></p>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
e32d508 parse &lt;template&gt; case
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e32d508809cb7c49e04e4bdac63c26d0101f31a7">feat: sfc-&gt; add &lt;template&gt; parse · gcclll/stb-vue-next@e32d508</a></p>
<p>
主要增加代码： switch case -&gt; &#39;template&#39;:
<img src="http://qiniu.ii6g.com/img/20201219160507.png" alt="http://qiniu.ii6g.com/img/20201219160507.png" title="http://qiniu.ii6g.com/img/20201219160507.png" /></p>
<p>
增加函数： <code>createBlock()</code> 用来处理 SFC 标签的属性(如： <code>lang, setup, src,
scoped, module</code>)</p>
<p>
回顾下 <a href="/vue/vue-mind-map-compiler-dom/">compiler-dom</a>, <a href="/vue/vue-mind-map-compiler-core-parser/">compiler-core</a> 其实对于 <code>&lt;template&gt;</code> 标签的处理工作依然集中
在这两个包里面，所以这里就不再赘述模板 ast 的解析了。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">parse</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-sfc.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;template&gt;
</span><span class="sb">  &lt;div&gt;{{ test }}&lt;/div&gt;
</span><span class="sb">&lt;/template&gt;
</span><span class="sb">&lt;script&gt;&lt;/script&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">  div {
</span><span class="sb">    color:v-bind(&#39;fontColor&#39;);
</span><span class="sb">  }
</span><span class="sb">&lt;/style&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  descriptor: {
    filename: &#39;anonymous.vue&#39;,
    source: &#39;\n&#39; +
      &#39;&lt;template&gt;\n&#39; +
      &#39;  &lt;div&gt;{{ test }}&lt;/div&gt;\n&#39; +
      &#39;&lt;/template&gt;\n&#39; +
      &#39;&lt;script&gt;&lt;/script&gt;\n&#39; +
      &#39;&lt;style&gt;\n&#39; +
      &#39;  div {\n&#39; +
      &#34;    color:v-bind(&#39;fontColor&#39;);\n&#34; +
      &#39;  }\n&#39; +
      &#39;&lt;/style&gt;&#39;,
    template: {
      type: &#39;template&#39;,
      content: &#39;\n  &lt;div&gt;{{ test }}&lt;/div&gt;\n&#39;,
      loc: [Object],
      attrs: {},
      ast: [Object]
    },
    script: null,
    scriptSetup: null,
    styles: [],
    customBlocks: [],
    cssVars: []
  },
  errors: []
}
undefined
</pre>
<p>
如上：一个最简单的 SFC 解析后的结构。</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
3160fed parse &lt;script&gt; case
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3160fedbf252ad5a71a16567ae44fa445a343fa8">feat(add): sfc-&gt; script parse · gcclll/stb-vue-next@3160fed</a></p>
<p>
增加 switch case script 逻辑：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">case</span> <span class="s1">&#39;script&#39;</span><span class="o">:</span> <span class="c1">// 脚本标签处理
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">scriptBlock</span> <span class="o">=</span> <span class="nx">createBlock</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">pad</span><span class="p">)</span> <span class="kr">as</span> <span class="nx">SFCScriptBlock</span>
    <span class="kr">const</span> <span class="nx">isSetup</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">scriptBlock</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">setup</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isSetup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">descriptor</span><span class="p">.</span><span class="nx">scriptSetup</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">descriptor</span><span class="p">.</span><span class="nx">scriptSetup</span> <span class="o">=</span> <span class="nx">scriptBlock</span>
        <span class="k">break</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSetup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">descriptor</span><span class="p">.</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">descriptor</span><span class="p">.</span><span class="nx">script</span> <span class="o">=</span> <span class="nx">scriptBlock</span>
        <span class="k">break</span>
    <span class="p">}</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">createDuplicateBlockError</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">isSetup</span><span class="p">))</span>
    <span class="k">break</span>
<span class="k">break</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
createBlock() 中增加各属性的解析和设置：</p>
<p>
<code>lang</code> -&gt; <code>block.lang</code></p>
<p>
<code>src</code> -&gt; <code>block.src</code></p>
<p>
<code>style &gt; scoped</code> -&gt; <code>block.scoped</code></p>
<p>
<code>style &gt; module</code> -&gt; <code>block.module</code></p>
<p>
<code>script &gt; setup</code> -&gt; <code>block.setup</code></p>
<p>
另外增加了 <code>padContent()</code> 检测回车换行符替换？</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">parse</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-sfc.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { x } from &#39;./x&#39;
</span><span class="sb">let a = 1
</span><span class="sb">const b = 2
</span><span class="sb">function c() {}
</span><span class="sb">class d {}
</span><span class="sb">&lt;/script&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">descriptor</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  filename: &#39;anonymous.vue&#39;,
  source: &#39;\n&#39; +
    &#39;&lt;script setup&gt;\n&#39; +
    &#34;import { x } from &#39;./x&#39;\n&#34; +
    &#39;let a = 1\n&#39; +
    &#39;const b = 2\n&#39; +
    &#39;function c() {}\n&#39; +
    &#39;class d {}\n&#39; +
    &#39;&lt;/script&gt;&#39;,
  template: null,
  script: null,
  scriptSetup: {
    type: &#39;script&#39;,
    content: &#39;\n&#39; +
      &#34;import { x } from &#39;./x&#39;\n&#34; +
      &#39;let a = 1\n&#39; +
      &#39;const b = 2\n&#39; +
      &#39;function c() {}\n&#39; +
      &#39;class d {}\n&#39;,
    loc: {
      source: &#39;\n&#39; +
        &#34;import { x } from &#39;./x&#39;\n&#34; +
        &#39;let a = 1\n&#39; +
        &#39;const b = 2\n&#39; +
        &#39;function c() {}\n&#39; +
        &#39;class d {}\n&#39;,
      start: [Object],
      end: [Object]
    },
    attrs: { setup: true },
    setup: true
  },
  styles: [],
  customBlocks: [],
  cssVars: []
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
aa037fe parse &lt;style&gt; case
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/aa037fef4476f27ce25a88480768cb81e10075da">feat(add): sfc-&gt; parse &lt;style&gt; · gcclll/stb-vue-next@aa037fe</a></p>
<p>
解析后的结果保存到 <code>descriptor.styles.push(styleBlock)</code> 所以可以有多个 <code>&lt;style&gt;</code>
存在。</p>
<blockquote>
<p><em>Tip</em>: 这里还有一个 <code>styleBlock.attrs.vars</code> 检测，难不成将来会支持直接 SFC 里面
声明 CSS 变量?</p>
</blockquote>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">parse</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-sfc.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;style scoped&gt;
</span><span class="sb">h1 {
</span><span class="sb">  color: red;
</span><span class="sb">  font-size: v-bind(fontSize);
</span><span class="sb">  border: v-bind(&#39;border&#39;);
</span><span class="sb">}
</span><span class="sb">&lt;/style&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">descriptor</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  filename: &#39;anonymous.vue&#39;,
  source: &#39;\n&#39; +
    &#39;&lt;style scoped&gt;\n&#39; +
    &#39;h1 {\n&#39; +
    &#39;  color: red;\n&#39; +
    &#39;  font-size: v-bind(fontSize);\n&#39; +
    &#34;  border: v-bind(&#39;border&#39;);\n&#34; +
    &#39;}\n&#39; +
    &#39;&lt;/style&gt;&#39;,
  template: null,
  script: null,
  scriptSetup: null,
  styles: [
    {
      type: &#39;style&#39;,
      content: &#39;\n&#39; +
        &#39;h1 {\n&#39; +
        &#39;  color: red;\n&#39; +
        &#39;  font-size: v-bind(fontSize);\n&#39; +
        &#34;  border: v-bind(&#39;border&#39;);\n&#34; +
        &#39;}\n&#39;,
      loc: [Object],
      attrs: [Object],
      scoped: true
    }
  ],
  customBlocks: [],
  cssVars: [ &#39;fontSize&#39;, &#39;border&#39; ]
}
undefined
</pre>
<p>
对于 <code>v-bind()</code> 变量的引用，不管有没引号，都会当做变量处理。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
compile &lt;template&gt;
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
c26e76c init compileTemplate
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c26e76cb4e7ef260f3c500aa693581fca175cab4">feat(init): sfc-&gt;compile &lt;template&gt; · gcclll/stb-vue-next@c26e76c</a></p>
<p>
增加两个类型和 compileTemplate 函数定义：</p>
<p>
SFCTemplateCompileResults 模板便后的结果类型</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCTemplateCompileResults</span> <span class="p">{</span>
  <span class="nx">code</span>: <span class="kt">string</span>
  <span class="nx">ast?</span>: <span class="kt">RootNode</span>
  <span class="nx">preamble?</span>: <span class="kt">string</span>
  <span class="nx">source</span>: <span class="kt">string</span>
  <span class="nx">tips</span>: <span class="kt">string</span><span class="p">[]</span>
  <span class="nx">errors</span><span class="o">:</span> <span class="p">(</span><span class="kt">string</span> <span class="o">|</span> <span class="nx">CompilerError</span><span class="p">)[]</span>
  <span class="nx">map?</span>: <span class="kt">RawSourceMap</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
SFCTemplateCompileOptions 模板编译器选项</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SFCTemplateCompileOptions</span> <span class="p">{</span>
  <span class="nx">source</span>: <span class="kt">string</span>
  <span class="nx">filename</span>: <span class="kt">string</span>
  <span class="nx">id</span>: <span class="kt">string</span>
  <span class="nx">scoped?</span>: <span class="kt">boolean</span>
  <span class="nx">isProd?</span>: <span class="kt">boolean</span>
  <span class="nx">ssr?</span>: <span class="kt">boolean</span>
  <span class="nx">ssrCssVars?</span>: <span class="kt">string</span><span class="p">[]</span>
  <span class="nx">inMap?</span>: <span class="kt">RawSourceMap</span>
  <span class="nx">compiler?</span>: <span class="kt">TemplateCompiler</span>
  <span class="nx">compilerOptions?</span>: <span class="kt">CompilerOptions</span>
  <span class="nx">preprocessLang?</span>: <span class="kt">string</span>
  <span class="nx">preprocessOptions?</span>: <span class="kt">any</span>
  <span class="cm">/**
</span><span class="cm">   * In some cases, compiler-sfc may not be inside the project root (e.g. when
</span><span class="cm">   * linked or globally installed). In such cases a custom `require` can be
</span><span class="cm">   * passed to correctly resolve the preprocessors.
</span><span class="cm">   */</span>
  <span class="nx">preprocessCustomRequire</span><span class="o">?:</span> <span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span>
  <span class="cm">/**
</span><span class="cm">   * Configure what tags/attributes to transform into asset url imports,
</span><span class="cm">   * or disable the transform altogether with `false`.
</span><span class="cm">   */</span>
  <span class="nx">transformAssetUrls?</span>: <span class="kt">AssetURLOptions</span> <span class="o">|</span> <span class="nx">AssetURLTagConfig</span> <span class="o">|</span> <span class="kr">boolean</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
及 compileTemplate 函数</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">compileTemplate</span><span class="p">(</span>
  <span class="nx">options</span>: <span class="kt">SFCTemplateCompileOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">SFCTemplateCompileResults</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">SFCTemplateCompileResults</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-9" class="outline-3">
<h3 id="headline-9">
<span class="todo">TODO</span>
1b2965f coding compileTemplate
</h3>
<div id="outline-text-headline-9" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1b2965fb3d45c450f0b8af66c54834a0ecc8d219">feat: sfc-&gt;compile compileTemplate code · gcclll/stb-vue-next@1b2965f</a></p>
<p>
这个函数相关的内容：</p>
<ol>
<li>
<p>preprocessLang</p>
</li>
<li>
<p>preprocessCustomRequire</p>
</li>
</ol>
<p>TODO 模板预处理器，没搞明白这里是要做什么？</p>
<p>
代码逻辑：</p>
<p>
if preprocessor -&gt; doCompileTemplate()</p>
<p>
elseif preprocessLang -&gt; …</p>
<p>
else -&gt; doCompileTemplate()</p>
<blockquote>
<p>⏹ 等待探索……</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-10" class="outline-3">
<h3 id="headline-10">
7b49db4 coding doCompileTemplate 函数实现
</h3>
<div id="outline-text-headline-10" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7b49db43ed8b1535d423b9143b3019fd5556be8a">feat(add): sfc-&gt;compile doCompileTemplate · gcclll/stb-vue-next@7b49db4</a></p>
<p>
函数功能：收集两个 transform 给 compiler.compile 在模板编译期间使用。</p>
<ol>
<li>
<p>asset url 资源地址转换用的 transform</p>
<p>
要处理的标签和对应的包含 url 的属性:</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>prop with url</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;video&gt;</code></td>
<td>&#39;src&#39;, &#39;poster&#39;</td>
</tr>
<tr>
<td><code>&lt;source&gt;</code></td>
<td>&#39;src&#39;</td>
</tr>
<tr>
<td><code>&lt;img&gt;</code></td>
<td>&#39;src&#39;</td>
</tr>
<tr>
<td><code>&lt;image&gt;</code></td>
<td>&#39;xlink:href&#39;, &#39;href&#39;</td>
</tr>
<tr>
<td><code>&lt;use&gt;</code></td>
<td>&#39;xlink:href&#39;, &#39;href&#39;</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>img/source 标签 src 地址转换</p>
</li>
</ol>
<p>
重点代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">shortId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^data-v-/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">longId</span> <span class="o">=</span> <span class="sb">`data-v-</span><span class="si">${</span><span class="nx">shortId</span><span class="si">}</span><span class="sb">`</span>

  <span class="kd">let</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">preamble</span><span class="p">,</span> <span class="nx">map</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compiler</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span>
    <span class="nx">prefixIdentifiers</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">hoistStatic</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">cacheHandlers</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">ssrCssVars</span>:
      <span class="kt">ssr</span> <span class="o">&amp;&amp;</span> <span class="nx">ssrCssVars</span> <span class="o">&amp;&amp;</span> <span class="nx">ssrCssVars</span><span class="p">.</span><span class="nx">length</span>
        <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="cm">/* TODO genCssVarsFromList(ssrCssVars, shortId, isProd) */</span>
        <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="c1">// css 局部使用，加上对应的唯一 id
</span><span class="c1"></span>    <span class="nx">scopeId</span>: <span class="kt">scoped</span> <span class="o">?</span> <span class="nx">longId</span> : <span class="kt">undefined</span><span class="p">,</span>
    <span class="p">...</span><span class="nx">compilerOptions</span><span class="p">,</span>
    <span class="nx">nodeTransforms</span>: <span class="kt">nodeTransforms.concat</span><span class="p">(</span><span class="nx">compilerOptions</span><span class="p">.</span><span class="nx">nodeTransforms</span> <span class="o">||</span> <span class="p">[]),</span>
    <span class="nx">filename</span><span class="p">,</span>
    <span class="nx">sourceMap</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">onError</span>: <span class="kt">e</span> <span class="o">=&gt;</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
将 <code>nodeTransforms: [transformAssetUrl, transformSrcset]</code> 传递给编译器处理。</p>
<p>
注意这里设置了几个属性： <code>mode = &#39;module&#39;, prefixIdentifiers = true</code> 所以这个应
该只能运行在非浏览器环境。</p>
<p>
下面来实现一个相对简单的 <code>transformAssetUrl()</code> 函数 ……</p>
</div>
</div>
<div id="outline-container-headline-11" class="outline-3">
<h3 id="headline-11">
2d82400 coding transformAssetUrl 转换资源 url
</h3>
<div id="outline-text-headline-11" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2d8240089e6d7642a0f2234b6addff8e0d9885cd">feat(add): sfc-&gt;compile templateTransformAssetUrl · gcclll/stb-vue-next@2d82400</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e08f8059612591a6b38d6e813e305986fc7f646a">fix: sfc preprocess function · gcclll/stb-vue-next@e08f805</a></p>
<p>
几种URL使用情况和转换结果如下实例：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileTemplate</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compileTemplate</span><span class="p">({</span>
  <span class="nx">source</span><span class="o">:</span> <span class="sb">`&lt;template&gt;&lt;div id=&#34;test&#34;&gt;
</span><span class="sb">&lt;img src=&#34;./test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;./test/test.png&#34; /&gt;
</span><span class="sb">&lt;img :src=&#34;imgUrl&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;http://1.1.1.1:100/imgs/test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;data:....&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;#test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;~test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;~/test/test.png&#34; /&gt;
</span><span class="sb">&lt;img src=&#34;@test/test.png&#34; /&gt;
</span><span class="sb">&lt;video src=&#34;./test/video.mp4&#34; poster=&#34;./test/poster.png&#34; /&gt;
</span><span class="sb">&lt;div src=&#34;./test/test.png&#34; /&gt;
</span><span class="sb">
</span><span class="sb">&lt;/div&gt;&lt;/template&gt;`</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;test.vue&#39;</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;
import _imports_0 from &#39;./test/test.png&#39;
import _imports_1 from &#39;test/test.png&#39;
import _imports_2 from &#39;@test/test.png&#39;
import _imports_3 from &#39;./test/video.mp4&#39;
import _imports_4 from &#39;./test/poster.png&#39;


const _hoisted_1 = { id: &#34;test&#34; }
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_0 }, null, -1 /* HOISTED */)
const _hoisted_3 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_0 }, null, -1 /* HOISTED */)
const _hoisted_4 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;&#34; }, null, -1 /* HOISTED */)
const _hoisted_5 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;http://1.1.1.1:100/imgs/test/test.png&#34; }, null, -1 /* HOISTED */)
const _hoisted_6 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;data:....&#34; }, null, -1 /* HOISTED */)
const _hoisted_7 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: &#34;#test/test.png&#34; }, null, -1 /* HOISTED */)
const _hoisted_8 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_1 }, null, -1 /* HOISTED */)
const _hoisted_9 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_1 }, null, -1 /* HOISTED */)
const _hoisted_10 = /*#__PURE__*/_createVNode(&#34;img&#34;, { src: _imports_2 }, null, -1 /* HOISTED */)
const _hoisted_11 = /*#__PURE__*/_createVNode(&#34;video&#34;, {
  src: _imports_3,
  poster: _imports_4
}, null, -1 /* HOISTED */)
const _hoisted_12 = /*#__PURE__*/_createVNode(&#34;div&#34;, { src: &#34;./test/test.png&#34; }, null, -1 /* HOISTED */)

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(&#34;template&#34;, null, [
    _createVNode(&#34;div&#34;, _hoisted_1, [
      _hoisted_2,
      _hoisted_3,
      _createVNode(&#34;img&#34;, { src: _ctx.imgUrl }, null, 8 /* PROPS */, [&#34;src&#34;]),
      _hoisted_4,
      _hoisted_5,
      _hoisted_6,
      _hoisted_7,
      _hoisted_8,
      _hoisted_9,
      _hoisted_10,
      _hoisted_11,
      _hoisted_12
    ])
  ]))
}
undefined
</pre>
<p>
模板中资源URL不转换几种情况：</p>
<ol>
<li>
<p>属性不是静态属性(<code>NodeTypes.ATTRIBUTE</code>)</p>
</li>
<li>
<p>非特定标签的不转换(或者通过 <code>options.tags</code> 里指定的标签)</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">tags:</span> <span class="p">{</span>
  <span class="err">video:</span> <span class="err">[&#39;src&#39;,</span> <span class="err">&#39;poster&#39;],</span>
  <span class="err">source:</span> <span class="err">[&#39;src&#39;],</span>
  <span class="err">img:</span> <span class="err">[&#39;src&#39;],</span>
  <span class="err">image:</span> <span class="err">[&#39;xlink:href&#39;,</span> <span class="err">&#39;href&#39;],</span>
  <span class="err">use:</span> <span class="err">[&#39;xlink:href&#39;,</span> <span class="err">&#39;href&#39;]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>没有属性值的属性</p>
</li>
<li>
<p>外部链接的URL(<code>https</code> 开头的)</p>
</li>
<li>
<p><code>data:</code> 开头的资源地址</p>
</li>
<li>
<p>属性值以 <code>#</code> 开头的地址</p>
</li>
<li>
<p>非绝对路径且费相对路径的(以， <code>.|~|@</code> 开头的地址)</p>
</li>
</ol>
<p>
需要处理的又分两种情况：</p>
<ol>
<li>
<p>给定了 <code>options.base</code> 基地址的(<code>.|~|@</code> 为第一个字符的)</p>
<p>
直接用 <code>options.base + assert url</code> 处理</p>
</li>
<li>
<p>非1中清空的使用 <code>import imgName from &#39;...img url&#39;</code> 引入</p>
</li>
</ol>
<blockquote>
<p>PS. 对于 CSS 中的URL引用放到后续 compileStyle 中去展示。</p>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-12" class="outline-2">
<h2 id="headline-12">
56358a8 compile &lt;style&gt;
</h2>
<div id="outline-text-headline-12" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/56358a8b2cf95ef6a2df125c672a455690785a84">feat(add): sfc-&gt; compile style · gcclll/stb-vue-next@56358a8</a></p>
<p>
这部分代码都是直接 Ctrl-c, Ctrl-v 来的，也没深入研究，所以这节也没什么好讲述的。</p>
<p>
待到以后有时间再来研究。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileStyle</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">option</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">=&gt;</span> <span class="nx">compileStyle</span><span class="p">({</span>
  <span class="nx">source</span><span class="p">,</span>
  <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;test.css&#39;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;data-v-test&#39;</span><span class="p">,</span>
  <span class="nx">scoped</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">...</span><span class="nx">option</span>
<span class="p">})</span>

<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="sb">`
</span><span class="sb">h1 { color: red; }
</span><span class="sb">.foo { color: red; }
</span><span class="sb">h1 .foo { color: red; }
</span><span class="sb">h1 .foo, .bar, .baz { color: red; }
</span><span class="sb">.foo:after { color: red; }
</span><span class="sb">::selection { display: none; }
</span><span class="sb">.abc, ::selection { color: red; }
</span><span class="sb">
</span><span class="sb">:deep(.foo) { color: red; }
</span><span class="sb">::v-deep(.foo) { color: red; }
</span><span class="sb">::v-deep(.foo .bar) { color: red; }
</span><span class="sb">.baz .qux ::v-deep(.foo .bar) { color: red; }
</span><span class="sb">
</span><span class="sb">:slotted(.foo) { color: red; }
</span><span class="sb">::v-slotted(.foo) { color: red; }
</span><span class="sb">::v-slotted(.foo .bar) { color: red; }
</span><span class="sb">.baz .qux ::v-slotted(.foo .bar) { color: red; }
</span><span class="sb">
</span><span class="sb">:global(.foo) { color: red; }
</span><span class="sb">::v-global(.foo) { color: red; }
</span><span class="sb">::v-global(.foo .bar) { color: red; }
</span><span class="sb">.baz .qux ::v-global(.foo .bar) { color: red; }
</span><span class="sb">
</span><span class="sb">@media print { .foo { color: red }}
</span><span class="sb">@supports(display: grid) { .foo { display: grid }}
</span><span class="sb">
</span><span class="sb">.anim {
</span><span class="sb">  animation: color 5s infinite, other 5s;
</span><span class="sb">}
</span><span class="sb">.anim-2 {
</span><span class="sb">  animation-name: color;
</span><span class="sb">  animation-duration: 5s;
</span><span class="sb">}
</span><span class="sb">.anim-3 {
</span><span class="sb">  animation: 5s color infinite, 5s other;
</span><span class="sb">}
</span><span class="sb">.anim-multiple {
</span><span class="sb">  animation: color 5s infinite, opacity 2s;
</span><span class="sb">}
</span><span class="sb">.anim-multiple-2 {
</span><span class="sb">  animation-name: color, opacity;
</span><span class="sb">  animation-duration: 5s, 2s;
</span><span class="sb">}
</span><span class="sb">
</span><span class="sb">@keyframes color {
</span><span class="sb">  from { color: red; }
</span><span class="sb">  to { color: green; }
</span><span class="sb">}
</span><span class="sb">@-webkit-keyframes color {
</span><span class="sb">  from { color: red; }
</span><span class="sb">  to { color: green; }
</span><span class="sb">}
</span><span class="sb">@keyframes opacity {
</span><span class="sb">  from { opacity: 0; }
</span><span class="sb">  to { opacity: 1; }
</span><span class="sb">}
</span><span class="sb">@-webkit-keyframes opacity {
</span><span class="sb">  from { opacity: 0; }
</span><span class="sb">  to { opacity: 1; }
</span><span class="sb">}
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

h1[data-v-test] { color: red;
}
.foo[data-v-test] { color: red;
}
h1 .foo[data-v-test] { color: red;
}
h1 .foo[data-v-test], .bar[data-v-test], .baz[data-v-test] { color: red;
}
.foo[data-v-test]:after { color: red;
}
[data-v-test]::selection { display: none;
}
.abc[data-v-test],[data-v-test]::selection { color: red;
}
[data-v-test] .foo { color: red;
}
[data-v-test] .foo { color: red;
}
[data-v-test] .foo .bar { color: red;
}
.baz .qux[data-v-test] .foo .bar { color: red;
}
.foo[data-v-test-s] { color: red;
}
.foo[data-v-test-s] { color: red;
}
.foo .bar[data-v-test-s] { color: red;
}
.baz .qux .foo .bar[data-v-test-s] { color: red;
}
.foo { color: red;
}
.foo { color: red;
}
.foo .bar { color: red;
}
.foo .bar { color: red;
}
@media print {
.foo[data-v-test] { color: red
}}
@supports(display: grid) {
.foo[data-v-test] { display: grid
}}
.anim[data-v-test] {
  animation: color-test 5s infinite, other 5s;
}
.anim-2[data-v-test] {
  animation-name: color-test;
  animation-duration: 5s;
}
.anim-3[data-v-test] {
  animation: 5s color-test infinite, 5s other;
}
.anim-multiple[data-v-test] {
  animation: color-test 5s infinite,opacity-test 2s;
}
.anim-multiple-2[data-v-test] {
  animation-name: color-test,opacity-test;
  animation-duration: 5s, 2s;
}
@keyframes color-test {
from { color: red;
}
to { color: green;
}
}
@-webkit-keyframes color-test {
from { color: red;
}
to { color: green;
}
}
@keyframes opacity-test {
from { opacity: 0;
}
to { opacity: 1;
}
}
@-webkit-keyframes opacity-test {
from { opacity: 0;
}
to { opacity: 1;
}
}

undefined
</pre>
<blockquote>
<p>PS. 对于 CSS 的解析需要 postcss 以及各种预处理来处理，这里暂时不展开。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-13" class="outline-2">
<h2 id="headline-13">
4d66531 compile &lt;script&gt;<sup>重点</sup>
</h2>
<div id="outline-text-headline-13" class="outline-text-2">
<p>
这节会是重点部分。</p>
<p>
<img src="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" alt="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" title="/img/vue3/compiler-sfc/vue-compiler-sfc-compile-script.svg" /></p>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
init compileScript function
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<p>
初始化 <code>compileScript()</code> 函数以及参数选项类型 <code>SFCScriptCompileOptions</code></p>
<p>
SFCScriptCompileOptions:</p>
<ul>
<li>
<p><code>id: string</code>, 传递给 <code>compileStyle</code> 用于作为 injected CSS 变量前缀用</p>
</li>
<li>
<p><code>isProd?: boolean</code> 决定生成的 CSS 变量是否要加上 hash 值</p>
</li>
<li>
<p><code>babelParserPlugins?: ParserPlugin[]</code></p>
</li>
<li>
<p><code>refSugar?: boolean</code> 使能 <code>ref</code> 语法糖</p>
</li>
<li>
<p><code>inlineTemplate?: boolean</code> 内联模板？？？</p>
</li>
</ul>
<p>
compileScript:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> * Compile `&lt;script setup&gt;`
</span><span class="cm"> * It requires the whole SFC descriptor because we need to handle and merge
</span><span class="cm"> * normal `&lt;script&gt;` + `&lt;script setup&gt;` if both are present.
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">compileScript</span><span class="p">(</span>
  <span class="nx">sfc</span>: <span class="kt">SFCDescriptor</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">SFCScriptCompileOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">SFCScriptBlock</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">SFCScriptBlock</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/54ea72a4fd3d2ccdce268714f0ef205fa9e9b976">feat(add): sfc-&gt;script, compileScript steps comment ·
gcclll/stb-vue-next@54ea72a</a></p>
<p>
列出 compileScript() 将要完成的任务：</p>
<table>
<thead>
<tr>
<th class="align-right">No.</th>
<th>Desc</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="align-right">0</td>
<td>前置处理</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">1</td>
<td>处理存在的 &lt;script&gt; 代码体</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">2</td>
<td>解析 &lt;script setup&gt;，遍历置顶的语句</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">3</td>
<td>将 ref访问转换成对 ref.value 的引用</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">4</td>
<td>释放 setup 上下文类型的运行时 props/emits 代码</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">5</td>
<td>检查用户选项(useOptions)参数，确保它没有引用 setup 下的变量</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">6</td>
<td>删除 non-script 的内容</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">7</td>
<td>分析 binding metadata</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">8</td>
<td>注入 `useCssVars` 调用</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">9</td>
<td>完成 setup() 参数签名</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">10</td>
<td>生成返回语句(return)</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">11</td>
<td>完成 default export</td>
<td>-</td>
</tr>
<tr>
<td class="align-right">12</td>
<td>完成 Vue helpers imports</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>
接下来就是按照上表的步骤来一步步完成 <code>compileScript()</code></p>
<blockquote>
<p>PS. 下面每个对应章节都有对应的原版英文注释，英语不好~~~~~。</p>
</blockquote>
<p>
增加一些逻辑无关的变量声明：
<a href="https://github.com/gcclll/stb-vue-next/commit/06f1d95b352452cd2f3999e431b2a2bf60dc37c4">feat(add): sfc-&gt;script compileScript declarations · gcclll/stb-vue-next@06f1d95</a></p>
<p>
在进入正式步骤之前，来简单看看使用到的 <code>@babel/parser</code> 这个插件是如何使用的，输
出结果又是啥？</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BABEL_DIR</span> <span class="o">+</span> <span class="s1">&#39;/parser/lib/index.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
<span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">import { a } from &#39;./a.js&#39;;
</span><span class="sb">
</span><span class="sb">const value = 1 * 10 + 100 - 20 / 30 + 1
</span><span class="sb">export const name = a.getName();
</span><span class="sb">
</span><span class="sb">export default { name }
</span><span class="sb">`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">body</span> <span class="p">=&gt;</span> <span class="nx">body</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
ImportDeclaration
VariableDeclaration
ExportNamedDeclaration
ExportDefaultDeclaration
undefined
</pre>
<p>
以上输出是每个语句在 parser 中对应的 AST 类型。</p>
</div>
</div>
<div id="outline-container-script-0" class="outline-3">
<h3 id="script-0">
0⃣ d7369ae 无 &lt;script setup&gt; 时
</h3>
<div id="outline-text-script-0" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d7369ae572e45ea9f6f32aa6bdfe534b1f5dda39">feat(add): script without setup-script parse · gcclll/stb-vue-next@d7369ae</a></p>
<p>
一开始会检测有没有 <code>script setup</code> 如果没有，继续检测 <code>&lt;script&gt;</code> 普通标签，如果两
者都不存在，抛出异常。</p>
<p>
如果 <code>&lt;script&gt;</code> 存在，则直接调用 <code>@babel/parser</code> 的 <a href="https://babeljs.io/docs/en/babel-parser#babelparserparsecode-options">parse</a> 函数进行解析，因此后面
一坨代码在这种情况下(只有普通的 <code>script</code> 时)是不需要的。</p>
<p>
新增代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">scriptAst</span> <span class="o">=</span> <span class="nx">_parse</span><span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">plugins</span><span class="p">,</span>
    <span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span>
<span class="p">}).</span><span class="nx">program</span><span class="p">.</span><span class="nx">body</span>
<span class="kr">const</span> <span class="nx">bindings</span> <span class="o">=</span> <span class="nx">analyzeScriptBindings</span><span class="p">(</span><span class="nx">scriptAst</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">needRewrite</span> <span class="o">=</span> <span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">hasInheritAttrsFlag</span>
<span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">content</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">needRewrite</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// TODO need rewrite
</span><span class="c1"></span><span class="p">}</span>
<span class="k">return</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">script</span><span class="p">,</span>
    <span class="nx">content</span><span class="p">,</span>
    <span class="nx">bindings</span><span class="p">,</span>
    <span class="nx">scriptAst</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">import { a } from &#39;./a.js&#39;;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">scriptAst</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
script
 [
  Node {
    type: &#39;ImportDeclaration&#39;,
    start: 1,
    end: 28,
    loc: SourceLocation {
      start: [Position],
      end: [Position],
      filename: undefined,
      identifierName: undefined
    },
    range: undefined,
    leadingComments: undefined,
    trailingComments: undefined,
    innerComments: undefined,
    extra: undefined,
    specifiers: [ [Node] ],
    source: Node {
      type: &#39;StringLiteral&#39;,
      start: 19,
      end: 27,
      loc: [SourceLocation],
      range: undefined,
      leadingComments: undefined,
      trailingComments: undefined,
      innerComments: undefined,
      extra: [Object],
      value: &#39;./a.js&#39;
    }
  }
]
undefined
</pre>
<p>
示例：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">  export default {
</span><span class="sb">    props: [&#39;foo&#39;, &#39;bar&#39;]
</span><span class="sb">  }
</span><span class="sb">&lt;/script&gt;`</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">scriptAst</span><span class="o">:</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="c1">// 首先是个 ExportDefaultDeclaration 类型
</span><span class="c1">// export 的值为一个 ObjectExpression 类型
</span><span class="c1"></span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; &lt;script&gt; 解析后的类型`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; export default 解析后的类型`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; { props : ... } 解析后的 ast 包含的 keys`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">declaration</span><span class="p">))</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; properties 为 ObjectExpression 对象的成员列表，如： props`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">elements</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: 精简之后的输出</p>
<pre class="example">
&gt;&gt;&gt; &lt;script&gt; 解析后的类型
script
&gt;&gt;&gt; export default 解析后的类型
ExportDefaultDeclaration
&gt;&gt;&gt; { props : ... } 解析后的 ast 包含的 keys
[
  &#39;type&#39;,
  &#39;start&#39;,
  &#39;end&#39;,
  &#39;loc&#39;,
  &#39;range&#39;,
  &#39;leadingComments&#39;,
  &#39;trailingComments&#39;,
  &#39;innerComments&#39;,
  &#39;extra&#39;,
  &#39;properties&#39;
]
&gt; properties 为 ObjectExpression 对象的成员列表，如： props
{
  type: &#39;ObjectProperty&#39;,
  key: Node {
    type: &#39;Identifier&#39;,
    name: &#39;props&#39;
  },
  value: Node {
    type: &#39;ArrayExpression&#39;,
    elements: [ [Node], [Node] ]
  }
}
[
  Node {
    type: &#39;StringLiteral&#39;,
    extra: { rawValue: &#39;foo&#39;, raw: &#34;&#39;foo&#39;&#34; },
    value: &#39;foo&#39;
  },
  Node {
    type: &#39;StringLiteral&#39;,
    extra: { rawValue: &#39;bar&#39;, raw: &#34;&#39;bar&#39;&#34; },
    value: &#39;bar&#39;
  }
]
</pre>
</div>
</div>
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
819a413 export default {} 解析
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/819a413020da1584de0c73b7f67ed0aec0d9cb86">feat(add): sfc-&gt;script, parse export default members into bindings · gcclll/stb-vue-next@819a413</a></p>
<p>
<code>(property.type === &#39;ObjectMethod&#39; &amp;&amp;property.key.type === &#39;Identifier&#39; &amp;&amp;(property.key.name === &#39;setup&#39; || property.key.name === &#39;data&#39;))</code></p>
<p>
成员最后在 <code>bindings</code> 里面存在类型值：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type(<code>BindingTypes</code>)</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>props</code></td>
<td>&#39;PROPS&#39;</td>
<td>&#39;props&#39;</td>
</tr>
<tr>
<td><code>inject</code></td>
<td>&#39;PROPS&#39;</td>
<td>&#39;props&#39;</td>
</tr>
<tr>
<td><code>computed</code></td>
<td>&#39;OPTIONS&#39;</td>
<td>&#39;options&#39;</td>
</tr>
<tr>
<td><code>methods</code></td>
<td>&#39;OPTIONS&#39;</td>
<td>&#39;options&#39;</td>
</tr>
</tbody>
<tbody>
<tr>
<td><code>setup</code></td>
<td>SETUP_MAYBE_REF</td>
<td>&#39;setup-maybe-ref&#39;</td>
</tr>
<tr>
<td><code>data</code></td>
<td>SETUP_MAYBE_REF</td>
<td>&#39;setup-maybe-ref&#39;</td>
</tr>
</tbody>
</table>
<p>
到这里还只是借助 <code>@babel/parser</code> 进行了解析，vue 自身的一些特性处理在
<code>analyzeScriptBindings()</code> 中，这个函数解析的类型是 <code>ExportDefaultDeclaration</code> 也
就是 <code>export default {}</code> 的代码部分。</p>
<p>
然后调用 <code>analyzeBindingsFromOptions(node.declaration)</code> 解析对象成员，这里要处理
的主要有两种：</p>
<ol>
<li>
<p><code>ObjectProperty</code> 属性类型成员</p>
<p>
<code>(property.type === &#39;ObjectProperty&#39; &amp;&amp;!property.computed &amp;&amp;property.key.type === &#39;Identifier&#39;)</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span>
<span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default {
</span><span class="sb"> props: [&#39;firstName&#39;, &#39;secondName&#39;],
</span><span class="sb"> inject: { foo: {} },
</span><span class="sb"> computed: {
</span><span class="sb">   fullName() {
</span><span class="sb">     return this.firstName + this.secondName + this.thirdName
</span><span class="sb">   }
</span><span class="sb"> },
</span><span class="sb"> methods: {
</span><span class="sb">   getName() {
</span><span class="sb">     return this.fullName
</span><span class="sb">   }
</span><span class="sb"> }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  firstName: &#39;props&#39;,
  secondName: &#39;props&#39;,
  foo: &#39;options&#39;,
  fullName: &#39;options&#39;,
  getName: &#39;options&#39;
}
undefined
</pre>
</li>
<li>
<p><code>ObjectMethod</code> 方法类型成员，且只处理 <code>setup</code> 和 <code>data</code> 方法</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c7b617bdad949c6db98ab6eb71caa00dbc7dec26">feat(add): sfc-&gt;script, parse export default data&amp;setup into bingdings · gcclll/stb-vue-next@c7b617b</a></p>
<p>
需要增加代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span>
   <span class="nx">property</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ObjectMethod&#39;</span> <span class="o">&amp;&amp;</span>
   <span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;Identifier&#39;</span> <span class="o">&amp;&amp;</span>
   <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;setup&#39;</span> <span class="o">||</span> <span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
 <span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">bodyItem</span> <span class="k">of</span> <span class="nx">property</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// setup() {
</span><span class="c1"></span>     <span class="c1">//   return {
</span><span class="c1"></span>     <span class="c1">//     foo: null
</span><span class="c1"></span>     <span class="c1">//   }
</span><span class="c1"></span>     <span class="c1">// }
</span><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span>
       <span class="nx">bodyItem</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ReturnStatement&#39;</span> <span class="o">&amp;&amp;</span>
       <span class="nx">bodyItem</span><span class="p">.</span><span class="nx">argument</span> <span class="o">&amp;&amp;</span>
       <span class="nx">bodyItem</span><span class="p">.</span><span class="nx">argument</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ObjectExpression&#39;</span>
     <span class="p">)</span> <span class="p">{</span>
       <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">getObjectExpressionKeys</span><span class="p">(</span><span class="nx">bodyItem</span><span class="p">.</span><span class="nx">argument</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">bindings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>
           <span class="o">?</span> <span class="nx">BindingTypes.SETUP_MAYBE_REF</span>
           : <span class="kt">BindingTypes.DATA</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span>
<span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default {
</span><span class="sb">setup() {
</span><span class="sb"> return {
</span><span class="sb">   foo: null
</span><span class="sb"> }
</span><span class="sb">},
</span><span class="sb">data() {
</span><span class="sb"> return {
</span><span class="sb">   bar: null
</span><span class="sb"> }
</span><span class="sb">},
</span><span class="sb">props: [&#39;baz&#39;]
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{ foo: &#39;setup-maybe-ref&#39;, bar: &#39;setup-maybe-ref&#39;, baz: &#39;props&#39; }
undefined
</pre>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-17" class="outline-3">
<h3 id="headline-17">
测试
</h3>
<div id="outline-text-headline-17" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span>
  <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span> <span class="s1">&#39;/dist/compiler-sfc.cjs.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/utils.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxx&#39;</span> <span class="p">})</span>
<span class="p">}</span>

<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; setup return`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">const bar = 2
</span><span class="sb">  export default {
</span><span class="sb">    setup() {
</span><span class="sb">    return {
</span><span class="sb">        foo: 1,
</span><span class="sb">        bar
</span><span class="sb">    }
</span><span class="sb">  }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; async setup return`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">const bar = 2
</span><span class="sb">  export default {
</span><span class="sb">    async setup() {
</span><span class="sb">      return {
</span><span class="sb">        foo: 1,
</span><span class="sb">        bar
</span><span class="sb">      }
</span><span class="sb">  }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; computeds`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">    &lt;script&gt;
</span><span class="sb">    export default {
</span><span class="sb">      computed: {
</span><span class="sb">        foo() {},
</span><span class="sb">        bar: {
</span><span class="sb">            get() {},
</span><span class="sb">            set() {},
</span><span class="sb">        }
</span><span class="sb">      }
</span><span class="sb">    }
</span><span class="sb">    &lt;/script&gt;
</span><span class="sb">`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 混合 bindings`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">    &lt;script&gt;
</span><span class="sb">    export default {
</span><span class="sb">      inject: [&#39;foo&#39;],
</span><span class="sb">        props: {
</span><span class="sb">        bar: String,
</span><span class="sb">      },
</span><span class="sb">      setup() {
</span><span class="sb">        return {
</span><span class="sb">            baz: null,
</span><span class="sb">        }
</span><span class="sb">      },
</span><span class="sb">      data() {
</span><span class="sb">        return {
</span><span class="sb">            qux: null
</span><span class="sb">        }
</span><span class="sb">      },
</span><span class="sb">      methods: {
</span><span class="sb">        quux() {}
</span><span class="sb">      },
</span><span class="sb">      computed: {
</span><span class="sb">        quuz() {}
</span><span class="sb">      }
</span><span class="sb">    }
</span><span class="sb">    &lt;/script&gt;
</span><span class="sb">`</span><span class="p">).</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
1⃣ eb650ca 解析 &lt;script&gt;
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/eb650ca301b2e27f47ad53aa5ff8f16b3161b3f9">feat(add): sfc-&gt;script, export default handle · gcclll/stb-vue-next@eb650ca</a></p>
<div class="comment-block">
<p>process normal &lt;script&gt; first if it exists</p>
</div>
<p>
用到的插件：</p>
<table>
<thead>
<tr>
<th>Plugin</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://babeljs.io/docs/en/babel-parser">@babel/parser · Babel</a></td>
</tr>
</tbody>
</table>
<p>
这一节中的普通 &lt;script&gt; 前提是，至少有一个 <code>&lt;script setup&gt;</code> 存在，否则会直接在
<a href="#script-0">上一节</a> 就退出解析了。</p>
<p>
@babel/parser 解析 import 结果对照表</p>
<table>
<thead>
<tr>
<th>段</th>
<th>类型</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>import { a } from &#39;./x&#39;</code></td>
<td><code>ImportDeclaration</code></td>
<td>…</td>
</tr>
<tr>
<td><code>a</code></td>
<td><code>ImportSpecifier</code></td>
<td><code>node.specifiers[i].imported.name</code></td>
</tr>
<tr>
<td><code>&#39;./x&#39;</code></td>
<td><code>StringLiteral</code></td>
<td><code>node.source.value</code></td>
</tr>
</tbody>
</table>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BABEL_DIR</span> <span class="o">+</span> <span class="s1">&#39;/parser/lib/index.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">import { a } from &#39;./x&#39;`</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span> <span class="p">}).</span><span class="nx">program</span><span class="p">.</span><span class="nx">body</span>
<span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">spec</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; node type &gt; </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; node source type &gt; </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; node source value &gt; </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; spec type &gt; </span><span class="si">${</span><span class="nx">spec</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; spec imported type &gt; </span><span class="si">${</span><span class="nx">spec</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; spec imported name &gt; </span><span class="si">${</span><span class="nx">spec</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; node type &gt; ImportDeclaration
&gt;&gt;&gt; node source type &gt; StringLiteral
&gt;&gt;&gt; node source value &gt; ./x
&gt;&gt;&gt; spec type &gt; ImportSpecifier
&gt;&gt;&gt; spec imported type &gt; Identifier
&gt;&gt;&gt; spec imported name &gt; a
</pre>
<p>
所以 vue-next 中新增的代码处理逻辑：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// import ... from &#39;./x&#39; 语句类型
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ImportDeclaration&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// record imports for dedupe
</span><span class="c1"></span>  <span class="c1">// import 进来的变量列表
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">specifier</span> <span class="k">of</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 变量名
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">imported</span> <span class="o">=</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;ImportSpecifier&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;Identifier&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span>
    <span class="c1">// 注册到 userImports[local] = { isType, imported, source } 中
</span><span class="c1"></span>    <span class="nx">registerUserImport</span><span class="p">(</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
      <span class="nx">specifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="nx">imported</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">importKind</span> <span class="o">===</span> <span class="s1">&#39;type&#39;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
然后 compileScript 中有一段处理不明白：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">scriptSetup</span> <span class="o">&amp;&amp;</span> <span class="nx">scriptSetupLang</span> <span class="o">!==</span> <span class="s1">&#39;ts&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do not process non js/ts script blocks
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">scriptSetup</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里是说如果有 <code>&lt;script setup&gt;</code> 但是类型不是 <strong>ts</strong> 就直接返回 <code>scriptSetup</code> ?</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_SFC</span> <span class="o">+</span>
  <span class="s2">&#34;/dist/compiler-sfc.cjs.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/utils.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">compile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">options</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;xxxx&#34;</span> <span class="p">});</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">import { a, a1, a2 } from &#39;./a&#39;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;
</span><span class="sb">import { b } from &#39;./b&#39;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
handling script ... with setup
userImports &gt;
 [Object: null prototype] {
  a: { isType: false, imported: &#39;a&#39;, source: &#39;./a&#39; },
  a1: { isType: false, imported: &#39;a1&#39;, source: &#39;./a&#39; },
  a2: { isType: false, imported: &#39;a2&#39;, source: &#39;./a&#39; }
}
userImportAlias &gt;
 [Object: null prototype] {}
undefined
</pre>
<p>
到此，因为还没实现 <code>&lt;script setup&gt;</code> 解析，所以只能看到普通 script 标签的处理结果。</p>
<div id="outline-container-headline-19" class="outline-4">
<h4 id="headline-19">
import … from 处理
</h4>
<div id="outline-text-headline-19" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">node</span> <span class="k">of</span> <span class="nx">scriptAst</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// import ... from &#39;...&#39;
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ImportDeclaration&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// record imports for dedupe
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">specifier</span> <span class="k">of</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">imported</span> <span class="o">=</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ImportSpecifier&#34;</span> <span class="o">&amp;&amp;</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;Identifier&#34;</span> <span class="o">&amp;&amp;</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">registerUserImport</span><span class="p">(</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
        <span class="nx">specifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">imported</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">importKind</span> <span class="o">===</span> <span class="s2">&#34;type&#34;</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;userImports &gt; \n&#34;</span><span class="p">,</span> <span class="nx">userImports</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;userImportAlias &gt; \n&#34;</span><span class="p">,</span> <span class="nx">userImportAlias</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
上面处理：遍历 script 中所有 ast 节点，找出 <code>import ... from ...</code> 语句，取出</p>
<p>
引入的文件源部分： <code>node.source.value</code></p>
<p>
引入之后的变量或解构后的变量： <code>imported.name</code></p>
<p>
组成新的结构 <code>{ isType: false, imported: &#39;a&#39;, source: &#39;./a&#39;}</code> 保存到 <code>userImports</code> 中</p>
<p>
修改下，引入多个变量呢？结果如下：</p>
<pre class="example">
userImports &gt;
 [Object: null prototype] {
  a: { isType: false, imported: &#39;a&#39;, source: &#39;./a&#39; },
  a1: { isType: false, imported: &#39;a1&#39;, source: &#39;./a&#39; },
  a2: { isType: false, imported: &#39;a2&#39;, source: &#39;./a&#39; }
</pre>
<p>
每个变量作为一项保存。</p>
</div>
</div>
<div id="outline-container-headline-20" class="outline-4">
<h4 id="headline-20">
export default {} 处理
</h4>
<div id="outline-text-headline-20" class="outline-text-4">
<p>
<code>export default {}</code> 语法的处理：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/* else */</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ExportDefaultDeclaration&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// export default
</span><span class="c1"></span>  <span class="nx">defaultExport</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span><span class="p">;</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">overwrite</span><span class="p">(</span>
    <span class="nx">start</span><span class="p">,</span>
    <span class="nx">start</span> <span class="o">+</span> <span class="sb">`export default`</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="sb">`const </span><span class="si">${</span><span class="nx">defaultTempVar</span><span class="si">}</span><span class="sb"> =`</span>
  <span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
变量 <code>s</code> :</p>
<p>
<code>const s = new MagicString(source)</code></p>
<p>
等于是将 export default 内容赋值给 <code>__default__</code> 变量上。</p>
<p>
<code>export default {...}</code> 处理成 <code>const __default__ =</code></p>
<p>
<a href="https://github.com/Rich-Harris/magic-string">GitHub - Rich-Harris/magic-string: Manipulate strings like a wizard</a></p>
<p>
从仓库介绍:</p>
<blockquote>
<p>Suppose you have some source code. You want to make some light modifications to it - replacing a few characters here and there…</p>
</blockquote>
<p>这个库的作用是用来替换源码中的部分代码的(字符串的一些操作)。</p>
<p>
先看测试吧：输出处理前后的 <code>source -&gt; s</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">[</span><span class="nx">result</span><span class="p">]</span> <span class="o">=</span> <span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">export default {
</span><span class="sb">  data() {},
</span><span class="sb">  computed: {}
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;
</span><span class="sb">export default {}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
handling script ... with setup
----- before -----
&lt;script lang=&#34;ts&#34;&gt;
export default {
  data() {},
  computed: {}
}
&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;
export default {}
&lt;/script&gt;

----- after -----
&lt;script lang=&#34;ts&#34;&gt;
const __default__ = {
  data() {},
  computed: {}
}
&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;
export default {}
&lt;/script&gt;

undefined
</pre>
<p>
结果如上。</p>
<blockquote>
<p>Tip: 请忽略 setup 部分，因为必须要有一个 <code>&lt;script setup&gt;</code> 且必须是 <strong>ts</strong> 语言才能进
入到这部分处理。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-21" class="outline-4">
<h4 id="headline-21">
export … [from] 处理
</h4>
<div id="outline-text-headline-21" class="outline-text-4">
<p>
<code>export { ...} from &#39;...&#39;</code> 的处理。</p>
<p>
如：</p>
<p>
<code>export { x as default } from &#39;./x&#39;</code></p>
<p>
<code>export { x as default }</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/*else*/</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ExportNamedDeclaration&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">defaultSpecifier</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">exported</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;Identifier&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">exported</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;default&#34;</span>
  <span class="p">)</span> <span class="kr">as</span> <span class="nx">ExportSpecifier</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">defaultSpecifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">defaultExport</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
    <span class="c1">// 1. remove specifier
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span>
        <span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span><span class="p">,</span>
        <span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">end</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">end</span><span class="o">!</span> <span class="o">+</span> <span class="nx">scriptStartOffset</span><span class="o">!</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// export { x as default } from &#39;./x&#39;
</span><span class="c1"></span>      <span class="c1">// 重写成 rewrite to `import { x as __default } from &#39;./x&#39;
</span><span class="c1"></span>      <span class="c1">// 然后添加到顶部
</span><span class="c1"></span>      <span class="nx">s</span><span class="p">.</span><span class="nx">prepend</span><span class="p">(</span>
        <span class="sb">`import { </span><span class="si">${</span><span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb"> as </span><span class="si">${</span><span class="nx">defaultTempVar</span><span class="si">}</span><span class="sb"> } from &#39;</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">&#39;</span><span class="err">\</span><span class="sb">n`</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// export { x as default }
</span><span class="c1"></span>      <span class="c1">// 重写成 `const __default__ = x` 且移到最后
</span><span class="c1"></span>      <span class="nx">s</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="sb">`</span><span class="err">\</span><span class="sb">nconst </span><span class="si">${</span><span class="nx">defaultTempVar</span><span class="si">}</span><span class="sb"> = </span><span class="si">${</span><span class="nx">defaultSpecifier</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="err">\</span><span class="sb">n`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;export { a as default } from &#39;./x&#39;&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">const a = {}
</span><span class="sb">export { a as default }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
handling script ... with setup
----- s, source, before -----

&lt;script lang=&#34;ts&#34;&gt;export { a as default } from &#39;./x&#39;&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

----- s, source, after -----
import { a as __default__ } from &#39;./x&#39;

&lt;script lang=&#34;ts&#34;&gt;&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

handling script ... with setup
----- s, source, before -----

&lt;script lang=&#34;ts&#34;&gt;
const a = {}
export { a as default }
&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

----- s, source, after -----

&lt;script lang=&#34;ts&#34;&gt;
const a = {}

&lt;/script&gt;
&lt;script lang=&#34;ts&#34; setup&gt;export default {}&lt;/script&gt;

const __default__ = a

undefined
</pre>
<p>
从文件导入的，放到 <code>source</code> 最前面去了</p>
<p>
用变量导出的，放到 <code>source</code> 最后面去了</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
2⃣ 8edf0d7 解析 &lt;script setup&gt;
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/8edf0d7ad4c77fe9bbb08233f09a313eefa6ca9b">feat(add): sfc-&gt;script, setup ref process · gcclll/stb-vue-next@8edf0d7</a></p>
<p>
如果只保留关键代码，这里的处理主要在 <code>processRefExpression()</code> 中</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// @babel/parser 解析出&lt;script setup&gt; 的 ast
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">scriptSetupAst</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span>
  <span class="nx">scriptSetup</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">...</span><span class="nx">plugins</span><span class="p">,</span>
      <span class="c1">// allow top level await but only inside &lt;script setup&gt;
</span><span class="c1"></span>      <span class="s2">&#34;topLevelAwait&#34;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="nx">sourceType</span><span class="o">:</span> <span class="s2">&#34;module&#34;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">startOffset</span>
<span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">node</span> <span class="k">of</span> <span class="nx">scriptSetupAst</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ... 省略
</span><span class="c1"></span>  <span class="c1">// 处理 `ref: x` 绑定，转成 refs
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;LabeledStatement&#34;</span> <span class="o">&amp;&amp;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">label</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;ref&#34;</span> <span class="o">&amp;&amp;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s2">&#34;ExpressionStatement&#34;</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 必须要开启 ref 功能
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">enableRefSugar</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warnExperimental</span><span class="p">(</span><span class="sb">`ref: sugar`</span><span class="p">,</span> <span class="mi">228</span><span class="p">);</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">overwrite</span><span class="p">(</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">label</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">startOffset</span><span class="p">,</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">boy</span><span class="p">.</span><span class="nx">start</span><span class="o">!</span> <span class="o">+</span> <span class="nx">startOffset</span><span class="p">,</span>
        <span class="s2">&#34;const &#34;</span>
      <span class="p">);</span>
      <span class="nx">processRefExpression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
下面是 processRefExpression 对 <code>ref:</code> 语法糖的各种使用情况分析。</p>
<div id="outline-container-headline-23" class="outline-4">
<h4 id="headline-23">
d4f6497 ref: n = 100
</h4>
<div id="outline-text-headline-23" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d4f649729c860bcd7c3305a11258cb4ef2b803a2">feat(add): sfc-&gt;script, ref: in setup · gcclll/stb-vue-next@d4f6497</a></p>
<p>
将 <code>ref: n = 100</code> 翻译成 <code>const n = _ref(100)</code></p>
<p>
新增核心处理代码：
<img src="http://qiniu.ii6g.com/img/20201226211608.png" alt="http://qiniu.ii6g.com/img/20201226211608.png" title="http://qiniu.ii6g.com/img/20201226211608.png" /></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">const a = {}
</span><span class="sb">export { a as default }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script lang=&#34;ts&#34; setup&gt;
</span><span class="sb">ref: n = 100
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-24" class="outline-4">
<h4 id="headline-24">
db7cb02 ref: { n = 1 } = useFoo()
</h4>
<div id="outline-text-headline-24" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/db7cb021defbc86adb8a2a825315c71359579f27">feat(add): sfc-&gt;script, ref: ({ b: 1} = {}) · gcclll/stb-vue-next@db7cb02</a></p>
<p>
对象解构语法支持。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default { b: 2 }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({ b = 1, foo: bar, nested: { baz: bax } } = { count: 0, b: 2 })
</span><span class="sb">
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
ref: ({ b = 1, foo: bar, nested: { baz: bax } } = { count: 0, b: 2 })

&lt;/script&gt;

---- after ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
const { b: __b = 1, foo: __bar, nested: { baz: __bax } } = { count: 0, b: 2 }

&lt;/script&gt;

undefined
</pre>
<p>
支持解构后重命名：<a href="https://github.com/gcclll/stb-vue-next/commit/e83d25a6ef9a6c2c3f708169fbd9517c96a87dcd">feat(add): sfc-&gt;script, ref: ({ b: bb} = {}) rename · gcclll/stb-vue-next@e83d25a</a></p>
<p>
对象嵌套解构：<a href="https://github.com/gcclll/stb-vue-next/commit/5c615d5c2905f8a50ec1729da4bde68b709ddc43">feat(add): sfc-&gt;script, ref deconstruct nested object · gcclll/stb-vue-next@5c615d5</a></p>
<p>
解构重命名：<a href="https://github.com/gcclll/stb-vue-next/commit/e3ffe6f6cf95748654612cd70855f0818e7757e0">feat(add): sfc-&gt;script, ref deconstruct object rename · gcclll/stb-vue-next@e3ffe6f</a></p>
</div>
</div>
<div id="outline-container-headline-25" class="outline-4">
<h4 id="headline-25">
af26553 ref: [a] = useFoo() 数据解构
</h4>
<div id="outline-text-headline-25" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/af265536bcba6ad3f154b5b944317e4d38b28b2d">feat(add): sfc-&gt;script, ref deconstruct array · gcclll/stb-vue-next@af26553</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default { b: 2 }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({ foo: [bar], baz: [,,bax]} = useFoo())
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
ref: ({ foo: [bar], baz: [,,bax]} = useFoo())
&lt;/script&gt;

---- after ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
const { foo: [__bar], baz: [,,__bax]} = useFoo()
const bar = _ref(__bar);
const bax = _ref(__bax);
&lt;/script&gt;

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-26" class="outline-4">
<h4 id="headline-26">
a9f4469 ref: ({…foo} = useFoo()) 展开符
</h4>
<div id="outline-text-headline-26" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a9f4469f8b47a273b2de5165e59ebd9718f5a07d">feat(add): sfc-&gt;script, ref deconstruct with es6 rest element · gcclll/stb-vue-next@a9f4469</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default { b: 2 }
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({...foo} = useFoo())
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
ref: ({...fo} = useFoo())
&lt;/script&gt;

---- after ----

&lt;script&gt;
const __default__ = { b: 2 }
&lt;/script&gt;
&lt;script setup&gt;
const {...__fo} = useFoo()
&lt;/script&gt;

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-27" class="outline-4">
<h4 id="headline-27">
d52a6d0 _ref(…) 增加 ref 声明
</h4>
<div id="outline-text-headline-27" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d52a6d006f3a741a4787220a3503572ad576d0ba">feat(add): sfc-&gt;script, ref all variables · gcclll/stb-vue-next@d52a6d0</a></p>
<p>
在解析完所有 <code>ref: xxx</code> 语法之后，需要将解构出来的编码，进行 ref 化。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">compileSFC</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;export default {}&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: ({
</span><span class="sb">  a, b: { foo, bar: bax }, c = 1, d: [doo1,, doo3], e: e1 = 2
</span><span class="sb">} = useFoo());
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
ref: ({
  a, b: { foo, bar: bax }, c = 1, d: [doo1,, doo3], e: e1 = 2
} = useFoo());
&lt;/script&gt;

---- after ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
const {
  a: __a, b: { foo: __foo, bar: __bax }, c: __c = 1, d: [__doo1,, __doo3], e: __e1 = 2
} = useFoo();
const a = _ref(__a);
const foo = _ref(__foo);
const bax = _ref(__bax);
const c = _ref(__c);
const doo1 = _ref(__doo1);
const doo3 = _ref(__doo3);
const e1 = _ref(__e1);
&lt;/script&gt;

undefined
</pre>
<p>
到这里 ref 语法才算解析完成了。</p>
<ol>
<li>
<p>借助 <code>@babel/parser</code> 得到 script[setup] ast 处理 ref 及解构语法</p>
</li>
<li>
<p>将解构之后的变量进行 ref 语法化。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-28" class="outline-4">
<h4 id="headline-28">
168041c ref: a = 1, b = 2 多条语句
</h4>
<div id="outline-text-headline-28" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/168041cafd719477b3904f5e6973547c8eb2fe2e">feat(add): sfc-&gt;script, multiple statements after ref: · gcclll/stb-vue-next@168041c</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;export default {}&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: a = 1, b = 2, c = 3
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
ref: a = 1, b = 2, c = 3
&lt;/script&gt;

---- after ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
const a = _ref(1), b = _ref(2), c = _ref(3)
&lt;/script&gt;

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-29" class="outline-4">
<h4 id="headline-29">
6e337c5 imports 置顶🔝
</h4>
<div id="outline-text-headline-29" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6e337c59b5c3c87925e1fe7d5efc3a671887c9af">feat(add): sfc-&gt;script, hoist imports to top · gcclll/stb-vue-next@6e337c5</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">compileSFC</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script&gt;export default {}&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { a } from &#39;./a&#39;
</span><span class="sb">import { b } from &#39;./b&#39;
</span><span class="sb">import { foo, bar } from &#39;./baz&#39;
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">enableRefSugar</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
---- before ----

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- after ----
import { a } from &#39;./a&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- before ----
import { a } from &#39;./a&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- after ----
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- before ----
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
import { foo, bar } from &#39;./baz&#39;
&lt;/script&gt;

---- after ----
import { a } from &#39;./a&#39;
import { b } from &#39;./b&#39;
import { foo, bar } from &#39;./baz&#39;

&lt;script&gt;const __default__ = {}&lt;/script&gt;
&lt;script setup&gt;
&lt;/script&gt;

undefined
</pre>
<p>
如上，经过几轮循环，将三个 import 提升到了最开始位置。</p>
</div>
</div>
<div id="outline-container-headline-30" class="outline-4">
<h4 id="headline-30">
<span class="todo">TODO</span>
68d4940 defineProps/Emit() 处理
</h4>
<div id="outline-text-headline-30" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/68d4940a2725e809ab731a6998bc7b72e1131907">feat(add): sfc-&gt;script, defineProps/Emit · gcclll/stb-vue-next@68d4940</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span><span class="nx">content</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup lang=&#34;ts&#34;&gt;
</span><span class="sb">import { defineProps } from &#39;vue&#39;
</span><span class="sb">interface Test {}
</span><span class="sb">
</span><span class="sb">type Alias = number[]
</span><span class="sb">
</span><span class="sb">defineProps&lt;{
</span><span class="sb">string: string
</span><span class="sb">number: number
</span><span class="sb">boolean: boolean
</span><span class="sb">object: object
</span><span class="sb">objectLiteral: { a: number }
</span><span class="sb">fn: (n: number) =&gt; void
</span><span class="sb">functionRef: Function
</span><span class="sb">objectRef: Object
</span><span class="sb">array: string[]
</span><span class="sb">arrayRef: Array&lt;any&gt;
</span><span class="sb">tuple: [number, number]
</span><span class="sb">set: Set&lt;string&gt;
</span><span class="sb">literal: &#39;foo&#39;
</span><span class="sb">optional?: any
</span><span class="sb">recordRef: Record&lt;string, null&gt;
</span><span class="sb">interface: Test
</span><span class="sb">alias: Alias
</span><span class="sb">
</span><span class="sb">union: string | number
</span><span class="sb">literalUnion: &#39;foo&#39; | &#39;bar&#39;
</span><span class="sb">literalUnionMixed: &#39;foo&#39; | 1 | boolean
</span><span class="sb">intersection: Test &amp; {}
</span><span class="sb">}&gt;()
</span><span class="sb">&lt;/script&gt;`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-31" class="outline-3">
<h3 id="headline-31">
3⃣ 5160a6d ref -&gt; ref.value
</h3>
<div id="outline-text-headline-31" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/5160a6db9b1ab4eb8e0aae9adc0c4bbec6e44fa8">feat(add): sfc-&gt;script, ref -&gt; ref.value · gcclll/stb-vue-next@5160a6d</a></p>
<p>
将对 ref 变量的访问转成对 <code>ref.value</code> 的访问。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFC</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">compile</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span>
  <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">ref: a = 1
</span><span class="sb">console.log(a)
</span><span class="sb">function get() {
</span><span class="sb">  return a + 1
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span>
<span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  enableRefSugar: true,
  refBindings: [Object: null prototype] { a: &#39;setup-ref&#39; }
}
&lt;script setup&gt;
const a = _ref(1)
console.log(a.value)
function get() {
  return a.value + 1
}
&lt;/script&gt;
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-32" class="outline-3">
<h3 id="headline-32">
<span class="todo">TODO</span>
4⃣ a6f4dae extract define props/emits
</h3>
<div id="outline-text-headline-32" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a6f4dae87de524a4d9da3d375a001c8d67bffdaa">feat(add): sfc-&gt;script, extract props/emits · gcclll/stb-vue-next@a6f4dae</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
ExpressionStatement --
undefined {} xx

undefined
</pre>
</div>
</div>
<div id="outline-container-headline-33" class="outline-3">
<h3 id="headline-33">
<span class="todo">TODO</span>
5⃣ 480acf0 checkInvalidScopeReference
</h3>
<div id="outline-text-headline-33" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/480acf01e9febdd804b39b580b572d19cc105a50">feat(add): sfc-&gt;script, check invalid scope references ·
gcclll/stb-vue-next@480acf0</a></p>
<p>
检查 <code>useOptions</code> ，是否包含 <code>&lt;setup&gt;</code> 中已经存在的变量，即 <code>useOptions</code> 中不能
有 setup 中声明的变量。</p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-3">
<h3 id="headline-34">
<span class="todo">TODO</span>
6⃣ 25662c6 删除非 script 内容
</h3>
<div id="outline-text-headline-34" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/25662c6ea1a85076bfcd8b13e130063cb248b58f">feat(add): sfc-&gt;script, delete non-script content · gcclll/stb-vue-next@25662c6</a></p>
</div>
</div>
<div id="outline-container-headline-35" class="outline-3">
<h3 id="headline-35">
7⃣ deed8c1 analyze binding metadata(bindingMetadata)
</h3>
<div id="outline-text-headline-35" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/deed8c1e21d2ccf63c6174032b66669975d4aa6f">feat(add): sfc-&gt;script, analyze binding metadata · gcclll/stb-vue-next@deed8c1</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">const props = defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">ref: a = 1
</span><span class="sb">const b = 2
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">bindings</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  foo: &#39;props&#39;,
  props: &#39;setup-const&#39;,
  a: &#39;setup-ref&#39;,
  b: &#39;setup-const&#39;
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-36" class="outline-3">
<h3 id="headline-36">
8⃣ 9cd2fd5 inject useCssVars, css 变量处理
</h3>
<div id="outline-text-headline-36" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9cd2fd504a86e4b6a3484f00151a24ef7f719323">feat(add): sfc-&gt;script, inject useCssVars · gcclll/stb-vue-next@9cd2fd5</a></p>
<div id="outline-container-headline-37" class="outline-4">
<h4 id="headline-37">
&lt;style&gt; v-bind css 变量
</h4>
<div id="outline-text-headline-37" class="outline-text-4">
<p>
处理 style 中使用的 css 变量</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// compileScript.ts
</span><span class="c1">// TODO 8. 注入 `useCssVars` 调用
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">helperImports</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">CSS_VARS_HELPER</span><span class="p">)</span>
    <span class="nx">helperImports</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;unref&#39;</span><span class="p">)</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">prependRight</span><span class="p">(</span>
      <span class="nx">startOffset</span><span class="p">,</span>
      <span class="sb">`</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="nx">genCssVarsCode</span><span class="p">(</span>
        <span class="nx">cssVars</span><span class="p">,</span>
        <span class="nx">bindingMetadata</span><span class="p">,</span>
        <span class="nx">scopeId</span><span class="p">,</span>
        <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isProd</span>
      <span class="p">)</span><span class="si">}</span><span class="err">\</span><span class="sb">n`</span>
    <span class="p">)</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script&gt;const a = 1&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineProps, ref } from &#39;vue&#39;
</span><span class="sb">const color = &#39;red&#39;
</span><span class="sb">const height = ref(&#39;10px&#39;)
</span><span class="sb">defineProps({
</span><span class="sb">  foo: Striing
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">div {
</span><span class="sb">  color: v-bind(color);
</span><span class="sb">  font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">  height: v-bind(height);
</span><span class="sb">  border: v-bind(foo)
</span><span class="sb">}
</span><span class="sb">&lt;/style&gt;
</span><span class="sb">`</span><span class="p">);</span>
<span class="c1">// 1. 本地变量绑定
</span><span class="c1">// 2. 本地 ref 绑定
</span><span class="c1">// 3. props 绑定
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { ref } from &#39;vue&#39;
const a = 1
_useCssVars(_ctx =&gt; ({
  &#34;xxxxxxxx-color&#34;: (color),
  &#34;xxxxxxxx-font_size&#34;: (_ctx.font.size),
  &#34;xxxxxxxx-height&#34;: (height.value),
  &#34;xxxxxxxx-foo&#34;: (__props.foo)
}))

const color = &#39;red&#39;
const height = ref(&#39;10px&#39;)
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-38" class="outline-4">
<h4 id="headline-38">
css 变量重写：
</h4>
<div id="outline-text-headline-38" class="outline-text-4">
<p>
源码处理：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">needRewrite</span> <span class="o">=</span> <span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">hasInheritAttrsFlag</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">needRewrite</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">content</span> <span class="o">=</span> <span class="nx">rewriteDefault</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="sb">`__default__`</span><span class="p">,</span> <span class="nx">plugins</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cssVars</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">+=</span> <span class="nx">genNormalScriptCssVarsCode</span><span class="p">(</span>
      <span class="nx">cssVars</span><span class="p">,</span>
      <span class="nx">bindings</span><span class="p">,</span>
      <span class="nx">scopeId</span><span class="p">,</span>
      <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isProd</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">hasInheritAttrsFlag</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`__default__.inheritAttrs = false`</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">content</span> <span class="o">+=</span> <span class="sb">`</span><span class="err">\</span><span class="sb">nexport default __default__`</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compileStyle</span><span class="p">({</span>
  <span class="nx">source</span><span class="o">:</span> <span class="sb">`.foo {
</span><span class="sb">    color: v-bind(color);
</span><span class="sb">    font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">  }`</span><span class="p">,</span>
  <span class="nx">filename</span><span class="o">:</span> <span class="s2">&#34;test.css&#34;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;data-v-test&#34;</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
.foo {
    color: var(--test-color);
    font-size: var(--test-font_size);
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-39" class="outline-4">
<h4 id="headline-39">
isProd option 使用 hash 变量名
</h4>
<div id="outline-text-headline-39" class="outline-text-4">
<p>
生产模式，使用随机 hash 值作为名字：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// cssVars.ts
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">genVarName</span><span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">raw</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">isProd</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isProd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">id</span> <span class="o">+</span> <span class="nx">raw</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sb">`</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">raw</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^\w-])/g</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span>
  <span class="sb">`&lt;script&gt;const a = 1&lt;/script&gt;\n`</span> <span class="o">+</span>
    <span class="sb">`&lt;style&gt;div{
</span><span class="sb">          color: v-bind(color);
</span><span class="sb">          font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">        }&lt;/style&gt;`</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">isProd</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const a = 1
const __default__ = {}
import { useCssVars as _useCssVars } from &#39;vue&#39;
const __injectCSSVars__ = () =&gt; {
_useCssVars(_ctx =&gt; ({
  &#34;4003f1a6&#34;: (_ctx.color),
  &#34;41b6490a&#34;: (_ctx.font.size)
}))}
const __setup__ = __default__.setup
__default__.setup = __setup__
  ? (props, ctx) =&gt; { __injectCSSVars__();return __setup__(props, ctx) }
  : __injectCSSVars__

export default __default__
undefined
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-40" class="outline-3">
<h3 id="headline-40">
<span class="todo">TODO</span>
9⃣ eef6fd5 setup() 参数签名
</h3>
<div id="outline-text-headline-40" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/eef6fd52f79f561d92a2914a3fdf74b998788640">feat(add): sfc-&gt;script, setup() 参数签名 · gcclll/stb-vue-next@eef6fd5</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup lang=&#34;ts&#34;&gt;
</span><span class="sb">import { defineProps, defineEmit } from &#39;vue&#39;
</span><span class="sb">const props = defineProps({ foo: String })
</span><span class="sb">const emit = defineEmit([&#39;a&#39;, &#39;b&#39;])
</span><span class="sb">&lt;/script&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { defineComponent as _defineComponent } from &#39;vue&#39;


export default _defineComponent({
  expose: [],
  props: { foo: String },
  emits: [&#39;a&#39;, &#39;b&#39;],
  setup(__props, { emit }) {

const props = __props



return { props, emit }
}

})
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-41" class="outline-3">
<h3 id="headline-41">
🔟 9cedeab 生成 return 语句
</h3>
<div id="outline-text-headline-41" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9cedeab1e337cb0e872d6ca19a83bf6d05856bd0">feat(add): sfc-&gt;script, process render function return · gcclll/stb-vue-next@9cedeab</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { x } from &#39;./x&#39;
</span><span class="sb">let a = 1
</span><span class="sb">const b = 2
</span><span class="sb">function c() {}
</span><span class="sb">class d {}
</span><span class="sb">&lt;/script&gt;`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { x } from &#39;./x&#39;

let a = 1
const b = 2
function c() {}
class d {}

return { a, b, c, d, x }
}
undefined
</pre>
<p>
将所有变量都返回出去了。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span>
  <span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { ref } from &#39;vue&#39;
</span><span class="sb">const count = ref(0)
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;template&gt;
</span><span class="sb">    &lt;div&gt;{{ count }}&lt;/div&gt;
</span><span class="sb">    &lt;div&gt;static&lt;/div&gt;
</span><span class="sb">&lt;/template&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">div { color: v-bind(count) }
</span><span class="sb">&lt;/style&gt;`</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">inlineTemplate</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { toDisplayString as _toDisplayString, createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, &#34;static&#34;, -1 /* HOISTED */)

import { ref } from &#39;vue&#39;

_useCssVars(_ctx =&gt; ({
  &#34;xxxxxxxx-count&#34;: (count.value)
}))

const count = ref(0)

return (_ctx, _cache) =&gt; {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;div&#34;, null, _toDisplayString(count.value), 1 /* TEXT */),
    _hoisted_1
  ], 64 /* STABLE_FRAGMENT */))
}
}
undefined
</pre>
<p>
如果要支持：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span>
   <span class="nx">inlineTemplate</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
   <span class="nx">templateOptions</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">ssr</span><span class="o">:</span> <span class="kc">true</span>
   <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
还需要实现 <code>compiler-ssr</code> 模块：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// TODO 10. 生成返回语句(return)
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">returned</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">inlineTemplate</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">sfc</span><span class="p">.</span><span class="nx">template</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">sfc</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO 需要 compiler-ssr 支持
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">returned</span> <span class="o">=</span> <span class="sb">`() =&gt; {}`</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// return bindings from setup
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">allBindings</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">setupBindings</span> <span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">userImports</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userImports</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">isType</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">allBindings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">returned</span> <span class="o">=</span> <span class="sb">`{ </span><span class="si">${</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">allBindings</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;, &#34;</span><span class="p">)</span><span class="si">}</span><span class="sb"> }`</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">s</span><span class="p">.</span><span class="nx">appendRight</span><span class="p">(</span><span class="nx">endOffset</span><span class="p">,</span> <span class="sb">`</span><span class="err">\</span><span class="sb">nreturn </span><span class="si">${</span><span class="nx">returned</span><span class="si">}</span><span class="err">\</span><span class="sb">n}</span><span class="err">\</span><span class="sb">n</span><span class="err">\</span><span class="sb">n`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-42" class="outline-3">
<h3 id="headline-42">
<span class="todo">TODO</span>
1⃣1⃣ cfca9de finalize default export
</h3>
<div id="outline-text-headline-42" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cfca9de9bbd44451eb5f7269c89d702220a032cd">feat(add): sfc-&gt;script, finalize default export · gcclll/stb-vue-next@cfca9de</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">bindings</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineEmit } from &#39;vue&#39;
</span><span class="sb">const myEmit = defineEmit([&#39;foo&#39;, &#39;bar&#39;])
</span><span class="sb">const props = defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">  `</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
export default {
  expose: [],
  props: {
  foo: String
},
  emits: [&#39;foo&#39;, &#39;bar&#39;],
  setup(__props, { emit: myEmit }) {

const props = __props



return { myEmit, props }
}

}
undefined
</pre>
<blockquote>
<p>emits 哪去了??? -&gt; fix: <a href="https://github.com/gcclll/stb-vue-next/commit/d631810952131058b7ea474f66ac3d5fdeee3821">d631810</a></p>
</blockquote>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/d631810952131058b7ea474f66ac3d5fdeee3821">fix: sfc-&gt;script, expose indent · gcclll/stb-vue-next@d631810</a></p>
</div>
</div>
<div id="outline-container-headline-43" class="outline-3">
<h3 id="headline-43">
<span class="todo">TODO</span>
1⃣2⃣ 5810296 finalize Vue helper imports
</h3>
<div id="outline-text-headline-43" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/5810296d43519e902085cacf8ab95cbbada1fe70">feat(add): sfc-&gt;script, finalize vue helper imports · gcclll/stb-vue-next@5810296</a></p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-44" class="outline-2">
<h2 id="headline-44">
61c3b7a transform src set
</h2>
<div id="outline-text-headline-44" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/61c3b7aed514f0d9474da22cb4ed7a1dd60f0492">feat(add): sfc-&gt;srcset transform · gcclll/stb-vue-next@61c3b7a</a></p>
<p>
转换 <code>&lt;img&gt;</code> 和 <code>&lt;source&gt;</code> 的 <code>srcset</code> 属性。</p>
<p>
img srcset 属性值： <code>&lt;img srcset=&#34;url 1x, url2 2x, ...&#34;&gt;</code> 浏览器会根据实际情况来
选用 srcset 中合适的图片地址来显示。</p>
<blockquote>
<p>有关 Reponsive Images 说明: <a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images">Responsive images - Learn web development | MDN</a>。</p>
</blockquote>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileWithSrcset</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">src</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;
import _imports_0 from &#39;./logo.png&#39;


const _hoisted_1 = _imports_0
const _hoisted_2 = _imports_0 + &#39;2x&#39;
const _hoisted_3 = _imports_0 + &#39;2x&#39;
const _hoisted_4 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x&#39;
const _hoisted_5 = _imports_0 + &#39;2x, &#39; + _imports_0
const _hoisted_6 = _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_7 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_8 = &#34;/logo.png&#34; + &#39;, &#39; + _imports_0 + &#39;2x&#39;

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_1
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_2
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_3
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_4
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_5
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_6
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_7
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: &#34;/logo.png, /logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;https://example.com/logo.png&#34;,
      srcset: &#34;https://example.com/logo.png, https://example.com/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: _hoisted_8
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;data:image/png;base64,i&#34;,
      srcset: &#34;data:image/png;base64,i 1x, data:image/png;base64,i 2x&#34;
    })
  ], 64 /* STABLE_FRAGMENT */))
}
undefined
</pre>
<p>
指定 <code>options.base: &#39;/foo&#39;</code> 测试结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileWithSrcset</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">src</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="p">{</span> <span class="nx">base</span><span class="o">:</span> <span class="s1">&#39;/foo&#39;</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png, /foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x, /foo/logo.png&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png 2x, /foo/logo.png 3x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: &#34;/foo/logo.png, /foo/logo.png 2x, /foo/logo.png 3x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: &#34;/logo.png, /logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;https://example.com/logo.png&#34;,
      srcset: &#34;https://example.com/logo.png, https://example.com/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: &#34;/logo.png, /foo/logo.png 2x&#34;
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;data:image/png;base64,i&#34;,
      srcset: &#34;data:image/png;base64,i 1x, data:image/png;base64,i 2x&#34;
    })
  ], 64 /* STABLE_FRAGMENT */))
}
undefined
</pre>
<p>
<code>options.includeAbsolute: true</code> 选项:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileWithSrcset</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">src</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="p">{</span> <span class="nx">includeAbsolute</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { createVNode as _createVNode, Fragment as _Fragment, openBlock as _openBlock, createBlock as _createBlock } from &#34;vue&#34;
import _imports_0 from &#39;./logo.png&#39;
import _imports_1 from &#39;/logo.png&#39;


const _hoisted_1 = _imports_0
const _hoisted_2 = _imports_0 + &#39;2x&#39;
const _hoisted_3 = _imports_0 + &#39;2x&#39;
const _hoisted_4 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x&#39;
const _hoisted_5 = _imports_0 + &#39;2x, &#39; + _imports_0
const _hoisted_6 = _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_7 = _imports_0 + &#39;, &#39; + _imports_0 + &#39;2x, &#39; + _imports_0 + &#39;3x&#39;
const _hoisted_8 = _imports_1 + &#39;, &#39; + _imports_1 + &#39;2x&#39;
const _hoisted_9 = &#34;https://example.com/logo.png&#34; + &#39;, &#39; + &#34;https://example.com/logo.png&#34; + &#39;2x&#39;
const _hoisted_10 = _imports_1 + &#39;, &#39; + _imports_0 + &#39;2x&#39;
const _hoisted_11 = &#34;data:image/png;base64,i&#34; + &#39;1x, &#39; + &#34;data:image/png;base64,i&#34; + &#39;2x&#39;

export function render(_ctx, _cache) {
  return (_openBlock(), _createBlock(_Fragment, null, [
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_1
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_2
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_3
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_4
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_5
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_6
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;./logo.png&#34;,
      srcset: _hoisted_7
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: _hoisted_8
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;https://example.com/logo.png&#34;,
      srcset: _hoisted_9
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;/logo.png&#34;,
      srcset: _hoisted_10
    }),
    _createVNode(&#34;img&#34;, {
      src: &#34;data:image/png;base64,i&#34;,
      srcset: _hoisted_11
    })
  ], 64 /* STABLE_FRAGMENT */))
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-45" class="outline-2">
<h2 id="headline-45">
总结
</h2>
<div id="outline-text-headline-45" class="outline-text-2">
<p>
SFC 模块的作用：</p>
<ol>
<li>
<p>解析 Render 函数，替换 ref 变量</p>
</li>
<li>
<p>解析 &lt;script&gt; 标签</p>
</li>
<li>
<p>解析 &lt;script setup&gt;</p>
</li>
<li>
<p>ref: 解析，将 ref: 类型访问转成对 ref.value 的访问</p>
</li>
<li>
<p>将 ref: { … } 解构后的变量进行 ref(…) 化</p>
</li>
<li>
<p>defineProps({ foo: String })  解析，合并到 export default { props: {…} }</p>
</li>
<li>
<p>defineEmit({ … }) 解析，合并到 export default { emits: {…} }</p>
</li>
<li>
<p>cssVar v-bind 变量使用，转换，包含 ref 变量引用转换</p>
</li>
<li>
<p>asset url 转换(相对路径，绝对路径， <code>~@path/...</code>, <code>@path/..</code> 转换)</p>
</li>
<li>
<p><code>&lt;img&gt;, &lt;source&gt;</code> 的 <code>srcset</code> URL转换</p>
</li>
</ol>
<p>
综合测试：</p>
<div id="outline-container-headline-46" class="outline-4">
<h4 id="headline-46">
script[setup] 测试
</h4>
<div id="outline-text-headline-46" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">compileWithSrcset</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">bindings</span><span class="p">,</span> <span class="nx">attrs</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compileSFCScript</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;template&gt;
</span><span class="sb">  &lt;div&gt;
</span><span class="sb">    &lt;img src=&#34;./logo.png&#34; srcset=&#34;./logo.png, ./logo.png 2x, ./logo.png 3x&#34;/&gt;
</span><span class="sb">  &lt;/div&gt;
</span><span class="sb">  &lt;div&gt;{{ count }}&lt;/div&gt;
</span><span class="sb">  &lt;div&gt;static&lt;/div&gt;
</span><span class="sb">&lt;/template&gt;
</span><span class="sb">&lt;script&gt;
</span><span class="sb">  const a = 1
</span><span class="sb">export default {
</span><span class="sb">  props: [&#39;foo&#39;, &#39;bar&#39;],
</span><span class="sb">  data() {
</span><span class="sb">    return { foo: null, bar }
</span><span class="sb">  },
</span><span class="sb">  setup() {
</span><span class="sb">    return { foo: 1, a }
</span><span class="sb">  },
</span><span class="sb">  computed: {
</span><span class="sb">    fcc() {},
</span><span class="sb">    bcc: {
</span><span class="sb">      get() {},
</span><span class="sb">      set() {}
</span><span class="sb">    }
</span><span class="sb">  },
</span><span class="sb">  inject: [&#39;fjj&#39;, &#39;bjj&#39;], // { fjj: {}, bjj: {} },
</span><span class="sb">  methods: {
</span><span class="sb">    quux() {}
</span><span class="sb">  },
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineProps, ref } from &#39;vue&#39;
</span><span class="sb">let a, b, c, d
</span><span class="sb">ref: aa = 1 + (await foa)
</span><span class="sb">ref: height = 100
</span><span class="sb">// 对象解构要用括号包裹起来
</span><span class="sb">ref: ({ foo, bar: bar, baz: { bax } } = useFoo());
</span><span class="sb">ref: [ar, br] = useFoo()
</span><span class="sb">ref: count = 0
</span><span class="sb">const color = &#39;red&#39;
</span><span class="sb">const size = ref(&#39;10px&#39;)
</span><span class="sb">defineProps({
</span><span class="sb">  foo: String
</span><span class="sb">})
</span><span class="sb">defineEmit([&#39;fox&#39;, &#39;foy&#39;])
</span><span class="sb">
</span><span class="sb">// ref 在函数中被访问
</span><span class="sb">function test() {
</span><span class="sb">  const { a } = aa
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;style&gt;
</span><span class="sb">div {
</span><span class="sb">  color: v-bind(color);
</span><span class="sb">  font-size: v-bind(&#39;font.size&#39;);
</span><span class="sb">  border: v-bind(foo);
</span><span class="sb">  height: v-bind(height);
</span><span class="sb">}
</span><span class="sb">&lt;/style&gt;
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; content 输出结果：`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; bindings 输出结果：`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">bindings</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; content 输出结果：
import { ref as _ref, useCssVars as _useCssVars, unref as _unref } from &#39;vue&#39;
import { ref } from &#39;vue&#39;

  const a = 1
const __default__ = {
  props: [&#39;foo&#39;, &#39;bar&#39;],
  data() {
    return { foo: null, bar }
  },
  setup() {
    return { foo: 1, a }
  },
  computed: {
    fcc() {},
    bcc: {
      get() {},
      set() {}
    }
  },
  inject: [&#39;fjj&#39;, &#39;bjj&#39;], // { fjj: {}, bjj: {} },
  methods: {
    quux() {}
  },
}

async function setup(__props) {

_useCssVars(_ctx =&gt; ({
  &#34;xxxxxxxx-color&#34;: (color),
  &#34;xxxxxxxx-font_size&#34;: (_ctx.font.size),
  &#34;xxxxxxxx-foo&#34;: (foo.value),
  &#34;xxxxxxxx-height&#34;: (height.value)
}))

let a, b, c, d
const aa = _ref(1 + (await foa))
const height = _ref(100)
// 对象解构要用括号包裹起来
const { foo: __foo, bar: __bar, baz: { bax: __bax } } = useFoo();
const foo = _ref(__foo);
const bar = _ref(__bar);
const bax = _ref(__bax);
const [__ar, __br] = useFoo()
const ar = _ref(__ar);
const br = _ref(__br);
const count = _ref(0)
const color = &#39;red&#39;
const size = ref(&#39;10px&#39;)



// ref 在函数中被访问
function test() {
  const { a } = aa.value
}

return { a, b, c, d, aa, height, foo, bar, bax, ar, br, count, color, size, test, ref }
}


export default /*#__PURE__*/ Object.assign(__default__, {
  expose: [],
  props: {
  foo: String
},
  emits: [&#39;fox&#39;, &#39;foy&#39;],
  setup
})
&gt;&gt;&gt; bindings 输出结果：
{
  foo: &#39;setup-ref&#39;,
  bar: &#39;setup-ref&#39;,
  a: &#39;setup-let&#39;,
  fcc: &#39;options&#39;,
  bcc: &#39;options&#39;,
  fjj: &#39;options&#39;,
  bjj: &#39;options&#39;,
  quux: &#39;options&#39;,
  ref: &#39;setup-const&#39;,
  b: &#39;setup-let&#39;,
  c: &#39;setup-let&#39;,
  d: &#39;setup-let&#39;,
  aa: &#39;setup-ref&#39;,
  height: &#39;setup-ref&#39;,
  bax: &#39;setup-ref&#39;,
  ar: &#39;setup-ref&#39;,
  br: &#39;setup-ref&#39;,
  count: &#39;setup-ref&#39;,
  color: &#39;setup-const&#39;,
  size: &#39;setup-ref&#39;,
  test: &#39;setup-const&#39;
}
undefined
</pre>
<p>
<strong>结果简析：</strong></p>
<ol>
<li>
<p><code>&lt;script setup&gt;</code> 标签内的代码都会被解析到 <code>setup() {...}</code> 函数中</p>
<p>
即它和 <code>&lt;script&gt;</code> 中代码是不冲突的，比如 <code>&lt;script&gt;</code> 里面的变量 <code>a</code> 和
<code>&lt;script setup&gt;</code> 中的同名变量 <code>a</code> 互不影响。</p>
</li>
<li>
<p>在 <code>&lt;style&gt;</code> 中使用的 v-bind 指令会使用 <code>_useCssVars</code> 进行注册替换成实际的样
式值</p>
</li>
<li>
<p><code>defineProps</code> 中定义的变量对应 export default -&gt; props</p>
</li>
<li>
<p><code>defineEmits</code> 中定义的变量对应 export default -&gt; emits</p>
</li>
<li>
<p><code>ref: height = 100</code> 中的 <code>ref:</code> 语法最终会转成对应的 <code>_ref(100)</code> reactive 变
量(语法糖，vue&gt;compile-sfc解析)</p>
<p>
并且支持多种用法，解构/多个声明组合/解构默认值，对于解构后的变量进行
<code>_ref(...)</code> 然后 setup return 中返回。</p>
<p>
ref: 语句中如果有解构(对象解构)操作，那么后面的解构表达式必须用括号(<code>({ a } = useFoo())</code>)包起来。</p>
<p>
<em>Imp. ref: 解构中的变量名不能以 <code>$</code> 开头。</em></p>
</li>
<li>
<p>如果 <code>script</code> 和 <code>script setup</code> 中的 export default 中同时包含同名属性，会被
<code>script setup</code> 中的替换掉。</p>
<p>
因为生成的代码中是将 script setup 往 script 上合并。</p>
<blockquote>
<p>PS. &lt;script&gt; 和 &lt;script setup&gt; 中 export default 的内容尽量不要重复。</p>
</blockquote>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-47" class="outline-4">
<h4 id="headline-47">
typescript 语言
</h4>
<div id="outline-text-headline-47" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="o">:</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">scriptAst</span><span class="p">,</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script lang=&#34;ts&#34;&gt;
</span><span class="sb">import { Options, Vue } from &#39;vue-class-component&#39;;
</span><span class="sb">@Options({
</span><span class="sb">    components: {
</span><span class="sb">    HelloWorld,
</span><span class="sb">    },
</span><span class="sb">    props: [&#39;foo&#39;, &#39;bar&#39;]
</span><span class="sb">})
</span><span class="sb">export default class Home extends Vue {}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

import { Options, Vue } from &#39;vue-class-component&#39;;
@Options({
    components: {
    HelloWorld,
    },
    props: [&#39;foo&#39;, &#39;bar&#39;]
})
export default class Home extends Vue {}

undefined
</pre>
</div>
</div>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-12-19
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/compiler-sfc/">compiler-sfc</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-compiler-ssr/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 源码头脑风暴之 6 ☞compiler-ssr</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-compiler-dom/">
            <span class="next-text nav-default">Vue3 源码头脑风暴之 4 ☞compiler-dom</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2020-12-19 00:00:00 \u002b0000 UTC',
        title: 'Vue3 源码头脑风暴之 5 ☞ compiler-sfc',
        clientID: '7251a6b30d0d6c0f4aa2',
        clientSecret: '320c43a98b0d5ae30535d8cf6cb3be7a05895c77',
        repo: 'cheng92-comments',
        owner: 'gcclll',
        admin: ['gcclll'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
