<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render - è‹¥å¶çŸ¥ç§‹</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-runtime-core-2-render/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.06b20cf21b1dff0a19c6a6fd2770439ed0c003d544ece3c4e1fbfb34fc217e45.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render" />
<meta property="og:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-runtime-core-2-render/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2021-01-26T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-01-26T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render">
<meta itemprop="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu"><meta itemprop="datePublished" content="2021-01-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-01-26T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="13782">
<meta itemprop="keywords" content="vue,,vue3,,runtime-core,,render," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render"/>
<meta name="twitter:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-01-26 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 13782 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 28 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">è„‘å›¾</a>
</li>
<li><a href="#headline-2">init</a>
</li>
<li><a href="#headline-3">function list</a>
</li>
<li><a href="#headline-4">render(vnode, container)</a>
</li>
<li><a href="#fn-patch">patch(â€¦args)</a>
</li>
<li><a href="#headline-6">patch-&gt;processElement(â€¦args)</a>
</li>
<li><a href="#fn-patchElement">mountElement(â€¦args)</a>
<ul>
<li><a href="#headline-8">default ELEMENT</a>
</li>
<li><a href="#headline-9">with props</a>
</li>
<li><a href="#headline-10">with text children</a>
<ul>
<li><a href="#headline-11">çº¯æ–‡æœ¬å•èŠ‚ç‚¹ child</a>
</li>
<li><a href="#headline-12">æ•°ç»„ç±»å‹(å¤šä¸ª) children:</a>
</li>
</ul>
</li>
<li><a href="#headline-13">children+props æ··åˆæµ‹è¯•</a>
</li>
<li><a href="#headline-14">å°ç»“</a>
</li>
</ul>
</li>
<li><a href="#fn-patchElement">patchElement</a>
</li>
<li><a href="#fn-patchChildren">patchChildren(n1,n2,â€¦)</a>
<ul>
<li><a href="#headline-17">new text + old array</a>
</li>
<li><a href="#headline-18">new null + old array</a>
</li>
<li><a href="#headline-19">new array + old null/text</a>
</li>
<li><a href="#headline-20">new array + old array</a>
</li>
</ul>
</li>
<li><a href="#keyed-children">patchKeyedChildren</a>
<ul>
<li><a href="#headline-22">append([1] -&gt; [1,2,3])</a>
</li>
<li><a href="#headline-23">prepend([4,5]-&gt;[1,2,3,4,5])</a>
</li>
<li><a href="#headline-24">insert begin&amp;end([2,3,4]-&gt;[1,2,3,4,5])</a>
</li>
<li><a href="#headline-25">move([1,2,3,4]-&gt;[2,3,1,4])</a>
</li>
<li><a href="#headline-26">move&amp;replace([1,2,3,4,5]-&gt;[4,1,2,3,6])</a>
</li>
</ul>
</li>
<li><a href="#patch-unkeyed-children">patchUnkeyedChildren</a>
</li>
<li><a href="#render-component">patch-&gt;processComponent(å¦‚ä½•patchç»„ä»¶çš„ï¼Ÿ)</a>
</li>
<li><a href="#test">æµ‹è¯•</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<link href="/js/vue/formatters-styles/style.css" rel="stylesheet">
<link href="/js/vue/formatters-styles/annotated.css" rel="stylesheet">
<link href="/js/vue/formatters-styles/html.css" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<script type='text/javascript' src="https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/jsondiffpatch.umd.min.js"></script>
<script src="/js/vue/vue-next.js"></script>
<script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
<script src="/js/utils.js"></script>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> å®Œå…¨æ‹·è´äº <a href="https://github.com/vuejs/vue-next">vue-next</a> ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚</strong>
</kbd></p>
<blockquote>
<p><strong>å£°æ˜</strong> ï¼švue-next runtime-core ä¸­çš„ render å‡½æ•°éƒ¨åˆ†ï¼Œ</p>
<font color='red'
size='2'>æœ¬ç¯‡æ‰€ä½¿ç”¨çš„çš„æµ‹è¯•ä¾‹å­æ˜¯æ™®
é€šçš„æ•°å­—æ•°ç»„ï¼Œå®é™…ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ VNode ç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ä¸åŒèŠ‚
ç‚¹å…±äº«åŒä¸€ä¸ªå†…å­˜ç©ºé—´é—®é¢˜ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä½•ç”¨ä¾‹ä¸­æ²¡æœ‰é‡å¤æ•°å­—çš„åŸå› ã€‚(_å°±ç®—æ˜¯é™æ€çš„å¯
å¤ç”¨èŠ‚ç‚¹ä¹Ÿä¼šæ‰§è¡Œ cloneVNode å…‹éš†å‡ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡_)
</font>
<p>
<strong>æ›´æ–°æ—¥å¿—&amp;Todos</strong> ï¼š</p>
<ol>
<li>
<p>[2021-01-26 14:15:15] åˆ›å»º</p>
</li>
</ol>
</blockquote>
<p>
<img src="/img/tmp/20210126143153.png" alt="/img/tmp/20210126143153.png" title="/img/tmp/20210126143153.png" /></p>
<blockquote>
<p>2229 - 423 = 1806 ğŸ¤¦â€â™€ï¸ ä¸€ä¸ªå‡½æ•°å°±å°†è¿‘ä¸¤åƒè¡Œï¼ŒğŸ˜²ï¼ï¼</p>
<p>
æ·å¾„ğŸ‘£ï¼š</p>
<ol>
<li>
<p><a href="#keyed-children">å¦‚æœåªæƒ³äº†è§£å¦‚ä½• diff ï¼Ÿ æ›´æ–°ï¼Ÿ</a></p>
</li>
</ol>
</blockquote>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
è„‘å›¾
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p><span style="text-decoration: underline;">runtime-core/src/render.ts</span> è„‘å›¾ï¼š</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-render-ts.svg" alt="/img/vue3/runtime-core/vue-runtime-core-render-ts.svg" title="/img/vue3/runtime-core/vue-runtime-core-render-ts.svg" /></p>
<p>
render å‡½æ•°åˆ›å»ºå‡½æ•° <code>baseCreateRender(options, createHydrationFns?)</code></p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-render-baseCreateRender.svg" alt="/img/vue3/runtime-core/vue-runtime-core-render-baseCreateRender.svg" title="/img/vue3/runtime-core/vue-runtime-core-render-baseCreateRender.svg" /></p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
init
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fb9738c18c624fe7525afa48b12b6589a3ac0dfe">feat(init): render function Â· gcclll/stb-vue-next@fb9738c Â· GitHub</a></p>
<p>
ä¸¤ä¸ª create render å‡½æ•°ï¼š</p>
<ol>
<li>
<p><code>createRenderer(options)</code></p>
</li>
<li>
<p><code>createHydrationRenderer(options)</code></p>
<p>
è¿™ä¸ªè¿˜ä¸æ¸…æ¥šæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œé€šè¿‡ä»£ç è§‚å¯Ÿè²Œä¼¼è·Ÿ SSR æœ‰å…³ï¼Œå…ˆæç½®å…ˆä¸ç®¡ã€‚</p>
</li>
</ol>
<p>
ä¸¤ä¸ªå‡½æ•°æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„ <code>baseCreateRenderer(options, createHydrationFns)</code></p>
<p>
å¹¶ä¸”å°±æ˜¯è¿™ä¸ªå‡½æ•°å°†è¿‘ä¸¤åƒè¡Œ~~~~</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createRenderer</span><span class="o">&lt;</span>
  <span class="nx">HostNode</span> <span class="o">=</span> <span class="nx">RendererNode</span><span class="p">,</span>
  <span class="nx">HostElement</span> <span class="o">=</span> <span class="nx">RendererElement</span>
<span class="o">&gt;</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">RendererOptions</span><span class="p">&lt;</span><span class="nt">HostNode</span><span class="err">,</span> <span class="na">HostElement</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">baseCreateRenderer</span><span class="p">&lt;</span><span class="nt">HostNode</span><span class="err">,</span> <span class="na">HostElement</span><span class="p">&gt;(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">createHydrationRenderer</span><span class="p">(</span>
  <span class="nx">options</span>: <span class="kt">RendererOptions</span><span class="p">&lt;</span><span class="nt">Node</span><span class="err">,</span> <span class="na">Element</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">baseCreateRenderer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">createHydrationFunctions</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// implementation
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">baseCreateRenderer</span><span class="p">(</span>
  <span class="nx">options</span>: <span class="kt">RendererOptions</span><span class="p">,</span>
  <span class="nx">createHydrationFns?</span>: <span class="kt">typeof</span> <span class="nx">createHydrationFunctions</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
function list
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b7f55a8fe0f70a58b6af48278f601777b8b3d36a">feat(init): renderer -&gt; baseCreateRenderer TODOs Â· gcclll/stb-vue-next@b7f55a8 Â· GitHub</a></p>
<p>
<code>baseCreateRenderer(options, createHydrationFns)</code> ä¹‹æ‰€ä»¥è¿™ä¹ˆé•¿ï¼Œæ˜¯å› ä¸ºè¿™é‡Œé¢åŒ…å«
äº†ä¸‰åå‡ ä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œä¸‹é¢å°†ä¸€ä¸ªä¸ªæŒ‰ç…§æµç¨‹é€ä¸€å®ç°ã€‚</p>
<table>
<thead>
<tr>
<th>step</th>
<th>what?</th>
<th>step</th>
<th>what?</th>
</tr>
</thead>
<tbody>
<tr>
<td>options</td>
<td>è§£æ„</td>
<td>patch</td>
<td>function</td>
</tr>
<tr>
<td>processText</td>
<td>æ–‡æœ¬å¤„ç†</td>
<td>processCommentNode</td>
<td>æ³¨é‡ŠèŠ‚ç‚¹</td>
</tr>
<tr>
<td>mountStaticNode</td>
<td>åŠ è½½é™æ€èŠ‚ç‚¹</td>
<td>patchStaticNode</td>
<td>-</td>
</tr>
<tr>
<td>moveStaticNode</td>
<td>-</td>
<td>removeStaticNode</td>
<td>åˆ é™¤é™æ€èŠ‚ç‚¹</td>
</tr>
<tr>
<td>processElement</td>
<td>-</td>
<td><strong>mountElement</strong></td>
<td>-</td>
</tr>
<tr>
<td>setScopeId</td>
<td>-</td>
<td><strong>mountChildren</strong></td>
<td>-</td>
</tr>
<tr>
<td>patchElement</td>
<td>-</td>
<td>patchBlockChildren</td>
<td>-</td>
</tr>
<tr>
<td>patchProps</td>
<td>-</td>
<td>processFragment</td>
<td>-</td>
</tr>
<tr>
<td>processComponent</td>
<td>-</td>
<td><strong>mountComponent</strong></td>
<td>-</td>
</tr>
<tr>
<td><strong>updateComponent</strong></td>
<td>-</td>
<td>setupRenderEffect</td>
<td>-</td>
</tr>
<tr>
<td>updateComponentPreRender</td>
<td>-</td>
<td>patchChildren</td>
<td>-</td>
</tr>
<tr>
<td>patchUnkeyedChildren</td>
<td>-</td>
<td>patchKeyedChildren</td>
<td>-</td>
</tr>
<tr>
<td><strong>move</strong></td>
<td></td>
<td><strong>unmount</strong></td>
<td></td>
</tr>
<tr>
<td><strong>remove</strong></td>
<td>-</td>
<td>removeFragment</td>
<td>-</td>
</tr>
<tr>
<td>unmountComponent</td>
<td>-</td>
<td><strong>unmountChildren</strong></td>
<td>-</td>
</tr>
<tr>
<td>getNextHostNode</td>
<td>-</td>
<td><strong>render</strong></td>
<td>-</td>
</tr>
<tr>
<td>internals</td>
<td>object, ä¸Šè¿°å‡½æ•°åˆ«å</td>
<td>createHydrationFns</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>
æœ€åå‡½æ•°è¿”å› <code>{ render, hydrate, createApp }</code></p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
render(vnode, container)
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9f5b40b943cf24c21bb2ee01459254df0be42972">feat(init): baseCreateRender-&gt; render Â· gcclll/stb-vue-next@9f5b40b Â· GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d4e10d444605e1b8096a8e335262a2561f7376be">feat(init): baseCreateRender-&gt; render with unmount Â· gcclll/stb-vue-next@d4e10d4
Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">render</span>: <span class="kt">RootRenderFunction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// render(h(&#39;div&#39;), root)
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">unmount</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">patch</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">container</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// æ‰§è¡Œæ‰€æœ‰ post å¼‚æ­¥ä»»åŠ¡
</span><span class="c1"></span>  <span class="nx">flushPostFlushCbs</span><span class="p">();</span>
  <span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>vnode ä¸ºç©ºï¼Œä¸” conatainer ä¸Šæœ‰æ³¨å†Œè¿‡ _vnodeï¼Œç»„è¦è¿›è¡Œå¸è½½</p>
<p>
å¦‚ï¼š <code>render(ref.value ? h(&#39;div&#39;) : null)</code></p>
<p>
ref.value = true æ—¶å€™è¿›å…¥ else -&gt; patch</p>
<p>
ref.value = false æ—¶å€™è¿›å…¥ if -&gt; unmount</p>
</li>
<li>
<p>å¦åˆ™æ‰§è¡Œ patch()ï¼Œå¹²ä»€ä¹ˆäº†?</p>
</li>
<li>
<p><code>flushPostFlushCbs()</code> æ­¤æ—¶ç»„ä»¶åº”è¯¥ mounted äº†ï¼Œæ‰‹åŠ¨åˆ·æ‰æ‰€æœ‰ post cbs ã€‚</p>
</li>
<li>
<p>ä¿å­˜ _vnodeï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¿›å…¥æ˜¯æ£€æµ‹</p>
</li>
</ol>
<p>
æ¥ä¸‹æ¥ï¼Œéœ€è¦ç»§ç»­å®ç° <code>unmount()</code> å’Œ <code>patch()</code></p>
</div>
</div>
<div id="outline-container-fn-patch" class="outline-2">
<h2 id="fn-patch">
patch(â€¦args)
</h2>
<div id="outline-text-fn-patch" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/eb48eb9b6a14b0654ed2a4eb966338c2bfe8afe1">feat(init): baseCreateRender-&gt; patch -&gt; processElement Â· gcclll/stb-vue-next@eb48eb9 Â· GitHub</a></p>
<p>
å‚æ•°:</p>
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>n1</td>
<td>VNode, è€èŠ‚ç‚¹</td>
</tr>
<tr>
<td>n2</td>
<td>VNode, æ–°èŠ‚ç‚¹</td>
</tr>
<tr>
<td>container</td>
<td>å®¹å™¨</td>
</tr>
<tr>
<td>anchor</td>
<td>?</td>
</tr>
<tr>
<td>parentComponent</td>
<td>çˆ¶çº§ç»„ä»¶</td>
</tr>
<tr>
<td>parentSuspense</td>
<td>Suspense ?</td>
</tr>
<tr>
<td>isSVG</td>
<td>?</td>
</tr>
<tr>
<td>optimized</td>
<td>æ˜¯å¦ä¼˜åŒ–è¿‡ï¼Ÿ</td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>æ£€æµ‹èŠ‚ç‚¹ç±»å‹æ˜¯ä¸æ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸ä¸€æ ·ç›´æ¥å¸è½½è€çš„</p>
<p>
å› ä¸ºç±»å‹éƒ½ä¸ä¸€æ ·äº†ï¼Œå¯èƒ½æ•´ä¸ªğŸŒ²éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œç›´æ¥å¸è½½è€çš„é‡æ–° patch æ–°çš„(<strong>n2</strong>)ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">isSameVNodeType</span><span class="p">(</span><span class="nx">n1</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span>
    <span class="nx">n2</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT</span> <span class="o">&amp;&amp;</span>
    <span class="nx">hmrDirtyComponents</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ConcreteComponent</span><span class="p">)</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// HMR only: if the component has been hot-updated, force a reload.
</span><span class="c1"></span>    <span class="c1">// ç»„ä»¶è¢«çƒ­æ›´æ–°ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">n1</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">n2</span><span class="p">.</span><span class="kr">type</span> <span class="o">&amp;&amp;</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">n2</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ul>
<li>
<p>ç»„ä»¶å‘ç”Ÿäº†çƒ­æ›´æ–°(HMRå¯ç”¨æƒ…å†µä¸‹)ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½ç»„ä»¶</p>
</li>
<li>
<p>åŒæ—¶åˆ¤æ–­ type å’Œ keyï¼Œæœ‰å¯èƒ½ type ä¸€æ ·(æ¯”å¦‚ï¼š <code>ul&gt;li</code> åŒç±»å‹å…ƒç´ çš„åˆ é™¤ç§»åŠ¨æ“ä½œ)</p>
</li>
</ul>
</li>
<li>
<p>switch -&gt; n2.type æ ¹æ®ç±»å‹ä¸åŒèµ°ä¸åŒåˆ†æ”¯è¿›è¡Œå¤„ç†</p>
<p>
åªæ”¯æŒçš„ç±»å‹ï¼š <code>Text|Comment|Static</code> èŠ‚ç‚¹ç±»å‹</p>
<p>
ç»„ä»¶ç±»å‹(default åˆ†æ”¯): <code>ELEMENT/TELEPORT/COMPONENT/SUSPENSE</code></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
patch-&gt;processElement(â€¦args)
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/761db2b532ceaaf9554b7df07e2fffe686cd98f0">feat(init): baseCreateRender-&gt; patch -&gt; processElement imp Â·
gcclll/stb-vue-next@761db2b Â· GitHub</a></p>
<p>
args åŒ <a href="#fn-patch">patch çš„ args</a> ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">processElement</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">n1</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">,</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
  <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">isSVB</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">optimized</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">isSVG</span> <span class="o">=</span> <span class="nx">isSVG</span> <span class="o">||</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&#34;svg&#34;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// no old
</span><span class="c1"></span>    <span class="nx">mountElement</span><span class="p">(</span>
      <span class="nx">n2</span><span class="p">,</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="nx">anchor</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">parentSuspense</span><span class="p">,</span>
      <span class="nx">isSVG</span><span class="p">,</span>
      <span class="nx">optimized</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">patchElement</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">,</span> <span class="nx">optimized</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>æ²¡æœ‰ n1 è€èŠ‚ç‚¹ï¼Œç›´æ¥ mount æ–°çš„ n2 èŠ‚ç‚¹</p>
</li>
<li>
<p>å¦åˆ™ï¼Œè¿›è¡Œ patch æ“ä½œ</p>
</li>
</ol>
<p>
æ¥ä¸‹æ¥æŒ‰ç…§ <a href="#fn-patchElement">patchElement</a> -&gt; <a href="#fn-mountElement">mountElement</a> é¡ºåºå®ç°ã€‚</p>
</div>
</div>
<div id="outline-container-fn-patchElement" class="outline-2">
<h2 id="fn-patchElement">
mountElement(â€¦args)
</h2>
<div id="outline-text-fn-patchElement" class="outline-text-2">
<p>
è¿›è¡Œåˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆæ­¥çš„åˆ¤æ–­ï¼Œ patch å’Œ mount çš„åŒºåˆ«ï¼Œ</p>
<p>
<strong>patch</strong>: éé¦–æ¬¡åŠ è½½ç»„ä»¶çš„æ—¶å€™ï¼Œç”¨ new å’Œ old vnode èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒç„¶åå¯¹å‘ç”Ÿå˜æ›´çš„
èŠ‚ç‚¹è¿›è¡Œæ›¿æ¢æˆ–æ›´æ–°æ“ä½œã€‚</p>
<p>
<strong>mount</strong>: å±äºé¦–æ¬¡åŠ è½½ç»„ä»¶çš„æ—¶å€™ï¼Œå±äºé‡æ–°åˆ›å»ºèŠ‚ç‚¹çš„æ“ä½œï¼Œä¸å­˜åœ¨æ¯”è¾ƒä»€ä¹ˆçš„ä¸€äº›æ“
ä½œã€‚</p>
<p>
æ¯”å¦‚ï¼š <code>render</code> é‡Œé¢çš„æ ¹æ® vnode æ¥åˆ¤æ–­æ˜¯ Unmount è¿˜æ˜¯ patchï¼Œä»¥åŠ
processElement ä¸­æ ¹æ® old vnode æ¥æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰æ—§çš„èŠ‚ç‚¹(éé¦–æ¬¡)æ¥åˆ¤å®šæ˜¯ç›´æ¥ Mount
ç»„ä»¶è¿˜æ˜¯ patch æ¯”è¾ƒæ›´æ–°ç»„ä»¶ã€‚</p>
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
default ELEMENT
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/81af3859c02379dac8aec3a08374c2936fdc4fe2">feat(add): patch element Â· gcclll/stb-vue-next@81af385 Â· GitHub</a></p>
<p>
render å‡½æ•°å®ç°ï¼Œ vnode ä¸ºç©ºä¼šè¿›å…¥å¸è½½ unmount æµç¨‹ï¼Œå¦åˆ™æ‰§è¡Œçš„æ˜¯ patch ï¼Œè¿™ä¸ªåº”
è¯¥å°±æ˜¯é€šè¿‡ vnode èŠ‚ç‚¹ç»“æ„æ‰§è¡Œ diff å’Œ dom æ“ä½œçš„å…¥å£äº†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">render</span>: <span class="kt">RootRenderFunction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;render.......xxx&#39;</span><span class="p">)</span>
    <span class="c1">// render(h(&#39;div&#39;), root)
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">vnode</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">unmount</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">patch</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// æ‰§è¡Œæ‰€æœ‰ post å¼‚æ­¥ä»»åŠ¡
</span><span class="c1"></span>    <span class="nx">flushPostFlushCbs</span><span class="p">()</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">_vnode</span> <span class="o">=</span> <span class="nx">vnode</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ³¨æ„ä¸Šé¢çš„ <code>flushPostFlushCbs()</code> æ˜¯åœ¨ patch ä¹‹åæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ post cbs ä¼šåœ¨ç»„
ä»¶ mount/unmount å®Œæˆä¹‹åçš„ä¸‹ä¸€ä¸ª tick å»æ‰§è¡Œçš„å›è°ƒã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">patch</span>: <span class="kt">PatchFn</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">n1</span><span class="p">,</span>
    <span class="nx">n2</span><span class="p">,</span>
    <span class="nx">container</span><span class="p">,</span>
    <span class="nx">anchor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentComponent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentSuspense</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isSVG</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">optimized</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;patching...&#39;</span><span class="p">)</span>
    <span class="c1">// ä¸åŒç±»å‹èŠ‚ç‚¹ï¼Œç›´æ¥å¸è½½è€çš„ğŸŒ²
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isSameVNodeType</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="c1">// TODO patch bail, è¿›è¡Œå…¨æ¯”è¾ƒ(full diff)
</span><span class="c1"></span>
    <span class="c1">// æ–°èŠ‚ç‚¹å¤„ç†
</span><span class="c1"></span>    <span class="kr">const</span> <span class="p">{</span> <span class="kr">type</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">shapeFlag</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">n2</span>
    <span class="k">switch</span> <span class="p">(</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="c1">// ELEMENT/COMPONENT/TELEPORT/SUSPENSE
</span><span class="c1"></span>        <span class="c1">// é»˜è®¤åªæ”¯æŒè¿™å››ç§ç»„ä»¶
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">processElement</span><span class="p">(</span>
            <span class="nx">n1</span><span class="p">,</span>
            <span class="nx">n2</span><span class="p">,</span>
            <span class="nx">container</span><span class="p">,</span>
            <span class="nx">anchor</span><span class="p">,</span>
            <span class="nx">parentComponent</span><span class="p">,</span>
            <span class="nx">parentSuspense</span><span class="p">,</span>
            <span class="nx">isSVG</span><span class="p">,</span>
            <span class="nx">optimized</span>
          <span class="p">)</span>
        <span class="p">}</span>
        <span class="k">break</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">parentComponent</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO set ref
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
patch å‡½æ•°é‡Œé¢é€šè¿‡ switch åˆ†æ”¯æ ¹æ® <code>ShapeFlags</code> çš„ç±»å‹ç±»è°ƒç”¨å¯¹åº”çš„  <code>processXxx</code>
å‡½æ•°è¿›è¡Œå¤„ç† old/new vnode èŠ‚ç‚¹ï¼Œè€Œè¿™é‡Œçš„ <code>ShapeFlags</code> å€¼çš„ä¾æ®æ¥è‡ªå“ªé‡Œï¼Ÿæ˜¯åœ¨å“ª
é‡Œèµ‹å€¼çš„ï¼Œç”±ç”±ä»€ä¹ˆä½œç”¨ï¼Ÿ ã€‚</p>
<p>
è¿™é‡Œä»¥æ™®é€šçš„ ELEMENT æ ‡ç­¾ä½œä¸ºåˆ‡å…¥ç‚¹æ¥å®ç°ä¸€ä¸ªå®Œæ•´çš„è¿‡ç¨‹ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°
processElement ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">processElement</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">n1</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
    <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
    <span class="nx">optimized</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">isSVG</span> <span class="o">=</span> <span class="nx">isSVG</span> <span class="o">||</span> <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;svg&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// no old
</span><span class="c1"></span>      <span class="nx">mountElement</span><span class="p">(</span>
        <span class="nx">n2</span><span class="p">,</span>
        <span class="nx">container</span><span class="p">,</span>
        <span class="nx">anchor</span><span class="p">,</span>
        <span class="nx">parentComponent</span><span class="p">,</span>
        <span class="nx">parentSuspense</span><span class="p">,</span>
        <span class="nx">isSVG</span><span class="p">,</span>
        <span class="nx">optimized</span>
      <span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// è¯¥é˜¶æ®µè¿˜ä¸ä¼šåˆ°è¿™é‡Œ
</span><span class="c1"></span>      <span class="nx">patchElement</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">,</span> <span class="nx">optimized</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œå°±æ˜¯ä¸ªå¾ˆç®€å• ifâ€¦else åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰æ—§çš„èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ˜¯ mount æœ‰åˆ™æ˜¯ patch æ“ä½œï¼Œ
æ‰€ä»¥éœ€è¦å®Œæˆ mountElement</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">mountElement</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
    <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
    <span class="nx">optimized</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mount element...&#39;</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">el</span>: <span class="kt">RendererElement</span>
    <span class="kd">let</span> <span class="nx">vnodeHook</span>: <span class="kt">VNodeHook</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">|</span> <span class="kc">null</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="kr">type</span><span class="p">,</span> <span class="nx">shapeFlag</span><span class="p">,</span> <span class="nx">patchFlag</span><span class="p">,</span> <span class="nx">props</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">vnode</span>

    <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span>
      <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">&amp;&amp;</span>
      <span class="nx">hostCloneNode</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span>
      <span class="nx">patchFlag</span> <span class="o">===</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">HOISTED</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">el</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">hostCreateElement</span><span class="p">(</span>
        <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">,</span>
        <span class="nx">isSVG</span><span class="p">,</span>
        <span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="k">is</span>
      <span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// hostInsert
</span><span class="c1"></span>    <span class="nx">hostInsert</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">)</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
mountElement é‡Œé¢ä¸¤ä¸ªæ ¸å¿ƒçš„å‡½æ•° <code>hostCreateElement</code> å’Œ <code>hostInsert</code> åˆ†åˆ«æ¥è‡ª
<code>baseCreateRender(option)</code> çš„ option å‚æ•°ã€‚</p>
<p>
è¿™é‡Œå°±éœ€è¦æ·±å…¥äº†è§£ <code>runtime-test</code> è¿™ä¸ªåŒ…ï¼Œå®ƒæ˜¯ä½œç”¨ä¸ºäº†èƒ½æµ‹è¯• runtime-core ç¼–å†™çš„
ä¸€ä¸ªæµ‹è¯•æŠ¥ï¼Œè¿™é‡ŒåŒ…å«äº†ä¸€äº›åˆ—çš„ DOM æ“ä½œå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¹Ÿä¼šåœ¨å°è£… <code>render</code> çš„æ—¶å€™
ä¼ é€’ç»™ <code>baseCreateRender(option)</code> ï¼Œæ‰€ä»¥ä¸Šé¢çš„ hostElement å’Œ hostInsert å°±æ˜¯æ¥
è‡ª <code>runtime-test</code> ï¼Œ<a href="/vue/vue-mind-map-runtime-core/#runtime-test">è¿™é‡Œé“¾æ¥</a>å¯ä»¥è·³è½¬æŸ¥çœ‹è¯¥åŒ…é‡Œé¢å…·ä½“åŒ…å«å“ªäº›å‡½æ•°ï¼Œåˆæ˜¯åšä»€ä¹ˆçš„ï¼Œ
è¿™é‡Œå°±ä¸å±•å¼€ç»†è®²ï¼Œä¸»è¦çœ‹ä¸‹ç›¸å…³çš„ä¸¤ä¸ªå‡½æ•°å®ç°ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createElement</span><span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">TestElement</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">node</span>: <span class="kt">TestElement</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">id</span>: <span class="kt">nodeId</span><span class="o">++</span><span class="p">,</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
    <span class="nx">tag</span><span class="p">,</span>
    <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">parentNode</span>: <span class="kt">null</span><span class="p">,</span>
    <span class="nx">eventListeners</span>: <span class="kt">null</span>
  <span class="p">}</span>
  <span class="c1">// ... log
</span><span class="c1"></span>  <span class="c1">// avoid test nodes from being observed
</span><span class="c1"></span>  <span class="nx">markRaw</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">node</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">insert</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">TestNode</span><span class="p">,</span> <span class="nx">parent</span>: <span class="kt">TestElement</span><span class="p">,</span> <span class="nx">ref?</span>: <span class="kt">TestNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">refIndex</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">refIndex</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">refIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;ref: &#39;</span><span class="p">,</span> <span class="nx">ref</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;parent: &#39;</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ref is not a child of parent&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//...log
</span><span class="c1"></span>  <span class="c1">// remove the node first, but don&#39;t log it as a REMOVE op
</span><span class="c1"></span>  <span class="nx">remove</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
  <span class="c1">// re-calculate the ref index because the child&#39;s removal may have affected it
</span><span class="c1"></span>  <span class="nx">refIndex</span> <span class="o">=</span> <span class="nx">ref</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">refIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">parent</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">refIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">parent</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ‰€ä»¥è¯´ï¼Œæˆªè‡³ç›®å‰è¿˜å¹¶æ²¡æœ‰æ¶‰åŠåˆ°å®é™…çš„ DOM æ“ä½œï¼Œè¿˜åªæ˜¯åœ¨ vnode ç»“æ„ä¸Šè¿›è¡Œæ’å…¥åˆ é™¤
æ“ä½œã€‚</p>
<p>
è¿™é‡Œå¼€å§‹åº”è¯¥å¯ä»¥æµ‹è¯•äº†ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;xx&#34;</span><span class="p">);</span>
<span class="nx">runtime_test</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; root ast, è¿™é‡Œ children é‡Œé¢åº”è¯¥è¿˜æ²¡æœ‰èŠ‚ç‚¹&#39;</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">f</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">])</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">f</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">),</span> <span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; begin render...&#39;</span><span class="p">)</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; after seririlize inner&#39;</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">]);</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
xx
undefinedfalse
&gt;&gt;&gt; root ast, è¿™é‡Œ children é‡Œé¢åº”è¯¥è¿˜æ²¡æœ‰èŠ‚ç‚¹
{ type: &#39;element&#39;, children: [] }
{ type: &#39;div&#39; }
&gt;&gt;&gt; begin render...
render.......xxx
patching...
mount element...
mountElment else...
el = vnode.el = hostCreateElement =  {
  id: 1,
  type: &#39;element&#39;,
  tag: &#39;div&#39;,
  children: [],
  props: {},
  parentNode: null,
  eventListeners: null
}
&lt;ref *1&gt; {
  id: 0,
  type: &#39;element&#39;,
  tag: &#39;div&#39;,
  children: [
    {
      id: 1,
      type: &#39;element&#39;,
      tag: &#39;div&#39;,
      children: [],
      props: {},
      parentNode: [Circular *1],
      eventListeners: null
    }
  ],
  props: {},
  parentNode: null,
  eventListeners: null
}
&gt;&gt;&gt; after seririlize inner
&lt;div&gt;&lt;/div&gt;
</pre>
<p>
æ³¨æ„çœ‹ä¸Šé¢çš„ç»“æœï¼Œæœ€å <code>h(&#39;div&#39;)</code> ç”Ÿæˆçš„èŠ‚ç‚¹åˆ« insert è¿›äº† <code>root.children</code> ä¸­ï¼Œ
ç„¶åæ³¨æ„ <code>insert</code> æœ€åçš„å®ç°æ’å…¥æ›¿æ¢éƒ¨åˆ†: <strong>å½“æ²¡æœ‰æ‰¾åˆ°æ—¶ refIndex = -1ï¼Œç›´æ¥æ‰§è¡Œ
å°¾éƒ¨æ’å…¥æ“ä½œ <code>push(...)</code>, å¦‚æœæ‰¾åˆ°äº†å°±æ‰§è¡Œ <code>splice(refIndex, 1, child)</code></strong></p>
<p>
æ‰€ä»¥è¿™é‡Œç›´æ¥æ‰§è¡Œçš„æ˜¯ç›´æ¥å°¾éƒ¨æ’å…¥æ“ä½œã€‚</p>
<p>
æœ€åè¾“å‡ºçš„ <code>&lt;div&gt;&lt;/div&gt;</code> æ˜¯ç”±äºè°ƒç”¨äº† <code>serializeInner(root)</code> ç»“æœï¼Œä¹Ÿæ˜¯ç›¸å½“äº
DOM æ“ä½œäº†(<code>serializeInner</code> -&gt; <code>seririlize&gt;children</code> -&gt; <code>serializeElement</code> -&gt; æœ€åæ ¹æ®
tag, props, children é€’å½’è§£æç”Ÿæˆå¯¹åº”çš„ DOM å…ƒç´ ç»“æ„)ã€‚</p>
<p>
serializeElement å®ç°ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">serializeElement</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">TestElement</span><span class="p">,</span>
  <span class="nx">indent</span>: <span class="kt">number</span><span class="p">,</span>
  <span class="nx">depth</span>: <span class="kt">number</span>
<span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">props</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">props</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">isOn</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="o">?</span> <span class="sb">``</span>
        <span class="o">:</span> <span class="nx">value</span> <span class="o">===</span> <span class="sb">``</span>
          <span class="o">?</span> <span class="nx">key</span>
          <span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">=</span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">padding</span> <span class="o">=</span> <span class="nx">indent</span> <span class="o">?</span> <span class="sb">` `</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">indent</span><span class="p">).</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">depth</span><span class="p">)</span> <span class="o">:</span> <span class="sb">``</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="sb">`</span><span class="si">${</span><span class="nx">padding</span><span class="si">}</span><span class="sb">&lt;</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="si">}${</span><span class="nx">props</span> <span class="o">?</span> <span class="sb">` </span><span class="si">${</span><span class="nx">props</span><span class="si">}</span><span class="sb">`</span> <span class="o">:</span> <span class="sb">``</span><span class="si">}</span><span class="sb">&gt;`</span> <span class="o">+</span>
    <span class="sb">`</span><span class="si">${</span><span class="nx">serializeInner</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">indent</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span> <span class="o">+</span>
    <span class="sb">`</span><span class="si">${</span><span class="nx">padding</span><span class="si">}</span><span class="sb">&lt;/</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">&gt;`</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ‰€ä»¥åˆ°æ­¤åº”è¯¥æ˜¯å®Œæˆäº†æœ€æ™®é€šçš„ <code>ELEMENT</code> ç±»å‹å…ƒç´ ä»</p>
<p>
ast -&gt; compiler-dom &gt;&gt; compiler-core &gt;&gt; compiler-sfc
vnode -&gt; runtime-core &gt;&gt; runtime-test(æµ‹è¯•ç”¨)
render -&gt; runtime-core &gt;&gt; baseCreateRender &gt;&gt; render &gt;&gt;
mount/unmount/patch -&gt;
ç”Ÿæˆ DOM å…ƒç´ ç»“æ„è¾ƒä¸ºå®Œæ•´çš„ä»£ç ã€‚</p>
</div>
</div>
<div id="outline-container-headline-9" class="outline-3">
<h3 id="headline-9">
with props
</h3>
<div id="outline-text-headline-9" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/46fc2a0ab59c591c3c1a737e3b604e0aece6cf0b">feat(add): baseRenderer-&gt;element with props Â· gcclll/stb-vue-next@46fc2a0 Â·
GitHub</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">}),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render.......
patching...
mount element...
mountElment else...
&lt;div id=&#34;foo&#34; class=&#34;bar&#34;&gt;&lt;/div&gt;
</pre>
<p>
æœ€åè¾“å‡ºç»“æœï¼š <code>&lt;div id=&#34;foo&#34; class=&#34;bar&#34;&gt;&lt;/div&gt;</code></p>
<p>
è¿˜è®°å¾— <a href="/vue/vue-mind-map-runtime-core/#h-function">runtime-core &gt; h function</a> ä¸€èŠ‚æˆ‘ä»¬è¯¦ç»†æè¿°äº† h å‡½æ•°çš„ç”¨æ³•ï¼Œè¿™é‡Œç®€å•å›é¡¾ä¸‹</p>
<table>
<thead>
<tr>
<th>h ç¬¬äºŒä¸ªå‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ™®é€šå¯¹è±¡</td>
<td>å½“åš props å¤„ç†</td>
</tr>
<tr>
<td>æ•°ç»„ç±»å‹</td>
<td>å½“åš children å¤„ç†</td>
</tr>
<tr>
<td>æ˜¯ä¸ª VNode ç±»å‹å¯¹è±¡</td>
<td>å¸¦æœ‰ __v_isVNode = true å±æ€§ï¼Œ [vnode] å½“åš children å¤„ç†</td>
</tr>
</tbody>
</table>
<p>
æ‰€ä»¥ä¸Šé¢çš„ <code>{ id: &#39;foo&#39;, class: &#39;bar&#39; }</code> è¢«å½“åšå±æ€§ä¼ é€’ç»™ <code>createVNode(type,
props, children ...)</code> å‡½æ•°</p>
<p>
æ–°å¢ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// mountElement å¢åŠ  props å¤„ç†é€»è¾‘
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">mountElement</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
    <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
    <span class="nx">optimized</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mount element...&#39;</span><span class="p">)</span>
    <span class="c1">// TODO
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">el</span>: <span class="kt">RendererElement</span>
    <span class="kd">let</span> <span class="nx">vnodeHook</span>: <span class="kt">VNodeHook</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">|</span> <span class="kc">null</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="kr">type</span><span class="p">,</span> <span class="nx">shapeFlag</span><span class="p">,</span> <span class="nx">patchFlag</span><span class="p">,</span> <span class="nx">props</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">vnode</span>

    <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span>
      <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">&amp;&amp;</span>
      <span class="nx">hostCloneNode</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span>
      <span class="nx">patchFlag</span> <span class="o">===</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">HOISTED</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>


      <span class="c1">// æ–°å¢ start
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// vue ä¿ç•™å±æ€§ ref/key/onVnodeXxx ç”Ÿå‘½å‘¨æœŸ
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isReservedProp</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">hostPatchProp</span><span class="p">(</span>
              <span class="nx">el</span><span class="p">,</span>
              <span class="nx">key</span><span class="p">,</span>
              <span class="kc">null</span><span class="p">,</span>
              <span class="nx">props</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span>
              <span class="nx">isSVG</span><span class="p">,</span>
              <span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">[],</span>
              <span class="nx">parentComponent</span><span class="p">,</span>
              <span class="nx">parentSuspense</span><span class="p">,</span>
              <span class="nx">unmountChildren</span>
            <span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="nx">vnodeHook</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">onVnodeBeforeMount</span><span class="p">))</span> <span class="p">{</span>
          <span class="c1">// æ‰§è¡Œ before mount hook
</span><span class="c1"></span>          <span class="nx">invokeVNodeHook</span><span class="p">(</span><span class="nx">vnodeHook</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="c1">// end æ–°å¢
</span><span class="c1"></span>    <span class="p">}</span>


    <span class="c1">// ...
</span><span class="c1"></span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
render -&gt; patch -&gt; case ELEMENT -&gt; processElement -&gt; mountElement</p>
<p>
åœ¨ mountElement ä¸­å¢åŠ  props å¤„ç†é€»è¾‘ï¼Œé’ˆå¯¹æ¯ä¸ª prop æ£€æµ‹æ˜¯ä¸æ˜¯ä¿ç•™åå­—</p>
<p>
<code>key/ref/onVnodeXxx</code> ç­‰ç”Ÿå‘½å‘¨æœŸåï¼Œéä¿ç•™åå­—æ‰éœ€è¦å¤„ç†ï¼Œè°ƒç”¨ hostPatchProp() å¤„
ç†ï¼Œåé¢åŠ ä¸Š <code>BeforeMount</code> ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°è°ƒç”¨ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// runtime-test/src/patchProp.ts
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">patchProp</span><span class="p">(</span>
  <span class="nx">el</span>: <span class="kt">TestElement</span><span class="p">,</span>
  <span class="nx">key</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">prevValue</span>: <span class="kt">any</span><span class="p">,</span>
  <span class="nx">nextValue</span>: <span class="kt">any</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">logNodeOp</span><span class="p">({</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeOpTypes</span><span class="p">.</span><span class="nx">PATCH</span><span class="p">,</span>
    <span class="nx">targetNode</span>: <span class="kt">el</span><span class="p">,</span>
    <span class="nx">propKey</span>: <span class="kt">key</span><span class="p">,</span>
    <span class="nx">propPrevValue</span>: <span class="kt">prevValue</span><span class="p">,</span>
    <span class="nx">propNextValue</span>: <span class="kt">nextValue</span>
  <span class="p">})</span>
  <span class="nx">el</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nextValue</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isOn</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="p">;(</span><span class="nx">el</span><span class="p">.</span><span class="nx">eventListeners</span> <span class="o">||</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">eventListeners</span> <span class="o">=</span> <span class="p">{}))[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nextValue</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ™®é€šå±æ€§ç›´æ¥æ›´æ–°åˆ° <code>el.props</code> ä¸­ï¼Œå¦‚æœæ˜¯ <code>onXxx</code> ç±»å‹çš„äº‹ä»¶ï¼Œå–å‡º <code>xxx</code> ä½œä¸º
<code>el.eventListeners</code> çš„ key å°†äº‹ä»¶åå’Œå…¶å¤„ç†å¥æŸ„ä¿å­˜èµ·æ¥ã€‚</p>
<p>
è¿™é‡Œçš„ <code>el</code> å®é™…ä¸Šæ˜¯ä¸ª ast ç»“æ„ç±»å‹çš„å¯¹è±¡ï¼Œä¿å­˜è¿™æ¯ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p>
</div>
</div>
<div id="outline-container-headline-10" class="outline-3">
<h3 id="headline-10">
with text children
</h3>
<div id="outline-text-headline-10" class="outline-text-3">
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
çº¯æ–‡æœ¬å•èŠ‚ç‚¹ child
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<p>
å°†çº¯æ–‡æœ¬åšä¸º child ï¼Œå°†ä¼šè¢« <code>h</code> å‡½æ•°è½¬æˆ <code>[child]</code> ä¼ é€’ç»™ <code>createVNode(type,
props, children, ...)</code> åšä¸ºå®ƒçš„children å‚æ•°å¤„ç†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="mi">_</span><span class="nx">root</span> <span class="o">=</span> <span class="nx">tag</span> <span class="p">=&gt;</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tag</span> <span class="o">||</span> <span class="s2">&#34;div&#34;</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; çº¯æ–‡æœ¬ä½œä¸º children&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">r1</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">root</span><span class="p">()</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="s1">&#39;pure test as children&#39;</span><span class="p">),</span> <span class="nx">r1</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">inner</span><span class="p">(</span><span class="nx">r1</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
&gt;&gt;&gt; çº¯æ–‡æœ¬ä½œä¸º children
render.......
patching...
mount element...
mountElment else...
&lt;div&gt;pure test as children&lt;/div&gt;
</pre>
<p>
ä¸Šé¢ç¤ºä¾‹æ˜¯å°†çº¯æ–‡æœ¬ä½œä¸º children å»æ¸²æŸ“è¿› root èŠ‚ç‚¹ï¼Œæ¶‰åŠä»£ç ä¿®æ”¹(<code>mountElement()</code>):</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/43b868e7f26f3e6ef1c0672d58bae842f1b8720f">feat(add): pure text as children to render Â· gcclll/stb-vue-next@43b868e Â·
GitHub</a></p>
<p>
<img src="/img/tmp/diff-mountElement.png" alt="/img/tmp/diff-mountElement.png" title="/img/tmp/diff-mountElement.png" /></p>
</div>
</div>
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
æ•°ç»„ç±»å‹(å¤šä¸ª) children:
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e6a5e619627bb080906eac4b84a0f1705888c551">feat(add): render-&gt;array children Â· gcclll/stb-vue-next@e6a5e61 Â· GitHub</a></p>
<p>
å½“ h(type, propsOrChildren) ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ•°ç»„æ—¶ä¼šè¢«å½“åš children ç»™ <code>createVNode</code>
ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span><span class="p">]),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render.......
patching...
{ type: &#39;div&#39;, shapeFlag: 17 }
xxxx
case default...
process element...
mount element...
mountElment else...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
&lt;div&gt;foo bar&lt;/div&gt;
</pre>
<p>
ä»ä¸Šé¢çš„è¾“å‡ºå¯å¾—å‡º <code>render(h(&#39;div&#39;), [&#39;foo&#39;, &#39; &#39;, &#39;bar&#39;]), root)</code> å¤§æ¦‚æ‰§è¡Œæµç¨‹:</p>
<ol>
<li>
<p>root-&gt;div</p>
<ul>
<li>
<p><strong>render</strong>, æ ¹æ® vnode ä¸ºç©ºæ£€æµ‹å†³å®šæ˜¯ unmount è¿˜æ˜¯ patch</p>
</li>
<li>
<p><strong>patch</strong>, æ ¹æ® new vnode çš„ type(å››ç§ç±»
å‹ <code>Text|Comment|Fragment|Static|default</code> ) å†³
å®šè°ƒç”¨ä»€ä¹ˆ <code>processXxx</code> è¿›è¡Œå¤„ç†</p>
</li>
<li>
<p><strong>case default</strong> ç”±äºè¿™é‡Œæ˜¯æ ¹èŠ‚ç‚¹ï¼Œä¸”æ˜¯ &#39;div&#39; æ™®é€šç±»å‹å…ƒç´ ï¼Œè¿›å…¥ processElement</p>
</li>
<li>
<p><strong>processElement</strong>, æ ¹æ® old vnode åˆ¤æ–­æ˜¯ mount è¿˜æ˜¯ patch æ“ä½œ</p>
</li>
<li>
<p>æ—  old vnode, æ²¡æœ‰æ—§çš„vnodeè¡¨ç¤ºæ˜¯æ–°èŠ‚ç‚¹ï¼Œéœ€è¦æ‰§è¡Œ mount æ“ä½œ</p>
</li>
<li>
<p><strong>mountElement</strong>, éœ€è¦æ£€æµ‹ vnode.el æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯é™æ€æå‡çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯é™æ€èŠ‚ç‚¹
å±äºå¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œéœ€è¦ cloneVNode å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„</p>
</li>
<li>
<p><strong>else: hostCreateElement</strong> åˆ›å»ºæ–°çš„å…ƒç´ ï¼Œç„¶åé€šè¿‡ <code>shapeFlag</code> åˆ¤æ–­ children
æ˜¯ä»€ä¹ˆç±»å‹è¿›å…¥ä¸åŒåˆ†æ”¯è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œæ˜¯æ•°ç»„(<code>ShapeFlags.ARRAY_CHILDREN</code>) æ‰€
ä»¥ä¼šè°ƒç”¨ <code>mountChildren(vnode.children, el, ...)</code> å¼€å§‹ mount children.</p>
</li>
<li>
<p><strong>mountChldren</strong> , ä¼šå¯¹ children è¿›è¡Œéå†ï¼Œå¦‚æœ child.el å­˜åœ¨è¯´æ˜æ˜¯å¯å¤ç”¨èŠ‚ç‚¹
(é™æ€æå‡çš„)ï¼Œåˆ™å°† child clone å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™è¿›è¡Œ normailize å¤„ç†(å…¶å®ä¹Ÿå°±
æ˜¯æ ¹æ® child æ•°æ®ç±»å‹ä¸åŒæ‰§è¡Œ createVNode è¿”å›æ–°çš„ vnode ç»™ child)ï¼Œæœ€åå°† child ä¼ å…¥ patch å›åˆ°ç¬¬
äºŒæ­¥è¿›è¡Œé€’å½’ mount children</p>
</li>
</ul>
</li>
<li>
<p>root-&gt;div-&gt;&#39;foo&#39;</p>
<p>
åœ¨ <strong>1</strong> æœ€åè¿›å…¥é€’å½’ä¹‹åï¼Œä¼šè¿›å…¥åˆ° patch æ£€æµ‹åˆ° type æ˜¯ Text ç±»å‹ï¼Œå»è°ƒç”¨
<code>processText()</code> å¤„ç† <code>&#39;foo&#39;</code> å®Œæˆä¹‹åï¼Œå†å›æº¯é€’å½’å¤„ç†ä¸‹ä¸€ä¸ªå…ƒç´  <code>&#39; &#39;</code> ç›´åˆ°ç»“æŸã€‚</p>
</li>
<li>
<p>root-&gt;div-&gt;&#39; &#39; åŒ <strong>2</strong></p>
</li>
<li>
<p>root-&gt;idv-&gt;&#39;bar&#39; åŒ <strong>2</strong></p>
</li>
</ol>
<p>
æ¶‰åŠä¿®æ”¹å†…å®¹(<code>renderer.ts -&gt; baseCreateRender</code>)ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// patch()
</span><span class="c1">// å¢åŠ  Text ç±»å‹åˆ†æ”¯å¤„ç† children: [&#39;foo&#39;, &#39; &#39;, &#39;bar&#39;]
</span><span class="c1"></span><span class="k">switch</span> <span class="p">(</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nx">Text</span>:
    <span class="kt">processText</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ–°å¢ processText(n1, n2, container, anchor)
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">processText</span>: <span class="kt">ProcessTextOrCommentFn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;process text...&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">n1</span> <span class="o">==</span> <span class="kc">null</span> <span class="cm">/* old */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ–°èŠ‚ç‚¹ï¼Œæ’å…¥å¤„ç†
</span><span class="c1"></span>    <span class="nx">hostInsert</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">hostCreateText</span><span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">)),</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="nx">anchor</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// has old vnode, need to diff
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// hostInert -&gt; å°† child insert åˆ° container.children ä¸­å»
</span><span class="c1">// hostCreateText -&gt; åˆ›å»º TEXT ç±»å‹çš„èŠ‚ç‚¹ç»“æ„
</span><span class="c1">// runtime-test/src/nodeOps.ts -&gt; createText
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">node</span>: <span class="kt">TestText</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">id</span>: <span class="kt">nodeId</span><span class="o">++</span><span class="p">,</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
  <span class="nx">text</span><span class="p">,</span>
  <span class="nx">parentNode</span>: <span class="kt">null</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// processElement -&gt; mountElement å¢åŠ  ARRAY_CHILDREN
</span><span class="c1">// åˆ†æ”¯å¤„ç†ï¼Œ mountChildren
</span><span class="c1"></span><span class="cm">/* else */</span> <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">mountChildren</span><span class="p">(</span>
    <span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNodeArrayChildren</span><span class="p">,</span>
    <span class="nx">el</span><span class="p">,</span>
    <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentComponent</span><span class="p">,</span>
    <span class="nx">parentSuspense</span><span class="p">,</span>
    <span class="nx">isSVG</span> <span class="o">&amp;&amp;</span> <span class="kr">type</span> <span class="o">!==</span> <span class="s2">&#34;foreignObject&#34;</span><span class="p">,</span>
    <span class="nx">optimized</span> <span class="o">||</span> <span class="o">!!</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">dynamicChildren</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// mountChildren éå† vnode.children
</span><span class="c1">// é€’å½’è°ƒç”¨ patch() å¤„ç†æ¯ä¸ª child
</span><span class="c1">// cloneIfMounted æ˜¯éœ€è¦ä¼˜åŒ–(é™æ€æå‡çš„èŠ‚ç‚¹)ï¼Œå¯å¤ç”¨çš„èŠ‚ç‚¹
</span><span class="c1">// å°†å…¶ clone å‡ºä¸€ä»½æ–°çš„ vnode å‡ºæ¥ä½¿ç”¨
</span><span class="c1">// normailizeVNode æ˜¯æ ¹æ® child çš„æ•°æ®ç±»å‹ä¸åŒæ‰§è¡Œ createVNode è¿”å›
</span><span class="c1">// æ–°çš„ vnode æˆ– child æœ¬èº«(vnode.el å­˜åœ¨çš„æƒ…å†µï¼Œè¢«å¤ç”¨äº†)
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">mountChildren</span>: <span class="kt">MountChildrenFn</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">children</span><span class="p">,</span>
  <span class="nx">container</span><span class="p">,</span>
  <span class="nx">anchor</span><span class="p">,</span>
  <span class="nx">parentComponent</span><span class="p">,</span>
  <span class="nx">parentSuspense</span><span class="p">,</span>
  <span class="nx">isSVG</span><span class="p">,</span>
  <span class="nx">optimized</span><span class="p">,</span>
  <span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">optimized</span>
      <span class="o">?</span> <span class="c1">// è¿™é‡Œæ˜¯æ£€æµ‹ child.el æ˜¯ä¸æ˜¯å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ˜¯å¯æœç”¨çš„ vnode
</span><span class="c1"></span>        <span class="c1">// å³éœ€è¦æå‡çš„é™æ€èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦è¿›è¡Œ cloneVNode ä¹‹åè¿”å›
</span><span class="c1"></span>        <span class="c1">// æ–°çš„ vnode å¯¹è±¡
</span><span class="c1"></span>        <span class="nx">cloneIfMounted</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">)</span>
      <span class="o">:</span> <span class="c1">// æ ¹æ® child çš„ç±»å‹è¿›è¡Œæ‹†åˆ†å¤„ç†
</span><span class="c1"></span>        <span class="c1">// 1. boolean, åˆ›å»ºä¸€ä¸ªç©ºçš„ Comment
</span><span class="c1"></span>        <span class="c1">// 2. array, ä½¿ç”¨ Fragment å°† child åŒ…èµ·æ¥
</span><span class="c1"></span>        <span class="c1">// 3. object, å¦‚æœæ˜¯å¯¹è±¡ï¼Œchild.el å­˜åœ¨ä¸å¦è¿›è¡Œ clone
</span><span class="c1"></span>        <span class="c1">// 4. å…¶ä»–æƒ…å†µï¼Œå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œå½“åš Text ç±»å‹å¤„ç†
</span><span class="c1"></span>        <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
    <span class="c1">// ç„¶åè¿›å…¥ patch é€’å½’å¤„ç† children
</span><span class="c1"></span>    <span class="nx">patch</span><span class="p">(</span>
      <span class="kc">null</span><span class="p">,</span>
      <span class="nx">child</span><span class="p">,</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="nx">anchor</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">parentSuspense</span><span class="p">,</span>
      <span class="nx">isSVG</span><span class="p">,</span>
      <span class="nx">optimized</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// cloneIfMounted æ˜¯æ£€æµ‹ vnode.el æ˜¯ä¸æ˜¯å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨è¯´æ˜æœ‰å¤ç”¨çš„æƒ…å†µ
</span><span class="c1">// é’ˆå¯¹ template-compiled render fns åšçš„ä¼˜åŒ–
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">cloneIfMounted</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">VNode</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="c1">// child.el å¦‚æœå­˜åœ¨çš„è¯ï¼Œchild å±äºé™æ€èŠ‚ç‚¹ä¼šè¢«é™æ€æå‡
</span><span class="c1"></span>  <span class="c1">// æ‰€ä»¥éœ€è¦ clone ä¸€ä»½å‡ºæ¥ï¼Œå¦åˆ™ç›´æ¥è¿”å› child
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">child</span><span class="p">.</span><span class="nx">el</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">child</span> : <span class="kt">cloneVNode</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-3">
<h3 id="headline-13">
children+props æ··åˆæµ‹è¯•
</h3>
<div id="outline-text-headline-13" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">},</span> <span class="p">[</span><span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)]),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">(</span><span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render.......
patching...
{ type: &#39;div&#39;, shapeFlag: 17 }
xxxx
case default...
process element...
mount element...
mountElment else...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
patching...
{ type: &#39;div&#39;, shapeFlag: 1 }
xxxx
case default...
process element...
mount element...
mountElment else...
&lt;div id=&#34;foo&#34; class=&#34;baz&#34;&gt;bar &lt;div&gt;&lt;/div&gt;&lt;/div&gt;
</pre>
</div>
</div>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
å°ç»“
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<p>
æ‰§è¡Œæµç¨‹ï¼š</p>
<p>
<code>render()</code> -&gt; <code>vnode !== null</code> -&gt; <code>patch()</code> -&gt; <code>switch case</code> -&gt;</p>
<p>
<code>default: processElement()</code> -&gt; ç”±äºæ˜¯é¦–æ¬¡åŠ è½½ old vnode ä¸º null -&gt;</p>
<p>
æ‰€ä»¥æ‰§è¡Œ <code>mountElement()</code> æ–°åˆ›å»ºå…ƒç´ è¿›è¡Œ mount æ“ä½œã€‚</p>
<p>
<code>mountElement()</code> é‡Œé¢åŒºåˆ†æ˜¯å¦æ˜¯å¯å¤ç”¨ç»„ä»¶(HOISTED, é™æ€æå‡çš„ç»„ä»¶)ï¼Œé€šè¿‡æ£€æµ‹
vnode.el æ˜¯å¦æœ‰å€¼ï¼Œå› ä¸ºå¦‚æœæ›¾ç»è¢«ä½¿ç”¨è¿‡å¿…å®šä¼šè¿›å…¥ mountElement -&gt; else å¯¹
vnode.el è¿›è¡Œèµ‹å€¼æ“ä½œã€‚</p>
<p>
å¦‚æœæ˜¯å¯å¤ç”¨çš„ç»„ä»¶ï¼Œç›´æ¥ clone ä¸€ä»½æ–°çš„ vnode å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™è¿›å…¥ else åˆ†æ”¯
<code>createElement</code> åˆ›å»ºæ–°çš„èŠ‚ç‚¹ <code>el = vnode.el = hostCreateElement(...)</code> ã€‚</p>
<p>
åœ¨ <code>mountElement</code> ä¸­ä¼˜å…ˆå¯¹ children è¿›è¡Œ mountï¼Œç„¶åå¤„ç† props ï¼Œå› ä¸ºæœ‰äº›æ—¶å€™
props éœ€è¦ä¾èµ– children æ˜¯ä¸æ˜¯åŠ è½½å®Œæˆäº†ï¼Œæ¯”å¦‚: <code>&lt;option value&gt;</code> å…ƒç´ ï¼Œéœ€è¦æ ¹æ®
<code>value</code> æœ€ç»ˆçš„å€¼é€‰æ‹©ä½¿ç”¨å“ªä¸ª child(å‰ææ˜¯è¿™ä¸ª child å¿…é¡»å·²ç»åŠ è½½å®Œæˆäº†) ã€‚</p>
<p>
children çš„å¤„ç†ï¼Œæœ‰ä¸¤ä¸ªç±»å‹åˆ†æ”¯å¤„ç†(<code>TEXT_CHILDREN</code> å’Œ <code>ARRAY_CHILDREN</code>)ï¼Œä¸ºä»€ä¹ˆ
åªæœ‰ä¸¤ä¸ªå‘¢ï¼Ÿ</p>
<p>
è¿™æ˜¯å› ä¸ºåœ¨ <code>createVNode()</code> å‡½æ•°ä¸­ä¼šè°ƒç”¨ <code>normalizeChildren()</code> å¯¹ <code>children</code> è¿›è¡Œ
æ£€æµ‹ï¼Œåˆ†å‡ ç§æƒ…å†µå¤„ç†ï¼š</p>
<table>
<thead>
<tr>
<th>children ç±»å‹</th>
<th>type(<code>ShapeFlags</code>)</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Array</code></td>
<td><code>ARRAY_CHILDREN</code></td>
<td>-</td>
</tr>
<tr>
<td><code>Object</code></td>
<td><code>SLOTS_CHILDREN</code></td>
<td>åŒºåˆ†æ˜¯ ELEMENT/TELEPORT æˆ–å…¶ä»–ç±»å‹</td>
</tr>
<tr>
<td><code>Function</code></td>
<td><code>SLOTS_CHILDREN</code></td>
<td>å‡½æ•°ç›´æ¥å½“åšæ’æ§½å¤„ç†</td>
</tr>
<tr>
<td><code>String</code> æˆ– <code>Number</code></td>
<td><code>TEXT_CHILDREN</code></td>
<td>å½“åšæ–‡æœ¬å¤„ç†</td>
</tr>
</tbody>
</table>
<p>
ä¸Šé¢æœ‰ä¸ªæ’æ§½ç±»å‹ï¼Œè¿˜è®°å¾— compiler-core é‡Œé¢å¯¹æ’æ§½çš„ç¼–è¯‘ç»“æœå—ï¼Ÿ</p>
<p>
<a href="/vue/vue-mind-map-compiler-core-transform-generate/#v-slot">compiler-core é˜¶æ®µå¯¹ slotæ ‡ç­¾å’Œ v-slot çš„è§£ææºç åˆ†æ -&gt;</a></p>
<p>
å¤§è‡´è§£æç»“æœå°±æ˜¯ç»„ä»¶å†…çš„æ‰€æœ‰å…ƒç´ æŒ‰ç…§ä¸€å®šçš„è§„åˆ™è§£ææˆæ’æ§½ï¼Œæœ€åç”Ÿæˆçš„ render å‡½æ•°
å¤§æ¦‚æ˜¯ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s1">&#39;Comp&#39;</span><span class="p">,</span> <span class="kc">null</span> <span class="cm">/* props */</span><span class="p">,</span> <span class="p">{</span>
  <span class="c1">// é»˜è®¤æ’æ§½
</span><span class="c1"></span>  <span class="nx">defualt</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="cm">/* ...slot children... */</span> <span class="p">]),</span>
  <span class="p">[</span><span class="nx">named</span><span class="p">]</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="cm">/* åŠ¨æ€å…·åæ’æ§½ */</span><span class="p">]),</span>
  <span class="nx">name</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="cm">/* å…·åæ’æ§½ */</span><span class="p">]),</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ‰€ä»¥å½“ children æ˜¯ä¸ªå¯¹è±¡çš„æ—¶å€™åœ¨ <code>createVNode()</code> -&gt; <code>normalizeChildren()</code> ä¸­ä¼šè¢«
å½“åšæ’æ§½æ¥å¤„ç†ã€‚</p>
</div>
</div>
</div>
</div>
<div id="outline-container-fn-patchElement" class="outline-2">
<h2 id="fn-patchElement">
patchElement
</h2>
<div id="outline-text-fn-patchElement" class="outline-text-2">
<p>
<code>render()</code> -&gt; <code>patch()</code> -&gt; <code>processElement()</code> -&gt;</p>
<p>
å½“æ£€æµ‹åˆ° old vnode å­˜åœ¨çš„æ—¶å€™ä¼šè¿›å…¥åˆ°è¿™ä¸ªå‡½æ•° <code>patchElement()</code> è¿›è¡Œæ›´æ–°æ“ä½œã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">patchElement</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">n1</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">,</span>
    <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
    <span class="nx">optimized</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// æ—§çš„ el æ›¿æ¢æ‰æ–°çš„ el ?
</span><span class="c1"></span>    <span class="c1">// const el = (n2.el = n1.el!)
</span><span class="c1"></span>    <span class="kd">let</span> <span class="p">{</span> <span class="nx">patchFlag</span><span class="p">,</span> <span class="nx">dynamicChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">n2</span>
    <span class="c1">// #1426 take the old vnode&#39;s patch flag into account since user may clone a
</span><span class="c1"></span>    <span class="c1">// compiler-generated vnode, which de-opts to FULL_PROPS
</span><span class="c1"></span>    <span class="nx">patchFlag</span> <span class="o">|=</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">patchFlag</span> <span class="o">&amp;</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">FULL_PROPS</span>
    <span class="c1">// const oldProps = n1.props || EMPTY_OBJ
</span><span class="c1"></span>    <span class="c1">// const newProps = n2.props || EMPTY_OBJ
</span><span class="c1"></span>
    <span class="c1">// TODO before update hooks
</span><span class="c1"></span>
    <span class="c1">// TODO dirs, æŒ‡ä»¤å¤„ç†
</span><span class="c1"></span>
    <span class="c1">// TODO HRM updating
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">patchFlag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`patch flag &gt; 0 ? </span><span class="si">${</span><span class="nx">patchFlag</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">optimized</span> <span class="o">&amp;&amp;</span> <span class="nx">dynamicChildren</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">optimized</span><span class="p">,</span> <span class="nx">patchFlag</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">// const areaChildrenSVG = isSVG &amp;&amp; n2.type !== &#39;foreignObject&#39;
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dynamicChildren</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;dynamic children...&#39;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">optimized</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;optimized null, éå¯å¤ç”¨èŠ‚ç‚¹&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// TODO vnode hook or dirs å¤„ç†
</span><span class="c1"></span>  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>å…ˆåšä¸ªæµ‹è¯•ï¼Œçœ‹ä¸‹ä»£ç æ‰§è¡Œæµç¨‹(<code>patchElement()</code> é‡Œé¢åŠ äº†ç‚¹æ‰“å°)ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">toSpan</span><span class="o">:</span> <span class="mi">_</span><span class="nx">toSpan</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">toSpan</span> <span class="o">=</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="mi">_</span><span class="nx">toSpan</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">renderChildren</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ç»™ root&gt;div ä¸­æ’å…¥ children
</span><span class="c1"></span>      <span class="c1">// &lt;div&gt;&lt;span&gt;1&lt;/span&gt;...&lt;/div&gt;
</span><span class="c1"></span>      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">toSpan</span><span class="p">)),</span> <span class="nx">root</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>
    <span class="c1">// root ä¸ŠæŒ‚ä¸€ä¸ª &#39;&lt;div id=&#34;1&#34;&gt;hello&lt;/div&gt;&#39;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>

    <span class="c1">// å¢åŠ ä¸€ä¸ª &lt;span&gt;1&lt;/span&gt;
</span><span class="c1"></span>    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">renderChildren</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>

    <span class="nx">log</span><span class="p">(</span><span class="sb">`elm.children.length = </span><span class="si">${</span><span class="nx">elm</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render()...
patch()...
processElement()...
mountElement()...
mountElment else...
render()...
patch()...
processElement()...
patchElement()...
{ optimized: false, patchFlag: 0 }
optimized null, éå¯å¤ç”¨èŠ‚ç‚¹
patchChildren()...
patchChildren, é text children
patchChildren, é text children, é array children...
elm.children.length = 1
</pre>
<p>
ä»ä¸Šé¢çš„ç»“æœå¯çŸ¥æˆ‘ä»¬è¯¥é˜¶æ®µéœ€è¦å®ç°çš„éƒ¨åˆ†ä»£ç ä¸ºï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// patchElement()
</span><span class="c1">// è¿™é‡Œæ˜¯ props å¤„ç†
</span><span class="c1"></span><span class="cm">/* else */</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">optimized</span> <span class="o">&amp;&amp;</span> <span class="nx">dynamicChildren</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">optimized</span><span class="p">,</span> <span class="nx">patchFlag</span> <span class="p">});</span>
  <span class="c1">// TODO patchProps
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// å’Œ
</span><span class="c1"></span><span class="cm">/* else */</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">optimized</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;optimized null, éå¯å¤ç”¨èŠ‚ç‚¹&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// patchChildren()
</span><span class="c1"></span><span class="cm">/* else */</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;patchChildren, old é text children&#34;</span><span class="p">);</span>

  <span class="cm">/* else */</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
      <span class="s2">&#34;patchChildren, old é text children, new é array children...&#34;</span>
    <span class="p">);</span>
    <span class="c1">// prev children was text or null
</span><span class="c1"></span>    <span class="c1">// new children is array or null
</span><span class="c1"></span>    <span class="c1">// è€çš„ children æ˜¯ textï¼Œæ–°çš„åˆæ˜¯æ•°ç»„æƒ…å†µ
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// å…ˆæ¸…ç©ºï¼Ÿ
</span><span class="c1"></span>      <span class="nx">hostSetElementText</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ç„¶åç›´æ¥é‡æ–°åŠ è½½æ–°çš„ array children -&gt; c2
</span><span class="c1"></span>    <span class="c1">// old children æ˜¯ array
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">mountChildren</span><span class="p">(</span>
        <span class="nx">c2</span> <span class="kr">as</span> <span class="nx">VNodeArrayChildren</span><span class="p">,</span>
        <span class="nx">container</span><span class="p">,</span>
        <span class="nx">anchor</span><span class="p">,</span>
        <span class="nx">parentComponent</span><span class="p">,</span>
        <span class="nx">parentSuspense</span><span class="p">,</span>
        <span class="nx">isSVG</span><span class="p">,</span>
        <span class="nx">optimized</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é‡æ–°æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">toSpan</span><span class="o">:</span> <span class="mi">_</span><span class="nx">toSpan</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">toSpan</span> <span class="o">=</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="mi">_</span><span class="nx">toSpan</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">renderChildren</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ç»™ root&gt;div ä¸­æ’å…¥ children
</span><span class="c1"></span>      <span class="c1">// &lt;div&gt;&lt;span&gt;1&lt;/span&gt;...&lt;/div&gt;
</span><span class="c1"></span>      <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">toSpan</span><span class="p">)),</span> <span class="nx">root</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span>
    <span class="c1">// root ä¸ŠæŒ‚ä¸€ä¸ª &#39;&lt;div id=&#34;1&#34;&gt;hello&lt;/div&gt;&#39;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>

    <span class="c1">// å¢åŠ ä¸€ä¸ª &lt;span&gt;1&lt;/span&gt;
</span><span class="c1"></span>    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">renderChildren</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>

    <span class="nx">log</span><span class="p">(</span><span class="sb">`elm.children.length = </span><span class="si">${</span><span class="nx">elm</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render()...
patch()...
processElement()...
mountElement()...
mountElment else...
render()...
patch()...
processElement()...
patchElement()...
{ optimized: false, patchFlag: 0 }
optimized null, éå¯å¤ç”¨èŠ‚ç‚¹
patchChildren()...
patchChildren, old é text children
patchChildren, old é text children, new é array children...
patch()...
processElement()...
mountElement()...
mountElment else...
elm.children.length = 1
</pre>
<p>
å› æ­¤åˆ°è¿™é‡Œå°†ä¼šè¿›å…¥ patchChildren(n1, n2, â€¦) å»è§£æ <code>&#34;hello&#34;</code> è¿™ä¸ªæ–‡æœ¬å­©å­èŠ‚ç‚¹ã€‚</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/26d2bfdcdcfa74e16581f3a1e51439a9522e1d0e">feat(add): patchElement-&gt;patchChildren Â· gcclll/stb-vue-next@26d2bfd</a></p>
</div>
</div>
<div id="outline-container-fn-patchChildren" class="outline-2">
<h2 id="fn-patchChildren">
patchChildren(n1,n2,â€¦)
</h2>
<div id="outline-text-fn-patchChildren" class="outline-text-2">
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-renderer-patchChildren.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-renderer-patchChildren.jpg" title="/img/vue3/runtime-core/vue-runtime-core-renderer-patchChildren.jpg" /></p>
<p>
ç®€åŒ–ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">patchChildren</span>: <span class="kt">PatchChildrenFn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">,</span> <span class="nx">optimized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">patchFlag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">patchFlag</span> <span class="o">&amp;</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">KEYED_FRAGMENT</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// é’ˆå¯¹æœ‰ key å±æ€§è¢« fragment åŒ…è£¹èµ·æ¥çš„å…ƒç´ (ä¾‹å¦‚ï¼š v-for)
</span><span class="c1"></span>      <span class="c1">// ... patchKeyedChildren(...)
</span><span class="c1"></span>      <span class="k">return</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">patchFlag</span> <span class="o">&amp;</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">UNKEYED_FRAGMENT</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ... patchUnkeyedChildren(...)
</span><span class="c1"></span>      <span class="k">return</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// children æœ‰ä¸‰ç§å¯èƒ½ï¼Œtext, array, æˆ–æ²¡æœ‰å­©å­èŠ‚ç‚¹
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// text children
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// å¦‚æœæ˜¯æ•°ç»„ï¼Œç›´æ¥ unmount æ‰
</span><span class="c1"></span>      <span class="c1">// unmountChildren(c1, ...)
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">!==</span> <span class="nx">c1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// hostSetElementText(container, c2) ç›´æ¥æ›¿æ¢æ–‡æœ¬
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// éæ–‡æœ¬èŠ‚ç‚¹å¤„ç†
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span>  <span class="p">{</span>
      <span class="c1">// ä¹‹å‰çš„ children æ˜¯ æ•°ç»„ç±»å‹
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">shapeFlag</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ–°çš„ä¹Ÿæ˜¯æ•°ç»„ï¼Œç›´æ¥è¿›è¡Œ full diff
</span><span class="c1"></span>        <span class="c1">// patchKeyedChildren(...)
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// åˆ°è¿™é‡Œè¡¨ç¤ºæ²¡æœ‰æ–°çš„å­©å­èŠ‚ç‚¹ï¼Œç­‰ä»·äºåˆ é™¤æ“ä½œï¼Œç›´æ¥å¸è½½è€çš„å°±è¡Œ
</span><span class="c1"></span>        <span class="c1">// unmountChildren(c1, ...)
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// è¿™ç§æƒ…å†µï¼Œold æ˜¯ text | null
</span><span class="c1"></span>      <span class="c1">// æ–°çš„æ˜¯æ•°ç»„æˆ– null
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">){</span>
        <span class="c1">// å…ˆæ¸…ç©ºè€çš„æ–‡æœ¬èŠ‚ç‚¹
</span><span class="c1"></span>        <span class="c1">// hostSetElementText(container, &#39;&#39;)
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="c1">// å¦‚æœæ–°çš„æ˜¯æ•°ç»„ï¼Œç›´æ¥ mountï¼Œå› ä¸ºä¹‹å‰çš„å¦‚æœæ˜¯æ–‡æœ¬åœ¨ä¸Šé¢å·²ç»æ¸…ç©ºäº†
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// mountChildren(c2, container, ...)
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ‰€ä»¥æ€»ç»“ä¸‹æ¥æœ‰å‡ ç§æƒ…å†µçš„ç»„åˆï¼š</p>
<ol>
<li>
<p>é¦–å…ˆæ˜¯ patchFlag &gt; 0 æƒ…å†µï¼Œéœ€è¦å±€éƒ¨ diff update(æ¯”å¦‚ï¼š v-for)ï¼Œè¿™é‡Œéœ€è¦åŒºåˆ†æ˜¯
å¦æœ‰ key å±æ€§</p>
<ol>
<li>
<p>keyed: <a href="#fn-patchKeyedChildren">patchKeyedChildren(c1, c2, â€¦)</a></p>
</li>
<li>
<p>unkeyed: <a href="#fn-patchUnkeyedChildren">patchUnkeyedChildren(c1, c2, â€¦)</a></p>
</li>
</ol>
</li>
<li>
<p>åˆ°è¿™é‡Œ patchFlag &lt;= 0 ï¼Œéœ€è¦è¿›è¡Œ full diff çš„æƒ…å†µ</p>
<p>
è¿™ç§æƒ…å†µä¸‹åªæœ‰ä¸‰ç§å¯èƒ½çš„ children: <code>text|array|null</code></p>
<p>
è¿™ä¸‰ç§æƒ…å†µç»“åˆ old + new æœ‰å¤šé‡ç»„åˆéœ€è¦è€ƒè™‘ã€‚</p>
<ol>
<li>
<p>new text + old array: ç›´æ¥å¸è½½ old array, å°† parent å†…å®¹è®¾ç½®æˆ new text</p>
</li>
<li>
<p>new array + old array: å½“åš keyed children è°ƒç”¨ <a href="#fn-patchKeyedChildren">patchKeyedChildren(c1, c2,
â€¦)</a> å¤„ç†</p>
</li>
<li>
<p>new null + old array: ç›´æ¥å¸è½½ old array(<a href="#fn-unmountChildren">unmountChildren(c1, â€¦)</a>)</p>
</li>
<li>
<p>new array + old null: ç›´æ¥ mount new array(<a href="#fn-mountChildren">mountChildren(c2, â€¦)</a>)</p>
</li>
</ol>
</li>
</ol>
<p>
è¿™é‡Œæ¶‰åŠåˆ°å‡ ä¸ªç›¸å…³å‡½æ•°ï¼š</p>
<p>
<a href="#fn-patchKeyedChildren">patchKeyedChildren(c1, c2, container, parentAnchor, parentComponent,
parentSuspense, isSVG, optimized)</a></p>
<p>
<a href="#fn-patchUnkeyedChildren">patchUnkeyedChildren(c1, c2, container, parentAnchor, parentComponent,
parentSuspense, isSVG, optimized)</a></p>
<p>
<a href="#fn-unmountChildren">unmountChildren(children, parentComponent, parentSuspense, doRemove, optimized, start)</a></p>
<p>
<a href="#fn-mountChildren">mountChildren(children, container, anchor, parentComponent, parentSuspense,
isSVG, optimized, start)</a></p>
<p>
æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œä¼šé€ä¸€å®ç°å„ç§æƒ…å†µã€‚</p>
<div class="src src-dot">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">digraph G{
    rankdir=LR;
	  node[shape=box, style=filled, color=&#34;.7.3 1.0&#34;];//ä¸€ä¸ªnodeçš„å±æ€§
	  size = &#34;6, 4&#34;;//å›¾ç‰‡å¤§å°
    patch-&gt;processElement
    processElement-&gt;n1[label=&#34;èŠ‚ç‚¹å·²å­˜åœ¨?&#34;]
    n1[shape=diamond];
    n1-&gt;mountElement[label=&#34;no&#34;]
    n1-&gt;patchElement[label=&#34;yes&#34;]
    mountElement-&gt;patch[style=dotted, color = red]
}</code></pre></td></tr></table>
</div>
</div>
</div>
<p><img src="/img/tmp/jIpIofqUV448p8A.png" alt="/img/tmp/jIpIofqUV448p8A.png" title="/img/tmp/jIpIofqUV448p8A.png" /></p>
<div id="outline-container-headline-17" class="outline-3">
<h3 id="headline-17">
new text + old array
</h3>
<div id="outline-text-headline-17" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7019c9d52f59411cd8532da7e38eaee78db22410">feat(add): new text + old array Â· gcclll/stb-vue-next@7019c9d</a></p>
<p>
patchChildren: å…ˆ unmountChildren(c1) -&gt; hostSetElementText(container, c2)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// children æœ‰ä¸‰ç§å¯èƒ½ï¼š text, array, æˆ–æ²¡æœ‰ children
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;patchChildren, new text...&#34;</span><span class="p">);</span>
  <span class="c1">// text children fast path
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">unmountChildren</span><span class="p">(</span><span class="nx">c1</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">[],</span> <span class="nx">parentComponent</span><span class="p">,</span> <span class="nx">parentSuspense</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">!==</span> <span class="nx">c1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hostSetElementText</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">c2</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
unmountChildren(â€¦) -&gt; éå† children è°ƒç”¨ unmount(children[i], ..)</p>
<p>
unmount(vnode, â€¦) ä¸­é€’å½’è°ƒç”¨ unmountChildren(children, â€¦)</p>
<p>
ä½†æ˜¯è¿™éƒ¨åˆ†é€»è¾‘è‡ªå§‹è‡³ç»ˆ doRemove éƒ½æ˜¯ falseï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ doRemove: remove(vnode)ï¼Œ
å› ä¸ºå¦‚ä¸Šé¢çš„ä»£ç ï¼Œåœ¨ c1 !== c2 çš„æ—¶å€™æ‰§è¡Œäº† <a href="/vue/vue-mind-map-runtime-core/#runtime-test">hostSetElementText(container, c2)</a>è¿™
é‡Œé¢é¦–å…ˆä¼šç›´æ¥æ¸…ç©º <code>container.children</code> ç„¶åé‡æ–°èµ‹å€¼ï¼Œå› æ­¤ remove(vnode) æ²¡æœ‰æ‰§
è¡Œä¹Ÿä¼šå®ç°ç›´æ¥æ›¿æ¢æ“ä½œï¼Œè¿™é‡Œå±äº full diffã€‚</p>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>

    <span class="c1">// root ä¸ŠæŒ‚ä¸€ä¸ª
</span><span class="c1"></span>    <span class="c1">// &#39;&lt;div id=&#34;1&#34;&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/div&gt;&#39;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">[</span> <span class="c1">// #1
</span><span class="c1"></span>      <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
      <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="p">]),</span> <span class="nx">root</span><span class="p">);</span>

    <span class="c1">// å¢åŠ ä¸€ä¸ª &lt;span&gt;1&lt;/span&gt;
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;1. div children length = &#39;</span><span class="p">,</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>

    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s1">&#39;hello&#39;</span><span class="p">),</span> <span class="nx">root</span><span class="p">)</span> <span class="c1">// #2
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;2. div children length = &#39;</span><span class="p">,</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render()...
patch()...
processElement()...
mountElement()...
mountElment else...
patch()...
processElement()...
mountElement()...
mountElment else...
patch()...
processElement()...
mountElement()...
mountElment else...
1. div children length =  2
render()...
patch()...
processElement()...
patchElement()...
{ optimized: false, patchFlag: 0 }
optimized null, éå¯å¤ç”¨èŠ‚ç‚¹
patchChildren()...
patchChildren, new text...
2. div children length =  1
</pre>
<p>
å¦‚ä¸Šç»“æœï¼Œæœ€å¼€å§‹æœ‰ä¸‰ä¸ªé€’å½’ï¼š</p>
<p>
patch() -&gt; processElement() -&gt; mountElement() -&gt; patch()</p>
<div class="src src-dot">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">digraph G{
        rankdir=LR;
	size = &#34;6, 4&#34;;//å›¾ç‰‡å¤§å°
	node[shape = box, style = filled, color = &#34;.7.3 1.0&#34;];//ä¸€ä¸ªnodeçš„å±æ€§
    patch-&gt;processElement;
    processElement-&gt;mountElement;
    mountElement-&gt;patch[style = dotted, color = red]
}</code></pre></td></tr></table>
</div>
</div>
</div>
<p><img src="/img/tmp/J0XD2pb6FUK5Rs8.png" alt="/img/tmp/J0XD2pb6FUK5Rs8.png" title="/img/tmp/J0XD2pb6FUK5Rs8.png" /></p>
<p>
<strong>#1</strong> æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œåˆ†åˆ«å¤„ç† <code>div -&gt; span 1 -&gt; span 2</code> ã€‚</p>
<p>
<strong>#2</strong> æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå±äº full diff æ“ä½œï¼Œæ£€æµ‹åˆ° old array, new textï¼Œæ‰€ä»¥ç›´æ¥æ¸…ç©º
  äº† <code>div.children~ï¼Œç„¶åå¤åˆ¶ ~div.children = [text node]</code></p>
</div>
</div>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
new null + old array
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3f45ac50d6123a1ae1abbd5af218de67689bb943">feat(add): patchChildren -&gt; patch new null, old array Â·
gcclll/stb-vue-next@3f45ac5</a></p>
<p>
æ–°å¢ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;patchChildren, new array, old array...&#34;</span><span class="p">);</span>
    <span class="c1">// TODO patchKeyedChildren
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// new null, old array ç›´æ¥å¸è½½ old
</span><span class="c1"></span>    <span class="nx">unmountChildren</span><span class="p">(</span>
      <span class="nx">c1</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">[],</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">parentSuspense</span><span class="p">,</span>
      <span class="kc">true</span> <span class="cm">/* doRemove */</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¦‚æœ new null ç›´æ¥å¸è½½ old array å°±å¥½äº†ï¼Œæ³¨æ„ç¬¬å››ä¸ªå‚æ•°ä¼ çš„æ˜¯ <code>doRemove:true</code> è¿™
æ · <code>unmount()</code> é‡Œé¢å°±ä¼šå»è°ƒç”¨ <code>remove()</code></p>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>

    <span class="c1">// root ä¸ŠæŒ‚ä¸€ä¸ª
</span><span class="c1"></span>    <span class="c1">// &#39;&lt;div id=&#34;1&#34;&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/div&gt;&#39;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">[</span> <span class="c1">// #1
</span><span class="c1"></span>      <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
      <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="p">]),</span> <span class="nx">root</span><span class="p">);</span>

    <span class="c1">// å¢åŠ ä¸€ä¸ª &lt;span&gt;1&lt;/span&gt;
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;1. div children length = &#39;</span><span class="p">,</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>

    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">root</span><span class="p">)</span> <span class="c1">// #2
</span><span class="c1"></span>    
    <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;2. div children length = &#39;</span><span class="p">,</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render()...
patch()...
processElement()...
mountElement()...
mountElment else...
patch()...
processElement()...
mountElement()...
mountElment else...
patch()...
processElement()...
mountElement()...
mountElment else...
1. div children length =  2
render()...
patch()...
processElement()...
patchElement()...
{ optimized: false, patchFlag: 0 }
optimized null, éå¯å¤ç”¨èŠ‚ç‚¹
patchChildren()...
patchChildren, new not text...
patchChildren, new null, old array...
2. div children length =  0
</pre>
<div class="src src-dot">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">digraph G{
    rankdir=LR;
	size = &#34;6, 4&#34;;//å›¾ç‰‡å¤§å°
	node[shape = box, style = filled, color = &#34;.7.3 1.0&#34;];//ä¸€ä¸ªnodeçš„å±æ€§
    render2,render1[shape=circle,fillcolor=red]
    render1-&gt;patch[label=&#34;two span&#34;];
    patch-&gt;processElement;
    processElement-&gt;mountElement[label=&#34;èŠ‚ç‚¹ä¸å­˜åœ¨&#34;];
    processElement-&gt;patchElement[label=&#34;èŠ‚ç‚¹å­˜åœ¨&#34;,color=&#34;blue&#34;];
    mountElement-&gt;patch[style=dotted, color=red]
    render2-&gt;patch[label=&#34;null&#34;,color=&#34;blue&#34;];
    patchElement-&gt;patchChildren[color=&#34;blue&#34;];
    patchChildren-&gt;unmountChildren[label=&#34;new null&#34;,color=&#34;blue&#34;]
    
}</code></pre></td></tr></table>
</div>
</div>
</div>
<p><img src="/img/tmp/I666vpKZVdkMluo.svg" alt="/img/tmp/I666vpKZVdkMluo.svg" title="/img/tmp/I666vpKZVdkMluo.svg" /></p>
</div>
</div>
<div id="outline-container-headline-19" class="outline-3">
<h3 id="headline-19">
new array + old null/text
</h3>
<div id="outline-text-headline-19" class="outline-text-3">
<p>
è¿™ç§æƒ…å†µï¼Œå¦‚æœæ˜¯ old textï¼Œä¼šå…ˆæ‰§è¡Œ</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">hostSetElementText</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å°† conteiner.children æ¸…ç©ºã€‚</p>
<p>
ç„¶åæ‰§è¡Œ <code>mountChidren(c2)</code> æ’å…¥æ–°çš„ array node ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// prev children was text OR null
</span><span class="c1">// new children is array OR null
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">prevShapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">hostSetElementText</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// mount new if array
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">mountChildren</span><span class="p">(</span>
    <span class="nx">c2</span> <span class="kr">as</span> <span class="nx">VNodeArrayChildren</span><span class="p">,</span>
    <span class="nx">container</span><span class="p">,</span>
    <span class="nx">anchor</span><span class="p">,</span>
    <span class="nx">parentComponent</span><span class="p">,</span>
    <span class="nx">parentSuspense</span><span class="p">,</span>
    <span class="nx">isSVG</span><span class="p">,</span>
    <span class="nx">optimized</span>
  <span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>

    <span class="c1">// root ä¸ŠæŒ‚ä¸€ä¸ª
</span><span class="c1"></span>    <span class="c1">// &#39;&lt;div id=&#34;1&#34;&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/div&gt;&#39;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>

    <span class="c1">// å¢åŠ ä¸€ä¸ª &lt;span&gt;1&lt;/span&gt;
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;1. div children length = &#39;</span><span class="p">,</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>

    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">[</span> <span class="c1">// #1
</span><span class="c1"></span>      <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
      <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="p">]),</span> <span class="nx">root</span><span class="p">)</span> <span class="c1">// #2
</span><span class="c1"></span>
    <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;2. div children length = &#39;</span><span class="p">,</span> <span class="nx">root</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
render()...
patch()...
processElement()...
mountElement()...
mountElment else...
1. div children length =  0
render()...
patch()...
processElement()...
patchElement()...
{ optimized: false, patchFlag: 0 }
optimized null, éå¯å¤ç”¨èŠ‚ç‚¹
patchChildren()...
patchChildren, new not text...
patchChildren, old text | null...
patchChildren, new array...
patch()...
processElement()...
mountElement()...
mountElment else...
patch()...
processElement()...
mountElement()...
mountElment else...
2. div children length =  2
</pre>
</div>
</div>
<div id="outline-container-headline-20" class="outline-3">
<h3 id="headline-20">
new array + old array
</h3>
</div>
</div>
</div>
<div id="outline-container-keyed-children" class="outline-2">
<h2 id="keyed-children">
patchKeyedChildren
</h2>
<div id="outline-text-keyed-children" class="outline-text-2">
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-diff.svg" alt="/img/vue3/runtime-core/vue-runtime-core-diff.svg" title="/img/vue3/runtime-core/vue-runtime-core-diff.svg" /></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/4a6a1f2b59e938346f097ead660d68b3b2837323">feat(add): patchKeyedChildren Â· gcclll/stb-vue-next@4a6a1f2</a></p>
<p>
ä»£ç ä¸­åˆ—å‡ºäº†å‡ ç§å¯èƒ½çš„æƒ…å†µï¼š</p>
<ol>
<li>
<p>old, new nodes å¼€å¤´ç›¸åŒï¼Œä»å·¦åˆ°å³æ–¹å‘ä»¥ä¸åŒä½ç½®ä¸ºèµ·ç‚¹å¼€å§‹æ¯”è¾ƒ</p>
</li>
<li>
<p>old, new nodes ç»“å°¾ç›¸åŒï¼Œä»å³åˆ°å·¦æ–¹å‘ä»¥ä¸åŒä½ç½®ä¸ºèµ·ç‚¹å¼€å§‹æ¯”è¾ƒ</p>
</li>
<li>
<p>old âŠ‚ newï¼Œold ä¸º new çš„çœŸå­é›†ï¼Œè¿™ç§æƒ…å†µè§†ä¸ºæ–°å¢èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹æ–°å¢çš„èŠ‚ç‚¹è¿›è¡Œ
mount æ“ä½œ</p>
</li>
<li>
<p>old âŠƒ new , new ä¸º old çš„çœŸå­é›†ï¼Œè¿™ç§æƒ…å†µè§†ä¸ºåˆ é™¤èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹å¤šä½™çš„èŠ‚ç‚¹è¿›è¡Œ
unmount æ“ä½œ</p>
</li>
<li>
<p>old,new æ²¡æœ‰ç‰¹åˆ«æ˜æ˜¾çš„è§„å¾‹å¯éµå¾ªçš„ï¼Œå¤„ç†èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 24. å¯èƒ½æ‰€æœ‰éƒ½æ˜¯ keyed ä¹Ÿå¯èƒ½éƒ¨åˆ†
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">patchKeyedChildren</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">c1</span>: <span class="kt">VNode</span><span class="p">[],</span>
  <span class="nx">c2</span>: <span class="kt">VNodeArrayChildren</span><span class="p">,</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
  <span class="nx">parentAnchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">optimized</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">l2</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">e1</span> <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// ä¸Šä¸€ä¸ªç»“æŸç´¢å¼•
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">e2</span> <span class="o">=</span> <span class="nx">l2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// ä¸‹ä¸€ä¸ªç»“æŸç´¢å¼•
</span><span class="c1"></span>
  <span class="c1">// 1. sync from start
</span><span class="c1"></span>  <span class="c1">// (a b) c
</span><span class="c1"></span>  <span class="c1">// (a b) d e
</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e1</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// 2. sync from end
</span><span class="c1"></span>  <span class="c1">// a (b c)
</span><span class="c1"></span>  <span class="c1">// d e (b c)
</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e1</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// 3. common sequence + mount
</span><span class="c1"></span>  <span class="c1">// (a b)
</span><span class="c1"></span>  <span class="c1">// (a b) c
</span><span class="c1"></span>  <span class="c1">// i = 2, e1 = 1, e2 = 2
</span><span class="c1"></span>  <span class="c1">// (a b)
</span><span class="c1"></span>  <span class="c1">// c (a b)
</span><span class="c1"></span>  <span class="c1">// i = 0, e1 = -1, e2 = 0
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// 4. common sequence + unmount
</span><span class="c1"></span>  <span class="c1">// (a b) c
</span><span class="c1"></span>  <span class="c1">// (a b)
</span><span class="c1"></span>  <span class="c1">// i = 2, e1 = 2, e2 = 1
</span><span class="c1"></span>  <span class="c1">// a (b c)
</span><span class="c1"></span>  <span class="c1">// (b c)
</span><span class="c1"></span>  <span class="c1">// i = 0, e1 = 0, e2 = -1
</span><span class="c1"></span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// 5. unknown sequence, æœªçŸ¥åºåˆ—
</span><span class="c1"></span>  <span class="c1">// [i ... e1 + 1]: a b [c d e] f g
</span><span class="c1"></span>  <span class="c1">// [i ... e2 + 1]: a b [e d c h] f g
</span><span class="c1"></span>  <span class="c1">// i = 2, e1 = 4, e2 = 5
</span><span class="c1"></span>  <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¸‹é¢æ¥ä¸€ä¸ªä¸ªå®ç°ï¼Œæ­å¼€ diff -&gt; patch çš„ç¥ç§˜é¢çº±ï¼ï¼ï¼</p>
<p>
åœ¨è¿›è¡Œä¹‹å‰å…ˆçœ‹ä¸‹ä¸€ä¸ªå‡½æ•° <code>isSameVNodeType(n1,n2)</code> ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">isSameVNodeType</span><span class="p">(</span><span class="nx">n1</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">n2</span>: <span class="kt">VNode</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span>
    <span class="nx">n2</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT</span> <span class="o">&amp;&amp;</span>
    <span class="nx">hmrDirtyComponents</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">n2</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ConcreteComponent</span><span class="p">)</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// HMR only: if the component has been hot-updated, force a reload.
</span><span class="c1"></span>    <span class="c1">// ç»„ä»¶è¢«çƒ­æ›´æ–°ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">false</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">n1</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">n2</span><span class="p">.</span><span class="kr">type</span> <span class="o">&amp;&amp;</span> <span class="nx">n1</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">n2</span><span class="p">.</span><span class="nx">key</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™ä¸ªå‡½æ•°ç”¨æ¥æ£€æµ‹ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯ç±»ä¼¼èŠ‚ç‚¹(éœ€åŒæ—¶æ»¡è¶³ type å’Œ key ç›¸åŒ)ã€‚</p>
<blockquote>
<p>æœ‰ç‚¹å¤æ‚ï¼Œæ•´çš„å¤´ç–¼ğŸ¤•ğŸ¤•ã€‚ã€‚ã€‚ä¼‘æ¯ä¼šğŸ˜´ğŸ˜´ï¼ï¼ï¼</p>
<p>
[2021-02-24 18:16:56] é€šè¿‡ç”»å›¾ç»ˆäºæŠŠè¿™å—é€»è¾‘æå¾—æœ‰ç‚¹æ¸…æ¥šäº†ï¼ï¼ï¼</p>
</blockquote>
<p>
å‰§æƒ…æœ‰ç‚¹å¤æ‚ï¼Œè¿˜æ˜¯æ ¹æ®å®˜æ–¹çš„æµ‹è¯•ç”¨ä¾‹æ¥é€æ­¥ç†Ÿæ‚‰å„ç§æƒ…å†µçš„ diff -&gt; patch å§ã€‚</p>
<blockquote>
<p>å£°æ˜ï¼š</p>
<ol>
<li>
<p>æ‰€æœ‰ <code>children [1,2,3]</code> éƒ½å°†è‡ªèº«å€¼ä½œä¸ºèŠ‚ç‚¹çš„å±æ€§ key å€¼</p>
</li>
<li>
<p>ä¸‹é¢çš„æ‰€æœ‰ç”¨ä¾‹éƒ½åŸºäºèŠ‚ç‚¹æœ‰ <code>key</code> å±æ€§ä¸ºå‰æ</p>
</li>
</ol>
</blockquote>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b7edc1b0939f2faf88d1e939a749f31fabab99f2">fix: patchKeydChildren if Â· gcclll/stb-vue-next@b7edc1b</a></p>
<p>
å¤§è‡´ç§»åŠ¨è§„åˆ™æµç¨‹å›¾ï¼š</p>
<p>
<img src="/img/vue3/vue-router/vue-runtime-core-diff-move-rules.svg" alt="/img/vue3/vue-router/vue-runtime-core-diff-move-rules.svg" title="/img/vue3/vue-router/vue-runtime-core-diff-move-rules.svg" /></p>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
append([1] -&gt; [1,2,3])
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="c1">// &lt;div&gt;hello&lt;/div&gt;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">rc</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">renderChildren</span><span class="p">(</span><span class="nx">render</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [1] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>

    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [1,2,3] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
root: &lt;div id=1&gt;hello&lt;/div&gt;
&gt;&gt;&gt; render [1] DONE.
root: &lt;div id=1&gt;&lt;span&gt;1&lt;/span&gt;&lt;/div&gt;
patchKeyedChildren...
while 1, sync from start...
patch keyed æ–°å¢ ...
&gt;&gt;&gt; render [1,2,3] DONE.
root: &lt;div id=1&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;/div&gt;
</pre>
<p>
å¦‚ä¸Šç»“æœï¼Œå½“æ‰§è¡Œ patchChildren çš„æ—¶å€™ï¼Œç”±äº old array ï¼Œ new array æ‰€ä»¥ä¼šæ‰§è¡Œ
<code>patchKeyedChildren</code> å¯¹ä¸¤ä¸ª array è¿›è¡Œå¯¹æ¯”æ›´æ–°ã€‚</p>
<p>
while 1: ä»å·¦åˆ°å³å¯¹åŒç±»å‹çš„ VNode è¿›è¡Œ patch ï¼Œæ‰€ä»¥è¿™é‡Œ <code>1</code> èŠ‚ç‚¹ä¼šåœ¨è¿™é‡Œè¢« patch
æ‰ ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e1</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;while 1, sync from start...&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">n1</span> <span class="o">=</span> <span class="nx">c1</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="kr">const</span> <span class="nx">n2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">optimized</span> <span class="c1">// é™æ€èŠ‚ç‚¹
</span><span class="c1"></span>    <span class="o">?</span> <span class="nx">cloneIfMounted</span><span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">)</span>
    <span class="o">:</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>

  <span class="c1">// type &amp; key ç›¸åŒ
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">isSameVNodeType</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">patch</span><span class="p">(</span>
      <span class="nx">n1</span><span class="p">,</span>
      <span class="nx">n2</span><span class="p">,</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="kc">null</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">parentSuspense</span><span class="p">,</span>
      <span class="nx">isSVG</span><span class="p">,</span>
      <span class="nx">optimized</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç„¶åï¼š <code>i=1,e1=0,e2=2</code> æ»¡è¶³ <code>if(i&gt;e1)</code> æ–°å¢èŠ‚ç‚¹æ¡ä»¶ï¼Œå¯¹ <code>[2,3]</code> è¿›å…¥æ–°å¢èŠ‚ç‚¹é€»è¾‘
ä»£ç (<code>if</code> åˆ†æ”¯)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;patch keyed æ–°å¢ ...&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">nextPos</span> <span class="o">=</span> <span class="nx">e2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">anchor</span> <span class="o">=</span> <span class="nx">nextPos</span> <span class="o">&lt;</span> <span class="nx">l2</span> <span class="o">?</span> <span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">nextPos</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">).</span><span class="nx">el</span> : <span class="kt">parentAnchor</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">patch</span><span class="p">(</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">optimized</span>
          <span class="o">?</span> <span class="nx">cloneIfMounted</span><span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">])),</span>
        <span class="nx">container</span><span class="p">,</span>
        <span class="nx">anchor</span><span class="p">,</span>
        <span class="nx">parentComponent</span><span class="p">,</span>
        <span class="nx">parentSuspense</span><span class="p">,</span>
        <span class="nx">isSVG</span>
      <span class="p">);</span>
      <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é’ˆå¯¹ <code>[2,3]</code> åˆ†åˆ«æ‰§è¡Œï¼š</p>
<p>
<code>patch(null, c2[i], container, anchor,...)</code></p>
<p>
æ³¨æ„è¿™é‡Œ <code>anchor</code> æ˜¯ <code>[3]</code> è¿™ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯ç”±äºåœ¨ <code>container.children</code> æ˜¯ä¸å­˜åœ¨çš„ï¼Œ
æ‰€ä»¥å¯¹äº <code>[2]</code> ä¼šæ‰§è¡Œ append æ“ä½œ(å…·ä½“è¯·æŸ¥çœ‹ <a href="https://github.com/vuejs/vue-next/blob/master/packages/runtime-test/src/nodeOps.ts">runtime-test/src/nodeOpts.ts:insert
å‡½æ•°å®ç°)</a>ã€‚</p>
<p>
ç›´åˆ°å…¨éƒ¨ append åˆ° <code>container.children</code> ç»“æŸã€‚</p>
<blockquote>
<p>old: <code>[1]</code>, new: <code>[1,2,3]</code></p>
<p>
è¿™ç§æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç›´æ¥ append 2,3 å°±è¡Œäº†ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-23" class="outline-3">
<h3 id="headline-23">
prepend([4,5]-&gt;[1,2,3,4,5])
</h3>
<div id="outline-text-headline-23" class="outline-text-3">
<p>
å®ä¾‹åˆ†æï¼š <code>n1=[4,5], n2=[1,2,3,4,5]</code> ç»è¿‡ while1 ä»€ä¹ˆéƒ½æ²¡åšï¼Œç»è¿‡ while2 åŒåŒ–æ‰
å°¾éƒ¨ <code>[4,5],i=0,e1=-1,e2=2=</code> æ»¡è¶³ <code>if(i&gt;e1)&amp;&amp;if(i&lt;e2)</code> å±äºæ–°å¢èŠ‚ç‚¹æ“ä½œï¼Œæ’å…¥æ—¶
çš„å‚è€ƒèŠ‚ç‚¹ä¸º <code>c2[e2+1]</code> ï¼Œä¹‹å‰åˆ†æè¿‡å¦‚æœéœ€è¦ç»è¿‡å‰ä¸¤ä¸ª while å¤„ç†çš„èŠ‚ç‚¹éƒ½ä¼šåœ¨
patch çš„è¿‡ç¨‹ä¸­ç›´æ¥æ›¿æ¢æ‰ï¼Œæ¯”å¦‚è¿™é‡Œçš„ <code>[4,5]</code> ä¼šåœ¨ while2 ä¸­è¢«æ›¿æ¢æ‰(ä½“ç°åœ¨
<code>container.children</code> ä¸­)ï¼Œæ–°çš„ <code>[4,5]</code> æ›¿æ¢æ‰è€çš„ <code>[4,5]</code> ï¼Œæ‰€ä»¥è¿™é‡Œå‘ç”Ÿæ’å…¥æ—¶çš„
anchor å®é™…æ˜¯å¯¹åº” <code>container.children</code> ä¸­çš„ <code>[4]</code> ä½ç½®ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="c1">// &lt;div&gt;hello&lt;/div&gt;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">rc</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">renderChildren</span><span class="p">(</span><span class="nx">render</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [4,5] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>

    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [1,2,3,4,5] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
root: &lt;div id=1&gt;hello&lt;/div&gt;
&gt;&gt;&gt; render [4,5] DONE.
root: &lt;div id=1&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;/div&gt;
patchKeyedChildren...
while 1, sync from start...
while 2, sync from end...
while 2, sync from end...
patch keyed æ–°å¢ ...
&gt;&gt;&gt; render [1,2,3,4,5] DONE.
root: &lt;div id=1&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;/div&gt;
</pre>
<p>
ä¸Šé¢ä¸¤æ¬¡ while 2 åˆ†åˆ«å¯¹åº”çš„æ˜¯ <em>5-&gt;4</em> åŒåŒ–è¿‡ç¨‹ã€‚</p>
<blockquote>
<p>åŒç±»ç”¨ä¾‹ï¼Œä¸åšå¤šä½™åˆ†æäº†ï¼Œç›´æ¥çœ‹ç»“æœå§ï¼</p>
<ol>
<li>
<p><code>[1,2,4,5]</code> å’Œ <code>[1,2,3,4,5]</code> ç»è¿‡ while1(æ›¿æ¢12) å’Œ while2(æ›¿æ¢45) ä¹‹å
<code>i=2,e1=1,e2=2</code> æ»¡è¶³~if(i&gt;e1)&amp;&amp;if(i&lt;=e2)~ æ’å…¥æ“ä½œï¼Œå‚è€ƒèŠ‚ç‚¹:
<code>anchor=c2[e2+1]=4</code> æ‰€ä»¥æ‰§è¡Œ patchæ—¶å€™ä¼šåœ¨ 4(å› ä¸º anchor æœ‰å€¼) ä¹‹å‰æ’å…¥ 3 ã€‚</p>
</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-headline-24" class="outline-3">
<h3 id="headline-24">
insert begin&amp;end([2,3,4]-&gt;[1,2,3,4,5])
</h3>
<div id="outline-text-headline-24" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="c1">// &lt;div&gt;hello&lt;/div&gt;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">rc</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">renderChildren</span><span class="p">(</span><span class="nx">render</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [2,3,4] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>

    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [1,2,3,4,5] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
root: &lt;div id=1&gt;hello&lt;/div&gt;
&gt;&gt;&gt; render [4,5] DONE.
root: &lt;div id=1&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;/div&gt;
patchKeyedChildren...
while 1, sync from start...
while 2, sync from end...
&gt;&gt;&gt; render [1,2,3,4,5] DONE.
root: &lt;div id=1&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;/div&gt;
</pre>
<p>
<code>[2,3,4]</code> å’Œ <code>[1,2,3,4,5]</code> ç»è¿‡ while1 å’Œ while2 ä»€ä¹ˆéƒ½æ²¡åšï¼Œ <code>i=0,e1=2,e2=4</code> æ—¢
ä¸æ»¡è¶³ <code>if(i&gt;e1)</code> ä¹Ÿä¸æ»¡è¶³ <code>elseif(i&gt;e2)</code> æ‰€ä»¥ä¼šè¿›å…¥ <code>else</code> çš„æ— è§„åˆ™æ¯”è¾ƒé˜¶æ®µã€‚æ ¹
æ®ä¹‹å‰è„‘å›¾åˆ†æç»“æœå¯çŸ¥ï¼Œ <code>else</code> æ‰§è¡Œçš„æ­¥éª¤å¤§è‡´æ˜¯ï¼š</p>
<ol>
<li>
<p>éå† old children æ›¿æ¢ <code>[2,3,4]</code></p>
<p>
ç”¨ old <code>[2,3,4]</code> çš„æ¯ä¸ªå…ƒç´ çš„ key å» new <code>[1,2,3,4,5]</code> é‡Œé¢å»æ‰¾å¯¹åº”çš„
key(type,keyç›¸ç­‰çš„èŠ‚ç‚¹)å»æ›¿æ¢è€çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°†ä¼šæ‰¾åˆ° <code>[2,3,4]</code> ï¼Œæ­¤æ—¶ç»è¿‡ä¸€ä¸ª
for old children å¾ªç¯æ‰§è¡Œæ›¿æ¢ï¼Œè¿™é‡Œé‡ç‚¹åœ¨äº <code>newIndexToOldIndexMap</code> ç»“æœä¼šæ›´
æ–°ä¸º <code>[0,1,2,3,0]</code> è¿™é‡Œçš„ 123 åˆ†åˆ«å¯¹åº” <code>[2,3,4]</code> åœ¨ old children ä¸­çš„ç´¢å¼• + 1
çš„ç»“æœã€‚</p>
</li>
<li>
<p>éå† new children æ£€æµ‹ <code>newIndexToOldIndexMap</code></p>
<p>
è¿™ä¸€æ­¥çš„å¾ªç¯æ˜¯é’ˆå¯¹ new children è€Œè¨€ï¼Œä½œç”¨æ˜¯æ‰¾å‡º <code>newIndexToOldIndexMap</code> ä¸­ä¸
ä¸º <code>0</code> çš„å…ƒç´ (ä¹Ÿå°±æ˜¯è¿˜æœªè¢«ä½¿ç”¨çš„å…ƒç´ )ï¼Œæ¥æ‰§è¡Œæ’å…¥æ“ä½œã€‚å¾ªç¯é¡ºåºä»å³åˆ°å·¦æ‰§è¡Œï¼Œ
åˆ™æœ‰(i-é€’å‡ç´¢å¼•ï¼Œindex-newchild çš„ç´¢å¼•å€¼,el-newchild,val-ä½¿ç”¨çŠ¶æ€)ï¼š</p>
<p>
<code>i=4,index=4,el=c2[index],val=0,anchor=null</code>:</p>
<p>
æœªä½¿ç”¨ï¼Œæ²¡æœ‰å‚è€ƒèŠ‚ç‚¹ï¼Œå±äºçº¯ append æ“ä½œã€‚</p>
<p>
<code>i=3,2,1,val!==0</code> å·²ç»è¢«ä½¿ç”¨äº†ï¼Œè·³è¿‡</p>
<p>
<code>i=0,index=0,el=c2[index],val=0,anchor=c2[index+1]=1</code>:</p>
<p>
æœªä½¿ç”¨ï¼Œæ’å…¥èŠ‚ç‚¹ä¸º <code>[1]</code> å‚è€ƒèŠ‚ç‚¹ä¸º <code>[2]</code> å±äºæ’å…¥æ“ä½œï¼Œåœ¨ <code>[1]</code> ä¹‹å‰æ’å…¥ã€‚</p>
<p>
æœ€åå¾—åˆ°ç»“æœï¼š <code>children=[1,2,3,4,5]</code> å®Œæˆã€‚</p>
</li>
</ol>
<blockquote>
<p>å…¶å®è¿™é‡Œè¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ï¼Œå› ä¸ºè¿˜æ²¡ç”¨åˆ°â€œæœ‰åºé€’å¢åºåˆ—â€ç®—æ³•ï¼Œå› ä¸º for old
children ä¸­çš„ key æ˜¯æœ‰åºçš„ä¸”æ˜¯ new children çš„å­é›†ï¼Œæ‰€ä»¥éå†è¿‡ç¨‹ä¸­ newIndex ä¸º
0,1,2 åé¢çš„æ€»æ˜¯æ¯”å‰é¢çš„å¤§ï¼Œå› æ­¤ <code>maxNewIndexSoFar=2</code> ç›´åˆ°ç»“æŸğŸ”šã€‚</p>
<p>
ç±»ä¼¼ç”¨ä¾‹ï¼š</p>
<ol>
<li>
<p><code>[]</code> å’Œ <code>[1,2,3,4,5]</code> è¿™ç§æƒ…å†µç­‰äºæ˜¯ <code>newIndexToOldIndexMap=[0,0,0,0,0]</code> æ‰€æœ‰
new child å…ƒç´ æ‰§è¡Œçš„éƒ½æ˜¯å°¾éƒ¨ append æ“ä½œã€‚</p>
</li>
<li>
<p><code>[1,2,3,4,5]</code> å’Œ <code>render(h(&#39;div&#39;), root)</code> ç­‰äºæ˜¯ <code>children=[]</code> ç›´æ¥åˆ é™¤ old
children æ“ä½œ</p>
</li>
<li>
<p><code>[1,2,3,4,5]</code> å’Œ <code>[3,4,5]</code> ç»è¿‡ while2 æ›¿æ¢æ‰ <code>[3,4,5]</code> å‰©ä¸‹ old <code>[1,2]</code> å› åœ¨
new children ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„å…ƒç´ ï¼Œåˆ™ä¼šè¢«åˆ é™¤ã€‚</p>
</li>
<li>
<p><code>[1,2,3,4,5]</code> å’Œ <code>[1,2,3]</code> ç»è¿‡ while1 æ›¿æ¢æ‰ <code>[1,2,3]</code> å‰©ä¸‹çš„ old <code>[4,5]</code> å› 
æ‰¾ä¸åˆ°å¯¹åº”çš„ new child è¢«åˆ é™¤ã€‚</p>
</li>
<li>
<p><code>[1,2,3,4,5]</code> å’Œ <code>[1,2,4,5]</code> ç»è¿‡ while1 æ›¿æ¢æ‰ <code>[1,2]</code> ç»è¿‡ while2 æ›¿æ¢æ‰
<code>[4,5]</code> å‰©ä¸‹ <code>[3]</code> å› æ‰¾ä¸åˆ° new child è€Œè¢«åˆ é™¤ã€‚</p>
</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-headline-25" class="outline-3">
<h3 id="headline-25">
move([1,2,3,4]-&gt;[2,3,1,4])
</h3>
<div id="outline-text-headline-25" class="outline-text-3">
<p>
è¿™ç§æƒ…å†µä¼šè§¦å‘â€œæœ€é•¿é€’å¢åºåˆ—â€è§„åˆ™ï¼Œè¿›è¡Œæ›¿æ¢ï¼Œå› ä¸ºå‘ç”Ÿ diff-update çš„åŸåˆ™æ˜¯ï¼šæ›´æ–°
ä¹‹åçš„é¡ºåºè¦å’Œ new children é¡ºåºä¸€è‡´ï¼Œå³åŸæ¥æ˜¯ 1234 æ›´æ–°ä¹‹åè¦ä¿æŒ 2314 é¡ºåºã€‚</p>
<p>
æ›´æ–°è¿‡ç¨‹ï¼š</p>
<ol>
<li>
<p>ç»è¿‡ while1 ä»€ä¹ˆéƒ½ä¸å‘ç”Ÿï¼Œå› ä¸º <code>[1]-&gt;[2]</code> éåŒç±»èŠ‚ç‚¹</p>
</li>
<li>
<p>ç»è¿‡ while2 æ›¿æ¢æ‰ <code>[4],i=0,e1=2,e2=2</code></p>
</li>
<li>
<p><code>if(i&gt;e1)</code> ä¸æ»¡è¶³æ–°å¢æ¡ä»¶</p>
</li>
<li>
<p><code>elif(i&gt;e2)</code> ä¸æ»¡è¶³åˆ é™¤æ¡ä»¶</p>
</li>
<li>
<p>è¿›å…¥ else æ— è§„åˆ™æ¯”è¾ƒæ›´æ–°</p>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="c1">// &lt;div&gt;hello&lt;/div&gt;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">rc</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">renderChildren</span><span class="p">(</span><span class="nx">render</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [1,2,3,4] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>

    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [2,3,1,4] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
root: &lt;div id=1&gt;hello&lt;/div&gt;
&gt;&gt;&gt; render [1,2,3,4] DONE.
root: &lt;div id=1&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;/div&gt;
patchKeyedChildren...
while 1, sync from start...
while 2, sync from end...
while 2, sync from end...
{ arr: [ 2, 3, 1 ] }
{ result: [ 2, 1 ] }
æœ€é•¿å¢é•¿åºåˆ—: 0,1
move äº¤æ¢...
&gt;&gt;&gt; render [2,3,1,4] DONE.
root: &lt;div id=1&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;/div&gt;
</pre>
<p>
åœ¨ä¸Šé¢æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿›å…¥ else åˆ†æ”¯ï¼Œæ‰§è¡Œï¼š</p>
<ol>
<li>
<p>for old children</p>
<p>
æ‰§è¡Œå®Œä¹‹å(<code>i=0,e1=2,e2=2</code>)ï¼Œ <code>newIndexToOldIndexMap=[2,3,1]</code> åˆ†åˆ«å¯¹åº” <code>[1,2,3]</code> åœ¨
<code>[2,3,1]</code> ä¸­çš„ç´¢å¼•å€¼ + 1ï¼Œå› ä¸ºå­˜åœ¨ <code>newIndex &lt; maxNewIndexSoFar</code> æ‰€ä»¥
<code>moved=true</code> åœ¨éšåçš„æµç¨‹ä¸­ç”¨æ¥è§¦å‘â€œæœ€é•¿å¢é•¿åºåˆ—â€æ“ä½œã€‚</p>
</li>
<li>
<p>for new children</p>
<p>
åœ¨æ‰§è¡Œè¿™ä¸ªå¾ªç¯ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° <code>newIndexToOldIndexMap=[2,3,1]</code> å¹¶ä¸”ä»ä¸­æ‰¾
åˆ°æœ€é•¿å¢é•¿åºåˆ—(<code>[2,3]</code>)ï¼Œç„¶è€Œ <code>getSequence(arr)</code> è¿”å›çš„æ˜¯å®ƒä»¬çš„ç´¢å¼•å€¼ï¼Œæ‰€ä»¥æ˜¯
<code>[0,1]</code> æ‰€ä»¥æœ€å <code>increasingNewIndexSequence=[0,1]</code> ã€‚</p>
<p>
ç„¶ååœ¨ for toBePatched new children é‡Œé¢ï¼Œå› ä¸ºæ£€æµ‹åˆ° <code>moved=true</code> åˆ™ä¼šè¿›å…¥åˆ°
ç§»åŠ¨äº¤æ¢æ“ä½œï¼Œè¿™é‡Œæ‰§è¡Œ <code>move()</code> ä¹Ÿæœ‰ä¸ªæ¡ä»¶ï¼š <code>j&lt;0 || i !== increasingNewIndexSequence[j]</code> è¿™ä¸¤ä¸ªæ¡ä»¶
æœ‰åˆ†åˆ«ä»£è¡¨ä¸¤ç§æƒ…å†µ(å‡è®¾ï¼š <code>val=increasingNewIndexSequence[j]</code>)ï¼š</p>
<ul>
<li>
<p><code>j&lt;0</code> ä»£è¡¨ increasingNewIndexSequence å¢é•¿åºåˆ—æ²¡æœ‰å†…å®¹ï¼Œè¿™è¯´æ˜ä»€ä¹ˆï¼Ÿè¯´æ˜
<code>newIndexToOldIndexMap</code> æ˜¯ä¸ªå®Œå…¨é€’å‡æ•°ç»„ï¼Œå¦‚ï¼š <code>[3,2,1]</code> è¿™ç§æƒ…å†µæ¯ä¸ªå…ƒç´ éƒ½
éœ€è¦è¿›è¡Œç§»åŠ¨ï¼Œæœ€åå˜æˆ <code>[1,2,3]</code> ï¼Œ 1ç§»åˆ°3ä½ç½®ï¼Œ2ä¸å˜ï¼Œ3ç§»åŠ¨1çš„ä½ç½®ã€‚</p>
</li>
<li>
<p><code>i!==val</code></p>
<p>
æ¯”å¦‚è¿™é‡Œ(<code>newIndexToOldIndexMap=[2,3,1],old=[1,2,3,4],new=[2,3,1,4]</code>)</p>
<p>
<code>i=2,val=1,nextchild=[1],anchor=[4]</code> æ„å‘³ç€è¦åœ¨ <code>[4]</code> å‰é¢æ’å…¥ <code>[1]</code> è®°ä½è¿™
é‡Œæ‰§è¡Œçš„ä¾æ—§æ˜¯æ’å…¥æ“ä½œï¼Œåªæ˜¯åœ¨æ’å…¥ä¹‹å‰ä¼šå°†åŸæ¥çš„ <code>[1]</code> ä» container.children
ä¸­åˆ é™¤ï¼Œæ‰€ä»¥çœ‹ä¼¼æ˜¯äº¤æ¢å®é™…åªæ˜¯å˜ç›¸æ’å…¥è€Œå·²ã€‚</p>
<p>
<code>i=1,val=1,nextchild=[3],anchor=[1]</code> è¿™é‡Œ <code>i===val</code> æ‰€ä»¥æ‰§è¡Œ <code>j--</code></p>
<p>
<code>i=0,val=0,nextchild=[2],anchor=[3]</code> è¿™é‡Œ <code>i===val</code> æ‰€ä»¥æ‰§è¡Œ <code>j--</code></p>
<p>
åˆ°æ­¤ for å¾ªç¯å·²ç»é€€å‡ºäº†ï¼Œä¸Šé¢ä¸¤ä¸ª <code>j--</code> è¯´æ˜è§¦åŠçš„æ˜¯å¢é•¿åºåˆ—é‡Œé¢çš„å…ƒç´ å³ä¸
éœ€è¦ç§»åŠ¨çš„å…ƒç´ ï¼Œæ‰€ä»¥æœ€å children ç”± <code>[1,2,3,4]</code> å˜æˆ <code>[2,3,1,4]</code>, åªæ˜¯ 1 è¿›
è¡Œäº†ç§»åŠ¨ã€‚</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>åªéœ€è¦ç§»åŠ¨ä¸€æ¬¡å°±å¯å®Œæˆã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚æˆ‘æ˜¯åˆ†ç•Œç‚¹~~~~~~~~~</p>
</blockquote>
<p>
åŒæ¡ˆä¾‹åˆ†æï¼š</p>
<ol>
<li>
<p><code>[1, 2, 3, 4]</code> å’Œ <code>[1, 4, 2, 3]</code></p>
<p>
åœ¨ç»è¿‡ while1 ä¹‹åå¼€å§‹è¿›å…¥ else åˆ†æ”¯ï¼Œ <code>newIndexToOldIndexMap=[4,2,3]</code> æœ€åå¾—
åˆ°å¢é•¿åºåˆ—ï¼š <code>[2,3]~å¯¹åº”çš„ç´¢å¼• ~[1,2]</code> å³éœ€è¦æ‰§è¡Œæ’å…¥çš„é€»è¾‘æ˜¯ï¼š</p>
<p>
<code>i=2,j=1,val=2,next=[3],anchor=null</code> ï¼š i===val, jâ€“</p>
<p>
<code>i=1,j=0,val=1,next=[2],anchor=[3]</code> : i===val, jâ€“</p>
<p>
<code>i=0,j=-1,val=undefined,next=[4],anchor=[2]</code> : 4 è¦æ’å…¥åˆ° 2 å‰é¢ï¼Œ
<code>children=[1,4,2,3]</code></p>
<p>
<code>i=-1</code> ç»“æŸã€‚</p>
<p>
æ‰€ä»¥åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ç§»åŠ¨å°±å¯ä»¥äº†ï¼Œåœ¨é€’å¢åºåˆ—å†…çš„å…ƒç´ æ˜¯ä¸éœ€è¦åŠ¨çš„ã€‚</p>
</li>
<li>
<p><code>[1,2,3]</code> å’Œ <code>[2,3,1]</code></p>
<p>
ç”±äºå‰åéƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ while1,while2 éƒ½æ²¡å¤„ç†ï¼Œå¹¶ä¸”è¿›å…¥ else ä¹±åºæƒ…å†µå¤„ç†ã€‚</p>
<p>
<code>newIndexToOldIndexMap=[2,4,1]</code> å¢é•¿åºåˆ—= <code>[2,4]</code> ï¼Œç´¢å¼•ï¼š <code>[0,1]</code></p>
<p>
<code>i=2,j=1,val=1,next=[1],anchor=null</code> ï¼š <code>1</code> append åˆ°æœ€åï¼Œå˜æˆ <code>children=[2,3,1]</code></p>
<p>
<code>i=1,j=1,val=1,next=[3],anchor=[1]</code> : i===val, jâ€“</p>
<p>
<code>i=0,j=0,val=0,next=[2],anchor=[3]</code> : i ===val, jâ€“</p>
<p>
<code>i=-1</code> ç»“æŸ.</p>
<p>
åªéœ€è¦å°† <code>[1]</code> ç§»åˆ°æœ€åå°±å®Œæˆäº†äº¤æ¢ã€‚</p>
</li>
<li>
<p><code>[1,2,3,4]</code> å’Œ <code>[4,2,3,1]</code></p>
<p>
<code>newIndexToOldIndexMap=[4,2,3,1]</code> å¢é•¿åºåˆ—ï¼š <code>[2,3]</code> ï¼Œç´¢å¼•ï¼š <code>[1,2]</code></p>
<p>
<code>i=3,j=1,val=2,next=[1],anchor=null</code> : <code>[1]</code> append åˆ°æœ€åï¼Œ <code>children=[2,3,4,1]</code></p>
<p>
<code>i=2,j=1,val=2,next=[3],anchor=[1]</code> : i===val, jâ€“</p>
<p>
<code>i=1,j=0,val=1,next=[2],anchor=[3]</code> : i===val, jâ€“</p>
<p>
<code>i=0,j=-1,val=undefined,next=[4],anchor=[2]</code>: j&lt;0, æ‰§è¡Œç§»åŠ¨ï¼Œ
<code>children=[4,2,3,1]</code>, å°† 4 ç§»åŠ¨åˆ° 2 å‰é¢ã€‚</p>
<p>
<code>i=-1</code> ç»“æŸã€‚</p>
<p>
è¿™é‡Œåªéœ€è¦æ‰§è¡Œä¸¤æ¬¡ç§»åŠ¨æ“ä½œï¼Œ 1&lt;-&gt;4 äº¤æ¢ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-26" class="outline-3">
<h3 id="headline-26">
move&amp;replace([1,2,3,4,5]-&gt;[4,1,2,3,6])
</h3>
<div id="outline-text-headline-26" class="outline-text-3">
<p>
è¿™é‡Œéœ€è¦å®Œæˆçš„åŠ¨ä½œæœ‰ï¼š <em>ç”¨ 6 æ›¿æ¢ 5ï¼Œå°† 4ç§»åˆ° 1 å‰é¢</em> ã€‚</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
  <span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">elm</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="c1">// &lt;div&gt;hello&lt;/div&gt;
</span><span class="c1"></span>    <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">rc</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">renderChildren</span><span class="p">(</span><span class="nx">render</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

    <span class="nx">logRoot</span><span class="p">();</span>
    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [1,2,3,4,5] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>

    <span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">]);</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [4,1,2,3,6] DONE.&#34;</span><span class="p">);</span>
    <span class="nx">logRoot</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
root: &lt;div id=1&gt;hello&lt;/div&gt;
&gt;&gt;&gt; render [1,2,3,4,5] DONE.
root: &lt;div id=1&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;/div&gt;
patchKeyedChildren...
while 1, sync from start...
while 2, sync from end...
{ arr: [ 4, 1, 2, 3, 0 ] }
{ result: [ 1, 2, 3 ] }
{ toBePatched: 5 }
æœ€é•¿å¢é•¿åºåˆ—: 1,2,3
{ val: 3, i: 3, j: 2, toBePatched: 5 }
{ val: 2, i: 2, j: 1, toBePatched: 5 }
{ val: 1, i: 1, j: 0, toBePatched: 5 }
{ val: undefined, i: 0, j: -1, toBePatched: 5 }
moving...
move äº¤æ¢...
&gt;&gt;&gt; render [4,1,2,3,6] DONE.
root: &lt;div id=1&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;6&lt;/span&gt;&lt;/div&gt;
</pre>
<p>
<strong>åˆ†æ</strong> ï¼š</p>
<p>
ç»è¿‡ while1, while2 å®é™…ä»€ä¹ˆéƒ½æ²¡åšï¼Œå› ä¸ºå‰åå¹¶æ²¡æœ‰å…±é€šèŠ‚ç‚¹ï¼Œä¹Ÿå› æ­¤ä¼šè¿›å…¥ else è¿›
è¡Œæ— åºåºåˆ—å¤„ç†ã€‚</p>
<p>
<code>old=[1,2,3,4,5]</code></p>
<p>
<code>new=[4,1,2,3,6]</code></p>
<p>
<code>newIndexToOldIndexMap=[0,0,0,0,0]</code> ç»è¿‡ for old ä¹‹å</p>
<p>
<code>newIndexToOldIndexMap=[4,1,2,3,0]</code> æœ€å 5 ç”±äºæ²¡æ‰¾åˆ°å¯¹åº” key çš„ new nodeæˆ–è€…æ— 
key çš„ new nodeè€Œ è¢«æ‰§è¡Œåˆ é™¤(<code>unmount()</code>)æ“ä½œã€‚</p>
<p>
æ‰¾æœ€é•¿å¢é•¿åºåˆ—ï¼š <code>[1,2,3]</code> å¾—åˆ° <code>newIndexToOldIndexMap</code> ä¸­å¯¹åº”çš„ç´¢å¼• <code>increasingNewIndexSequence=[1,2,3],j=2</code></p>
<p>
å¼€å§‹ä»å³åˆ°å·¦éå† new children(<code>val=increasingNewIndexSequence[j]</code>)ï¼š</p>
<p>
<code>i=4,map=0,newchild=6</code>: ç”±äº index map ä¸­çš„å€¼ä¸º 0ï¼Œè¯´æ˜å¹¶æ²¡æœ‰å¯¹åº”çš„ old child å±
äºéœ€è¦æ–°å¢çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œ mount new èŠ‚ç‚¹æ“ä½œ <code>children=[1,2,3,4,6]</code> (<strong>æ³¨æ„</strong> ï¼š 5 åœ¨
ä¸Šé¢å·²ç»è¢« unmount æ‰äº†)</p>
<p>
<code>i=3,j=2,val=3,next=3,anchor=6</code> : i===val, jâ€“</p>
<p>
<code>i=2,j=1,val=2,next=2,anchor=3</code> : i===val, jâ€“</p>
<p>
<code>i=1,j=0,val=1,next=1,anchor=2</code> : i===val, jâ€“</p>
<p>
<code>i=0,j=-1,val=undefined,next=4,anchor=1</code> : j&lt;0, æ‰§è¡Œ <code>move()</code> ï¼Œå°† <strong>4</strong> ç§»åŠ¨åˆ°
<strong>1</strong> å‰é¢ï¼Œå˜æˆï¼š <code>children=[4,1,2,3,6]</code></p>
<p>
<code>i=-1</code> ç»“æŸã€‚</p>
<blockquote>
<p>è¿™é‡Œå®é™…ä¸Šæœ‰ä¸‰ä¸ªåŠ¨ä½œï¼š</p>
<ol>
<li>
<p><strong>5</strong> åœ¨ new children ä¸­æ²¡æ‰¾åˆ° keyed childï¼Œä¹Ÿæ²¡æœ‰ non-keyed child æ‰€ä»¥è¢«
unmount åˆ é™¤äº†;</p>
</li>
<li>
<p><strong>6</strong> åœ¨ <code>newIndexToOldIndexMap</code> ä¸­å¯¹åº”çš„å€¼ä¸º 0ï¼Œè¯´æ˜å¹¶æ²¡æœ‰ old child ä¸ä¹‹å¯¹åº”ï¼Œ
å±äºæ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œ mount new æ“ä½œ;</p>
</li>
<li>
<p><strong>4</strong> èŠ‚ç‚¹æ»¡è¶³ move æ¡ä»¶ï¼Œå°†å…¶ç§»åŠ¨åˆ° <strong>1</strong> å‰é¢ã€‚</p>
</li>
</ol>
</blockquote>
<p>
<strong>åŒæ¡ˆä¾‹åˆ†æ</strong> ï¼š</p>
<ol>
<li>
<p><code>[1,4,5]</code> å’Œ <code>[4,6]</code></p>
<p>
for old æ—¶ 1 å’Œ 5 è¢« unmount æ‰</p>
<p>
<code>newIndexToOldIndexMap=[2,0]</code> å› ä¸ºä¸å­˜åœ¨ <code>newIndex &gt; maxNewIndexSoFar</code> å¯¼è‡´
<code>moved=false</code> éšä¹‹ <code>increasingNewIndexSequence=[]</code></p>
<p>
for new æ—¶ï¼Œç”±äºå¢é•¿åºåˆ—ä¸ºç©ºï¼Œæ‰€ä»¥åªä¼šè¿›å…¥ <code>newIndexToOldIndexMap</code> æ£€æµ‹æ˜¯å¦ä¸º
0 çš„ if åˆ†æ”¯æ‰§è¡Œ mount new æ“ä½œï¼Œå³æ–°å¢ 6 è¿™ä¸ªèŠ‚ç‚¹ï¼š</p>
<p>
<code>i=1,newIndexToOldIndexMap[i]===0</code> è¿›å…¥ if mount new 6 node.</p>
</li>
<li>
<p><code>[2,4,5]</code> å’Œ <code>[4,5,3]</code> åˆ é™¤ 2ï¼Œæ–°å¢ 3</p>
</li>
<li>
<p><code>[1,2,3,4,5,6,7,8]</code> å’Œ <code>[8,7,6,5,4,3,2,1]</code></p>
<p>
è¿™åº”è¯¥æ˜¯æœ€ç³Ÿç³•çš„æƒ…å†µäº†</p>
<p>
<code>newIndexToOldIndexMap=[8,7,6,5,4,3,2,1],moved=true</code></p>
<p>
å¢é•¿åºåˆ—ä¸º <code>[7]</code> ï¼Œæ‰€ä»¥ <code>increasingNewIndexSequence=[1],j=0</code></p>
<p>
<code>i=7,j=0,val=7,next=1,anchor=undefined</code>, i===val, jâ€“, å³èŠ‚ç‚¹ <code>[1]</code> ä¸éœ€è¦åŠ¨</p>
<p>
<code>i=6,j=-1,next=2,anchor=1</code> -&gt;2ç§»åˆ°1å‰é¢-&gt; <code>children=[3,4,5,6,7,8,2,1]</code></p>
<p>
<code>i=5,j=-1,next=3,anchor=2</code> -&gt;3ç§»åˆ°2å‰é¢-&gt; <code>children=[4,5,6,7,8,3,2,1]</code></p>
<p>
<code>i=4,j=-1,next=4,anchor=3</code> -&gt;4ç§»åˆ°3å‰é¢-&gt; <code>children=[5,6,7,8,4,3,2,1]</code></p>
<p>
<code>i=3,j=-1,next=5,anchor=4</code> -&gt;5ç§»åˆ°4å‰é¢-&gt; <code>children=[6,7,8,5,4,3,2,1]</code></p>
<p>
<code>i=2,j=-1,next=6,anchor=5</code> -&gt;6ç§»åˆ°5å‰é¢-&gt; <code>children=[7,8,6,5,4,3,2,1]</code></p>
<p>
<code>i=1,j=-1,next=7,anchor=6</code> -&gt;7ç§»åˆ°6å‰é¢-&gt; <code>children=[8,7,6,5,4,3,2,1]</code></p>
<p>
<code>i=0,j=-1,next=8,anchor=7</code> è¿™é‡Œä¹Ÿä¼šæ‰§è¡Œä¸€æ¬¡æ’å…¥å—(å¦‚ä¸‹é¢æµ‹è¯•ç»“æœ)ï¼Ÿ</p>
<p>
<code>i=-1</code> ç»“æŸï¼Œå…±æ‰§è¡Œäº†ä¸ƒæ¬¡ç§»åŠ¨ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">shuffle</span><span class="p">,</span> <span class="nx">runtime_test</span><span class="p">,</span> <span class="nx">renderChildren</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
<span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/lib.js&#34;</span><span class="p">);</span>
<span class="kr">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_DIR_VUE</span> <span class="o">+</span> <span class="s2">&#34;/runtime-test.global.js&#34;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
<span class="p">({</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">inner</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="kd">let</span> <span class="nx">elm</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="c1">// &lt;div&gt;hello&lt;/div&gt;
</span><span class="c1"></span><span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="s2">&#34;hello&#34;</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">rc</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">renderChildren</span><span class="p">(</span><span class="nx">render</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">logRoot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root: &#34;</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

<span class="nx">logRoot</span><span class="p">();</span>
<span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [1,2,3,4,5,6,7,8] DONE.&#34;</span><span class="p">);</span>
<span class="nx">logRoot</span><span class="p">();</span>

<span class="nx">elm</span> <span class="o">=</span> <span class="nx">rc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">].</span><span class="nx">reverse</span><span class="p">());</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; render [8,7,6,5,4,3,2,1] DONE.&#34;</span><span class="p">);</span>
<span class="nx">logRoot</span><span class="p">();</span>
<span class="p">},</span>
<span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefinedfalse
root: &lt;div id=1&gt;hello&lt;/div&gt;
&gt;&gt;&gt; render [1,2,3,4,5,6,7,8] DONE.
root: &lt;div id=1&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;span&gt;6&lt;/span&gt;&lt;span&gt;7&lt;/span&gt;&lt;span&gt;8&lt;/span&gt;&lt;/div&gt;
patchKeyedChildren...
while 1, sync from start...
while 2, sync from end...
{ arr: [
    8, 7, 6, 5,
    4, 3, 2, 1
] }
{ result: [ 7 ] }
{ toBePatched: 8 }
æœ€é•¿å¢é•¿åºåˆ—: 7
{ val: 7, i: 7, j: 0, next: &#39;1&#39;, anchor: null, toBePatched: 8 }
{ val: undefined, i: 6, j: -1, next: &#39;2&#39;, anchor: &#39;1&#39;, toBePatched: 8 }
move äº¤æ¢...
{ val: undefined, i: 5, j: -1, next: &#39;3&#39;, anchor: &#39;2&#39;, toBePatched: 8 }
move äº¤æ¢...
{ val: undefined, i: 4, j: -1, next: &#39;4&#39;, anchor: &#39;3&#39;, toBePatched: 8 }
move äº¤æ¢...
{ val: undefined, i: 3, j: -1, next: &#39;5&#39;, anchor: &#39;4&#39;, toBePatched: 8 }
move äº¤æ¢...
{ val: undefined, i: 2, j: -1, next: &#39;6&#39;, anchor: &#39;5&#39;, toBePatched: 8 }
move äº¤æ¢...
{ val: undefined, i: 1, j: -1, next: &#39;7&#39;, anchor: &#39;6&#39;, toBePatched: 8 }
move äº¤æ¢...
{ val: undefined, i: 0, j: -1, next: &#39;8&#39;, anchor: &#39;7&#39;, toBePatched: 8 }
move äº¤æ¢...
&gt;&gt;&gt; render [8,7,6,5,4,3,2,1] DONE.
root: &lt;div id=1&gt;&lt;span&gt;8&lt;/span&gt;&lt;span&gt;7&lt;/span&gt;&lt;span&gt;6&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;span&gt;4&lt;/span&gt;&lt;span&gt;3&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;/div&gt;
</pre>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-patch-unkeyed-children" class="outline-2">
<h2 id="patch-unkeyed-children">
patchUnkeyedChildren
</h2>
<div id="outline-text-patch-unkeyed-children" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2d067109dc386b27fa4a6ef9c783262caf6d0f7a">feat(add): unkeyd children patch Â· gcclll/stb-vue-next@2d06710</a></p>
<p>
å¯¹äºæ˜ç¡® unkeyed çš„ children å¤„ç†å’Œ keyed å¤„ç†åŒºåˆ«åœ¨äºï¼Œä¼šå°†å‰é¢çš„ children å…ˆè¿›
è¡Œ patch, å› ä¸ºåœ¨ <a href="#keyed-children">patchKeyedChildren</a> ä¸€èŠ‚å·²ç»è¯¦ç»†åˆ†æè¿‡ï¼Œå¦‚æœæ²¡æœ‰ old child æ˜¯
unkeyed ä¼šä» new children ä¸­ä¾åºæ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ unkeyed child å»æ›¿æ¢ã€‚</p>
<p>
æ‰€ä»¥è¿™é‡Œåˆ†ä¸‰æ­¥èµ°ï¼š</p>
<ol>
<li>
<p>æ‰¾åˆ°æœ€å°é•¿åº¦ï¼Œé’ˆå¯¹æ­¤é•¿åº¦å†…çš„ child è¿›è¡Œ patchï¼Œå› ä¸ºå¯¹äº unkeyed old child åª
éœ€è¦æ‰¾åˆ°å¯¹åº”çš„ unkeyed new child æ›¿æ¢å°±è¡Œ</p>
</li>
<li>
<p>æ–°å¢çš„æƒ…å†µ new child len &gt; old child len</p>
</li>
<li>
<p>å‡å°‘çš„æƒ…å†µ new child len &lt; old child len</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">patchUnkeyedChildren</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">c1</span>: <span class="kt">VNode</span><span class="p">[],</span>
  <span class="nx">c2</span>: <span class="kt">VNodeArrayChildren</span><span class="p">,</span>
  <span class="nx">container</span>: <span class="kt">RendererElement</span><span class="p">,</span>
  <span class="nx">anchor</span>: <span class="kt">RendererNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">parentSuspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">isSVG</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">optimized</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">c1</span> <span class="o">=</span> <span class="nx">c1</span> <span class="o">||</span> <span class="nx">EMPTY_ARR</span><span class="p">;</span>
  <span class="nx">c2</span> <span class="o">=</span> <span class="nx">c2</span> <span class="o">||</span> <span class="nx">EMPTY_ARR</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">oldLength</span> <span class="o">=</span> <span class="nx">c1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">newLength</span> <span class="o">=</span> <span class="nx">c2</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">commonLength</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">oldLength</span><span class="p">,</span> <span class="nx">newLength</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">commonLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">nextChild</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">optimized</span>
      <span class="o">?</span> <span class="nx">cloneIfMounted</span><span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">c2</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
    <span class="nx">patch</span><span class="p">(</span>
      <span class="nx">c1</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
      <span class="nx">nextChild</span><span class="p">,</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="kc">null</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">parentSuspense</span><span class="p">,</span>
      <span class="nx">isSVG</span><span class="p">,</span>
      <span class="nx">optimized</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">oldLength</span> <span class="o">&gt;</span> <span class="nx">newLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// remove old
</span><span class="c1"></span>    <span class="nx">unmountChildren</span><span class="p">(</span>
      <span class="nx">c1</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">parentSuspense</span><span class="p">,</span>
      <span class="kc">true</span><span class="p">,</span>
      <span class="kc">false</span><span class="p">,</span>
      <span class="nx">commonLength</span>
    <span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// mount new
</span><span class="c1"></span>    <span class="nx">mountChildren</span><span class="p">(</span>
      <span class="nx">c2</span><span class="p">,</span>
      <span class="nx">container</span><span class="p">,</span>
      <span class="nx">anchor</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">parentSuspense</span><span class="p">,</span>
      <span class="nx">isSVG</span><span class="p">,</span>
      <span class="nx">optimized</span><span class="p">,</span>
      <span class="nx">commonLength</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-render-component" class="outline-2">
<h2 id="render-component">
patch-&gt;processComponent(å¦‚ä½•patchç»„ä»¶çš„ï¼Ÿ)
</h2>
</div>
<div id="outline-container-test" class="outline-2">
<h2 id="test">
æµ‹è¯•
</h2>
<div id="outline-text-test" class="outline-text-2">
<div id="visual"></div>
<hr/>
<div id="annotated"></div>
<div id="tShhLU1P6z"></div>
<script src="/js/vue/tests/tShhLU1P6z.js"></script>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2021-01-26
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/runtime-core/">runtime-core,</a>
          <a href="/tags/render/">render</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-vite/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 -&gt; Vite è„šæ‰‹æ¶</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-runtime-core-1/">
            <span class="next-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1)</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
