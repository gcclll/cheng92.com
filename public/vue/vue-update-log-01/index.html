<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 更新日志 01(3.0.5 ~ 3.2.0-beta.1) - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md 前言 TIP 本系列文说明：会不定期的更新本地" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-update-log-01/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.9d6c07951e716411e0fdd9d1d7616cb41ced57b53993154c49ea809e194527af.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 更新日志 01(3.0.5 ~ 3.2.0-beta.1)" />
<meta property="og:description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md 前言 TIP 本系列文说明：会不定期的更新本地" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-update-log-01/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2021-06-28T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-06-28T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 更新日志 01(3.0.5 ~ 3.2.0-beta.1)">
<meta itemprop="description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md 前言 TIP 本系列文说明：会不定期的更新本地"><meta itemprop="datePublished" content="2021-06-28T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-06-28T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="4938">
<meta itemprop="keywords" content="vue,,vue3," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 更新日志 01(3.0.5 ~ 3.2.0-beta.1)"/>
<meta name="twitter:description" content="诗号：六道同坠，魔劫万千，引渡如来。 -- insertCssLink(&#34;https://unpkg.com/element-plus/lib/theme-chalk/index.css&#34;); https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md 前言 TIP 本系列文说明：会不定期的更新本地"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 更新日志 01(3.0.5 ~ 3.2.0-beta.1)</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-06-28 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> 约 4938 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">前言</a>
</li>
<li><a href="#headline-2">3.0.8 (2021-03-26)</a>
<ul>
<li><a href="#headline-3">Important</a>
</li>
<li><a href="#headline-4">Bug Fixes <code class="statistic">[0/44]</code></a>
</li>
<li><a href="#headline-5">Performance Improvements <code class="statistic">[1/1]</code></a>
</li>
</ul>
</li>
<li><a href="#headline-6">3.0.7 (2021-08-08)</a>
<ul>
<li><a href="#headline-7">Important</a>
</li>
<li><a href="#headline-8">Bug Fixes <code class="statistic">[6/6]</code></a>
</li>
<li><a href="#headline-9">Performance Improvements <code class="statistic">[1/1]</code></a>
</li>
</ul>
</li>
<li><a href="#headline-10">3.0.6 (2021-02-24)</a>
<ul>
<li><a href="#headline-11">Important</a>
</li>
<li><a href="#headline-12">Bug Fixes <code class="statistic">[25/25]</code></a>
</li>
<li><a href="#headline-13">Features <code class="statistic">[5/5]</code></a>
</li>
<li><a href="#headline-14">Performance Improvements <code class="statistic">[1/1]</code></a>
</li>
</ul>
</li>
<li><a href="#headline-15">3.0.5 (2020-12-30)</a>
<ul>
<li><a href="#headline-16"><strong>Bug Fixes</strong> <code class="statistic">[9/9]</code></a>
</li>
<li><a href="#headline-17">Features <code class="statistic">[1/1]</code></a>
</li>
</ul>
</li>
<li><a href="#headline-18">tests</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<link href="/js/vue/formatters-styles/style.css" rel="stylesheet">
<link href="/js/vue/formatters-styles/annotated.css" rel="stylesheet">
<link href="/js/vue/formatters-styles/html.css" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<script src="/js/utils.js"></script>
<script src="/js/vue/vue-next.js"></script>
<!--<script src="https://unpkg.com/vue@next"></script>-->
<script>
insertCssLink("https://unpkg.com/element-plus/lib/theme-chalk/index.css");
</script>
<script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
<script type='text/javascript' src="https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/jsondiffpatch.umd.min.js"></script>
<script src="/js/vue/tests/common.js"></script>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
前言
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<div class="tip-block">
<p><p><strong>TIP</strong></p></p>
<p>
本系列文说明：会不定期的更新本地的 vue-next 仓库，本系列文章则是针对 git pull 后
的更新内容的分析和记录， 。</p>
<p>
<strong><font color="red">可参过链接跳转到对应的分析文章</font></strong></p>
</div>
<p>
更新内容：</p>
<p>
很久没更新了，惨~~~~~~~~~</p>
<p>
捡点重要的来看下吧，以后还是要保持每周拉一次代码比较好！！！</p>
<p>
最初分析拉取的代码是： <strong>3.0.4</strong>, 现在都 <strong>3.1.2</strong> 了 尴尬！！!</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
3.0.8 (2021-03-26)
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
Important
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<ol>
<li>
<p><strong>IMP</strong>: SFC style 中的 <code>::v-slotted</code> 和 <code>:slotted</code> <a href="#slotted">🔗 </a></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
<span class="todo">TODO</span>
Bug Fixes <code class="statistic">[0/44]</code>
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<ul>
<li class="indeterminate">
<p>compiler: properly bail stringfication for nested slot elements (f74b16c)</p>
</li>
<li class="indeterminate">
<p>compiler-core: allow unicode to appear in identifiers (#3443) (ebedccc), closes #3440</p>
</li>
<li class="indeterminate">
<p>compiler-core: avoid generating useless createVNode helper (#2938) (7715c49), closes #2739</p>
</li>
<li class="indeterminate">
<p>compiler-core: detect v-if branch root with comment as dev fragment (#2785) (4bf7ba1), closes #2780</p>
</li>
<li class="indeterminate">
<p>compiler-core: fix the detection of forwarded slots with v-if or v-for (#3353) (602b58e), closes #3347</p>
</li>
<li class="indeterminate">
<p>compiler-core: should not condense whitespace in RCDATA text mode (#3482) (b4b8215), closes #3479</p>
</li>
<li class="indeterminate">
<p>compiler-dom: stringifyStatic should remove attribute bindings with null value (#3477) (ca6aa01), closes #3475</p>
</li>
<li class="indeterminate">
<p>compiler-sfc: scope Id should not be attached to @keyframe breakpoint rules (#3308) (6cb9475), closes #3304</p>
</li>
<li class="indeterminate">
<p>compiler-sfc: should not rewrite scope variable (#3449) (bbc5fe6), closes #3445</p>
</li>
<li class="indeterminate">
<p>compiler-ssr: keep the order of imports expression for the fallback branch of SSR (#3448) (49f4072), closes #3447</p>
</li>
<li class="indeterminate">
<p>component: prioritize registered component over implicit self-reference via filename (abd129d), closes #2827</p>
</li>
<li class="indeterminate">
<p>hydration: handle camel-case tag name when performing match assertion (#3247) (9036f88), closes #3243</p>
</li>
<li class="indeterminate">
<p>KeepAlive: adapt keepalive for ssr (#3259) (e8e9b00), closes #3255</p>
</li>
<li class="indeterminate">
<p>reactivity: ensure computed can be wrapped by readonly (41e02f0), closes #3376</p>
</li>
<li class="indeterminate">
<p>reactivity: ensure that shallow and normal proxies are tracked seperately (close #2843) (#2851) (22cc4a7)</p>
</li>
<li class="indeterminate">
<p>reactivity: fix shallow readonly behavior for collections (#3003) (68de9f4), closes #3007</p>
</li>
<li class="indeterminate">
<p>rumtime-core: custom dom props should be cloned when cloning a hoisted DOM (#3080) (5dbe834), closes #3072</p>
</li>
<li class="indeterminate">
<p>runtime-core: cache props default values to avoid unnecessary watcher trigger (#3474) (44166b4), closes #3471</p>
</li>
<li class="indeterminate">
<p>runtime-core: ensure only skip unflushed job (#3406) (bf34e33)</p>
</li>
<li class="indeterminate">
<p>runtime-core: fix async component ref handling (#3191) (7562e72), closes #3188</p>
</li>
<li class="indeterminate">
<p>runtime-core: fix erraneous emits warnings w/ mixins (60d777d), closes #2651</p>
</li>
<li class="indeterminate">
<p>runtime-core: fix warning for absent props (#3363) (86ceef4), closes #3362</p>
</li>
<li class="indeterminate">
<p>runtime-core: handle error in async setup (#2881) (d668d48)</p>
</li>
<li class="indeterminate">
<p>runtime-core: handle error in async watchEffect (#3129) (eb1fae6)</p>
</li>
<li class="indeterminate">
<p>runtime-core: should call chained mixins and extends (#3040) (b58bb16), closes #3038</p>
</li>
<li class="indeterminate">
<p>runtime-core: should not cache property access during data() invocation (#3299) (6e88156), closes #3297</p>
</li>
<li class="indeterminate">
<p>runtime-core: should not track deps in pre flush watcher callbacks (d5824b9), closes #2728</p>
</li>
<li class="indeterminate">
<p>runtime-core: the select tag&#39;s multiple prop should be set before the children mounting (#3202) (2451dd8), closes #3199</p>
</li>
<li class="indeterminate">
<p>runtime-dom: support mounting app to svg container (#2929) (8ffcde2), closes #2926</p>
</li>
<li class="indeterminate">
<p>ssr: ensure async setup error handling work with suspense during ssr (2e71f07)</p>
</li>
<li class="indeterminate">
<p>ssr: fix memory leak when vnode component render throws error (da944cb), closes #3100</p>
</li>
<li class="indeterminate">
<p>ssr: properly update currentRenderingInstance state during ssr (8c3c14a), closes #2863</p>
</li>
<li class="indeterminate">
<p>ssr: respect render function from extends/mixins in ssr (#3006) (0a583d5), closes #3004</p>
</li>
<li class="indeterminate">
<p>ssr: watchEffect onInvalidate runner initialization (#3323) (e4b5fcc), closes #3322</p>
</li>
<li class="indeterminate">
<p>ssr/hydration: handle ending empty text node (#3246) (420c8f4), closes #3245</p>
</li>
<li class="indeterminate">
<p>teleport: targetAnchor should also be removed when unmounted (#2870) (21d1288)</p>
</li>
<li class="indeterminate">
<p>Teleport: component with multi roots should be removed when unmounted (#3157) (7769513), closes #3156</p>
</li>
<li class="indeterminate">
<p>Teleport: fallback to non-optimized mode when HRM performing updates (#3311) (9cb21d0), closes #3302</p>
</li>
<li class="indeterminate">
<p>transition: toggling branches with in-out mode should be transitioned correctly (#3109) (67a0290), closes #3104</p>
</li>
<li class="indeterminate">
<p>types: allow style to be an array in JSX (#2947) (13c9d2c)</p>
</li>
<li class="indeterminate">
<p>types: union function prop (#3119) (3755e60), closes #3357</p>
</li>
<li class="indeterminate">
<p>types: unwrap refs on public instance data (#3319) (2b588cf), closes #3315</p>
</li>
<li class="indeterminate">
<p>types/jsx: llow tabindex to be a string (#3476) (e4a5712)</p>
</li>
<li class="indeterminate">
<p>add display name for suspense component (#3312) (3b3a9a1)</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
<span class="todo">DONE</span>
Performance Improvements <code class="statistic">[1/1]</code>
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>CLOSED: [2021-08-09 Mon 21:23]</p>
<ul>
<li class="checked">
<p>support only attaching slot scope ids when necessary (<a href="https://github.com/vuejs/vue-next/commit/02cbbb718ca226b087c42e6f132120931307c2a6">02cbbb7</a>)
<span id="slotted"></span></p>
<p>
SFC style 中使用</p>
<p>
<code>:slotted(h1) { color: blue; }</code></p>
<p>
或</p>
<p>
<code>::v-slotted(h1) { color: blue; }</code></p>
<p>
可以在当前组件中控制 slot 组件的样式。</p>
<p>
https://codesandbox.io/s/damp-cdn-k9eed?file=/src/main.js</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span> <span class="s2">&#34;/../compiler-sfc/dist/compiler-sfc.cjs.js&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&#34;stb-&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">));</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span><span class="p">,</span> <span class="nx">compileStyle</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">compileScoped</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compileStyle</span><span class="p">({</span>
  <span class="nx">source</span><span class="p">,</span>
  <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;test.css&#39;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;data-v-test&#39;</span><span class="p">,</span>
  <span class="nx">scoped</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">...</span><span class="nx">options</span>
<span class="p">})</span>
<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">code</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">src</span> <span class="o">=</span> <span class="sb">`::v-slotted(h1) { color: red; } :slotted(h1) {font-size:12px;}`</span>
<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">compileScoped</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
h1[data-v-test-s] { color: red;
}
h1[data-v-test-s] {font-size:12px;}
0
</pre>
<p>
下面会检查 style 中是不是含 <code>::v-slotted(...) {...}</code> 或 <code>:slotted(...) {..}</code> 指令</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// packages/compiler-sfc/src/parse.ts
</span><span class="c1">// check if the SFC uses :slotted
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">slottedRE</span> <span class="o">=</span> <span class="sr">/(?:::v-|:)slotted\(/</span>
<span class="nx">descriptor</span><span class="p">.</span><span class="nx">slotted</span> <span class="o">=</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">styles</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">slottedRE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">content</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
根据上面的结果，在 parse SFC template 阶段给组件加上 <code>scope-id-s</code> 属性， 如：</p>
<p>
<code>&lt;div scope-id-s /&gt;</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// packages/compiler-ssr/src/transforms/ssrTransformSlotOutlet.ts
</span><span class="c1">// inject slot scope id if current template uses :slotted
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">scopeId</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">slotted</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`&#34;</span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">scopeId</span><span class="si">}</span><span class="sb">-s&#34;`</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
3.0.7 (2021-08-08)
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<div id="outline-container-headline-7" class="outline-3">
<h3 id="headline-7">
Important
</h3>
<div id="outline-text-headline-7" class="outline-text-3">
<ol>
<li>
<p><strong>FIX</strong>: <code>&lt;script setup&gt;</code> 中 export default 和 class 语法 <a href="#default-rewrite">🔗</a></p>
</li>
<li>
<p><strong>FIX</strong>: <code>v-show</code> 的优先级比 <code>{style: { display: &#39;block&#39; }}</code> 更高 <a href="#v-show-priority">🔗</a></p>
</li>
<li>
<p><strong>FIX</strong>: scheduler 中 组件更新任务总是保持以 job.id 的增序执行，在插入的时候找到
对应的索引插入 <a href="#job-id-as">🔗 </a></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
<span class="todo">DONE</span>
Bug Fixes <code class="statistic">[6/6]</code>
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<p>CLOSED: [2021-08-09 Mon 15:23]</p>
<ul>
<li class="checked">
<p>✅ compiler-sfc: handle more edge cases in default rewrite (1dedc19)
<span id="default-rewrite"></span></p>
<p>
处理 setup script 中更多语法情况：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span> <span class="s2">&#34;/../compiler-sfc/dist/compiler-sfc.cjs.js&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&#34;stb-&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">));</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">rewriteDefault</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">test</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hint</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span> <span class="o">+</span> <span class="nx">hint</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rewriteDefault</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">))</span>
<span class="p">}</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;1. comments&#39;</span><span class="p">,</span> <span class="sb">`// export default\nexport default {}`</span><span class="p">)</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;2. export default class&#39;</span><span class="p">,</span> <span class="sb">`export default class Foo {}`</span><span class="p">)</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;3. export default class + commons&#39;</span><span class="p">,</span> <span class="sb">`// export default\nexport default class Foo {}`</span><span class="p">)</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;4. export default class + comments 2&#39;</span><span class="p">,</span>  <span class="sb">`export default {}\n`</span> <span class="o">+</span> <span class="sb">`// export default class Foo {}`</span><span class="p">)</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;5. export default class + comments 3&#39;</span><span class="p">,</span> <span class="sb">`/*\nexport default class Foo {}*/\n`</span> <span class="o">+</span> <span class="sb">`export default class Bar {}`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;------ end ------ &#39;</span><span class="p">);</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt; 1. comments

// export default
const script = {}
&gt; 2. export default class

class Foo {}
const script = Foo
&gt; 3. export default class + commons

// export default
class Foo {}
const script = Foo
&gt; 4. export default class + comments 2

const script = {}
// export default class Foo {}
&gt; 5. export default class + comments 3

/*
export default class Foo {}*/
const script = class Bar {}
------ end ------
0
</pre>
</li>
<li class="checked">
<p>✅ deps: pin Rollup to 2.38 (34f354b), closes #3332</p>
</li>
<li class="checked">
<p>✅ runtime-core: properties in methods should be writable and enumerable in DEV (#3301) (e3568ba), closes #3300</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">3  packages/runtime-core/src/componentOptions.ts
<span class="gu">@@ -610,7 +610,8 @@ export function applyOptions(
</span><span class="gu"></span>        Object.defineProperty(ctx, key, {
          value: methodHandler.bind(publicThis),
          configurable: true,
<span class="gd">-            enumerable: false
</span><span class="gd"></span><span class="gi">+            enumerable: true,
</span><span class="gi">+            writable: true
</span><span class="gi"></span>        })
      } else {
        ctx[key] = methodHandler.bind(publicThis)
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ scheduler: ensure updates are always inserted in ascending id order (<a href="https://github.com/vuejs/vue-next/issues/3184">#3184</a>) (<a href="https://github.com/vuejs/vue-next/commit/45fae9d308e8cb9fe3304d4ca03c373ce63b2e62">45fae9d</a>), closes <a href="https://github.com/vuejs/vue-next/issues/2768">#2768</a> <a href="https://github.com/vuejs/vue-next/issues/2829">#2829</a>
<span id="job-id-as"></span></p>
<p>
<a href="https://codesandbox.io/s/lucid-wind-c4jky?file=/src/App.vue">View isn&#39;t updated in a weird case (combination of many factors, transition,
injection &amp; computed)</a></p>
<p>
确保 updates 总是以升序被插入，那么在插入之前就得找到适当的 job 索引:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// #2768
</span><span class="c1">// Use binary-search to find a suitable position in the queue,
</span><span class="c1">// so that the queue maintains the increasing order of job&#39;s id,
</span><span class="c1">// which can prevent the job from being skipped and also can avoid repeated patching.
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">findInsertionIndex</span><span class="p">(</span><span class="nx">job</span>: <span class="kt">SchedulerJob</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// the start index should be `flushIndex + 1`
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">flushIndex</span> <span class="o">+</span> <span class="mi">1</span>
<span class="kd">let</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span>
<span class="kr">const</span> <span class="nx">jobId</span> <span class="o">=</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">job</span><span class="p">)</span>

<span class="k">while</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">middle</span> <span class="o">=</span> <span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">end</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span>
  <span class="kr">const</span> <span class="nx">middleJobId</span> <span class="o">=</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">queue</span><span class="p">[</span><span class="nx">middle</span><span class="p">])</span>
  <span class="nx">middleJobId</span> <span class="o">&lt;</span> <span class="nx">jobId</span> <span class="o">?</span> <span class="p">(</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">middle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">middle</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">return</span> <span class="nx">start</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
在 update 进入任务队列的时候保证所有 jobs 是以升序排列</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">export function queueJob(job: SchedulerJob) {
// the dedupe search uses the startIndex argument of Array.includes()
// by default the search index includes the current job that is being run
<span class="gu">@@ -72,7 +91,12 @@ export function queueJob(job: SchedulerJob) {
</span><span class="gu"></span>    )) &amp;&amp;
  job !== currentPreFlushParentJob
) {
<span class="gd">-    queue.push(job)
</span><span class="gd"></span><span class="gi">+    const pos = findInsertionIndex(job)
</span><span class="gi">+    if (pos &gt; -1) {
</span><span class="gi">+      queue.splice(pos, 0, job)
</span><span class="gi">+    } else {
</span><span class="gi">+      queue.push(job)
</span><span class="gi">+    }
</span><span class="gi"></span>  queueFlush()
}
}
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ v-show: v-show takes higher priority than style attribute (<a href="https://github.com/vuejs/vue-next/issues/3230">#3230</a>) (<a href="https://github.com/vuejs/vue-next/commit/5ad4036e29f75dc907e95b99a63325b855332566">5ad4036</a>), closes <a href="https://github.com/vuejs/vue-next/issues/2757">#2757</a>
<span id="v-show-priority"></span></p>
<div class="comment-block">
<p>v-show 也是通过 el.style.display 来实现的，这里意思是如果 style 属性中也有
display 的话，在 <a href="https://github.com/vuejs/vue-next/tree/master/packages/runtime-dom/src/modules/style.ts">runtime-dom/src/modules/style.ts</a> 中 patch 的时候应该 v-show
的优先级更高。</p>
</div>
</li>
<li class="checked">
<p>✅ init devtools after feature flag checks (<a href="https://github.com/vuejs/vue-next/commit/d0ea74556f74d8c503ffb7b70f41cbe2ce14db98">d0ea745</a>)</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-9" class="outline-3">
<h3 id="headline-9">
<span class="todo">DONE</span>
Performance Improvements <code class="statistic">[1/1]</code>
</h3>
<div id="outline-text-headline-9" class="outline-text-3">
<p>CLOSED: [2021-08-09 Mon 15:22]</p>
<ul>
<li class="checked">
<p>✅ reactivity: only call Set.add if doesn&#39;t already have value (<a href="https://github.com/vuejs/vue-next/issues/3307">#3307</a>) (<a href="https://github.com/vuejs/vue-next/commit/9cd988342cfa32ddd9479585244eb317d74c9712">9cd9883</a>)</p>
<p>
对于 Set key-value 都是值，所以当有这个 value 的时候再添加就没有什么意义了，
Set 又是不重复集合。</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/reactivity/src/collectionHandlers.ts
<span class="gu">@@ -76,8 +76,8 @@ function add(this: SetTypes, value: unknown) {
</span><span class="gu"></span>const target = toRaw(this)
const proto = getProto(target)
const hadKey = proto.has.call(target, value)
<span class="gd">-  target.add(value)
</span><span class="gd"></span>if (!hadKey) {
<span class="gi">+    target.add(value)
</span><span class="gi"></span>  trigger(target, TriggerOpTypes.ADD, value, value)
}
return this
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-10" class="outline-2">
<h2 id="headline-10">
3.0.6 (2021-02-24)
</h2>
<div id="outline-text-headline-10" class="outline-text-2">
<div id="outline-container-headline-11" class="outline-3">
<h3 id="headline-11">
Important
</h3>
<div id="outline-text-headline-11" class="outline-text-3">
<p>
此次更新重点内容(值得关注的点)：</p>
<ol>
<li>
<p><strong>ADD</strong>: <code>BigInt</code> 类型和 <em>SFC</em> 支持 <a href="#add-bigint">🔗</a></p>
</li>
<li>
<p><strong>FIX</strong>: 修复 <code>class: [&#39;foo&#39;, false, undefined, &#39;bar&#39;]</code> 被解析成 <code>&lt;div class=&#34;foo
bar&#34;/&gt;</code> 问题 <a href="#fix-array-class">🔗</a>。</p>
</li>
<li>
<p><strong>FIX</strong>: 修复 <code>foo-bar</code> 事件名无法触发问题 <a href="#fix-kebab-event-name">🔗</a> 。</p>
</li>
<li>
<p><strong>FIX</strong>: <code>this.$watch(fn, callback)</code> 的 <code>fn</code> 第一个参数是 <code>instance.proxy</code> <a href="#instanceWatch">🔗</a></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-12" class="outline-3">
<h3 id="headline-12">
<span class="todo">DONE</span>
Bug Fixes <code class="statistic">[25/25]</code>
</h3>
<div id="outline-text-headline-12" class="outline-text-3">
<p>CLOSED: [2021-08-05 Thu 23:42]</p>
<ul>
<li class="checked">
<p>✅ compiler-core: do not mark v-for as stable on const bindings (<a href="https://github.com/vuejs/vue-next/commit/734c65badd8395a78d7beee1fc960aee418361a0">734c65b</a>), closes <a href="https://github.com/vitejs/vite/issues/1956">vitejs/vite#1956</a></p>
</li>
<li class="checked">
<p>✅ compiler-dom: ensure global build filename matches the one defined in package.json (close <a href="https://github.com/vuejs/vue-next/issues/3181">#3181</a>) (<a href="https://github.com/vuejs/vue-next/issues/3185">#3185</a>) (<a href="https://github.com/vuejs/vue-next/commit/96b64335242a99432080aeb879e5c0787207a0de">96b6433</a>)</p>
</li>
<li class="checked">
<p>✅ compiler-dom: fix cdn entries (<a href="https://github.com/vuejs/vue-next/commit/fcb6c8920c6ee76f57325a178eb9280d7bae4d7c">fcb6c89</a>), closes <a href="https://github.com/vuejs/vue-next/issues/3181">#3181</a> <a href="https://github.com/vuejs/vue-next/issues/3185">#3185</a></p>
</li>
<li class="checked">
<p>✅ compiler-sfc: compiler blank srcset (<a href="https://github.com/vuejs/vue-next/issues/3005">#3005</a>) (<a href="https://github.com/vuejs/vue-next/commit/9dc816d63468b0a2fa2b6123959310014e121b58">9dc816d</a>)</p>
<p>
允许 <code>&lt;img src=&#34;./logo.png&#34; srcset=&#34;&#34;/&gt;</code> 的 <code>srcset</code> 是个空值，编译后：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="err">\\</span><span class="s2">&#34;img\\&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">src</span><span class="o">:</span> <span class="err">\\</span><span class="s2">&#34;./logo.png\\&#34;</span><span class="p">,</span>
    <span class="nx">srcset</span><span class="o">:</span> <span class="err">\\</span><span class="s2">&#34;\\&#34;</span>
  <span class="p">}),</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ compiler-sfc: removeSpecifier issue when removing initial imports (script-setup) (<a href="https://github.com/vuejs/vue-next/issues/2729">#2729</a>) (<a href="https://github.com/vuejs/vue-next/commit/6d5b62351248780663d2612a1f483f7ea9f5e5a2">6d762a8</a>)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span> <span class="s2">&#34;/../compiler-sfc/dist/compiler-sfc.cjs.js&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&#34;stb-&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">));</span>
<span class="kr">const</span> <span class="nx">parser</span> <span class="o">=</span> <span class="s1">&#39;/usr/local/lib/node_modules/@babel/parser/lib&#39;</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">parse</span><span class="o">:</span> <span class="nx">babelParse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">parser</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">src</span> <span class="o">=</span> <span class="sb">`&lt;script setup&gt;
</span><span class="sb">    import { defineProps, defineEmits, ref } from &#39;vue&#39;
</span><span class="sb">    defineProps([&#39;foo&#39;])
</span><span class="sb">    defineEmits([&#39;bar&#39;])
</span><span class="sb">    const r = ref(0)
</span><span class="sb">    &lt;/script&gt;`</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">descriptor</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">compileScript</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;xxxxx&#39;</span> <span class="p">}).</span><span class="nx">content</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before babel &gt; \n&#39;</span><span class="p">,</span> <span class="nx">code</span><span class="p">);</span>
<span class="nx">babelParse</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span>
<span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span>
<span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;bigInt&#39;</span><span class="p">,</span> <span class="s1">&#39;optionalChaining&#39;</span><span class="p">,</span> <span class="s1">&#39;nullishCoalescingOperator&#39;</span><span class="p">,</span> <span class="s1">&#39;typescript&#39;</span><span class="p">]</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;after babel &gt; \n&#39;</span><span class="p">,</span> <span class="nx">code</span><span class="p">);</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
before babel &gt;
 import { ref } from &#39;vue&#39;

export default {
  props: [&#39;foo&#39;],
  emits: [&#39;bar&#39;],
  setup(__props, { expose }) {
  expose()



      const r = ref(0)

return { r, ref, __isScriptSetup: true }
}

}
after babel &gt;
 import { ref } from &#39;vue&#39;

export default {
  props: [&#39;foo&#39;],
  emits: [&#39;bar&#39;],
  setup(__props, { expose }) {
  expose()



      const r = ref(0)

return { r, ref, __isScriptSetup: true }
}

}
0
</pre>
</li>
<li class="checked">
<p>✅ compiler-sfc: the empty lang attribute should be treated as no lang specified (<a href="https://github.com/vuejs/vue-next/issues/3051">#3051</a>) (<a href="https://github.com/vuejs/vue-next/commit/6d5b62351248780663d2612a1f483f7ea9f5e5a2">6d5b623</a>)</p>
</li>
<li class="checked">
<p>✅ <a href="/vue/vue-teardown-7-asset-transform/">compiler-sfc: transformAssetUrls.base should not affect known module requests</a> (<a href="https://github.com/vuejs/vue-next/commit/2ea9867398d19148b32643fa0e6523c95b9ca956">2ea9867</a>)</p>
</li>
<li class="checked">
<p>✅ compiler-sfc: treat const reactive() bindings as mutable (<a href="https://github.com/vuejs/vue-next/commit/03360cefa1b7038174fa3c1fc3a04400b4cdbbce">03360ce</a>)
<code>const obj = reactive({})</code> 编译成 <code>let</code> 变量。</p>
</li>
<li class="checked">
<p>✅ compiler-ssr: avoid duplicated asset imports merged from component slot client branch (<a href="https://github.com/vuejs/vue-next/commit/c69f4ea857b7db8d26bbde2f80786c8212d16770">c69f4ea</a>), closes <a href="https://github.com/vitejs/vite/issues/2034">vitejs/vite#2034</a></p>
<p>
<code>root.imports</code> Set 改成了 Array，允许重复了.</p>
</li>
<li class="checked">
<p>✅ devtools: init devtools in production (<a href="https://github.com/vuejs/vue-next/issues/2906">#2906</a>) (<a href="https://github.com/vuejs/vue-next/commit/4d9bcb768ddc294430aedcf27155aaca292c47bd">4d9bcb7</a>)</p>
</li>
<li class="checked">
<p>✅ devtools: send instance to devtools when it&#39;s mounted instead of created (<a href="https://github.com/vuejs/vue-next/commit/4fecb27f8696fdb8f681948543ea81ea62fe43bf">4fecb27</a>)</p>
</li>
<li class="checked">
<p>✅ docs: change reference to passed deadline (<a href="https://github.com/vuejs/vue-next/issues/2930">#2930</a>) (<a href="https://github.com/vuejs/vue-next/commit/de7f9d1efd7fa19a908357d3f3a706c52694d8bd">de7f9d1</a>)</p>
</li>
<li class="checked">
<p>✅ hmr: deep clone reused hoisted trees during dev (<a href="https://github.com/vuejs/vue-next/commit/5a7a1b8293822219283d6e267496bec02234b0bc">5a7a1b8</a>), closes <a href="https://github.com/vitejs/vite/issues/2022">vitejs/vite#2022</a></p>
<p>
开发过程中，对静态提升的组件树进行深拷贝。</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-core/src/vnode.ts
<span class="gu">@@ -459,7 +459,7 @@ export function cloneVNode&lt;T, U&gt;(
</span><span class="gu"></span>): VNode&lt;T, U&gt; {
// This is intentionally NOT using spread or extend to avoid the runtime
// key enumeration cost.
<span class="gd">-  const { props, ref, patchFlag } = vnode
</span><span class="gd"></span><span class="gi">+  const { props, ref, patchFlag, children } = vnode
</span><span class="gi"></span>const mergedProps = extraProps ? mergeProps(props || {}, extraProps) : props
return {
  __v_isVNode: true,
<span class="gu">@@ -479,7 +479,10 @@ export function cloneVNode&lt;T, U&gt;(
</span><span class="gu"></span>        : normalizeRef(extraProps)
      : ref,
  scopeId: vnode.scopeId,
<span class="gd">-    children: vnode.children,
</span><span class="gd"></span><span class="gi">+    children:
</span><span class="gi">+      __DEV__ &amp;&amp; patchFlag === PatchFlags.HOISTED &amp;&amp; isArray(children)
</span><span class="gi">+        ? (children as VNode[]).map(deepCloneVNode)
</span><span class="gi">+        : children,
</span><span class="gi"></span>  target: vnode.target,
  targetAnchor: vnode.targetAnchor,
  staticCount: vnode.staticCount,
<span class="gu">@@ -513,6 +516,18 @@ export function cloneVNode&lt;T, U&gt;(
</span><span class="gu"></span>}
}
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
deep clone 函数：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm">* Dev only, for HMR of hoisted vnodes reused in v-for
</span><span class="cm">* https://github.com/vitejs/vite/issues/2022
</span><span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">deepCloneVNode</span><span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
<span class="kr">const</span> <span class="nx">cloned</span> <span class="o">=</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">cloned</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">[]).</span><span class="nx">map</span><span class="p">(</span><span class="nx">deepCloneVNode</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">return</span> <span class="nx">cloned</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ runtime-core: align $parent/$root with the template ref when using <a href="/vue/vue-teardown-11-expose/">expose</a> (<a href="https://github.com/vuejs/vue-next/issues/3158">#3158</a>) (<a href="https://github.com/vuejs/vue-next/commit/f43a3b0bebf0837223e7b8f046dad63e34cd323b">f43a3b0</a>)</p>
<p>
expose 特性详解：<a href="/vue/vue-teardown-11-expose/">Vue3 功能拆解⑪ expose options&amp;api</a></p>
</li>
<li class="checked">
<p>✅ runtime-core: allow overriding properties other than props (<a href="https://github.com/vuejs/vue-next/issues/3105">#3105</a>) (<a href="https://github.com/vuejs/vue-next/commit/73117f6b5b1e36c9400248ed9e815839c49a12c8">73117f6</a>)</p>
<p>
允许重写非组件 props 的属性，比如：原生 API <code>hasOwnProperty</code></p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-core/src/componentPublicInstance.ts
<span class="gu">@@ -368,7 +368,7 @@ export const PublicInstanceProxyHandlers: ProxyHandler&lt;any&gt; = {
</span><span class="gu"></span>    setupState[key] = value
  } else if (data !== EMPTY_OBJ &amp;&amp; hasOwn(data, key)) {
    data[key] = value
<span class="gd">-    } else if (key in instance.props) {
</span><span class="gd"></span><span class="gi">+    } else if (hasOwn(instance.props, key)) {
</span><span class="gi"></span>    __DEV__ &amp;&amp;
      warn(
        `Attempting to mutate prop &#34;${key}&#34;. Props are readonly.`,
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-core/__tests__/componentProps.spec.ts
<span class="gu">@@ -295,6 +295,10 @@ describe(&#39;component props&#39;, () =&gt; {
</span><span class="gu"></span>    ;(instance!.proxy as any).foo = 2
  }).toThrow(TypeError)
  expect(`Attempting to mutate prop &#34;foo&#34;`).toHaveBeenWarned()
  // should not throw when overriding properties other than props
<span class="gi">+    expect(() =&gt; {
</span><span class="gi">+      ;(instance!.proxy as any).hasOwnProperty = () =&gt; {}
</span><span class="gi">+    }).not.toThrow(TypeError)
</span><span class="gi"></span>})
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ runtime-core: check the DEV_ROOT_FRAGMENT flag correctly in the dev environment (<a href="https://github.com/vuejs/vue-next/issues/2750">#2750</a>) (<a href="https://github.com/vuejs/vue-next/commit/347a8798a4c5f0b426f3ac84a01d752d823fb51b">347a879</a>)</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">  // to have comments along side the root element which makes it a fragment
  let root = result
  let setRoot: ((root: VNode) =&gt; void) | undefined = undefined
<span class="gd">-    if (__DEV__ &amp;&amp; result.patchFlag &amp; PatchFlags.DEV_ROOT_FRAGMENT) {
</span><span class="gd"></span><span class="gi">+    if (
</span><span class="gi">+      __DEV__ &amp;&amp;
</span><span class="gi">+      result.patchFlag &gt; 0 &amp;&amp;
</span><span class="gi">+      result.patchFlag &amp; PatchFlags.DEV_ROOT_FRAGMENT
</span><span class="gi">+    ) {
</span><span class="gi"></span>    ;[root, setRoot] = getChildRoot(result)
  }
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ runtime-core: component methods should override global properties in DEV (<a href="https://github.com/vuejs/vue-next/issues/3074">#3074</a>) (<a href="https://github.com/vuejs/vue-next/commit/2587f36fe311359e2e34f40e8e47d2eebfab7f42">2587f36</a>)</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-core/src/componentOptions.ts
<span class="gu">@@ -604,7 +604,17 @@ export function applyOptions(
</span><span class="gu"></span>  for (const key in methods) {
    const methodHandler = (methods as MethodOptions)[key]
    if (isFunction(methodHandler)) {
<span class="gd">-        ctx[key] = methodHandler.bind(publicThis)
</span><span class="gd"></span><span class="gi">+        // In dev mode, we use the `createRenderContext` function to define methods to the proxy target,
</span><span class="gi">+        // and those are read-only but reconfigurable, so it needs to be redefined here
</span><span class="gi">+        if (__DEV__) {
</span><span class="gi">+          Object.defineProperty(ctx, key, {
</span><span class="gi">+            value: methodHandler.bind(publicThis),
</span><span class="gi">+            configurable: true,
</span><span class="gi">+            enumerable: false
</span><span class="gi">+          })
</span><span class="gi">+        } else {
</span><span class="gi">+          ctx[key] = methodHandler.bind(publicThis)
</span><span class="gi">+        }
</span><span class="gi"></span>      if (__DEV__) {
        checkDuplicateProperties!(OptionTypes.METHODS, key)
      }
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span><span class="s1">&#39;/../runtime-test/dist/runtime-test.cjs.js&#39;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;stb-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">createApp</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span>

<span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
<span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;foo&#39;</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">()</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">globalProperties</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="s1">&#39;bar&#39;</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">(</span><span class="nx">root</span><span class="p">))</span>
<span class="k">return</span> <span class="mi">0</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
foo
0
</pre>
</li>
<li class="checked">
<p>✅ runtime-core: ensure app instance can be garbage collected after unmount (close <a href="https://github.com/vuejs/vue-next/issues/3074">#2907</a>) (<a href="https://github.com/vuejs/vue-next/issues/2909">#2909</a>) (<a href="https://github.com/vuejs/vue-next/commit/60e05eff232c3ddfca1c20e52f72aa36165d8a22">60e05ef</a>)</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-core/src/apiCreateApp.ts
<span class="gu">@@ -272,6 +272,7 @@ export function createAppAPI&lt;HostElement&gt;(
</span><span class="gu"></span>        if (__DEV__ || __FEATURE_PROD_DEVTOOLS__) {
          devtoolsUnmountApp(app)
        }
<span class="gi">+          delete app._container.__vue_app__
</span><span class="gi"></span>      } else if (__DEV__) {
        warn(`Cannot unmount an app that is not mounted.`)
      }
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
取消引用。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">unmount() {</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">_container</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">||</span> <span class="nx">__FEATURE_PROD_DEVTOOLS__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">_instance</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="nx">devtoolsUnmountApp</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">delete</span> <span class="nx">app</span><span class="p">.</span><span class="nx">_container</span><span class="p">.</span><span class="nx">__vue_app__</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">warn</span><span class="p">(</span><span class="sb">`Cannot unmount an app that is not mounted.`</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
mount 里面保存的 <code>__vue_ap__</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">mount</span><span class="p">(</span>
<span class="nx">rootContainer</span>: <span class="kt">HostElement</span><span class="p">,</span>
<span class="nx">isHydrate?</span>: <span class="kt">boolean</span><span class="p">,</span>
<span class="nx">isSVG?</span>: <span class="kt">boolean</span>
<span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>     <span class="nx">vnode</span><span class="p">.</span><span class="nx">appContext</span> <span class="o">=</span> <span class="nx">context</span>

  <span class="c1">// HMR root reload ...
</span><span class="c1"></span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isHydrate</span> <span class="o">&amp;&amp;</span> <span class="nx">hydrate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hydrate</span><span class="p">(</span><span class="nx">vnode</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">&lt;</span><span class="nt">Node</span><span class="err">,</span> <span class="na">Element</span><span class="p">&gt;,</span> <span class="nx">rootContainer</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">rootContainer</span><span class="p">,</span> <span class="nx">isSVG</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">isMounted</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">_container</span> <span class="o">=</span> <span class="nx">rootContainer</span>
  <span class="c1">// for devtools and telemetry
</span><span class="c1"></span>  <span class="p">;(</span><span class="nx">rootContainer</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">__vue_app__</span> <span class="o">=</span> <span class="nx">app</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">||</span> <span class="nx">__FEATURE_PROD_DEVTOOLS__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">_instance</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span>
    <span class="nx">devtoolsInitApp</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">.</span><span class="nx">proxy</span>
<span class="p">}</span>  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ runtime-core: instanceWatch should pass this.proxy to source as the first argument (<a href="https://github.com/vuejs/vue-next/issues/2753">#2753</a>) (<a href="https://github.com/vuejs/vue-next/commit/ec8fd10cec61c33c7c8056413a1c609ac90e1215">ec8fd10</a>)
<span id="instanceWatch"></span></p>
<p>
当 watch 一个函数的时候，将 instance.proxy 做为第一个参数传给这个函数。</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span><span class="s1">&#39;/../runtime-test/dist/runtime-test.cjs.js&#39;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;stb-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">createApp</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span>

<span class="kd">let</span> <span class="nx">instance</span> <span class="o">=</span> <span class="kc">null</span>
<span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="p">(</span><span class="nx">proxy</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">instance</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">proxy</span> <span class="o">===</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">proxy</span> <span class="p">))</span>
<span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
<span class="nx">created</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">instance</span> <span class="o">=</span> <span class="k">this</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{})</span>
<span class="p">},</span>
<span class="nx">render</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
<span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">).</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span>
<span class="k">return</span> <span class="mi">0</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
false
0
</pre>
<p>
修复：</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-core/src/apiWatch.ts
<span class="gu">@@ -181,7 +181,9 @@ function doWatch(
</span><span class="gu"></span>      } else if (isReactive(s)) {
        return traverse(s)
      } else if (isFunction(s)) {
<span class="gd">-          return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER)
</span><span class="gd"></span><span class="gi">+          return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER, [
</span><span class="gi">+            instance &amp;&amp; (instance.proxy as any)
</span><span class="gi">+          ])
</span><span class="gi"></span>      } else {
        __DEV__ &amp;&amp; warnInvalidSource(s)
      }
<span class="gu">@@ -190,7 +192,9 @@ function doWatch(
</span><span class="gu"></span>  if (cb) {
    // getter with cb
    getter = () =&gt;
<span class="gd">-        callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER)
</span><span class="gd"></span><span class="gi">+        callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER, [
</span><span class="gi">+          instance &amp;&amp; (instance.proxy as any)
</span><span class="gi">+        ])
</span><span class="gi"></span>  } else {
    // no cb -&gt; simple effect
    getter = () =&gt; {
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ types: extract the correct props type for the DateConstructor (<a href="https://github.com/vuejs/vue-next/issues/2676">#2676</a>) (<a href="https://github.com/vuejs/vue-next/commit/48f0d2944f0f9d2f556e62782fc61985897b2ed4">48f0d29</a>)</p>
</li>
<li class="checked">
<p>✅ ensure all published packages contan a LICENCE file (close #2650) (#2857) (6a48d23)</p>
</li>
<li class="checked">
<p>✅ remove superfluous spaces when normalizing class (<a href="https://github.com/vuejs/vue-next/issues/3083">#3083</a>) (<a href="https://github.com/vuejs/vue-next/commit/4b551420fc058c4683219db5d75893f9fc69aa04">4b55142</a>)
<span id="fix-array-class"></span></p>
<p>
问题如下代码，正常应该忽略 <code>undefind</code>, <code>false</code> ：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span><span class="s1">&#39;/../runtime-test/dist/runtime-test.cjs.js&#39;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;stb-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">s</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span>

<span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
<span class="nx">props</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="nx">BigInt</span> <span class="p">},</span>
<span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">]</span> <span class="p">},</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">])</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
<span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span>  <span class="p">{</span>
<span class="nx">foo</span><span class="o">:</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="mi">100000111</span><span class="p">))</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">2000000000</span><span class="p">)</span> <span class="o">*</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">30000000</span><span class="p">)</span>
<span class="p">}),</span> <span class="nx">root</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">(</span><span class="nx">root</span><span class="p">))</span>
<span class="k">return</span> <span class="mi">0</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&lt;div class=&#34;foo   bar&#34;&gt;60000000100000111&lt;/div&gt;
0
</pre>
<p>
修复：</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/shared/src/normalizeProp.ts
<span class="gu">@@ -62,7 +62,10 @@ export function normalizeClass(value: unknown): string {
</span><span class="gu"></span>  res = value
} else if (isArray(value)) {
  for (let i = 0; i &lt; value.length; i++) {
<span class="gd">-      res += normalizeClass(value[i]) + &#39; &#39;
</span><span class="gd"></span><span class="gi">+      const normalized = normalizeClass(value[i])
</span><span class="gi">+      if (normalized) {
</span><span class="gi">+        res += normalized + &#39; &#39;
</span><span class="gi">+      }
</span><span class="gi"></span>  }
} else if (isObject(value)) {
  for (const name in value) {
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ runtime-dom: enable set form attr to null on form-elements (<a href="https://github.com/vuejs/vue-next/issues/2840">#2840</a>) (<a href="https://github.com/vuejs/vue-next/issues/2849">#2849</a>) (<a href="https://github.com/vuejs/vue-next/commit/f2624380731cc32e71523e8c2c98037e98e09319">f262438</a>)</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-dom/src/patchProp.ts
<span class="gu">@@ -3,7 +3,13 @@ import { patchStyle } from &#39;./modules/style&#39;
</span><span class="gu"></span><span class="gd">-  // #1787 form as an attribute must be a string, while it accepts an Element as
</span><span class="gd">-  // a prop
</span><span class="gd">-  if (key === &#39;form&#39; &amp;&amp; typeof value === &#39;string&#39;) {
</span><span class="gd"></span><span class="gi">+  // #1787, #2840 the form property is readonly and can only be set as an
</span><span class="gi">+  // attribute using a string value
</span><span class="gi">+  if (key === &#39;form&#39; &amp;&amp; isFormTag(el.tagName)) {
</span><span class="gi"></span>  return false
}

packages/shared/src/domTagConfig.ts
<span class="gu">@@ -30,6 +30,11 @@ const SVG_TAGS =
</span><span class="gu"></span>const VOID_TAGS =
&#39;area,base,br,col,embed,hr,img,input,link,meta,param,source,track,wbr&#39;

<span class="gi">+ const FORM_TAGS =
</span><span class="gi">+  &#39;button,datalist,fieldset,input,keygen,label,legend,meter,optgroup,option,&#39; +
</span><span class="gi">+  &#39;output,progress,select,textarea&#39;
</span><span class="gi"></span>
export const isHTMLTag = /*#__PURE__*/ makeMap(HTML_TAGS)
export const isSVGTag = /*#__PURE__*/ makeMap(SVG_TAGS)
export const isVoidTag = /*#__PURE__*/ makeMap(VOID_TAGS)
export const isFormTag = /*#__PURE__*/ makeMap(FORM_TAGS, true)
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ toRef: ref created from union typed prop can&#39;t be used in watch (<a href="https://github.com/vuejs/vue-next/issues/3048">#3048</a>) (<a href="https://github.com/vuejs/vue-next/commit/4ca4666d58ee8025570dc14f1c163bdeac9c6012">4ca4666</a>)</p>
</li>
<li class="checked">
<p>✅ should prefix ShadowRoot with window. (<a href="https://github.com/vuejs/vue-next/issues/2943">#2943</a>) (<a href="https://github.com/vuejs/vue-next/commit/97d6f1a716045123d0e05600e64f11f92f504747">97d6f1a</a>)</p>
<p>
通过 window 去使用 ShadowRoot，因为它不是 window 上可枚举的属性。</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-dom/src/index.ts
<span class="gu">@@ -119,7 +119,7 @@ function normalizeContainer(
</span><span class="gu"></span>}
if (
  __DEV__ &amp;&amp;
<span class="gd">-    container instanceof ShadowRoot &amp;&amp;
</span><span class="gd"></span><span class="gi">+    container instanceof window.ShadowRoot &amp;&amp;
</span><span class="gi"></span>  container.mode === &#39;closed&#39;
) {
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-13" class="outline-3">
<h3 id="headline-13">
<span class="todo">DONE</span>
Features <code class="statistic">[5/5]</code>
</h3>
<div id="outline-text-headline-13" class="outline-text-3">
<p>CLOSED: [2021-08-05 Thu 23:42]</p>
<ul>
<li class="checked">
<p>✅ remove useless option in KeepAlive (<a href="https://github.com/vuejs/vue-next/issues/3170">#3170</a>) (<a href="https://github.com/vuejs/vue-next/commit/bd1240c1270b610c4ffcf6c32e2bbe2c9265020f">bd1240c</a>)</p>
<p>
删除了 KeepAlive 的 <code>inheritRef: true</code> 选项。</p>
</li>
<li class="checked">
<p>✅ compiler-core: support BigInt in template (<a href="https://github.com/vuejs/vue-next/issues/2900">#2900</a>) (<a href="https://github.com/vuejs/vue-next/commit/c9f94fa3cfbe8fcd9ea3d49d523dfb282c468369">c9f94fa</a>)</p>
<p>
将 <code>BigInt</code> 标记为全局变量。</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/shared/src/globalsWhitelist.ts
<span class="gu">@@ -3,6 +3,6 @@ import { makeMap } from &#39;./makeMap&#39;
</span><span class="gu"></span>const GLOBALS_WHITE_LISTED =
&#39;Infinity,undefined,NaN,isFinite,isNaN,parseFloat,parseInt,decodeURI,&#39; +
&#39;decodeURIComponent,encodeURI,encodeURIComponent,Math,Number,Date,Array,&#39; +
<span class="gd">-  &#39;Object,Boolean,String,RegExp,Map,Set,JSON,Intl&#39;
</span><span class="gd"></span><span class="gi">+  &#39;Object,Boolean,String,RegExp,Map,Set,JSON,Intl,BigInt&#39;
</span><span class="gi"></span>
export const isGloballyWhitelisted = /*#__PURE__*/ makeMap(GLOBALS_WHITE_LISTED)
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试结果：</p>
<div id="ZA4bDx"></div>
<script class="ZA4bDx">
const app = Vue.createApp({
  template: `
    <div class="comment-block">{{ BigInt(BigInt(100000111)) + BigInt(2000000000n) * 30000000n }}</div>
    <el-button type="primary" @click="click">查看测试源码</el-button>
    <div class="chroma language-js" v-if="showCode"><pre class="chroma">{{code}}</pre></div>
  `,
  setup() {
    const showCode = Vue.ref(false)
    return {
      showCode,
      code: Vue.computed(() => document.querySelector('script.ZA4bDx').textContent),
      click: () => ( showCode.value = !showCode.value )
    }
  }
})
const root = document.getElementById('ZA4bDx')
app.use(ElementPlus).mount(root)
</script>
</li>
<li class="checked">
<p>✅ <a href="/vue/vue-teardown-10-sfc-style">compiler-sfc: upgrade to postcss 8</a> (<a href="https://github.com/vuejs/vue-next/issues/2710">#2710</a>) (<a href="https://github.com/vuejs/vue-next/commit/49bc2e4db568d4f9fa2ccfe4e22c792cfc02651a">49bc2e4</a>)</p>
</li>
<li class="checked">
<p>✅ runtime-core: improve render context warning (<a href="https://github.com/vuejs/vue-next/issues/2496">#2496</a>) (<a href="https://github.com/vuejs/vue-next/commit/288ae0a8d9444365ad7438462e072c425150cbf1">288ae0a</a>)</p>
<p>
问题： 组件渲染期间去访问一个不存在的属性时候，报错信息：</p>
<div class="comment-block">
<p>Property ${JSON.stringify(key)} was accessed during render but is not defined on instance.</p>
</div>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">packages/runtime-core/src/componentPublicInstance.ts
<span class="gu">@@ -349,7 +349,7 @@ export const PublicInstanceProxyHandlers: ProxyHandler&lt;any&gt; = {
</span><span class="gu"></span>        )} must be accessed via $data because it starts with a reserved ` +
          `character (&#34;$&#34; or &#34;_&#34;) and is not proxied on the render context.`
      )
<span class="gd">-      } else {
</span><span class="gd"></span><span class="gi">+      } else if (instance === currentRenderingInstance) {
</span><span class="gi"></span>      warn(
        `Property ${JSON.stringify(key)} was accessed during render ` +
          `but is not defined on instance.`
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ runtime-core: props type support BigInt (<a href="https://github.com/vuejs/vue-next/issues/2891">#2891</a>) (<a href="https://github.com/vuejs/vue-next/commit/ffd52885453d1621e45dff645ff1101e74ea40b2">ffd5288</a>)
<span id="add-bigint"></span></p>
<p>
修改代码：</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">const isSimpleType = /*#__PURE__*/ makeMap(
<span class="gd">-  &#39;String,Number,Boolean,Function,Symbol&#39;
</span><span class="gd"></span><span class="gi">+  &#39;String,Number,Boolean,Function,Symbol,BigInt&#39;
</span><span class="gi"></span>)
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span><span class="s1">&#39;/../runtime-test/dist/runtime-test.cjs.js&#39;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;stb-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">s</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span>

<span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
<span class="nx">props</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="nx">BigInt</span> <span class="p">},</span>
<span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">])</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
<span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span>  <span class="p">{</span>
<span class="nx">foo</span><span class="o">:</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="mi">100000111</span><span class="p">))</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">2000000000</span><span class="p">)</span> <span class="o">*</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">30000000</span><span class="p">)</span>
<span class="p">}),</span> <span class="nx">root</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">(</span><span class="nx">root</span><span class="p">))</span>
<span class="k">return</span> <span class="mi">0</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&lt;div&gt;60000000100000111&lt;/div&gt;
0
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
<span class="todo">DONE</span>
Performance Improvements <code class="statistic">[1/1]</code>
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<p>CLOSED: [2021-08-05 Thu 23:42]</p>
<ul>
<li class="checked">
<p>✅ reactivity: should not track __isVue (<a href="https://github.com/vuejs/vue-next/issues/2940">#2940</a>) (<a href="https://github.com/vuejs/vue-next/commit/dd02cf37d5f5a6946bcae01ee70568e38a82c177">dd02cf3</a>)</p>
<p>
<em>@@ -93,7 +96,7 @@ function createGetter(isReadonly = false, shallow = false) {</em></p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gi">+  const isNonTrackableKeys = /*#__PURE__*/ makeMap(`__proto__,__v_isRef,__isVue`)
</span><span class="gi"></span>
  if (
    isSymbol(key)
      ? builtInSymbols.has(key as symbol)
<span class="gd">-        : key === `__proto__` || key === `__v_isRef`
</span><span class="gd"></span><span class="gi">+        : isNonTrackableKeys(key)
</span><span class="gi"></span>  ) {
    return res
  }

// 遇到 __isVue 也直接返回 Reflect.get 的结果，不往下 track 了。
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-15" class="outline-2">
<h2 id="headline-15">
3.0.5 (2020-12-30)
</h2>
<div id="outline-text-headline-15" class="outline-text-2">
<p>
<a href="https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md">vue-next/CHANGELOG.md at master · vuejs/vue-next</a></p>
<div class="tip-block">
<p><p><strong>TIP</strong></p></p>
<p>
<strong>Note</strong>: this release contains a type-only change that requires TypeScript 4.0+,
which may cause build issues in projects still using TS 3.x.</p>
</div>
<p>
只包含一些类型的变更。</p>
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
<span class="todo">DONE</span>
<strong>Bug Fixes</strong> <code class="statistic">[9/9]</code>
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>CLOSED: [2021-08-05 Thu 23:44]</p>
<ul>
<li class="checked">
<p>✅ compiler-core: fix missing createVNode import on nested v-for (<a href="https://github.com/vuejs/vue-next/commit/ad4d3915d39515a3e9ff2de691f82cb922a314b9">ad4d391</a>),
closes <a href="https://github.com/vuejs/vue-next/issues/2718">#2718</a></p>
</li>
<li class="checked">
<p>✅ compiler-sfc: should keep template nodes with no content (<a href="https://github.com/vuejs/vue-next/issues/2468">#2468</a>) (<a href="https://github.com/vuejs/vue-next/commit/5b9b37fc9b363be2989c1e9d76ab6e950cdfe2ad">5b9b37f</a>),
closes <a href="https://github.com/vuejs/vue-next/issues/2463">#2463</a></p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff"> -&gt; packages/compiler-sfc/src/parse.ts

 if (node.type !== NodeTypes.ELEMENT) {
    return
  }
<span class="gd">-    if (!node.children.length &amp;&amp; !hasSrc(node)) {
</span><span class="gd"></span><span class="gi">+    if (!node.children.length &amp;&amp; !hasSrc(node) &amp;&amp; node.tag !== &#39;template&#39;) {
</span><span class="gi"></span>    return
  }
  switch (node.tag) {
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>✅ <a href="/vue/vue-teardown-7-asset-transform/">compiler-sfc: support transforming asset urls with full base url.</a> (<a href="https://github.com/vuejs/vue-next/issues/2477">#2477</a>) (<a href="https://github.com/vuejs/vue-next/commit/db786b1afe41c26611a215e6d6599d50312b9c2f">db786b1</a>)</p>
<p>
  针对相对路径而言，当提供了 base 选项的时候，会使用这个值去拼接，如：</p>
<p>
  <code>{ transformAssetUrls: { base: &#39;https://www.cheng92.com&#39; } }</code></p>
<p>
  <code>&lt;img src=&#34;./vue/img/test.png&#34; /&gt;</code> 会被编译成：</p>
<p>
  <code>createVNode(&#39;img&#39;, { src: &#39;https://www.cheng92.com/vue/img/test.png&#39; })</code></p>
</li>
<li class="checked">
<p>✅ runtime-core: component mount anchor memory leak (<a href="https://github.com/vuejs/vue-next/issues/2459">#2459</a>) (<a href="https://github.com/vuejs/vue-next/commit/3867bb4c14131ef94098a62bffba97a5b7d1fe66">3867bb4</a>), closes <a href="https://github.com/vuejs/vue-next/issues/2458">#2458</a></p>
<p>
<img src="/img/tmp/vue-bug-2459.png" alt="/img/tmp/vue-bug-2459.png" title="/img/tmp/vue-bug-2459.png" /></p>
</li>
<li class="checked">
<p>✅ runtime-core: skip patchBlockChildren if n1.dynamicChildren is null (<a href="https://github.com/vuejs/vue-next/issues/2717">#2717</a>) (<a href="https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8">c59897c</a>), closes <a href="https://github.com/vuejs/vue-next/issues/2715">#2715</a> <a href="https://github.com/vuejs/vue-next/issues/2485">#2485</a></p>
  <script src="https://unpkg.com/vue@3.0.4/dist/vue.global.js"></script>
  <div id="IR8Cl"></div>
  <script src="/js/vue/tests/IR8Cl.js"></script>
<p>
这个问题原因是，一开始 HelloWorld 的 dynamicChildren 是 null。</p>
<p>
当点击 ADD 按钮的时候增加了一项数据，会进入 mountChildren -&gt; patchBlockChildren</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">patchBlockChildren</span>: <span class="kt">PatchBlockChildrenFn</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">oldChildren</span><span class="p">,</span>
  <span class="nx">newChildren</span><span class="p">,</span>
  <span class="nx">fallbackContainer</span><span class="p">,</span>
  <span class="nx">parentComponent</span><span class="p">,</span>
  <span class="nx">parentSuspense</span><span class="p">,</span>
  <span class="nx">isSVG</span><span class="p">,</span>
  <span class="nx">slotScopeIds</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">newChildren</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">oldVNode</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="c1">// dynamicChildren
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newVNode</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

    <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
而 <code>dynamicChildren</code> 在初始化的时候是个 <code>null</code> 值, 一开始就访问了
<code>dynamicChildren[i]</code> 所以导致报错。</p>
<p>
修复代码(<a href="https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8">c59897c</a>)，加个判断条件：</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">if (
      patchFlag &gt; 0 &amp;&amp;
      patchFlag &amp; PatchFlags.STABLE_FRAGMENT &amp;&amp;
<span class="gd">-        dynamicChildren &amp;&amp;
</span><span class="gd"></span><span class="gi">+        dynamicChildren &amp;&amp;
</span><span class="gi">+        n1.dynamicChildren
</span><span class="gi"></span>    ) {
      // a stable fragment (template root or &lt;template v-for&gt;) doesn&#39;t need to
      // patch children order, but it may contain dynamicChildren.
      patchBlockChildren(
<span class="gd">-         n1.dynamicChildren!,
</span><span class="gd"></span><span class="gi">+          n1.dynamicChildren,
</span><span class="gi"></span>        dynamicChildren,
        container,
        parentComponent,
        parentSuspense,
        isSVG,
        slotScopeIds
      )
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="checked">
<p>❌ <del>runtime-dom: support mounting app on ShadowRoot</del> (<a href="https://github.com/vuejs/vue-next/pull/2447">#2447</a>) (b2189ba), closes <a href="https://github.com/vuejs/vue-next/issues/2399">#2399</a></p>
<p>
<strong>&gt;3.2</strong> 中已经没有 <code>__isShadowRoot</code> 相关的代码了。</p>
</li>
<li class="checked">
<p>✅ ssr: properly handle ssr empty slot and fallback (88f6b33)</p>
</li>
<li class="checked">
<p>✅ <a href="/vue/vue-teardown-9-transition">transition: ensure manual style manipulation in transition leave hooks work</a> (<a href="https://github.com/vuejs/vue-next/commit/cbaa3805064cb581fc2007cf63774c91d39844fe">cbaa380</a>), closes <a href="https://github.com/vuejs/vue-next/issues/2720">#2720</a></p>
<p>
在 onLeave hook 中增加</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">forceReflow</span><span class="p">()</span>
<span class="nx">addTransitionClass</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">leaveActiveClass</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
去强制渲染，触发 <code>leaveActiveClass</code> 。</p>
</li>
<li class="checked">
<p>✅ <a href="/vue/vue-teardown-9-transition">transition: ensure styles from *-leave-active trigger transition</a> (<a href="https://github.com/vuejs/vue-next/issues/2716">#2716</a>) (<a href="https://github.com/vuejs/vue-next/commit/3f8f9b67b3b54a7ae8405baf6d28be7ec074509d">3f8f9b6</a>), closes <a href="https://github.com/vuejs/vue-next/issues/2712">#2712</a></p>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-17" class="outline-3">
<h3 id="headline-17">
<span class="todo">DONE</span>
Features <code class="statistic">[1/1]</code>
</h3>
<div id="outline-text-headline-17" class="outline-text-3">
<p>CLOSED: [2021-08-05 Thu 23:44]</p>
<ul>
<li class="checked">
<p>✅ devtools: send instance (3626ff0)</p>
<p>
将组件实例给开发工具。</p>
<div class="src src-diff">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-diff" data-lang="diff">function createDevtoolsComponentHook(hook: DevtoolsHooks) {
return (component: ComponentInternalInstance) =&gt; {
  if (!devtools) return
  devtools.emit(
    hook,
    component.appContext.app,
    component.uid,
<span class="gd">-      component.parent ? component.parent.uid : undefined
</span><span class="gd"></span><span class="gi">+      component.parent ? component.parent.uid : undefined,
</span><span class="gi">+      component
</span><span class="gi"></span>  )
}
}
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-18" class="outline-2">
<h2 id="headline-18">
tests
</h2>
<div id="outline-text-headline-18" class="outline-text-2">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VNEXT_PKG_RC</span> <span class="o">+</span> <span class="s2">&#34;/../compiler-sfc/dist/compiler-sfc.cjs.js&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&#34;stb-&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">));</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">compileScript</span><span class="p">,</span> <span class="nx">parse</span><span class="p">,</span> <span class="nx">compileStyle</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">compileScoped</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">compileStyle</span><span class="p">({</span>
    <span class="nx">source</span><span class="p">,</span>
    <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;test.css&#39;</span><span class="p">,</span>
    <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;data-v-test&#39;</span><span class="p">,</span>
    <span class="nx">scoped</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">...</span><span class="nx">options</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">code</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">src</span> <span class="o">=</span> <span class="sb">`::v-slotted(h1) { color: red; }`</span>
<span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">compileScoped</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
h1[data-v-test-s] { color: red;
}
0
</pre>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-06-28
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-teardown-6-event-listen/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 功能拆解⑥ directives 事件绑定机制</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/vue/how-to-build-a-vite-vue3-project/">
            <span class="next-text nav-default">如何开始一个 vite &#43; vue3 &#43; ... 项目</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2021-06-28 00:00:00 \u002b0000 UTC',
        title: 'Vue3 更新日志 01(3.0.5 ~ 3.2.0-beta.1)',
        clientID: '7251a6b30d0d6c0f4aa2',
        clientSecret: '320c43a98b0d5ae30535d8cf6cb3be7a05895c77',
        repo: 'cheng92-comments',
        owner: 'gcclll',
        admin: ['gcclll'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
