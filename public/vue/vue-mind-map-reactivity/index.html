<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 æºç å¤´è„‘é£æš´ä¹‹ 1 â˜reactivity - è‹¥å¶çŸ¥ç§‹</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="æ›´æ–°æ—¥å¿—&amp;amp;Todos ï¼š DONE [2021-01-20 15:16:45] ref è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ function _log(el, content)" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-reactivity/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.06b20cf21b1dff0a19c6a6fd2770439ed0c003d544ece3c4e1fbfb34fc217e45.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 1 â˜reactivity" />
<meta property="og:description" content="æ›´æ–°æ—¥å¿—&amp;Todos ï¼š DONE [2021-01-20 15:16:45] ref è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ function _log(el, content)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-reactivity/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2020-11-09T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-11-09T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 1 â˜reactivity">
<meta itemprop="description" content="æ›´æ–°æ—¥å¿—&amp;Todos ï¼š DONE [2021-01-20 15:16:45] ref è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ function _log(el, content)"><meta itemprop="datePublished" content="2020-11-09T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-11-09T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="18779">
<meta itemprop="keywords" content="vue,,vue3,,compiler-core,,parser,,compiler," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 1 â˜reactivity"/>
<meta name="twitter:description" content="æ›´æ–°æ—¥å¿—&amp;Todos ï¼š DONE [2021-01-20 15:16:45] ref è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ function _log(el, content)"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 1 â˜reactivity</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-09 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 18779 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 38 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">å…³é”®çŸ¥è¯†ç‚¹</a>
</li>
<li><a href="#init">init project</a>
</li>
<li><a href="#fn cro">add: createReactiveObject</a>
</li>
<li><a href="#headline-4">feat: reactive(target)</a>
<ul>
<li><a href="#headline-5">ç”¨ä¾‹ä¸€ï¼šæ™®é€šå¯¹è±¡</a>
</li>
<li><a href="#headline-6">ç”¨ä¾‹äºŒï¼šåŸå‹</a>
</li>
<li><a href="#headline-7">ç”¨ä¾‹ä¸‰ï¼šåµŒå¥—å¯¹è±¡</a>
</li>
<li><a href="#headline-8">ç”¨ä¾‹å››ï¼šä»£ç†åçš„å¯¹è±¡æ“ä½œä¹Ÿä¼šä½“ç°åœ¨åŸå¯¹è±¡ä¸Š</a>
</li>
<li><a href="#headline-9">ç”¨ä¾‹äº”ï¼šåŸå§‹å¯¹è±¡ä¸Šçš„æ“ä½œä¹Ÿè¦èƒ½åœ¨ä»£ç†åå¯¹è±¡æœ‰æ‰€ä½“ç°</a>
</li>
<li><a href="#headline-10">ç”¨ä¾‹å…­ï¼šè¢«è®¾ç½®çš„å€¼å¦‚æœæ˜¯å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šè¢« Reactive</a>
</li>
<li><a href="#headline-11">ç”¨ä¾‹ä¸ƒï¼šä¸è¯¥é‡å¤ proxyï¼Œè¿”å›ç¬¬ä¸€ä¸ª proxy ç»“æœ</a>
</li>
<li><a href="#headline-12">ç”¨ä¾‹å…«ï¼šä¸åº”è¯¥ç”¨ proxies æ±¡æŸ“åŸå§‹å¯¹è±¡ï¼Ÿ</a>
</li>
</ul>
</li>
<li><a href="#headline-13">basic proxy get handler(createGetter)</a>
</li>
<li><a href="#r-track-effect">add track() and effect()</a>
<ul>
<li><a href="#r-track">track(target, type, key) ç›‘å¬å–å€¼æ”¶é›†ä¾èµ–ï¼š</a>
</li>
<li><a href="#fn-effect">effect(fn, options)</a>
</li>
</ul>
</li>
<li><a href="#headline-17">add trigger() proxy set handler</a>
<ul>
<li><a href="#headline-18">proxy set handler(createSetter)</a>
</li>
<li><a href="#r-trigger">trigger()</a>
</li>
</ul>
</li>
<li><a href="#headline-20">observe object recursively</a>
</li>
<li><a href="#effect-track-trigger">effect -&gt; track -&gt; trigger å…³ç³»å›¾</a>
</li>
<li><a href="#c-delete">add delete(<strong>deleteProperty</strong>) proxy handler</a>
</li>
<li><a href="#headline-23">add has, ownKeys proxy handlers</a>
</li>
<li><a href="#headline-24">add array support</a>
</li>
<li><a href="#headline-25">array add element support</a>
</li>
<li><a href="#headline-26">add shallow reactive</a>
</li>
<li><a href="#headline-27">add readonly reactive</a>
<ul>
<li><a href="#headline-28">æµ‹è¯•(for <code>Object</code>)ï¼š</a>
</li>
<li><a href="#headline-29">æµ‹è¯•(for <code>Array</code>):</a>
</li>
<li><a href="#headline-30">æµ‹è¯•(reactive, readonly äº’æ’©)</a>
</li>
</ul>
</li>
<li><a href="#headline-31">add shallow readonly reactive</a>
</li>
<li><a href="#headline-32">add effect stop</a>
</li>
<li><a href="#headline-33">é›†åˆç±»å‹ä»£ç†(proxy handlers)è„‘å›¾</a>
</li>
<li><a href="#headline-34">add collection handlers</a>
</li>
<li><a href="#headline-35">add collection get proxy handler</a>
<ul>
<li><a href="#key-collection-proxy-get">å®ç°é¡ºåº(åŸç†)</a>
</li>
<li><a href="#headline-37">12bc4da add get handler</a>
</li>
<li><a href="#headline-38">0b3fd71 add get handler track</a>
</li>
<li><a href="#headline-39">77b14ef add get handler return value</a>
</li>
</ul>
</li>
<li><a href="#headline-40">add collection set proxy handler</a>
</li>
<li><a href="#headline-41">add collection size,has,add proxy handler</a>
</li>
<li><a href="#headline-42">add collection delete,clear proxy handler</a>
</li>
<li><a href="#headline-43">add collection forEach proxy handler</a>
</li>
<li><a href="#headline-44">add collection iterators methods proxy handler</a>
</li>
<li><a href="#headline-45">add collection readonly proxy handlers</a>
</li>
<li><a href="#headline-46">add collection shallow proxy handlers</a>
</li>
<li><a href="#computed">computed</a>
<ul>
<li><a href="#headline-48">types definitions</a>
</li>
<li><a href="#headline-49">implementation</a>
</li>
</ul>
</li>
<li><a href="#ref">add ref</a>
<ul>
<li><a href="#headline-51">ref &amp; shallow ref</a>
</li>
<li><a href="#headline-52">object ref</a>
</li>
<li><a href="#headline-53">ref proxy</a>
</li>
<li><a href="#headline-54">custom ref</a>
</li>
<li><a href="#headline-55">è¾…åŠ©å‡½æ•°</a>
</li>
</ul>
</li>
<li><a href="#headline-56">jest ğŸƒè·‘ğŸƒç”¨ä¾‹</a>
</li>
<li><a href="#headline-57">ç”¨ä¾‹åˆ†æ</a>
<ul>
<li><a href="#headline-58">Map.spec.ts</a>
</li>
<li><a href="#test-computed">computed.spec.ts</a>
<ul>
<li><a href="#test-computed-01">should return updated value</a>
</li>
<li><a href="#test-computed-02">should compute lazily</a>
</li>
<li><a href="#test-computed-03">should no longer update when stopped</a>
</li>
<li><a href="#test-computed-04">should support setter</a>
</li>
<li><a href="#test-computed-05">should be readonly</a>
</li>
</ul>
</li>
<li><a href="#headline-65">effect.ts</a>
<ul>
<li><a href="#test-01">effect + track + trigger</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#headline-67">effect æµ‹è¯•</a>
<ul>
<li><a href="#headline-68">æµ‹è¯•1(base, prototype)</a>
</li>
<li><a href="#effect-test-02">æµ‹è¯•2(stop, â€¦)</a>
</li>
</ul>
</li>
<li><a href="#whole-mind-map">å®Œæ•´è„‘å›¾</a>
<ul>
<li><a href="#mind-collection">collection proxy handlers è„‘å›¾</a>
</li>
<li><a href="#mind-effect">effect è„‘å›¾</a>
</li>
</ul>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<blockquote>
<p><strong>æ›´æ–°æ—¥å¿—&amp;Todos</strong> ï¼š</p>
<ol>
<li>
<p>DONE [2021-01-20 15:16:45] ref</p>
</li>
</ol>
</blockquote>
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<script src="/js/vue/reactivity.global.js"></script>
<script>
function _log(el, content) {
  $(el).children('.result').append('<p>' + content + '</p>')
}
</script>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> å®Œå…¨æ‹·è´äº <a href="https://github.com/vuejs/vue-next">vue-next</a> ï¼Œä¸»è¦ç›®çš„å­¦ä¹ åŠå°è¯•åº”ç”¨äºæœºé¡¶ç›’ç¯å¢ƒã€‚</strong>
</kbd></p>
<p>
<kbd> <strong>æœ¬æ–‡ä¾æ® commit è¿›ç¨‹è¿›è¡Œè®°å½•</strong> </kbd></p>
<blockquote>
<p>æ‰€æœ‰ç”¨ä¾‹è¯·æŒ‰ <code>&lt;f12&gt;</code> æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ &gt;</p>
</blockquote>
<script>
let i = 0, j = 0
const l1 = x => (j = 0, console.log(`%c >>> ${++i} ${x}`, 'background: #222; color: #bada55'))
const l2 = x => console.log(`%c > ${i}.${j++} ${x}`, 'background: #222; color: #bada55')
const log = (args) => console.log.apply(console, Array.isArray(args) ? args : [args])
log.blue = x => log([`%c ${x}`, `color: blue`])
log.red = x => log([`%c ${x}`, `color: red`])
log.gray = x => log([`%c ${x}`, `color: gray`])
log.blues = xx => xx.forEach(x => log.blue(x))
log.gray.fn = (fn) => (log.gray(fn), fn())
</script>
<script>
const { reactive, isReactive, expect } = VueReactivity
l1(`reactivity/reacitve`)
l2(`Object`)
log.gray.fn(() => {
  let original = { foo: 1 }
  let observed = reactive(original)
  log.blues([
    `observed !== original, ` + (original !== observed),
    `observed is reactive, ` + isReactive(observed),
    `original is reactive, ` + isReactive(original),
    `observed.foo === ` + observed.foo,
    `"foo" in observed, ` + ('foo' in observed),
    `own keys: ` + Object.keys(observed)
  ])
})
l2(`proto, åŸå‹å“åº”å¼`)
log.gray.fn(() => {
  const obj = {}
  const reactiveObj = reactive(obj)
  // å±æ€§è¯»å–ï¼Œä¼šå¯¼è‡´è¯¥å±æ€§ä¹Ÿå˜æˆ reactive
  const prototype = reactiveObj['__proto__']
  const otherObj = { data: ['a'] }
  log.blues([
    `"reactiveObj" is reactive, ` + isReactive(reactiveObj),
    `otherObj is reactive, ` + isReactive(otherObj) ,
  ])
  const reactiveOther = reactive(otherObj)
  log.blues([
    `reactiveOther is reactive, ` + isReactive(otherObj),
    `reactiveOther.data[0] = ` + reactiveOther.data[0]
  ])
})
</script>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
å…³é”®çŸ¥è¯†ç‚¹
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ul>
<li class="indeterminate">
<p><a href="#test-computed-01">è®¡ç®—å±æ€§æ˜¯å¦‚ä½•å®ç°ç»“æœç¼“å­˜çš„ï¼Ÿ</a></p>
</li>
</ul>
</div>
</div>
<div id="outline-container-init" class="outline-2">
<h2 id="init">
init project
</h2>
<div id="outline-text-init" class="outline-text-2">
<p>
åˆå§‹åŒ–é¡¹ç›®ï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/cb3470d7c3f2944fd23e9155fc8a6afb7a51a732">feat: reactive-fn Â· gcclll/stb-vue-next@cb3470d</a></p>
<p>
<a href="#while-mind-map">ç”±äºå®Œæ•´è„‘å›¾ä¼šæ¯”è¾ƒå…¨è€Œå¤§æ‰€ä»¥æ”¾åˆ°æ–‡å­—æœ€åå»ã€‚ã€‚ã€‚</a></p>
<p>
<a href="/img/vue3/reactivity/reactivity.svg">ä¹Ÿå¯ä»¥ç‚¹å‡»è¯¥é“¾æ¥ç›´æ¥æ–°çª—å£æ‰“å¼€ï¼Œæ•ˆæœæ›´ä½³ã€‚</a></p>
</div>
</div>
<div id="outline-container-fn cro" class="outline-2">
<h2 id="fn cro">
add: createReactiveObject
</h2>
<div id="outline-text-fn cro" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cb3470d7c3f2944fd23e9155fc8a6afb7a51a732">feat: reactive-fn Â· gcclll/stb-vue-next@cb3470d</a></p>
<p>
<img src="/img/vue3/reactivity/reactivity-reactive.svg" alt="/img/vue3/reactivity/reactivity-reactive.svg" title="/img/vue3/reactivity/reactivity-reactive.svg" /></p>
<p>
ä»…å¢åŠ å‡½æ•°å£°æ˜:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// å¦‚æœè¯•å›¾ observe ä¸€ä¸ªåªè¯» proxyï¼Œè¿”å›åªè¯»ç‰ˆæœ¬
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="nx">Target</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">target</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">createReactiveObject</span><span class="p">(</span>
    <span class="nx">target</span><span class="p">,</span>
    <span class="kc">false</span><span class="p">,</span>
    <span class="nx">mutableHandlers</span><span class="p">,</span>
    <span class="p">{}</span>
    <span class="c1">// mutableCollectionHandlers
</span><span class="c1"></span>  <span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createReactiveObject</span><span class="p">(</span>
  <span class="nx">target</span>: <span class="kt">Target</span><span class="p">,</span>
  <span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">baseHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;,</span>
  <span class="nx">collectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>mutableHandlers</strong>: æ™®é€šå¯¹è±¡ç±»å‹çš„ proxy handlers</p>
<p>
<strong>mutableCollectionHandlers</strong>: é›†åˆç±»å‹çš„ proxy handlersï¼Œå› ä¸º <code>Reflect</code> å¹¶æ²¡æœ‰å¯¹é›†
åˆç±»å‹åšåº•å±‚æ˜ å°„ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
feat: reactive(target)
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/443a0b5920efaf714de08b0975c17f1d652815e4">feat: createReactiveObject Â· gcclll/stb-vue-next@443a0b5</a></p>
<p>
<img src="/img/vue3/reactivity/reactivity-create-reactive-object.svg" alt="/img/vue3/reactivity/reactivity-create-reactive-object.svg" title="/img/vue3/reactivity/reactivity-create-reactive-object.svg" /></p>
<ol>
<li>
<p>é‡ç‚¹ï¼š <code>new Proxy(target, collection)</code></p>
</li>
<li>
<p>è¢«ä»£ç†ç±»å‹å¿…é¡»æ˜¯å¯¹è±¡(å¼•ç”¨ç±»å‹)</p>
</li>
<li>
<p>target æœ¬èº«å·²ç»æ˜¯ proxy äº†</p>
</li>
<li>
<p>target ä»£ç†æœ‰ç¼“å­˜ä¸ç”¨é‡å¤åˆ›å»º</p>
</li>
<li>
<p>å¿…é¡»æ˜¯åˆæ³•çš„ç±»å‹(<code>Object|Array|[Weak]Map|[Weak]Set</code>)æ‰èƒ½è¢«ä»£ç†</p>
</li>
<li>
<p>è®°å¾—ç¼“å­˜æ–°åˆ›å»ºçš„ä»£ç†å…³ç³»(<code>proxyMap</code> å…¨å±€å˜é‡)</p>
</li>
</ol>
<div id="outline-container-headline-5" class="outline-4">
<h4 id="headline-5">
ç”¨ä¾‹ä¸€ï¼šæ™®é€šå¯¹è±¡
</h4>
<div id="outline-text-headline-5" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span><span class="p">,</span> <span class="nx">isReactive</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;observed is not orignial,&#39;</span> <span class="o">+</span> <span class="nx">original</span> <span class="o">!==</span> <span class="nx">observed</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;observed is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;original is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;observed.foo === 1, &#39;</span> <span class="o">+</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;`foo` in observed, &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="sb">`foo`</span> <span class="k">in</span> <span class="nx">observed</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Object.keys(observed) == [&#39;foo&#39;], `</span> <span class="o">+</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">observed</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;foo&#39;</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
true
observed is reactive, true
original is reactive, false
false
`foo` in observed, true
Object.keys(observed) == [&#39;foo&#39;], true
undefined
</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1005ef30d5367fe306a4cfeb7e00c1cd56b1c691">b2143f9</a> FIX: <code>isReactive(observed): false</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1005ef30d5367fe306a4cfeb7e00c1cd56b1c691">fix: get object&#39;s __v_isReactive prop Â· gcclll/stb-vue-next@1005ef3</a></p>
<p>
åœ¨ <code>createGetter</code> ä¸­å¢åŠ åˆ¤æ–­ï¼Œå¦‚æœæ¥å–çš„å±æ€§ä¸º <code>__v_isReactive</code> åˆ™ç›´æ¥è¿”å›
<code>!isReadonly</code> ã€‚</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-4">
<h4 id="headline-6">
ç”¨ä¾‹äºŒï¼šåŸå‹
</h4>
<div id="outline-text-headline-6" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">const</span> <span class="nx">reactiveObj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;reactiveObj is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">reactiveObj</span><span class="p">))</span>
<span class="kr">const</span> <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">reactiveObj</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">otherObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;otherObj is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">otherObj</span><span class="p">))</span>
<span class="kr">const</span> <span class="nx">reactiveOther</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">otherObj</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;reactiveOther is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">reactiveOther</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;reactiveOther.data[0] is `a`, &#39;</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">reactiveOther</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;a&#39;</span> <span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`__proto__, `</span> <span class="o">+</span> <span class="nx">prototype</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
reactiveObj is reactive, true
otherObj is reactive, false
reactiveOther is reactive, true
reactiveOther.data[0] is `a`, true
__proto__, [object Object]
undefined
</pre>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/1e2a3fef77b4a2b5f4dc3c497296b30b4ff06883">1005ef3</a> å½“å–å€¼æ—¶å±æ€§åä¸º <code>__proto__</code> æ—¶ï¼šç›´æ¥è¿”å›å–å€¼ç»“æœã€‚</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1e2a3fef77b4a2b5f4dc3c497296b30b4ff06883">feat: get key is symbol or <span style="text-decoration: underline;"><span style="text-decoration: underline;">proto</span></span> or __v_isRef Â· gcclll/stb-vue-next@1e2a3fe</a></p>
</div>
</div>
<div id="outline-container-headline-7" class="outline-4">
<h4 id="headline-7">
ç”¨ä¾‹ä¸‰ï¼šåµŒå¥—å¯¹è±¡
</h4>
<div id="outline-text-headline-7" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span><span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">nested</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nx">array</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}]</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.nested is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">nested</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.array is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">array</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.array[0] is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.nested is reactive true
observed.array is reactive true
observed.array[0] is reactive true
</pre>
</div>
</div>
<div id="outline-container-headline-8" class="outline-4">
<h4 id="headline-8">
ç”¨ä¾‹å››ï¼šä»£ç†åçš„å¯¹è±¡æ“ä½œä¹Ÿä¼šä½“ç°åœ¨åŸå¯¹è±¡ä¸Š
</h4>
<div id="outline-text-headline-8" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span>
      <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">or</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">or</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ob.bar = </span><span class="si">${</span><span class="nx">ob</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">, or.bar = </span><span class="si">${</span><span class="nx">or</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&#39;foo&#39; in ob: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">ob</span><span class="si">}</span><span class="sb">, &#39;foo&#39; in or: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">or</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
ob.bar = 1, or.bar = 1
&#39;foo&#39; in ob: false, &#39;foo&#39; in or: false
</pre>
<p>
ç»“æœåˆ é™¤åï¼Œä¾æ—§åœ¨ï¼Œéœ€è¦å®ç° delete proxy handlerã€‚</p>
</div>
</div>
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
ç”¨ä¾‹äº”ï¼šåŸå§‹å¯¹è±¡ä¸Šçš„æ“ä½œä¹Ÿè¦èƒ½åœ¨ä»£ç†åå¯¹è±¡æœ‰æ‰€ä½“ç°
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>

<span class="nx">original</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.bar = </span><span class="si">${</span><span class="nx">observed</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">, original.bar = </span><span class="si">${</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">original</span><span class="p">.</span><span class="nx">foo</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&#39;foo&#39; in original: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">original</span><span class="si">}</span><span class="sb">, &#39;foo&#39; in observed: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">observed</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.bar = 1, original.bar = 1
&#39;foo&#39; in original: false, &#39;foo&#39; in observed: false
</pre>
</div>
</div>
<div id="outline-container-headline-10" class="outline-4">
<h4 id="headline-10">
ç”¨ä¾‹å…­ï¼šè¢«è®¾ç½®çš„å€¼å¦‚æœæ˜¯å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¼šè¢« Reactive
</h4>
<div id="outline-text-headline-10" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="nx">raw</span> <span class="c1">// #0
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.foo === faw, </span><span class="si">${</span><span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">raw</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span> <span class="c1">// #1
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.foo is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.foo === faw, false
observed.foo is reactive, true
</pre>
<p>
è®¿é—® raw ä¹‹å‰(<strong>#1</strong> ä¹‹å‰)å®ƒè¿˜ä¸æ˜¯ reactiveï¼Œå› ä¸ºé€’å½’ reactive å‘ç”Ÿåœ¨ track() ä¸­ï¼Œå³å–å€¼é˜¶æ®µã€‚</p>
<p>
å¦‚ï¼šæ§åˆ¶å°æµ‹è¯•è¾“å‡º</p>
<pre class="example">
var ob = reactive({})
var raw = {}
ob.foo = raw
ob
    Proxy {foo: {â€¦}}
        [[Handler]]: Object
            deleteProperty: Æ’ deleteProperty(target, key)
            get: Æ’ (target, key, receiver)
            set: Æ’ (target, key, value, receiver)
        [[Target]]: Object
            foo: {} // æ³¨æ„è¿™é‡Œ
        [[IsRevoked]]: false
</pre>
<p>
è¿›è¡Œä¸€æ¬¡å–å€¼ï¼š</p>
<pre class="example">
ob.foo
    ProxyÂ {}
        [[Handler]]: Object
        [[Target]]: Object
        [[IsRevoked]]: false
</pre>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
ç”¨ä¾‹ä¸ƒï¼šä¸è¯¥é‡å¤ proxyï¼Œè¿”å›ç¬¬ä¸€ä¸ª proxy ç»“æœ
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="c1">// #1
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">observed1</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span> <span class="c1">// #2
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">observed2</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">observed1</span><span class="p">)</span> <span class="c1">// #3
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed2 === observed1, </span><span class="si">${</span><span class="nx">observed2</span> <span class="o">===</span> <span class="nx">observed1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
observed2 === observed1, true
undefined
</pre>
<p>
å› ä¸º <code>reactive()</code> å®ç°ä¸­ç»„äº†æ£€æµ‹ï¼Œå¦‚æœè‡ªèº«æ˜¯ä¸ª proxy å°±ç›´æ¥è¿”å›ï¼Œæ‰€ä»¥ <strong>#3</strong> ä¸­å®
é™…ç›´æ¥å°† <code>observed1</code> è¿”å›äº†ã€‚</p>
</div>
</div>
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
<span class="todo">TODO</span>
ç”¨ä¾‹å…«ï¼šä¸åº”è¯¥ç”¨ proxies æ±¡æŸ“åŸå§‹å¯¹è±¡ï¼Ÿ
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">original2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">observed2</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original2</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="nx">observed2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.bar === observed2, </span><span class="si">${</span><span class="nx">observed</span><span class="p">.</span><span class="nx">bar</span> <span class="o">===</span> <span class="nx">observed2</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original.bar === original2, </span><span class="si">${</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span> <span class="o">===</span> <span class="nx">original2</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.bar === observed2, true
original.bar === original2, false
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-2">
<h2 id="headline-13">
basic proxy get handler(createGetter)
</h2>
<div id="outline-text-headline-13" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/598e047407fe52183468037beb45328878431a55">feat: reactive proxy get handler Â· gcclll/stb-vue-next@598e047</a></p>
<p>
commit: åªå®ç°å¯¹è±¡çš„ <code>get proxy handler</code> ï¼Œå¯¹è±¡å±æ€§è¢«è®¿é—®çš„æ—¶å€™ä¼šè§¦å‘ä»£ç†ï¼Œæ¯”å¦‚ä¸‹é¢
å®ä¾‹ä¸­ï¼Œå½“è®¿é—® <code>observed.count</code> æ—¶å€™ä¼šè§¦å‘ <code>console.log({ res }, &#34;get&#34;)</code> æ‰§è¡Œã€‚</p>
<p>
æœ€ç®€å• proxy get handler è„‘å›¾ï¼š
<img src="/img/vue3/reactivity/reactivity-basehd-get-01.svg" alt="/img/vue3/reactivity/reactivity-basehd-get-01.svg" title="/img/vue3/reactivity/reactivity-basehd-get-01.svg" /></p>
<ol>
<li>
<p>è°ƒç”¨ <code>Reflect.get(target, key, receiver)</code> æ‰§è¡ŒåŸå­æ“ä½œ</p>
</li>
<li>
<p>è¿”å›æ‰§è¡Œç»“æœ</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createGetter</span><span class="p">(</span><span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// target: è¢«å–å€¼çš„å¯¹è±¡ï¼Œkey: å–å€¼çš„å±æ€§ï¼Œreceiver: this çš„å€¼
</span><span class="c1"></span>  <span class="k">return</span> <span class="kd">function</span> <span class="kr">get</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">Target</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span> <span class="nx">receiver</span>: <span class="kt">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span>

    <span class="c1">// æ˜¯å¦åªéœ€è¦ reactive ä¸€çº§å±æ€§(ä¸é€’å½’ reactive)
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">shallow</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">res</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">object</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span> <span class="c1">// ob.count å±æ€§ æ”¶é›† effect fn
</span><span class="c1"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">target</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: effect ä¼šç«‹å³æ‰§è¡Œ fnï¼Œ <code>ob.count</code> å–å€¼è§¦å‘ get proxy æ”¶é›† fn -&gt; count =&gt; deps&lt;Set&gt;</p>
<pre class="example">
Map(1) {
  &#39;count&#39; =&gt; Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  }
}
</pre>
</div>
</div>
<div id="outline-container-r-track-effect" class="outline-2">
<h2 id="r-track-effect">
add track() and effect()
</h2>
<div id="outline-text-r-track-effect" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3fc963486868ca3583b02852f07a5aa5969ac354">feat: track+effect Â· gcclll/stb-vue-next@3fc9634</a></p>
<p>
ä¸ºäº†å®Œæˆè§‚å¯Ÿå±æ€§ï¼Œé€šè¿‡å±æ€§çš„å–å€¼æ“ä½œæ¥æ”¶é›†ä¾èµ–è¿‡ç¨‹ï¼Œè¿™é‡ŒåŒæ—¶å®ç°äº† <code>track()</code> å’Œ
<code>effect()</code> å‡½æ•°ã€‚</p>
<div id="outline-container-r-track" class="outline-3">
<h3 id="r-track">
track(target, type, key) ç›‘å¬å–å€¼æ”¶é›†ä¾èµ–ï¼š
</h3>
<div id="outline-text-r-track" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-basehd-get-02-track.svg" alt="/img/vue3/reactivity/reactivity-basehd-get-02-track.svg" title="/img/vue3/reactivity/reactivity-basehd-get-02-track.svg" /></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">track</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span> <span class="kr">type</span><span class="o">:</span> <span class="nx">TrackOpTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">shouldTrack</span> <span class="o">||</span> <span class="nx">activeEffect</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Map&lt; obj -&gt; Map&lt;key, Set[...deps]&gt; &gt;
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">depsMap</span> <span class="o">=</span> <span class="nx">targetMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depsMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åˆå§‹åŒ–
</span><span class="c1"></span>    <span class="nx">targetMap</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="p">(</span><span class="nx">depsMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()));</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">dep</span> <span class="o">=</span> <span class="nx">depsMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">depsMap</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">(</span><span class="nx">dep</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()));</span>
  <span class="p">}</span>

  <span class="c1">// æ­£åœ¨è¯·æ±‚æ”¶é›†çš„ effect ï¼Œæ˜¯åˆæ¬¡å‡ºç°
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">dep</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">);</span>
    <span class="c1">// è‡ªèº«ä¿å­˜ä¸€ä»½è¢«ä¾èµ–è€…åå•
</span><span class="c1"></span>    <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">({</span>
        <span class="nx">effect</span>: <span class="kt">activeEffect</span><span class="p">,</span>
        <span class="nx">target</span><span class="p">,</span>
        <span class="kr">type</span><span class="p">,</span>
        <span class="nx">key</span><span class="p">,</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-fn-effect" class="outline-3">
<h3 id="fn-effect">
effect(fn, options)
</h3>
<div id="outline-text-fn-effect" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-effect.svg" alt="/img/vue3/reactivity/reactivity-effect.svg" title="/img/vue3/reactivity/reactivity-effect.svg" /></p>
<ul>
<li>
<p><strong>å‚æ•°åˆ—è¡¨</strong> ï¼š</p>
<p>
  fn - è¢«å°è£…çš„å‡½æ•°ï¼Œé‡Œé¢å¯å¯¹å¯¹è±¡æ‰§è¡Œ get/set æ“ä½œã€‚</p>
</li>
<li>
<p><strong>ä¸»è¦åŠŸèƒ½</strong> ï¼šå°† fn å°è£…æˆ <code>ReactiveEffect</code> å‡½æ•°</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="p">()</span><span class="o">:</span> <span class="nx">T</span> <span class="c1">// effectå‡½æ•°ä¸»é¢˜
</span><span class="c1"></span>    <span class="nx">_isEffect</span>: <span class="kt">true</span> <span class="c1">// æ ‡è®°è‡ªèº«æ˜¯ä¸æ˜¯ä¸€ä¸ª ReactiveEffect ç±»å‹
</span><span class="c1"></span>    <span class="nx">id</span>: <span class="kt">number</span> <span class="c1">// uid++ è€Œæ¥ï¼Œå…¨å±€çš„ä¸€ä¸ªç›¸å¯¹å”¯ä¸€çš„ id
</span><span class="c1"></span>    <span class="nx">active</span>: <span class="kt">boolean</span> <span class="c1">// è®°å½•å½“å‰çš„ effect æ˜¯ä¸æ˜¯æ¿€æ´»çŠ¶æ€
</span><span class="c1"></span>    <span class="nx">raw</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span> <span class="c1">// å°è£…ä¹‹å‰çš„é‚£ä¸ª fn
</span><span class="c1"></span>    <span class="nx">deps</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">Dep</span><span class="p">&gt;</span> <span class="c1">// fn çš„è¢«ä¾èµ–è€…åˆ—è¡¨
</span><span class="c1"></span>    <span class="nx">options</span>: <span class="kt">ReactiveEffectOptions</span> <span class="c1">// é¢å¤–é€‰é¡¹ï¼Œå¦‚ï¼šlazy
</span><span class="c1"></span>    <span class="nx">allowRecurse</span>: <span class="kt">boolean</span> <span class="c1">// ???
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><strong>è§£å†³é—®é¢˜</strong> :</p>
<ol>
<li>
<p>fn å°è£…ä¹‹åï¼Œæ‰§è¡Œ fn è¿‡ç¨‹ä¸­ä½¿ç”¨ tryâ€¦finally ï¼Œé˜²æ­¢ fn æ‰§è¡Œå¼‚å¸¸å¯¼è‡´
effect è¿›ç¨‹ä¸­æ–­</p>
</li>
<li>
<p>ç»“åˆ shouldTrack, activeEffect å’Œ track() å‡½æ•°ï¼Œæœ‰æ•ˆçš„é¿å…äº†åœ¨ fn ä¸­æ‰§è¡Œ
obj.value++ å¯¼è‡´ effect æ­»å¾ªç¯é—®é¢˜ï¼Œå› ä¸º tryâ€¦finally ç¡®ä¿äº†åªæœ‰ fn å‡½æ•°
å®Œæˆä¹‹åæ‰ä¼šè¿›å…¥ finally æ¢å¤ effect çŠ¶æ€(<code>shouldTrack = true,
activeEffect = last || null</code>)ã€‚</p>
</li>
</ol>
</li>
</ul>
<p>
ç›¸å…³å‡½æ•°åŠå˜é‡åˆ—è¡¨</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>activeEffect</code></td>
<td><em>ReactiveEffect</em></td>
<td>å½“å‰æ­£åœ¨å¤„ç†çš„ Effectï¼Œfn è¿˜æœªæ‰§è¡Œå®Œæˆï¼Œfinally è¿˜æ²¡ç»“æŸ</td>
</tr>
<tr>
<td><code>effectStack</code></td>
<td><em>Array, []</em></td>
<td>ç¼“å­˜æ‰€æœ‰çŠ¶æ€è¿˜æ²¡å®Œæˆçš„ Effect</td>
</tr>
<tr>
<td><code>shouldTrack</code></td>
<td><em>boolean, true</em></td>
<td>track() ä¸­ç”¨æ¥æ£€æµ‹å½“å‰ effect æ˜¯å¦ç»“æŸï¼Œä»è€Œåˆ¤å®šæ˜¯å¦å¯ä»¥ç»§ç»­æ‰§è¡Œ track() æ”¶é›†ä¾èµ–</td>
</tr>
<tr>
<td><code>trackStack</code></td>
<td><em>Array, []</em></td>
<td>ä¿å­˜ç€æ‰€æœ‰ Effect çš„ shouldTrack å€¼</td>
</tr>
<tr>
<td><code>effect()</code></td>
<td><em>function</em></td>
<td>å°è£… fnæˆ ReactiveEffect ç»“æ„</td>
</tr>
<tr>
<td><code>track(target, type, key)</code></td>
<td><em>function</em></td>
<td>æ”¶é›†ä¾èµ–ï¼Œå¹¶ä¸”å“åº”å¼é€’å½’</td>
</tr>
<tr>
<td><code>trigger(...)</code></td>
<td><em>function</em></td>
<td>å½“å€¼æ›´æ–°æ—¶è§¦å‘æ‰€æœ‰ä¾èµ–æ›´æ–°</td>
</tr>
<tr>
<td><code>createReactiveEffect(fn, options)</code></td>
<td><em>function</em></td>
<td>effect() å‡½æ•°ä¸»é¢˜åŠŸèƒ½åˆ†ç¦»å‡ºæ¥</td>
</tr>
<tr>
<td><code>cleanup(effect: ReactiveEffect)</code></td>
<td><em>function</em></td>
<td>æ¸…ç©ºæ‰€æœ‰ fn çš„ä¾èµ– effect.deps[]</td>
</tr>
<tr>
<td><code>enableTracking()</code></td>
<td><em>function</em></td>
<td>ä½¿èƒ½ Effect ï¼ŒshouldTrack = true, å¹¶å°†å…¶åŠ å…¥ trackStack</td>
</tr>
<tr>
<td><code>resetTracking()</code></td>
<td><em>function</em></td>
<td>é‡ç½® Effect, shouldTrack = ä¸Šä¸€ä¸ª Effect çš„ shouldTrack å€¼æˆ– true</td>
</tr>
</tbody>
</table>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">effect</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;(</span>
  <span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">ReactiveEffectOptions</span> <span class="o">=</span> <span class="nx">EMPTY_OBJ</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isEffect</span><span class="p">(</span><span class="nx">fn</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">raw</span> <span class="c1">// å–å‡ºåŸå§‹çš„å‡½æ•°ï¼Œå°è£…ä¹‹å‰çš„
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// å°è£…æˆ ReactiveEffect
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">effect</span> <span class="o">=</span> <span class="nx">createReactiveEffect</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">lazy</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å¦‚æœå¹¶æ²¡æŒ‡å®š lazy: true é€‰é¡¹ï¼Œåˆ™ç«‹å³æ‰§è¡Œ effect æ”¶é›†ä¾èµ–
</span><span class="c1"></span>    <span class="c1">// å› ä¸º effect ä¸€èˆ¬éƒ½ä¼šæœ‰å–å€¼æ“ä½œï¼Œæ­¤æ—¶ä¼šè§¦å‘ proxy get handler
</span><span class="c1"></span>    <span class="c1">// ç„¶åæ‰§è¡Œ track() ç»“åˆå½“å‰çš„ activeEffect å³ effect() æ‰§è¡Œæ—¶å€™çš„è¿™ä¸ª
</span><span class="c1"></span>    <span class="c1">// effectï¼Œè¿™æ ·å–å€¼æ“ä½œå°±å’Œå½“å‰å–å€¼ä½œç”¨åŸŸä¸‹çš„ä¾èµ–å‡½æ•°å»ºç«‹çš„ä¾èµ–å…³ç³»
</span><span class="c1"></span>    <span class="nx">effect</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">effect</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">uid</span> <span class="o">=</span> <span class="mi">0</span>

<span class="kd">function</span> <span class="nx">createReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;(</span>
  <span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">ReactiveEffectOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="c1">// å°† fn æ‰§è¡Œå°è£…æˆ  ReactiveEffect ç±»å‹çš„å‡½æ•°
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">effect</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">reactiveEffect</span><span class="p">()</span><span class="o">:</span> <span class="kt">unknown</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effect</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// éæ¿€æ´»çŠ¶æ€ï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨è°ƒç”¨äº† stop
</span><span class="c1"></span>      <span class="c1">// é‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™å°±éœ€è¦è€ƒè™‘è°ƒç”¨ stop è€…æ˜¯å¦æä¾›äº†æ‰‹åŠ¨è°ƒåº¦è¯¥ effect
</span><span class="c1"></span>      <span class="c1">// çš„å‡½æ•° scheduler ? ä¹Ÿå°±æ˜¯è¯´ä½ åœæ­¢ä½ å¯ä»¥é‡æ–°å¯åŠ¨
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effectStack</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">effect</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 1. cleanup, ä¿æŒçº¯å‡€
</span><span class="c1"></span>      <span class="nx">cleanup</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// 2. ä½¿å…¶ tracking çŠ¶æ€æœ‰æ•ˆï¼Œtrack() ä¸­æœ‰ç”¨
</span><span class="c1"></span>        <span class="nx">enableTracking</span><span class="p">()</span> <span class="c1">// track() å¯ä»¥æ‰§è¡Œæ”¶é›†æ“ä½œ
</span><span class="c1"></span>        <span class="nx">effectStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span> <span class="c1">// effect å…¥æ ˆ
</span><span class="c1"></span>        <span class="c1">// 3. ä¿å­˜ä¸ºå½“å‰çš„ activeEffect, track() ä¸­æœ‰ç”¨
</span><span class="c1"></span>        <span class="nx">activeEffect</span> <span class="o">=</span> <span class="nx">effect</span> <span class="c1">// è®°å½•å½“å‰çš„ effect -&gt; track/trigger
</span><span class="c1"></span>        <span class="c1">// 4. æ‰§è¡Œ fn å¹¶è¿”å›ç»“æœ
</span><span class="c1"></span>        <span class="k">return</span> <span class="nx">fn</span><span class="p">()</span> <span class="c1">// è¿”å›æ‰§è¡Œç»“æœ
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="c1">// å§‹ç»ˆéƒ½ä¼šæ‰§è¡Œï¼Œé¿å…å‡ºç°å¼‚å¸¸å°† effect è¿›ç¨‹å¡æ­»
</span><span class="c1"></span>        <span class="c1">// 5. å¦‚æœæ‰§è¡Œå¼‚å¸¸ï¼Œä¸¢å¼ƒå½“å‰çš„ effect ï¼Œå¹¶å°†çŠ¶æ€é‡ç½®ä¸ºä¸Šä¸€ä¸ª effect
</span><span class="c1"></span>        <span class="c1">//   ç”±ä¸€ä¸ª effect æ ˆæ¥ç»´æŠ¤ã€‚
</span><span class="c1"></span>
        <span class="nx">effectStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="nx">resetTracking</span><span class="p">()</span>
        <span class="nx">activeEffect</span> <span class="o">=</span> <span class="nx">effectStack</span><span class="p">[</span><span class="nx">effectStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="kr">as</span> <span class="nx">ReactiveEffect</span>

  <span class="nx">effect</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">uid</span><span class="o">++</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">allowRecurse</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">_isEffect</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">raw</span> <span class="o">=</span> <span class="nx">fn</span> <span class="c1">// è¿™é‡Œä¿å­˜åŸå§‹å‡½æ•°å¼•ç”¨
</span><span class="c1"></span>  <span class="nx">effect</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span>

  <span class="k">return</span> <span class="nx">effect</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¾èµ–å’Œå±æ€§å˜æ›´å‘ç”Ÿè”ç³»çš„æ¡¥æ¢æ¨¡å—ã€‚</p>
<ol>
<li>
<p><code>effect(fn, options)</code> å°è£…æ‰§è¡Œ fnï¼Œè§¦å‘å–å€¼æ“ä½œ -&gt;</p>
</li>
<li>
<p><code>track(target, type, key)</code> æ”¶é›†å¯¹è±¡åŠå±æ€§æ‰€æœ‰ä¾èµ– -&gt;</p>
</li>
<li>
<p>fn ä¸­è®¾å€¼æ“ä½œè§¦å‘ <code>trigger(...)</code> æ‰§è¡Œæ‰€æœ‰ depsï¼Œæ›´æ–° DOMã€‚</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-17" class="outline-2">
<h2 id="headline-17">
add trigger() proxy set handler
</h2>
<div id="outline-text-headline-17" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/20afde9970282c144b978b005767bd2c710d54ab">feat: proxy set and trigger operation Â· gcclll/stb-vue-next@20afde9</a></p>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
proxy set handler(createSetter)
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kd">function</span> <span class="nx">createSetter</span><span class="p">(</span><span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="kr">set</span><span class="p">(</span>
    <span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span>
    <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span>
    <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span>
    <span class="nx">receiver</span>: <span class="kt">object</span>
  <span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]</span>
    <span class="c1">// TODO shallow or not, or ref ?
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>
    <span class="kr">const</span> <span class="nx">hadKey</span> <span class="o">=</span>
      <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isIntegerKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="o">?</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">target.length</span>
        : <span class="kt">hasOwn</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">receiver</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO ADD
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-r-trigger" class="outline-3">
<h3 id="r-trigger">
trigger()
</h3>
<div id="outline-text-r-trigger" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span>
  <span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">TriggerOpTypes</span><span class="p">,</span>
  <span class="nx">key?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">newValue?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">oldValue?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">oldTarget?</span>: <span class="kt">Map</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="err">,</span> <span class="na">unknown</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">Set</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">depsMap</span> <span class="o">=</span> <span class="nx">targetMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depsMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">effects</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">&lt;</span><span class="nt">ReactiveEffect</span><span class="p">&gt;()</span>
  <span class="kr">const</span> <span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="nx">effectsToAdd</span>: <span class="kt">Set</span><span class="p">&lt;</span><span class="nt">ReactiveEffect</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">effectsToAdd</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">effectsToAdd</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">effect</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">effect</span> <span class="o">!==</span> <span class="nx">activeEffect</span> <span class="o">||</span> <span class="nx">effect</span><span class="p">.</span><span class="nx">allowRecurse</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">effects</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">CLEAR</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO collection clear operation
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;length&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// TODO array change operation
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// SET | ADD | DELETE operation
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">depsMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// TODO è¿­ä»£å™¨ keyï¼Œfor...of, ä½¿ç”¨è¿­ä»£å™¨æ˜¯å¯¹æ•°æ®çš„ç›‘å¬å˜åŒ–
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="p">(</span><span class="nx">effect</span>: <span class="kt">ReactiveEffect</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">({</span>
        <span class="nx">effect</span><span class="p">,</span>
        <span class="nx">target</span><span class="p">,</span>
        <span class="nx">key</span><span class="p">,</span>
        <span class="kr">type</span><span class="p">,</span>
        <span class="nx">newValue</span><span class="p">,</span>
        <span class="nx">oldValue</span><span class="p">,</span>
        <span class="nx">oldTarget</span>
      <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">effect</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">effects</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">run</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-20" class="outline-2">
<h2 id="headline-20">
observe object recursively
</h2>
<div id="outline-text-headline-20" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b2143f9e35af77ee43792a6110ea70c4caf9a54f">feat: observe object recursively Â· gcclll/stb-vue-next@b2143f9</a></p>
<p>
é’ˆå¯¹åµŒå¥—å¯¹è±¡è¿›è¡Œé€’å½’ Reactive ã€‚</p>
<p>
<img src="/img/vue3/reactivity/reactivity-basehd-get-03-track-recursively.svg" alt="/img/vue3/reactivity/reactivity-basehd-get-03-track-recursively.svg" title="/img/vue3/reactivity/reactivity-basehd-get-03-track-recursively.svg" /></p>
</div>
</div>
<div id="outline-container-effect-track-trigger" class="outline-2">
<h2 id="effect-track-trigger">
effect -&gt; track -&gt; trigger å…³ç³»å›¾
</h2>
<div id="outline-text-effect-track-trigger" class="outline-text-2">
<p>
åˆ°æ­¤ effect + track + trigger å®Œæˆäº†æœ€ç®€å•çš„å“åº”å¼ä»£ç ã€‚</p>
<p>
<img src="/img/vue3/reactivity/reactivity-effect-track-trigger.svg" alt="/img/vue3/reactivity/reactivity-effect-track-trigger.svg" title="/img/vue3/reactivity/reactivity-effect-track-trigger.svg" /></p>
<ol>
<li>
<p>effect å°è£…æ³¨å†Œå‡½æ•°</p>
</li>
<li>
<p>track å–å€¼è§¦å‘æ”¶é›†ä¾èµ–å‡½æ•°</p>
</li>
<li>
<p>trigger è®¾å€¼è§¦å‘æ‰€æœ‰ä¾èµ–å‡½æ•°æ‰§è¡Œ</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-c-delete" class="outline-2">
<h2 id="c-delete">
add delete(<strong>deleteProperty</strong>) proxy handler
</h2>
<div id="outline-text-c-delete" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/05b98c571560d2c1806d29cdda7b500b4b2bdeac">feat: delete proxy handler Â· gcclll/stb-vue-next@05b98c5</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åˆ é™¤æˆåŠŸï¼Œè§¦å‘ DELETE
</span><span class="c1"></span>    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">object</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="p">,</span>	  <span class="kr">get</span><span class="p">,</span>
  <span class="kr">set</span>	  <span class="kr">set</span><span class="p">,</span>
  <span class="nx">deleteProperty</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
åˆ é™¤æˆåŠŸè°ƒç”¨ <code>trigger()</code> è§¦å‘ <strong>DELETE</strong> ã€‚</p>
</div>
</div>
<div id="outline-container-headline-23" class="outline-2">
<h2 id="headline-23">
add has, ownKeys proxy handlers
</h2>
<div id="outline-text-headline-23" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ab69fe9eecb274f836bf19163636bd8f464b84d1">feat: has + ownKeys proxy handler Â· gcclll/stb-vue-next@ab69fe9</a></p>
<p>
å¢åŠ  has, ownKeys proxy handlers.</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">has</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSymbol</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">builtInSymbols</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">HAS</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ownKeys</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">)</span><span class="o">:</span> <span class="p">(</span><span class="kt">string</span> <span class="o">|</span> <span class="nx">num</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)[]</span> <span class="p">{</span>
  <span class="nx">track</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;length&#39;</span> <span class="o">:</span> <span class="nx">ITERATE_KEY</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="kc">false</span>
<span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">),</span> <span class="p">{</span> <span class="nx">lazy</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before run effect, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">runner</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after run effect, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
before run effect, dummy = false
after run effect, dummy = true
</pre>
</div>
</div>
<div id="outline-container-headline-24" class="outline-2">
<h2 id="headline-24">
<span class="todo">TODO</span>
add array support
</h2>
<div id="outline-text-headline-24" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9aeb678befc3826b2ce8976b62c1172b4800df27">feat: array support Â· gcclll/stb-vue-next@9aeb678</a></p>
<p>
ä¿®æ”¹ç‚¹ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// æ•°ç»„å†…ç½®æ–¹æ³•å¤„ç†
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">arrayInstrumentations</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Function</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">;([</span><span class="s1">&#39;includes&#39;</span><span class="p">,</span> <span class="s1">&#39;indexOf&#39;</span><span class="p">,</span> <span class="s1">&#39;lastIndexOf&#39;</span><span class="p">]</span> <span class="kr">as</span> <span class="kr">const</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="nx">arrayInstrumentations</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="kt">unknown</span><span class="p">[],</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">track</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">res</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="p">;([</span><span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="s1">&#39;unshift&#39;</span><span class="p">,</span> <span class="s1">&#39;splice&#39;</span><span class="p">]</span> <span class="kr">as</span> <span class="kr">const</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="nx">arrayInstrumentations</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="kt">unknown</span><span class="p">[],</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="p">{</span>
    <span class="nx">pauseTracking</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="nx">resetTracking</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">res</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="c1">// createGetter
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">createGetter</span><span class="p">(</span><span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// 4. target is array
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">targetIsArray</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">targetIsArray</span> <span class="o">&amp;&amp;</span> <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">arrayInstrumentations</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">arrayInstrumentations</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>ç´¢å¼•æ“ä½œ(<code>includes, lastIndexOf, indexOf</code>)å¤„ç†</p>
<p>
ç¡®ä¿ç´¢å¼•å–å€¼çš„æ—¶å€™ï¼Œèƒ½ä½¿ç”¨ track() æ­£ç¡®æ”¶é›†å¯¹åº”ç´¢å¼•çš„ä¾èµ–åˆ—è¡¨ã€‚</p>
</li>
<li>
<p>å¯æ”¹å˜åŸæ•°ç»„é•¿åº¦æ“ä½œ(<code>push, pop, shift, unshift, splice</code>)</p>
<p>
å› ä¸ºè¿™äº›å‡½æ•°å†…éƒ¨å®ç°éƒ½éœ€è¦è®¿é—®åŠæ”¹å˜åŸæ•°ç»„çš„é•¿åº¦ï¼Œå› æ­¤è¿™é‡Œéœ€è¦åšä¸€å±‚ä¿æŠ¤ï¼Œå®ƒ
ä»¬æ‰§è¡Œä¹‹å‰ <code>shouldTrack = false</code> ï¼Œæ‰§è¡Œå®Œæˆä¹‹å <code>shouldTrack = true</code> ï¼Œé¿å…
<code>track()</code> æ­»å¾ªç¯ã€‚</p>
</li>
</ol>
<p>
ä¸‹é¢å‡ä¸º vue-next æºç ä¸­ç”¨ä¾‹åˆ†æã€‚</p>
<ul>
<li class="checked">
<p>T1: è¯»å†™æ“ä½œ</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}]</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#01 original !== observed, </span><span class="si">${</span><span class="nx">original</span> <span class="o">!==</span> <span class="nx">observed</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#02 original is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#03 observed is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#04 observed[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">clone</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">slice</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#05 clone[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">clone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#06 clone[0] !== original[0], </span><span class="si">${</span><span class="nx">clone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#07 clone[0] === observed[0], </span><span class="si">${</span><span class="nx">clone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">reactiveValue</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#08 observed[0] === reactiveValue, </span><span class="si">${</span><span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">reactiveValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#09 original[0] === value, </span><span class="si">${</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#10 observed[0] === undefined, </span><span class="si">${</span><span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#11 original[0] === undefined, </span><span class="si">${</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#12 observed[2] === reactiveValue, </span><span class="si">${</span><span class="nx">observed</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">reactiveValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#13 original[2] === value, </span><span class="si">${</span><span class="nx">original</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  +RESULTS:</p>
<pre class="example">
#01 original !== observed, true
#02 original is reactive, false
#03 observed is reactive, true
#04 observed[0] is reactive, true
#05 clone[0] is reactive, true
#06 clone[0] !== original[0], true
#07 clone[0] === observed[0], true
#08 observed[0] === reactiveValue, true
#09 original[0] === value, true
#10 observed[0] === undefined, true
#11 original[0] === undefined, true
#12 observed[2] === reactiveValue, true
#13 original[2] === value, true
</pre>
<p>
  åˆ†æï¼š</p>
<ul>
<li>
<p><strong>#01</strong> å› ä¸º Proxy <a href="https://tc39.es/ecma262/#sec-proxycreate">å†…éƒ¨å®ç°</a>å®é™…ä¼šåˆ›å»ºæ–°å¯¹è±¡</p>
</li>
<li>
<p><strong>#02</strong> è¯»å– <code>__v_isReactive</code> åœ¨ <code>createGetter()</code> é‡Œé¢ä¼šç›´æ¥è¿”å› <code>!isReadonly</code></p>
</li>
<li>
<p><strong>#03</strong> åŒä¸Š</p>
</li>
<li>
<p><strong>#04</strong> å–å€¼çš„æ—¶å€™è¿”å›ç»“æœä¹‹å‰ä¼šæ£€æµ‹å½“å‰æ˜¯ä¸æ˜¯å¯¹è±¡å¦‚æœæ˜¯ä¼šæ‰§è¡Œé€’å½’ reactive</p>
</li>
<li>
<p><strong>#05</strong> slice <a href="/post/javascript-apis/#api-array-slice">å®ç°è¿‡ç¨‹</a>å¹¶éæ·±æ‹·è´</p>
</li>
<li>
<p><strong>#06</strong> å’Œ <code>observed[0] !== original[0]</code> ä¸€ä¸ªåŸå› </p>
</li>
<li>
<p><strong>#07</strong> <a href="/post/javascript-apis/#api-array-slice">æµ…æ‹·è´é—®é¢˜</a></p>
</li>
<li>
<p><strong>#08</strong> å…ˆ <code>observed[0]</code> å¯¹ value å–å€¼æ“ä½œï¼Œæ­¤æ—¶ Reactive value å¯¹è±¡æ—¶ï¼Œå‘ç°è¯¥å¯¹</p>
</li>
</ul>
<p>è±¡å·²ç»æœ‰æ˜ å°„äº†(proxyMap ä¸­å·²å­˜åœ¨ value -&gt; reactiveValue å…³ç³»ã€‚)</p>
<ul>
<li>
<p><strong>#09</strong> proxy çš„æ”¹å˜ä¹Ÿä¼šä½“ç°åœ¨ original å¯¹è±¡ä¸Šã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">{</span>  <span class="p">}</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="p">{})</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">test</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{ value: { test: 1 } }
</pre>
</li>
<li>
<p><strong>#10</strong> åŒä¸Š</p>
</li>
<li>
<p><strong>#11</strong> åŒä¸Š</p>
</li>
<li>
<p><strong>#12</strong> åŒ <strong>#08</strong> <code>proxyMap</code> ä¸­æœ‰ç¼“å­˜äº†</p>
</li>
<li>
<p><strong>#13</strong> åŒä¸Š</p>
</li>
</ul>
</li>
<li class="checked">
<p>T2ï¼šç´¢å¼•æ–¹æ³•(includes, lastIndexOf, indexOf)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([{},</span> <span class="p">{}])</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.indexOf(raw), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.indexOf(raw, 3), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.includes(raw), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.includes(raw, 3), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.lastIndexOf(raw), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.lastIndexOf(raw, 1), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  +RESULTS:</p>
<pre class="example">
arr.indexOf(raw), 2
arr.indexOf(raw, 3), -1
arr.includes(raw), true
arr.includes(raw, 3), false
arr.lastIndexOf(raw), 2
arr.lastIndexOf(raw, 1), -1
</pre>
</li>
<li class="checked">
<p>T3ï¼šæ•°ç»„å…ƒç´ æœ¬èº«å·²ç»æ˜¯ Proxy</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.includes(obj), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: è¿™ä¸ªåº”è¯¥å¾ˆå¥½ç†è§£ï¼Œå¯¹è±¡å·²ç»æ˜¯ proxy ä¹‹åä¸ä¼šå†ç»§ç»­ä»£ç†ï¼Œè€Œæ˜¯è¿”å›
proxyMap ä¸­ç¼“å­˜è¿‡çš„ä»£ç†ç»“æœã€‚</p>
<pre class="example">
arr.includes(obj), true
</pre>
</li>
<li class="indeterminate">
<p>T4: <a href="/post/javascript-apis/#api-array-reverse">reverse</a> æ–¹æ³•ä¹Ÿåº”è¯¥æ˜¯ reactive çš„</p>
<p>
<strong>TODO</strong>: reverse ä¹‹åæ‰¾ä¸åˆ°(<code>indexOf</code>)åŸå§‹å¯¹è±¡äº†ï¼Ÿ</p>
<p>
æ ¹æ® <a href="/post/javascript-apis/#api-array-reverse">reverse()</a> çš„å®ç°åŸç†ï¼Œæœ¬è´¨ä¸Šæ˜¯å…ƒç´ ä¹‹é—´çš„æ›¿æ¢æ“ä½œï¼Œå› æ­¤å¹¶ä¸ä¼šæ”¹å˜æ•°ç»„æˆ–å…ƒ
ç´ æœ¬èº«æ˜¯ proxy æ€§è´¨ï¼Œä¸”å±äºç´¢å¼•èµ‹å€¼æ“ä½œï¼Œå› æ­¤ä¼šè§¦å‘ç´¢å¼•çš„ reactive ç›¸å…³æ“ä½œã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span><span class="p">,</span> <span class="nx">toRaw</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([</span><span class="nx">obj</span><span class="p">,</span> <span class="p">{</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}])</span>
<span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 obj === arr[0], </span><span class="si">${</span><span class="nx">obj</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)))</span> <span class="c1">// index = 0
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 before reverse, index = </span><span class="si">${</span><span class="nx">index</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span> <span class="c1">// #3
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 after reverse, index = </span><span class="si">${</span><span class="nx">index</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 obj === arr[1], </span><span class="si">${</span><span class="nx">obj</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
#1 obj === arr[0], true
#2 before reverse, index = 0
#4 after reverse, index = -1
#5 obj === arr[1], true
undefined
</pre>
<p>
+RESULTS: å¤±è´¥</p>
<pre class="example">
before reverse, index = 0
after reverse, index = -1
[ { b: 2 }, { a: 1 } ]
</pre>
</li>
<li class="checked">
<p>T5: ä½¿ç”¨ <a href="/post/javascript-apis/#api-op-delete">delete</a> åˆ é™¤æ•°ç»„å…ƒç´ æ—¶ä¸åº”è¯¥è§¦å‘ <code>length</code> ä¾èµ–</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, arr = </span><span class="si">${</span><span class="nx">arr</span><span class="si">}</span><span class="sb">, len = </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, arr = </span><span class="si">${</span><span class="nx">arr</span><span class="si">}</span><span class="sb">, len = </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: åˆ é™¤æ“ä½œå¹¶ä¸ä¼šæ”¹å˜æ•°ç»„é•¿åº¦</p>
<pre class="example">
before delete, dummy = 4, arr = 1,2,3, len = 3
after delete, dummy = 4, arr = 1,,3, len = 3
undefined
</pre>
<blockquote>
<p>PS: èµ‹å€¼å·²æœ‰çš„ä¸‹æ ‡å…ƒç´ å€¼ã€æ·»åŠ éæ­£æ•´æ•°ç±»å‹çš„å±æ€§åˆ°æ•°ç»„ä¸Šéƒ½ä¸ä¼šè§¦å‘ <code>length</code> ä¾
èµ–ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰æ”¹å˜æ•°ç»„é•¿åº¦ã€‚</p>
</blockquote>
</li>
<li class="checked">
<p>T6: åœ¨ effect fn ä¸­ä½¿ç”¨ <code>for ... in</code> è¿­ä»£è¯­å¥åº”è¯¥ <em>track length</em></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">array</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">nums</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">len</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">len</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">len</span> <span class="o">+=</span> <span class="nx">key</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before push, len = </span><span class="si">${</span><span class="nx">len</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after push, len = </span><span class="si">${</span><span class="nx">len</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
before push, len = 0
after push, len = 01
undefined
</pre>
<p>
+RESULTS: è¾“å‡ºæ˜¾ç¤ºï¼Œlength ä¾èµ–å·²ç» track åˆ°äº†ï¼Œåªæ˜¯ Length å˜åŒ–å¹¶æ²¡æœ‰è§¦å‘</p>
<pre class="example">
Map(1) {
  &#39;length&#39; =&gt; Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  }
}
before push, len = 0
after push, len = 0
</pre>
<blockquote>
<p>FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/21b4881a906d5e6f2def3a7e486934af6009e93a">feat(add): array add element support Â· gcclll/stb-vue-next@21b4881</a></p>
</blockquote>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-25" class="outline-2">
<h2 id="headline-25">
array add element support
</h2>
<div id="outline-text-headline-25" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/21b4881a906d5e6f2def3a7e486934af6009e93a">feat(add): array add element support Â· gcclll/stb-vue-next@21b4881</a></p>
<p>
å¢åŠ æ·»åŠ æ•°ç»„å…ƒç´ æ”¯æŒã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p><code>createGetter -&gt; get</code> proxy handler ä¸­å¢åŠ å±æ€§æ·»åŠ  trigger æ“ä½œ</p>
<p>
<code>trigger(target, TriggerOpTypes.ADD, key, value)</code></p>
</li>
<li>
<p>effect.ts -&gt; <code>trigger()</code> ä¸­å¢åŠ æ•°ç»„é•¿åº¦å˜æ›´ä¾èµ–æ”¶é›†å’Œ <code>ADD</code> æ“ä½œä¾èµ–æ”¶é›†</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201118105046.png" alt="http://qiniu.ii6g.com/img/20201118105046.png" title="http://qiniu.ii6g.com/img/20201118105046.png" /></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-26" class="outline-2">
<h2 id="headline-26">
add shallow reactive
</h2>
<div id="outline-text-headline-26" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e85dfc630c3374aa6452891784cc58ffdc5895c6">feat(add): shallowReactive api Â· gcclll/stb-vue-next@e85dfc6</a></p>
<p>
æ­£å¸¸ track è¿‡ç¨‹ä¸­ä¼šæ£€æµ‹åµŒå¥—å†…çš„æ˜¯ä¸æ˜¯å¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡ä¼šè¿›è¡Œé€’å½’ reactive è®©å†…éƒ¨åµŒå¥—çš„å¯¹è±¡ä¹Ÿ reactive åŒ–ã€‚</p>
<p>
shallow reactive æ„æ€æ˜¯å½“å¯¹è±¡å­˜åœ¨åµŒå¥—çš„æ—¶å€™ï¼Œä¸è¿›è¡Œé€’å½’ reactive ã€‚</p>
<p>
è¿™ä¸ªé€šè¿‡åœ¨ track() å‡½æ•°ä¸­åšä¸€æ¬¡æ‹¦æˆªå¤„ç†ã€‚</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReactive</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`props.n is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">props2</span> <span class="o">=</span> <span class="nx">shallowReactive</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span> <span class="p">})</span>
<span class="nx">props2</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">2</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`props2.n is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">props2</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// array test
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">shallowArray</span> <span class="o">=</span> <span class="nx">shallowReactive</span><span class="p">([])</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">let</span> <span class="nx">size</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">size</span> <span class="o">=</span> <span class="nx">shallowArray</span><span class="p">.</span><span class="nx">length</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; array`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before push a, size = </span><span class="si">${</span><span class="nx">size</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">shallowArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after push a, size = </span><span class="si">${</span><span class="nx">size</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">shallowArray</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after pop, size = </span><span class="si">${</span><span class="nx">size</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; è¿­ä»£æ—¶ä¸åº”è§‚å¯Ÿ`</span><span class="p">)</span>
<span class="nx">shallowArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">spreadA</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">shallowArray</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">// è¿­ä»£ä¹Ÿæœ‰å–å€¼è¿‡ç¨‹ï¼Œshallow = true ä¸ä¼šé€’å½’ reactive
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`spreadA is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">spreadA</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; onTrack`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">onTrackFn</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;on tracking...&#39;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">b</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">shallowArray</span><span class="p">)</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nx">onTrack</span><span class="o">:</span> <span class="nx">onTrackFn</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: <a href="/post/javascript-apis/#api-array-from">Array.from</a> æœ¬è´¨æ˜¯è¿­ä»£å™¨æ“ä½œï¼Œæ‰€ä»¥ä¼šè§¦å‘è¿­ä»£å™¨ tracking ã€‚</p>
<pre class="example">
props.n is reactive, false
props2.n is reactive, true
&gt;&gt; array
before push a, size = 0
after push a, size = 1
after pop, size = 0
&gt;&gt; è¿­ä»£æ—¶ä¸åº”è§‚å¯Ÿ
spreadA is reactive, false
&gt;&gt; onTrack
on tracking...
on tracking...
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-27" class="outline-2">
<h2 id="headline-27">
add readonly reactive
</h2>
<div id="outline-text-headline-27" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/66e7903568bf7d5bce0faca2f85e80c36399bc66">feat(add): readonly reactive Â· gcclll/stb-vue-next@66e7903</a></p>
<div id="outline-container-headline-28" class="outline-4">
<h4 id="headline-28">
æµ‹è¯•(for <code>Object</code>)ï¼š
</h4>
<div id="outline-text-headline-28" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">readonly</span><span class="p">,</span>
  <span class="nx">isProxy</span><span class="p">,</span>
  <span class="nx">isReadonly</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should make nested values readonly`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">wrapped</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped !== original, </span><span class="si">${</span><span class="nx">wrapped</span> <span class="o">!==</span> <span class="nx">original</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is proxy, </span><span class="si">${</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped.bar is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped.bar is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original.bar is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original.bar is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; get`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped.foo = </span><span class="si">${</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; has`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&#39;foo&#39; in wrapped, </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">wrapped</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; ownKeys`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Object.keys(wrapped), [</span><span class="si">${</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; set or delete, should fail`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">qux</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">(</span><span class="s1">&#39;qux&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">bar</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">baz</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">},</span>
  <span class="p">[</span><span class="nx">qux</span><span class="p">]</span><span class="o">:</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">wrapped2</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">(</span><span class="nx">original2</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">// fail
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.foo = 2&#39;,  wrapped2.foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.bar.baz = 3&#39;, wrapped2.bar.baz = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2[qux] = 4&#39;,  wrapped2[qux] = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="k">delete</span> <span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;delete wrapped2.foo&#39;, wrapped2.foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;delete wrapped2.bar.baz&#39;, wrapped2.bar.baz = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;delete wrapped2[qux]&#39;, wrapped2[qux] = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: readonly ä¼šé€’å½’åµŒå¥—å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒå†…éƒ¨çš„å¯¹è±¡éƒ½ä¼šæ˜¯ readonlyã€‚</p>
<pre class="example">
&gt;&gt;&gt; should make nested values readonly
wrapped !== original, true
wrapped is proxy, true
wrapped is reactive, false
wrapped is readonly, true
original is reactive, false
original is readonly, false
wrapped.bar is reactive, false
wrapped.bar is readonly, true
original.bar is reactive, false
original.bar is readonly, false
&gt;&gt; get
wrapped.foo = 1
&gt;&gt; has
&#39;foo&#39; in wrapped, true
&gt;&gt; ownKeys
Object.keys(wrapped), [foo,bar]
&gt;&gt; set or delete, should fail
after &#39;wrapped2.foo = 2&#39;,  wrapped2.foo = 1
after &#39;wrapped2.bar.baz = 3&#39;, wrapped2.bar.baz = 2
after &#39;wrapped2[qux] = 4&#39;,  wrapped2[qux] = 3
after &#39;delete wrapped2.foo&#39;, wrapped2.foo = 1
after &#39;delete wrapped2.bar.baz&#39;, wrapped2.bar.baz = 2
after &#39;delete wrapped2[qux]&#39;, wrapped2[qux] = 3
</pre>
</div>
</div>
<div id="outline-container-headline-29" class="outline-4">
<h4 id="headline-29">
æµ‹è¯•(for <code>Array</code>):
</h4>
<div id="outline-text-headline-29" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">readonly</span><span class="p">,</span>
  <span class="nx">isReadonly</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">isProxy</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should make nested values readonly`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}]</span>
<span class="kr">const</span> <span class="nx">wrapped</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped !== original`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is proxy, </span><span class="si">${</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped[0] is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original[0] is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; get`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped[0].foo = </span><span class="si">${</span><span class="nx">wrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; has`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`0 in wrapped, </span><span class="si">${</span><span class="mi">0</span> <span class="k">in</span> <span class="nx">wrapped</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; ownKeys`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Object.keys(wrapped) = [</span><span class="si">${</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">wrapped2</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">([{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}])</span>
<span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2[0] = 1&#39;, wrapped2[0] = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2[0].foo = 2&#39;, wrapped2[0].foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.length = 0&#39;, wrapped2.length = </span><span class="si">${</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.length = 0&#39;, wrapped2[0].foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.push(2)&#39;, wrapped2.length = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; should make nested values readonly
wrapped !== original
wrapped is proxy, true
wrapped is reactive, false
wrapped is readonly, true
original is reactive, false
original is readonly, false
wrapped[0] is reactive, false
wrapped[0] is readonly, true
original[0] is reactive, false
original[0] is readonly, false
&gt; get
wrapped[0].foo = 1
&gt; has
0 in wrapped, true
&gt; ownKeys
Object.keys(wrapped) = [0]
after &#39;wrapped2[0] = 1&#39;, wrapped2[0] = [object Object]
after &#39;wrapped2[0].foo = 2&#39;, wrapped2[0].foo = 1
after &#39;wrapped2.length = 0&#39;, wrapped2.length = 1
after &#39;wrapped2.length = 0&#39;, wrapped2[0].foo = 1
after &#39;wrapped2.push(2)&#39;, wrapped2.length = 1
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-30" class="outline-4">
<h4 id="headline-30">
æµ‹è¯•(reactive, readonly äº’æ’©)
</h4>
<div id="outline-text-headline-30" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">readonly</span><span class="p">,</span>
  <span class="nx">isReadonly</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">toRaw</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`*#1* isReadonly(b), </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`*#2* toRaw(a) === toRaw(b), </span><span class="si">${</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`*#3* a === b, </span><span class="si">${</span> <span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span> <span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
*#1* isReadonly(b), true
*#2* toRaw(a) === toRaw(b), true
*#3* a === b, true
undefined
</pre>
<ol>
<li>
<p><strong>#1</strong> b is readonly: <code>createReactive</code> ä¸­çš„å¤„ç†</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">Raw</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_REACTIVE</span><span class="p">]))</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">target</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¸Šé¢çš„å¤„ç†é’ˆå¯¹ <code>b = reactive(a)</code> æœ‰ï¼š</p>
<p>
a æ»¡è¶³ target[ReactiveFlags.Raw] å› ä¸ºå®ƒæ˜¯ readonly çš„.</p>
<p>
isReadonly = false</p>
<p>
target[ReactiveFlags.IS_REACTIVE] ä¸æ»¡è¶³</p>
<p>
å› æ­¤ä¸Šé¢çš„åˆ¤æ–­æ»¡è¶³ <code>target[ReactiveFlags.RAW] &amp;&amp;
!target[ReactiveFlags.IS_REACTIVE]</code> ç›´æ¥è¿”å› target ã€‚</p>
</li>
<li>
<p><strong>#2</strong> <code>toRaw(a) === toRaw(b)</code> è¿™ä¸ªç»“æœä¸º trueï¼Œå› ä¸º <strong>#1</strong> ä¸­çš„åŸå› ï¼Œç›´æ¥è¿”å›äº† targetï¼Œ
æ‰€ä»¥ b å®é™…ä¸Šå°±æ˜¯ a(å¦‚ç»“æœ <strong>#3</strong>)</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-31" class="outline-2">
<h2 id="headline-31">
add shallow readonly reactive
</h2>
<div id="outline-text-headline-31" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/aaaf911eb88c75935970e51f843a88f6a3a3c6d6">feat(add): shallow readonly reactive Â· gcclll/stb-vue-next@aaaf911</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201119153149.png" alt="http://qiniu.ii6g.com/img/20201119153149.png" title="http://qiniu.ii6g.com/img/20201119153149.png" /></p>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">shallowReadonly</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="c1">// åµŒå¥—å¯¹è±¡ä¸åº”è¯¥ reactive
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should not make non-reactive properties reactive`</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReadonly</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="p">{</span><span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`isReactive(props.n), </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// æ ¹å±æ€§åº”è¯¥æ˜¯ readonly
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should make root level properties readonly`</span><span class="p">)</span>
<span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReadonly</span><span class="p">({</span><span class="nx">n</span> <span class="o">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="nx">props</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;props.n = 2&#39;, props.n = </span><span class="si">${</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="c1">// åµŒå¥—çš„å±æ€§ä¸åº”è¯¥æ˜¯ readonly ï¼Œå› ä¸ºæ˜¯ shallow
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should NOT make nested properties readonly`</span><span class="p">)</span>
<span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReadonly</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;props.n.foo = 2&#39;, props.n.foo = </span><span class="si">${</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; should not make non-reactive properties reactive
isReactive(props.n), false
&gt;&gt;&gt; should make root level properties readonly
after &#39;props.n = 2&#39;, props.n = 1
&gt;&gt;&gt; should NOT make nested properties readonly
after &#39;props.n.foo = 2&#39;, props.n.foo = 2
undefined
</pre>
<p>
è¿™é‡Œçš„ç»“æœä¸éš¾ç†è§£</p>
<ol>
<li>
<p>shallow ä¸ä¼šé€’å½’ reactive</p>
</li>
<li>
<p>readonly è®©å±æ€§åªè¯»ï¼Œä½†æ˜¯ç”±äºæ˜¯ shallow æ‰€ä»¥åªæœ‰å¯¹è±¡æ ¹å±æ€§æ‰æ˜¯åªè¯»</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-32" class="outline-2">
<h2 id="headline-32">
add effect stop
</h2>
<div id="outline-text-headline-32" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f1e5b3afb88d41d065f1c797f5db66ac7c65339f">feat(add): effect stop Â· gcclll/stb-vue-next@f1e5b3a</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201119162119.png" alt="http://qiniu.ii6g.com/img/20201119162119.png" title="http://qiniu.ii6g.com/img/20201119162119.png" /></p>
<p>
stop() å‡½æ•°æ“ä½œï¼š</p>
<ol>
<li>
<p>æ¸…ç©ºæ‰€æœ‰ effect ä¸Šçš„ depsï¼ŒåŒæ—¶å°†å½“å‰çš„ effect ä»æ‰€æœ‰ä¾èµ–å®ƒçš„ dep ä¸­åˆ é™¤</p>
<p>
<code>effect.deps[i].delete(effect)</code> , è¿™ä¸€æ­¥æ˜¯å°† <code>targetMap &gt; depsMap &gt; deps</code> ä¸­
çš„ effect åˆ é™¤ã€‚</p>
<p>
<code>effect.deps.length = 0</code></p>
</li>
<li>
<p>å°† effect.active ç½®ä¸º false</p>
</li>
</ol>
<p>
æ‰§è¡Œ <code>stop()</code> ä¹‹åï¼Œåªèƒ½æ‰‹åŠ¨è°ƒç”¨ <code>runner()</code> æ¥è§¦å‘ effect fn(å‰ææ˜¯æ²¡æœ‰æä¾›
<code>options.scheduler</code> ï¼Œå¦åˆ™æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ) ã€‚</p>
<p>
è¢« stopped çš„ effect å¯ä»¥å½“åšå¦ä¸€ä¸ªæ­£å¸¸çš„ effect çš„ fnã€‚</p>
</div>
</div>
<div id="outline-container-headline-33" class="outline-2">
<h2 id="headline-33">
é›†åˆç±»å‹ä»£ç†(proxy handlers)è„‘å›¾
</h2>
<div id="outline-text-headline-33" class="outline-text-2">
<p><img src="/img/vue3/reactivity/reactivity-collection-proxy.svg" alt="/img/vue3/reactivity/reactivity-collection-proxy.svg" title="/img/vue3/reactivity/reactivity-collection-proxy.svg" /></p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-2">
<h2 id="headline-34">
add collection handlers
</h2>
<div id="outline-text-headline-34" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/521f755fd403d5f0431bcafd1737f1d988ce0825">feat(add): mutable collection handlers Â· gcclll/stb-vue-next@521f755</a></p>
<p>
<a href="#whole-collection">collection proxy handlers è„‘å›¾é“¾æ¥</a></p>
<p>
å› ä¸º Reflect æ²¡æœ‰é›†åˆæ“ä½œçš„å¯¹åº”æ¥å£ï¼Œæ‰€ä»¥é’ˆå¯¹é›†åˆç±»å‹éœ€è¦é€šè¿‡ <code>get proxy</code> æ¥ä¸­è½¬
åšç‰¹æ®Šå¤„ç†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span> <span class="nx">shallow</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableCollectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">CollectionTypes</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// get: createInstrumentationGetter(false, false)
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ·»åŠ é›†åˆç±»å‹çš„ handlersã€‚</p>
</div>
</div>
<div id="outline-container-headline-35" class="outline-2">
<h2 id="headline-35">
add collection get proxy handler
</h2>
<div id="outline-text-headline-35" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a5e8e062658d458081ce1bb499b8041f6175689e">feat(add): collection get proxy Â· gcclll/stb-vue-next@a5e8e06</a></p>
<p>
é’ˆå¯¹é›†åˆçš„æ‰€æœ‰æ“ä½œä»£ç†éƒ½æ˜¯é€šè¿‡ get proxy å˜ç›¸å®Œæˆçš„ï¼Œæ‰€ä»¥ææ‡‚è¿™é‡Œæ˜¯è‡³å…³é‡è¦çš„ã€‚</p>
<p>
collection proxy handler:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableCollectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">CollectionTypes</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç®€å•å§ï¼Œåˆ«è¢«å‡ğŸ˜ç»™è¿·æƒ‘äº†ï¼ï¼ï¼</p>
<p>
è¿™é‡Œçš„åŸç†å¦‚æœæƒ³é€šäº†ä¹Ÿç®€å•ã€‚</p>
<p>
è¯•æƒ³ä¸‹ï¼Œæˆ‘ä»¬è°ƒç”¨é›†åˆç±»å‹çš„æ–¹æ³•æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>
<code>map.get()</code>, <code>map.set()</code>, <code>map.delete()</code>, <code>...</code></p>
<p>
éƒ½æ˜¯é€šè¿‡ç‚¹è¯­æ³•ä½¿ç”¨çš„ï¼Œç‚¹è¯­æ³•å‰æä¹Ÿå¿…é¡»æ˜¯å…ˆå–å‡ºå€¼æ¥è¿›è¡Œæ“ä½œï¼Œå³è¦è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œå…ˆ
å°†æ–¹æ³•å–å‡ºæ¥ï¼Œå› æ­¤è¿™é‡Œå°±æ˜¯å–å€¼æ“ä½œã€‚</p>
<p>
ä»è¿™ä¸€ä¸ªå±‚çº§ä¸Šå»ç†è§£å»å®ç°ï¼Œå°±å¯ä»¥é€šè¿‡é›†åˆçš„ <code>proxy get</code> æ¥å˜ç›¸å®ç°æ‰€æœ‰é›†åˆçš„æ–¹
æ³•å’Œå±æ€§ä»£ç†ã€‚</p>
<p>
æ³¨æ„ <code>Reflect.get(target, key, receiver)</code> ç¬¬ä¸€ä¸ªä¼ çš„æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>
<code>boolean ? instrumentations : target</code> å³å°è£…åçš„ <code>instrumentations</code> å•Š !</p>
<p>
å¦‚ï¼š <code>map.get()</code> -&gt; <code>target: map, key: get</code> -&gt; <code>target: instumentations, key:
get</code> -&gt; <code>get(target, key, isReadonly, isShallow)</code></p>
<p>
é›†åˆçš„æ“ä½œæœ€ç»ˆ â€”â€“&gt; è½¬å˜æˆ instrumentations å¯¹è±¡ä¸Šçš„æ“ä½œã€‚</p>
<blockquote>
<p>å»æ‰æš‚æ—¶ä¸éœ€è¦çš„ä»£ç (<a href="https://github.com/gcclll/stb-vue-next/commit/65ea709dac46e4310eb2ac95cb19984d9b921d88">65ea709</a>)ï¼š</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/65ea709dac46e4310eb2ac95cb19984d9b921d88">feat: add get proxy handler Â· gcclll/stb-vue-next@65ea709</a></p>
</blockquote>
<div id="outline-container-key-collection-proxy-get" class="outline-3">
<h3 id="key-collection-proxy-get">
å®ç°é¡ºåº(åŸç†)
</h3>
<div id="outline-text-key-collection-proxy-get" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 1. å¯¹å¤–çš„ handlers
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableCollectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">CollectionTypes</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1">// 2. å°è£… get proxy æ‰€æœ‰ collection æ“ä½œçš„å…¥å£
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span> <span class="nx">shallow</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">instrumentations</span> <span class="o">=</span> <span class="nx">mutableInstrumentations</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">target</span>: <span class="kt">CollectionTypes</span><span class="p">,</span>
    <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span>
    <span class="nx">receiver</span>: <span class="kt">CollectionTypes</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_REACTIVE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">isReadonly</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">isReadonly</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">target</span>
    <span class="p">}</span>

    <span class="c1">// å°†é›†åˆæ“ä½œä»£ç†åˆ° instrumentations å¯¹è±¡ä¸Š
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span>
      <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">instrumentations</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">target</span>
        <span class="o">?</span> <span class="nx">instrumentations</span>
        : <span class="kt">target</span><span class="p">,</span>
      <span class="nx">key</span><span class="p">,</span>
      <span class="nx">receiver</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 3. map -&gt; instrumentations -&gt; proxy ä¸­é—´å¯¹è±¡
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">mutableInstrumentations</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Function</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// get proxy handler, this -&gt; target
</span><span class="c1"></span>  <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// 4. æœ€ç»ˆæ‰§è¡Œæ“ä½œå¾—åˆ°ç»“æœçš„å‡½æ•°
</span><span class="c1"></span><span class="kd">function</span> <span class="kr">get</span><span class="p">(</span>
  <span class="nx">target</span>: <span class="kt">MapTypes</span><span class="p">,</span>
  <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">isShallow</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span> <span class="p">})</span>
  <span class="k">return</span> <span class="nx">target</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>ç†è§£è¿‡ç¨‹ï¼š</p>
<p>
é¦–å…ˆè¦ç†è§£æ‰§è¡Œè¿™ä¸€å¥ <code>map.get(&#39;foo&#39;)</code> å‘ç”Ÿäº†ä»€ä¹ˆ</p>
<ol>
<li>
<p>é¦–å…ˆæ˜¯ <code>map.get</code> å–å€¼æ“ä½œï¼Œå³ <code>createInstrumentationGetter()</code> æœ€å return çš„
é‚£ä¸€å¥</p>
<p>
å…¶å®æ˜¯é’ˆå¯¹ <code>map.get</code> æ“ä½œçš„ä»£ç†ï¼Œå°† &#34;get&#34; æ–¹æ³•ä» <strong>map</strong> å¯¹è±¡ä¸­å–å‡ºæ¥çš„ä»£ç†ã€‚</p>
<p>
æ‰€ä»¥ <code>Reflect.get(target, key, receiver)</code> è¿™é‡Œçš„ <code>key = &#34;foo&#34;</code></p>
</li>
<li>
<p>ç»è¿‡ <strong>#1</strong> ä¹‹åï¼Œéœ€è¦ç«‹å³æ‰§è¡Œ &#34;get&#34; æ–¹æ³•å³ <code>()</code> æ“ä½œ</p>
<p>
æ­¤æ—¶æ‰§è¡Œçš„æ˜¯ <code>mutableInstrumentations.get(this, key)</code> æ–¹æ³•</p>
<p>
æ‰€ä»¥è¿™é‡Œçš„ <code>key = &#39;foo&#39;</code> , <code>this</code> å°±æ˜¯è°ƒç”¨ <code>get()</code> æ–¹æ³•çš„å¯¹è±¡ <strong>map</strong> ã€‚ </p>
</li>
<li>
<p>æœ€å get æ“ä½œä¼šè¢«æ¨¡å—å…¨å±€å‡½æ•° <code>get(target, key, isReadonly, isShallow)</code> ä»£æ›¿ï¼Œ
åšäº†è®¸å¤šç‰¹æ®Šå¤„ç†ï¼Œæ”¶é›†ä¾èµ–ã€‚</p>
</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-headline-37" class="outline-3">
<h3 id="headline-37">
<a href="https://github.com/gcclll/stb-vue-next/commit/12bc4da85edd0bfee3785ef3dfb77c3f52ef33cd">12bc4da</a> add get handler
</h3>
<div id="outline-text-headline-37" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/12bc4da85edd0bfee3785ef3dfb77c3f52ef33cd">feat(add): get function for collection proxy Â· gcclll/stb-vue-next@12bc4da</a></p>
<p>
<strong>FIX</strong>: <a href="https://github.com/gcclll/stb-vue-next/commit/edc1d3f701e744a2b33e9ad5352597519cc06106">edc1d3f</a> æ­»å¾ªç¯é—®é¢˜(ç›´æ¥æ”¾å› target.get(key) åˆä¼šè§¦å‘ get -&gt; â€¦)
<a href="https://github.com/gcclll/stb-vue-next/commit/edc1d3f701e744a2b33e9ad5352597519cc06106">fix: infinite loop Â· gcclll/stb-vue-next@edc1d3f</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">res</span> <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{
  key: &#39;get&#39;,
  target: Map(1) { &#39;foo&#39; =&gt; 1 },
  x: &#39;in createInstrumentationsGetter&#39;
}
{ key: &#39;foo&#39;, target: Map(1) { &#39;foo&#39; =&gt; 1 }, x: &#39;in get&#39; }
{ res: 100 }
</pre>
<p>
ç»“æœå¦‚ä¸Š(å‚è§.<a href="#key-collection-proxy-get">åŸç†è¯¦ç»†åˆ†æ</a>)</p>
<ol>
<li>
<p>reactive(map) -&gt; å°† map ä»£ç†ç»™ <code>instrumentations{ get }</code></p>
</li>
<li>
<p>observed.get -&gt; å¾—åˆ° instrumentations é‡Œé¢çš„ &#34;get&#34; æ–¹æ³•</p>
</li>
<li>
<p>(&#39;foo&#39;) -&gt; æ‰§è¡Œ <code>instrumentations.get(this, key)</code>, <em>key = &#39;foo&#39;</em></p>
</li>
<li>
<p>è¿”å›ç»“æœ</p>
</li>
</ol>
<blockquote>
<p>è‡³æ­¤ï¼Œå®Œæˆ collection get proxy handler çš„å®Œæ•´æµç¨‹ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-38" class="outline-3">
<h3 id="headline-38">
<a href="https://github.com/gcclll/stb-vue-next/commit/0b3fd712f72ddeda7c4bf5252624545650c1601b">0b3fd71</a> add get handler track
</h3>
<div id="outline-text-headline-38" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0b3fd712f72ddeda7c4bf5252624545650c1601b">feat(add): collection proxy get -&gt; global get Â· gcclll/stb-vue-next@0b3fd71</a></p>
<p>
æ–°å¢get æ“ä½œï¼Œtrack æ·»åŠ ä¾èµ–ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{
  key: &#39;get&#39;,
  target: Map(1) { &#39;foo&#39; =&gt; 1 },
  x: &#39;in createInstrumentationGetter&#39;
}
{
  key: &#39;foo&#39;,
  type: &#39;get&#39;,
  dep: Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  },
  x: &#39;in track&#39;
}
{ key: &#39;foo&#39;, target: Map(1) { &#39;foo&#39; =&gt; 1 }, x: &#39;in global get&#39; }
dummy = 100
</pre>
<p>
åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ</p>
<ol>
<li>
<p>collection proxy handler å–  map.get æ–¹æ³•, <code>key = &#39;get&#39;</code></p>
</li>
<li>
<p><code>(&#39;prop&#39;)</code> æ‰§è¡ŒæœŸè§¦å‘ <code>instrumentations.get(this, key), key = &#39;foo&#39;</code></p>
</li>
<li>
<p>æ‰§è¡Œ global get è§¦å‘ <code>track</code> æ”¶é›†ä¾èµ–ï¼Œè¿”å›ç»“æœå€¼</p>
</li>
</ol>
<p>
å‡è®¾ <code>map.get(key)</code> çš„ key ä¹Ÿæ˜¯ä¸ª proxy :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">k</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">v</span><span class="o">:</span> <span class="mi">2</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]]))</span>

<span class="nx">effect</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span> <span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{ #1
  key: &#39;get&#39;,
  target: Map(1) { { k: 1 } =&gt; { v: 2 } },
  x: &#39;in createInstrumentationGetter&#39;
}
#2
{ key: { k: 1 }, rawKey: { k: 1 }, eq: false }
{ #3
  key: { k: 1 },
  type: &#39;get&#39;,
  dep: Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  },
  x: &#39;in track&#39;
}
{ #4
  key: { k: 1 },
  type: &#39;get&#39;,
  dep: Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  },
  x: &#39;in track&#39;
}
{ #5
  key: { k: 1 },
  target: Map(1) { { k: 1 } =&gt; { v: 2 } },
  x: &#39;in global get&#39;
}
dummy = 100
</pre>
<ol>
<li>
<p><strong>#1</strong> proxy collection get handler</p>
</li>
<li>
<p><strong>#2</strong> global get å‡½æ•°é‡Œè°ƒç”¨ track ä¹‹å‰è¾“å‡ºï¼Œæ˜¾ç¤º <code>key</code> å’Œ <code>rawKey</code> æ˜¯ä¸åŒçš„
(<code>eq = false</code>)ï¼Œå› ä¸ºå‰è€…æ˜¯ä¸ª proxy åè€…æ˜¯ key proxy çš„ rawValue ã€‚</p>
</li>
<li>
<p><strong>#3</strong> track() è°ƒç”¨æ—¶çš„è¾“å‡ºï¼Œæ˜¾ç¤ºçš„æ˜¯éœ€è¦æ”¶é›†ä¾èµ–çš„æ˜¯ <code>proxy key{k: 1}</code> </p>
</li>
<li>
<p><strong>#4</strong> track() è°ƒç”¨æ—¶çš„è¾“å‡ºï¼Œæ˜¾ç¤ºçš„æ˜¯éœ€è¦æ”¶é›†ä¾èµ–çš„æ˜¯ <code>raw key{k: 1}</code></p>
</li>
</ol>
<p>
ä» <strong>#3</strong>, <strong>#4</strong> å¯çŸ¥å¦‚æœ key æœ¬èº«å·²ç»æ˜¯ proxy é‚£ä¹ˆå®ƒåŠå…¶å¯¹åº”çš„ rawKey åŒæ—¶ä¹Ÿä¼šæ”¶é›†
å½“å‰çš„ effect ã€‚</p>
</div>
</div>
<div id="outline-container-headline-39" class="outline-3">
<h3 id="headline-39">
<a href="https://github.com/gcclll/stb-vue-next/commit/77b14ef019cd320bc04f1c861424db79bcc82f9f">77b14ef</a> add get handler return value
</h3>
<div id="outline-text-headline-39" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/77b14ef019cd320bc04f1c861424db79bcc82f9f">feat(add): collection proxy get with value return Â· gcclll/stb-vue-next@77b14ef</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201121095654.png" alt="http://qiniu.ii6g.com/img/20201121095654.png" title="http://qiniu.ii6g.com/img/20201121095654.png" /></p>
<p>
è¿™é‡Œå¤„ç†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>
<p>å–å‡º <code>has</code> æ–¹æ³•æ£€æµ‹å­˜åœ¨æ€§</p>
</li>
<li>
<p>æ ¹æ® <code>isReadonly</code> å’Œ <code>isShallow</code> å†³å®šå¯¹è¿”å›å€¼åšä»€ä¹ˆå¤„ç†ï¼Œå¦‚ï¼šé€’å½’ reactive/readonly</p>
</li>
<li>
<p>ä½¿ç”¨ target.get(key) å–å‡ºç»“æœå€¼è¿”å›</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-40" class="outline-2">
<h2 id="headline-40">
add collection set proxy handler
</h2>
<div id="outline-text-headline-40" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7b680df94e359c208697111319eda9ee75560b11">feat(add): collection set proxy handler Â· gcclll/stb-vue-next@7b680df</a></p>
<p>
set proxy handler å¤„ç†</p>
<ol>
<li>
<p>è®¾å€¼çš„æ—¶å€™å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µ a) set, b) add</p>
</li>
<li>
<p>éœ€è¦è€ƒè™‘ proxy key å’Œ raw key é—®é¢˜</p>
</li>
<li>
<p>æœ€å trigger è§¦å‘ä¾èµ–</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kd">function</span> <span class="kr">set</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">has</span><span class="p">,</span> <span class="kr">get</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">getProto</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>

  <span class="kd">let</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="c1">// è€ƒè™‘ key å¯èƒ½æ˜¯ proxy
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// to add
</span><span class="c1"></span>    <span class="nx">key</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">checkIdentityKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">has</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="kr">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="c1">// è®¾å€¼ç»“æœ
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ·»åŠ æ“ä½œ
</span><span class="c1"></span>    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// è®¾å€¼æ“ä½œ
</span><span class="c1"></span>    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>


<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; before get, deps`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">map</span><span class="p">))</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; after get, deps`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">map</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt; before get, deps
undefined
&gt; after get, deps
&lt;ref *1&gt; Set(1) {
  [Function: reactiveEffect] {
    id: 0,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1] ],
    options: {}
  }
}
#1 before set, dummy = undefined
#2 after set, dummy = 1
</pre>
</div>
</div>
<div id="outline-container-headline-41" class="outline-2">
<h2 id="headline-41">
add collection size,has,add proxy handler
</h2>
<div id="outline-text-headline-41" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/73fa5ebf7f0dcdaa11bbf42df89c7f7c1ab88385">feat(add): size, has, add collection proxy handlers Â· gcclll/stb-vue-next@73fa5eb</a></p>
<p>
has: proxy key, raw key éƒ½éœ€è¦ track has æ“ä½œä¾èµ–</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">has</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">CollectionTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
  <span class="kr">const</span> <span class="nx">rawTarget</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">rawKey</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="nx">rawKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">HAS</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">HAS</span><span class="p">,</span> <span class="nx">rawKey</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">key</span> <span class="o">===</span> <span class="nx">rawKey</span>
    <span class="o">?</span> <span class="nx">target</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="o">:</span> <span class="nx">target</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">rawKey</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
size: å–size å†…éƒ¨å®ç°è¿‡ç¨‹ä¸­æ˜¯éœ€è¦å¯¹ collection è¿›è¡Œè¿­ä»£æ“ä½œçš„ï¼Œæ‰€ä»¥ track ç”¨çš„æ˜¯ <code>ITERATE_KEY</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">size</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">IterableCollections</span><span class="p">,</span> <span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
  <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span> <span class="nx">ITERATE_KEY</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
add: set.add æ“ä½œï¼Œæ ¹æ® set ç‰¹æ€§ï¼Œkey,value éƒ½æ˜¯åŒä¸€ä¸ªä¸”å…ƒç´ æ˜¯ä¸é‡å¤çš„ï¼Œæ‰€ä»¥åªéœ€
è¦æ£€æµ‹æ˜¯ä¸æ˜¯æ–°å¢ï¼Œæ–°å¢å°±éœ€è¦ trigger ADD ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">SetTypes</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">proto</span> <span class="o">=</span> <span class="nx">getProto</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="c1">// å› ä¸º set æ˜¯ä¸ä¼šå­˜åœ¨é‡å¤å…ƒç´ çš„ï¼Œæ‰€ä»¥åªä¼šåœ¨æ²¡æœ‰å½“å‰ key çš„æƒ…å†µä¸‹æ‰ä¼šæ‰§è¡Œ
</span><span class="c1"></span>  <span class="c1">// æ·»åŠ æ“ä½œ
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
trigger å¤„ç†ï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/838b4023b61bc0fede67e94aa7fd857a4950c29e">838b402</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/838b4023b61bc0fede67e94aa7fd857a4950c29e">feat(add): collection trigger cases Â· gcclll/stb-vue-next@838b402</a></p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, get map size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, get map size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed has &#39;foo&#39; -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observedSet</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">set</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observedSet</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before add, get set size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after add, get set size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
before set, get map size -&gt; dummy = 0
after set, get map size -&gt; dummy = 1
observed has &#39;foo&#39; -&gt; dummy = true
before add, get set size -&gt; dummy = 0
after add, get set size -&gt; dummy = 1
</pre>
</div>
</div>
<div id="outline-container-headline-42" class="outline-2">
<h2 id="headline-42">
add collection delete,clear proxy handler
</h2>
<div id="outline-text-headline-42" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b3c5087095ace7797cf6c38bd45b99700d4b6059">feat(add): collection delete and clear Â· gcclll/stb-vue-next@b3c5087</a></p>
<p>
delete:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">deleteEntry</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">CollectionTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">has</span><span class="p">,</span> <span class="kr">get</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">getProto</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">checkIdentityKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">has</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="kr">get</span> <span class="o">?</span> <span class="kr">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
clear:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">clear</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">IterableCollections</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">hadItems</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">size</span> <span class="o">!==</span> <span class="mi">0</span>
  <span class="kr">const</span> <span class="nx">oldTarget</span> <span class="o">=</span> <span class="nx">__DEV__</span>
    <span class="o">?</span> <span class="nx">isMap</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
      <span class="o">?</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
      <span class="o">:</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
    <span class="o">:</span> <span class="kc">undefined</span>

  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hadItems</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">CLEAR</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">oldTarget</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observedMap</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observedMap</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; map`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; set`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observedSet</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">set</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observedSet</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; map
before delete, dummy = 1
after delete, dummy = 0
before clear, dummy = 2
after clear, dummy = 0
&gt;&gt;&gt; set
before delete, dummy = 1
after delete, dummy = 0
before clear, dummy = 3
after clear, dummy = 0
</pre>
</div>
</div>
<div id="outline-container-headline-43" class="outline-2">
<h2 id="headline-43">
add collection forEach proxy handler
</h2>
<div id="outline-text-headline-43" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/77a02224b107c9f6a2d5101affa861c7b4c8b392">feat(add): collection forEach proxy handler Â· gcclll/stb-vue-next@77a0222</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createForEach</span><span class="p">(</span><span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span> <span class="nx">isShallow</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">forEach</span><span class="p">(</span>
    <span class="k">this</span><span class="o">:</span> <span class="nx">IterableCollections</span><span class="p">,</span>
    <span class="nx">callback</span>: <span class="kt">Function</span><span class="p">,</span>
    <span class="nx">thisArg?</span>: <span class="kt">unknown</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="k">this</span> <span class="kr">as</span> <span class="kt">any</span>
    <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">rawTarget</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="nx">isReadonly</span> <span class="o">?</span> <span class="nx">toReadonly</span> : <span class="kt">isShallow</span> <span class="o">?</span> <span class="nx">toShallow</span> : <span class="kt">toReactive</span>
    <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span> <span class="nx">ITERATE_KEY</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">target</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// é‡è¦ï¼šç¡®ä¿å›è°ƒ
</span><span class="c1"></span>      <span class="c1">// 1. åœ¨ reactive map ä½œç”¨åŸŸä¸‹è¢«æ‰§è¡Œ(this, å’Œç¬¬ä¸‰ä¸ªå‚æ•°)
</span><span class="c1"></span>      <span class="c1">// 2. æ¥å—çš„ value å€¼åº”è¯¥æ˜¯ä¸ª reactive/readonly ç±»å‹
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="nx">observed</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å°† forEach å°è£…äº†ä¸€å±‚ï¼Œå¯¹ä¼ é€’ç»™å›è°ƒçš„å€¼ reactive åŒ–ï¼Œä½¿ç”¨ <code>ITERATE_KEY</code> æ”¶é›†è°ƒç”¨
è¯¥æ–¹æ³•çš„ä¾èµ–ã€‚</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">ob</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">+=</span> <span class="nx">value</span> <span class="o">||</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before set 1, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 before set 2, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 before set 1, dummy = 0
#2 before set 2, dummy = 1
#3 after set, dummy = 4
</pre>
<ul>
<li>
<p><strong>#1</strong> effect ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯æ­¤æ—¶ map æ²¡æ•°æ®</p>
</li>
<li>
<p><strong>#1</strong> æ·»åŠ  <code>foo =&gt; 1</code> ä¹‹åæ‰§è¡Œ effect fn forEach è¿­ä»£å™¨è¿›è¡Œç´¯åŠ æ“ä½œçš„ç»“æœ</p>
</li>
<li>
<p><strong>#2</strong> æ·»åŠ  <code>bar =&gt; 2</code> ç»“æœæ˜¯ 4ï¼ŒåŸå› æ˜¯åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ <code>dummy = 1</code> çš„ï¼Œæ‰€ä»¥å†ç´¯åŠ ä¹‹</p>
</li>
</ul>
<p>åå°±æ˜¯ 4</p>
</div>
</div>
<div id="outline-container-headline-44" class="outline-2">
<h2 id="headline-44">
add collection iterators methods proxy handler
</h2>
<div id="outline-text-headline-44" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e5497be89422f6d14d2d14c76bee42e3cf866eee">feat(add): collection iterable methods Â· gcclll/stb-vue-next@e5497be</a></p>
<p>
add code:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">interface</span> <span class="nx">Iterable</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span><span class="o">:</span> <span class="nx">Iterator</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Iterator</span> <span class="p">{</span>
  <span class="nx">next</span><span class="p">(</span><span class="nx">value?</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">IterationResult</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IterationResult</span> <span class="p">{</span>
  <span class="nx">value</span>: <span class="kt">any</span>
  <span class="nx">done</span>: <span class="kt">boolean</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createIterableMethod</span><span class="p">(</span>
  <span class="nx">method</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span>
  <span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">isShallow</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span>
    <span class="k">this</span><span class="o">:</span> <span class="nx">IterableCollections</span><span class="p">,</span>
    <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[]</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">Iterable</span> <span class="o">&amp;</span> <span class="nx">Iterator</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">rawTarget</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">targetIsMap</span> <span class="o">=</span> <span class="nx">isMap</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">isPair</span> <span class="o">=</span>
      <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;entries&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span> <span class="o">&amp;&amp;</span> <span class="nx">targetIsMap</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">isKeyOnly</span> <span class="o">=</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;keys&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">targetIsMap</span>
    <span class="kr">const</span> <span class="nx">innerIterator</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="nx">method</span><span class="p">](...</span><span class="nx">args</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="nx">isReadonly</span> <span class="o">?</span> <span class="nx">toReadonly</span> : <span class="kt">isShallow</span> <span class="o">?</span> <span class="nx">toShallow</span> : <span class="kt">toReactive</span>
    <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span>
      <span class="nx">track</span><span class="p">(</span>
        <span class="nx">rawTarget</span><span class="p">,</span>
        <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span>
        <span class="nx">isKeyOnly</span> <span class="o">?</span> <span class="nx">MAP_KEY_ITERATE_KEY</span> : <span class="kt">ITERATE_KEY</span>
      <span class="p">)</span>

    <span class="c1">// é‡å†™è¿­ä»£å™¨ï¼Œè®©å…¶è¿”å›çš„å¯¹è±¡ä¹Ÿæ˜¯ reactive/readonly ç±»å‹
</span><span class="c1"></span>    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">next() {</span>
        <span class="kr">const</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">done</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">innerIterator</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">done</span>
          <span class="o">?</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">done</span> <span class="p">}</span>
          <span class="o">:</span> <span class="p">{</span>
              <span class="nx">value</span>: <span class="kt">isPair</span> <span class="o">?</span> <span class="p">[</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">:</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span>
              <span class="nx">done</span>
            <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
test:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">toRaw</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>

<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;dax&#39;</span> <span class="p">}</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;dax&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">dummy</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #1 set`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`obj in map is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;dax&#34;</span><span class="p">))</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #2 clear`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #3 should not observe custom property`</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">customProp</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set cumstom prop, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">customProp</span> <span class="o">=</span> <span class="s1">&#39;Hello World&#39;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set cumstom prop, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #4 ä¸åº”è¯¥ä½¿ Proxies æ±¡æŸ“åŸæ¥çš„ Map å¯¹è±¡`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observed2</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map2</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="nx">observed2</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`map2.get(&#39;key&#39;) !== value, </span><span class="si">${</span><span class="nx">map2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`map2.get(&#39;key&#39;) === toRaw(value), </span><span class="si">${</span><span class="nx">map2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; #1 set
before set, dummy = foo,1,bar,2,dax,[object Object]
after set, dummy = foo,1,bar,2,dax,[object Object],foo,1,bar,2,dax,[object Object],baz,3
obj in map is reactive true
&gt;&gt;&gt; #2 clear
before clear, dummy = 4
after clear, dummy = 0
&gt;&gt;&gt; #3 should not observe custom property
before set cumstom prop, dummy = undefined
after set cumstom prop, dummy = undefined
&gt;&gt;&gt; #4 ä¸åº”è¯¥ä½¿ Proxies æ±¡æŸ“åŸæ¥çš„ Map å¯¹è±¡
map2.get(&#39;key&#39;) !== value, true
map2.get(&#39;key&#39;) === toRaw(value), true
</pre>
<ul>
<li>
<p><strong>#1</strong> åœ¨éå†è¿‡ç¨‹ä¸­ get -&gt; track -&gt; é€’å½’ reactiveï¼Œæ‰€ä»¥ obj æ˜¯
<code>obsreved.get(&#39;dax&#39;)</code> ç»“æœæ˜¯ reactive ã€‚</p>
</li>
<li>
<p><strong>#2</strong> clear å†…éƒ¨å®ç°ä¼šå–è¿­ä»£å™¨è¿›è¡Œè¿­ä»£åˆ é™¤ï¼Œå¹¶ä¸”æ”¹å˜æœ€ç»ˆ size å€¼ã€‚</p>
</li>
<li>
<p><strong>#3</strong> collectionHandlers.ts ä¸­çš„æ–¹æ³•éƒ½æ˜¯é’ˆå¯¹é›†åˆæœ¬èº«å…ƒç´ è¿›è¡Œæ“ä½œçš„ï¼Œå¯¹äºè‡ªå®šä¹‰
å±æ€§æ˜¯ä¸åœ¨å“åº”å¼ Map/Set ä¹‹åˆ—çš„ã€‚</p>
</li>
<li>
<p><strong>#4</strong> set proxy handler é‡Œé¢çš„å®ç°ä¼šå…ˆå–  <code>toRaw(value)</code> å†è¿›è¡Œè®¾ç½®æ“ä½œã€‚</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-45" class="outline-2">
<h2 id="headline-45">
add collection readonly proxy handlers
</h2>
<div id="outline-text-headline-45" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fa2636d5e4f9d4b7bb7ba388ad25f692f27e6e4f">feat(add): readonly collection handlers Â· gcclll/stb-vue-next@fa2636d</a></p>
<p>
åˆ›å»ºå‡ ä¸ªè®¾ç½®å‹çš„æ–¹æ³•(<code>add,set,delete,clear</code>)
create readonly method for settable handlers(<code>add,set,delete,clear</code>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createReadonlyMethod</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="nx">TriggerOpTypes</span><span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">CollectionTypes</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="sb">`on key &#34;</span><span class="si">${</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">&#34;`</span> <span class="o">:</span> <span class="sb">``</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span>
        <span class="sb">`</span><span class="si">${</span><span class="nx">capitalize</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span><span class="si">}</span><span class="sb"> operation </span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb"> failed: target is readonly.`</span><span class="p">,</span>
        <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kr">type</span> <span class="o">===</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="k">this</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
readonly instrumentations:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">readonlyInstrumentations</span>: <span class="kt">Recor</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Function</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="kr">get</span> <span class="nx">size() {</span>
    <span class="k">return</span> <span class="nx">size</span><span class="p">((</span><span class="k">this</span> <span class="kr">as</span> <span class="kt">unknown</span><span class="p">)</span> <span class="kr">as</span> <span class="nx">IterableCollections</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">has</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">add</span>: <span class="kt">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">),</span>
  <span class="kr">set</span><span class="o">:</span> <span class="nx">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">),</span>
  <span class="k">delete</span><span class="o">:</span> <span class="nx">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">),</span>
  <span class="nx">clear</span>: <span class="kt">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">CLEAR</span><span class="p">),</span>
  <span class="nx">forEach</span>: <span class="kt">createForEach</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
</div>
</div>
<div id="outline-container-headline-46" class="outline-2">
<h2 id="headline-46">
add collection shallow proxy handlers
</h2>
<div id="outline-text-headline-46" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/676bc70fe9a6535b85ada4754fb6a683bec50f5f">feat(add): shallow collection handlers Â· gcclll/stb-vue-next@676bc70</a></p>
<p>
ä¸ä¼šé€’å½’ reactive ç‰ˆæœ¬ã€‚</p>
</div>
</div>
<div id="outline-container-computed" class="outline-2">
<h2 id="computed">
computed
</h2>
<div id="outline-text-computed" class="outline-text-2">
<div id="outline-container-headline-48" class="outline-3">
<h3 id="headline-48">
types definitions
</h3>
<div id="outline-text-headline-48" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e9e53a16dcaffd35aa519b3251e4bcb4ad4e9342">feat(add): computed type definitions Â· gcclll/stb-vue-next@e9e53a1</a></p>
<p>
computed è®¡ç®—å±æ€§çš„ä¸€äº›ç±»å‹å®šä¹‰ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Ref</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./ref&#39;</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="kr">extends</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{}</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="kr">extends</span> <span class="nx">Ref</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{}</span>

<span class="kr">export</span> <span class="kr">type</span> <span class="nx">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ctx?</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">T</span>

<span class="kr">export</span> <span class="kr">type</span> <span class="nx">ComputedSetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">v</span>: <span class="kt">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
computed å‡½æ•°é‡è½½(<a href="https://github.com/gcclll/stb-vue-next/commit/315e0d91869dd4332c740e56d4e385f04b6009e9">315e0d9</a>)ï¼š
<a href="https://github.com/gcclll/stb-vue-next/commit/315e0d91869dd4332c740e56d4e385f04b6009e9">feat(add): computed function reloads Â· gcclll/stb-vue-next@315e0d9</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">options</span>: <span class="kt">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">getterOrOptions</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-49" class="outline-3">
<h3 id="headline-49">
implementation
</h3>
<div id="outline-text-headline-49" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/64d380dfea9da6a78f10fe2de9ef95fbd253d3f0">feat(add): computed tpl and computed function Â· gcclll/stb-vue-next@64d380d</a></p>
<p>
è®¡ç®—å±æ€§å®ç°å…¨åœ¨ <code>ComputedRefImpl&lt;T&gt;</code> ç±»çš„å®ç°ä¸­ï¼Œå®ç°å…³é”®ç‚¹</p>
<ol>
<li>
<p>ä½¿ç”¨ effect å°è£… getter å‡½æ•°ï¼Œæ”¶é›†æ‰€æœ‰ä¾èµ–ï¼Œåœ¨ç‰¹å®šæ—¶å€™æ‰§è¡Œ effect</p>
</li>
<li>
<p>_dirty æ ‡è®°ï¼Œä¸€æ—¦ <code>_dirty = true</code> è¡¨ç¤ºæ•°æ®æœ‰æ›´æ–°ï¼Œä¸‹æ¬¡å–å€¼çš„æ—¶å€™å°±è¦ç«‹å³æ‰§è¡Œ
effect å–æœ€æ–°å€¼</p>
</li>
</ol>
<p>
class <code>ComputedRefImpl</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// è®¡ç®—å±æ€§æ¨¡æ¿
</span><span class="c1"></span><span class="kr">class</span> <span class="nx">ComputedRefImpl</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">_value</span><span class="o">!:</span> <span class="nx">T</span>
  <span class="kr">private</span> <span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">effect</span>: <span class="kt">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kr">public</span> <span class="kr">readonly</span> <span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">]</span><span class="o">:</span> <span class="kr">boolean</span>

  <span class="kr">constructor</span><span class="p">(</span>
    <span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;,</span>
    <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_setter</span>: <span class="kt">ComputedSetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;,</span>
    <span class="nx">isReadonly</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">effect</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(</span><span class="nx">getter</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">lazy</span>: <span class="kt">true</span><span class="p">,</span>
      <span class="nx">scheduler</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="nx">trigger</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">this</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isReadonly</span>
  <span class="p">}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">effect</span><span class="p">()</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newValue</span>: <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_setter</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
computed å‡½æ•°:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">options</span>: <span class="kt">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">getterOrOptions</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
  <span class="kd">let</span> <span class="nx">setter</span>: <span class="kt">ComputedSetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">getterOrOptions</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">getter</span> <span class="o">=</span> <span class="nx">getterOrOptions</span>
    <span class="nx">setter</span> <span class="o">=</span> <span class="nx">__DEV__</span>
      <span class="o">?</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Write operation failed: computed value is readonly&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="o">:</span> <span class="nx">NOOP</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">getter</span> <span class="o">=</span> <span class="nx">getterOrOptions</span><span class="p">.</span><span class="kr">get</span>
    <span class="nx">setter</span> <span class="o">=</span> <span class="nx">getterOrOptions</span><span class="p">.</span><span class="kr">set</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nx">ComputedRefImpl</span><span class="p">(</span>
    <span class="nx">getter</span><span class="p">,</span>
    <span class="nx">setter</span><span class="p">,</span>
    <span class="nx">isFunction</span><span class="p">(</span><span class="nx">getterOrOptions</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">getterOrOptions</span><span class="p">.</span><span class="kr">set</span>
  <span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
computed å‡½æ•°çš„ options å¯ä»¥æ˜¯å‡½æ•°æˆ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç”¨å¤–éƒ¨è‡ªå®šä¹‰ setter å‡½æ•°ï¼Œæ¯”å¦‚
åœ¨æ›´æ–°ä¹‹å‰è®°å½•å½“å‰çŠ¶æ€ï¼Œå°±å¯ä»¥åœ¨ options.set ä¸­å»å®ç°ã€‚</p>
<p>
æµ‹è¯•è¯·ç§»æ­¥â€œ<a href="#test-computed">è®¡ç®—å±æ€§æµ‹è¯•ç”¨ä¾‹</a>â€</p>
<p>
è„‘å›¾è¯·ç›´æ¥æŸ¥çœ‹â€œ<a href="#whole-mind-map">å®Œæ•´è„‘å›¾ computed éƒ¨åˆ†</a>â€</p>
</div>
</div>
</div>
</div>
<div id="outline-container-ref" class="outline-2">
<h2 id="ref">
add ref
</h2>
<div id="outline-text-ref" class="outline-text-2">
<p>
<img src="/img/vue3/reactivity/reactivity-ref.svg" alt="/img/vue3/reactivity/reactivity-ref.svg" title="/img/vue3/reactivity/reactivity-ref.svg" /></p>
<p>
è¿™éƒ¨åˆ†å› ä¸ºä¹‹å‰æ²¡æœ‰å•ç‹¬æ‹å‡ºæ¥ä¸€æ­¥æ­¥å®ç°ï¼Œè€Œæ˜¯ç›´æ¥æ‹·è´è¿‡æ¥äº†ä¸ºäº†å…ˆæµ‹è¯• computed å±
æ€§ã€‚</p>
<p>
æ‰€ä»¥è¿™é‡Œç›´æ¥æ ¹æ®æºç ä»¥åŠä½¿ç”¨æ–¹å¼æ¥è¿›è¡Œé€æ­¥åˆ†æã€‚</p>
<p>
APIs:</p>
<table>
<thead>
<tr>
<th>api</th>
<th>function</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>isRef(r:any)</code></td>
<td>æ£€æµ‹å‡½æ•°</td>
</tr>
<tr>
<td><code>ref(value)</code></td>
<td>å°† value è½¬æˆ Ref ç±»å‹</td>
</tr>
<tr>
<td><code>shallowRef(value)</code></td>
<td>ä¸è¿›è¡Œé€’å½’ reactive</td>
</tr>
<tr>
<td><code>createRef(rawValue, shallow = false)</code></td>
<td>create ref, for ref/shallowRef</td>
</tr>
<tr>
<td><code>triggerRef(ref: Ref)</code></td>
<td>è§¦å‘ ref å˜é‡ä¸Šçš„æ‰€æœ‰ä¾èµ–</td>
</tr>
<tr>
<td><code>unref(ref)</code></td>
<td>å–æ¶ˆ ref åŒ–ï¼Œè¿”å› ref.value åŸå§‹å€¼</td>
</tr>
<tr>
<td><code>proxyRefs(objectWithRefs)</code></td>
<td>refs ä»£ç†</td>
</tr>
<tr>
<td><code>RefImpl</code></td>
<td>Ref å˜é‡æ¨¡æ¿</td>
</tr>
<tr>
<td><code>CustomRefImpl</code></td>
<td>è‡ªå®šä¹‰ Ref å˜é‡æ¨¡æ¿</td>
</tr>
</tbody>
</table>
<div id="outline-container-headline-51" class="outline-3">
<h3 id="headline-51">
ref &amp; shallow ref
</h3>
<div id="outline-text-headline-51" class="outline-text-3">
<p>
<code>ref()</code> å’Œ <code>shallowRef()</code> å‡½æ•°éƒ½æ˜¯è°ƒç”¨çš„åŒä¸€ä¸ªå‡½æ•° <code>createRef(val, shallow)</code> æ¥
åˆ›å»ºref å˜é‡ï¼Œè€Œ <code>createRef</code> æœ¬èº«ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ <code>new</code> äº†ä¸€ä¸ª <code>RefImpl</code> å®ä¾‹å‡ºæ¥ã€‚</p>
<p>
å¦å¤–é’ˆå¯¹å·²ç»æ˜¯ ref çš„å€¼ä¸éœ€è¦é‡å¤ <code>new</code> æ“ä½œï¼Œç›´æ¥è¿”å›åŸ refã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// ref
</span><span class="c1"></span> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">ref</span><span class="p">(</span><span class="nx">value?</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">createRef</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
 <span class="p">}</span>

<span class="c1">// shallow ref
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">shallowRef</span><span class="p">(</span><span class="nx">value?</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createRef</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// createRef(rawValue, shallow = false)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">createRef</span><span class="p">(</span><span class="nx">rawValue</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">rawValue</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rawValue</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">RefImpl</span><span class="p">(</span><span class="nx">rawValue</span><span class="p">,</span> <span class="nx">shallow</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å‚æ•°ï¼š</p>
<ol>
<li>
<p>val éœ€è¦è¿›è¡Œ ref åŒ–çš„å˜é‡</p>
</li>
<li>
<p>shallow å¦‚æœ val æ˜¯å¯¹è±¡çš„æ—¶å€™å†³å®šæ˜¯å¦éœ€è¦å¯¹è¯¥å¯¹è±¡è¿›è¡Œé€’å½’ reactive åŒ–</p>
</li>
</ol>
<p>
çœ‹ä¸‹ ref ç»“æ„æ¨¡æ¿ç±»ï¼š <code>RefImpl&lt;T&gt;</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">class</span> <span class="nx">RefImpl</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">T</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">_rawValue</span>: <span class="kt">T</span><span class="p">,</span> <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">_shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">_shallow</span> <span class="o">?</span> <span class="nx">_rawValue</span> : <span class="kt">convert</span><span class="p">(</span><span class="nx">_rawValue</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">newVal</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">newVal</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_shallow</span> <span class="o">?</span> <span class="nx">newVal</span> : <span class="kt">convert</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span>
      <span class="nx">trigger</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">newVal</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä»£ç æ˜¯ç›¸å½“ç®€å•çš„ï¼Œå››ä¸ªå±æ€§(<code>_value/__v_isRef/_rawValue/_shallow</code>)+ä¸¤ä¸ªè®¿é—®å™¨æ–¹æ³•
(<code>value getter/setter</code>)ã€‚</p>
<blockquote>
<p>æ ¹æ® es6 class è¯­æ³•ï¼Œæ„é€ å‚æ•°å¦‚æœä½¿ç”¨äº†æƒé™ä¿®é¥°ç¬¦ä¼šè‡ªåŠ¨è½¬æˆæˆå‘˜å±æ€§ï¼Œæ‰€ä»¥
<code>_rawValue</code> å’Œ <code>_shallow</code> ä¹Ÿæ˜¯ RefImpl æˆå‘˜å±æ€§å’Œ <code>_value</code> æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äºè¿™
ä¸¤ä¸ªå€¼å¯ä»¥é€šè¿‡å¤–éƒ¨æ§åˆ¶ã€‚</p>
</blockquote>
<p>
å¼€å§‹æµ‹è¯•å§ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rt</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">shallowRef</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;1. base usage &gt;&gt;&gt;&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;before, a.value = &#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">]);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;after, a.value = &#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">]);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n2. should be reactive &gt;&gt;&gt;&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;ge/set value é‡Œé¢ä½¿ç”¨çš„æ˜¯ track/trigger&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
  <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">calls</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`before set a.value, dummy=</span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, calls=</span><span class="si">${</span><span class="nx">calls</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`after set a.value, dummy=</span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, calls=</span><span class="si">${</span><span class="nx">calls</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n3. é»˜è®¤æƒ…å†µä¸‹å¯¹åµŒå¥—å¯¹è±¡å±æ€§è¿›è¡Œ reactive &gt;&gt;&gt;&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="p">));</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before set, dummy = ${dummy}&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after set, dummy = ${dummy}&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n4. ref() ä¸ä¼ å€¼çš„æ—¶å€™ä¹Ÿåº”è¯¥å¯ä»¥å·¥ä½œ&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">();</span>
<span class="c1">// ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œç»™ä»€ä¹ˆå€¼éƒ½å¯ä»¥
</span><span class="c1"></span><span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="p">));</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">c</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="c1">// å½“åµŒå¥—åœ¨ä¸€ä¸ªå¤šå±‚çº§çš„å¯¹è±¡é‡Œçš„æ—¶å€™
</span><span class="c1">// å› ä¸º ref() è¿”å›çš„æ˜¯ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥æ”¾åœ¨å¯¹è±¡é‡Œé¢æœ¬è´¨ä¸Šæ“ä½œçš„è¿˜æ˜¯
</span><span class="c1">// ref æœ¬èº«
</span><span class="c1"></span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n5. ref ä½œä¸ºå¤šçº§å¯¹è±¡çš„å€¼æ—¶&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span>
  <span class="nx">d</span><span class="p">,</span>
  <span class="nx">b</span><span class="o">:</span> <span class="p">{</span> <span class="nx">c</span><span class="o">:</span> <span class="nx">d</span> <span class="p">},</span>
<span class="p">});</span>
<span class="kd">let</span> <span class="nx">dummy1</span><span class="p">,</span> <span class="nx">dummy2</span><span class="p">;</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy1</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">d</span><span class="p">;</span>
  <span class="nx">dummy2</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`d.value++, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="c1">// æ³¨æ„è¿™é‡Œç›´æ¥é’ˆå¯¹ ref è¿›è¡Œèµ‹å€¼æ“ä½œè€Œä¸æ˜¯obj.d.value++
</span><span class="c1">// è¿™æ ·ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå› ä¸º set proxy é‡Œé¢æœ‰æ£€æµ‹è¯¥å±æ€§æ˜¯ä¸æ˜¯ ref
</span><span class="c1">// å¦‚æœæ˜¯ Ref ä¼šè½¬å˜æˆå¯¹ obj.d.value++ ä¹Ÿå°±æ˜¯è¯´ vue å†…éƒ¨å¸®
</span><span class="c1">// æˆ‘ä»¬è¿™ä¹ˆåšäº†ï¼Œä¸‹é¢å¯¹ obj.b.c++ åŒ
</span><span class="c1"></span><span class="nx">obj</span><span class="p">.</span><span class="nx">d</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`obj.d++, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`obj.b.c++, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
1. base usage &gt;&gt;&gt;
before, a.value =  1
after, a.value =  2

2. should be reactive &gt;&gt;&gt;
ge/set value é‡Œé¢ä½¿ç”¨çš„æ˜¯ track/trigger
before set a.value, dummy=2, calls=1
after set a.value, dummy=3, calls=2

3. é»˜è®¤æƒ…å†µä¸‹å¯¹åµŒå¥—å¯¹è±¡å±æ€§è¿›è¡Œ reactive &gt;&gt;&gt;
before set, dummy = ${dummy}
after set, dummy = ${dummy}

4. ref() ä¸ä¼ å€¼çš„æ—¶å€™ä¹Ÿåº”è¯¥å¯ä»¥å·¥ä½œ
before set, dummy = undefined
after set, dummy = 100

5. ref ä½œä¸ºå¤šçº§å¯¹è±¡çš„å€¼æ—¶
before set, dummy1=1, dummy2=1
d.value++, dummy1=2, dummy2=2
obj.d++, dummy1=3, dummy2=3
obj.b.c++, dummy1=4, dummy2=4
undefined
</pre>
<p>
æµ‹è¯•åˆ†æï¼š</p>
<ol>
<li>
<p>åŸºæœ¬ä½¿ç”¨</p>
<p>
ref å®ç°åŸºäº effect çš„ track å’Œ trigger</p>
<p>
get value å®ç°</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
set value å®ç°</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">newVal</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
      <span class="c1">// convert() æ£€æµ‹ newVal æ˜¯å¯¹è±¡å°±è°ƒç”¨ reactive
</span><span class="c1"></span>      <span class="c1">// æ³¨æ„è¿™é‡Œåªæ˜¯ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥ ref å¯ä»¥æ¥å—ä»»æ„ç±»å‹çš„å€¼
</span><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_shallow</span> <span class="o">?</span> <span class="nx">newVal</span> : <span class="kt">convert</span><span class="p">(</span><span class="nx">newVal</span><span class="p">);</span>
      <span class="c1">// trigger è§¦å‘ value å±æ€§ä¸Šçš„ä¾èµ–è¿›è¡Œ
</span><span class="c1"></span>      <span class="c1">// å› ä¸º track ä¹Ÿæ˜¯åœ¨è¿™ä¸ªå±æ€§ä¸Šè¿›è¡Œæ”¶é›†çš„
</span><span class="c1"></span>      <span class="nx">trigger</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">,</span> <span class="nx">newVal</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>should be reactive</p>
<p>
è¿™ä¸ªåœ¨ <strong>1</strong> åˆ—å‡ºäº† get value æºç ï¼Œç»“åˆ track/trigger è¾¾åˆ° reactive ç›®çš„ã€‚</p>
</li>
<li>
<p>è¿™ä¸€ç‚¹ç›´æ¥çœ‹æºç  <code>set value(newVal)</code></p>
<p>
<code>this._value = this._shallow ? newVal : convert(newVal)</code></p>
<p>
convert() é’ˆå¯¹å¯¹è±¡ reactive</p>
</li>
<li>
<p>å› ä¸º <code>new RefImpl(rawValue, shallow)</code> æ˜¯ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œç»™å•¥å€¼éƒ½è¡Œ</p>
</li>
<li>
<p>å› ä¸º <code>new RefImpl(rawValue, shallow)</code> è¿”å›çš„æ˜¯ä¸ª RefImpl å®ä¾‹å¯¹è±¡ï¼Œå±äºå¼•ç”¨ç±»
å‹ï¼Œä¸ç®¡å¯¹è±¡å±‚çº§å¤šæ·±ï¼Œæœ€ç»ˆå¼•ç”¨çš„éƒ½æ˜¯è¿™ä¸ªå¯¹è±¡ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-52" class="outline-3">
<h3 id="headline-52">
object ref
</h3>
<div id="outline-text-headline-52" class="outline-text-3">
<p>
å¯¹å¯¹è±¡çš„æ‰€æœ‰å±æ€§è¿›è¡Œ ref åŒ–ï¼Œåœ¨è¿›è¡Œ proxy ref ä¹‹å‰éœ€è¦å…ˆå®Œæˆè¿™éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒä¾èµ–
object refã€‚</p>
<table>
<thead>
<tr>
<th>function</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>toRefs(object)</code></td>
<td>refå¯¹è±¡çš„æ‰€æœ‰å±æ€§</td>
</tr>
<tr>
<td><code>ObjectRefImpl</code></td>
<td>å¯¹è±¡ ref æ¨¡æ¿</td>
</tr>
<tr>
<td><code>toRef(object, key)</code></td>
<td>é’ˆå¯¹ object[key] è¿›è¡Œ ref</td>
</tr>
</tbody>
</table>
<p>
ç›¸å…³æºç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">class</span> <span class="nx">ObjectRefImpl</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="err">,</span> <span class="na">K</span> <span class="na">extends</span> <span class="na">keyof</span> <span class="na">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_object</span>: <span class="kt">T</span><span class="p">,</span> <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_key</span>: <span class="kt">K</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_key</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newVal</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ref object å±æ€§çš„
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">toRef</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="err">,</span> <span class="na">K</span> <span class="na">extends</span> <span class="na">keyof</span> <span class="na">T</span><span class="p">&gt;(</span>
  <span class="kt">object</span><span class="o">:</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">key</span>: <span class="kt">K</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ToRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">[</span><span class="na">K</span><span class="err">]</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isRef</span><span class="p">(</span><span class="kt">object</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
    <span class="o">?</span> <span class="kt">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ObjectRefImpl</span><span class="p">(</span><span class="kt">object</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ref object æ‰€æœ‰å±æ€§
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">toRefs</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="p">&gt;(</span><span class="kt">object</span><span class="o">:</span> <span class="nx">T</span><span class="p">)</span><span class="o">:</span> <span class="nx">ToRefs</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isProxy</span><span class="p">(</span><span class="kt">object</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`toRefs() expects a reactive object but received a plain one.`</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">ret</span>: <span class="kt">any</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="kt">object</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="kt">object</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="kt">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">toRef</span><span class="p">(</span><span class="kt">object</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>æºç åˆ†æ</strong> ï¼š <code>ObjectRefImpl</code> ä¸­é’ˆå¯¹æ¯ä¸ª <code>object[key]</code> æŒæœ‰äº†ä¸€ä»½ object å¼•
 ç”¨ _object, ä¸”åœ¨æœ€å¼€å§‹ <code>new</code> å®ä¾‹çš„æ—¶å€™å°†å±æ€§åä¿å­˜åˆ°äº† _keyï¼Œåç»­å–å€¼è®¾å€¼ç”¨çš„éƒ½
 æ˜¯è¿™ä¸ªå€¼ï¼Œç„¶åé‡å†™äº† getter/setter å‡½æ•°ï¼Œåœ¨å–å€¼è®¾å€¼çš„æ—¶å€™æ“ä½œ <code>_object + _key</code>
 ã€‚</p>
<p>
 æ‰“ä¸ªæ¯”æ–¹ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// åŸå§‹å¯¹è±¡
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">rawObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>

<span class="c1">// toRef(rawObj, &#39;count&#39;) ä¹‹å
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">reffed</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">_</span><span class="nx">key</span><span class="o">:</span> <span class="s2">&#34;count&#34;</span><span class="p">,</span>
  <span class="mi">_</span><span class="nx">object</span><span class="o">:</span> <span class="nx">rawObj</span><span class="p">,</span>
  <span class="nx">get</span> <span class="nx">value</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="nx">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="c1">// ç„¶åå½“ä½ æ”¹å˜ reffed.value å€¼æ—¶å®é™…ä¸Šæ˜¯åœ¨æ”¹å˜ rawObj.count çš„å€¼
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, rawObj.count = </span><span class="si">${</span><span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">reffed</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, rawObj.count = </span><span class="si">${</span><span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// toRefs(rawObj) å°±æ˜¯å¯¹æ‰€æœ‰å±æ€§è¿›è¡Œ toRef()ï¼Œç„¶åå°†è¿”å›çš„å€¼ç”¨
</span><span class="c1">// åŒæ ·çš„ key ç»„æˆæ–°çš„å¯¹è±¡è¿”å›
</span><span class="c1">// å¦‚: æ²¿ç”¨ä¸Šé¢çš„æµ‹è¯•
</span><span class="c1">// toRefs(rawObj) ç­‰äºæ˜¯è¿”å›äº†ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡è¿™ä¸ªå¯¹è±¡å†…å®¹ä¸ºï¼š
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">reffedObj</span> <span class="o">=</span> <span class="p">{</span>
 <span class="nx">count</span><span class="o">:</span> <span class="nx">reffed</span>
<span class="p">}</span>
<span class="c1">// éšåæˆ‘ä»¬ç›´æ¥é€šè¿‡ä¿®æ”¹ reffedObj.count æ¥é—´æ¥æ“ä½œ rawObj å¯¹è±¡é‡Œå±æ€§çš„å€¼
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before set on obj, rawObj.count = &#39;</span> <span class="o">+</span> <span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
<span class="nx">reffedObj</span><span class="p">.</span><span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">200</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;after set on obj, rawObj.count = &#39;</span> <span class="o">+</span> <span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
before set, rawObj.count = 0
after set, rawObj.count = 100
before set on obj, rawObj.count = 100
after set on obj, rawObj.count = 200
undefined
</pre>
<p>
 çœ‹åˆ°æ²¡ï¼Œå®é™…éƒ½æ˜¯æ”¹å˜äº† <code>rawObj.count</code></p>
<blockquote>
<p>æ‰€ä»¥, object ref ç­‰äºæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡é‡Œé¢åŒ…å«çš„å±æ€§å’Œ raw object å±æ€§åä¸€
è‡´ï¼Œä½†æ˜¯å€¼æ˜¯ <code>ObjectRefImpl</code> åˆ›å»ºçš„å®ä¾‹ï¼Œç”¨æ¥é—´æ¥æ“ä½œ raw object ã€‚</p>
</blockquote>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">toRef</span><span class="p">,</span> <span class="nx">proxyRefs</span><span class="p">,</span> <span class="nx">toRefs</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">objRef</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="kd">let</span> <span class="nx">dummy</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span>
<span class="p">})</span>
<span class="c1">// proxyRefs(objRef)
</span><span class="c1"></span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; ref åŸºæœ¬ç”¨æ³•&#39;</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`1. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`2. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; toRef ç”¨æ³•ï¼Œref å¯¹è±¡å±æ€§&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">toRef</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-53" class="outline-3">
<h3 id="headline-53">
ref proxy
</h3>
<div id="outline-text-headline-53" class="outline-text-3">
<p>
ä½œç”¨ï¼šä»£ç† ref éå†çš„ get/set æ“ä½œï¼Œè®© get åœ¨è¿”å›ä¹‹å‰å…ˆ <code>unref(result)</code> å¾—åˆ°åŸå§‹
çš„å€¼è¿”å›ï¼Œè®© set åœ¨ set ä¹‹å‰ç¡®ä¿è®¾å€¼çš„å€¼æ˜¯åœ¨ ref.value ä¸Šã€‚</p>
<p>
å’Œ ref proxy æœ‰å…³çš„å‡½æ•°å’Œå±æ€§:</p>
<table>
<thead>
<tr>
<th>function</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>shallowUnwrapHandlers { get, set }</code></td>
<td>ä»£ç†çš„ handler</td>
</tr>
<tr>
<td><code>proxyRefs(objectWithRefs)</code></td>
<td>ä»£ç† ref å¯¹è±¡</td>
</tr>
</tbody>
</table>
<p>
æºç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// proxy handler
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">shallowUnwrapHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">unref</span><span class="p">(</span><span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)),</span>
  <span class="kr">set</span><span class="o">:</span> <span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">oldValue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">oldValue</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">proxyRefs</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="p">&gt;(</span>
  <span class="nx">objectWithRefs</span>: <span class="kt">T</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ShallowUnwrapRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">objectWithRefs</span><span class="p">)</span>
    <span class="o">?</span> <span class="nx">objectWithRefs</span>
    : <span class="kt">new</span> <span class="nx">Proxy</span><span class="p">(</span><span class="nx">objectWithRefs</span><span class="p">,</span> <span class="nx">shallowUnwrapHandlers</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ref proxy ä½œç”¨ï¼šé’ˆå¯¹è¢« ref çš„ object å¯¹è±¡ï¼Œè¿›è¡Œ get å’Œ set æ“ä½œä»£ç†ã€‚</p>
<p>
get æ“ä½œï¼Œ <code>Reflect.get(...)</code> æ‹¿åˆ°çš„æ˜¯ä¸ª unrefï¼Œé€šè¿‡ proxy get handler å» ref åŒ–ï¼Œ
è¿”å›å…¶åŸå§‹å€¼ã€‚</p>
<p>
set æ“ä½œï¼Œ <code>Reflect.set(...)</code> æ–°å€¼æ˜¯ ref ç›´æ¥è¦†ç›–ä¹‹å‰çš„ <code>target[key]</code> å€¼ï¼Œå¦‚æœä¸æ˜¯
refï¼Œå°†å…¶è®¾ç½®åˆ° <code>oldValue.value</code> ä¸Šã€‚</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">toRef</span><span class="p">,</span> <span class="nx">proxyRefs</span><span class="p">,</span> <span class="nx">toRefs</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">objRef</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="kd">let</span> <span class="nx">dummy</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span>
<span class="p">})</span>
<span class="c1">// proxyRefs(objRef)
</span><span class="c1"></span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; ref åŸºæœ¬ç”¨æ³•&#39;</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`1. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`2. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; toRef ç”¨æ³•ï¼Œref å¯¹è±¡å±æ€§&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">toRef</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; before proxy
1. dummy = 0
2. dummy = 1
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-54" class="outline-3">
<h3 id="headline-54">
custom ref
</h3>
<div id="outline-text-headline-54" class="outline-text-3">
<p>
ç›¸å…³å‡½æ•°å’Œç±»ï¼š</p>
<table>
<thead>
<tr>
<th>function</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CustomRefImpl</code></td>
<td>è‡ªå®šä¹‰çš„ ref æ¨¡æ¿</td>
</tr>
<tr>
<td><code>customRef(factory)</code></td>
<td>è‡ªå®šä¹‰ refï¼Œå³ç”±å¤–éƒ¨å†³å®šå¦‚ä½•å®ç° getter &amp; settter value</td>
</tr>
</tbody>
</table>
<p>
è®©ä½¿ç”¨è€…è‡ªå®šä¹‰ä»¥ä»€ä¹ˆæ–¹å¼åœ¨ get çš„æ—¶å€™ track æˆ– set çš„æ—¶å€™ trigger</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">CustomRefFactory</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">track</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
  <span class="nx">trigger</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">;</span>
  <span class="kr">set</span><span class="o">:</span> <span class="p">(</span><span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">class</span> <span class="nx">CustomRefImpl</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_get</span>: <span class="kt">ReturnType</span><span class="p">&lt;</span><span class="nt">CustomRefFactory</span><span class="err">&lt;</span><span class="na">T</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">];</span>
  <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_set</span>: <span class="kt">ReturnType</span><span class="p">&lt;</span><span class="nt">CustomRefFactory</span><span class="err">&lt;</span><span class="na">T</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">[</span><span class="s2">&#34;set&#34;</span><span class="p">];</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="nx">factory</span>: <span class="kt">CustomRefFactory</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="kr">get</span><span class="p">,</span> <span class="kr">set</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span>
      <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">),</span>
      <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">trigger</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_get</span> <span class="o">=</span> <span class="kr">get</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_set</span> <span class="o">=</span> <span class="kr">set</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_set</span><span class="p">(</span><span class="nx">newVal</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å°±æ˜¯æˆ‘åªè´Ÿè´£ç»™ä½ æ„é€ ä¸€ä¸ª Ref ç»“æ„çš„å¯¹è±¡ï¼Œè‡³äºä»€ä¹ˆ get å’Œ set æ€ä¹ˆå®ç°å…¨æƒäº¤ç»™ä½¿
ç”¨è€…ï¼Œget/set é»˜è®¤ track/trigger value å±æ€§ã€‚</p>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">toRefs</span><span class="p">,</span> <span class="nx">customRef</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">isRef</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">let</span> <span class="mi">_</span><span class="nx">trigger</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">custom</span> <span class="o">=</span> <span class="nx">customRef</span><span class="p">((</span><span class="nx">track</span><span class="p">,</span> <span class="nx">trigger</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span>
  <span class="nx">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">track</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">set</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="mi">_</span><span class="nx">trigger</span> <span class="o">=</span> <span class="nx">trigger</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">}));</span>

<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;custom is ref, &#39;</span> <span class="o">+</span> <span class="nx">isRef</span><span class="p">(</span><span class="nx">custom</span><span class="p">))</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">custom</span><span class="p">.</span><span class="nx">value</span>
<span class="p">})</span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;dummy = &#39;</span> <span class="o">+</span> <span class="nx">dummy</span><span class="p">)</span>
<span class="nx">custom</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1">// è¿™ä¸ªæ—¶å€™è¿˜ä¸ä¼šè§¦å‘ä¾èµ–æ›´æ–°ï¼Œå› ä¸º trigger å¹¶æ²¡æœ‰æ‰§è¡Œ
</span><span class="c1">// åªæ˜¯ç¼“å­˜åˆ°äº† _trigger ä¸Š
</span><span class="c1"></span><span class="mi">_</span><span class="nx">trigger</span><span class="p">()</span> <span class="c1">// æ‰‹åŠ¨è§¦å‘ effects
</span><span class="c1"></span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;dummy = &#39;</span> <span class="o">+</span> <span class="nx">dummy</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
custom is ref, true
dummy = 1
dummy = 2
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-55" class="outline-3">
<h3 id="headline-55">
è¾…åŠ©å‡½æ•°
</h3>
<div id="outline-text-headline-55" class="outline-text-3">
<table>
<thead>
<tr>
<th>function</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>isRef(value)</code></td>
<td>æ£€æµ‹ value.__v_isRef å€¼</td>
</tr>
<tr>
<td><code>triggerRef(ref)</code></td>
<td>æ‰‹åŠ¨è§¦å‘ ref value ä¸Šçš„ä¾èµ–</td>
</tr>
<tr>
<td><code>unref(ref)</code></td>
<td>è¿”å› ref.value å€¼</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-56" class="outline-2">
<h2 id="headline-56">
jest ğŸƒè·‘ğŸƒç”¨ä¾‹
</h2>
<div id="outline-text-headline-56" class="outline-text-2">
<p>é™¤äº† runtime-dom æ²¡å®ç°çš„éƒ¨åˆ†ï¼Œéƒ½é€šè¿‡äº†æµ‹è¯•ã€‚</p>
<pre class="example">
@vue/runtime-dom (guessing &#39;runtimeDom&#39;)
created packages/vue/dist/vue.global.js in 1.4s
 FAIL  packages/reactivity/__tests__/effect.spec.ts
  â— Test suite failed to run

    packages/reactivity/__tests__/ref.spec.ts:11:26 - error TS2307: Cannot find module &#39;@vue/runtime-dom&#39; or its corresponding type declarations.

    11 import { computed } from &#39;@vue/runtime-dom&#39;
                                ~~~~~~~~~~~~~~~~~~

 PASS  packages/reactivity/__tests__/reactive.spec.ts
 PASS  packages/reactivity/__tests__/collections/Set.spec.ts
 PASS  packages/reactivity/__tests__/collections/Map.spec.ts
 PASS  packages/reactivity/__tests__/reactiveArray.spec.ts
 PASS  packages/reactivity/__tests__/collections/WeakMap.spec.ts
 PASS  packages/reactivity/__tests__/collections/WeakSet.spec.ts
 PASS  packages/reactivity/__tests__/shallowReactive.spec.ts
 PASS  packages/reactivity/__tests__/readonly.spec.ts
 FAIL  packages/reactivity/__tests__/ref.spec.ts
  â— Test suite failed to run

    Configuration error:

    Could not locate module @vue/runtime-dom mapped as:
    /Users/simon/github/vue/stb-vue-next/packages/$1/src.

    Please check your configuration for these entries:
    {
      &#34;moduleNameMapper&#34;: {
        &#34;/^@vue\/(.*?)$/&#34;: &#34;/Users/simon/github/vue/stb-vue-next/packages/$1/src&#34;
      },
      &#34;resolver&#34;: undefined
    }

      2 |   ref,
      3 |   effect,
    &gt; 4 |   reactive,
        |                      ^
      5 |   isRef,
      6 |   toRef,
      7 |   toRefs,

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/index.js:551:17)
      at Object.&lt;anonymous&gt; (packages/reactivity/__tests__/ref.spec.ts:4:23)

 PASS  packages/reactivity/__tests__/computed.spec.ts

Test Suites: 2 failed, 9 passed, 11 total
Tests:       169 passed, 169 total
Snapshots:   0 total
Time:        15.568 s
</pre>
</div>
</div>
<div id="outline-container-headline-57" class="outline-2">
<h2 id="headline-57">
ç”¨ä¾‹åˆ†æ
</h2>
<div id="outline-text-headline-57" class="outline-text-2">
<div id="outline-container-headline-58" class="outline-3">
<h3 id="headline-58">
Map.spec.ts
</h3>
<div id="outline-text-headline-58" class="outline-text-3">
<ul>
<li class="checked">
<p>instanceof</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">original</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">observed</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
<span class="nx">isReactive</span><span class="p">,</span>
<span class="nx">effect</span><span class="p">,</span>
<span class="nx">reactive</span><span class="p">,</span>
<span class="nx">targetMap</span><span class="p">,</span>
<span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 ob is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">ob</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 </span><span class="si">${</span><span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 </span><span class="si">${</span><span class="nx">ob</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">ob</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 ob is reactive, true
#2 true
#3 true
Map(0) {} Map(0) {}
</pre>
</li>
<li class="checked">
<p>should observe mutations(åº”è¯¥è§‚å¯Ÿå˜åŒ–)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should observe mutations&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">dummy</span>
  <span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="k">new</span> <span class="nx">Map</span><span class="p">())</span>
  <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
  <span class="nx">map</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
  <span class="nx">map</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;value2&#39;</span><span class="p">)</span>
  <span class="nx">map</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
    <span class="nx">isReactive</span><span class="p">,</span>
    <span class="nx">effect</span><span class="p">,</span>
    <span class="nx">reactive</span><span class="p">,</span>
    <span class="nx">targetMap</span><span class="p">,</span>
    <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="k">new</span> <span class="nx">Map</span><span class="p">())</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  +RESULTS:</p>
<pre class="example">
#1 dummy = undefined
#2 dummy = value // set è§¦å‘ trigger effect fn
#3 dummy = value2 // åŒä¸Š
#4 dummy = undefined // åˆ é™¤è§¦å‘ DELETE trigger ä¸è¯¥
</pre>
<p>
  <strong>#4</strong> å±æ€§çš„ ADD | DELETE | SET æ“ä½œé¦–å…ˆä¼šå°†æ‰€æœ‰ä¸è¯¥ key æœ‰å…³çš„ä¾èµ–æ·»åŠ åˆ°å°†æ‰§è¡Œåºåˆ—ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// SET | ADD | DELETE operation
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">depsMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="unchecked">
<p>should observe mutations with observed value as key</p>
<p>
å°† reactive ç±»å‹çš„å€¼ä½œä¸º key çš„æ—¶å€™ä¹Ÿåº”è¯¥èƒ½è¢«è§‚å¯Ÿå˜åŒ–ã€‚</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-test-computed" class="outline-3">
<h3 id="test-computed">
computed.spec.ts
</h3>
<div id="outline-text-test-computed" class="outline-text-3">
<p>
ä¸‹é¢æ‰€æœ‰çš„ç”¨ä¾‹éƒ½å¯ä»¥å‚è€ƒ <a href="#test-computed-01">ç”¨ä¾‹ 01</a> çš„è„‘å›¾(åŸç†å›¾)</p>
<div id="outline-container-test-computed-01" class="outline-4">
<h4 id="test-computed-01">
should return updated value
</h4>
<div id="outline-text-test-computed-01" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should return updated value&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">foo?</span>: <span class="kt">number</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({})</span>
    <span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
    <span class="nx">isReactive</span><span class="p">,</span>
    <span class="nx">effect</span><span class="p">,</span>
    <span class="nx">reactive</span><span class="p">,</span>
    <span class="nx">targetMap</span><span class="p">,</span>
    <span class="nx">shallowReactive</span><span class="p">,</span>
    <span class="nx">computed</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before set value.foo, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after set value.foo, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 before set value.foo, cValue.value = undefined
#2 after set value.foo, cValue.value = 1
</pre>
<p>
åˆ†æç»“æœ</p>
<p>
<strong>#1</strong> : å› ä¸º computed é»˜è®¤æ˜¯ effect lazy çš„ï¼Œæ‰€ä»¥ä¸ä¼šç«‹å³æ‰§è¡Œ effectï¼Œæ‰€ä»¥ cValue ä¹Ÿå°±ä¸ä¼šæœ‰å€¼</p>
<p>
<strong>#2</strong> : æ­¤æ—¶å€¼ä¸º 1ï¼Œå¹¶ä¸æ˜¯å› ä¸º <code>value.foo = 1</code> è§¦å‘çš„ effect æ‰§è¡Œï¼Œ</p>
<p>
è€Œæ˜¯å› ä¸º <code>_dirty</code> é»˜è®¤æ˜¯ <code>true</code> çš„ï¼Œæ‰€ä»¥åœ¨ <strong>#1</strong> å¤„å–å€¼çš„æ—¶å€™è§¦å‘äº†
<code>effect()</code> æ‰§è¡Œï¼Œ <code>_dirty = false</code> äº†ï¼Œå€¼ç»“æœå·²å‡ºã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">effect</span><span class="p">()</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¹Ÿæ­£æ˜¯ç”±äº <code>effect</code> çš„æ‰§è¡Œï¼Œè®© <code>value.foo</code> æ”¶é›†åˆ°äº†è¿™ä¸ªä¾èµ–ã€‚</p>
<p>
éšåè®¾ç½® <code>value.foo</code> ä¹Ÿä¼šå°† computed effect æ‰§è¡Œï¼Œç”±äº options ä¸­æä¾›äº†
schedulerï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œç½® <code>_dirty = true</code> ï¼Œä½†æ˜¯æ­¤æ—¶è®¡ç®—å±æ€§å€¼å¹¶ä¸ä¼šç«‹å³è®¡ç®—å¾—å‡º
ç»“æœ(å› ä¸ºå®ƒçš„è®¡ç®—æ“ä½œå§‹ç»ˆæ˜¯åœ¨ <code>get value()</code> é‡Œé¢å‘ç”Ÿçš„)ï¼Œæ‰€æœ‰å½“ä¸‹æ¬¡å–å€¼æ“ä½œ(å³
<strong>#2</strong> è¡Œæ‰§è¡Œæ—¶)ï¼Œæ£€æµ‹åˆ° <code>_dirty = true</code> äº†æ‰ä¼šé‡æ–°è®¡ç®—è¿”å›æœ€æ–°ç»“æœã€‚</p>
<p>
ç”¨ä¾‹è„‘å›¾ï¼š</p>
<p>
<img src="/img/vue3/reactivity/reactivity-computed-test-01.svg" alt="/img/vue3/reactivity/reactivity-computed-test-01.svg" title="/img/vue3/reactivity/reactivity-computed-test-01.svg" /></p>
</div>
</div>
<div id="outline-container-test-computed-02" class="outline-4">
<h4 id="test-computed-02">
should compute lazily
</h4>
<div id="outline-text-test-computed-02" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should compute lazily&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">foo?</span>: <span class="kt">number</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({})</span>
    <span class="kr">const</span> <span class="nx">getter</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span>

    <span class="c1">// lazy
</span><span class="c1"></span>    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">// should not compute again
</span><span class="c1"></span>    <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">// should not compute until needed
</span><span class="c1"></span>    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">// now it should compute
</span><span class="c1"></span>    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">// should not compute again
</span><span class="c1"></span>    <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">computed</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kr">const</span> <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="o">++</span><span class="nx">n</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span>
<span class="c1">// lazy
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before get value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times.`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 get value(), cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 after get value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>

<span class="c1">// ä¸è¯¥é‡å¤è®¡ç®—ï¼Œå› ä¸º _dirty åœ¨ #3 ä¹‹åå€¼ä¸º false
</span><span class="c1"></span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 after get value 2, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>

<span class="c1">// è§¦å‘ cValue çš„ effect æ‰§è¡Œ schedulerï¼Œä½¿å¾—  _dirty = true
</span><span class="c1"></span><span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">// trigger effect
</span><span class="c1">// å› ä¸ºä¸Šé¢èµ‹å€¼æ“ä½œåªæ˜¯è®© _dirty = true äº†ï¼Œå¹¶æ²¡æœ‰ç«‹å³é‡æ–°è®¡ç®—
</span><span class="c1">// å› ä¸ºè®¡ç®—å±æ€§çš„ç»“æœæ€»æ˜¯åœ¨ get value() æ“ä½œä¸­å®Œæˆçš„
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 after set &#39;value.foo = 1&#39;, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>

<span class="c1">// è¿™é‡Œè¿›è¡Œå–å€¼æ“ä½œï¼Œæ­£å¼å‘èµ·é‡æ–°è®¡ç®—
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#6 should re-compute value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// #6 é‡æ–°è®¡ç®—å _dirty åˆå˜æˆäº† falseï¼Œæ‰€ä»¥ç°åœ¨å–å€¼ä¸ä¼šå†é‡æ–°è®¡ç®—
</span><span class="c1"></span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#7 should not re-compute value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: åˆ†æå¦‚ä»£ç æ³¨é‡Š</p>
<pre class="example">
#1 before get value, getter called 0 times.
#2 get value(), cValue.value = undefined
#3 after get value, getter called 1 times
#4 after get value 2, getter called 1 times
#5 after set &#39;value.foo = 1&#39;, getter called 1 times
#6 should re-compute value, getter called 1 times, cValue.value = 1
#7 should not re-compute value, getter called 2 times, cValue.value = 1
</pre>
<blockquote>
<p>Tips: æ€»æ˜¯è®°ç€è®¡ç®—å±æ€§é‡æ–°è®¡ç®—çš„å…³é”®ç‚¹ï¼šâ€œ_dirty = true ä¸”éšåçš„å–å€¼æ“ä½œâ€ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-test-computed-03" class="outline-4">
<h4 id="test-computed-03">
should no longer update when stopped
</h4>
<div id="outline-text-test-computed-03" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should no longer update when stopped&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">foo?</span>: <span class="kt">number</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({})</span>
    <span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">stop</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">effect</span><span class="p">)</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">computed</span><span class="p">,</span>
  <span class="nx">stop</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set value, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set value, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="c1">// åœæ­¢äº† effect.active = falseï¼Œåœ¨æ‰§è¡Œ effect fn çš„æ—¶å€™
</span><span class="c1">// ä¼šæ£€æµ‹ active å¦‚æœæ˜¯ false ä¼šç›´æ¥æ‰§è¡Œï¼š
</span><span class="c1">// options.scheduler ? undefined : fn()
</span><span class="c1">// è€Œç”±äºè®¡ç®—å±æ€§æ˜¯é»˜è®¤æä¾›äº† scheduler çš„ï¼Œæ‰€ä»¥åœ¨ stop ä¹‹å
</span><span class="c1">// effect å°±ä¸ä¼šè¢«æ‰§è¡Œ
</span><span class="c1"></span><span class="nx">stop</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">effect</span><span class="p">)</span>
<span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after stop and set value, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
before set value, dummy = undefined
after set value, dummy = 1
after stop and set value, dummy = 1
</pre>
</div>
</div>
<div id="outline-container-test-computed-04" class="outline-4">
<h4 id="test-computed-04">
<span class="todo">TODO</span>
should support setter
</h4>
<div id="outline-text-test-computed-04" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should support setter&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">plusOne</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">({</span>
      <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
      <span class="kr">set</span><span class="o">:</span> <span class="nx">val</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">plusOne</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">n</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">plusOne</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nx">plusOne</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-computed-05" class="outline-4">
<h4 id="test-computed-05">
should be readonly
</h4>
<div id="outline-text-test-computed-05" class="outline-text-4">
<p>
åªè¯»ç‰ˆæœ¬ï¼Œæ˜¯æœ‰ computed ä½¿ç”¨çš„æ—¶å€™ä¼ å…¥çš„å‚æ•°(<code>option</code>)å†³å®šçš„ã€‚</p>
<ol>
<li>
<p>å¦‚æœ option æ˜¯å‡½æ•°(<code>getter</code>) é‚£å°±æ˜¯åªè¯»çš„</p>
</li>
<li>
<p>å¦‚æœ option æ˜¯å¯¹è±¡ä¸”æä¾›äº† <code>option.set</code> é‚£ä¹ˆæ˜¯éåªè¯»</p>
</li>
<li>
<p>å¦‚æœ option æ˜¯å¯¹è±¡ä½†æ˜¯æ²¡æœ‰æä¾› <code>option.set</code> é‚£ä¹ˆä¹Ÿæ˜¯åªè¯»çš„</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be readonly&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">a</span>: <span class="kt">1</span> <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">a</span><span class="p">&gt;({</span>
      <span class="kr">get</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span>
      <span class="p">},</span>
      <span class="kr">set</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">isReadonly</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">computed</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">a</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 x is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span> <span class="c1">// true
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 x.value is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 x.value.a is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">({</span>
  <span class="nx">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span>
  <span class="p">},</span>
  <span class="nx">set</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 z is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 z.value.a is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 x is readonly, true
#2 x.value is readonly, false
#3 x.value.a is readonly, false
#4 z is readonly, false
#5 z.value.a is readonly, false
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-65" class="outline-3">
<h3 id="headline-65">
effect.ts
</h3>
<div id="outline-text-headline-65" class="outline-text-3">
<div id="outline-container-test-01" class="outline-4">
<h4 id="test-01">
effect + track + trigger
</h4>
<div id="outline-text-test-01" class="outline-text-4">
<p>
commit: <a href="https://github.com/gcclll/stb-vue-next/commit/b5f97b413d4628f4ec8fcf4e859d387ebfac3ad8">feat: effect-trigger Â· gcclll/stb-vue-next@b5f97b4</a></p>
<ol>
<li>
<p>lazy: true æ ‡è¯† effect fn ä¸ä¼šç«‹å³æ‰§è¡Œ</p>
</li>
<li>
<p>ç‚¹å‡» set æ“ä½œï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰ä¾èµ–ï¼Œæ‰€ä»¥åªä¼šè§¦å‘ count++</p>
</li>
<li>
<p>å½“ç‚¹å‡» get æ“ä½œï¼Œè§¦å‘ <code>track()</code> æ”¶é›†ä¾èµ– fn -&gt; deps</p>
</li>
<li>
<p>å†ç‚¹å‡» set æ“ä½œï¼Œæ­¤æ—¶å·²ç»æœ‰ä¾èµ–ï¼Œæ‰€ä»¥ä¼š <code>trigger()</code> æ‰€æœ‰ä¾èµ–æ›´æ–°</p>
</li>
<li>
<p>options.scheduler é€‰é¡¹ä½œç”¨</p>
<p>
å¦‚æœ options æœ‰ scheduler é€‰é¡¹ï¼Œ <code>trigger()</code> çš„æ—¶å€™ä¸ä¼šç«‹å³æ‰§è¡Œ effects è€Œæ˜¯
è°ƒç”¨ scheduler å¹¶å°†å½“å‰éœ€è¦è¢«æ‰§è¡Œçš„ effect å½“åšå‚æ•°ç»™ schedulerï¼Œç”±ä½¿ç”¨è€…å†³å®š
ä½•æ—¶å»æ‰§è¡Œ effectï¼Œæ¯”å¦‚éœ€è¦åœ¨ dummy æ›´æ–°ä¹‹å‰åšç‚¹ä»€ä¹ˆã€‚</p>
</li>
</ol>
<style>
#_effect_test_02>.box {
  display: flex;
  justify-content: space-around;
}
#_effect_test_02>.box>button{
  border: none;
  width: 250px;
}
</style>
<div id="_effect_test_02">
<div class="box">
    <button class="getval">ç‚¹æˆ‘è§¦å‘ getæ“ä½œï¼</button>
    <button class="setval">ç‚¹æˆ‘è§¦å‘ setæ“ä½œï¼</button>
</div>
<br>
<div class="box">
    <button class="before-scheduler">æ‰‹åŠ¨è°ƒç”¨ scheduler ä¹‹å‰</button>
    <button class="after-scheduler">æ‰‹åŠ¨è°ƒç”¨ scheduler ä¹‹å</button>
</div>
<br>
<div class="box">
    <button class="code">ç‚¹å‡»æŸ¥çœ‹æµ‹è¯•æºç </button>
    <button class="reset">é‡ç½®</button>
</div>
<div class="result"></div>
<code></code>
</div>
<script id="GW0MDx">
setTimeout(function test() {
    if (typeof $ === 'undefined') return

    var ins = VueReactivity
    var effect = ins.effect
    var reactive = ins.reactive
    var target = { count: 0 }
    var counter = reactive(target)

    var $el = $("#_effect_test_02")
    var LOG = function (msg) {
      _log($el, msg)
    }

    var lazyEffect = effect(
      function fn() {
        var c = counter.count
        LOG('æ­£åœ¨æ‰§è¡Œ effect fn..., counter.count = ' + counter.count)
      }, {
        lazy: true
      }
    )

    var effected = false
    var getDeps = function () {
      if (!ins.targetMap) return new Set()
      const depsMap = ins.targetMap.get(target) || new Map()
      return depsMap.get('count') || new Set()
    }
    $el.find(".setval").click(function() {
      counter.count++
      var size = getDeps().size
      if (size === 0) {
        LOG('target æ­¤æ—¶æ— ä»»ä½•ä¾èµ–ï¼Œdeps.size = ' + size + ', counter.count = ' + counter.count)
      }
    })
    $el.find(".reset").click(function() {
      ins.cleanup(lazyEffect)
      $el.children(".result").html('')
      effected = false
      counter.count = 0
      dummy = 0
      runner = undefined
      times = 0
      LOG('target.count deps.size = ' + getDeps().size)
    })
    $el.find(".getval").click(function() {
      if (!effected) {
        effected = true
        lazyEffect() // æ‰‹åŠ¨æ‰§è¡Œ effect
        LOG('æ‰‹åŠ¨æ‰§è¡Œ effect()ï¼Œå¼€å§‹æ”¶é›†ä¾èµ– fn -> deps<Set>, size: ' + getDeps().size)
      }
      LOG('å–å€¼æ“ä½œ(target.count çš„ deps æ•°)ï¼š'
        + ins.targetMap.get(target).get('count').size
        + ', counter.count = ' + counter.count)
    })

    $el.find('.code').click(function() {
      console.log($("#GW0MDx").html())
      LOG('æºç å·²è¾“å‡ºåˆ°æ§åˆ¶å°(F12-console)....')
    })

    var dummy = 0, runner
    var counter1 = reactive({ count: 0 })
    var times = 0
    var schedulerEffect = effect(function fn() {
      dummy = counter1.count
    }, {
      scheduler: function(_effect) {
        LOG('scheduler æ‰§è¡Œæ¬¡æ•° ' + ++times + ', dummy = ' + dummy)
        runner = function() {
          _effect()
        }
      }
    })

    LOG('scheduler effect fn ç¬¬ä¸€æ¬¡ä¼šè¢«æ‰§è¡Œï¼Œ dummy = ' + dummy)
    $el.find('.before-scheduler').click(function() {
      LOG('scheduler ä¸ä¼šè¢«æ‰§è¡Œ, dummy = ' + dummy)
    })

    $el.find('.after-scheduler').click(function() {
      counter1.count++
      runner()
    })
}, 1000)

</script>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-67" class="outline-2">
<h2 id="headline-67">
effect æµ‹è¯•
</h2>
<div id="outline-text-headline-67" class="outline-text-2">
<div id="outline-container-headline-68" class="outline-4">
<h4 id="headline-68">
æµ‹è¯•1(base, prototype)
</h4>
<div id="outline-text-headline-68" class="outline-text-4">
<p>
æµ‹è¯•å†…å®¹ï¼š</p>
<ol>
<li>
<p>effect åŸºæœ¬ä½¿ç”¨</p>
</li>
<li>
<p>effect ä½œç”¨åŸŸåŸå‹é“¾</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// åªæ‰§è¡Œä¸€æ¬¡ effect fn
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="c1">// åŸºæœ¬çš„æµ‹è¯•ç”¨ä¾‹å°±ä¸åˆ—å‡ºæ¥äº†ï¼Œè¿™é‡Œåªåˆ—å‡ºæœ‰ç–‘é—®çš„
</span><span class="c1">// 1. effect fn åªæ‰§è¡Œä¸€æ¬¡
</span><span class="c1">// 2. observe åŸºæœ¬å±æ€§
</span><span class="c1">// 3. observe å¤šä¸ªå±æ€§(n1,n2...) -&gt; effect(() =&gt; (dummy = obj.n1 + obj.n2))
</span><span class="c1">// 4. åŒä¸€ä¸ªå±æ€§å¤šä¸ª effectï¼Œä¼šå°†è¿™å¤šä¸ª effects æ”¶é›†åˆ° prop çš„ deps ä¸­
</span><span class="c1">// 5. observe å±æ€§åˆ é™¤
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span> <span class="nx">dummy1</span><span class="p">,</span> <span class="nx">dummy2</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="p">{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span><span class="p">))</span> <span class="c1">// effect -&gt; ob, ob.foo, ob.foo.bar deps
</span><span class="c1"></span><span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy1</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, dummy1 = </span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">8</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, dummy1 = </span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, dummy1 = </span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; åŸå‹é“¾`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">obj1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="nx">obj2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">obj1</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">parentCounter</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">obj2</span><span class="p">)</span>
<span class="c1">// å–å€¼åŸç†ï¼š å…ˆè‡ªèº«å†å¾€ä¸Šæ‰¾åŸå‹é“¾ï¼Œæ‰€æœ‰åªè¦
</span><span class="c1"></span><span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">parentCounter</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">counter</span><span class="p">.</span><span class="nx">num</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; #1 obj1.num çš„ä¾èµ–`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj1</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; #2 obj2.num çš„ä¾èµ–, delete ä¹‹å‰`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj2</span><span class="p">))</span>
<span class="k">delete</span> <span class="nx">counter</span><span class="p">.</span><span class="nx">num</span> <span class="c1">// è¿™é‡Œåˆ é™¤äº†å±æ€§ï¼Œè§¦å‘ effect fn é‡Œé¢å–å€¼æ“ä½œå‘ç°æ²¡æœ‰å±æ€§äº†
</span><span class="c1">// å¾€åŸå‹é“¾æ‰¾ï¼Œæ‰¾åˆ° parentCounter.num ï¼Œæ­¤æ—¶ parentCounter.num æ”¶é›† effect fn è¿›è‡ªå·±çš„ deps
</span><span class="c1">// æ‰€ä»¥åé¢çš„ parentCounter.num ä¸Šçš„æ“ä½œåŒæ ·ä¼šè§¦å‘ effect fn
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; #3 obj2.num çš„ä¾èµ–, delete ä¹‹å`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj2</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">))</span>
<span class="nx">parentCounter</span><span class="p">.</span><span class="nx">num</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 after &#39;parentCounter.num = 4&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">num</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 after counter.num = 3&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç»“æœåˆ†æï¼š</p>
<ul>
<li>
<p><strong>#1</strong> obj1.num ä¾èµ–æ˜¯åœ¨ effect ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™æ”¶é›†çš„</p>
</li>
<li>
<p><strong>#2</strong> obj2.num åœ¨æ‰§è¡Œ <code>delete counter.num</code> ä¹‹å‰æ˜¯æ²¡æœ‰ä»»ä½•ä¾èµ–</p>
<p>
å› ä¸ºæ­¤æ—¶å¹¶æ²¡æœ‰ä»»ä½• <code>parentCounter</code> ä¸Šçš„æ“ä½œ</p>
</li>
<li>
<p><strong>#3</strong> obj2.num æœ‰äº†è‡ªå·±çš„ä¾èµ–</p>
<p>
æ­¤æ—¶ï¼Œæ‰§è¡Œäº† <code>delete counter.num</code> é€»è¾‘å¦‚ä¸‹ï¼š</p>
<p>
å¯¹ counter.num æ‰§è¡Œåˆ é™¤ä¼šè§¦å‘ <code>num</code> ä¸Šçš„æ‰€æœ‰ä¾èµ– depsï¼Œå³æ‰§è¡Œ effect fnï¼Œ</p>
<p>
åœ¨ effect fn é‡Œé¢æœ‰ <code>counter.num</code> çš„å–å€¼æ“ä½œï¼Œä½†æ˜¯å‘ç°å±æ€§è¢«åˆ é™¤ï¼Œæ ¹æ®å–å€¼æŸ¥æ‰¾
åŸç†ï¼Œä¼šåœ¨å¯¹è±¡çš„åŸå‹é“¾ä¸Šé€çº§å¾€ä¸ŠæŸ¥æ‰¾(<code>parentCounter</code>)ï¼Œæ‰¾åˆ°
<code>parentCounter.num</code> éšæœºè¿›è¡Œå–å€¼æ“ä½œï¼Œæ‰€ä»¥åˆ é™¤æ“ä½œä¹‹åçš„ <code>dummy = 2</code> ï¼Œä¸”å–å€¼
æ“ä½œè§¦å‘ tracking å› æ­¤æ­¤æ—¶ <code>parentCounter.num</code> å°±æœ‰äº†è‡ªå·±çš„ä¾èµ– effect fnã€‚</p>
</li>
<li>
<p><strong>#4</strong> ç»™ parentCounter è®¾å€¼è§¦å‘ effect fnï¼ŒæŸ¥æ‰¾åŸå‹é“¾ , æ‰€ä»¥ dummy = 4</p>
</li>
<li>
<p><strong>#5</strong> ç»™ counter è®¾å€¼è§¦å‘ effect fnï¼Œä¸æŸ¥æ‰¾åŸå‹é“¾(è‡ªèº«å±æ€§)ï¼Œæ‰€ä»¥ dummy = 3</p>
</li>
</ul>
<p>+RESULTS:</p>
<pre class="example">
before set, dummy = 0, dummy1 = 0
after set, dummy = 8, dummy1 = 8
after delete, dummy = undefined, dummy1 = undefined
&gt;&gt;&gt; åŸå‹é“¾
dummy = 0
&gt; #1 obj1.num çš„ä¾èµ–
&lt;ref *1&gt; Set(1) {
  [Function: reactiveEffect] {
    id: 2,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1] ],
    options: {}
  }
}
&gt; #2 obj2.num çš„ä¾èµ–, delete ä¹‹å‰
undefined
after delete, dummy = 2
&gt; #3 obj2.num çš„ä¾èµ–, delete ä¹‹å
&lt;ref *1&gt; Set(1) {
  [Function: reactiveEffect] {
    id: 2,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1], [Set] ],
    options: {}
  }
}
#4 after &#39;parentCounter.num = 4&#39;, dummy = 4
#5 after counter.num = 3&#39;, dummy = 3
undefined
</pre>
</div>
</div>
<div id="outline-container-effect-test-02" class="outline-4">
<h4 id="effect-test-02">
æµ‹è¯•2(stop, â€¦)
</h4>
<div id="outline-text-effect-test-02" class="outline-text-4">
<ol>
<li>
<p><strong>stop</strong> :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">shallowReactive</span><span class="p">,</span>
     <span class="nx">stop</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; stop effect`</span><span class="p">)</span>
 <span class="kd">let</span> <span class="nx">dummy</span>
 <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">prop</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
 <span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
     <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span>
 <span class="p">})</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">2</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1, after &#39;obj.prop = 2&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; prop deps, before stop`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="mi">__</span><span class="nx">v_raw</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;prop&#39;</span><span class="p">))</span>
 <span class="c1">// æ¸…ç©ºäº†æ‰€æœ‰ä¾èµ–
</span><span class="c1"></span> <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span> <span class="c1">// stop the effect, set effect.active = false
</span><span class="c1"></span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; prop deps, after stop`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="mi">__</span><span class="nx">v_raw</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;prop&#39;</span><span class="p">))</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">3</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2, after stop, &#39;obj.prop = 3&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">4</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3, after stop, &#39;obj.prop = 4&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">runner</span><span class="p">()</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4, after run runner, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, runner.active = </span><span class="si">${</span><span class="nx">runner</span><span class="p">.</span><span class="nx">active</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 +RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; stop effect
#1, after &#39;obj.prop = 2&#39;, dummy = 2
&gt; prop deps, before stop
&lt;ref *1&gt; Set(1) {
[Function: reactiveEffect] {
    id: 0,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1] ],
    options: {}
}
}
&gt; prop deps, after stop
Set(0) {}
#2, after stop, &#39;obj.prop = 3&#39;, dummy = 2
#3, after stop, &#39;obj.prop = 4&#39;, dummy = 2
#4, after run runner, dummy = 4, runner.active = false
undefined
</pre>
<ul>
<li>
<p>stop å¹²äº†ä¸¤ä»¶äº‹(a. æ¸…ç©ºæ‰€æœ‰ effect.deps, b. å°† effect.active ç½®ä¸º false)</p>
</li>
<li>
<p>stop ä¹‹å trigger æ—¶æ²¡æœ‰ deps å¯æ‰§è¡Œï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½• effect fn ä¸ä¼šè¢«æ‰§è¡Œ</p>
</li>
<li>
<p>æ‰‹åŠ¨æ‰§è¡Œ runner() ä¹‹åæ‰§è¡Œeffect fn é‡æ–°æ”¶é›†ä¾èµ–(æ­¤æ—¶ active ä¾æ—§ä¸º <code>false</code>)</p>
</li>
</ul>
</li>
<li>
<p><strong>stop + scheduler</strong> :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">stop</span><span class="p">,</span>
     <span class="nx">shallowReactive</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

 <span class="kd">let</span> <span class="nx">dummy</span>
 <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">prop</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
 <span class="kr">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span><span class="p">),</span> <span class="p">{</span> <span class="nx">scheduler</span><span class="o">:</span> <span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">})</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">2</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 after &#39;obj.prop = 2&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after &#39;obj.prop = 2&#39;, queue.length = </span><span class="si">${</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>

 <span class="nx">queue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">e</span><span class="p">())</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 after stop, queue forEach, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 +RESULTS:</p>
<pre class="example">
#1 after &#39;obj.prop = 2&#39;, dummy = 1
#2 after &#39;obj.prop = 2&#39;, queue.length = 1
#3 after stop, queue forEach, dummy = 1
</pre>
<p>
 æä¾›äº† scheduler é€‰é¡¹çš„ effect æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œæºç ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effect</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><strong>onStop</strong> :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">stop</span><span class="p">,</span>
     <span class="nx">shallowReactive</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

 <span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span>
 <span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{},</span> <span class="p">{</span>
     <span class="nx">onStop</span><span class="p">()</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`stopped </span><span class="si">${</span><span class="o">++</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>
     <span class="p">}</span>
 <span class="p">})</span>

 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>
 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>
 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 +RESULTS:</p>
<pre class="example">
stopped 1 times
</pre>
<p>
 åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸º <code>effect.active = true</code> æ—¶æ‰å¯ä»¥è¢« stop ã€‚</p>
</li>
<li>
<p><strong>stop: ä¸€ä¸ª stopped çš„ effect åœ¨ä¸€ä¸ªæ­£å¸¸çš„ effect ä¸­è°ƒç”¨</strong></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">stop</span><span class="p">,</span>
     <span class="nx">shallowReactive</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">prop</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span>
<span class="p">})</span>

<span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 after stop runner, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// è¿™é‡Œç­‰äºæ˜¯æ‰‹åŠ¨æ‰§è¡Œäº† runner effect `dummy = obj.prop`
</span><span class="c1">// æ‰€ä»¥ä¸‹é¢çš„ effect è¢« obj.prop æ”¶é›†è¿› deps&lt;Set&gt;
</span><span class="c1"></span><span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">runner</span><span class="p">()</span>
<span class="p">})</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after runner in effect, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 after stop runner, dummy = 1
#2 after runner in effect, dummy = 3
</pre>
<ol>
<li>
<p><strong>#1</strong> å€¼ä¾æ—§æ˜¯ 1 ï¼Œæ˜¯å› ä¸º stop äº†</p>
</li>
<li>
<p><strong>#2</strong> å€¼ä¸º 3ï¼Œæ˜¯å› ä¸º effect æ‰§è¡Œ runner() ä½¿å¾— <code>obj.prop</code> æ”¶é›†åˆ°ç¬¬äºŒä¸ª
effect fn ã€‚</p>
</li>
</ol>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-whole-mind-map" class="outline-2">
<h2 id="whole-mind-map">
å®Œæ•´è„‘å›¾
</h2>
<div id="outline-text-whole-mind-map" class="outline-text-2">
<p>
<img src="/img/vue3/reactivity/reactivity.svg" alt="/img/vue3/reactivity/reactivity.svg" title="/img/vue3/reactivity/reactivity.svg" /></p>
<div id="outline-container-mind-collection" class="outline-3">
<h3 id="mind-collection">
collection proxy handlers è„‘å›¾
</h3>
<div id="outline-text-mind-collection" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-collection-proxy.svg" alt="/img/vue3/reactivity/reactivity-collection-proxy.svg" title="/img/vue3/reactivity/reactivity-collection-proxy.svg" /></p>
</div>
</div>
<div id="outline-container-mind-effect" class="outline-3">
<h3 id="mind-effect">
effect è„‘å›¾
</h3>
<div id="outline-text-mind-effect" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-effect.svg" alt="/img/vue3/reactivity/reactivity-effect.svg" title="/img/vue3/reactivity/reactivity-effect.svg" /></p>
</div>
</div>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2020-11-09
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/compiler-core/">compiler-core,</a>
          <a href="/tags/parser/">parser,</a>
          <a href="/tags/compiler/">compiler</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-compiler-core-parser/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 2 â˜compiler-core - ast parser</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-house-cc/">
            <span class="next-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹â˜compiler-core</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
