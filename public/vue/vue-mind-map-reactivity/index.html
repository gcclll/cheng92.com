<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 源码头脑风暴之 1 ☞reactivity - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="更新日志&amp;amp;Todos ： DONE [2021-01-20 15:16:45] ref 诗号：六道同坠，魔劫万千，引渡如来。 function _log(el, content)" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-reactivity/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.06b20cf21b1dff0a19c6a6fd2770439ed0c003d544ece3c4e1fbfb34fc217e45.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 源码头脑风暴之 1 ☞reactivity" />
<meta property="og:description" content="更新日志&amp;Todos ： DONE [2021-01-20 15:16:45] ref 诗号：六道同坠，魔劫万千，引渡如来。 function _log(el, content)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-reactivity/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2020-11-09T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-11-09T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 源码头脑风暴之 1 ☞reactivity">
<meta itemprop="description" content="更新日志&amp;Todos ： DONE [2021-01-20 15:16:45] ref 诗号：六道同坠，魔劫万千，引渡如来。 function _log(el, content)"><meta itemprop="datePublished" content="2020-11-09T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-11-09T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="18779">
<meta itemprop="keywords" content="vue,,vue3,,compiler-core,,parser,,compiler," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 源码头脑风暴之 1 ☞reactivity"/>
<meta name="twitter:description" content="更新日志&amp;Todos ： DONE [2021-01-20 15:16:45] ref 诗号：六道同坠，魔劫万千，引渡如来。 function _log(el, content)"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 源码头脑风暴之 1 ☞reactivity</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-09 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> 约 18779 字 </span>
          <span class="more-meta"> 预计阅读 38 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">关键知识点</a>
</li>
<li><a href="#init">init project</a>
</li>
<li><a href="#fn cro">add: createReactiveObject</a>
</li>
<li><a href="#headline-4">feat: reactive(target)</a>
<ul>
<li><a href="#headline-5">用例一：普通对象</a>
</li>
<li><a href="#headline-6">用例二：原型</a>
</li>
<li><a href="#headline-7">用例三：嵌套对象</a>
</li>
<li><a href="#headline-8">用例四：代理后的对象操作也会体现在原对象上</a>
</li>
<li><a href="#headline-9">用例五：原始对象上的操作也要能在代理后对象有所体现</a>
</li>
<li><a href="#headline-10">用例六：被设置的值如果是对象，该对象也会被 Reactive</a>
</li>
<li><a href="#headline-11">用例七：不该重复 proxy，返回第一个 proxy 结果</a>
</li>
<li><a href="#headline-12">用例八：不应该用 proxies 污染原始对象？</a>
</li>
</ul>
</li>
<li><a href="#headline-13">basic proxy get handler(createGetter)</a>
</li>
<li><a href="#r-track-effect">add track() and effect()</a>
<ul>
<li><a href="#r-track">track(target, type, key) 监听取值收集依赖：</a>
</li>
<li><a href="#fn-effect">effect(fn, options)</a>
</li>
</ul>
</li>
<li><a href="#headline-17">add trigger() proxy set handler</a>
<ul>
<li><a href="#headline-18">proxy set handler(createSetter)</a>
</li>
<li><a href="#r-trigger">trigger()</a>
</li>
</ul>
</li>
<li><a href="#headline-20">observe object recursively</a>
</li>
<li><a href="#effect-track-trigger">effect -&gt; track -&gt; trigger 关系图</a>
</li>
<li><a href="#c-delete">add delete(<strong>deleteProperty</strong>) proxy handler</a>
</li>
<li><a href="#headline-23">add has, ownKeys proxy handlers</a>
</li>
<li><a href="#headline-24">add array support</a>
</li>
<li><a href="#headline-25">array add element support</a>
</li>
<li><a href="#headline-26">add shallow reactive</a>
</li>
<li><a href="#headline-27">add readonly reactive</a>
<ul>
<li><a href="#headline-28">测试(for <code>Object</code>)：</a>
</li>
<li><a href="#headline-29">测试(for <code>Array</code>):</a>
</li>
<li><a href="#headline-30">测试(reactive, readonly 互撩)</a>
</li>
</ul>
</li>
<li><a href="#headline-31">add shallow readonly reactive</a>
</li>
<li><a href="#headline-32">add effect stop</a>
</li>
<li><a href="#headline-33">集合类型代理(proxy handlers)脑图</a>
</li>
<li><a href="#headline-34">add collection handlers</a>
</li>
<li><a href="#headline-35">add collection get proxy handler</a>
<ul>
<li><a href="#key-collection-proxy-get">实现顺序(原理)</a>
</li>
<li><a href="#headline-37">12bc4da add get handler</a>
</li>
<li><a href="#headline-38">0b3fd71 add get handler track</a>
</li>
<li><a href="#headline-39">77b14ef add get handler return value</a>
</li>
</ul>
</li>
<li><a href="#headline-40">add collection set proxy handler</a>
</li>
<li><a href="#headline-41">add collection size,has,add proxy handler</a>
</li>
<li><a href="#headline-42">add collection delete,clear proxy handler</a>
</li>
<li><a href="#headline-43">add collection forEach proxy handler</a>
</li>
<li><a href="#headline-44">add collection iterators methods proxy handler</a>
</li>
<li><a href="#headline-45">add collection readonly proxy handlers</a>
</li>
<li><a href="#headline-46">add collection shallow proxy handlers</a>
</li>
<li><a href="#computed">computed</a>
<ul>
<li><a href="#headline-48">types definitions</a>
</li>
<li><a href="#headline-49">implementation</a>
</li>
</ul>
</li>
<li><a href="#ref">add ref</a>
<ul>
<li><a href="#headline-51">ref &amp; shallow ref</a>
</li>
<li><a href="#headline-52">object ref</a>
</li>
<li><a href="#headline-53">ref proxy</a>
</li>
<li><a href="#headline-54">custom ref</a>
</li>
<li><a href="#headline-55">辅助函数</a>
</li>
</ul>
</li>
<li><a href="#headline-56">jest 🏃跑🏃用例</a>
</li>
<li><a href="#headline-57">用例分析</a>
<ul>
<li><a href="#headline-58">Map.spec.ts</a>
</li>
<li><a href="#test-computed">computed.spec.ts</a>
<ul>
<li><a href="#test-computed-01">should return updated value</a>
</li>
<li><a href="#test-computed-02">should compute lazily</a>
</li>
<li><a href="#test-computed-03">should no longer update when stopped</a>
</li>
<li><a href="#test-computed-04">should support setter</a>
</li>
<li><a href="#test-computed-05">should be readonly</a>
</li>
</ul>
</li>
<li><a href="#headline-65">effect.ts</a>
<ul>
<li><a href="#test-01">effect + track + trigger</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#headline-67">effect 测试</a>
<ul>
<li><a href="#headline-68">测试1(base, prototype)</a>
</li>
<li><a href="#effect-test-02">测试2(stop, …)</a>
</li>
</ul>
</li>
<li><a href="#whole-mind-map">完整脑图</a>
<ul>
<li><a href="#mind-collection">collection proxy handlers 脑图</a>
</li>
<li><a href="#mind-effect">effect 脑图</a>
</li>
</ul>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<blockquote>
<p><strong>更新日志&amp;Todos</strong> ：</p>
<ol>
<li>
<p>DONE [2021-01-20 15:16:45] ref</p>
</li>
</ol>
</blockquote>
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<script src="/js/vue/reactivity.global.js"></script>
<script>
function _log(el, content) {
  $(el).children('.result').append('<p>' + content + '</p>')
}
</script>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> 完全拷贝于 <a href="https://github.com/vuejs/vue-next">vue-next</a> ，主要目的学习及尝试应用于机顶盒环境。</strong>
</kbd></p>
<p>
<kbd> <strong>本文依据 commit 进程进行记录</strong> </kbd></p>
<blockquote>
<p>所有用例请按 <code>&lt;f12&gt;</code> 打开控制台查看 &gt;</p>
</blockquote>
<script>
let i = 0, j = 0
const l1 = x => (j = 0, console.log(`%c >>> ${++i} ${x}`, 'background: #222; color: #bada55'))
const l2 = x => console.log(`%c > ${i}.${j++} ${x}`, 'background: #222; color: #bada55')
const log = (args) => console.log.apply(console, Array.isArray(args) ? args : [args])
log.blue = x => log([`%c ${x}`, `color: blue`])
log.red = x => log([`%c ${x}`, `color: red`])
log.gray = x => log([`%c ${x}`, `color: gray`])
log.blues = xx => xx.forEach(x => log.blue(x))
log.gray.fn = (fn) => (log.gray(fn), fn())
</script>
<script>
const { reactive, isReactive, expect } = VueReactivity
l1(`reactivity/reacitve`)
l2(`Object`)
log.gray.fn(() => {
  let original = { foo: 1 }
  let observed = reactive(original)
  log.blues([
    `observed !== original, ` + (original !== observed),
    `observed is reactive, ` + isReactive(observed),
    `original is reactive, ` + isReactive(original),
    `observed.foo === ` + observed.foo,
    `"foo" in observed, ` + ('foo' in observed),
    `own keys: ` + Object.keys(observed)
  ])
})
l2(`proto, 原型响应式`)
log.gray.fn(() => {
  const obj = {}
  const reactiveObj = reactive(obj)
  // 属性读取，会导致该属性也变成 reactive
  const prototype = reactiveObj['__proto__']
  const otherObj = { data: ['a'] }
  log.blues([
    `"reactiveObj" is reactive, ` + isReactive(reactiveObj),
    `otherObj is reactive, ` + isReactive(otherObj) ,
  ])
  const reactiveOther = reactive(otherObj)
  log.blues([
    `reactiveOther is reactive, ` + isReactive(otherObj),
    `reactiveOther.data[0] = ` + reactiveOther.data[0]
  ])
})
</script>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
关键知识点
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ul>
<li class="indeterminate">
<p><a href="#test-computed-01">计算属性是如何实现结果缓存的？</a></p>
</li>
</ul>
</div>
</div>
<div id="outline-container-init" class="outline-2">
<h2 id="init">
init project
</h2>
<div id="outline-text-init" class="outline-text-2">
<p>
初始化项目：<a href="https://github.com/gcclll/stb-vue-next/commit/cb3470d7c3f2944fd23e9155fc8a6afb7a51a732">feat: reactive-fn · gcclll/stb-vue-next@cb3470d</a></p>
<p>
<a href="#while-mind-map">由于完整脑图会比较全而大所以放到文字最后去。。。</a></p>
<p>
<a href="/img/vue3/reactivity/reactivity.svg">也可以点击该链接直接新窗口打开，效果更佳。</a></p>
</div>
</div>
<div id="outline-container-fn cro" class="outline-2">
<h2 id="fn cro">
add: createReactiveObject
</h2>
<div id="outline-text-fn cro" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cb3470d7c3f2944fd23e9155fc8a6afb7a51a732">feat: reactive-fn · gcclll/stb-vue-next@cb3470d</a></p>
<p>
<img src="/img/vue3/reactivity/reactivity-reactive.svg" alt="/img/vue3/reactivity/reactivity-reactive.svg" title="/img/vue3/reactivity/reactivity-reactive.svg" /></p>
<p>
仅增加函数声明:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 如果试图 observe 一个只读 proxy，返回只读版本
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="nx">Target</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">target</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">createReactiveObject</span><span class="p">(</span>
    <span class="nx">target</span><span class="p">,</span>
    <span class="kc">false</span><span class="p">,</span>
    <span class="nx">mutableHandlers</span><span class="p">,</span>
    <span class="p">{}</span>
    <span class="c1">// mutableCollectionHandlers
</span><span class="c1"></span>  <span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createReactiveObject</span><span class="p">(</span>
  <span class="nx">target</span>: <span class="kt">Target</span><span class="p">,</span>
  <span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">baseHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;,</span>
  <span class="nx">collectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>mutableHandlers</strong>: 普通对象类型的 proxy handlers</p>
<p>
<strong>mutableCollectionHandlers</strong>: 集合类型的 proxy handlers，因为 <code>Reflect</code> 并没有对集
合类型做底层映射，所以需要特殊处理。</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
feat: reactive(target)
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/443a0b5920efaf714de08b0975c17f1d652815e4">feat: createReactiveObject · gcclll/stb-vue-next@443a0b5</a></p>
<p>
<img src="/img/vue3/reactivity/reactivity-create-reactive-object.svg" alt="/img/vue3/reactivity/reactivity-create-reactive-object.svg" title="/img/vue3/reactivity/reactivity-create-reactive-object.svg" /></p>
<ol>
<li>
<p>重点： <code>new Proxy(target, collection)</code></p>
</li>
<li>
<p>被代理类型必须是对象(引用类型)</p>
</li>
<li>
<p>target 本身已经是 proxy 了</p>
</li>
<li>
<p>target 代理有缓存不用重复创建</p>
</li>
<li>
<p>必须是合法的类型(<code>Object|Array|[Weak]Map|[Weak]Set</code>)才能被代理</p>
</li>
<li>
<p>记得缓存新创建的代理关系(<code>proxyMap</code> 全局变量)</p>
</li>
</ol>
<div id="outline-container-headline-5" class="outline-4">
<h4 id="headline-5">
用例一：普通对象
</h4>
<div id="outline-text-headline-5" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span><span class="p">,</span> <span class="nx">isReactive</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;observed is not orignial,&#39;</span> <span class="o">+</span> <span class="nx">original</span> <span class="o">!==</span> <span class="nx">observed</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;observed is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;original is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;observed.foo === 1, &#39;</span> <span class="o">+</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;`foo` in observed, &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="sb">`foo`</span> <span class="k">in</span> <span class="nx">observed</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Object.keys(observed) == [&#39;foo&#39;], `</span> <span class="o">+</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">observed</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;foo&#39;</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
true
observed is reactive, true
original is reactive, false
false
`foo` in observed, true
Object.keys(observed) == [&#39;foo&#39;], true
undefined
</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1005ef30d5367fe306a4cfeb7e00c1cd56b1c691">b2143f9</a> FIX: <code>isReactive(observed): false</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1005ef30d5367fe306a4cfeb7e00c1cd56b1c691">fix: get object&#39;s __v_isReactive prop · gcclll/stb-vue-next@1005ef3</a></p>
<p>
在 <code>createGetter</code> 中增加判断，如果来取的属性为 <code>__v_isReactive</code> 则直接返回
<code>!isReadonly</code> 。</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-4">
<h4 id="headline-6">
用例二：原型
</h4>
<div id="outline-text-headline-6" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">const</span> <span class="nx">reactiveObj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;reactiveObj is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">reactiveObj</span><span class="p">))</span>
<span class="kr">const</span> <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">reactiveObj</span><span class="p">[</span><span class="s1">&#39;__proto__&#39;</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">otherObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;otherObj is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">otherObj</span><span class="p">))</span>
<span class="kr">const</span> <span class="nx">reactiveOther</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">otherObj</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;reactiveOther is reactive, &#39;</span> <span class="o">+</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">reactiveOther</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;reactiveOther.data[0] is `a`, &#39;</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">reactiveOther</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;a&#39;</span> <span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`__proto__, `</span> <span class="o">+</span> <span class="nx">prototype</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
reactiveObj is reactive, true
otherObj is reactive, false
reactiveOther is reactive, true
reactiveOther.data[0] is `a`, true
__proto__, [object Object]
undefined
</pre>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/1e2a3fef77b4a2b5f4dc3c497296b30b4ff06883">1005ef3</a> 当取值时属性名为 <code>__proto__</code> 时：直接返回取值结果。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1e2a3fef77b4a2b5f4dc3c497296b30b4ff06883">feat: get key is symbol or <span style="text-decoration: underline;"><span style="text-decoration: underline;">proto</span></span> or __v_isRef · gcclll/stb-vue-next@1e2a3fe</a></p>
</div>
</div>
<div id="outline-container-headline-7" class="outline-4">
<h4 id="headline-7">
用例三：嵌套对象
</h4>
<div id="outline-text-headline-7" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span><span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">nested</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nx">array</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}]</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.nested is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">nested</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.array is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">array</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.array[0] is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.nested is reactive true
observed.array is reactive true
observed.array[0] is reactive true
</pre>
</div>
</div>
<div id="outline-container-headline-8" class="outline-4">
<h4 id="headline-8">
用例四：代理后的对象操作也会体现在原对象上
</h4>
<div id="outline-text-headline-8" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span>
      <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">or</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">or</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ob.bar = </span><span class="si">${</span><span class="nx">ob</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">, or.bar = </span><span class="si">${</span><span class="nx">or</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&#39;foo&#39; in ob: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">ob</span><span class="si">}</span><span class="sb">, &#39;foo&#39; in or: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">or</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
ob.bar = 1, or.bar = 1
&#39;foo&#39; in ob: false, &#39;foo&#39; in or: false
</pre>
<p>
结果删除后，依旧在，需要实现 delete proxy handler。</p>
</div>
</div>
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
用例五：原始对象上的操作也要能在代理后对象有所体现
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>

<span class="nx">original</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.bar = </span><span class="si">${</span><span class="nx">observed</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">, original.bar = </span><span class="si">${</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">original</span><span class="p">.</span><span class="nx">foo</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&#39;foo&#39; in original: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">original</span><span class="si">}</span><span class="sb">, &#39;foo&#39; in observed: </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">observed</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.bar = 1, original.bar = 1
&#39;foo&#39; in original: false, &#39;foo&#39; in observed: false
</pre>
</div>
</div>
<div id="outline-container-headline-10" class="outline-4">
<h4 id="headline-10">
用例六：被设置的值如果是对象，该对象也会被 Reactive
</h4>
<div id="outline-text-headline-10" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="nx">raw</span> <span class="c1">// #0
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.foo === faw, </span><span class="si">${</span><span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span> <span class="o">===</span> <span class="nx">raw</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span> <span class="c1">// #1
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.foo is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.foo === faw, false
observed.foo is reactive, true
</pre>
<p>
访问 raw 之前(<strong>#1</strong> 之前)它还不是 reactive，因为递归 reactive 发生在 track() 中，即取值阶段。</p>
<p>
如：控制台测试输出</p>
<pre class="example">
var ob = reactive({})
var raw = {}
ob.foo = raw
ob
    Proxy {foo: {…}}
        [[Handler]]: Object
            deleteProperty: ƒ deleteProperty(target, key)
            get: ƒ (target, key, receiver)
            set: ƒ (target, key, value, receiver)
        [[Target]]: Object
            foo: {} // 注意这里
        [[IsRevoked]]: false
</pre>
<p>
进行一次取值：</p>
<pre class="example">
ob.foo
    Proxy {}
        [[Handler]]: Object
        [[Target]]: Object
        [[IsRevoked]]: false
</pre>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
用例七：不该重复 proxy，返回第一个 proxy 结果
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="c1">// #1
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">observed1</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span> <span class="c1">// #2
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">observed2</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">observed1</span><span class="p">)</span> <span class="c1">// #3
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed2 === observed1, </span><span class="si">${</span><span class="nx">observed2</span> <span class="o">===</span> <span class="nx">observed1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
observed2 === observed1, true
undefined
</pre>
<p>
因为 <code>reactive()</code> 实现中组了检测，如果自身是个 proxy 就直接返回，所以 <strong>#3</strong> 中实
际直接将 <code>observed1</code> 返回了。</p>
</div>
</div>
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
<span class="todo">TODO</span>
用例八：不应该用 proxies 污染原始对象？
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">original2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">observed2</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original2</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="nx">observed2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed.bar === observed2, </span><span class="si">${</span><span class="nx">observed</span><span class="p">.</span><span class="nx">bar</span> <span class="o">===</span> <span class="nx">observed2</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original.bar === original2, </span><span class="si">${</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span> <span class="o">===</span> <span class="nx">original2</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
observed.bar === observed2, true
original.bar === original2, false
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-2">
<h2 id="headline-13">
basic proxy get handler(createGetter)
</h2>
<div id="outline-text-headline-13" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/598e047407fe52183468037beb45328878431a55">feat: reactive proxy get handler · gcclll/stb-vue-next@598e047</a></p>
<p>
commit: 只实现对象的 <code>get proxy handler</code> ，对象属性被访问的时候会触发代理，比如下面
实例中，当访问 <code>observed.count</code> 时候会触发 <code>console.log({ res }, &#34;get&#34;)</code> 执行。</p>
<p>
最简单 proxy get handler 脑图：
<img src="/img/vue3/reactivity/reactivity-basehd-get-01.svg" alt="/img/vue3/reactivity/reactivity-basehd-get-01.svg" title="/img/vue3/reactivity/reactivity-basehd-get-01.svg" /></p>
<ol>
<li>
<p>调用 <code>Reflect.get(target, key, receiver)</code> 执行原子操作</p>
</li>
<li>
<p>返回执行结果</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createGetter</span><span class="p">(</span><span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// target: 被取值的对象，key: 取值的属性，receiver: this 的值
</span><span class="c1"></span>  <span class="k">return</span> <span class="kd">function</span> <span class="kr">get</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">Target</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span> <span class="nx">receiver</span>: <span class="kt">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span>

    <span class="c1">// 是否只需要 reactive 一级属性(不递归 reactive)
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">shallow</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">res</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">object</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span> <span class="c1">// ob.count 属性 收集 effect fn
</span><span class="c1"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">target</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: effect 会立即执行 fn， <code>ob.count</code> 取值触发 get proxy 收集 fn -&gt; count =&gt; deps&lt;Set&gt;</p>
<pre class="example">
Map(1) {
  &#39;count&#39; =&gt; Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  }
}
</pre>
</div>
</div>
<div id="outline-container-r-track-effect" class="outline-2">
<h2 id="r-track-effect">
add track() and effect()
</h2>
<div id="outline-text-r-track-effect" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3fc963486868ca3583b02852f07a5aa5969ac354">feat: track+effect · gcclll/stb-vue-next@3fc9634</a></p>
<p>
为了完成观察属性，通过属性的取值操作来收集依赖过程，这里同时实现了 <code>track()</code> 和
<code>effect()</code> 函数。</p>
<div id="outline-container-r-track" class="outline-3">
<h3 id="r-track">
track(target, type, key) 监听取值收集依赖：
</h3>
<div id="outline-text-r-track" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-basehd-get-02-track.svg" alt="/img/vue3/reactivity/reactivity-basehd-get-02-track.svg" title="/img/vue3/reactivity/reactivity-basehd-get-02-track.svg" /></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">track</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span> <span class="kr">type</span><span class="o">:</span> <span class="nx">TrackOpTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">shouldTrack</span> <span class="o">||</span> <span class="nx">activeEffect</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Map&lt; obj -&gt; Map&lt;key, Set[...deps]&gt; &gt;
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">depsMap</span> <span class="o">=</span> <span class="nx">targetMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depsMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 初始化
</span><span class="c1"></span>    <span class="nx">targetMap</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="p">(</span><span class="nx">depsMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()));</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">dep</span> <span class="o">=</span> <span class="nx">depsMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">depsMap</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">(</span><span class="nx">dep</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()));</span>
  <span class="p">}</span>

  <span class="c1">// 正在请求收集的 effect ，是初次出现
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">dep</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">);</span>
    <span class="c1">// 自身保存一份被依赖者名单
</span><span class="c1"></span>    <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">({</span>
        <span class="nx">effect</span>: <span class="kt">activeEffect</span><span class="p">,</span>
        <span class="nx">target</span><span class="p">,</span>
        <span class="kr">type</span><span class="p">,</span>
        <span class="nx">key</span><span class="p">,</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-fn-effect" class="outline-3">
<h3 id="fn-effect">
effect(fn, options)
</h3>
<div id="outline-text-fn-effect" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-effect.svg" alt="/img/vue3/reactivity/reactivity-effect.svg" title="/img/vue3/reactivity/reactivity-effect.svg" /></p>
<ul>
<li>
<p><strong>参数列表</strong> ：</p>
<p>
  fn - 被封装的函数，里面可对对象执行 get/set 操作。</p>
</li>
<li>
<p><strong>主要功能</strong> ：将 fn 封装成 <code>ReactiveEffect</code> 函数</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="p">()</span><span class="o">:</span> <span class="nx">T</span> <span class="c1">// effect函数主题
</span><span class="c1"></span>    <span class="nx">_isEffect</span>: <span class="kt">true</span> <span class="c1">// 标记自身是不是一个 ReactiveEffect 类型
</span><span class="c1"></span>    <span class="nx">id</span>: <span class="kt">number</span> <span class="c1">// uid++ 而来，全局的一个相对唯一的 id
</span><span class="c1"></span>    <span class="nx">active</span>: <span class="kt">boolean</span> <span class="c1">// 记录当前的 effect 是不是激活状态
</span><span class="c1"></span>    <span class="nx">raw</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span> <span class="c1">// 封装之前的那个 fn
</span><span class="c1"></span>    <span class="nx">deps</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">Dep</span><span class="p">&gt;</span> <span class="c1">// fn 的被依赖者列表
</span><span class="c1"></span>    <span class="nx">options</span>: <span class="kt">ReactiveEffectOptions</span> <span class="c1">// 额外选项，如：lazy
</span><span class="c1"></span>    <span class="nx">allowRecurse</span>: <span class="kt">boolean</span> <span class="c1">// ???
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><strong>解决问题</strong> :</p>
<ol>
<li>
<p>fn 封装之后，执行 fn 过程中使用 try…finally ，防止 fn 执行异常导致
effect 进程中断</p>
</li>
<li>
<p>结合 shouldTrack, activeEffect 和 track() 函数，有效的避免了在 fn 中执行
obj.value++ 导致 effect 死循环问题，因为 try…finally 确保了只有 fn 函数
完成之后才会进入 finally 恢复 effect 状态(<code>shouldTrack = true,
activeEffect = last || null</code>)。</p>
</li>
</ol>
</li>
</ul>
<p>
相关函数及变量列表</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>activeEffect</code></td>
<td><em>ReactiveEffect</em></td>
<td>当前正在处理的 Effect，fn 还未执行完成，finally 还没结束</td>
</tr>
<tr>
<td><code>effectStack</code></td>
<td><em>Array, []</em></td>
<td>缓存所有状态还没完成的 Effect</td>
</tr>
<tr>
<td><code>shouldTrack</code></td>
<td><em>boolean, true</em></td>
<td>track() 中用来检测当前 effect 是否结束，从而判定是否可以继续执行 track() 收集依赖</td>
</tr>
<tr>
<td><code>trackStack</code></td>
<td><em>Array, []</em></td>
<td>保存着所有 Effect 的 shouldTrack 值</td>
</tr>
<tr>
<td><code>effect()</code></td>
<td><em>function</em></td>
<td>封装 fn成 ReactiveEffect 结构</td>
</tr>
<tr>
<td><code>track(target, type, key)</code></td>
<td><em>function</em></td>
<td>收集依赖，并且响应式递归</td>
</tr>
<tr>
<td><code>trigger(...)</code></td>
<td><em>function</em></td>
<td>当值更新时触发所有依赖更新</td>
</tr>
<tr>
<td><code>createReactiveEffect(fn, options)</code></td>
<td><em>function</em></td>
<td>effect() 函数主题功能分离出来</td>
</tr>
<tr>
<td><code>cleanup(effect: ReactiveEffect)</code></td>
<td><em>function</em></td>
<td>清空所有 fn 的依赖 effect.deps[]</td>
</tr>
<tr>
<td><code>enableTracking()</code></td>
<td><em>function</em></td>
<td>使能 Effect ，shouldTrack = true, 并将其加入 trackStack</td>
</tr>
<tr>
<td><code>resetTracking()</code></td>
<td><em>function</em></td>
<td>重置 Effect, shouldTrack = 上一个 Effect 的 shouldTrack 值或 true</td>
</tr>
</tbody>
</table>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">effect</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;(</span>
  <span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">ReactiveEffectOptions</span> <span class="o">=</span> <span class="nx">EMPTY_OBJ</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isEffect</span><span class="p">(</span><span class="nx">fn</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">raw</span> <span class="c1">// 取出原始的函数，封装之前的
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// 封装成 ReactiveEffect
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">effect</span> <span class="o">=</span> <span class="nx">createReactiveEffect</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">lazy</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 如果并没指定 lazy: true 选项，则立即执行 effect 收集依赖
</span><span class="c1"></span>    <span class="c1">// 因为 effect 一般都会有取值操作，此时会触发 proxy get handler
</span><span class="c1"></span>    <span class="c1">// 然后执行 track() 结合当前的 activeEffect 即 effect() 执行时候的这个
</span><span class="c1"></span>    <span class="c1">// effect，这样取值操作就和当前取值作用域下的依赖函数建立的依赖关系
</span><span class="c1"></span>    <span class="nx">effect</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">effect</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">uid</span> <span class="o">=</span> <span class="mi">0</span>

<span class="kd">function</span> <span class="nx">createReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;(</span>
  <span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">ReactiveEffectOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="c1">// 将 fn 执行封装成  ReactiveEffect 类型的函数
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">effect</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">reactiveEffect</span><span class="p">()</span><span class="o">:</span> <span class="kt">unknown</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effect</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 非激活状态，可能是手动调用了 stop
</span><span class="c1"></span>      <span class="c1">// 那么执行的时候就需要考虑调用 stop 者是否提供了手动调度该 effect
</span><span class="c1"></span>      <span class="c1">// 的函数 scheduler ? 也就是说你停止你可以重新启动
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effectStack</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">effect</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 1. cleanup, 保持纯净
</span><span class="c1"></span>      <span class="nx">cleanup</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// 2. 使其 tracking 状态有效，track() 中有用
</span><span class="c1"></span>        <span class="nx">enableTracking</span><span class="p">()</span> <span class="c1">// track() 可以执行收集操作
</span><span class="c1"></span>        <span class="nx">effectStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span> <span class="c1">// effect 入栈
</span><span class="c1"></span>        <span class="c1">// 3. 保存为当前的 activeEffect, track() 中有用
</span><span class="c1"></span>        <span class="nx">activeEffect</span> <span class="o">=</span> <span class="nx">effect</span> <span class="c1">// 记录当前的 effect -&gt; track/trigger
</span><span class="c1"></span>        <span class="c1">// 4. 执行 fn 并返回结果
</span><span class="c1"></span>        <span class="k">return</span> <span class="nx">fn</span><span class="p">()</span> <span class="c1">// 返回执行结果
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="c1">// 始终都会执行，避免出现异常将 effect 进程卡死
</span><span class="c1"></span>        <span class="c1">// 5. 如果执行异常，丢弃当前的 effect ，并将状态重置为上一个 effect
</span><span class="c1"></span>        <span class="c1">//   由一个 effect 栈来维护。
</span><span class="c1"></span>
        <span class="nx">effectStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="nx">resetTracking</span><span class="p">()</span>
        <span class="nx">activeEffect</span> <span class="o">=</span> <span class="nx">effectStack</span><span class="p">[</span><span class="nx">effectStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="kr">as</span> <span class="nx">ReactiveEffect</span>

  <span class="nx">effect</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">uid</span><span class="o">++</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">allowRecurse</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">_isEffect</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">raw</span> <span class="o">=</span> <span class="nx">fn</span> <span class="c1">// 这里保存原始函数引用
</span><span class="c1"></span>  <span class="nx">effect</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span>

  <span class="k">return</span> <span class="nx">effect</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
依赖和属性变更发生联系的桥梁模块。</p>
<ol>
<li>
<p><code>effect(fn, options)</code> 封装执行 fn，触发取值操作 -&gt;</p>
</li>
<li>
<p><code>track(target, type, key)</code> 收集对象及属性所有依赖 -&gt;</p>
</li>
<li>
<p>fn 中设值操作触发 <code>trigger(...)</code> 执行所有 deps，更新 DOM。</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-17" class="outline-2">
<h2 id="headline-17">
add trigger() proxy set handler
</h2>
<div id="outline-text-headline-17" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/20afde9970282c144b978b005767bd2c710d54ab">feat: proxy set and trigger operation · gcclll/stb-vue-next@20afde9</a></p>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
proxy set handler(createSetter)
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kd">function</span> <span class="nx">createSetter</span><span class="p">(</span><span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="kr">set</span><span class="p">(</span>
    <span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span>
    <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span>
    <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span>
    <span class="nx">receiver</span>: <span class="kt">object</span>
  <span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]</span>
    <span class="c1">// TODO shallow or not, or ref ?
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>
    <span class="kr">const</span> <span class="nx">hadKey</span> <span class="o">=</span>
      <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isIntegerKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="o">?</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">target.length</span>
        : <span class="kt">hasOwn</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">receiver</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO ADD
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-r-trigger" class="outline-3">
<h3 id="r-trigger">
trigger()
</h3>
<div id="outline-text-r-trigger" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span>
  <span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">TriggerOpTypes</span><span class="p">,</span>
  <span class="nx">key?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">newValue?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">oldValue?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">oldTarget?</span>: <span class="kt">Map</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="err">,</span> <span class="na">unknown</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">Set</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">depsMap</span> <span class="o">=</span> <span class="nx">targetMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depsMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">effects</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">&lt;</span><span class="nt">ReactiveEffect</span><span class="p">&gt;()</span>
  <span class="kr">const</span> <span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="nx">effectsToAdd</span>: <span class="kt">Set</span><span class="p">&lt;</span><span class="nt">ReactiveEffect</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">effectsToAdd</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">effectsToAdd</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">effect</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">effect</span> <span class="o">!==</span> <span class="nx">activeEffect</span> <span class="o">||</span> <span class="nx">effect</span><span class="p">.</span><span class="nx">allowRecurse</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">effects</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">CLEAR</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO collection clear operation
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;length&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// TODO array change operation
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// SET | ADD | DELETE operation
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">depsMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// TODO 迭代器 key，for...of, 使用迭代器是对数据的监听变化
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="p">(</span><span class="nx">effect</span>: <span class="kt">ReactiveEffect</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">({</span>
        <span class="nx">effect</span><span class="p">,</span>
        <span class="nx">target</span><span class="p">,</span>
        <span class="nx">key</span><span class="p">,</span>
        <span class="kr">type</span><span class="p">,</span>
        <span class="nx">newValue</span><span class="p">,</span>
        <span class="nx">oldValue</span><span class="p">,</span>
        <span class="nx">oldTarget</span>
      <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">(</span><span class="nx">effect</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">effect</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">effects</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">run</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-20" class="outline-2">
<h2 id="headline-20">
observe object recursively
</h2>
<div id="outline-text-headline-20" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b2143f9e35af77ee43792a6110ea70c4caf9a54f">feat: observe object recursively · gcclll/stb-vue-next@b2143f9</a></p>
<p>
针对嵌套对象进行递归 Reactive 。</p>
<p>
<img src="/img/vue3/reactivity/reactivity-basehd-get-03-track-recursively.svg" alt="/img/vue3/reactivity/reactivity-basehd-get-03-track-recursively.svg" title="/img/vue3/reactivity/reactivity-basehd-get-03-track-recursively.svg" /></p>
</div>
</div>
<div id="outline-container-effect-track-trigger" class="outline-2">
<h2 id="effect-track-trigger">
effect -&gt; track -&gt; trigger 关系图
</h2>
<div id="outline-text-effect-track-trigger" class="outline-text-2">
<p>
到此 effect + track + trigger 完成了最简单的响应式代码。</p>
<p>
<img src="/img/vue3/reactivity/reactivity-effect-track-trigger.svg" alt="/img/vue3/reactivity/reactivity-effect-track-trigger.svg" title="/img/vue3/reactivity/reactivity-effect-track-trigger.svg" /></p>
<ol>
<li>
<p>effect 封装注册函数</p>
</li>
<li>
<p>track 取值触发收集依赖函数</p>
</li>
<li>
<p>trigger 设值触发所有依赖函数执行</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-c-delete" class="outline-2">
<h2 id="c-delete">
add delete(<strong>deleteProperty</strong>) proxy handler
</h2>
<div id="outline-text-c-delete" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/05b98c571560d2c1806d29cdda7b500b4b2bdeac">feat: delete proxy handler · gcclll/stb-vue-next@05b98c5</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">deleteProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 删除成功，触发 DELETE
</span><span class="c1"></span>    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">object</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="p">,</span>	  <span class="kr">get</span><span class="p">,</span>
  <span class="kr">set</span>	  <span class="kr">set</span><span class="p">,</span>
  <span class="nx">deleteProperty</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
删除成功调用 <code>trigger()</code> 触发 <strong>DELETE</strong> 。</p>
</div>
</div>
<div id="outline-container-headline-23" class="outline-2">
<h2 id="headline-23">
add has, ownKeys proxy handlers
</h2>
<div id="outline-text-headline-23" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ab69fe9eecb274f836bf19163636bd8f464b84d1">feat: has + ownKeys proxy handler · gcclll/stb-vue-next@ab69fe9</a></p>
<p>
增加 has, ownKeys proxy handlers.</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">has</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSymbol</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">builtInSymbols</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">HAS</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ownKeys</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">object</span><span class="p">)</span><span class="o">:</span> <span class="p">(</span><span class="kt">string</span> <span class="o">|</span> <span class="nx">num</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)[]</span> <span class="p">{</span>
  <span class="nx">track</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;length&#39;</span> <span class="o">:</span> <span class="nx">ITERATE_KEY</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="kc">false</span>
<span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">),</span> <span class="p">{</span> <span class="nx">lazy</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before run effect, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">runner</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after run effect, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
before run effect, dummy = false
after run effect, dummy = true
</pre>
</div>
</div>
<div id="outline-container-headline-24" class="outline-2">
<h2 id="headline-24">
<span class="todo">TODO</span>
add array support
</h2>
<div id="outline-text-headline-24" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9aeb678befc3826b2ce8976b62c1172b4800df27">feat: array support · gcclll/stb-vue-next@9aeb678</a></p>
<p>
修改点：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 数组内置方法处理
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">arrayInstrumentations</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Function</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">;([</span><span class="s1">&#39;includes&#39;</span><span class="p">,</span> <span class="s1">&#39;indexOf&#39;</span><span class="p">,</span> <span class="s1">&#39;lastIndexOf&#39;</span><span class="p">]</span> <span class="kr">as</span> <span class="kr">const</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="nx">arrayInstrumentations</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="kt">unknown</span><span class="p">[],</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">track</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">res</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="p">;([</span><span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="s1">&#39;unshift&#39;</span><span class="p">,</span> <span class="s1">&#39;splice&#39;</span><span class="p">]</span> <span class="kr">as</span> <span class="kr">const</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="nx">arrayInstrumentations</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="kt">unknown</span><span class="p">[],</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="p">{</span>
    <span class="nx">pauseTracking</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="nx">resetTracking</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">res</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="c1">// createGetter
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">createGetter</span><span class="p">(</span><span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// 4. target is array
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">targetIsArray</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">targetIsArray</span> <span class="o">&amp;&amp;</span> <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">arrayInstrumentations</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">arrayInstrumentations</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>索引操作(<code>includes, lastIndexOf, indexOf</code>)处理</p>
<p>
确保索引取值的时候，能使用 track() 正确收集对应索引的依赖列表。</p>
</li>
<li>
<p>可改变原数组长度操作(<code>push, pop, shift, unshift, splice</code>)</p>
<p>
因为这些函数内部实现都需要访问及改变原数组的长度，因此这里需要做一层保护，它
们执行之前 <code>shouldTrack = false</code> ，执行完成之后 <code>shouldTrack = true</code> ，避免
<code>track()</code> 死循环。</p>
</li>
</ol>
<p>
下面均为 vue-next 源码中用例分析。</p>
<ul>
<li class="checked">
<p>T1: 读写操作</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}]</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#01 original !== observed, </span><span class="si">${</span><span class="nx">original</span> <span class="o">!==</span> <span class="nx">observed</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#02 original is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#03 observed is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#04 observed[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">clone</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">slice</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#05 clone[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">clone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#06 clone[0] !== original[0], </span><span class="si">${</span><span class="nx">clone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#07 clone[0] === observed[0], </span><span class="si">${</span><span class="nx">clone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">reactiveValue</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#08 observed[0] === reactiveValue, </span><span class="si">${</span><span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">reactiveValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#09 original[0] === value, </span><span class="si">${</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#10 observed[0] === undefined, </span><span class="si">${</span><span class="nx">observed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#11 original[0] === undefined, </span><span class="si">${</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#12 observed[2] === reactiveValue, </span><span class="si">${</span><span class="nx">observed</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">reactiveValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#13 original[2] === value, </span><span class="si">${</span><span class="nx">original</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  +RESULTS:</p>
<pre class="example">
#01 original !== observed, true
#02 original is reactive, false
#03 observed is reactive, true
#04 observed[0] is reactive, true
#05 clone[0] is reactive, true
#06 clone[0] !== original[0], true
#07 clone[0] === observed[0], true
#08 observed[0] === reactiveValue, true
#09 original[0] === value, true
#10 observed[0] === undefined, true
#11 original[0] === undefined, true
#12 observed[2] === reactiveValue, true
#13 original[2] === value, true
</pre>
<p>
  分析：</p>
<ul>
<li>
<p><strong>#01</strong> 因为 Proxy <a href="https://tc39.es/ecma262/#sec-proxycreate">内部实现</a>实际会创建新对象</p>
</li>
<li>
<p><strong>#02</strong> 读取 <code>__v_isReactive</code> 在 <code>createGetter()</code> 里面会直接返回 <code>!isReadonly</code></p>
</li>
<li>
<p><strong>#03</strong> 同上</p>
</li>
<li>
<p><strong>#04</strong> 取值的时候返回结果之前会检测当前是不是对象如果是会执行递归 reactive</p>
</li>
<li>
<p><strong>#05</strong> slice <a href="/post/javascript-apis/#api-array-slice">实现过程</a>并非深拷贝</p>
</li>
<li>
<p><strong>#06</strong> 和 <code>observed[0] !== original[0]</code> 一个原因</p>
</li>
<li>
<p><strong>#07</strong> <a href="/post/javascript-apis/#api-array-slice">浅拷贝问题</a></p>
</li>
<li>
<p><strong>#08</strong> 先 <code>observed[0]</code> 对 value 取值操作，此时 Reactive value 对象时，发现该对</p>
</li>
</ul>
<p>象已经有映射了(proxyMap 中已存在 value -&gt; reactiveValue 关系。)</p>
<ul>
<li>
<p><strong>#09</strong> proxy 的改变也会体现在 original 对象上。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">{</span>  <span class="p">}</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="p">{})</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">test</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{ value: { test: 1 } }
</pre>
</li>
<li>
<p><strong>#10</strong> 同上</p>
</li>
<li>
<p><strong>#11</strong> 同上</p>
</li>
<li>
<p><strong>#12</strong> 同 <strong>#08</strong> <code>proxyMap</code> 中有缓存了</p>
</li>
<li>
<p><strong>#13</strong> 同上</p>
</li>
</ul>
</li>
<li class="checked">
<p>T2：索引方法(includes, lastIndexOf, indexOf)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([{},</span> <span class="p">{}])</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.indexOf(raw), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.indexOf(raw, 3), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.includes(raw), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.includes(raw, 3), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.lastIndexOf(raw), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.lastIndexOf(raw, 1), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  +RESULTS:</p>
<pre class="example">
arr.indexOf(raw), 2
arr.indexOf(raw, 3), -1
arr.includes(raw), true
arr.includes(raw, 3), false
arr.lastIndexOf(raw), 2
arr.lastIndexOf(raw, 1), -1
</pre>
</li>
<li class="checked">
<p>T3：数组元素本身已经是 Proxy</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">raw</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`arr.includes(obj), </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: 这个应该很好理解，对象已经是 proxy 之后不会再继续代理，而是返回
proxyMap 中缓存过的代理结果。</p>
<pre class="example">
arr.includes(obj), true
</pre>
</li>
<li class="indeterminate">
<p>T4: <a href="/post/javascript-apis/#api-array-reverse">reverse</a> 方法也应该是 reactive 的</p>
<p>
<strong>TODO</strong>: reverse 之后找不到(<code>indexOf</code>)原始对象了？</p>
<p>
根据 <a href="/post/javascript-apis/#api-array-reverse">reverse()</a> 的实现原理，本质上是元素之间的替换操作，因此并不会改变数组或元
素本身是 proxy 性质，且属于索引赋值操作，因此会触发索引的 reactive 相关操作。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span><span class="p">,</span> <span class="nx">toRaw</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([</span><span class="nx">obj</span><span class="p">,</span> <span class="p">{</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}])</span>
<span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 obj === arr[0], </span><span class="si">${</span><span class="nx">obj</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)))</span> <span class="c1">// index = 0
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 before reverse, index = </span><span class="si">${</span><span class="nx">index</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span> <span class="c1">// #3
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 after reverse, index = </span><span class="si">${</span><span class="nx">index</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 obj === arr[1], </span><span class="si">${</span><span class="nx">obj</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
#1 obj === arr[0], true
#2 before reverse, index = 0
#4 after reverse, index = -1
#5 obj === arr[1], true
undefined
</pre>
<p>
+RESULTS: 失败</p>
<pre class="example">
before reverse, index = 0
after reverse, index = -1
[ { b: 2 }, { a: 1 } ]
</pre>
</li>
<li class="checked">
<p>T5: 使用 <a href="/post/javascript-apis/#api-op-delete">delete</a> 删除数组元素时不应该触发 <code>length</code> 依赖</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, arr = </span><span class="si">${</span><span class="nx">arr</span><span class="si">}</span><span class="sb">, len = </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, arr = </span><span class="si">${</span><span class="nx">arr</span><span class="si">}</span><span class="sb">, len = </span><span class="si">${</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: 删除操作并不会改变数组长度</p>
<pre class="example">
before delete, dummy = 4, arr = 1,2,3, len = 3
after delete, dummy = 4, arr = 1,,3, len = 3
undefined
</pre>
<blockquote>
<p>PS: 赋值已有的下标元素值、添加非正整数类型的属性到数组上都不会触发 <code>length</code> 依
赖，本质上并没有改变数组长度。</p>
</blockquote>
</li>
<li class="checked">
<p>T6: 在 effect fn 中使用 <code>for ... in</code> 迭代语句应该 <em>track length</em></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span> <span class="nx">isReactive</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">targetMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">array</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">nums</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">len</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">len</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">len</span> <span class="o">+=</span> <span class="nx">key</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before push, len = </span><span class="si">${</span><span class="nx">len</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after push, len = </span><span class="si">${</span><span class="nx">len</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
before push, len = 0
after push, len = 01
undefined
</pre>
<p>
+RESULTS: 输出显示，length 依赖已经 track 到了，只是 Length 变化并没有触发</p>
<pre class="example">
Map(1) {
  &#39;length&#39; =&gt; Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  }
}
before push, len = 0
after push, len = 0
</pre>
<blockquote>
<p>FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/21b4881a906d5e6f2def3a7e486934af6009e93a">feat(add): array add element support · gcclll/stb-vue-next@21b4881</a></p>
</blockquote>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-25" class="outline-2">
<h2 id="headline-25">
array add element support
</h2>
<div id="outline-text-headline-25" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/21b4881a906d5e6f2def3a7e486934af6009e93a">feat(add): array add element support · gcclll/stb-vue-next@21b4881</a></p>
<p>
增加添加数组元素支持。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p><code>createGetter -&gt; get</code> proxy handler 中增加属性添加 trigger 操作</p>
<p>
<code>trigger(target, TriggerOpTypes.ADD, key, value)</code></p>
</li>
<li>
<p>effect.ts -&gt; <code>trigger()</code> 中增加数组长度变更依赖收集和 <code>ADD</code> 操作依赖收集</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201118105046.png" alt="http://qiniu.ii6g.com/img/20201118105046.png" title="http://qiniu.ii6g.com/img/20201118105046.png" /></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-26" class="outline-2">
<h2 id="headline-26">
add shallow reactive
</h2>
<div id="outline-text-headline-26" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e85dfc630c3374aa6452891784cc58ffdc5895c6">feat(add): shallowReactive api · gcclll/stb-vue-next@e85dfc6</a></p>
<p>
正常 track 过程中会检测嵌套内的是不是对象，如果是对象会进行递归 reactive 让内部嵌套的对象也 reactive 化。</p>
<p>
shallow reactive 意思是当对象存在嵌套的时候，不进行递归 reactive 。</p>
<p>
这个通过在 track() 函数中做一次拦截处理。</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReactive</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`props.n is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">props2</span> <span class="o">=</span> <span class="nx">shallowReactive</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span> <span class="p">})</span>
<span class="nx">props2</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">2</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`props2.n is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">props2</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// array test
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">shallowArray</span> <span class="o">=</span> <span class="nx">shallowReactive</span><span class="p">([])</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">let</span> <span class="nx">size</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">size</span> <span class="o">=</span> <span class="nx">shallowArray</span><span class="p">.</span><span class="nx">length</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; array`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before push a, size = </span><span class="si">${</span><span class="nx">size</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">shallowArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after push a, size = </span><span class="si">${</span><span class="nx">size</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">shallowArray</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after pop, size = </span><span class="si">${</span><span class="nx">size</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; 迭代时不应观察`</span><span class="p">)</span>
<span class="nx">shallowArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">spreadA</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">shallowArray</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">// 迭代也有取值过程，shallow = true 不会递归 reactive
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`spreadA is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">spreadA</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; onTrack`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">onTrackFn</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;on tracking...&#39;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">b</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">shallowArray</span><span class="p">)</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nx">onTrack</span><span class="o">:</span> <span class="nx">onTrackFn</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: <a href="/post/javascript-apis/#api-array-from">Array.from</a> 本质是迭代器操作，所以会触发迭代器 tracking 。</p>
<pre class="example">
props.n is reactive, false
props2.n is reactive, true
&gt;&gt; array
before push a, size = 0
after push a, size = 1
after pop, size = 0
&gt;&gt; 迭代时不应观察
spreadA is reactive, false
&gt;&gt; onTrack
on tracking...
on tracking...
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-27" class="outline-2">
<h2 id="headline-27">
add readonly reactive
</h2>
<div id="outline-text-headline-27" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/66e7903568bf7d5bce0faca2f85e80c36399bc66">feat(add): readonly reactive · gcclll/stb-vue-next@66e7903</a></p>
<div id="outline-container-headline-28" class="outline-4">
<h4 id="headline-28">
测试(for <code>Object</code>)：
</h4>
<div id="outline-text-headline-28" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">readonly</span><span class="p">,</span>
  <span class="nx">isProxy</span><span class="p">,</span>
  <span class="nx">isReadonly</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should make nested values readonly`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">wrapped</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped !== original, </span><span class="si">${</span><span class="nx">wrapped</span> <span class="o">!==</span> <span class="nx">original</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is proxy, </span><span class="si">${</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped.bar is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped.bar is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original.bar is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original.bar is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">.</span><span class="nx">bar</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; get`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped.foo = </span><span class="si">${</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; has`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&#39;foo&#39; in wrapped, </span><span class="si">${</span><span class="s1">&#39;foo&#39;</span> <span class="k">in</span> <span class="nx">wrapped</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; ownKeys`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Object.keys(wrapped), [</span><span class="si">${</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt; set or delete, should fail`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">qux</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">(</span><span class="s1">&#39;qux&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">bar</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">baz</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">},</span>
  <span class="p">[</span><span class="nx">qux</span><span class="p">]</span><span class="o">:</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">wrapped2</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">(</span><span class="nx">original2</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">// fail
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.foo = 2&#39;,  wrapped2.foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.bar.baz = 3&#39;, wrapped2.bar.baz = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2[qux] = 4&#39;,  wrapped2[qux] = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="k">delete</span> <span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;delete wrapped2.foo&#39;, wrapped2.foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;delete wrapped2.bar.baz&#39;, wrapped2.bar.baz = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">bar</span><span class="p">.</span><span class="nx">baz</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;delete wrapped2[qux]&#39;, wrapped2[qux] = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="nx">qux</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: readonly 会递归嵌套对象，所以它内部的对象都会是 readonly。</p>
<pre class="example">
&gt;&gt;&gt; should make nested values readonly
wrapped !== original, true
wrapped is proxy, true
wrapped is reactive, false
wrapped is readonly, true
original is reactive, false
original is readonly, false
wrapped.bar is reactive, false
wrapped.bar is readonly, true
original.bar is reactive, false
original.bar is readonly, false
&gt;&gt; get
wrapped.foo = 1
&gt;&gt; has
&#39;foo&#39; in wrapped, true
&gt;&gt; ownKeys
Object.keys(wrapped), [foo,bar]
&gt;&gt; set or delete, should fail
after &#39;wrapped2.foo = 2&#39;,  wrapped2.foo = 1
after &#39;wrapped2.bar.baz = 3&#39;, wrapped2.bar.baz = 2
after &#39;wrapped2[qux] = 4&#39;,  wrapped2[qux] = 3
after &#39;delete wrapped2.foo&#39;, wrapped2.foo = 1
after &#39;delete wrapped2.bar.baz&#39;, wrapped2.bar.baz = 2
after &#39;delete wrapped2[qux]&#39;, wrapped2[qux] = 3
</pre>
</div>
</div>
<div id="outline-container-headline-29" class="outline-4">
<h4 id="headline-29">
测试(for <code>Array</code>):
</h4>
<div id="outline-text-headline-29" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">readonly</span><span class="p">,</span>
  <span class="nx">isReadonly</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">isProxy</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should make nested values readonly`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}]</span>
<span class="kr">const</span> <span class="nx">wrapped</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped !== original`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is proxy, </span><span class="si">${</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped[0] is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original[0] is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`original[0] is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">original</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; get`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`wrapped[0].foo = </span><span class="si">${</span><span class="nx">wrapped</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; has`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`0 in wrapped, </span><span class="si">${</span><span class="mi">0</span> <span class="k">in</span> <span class="nx">wrapped</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; ownKeys`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Object.keys(wrapped) = [</span><span class="si">${</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">)</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">wrapped2</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">([{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}])</span>
<span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2[0] = 1&#39;, wrapped2[0] = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2[0].foo = 2&#39;, wrapped2[0].foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.length = 0&#39;, wrapped2.length = </span><span class="si">${</span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.length = 0&#39;, wrapped2[0].foo = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">wrapped2</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;wrapped2.push(2)&#39;, wrapped2.length = </span><span class="si">${</span><span class="nx">wrapped2</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; should make nested values readonly
wrapped !== original
wrapped is proxy, true
wrapped is reactive, false
wrapped is readonly, true
original is reactive, false
original is readonly, false
wrapped[0] is reactive, false
wrapped[0] is readonly, true
original[0] is reactive, false
original[0] is readonly, false
&gt; get
wrapped[0].foo = 1
&gt; has
0 in wrapped, true
&gt; ownKeys
Object.keys(wrapped) = [0]
after &#39;wrapped2[0] = 1&#39;, wrapped2[0] = [object Object]
after &#39;wrapped2[0].foo = 2&#39;, wrapped2[0].foo = 1
after &#39;wrapped2.length = 0&#39;, wrapped2.length = 1
after &#39;wrapped2.length = 0&#39;, wrapped2[0].foo = 1
after &#39;wrapped2.push(2)&#39;, wrapped2.length = 1
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-30" class="outline-4">
<h4 id="headline-30">
测试(reactive, readonly 互撩)
</h4>
<div id="outline-text-headline-30" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">readonly</span><span class="p">,</span>
  <span class="nx">isReadonly</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">toRaw</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">readonly</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`*#1* isReadonly(b), </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`*#2* toRaw(a) === toRaw(b), </span><span class="si">${</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`*#3* a === b, </span><span class="si">${</span> <span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span> <span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
*#1* isReadonly(b), true
*#2* toRaw(a) === toRaw(b), true
*#3* a === b, true
undefined
</pre>
<ol>
<li>
<p><strong>#1</strong> b is readonly: <code>createReactive</code> 中的处理</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">Raw</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_REACTIVE</span><span class="p">]))</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">target</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
上面的处理针对 <code>b = reactive(a)</code> 有：</p>
<p>
a 满足 target[ReactiveFlags.Raw] 因为它是 readonly 的.</p>
<p>
isReadonly = false</p>
<p>
target[ReactiveFlags.IS_REACTIVE] 不满足</p>
<p>
因此上面的判断满足 <code>target[ReactiveFlags.RAW] &amp;&amp;
!target[ReactiveFlags.IS_REACTIVE]</code> 直接返回 target 。</p>
</li>
<li>
<p><strong>#2</strong> <code>toRaw(a) === toRaw(b)</code> 这个结果为 true，因为 <strong>#1</strong> 中的原因，直接返回了 target，
所以 b 实际上就是 a(如结果 <strong>#3</strong>)</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-31" class="outline-2">
<h2 id="headline-31">
add shallow readonly reactive
</h2>
<div id="outline-text-headline-31" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/aaaf911eb88c75935970e51f843a88f6a3a3c6d6">feat(add): shallow readonly reactive · gcclll/stb-vue-next@aaaf911</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201119153149.png" alt="http://qiniu.ii6g.com/img/20201119153149.png" title="http://qiniu.ii6g.com/img/20201119153149.png" /></p>
<p>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">shallowReadonly</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="c1">// 嵌套对象不应该 reactive
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should not make non-reactive properties reactive`</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReadonly</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="p">{</span><span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`isReactive(props.n), </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// 根属性应该是 readonly
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should make root level properties readonly`</span><span class="p">)</span>
<span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReadonly</span><span class="p">({</span><span class="nx">n</span> <span class="o">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="nx">props</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;props.n = 2&#39;, props.n = </span><span class="si">${</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="c1">// 嵌套的属性不应该是 readonly ，因为是 shallow
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; should NOT make nested properties readonly`</span><span class="p">)</span>
<span class="nx">props</span> <span class="o">=</span> <span class="nx">shallowReadonly</span><span class="p">({</span> <span class="nx">n</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after &#39;props.n.foo = 2&#39;, props.n.foo = </span><span class="si">${</span><span class="nx">props</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">foo</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; should not make non-reactive properties reactive
isReactive(props.n), false
&gt;&gt;&gt; should make root level properties readonly
after &#39;props.n = 2&#39;, props.n = 1
&gt;&gt;&gt; should NOT make nested properties readonly
after &#39;props.n.foo = 2&#39;, props.n.foo = 2
undefined
</pre>
<p>
这里的结果不难理解</p>
<ol>
<li>
<p>shallow 不会递归 reactive</p>
</li>
<li>
<p>readonly 让属性只读，但是由于是 shallow 所以只有对象根属性才是只读</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-32" class="outline-2">
<h2 id="headline-32">
add effect stop
</h2>
<div id="outline-text-headline-32" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f1e5b3afb88d41d065f1c797f5db66ac7c65339f">feat(add): effect stop · gcclll/stb-vue-next@f1e5b3a</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201119162119.png" alt="http://qiniu.ii6g.com/img/20201119162119.png" title="http://qiniu.ii6g.com/img/20201119162119.png" /></p>
<p>
stop() 函数操作：</p>
<ol>
<li>
<p>清空所有 effect 上的 deps，同时将当前的 effect 从所有依赖它的 dep 中删除</p>
<p>
<code>effect.deps[i].delete(effect)</code> , 这一步是将 <code>targetMap &gt; depsMap &gt; deps</code> 中
的 effect 删除。</p>
<p>
<code>effect.deps.length = 0</code></p>
</li>
<li>
<p>将 effect.active 置为 false</p>
</li>
</ol>
<p>
执行 <code>stop()</code> 之后，只能手动调用 <code>runner()</code> 来触发 effect fn(前提是没有提供
<code>options.scheduler</code> ，否则永远不会被执行) 。</p>
<p>
被 stopped 的 effect 可以当做另一个正常的 effect 的 fn。</p>
</div>
</div>
<div id="outline-container-headline-33" class="outline-2">
<h2 id="headline-33">
集合类型代理(proxy handlers)脑图
</h2>
<div id="outline-text-headline-33" class="outline-text-2">
<p><img src="/img/vue3/reactivity/reactivity-collection-proxy.svg" alt="/img/vue3/reactivity/reactivity-collection-proxy.svg" title="/img/vue3/reactivity/reactivity-collection-proxy.svg" /></p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-2">
<h2 id="headline-34">
add collection handlers
</h2>
<div id="outline-text-headline-34" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/521f755fd403d5f0431bcafd1737f1d988ce0825">feat(add): mutable collection handlers · gcclll/stb-vue-next@521f755</a></p>
<p>
<a href="#whole-collection">collection proxy handlers 脑图链接</a></p>
<p>
因为 Reflect 没有集合操作的对应接口，所以针对集合类型需要通过 <code>get proxy</code> 来中转
做特殊处理。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span> <span class="nx">shallow</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableCollectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">CollectionTypes</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// get: createInstrumentationGetter(false, false)
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
添加集合类型的 handlers。</p>
</div>
</div>
<div id="outline-container-headline-35" class="outline-2">
<h2 id="headline-35">
add collection get proxy handler
</h2>
<div id="outline-text-headline-35" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a5e8e062658d458081ce1bb499b8041f6175689e">feat(add): collection get proxy · gcclll/stb-vue-next@a5e8e06</a></p>
<p>
针对集合的所有操作代理都是通过 get proxy 变相完成的，所以搞懂这里是至关重要的。</p>
<p>
collection proxy handler:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableCollectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">CollectionTypes</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
简单吧，别被假🐘给迷惑了！！！</p>
<p>
这里的原理如果想通了也简单。</p>
<p>
试想下，我们调用集合类型的方法是怎么调用的？？？</p>
<p>
<code>map.get()</code>, <code>map.set()</code>, <code>map.delete()</code>, <code>...</code></p>
<p>
都是通过点语法使用的，点语法前提也必须是先取出值来进行操作，即要调用方法之前，先
将方法取出来，因此这里就是取值操作。</p>
<p>
从这一个层级上去理解去实现，就可以通过集合的 <code>proxy get</code> 来变相实现所有集合的方
法和属性代理。</p>
<p>
注意 <code>Reflect.get(target, key, receiver)</code> 第一个传的是什么？</p>
<p>
<code>boolean ? instrumentations : target</code> 即封装后的 <code>instrumentations</code> 啊 !</p>
<p>
如： <code>map.get()</code> -&gt; <code>target: map, key: get</code> -&gt; <code>target: instumentations, key:
get</code> -&gt; <code>get(target, key, isReadonly, isShallow)</code></p>
<p>
集合的操作最终 —–&gt; 转变成 instrumentations 对象上的操作。</p>
<blockquote>
<p>去掉暂时不需要的代码(<a href="https://github.com/gcclll/stb-vue-next/commit/65ea709dac46e4310eb2ac95cb19984d9b921d88">65ea709</a>)：</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/65ea709dac46e4310eb2ac95cb19984d9b921d88">feat: add get proxy handler · gcclll/stb-vue-next@65ea709</a></p>
</blockquote>
<div id="outline-container-key-collection-proxy-get" class="outline-3">
<h3 id="key-collection-proxy-get">
实现顺序(原理)
</h3>
<div id="outline-text-key-collection-proxy-get" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 1. 对外的 handlers
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">mutableCollectionHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">CollectionTypes</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1">// 2. 封装 get proxy 所有 collection 操作的入口
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">createInstrumentationGetter</span><span class="p">(</span><span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span> <span class="nx">shallow</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">instrumentations</span> <span class="o">=</span> <span class="nx">mutableInstrumentations</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">target</span>: <span class="kt">CollectionTypes</span><span class="p">,</span>
    <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span>
    <span class="nx">receiver</span>: <span class="kt">CollectionTypes</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_REACTIVE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">isReadonly</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">isReadonly</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">target</span>
    <span class="p">}</span>

    <span class="c1">// 将集合操作代理到 instrumentations 对象上
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span>
      <span class="nx">hasOwn</span><span class="p">(</span><span class="nx">instrumentations</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">target</span>
        <span class="o">?</span> <span class="nx">instrumentations</span>
        : <span class="kt">target</span><span class="p">,</span>
      <span class="nx">key</span><span class="p">,</span>
      <span class="nx">receiver</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 3. map -&gt; instrumentations -&gt; proxy 中间对象
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">mutableInstrumentations</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Function</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// get proxy handler, this -&gt; target
</span><span class="c1"></span>  <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// 4. 最终执行操作得到结果的函数
</span><span class="c1"></span><span class="kd">function</span> <span class="kr">get</span><span class="p">(</span>
  <span class="nx">target</span>: <span class="kt">MapTypes</span><span class="p">,</span>
  <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">isShallow</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span> <span class="p">})</span>
  <span class="k">return</span> <span class="nx">target</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>理解过程：</p>
<p>
首先要理解执行这一句 <code>map.get(&#39;foo&#39;)</code> 发生了什么</p>
<ol>
<li>
<p>首先是 <code>map.get</code> 取值操作，即 <code>createInstrumentationGetter()</code> 最后 return 的
那一句</p>
<p>
其实是针对 <code>map.get</code> 操作的代理，将 &#34;get&#34; 方法从 <strong>map</strong> 对象中取出来的代理。</p>
<p>
所以 <code>Reflect.get(target, key, receiver)</code> 这里的 <code>key = &#34;foo&#34;</code></p>
</li>
<li>
<p>经过 <strong>#1</strong> 之后，需要立即执行 &#34;get&#34; 方法即 <code>()</code> 操作</p>
<p>
此时执行的是 <code>mutableInstrumentations.get(this, key)</code> 方法</p>
<p>
所以这里的 <code>key = &#39;foo&#39;</code> , <code>this</code> 就是调用 <code>get()</code> 方法的对象 <strong>map</strong> 。 </p>
</li>
<li>
<p>最后 get 操作会被模块全局函数 <code>get(target, key, isReadonly, isShallow)</code> 代替，
做了许多特殊处理，收集依赖。</p>
</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-headline-37" class="outline-3">
<h3 id="headline-37">
<a href="https://github.com/gcclll/stb-vue-next/commit/12bc4da85edd0bfee3785ef3dfb77c3f52ef33cd">12bc4da</a> add get handler
</h3>
<div id="outline-text-headline-37" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/12bc4da85edd0bfee3785ef3dfb77c3f52ef33cd">feat(add): get function for collection proxy · gcclll/stb-vue-next@12bc4da</a></p>
<p>
<strong>FIX</strong>: <a href="https://github.com/gcclll/stb-vue-next/commit/edc1d3f701e744a2b33e9ad5352597519cc06106">edc1d3f</a> 死循环问题(直接放回 target.get(key) 又会触发 get -&gt; …)
<a href="https://github.com/gcclll/stb-vue-next/commit/edc1d3f701e744a2b33e9ad5352597519cc06106">fix: infinite loop · gcclll/stb-vue-next@edc1d3f</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">res</span> <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{
  key: &#39;get&#39;,
  target: Map(1) { &#39;foo&#39; =&gt; 1 },
  x: &#39;in createInstrumentationsGetter&#39;
}
{ key: &#39;foo&#39;, target: Map(1) { &#39;foo&#39; =&gt; 1 }, x: &#39;in get&#39; }
{ res: 100 }
</pre>
<p>
结果如上(参见.<a href="#key-collection-proxy-get">原理详细分析</a>)</p>
<ol>
<li>
<p>reactive(map) -&gt; 将 map 代理给 <code>instrumentations{ get }</code></p>
</li>
<li>
<p>observed.get -&gt; 得到 instrumentations 里面的 &#34;get&#34; 方法</p>
</li>
<li>
<p>(&#39;foo&#39;) -&gt; 执行 <code>instrumentations.get(this, key)</code>, <em>key = &#39;foo&#39;</em></p>
</li>
<li>
<p>返回结果</p>
</li>
</ol>
<blockquote>
<p>至此，完成 collection get proxy handler 的完整流程。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-38" class="outline-3">
<h3 id="headline-38">
<a href="https://github.com/gcclll/stb-vue-next/commit/0b3fd712f72ddeda7c4bf5252624545650c1601b">0b3fd71</a> add get handler track
</h3>
<div id="outline-text-headline-38" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0b3fd712f72ddeda7c4bf5252624545650c1601b">feat(add): collection proxy get -&gt; global get · gcclll/stb-vue-next@0b3fd71</a></p>
<p>
新增get 操作，track 添加依赖。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{
  key: &#39;get&#39;,
  target: Map(1) { &#39;foo&#39; =&gt; 1 },
  x: &#39;in createInstrumentationGetter&#39;
}
{
  key: &#39;foo&#39;,
  type: &#39;get&#39;,
  dep: Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  },
  x: &#39;in track&#39;
}
{ key: &#39;foo&#39;, target: Map(1) { &#39;foo&#39; =&gt; 1 }, x: &#39;in global get&#39; }
dummy = 100
</pre>
<p>
分为三个阶段</p>
<ol>
<li>
<p>collection proxy handler 取  map.get 方法, <code>key = &#39;get&#39;</code></p>
</li>
<li>
<p><code>(&#39;prop&#39;)</code> 执行期触发 <code>instrumentations.get(this, key), key = &#39;foo&#39;</code></p>
</li>
<li>
<p>执行 global get 触发 <code>track</code> 收集依赖，返回结果值</p>
</li>
</ol>
<p>
假设 <code>map.get(key)</code> 的 key 也是个 proxy :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">k</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">v</span><span class="o">:</span> <span class="mi">2</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="k">new</span> <span class="nx">Map</span><span class="p">([[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]]))</span>

<span class="nx">effect</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span> <span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{ #1
  key: &#39;get&#39;,
  target: Map(1) { { k: 1 } =&gt; { v: 2 } },
  x: &#39;in createInstrumentationGetter&#39;
}
#2
{ key: { k: 1 }, rawKey: { k: 1 }, eq: false }
{ #3
  key: { k: 1 },
  type: &#39;get&#39;,
  dep: Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  },
  x: &#39;in track&#39;
}
{ #4
  key: { k: 1 },
  type: &#39;get&#39;,
  dep: Set(1) {
    [Function: reactiveEffect] {
      id: 0,
      allowRecurse: false,
      _isEffect: true,
      active: true,
      raw: [Function (anonymous)],
      deps: [Array],
      options: {}
    }
  },
  x: &#39;in track&#39;
}
{ #5
  key: { k: 1 },
  target: Map(1) { { k: 1 } =&gt; { v: 2 } },
  x: &#39;in global get&#39;
}
dummy = 100
</pre>
<ol>
<li>
<p><strong>#1</strong> proxy collection get handler</p>
</li>
<li>
<p><strong>#2</strong> global get 函数里调用 track 之前输出，显示 <code>key</code> 和 <code>rawKey</code> 是不同的
(<code>eq = false</code>)，因为前者是个 proxy 后者是 key proxy 的 rawValue 。</p>
</li>
<li>
<p><strong>#3</strong> track() 调用时的输出，显示的是需要收集依赖的是 <code>proxy key{k: 1}</code> </p>
</li>
<li>
<p><strong>#4</strong> track() 调用时的输出，显示的是需要收集依赖的是 <code>raw key{k: 1}</code></p>
</li>
</ol>
<p>
从 <strong>#3</strong>, <strong>#4</strong> 可知如果 key 本身已经是 proxy 那么它及其对应的 rawKey 同时也会收集
当前的 effect 。</p>
</div>
</div>
<div id="outline-container-headline-39" class="outline-3">
<h3 id="headline-39">
<a href="https://github.com/gcclll/stb-vue-next/commit/77b14ef019cd320bc04f1c861424db79bcc82f9f">77b14ef</a> add get handler return value
</h3>
<div id="outline-text-headline-39" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/77b14ef019cd320bc04f1c861424db79bcc82f9f">feat(add): collection proxy get with value return · gcclll/stb-vue-next@77b14ef</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201121095654.png" alt="http://qiniu.ii6g.com/img/20201121095654.png" title="http://qiniu.ii6g.com/img/20201121095654.png" /></p>
<p>
这里处理分为两部分：</p>
<ol>
<li>
<p>取出 <code>has</code> 方法检测存在性</p>
</li>
<li>
<p>根据 <code>isReadonly</code> 和 <code>isShallow</code> 决定对返回值做什么处理，如：递归 reactive/readonly</p>
</li>
<li>
<p>使用 target.get(key) 取出结果值返回</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-40" class="outline-2">
<h2 id="headline-40">
add collection set proxy handler
</h2>
<div id="outline-text-headline-40" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7b680df94e359c208697111319eda9ee75560b11">feat(add): collection set proxy handler · gcclll/stb-vue-next@7b680df</a></p>
<p>
set proxy handler 处理</p>
<ol>
<li>
<p>设值的时候可能有两种情况 a) set, b) add</p>
</li>
<li>
<p>需要考虑 proxy key 和 raw key 问题</p>
</li>
<li>
<p>最后 trigger 触发依赖</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kd">function</span> <span class="kr">set</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">has</span><span class="p">,</span> <span class="kr">get</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">getProto</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>

  <span class="kd">let</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="c1">// 考虑 key 可能是 proxy
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// to add
</span><span class="c1"></span>    <span class="nx">key</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">checkIdentityKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">has</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="kr">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="c1">// 设值结果
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 添加操作
</span><span class="c1"></span>    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 设值操作
</span><span class="c1"></span>    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>


<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; before get, deps`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">map</span><span class="p">))</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; after get, deps`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">map</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt; before get, deps
undefined
&gt; after get, deps
&lt;ref *1&gt; Set(1) {
  [Function: reactiveEffect] {
    id: 0,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1] ],
    options: {}
  }
}
#1 before set, dummy = undefined
#2 after set, dummy = 1
</pre>
</div>
</div>
<div id="outline-container-headline-41" class="outline-2">
<h2 id="headline-41">
add collection size,has,add proxy handler
</h2>
<div id="outline-text-headline-41" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/73fa5ebf7f0dcdaa11bbf42df89c7f7c1ab88385">feat(add): size, has, add collection proxy handlers · gcclll/stb-vue-next@73fa5eb</a></p>
<p>
has: proxy key, raw key 都需要 track has 操作依赖</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">has</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">CollectionTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
  <span class="kr">const</span> <span class="nx">rawTarget</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">rawKey</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="nx">rawKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">HAS</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">HAS</span><span class="p">,</span> <span class="nx">rawKey</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">key</span> <span class="o">===</span> <span class="nx">rawKey</span>
    <span class="o">?</span> <span class="nx">target</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="o">:</span> <span class="nx">target</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">||</span> <span class="nx">target</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">rawKey</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
size: 取size 内部实现过程中是需要对 collection 进行迭代操作的，所以 track 用的是 <code>ITERATE_KEY</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">size</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">IterableCollections</span><span class="p">,</span> <span class="nx">isReadonly</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="nx">target</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
  <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span> <span class="nx">ITERATE_KEY</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
add: set.add 操作，根据 set 特性，key,value 都是同一个且元素是不重复的，所以只需
要检测是不是新增，新增就需要 trigger ADD 。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">SetTypes</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">proto</span> <span class="o">=</span> <span class="nx">getProto</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="c1">// 因为 set 是不会存在重复元素的，所以只会在没有当前 key 的情况下才会执行
</span><span class="c1"></span>  <span class="c1">// 添加操作
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
trigger 处理：<a href="https://github.com/gcclll/stb-vue-next/commit/838b4023b61bc0fede67e94aa7fd857a4950c29e">838b402</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/838b4023b61bc0fede67e94aa7fd857a4950c29e">feat(add): collection trigger cases · gcclll/stb-vue-next@838b402</a></p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, get map size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, get map size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`observed has &#39;foo&#39; -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observedSet</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">set</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observedSet</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before add, get set size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after add, get set size -&gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
before set, get map size -&gt; dummy = 0
after set, get map size -&gt; dummy = 1
observed has &#39;foo&#39; -&gt; dummy = true
before add, get set size -&gt; dummy = 0
after add, get set size -&gt; dummy = 1
</pre>
</div>
</div>
<div id="outline-container-headline-42" class="outline-2">
<h2 id="headline-42">
add collection delete,clear proxy handler
</h2>
<div id="outline-text-headline-42" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b3c5087095ace7797cf6c38bd45b99700d4b6059">feat(add): collection delete and clear · gcclll/stb-vue-next@b3c5087</a></p>
<p>
delete:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">deleteEntry</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">CollectionTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">has</span><span class="p">,</span> <span class="kr">get</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">getProto</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">hadKey</span> <span class="o">=</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">checkIdentityKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">has</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="kr">get</span> <span class="o">?</span> <span class="kr">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hadKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
clear:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">clear</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">IterableCollections</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">hadItems</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">size</span> <span class="o">!==</span> <span class="mi">0</span>
  <span class="kr">const</span> <span class="nx">oldTarget</span> <span class="o">=</span> <span class="nx">__DEV__</span>
    <span class="o">?</span> <span class="nx">isMap</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
      <span class="o">?</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
      <span class="o">:</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
    <span class="o">:</span> <span class="kc">undefined</span>

  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hadItems</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">CLEAR</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">oldTarget</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observedMap</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observedMap</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; map`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedMap</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; set`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observedSet</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">set</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observedSet</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observedSet</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; map
before delete, dummy = 1
after delete, dummy = 0
before clear, dummy = 2
after clear, dummy = 0
&gt;&gt;&gt; set
before delete, dummy = 1
after delete, dummy = 0
before clear, dummy = 3
after clear, dummy = 0
</pre>
</div>
</div>
<div id="outline-container-headline-43" class="outline-2">
<h2 id="headline-43">
add collection forEach proxy handler
</h2>
<div id="outline-text-headline-43" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/77a02224b107c9f6a2d5101affa861c7b4c8b392">feat(add): collection forEach proxy handler · gcclll/stb-vue-next@77a0222</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createForEach</span><span class="p">(</span><span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span> <span class="nx">isShallow</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">forEach</span><span class="p">(</span>
    <span class="k">this</span><span class="o">:</span> <span class="nx">IterableCollections</span><span class="p">,</span>
    <span class="nx">callback</span>: <span class="kt">Function</span><span class="p">,</span>
    <span class="nx">thisArg?</span>: <span class="kt">unknown</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="k">this</span> <span class="kr">as</span> <span class="kt">any</span>
    <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">rawTarget</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="nx">isReadonly</span> <span class="o">?</span> <span class="nx">toReadonly</span> : <span class="kt">isShallow</span> <span class="o">?</span> <span class="nx">toShallow</span> : <span class="kt">toReactive</span>
    <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span> <span class="nx">track</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span> <span class="nx">ITERATE_KEY</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">target</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// 重要：确保回调
</span><span class="c1"></span>      <span class="c1">// 1. 在 reactive map 作用域下被执行(this, 和第三个参数)
</span><span class="c1"></span>      <span class="c1">// 2. 接受的 value 值应该是个 reactive/readonly 类型
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisArg</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="nx">observed</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
将 forEach 封装了一层，对传递给回调的值 reactive 化，使用 <code>ITERATE_KEY</code> 收集调用
该方法的依赖。</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">ob</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">+=</span> <span class="nx">value</span> <span class="o">||</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before set 1, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 before set 2, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 before set 1, dummy = 0
#2 before set 2, dummy = 1
#3 after set, dummy = 4
</pre>
<ul>
<li>
<p><strong>#1</strong> effect 会立即执行一次，但是此时 map 没数据</p>
</li>
<li>
<p><strong>#1</strong> 添加 <code>foo =&gt; 1</code> 之后执行 effect fn forEach 迭代器进行累加操作的结果</p>
</li>
<li>
<p><strong>#2</strong> 添加 <code>bar =&gt; 2</code> 结果是 4，原因是到这一步的时候 <code>dummy = 1</code> 的，所以再累加之</p>
</li>
</ul>
<p>后就是 4</p>
</div>
</div>
<div id="outline-container-headline-44" class="outline-2">
<h2 id="headline-44">
add collection iterators methods proxy handler
</h2>
<div id="outline-text-headline-44" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e5497be89422f6d14d2d14c76bee42e3cf866eee">feat(add): collection iterable methods · gcclll/stb-vue-next@e5497be</a></p>
<p>
add code:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">interface</span> <span class="nx">Iterable</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span><span class="o">:</span> <span class="nx">Iterator</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Iterator</span> <span class="p">{</span>
  <span class="nx">next</span><span class="p">(</span><span class="nx">value?</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">IterationResult</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IterationResult</span> <span class="p">{</span>
  <span class="nx">value</span>: <span class="kt">any</span>
  <span class="nx">done</span>: <span class="kt">boolean</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createIterableMethod</span><span class="p">(</span>
  <span class="nx">method</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">,</span>
  <span class="nx">isReadonly</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">isShallow</span>: <span class="kt">boolean</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span>
    <span class="k">this</span><span class="o">:</span> <span class="nx">IterableCollections</span><span class="p">,</span>
    <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[]</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">Iterable</span> <span class="o">&amp;</span> <span class="nx">Iterator</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">RAW</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">rawTarget</span> <span class="o">=</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">targetIsMap</span> <span class="o">=</span> <span class="nx">isMap</span><span class="p">(</span><span class="nx">rawTarget</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">isPair</span> <span class="o">=</span>
      <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;entries&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span> <span class="o">&amp;&amp;</span> <span class="nx">targetIsMap</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">isKeyOnly</span> <span class="o">=</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;keys&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">targetIsMap</span>
    <span class="kr">const</span> <span class="nx">innerIterator</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="nx">method</span><span class="p">](...</span><span class="nx">args</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="nx">isReadonly</span> <span class="o">?</span> <span class="nx">toReadonly</span> : <span class="kt">isShallow</span> <span class="o">?</span> <span class="nx">toShallow</span> : <span class="kt">toReactive</span>
    <span class="o">!</span><span class="nx">isReadonly</span> <span class="o">&amp;&amp;</span>
      <span class="nx">track</span><span class="p">(</span>
        <span class="nx">rawTarget</span><span class="p">,</span>
        <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">ITERATE</span><span class="p">,</span>
        <span class="nx">isKeyOnly</span> <span class="o">?</span> <span class="nx">MAP_KEY_ITERATE_KEY</span> : <span class="kt">ITERATE_KEY</span>
      <span class="p">)</span>

    <span class="c1">// 重写迭代器，让其返回的对象也是 reactive/readonly 类型
</span><span class="c1"></span>    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">next() {</span>
        <span class="kr">const</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">done</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">innerIterator</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">done</span>
          <span class="o">?</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">done</span> <span class="p">}</span>
          <span class="o">:</span> <span class="p">{</span>
              <span class="nx">value</span>: <span class="kt">isPair</span> <span class="o">?</span> <span class="p">[</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">:</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span>
              <span class="nx">done</span>
            <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
test:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">toRaw</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>

<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;dax&#39;</span> <span class="p">}</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;dax&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">dummy</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #1 set`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`obj in map is reactive </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;dax&#34;</span><span class="p">))</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">size</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #2 clear`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after clear, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #3 should not observe custom property`</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">observed</span><span class="p">.</span><span class="nx">customProp</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set cumstom prop, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">observed</span><span class="p">.</span><span class="nx">customProp</span> <span class="o">=</span> <span class="s1">&#39;Hello World&#39;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set cumstom prop, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; #4 不应该使 Proxies 污染原来的 Map 对象`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">observed2</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map2</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="nx">observed2</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`map2.get(&#39;key&#39;) !== value, </span><span class="si">${</span><span class="nx">map2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`map2.get(&#39;key&#39;) === toRaw(value), </span><span class="si">${</span><span class="nx">map2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">toRaw</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; #1 set
before set, dummy = foo,1,bar,2,dax,[object Object]
after set, dummy = foo,1,bar,2,dax,[object Object],foo,1,bar,2,dax,[object Object],baz,3
obj in map is reactive true
&gt;&gt;&gt; #2 clear
before clear, dummy = 4
after clear, dummy = 0
&gt;&gt;&gt; #3 should not observe custom property
before set cumstom prop, dummy = undefined
after set cumstom prop, dummy = undefined
&gt;&gt;&gt; #4 不应该使 Proxies 污染原来的 Map 对象
map2.get(&#39;key&#39;) !== value, true
map2.get(&#39;key&#39;) === toRaw(value), true
</pre>
<ul>
<li>
<p><strong>#1</strong> 在遍历过程中 get -&gt; track -&gt; 递归 reactive，所以 obj 是
<code>obsreved.get(&#39;dax&#39;)</code> 结果是 reactive 。</p>
</li>
<li>
<p><strong>#2</strong> clear 内部实现会取迭代器进行迭代删除，并且改变最终 size 值。</p>
</li>
<li>
<p><strong>#3</strong> collectionHandlers.ts 中的方法都是针对集合本身元素进行操作的，对于自定义
属性是不在响应式 Map/Set 之列的。</p>
</li>
<li>
<p><strong>#4</strong> set proxy handler 里面的实现会先取  <code>toRaw(value)</code> 再进行设置操作。</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-45" class="outline-2">
<h2 id="headline-45">
add collection readonly proxy handlers
</h2>
<div id="outline-text-headline-45" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fa2636d5e4f9d4b7bb7ba388ad25f692f27e6e4f">feat(add): readonly collection handlers · gcclll/stb-vue-next@fa2636d</a></p>
<p>
创建几个设置型的方法(<code>add,set,delete,clear</code>)
create readonly method for settable handlers(<code>add,set,delete,clear</code>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createReadonlyMethod</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="nx">TriggerOpTypes</span><span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">CollectionTypes</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="sb">`on key &#34;</span><span class="si">${</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sb">&#34;`</span> <span class="o">:</span> <span class="sb">``</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span>
        <span class="sb">`</span><span class="si">${</span><span class="nx">capitalize</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span><span class="si">}</span><span class="sb"> operation </span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb"> failed: target is readonly.`</span><span class="p">,</span>
        <span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kr">type</span> <span class="o">===</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="k">this</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
readonly instrumentations:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">readonlyInstrumentations</span>: <span class="kt">Recor</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Function</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kr">get</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="kr">get</span> <span class="nx">size() {</span>
    <span class="k">return</span> <span class="nx">size</span><span class="p">((</span><span class="k">this</span> <span class="kr">as</span> <span class="kt">unknown</span><span class="p">)</span> <span class="kr">as</span> <span class="nx">IterableCollections</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">has</span><span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="nx">MapTypes</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">add</span>: <span class="kt">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">),</span>
  <span class="kr">set</span><span class="o">:</span> <span class="nx">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">),</span>
  <span class="k">delete</span><span class="o">:</span> <span class="nx">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">),</span>
  <span class="nx">clear</span>: <span class="kt">createReadonlyMethod</span><span class="p">(</span><span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">CLEAR</span><span class="p">),</span>
  <span class="nx">forEach</span>: <span class="kt">createForEach</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
</div>
</div>
<div id="outline-container-headline-46" class="outline-2">
<h2 id="headline-46">
add collection shallow proxy handlers
</h2>
<div id="outline-text-headline-46" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/676bc70fe9a6535b85ada4754fb6a683bec50f5f">feat(add): shallow collection handlers · gcclll/stb-vue-next@676bc70</a></p>
<p>
不会递归 reactive 版本。</p>
</div>
</div>
<div id="outline-container-computed" class="outline-2">
<h2 id="computed">
computed
</h2>
<div id="outline-text-computed" class="outline-text-2">
<div id="outline-container-headline-48" class="outline-3">
<h3 id="headline-48">
types definitions
</h3>
<div id="outline-text-headline-48" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e9e53a16dcaffd35aa519b3251e4bcb4ad4e9342">feat(add): computed type definitions · gcclll/stb-vue-next@e9e53a1</a></p>
<p>
computed 计算属性的一些类型定义。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Ref</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;./ref&#39;</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="kr">extends</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{}</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="kr">extends</span> <span class="nx">Ref</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{}</span>

<span class="kr">export</span> <span class="kr">type</span> <span class="nx">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ctx?</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">T</span>

<span class="kr">export</span> <span class="kr">type</span> <span class="nx">ComputedSetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">v</span>: <span class="kt">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
computed 函数重载(<a href="https://github.com/gcclll/stb-vue-next/commit/315e0d91869dd4332c740e56d4e385f04b6009e9">315e0d9</a>)：
<a href="https://github.com/gcclll/stb-vue-next/commit/315e0d91869dd4332c740e56d4e385f04b6009e9">feat(add): computed function reloads · gcclll/stb-vue-next@315e0d9</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">options</span>: <span class="kt">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">getterOrOptions</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-49" class="outline-3">
<h3 id="headline-49">
implementation
</h3>
<div id="outline-text-headline-49" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/64d380dfea9da6a78f10fe2de9ef95fbd253d3f0">feat(add): computed tpl and computed function · gcclll/stb-vue-next@64d380d</a></p>
<p>
计算属性实现全在 <code>ComputedRefImpl&lt;T&gt;</code> 类的实现中，实现关键点</p>
<ol>
<li>
<p>使用 effect 封装 getter 函数，收集所有依赖，在特定时候执行 effect</p>
</li>
<li>
<p>_dirty 标记，一旦 <code>_dirty = true</code> 表示数据有更新，下次取值的时候就要立即执行
effect 取最新值</p>
</li>
</ol>
<p>
class <code>ComputedRefImpl</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 计算属性模板
</span><span class="c1"></span><span class="kr">class</span> <span class="nx">ComputedRefImpl</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">_value</span><span class="o">!:</span> <span class="nx">T</span>
  <span class="kr">private</span> <span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">effect</span>: <span class="kt">ReactiveEffect</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kr">public</span> <span class="kr">readonly</span> <span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">]</span><span class="o">:</span> <span class="kr">boolean</span>

  <span class="kr">constructor</span><span class="p">(</span>
    <span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;,</span>
    <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_setter</span>: <span class="kt">ComputedSetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;,</span>
    <span class="nx">isReadonly</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">effect</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(</span><span class="nx">getter</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">lazy</span>: <span class="kt">true</span><span class="p">,</span>
      <span class="nx">scheduler</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="nx">trigger</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">this</span><span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">IS_READONLY</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isReadonly</span>
  <span class="p">}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">effect</span><span class="p">()</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newValue</span>: <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_setter</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
computed 函数:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">options</span>: <span class="kt">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">getterOrOptions</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
  <span class="kd">let</span> <span class="nx">setter</span>: <span class="kt">ComputedSetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">getterOrOptions</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">getter</span> <span class="o">=</span> <span class="nx">getterOrOptions</span>
    <span class="nx">setter</span> <span class="o">=</span> <span class="nx">__DEV__</span>
      <span class="o">?</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Write operation failed: computed value is readonly&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="o">:</span> <span class="nx">NOOP</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">getter</span> <span class="o">=</span> <span class="nx">getterOrOptions</span><span class="p">.</span><span class="kr">get</span>
    <span class="nx">setter</span> <span class="o">=</span> <span class="nx">getterOrOptions</span><span class="p">.</span><span class="kr">set</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nx">ComputedRefImpl</span><span class="p">(</span>
    <span class="nx">getter</span><span class="p">,</span>
    <span class="nx">setter</span><span class="p">,</span>
    <span class="nx">isFunction</span><span class="p">(</span><span class="nx">getterOrOptions</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">getterOrOptions</span><span class="p">.</span><span class="kr">set</span>
  <span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
computed 函数的 options 可以是函数或一个对象，可以用外部自定义 setter 函数，比如
在更新之前记录当前状态，就可以在 options.set 中去实现。</p>
<p>
测试请移步“<a href="#test-computed">计算属性测试用例</a>”</p>
<p>
脑图请直接查看“<a href="#whole-mind-map">完整脑图 computed 部分</a>”</p>
</div>
</div>
</div>
</div>
<div id="outline-container-ref" class="outline-2">
<h2 id="ref">
add ref
</h2>
<div id="outline-text-ref" class="outline-text-2">
<p>
<img src="/img/vue3/reactivity/reactivity-ref.svg" alt="/img/vue3/reactivity/reactivity-ref.svg" title="/img/vue3/reactivity/reactivity-ref.svg" /></p>
<p>
这部分因为之前没有单独拎出来一步步实现，而是直接拷贝过来了为了先测试 computed 属
性。</p>
<p>
所以这里直接根据源码以及使用方式来进行逐步分析。</p>
<p>
APIs:</p>
<table>
<thead>
<tr>
<th>api</th>
<th>function</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>isRef(r:any)</code></td>
<td>检测函数</td>
</tr>
<tr>
<td><code>ref(value)</code></td>
<td>将 value 转成 Ref 类型</td>
</tr>
<tr>
<td><code>shallowRef(value)</code></td>
<td>不进行递归 reactive</td>
</tr>
<tr>
<td><code>createRef(rawValue, shallow = false)</code></td>
<td>create ref, for ref/shallowRef</td>
</tr>
<tr>
<td><code>triggerRef(ref: Ref)</code></td>
<td>触发 ref 变量上的所有依赖</td>
</tr>
<tr>
<td><code>unref(ref)</code></td>
<td>取消 ref 化，返回 ref.value 原始值</td>
</tr>
<tr>
<td><code>proxyRefs(objectWithRefs)</code></td>
<td>refs 代理</td>
</tr>
<tr>
<td><code>RefImpl</code></td>
<td>Ref 变量模板</td>
</tr>
<tr>
<td><code>CustomRefImpl</code></td>
<td>自定义 Ref 变量模板</td>
</tr>
</tbody>
</table>
<div id="outline-container-headline-51" class="outline-3">
<h3 id="headline-51">
ref &amp; shallow ref
</h3>
<div id="outline-text-headline-51" class="outline-text-3">
<p>
<code>ref()</code> 和 <code>shallowRef()</code> 函数都是调用的同一个函数 <code>createRef(val, shallow)</code> 来
创建ref 变量，而 <code>createRef</code> 本身也很简单，就是 <code>new</code> 了一个 <code>RefImpl</code> 实例出来。</p>
<p>
另外针对已经是 ref 的值不需要重复 <code>new</code> 操作，直接返回原 ref。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// ref
</span><span class="c1"></span> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">ref</span><span class="p">(</span><span class="nx">value?</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">createRef</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
 <span class="p">}</span>

<span class="c1">// shallow ref
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">shallowRef</span><span class="p">(</span><span class="nx">value?</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createRef</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// createRef(rawValue, shallow = false)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">createRef</span><span class="p">(</span><span class="nx">rawValue</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">rawValue</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rawValue</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">RefImpl</span><span class="p">(</span><span class="nx">rawValue</span><span class="p">,</span> <span class="nx">shallow</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
参数：</p>
<ol>
<li>
<p>val 需要进行 ref 化的变量</p>
</li>
<li>
<p>shallow 如果 val 是对象的时候决定是否需要对该对象进行递归 reactive 化</p>
</li>
</ol>
<p>
看下 ref 结构模板类： <code>RefImpl&lt;T&gt;</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">class</span> <span class="nx">RefImpl</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">T</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">_rawValue</span>: <span class="kt">T</span><span class="p">,</span> <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">_shallow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">_shallow</span> <span class="o">?</span> <span class="nx">_rawValue</span> : <span class="kt">convert</span><span class="p">(</span><span class="nx">_rawValue</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">newVal</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">newVal</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_shallow</span> <span class="o">?</span> <span class="nx">newVal</span> : <span class="kt">convert</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span>
      <span class="nx">trigger</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">newVal</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
代码是相当简单的，四个属性(<code>_value/__v_isRef/_rawValue/_shallow</code>)+两个访问器方法
(<code>value getter/setter</code>)。</p>
<blockquote>
<p>根据 es6 class 语法，构造参数如果使用了权限修饰符会自动转成成员属性，所以
<code>_rawValue</code> 和 <code>_shallow</code> 也是 RefImpl 成员属性和 <code>_value</code> 是一样的，区别在于这
两个值可以通过外部控制。</p>
</blockquote>
<p>
开始测试吧：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rt</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">shallowRef</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;1. base usage &gt;&gt;&gt;&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;before, a.value = &#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">]);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;after, a.value = &#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">]);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n2. should be reactive &gt;&gt;&gt;&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;ge/set value 里面使用的是 track/trigger&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
  <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">calls</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`before set a.value, dummy=</span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, calls=</span><span class="si">${</span><span class="nx">calls</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`after set a.value, dummy=</span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, calls=</span><span class="si">${</span><span class="nx">calls</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n3. 默认情况下对嵌套对象属性进行 reactive &gt;&gt;&gt;&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="p">));</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before set, dummy = ${dummy}&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after set, dummy = ${dummy}&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n4. ref() 不传值的时候也应该可以工作&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">();</span>
<span class="c1">// 简单的赋值操作，给什么值都可以
</span><span class="c1"></span><span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="p">));</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">c</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="c1">// 当嵌套在一个多层级的对象里的时候
</span><span class="c1">// 因为 ref() 返回的是个对象，所以放在对象里面本质上操作的还是
</span><span class="c1">// ref 本身
</span><span class="c1"></span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n5. ref 作为多级对象的值时&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span>
  <span class="nx">d</span><span class="p">,</span>
  <span class="nx">b</span><span class="o">:</span> <span class="p">{</span> <span class="nx">c</span><span class="o">:</span> <span class="nx">d</span> <span class="p">},</span>
<span class="p">});</span>
<span class="kd">let</span> <span class="nx">dummy1</span><span class="p">,</span> <span class="nx">dummy2</span><span class="p">;</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy1</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">d</span><span class="p">;</span>
  <span class="nx">dummy2</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`d.value++, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="c1">// 注意这里直接针对 ref 进行赋值操作而不是obj.d.value++
</span><span class="c1">// 这样也是可以的，因为 set proxy 里面有检测该属性是不是 ref
</span><span class="c1">// 如果是 Ref 会转变成对 obj.d.value++ 也就是说 vue 内部帮
</span><span class="c1">// 我们这么做了，下面对 obj.b.c++ 同
</span><span class="c1"></span><span class="nx">obj</span><span class="p">.</span><span class="nx">d</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`obj.d++, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`obj.b.c++, dummy1=</span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">, dummy2=</span><span class="si">${</span><span class="nx">dummy2</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
1. base usage &gt;&gt;&gt;
before, a.value =  1
after, a.value =  2

2. should be reactive &gt;&gt;&gt;
ge/set value 里面使用的是 track/trigger
before set a.value, dummy=2, calls=1
after set a.value, dummy=3, calls=2

3. 默认情况下对嵌套对象属性进行 reactive &gt;&gt;&gt;
before set, dummy = ${dummy}
after set, dummy = ${dummy}

4. ref() 不传值的时候也应该可以工作
before set, dummy = undefined
after set, dummy = 100

5. ref 作为多级对象的值时
before set, dummy1=1, dummy2=1
d.value++, dummy1=2, dummy2=2
obj.d++, dummy1=3, dummy2=3
obj.b.c++, dummy1=4, dummy2=4
undefined
</pre>
<p>
测试分析：</p>
<ol>
<li>
<p>基本使用</p>
<p>
ref 实现基于 effect 的 track 和 trigger</p>
<p>
get value 实现</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
set value 实现</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="nx">newVal</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
      <span class="c1">// convert() 检测 newVal 是对象就调用 reactive
</span><span class="c1"></span>      <span class="c1">// 注意这里只是简单的赋值操作，所以 ref 可以接受任意类型的值
</span><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_shallow</span> <span class="o">?</span> <span class="nx">newVal</span> : <span class="kt">convert</span><span class="p">(</span><span class="nx">newVal</span><span class="p">);</span>
      <span class="c1">// trigger 触发 value 属性上的依赖进行
</span><span class="c1"></span>      <span class="c1">// 因为 track 也是在这个属性上进行收集的
</span><span class="c1"></span>      <span class="nx">trigger</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">,</span> <span class="nx">newVal</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>should be reactive</p>
<p>
这个在 <strong>1</strong> 列出了 get value 源码，结合 track/trigger 达到 reactive 目的。</p>
</li>
<li>
<p>这一点直接看源码 <code>set value(newVal)</code></p>
<p>
<code>this._value = this._shallow ? newVal : convert(newVal)</code></p>
<p>
convert() 针对对象 reactive</p>
</li>
<li>
<p>因为 <code>new RefImpl(rawValue, shallow)</code> 是简单的赋值操作，给啥值都行</p>
</li>
<li>
<p>因为 <code>new RefImpl(rawValue, shallow)</code> 返回的是个 RefImpl 实例对象，属于引用类
型，不管对象层级多深，最终引用的都是这个对象。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-52" class="outline-3">
<h3 id="headline-52">
object ref
</h3>
<div id="outline-text-headline-52" class="outline-text-3">
<p>
对对象的所有属性进行 ref 化，在进行 proxy ref 之前需要先完成这部分，因为它依赖
object ref。</p>
<table>
<thead>
<tr>
<th>function</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>toRefs(object)</code></td>
<td>ref对象的所有属性</td>
</tr>
<tr>
<td><code>ObjectRefImpl</code></td>
<td>对象 ref 模板</td>
</tr>
<tr>
<td><code>toRef(object, key)</code></td>
<td>针对 object[key] 进行 ref</td>
</tr>
</tbody>
</table>
<p>
相关源码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">class</span> <span class="nx">ObjectRefImpl</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="err">,</span> <span class="na">K</span> <span class="na">extends</span> <span class="na">keyof</span> <span class="na">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_object</span>: <span class="kt">T</span><span class="p">,</span> <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_key</span>: <span class="kt">K</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_key</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newVal</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ref object 属性的
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">toRef</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="err">,</span> <span class="na">K</span> <span class="na">extends</span> <span class="na">keyof</span> <span class="na">T</span><span class="p">&gt;(</span>
  <span class="kt">object</span><span class="o">:</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">key</span>: <span class="kt">K</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ToRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">[</span><span class="na">K</span><span class="err">]</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isRef</span><span class="p">(</span><span class="kt">object</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
    <span class="o">?</span> <span class="kt">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="o">:</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ObjectRefImpl</span><span class="p">(</span><span class="kt">object</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ref object 所有属性
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">toRefs</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="p">&gt;(</span><span class="kt">object</span><span class="o">:</span> <span class="nx">T</span><span class="p">)</span><span class="o">:</span> <span class="nx">ToRefs</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isProxy</span><span class="p">(</span><span class="kt">object</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`toRefs() expects a reactive object but received a plain one.`</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">ret</span>: <span class="kt">any</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="kt">object</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="kt">object</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="kt">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">toRef</span><span class="p">(</span><span class="kt">object</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>源码分析</strong> ： <code>ObjectRefImpl</code> 中针对每个 <code>object[key]</code> 持有了一份 object 引
 用 _object, 且在最开始 <code>new</code> 实例的时候将属性名保存到了 _key，后续取值设值用的都
 是这个值，然后重写了 getter/setter 函数，在取值设值的时候操作 <code>_object + _key</code>
 。</p>
<p>
 打个比方：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 原始对象
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">rawObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>

<span class="c1">// toRef(rawObj, &#39;count&#39;) 之后
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">reffed</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">_</span><span class="nx">key</span><span class="o">:</span> <span class="s2">&#34;count&#34;</span><span class="p">,</span>
  <span class="mi">_</span><span class="nx">object</span><span class="o">:</span> <span class="nx">rawObj</span><span class="p">,</span>
  <span class="nx">get</span> <span class="nx">value</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="nx">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">object</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="mi">_</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="c1">// 然后当你改变 reffed.value 值时实际上是在改变 rawObj.count 的值
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, rawObj.count = </span><span class="si">${</span><span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">reffed</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, rawObj.count = </span><span class="si">${</span><span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// toRefs(rawObj) 就是对所有属性进行 toRef()，然后将返回的值用
</span><span class="c1">// 同样的 key 组成新的对象返回
</span><span class="c1">// 如: 沿用上面的测试
</span><span class="c1">// toRefs(rawObj) 等于是返回了一个全新的对象这个对象内容为：
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">reffedObj</span> <span class="o">=</span> <span class="p">{</span>
 <span class="nx">count</span><span class="o">:</span> <span class="nx">reffed</span>
<span class="p">}</span>
<span class="c1">// 随后我们直接通过修改 reffedObj.count 来间接操作 rawObj 对象里属性的值
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before set on obj, rawObj.count = &#39;</span> <span class="o">+</span> <span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
<span class="nx">reffedObj</span><span class="p">.</span><span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">200</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;after set on obj, rawObj.count = &#39;</span> <span class="o">+</span> <span class="nx">rawObj</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
before set, rawObj.count = 0
after set, rawObj.count = 100
before set on obj, rawObj.count = 100
after set on obj, rawObj.count = 200
undefined
</pre>
<p>
 看到没，实际都是改变了 <code>rawObj.count</code></p>
<blockquote>
<p>所以, object ref 等于是创建了一个全新的对象里面包含的属性和 raw object 属性名一
致，但是值是 <code>ObjectRefImpl</code> 创建的实例，用来间接操作 raw object 。</p>
</blockquote>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">toRef</span><span class="p">,</span> <span class="nx">proxyRefs</span><span class="p">,</span> <span class="nx">toRefs</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">objRef</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="kd">let</span> <span class="nx">dummy</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span>
<span class="p">})</span>
<span class="c1">// proxyRefs(objRef)
</span><span class="c1"></span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; ref 基本用法&#39;</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`1. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`2. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; toRef 用法，ref 对象属性&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">toRef</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-53" class="outline-3">
<h3 id="headline-53">
ref proxy
</h3>
<div id="outline-text-headline-53" class="outline-text-3">
<p>
作用：代理 ref 遍历的 get/set 操作，让 get 在返回之前先 <code>unref(result)</code> 得到原始
的值返回，让 set 在 set 之前确保设值的值是在 ref.value 上。</p>
<p>
和 ref proxy 有关的函数和属性:</p>
<table>
<thead>
<tr>
<th>function</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>shallowUnwrapHandlers { get, set }</code></td>
<td>代理的 handler</td>
</tr>
<tr>
<td><code>proxyRefs(objectWithRefs)</code></td>
<td>代理 ref 对象</td>
</tr>
</tbody>
</table>
<p>
源码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// proxy handler
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">shallowUnwrapHandlers</span>: <span class="kt">ProxyHandler</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">unref</span><span class="p">(</span><span class="nx">Reflect</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)),</span>
  <span class="kr">set</span><span class="o">:</span> <span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">oldValue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">oldValue</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">proxyRefs</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="p">&gt;(</span>
  <span class="nx">objectWithRefs</span>: <span class="kt">T</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">ShallowUnwrapRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isReactive</span><span class="p">(</span><span class="nx">objectWithRefs</span><span class="p">)</span>
    <span class="o">?</span> <span class="nx">objectWithRefs</span>
    : <span class="kt">new</span> <span class="nx">Proxy</span><span class="p">(</span><span class="nx">objectWithRefs</span><span class="p">,</span> <span class="nx">shallowUnwrapHandlers</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ref proxy 作用：针对被 ref 的 object 对象，进行 get 和 set 操作代理。</p>
<p>
get 操作， <code>Reflect.get(...)</code> 拿到的是个 unref，通过 proxy get handler 去 ref 化，
返回其原始值。</p>
<p>
set 操作， <code>Reflect.set(...)</code> 新值是 ref 直接覆盖之前的 <code>target[key]</code> 值，如果不是
ref，将其设置到 <code>oldValue.value</code> 上。</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">toRef</span><span class="p">,</span> <span class="nx">proxyRefs</span><span class="p">,</span> <span class="nx">toRefs</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">objRef</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="kd">let</span> <span class="nx">dummy</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span>
<span class="p">})</span>
<span class="c1">// proxyRefs(objRef)
</span><span class="c1"></span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; ref 基本用法&#39;</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`1. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">objRef</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`2. dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; toRef 用法，ref 对象属性&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">toRef</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; before proxy
1. dummy = 0
2. dummy = 1
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-54" class="outline-3">
<h3 id="headline-54">
custom ref
</h3>
<div id="outline-text-headline-54" class="outline-text-3">
<p>
相关函数和类：</p>
<table>
<thead>
<tr>
<th>function</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CustomRefImpl</code></td>
<td>自定义的 ref 模板</td>
</tr>
<tr>
<td><code>customRef(factory)</code></td>
<td>自定义 ref，即由外部决定如何实现 getter &amp; settter value</td>
</tr>
</tbody>
</table>
<p>
让使用者自定义以什么方式在 get 的时候 track 或 set 的时候 trigger</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">CustomRefFactory</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">track</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
  <span class="nx">trigger</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">;</span>
  <span class="kr">set</span><span class="o">:</span> <span class="p">(</span><span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">class</span> <span class="nx">CustomRefImpl</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_get</span>: <span class="kt">ReturnType</span><span class="p">&lt;</span><span class="nt">CustomRefFactory</span><span class="err">&lt;</span><span class="na">T</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">];</span>
  <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_set</span>: <span class="kt">ReturnType</span><span class="p">&lt;</span><span class="nt">CustomRefFactory</span><span class="err">&lt;</span><span class="na">T</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">[</span><span class="s2">&#34;set&#34;</span><span class="p">];</span>

  <span class="kr">public</span> <span class="kr">readonly</span> <span class="nx">__v_isRef</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kr">constructor</span><span class="p">(</span><span class="nx">factory</span>: <span class="kt">CustomRefFactory</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="kr">get</span><span class="p">,</span> <span class="kr">set</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span>
      <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">),</span>
      <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">trigger</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">TriggerOpTypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_get</span> <span class="o">=</span> <span class="kr">get</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_set</span> <span class="o">=</span> <span class="kr">set</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_get</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_set</span><span class="p">(</span><span class="nx">newVal</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
就是我只负责给你构造一个 Ref 结构的对象，至于什么 get 和 set 怎么实现全权交给使
用者，get/set 默认 track/trigger value 属性。</p>
<p>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">toRefs</span><span class="p">,</span> <span class="nx">customRef</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">isRef</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">let</span> <span class="mi">_</span><span class="nx">trigger</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">custom</span> <span class="o">=</span> <span class="nx">customRef</span><span class="p">((</span><span class="nx">track</span><span class="p">,</span> <span class="nx">trigger</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span>
  <span class="nx">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">track</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">set</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="mi">_</span><span class="nx">trigger</span> <span class="o">=</span> <span class="nx">trigger</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">}));</span>

<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;custom is ref, &#39;</span> <span class="o">+</span> <span class="nx">isRef</span><span class="p">(</span><span class="nx">custom</span><span class="p">))</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">custom</span><span class="p">.</span><span class="nx">value</span>
<span class="p">})</span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;dummy = &#39;</span> <span class="o">+</span> <span class="nx">dummy</span><span class="p">)</span>
<span class="nx">custom</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1">// 这个时候还不会触发依赖更新，因为 trigger 并没有执行
</span><span class="c1">// 只是缓存到了 _trigger 上
</span><span class="c1"></span><span class="mi">_</span><span class="nx">trigger</span><span class="p">()</span> <span class="c1">// 手动触发 effects
</span><span class="c1"></span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;dummy = &#39;</span> <span class="o">+</span> <span class="nx">dummy</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
custom is ref, true
dummy = 1
dummy = 2
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-55" class="outline-3">
<h3 id="headline-55">
辅助函数
</h3>
<div id="outline-text-headline-55" class="outline-text-3">
<table>
<thead>
<tr>
<th>function</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>isRef(value)</code></td>
<td>检测 value.__v_isRef 值</td>
</tr>
<tr>
<td><code>triggerRef(ref)</code></td>
<td>手动触发 ref value 上的依赖</td>
</tr>
<tr>
<td><code>unref(ref)</code></td>
<td>返回 ref.value 值</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-56" class="outline-2">
<h2 id="headline-56">
jest 🏃跑🏃用例
</h2>
<div id="outline-text-headline-56" class="outline-text-2">
<p>除了 runtime-dom 没实现的部分，都通过了测试。</p>
<pre class="example">
@vue/runtime-dom (guessing &#39;runtimeDom&#39;)
created packages/vue/dist/vue.global.js in 1.4s
 FAIL  packages/reactivity/__tests__/effect.spec.ts
  ● Test suite failed to run

    packages/reactivity/__tests__/ref.spec.ts:11:26 - error TS2307: Cannot find module &#39;@vue/runtime-dom&#39; or its corresponding type declarations.

    11 import { computed } from &#39;@vue/runtime-dom&#39;
                                ~~~~~~~~~~~~~~~~~~

 PASS  packages/reactivity/__tests__/reactive.spec.ts
 PASS  packages/reactivity/__tests__/collections/Set.spec.ts
 PASS  packages/reactivity/__tests__/collections/Map.spec.ts
 PASS  packages/reactivity/__tests__/reactiveArray.spec.ts
 PASS  packages/reactivity/__tests__/collections/WeakMap.spec.ts
 PASS  packages/reactivity/__tests__/collections/WeakSet.spec.ts
 PASS  packages/reactivity/__tests__/shallowReactive.spec.ts
 PASS  packages/reactivity/__tests__/readonly.spec.ts
 FAIL  packages/reactivity/__tests__/ref.spec.ts
  ● Test suite failed to run

    Configuration error:

    Could not locate module @vue/runtime-dom mapped as:
    /Users/simon/github/vue/stb-vue-next/packages/$1/src.

    Please check your configuration for these entries:
    {
      &#34;moduleNameMapper&#34;: {
        &#34;/^@vue\/(.*?)$/&#34;: &#34;/Users/simon/github/vue/stb-vue-next/packages/$1/src&#34;
      },
      &#34;resolver&#34;: undefined
    }

      2 |   ref,
      3 |   effect,
    &gt; 4 |   reactive,
        |                      ^
      5 |   isRef,
      6 |   toRef,
      7 |   toRefs,

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/index.js:551:17)
      at Object.&lt;anonymous&gt; (packages/reactivity/__tests__/ref.spec.ts:4:23)

 PASS  packages/reactivity/__tests__/computed.spec.ts

Test Suites: 2 failed, 9 passed, 11 total
Tests:       169 passed, 169 total
Snapshots:   0 total
Time:        15.568 s
</pre>
</div>
</div>
<div id="outline-container-headline-57" class="outline-2">
<h2 id="headline-57">
用例分析
</h2>
<div id="outline-text-headline-57" class="outline-text-2">
<div id="outline-container-headline-58" class="outline-3">
<h3 id="headline-58">
Map.spec.ts
</h3>
<div id="outline-text-headline-58" class="outline-text-3">
<ul>
<li class="checked">
<p>instanceof</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;instanceof&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">original</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">observed</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">original</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">observed</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
<span class="nx">isReactive</span><span class="p">,</span>
<span class="nx">effect</span><span class="p">,</span>
<span class="nx">reactive</span><span class="p">,</span>
<span class="nx">targetMap</span><span class="p">,</span>
<span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 ob is reactive, </span><span class="si">${</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">ob</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 </span><span class="si">${</span><span class="nx">map</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 </span><span class="si">${</span><span class="nx">ob</span> <span class="k">instanceof</span> <span class="nx">Map</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">ob</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 ob is reactive, true
#2 true
#3 true
Map(0) {} Map(0) {}
</pre>
</li>
<li class="checked">
<p>should observe mutations(应该观察变化)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should observe mutations&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">dummy</span>
  <span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="k">new</span> <span class="nx">Map</span><span class="p">())</span>
  <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
  <span class="nx">map</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
  <span class="nx">map</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;value2&#39;</span><span class="p">)</span>
  <span class="nx">map</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
    <span class="nx">isReactive</span><span class="p">,</span>
    <span class="nx">effect</span><span class="p">,</span>
    <span class="nx">reactive</span><span class="p">,</span>
    <span class="nx">targetMap</span><span class="p">,</span>
    <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="k">new</span> <span class="nx">Map</span><span class="p">())</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">map</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  +RESULTS:</p>
<pre class="example">
#1 dummy = undefined
#2 dummy = value // set 触发 trigger effect fn
#3 dummy = value2 // 同上
#4 dummy = undefined // 删除触发 DELETE trigger 与该
</pre>
<p>
  <strong>#4</strong> 属性的 ADD | DELETE | SET 操作首先会将所有与该 key 有关的依赖添加到将执行序列。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// SET | ADD | DELETE operation
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">depsMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="unchecked">
<p>should observe mutations with observed value as key</p>
<p>
将 reactive 类型的值作为 key 的时候也应该能被观察变化。</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-test-computed" class="outline-3">
<h3 id="test-computed">
computed.spec.ts
</h3>
<div id="outline-text-test-computed" class="outline-text-3">
<p>
下面所有的用例都可以参考 <a href="#test-computed-01">用例 01</a> 的脑图(原理图)</p>
<div id="outline-container-test-computed-01" class="outline-4">
<h4 id="test-computed-01">
should return updated value
</h4>
<div id="outline-text-test-computed-01" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should return updated value&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">foo?</span>: <span class="kt">number</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({})</span>
    <span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
    <span class="nx">isReactive</span><span class="p">,</span>
    <span class="nx">effect</span><span class="p">,</span>
    <span class="nx">reactive</span><span class="p">,</span>
    <span class="nx">targetMap</span><span class="p">,</span>
    <span class="nx">shallowReactive</span><span class="p">,</span>
    <span class="nx">computed</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before set value.foo, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after set value.foo, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 before set value.foo, cValue.value = undefined
#2 after set value.foo, cValue.value = 1
</pre>
<p>
分析结果</p>
<p>
<strong>#1</strong> : 因为 computed 默认是 effect lazy 的，所以不会立即执行 effect，所以 cValue 也就不会有值</p>
<p>
<strong>#2</strong> : 此时值为 1，并不是因为 <code>value.foo = 1</code> 触发的 effect 执行，</p>
<p>
而是因为 <code>_dirty</code> 默认是 <code>true</code> 的，所以在 <strong>#1</strong> 处取值的时候触发了
<code>effect()</code> 执行， <code>_dirty = false</code> 了，值结果已出。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">get</span> <span class="nx">value() {</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">effect</span><span class="p">()</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="nx">track</span><span class="p">(</span><span class="nx">toRaw</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">TrackOpTypes</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
也正是由于 <code>effect</code> 的执行，让 <code>value.foo</code> 收集到了这个依赖。</p>
<p>
随后设置 <code>value.foo</code> 也会将 computed effect 执行，由于 options 中提供了
scheduler，所以会执行置 <code>_dirty = true</code> ，但是此时计算属性值并不会立即计算得出
结果(因为它的计算操作始终是在 <code>get value()</code> 里面发生的)，所有当下次取值操作(即
<strong>#2</strong> 行执行时)，检测到 <code>_dirty = true</code> 了才会重新计算返回最新结果。</p>
<p>
用例脑图：</p>
<p>
<img src="/img/vue3/reactivity/reactivity-computed-test-01.svg" alt="/img/vue3/reactivity/reactivity-computed-test-01.svg" title="/img/vue3/reactivity/reactivity-computed-test-01.svg" /></p>
</div>
</div>
<div id="outline-container-test-computed-02" class="outline-4">
<h4 id="test-computed-02">
should compute lazily
</h4>
<div id="outline-text-test-computed-02" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should compute lazily&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">foo?</span>: <span class="kt">number</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({})</span>
    <span class="kr">const</span> <span class="nx">getter</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span>

    <span class="c1">// lazy
</span><span class="c1"></span>    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">// should not compute again
</span><span class="c1"></span>    <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">// should not compute until needed
</span><span class="c1"></span>    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">// now it should compute
</span><span class="c1"></span>    <span class="nx">expect</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">// should not compute again
</span><span class="c1"></span>    <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">getter</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">computed</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kr">const</span> <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="o">++</span><span class="nx">n</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span>
<span class="c1">// lazy
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 before get value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times.`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 get value(), cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 after get value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>

<span class="c1">// 不该重复计算，因为 _dirty 在 #3 之后值为 false
</span><span class="c1"></span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 after get value 2, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>

<span class="c1">// 触发 cValue 的 effect 执行 scheduler，使得  _dirty = true
</span><span class="c1"></span><span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">// trigger effect
</span><span class="c1">// 因为上面赋值操作只是让 _dirty = true 了，并没有立即重新计算
</span><span class="c1">// 因为计算属性的结果总是在 get value() 操作中完成的
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 after set &#39;value.foo = 1&#39;, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>

<span class="c1">// 这里进行取值操作，正式发起重新计算
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#6 should re-compute value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// #6 重新计算后 _dirty 又变成了 false，所以现在取值不会再重新计算
</span><span class="c1"></span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#7 should not re-compute value, getter called </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times, cValue.value = </span><span class="si">${</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS: 分析如代码注释</p>
<pre class="example">
#1 before get value, getter called 0 times.
#2 get value(), cValue.value = undefined
#3 after get value, getter called 1 times
#4 after get value 2, getter called 1 times
#5 after set &#39;value.foo = 1&#39;, getter called 1 times
#6 should re-compute value, getter called 1 times, cValue.value = 1
#7 should not re-compute value, getter called 2 times, cValue.value = 1
</pre>
<blockquote>
<p>Tips: 总是记着计算属性重新计算的关键点：“_dirty = true 且随后的取值操作”。</p>
</blockquote>
</div>
</div>
<div id="outline-container-test-computed-03" class="outline-4">
<h4 id="test-computed-03">
should no longer update when stopped
</h4>
<div id="outline-text-test-computed-03" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should no longer update when stopped&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">foo?</span>: <span class="kt">number</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">({})</span>
    <span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">stop</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">effect</span><span class="p">)</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">computed</span><span class="p">,</span>
  <span class="nx">stop</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({})</span>
<span class="kr">const</span> <span class="nx">cValue</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">dummy</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">cValue</span><span class="p">.</span><span class="nx">value</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set value, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set value, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="c1">// 停止了 effect.active = false，在执行 effect fn 的时候
</span><span class="c1">// 会检测 active 如果是 false 会直接执行：
</span><span class="c1">// options.scheduler ? undefined : fn()
</span><span class="c1">// 而由于计算属性是默认提供了 scheduler 的，所以在 stop 之后
</span><span class="c1">// effect 就不会被执行
</span><span class="c1"></span><span class="nx">stop</span><span class="p">(</span><span class="nx">cValue</span><span class="p">.</span><span class="nx">effect</span><span class="p">)</span>
<span class="nx">value</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after stop and set value, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
before set value, dummy = undefined
after set value, dummy = 1
after stop and set value, dummy = 1
</pre>
</div>
</div>
<div id="outline-container-test-computed-04" class="outline-4">
<h4 id="test-computed-04">
<span class="todo">TODO</span>
should support setter
</h4>
<div id="outline-text-test-computed-04" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should support setter&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">plusOne</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">({</span>
      <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
      <span class="kr">set</span><span class="o">:</span> <span class="nx">val</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">plusOne</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">n</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">plusOne</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nx">plusOne</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-computed-05" class="outline-4">
<h4 id="test-computed-05">
should be readonly
</h4>
<div id="outline-text-test-computed-05" class="outline-text-4">
<p>
只读版本，是有 computed 使用的时候传入的参数(<code>option</code>)决定的。</p>
<ol>
<li>
<p>如果 option 是函数(<code>getter</code>) 那就是只读的</p>
</li>
<li>
<p>如果 option 是对象且提供了 <code>option.set</code> 那么是非只读</p>
</li>
<li>
<p>如果 option 是对象但是没有提供 <code>option.set</code> 那么也是只读的</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be readonly&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">a</span>: <span class="kt">1</span> <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">a</span><span class="p">&gt;({</span>
      <span class="kr">get</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span>
      <span class="p">},</span>
      <span class="kr">set</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
  <span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">isReadonly</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span><span class="p">,</span>
  <span class="nx">computed</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">a</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 x is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span> <span class="c1">// true
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 x.value is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 x.value.a is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">computed</span><span class="p">({</span>
  <span class="nx">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span>
  <span class="p">},</span>
  <span class="nx">set</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">v</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 z is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 z.value.a is readonly, </span><span class="si">${</span><span class="nx">isReadonly</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 x is readonly, true
#2 x.value is readonly, false
#3 x.value.a is readonly, false
#4 z is readonly, false
#5 z.value.a is readonly, false
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-65" class="outline-3">
<h3 id="headline-65">
effect.ts
</h3>
<div id="outline-text-headline-65" class="outline-text-3">
<div id="outline-container-test-01" class="outline-4">
<h4 id="test-01">
effect + track + trigger
</h4>
<div id="outline-text-test-01" class="outline-text-4">
<p>
commit: <a href="https://github.com/gcclll/stb-vue-next/commit/b5f97b413d4628f4ec8fcf4e859d387ebfac3ad8">feat: effect-trigger · gcclll/stb-vue-next@b5f97b4</a></p>
<ol>
<li>
<p>lazy: true 标识 effect fn 不会立即执行</p>
</li>
<li>
<p>点击 set 操作，此时并没有依赖，所以只会触发 count++</p>
</li>
<li>
<p>当点击 get 操作，触发 <code>track()</code> 收集依赖 fn -&gt; deps</p>
</li>
<li>
<p>再点击 set 操作，此时已经有依赖，所以会 <code>trigger()</code> 所有依赖更新</p>
</li>
<li>
<p>options.scheduler 选项作用</p>
<p>
如果 options 有 scheduler 选项， <code>trigger()</code> 的时候不会立即执行 effects 而是
调用 scheduler 并将当前需要被执行的 effect 当做参数给 scheduler，由使用者决定
何时去执行 effect，比如需要在 dummy 更新之前做点什么。</p>
</li>
</ol>
<style>
#_effect_test_02>.box {
  display: flex;
  justify-content: space-around;
}
#_effect_test_02>.box>button{
  border: none;
  width: 250px;
}
</style>
<div id="_effect_test_02">
<div class="box">
    <button class="getval">点我触发 get操作！</button>
    <button class="setval">点我触发 set操作！</button>
</div>
<br>
<div class="box">
    <button class="before-scheduler">手动调用 scheduler 之前</button>
    <button class="after-scheduler">手动调用 scheduler 之后</button>
</div>
<br>
<div class="box">
    <button class="code">点击查看测试源码</button>
    <button class="reset">重置</button>
</div>
<div class="result"></div>
<code></code>
</div>
<script id="GW0MDx">
setTimeout(function test() {
    if (typeof $ === 'undefined') return

    var ins = VueReactivity
    var effect = ins.effect
    var reactive = ins.reactive
    var target = { count: 0 }
    var counter = reactive(target)

    var $el = $("#_effect_test_02")
    var LOG = function (msg) {
      _log($el, msg)
    }

    var lazyEffect = effect(
      function fn() {
        var c = counter.count
        LOG('正在执行 effect fn..., counter.count = ' + counter.count)
      }, {
        lazy: true
      }
    )

    var effected = false
    var getDeps = function () {
      if (!ins.targetMap) return new Set()
      const depsMap = ins.targetMap.get(target) || new Map()
      return depsMap.get('count') || new Set()
    }
    $el.find(".setval").click(function() {
      counter.count++
      var size = getDeps().size
      if (size === 0) {
        LOG('target 此时无任何依赖，deps.size = ' + size + ', counter.count = ' + counter.count)
      }
    })
    $el.find(".reset").click(function() {
      ins.cleanup(lazyEffect)
      $el.children(".result").html('')
      effected = false
      counter.count = 0
      dummy = 0
      runner = undefined
      times = 0
      LOG('target.count deps.size = ' + getDeps().size)
    })
    $el.find(".getval").click(function() {
      if (!effected) {
        effected = true
        lazyEffect() // 手动执行 effect
        LOG('手动执行 effect()，开始收集依赖 fn -> deps<Set>, size: ' + getDeps().size)
      }
      LOG('取值操作(target.count 的 deps 数)：'
        + ins.targetMap.get(target).get('count').size
        + ', counter.count = ' + counter.count)
    })

    $el.find('.code').click(function() {
      console.log($("#GW0MDx").html())
      LOG('源码已输出到控制台(F12-console)....')
    })

    var dummy = 0, runner
    var counter1 = reactive({ count: 0 })
    var times = 0
    var schedulerEffect = effect(function fn() {
      dummy = counter1.count
    }, {
      scheduler: function(_effect) {
        LOG('scheduler 执行次数 ' + ++times + ', dummy = ' + dummy)
        runner = function() {
          _effect()
        }
      }
    })

    LOG('scheduler effect fn 第一次会被执行， dummy = ' + dummy)
    $el.find('.before-scheduler').click(function() {
      LOG('scheduler 不会被执行, dummy = ' + dummy)
    })

    $el.find('.after-scheduler').click(function() {
      counter1.count++
      runner()
    })
}, 1000)

</script>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-67" class="outline-2">
<h2 id="headline-67">
effect 测试
</h2>
<div id="outline-text-headline-67" class="outline-text-2">
<div id="outline-container-headline-68" class="outline-4">
<h4 id="headline-68">
测试1(base, prototype)
</h4>
<div id="outline-text-headline-68" class="outline-text-4">
<p>
测试内容：</p>
<ol>
<li>
<p>effect 基本使用</p>
</li>
<li>
<p>effect 作用域原型链</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 只执行一次 effect fn
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">isReactive</span><span class="p">,</span>
  <span class="nx">effect</span><span class="p">,</span>
  <span class="nx">reactive</span><span class="p">,</span>
  <span class="nx">targetMap</span><span class="p">,</span>
  <span class="nx">shallowReactive</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="c1">// 基本的测试用例就不列出来了，这里只列出有疑问的
</span><span class="c1">// 1. effect fn 只执行一次
</span><span class="c1">// 2. observe 基本属性
</span><span class="c1">// 3. observe 多个属性(n1,n2...) -&gt; effect(() =&gt; (dummy = obj.n1 + obj.n2))
</span><span class="c1">// 4. 同一个属性多个 effect，会将这多个 effects 收集到 prop 的 deps 中
</span><span class="c1">// 5. observe 属性删除
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span> <span class="nx">dummy1</span><span class="p">,</span> <span class="nx">dummy2</span>
<span class="kr">const</span> <span class="nx">ob</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="p">{</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span><span class="p">))</span> <span class="c1">// effect -&gt; ob, ob.foo, ob.foo.bar deps
</span><span class="c1"></span><span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy1</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`before set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, dummy1 = </span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">8</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after set, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, dummy1 = </span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="k">delete</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, dummy1 = </span><span class="si">${</span><span class="nx">dummy1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 原型链`</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">obj1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="nx">obj2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">num</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">obj1</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">parentCounter</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">obj2</span><span class="p">)</span>
<span class="c1">// 取值原理： 先自身再往上找原型链，所有只要
</span><span class="c1"></span><span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">parentCounter</span><span class="p">)</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">counter</span><span class="p">.</span><span class="nx">num</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; #1 obj1.num 的依赖`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj1</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; #2 obj2.num 的依赖, delete 之前`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj2</span><span class="p">))</span>
<span class="k">delete</span> <span class="nx">counter</span><span class="p">.</span><span class="nx">num</span> <span class="c1">// 这里删除了属性，触发 effect fn 里面取值操作发现没有属性了
</span><span class="c1">// 往原型链找，找到 parentCounter.num ，此时 parentCounter.num 收集 effect fn 进自己的 deps
</span><span class="c1">// 所以后面的 parentCounter.num 上的操作同样会触发 effect fn
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`after delete, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; #3 obj2.num 的依赖, delete 之后`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj2</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">))</span>
<span class="nx">parentCounter</span><span class="p">.</span><span class="nx">num</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4 after &#39;parentCounter.num = 4&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">num</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#5 after counter.num = 3&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
结果分析：</p>
<ul>
<li>
<p><strong>#1</strong> obj1.num 依赖是在 effect 第一次执行的时候收集的</p>
</li>
<li>
<p><strong>#2</strong> obj2.num 在执行 <code>delete counter.num</code> 之前是没有任何依赖</p>
<p>
因为此时并没有任何 <code>parentCounter</code> 上的操作</p>
</li>
<li>
<p><strong>#3</strong> obj2.num 有了自己的依赖</p>
<p>
此时，执行了 <code>delete counter.num</code> 逻辑如下：</p>
<p>
对 counter.num 执行删除会触发 <code>num</code> 上的所有依赖 deps，即执行 effect fn，</p>
<p>
在 effect fn 里面有 <code>counter.num</code> 的取值操作，但是发现属性被删除，根据取值查找
原理，会在对象的原型链上逐级往上查找(<code>parentCounter</code>)，找到
<code>parentCounter.num</code> 随机进行取值操作，所以删除操作之后的 <code>dummy = 2</code> ，且取值
操作触发 tracking 因此此时 <code>parentCounter.num</code> 就有了自己的依赖 effect fn。</p>
</li>
<li>
<p><strong>#4</strong> 给 parentCounter 设值触发 effect fn，查找原型链 , 所以 dummy = 4</p>
</li>
<li>
<p><strong>#5</strong> 给 counter 设值触发 effect fn，不查找原型链(自身属性)，所以 dummy = 3</p>
</li>
</ul>
<p>+RESULTS:</p>
<pre class="example">
before set, dummy = 0, dummy1 = 0
after set, dummy = 8, dummy1 = 8
after delete, dummy = undefined, dummy1 = undefined
&gt;&gt;&gt; 原型链
dummy = 0
&gt; #1 obj1.num 的依赖
&lt;ref *1&gt; Set(1) {
  [Function: reactiveEffect] {
    id: 2,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1] ],
    options: {}
  }
}
&gt; #2 obj2.num 的依赖, delete 之前
undefined
after delete, dummy = 2
&gt; #3 obj2.num 的依赖, delete 之后
&lt;ref *1&gt; Set(1) {
  [Function: reactiveEffect] {
    id: 2,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1], [Set] ],
    options: {}
  }
}
#4 after &#39;parentCounter.num = 4&#39;, dummy = 4
#5 after counter.num = 3&#39;, dummy = 3
undefined
</pre>
</div>
</div>
<div id="outline-container-effect-test-02" class="outline-4">
<h4 id="effect-test-02">
测试2(stop, …)
</h4>
<div id="outline-text-effect-test-02" class="outline-text-4">
<ol>
<li>
<p><strong>stop</strong> :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">shallowReactive</span><span class="p">,</span>
     <span class="nx">stop</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; stop effect`</span><span class="p">)</span>
 <span class="kd">let</span> <span class="nx">dummy</span>
 <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">prop</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
 <span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
     <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span>
 <span class="p">})</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">2</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1, after &#39;obj.prop = 2&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; prop deps, before stop`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="mi">__</span><span class="nx">v_raw</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;prop&#39;</span><span class="p">))</span>
 <span class="c1">// 清空了所有依赖
</span><span class="c1"></span> <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span> <span class="c1">// stop the effect, set effect.active = false
</span><span class="c1"></span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt; prop deps, after stop`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="mi">__</span><span class="nx">v_raw</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;prop&#39;</span><span class="p">))</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">3</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2, after stop, &#39;obj.prop = 3&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">4</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3, after stop, &#39;obj.prop = 4&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">runner</span><span class="p">()</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#4, after run runner, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">, runner.active = </span><span class="si">${</span><span class="nx">runner</span><span class="p">.</span><span class="nx">active</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 +RESULTS:</p>
<pre class="example">
&gt;&gt;&gt; stop effect
#1, after &#39;obj.prop = 2&#39;, dummy = 2
&gt; prop deps, before stop
&lt;ref *1&gt; Set(1) {
[Function: reactiveEffect] {
    id: 0,
    allowRecurse: false,
    _isEffect: true,
    active: true,
    raw: [Function (anonymous)],
    deps: [ [Circular *1] ],
    options: {}
}
}
&gt; prop deps, after stop
Set(0) {}
#2, after stop, &#39;obj.prop = 3&#39;, dummy = 2
#3, after stop, &#39;obj.prop = 4&#39;, dummy = 2
#4, after run runner, dummy = 4, runner.active = false
undefined
</pre>
<ul>
<li>
<p>stop 干了两件事(a. 清空所有 effect.deps, b. 将 effect.active 置为 false)</p>
</li>
<li>
<p>stop 之后 trigger 时没有 deps 可执行，所以无论如何 effect fn 不会被执行</p>
</li>
<li>
<p>手动执行 runner() 之后执行effect fn 重新收集依赖(此时 active 依旧为 <code>false</code>)</p>
</li>
</ul>
</li>
<li>
<p><strong>stop + scheduler</strong> :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">stop</span><span class="p">,</span>
     <span class="nx">shallowReactive</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

 <span class="kd">let</span> <span class="nx">dummy</span>
 <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">prop</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
 <span class="kr">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span><span class="p">),</span> <span class="p">{</span> <span class="nx">scheduler</span><span class="o">:</span> <span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">})</span>
 <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">2</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 after &#39;obj.prop = 2&#39;, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after &#39;obj.prop = 2&#39;, queue.length = </span><span class="si">${</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>

 <span class="nx">queue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">e</span><span class="p">())</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#3 after stop, queue forEach, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 +RESULTS:</p>
<pre class="example">
#1 after &#39;obj.prop = 2&#39;, dummy = 1
#2 after &#39;obj.prop = 2&#39;, queue.length = 1
#3 after stop, queue forEach, dummy = 1
</pre>
<p>
 提供了 scheduler 选项的 effect 永远不会被执行，源码：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effect</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><strong>onStop</strong> :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">stop</span><span class="p">,</span>
     <span class="nx">shallowReactive</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

 <span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span>
 <span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{},</span> <span class="p">{</span>
     <span class="nx">onStop</span><span class="p">()</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`stopped </span><span class="si">${</span><span class="o">++</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times`</span><span class="p">)</span>
     <span class="p">}</span>
 <span class="p">})</span>

 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>
 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>
 <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 +RESULTS:</p>
<pre class="example">
stopped 1 times
</pre>
<p>
 只会被执行一次，因为 <code>effect.active = true</code> 时才可以被 stop 。</p>
</li>
<li>
<p><strong>stop: 一个 stopped 的 effect 在一个正常的 effect 中调用</strong></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">isReactive</span><span class="p">,</span>
     <span class="nx">effect</span><span class="p">,</span>
     <span class="nx">reactive</span><span class="p">,</span>
     <span class="nx">targetMap</span><span class="p">,</span>
     <span class="nx">stop</span><span class="p">,</span>
     <span class="nx">shallowReactive</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/reactivity.global.js&#39;</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">dummy</span>
<span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">prop</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span>
<span class="p">})</span>

<span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#1 after stop runner, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="c1">// 这里等于是手动执行了 runner effect `dummy = obj.prop`
</span><span class="c1">// 所以下面的 effect 被 obj.prop 收集进 deps&lt;Set&gt;
</span><span class="c1"></span><span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">runner</span><span class="p">()</span>
<span class="p">})</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`#2 after runner in effect, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
#1 after stop runner, dummy = 1
#2 after runner in effect, dummy = 3
</pre>
<ol>
<li>
<p><strong>#1</strong> 值依旧是 1 ，是因为 stop 了</p>
</li>
<li>
<p><strong>#2</strong> 值为 3，是因为 effect 执行 runner() 使得 <code>obj.prop</code> 收集到第二个
effect fn 。</p>
</li>
</ol>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-whole-mind-map" class="outline-2">
<h2 id="whole-mind-map">
完整脑图
</h2>
<div id="outline-text-whole-mind-map" class="outline-text-2">
<p>
<img src="/img/vue3/reactivity/reactivity.svg" alt="/img/vue3/reactivity/reactivity.svg" title="/img/vue3/reactivity/reactivity.svg" /></p>
<div id="outline-container-mind-collection" class="outline-3">
<h3 id="mind-collection">
collection proxy handlers 脑图
</h3>
<div id="outline-text-mind-collection" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-collection-proxy.svg" alt="/img/vue3/reactivity/reactivity-collection-proxy.svg" title="/img/vue3/reactivity/reactivity-collection-proxy.svg" /></p>
</div>
</div>
<div id="outline-container-mind-effect" class="outline-3">
<h3 id="mind-effect">
effect 脑图
</h3>
<div id="outline-text-mind-effect" class="outline-text-3">
<p>
<img src="/img/vue3/reactivity/reactivity-effect.svg" alt="/img/vue3/reactivity/reactivity-effect.svg" title="/img/vue3/reactivity/reactivity-effect.svg" /></p>
</div>
</div>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-11-09
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/compiler-core/">compiler-core,</a>
          <a href="/tags/parser/">parser,</a>
          <a href="/tags/compiler/">compiler</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-compiler-core-parser/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 源码头脑风暴之 2 ☞compiler-core - ast parser</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-house-cc/">
            <span class="next-text nav-default">Vue3 源码头脑风暴之☞compiler-core</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
