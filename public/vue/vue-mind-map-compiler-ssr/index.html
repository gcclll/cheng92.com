<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 源码头脑风暴之 6 ☞compiler-ssr - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-compiler-ssr/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.06b20cf21b1dff0a19c6a6fd2770439ed0c003d544ece3c4e1fbfb34fc217e45.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 源码头脑风暴之 6 ☞compiler-ssr" />
<meta property="og:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-compiler-ssr/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2021-01-04T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-01-04T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 源码头脑风暴之 6 ☞compiler-ssr">
<meta itemprop="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu"><meta itemprop="datePublished" content="2021-01-04T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-01-04T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="9952">
<meta itemprop="keywords" content="vue,,vue3,,compiler-ssr," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 源码头脑风暴之 6 ☞compiler-ssr"/>
<meta name="twitter:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 源码头脑风暴之 6 ☞compiler-ssr</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-01-04 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> 约 9952 字 </span>
          <span class="more-meta"> 预计阅读 20 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">Tip</a>
</li>
<li><a href="#headline-2">05db578 compiler-ssr init</a>
<ul>
<li><a href="#headline-3">ssr text testing</a>
</li>
</ul>
</li>
<li><a href="#headline-4">54ad7e2 coding ssrCodegenTransform function</a>
</li>
<li><a href="#headline-5">561d41b ELEMENT: ssrTransformElement</a>
</li>
<li><a href="#headline-6">ea6bb01 add ssrInjectFallthroughAttrs 注入属性</a>
</li>
<li><a href="#headline-7">7d20acd ELEMENT: ssrTransformElement&gt;v-bind</a>
</li>
<li><a href="#headline-8">f6d22c1 TEXT 节点类型解析</a>
</li>
<li><a href="#headline-9">8f09472 INTERPOLATION 插值处理</a>
</li>
<li><a href="#headline-10">ssrTransformElement 续</a>
<ul>
<li><a href="#headline-11">954a9ee static class 属性处理</a>
</li>
<li><a href="#headline-12">c28d528 dynamic class 属性处理</a>
</li>
<li><a href="#headline-13">ca39229 style 属性处理</a>
</li>
<li><a href="#headline-14">dfd4fb9 v-html 指令处理</a>
</li>
<li><a href="#headline-15">678e98a v-text 指令处理</a>
</li>
<li><a href="#headline-16">0472dfd v-slot 指令错误</a>
</li>
<li><a href="#headline-17">45e78e1 v-bind 指令</a>
</li>
<li><a href="#headline-18">value on textarea</a>
<ul>
<li><a href="#headline-19">e79e343 static value</a>
</li>
<li><a href="#headline-20">dynamic value</a>
</li>
<li><a href="#headline-21">cdd8fd0 dynamic arg 动态参数</a>
</li>
</ul>
</li>
<li><a href="#headline-22">b97d467 input + boolean attr</a>
</li>
<li><a href="#headline-23">e58d062 dynamic key attr</a>
</li>
</ul>
</li>
<li><a href="#headline-24">893681b v-model transform</a>
<ul>
<li><a href="#headline-25">7502230 input type: radio</a>
</li>
<li><a href="#input-checkbox">input type: checkbox</a>
<ul>
<li><a href="#headline-27">880eaf3 with true/false-value</a>
</li>
<li><a href="#headline-28">59b1577 without true/false-value</a>
</li>
</ul>
</li>
<li><a href="#headline-29">a0d4a40 input type: file 时不能用 v-model</a>
</li>
<li><a href="#headline-30">d7309be v-model on textarea</a>
</li>
</ul>
</li>
<li><a href="#headline-31">169027e v-show transform</a>
</li>
<li><a href="#headline-32">5bf3644 v-if transform</a>
</li>
<li><a href="#headline-33">4839090 v-for transform</a>
</li>
<li><a href="#headline-34">8036837 其他不需要处理的情况</a>
</li>
<li><a href="#headline-35">16833be component transform</a>
</li>
<li><a href="#headline-36">cdba013 component slot outlet</a>
</li>
<li><a href="#headline-37">359f856 suspense 内置组件</a>
</li>
<li><a href="#headline-38">e27a5e4 teleport 内置组件</a>
</li>
<li><a href="#headline-39">e0fc173 transition group transform</a>
</li>
<li><a href="#headline-40">c8e1d56 ssrCssVars inject</a>
</li>
<li><a href="#headline-41">总结</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> 完全拷贝于 <a href="https://github.com/vuejs/vue-next">vue-next</a> ，主要目的用于学习。</strong>
</kbd></p>
<blockquote>
<p><strong>声明</strong> ：vue-next compiler-ssr 服务端渲染模块，相关的所有测试代码均在 <code>/js/vue/</code> 目录下面。</p>
<p>
<strong>更新日志&amp;Todos</strong> ：</p>
<ol>
<li>
<p>[2021-01-04 20:11:43] 创建</p>
</li>
<li>
<p>[2021-01-08 10:11:47] 完成</p>
</li>
</ol>
</blockquote>
<p>
模块初始化：<a href="https://github.com/gcclll/stb-vue-next/commit/dff9d31aeaf88e00f4d9233b05e8ddadc8d6ac5f">feat(init): compiler-ssr · gcclll/stb-vue-next@dff9d31 · GitHub</a></p>
<p>
脑图：</p>
<p>
<img src="/img/vue3/compiler-ssr/vue-compiler-ssr.svg" alt="/img/vue3/compiler-ssr/vue-compiler-ssr.svg" title="/img/vue3/compiler-ssr/vue-compiler-ssr.svg" /></p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Tip
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ol>
<li>
<p>ssr 不处理 v-on/v-once/v-cloak 三个指令</p>
</li>
<li>
<p>v-show 转成 <code>exp ? &#39;null&#39; : {display: &#39;none&#39;}</code> 合并到 <code>style</code></p>
</li>
<li>
<p><code>&lt;Suspense&gt;</code> 组件，会将所有 children 放到一个 <code>await</code> 函数里面执行</p>
</li>
<li>
<p><code>&lt;Teleport&gt;</code> 作用？</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
05db578 compiler-ssr init
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/05db578e37b1bb8651d18fb7b76abb2a064235dc">feat(init): compiler-ssr -&gt; compile function · gcclll/stb-vue-next@05db578 · GitHub</a></p>
<p>
源码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">compile</span><span class="p">(</span>
  <span class="nx">template</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">CompilerOptions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">CodegenResult</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">options</span><span class="p">,</span>
    <span class="c1">// 引用 DOM parser 选项
</span><span class="c1"></span>    <span class="p">...</span><span class="nx">parserOptions</span><span class="p">,</span>
    <span class="nx">ssr</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="nx">scopeId</span>: <span class="kt">options.mode</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">scopeId</span><span class="p">,</span>
    <span class="c1">// 总是加上前缀，ssr 不需要关系大小
</span><span class="c1"></span>    <span class="nx">prefixIdentifiers</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="c1">// ssr 下不需要缓存和静态提升优化
</span><span class="c1"></span>    <span class="nx">cacheHandlers</span>: <span class="kt">false</span><span class="p">,</span>
    <span class="nx">hoistStatic</span>: <span class="kt">false</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
  <span class="c1">// TODO Save raw options for AST. This is needed when performing sub-transforms
</span><span class="c1"></span>  <span class="c1">// on slot vnode branches.
</span><span class="c1"></span>
  <span class="nx">transform</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">options</span><span class="p">,</span>
    <span class="nx">nodeTransforms</span><span class="o">:</span> <span class="p">[</span>
      <span class="c1">// TODO ... ssr transforms
</span><span class="c1"></span>
      <span class="p">...(</span><span class="nx">options</span><span class="p">.</span><span class="nx">nodeTransforms</span> <span class="o">||</span> <span class="p">[])</span> <span class="c1">// user transforms
</span><span class="c1"></span>    <span class="p">],</span>
    <span class="nx">directiveTransforms</span><span class="o">:</span> <span class="p">{</span>
      <span class="c1">// 复用 compiler-core 的 v-bind
</span><span class="c1"></span>      <span class="nx">bind</span>: <span class="kt">transformBind</span><span class="p">,</span>
      <span class="c1">// TODO ... more ssr directive transforms
</span><span class="c1"></span>      <span class="p">...(</span><span class="nx">options</span><span class="p">.</span><span class="nx">directiveTransforms</span> <span class="o">||</span> <span class="p">{})</span> <span class="c1">// user transforms
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">})</span>

  <span class="c1">// TODO traverse the template AST and convert into SSR codegen AST
</span><span class="c1"></span>  <span class="c1">// by replacing ast.codegenNode.
</span><span class="c1"></span>  <span class="c1">// 将 compiler-core 阶段生成的 codegenNode 转换成 SSR codegen AST
</span><span class="c1"></span>
  <span class="k">return</span> <span class="nx">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
沿用 compiler-core 的三个阶段(<a href="/vue/vue-mind-map-compiler-core-parser/">parse</a> -&gt; <a href="/vue/vue-mind-map-compiler-core-transform-generate/">transform</a> -&gt; <a href="/vue/vue-mind-map-compiler-core-transform-generate/">generate</a>)，另加上 SSR 渲染相
关的选项和其对应的 transforms 函数。</p>
<div id="outline-container-headline-3" class="outline-4">
<h4 id="headline-3">
ssr text testing
</h4>
<div id="outline-text-headline-3" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">matched</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ssr</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;codegenNode: &#34;</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span> <span class="o">||</span> <span class="s2">&#34;null&#34;</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; render function&#39;</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
codegenNode:  null
&gt;&gt;&gt; render function

return function ssrRender(_ctx, _push, _parent, _attrs) {
  null
}
undefined
</pre>
<p>
结果显示没有 codegenNode， ssrRender 函数体内也就啥都没有。</p>
<p>
FIX: 应该需要需要实现 <code>ssrCodegenTransform</code> 。</p>
<blockquote>
<p>后面的所有测试都会依赖下面的正则(官方用例中的代码)：</p>
<p>
<code>/_push\(\`&lt;div\${\s*_ssrRenderAttrs\(_attrs\)\s*}&gt;([^]*)&lt;\/div&gt;\`\)/</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20210104214735.png" alt="http://qiniu.ii6g.com/img/20210104214735.png" title="http://qiniu.ii6g.com/img/20210104214735.png" /></p>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
54ad7e2 coding ssrCodegenTransform function
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/54ad7e2cc3334473aceca886343f397068ceddbb">feat(add): compiler-ssr-&gt; ssrCodegenTransform function ·
gcclll/stb-vue-next@54ad7e2 · GitHub</a></p>
<p>
生成 ssr codegenNode 的 transform 函数。</p>
<p>
大致流程和 compiler-core 差不多。</p>
<ol>
<li>
<p>创建上下文 context = <code>createSSRTransformContext(ast, options)</code></p>
</li>
<li>
<p>options.ssrCssVars 样式变量处理</p>
</li>
<li>
<p>如果多个且至少有一个为非文本节点，需要用到 fragment</p>
</li>
<li>
<p><code>processChildren</code> 递归处理所有孩子节点，生成 <code>codegenNode</code> , 所以这里是 <strong>核心</strong></p>
</li>
<li>
<p>helpers 合并</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">matched</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ssr</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; ast.children\n&#34;</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; ast.codegenNode.body\n&#34;</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">body</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; code\n&#34;</span><span class="p">,</span> <span class="nx">code</span><span class="p">]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; ast.children
 [
  {
    type: 2,
    content: &#39;foo&#39;,
    loc: { start: [Object], end: [Object], source: &#39;foo&#39; }
  }
]
&gt;&gt;&gt; ast.codegenNode.body
 [
  {
    type: 14,
    loc: { source: &#39;&#39;, start: [Object], end: [Object] },
    callee: &#39;_push&#39;,
    arguments: [ [Object] ]
  }
]
&gt;&gt;&gt; code

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`foo`)
}
undefined
</pre>
<p>
<strong>Bug1</strong>: body 里面没东西, <a href="https://github.com/gcclll/stb-vue-next/commit/f6d22c101b546a2de6d9cfb5b9b1ddd24fcc34d2">fix: body null · gcclll/stb-vue-next@f6d22c1 · GitHub</a></p>
<p>
<strong>Bug2</strong>: <code>div</code> 没有被解析到，因为没有实现 ssrTransformElement 所有这里要先实现它，
 测试用例中默认是 <code>&lt;div&gt;${src}&lt;/div&gt;</code> 包起来的。</p>
<blockquote>
<p>因为测试函数 <code>getCompiledSSRString</code> 中会将 src 用 <code>&lt;div&gt;</code> 包裹起来，所以需要先实
现 div 的解析，即 <code>NodeTypes.ELEMENT</code> 类型解析。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
561d41b ELEMENT: ssrTransformElement
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/561d41be869a4718e027273cdea71d3473628229">feat(add): ssr-&gt;ssrTransformElement · gcclll/stb-vue-next@561d41b · GitHub</a></p>
<p>
新增两个函数实现：</p>
<ol>
<li>
<p><code>ssrProcessElement</code> 处理标签</p>
</li>
<li>
<p><code>ssrPostTransformElement</code> ELEMENT 的转换函数</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssrs</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">matched</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ssrs</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; code\n&#34;</span><span class="p">,</span> <span class="nx">code</span><span class="p">]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; code

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div&gt;foo&lt;/div&gt;`)
}
undefined
</pre>
<p>
还是没有 <code>_ssrRenderAttrs</code> 匹配失败，与期待结果还差一步：属性解析。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/dc1571944ef04fb3149c6a112b37ef728230c3a4">feat(add): directives and node transforms from compiler-core ·
gcclll/stb-vue-next@dc15719 · GitHub</a></p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
ea6bb01 add ssrInjectFallthroughAttrs 注入属性
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ea6bb01d1b8493926d5426bc88af8d34b91b63da">feat(add): ssr-&gt; add ssrInjectFallthroughAttrs · gcclll/stb-vue-next@ea6bb01 ·
GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">ssrInjectFallthroughAttrs</span>: <span class="kt">NodeTransform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// _attrs is provided as a function argument.
</span><span class="c1"></span>  <span class="c1">// mark it as a known identifier so that it doesn&#39;t get prefixed by
</span><span class="c1"></span>  <span class="c1">// transformExpression.
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ROOT</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">identifiers</span><span class="p">.</span><span class="nx">_attrs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">parent</span> <span class="o">||</span> <span class="nx">parent</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ROOT</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">IF_BRANCH</span> <span class="o">&amp;&amp;</span> <span class="nx">hasSingleChild</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">injectFallThroughAttrs</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hasSingleChild</span><span class="p">(</span><span class="nx">parent</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">injectFallThroughAttrs</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这个函数是用来将 render 函数的 <code>attrs</code> 参数处理成 <code>v-bind</code> 指令。</p>
<p>
前提条件：</p>
<ol>
<li>
<p>必须要有 parent 父元素，即 ROOT 节点不会处理</p>
</li>
<li>
<p>且 parent 必须是 ROOT 节点，即 <code>attrs</code> 会注入到第一个最外层的元素上</p>
<p>
比如：实例中的 <code>&lt;div&gt;${src}&lt;/div&gt;</code> ， render 函数中的 <code>attrs</code> 会被注入到这个
<code>div</code> 上，这也是 <code>_ssrRenderAttrs</code> 的由来。</p>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssrs</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">matched</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ssrs</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; code\n&#34;</span><span class="p">,</span> <span class="nx">code</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; ast.children[0].props\n&#39;</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">props</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; code

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div&gt;foo&lt;/div&gt;`)
}
&gt;&gt;&gt; ast.children[0].props
 [
  {
    type: 7,
    name: &#39;bind&#39;,
    arg: undefined,
    exp: {
      type: 4,
      loc: [Object],
      content: &#39;_attrs&#39;,
      isStatic: false,
      constType: 0
    },
    modifiers: [],
    loc: { source: &#39;&#39;, start: [Object], end: [Object] }
  }
]
undefined
</pre>
<p>
虽然结果还没达预期，但是上面结果显示已经有属性了，那么接下来就是要处理这个属性了，
这个在 <code>ssrTransformElement</code> 中处理。</p>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
7d20acd ELEMENT: ssrTransformElement&gt;v-bind
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7d20acd63f38ff0b6a539c31526ae46dec78b70e">feat(add): ssr-&gt;element:v-bind · gcclll/stb-vue-next@7d20acd · GitHub</a></p>
<p>
新增处理代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 需要运行时做特殊处理
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">needTagForRuntime</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;textarea&#34;</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// 1. TODO v-bind
</span><span class="c1">// v-bind=&#34;obj&#34; or v-bind:[key] can potentially overwrite other static
</span><span class="c1">// attrs and can affect final rendering result, so when they are present
</span><span class="c1">// we need to bail out to full `renderAttrs`
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">hasDynamicVBind</span> <span class="o">=</span> <span class="nx">hasDynamicKeyVBind</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">hasDynamicVBind</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">props</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">buildProps</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span> <span class="kc">true</span> <span class="cm">/* ssr */</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">propsExp</span> <span class="o">=</span> <span class="nx">createCallExpression</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_RENDER_ATTRS</span><span class="p">),</span> <span class="p">[</span>
      <span class="nx">props</span><span class="p">,</span>
    <span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;textarea&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;input&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">needTagForRuntime</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">propsExp</span><span class="p">.</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`&#34;</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">&#34;`</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">openTag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">propsExp</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
因为在上一节中将 <code>attrs</code> 注册为了 v-bind 属性，因此在 transform element 中就有
Props 需要处理了， <code>ssrRenderAttrs</code> 就是在这里增加了 <code>SSR_RENDER_ATTRS</code> 。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssrs</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">matched</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ssrs</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; code\n&#34;</span><span class="p">,</span> <span class="nx">code</span><span class="p">]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; code
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;foo&lt;/div&gt;`)
}
undefined
</pre>
<p>
到这里算是能满足测试用例中的正则要求了。</p>
<p>
_attrs 注入逻辑脑图：
<img src="http://qiniu.ii6g.com/img/20210106143502.png" alt="http://qiniu.ii6g.com/img/20210106143502.png" title="http://qiniu.ii6g.com/img/20210106143502.png" /></p>
</div>
</div>
<div id="outline-container-headline-8" class="outline-2">
<h2 id="headline-8">
f6d22c1 TEXT 节点类型解析
</h2>
<div id="outline-text-headline-8" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f6d22c101b546a2de6d9cfb5b9b1ddd24fcc34d2">fix: body null · gcclll/stb-vue-next@f6d22c1 · GitHub</a></p>
<p>
新增 <code>pushStringPart</code> 函数的实现，用来处理 <code>NodeTypes.TEXT</code> 节点类型。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">switch</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nx">NodeTypes.TEXT</span>:
    <span class="kt">context.pushStringPart</span><span class="p">(</span><span class="nx">escapeHtml</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">content</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssrs</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 静态文本\n&#34;</span><span class="p">,</span> <span class="nx">ssrs</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">).</span><span class="nx">code</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 静态文本，含反斜杠\n&#34;</span><span class="p">,</span> <span class="nx">ssrs</span><span class="p">(</span><span class="sb">`\\$foo`</span><span class="p">).</span><span class="nx">code</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 静态文本，&amp;lt; 等符号的\n&#34;</span><span class="p">,</span> <span class="nx">ssrs</span><span class="p">(</span><span class="sb">`&amp;lt;foo&amp;gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span>
  <span class="s2">&#34;&gt;&gt;&gt; 静态文本，元素嵌套\n&#34;</span><span class="p">,</span>
  <span class="nx">ssrs</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;span&gt;hello&lt;/span&gt;&lt;span&gt;bye&lt;/span&gt;&lt;/div&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">,</span>
<span class="p">]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 静态文本
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;foo&lt;/div&gt;`)
}
&gt;&gt;&gt; 静态文本，含反斜杠
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;\\\$foo&lt;/div&gt;`)
}
&gt;&gt;&gt; 静态文本，&amp;lt; 等符号的
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&amp;lt;foo&amp;gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; 静态文本，元素嵌套
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;div&gt;&lt;span&gt;hello&lt;/span&gt;&lt;span&gt;bye&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-9" class="outline-2">
<h2 id="headline-9">
8f09472 INTERPOLATION 插值处理
</h2>
<div id="outline-text-headline-9" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/8f09472a264682cc6fb0b8c66586ac555af86f32">feat(add): ssr-&gt;interpolation · gcclll/stb-vue-next@8f09472 · GitHub</a></p>
<p>
增加代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">case</span> <span class="nx">NodeTypes.INTERPOLATION</span>:
  <span class="kt">context.pushStringPart</span><span class="p">(</span>
    <span class="nx">createCallExpression</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_INTERPOLATE</span><span class="p">),</span> <span class="p">[</span><span class="nx">child</span><span class="p">.</span><span class="nx">content</span><span class="p">])</span>
  <span class="p">)</span>
  <span class="k">break</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 插值处理\n&#34;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`\`\${foo}\``</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 插值处理，元素嵌套\n&#34;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;span&gt;{{ foo }} bar&lt;/span&gt;&lt;span&gt;baz {{ qux }}&lt;/span&gt;&lt;/div&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 插值处理
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;\`\${foo}\`&lt;/div&gt;`)
}
&gt;&gt;&gt; 插值处理，元素嵌套
 const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div&gt;&lt;span&gt;${
    _ssrInterpolate(_ctx.foo)
  } bar&lt;/span&gt;&lt;span&gt;baz ${
    _ssrInterpolate(_ctx.qux)
  }&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
<p>
第一个并非直接的差值，而是字符串形式，所以并没有当做插值处理。</p>
<p>
后面的差值调用 <code>_ssrInterpolate(_ctx.foo)</code> 处理</p>
</div>
</div>
<div id="outline-container-headline-10" class="outline-2">
<h2 id="headline-10">
ssrTransformElement 续
</h2>
<div id="outline-text-headline-10" class="outline-text-2">
<div id="outline-container-headline-11" class="outline-3">
<h3 id="headline-11">
954a9ee static class 属性处理
</h3>
<div id="outline-text-headline-11" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/954a9ee4200022b881de18b28c2179a63f8a2797">feat(add): ssr-&gt;static class attr · gcclll/stb-vue-next@954a9ee · GitHub</a></p>
<p>
静态 class 属性处理:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">prop</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="c1">// 忽略 input 上的 true 值或 false 值
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;input&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">isTrueFalseValue</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// special cases with children override
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO 指令处理
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;textarea&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;value&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO 特殊情况：value on &lt;textarea&gt;
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasDynamicVBind</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;key&#34;</span> <span class="o">||</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;ref&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// static prop
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;class&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">staticClassBinding</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">openTag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
        <span class="sb">` </span><span class="si">${</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span> <span class="o">+</span>
          <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="sb">`=&#34;</span><span class="si">${</span><span class="nx">escapeHtml</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span><span class="si">}</span><span class="sb">&#34;`</span> <span class="o">:</span> <span class="sb">``</span><span class="p">)</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
class 处理部分：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// static prop
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;class&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">staticClassBinding</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">openTag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
  <span class="sb">` </span><span class="si">${</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span> <span class="o">+</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="sb">`=&#34;</span><span class="si">${</span><span class="nx">escapeHtml</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span><span class="si">}</span><span class="sb">&#34;`</span> <span class="o">:</span> <span class="sb">``</span><span class="p">)</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
等于是将 <code>class=&#34;bar&#34;</code> 原样添加到 openTag 中了，只不过这里对值用 <code>escapeHtml</code> 处
理了一下。</p>
<p>
匹配： <code>const escapeRE = /[&#34;&#39;&amp;&lt;&gt;]/</code> 替换成对应的</p>
<table>
<thead>
<tr>
<th>char</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&#34;</code></td>
<td><code>&amp;quot;</code></td>
</tr>
<tr>
<td><code>&amp;</code></td>
<td><code>&amp;amp;</code></td>
</tr>
<tr>
<td><code>&#39;</code></td>
<td><code>&amp;#39;</code></td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td><code>&amp;lt;</code></td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td><code>&amp;gt;</code></td>
</tr>
</tbody>
</table>
<p>
如下测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; static class\n&#34;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&#34;bar&#34;&gt;&lt;/div&gt;&lt;p class=&#34;foo&gt;&#34;&gt;&lt;/p&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; ref/key 属性会被忽略，不论静态还是动态\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div key=&#34;1&#34; ref=&#34;el&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; ref/key 属性会被忽略，不论静态还是动态\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div :key=&#34;1&#34; :ref=&#34;el&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; static class
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;div class=&#34;bar&#34;&gt;&lt;/div&gt;&lt;p class=&#34;foo&amp;gt;&#34;&gt;&lt;/p&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; ref/key 属性会被忽略，不论静态还是动态
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; ref/key 属性会被忽略，不论静态还是动态
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-12" class="outline-3">
<h3 id="headline-12">
c28d528 dynamic class 属性处理
</h3>
<div id="outline-text-headline-12" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c28d528818adbf829b715bfff68c4508add67af3">feat(add): ssr-&gt;dynamic class · gcclll/stb-vue-next@c28d528 · GitHub</a></p>
<p>
当既有 static 也有 dynamic class 时需要进行合并，且是将 static 往 dynamic 上进行
合并，最后成为动态的 class。</p>
<p>
新增处理逻辑：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">attrName</span> <span class="o">===</span> <span class="s2">&#34;class&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">openTag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
    <span class="sb">` class=&#34;`</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">dynamicClassBinding</span> <span class="o">=</span> <span class="nx">createCallExpression</span><span class="p">(</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_RENDER_CLASS</span><span class="p">),</span>
      <span class="p">[</span><span class="nx">value</span><span class="p">]</span>
    <span class="p">)),</span>
    <span class="sb">`&#34;`</span>
  <span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
如果也有静态属性的时候，将两者合并，需要用到两个函数：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">mergeCall</span><span class="p">(</span><span class="nx">call</span>: <span class="kt">CallExpression</span><span class="p">,</span> <span class="nx">arg</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nx">JSChildNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">existing</span> <span class="o">=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">ExpressionNode</span> <span class="o">|</span> <span class="nx">ArrayExpression</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">existing</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_ARRAY_EXPRESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">existing</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">call</span><span class="p">.</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">createArrayExpression</span><span class="p">([</span><span class="nx">existing</span><span class="p">,</span> <span class="nx">arg</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeStaticBinding</span><span class="p">(</span>
  <span class="nx">tag</span>: <span class="kt">TemplateLiteral</span><span class="p">[</span><span class="s2">&#34;elements&#34;</span><span class="p">],</span>
  <span class="nx">binding</span>: <span class="kt">string</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">regExp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="sb">`^ </span><span class="si">${</span><span class="nx">binding</span><span class="si">}</span><span class="sb">=&#34;.+&#34;$`</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">typeof</span> <span class="nx">e</span> <span class="o">===</span> <span class="s2">&#34;string&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">regExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">e</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tag</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>mergeCall</strong>: 将静态 class 合并到动态 class 上
<strong>removeStaticBinding</strong>: 删除原来的静态 class 属性</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; dynamic class\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div :class=&#34;bar&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; static class\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&#34;foo&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; static + dynamic class\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&#34;foo&#34; :class=&#34;bar&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; dynamic class
 const { ssrRenderClass: _ssrRenderClass, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div class=&#34;${
    _ssrRenderClass(_ctx.bar)
  }&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; static class
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;div class=&#34;foo&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; static + dynamic class
 const { ssrRenderClass: _ssrRenderClass, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div class=&#34;${
    _ssrRenderClass([_ctx.bar, &#34;foo&#34;])
  }&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
<p>
逻辑脑图：
<img src="http://qiniu.ii6g.com/img/20210106143239.png" alt="http://qiniu.ii6g.com/img/20210106143239.png" title="http://qiniu.ii6g.com/img/20210106143239.png" /></p>
</div>
</div>
<div id="outline-container-headline-13" class="outline-3">
<h3 id="headline-13">
ca39229 style 属性处理
</h3>
<div id="outline-text-headline-13" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ca392295afd086ef4053a062fa23ad948e305ad4">feat(add): ssr-&gt;style prop · gcclll/stb-vue-next@ca39229 · GitHub</a></p>
<p>
新增处理代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">attrName</span> <span class="o">===</span> <span class="s2">&#34;style&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// :style
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">dynamicStyleBinding</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 已经有 style 合并
</span><span class="c1"></span>    <span class="nx">mergeCall</span><span class="p">(</span><span class="nx">dynamicStyleBinding</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">openTag</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
      <span class="sb">` style=&#34;`</span><span class="p">,</span>
      <span class="p">(</span><span class="nx">dynamicStyleBinding</span> <span class="o">=</span> <span class="nx">createCallExpression</span><span class="p">(</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_RENDER_STYLE</span><span class="p">),</span>
        <span class="p">[</span><span class="nx">value</span><span class="p">]</span>
      <span class="p">)),</span>
      <span class="sb">`&#34;`</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; static style\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div style=&#34;color:red&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; dynamic style\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div :style=&#34;bar&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; dynamic + static style\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div :style=&#34;bar&#34; style=&#34;color:red&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; static style
 const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div style=&#34;${
    _ssrRenderStyle({&#34;color&#34;:&#34;red&#34;})
  }&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; dynamic style
 const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div style=&#34;${
    _ssrRenderStyle(_ctx.bar)
  }&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; dynamic + static style
 const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div style=&#34;${
    _ssrRenderStyle([_ctx.bar, {&#34;color&#34;:&#34;red&#34;}])
  }&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
dfd4fb9 v-html 指令处理
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/dfd4fb986483ec6de94f894ff44562dae044109f">feat(add): ssr-&gt;v-html directive · gcclll/stb-vue-next@dfd4fb9 · GitHub</a></p>
<p>
这个处理在 <code>ssrTransformElement</code> 中只需要增加一行代码就OK，但是需要结合
<code>ssrProcessElement</code> 来进行处理。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;html&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">exp</span> <span class="cm">/* v-html */</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">rawChildrenMap</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">exp</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ssrProcessElement 中会对 rawChildrenMap 进行处理：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">ssrProcessElement</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">PlainElementNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">SSRTransformContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// 已缓存的处理结果
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">rawChildren</span> <span class="o">=</span> <span class="nx">rawChildrenMap</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rawChildren</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">pushStringPart</span><span class="p">(</span><span class="nx">rawChildren</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">processChildren</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; v-html\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div v-html=&#34;foo&#34;/&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
直接进行值替换。</p>
<p>
<img src="http://qiniu.ii6g.com/img/20210106170904.png" alt="http://qiniu.ii6g.com/img/20210106170904.png" title="http://qiniu.ii6g.com/img/20210106170904.png" /></p>
</div>
</div>
<div id="outline-container-headline-15" class="outline-3">
<h3 id="headline-15">
678e98a v-text 指令处理
</h3>
<div id="outline-text-headline-15" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/678e98aff50dec73cd0ab7f6fdfe823c1318bec5">feat(add): ssr-&gt;v-text directive · gcclll/stb-vue-next@678e98a · GitHub</a></p>
<p>
这里是用插值方式来处理了 v-text ：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;text&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">exp</span> <span class="cm">/* v-text */</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">createInterpolation</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">loc</span><span class="p">)];</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div v-text=&#34;foo&#34;/&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div&gt;${
    _ssrInterpolate(_ctx.foo)
  }&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
<p>
<img src="http://qiniu.ii6g.com/img/20210106170929.png" alt="http://qiniu.ii6g.com/img/20210106170929.png" title="http://qiniu.ii6g.com/img/20210106170929.png" /></p>
</div>
</div>
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
0472dfd v-slot 指令错误
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0472dfd1574d6312e11c12336312a2a2bc0cf1d7">feat(add): ssr-&gt;v-slot directive · gcclll/stb-vue-next@0472dfd · GitHub</a></p>
<p>
由于指令不能应用于非 component 或 template 组件上，所以这里无法适用。</p>
</div>
</div>
<div id="outline-container-headline-17" class="outline-3">
<h3 id="headline-17">
45e78e1 v-bind 指令
</h3>
<div id="outline-text-headline-17" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/45e78e1a9de6d5a6c1820e102c5792ff0c1d2e80">feat(add): ssr-&gt;v-bind · gcclll/stb-vue-next@45e78e1 · GitHub</a></p>
<p>
下面的测试为综合情况测试，包含大部分使用情况。</p>
<ol>
<li>
<p>v-bind:arg(non-boolean)</p>
</li>
<li>
<p>v-bind:[arg] 动态参数处理</p>
</li>
<li>
<p>v-bind:[arg] + v-bind 混合方式</p>
</li>
<li>
<p>style + :style</p>
</li>
<li>
<p>class + :class</p>
</li>
<li>
<p>v-on 会被忽略</p>
</li>
<li>
<p>key/ref 无论静态动态都会被忽略</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">(</span>
  <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div
</span><span class="sb">style=&#34;color:red&#34;
</span><span class="sb">:style=&#34;baz&#34;
</span><span class="sb">class=&#34;foo&#34;
</span><span class="sb">:class=&#34;bar&#34;
</span><span class="sb">:[key]=&#34;value&#34;
</span><span class="sb">:id=&#34;id&#34;
</span><span class="sb">v-bind=&#34;obj&#34;
</span><span class="sb">v-on=&#34;fxx&#34;
</span><span class="sb">@click=&#34;fxc&#34;
</span><span class="sb">:key=&#34;1&#34;
</span><span class="sb">:ref=&#34;el&#34;
</span><span class="sb">&gt;&lt;/div&gt;`</span><span class="p">).</span><span class="nx">code</span>
<span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { mergeProps: _mergeProps } = require(&#34;vue&#34;)
const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div${
    _ssrRenderAttrs(_mergeProps({
      style: [{&#34;color&#34;:&#34;red&#34;}, _ctx.baz],
      class: [&#34;foo&#34;, _ctx.bar],
      [_ctx.key || &#34;&#34;]: _ctx.value,
      id: _ctx.id
    }, _ctx.obj, {
      key: 1,
      ref: _ctx.el
    }))
  }&gt;&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
<blockquote>
<p>key, ref 为什么没有忽略？？？</p>
</blockquote>
<p>
<img src="http://qiniu.ii6g.com/img/20210106171132.png" alt="http://qiniu.ii6g.com/img/20210106171132.png" title="http://qiniu.ii6g.com/img/20210106171132.png" /></p>
</div>
</div>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
value on textarea
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<p>
<img src="http://qiniu.ii6g.com/img/20210106170832.png" alt="http://qiniu.ii6g.com/img/20210106170832.png" title="http://qiniu.ii6g.com/img/20210106170832.png" /></p>
<div id="outline-container-headline-19" class="outline-4">
<h4 id="headline-19">
e79e343 static value
</h4>
<div id="outline-text-headline-19" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e79e343bc81f3b4b729bab7f02a4ab51f72e23c5">feat(add): ssr-&gt;static value on textarea · gcclll/stb-vue-next@e79e343 · GitHub</a></p>
<p>
静态 value 处理很简单，直接当做子节点替换。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;textarea&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;value&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 特殊情况：value on &lt;textarea&gt;
</span><span class="c1"></span>  <span class="nx">rawChildrenMap</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">escapeHtml</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">));</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; static value on textarea\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;textarea value=&#34;fo&amp;gt;o&#34;/&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; static value on textarea
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;textarea&gt;fo&amp;gt;o&lt;/textarea&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-20" class="outline-4">
<h4 id="headline-20">
dynamic value
</h4>
<div id="outline-text-headline-20" class="outline-text-4">
<p>
处理代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">isTextareaWithValue</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">exp</span> <span class="cm">/* textarea with value */</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasDynamicVBind</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">createInterpolation</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">loc</span><span class="p">)];</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
当做插值类型处理，作为孩子节点。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">(</span><span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;textarea :value=&#34;foo&#34;/&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;textarea&gt;${
    _ssrInterpolate(_ctx.foo)
  }&lt;/textarea&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-21" class="outline-4">
<h4 id="headline-21">
cdd8fd0 dynamic arg 动态参数
</h4>
<div id="outline-text-headline-21" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cdd8fd0d279ef2ef8d8e7c0051e8e95daec8d1d0">feat(add): ssr-&gt;dynamic arg on textarea · gcclll/stb-vue-next@cdd8fd0 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;textarea&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">existingText</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span>
    <span class="o">|</span> <span class="nx">TextNode</span>
    <span class="o">|</span> <span class="nx">InterpolationNode</span>
    <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="c1">// If interpolation, this is dynamic &lt;textarea&gt; content, potentially
</span><span class="c1"></span>  <span class="c1">// injected by v-model and takes higher priority than v-bind value
</span><span class="c1"></span>  <span class="c1">// v-model 的优先级高于 v-bind value
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existingText</span> <span class="o">||</span> <span class="nx">existingText</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// &lt;textarea&gt; with dynamic v-bind. We don&#39;t know if the final props
</span><span class="c1"></span>    <span class="c1">// will contain .value, so we will have to do something special:
</span><span class="c1"></span>    <span class="c1">// assign the merged props to a temp variable, and check whether
</span><span class="c1"></span>    <span class="c1">// it contains value (if yes, render is as children).
</span><span class="c1"></span>    <span class="c1">// 当 textarea 包含动态参数时，我们并不能确定最后的结果是否包含 .value
</span><span class="c1"></span>    <span class="c1">// 因此我们将不得不做些特殊处理来应对：
</span><span class="c1"></span>    <span class="c1">// 将已合并的 props 保存成一个临时变量，然后检查它是否包含 value 属性(如果
</span><span class="c1"></span>    <span class="c1">// 包含，则将它当做 children 来渲染)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">tempId</span> <span class="o">=</span> <span class="sb">`_temp</span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">temps</span><span class="o">++</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
    <span class="nx">propsExp</span><span class="p">.</span><span class="nx">arguments</span> <span class="o">=</span> <span class="p">[</span>
      <span class="nx">createAssignmentExpression</span><span class="p">(</span><span class="nx">createSimpleExpression</span><span class="p">(</span><span class="nx">tempId</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span> <span class="nx">props</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="nx">rawChildrenMap</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span>
      <span class="nx">node</span><span class="p">,</span>
      <span class="nx">createCallExpression</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_INTERPOLATE</span><span class="p">),</span> <span class="p">[</span>
        <span class="nx">createConditionalExpression</span><span class="p">(</span>
          <span class="nx">createSimpleExpression</span><span class="p">(</span><span class="sb">`&#34;value&#34; in </span><span class="si">${</span><span class="nx">tempId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span>
          <span class="nx">createSimpleExpression</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">tempId</span><span class="si">}</span><span class="sb">.value`</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span>
          <span class="nx">createSimpleExpression</span><span class="p">(</span>
            <span class="nx">existingText</span> <span class="o">?</span> <span class="nx">existingText</span><span class="p">.</span><span class="nx">content</span> <span class="o">:</span> <span class="sb">``</span><span class="p">,</span>
            <span class="kc">true</span>
          <span class="p">),</span>
          <span class="kc">false</span>
        <span class="p">),</span>
      <span class="p">])</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
在包含动态参数的时候，并不能确定最终参数名就是 <code>value</code> 所以需要做些特殊处理。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;textarea v-bind=&#34;obj&#34;&gt;fallback&lt;/textarea&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { mergeProps: _mergeProps } = require(&#34;vue&#34;)
const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  let _temp0

  _push(`&lt;textarea${
    _ssrRenderAttrs(_temp0 = _mergeProps(_ctx.obj, _attrs), &#34;textarea&#34;)
  }&gt;${
    _ssrInterpolate((&#34;value&#34; in _temp0) ? _temp0.value : &#34;fallback&#34;)
  }&lt;/textarea&gt;`)
}
undefined
</pre>
<p>
等于先将所有属性合并起来，在运行时决定是否有 <code>value</code> 属性，如果存在就使用这个值
内容填充 <code>&lt;textarea&gt;</code> 孩子节点，否则直接使用原来的孩子节点内容(如: <code>&#34;fallback&#34;</code>)</p>
<p>
源码处理中有两个前提条件，才会这样处理</p>
<ol>
<li>
<p>没有孩子节点</p>
</li>
<li>
<p>或者孩子节点不是插值类型</p>
</li>
</ol>
<p>即如果有插值类型的孩子节点，是不会进行如上的处理的，看下面的实例：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;textarea v-bind=&#34;obj&#34;&gt;{{ foo }}&lt;/textarea&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { mergeProps: _mergeProps } = require(&#34;vue&#34;)
const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;textarea${
    _ssrRenderAttrs(_mergeProps(_ctx.obj, _attrs), &#34;textarea&#34;)
  }&gt;${
    _ssrInterpolate(_ctx.foo)
  }&lt;/textarea&gt;`)
}
undefined
</pre>
<p>
结果如上 ↑。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
b97d467 input + boolean attr
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b97d4679d19434a2fb29eece3ee3cf1026e08311">feat(add): ssr-&gt;v-bind boolean on input · gcclll/stb-vue-next@b97d467 · GitHub</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; input\n&#34;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s2">&#34;&lt;input&gt;&#34;</span><span class="p">).</span><span class="nx">code</span><span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span>
  <span class="s2">&#34;&gt;&gt;&gt; input with v-bind:arg(boolean)\n&#34;</span><span class="p">,</span>
  <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;input type=&#34;checkbox&#34; :checked=&#34;checked&#34;&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">,</span>
<span class="p">]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; input
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;input&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; input with v-bind:arg(boolean)
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;input type=&#34;checkbox&#34;${
    (_ctx.checked) ? &#34; checked&#34; : &#34;&#34;
  }&gt;&lt;/div&gt;`)
}
undefined
</pre>
<blockquote>
<p>TODO 对于 v-bind + v-model 的结合使用，需要实现 <code>ssrTransformModel</code> 函数，这里暂时不做处理。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-23" class="outline-3">
<h3 id="headline-23">
<span class="todo">TODO</span>
e58d062 dynamic key attr
</h3>
<div id="outline-text-headline-23" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e58d06299add184eed058ca9d1a3c1fe21279d1d">feat(add): ssr-&gt;dynamic key attr · gcclll/stb-vue-next@e58d062 · GitHub</a></p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-24" class="outline-2">
<h2 id="headline-24">
893681b v-model transform
</h2>
<div id="outline-text-headline-24" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/893681b464e811e5c9f039edd147603729fadb15">feat(add): ssr-&gt;v-model, text type · gcclll/stb-vue-next@893681b · GitHub</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; &lt;input&gt; (text types，默认)&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;input v-model=&#34;bar&#34;&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
脑图：</p>
<p>
<img src="http://qiniu.ii6g.com/img/20210106174207.png" alt="http://qiniu.ii6g.com/img/20210106174207.png" title="http://qiniu.ii6g.com/img/20210106174207.png" /></p>
<div id="outline-container-headline-25" class="outline-3">
<h3 id="headline-25">
7502230 input type: radio
</h3>
<div id="outline-text-headline-25" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/75022301780e1c420421a95042bb7a19cf81c77f">feat(add): ssr-&gt;v-model, type radio · gcclll/stb-vue-next@7502230 · GitHub</a></p>
<p>
v-model 根据 model表达式的值和 <code>value</code> 属性的值，判断最终转成 <code>checked</code> 属性
(<code>&lt;input type=&#34;radio&#34; checked&gt;</code>)。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="kr">type</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 静态类型
</span><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span><span class="kr">type</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s2">&#34;radio&#34;</span><span class="o">:</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">createObjectProperty</span><span class="p">(</span>
          <span class="sb">`checked`</span><span class="p">,</span>
          <span class="nx">createCallExpression</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_LOOSE_EQUAL</span><span class="p">),</span> <span class="p">[</span><span class="nx">model</span><span class="p">,</span> <span class="nx">value</span><span class="p">])</span>
        <span class="p">),</span>
      <span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;input type=&#34;radio&#34; value=&#34;foo&#34; v-model=&#34;bar&#34;&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { ssrLooseEqual: _ssrLooseEqual, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;input type=&#34;radio&#34; value=&#34;foo&#34;${
    (_ssrLooseEqual(_ctx.bar, &#34;foo&#34;)) ? &#34; checked&#34; : &#34;&#34;
  }&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-input-checkbox" class="outline-3">
<h3 id="input-checkbox">
input type: checkbox
</h3>
<div id="outline-text-input-checkbox" class="outline-text-3">
<p>
类型为 checkbox 的时候要检查 <code>true-value/false-value</code> 属性。</p>
<div id="outline-container-headline-27" class="outline-4">
<h4 id="headline-27">
880eaf3 with true/false-value
</h4>
<div id="outline-text-headline-27" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/880eaf33ffb767ab11885b536486c45e74b4c744">feat(add): ssr-&gt;v-model, type checkbox with true/false-value · gcclll/stb-vue-next@880eaf3 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">switch</span> <span class="p">(</span><span class="kr">type</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">case</span> <span class="s2">&#34;checkbox&#34;</span><span class="o">:</span>
    <span class="kr">const</span> <span class="nx">trueValueBinding</span> <span class="o">=</span> <span class="nx">findProp</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s2">&#34;true-value&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">trueValueBinding</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">trueValue</span> <span class="o">=</span>
        <span class="nx">trueValueBinding</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ATTRIBUTE</span>
          <span class="o">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">trueValueBinding</span><span class="p">.</span><span class="nx">value</span><span class="o">!</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">trueValueBinding</span><span class="p">.</span><span class="nx">exp</span><span class="o">!</span><span class="p">;</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">createObjectProperty</span><span class="p">(</span>
          <span class="sb">`checked`</span><span class="p">,</span>
          <span class="nx">createCallExpression</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_LOOSE_EQUAL</span><span class="p">),</span> <span class="p">[</span>
            <span class="nx">model</span><span class="p">,</span>
            <span class="nx">trueValue</span><span class="p">,</span>
          <span class="p">])</span>
        <span class="p">),</span>
      <span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
如果存在 <code>true-value/false-value</code> 的时候，检测条件就是这两个值的比较结果，只有这
两个值相等的情况下才会 <code>checked</code> 。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; v-bind true-value/false-value\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;input type=&#34;checkbox&#34; :true-value=&#34;foo&#34; :false-value=&#34;bar&#34; v-model=&#34;baz&#34;&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; static true-value/false-value\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;input type=&#34;checkbox&#34; true-value=&#34;foo&#34; false-value=&#34;bar&#34; v-model=&#34;baz&#34;&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; true-value/false-value 只有其中一个\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;input type=&#34;checkbox&#34; false-value=&#34;bar&#34; v-model=&#34;baz&#34;&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; v-bind true-value/false-value
 const { ssrLooseEqual: _ssrLooseEqual, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;input type=&#34;checkbox&#34;${
    (_ssrLooseEqual(_ctx.baz, _ctx.foo)) ? &#34; checked&#34; : &#34;&#34;
  }&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; static true-value/false-value
 const { ssrLooseEqual: _ssrLooseEqual, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;input type=&#34;checkbox&#34;${
    (_ssrLooseEqual(_ctx.baz, &#34;foo&#34;)) ? &#34; checked&#34; : &#34;&#34;
  }&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; true-value/false-value 只有其中一个
 const { ssrLooseContain: _ssrLooseContain, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;input type=&#34;checkbox&#34;${
    ((Array.isArray(_ctx.baz))
      ? _ssrLooseContain(_ctx.baz, null)
      : _ctx.baz) ? &#34; checked&#34; : &#34;&#34;
  }&gt;&lt;/div&gt;`)
}
undefined
</pre>
<blockquote>
<p>❓ 为什么 <code>false-value</code> 还在？</p>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/e0fc173f2246e50ece2dd847083f26e653ecc980">fix: false.value -&gt; false-value · gcclll/stb-vue-next@e0fc173 · GitHub</a></p>
</blockquote>
<p>
从结果看，貌似 <code>false-value</code> 并没有被用到，用到的只有 <code>true-value</code> 去和
<code>v-model</code> 表达式值进行比较。</p>
</div>
</div>
<div id="outline-container-headline-28" class="outline-4">
<h4 id="headline-28">
59b1577 without true/false-value
</h4>
<div id="outline-text-headline-28" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/59b157792c9cf02ba55a8614b44da2ed72a5c363">feat(add): ssr-&gt;v-model, type checkbox without true/false-value · gcclll/stb-vue-next@59b1577 · GitHub</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="nx">log</span><span class="p">(</span><span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;input type=&#34;checkbox&#34; value=&#34;foo&#34; v-model=&#34;bar&#34;&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { ssrLooseContain: _ssrLooseContain, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;input type=&#34;checkbox&#34; value=&#34;foo&#34;${
    ((Array.isArray(_ctx.bar))
      ? _ssrLooseContain(_ctx.bar, &#34;foo&#34;)
      : _ctx.bar) ? &#34; checked&#34; : &#34;&#34;
  }&gt;&lt;/div&gt;`)
}
undefined
</pre>
<p>
<code>_ssrLooseContain(_ctx.bar, &#34;foo&#34;)</code> 简单的数组找值操作：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">ssrLooseContain</span><span class="p">(</span><span class="nx">arr</span>: <span class="kt">unknown</span><span class="p">[],</span> <span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">looseIndexOf</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
相当于，如果 <code>v-model=&#34;bar&#34;</code> 的值 bar 是个数组，只需要其中有一个满足条件就会
<code>checked</code> ，这也是经常使用到的方式，将一组数据保存到一个数组里面，然后对应一组
<code>checkboxs</code> 用来控制这些组件的选中未选中状态。</p>
<div class="src src-html">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;checkbox&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;1&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;checkedBoxes&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;checkbox&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;2&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;checkedBoxes&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;checkbox&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;3&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;checkedBoxes&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
export default {
  data() {
    return { checkedBoxes: [1, 2, 3] }
  }
}
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
就如上面的例子，只要 <code>checkedBoxes</code> 里面的值发生改变，就会触发 <code>checkbox</code> 状态更
新，且只有在数组内的值与当前 <code>checkbox</code> 的 value 属性值相等就会被选中，反之不会
被选中。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-29" class="outline-3">
<h3 id="headline-29">
a0d4a40 input type: file 时不能用 v-model
</h3>
<div id="outline-text-headline-29" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a0d4a40ab11adb4ff1c1649f8c05b2af501c3525">feat(add): ssr-&gt;v-model, type file with v-model error · gcclll/stb-vue-next@a0d4a40 · GitHub</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">compileSFCScript</span><span class="p">,</span>
  <span class="nx">compileStyle</span><span class="p">,</span>
  <span class="nx">getCompiledSSRString</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span>
  <span class="nx">compileSSR</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;input type=&#34;file&#34; v-model=&#34;foo&#34;&gt;&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
v-model cannot be used on file inputs since they are read-only. Use a v-on:change listener instead.
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-30" class="outline-3">
<h3 id="headline-30">
d7309be v-model on textarea
</h3>
<div id="outline-text-headline-30" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d7309be668636b5619968ddf7d7b2045bf960f96">feat(add): ssr-&gt;v-model on textarea · gcclll/stb-vue-next@d7309be · GitHub</a></p>
<p>
当做插值处理，替换成孩子节点。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;textarea v-model=&#34;foo&#34;&gt;bar&lt;/textarea&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const { ssrRenderAttrs: _ssrRenderAttrs, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;textarea&gt;${
    _ssrInterpolate(_ctx.foo)
  }&lt;/textarea&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-31" class="outline-2">
<h2 id="headline-31">
169027e v-show transform
</h2>
<div id="outline-text-headline-31" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/169027eb3a759cd2bdf12d42430711c0471a1a90">feat(add): ssr-&gt;v-show · gcclll/stb-vue-next@169027e · GitHub</a></p>
<p>
v-show 指令的处理相对简单，根据指令表达式值，创建一个三元条件表达式，利用
<code>display:none</code> 属性隐藏元素(非删除操作)。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">ssrTransformShow</span>: <span class="kt">DirectiveTransform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dir</span><span class="p">.</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span>
      <span class="nx">createDOMCompilerError</span><span class="p">(</span><span class="nx">DOMErrorCodes</span><span class="p">.</span><span class="nx">X_V_SHOW_NO_EXPRESSION</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">createObjectProperty</span><span class="p">(</span>
        <span class="sb">`style`</span><span class="p">,</span>
        <span class="c1">// -&gt; dir.exp ? `null` : `display:none`
</span><span class="c1"></span>        <span class="nx">createConditionalExpression</span><span class="p">(</span>
          <span class="nx">dir</span><span class="p">.</span><span class="nx">exp</span><span class="o">!</span><span class="p">,</span>
          <span class="nx">createSimpleExpression</span><span class="p">(</span><span class="sb">`null`</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span>
          <span class="nx">createObjectExpression</span><span class="p">([</span>
            <span class="nx">createObjectProperty</span><span class="p">(</span>
              <span class="sb">`display`</span><span class="p">,</span>
              <span class="nx">createSimpleExpression</span><span class="p">(</span><span class="sb">`none`</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
            <span class="p">),</span>
          <span class="p">]),</span>
          <span class="kc">false</span> <span class="cm">/* no newline */</span>
        <span class="p">)</span>
      <span class="p">),</span>
    <span class="p">],</span>
  <span class="p">};</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="o">:</span><span class="nx">ssrs</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic 作为根节点\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-show=&#34;foo&#34;/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n&gt;&gt;&gt; basic 非根节点\n&#39;</span><span class="p">,</span> <span class="nx">ssrs</span><span class="p">(</span><span class="sb">`&lt;div v-show=&#34;foo&#34;/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n&gt;&gt;&gt; basic 非根节点，包含静态和动态 style\n&#39;</span><span class="p">,</span> <span class="nx">ssrs</span><span class="p">(</span><span class="sb">`&lt;div v-show=&#34;foo&#34; style=&#34;color:red&#34; :style=&#34;bar&#34;/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic 作为根节点
 const { mergeProps: _mergeProps } = require(&#34;vue&#34;)
const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${_ssrRenderAttrs(_mergeProps({
    style: (_ctx.foo) ? null : { display: &#34;none&#34; }
  }, _attrs))}&gt;&lt;/div&gt;`)
}

&gt;&gt;&gt; basic 非根节点
 const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div style=&#34;${
    _ssrRenderStyle((_ctx.foo) ? null : { display: &#34;none&#34; })
  }&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}

&gt;&gt;&gt; basic 非根节点，包含静态和动态 style
 const { ssrRenderStyle: _ssrRenderStyle, ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;div${
    _ssrRenderAttrs(_attrs)
  }&gt;&lt;div style=&#34;${
    _ssrRenderStyle([
      (_ctx.foo) ? null : { display: &#34;none&#34; },
      {&#34;color&#34;:&#34;red&#34;},
      _ctx.bar
    ])
  }&#34;&gt;&lt;/div&gt;&lt;/div&gt;`)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-32" class="outline-2">
<h2 id="headline-32">
5bf3644 v-if transform
</h2>
<div id="outline-text-headline-32" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/5bf364450c08cc343b308d1a755ead6aca82644c">feat(add): ssr-&gt;v-if · gcclll/stb-vue-next@5bf3644 · GitHub</a></p>
<p>
ssrTransformIf 也是直接使用了 compiler-core: transformIf 进行处理。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/094d5c07717b9593527f4fa442b0e216903cce35">fix: ssr-&gt;template v-if no ] · gcclll/stb-vue-next@094d5c0 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Plugin for the first transform pass, which simply constructs the AST node
</span><span class="c1">// 先经过 core: transformIf 处理一道
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">ssrTransformIf</span> <span class="o">=</span> <span class="nx">createStructuralDirectiveTransform</span><span class="p">(</span>
  <span class="sr">/^(if|else|else-if)$/</span><span class="p">,</span>
  <span class="nx">processIf</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
剩下的 ssr 的部分，需要用到 <code>ssrProcessIf()</code> 进行单独处理。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div v-if=&#34;foo&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>
<span class="nx">log</span><span class="p">([</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 23, line: 1, offset: 22 },
    source: &#39;&lt;div v-if=&#34;foo&#34;&gt;&lt;/div&gt;&#39;
  },
  condition: {
    type: 4,
    content: &#39;_ctx.foo&#39;,
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: &#39;foo&#39; }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: &#39;div&#39;,
      tagType: 0,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined,
      ssrCodegenNode: [Object]
    }
  ],
  userKey: undefined
}
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {

}
undefined
</pre>
<p>
啥也没有？</p>
<p>
但是从 ast.children[0].branches[0] 结果看确实被 core 正确处理了</p>
<p>
所以还是需要实现 <code>ssrProcessIf()</code> 并且在 <code>ssrCodegenTransform-&gt;processChildren</code>
增加 <code>NodeTypes.IF</code> 分支处理。</p>
<p>
加上 <code>ssrProcessIf</code> 再测试一遍(测试均来自官方测试用例 <em>ssrVIf.spec.ts</em> 其他同)：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="s1">&#39;&lt;div v-if=&#34;foo&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n&gt;&gt;&gt; with nested content\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;foo&#34;&gt;hello&lt;span&gt;ok&lt;/span&gt;&lt;/div&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; v-if + v-else\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;foo&#34;/&gt;&lt;span v-else/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; v-if + v-else-if\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;foo&#34;/&gt;&lt;span v-else-if=&#34;bar&#34;/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; v-if + v-else-if + v-else\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;foo&#34;/&gt;&lt;span v-else-if=&#34;bar&#34;/&gt;&lt;span v-else/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; &lt;template v-if&gt;(text)&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;template v-if=&#34;foo&#34;&gt;hello&lt;/template&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; &lt;template v-if&gt;(single element)&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;template v-if=&#34;foo&#34;&gt;&lt;div&gt;hi&lt;/div&gt;&lt;/template&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; &lt;template v-if&gt;(multiple element)&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;template v-if=&#34;foo&#34;&gt;&lt;div&gt;hi&lt;/div&gt;&lt;div&gt;hi&lt;/div&gt;&lt;div&gt;ho&lt;/div&gt;&lt;/template&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="c1">// v-for transform 到此还没实现，所以这个会报错
</span><span class="c1">// log([&#39;&gt;&gt;&gt; &lt;template v-if&gt; (with v-for inside)&#39;, ssr(`&lt;template v-if=&#34;foo&#34;&gt;&lt;div v-for=&#34;i in list&#34;/&gt;&lt;/template&gt;`).code])
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; &lt;template v-if&gt; + normal v-else&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;template v-if=&#34;foo&#34;&gt;&lt;div&gt;hi&lt;/div&gt;&lt;/template&gt;&lt;div v-else/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;/div&gt;`)
  } else {
    _push(`&lt;!----&gt;`)
  }
}

&gt;&gt;&gt; with nested content
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;hello&lt;span&gt;ok&lt;/span&gt;&lt;/div&gt;`)
  } else {
    _push(`&lt;!----&gt;`)
  }
}
&gt;&gt;&gt; v-if + v-else
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;/div&gt;`)
  } else {
    _push(`&lt;span${_ssrRenderAttrs(_attrs)}&gt;&lt;/span&gt;`)
  }
}
&gt;&gt;&gt; v-if + v-else-if
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;/div&gt;`)
  } else if (_ctx.bar) {
    _push(`&lt;span${_ssrRenderAttrs(_attrs)}&gt;&lt;/span&gt;`)
  } else {
    _push(`&lt;!----&gt;`)
  }
}
&gt;&gt;&gt; v-if + v-else-if + v-else
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;/div&gt;`)
  } else if (_ctx.bar) {
    _push(`&lt;span${_ssrRenderAttrs(_attrs)}&gt;&lt;/span&gt;`)
  } else {
    _push(`&lt;span${_ssrRenderAttrs(_attrs)}&gt;&lt;/span&gt;`)
  }
}
&gt;&gt;&gt; &lt;template v-if&gt;(text)
return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;!--[--&gt;hello&lt;!--]--&gt;`)
  } else {
    _push(`&lt;!----&gt;`)
  }
}
&gt;&gt;&gt; &lt;template v-if&gt;(single element) const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;hi&lt;/div&gt;`)
  } else {
    _push(`&lt;!----&gt;`)
  }
}
&gt;&gt;&gt; &lt;template v-if&gt;(multiple element)
return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;!--[--&gt;&lt;div&gt;hi&lt;/div&gt;&lt;div&gt;hi&lt;/div&gt;&lt;div&gt;ho&lt;/div&gt;&lt;!--]--&gt;`)
  } else {
    _push(`&lt;!----&gt;`)
  }
}
&gt;&gt;&gt; &lt;template v-if&gt; + normal v-else const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  if (_ctx.foo) {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;hi&lt;/div&gt;`)
  } else {
    _push(`&lt;div${_ssrRenderAttrs(_attrs)}&gt;&lt;/div&gt;`)
  }
}
undefined
</pre>
<p>
为什么是 <code>if(){}else{}</code> ???</p>
<p>
这个要追溯到 compiler-core: codegen.ts 里面对 ssr 环境下的 <code>if</code> 指令的处理代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">switch</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_IF_STATEMENT</span><span class="o">:</span>
    <span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="nx">genIfStatement</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这个 <code>genIfStatement</code> 就是用来生成 <code>if...else</code> 代码的。</p>
<p>
脑图：
<img src="http://qiniu.ii6g.com/img/20210106224304.png" alt="http://qiniu.ii6g.com/img/20210106224304.png" title="http://qiniu.ii6g.com/img/20210106224304.png" /></p>
<p>
所以 ssr v-if 处理大致流程简单分两步：</p>
<ol>
<li>
<p>core: transformIf 得到 node.branches</p>
</li>
<li>
<p>ssrProcessIf 处理，生成 if -&gt; else if -&gt; else</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-33" class="outline-2">
<h2 id="headline-33">
4839090 v-for transform
</h2>
<div id="outline-text-headline-33" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/48390900ef8b899d5797dd0fdf728087605621ef">fix: ssr-&gt;v-for add transform · gcclll/stb-vue-next@4839090 · GitHub</a></p>
<p>
主要还是借助了 compiler-core: transformFor 处理逻辑，加上 ssrProcessFor 加工处理
了下。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-for=&#34;i in list&#34; /&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; nested content\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-for=&#34;i in list&#34;&gt;foo&lt;span&gt;bar&lt;/span&gt;&lt;/div&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; nested v-for\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-for=&#34;row, i in list&#34;&gt;`</span> <span class="o">+</span>
          <span class="sb">`&lt;div v-for=&#34;j in row&#34;&gt;{{ i }},{{ j }}&lt;/div&gt;`</span> <span class="o">+</span>
          <span class="sb">`&lt;/div&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; template v-for(text)\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;template v-for=&#34;i in list&#34;&gt;{{ i }}&lt;/template&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; template v-for (single element)\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;template v-for=&#34;i in list&#34;&gt;&lt;span&gt;{{ i }}&lt;/span&gt;&lt;/template&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; template v-for (multi element)\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;template v-for=&#34;i in list&#34;&gt;&lt;span&gt;{{ i }}&lt;/span&gt;&lt;span&gt;{{ i + 1 }}&lt;/span&gt;&lt;/template&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; render loop args should not be prefixed\n&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt; render loop 循环回调的参数不应该加前缀\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div v-for=&#34;{ foo }, index in list&#34;&gt;{{ foo + bar + index }}&lt;/div&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic
 const { ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
&gt;&gt;&gt; nested content
 const { ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;div&gt;foo&lt;span&gt;bar&lt;/span&gt;&lt;/div&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
&gt;&gt;&gt; nested v-for
 const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, (row, i) =&gt; {
    _push(`&lt;div&gt;&lt;!--[--&gt;`)
    _ssrRenderList(row, (j) =&gt; {
      _push(`&lt;div&gt;${
        _ssrInterpolate(i)
      },${
        _ssrInterpolate(j)
      }&lt;/div&gt;`)
    })
    _push(`&lt;!--]--&gt;&lt;/div&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
&gt;&gt;&gt; template v-for(text)
 const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;!--[--&gt;${_ssrInterpolate(i)}&lt;!--]--&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
&gt;&gt;&gt; template v-for (single element)
 const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;span&gt;${_ssrInterpolate(i)}&lt;/span&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
&gt;&gt;&gt; template v-for (multi element)
 const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;!--[--&gt;&lt;span&gt;${
      _ssrInterpolate(i)
    }&lt;/span&gt;&lt;span&gt;${
      _ssrInterpolate(i + 1)
    }&lt;/span&gt;&lt;!--]--&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
&gt;&gt;&gt; render loop args should not be prefixed
 &gt; render loop 循环回调的参数不应该加前缀
 const { ssrInterpolate: _ssrInterpolate, ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, ({ foo }, index) =&gt; {
    _push(`&lt;div&gt;${_ssrInterpolate(foo + _ctx.bar + index)}&lt;/div&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
undefined
</pre>
<p>
代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">ssrProcessFor</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">ForNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">SSRTransformContext</span><span class="p">,</span>
  <span class="nx">disableNestedFragments</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 需要 Fragment 的条件
</span><span class="c1"></span>  <span class="c1">// 1. disableNestedFragments = false
</span><span class="c1"></span>  <span class="c1">// 2. 有两个及以上的孩子节点或者第一个孩子节点的类型不是 ELEMENT（可能是用户组件）
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">needFragmentWrapper</span> <span class="o">=</span>
    <span class="o">!</span><span class="nx">disableNestedFragments</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">)</span>

  <span class="c1">// 创建 for (...) 表达式
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">renderLoop</span> <span class="o">=</span> <span class="nx">createFunctionExpression</span><span class="p">(</span>
    <span class="nx">createForLoopParams</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parseResult</span><span class="p">)</span>
  <span class="p">)</span>

  <span class="nx">renderLoop</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">processChildrenAsStatement</span><span class="p">(</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span>
    <span class="nx">context</span><span class="p">,</span>
    <span class="nx">needFragmentWrapper</span>
  <span class="p">)</span>

  <span class="c1">// v-for always renders a fragment unless explicitly disabled
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">disableNestedFragments</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">pushStringPart</span><span class="p">(</span><span class="sb">`&lt;!--[--&gt;`</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// 创建表达式
</span><span class="c1"></span>  <span class="nx">context</span><span class="p">.</span><span class="nx">pushStatement</span><span class="p">(</span>
    <span class="nx">createCallExpression</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SSR_RENDER_LIST</span><span class="p">),</span> <span class="p">[</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span>
      <span class="nx">renderLoop</span>
    <span class="p">])</span>
  <span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">disableNestedFragments</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">pushStringPart</span><span class="p">(</span><span class="sb">`&lt;!--]--&gt;`</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
v-for 处理除了 <code>tranformFor</code> 剩下的处理都在这个 <code>ssrProcessFor</code> 里面了。</p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-2">
<h2 id="headline-34">
8036837 其他不需要处理的情况
</h2>
<div id="outline-text-headline-34" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/80368374101b14f884e7ce56987f82fb99afdf0d">fix: ssr-&gt;add other useless cases in process children · gcclll/stb-vue-next@8036837 · GitHub</a></p>
<p>
比如：</p>
<ol>
<li>
<p><code>IF_BRANCH</code> 在 <code>ssrProcessIf</code> 中被处理了</p>
</li>
<li>
<p><code>TEXT_CALL</code> 和 <code>COMPOUND_EXPRESSION</code> 在 ssr 中不会被用到</p>
</li>
<li>
<p><code>COMMENT</code> 注释简单的还原处理即可</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-35" class="outline-2">
<h2 id="headline-35">
<span class="todo">TODO</span>
16833be component transform
</h2>
<div id="outline-text-headline-35" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/16833be349c6d91f632d7c7dfacce82a174a4a3f">fix: ssr-&gt;component transform · gcclll/stb-vue-next@16833be · GitHub</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20210107171258.png" alt="http://qiniu.ii6g.com/img/20210107171258.png" title="http://qiniu.ii6g.com/img/20210107171258.png" /></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span> <span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;foo id=&#34;a&#34; :prop=&#34;b&#34; /&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; 动态组件 is\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;component is=&#34;foo&#34; prop=&#34;b&#34; /&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; 动态组件 :is\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;component :is=&#34;foo&#34; prop=&#34;b&#34; /&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic
 const { resolveComponent: _resolveComponent, mergeProps: _mergeProps } = require(&#34;vue&#34;)
const { ssrRenderComponent: _ssrRenderComponent } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  const _component_foo = _resolveComponent(&#34;foo&#34;)

  _push(_ssrRenderComponent(_component_foo, _mergeProps({
    id: &#34;a&#34;,
    prop: _ctx.b
  }, _attrs), null, _parent))
}
&gt;&gt;&gt; 动态组件 is
 const { resolveDynamicComponent: _resolveDynamicComponent, mergeProps: _mergeProps, createVNode: _createVNode } = require(&#34;vue&#34;)
const { ssrRenderVNode: _ssrRenderVNode } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderVNode(_push, _createVNode(_resolveDynamicComponent(&#34;foo&#34;), _mergeProps({ prop: &#34;b&#34; }, _attrs), null), _parent)
}
&gt;&gt;&gt; 动态组件 :is
 const { resolveDynamicComponent: _resolveDynamicComponent, mergeProps: _mergeProps, createVNode: _createVNode } = require(&#34;vue&#34;)
const { ssrRenderVNode: _ssrRenderVNode } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderVNode(_push, _createVNode(_resolveDynamicComponent(_ctx.foo), _mergeProps({ prop: &#34;b&#34; }, _attrs), null), _parent)
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-36" class="outline-2">
<h2 id="headline-36">
cdba013 component slot outlet
</h2>
<div id="outline-text-headline-36" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cdba013401c1bfbc9b389699004f402c0187e7f1">feat(add): ssr-&gt;slot outlet transform · gcclll/stb-vue-next@cdba013 · GitHub</a></p>
<p>
<code>&lt;slot&gt;&lt;/slot&gt;</code> 插槽处理。</p>
<p>
处理逻辑：</p>
<ol>
<li>
<p>transform 阶段 -&gt; ssrTransformSlotOutlet</p>
<p>
这里还只是创建了 ssrCodegenNode 并没有实际创建 render 函数</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="mi">_</span><span class="nx">ssrRenderSlot</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">$slots</span><span class="p">,</span> <span class="nx">slotName</span><span class="p">,</span> <span class="nx">slotProps</span><span class="p">,</span> <span class="nx">fallback</span><span class="p">,</span> <span class="mi">_</span><span class="nx">push</span><span class="p">,</span> <span class="mi">_</span><span class="nx">parent</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>codegen 处理 -&gt; ssrCodgenTransform</p>
<p>
这个阶段是扩展 1 中的第四个参数，也就是 fallback，检测 <code>&lt;slot&gt;&lt;/slot&gt;</code> 下是不
是有孩子节点，如果有当做 fallback 处理，替换
<code>node.ssrCodegenNode.arguments[3]</code> 的值。</p>
</li>
</ol>
<p>
<img src="http://qiniu.ii6g.com/img/20210107171820.png" alt="http://qiniu.ii6g.com/img/20210107171820.png" title="http://qiniu.ii6g.com/img/20210107171820.png" /></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;slot/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; with named\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;slot name=&#34;foo&#34;/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; with dynamic named\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;slot :name=&#34;bar.baz&#34;/&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; with props and fallback\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;slot name=&#34;foo&#34; :p1=&#34;1&#34; bar=&#34;2&#34; &gt;some {{ fallback }} content&lt;/slot&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; with fallback\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;slot&gt;some {{ fallback }} content&lt;/slot&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic
 const { ssrRenderSlot: _ssrRenderSlot } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderSlot(_ctx.$slots, &#34;default&#34;, {}, null, _push, _parent)
}
&gt;&gt;&gt; with named
 const { ssrRenderSlot: _ssrRenderSlot } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderSlot(_ctx.$slots, &#34;foo&#34;, {}, null, _push, _parent)
}
&gt;&gt;&gt; with dynamic named
 const { ssrRenderSlot: _ssrRenderSlot } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderSlot(_ctx.$slots, _ctx.bar.baz, {}, null, _push, _parent)
}
&gt;&gt;&gt; with props and fallback
 const { ssrRenderSlot: _ssrRenderSlot, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderSlot(_ctx.$slots, &#34;foo&#34;, {
    p1: 1,
    bar: &#34;2&#34;
  }, () =&gt; {
    _push(`some ${_ssrInterpolate(_ctx.fallback)} content`)
  }, _push, _parent)
}
&gt;&gt;&gt; with fallback
 const { ssrRenderSlot: _ssrRenderSlot, ssrInterpolate: _ssrInterpolate } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderSlot(_ctx.$slots, &#34;default&#34;, {}, () =&gt; {
    _push(`some ${_ssrInterpolate(_ctx.fallback)} content`)
  }, _push, _parent)
}
undefined
</pre>
<p>
ssrRenderSlot 函数实现：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">ssrRenderSlot</span><span class="p">(</span>
  <span class="nx">slots</span>: <span class="kt">Slots</span> <span class="o">|</span> <span class="nx">SSRSlots</span><span class="p">,</span>
  <span class="nx">slotName</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">slotProps</span>: <span class="kt">Props</span><span class="p">,</span>
  <span class="nx">fallbackRenderFn</span><span class="o">:</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">push</span>: <span class="kt">PushFn</span><span class="p">,</span>
  <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// template-compiled slots are always rendered as fragments
</span><span class="c1"></span>  <span class="nx">push</span><span class="p">(</span><span class="sb">`&lt;!--[--&gt;`</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">slotFn</span> <span class="o">=</span> <span class="nx">slots</span><span class="p">[</span><span class="nx">slotName</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">slotFn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">scopeId</span> <span class="o">=</span> <span class="nx">parentComponent</span> <span class="o">&amp;&amp;</span> <span class="nx">parentComponent</span><span class="p">.</span><span class="kr">type</span><span class="p">.</span><span class="nx">__scopeId</span>
    <span class="kr">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">slotFn</span><span class="p">(</span>
      <span class="nx">slotProps</span><span class="p">,</span>
      <span class="nx">push</span><span class="p">,</span>
      <span class="nx">parentComponent</span><span class="p">,</span>
      <span class="nx">scopeId</span> <span class="o">?</span> <span class="sb">` </span><span class="si">${</span><span class="nx">scopeId</span><span class="si">}</span><span class="sb">-s`</span> <span class="o">:</span> <span class="sb">``</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">ret</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// normal slot
</span><span class="c1"></span>      <span class="nx">renderVNodeChildren</span><span class="p">(</span><span class="nx">push</span><span class="p">,</span> <span class="nx">ret</span><span class="p">,</span> <span class="nx">parentComponent</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fallbackRenderFn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fallbackRenderFn</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">push</span><span class="p">(</span><span class="sb">`&lt;!--]--&gt;`</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
fallback 用途：在没有任何 slot template 时候会默认用 fallback 里的内容来渲染这个 slot。</p>
<p>
如：</p>
<div class="src src-html">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">slot</span><span class="p">&gt;</span>some content<span class="p">&lt;/</span><span class="nt">slot</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="c">&lt;!-- 当引用这个组件的组件没有提供任何 slot 模板的时候： 相当于直接使用 fallback 替换插槽--&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>some content<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-37" class="outline-2">
<h2 id="headline-37">
359f856 suspense 内置组件
</h2>
<div id="outline-text-headline-37" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/359f856ffe162420e6023e23f75f0f976ae988f0">feat(add): ssr-&gt;slot suspense component · gcclll/stb-vue-next@359f856 · GitHub</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20210107191831.png" alt="http://qiniu.ii6g.com/img/20210107191831.png" title="http://qiniu.ii6g.com/img/20210107191831.png" /></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; implicit default\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;suspense&gt;&lt;foo/&gt;&lt;/suspense&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; explicit slots\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;suspense&gt;
</span><span class="sb">      &lt;template #default&gt;
</span><span class="sb">        &lt;foo/&gt;
</span><span class="sb">      &lt;/template&gt;
</span><span class="sb">      &lt;template #fallback&gt;
</span><span class="sb">        loading...
</span><span class="sb">      &lt;/template&gt;
</span><span class="sb">    &lt;/suspense&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; implicit default
 const { resolveComponent: _resolveComponent, withCtx: _withCtx } = require(&#34;vue&#34;)
const { ssrRenderComponent: _ssrRenderComponent, ssrRenderSuspense: _ssrRenderSuspense } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  const _component_foo = _resolveComponent(&#34;foo&#34;)

  _ssrRenderSuspense(_push, {
    default: () =&gt; {
      _push(_ssrRenderComponent(_component_foo, null, null, _parent))
    },
    _: 1 /* STABLE */
  })
}
&gt;&gt;&gt; explicit slots
 const { resolveComponent: _resolveComponent, withCtx: _withCtx } = require(&#34;vue&#34;)
const { ssrRenderComponent: _ssrRenderComponent, ssrRenderSuspense: _ssrRenderSuspense } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  const _component_foo = _resolveComponent(&#34;foo&#34;)

  _ssrRenderSuspense(_push, {
    default: () =&gt; {
      _push(_ssrRenderComponent(_component_foo, null, null, _parent))
    },
    fallback: () =&gt; {
      _push(` loading... `)
    },
    _: 1 /* STABLE */
  })
}
undefined
</pre>
<p>
ssrRenderSuspense 实际上只是一个 await 异步函数封装：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">ssrRenderSuspense</span><span class="p">(</span>
  <span class="nx">push</span>: <span class="kt">PushFn</span><span class="p">,</span>
  <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">renderContent</span> <span class="p">}</span><span class="o">:</span> <span class="nx">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="err">(()</span> <span class="err">=</span><span class="p">&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">|</span> <span class="kc">undefined</span><span class="o">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">renderContent</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">renderContent</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`&lt;!----&gt;`</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
最终将 <code>SUSPENSE</code> 中的组件异步渲染。</p>
</div>
</div>
<div id="outline-container-headline-38" class="outline-2">
<h2 id="headline-38">
e27a5e4 teleport 内置组件
</h2>
<div id="outline-text-headline-38" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e27a5e4598354675410acb116667d3e763c63814">feat(add): ssr-&gt;teleport component · gcclll/stb-vue-next@e27a5e4 · GitHub</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20210107195939.png" alt="http://qiniu.ii6g.com/img/20210107195939.png" title="http://qiniu.ii6g.com/img/20210107195939.png" /></p>
<p>
作用❓</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;teleport :to=&#34;target&#34;&gt;&lt;div/&gt;&lt;/teleport&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; disabled prop\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;teleport :to=&#34;target&#34; disabled&gt;&lt;div/&gt;&lt;/teleport&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; disabled prop with value\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;teleport :to=&#34;target&#34; :disabled=&#34;foo&#34;&gt;&lt;div/&gt;&lt;/teleport&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic
 const { ssrRenderTeleport: _ssrRenderTeleport } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderTeleport(_push, (_push) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  }, _ctx.target, false, _parent)
}
&gt;&gt;&gt; disabled prop
 const { ssrRenderTeleport: _ssrRenderTeleport } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderTeleport(_push, (_push) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  }, _ctx.target, true, _parent)
}
&gt;&gt;&gt; disabled prop with value
 const { ssrRenderTeleport: _ssrRenderTeleport } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _ssrRenderTeleport(_push, (_push) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  }, _ctx.target, _ctx.foo, _parent)
}
undefined
</pre>
<p>
ssrRenderTeleport :</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">ssrRenderTeleport</span><span class="p">(</span>
  <span class="nx">parentPush</span>: <span class="kt">PushFn</span><span class="p">,</span>
  <span class="nx">contentRenderFn</span><span class="o">:</span> <span class="p">(</span><span class="nx">push</span>: <span class="kt">PushFn</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
  <span class="nx">target</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">disabled</span>: <span class="kt">boolean</span><span class="p">,</span>
  <span class="nx">parentComponent</span>: <span class="kt">ComponentInternalInstance</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">parentPush</span><span class="p">(</span><span class="s1">&#39;&lt;!--teleport start--&gt;&#39;</span><span class="p">)</span>

  <span class="kd">let</span> <span class="nx">teleportContent</span>: <span class="kt">SSRBufferItem</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">disabled</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">contentRenderFn</span><span class="p">(</span><span class="nx">parentPush</span><span class="p">)</span>
    <span class="nx">teleportContent</span> <span class="o">=</span> <span class="sb">`&lt;!----&gt;`</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">getBuffer</span><span class="p">,</span> <span class="nx">push</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">createBuffer</span><span class="p">()</span>
    <span class="nx">contentRenderFn</span><span class="p">(</span><span class="nx">push</span><span class="p">)</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`&lt;!----&gt;`</span><span class="p">)</span> <span class="c1">// teleport end anchor
</span><span class="c1"></span>    <span class="nx">teleportContent</span> <span class="o">=</span> <span class="nx">getBuffer</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">parentComponent</span><span class="p">.</span><span class="nx">appContext</span><span class="p">.</span><span class="nx">provides</span><span class="p">[</span>
    <span class="nx">ssrContextKey</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="p">]</span> <span class="kr">as</span> <span class="nx">SSRContext</span>
  <span class="kr">const</span> <span class="nx">teleportBuffers</span> <span class="o">=</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">__teleportBuffers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">__teleportBuffers</span> <span class="o">=</span> <span class="p">{})</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">teleportBuffers</span><span class="p">[</span><span class="nx">target</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">teleportBuffers</span><span class="p">[</span><span class="nx">target</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">teleportContent</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">teleportBuffers</span><span class="p">[</span><span class="nx">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">teleportContent</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">parentPush</span><span class="p">(</span><span class="s1">&#39;&lt;!--teleport end--&gt;&#39;</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-39" class="outline-2">
<h2 id="headline-39">
e0fc173 transition group transform
</h2>
<div id="outline-text-headline-39" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e0fc173f2246e50ece2dd847083f26e653ecc980">fix: false.value -&gt; false-value · gcclll/stb-vue-next@e0fc173 · GitHub</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;transition-group&gt;&lt;div v-for=&#34;i in list&#34;/&gt;&lt;/transition-group&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; with static tag\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;transition-group tag=&#34;ul&#34;&gt;&lt;div v-for=&#34;i in list&#34;/&gt;&lt;/transition-group&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; with dynamic tag\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;transition-group :tag=&#34;someTag&#34;&gt;&lt;div v-for=&#34;i in list&#34;/&gt;&lt;/transition-group&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; with multi fragments children\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;transition-group&gt;
</span><span class="sb">              &lt;div v-for=&#34;i in 10&#34;/&gt;
</span><span class="sb">              &lt;div v-for=&#34;i in 10&#34;/&gt;
</span><span class="sb">              &lt;template v-if=&#34;ok&#34;&gt;&lt;div&gt;ok&lt;/div&gt;&lt;/template&gt;
</span><span class="sb">            &lt;/transition-group&gt;`</span><span class="p">).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic
 const { ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  })
  _push(`&lt;!--]--&gt;`)
}
&gt;&gt;&gt; with static tag
 const { ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;ul&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  })
  _push(`&lt;/ul&gt;`)
}
&gt;&gt;&gt; with dynamic tag
 const { ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;${_ctx.someTag}&gt;`)
  _ssrRenderList(_ctx.list, (i) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  })
  _push(`&lt;/${_ctx.someTag}&gt;`)
}
&gt;&gt;&gt; with multi fragments children
 const { ssrRenderList: _ssrRenderList } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  _push(`&lt;!--[--&gt;`)
  _ssrRenderList(10, (i) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  })
  _ssrRenderList(10, (i) =&gt; {
    _push(`&lt;div&gt;&lt;/div&gt;`)
  })
  if (_ctx.ok) {
    _push(`&lt;div&gt;ok&lt;/div&gt;`)
  } else {
    _push(`&lt;!----&gt;`)
  }
  _push(`&lt;!--]--&gt;`)
}
undefined
</pre>
<p>
ssrRenderList:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">ssrRenderList</span><span class="p">(</span>
  <span class="nx">source</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">renderItem</span><span class="o">:</span> <span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">key</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">number</span><span class="p">,</span> <span class="nx">index?</span>: <span class="kt">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">renderItem</span><span class="p">(</span><span class="nx">source</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">source</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Number</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="sb">`The v-for range expect an integer value but got </span><span class="si">${</span><span class="nx">source</span><span class="si">}</span><span class="sb">.`</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">source</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">renderItem</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">])</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">source</span> <span class="kr">as</span> <span class="nx">Iterable</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">renderItem</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="nx">renderItem</span><span class="p">(</span><span class="nx">source</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<ol>
<li>
<p>也就是将 children 直接调用 renderItem 渲染出来，那这个跟动画有什么关系呢❓</p>
</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-headline-40" class="outline-2">
<h2 id="headline-40">
c8e1d56 ssrCssVars inject
</h2>
<div id="outline-text-headline-40" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c8e1d56db5c264e32d69af1dba40306af34b6c98">feat(add): ssr-&gt;ssrCssVars inject · gcclll/stb-vue-next@c8e1d56 · GitHub</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compileSFCScript</span><span class="p">,</span> <span class="nx">compileStyle</span><span class="p">,</span> <span class="nx">getCompiledSSRString</span><span class="p">,</span> <span class="nx">compileSSR</span><span class="o">:</span><span class="nx">ssr</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; basic\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div/&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ssrCssVars</span><span class="o">:</span> <span class="sb">`{ color }`</span> <span class="p">}).</span><span class="nx">code</span><span class="p">])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; fragment\n&#39;</span><span class="p">,</span> <span class="nx">ssr</span><span class="p">(</span><span class="sb">`&lt;div/&gt;&lt;div/&gt;&lt;div&gt;&lt;p/&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ssrCssVars</span><span class="o">:</span> <span class="sb">`{ color }`</span> <span class="p">}).</span><span class="nx">code</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic
 const { mergeProps: _mergeProps } = require(&#34;vue&#34;)
const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  const _cssVars = { style: { color: _ctx.color }}
  _push(`&lt;div${_ssrRenderAttrs(_mergeProps(_attrs, _cssVars))}&gt;&lt;/div&gt;`)
}
&gt;&gt;&gt; fragment
 const { ssrRenderAttrs: _ssrRenderAttrs } = require(&#34;@vue/server-renderer&#34;)

return function ssrRender(_ctx, _push, _parent, _attrs) {
  const _cssVars = { style: { color: _ctx.color }}
  _push(`&lt;!--[--&gt;&lt;div${
    _ssrRenderAttrs(_cssVars)
  }&gt;&lt;/div&gt;&lt;div${
    _ssrRenderAttrs(_cssVars)
  }&gt;&lt;/div&gt;&lt;div${
    _ssrRenderAttrs(_cssVars)
  }&gt;&lt;p&gt;&lt;/p&gt;&lt;/div&gt;&lt;!--]--&gt;`)
}
undefined
</pre>
<p>
cssVars 属性会注入到每个外层同级元素上。</p>
</div>
</div>
<div id="outline-container-headline-41" class="outline-2">
<h2 id="headline-41">
总结
</h2>
<div id="outline-text-headline-41" class="outline-text-2">
<ol>
<li>
<p>ELEMENT 解析</p>
<ul>
<li>
<p>v-html: <code>&lt;div v-html=&#34;foo&#34;/&gt;</code> =&gt; <code>&lt;div&gt;${foo}&lt;/div&gt;</code></p>
</li>
<li>
<p>v-text: <code>&lt;div v-text=&#34;foo&#34;/&gt;</code> =&gt; <code>&lt;div&gt;${_ssrInterpolate(_ctx.foo)}&lt;/div&gt;</code></p>
</li>
<li>
<p>v-slot: 只能用在 <code>&lt;template&gt;</code> 和 <code>&lt;component&gt;</code> 或用户组件上</p>
</li>
<li>
<p>v-on: ssr 中不处理</p>
</li>
<li>
<p>v-bind: 忽略 ref和key 属性，class 合并成动态 class 属性(style 也一样)</p>
<p>
<code>&lt;div class=&#34;foo&#34; :class=&#34;bar&#34;/&gt;</code> <code class="verbatim">&gt; ~&lt;div
class</code>&#34;${_ssrRenderCalss([_ctx.bar, &#39;foo&#39;])}&#34;&gt;&lt;/div&gt;~</p>
</li>
</ul>
</li>
<li>
<p>input: radio</p>
<p>
 <code>&lt;input type=&#34;radio&#34; value=&#34;foo&#34; v-model=&#34;bar&#34;&gt;</code></p>
<p>
 =&gt;</p>
<div class="src src-html">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;radio&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;${(_ssrLooseEqual(_ctx.bar, &#39;foo&#39;)) ? &#39;checked&#39; : &#39;&#39;}&#34;</span><span class="p">&gt;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>input: checkbox, <a href="#input-checkbox">详情-&gt;</a></p>
<p>
有关属性： value, true-value, false-value, v-model</p>
<p>
如果使用 true/false-value 配套，则只支持 v-model 绑定单个属性值。</p>
<p>
如果单独使用 value ，则 v-model 支持绑定一个数组，只要当前 checkbox 的 value
值在该数组里面，则为 checked 状态，否则非选中状态。</p>
</li>
<li>
<p>input: file 不支持，如果没有 type 属性，默认为 <code>text</code></p>
</li>
<li>
<p>ssrInjectFallthroughAttrs ，将 ssrRender 函数的 _attrs 参数作为属性注入到最外
层的元素上。</p>
</li>
<li>
<p>INTEROLATION: 插值调用 <code>_ssrInterpolate(_ctx.foo)</code> 处理</p>
</li>
<li>
<p>v-show 指令处理，就是在元素上增加一个 <code>style = { display: &#39;none&#39; }</code> 来切换元
素显示隐藏</p>
</li>
<li>
<p>v-if 先调用 compiler-core 的 transformIf 解析出 node.branches，然后使用 ssr
端的 processIf 处理成 <code>if (condition) {} else if () {} else {}</code> 语句，而不是
非 ssr 情况下的三元表达式(<code>?:</code>)</p>
</li>
<li>
<p>v-for 指令使用 <code>_ssrRenderList(_ctx.list, (row, i) =&gt; {...})</code></p>
</li>
<li>
<p><code>&lt;slot/&gt;</code> 标签的处理</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// `&lt;slot name=&#34;foo&#34; :p1=&#34;1&#34; bar=&#34;2&#34; &gt;some {{ fallback }} content&lt;/slot&gt;
</span><span class="c1"></span><span class="mi">_</span><span class="nx">ssrRenderSlot</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">$slots</span><span class="p">,</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="p">{</span>
<span class="nx">p1</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="nx">bar</span><span class="o">:</span> <span class="s2">&#34;2&#34;</span>
<span class="p">},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
<span class="mi">_</span><span class="nx">push</span><span class="p">(</span><span class="sb">`some </span><span class="si">${</span><span class="mi">_</span><span class="nx">ssrInterpolate</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fallback</span><span class="p">)</span><span class="si">}</span><span class="sb"> content`</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">_</span><span class="nx">push</span><span class="p">,</span> <span class="mi">_</span><span class="nx">parent</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>&lt;Suspense/&gt;</code> 内置组件，内部处理其实等于将 children 用一个 <code>await</code> 函数包裹
起来了，成为异步操作。</p>
</li>
<li>
<p><code>&lt;Teleport/&gt;</code> 内置组件，需要制定 <code>to=&#34;target&#34;</code></p>
<p>
支持 <code>disabled</code> 属性</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// &lt;teleport :to=&#34;target&#34; :disabled=&#34;foo&#34;&gt;&lt;div/&gt;&lt;/teleport&gt;
</span><span class="c1"></span><span class="mi">_</span><span class="nx">ssrRenderTeleport</span><span class="p">(</span><span class="mi">_</span><span class="nx">push</span><span class="p">,</span> <span class="p">(</span><span class="mi">_</span><span class="nx">push</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="mi">_</span><span class="nx">push</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">_</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="mi">_</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="mi">_</span><span class="nx">parent</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>ssr css vars 简单在元素上注入 <code>style = { color }</code> 属性</p>
</li>
</ol>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-01-04
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/compiler-ssr/">compiler-ssr</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-runtime-core-1/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 源码头脑风暴之 7 ☞ runtime-core(1)</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-compiler-sfc/">
            <span class="next-text nav-default">Vue3 源码头脑风暴之 5 ☞ compiler-sfc</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
