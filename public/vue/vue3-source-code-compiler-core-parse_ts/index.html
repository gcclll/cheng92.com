<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts - è‹¥å¶çŸ¥ç§‹</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="window.g_need_fold = 1 è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚ æ–‡å­—æ¯”" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.76.5 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.82a3cd5d48f8908f385c7cb4088edc324ee1dcab1ade8b3f6f6c51097e700594.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts" />
<meta property="og:description" content="window.g_need_fold = 1 è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚ æ–‡å­—æ¯”" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/" />
<meta property="article:published_time" content="2020-08-31T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-08-31T00:00:00+00:00" />
<meta itemprop="name" content="Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts">
<meta itemprop="description" content="window.g_need_fold = 1 è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚ æ–‡å­—æ¯”">
<meta itemprop="datePublished" content="2020-08-31T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-08-31T00:00:00+00:00" />
<meta itemprop="wordCount" content="25626">



<meta itemprop="keywords" content="vue,,vue3,,vuenext,,compiler," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts"/>
<meta name="twitter:description" content="window.g_need_fold = 1 è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚ æ–‡å­—æ¯”"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 1: parse.ts</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-08-31 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 25626 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 52 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">å°ç»“</a>
</li>
<li><a href="#parse.spec.ts">parse.spec.ts</a>
<ul>
<li><a href="#test-parse-errors">ErrorCodes å„ç§é”™è¯¯æƒ…å†µç”¨ä¾‹</a>
<ul>
<li><a href="#test-parse-errors-comment">æ³¨é‡Šåä¾‹(åµŒå¥—æ³¨é‡Š)ï¼š</a>
</li>
</ul>
</li>
<li><a href="#headline-5">å…¶ä»–ç”¨ä¾‹</a>
<ul>
<li><a href="#parse-test-other-02">02-valid/invalid html</a>
</li>
<li><a href="#parse-test-other-01">01-self closing single/multiple tag</a>
</li>
</ul>
</li>
<li><a href="#headline-8">Element å…ƒç´ æ ‡ç­¾è§£æ</a>
<ul>
<li><a href="#test-element-13">13-ç»“æŸæ ‡ç­¾å¿½ç•¥å¤§å°å†™</a>
</li>
<li><a href="#test-element-12">12-v-pre ç”¨ä¾‹æµ‹è¯•</a>
</li>
<li><a href="#headline-11">11-<code>&lt;div&gt; id=a/&gt;&lt;/div&gt;</code> å±æ€§å€¼ä¸­æ²¡æœ‰å¼•å·æ—¶</a>
</li>
<li><a href="#test-element-10">10-<code>&lt;div&gt; id=&#34;&gt;\&#39;&#34;&gt;&lt;/div&gt;</code> å±æ€§å€¼ä¸­æœ‰å¼•å·æ—¶</a>
</li>
<li><a href="#test-element-09">09-<code>&lt;div id=&#34;&#34;&gt;&lt;/div&gt;</code> å±æ€§å€¼ä¸ºç©ºçš„æƒ…å†µ</a>
</li>
<li><a href="#test-element-08">08-<code>&lt;div id&gt;&lt;/div&gt;</code> æ— å±æ€§å€¼çš„å±æ€§</a>
</li>
<li><a href="#test-element-07">07-isCustomElement è‡ªå®šä¹‰å…ƒç´ </a>
</li>
<li><a href="#test-element-06">06-isNativeTag åŸç”Ÿæ ‡ç­¾ç±»å‹</a>
</li>
<li><a href="#test-element-05">05-template element with directives</a>
</li>
<li><a href="#test-element-04">04-void element</a>
</li>
<li><a href="#test-element-03">03-self closing</a>
</li>
<li><a href="#test-element-02">02-empty div</a>
</li>
<li><a href="#test-element-01">01-simple div</a>
</li>
</ul>
</li>
<li><a href="#test-parse-comment">Comment æ³¨é‡Šè§£æ</a>
</li>
<li><a href="#headline-23">Interpolation æ’å€¼è§£æ</a>
<ul>
<li><a href="#test-interpolation-05">05-custom delimiters</a>
</li>
<li><a href="#test-interpolation-04">04-it can have tag-like notation (3)</a>
</li>
<li><a href="#test-interpolation-03">03-it can have tag-like notation(2)</a>
</li>
<li><a href="#test-interpolation-02">02-it can have tag-like notation(1)</a>
</li>
<li><a href="#test-interpolation-01">01- simple interpolation</a>
</li>
</ul>
</li>
<li><a href="#headline-29">Text æ–‡æœ¬è§£æ</a>
<ul>
<li><a href="#test-text-06">07-only &#34;{{&#34; don\&#39;t separate nodes</a>
</li>
<li><a href="#test-text-05">06-only &#34;&lt;&#34; don\&#39;t separate nodes</a>
</li>
<li><a href="#test-text-05">05-text with mix of tags and interpolations</a>
</li>
<li><a href="#test-text-04">04-text with interpolation which has `&lt;`</a>
</li>
<li><a href="#test-text-03">03-text with interpolation</a>
</li>
<li><a href="#test-text-02">02-simple text\&lt;div&gt;</a>
</li>
<li><a href="#test-text-01">01-simple text</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#parse-funcs">å‡½æ•°åˆ—è¡¨</a>
<ul>
<li><a href="#parse-baseparse">baseParse(context, options)</a>
</li>
<li><a href="#parse-createparsecontext">createParseContext(context, options)</a>
</li>
<li><a href="#parse-parsechildren">parseChildren(context, mode, ancestors)</a>
<ul>
<li><a href="#headline-41">é˜¶æ®µä¸€(test01 some text)</a>
</li>
<li><a href="#headline-42">é˜¶æ®µäºŒ(&lt;div â€¦&gt;&lt;/div&gt;\n&lt;div â€¦&gt;&lt;/div&gt;)</a>
</li>
</ul>
</li>
<li><a href="#parse-parsecomment">parseComment(context)</a>
</li>
<li><a href="#parse-parseelement">parseElement(context, mode)</a>
<ul>
<li><a href="#headline-45">é˜¶æ®µä¸€(test-05)</a>
</li>
</ul>
</li>
<li><a href="#parse-parseinterpolation">parseInterpolation(context, mode)</a>
</li>
<li><a href="#parse-parsetag">parseTag(context, type, parent)</a>
<ul>
<li><a href="#parse-parsetag-01">é˜¶æ®µä¸€(simple text&lt;\/div&gt;)</a>
</li>
<li><a href="#parse-parsetag-02">é˜¶æ®µäºŒ(test-text-05)</a>
</li>
<li><a href="#parse-parsetag-03">é˜¶æ®µä¸‰(test-element-03)</a>
</li>
<li><a href="#parse-parsetag-04">é˜¶æ®µå››(æ”¯æŒ template + v-if)</a>
</li>
<li><a href="#headline-52">é˜¶æ®µäº”(&lt;div â€¦&gt;&lt;/div&gt;\n&lt;div â€¦&gt;&lt;/div&gt;)</a>
</li>
</ul>
</li>
<li><a href="#parse-parsetext">parseText(context, mode)</a>
</li>
<li><a href="#parse-parsetextdata">parseTextData(context, length, mode)</a>
</li>
<li><a href="#parse-parseattributes">parseAttributes(context, type)</a>
</li>
<li><a href="#parse-parseattribute">parseAttribute(context, nameSet)</a>
</li>
<li><a href="#parse-parseattributevalue">parseAttributeValue(context)</a>
</li>
<li><a href="#headline-58">parseCDATA(context, ancestors)</a>
</li>
<li><a href="#headline-59">parseBogusComment(context)</a>
</li>
<li><a href="#parse-pushnode">pushNode(nodes, node)</a>
</li>
<li><a href="#parse-isend">isEnd(context, mode, ancestors)</a>
</li>
<li><a href="#parse-getCursor">getCursor(context)</a>
</li>
<li><a href="#parse-getselection">getSelection(context, start, end?: Postion)</a>
</li>
</ul>
</li>
<li><a href="#headline-64">é‡è¦ç±»å‹å£°æ˜</a>
<ul>
<li><a href="#headline-65">defaultParserOptions</a>
</li>
<li><a href="#td-vars-textmodes">TextModes</a>
</li>
<li><a href="#td-parser-options">ParserOptions</a>
</li>
<li><a href="#td-parser-context">ParserContext</a>
</li>
</ul>
</li>
<li><a href="#headline-69">utils.ts</a>
<ul>
<li><a href="#util-advancepositionwithmutation">advancePositionWithMutation(pos,source, numberOfCharacters)</a>
</li>
</ul>
</li>
<li><a href="#stage_code">é˜¶æ®µä»£ç è®°å½•</a>
</li>
<li><a href="#issues">é—®é¢˜/ç–‘é—®åˆ—è¡¨</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<script>
window.g_need_fold = 1
</script>
<blockquote>
<p>è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚</p>
</blockquote>
<p>
<kbd>æ–‡å­—æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³çœ‹æ–‡å­—å¯ç›´æ¥è½¬åˆ°<a href="/vue/vue-mind-map-house/">è¿™é‡Œ</a>çœ‹è„‘å›¾</kbd></p>
<font color="#fc02ff">å¯èƒ½æ„Ÿå…´è¶£åˆ—è¡¨ï¼š</font>
<ol>
<li>
<p><a href="#issues">æºç ç›¸å…³çš„ç–‘é—®/é—®é¢˜åˆ—è¡¨åŠå…¶è§£ç­”</a> ğŸ›³ ğŸ›³ ğŸ›³ ğŸ›³ ğŸ›³</p>
</li>
<li>
<p><a href="#stage_code">é˜¶æ®µæ€§çš„ä»£ç å¤‡ä»½(æ¯”å¦‚èƒ½ pass æŸä¸ªç”¨ä¾‹)</a> ğŸš˜ ğŸš˜ ğŸš˜ ğŸš˜ ğŸš˜</p>
</li>
<li>
<p><a href="/vue/vue-mind-map-house/">æ‰€æœ‰è„‘å›¾åˆ—è¡¨åŠç®€è¦è§£æ</a></p>
</li>
</ol>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
å°ç»“
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
å°ç»“ä¹‹æ‰€ä»¥æ”¾åœ¨æœ€å‰é¢ï¼Œä¸»è¦åŸå› æœ‰äºŒï¼š</p>
<ol>
<li>
<p>æ–‡ç« éƒ½æ˜¯æ ¹æ®æµ‹è¯•ç”¨ä¾‹é€æ­¥ç”±å°‘åˆ°å¤šï¼Œç®€åˆ°å…¨çš„è¿›åº¦å»å®ç°å’Œæµ‹è¯•çš„ã€‚</p>
</li>
<li>
<p>æ–‡å­—å†…å®¹å¤ªå¤šï¼Œå°ç»“æ”¾å‰é¢èƒ½æå‰å¤§æ¦‚æœ‰ä¸ªå…¨å±€è§‚ï¼Œå…¨å±€çš„æ¦‚å¿µã€‚</p>
</li>
</ol>
<p>ä¸Šå›¾ï¼šå‡ ä¸ªé‡è¦å‡½æ•°å’Œå‡ ä¸ªç®€å•çš„ç”¨ä¾‹</p>
<p>
<img src="/img/vue3/compiler-core/parse_ts-brief-summary.png" alt="/img/vue3/compiler-core/parse_ts-brief-summary.png" title="/img/vue3/compiler-core/parse_ts-brief-summary.png" /></p>
<p>
æ¯ä¸ªå‡½æ•°çš„é‡è¦å®ç°è§£è¯´ï¼š</p>
<ol>
<li>
<p><a href="#parse-parsechildren">parseChildren</a> æ‰€æœ‰æ¨¡æ¿è§£æçš„å…¥å£ï¼Œé‡ç‚¹æ˜¯ while å¾ªç¯æ£€æµ‹è§„åˆ™è¿›å…¥å¯¹åº”çš„ parse*
å‡½æ•°è§£æï¼Œåˆå¹¶ç›¸é‚»æ–‡æœ¬èŠ‚ç‚¹ï¼Œè¿‡æ»¤ç©ºè¡ŒèŠ‚ç‚¹ï¼Œè¿”å› root.childrenã€‚</p>
</li>
<li>
<p><a href="#parse-parsecomment">parseComment</a> è¿™é‡Œçš„æ³¨é‡Šæ˜¯æŒ‡ <code>&lt;!--xx--&gt;</code> html æ³¨é‡Šï¼ŒåŒºåˆ†å‡ ç§éæ³•æƒ…å†µï¼Œå¯é€šè¿‡ç”¨
ä¾‹æ¥ç†Ÿæ‚‰(a. <a href="#test-parse-comment">æ­£å¸¸æ³¨é‡Š</a>ï¼Œb. <a href="#test-parse-errors-comment">éæ³•æ³¨é‡Š</a>)</p>
</li>
<li>
<p><a href="#parse-parseelement">parseElememt</a> è§£ææ ‡ç­¾ï¼Œå¾—åˆ°æ•´ä¸ªæ ‡ç­¾çš„ ast ç»“æ„ï¼ŒåŒ…å«ï¼šæ ‡ç­¾å tagï¼Œå±æ€§åˆ—è¡¨
propsï¼Œå­©å­èŠ‚ç‚¹ childrenï¼Œç­‰ç­‰ã€‚</p>
<ul>
<li>
<p>æ£€æµ‹è‡ªé—­åˆ(<code>&lt;div/&gt;</code>)å’Œç©ºæ ‡ç­¾(<code>&lt;img&gt;</code>)æ£€æµ‹ï¼Œå®ƒä»¬æ²¡æœ‰å­©å­èŠ‚ç‚¹ã€‚</p>
</li>
<li>
<p>å…³é”®çš„ ancestors æ•°ç»„ï¼Œåœ¨é€’å½’è§£æå­©å­èŠ‚ç‚¹çš„æ—¶å€™é€šè¿‡å‡ºå…¥æ ˆæ“ä½œä¿å­˜å½“å‰è§£æçš„
èŠ‚ç‚¹å¯¹è±¡(å¦‚ï¼š<a href="#issues-03">ç–‘é—®3</a>)ã€‚</p>
</li>
</ul>
</li>
<li>
<p><a href="#parse-parsetext">parseText</a> æ–‡æœ¬è§£æï¼Œéæ ‡ç­¾ï¼Œéæ’å€¼ç±»å‹çš„èŠ‚ç‚¹ä¼šè¢«å½“åšæ–‡æœ¬ç±»å‹å»è§£æã€‚æ–‡æœ¬ç»“æŸ
æ ¹æ®æ˜¯ (<code>&lt;, {{, ]]&gt;</code>)ã€‚</p>
</li>
<li>
<p><a href="#parse-parsetextdata">parseTextData</a> è§£ææ–‡æœ¬ï¼Œæ›¿æ¢ html æ ‡è®°(åŒ¹é…ï¼š <code>/&amp;(gt|lt|amp|apos|quot);/g</code>)</p>
</li>
<li>
<p><a href="#parse-parsetag">parseTag</a> è§£æå…ƒç´ æ ‡ç­¾ï¼Œå±æ€§ propsï¼Œv-pre ç­‰æŒ‡ä»¤éƒ½æ˜¯åœ¨è¿™é‡Œé¢å‘èµ·è§£æçš„ï¼Œæ³¨æ„è‡ªé—­
åˆæ ‡ç­¾çš„å¤„ç† isSelfClosing æ ‡å¿—ç»“æŸ parseElement ä¸­è§£æè¿›ç¨‹ã€‚</p>
</li>
<li>
<p><a href="#parse-parseattributes">parseAttributes</a> whle å¾ªç¯è°ƒç”¨ parseAttribute è§£æå±æ€§å­˜åˆ° props ä¸­ã€‚</p>
</li>
<li>
<p><a href="#parse-parseattribute">parseAttribute</a> è§£æå•ä¸ªå±æ€§ï¼Œé›†åˆä¿å­˜å±æ€§åé˜²æ­¢é‡å¤ï¼Œå…ˆè§£æå±æ€§å€¼ï¼Œç„¶åè§£æå±
æ€§åï¼ŒæŒ‡ä»¤ï¼Œä¿®é¥°ç¬¦ï¼Œå‚æ•°ç­‰ã€‚</p>
</li>
<li>
<p><a href="#parse-parseattributevalue">parseAttributeValue</a> è§£æå±æ€§å€¼ï¼ŒåŒºåˆ†æœ‰å¼•å·æˆ–æ²¡å¼•å·(å³å±æ€§å€¼å¯ä»¥æ²¡å¼•å·å“¦ğŸ˜¯)ã€‚</p>
</li>
<li>
<p><a href="#parse-parseinterpolation">parseInterpolation</a> æ’å€¼è§£æï¼Œå– <strong>{{</strong> å’Œ <strong>}}</strong> ä¹‹é—´çš„æ–‡æœ¬ä½œä¸ºè¡¨è¾¾å¼ã€‚</p>
</li>
<li>
<p><a href="#parse-parsecdata">parseCDATA</a> è§£æ xml æ³¨é‡Šï¼Œå½“åšæ–‡æœ¬å¤„ç†</p>
</li>
<li>
<p><a href="#parse-parseboguscomment">parseBogusComment</a> è§£æ &lt;? çš„æ³¨é‡Š</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-parse.spec.ts" class="outline-2">
<h2 id="parse.spec.ts">
parse.spec.ts
</h2>
<div id="outline-text-parse.spec.ts" class="outline-text-2">
<p>
æµ‹è¯•ç”¨ä¾‹ç»“æ„ï¼šcompiler: parse
æˆªæ­¢ï¼š2020-09-02 22:53:14</p>
<p>
<a href="#test-parse-all">æ‰€æœ‰ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼šparse.ts çš„è§£æåŠŸèƒ½å‡ ä¹å…¨éƒ¨å®ç°(å¯èƒ½ä¼šæœ‰é—æ¼)</a></p>
<div id="outline-container-test-parse-errors" class="outline-3">
<h3 id="test-parse-errors">
ErrorCodes å„ç§é”™è¯¯æƒ…å†µç”¨ä¾‹
</h3>
<div id="outline-text-test-parse-errors" class="outline-text-3">
<p>ä¸é€šè¿‡ç”¨ä¾‹ï¼š</p>
<ul>
<li>
<p><code>&lt;textarea&gt;&lt;/div&gt;&lt;/textarea&gt;</code></p>
</li>
<li>
<p><code>&lt;template&gt;&lt;svg&gt;&lt;![CDATA[cdata]]&gt;&lt;/svg&gt;&lt;/template&gt;</code></p>
</li>
</ul>
<p>ç”¨ä¾‹ä»£ç ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">getNamespace</span><span class="o">:</span> <span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// è¿™é‡Œä½œç”¨æ˜¯æ”¹å˜å‘½åç©ºé—´ï¼Œä»è€Œåœ¨ parseChildren while å¾ªç¯é‡Œé¢
</span><span class="c1"></span>      <span class="c1">// èƒ½è¿›å…¥åˆ° parseCDATA è§£æ svg
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">ns</span> <span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ns</span> <span class="o">===</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;svg&#34;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">ns</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">getTextMode</span><span class="o">:</span> <span class="p">({</span> <span class="nx">tag</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// è¿™é‡Œä½œç”¨æ”¹å˜ textarea æ ‡ç­¾çš„ mode = RCDATAï¼Œä»è€Œåœ¨ parseChildren while
</span><span class="c1"></span>      <span class="c1">// é‡Œé¢å°† textarea å†…éƒ¨çš„éƒ½å½“åšæ–‡æœ¬äº¤ç»™ parseText å»è§£æï¼ŒparseText é‡Œé¢ä¼šä»
</span><span class="c1"></span>      <span class="c1">// &lt;/div&gt;&lt;/textarea&gt; ç¬¬äºŒä¸ªå­—ç¬¦å¼€å§‹åŒ¹é… `&lt;` æˆ– `{{` ä»¥ç¤ºç»“æŸæ ‡ç­¾çš„å¼€å§‹ä½ç½®
</span><span class="c1"></span>      <span class="c1">// æœ€åè§£æå‡º `&lt;/div&gt;` è¿™ä¸ªçº¯æ–‡æœ¬ï¼Œå‰©ä¸‹çš„ &lt;/textarea&gt; è¿›å…¥ isEnd
</span><span class="c1"></span>      <span class="c1">// åœ¨å®ç° isEnd é‡Œé¢çš„ case RCDATA åˆ†æ”¯åé¡ºåˆ©æ¨å‡ºå¾ªç¯
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;textarea&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RCDATA</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;script&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RAWTEXT</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="p">...</span><span class="nx">options</span><span class="p">,</span>
    <span class="nx">onError</span><span class="o">:</span> <span class="nx">spy</span><span class="p">,</span>
  <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¤§éƒ¨åˆ†éƒ½èƒ½é€šè¿‡ï¼Œåªæœ‰å°‘éƒ¨åˆ†ä¸èƒ½é€šè¿‡çš„åˆ†ä¸ºå‡ ç§ï¼š</p>
<ol>
<li>
<p>CDATA ç±»å‹å¤„ç†ï¼Œéœ€è¦å®ç° parseBogusComment å’Œ parseCDATA ä¸¤ä¸ªå‡½æ•°</p>
</li>
<li>
<p>RCDATA ç±»å‹å‡ ä¸ªç”¨ä¾‹ä¸èƒ½é€šè¿‡ï¼ŒåŸå› åœ¨äºåœ¨ isEnd å‡½æ•°ä¸­æ²¡æœ‰å®ç°é™¤ DATA ç±»å‹å¤–çš„
æƒ…å†µï¼Œå®ç°ä¹‹åå°±èƒ½æ­£å¸¸æ£€æµ‹ RCDATA çš„ç»“æŸæ ‡ç­¾ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">isEnd</span><span class="p">(</span>
    <span class="nx">context</span> <span class="cm">/*ParserContext*/</span><span class="p">,</span>
    <span class="nx">mode</span> <span class="cm">/*TextModes*/</span><span class="p">,</span>
    <span class="nx">ancestors</span> <span class="cm">/*ElementNode[]*/</span>
  <span class="p">)</span> <span class="cm">/*boolean*/</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>

    <span class="c1">// mode ä¸º TextModes å„ç§æƒ…å†µ
</span><span class="c1"></span>    <span class="c1">// ...çœç•¥
</span><span class="c1"></span>    <span class="k">switch</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;&lt;/&#34;</span><span class="p">))</span> <span class="p">{</span>
          <span class="c1">// æ ‡ç­¾
</span><span class="c1"></span>          <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">ancestors</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// æ–°å¢ - start
</span><span class="c1"></span>      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RCDATA</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RAWTEXT</span><span class="o">:</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="nx">ancestors</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">CDATA</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;]]&gt;&#34;</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
        <span class="c1">// æ–°å¢ - end
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="c1">// æ˜¯ TextModes.TEXT ç›´æ¥è¿”å› source çš„å†…å®¹æ˜¯å¦ä¸ºç©ºäº†
</span><span class="c1"></span>    <span class="k">return</span> <span class="o">!</span><span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<div id="outline-container-test-parse-errors-comment" class="outline-4">
<h4 id="test-parse-errors-comment">
æ³¨é‡Šåä¾‹(åµŒå¥—æ³¨é‡Š)ï¼š
</h4>
<div id="outline-text-test-parse-errors-comment" class="outline-text-4">
<ol>
<li>
<p><code>&lt;template&gt;&lt;!--a&lt;!--b--&gt;&lt;/template&gt;</code></p>
</li>
<li>
<p><code>&lt;template&gt;&lt;!--a&lt;!--b&lt;!--c--&gt;&lt;/template&gt;</code></p>
</li>
<li>
<p><code>&lt;template&gt;&lt;!--a&lt;!--&gt;&lt;/template&gt;</code></p>
</li>
<li>
<p><code>&lt;template&gt;&lt;!--a&lt;!--</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
å…¶ä»–ç”¨ä¾‹
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<div id="outline-container-parse-test-other-02" class="outline-4">
<h4 id="parse-test-other-02">
02-valid/invalid html
</h4>
<div id="outline-text-parse-test-other-02" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;valid html&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span>
      <span class="sb">`&lt;div :class=&#34;{ some: condition }&#34;&gt;</span><span class="err">\</span><span class="sb">n`</span> <span class="o">+</span>
        <span class="sb">`  &lt;p v-bind:style=&#34;{ color: &#39;red&#39; }&#34;/&gt;</span><span class="err">\</span><span class="sb">n`</span> <span class="o">+</span>
        <span class="sb">`  &lt;!-- a comment with &lt;html&gt; inside it --&gt;</span><span class="err">\</span><span class="sb">n`</span> <span class="o">+</span>
        <span class="sb">`&lt;/div&gt;`</span>
    <span class="p">);</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">).</span><span class="nx">toMatchSnapshot</span><span class="p">();</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;p&#34;</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;invalid html&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">baseParse</span><span class="p">(</span><span class="sb">`&lt;div&gt;</span><span class="err">\</span><span class="sb">n&lt;span&gt;</span><span class="err">\</span><span class="sb">n&lt;/div&gt;</span><span class="err">\</span><span class="sb">n&lt;/span&gt;`</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">toThrow</span><span class="p">(</span><span class="s2">&#34;Element is missing end tag.&#34;</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="sb">`&lt;div&gt;</span><span class="err">\</span><span class="sb">n&lt;span&gt;</span><span class="err">\</span><span class="sb">n&lt;/div&gt;</span><span class="err">\</span><span class="sb">n&lt;/span&gt;`</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="o">:</span> <span class="nx">spy</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">spy</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">([</span>
      <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">code</span><span class="o">:</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_MISSING_END_TAG</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">offset</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
              <span class="nx">line</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
          <span class="p">},</span>
        <span class="p">},</span>
      <span class="p">],</span>
      <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">code</span><span class="o">:</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_INVALID_END_TAG</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">offset</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
              <span class="nx">line</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
              <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
          <span class="p">},</span>
        <span class="p">},</span>
      <span class="p">],</span>
    <span class="p">]);</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">).</span><span class="nx">toMatchSnapshot</span><span class="p">();</span>
  <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œè¦åˆ†æçš„æ˜¯ invalid html, è¿™ä¸ªç”¨ä¾‹æ‹¿å‡ºæ¥è¯´ä¸»è¦åŸå› æ˜¯å®ƒèƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£æ ‡
ç­¾åµŒå¥—æ—¶å€™çš„è§£æè¿‡ç¨‹ã€‚</p>
<p>
<code>&lt;div&gt;\n&lt;span&gt;\n&lt;/div&gt;\n&lt;/span&gt;</code></p>
<p>
å¤§è‡´è§£ææµç¨‹æ˜¯ï¼š parseChildren -&gt; parseElement -&gt; parseTag -&gt; parseChildren -&gt;
parseElement -&gt; parseTag -&gt; æŠ¥é”™</p>
<p>
debugger local æ•°æ®(è§£æå®Œ <strong>&lt;span&gt;</strong> ä¹‹å):</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="err">Local</span>
  <span class="err">ancestors:</span> <span class="err">Array(</span><span class="mi">1</span><span class="err">)</span>
  <span class="mi">0</span><span class="err">:</span> <span class="p">{</span><span class="err">type:</span> <span class="err">1,</span> <span class="err">ns:</span> <span class="err">0,</span> <span class="err">tag:</span> <span class="nt">&#34;div&#34;</span><span class="p">,</span> <span class="err">tagType:</span> <span class="err">0,</span> <span class="err">props:</span> <span class="err">Array(0),</span> <span class="err">â€¦</span><span class="p">}</span>
  <span class="err">length:</span> <span class="mi">1</span>
  <span class="err">children:</span> <span class="p">[]</span>
  <span class="err">context:</span>
  <span class="err">column:</span> <span class="mi">1</span>
  <span class="err">inPref:</span> <span class="kc">false</span>
  <span class="err">inVPref:</span> <span class="kc">false</span>
  <span class="err">line:</span> <span class="mi">3</span>
  <span class="err">offset:</span> <span class="mi">13</span>
  <span class="err">options:</span> <span class="p">{</span><span class="err">delimiters:</span> <span class="err">Array(2),</span> <span class="err">getNamespace:</span> <span class="err">Æ’,</span> <span class="err">getTextMode:</span> <span class="err">Æ’,</span> <span class="err">isVoidTag:</span> <span class="err">Æ’,</span> <span class="err">isPreTag:</span> <span class="err">Æ’,</span> <span class="err">â€¦</span><span class="p">}</span>
  <span class="err">originalSource:</span> <span class="s2">&#34;&lt;div&gt;â†µ&lt;span&gt;â†µ&lt;/div&gt;â†µ&lt;/span&gt;&#34;</span>
  <span class="err">source:</span> <span class="s2">&#34;&lt;/div&gt;â†µ&lt;/span&gt;&#34;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>è§£æå‡º div æ ‡ç­¾ï¼Œæ‰€ä»¥ <code>ancestors.length === 1</code></p>
</li>
<li>
<p>è§£æå‡º span æ ‡ç­¾ï¼Œancestors.length åº”è¯¥æ˜¯ 2ï¼Œä½†æ˜¯ä¸Šé¢æˆ‘ä»¬åªä¿ç•™äº† span è§£æä¹‹
åçš„æ•°æ®ï¼Œæ‰€ä»¥ ancestors.span è¢« <code>pop()</code> æ‰äº†ï¼Œå› ä¸ºå®ƒä¸æ˜¯é‡ç‚¹</p>
</li>
<li>
<p>è§£æå®Œ span ä¹‹åä¼šå»è§£æ \n ï¼Œä½†æ˜¯ä¼šè¢« removedWhitespace é‚£æ®µé€»è¾‘è¿‡æ»¤æ‰(æ»¡è¶³
åœ¨ pre å’Œ next ä¹‹é—´æ¡ä»¶)</p>
</li>
<li>
<p>é‚£ä¹ˆé‡ç‚¹åœ¨è¿™ï¼Œåˆ°è¿™ä¸€æ­¥ä¹Ÿæ˜¯ä¸Šé¢ä»£ç  <code>source = `&lt;/div&gt;\n&lt;/span&gt;`</code> çš„æ—¶å€™</p>
</li>
<li>
<p>æ£€æµ‹åˆ° <strong>&lt;/</strong> å¼€å§‹ç»“æŸæ ‡ç­¾è§£æï¼Œæ³¨æ„çœ‹ <a href="#parse-parseelement">parseElement</a> ä¸­æœ‰è¿™ä¹ˆä¸€æ®µ</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">if</span> <span class="p">(</span><span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç»è¿‡ 4 ä¹‹åçš„ source åˆšå¥½èƒ½æ»¡è¶³è¿™ä¸ª if ï¼Œå› æ­¤æºå¸¦ TagType.End è¿›å…¥ <a href="#parse-parsetag">parseTag</a>ï¼Œ
æ­¤æ—¶æœ‰ä¸ªå˜é‡ <strong>parent</strong> ä¿å­˜äº† <code>pop()</code> ä¹‹å‰çš„é‚£ä¸ª <code>ancestors[1]</code> å³ span é‚£ä¸ªæ ‡ç­¾
ï¼Œä½†æ˜¯è¿™é‡Œçš„ç»“æŸæ ‡ç­¾æ˜¯ <strong>div</strong> æœ€åä¼šåŒ¹é…å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-parse-test-other-01" class="outline-4">
<h4 id="parse-test-other-01">
01-self closing single/multiple tag
</h4>
<div id="outline-text-parse-test-other-01" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="cm">/*
</span><span class="cm">    ä¸ç®¡æ˜¯å•æ ‡ç­¾è¿˜æ˜¯å¤šæ ‡ç­¾ä¹Ÿå¥½ï¼Œè‡ªé—­åˆæ ‡ç­¾çš„å¤„ç†éƒ½ä¸€æ ·ï¼Œåœ¨ parseTag é‡Œé¢è§£æéƒ½éœ€è¦ç»è¿‡è¿™ä¹ˆ
</span><span class="cm">    ä¸€æ®µï¼šadvanceBy(context, isSelfClosing ? 2 : 1);
</span><span class="cm">    ç„¶åç»“åˆ parseElement ä¸­çš„æ£€æµ‹ isSelfClosing ç›´æ¥é€€å‡ºè¿”å›å…ƒç´ èŠ‚ç‚¹ï¼Œå³ä¸éœ€è¦å†ç»§ç»­
</span><span class="cm">    è§£æå­èŠ‚ç‚¹äº†(å®ƒæ²¡æœ‰)
</span><span class="cm">  ,*/</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;self closing single tag&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;div :class=&#34;{ some: condition }&#34; /&gt;&#39;</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span> <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span> <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;self closing multiple tag&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span>
          <span class="sb">`&lt;div :class=&#34;{ some: condition }&#34; /&gt;</span><span class="err">\</span><span class="sb">n`</span> <span class="o">+</span>
              <span class="sb">`&lt;p v-bind:style=&#34;{ color: &#39;red&#39; }&#34;/&gt;`</span>
      <span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">).</span><span class="nx">toMatchSnapshot</span><span class="p">()</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span> <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span> <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span> <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;p&#39;</span> <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
Element å…ƒç´ æ ‡ç­¾è§£æ
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<div id="outline-container-test-element-13" class="outline-4">
<h4 id="test-element-13">
13-ç»“æŸæ ‡ç­¾å¿½ç•¥å¤§å°å†™
</h4>
<div id="outline-text-test-element-13" class="outline-text-4">
<p>
<code>&lt;div&gt;hello&lt;/DIV&gt;after</code></p>
<p>
å› ä¸ºè§£æåˆ°ç»“æŸæ ‡ç­¾çš„æ—¶å€™åŒ¹é…ç»“æŸæ ‡ç­¾åç§°çš„æ—¶å€™ä¼šè°ƒç”¨ <a href="#parse-startswithendtagopen">startsWithEndTagOpen</a> æ£€æµ‹ï¼Œ
ä¸”é‡Œé¢æ˜¯å¿½ç•¥å¤§å°å†™çš„ï¼Œç»Ÿä¸€è½¬æˆå°å†™å»æ¯”è¾ƒã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// åŒ¹é…ï¼š&lt;/tag&gt; æˆ–&lt;/tag æ²¡æœ‰ `&gt;` çš„æƒ…å†µ???
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;&lt;/&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="nx">source</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
        <span class="sr">/[\t\n\f /&gt;]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">source</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&#34;&gt;&#34;</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-12" class="outline-4">
<h4 id="test-element-12">
12-v-pre ç”¨ä¾‹æµ‹è¯•
</h4>
<div id="outline-text-test-element-12" class="outline-text-4">
<p>
<code>`&lt;div v-pre :id=&#34;foo&#34;&gt;&lt;Comp/&gt;{{ bar }}&lt;/div&gt;\n` + `&lt;div :id=&#34;foo&#34;&gt;&lt;Comp/&gt;{{ bar }}&lt;/div&gt;`</code></p>
<p>
ç°é˜¶æ®µä»£ç æš‚æ—¶æ˜¯ä¸æ”¯æŒçš„ <strong>v-pre</strong> çš„ã€‚æ‰€ä»¥è§£æä¹‹åä¼šå‡ºç°ä¸‹é¢çš„ç»“æœï¼š</p>
<p>
<code>root.children[3]</code> æœ‰ä¸‰ä¸ªå­©å­èŠ‚ç‚¹</p>
<ol>
<li>
<p>first: div v-pre(è¿˜æ²¡å®ç°æ‰€ä»¥å½“åšæ™®é€šæ ‡ç­¾å¤„ç†)ï¼Œfirst.children[2] æœ‰ä¸¤ä¸ªå­©å­</p>
<ol>
<li>
<p>component ç±»å‹çš„ <code>&lt;Comp/&gt;</code> å› ä¸ºé¦–å­—æ¯å¤§å†™æ‰€ä»¥å½“åšç»„ä»¶ç±»å‹å¤„ç†</p>
</li>
<li>
<p>bar æ’å€¼èŠ‚ç‚¹</p>
</li>
</ol>
</li>
<li>
<p>second: \n æ–‡æœ¬èŠ‚ç‚¹</p>
</li>
<li>
<p>third: div :idï¼Œthird.children[2] ä¹Ÿæœ‰ä¸¤ä¸ªå­©å­å’Œ first ä¸€æ ·</p>
</li>
</ol>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="err">(</span><span class="mi">3</span><span class="err">)</span>Â <span class="p">[{</span><span class="err">â€¦</span><span class="p">},</span> <span class="p">{</span><span class="err">â€¦</span><span class="p">},</span> <span class="p">{</span><span class="err">â€¦</span><span class="p">}]</span>
  <span class="mi">0</span><span class="err">:</span> <span class="p">{</span><span class="err">type:</span> <span class="err">1,</span> <span class="err">ns:</span> <span class="err">0,</span> <span class="err">tag:</span> <span class="nt">&#34;div&#34;</span><span class="p">,</span> <span class="err">tagType:</span> <span class="err">0,</span> <span class="err">props:</span> <span class="err">Array(1),</span>Â <span class="err">â€¦</span><span class="p">}</span>
  <span class="mi">1</span><span class="err">:</span> <span class="p">{</span><span class="err">type:</span> <span class="err">2,</span> <span class="err">content:</span> <span class="nt">&#34;â†µ&#34;</span><span class="p">,</span> <span class="err">loc:</span> <span class="err">{â€¦</span><span class="p">}</span><span class="err">}</span>
  <span class="mi">2</span><span class="err">:</span> <span class="p">{</span><span class="err">type:</span> <span class="err">1,</span> <span class="err">ns:</span> <span class="err">0,</span> <span class="err">tag:</span> <span class="nt">&#34;div&#34;</span><span class="p">,</span> <span class="err">tagType:</span> <span class="err">0,</span> <span class="err">props:</span> <span class="err">Array(1),</span>Â <span class="err">â€¦</span><span class="p">}</span><span class="err">length:</span> <span class="mi">3</span><span class="err">__proto__:</span> <span class="err">Array(</span><span class="mi">0</span><span class="err">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å®ç°ä¹‹åï¼š</p>
<pre class="example">
0: {type: 1, ns: 0, tag: &#34;div&#34;, tagType: 0, props: Array(1), â€¦}
1: null
2: {type: 1, ns: 0, tag: &#34;div&#34;, tagType: 0, props: Array(1), â€¦}
length: 3
__proto__: Array(0)
</pre>
<p>
è¦é€šè¿‡è¯¥ç”¨ä¾‹éœ€è¦ä¿®æ”¹çš„ç‚¹ï¼š</p>
<ol>
<li>
<p><a href="#parse-parsechildren">parseChildren</a> é‡Œè¦æ·»åŠ åˆ é™¤ç©ºå­—ç¬¦æ¢è¡Œç¬¦æ“ä½œ</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseChildren</span><span class="p">(</span>
    <span class="nx">context</span> <span class="cm">/* ParserContext*/</span><span class="p">,</span>
    <span class="nx">mode</span> <span class="cm">/*TextModes*/</span><span class="p">,</span>
    <span class="nx">ancestors</span> <span class="cm">/*ElementNode[]*/</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="nx">ancestors</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">ns</span> <span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">nodes</span> <span class="cm">/*TemplateChildNode[]*/</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="c1">// ... çœç•¥ while
</span><span class="c1"></span>
    <span class="c1">// æ–°å¢-start
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">removedWhitespace</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="c1">// TODO ç©ºæ ¼ç®¡ç†ï¼Œä¸ºäº†æ›´é«˜æ•ˆçš„è¾“å‡º
</span><span class="c1"></span>    <span class="c1">// `\n&lt;div&gt;...` åˆ é™¤å¼€å¤´çš„ç©ºæ ¼å­—ç¬¦ï¼Œä¹‹å‰è§£æ v-pre ç”¨ä¾‹æ˜¯å¡åœ¨è¿™é‡Œäº†
</span><span class="c1"></span>    <span class="c1">// è¿™é‡Œå¿˜è®°å®ç°äº†ï¼Œæ‰€ä»¥ç”¨ä¾‹ http://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/#headline-3
</span><span class="c1"></span>    <span class="c1">// å¾—åˆ°äº†ä¸‰ä¸ª childï¼Œç¬¬äºŒä¸ªæ˜¯ \nï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œæ²¡å®ç°è¿‡æ»¤
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">!==</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RAWTEXT</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inPre</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/[^\t\r\n\f ]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">))</span> <span class="p">{</span>
              <span class="kr">const</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
              <span class="kr">const</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
              <span class="c1">// 1. ç©ºæ ¼æ˜¯ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…
</span><span class="c1"></span>              <span class="c1">// 2. ç©ºæ ¼ä¸æ³¨é‡ŠèŠ‚ç‚¹ç›¸é‚»
</span><span class="c1"></span>              <span class="c1">// 3. ç©ºæ ¼åœ¨ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œå°±æˆ‘ä»¬é‡åˆ°çš„ &lt;div&gt;&lt;/div&gt;\n&lt;div&gt;...
</span><span class="c1"></span>              <span class="c1">// ä¸Šé¢ä¸‰ç§æƒ…å†µçš„ç©ºæ ¼ä¼šè¢«å¿½ç•¥
</span><span class="c1"></span>              <span class="k">if</span> <span class="p">(</span>
                <span class="o">!</span><span class="nx">prev</span> <span class="o">||</span>
                  <span class="o">!</span><span class="nx">next</span> <span class="o">||</span>
                  <span class="nx">prev</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span> <span class="o">||</span>
                  <span class="nx">next</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span> <span class="o">||</span>
                  <span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span>
                   <span class="nx">next</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span>
                   <span class="sr">/[\r\n]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">))</span>
              <span class="p">)</span> <span class="p">{</span>
                <span class="nx">removedWhitespace</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// å¦åˆ™æ›¿æ¢æˆç©ºæ ¼
</span><span class="c1"></span>                <span class="nx">node</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// æ›¿æ¢æˆç©ºæ ¼
</span><span class="c1"></span>              <span class="nx">node</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\t\r\n\f ]+/g</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">isPreTag</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">//å¦‚æœæ˜¯ &lt;pre&gt; åˆ æ‰ç¬¬ä¸€è¡Œçš„ç©ºè¡Œ
</span><span class="c1"></span>        <span class="kr">const</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="nx">first</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">first</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">first</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\r?\n/</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// &lt;&lt;&lt;&lt;&lt;&lt; æ–°å¢-end
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">removedWhitespace</span> <span class="o">?</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span> <span class="o">:</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>ä¿®æ”¹ <a href="#parse-parsetag">parseTag</a> å¢åŠ  v-pre, &lt;pre&gt; ä»£ç å¤„ç†</p>
<p>
è¿™é‡Œä¼šæœ‰ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹å°±æ˜¯å®ƒæ£€æµ‹åˆ°æ˜¯ pre ä¼šå›å¤´é‡æ–°è§£æå±æ€§ï¼Œç„¶åè¿‡æ»¤æ‰
v-pre æŒ‡ä»¤ï¼Œå¹¶ä¸”åœ¨ <a href="#parse-parseattribute">parseAttribute</a> é‡Œé¢ä¼šæ£€æµ‹åˆ° inVPre ä»æ¥ä¸ä¼šè¿›
è¡ŒæŒ‡ä»¤è§£æï¼Œåªä¼šè§£ææ™®é€šçš„ propsã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>
    <span class="c1">// æ–°å¢-start
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">isPreTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">inPre</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 1. inVPre = false å› ä¸ºåˆå§‹åŒ–é»˜è®¤ä¸ä¼šæ˜¯ v-pre çš„
</span><span class="c1"></span>    <span class="c1">// 2. åªè¦å±æ€§åˆ—è¡¨ä¸­æœ‰ä¸€ä¸ªæ»¡è¶³ï¼šv-pre æŒ‡ä»¤ç±»å‹
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span>
        <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;pre&#34;</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// è¿™é‡Œæ¢å¤ä¹‹å‰çš„è§£æï¼Œå› ä¸º &lt;div v-pre&gt;...&lt;/div&gt; èµ°åˆ°è¿™é‡Œçš„æ—¶å€™å·²ç»è§£æå®Œäº†
</span><span class="c1"></span>      <span class="c1">// æ‰€ä»¥è¦æ¢å¤å±æ€§å­—ç¬¦ä¸²ï¼Ÿ
</span><span class="c1"></span>      <span class="nx">extend</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">);</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">currentSource</span><span class="p">;</span>
      <span class="c1">// ä¸ºä»€ä¹ˆè¦é‡æ–°è§£æï¼Œç›´æ¥è¿‡æ»¤ä¸å¥½å—ï¼Ÿ
</span><span class="c1"></span>      <span class="c1">// å› ä¸º parseAttribute ä¸­åœ¨ inVPre = true æƒ…å†µä¸‹æ˜¯ä¸ä¼šå»è§£æå…¶ä»–æŒ‡ä»¤å±æ€§çš„
</span><span class="c1"></span>      <span class="c1">// å…¶ä»–æŒ‡ä»¤ç…§æ ·ä¼šè§£æï¼Œç›´æ¥è¿‡æ»¤æ‰æ‰€æœ‰æŒ‡ä»¤å±æ€§ä¸å°±å¥½äº†ï¼Ÿ
</span><span class="c1"></span>      <span class="nx">props</span> <span class="o">=</span> <span class="nx">parseAttributes</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">).</span><span class="nx">filter</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">!==</span> <span class="s2">&#34;v-pre&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// æ–°å¢-end
</span><span class="c1"></span>
    <span class="c1">// ...
</span><span class="c1"></span>
    <span class="kr">const</span> <span class="nx">val</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="p">,</span>
      <span class="nx">tag</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="p">,</span>
      <span class="nx">props</span><span class="p">,</span>
      <span class="nx">isSelfClosing</span><span class="p">,</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
11-<code>&lt;div&gt; id=a/&gt;&lt;/div&gt;</code> å±æ€§å€¼ä¸­æ²¡æœ‰å¼•å·æ—¶
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<p>
æ²¡æœ‰å¼•å·çš„æ—¶å€™æœ‰ä¸€äº›éæ³•å­—ç¬¦ï¼š <code>const unexpectedChars = /[&#34;&#39;&lt;=`]/g;</code> ï¼Œé‡åˆ°è¿™äº›
å€¼çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚</p>
<p>
åœ¨è¿™ä¹‹å‰æœ‰ä¸€ä¸ªåŒ¹é…ä½¿ç”¨æ¥åŒ¹é…å‡ºå€¼çš„ï¼š</p>
<p>
<code>const match = /^[^\t\r\n\f &gt;]+/.exec(context.source);</code></p>
<p>
è¿™ä¸ªä¼šå°† <strong>&gt;</strong> ä¹‹å‰çš„ <strong>=</strong> ä¹‹åçš„å±æ€§å€¼åŒ¹é…å‡ºæ¥ï¼Œç„¶åäº¤ç»™ <a href="#parse-parsetextdata">parseTextData</a> è¿›è¡Œè§£æã€‚</p>
</div>
</div>
<div id="outline-container-test-element-10" class="outline-4">
<h4 id="test-element-10">
10-<code>&lt;div&gt; id=&#34;&gt;\&#39;&#34;&gt;&lt;/div&gt;</code> å±æ€§å€¼ä¸­æœ‰å¼•å·æ—¶
</h4>
<div id="outline-text-test-element-10" class="outline-text-4">
<p>
è¿™ç§æƒ…å†µæ˜¯åˆæ³•çš„ï¼Œå±æ€§å€¼é‡Œé¢çš„å†…å®¹ä¼šè¢«å½“åšçº¯æ–‡æœ¬å¤„ç†ã€‚</p>
<pre class="example">
props: Array(1)
0:
  name: &#34;id&#34;
  type: 6
  value:
    content: &#34;&gt;&#39;&#34; // å±æ€§å€¼
    type: 2
</pre>
<p>
è¿™ä¸ªå¤„ç†è·Ÿ <a href="#test-element-09">ç”¨ä¾‹09</a> æ˜¯ä¸€æ ·çš„é€»è¾‘</p>
<p>
å¤šä¸ªå±æ€§çš„æƒ…å†µï¼Œåœ¨ parseAttributes ä¸­æœ‰ä¸ª while å¾ªç¯å¤„ç†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="kd">function</span> <span class="nx">parseAttributes</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="kr">type</span><span class="o">:</span> <span class="nx">TagType</span>
  <span class="p">)</span><span class="o">:</span> <span class="p">(</span><span class="nx">AttributeNode</span> <span class="o">|</span> <span class="nx">DirectiveNode</span><span class="p">)[]</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">props</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="kr">const</span> <span class="nx">attributeNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;()</span>
      <span class="k">while</span> <span class="p">(</span>
          <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
              <span class="o">!</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
              <span class="o">!</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="s1">&#39;/&gt;&#39;</span><span class="p">)</span>
      <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// ...
</span><span class="c1"></span>
          <span class="kr">const</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">parseAttribute</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">attributeNames</span><span class="p">)</span>
          <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">props</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-09" class="outline-4">
<h4 id="test-element-09">
09-<code>&lt;div id=&#34;&#34;&gt;&lt;/div&gt;</code> å±æ€§å€¼ä¸ºç©ºçš„æƒ…å†µ
</h4>
<div id="outline-text-test-element-09" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;attribute with empty value, double quote&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;div id=&#34;&#34;&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">ElementNode</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
          <span class="nx">ns</span>: <span class="kt">Namespaces.HTML</span><span class="p">,</span>
          <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
          <span class="nx">tagType</span>: <span class="kt">ElementTypes.ELEMENT</span><span class="p">,</span>
          <span class="nx">codegenNode</span>: <span class="kt">undefined</span><span class="p">,</span>
          <span class="nx">props</span><span class="o">:</span> <span class="p">[</span>
              <span class="p">{</span>
                  <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ATTRIBUTE</span><span class="p">,</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
                  <span class="nx">value</span><span class="o">:</span> <span class="p">{</span>
                      <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
                      <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
                          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">8</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">9</span> <span class="p">},</span>
                          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">10</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">11</span> <span class="p">},</span>
                          <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&#34;&#34;&#39;</span>
                      <span class="p">}</span>
                  <span class="p">},</span>
                  <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
                      <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">5</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">6</span> <span class="p">},</span>
                      <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">10</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">11</span> <span class="p">},</span>
                      <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;id=&#34;&#34;&#39;</span>
                  <span class="p">}</span>
              <span class="p">}</span>
          <span class="p">],</span>

          <span class="nx">isSelfClosing</span>: <span class="kt">false</span><span class="p">,</span>
          <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">0</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">1</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">17</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">18</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;div id=&#34;&#34;&gt;&lt;/div&gt;&#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è§£æï¼š <a href="#parse-parsetag">parseTag</a> -&gt; <a href="#parse-parseattributes">parseAttributes</a> -&gt; <a href="#parse-parseattribute">parseAttribute</a> -&gt; <a href="#parse-parseattributevalue">parseAttributeValue</a>
-&gt; <a href="#parse-parsetextdata">parseTextData</a> ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œç»„ç»‡ï¼š <code>{ type, content: &#39;&#39;, ... }</code> è¿”å›</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="kd">function</span> <span class="nx">parseAttributeValue</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span>
  <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...çœç•¥
</span><span class="c1"></span>
      <span class="kr">const</span> <span class="nx">quote</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="kr">const</span> <span class="nx">isQuoted</span> <span class="o">=</span> <span class="nx">quote</span> <span class="o">===</span> <span class="sb">`&#34;`</span> <span class="o">||</span> <span class="nx">quote</span> <span class="o">===</span> <span class="sb">`&#39;`</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isQuoted</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// id=&#34;&#34;ï¼Œæœ‰å¼•å·
</span><span class="c1"></span>          <span class="c1">// Quoted value.
</span><span class="c1"></span>          <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

          <span class="kr">const</span> <span class="nx">endIndex</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">quote</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">endIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">content</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span>
                  <span class="nx">context</span><span class="p">,</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
                  <span class="nx">TextModes</span><span class="p">.</span><span class="nx">ATTRIBUTE_VALUE</span>
              <span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// åˆ°è¿™é‡Œ
</span><span class="c1"></span>              <span class="nx">content</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">endIndex</span><span class="p">,</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">ATTRIBUTE_VALUE</span><span class="p">)</span>
              <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// ä¸ä¼šåˆ°è¿™é‡Œ
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="k">return</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">isQuoted</span><span class="p">,</span> <span class="nx">loc</span>: <span class="kt">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-08" class="outline-4">
<h4 id="test-element-08">
08-<code>&lt;div id&gt;&lt;/div&gt;</code> æ— å±æ€§å€¼çš„å±æ€§
</h4>
<div id="outline-text-test-element-08" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;attribute with no value&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s2">&#34;&lt;div id&gt;&lt;/div&gt;&#34;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ATTRIBUTE</span><span class="p">,</span>
          <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;id&#34;</span><span class="p">,</span>
          <span class="nx">value</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">6</span> <span class="p">},</span>
            <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">8</span> <span class="p">},</span>
            <span class="nx">source</span><span class="o">:</span> <span class="s2">&#34;id&#34;</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">},</span>
      <span class="p">],</span>

      <span class="nx">isSelfClosing</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">15</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s2">&#34;&lt;div id&gt;&lt;/div&gt;&#34;</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">});</span> <span class="c1">// attribute with no value
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è§£æï¼š <a href="#parse-parsetag">parseTag</a> -&gt; <a href="#parse-parseattributes">parseAttributes</a> -&gt; <a href="#parse-parseattribute">parseAttribute</a> é‡Œé¢æœ‰ä¸€æ®µé’ˆå¯¹å±æ€§å€¼å¤„ç†</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">parseAttribute</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="nx">nameSet</span>: <span class="kt">Set</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">AttributeNode</span> <span class="o">|</span> <span class="nx">DirectiveNode</span> <span class="p">{</span>
      <span class="c1">// ... çœç•¥
</span><span class="c1"></span>
      <span class="c1">// è¿™é‡Œæ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ name= æˆ– name=value æƒ…å†µ
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="sr">/^[\t\r\n\f ]*=/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
          <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">parseAttributeValue</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
          <span class="c1">// è¿™é‡Œæ˜¯é˜²æ­¢ name= åé¢æ²¡æœ‰å€¼å¾—æƒ…å†µæŠ¥é”™
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">MISSING_ATTRIBUTE_VALUE</span><span class="p">)</span>
          <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// ... å› ä¸º id æ²¡æœ‰ id=? æ‰€ä»¥ç›´æ¥å›åˆ°è¿™é‡Œï¼Œä¸ä¼šè¿›å…¥
</span><span class="c1"></span>      <span class="c1">// parseAttributeValue è§£æå±æ€§å€¼
</span><span class="c1"></span>
      <span class="c1">// ... id éæŒ‡ä»¤å±æ€§ï¼Œæ‰€ä»¥ç›´æ¥åˆ°æœ€åä»¥æ™®é€šå±æ€§ç±»å‹é€€å‡º
</span><span class="c1"></span>      <span class="k">return</span> <span class="p">{</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ATTRIBUTE</span><span class="p">,</span>
          <span class="nx">name</span><span class="p">,</span>
          <span class="nx">value</span>: <span class="kt">value</span> <span class="o">&amp;&amp;</span> <span class="p">{</span>
              <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
              <span class="nx">content</span>: <span class="kt">value.content</span><span class="p">,</span>
              <span class="nx">loc</span>: <span class="kt">value.loc</span>
          <span class="p">},</span>
          <span class="nx">loc</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-07" class="outline-4">
<h4 id="test-element-07">
07-isCustomElement è‡ªå®šä¹‰å…ƒç´ 
</h4>
<div id="outline-text-test-element-07" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;custom element&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s2">&#34;&lt;div&gt;&lt;/div&gt;&lt;comp&gt;&lt;/comp&gt;&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">isNativeTag</span><span class="o">:</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
      <span class="nx">isCustomElement</span><span class="o">:</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;comp&#34;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span> <span class="c1">// ç”±äºæ˜¯ isNativeTag() ä½¿ç”¨äº†é»˜è®¤ ELEMENT
</span><span class="c1"></span>    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;comp&#34;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span> <span class="c1">// ç”±äºæ˜¯ isCustomElement() æ‰€ä»¥å‹æ ¹ä¸ä¼šè¿›å…¥åˆ° if ... ä¸­æ£€æµ‹ç±»å‹
</span><span class="c1"></span>    <span class="p">});</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è‡ªå®šä¹‰ç±»å‹åˆ¤æ–­ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="kr">type</span><span class="o">:</span> <span class="nx">TagType</span><span class="p">,</span>
      <span class="nx">parent</span>: <span class="kt">ElementNode</span> <span class="o">|</span> <span class="kc">undefined</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">ElementNode</span> <span class="p">{</span>
      <span class="c1">// ... çœç•¥
</span><span class="c1"></span>
      <span class="kd">let</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span>
      <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span>
      <span class="c1">// &lt;comp&gt; ç”±äºæ˜¯ isCustomElement å› æ­¤å‹æ ¹ä¸ä¼šè¿›å…¥ä¸‹é¢çš„ if (false) ...
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isCustomElement</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">hasVIs</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
              <span class="nx">p</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;is&#39;</span>
          <span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasVIs</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// div ä¼šè¿›å…¥åˆ°è¿™é‡Œï¼Œä½†æ˜¯æ£€æµ‹å¤±è´¥ if (!true) ...
</span><span class="c1"></span>              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
              <span class="c1">// div è¿™é‡Œéƒ½ä¸æ»¡è¶³ï¼Œif (false) ...
</span><span class="c1"></span>              <span class="nx">hasVIs</span> <span class="o">||</span>
                  <span class="nx">isCoreComponent</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">||</span>
                  <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isBuiltInComponent</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">isBuiltInComponent</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="o">||</span>
                  <span class="sr">/^[A-Z]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">||</span>
                  <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;component&#39;</span>
          <span class="p">)</span> <span class="p">{</span>
              <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;slot&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">SLOT</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
              <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;template&#39;</span> <span class="o">&amp;&amp;</span>
                  <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">p</span> <span class="o">=&gt;</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="p">(</span>
                          <span class="nx">p</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">isSpecialTemplateDirective</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
                      <span class="p">)</span>
                  <span class="p">})</span>
          <span class="p">)</span> <span class="p">{</span>
              <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span>
          <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// æ‰€ä»¥ &lt;div&gt; æœ€ç»ˆä½¿ç”¨äº†é»˜è®¤å€¼ï¼šELEMENT
</span><span class="c1"></span>      <span class="c1">// æ‰€ä»¥ &lt;comp&gt; ç›´æ¥åˆ°äº†è¿™é‡Œï¼Œæ˜¯ï¼šELEMENT ç±»å‹
</span><span class="c1"></span>      <span class="k">return</span> <span class="p">{</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
          <span class="nx">ns</span><span class="p">,</span>
          <span class="nx">tag</span><span class="p">,</span>
          <span class="nx">tagType</span><span class="p">,</span>
          <span class="nx">props</span><span class="p">,</span>
          <span class="nx">isSelfClosing</span><span class="p">,</span>
          <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
          <span class="nx">loc</span>: <span class="kt">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
          <span class="nx">codegenNode</span>: <span class="kt">undefined</span> <span class="c1">// to be created during transform phase
</span><span class="c1"></span>      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-06" class="outline-4">
<h4 id="test-element-06">
06-isNativeTag åŸç”Ÿæ ‡ç­¾ç±»å‹
</h4>
<div id="outline-text-test-element-06" class="outline-text-4">
<p>
è¿™ä¸ªç”¨ä¾‹(<code>&lt;div&gt;&lt;/div&gt;&lt;comp&gt;&lt;/comp&gt;&lt;Comp&gt;&lt;/Comp&gt;</code>)é‡Œé¢æœ‰ä¸‰ä¸ªæ ‡ç­¾ï¼š</p>
<ol>
<li>
<p><code class="verbatim">div</code></p>
</li>
<li>
<p><code class="verbatim">comp</code></p>
</li>
<li>
<p><code class="verbatim">Comp</code></p>
</li>
</ol>
<p>
åŒæ—¶ä¼ é€’ä¸€ä¸ª <code>options: { isNativeTag: tag =&gt; tag === &#39;div&#39; }</code></p>
<p>
æ„æ€å‘Šè¯‰ç¼–è¯‘å™¨è¿™é‡Œé¢åªæœ‰ <strong>div</strong> å±äºåŸç”Ÿæ ‡ç­¾ï¼Œå…¶ä»–çš„éƒ½å±äºç»„ä»¶ç±»å‹ï¼Œè¿™ä¸ªåœ¨ <a href="#parse-parsetag">parseTag</a>
å®ç°ä¸­ä½“ç°å‡ºæ¥ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;native element with `isNativeTag`&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s2">&#34;&lt;div&gt;&lt;/div&gt;&lt;comp&gt;&lt;/comp&gt;&lt;Comp&gt;&lt;/Comp&gt;&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">isNativeTag</span><span class="o">:</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">tag</span> <span class="o">===</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;comp&#34;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s2">&#34;Comp&#34;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">});</span> <span class="c1">// native element with `isNativeTag`
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é€šè¿‡è¯¥ç”¨ä¾‹çš„ä»£ç å®ç°ç‰‡æ®µ(åœ¨<a href="#test-element-05">ç”¨ä¾‹ 05</a> ä¸­å°±å·²ç»å®ç°è¿‡äº†ï¼Œå› æ­¤è¯¥ç”¨ä¾‹é¡ºåˆ©é€šè¿‡)ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="kr">type</span><span class="o">:</span> <span class="nx">TagType</span><span class="p">,</span>
      <span class="nx">parent</span>: <span class="kt">ElementNode</span> <span class="o">|</span> <span class="kc">undefined</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">ElementNode</span> <span class="p">{</span>
      <span class="c1">// ... çœç•¥
</span><span class="c1"></span>
      <span class="kd">let</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span>
      <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span>
      <span class="c1">// å‰æï¼Œé v-pre æŒ‡ä»¤ï¼Œä¸”éè‡ªå®šä¹‰æ ‡ç­¾(é»˜è®¤ï¼šNO)
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isCustomElement</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>

          <span class="c1">// æ˜¯å¦æœ‰ v-is æŒ‡ä»¤
</span><span class="c1"></span>          <span class="kr">const</span> <span class="nx">hasVIs</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
              <span class="nx">p</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;is&#39;</span>
          <span class="p">)</span>

          <span class="c1">// é¦–å…ˆç”±æä¾›åŸç”Ÿæ ‡ç­¾æ£€æµ‹å‡½æ•°ï¼Œä¸”æ²¡æœ‰ v-is æƒ…å†µä¸‹è¿›å…¥ç»„ä»¶åˆ¤æ–­
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasVIs</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// ç±»å‹ä¸º COMPONENT ç»„ä»¶ç±»å‹
</span><span class="c1"></span>              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
          <span class="p">}</span>

          <span class="c1">// ... çœç•¥
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="k">return</span> <span class="p">{</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
          <span class="nx">ns</span><span class="p">,</span>
          <span class="nx">tag</span><span class="p">,</span>
          <span class="nx">tagType</span><span class="p">,</span>
          <span class="nx">props</span><span class="p">,</span>
          <span class="nx">isSelfClosing</span><span class="p">,</span>
          <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
          <span class="nx">loc</span>: <span class="kt">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
          <span class="nx">codegenNode</span>: <span class="kt">undefined</span> <span class="c1">// to be created during transform phase
</span><span class="c1"></span>      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è€Œåœ¨æ²¡æœ‰æä¾› <code class="verbatim">isNativeTag()</code> çš„æƒ…å†µä¸‹ï¼Œä¸‰ç§æ ‡ç­¾çš„è§£æç»“æœä¸­çš„ <code class="verbatim">tagType</code> åˆæ˜¯ä¸ä¸€
æ ·çš„ï¼Œå»¶ç»­ä¸Šé¢çš„å¸¦ç»§ç»­åˆ†æï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="kr">type</span><span class="o">:</span> <span class="nx">TagType</span><span class="p">,</span>
      <span class="nx">parent</span>: <span class="kt">ElementNode</span> <span class="o">|</span> <span class="kc">undefined</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">ElementNode</span> <span class="p">{</span>
      <span class="c1">// ... çœç•¥
</span><span class="c1"></span>
      <span class="kd">let</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span>
      <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span>
      <span class="c1">// å‰æï¼Œé v-pre æŒ‡ä»¤ï¼Œä¸”éè‡ªå®šä¹‰æ ‡ç­¾(é»˜è®¤ï¼šNO)
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isCustomElement</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>

          <span class="c1">// æ˜¯å¦æœ‰ v-is æŒ‡ä»¤
</span><span class="c1"></span>          <span class="kr">const</span> <span class="nx">hasVIs</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
              <span class="nx">p</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;is&#39;</span>
          <span class="p">)</span>

          <span class="c1">// é¦–å…ˆç”±æä¾›åŸç”Ÿæ ‡ç­¾æ£€æµ‹å‡½æ•°ï¼Œä¸”æ²¡æœ‰ v-is æƒ…å†µä¸‹è¿›å…¥ç»„ä»¶åˆ¤æ–­
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasVIs</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// ç±»å‹ä¸º COMPONENT ç»„ä»¶ç±»å‹
</span><span class="c1"></span>              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
              <span class="c1">// æŠŠè¿™é‡Œçœç•¥çš„éƒ¨åˆ†åŠ ä¸Š...
</span><span class="c1"></span>              <span class="nx">hasVIs</span> <span class="o">||</span>
                  <span class="nx">isCoreComponent</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">||</span>
                  <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isBuiltInComponent</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">isBuiltInComponent</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="o">||</span>
                  <span class="c1">// é‡ç‚¹åœ¨è¿™é‡Œï¼Œæ£€æµ‹åˆ°å¦‚æœæ ‡ç­¾åå¼€å¤´æ˜¯å¤§å†™çš„å°±ä¼šè¢«è§†ä¸ºç»„ä»¶ç±»å‹
</span><span class="c1"></span>                  <span class="sr">/^[A-Z]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">||</span>
                  <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;component&#39;</span>
          <span class="p">)</span> <span class="p">{</span>
              <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
          <span class="p">}</span>

          <span class="c1">// ... çœç•¥
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="k">return</span> <span class="p">{</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
          <span class="nx">ns</span><span class="p">,</span>
          <span class="nx">tag</span><span class="p">,</span>
          <span class="nx">tagType</span><span class="p">,</span>
          <span class="nx">props</span><span class="p">,</span>
          <span class="nx">isSelfClosing</span><span class="p">,</span>
          <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
          <span class="nx">loc</span>: <span class="kt">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
          <span class="nx">codegenNode</span>: <span class="kt">undefined</span> <span class="c1">// to be created during transform phase
</span><span class="c1"></span>      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é‚£ä¹ˆæ¥ä¸‹æ¥çš„ç”¨ä¾‹ä¹Ÿä¸æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;v-is without `isNativeTag`&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span>
      <span class="sb">`&lt;div&gt;&lt;/div&gt;&lt;div v-is=&#34;&#39;foo&#39;&#34;&gt;&lt;/div&gt;&lt;Comp&gt;&lt;/Comp&gt;`</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="nx">isNativeTag</span><span class="o">:</span> <span class="nx">tag</span> <span class="p">=&gt;</span> <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;div&#39;</span>
      <span class="p">}</span>
    <span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="c1">// è¿™é‡Œæ¯‹åº¸ç½®ç–‘æ˜¯é»˜è®¤åŸç”Ÿå…ƒç´ ç±»å‹
</span><span class="c1"></span>    <span class="p">})</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
      <span class="c1">// å®¹æ˜“äº§ç”Ÿç–‘é—®çš„æ˜¯è¿™ä¸ªï¼Œè¿™é‡Œä¸ºä»€ä¹ˆæ˜¯ COMPONENTï¼Œè€Œä¸æ˜¯ element å‘¢
</span><span class="c1"></span>      <span class="c1">// è¿™é‡Œå…³é”®åœ¨äº v-isï¼Œè®°å¾—ï¼šisNativeTag() æ£€æµ‹çš„ä¼˜å…ˆçº§æœ€é«˜å‰ææ˜¯ !hasVIs æˆç«‹æƒ…å†µ
</span><span class="c1"></span>      <span class="c1">// ç„¶è€Œè¿™é‡Œæ˜¾ç„¶ hasVIs === true
</span><span class="c1"></span>      <span class="c1">// å› æ­¤è¿›å…¥äº† else if (... || hasVIs || ...) { tagType = ElementTypes.COMPONENT }
</span><span class="c1"></span>      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
    <span class="p">})</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;Comp&#39;</span><span class="p">,</span>
      <span class="c1">// è¿™é‡Œæ²¡å•¥ç–‘é—®ï¼Œå¤§å†™å¼€å¤´æ‰€ä»¥æ˜¯ç»„ä»¶ç±»å‹
</span><span class="c1"></span>      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è‡ªå®šä¹‰ç»„ä»¶ï¼š</p>
</div>
</div>
<div id="outline-container-test-element-05" class="outline-4">
<h4 id="test-element-05">
05-template element with directives
</h4>
<div id="outline-text-test-element-05" class="outline-text-4">
<p>
è¿™ä¸ªç”¨ä¾‹å¼€å§‹æ¨¡æ¿çš„è§£æã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;template element with directives&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;template v-if=&#34;ok&#34;&gt;&lt;/template&gt;&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>baseParse(&#39;&lt;template v-if=&#34;ok&#34;&gt;&lt;/template&gt;&#39;)</code> è§£æä¹‹åçš„ç»“æ„ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="p">{</span>
    <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;children&#34;</span><span class="p">:[</span>
      <span class="p">{</span> <span class="err">//</span> <span class="err">&lt;template&gt;</span> <span class="err">èŠ‚ç‚¹</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="nt">&#34;ns&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="nt">&#34;tag&#34;</span><span class="p">:</span><span class="s2">&#34;template&#34;</span><span class="p">,</span>
        <span class="nt">&#34;tagType&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
        <span class="nt">&#34;props&#34;</span><span class="p">:[</span>
          <span class="p">{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="err">//</span> <span class="err">DIRECTIVE</span>
            <span class="nt">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;if&#34;</span><span class="p">,</span>
            <span class="nt">&#34;exp&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="err">//</span> <span class="err">SIMPLE_EXPRESSION</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;ok&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;loc&#34;</span><span class="p">:{</span>
                <span class="err">//</span> <span class="err">...</span> <span class="err">çœç•¥</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&#34;modifiers&#34;</span><span class="p">:[</span>
              <span class="err">//</span> <span class="err">ä¿®é¥°ç¬¦</span>
            <span class="p">],</span>
            <span class="nt">&#34;loc&#34;</span><span class="p">:{</span>
              <span class="err">//</span> <span class="err">çœç•¥</span>
              <span class="nt">&#34;source&#34;</span><span class="p">:</span><span class="s2">&#34;v-if=&#34;</span><span class="err">ok</span><span class="s2">&#34;&#34;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="err">//</span> <span class="err">...</span> <span class="err">çœç•¥</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="err">//</span> <span class="err">...</span> <span class="err">çœå»</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¸ºäº†èƒ½è§£æå‡º <code>v-if=&#34;ok&#34;</code> æˆ‘ä»¬éœ€è¦å»å®ç° <a href="#parse-parseattributes">parseAttributes(context, type)</a> -&gt;
<a href="#parse-parseattribute">parseAttribute</a> -&gt; <a href="#parse-parseattributevalue">parseAttributeValue</a></p>
<p>
è¯¥ç”¨ä¾‹è€ƒå¯Ÿçš„å…¶å®å¹¶ä¸æ˜¯ <code>&lt;template&gt;</code> æ¨¡æ¿æ ‡ç­¾è§£æï¼Œè€Œæ˜¯æ ‡ç­¾ä¸Šçš„å±æ€§è§£æï¼Œå¯¹æ™®é€šçš„
<code>&lt;div&gt;</code> æ ‡ç­¾ä¾ç„¶å¯ä»¥è§£æå‡ºå±æ€§ props[]ã€‚</p>
<blockquote>
<p><strong>é’ˆå¯¹æ¨¡æ¿ <code class="verbatim">&lt;template&gt;</code> æ ‡ç­¾çš„å¤„ç†è¯¦æƒ…å¯ä»¥<a href="/vue/vue-mind-map-house/#map-parse-template">æŸ¥çœ‹æ­¤å¤„(å«è„‘å›¾)</a>ï¼Œæ›´ç›´è§‚ã€‚</strong></p>
</blockquote>
</div>
</div>
<div id="outline-container-test-element-04" class="outline-4">
<h4 id="test-element-04">
04-void element
</h4>
<div id="outline-text-test-element-04" class="outline-text-4">
<p>
ç©ºæ ‡ç­¾è§£æï¼Œå¦‚ï¼š~&lt;img&gt;~</p>
<p>
å‰ææ˜¯æä¾›äº† <code>isVoidTag()</code> é€‰é¡¹ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;void element&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;img&gt;after&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">isVoidTag</span><span class="o">:</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;img&#39;</span>
    <span class="p">})</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="p">[],</span>

      <span class="nx">isSelfClosing</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">6</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;img&gt;&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¯¥ç”¨ä¾‹å’Œ<a href="#test-element-03">è‡ªé—­æ ‡ç­¾</a>ç±»ä¼¼éƒ½æ˜¯åœ¨ <a href="#parse-parsetag">parseTag</a> è§£æå®Œä¹‹ååœ¨ <a href="#parse-parseelement">parseElement</a> ä¸­ç»“æŸè§£æï¼Œä¸åŒç‚¹
åœ¨äºè°ƒç”¨ <a href="#parse-baseparse">baseParse</a> çš„æ—¶å€™éœ€è¦ä¼ é€’ä¸€ä¸ªåŒ…å« <code>isVoidTag()</code> çš„é€‰é¡¹ <code>{isVoidTag: tag
=&gt; tag === &#39;img&#39;}</code> ç”¨æ¥å‘Šè¯‰è§£æå™¨ä»€ä¹ˆæ ·çš„æ ‡ç­¾å±äºç©ºæ ‡ç­¾ï¼Œå³ä¸æ˜¯ <code>&lt;img/&gt;</code> ä¹Ÿä¸æ˜¯
<code>&lt;div&gt;&lt;/div&gt;</code> ç±»å‹ã€‚</p>
<p>
<a href="#parse-parseelement">parseElement</a> ä¸­è§£ææ¡ä»¶ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">parseElement</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... parseTag ä¸­è§£æ &lt;img ...&gt;
</span><span class="c1"></span>    <span class="c1">// è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">isSelfClosing</span> <span class="o">||</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">isVoidTag</span><span class="o">?</span><span class="p">.(</span><span class="nx">element</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">element</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-03" class="outline-4">
<h4 id="test-element-03">
03-self closing
</h4>
<div id="outline-text-test-element-03" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;self closing&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;after&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="p">[],</span>

      <span class="nx">isSelfClosing</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">7</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;div/&gt;&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-02" class="outline-4">
<h4 id="test-element-02">
02-empty div
</h4>
<div id="outline-text-test-element-02" class="outline-text-4">
<p>
å’Œ <a href="#test-element-01">01-simple div</a> ä¸€æ ·ï¼Œæ— éå°±æ˜¯æ²¡æœ‰ <code>children[]</code> å­èŠ‚ç‚¹äº†ã€‚åœ¨ <a href="#parse-parseelement">parseElement</a> -&gt; <a href="#parse-parsetag">parseTag</a> è§£æå°±ç»“æŸäº†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;empty div&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">isSelfClosing</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">12</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-element-01" class="outline-4">
<h4 id="test-element-01">
01-simple div
</h4>
<div id="outline-text-test-element-01" class="outline-text-4">
<p>
æµç¨‹å›¾ï¼š
<img src="/img/vue3/compiler-core/parser-test-simple-tag-div.png" alt="/img/vue3/compiler-core/parser-test-simple-tag-div.png" title="/img/vue3/compiler-core/parser-test-simple-tag-div.png" /></p>
<p>
å› ä¸º <a href="#parse-parseelement">parseElement</a> å·²ç»å®ç°ï¼Œå› æ­¤è¿™ä¸ªé¡ºåˆ©é€šè¿‡ï¼Œ~parseElement~ è§£æå…ˆæ£€æµ‹ <code>&lt;/div&gt;</code>
ç»“æŸæ ‡ç­¾ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºéæ³•æ— ç»“æŸæ ‡ç­¾è§¦å‘ <code>ErrorCodes.EOF_IN_TAG</code> å¼‚å¸¸ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;simple div&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;hello&lt;/div&gt;&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">,</span>
      <span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="o">:</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">isSelfClosing</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// &lt;div åä¸º &gt; ä¸ºéè‡ªé—­åˆæ ‡ç­¾
</span><span class="c1"></span>      <span class="nx">children</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">6</span> <span class="p">},</span> <span class="c1">// h ä½ç½®ç´¢å¼•
</span><span class="c1"></span>            <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">11</span> <span class="p">},</span> <span class="c1">// o ä½ç½®ç´¢å¼•
</span><span class="c1"></span>            <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">17</span> <span class="p">},</span>
        <span class="c1">// é‡åˆ°&lt;div&gt; ä¼šç›´æ¥åˆ¤æ–­æ˜¯å¦æœ‰ &lt;/div&gt; ç„¶åæˆªå–`&lt;div&gt;...&lt;/div&gt;
</span><span class="c1"></span>        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;div&gt;hello&lt;/div&gt;&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ ‡ç­¾çš„è§£æåœ¨ <a href="#parse-parsetag">parseTag</a> ä¸­å®Œæˆï¼Œ å¦‚æœæ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œä¼šç½®æ ‡å¿—ä½ <code>isSelfClosing =
true</code> ã€‚</p>
<p>
å¹¶ä¸”è§£ææ ‡ç­¾åªä¼šè§£æåˆ° <code class="verbatim">&lt;div&gt;</code> ä¸­çš„ <code class="verbatim">&lt;div</code> éƒ¨åˆ†å°±ç»“æŸï¼Œæ˜¯å› ä¸ºéœ€è¦æ£€æµ‹åé¢æ˜¯ <code class="verbatim">&gt;</code>
è¿˜æ˜¯ <code class="verbatim">/&gt;</code> å¦‚æœæ˜¯ <code class="verbatim">/&gt;</code> åˆ™ä¸ºè‡ªé—­åˆæ ‡ç­¾éœ€è¦åŒºåˆ†å¤„ç†ï¼Œå› æ­¤è¿™é‡Œä¼šæœ‰ä¸ªåˆ¤æ–­æ¥å†³å®š
<code class="verbatim">advanceBy</code> 1 æˆ– 2 ä¸ªæŒ‡é’ˆä½ç½®ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// parseTag
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_TAG</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// some &lt;div&gt; ... &lt;/div&gt; åˆ°è¿™é‡Œçš„ source = &gt; ... &lt;/div&gt;
</span><span class="c1"></span>    <span class="c1">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /&gt; å¼€å¤´çš„
</span><span class="c1"></span>    <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&gt;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span> <span class="o">&amp;&amp;</span> <span class="nx">isSelfClosing</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/&gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(&gt;)
</span><span class="c1"></span>    <span class="c1">// åˆ°è¿™é‡Œ source = ... &lt;/div&gt;
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">isSelfClosing</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-parse-comment" class="outline-3">
<h3 id="test-parse-comment">
Comment æ³¨é‡Šè§£æ
</h3>
<div id="outline-text-test-parse-comment" class="outline-text-3">
<p>
æ³¨é‡Šé£æ ¼ï¼š <code class="verbatim">&lt;!-- ... --&gt;</code> ï¼Œ<a href="#link-05">é˜¶æ®µ 5</a> åŠä¹‹å‰è¿˜ä¸æ”¯æŒæ³¨é‡Šè§£æï¼Œå› ä¸ºè¿˜æ²¡å®ç° <a href="#parse-parsecomment">parseComment</a>ã€‚</p>
<p>
æ³¨é‡Šæµ‹è¯•ç”¨ä¾‹ä¸å­˜åœ¨é˜¶æ®µæ€§çš„å®ç°ï¼Œåªè¦å®ç°äº† <a href="#parse-parsecomment">parseComment</a> å°±é¥¿éƒ½å¯ä»¥é€šè¿‡äº†ï¼Œå› æ­¤è¿™é‡Œæ”¾åœ¨ä¸€èµ·é€šè¿‡è®°å½•ã€‚</p>
<ol>
<li>
<p><strong>empty comment</strong> ç©ºæ³¨é‡ŠèŠ‚ç‚¹</p>
</li>
<li>
<p><strong>simple comment</strong> æ­£å¸¸æ³¨é‡ŠèŠ‚ç‚¹</p>
</li>
<li>
<p><strong>two comments</strong> å¤šä¸ªæ³¨é‡ŠèŠ‚ç‚¹</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Comment&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;empty comment&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;!----&gt;&#39;</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">comment</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">comment</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">8</span> <span class="p">},</span>
          <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;!----&gt;&#39;</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">})</span> <span class="c1">// empty comment
</span><span class="c1"></span>
    <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;simple comment&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;!--abc--&gt;&#39;</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">comment</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">comment</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">11</span> <span class="p">},</span>
          <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;!--abc--&gt;&#39;</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">})</span> <span class="c1">// simple comment
</span><span class="c1"></span>
    <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;two comments&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;!--abc--&gt;&lt;!--def--&gt;&#39;</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">comment1</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="kr">const</span> <span class="nx">comment2</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">comment1</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">11</span> <span class="p">},</span>
          <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;!--abc--&gt;&#39;</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">comment2</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;def&#39;</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">11</span> <span class="p">},</span>
          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">21</span> <span class="p">},</span>
          <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&lt;!--def--&gt;&#39;</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">})</span> <span class="c1">// two comments
</span><span class="c1"></span>  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ªç”¨ä¾‹ï¼Œä¸€å¼€å§‹æµ‹è¯•å¹¶ä¸èƒ½é€šè¿‡ï¼Œæ˜¯å› ä¸ºå®ç° <a href="#parse-pushnode">pushNode</a> çš„æ—¶å€™å¿˜è®°åŠ ä¸Š
<code class="verbatim">__DEV__</code> ç¯å¢ƒæ£€æµ‹äº†ï¼Œå› ä¸ºç”Ÿäº§ç¯å¢ƒæ˜¯ä¸éœ€è¦ä¿å­˜æ³¨é‡ŠèŠ‚ç‚¹çš„ï¼Œå¼€å‘ç¯å¢ƒä¸ºäº†æµ‹è¯•éœ€è¦æœ‰
è¿™ä¸ªä¿¡æ¯ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// è¿™é‡ŒåŠ ä¸Š __DEV__ æ£€æµ‹ï¼Œå¼€å‘çš„æ—¶å€™è¿˜æ˜¯éœ€è¦çš„
</span><span class="c1"></span>    <span class="c1">// ä¸ç„¶ç”¨ä¾‹ä¼šé€šä¸è¿‡ï¼Œå› ä¸ºè¿™é‡Œç›´æ¥è¿”å› Undefined äº†ï¼Œå¯¼è‡´
</span><span class="c1"></span>    <span class="c1">// parent.children[] é‡Œé¢å¹¶ä¸å­˜åœ¨è¿™ä¸ªæ³¨é‡ŠèŠ‚ç‚¹
</span><span class="c1"></span>    <span class="c1">// åŠ ä¸Šå°±å¥½äº†
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// æ³¨é‡ŠèŠ‚ç‚¹ä¸å¤„ç†
</span><span class="c1"></span>      <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">// ... çœç•¥
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-23" class="outline-3">
<h3 id="headline-23">
Interpolation æ’å€¼è§£æ
</h3>
<div id="outline-text-headline-23" class="outline-text-3">
<div id="outline-container-test-interpolation-05" class="outline-4">
<h4 id="test-interpolation-05">
05-custom delimiters
</h4>
<div id="outline-text-test-interpolation-05" class="outline-text-4">
<p>
è‡ªå®šä¹‰æ’å€¼åˆ†éš”ç¬¦ï¼Œå…¶å®å¤„ç†æµç¨‹å’Œæ’å€¼å¤„ç†ä¸€æ ·ï¼Œæ‰€ä»¥æ²¡å•¥å¥½è®²çš„ï¼Œ<a href="#link-04">é˜¶æ®µä»£ç  4</a> å°±æ”¯æŒè¯¥ç”¨ä¾‹é€šè¿‡ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;custom delimiters&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;{msg}&lt;/p&gt;&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">delimiters</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">]</span>
    <span class="p">})</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">interpolation</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">interpolation</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="sb">`msg`</span><span class="p">,</span>
        <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">5</span> <span class="p">},</span>
          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">8</span> <span class="p">},</span>
          <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;msg&#39;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">4</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">9</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;{msg}&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-interpolation-04" class="outline-4">
<h4 id="test-interpolation-04">
04-it can have tag-like notation (3)
</h4>
<div id="outline-text-test-interpolation-04" class="outline-text-4">
<p>
å‰é¢çš„ä¸¤ä¸ªç”¨ä¾‹å·²ç»è§£é‡Šè¿‡äº†ï¼Œæ’å€¼é‡Œé¢çš„å†…å®¹ä¼šåœ¨ <a href="#parse-parseinterpolation">parseInterpolation</a> ä¸­ç›´æ¥å¤„ç†æˆæ’
å€¼çš„æ¨¡æ¿(source)ï¼Œä¸ä¼šè¿›å…¥åˆ° while å¾ªç¯è§¦å‘å¼‚å¸¸ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;it can have tag-like notation (3)&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;{{ &#34;&lt;/div&gt;&#34; }}&lt;/div&gt;&#39;</span><span class="p">)</span>
      <span class="c1">// è¿™é‡Œè§£æå‡ºæ¥çš„æ˜¯ &lt;div&gt;&lt;/div&gt; è¿™ä¸ªå…ƒç´ èŠ‚ç‚¹
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">ElementNode</span>
      <span class="c1">// æ ‡ç­¾å†…éƒ¨çš„æ‰€æœ‰å†…å®¹åœ¨è§£æä¹‹åä¼šè¢«å½“åšå­èŠ‚ç‚¹å­˜æ”¾åˆ° children[] æ•°ç»„ä¸­
</span><span class="c1"></span>      <span class="c1">// å› æ­¤è¿™é‡Œç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹æ˜¯ä¸ªæ’å€¼æ¨¡æ¿
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">interpolation</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">InterpolationNode</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">interpolation</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
              <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
              <span class="nx">isStatic</span>: <span class="kt">false</span><span class="p">,</span>
              <span class="c1">// The `isConstant` is the default value and will be determined in `transformExpression`.
</span><span class="c1"></span>              <span class="nx">isConstant</span>: <span class="kt">false</span><span class="p">,</span>
              <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;&#34;&lt;/div&gt;&#34;&#39;</span><span class="p">,</span>
              <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
                  <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">8</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">9</span> <span class="p">},</span>
                  <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">16</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">17</span> <span class="p">},</span>
                  <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&#34;&lt;/div&gt;&#34;&#39;</span>
              <span class="p">}</span>
          <span class="p">},</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">5</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">6</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">19</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">20</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;{{ &#34;&lt;/div&gt;&#34; }}&#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-interpolation-03" class="outline-4">
<h4 id="test-interpolation-03">
03-it can have tag-like notation(2)
</h4>
<div id="outline-text-test-interpolation-03" class="outline-text-4">
<p>
è¿™ä¸ªç”¨ä¾‹å…¶å®å’Œ <a href="#test-interpolation-02">ç”¨ä¾‹ 2</a> æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ˜¯è§£æäº†ä¸¤ä¸ªæ’å€¼è€Œå·²ï¼Œå…ˆè§£æ <code class="verbatim">{{ a&lt;b }}</code>
ï¼Œæœ€åå‰©ä¸‹çš„ <code class="verbatim">{{ c&gt;d }}</code> ä¼šåœ¨é€€å‡º <a href="#parse-parseinterpolation">parseInterpolation</a> ä¹‹åå‰©ä½™çš„ context.source
ä¸º <code class="verbatim">{{ c&gt;d }}</code> åœ¨ <a href="#parse-parsechildren">parseChildren</a> é‡Œé¢ç»§ç»­è¿›è¡Œ while å¾ªç¯å¤„
ç†ï¼Œéšåˆæ£€æµ‹åˆ°æ˜¯æ’å€¼å†æ¬¡è°ƒç”¨ <code class="verbatim">parseInterpolation</code> è¿›è¡Œå¤„ç†å¾—åˆ°ç¬¬äºŒä¸ªæ’å€¼èŠ‚ç‚¹ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;it can have tag-like notation (2)&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;{{ a&lt;b }}{{ c&gt;d }}&#39;</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">interpolation1</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">InterpolationNode</span>
      <span class="kr">const</span> <span class="nx">interpolation2</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">InterpolationNode</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">interpolation1</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
              <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
              <span class="nx">content</span><span class="o">:</span> <span class="sb">`a&lt;b`</span><span class="p">,</span>
              <span class="nx">isStatic</span>: <span class="kt">false</span><span class="p">,</span>
              <span class="nx">isConstant</span>: <span class="kt">false</span><span class="p">,</span>
              <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
                  <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">3</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">4</span> <span class="p">},</span>
                  <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">6</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">7</span> <span class="p">},</span>
                  <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;a&lt;b&#39;</span>
              <span class="p">}</span>
          <span class="p">},</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">0</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">1</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">9</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">10</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;{{ a&lt;b }}&#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">interpolation2</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
              <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
              <span class="nx">isStatic</span>: <span class="kt">false</span><span class="p">,</span>
              <span class="nx">isConstant</span>: <span class="kt">false</span><span class="p">,</span>
              <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;c&gt;d&#39;</span><span class="p">,</span>
              <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
                  <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">12</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">13</span> <span class="p">},</span>
                  <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">15</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">16</span> <span class="p">},</span>
                  <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;c&gt;d&#39;</span>
              <span class="p">}</span>
          <span class="p">},</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">9</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">10</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">18</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">19</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;{{ c&gt;d }}&#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="#link-04">æ”¯æŒè¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ğŸ›¬</a></p>
</div>
</div>
<div id="outline-container-test-interpolation-02" class="outline-4">
<h4 id="test-interpolation-02">
02-it can have tag-like notation(1)
</h4>
<div id="outline-text-test-interpolation-02" class="outline-text-4">
<p>
è¯¥ç”¨ä¾‹é‡Œé¢è™½ç„¶æœ‰ <code class="verbatim">&lt;</code> ç¬¦å·ï¼Œä½†æ˜¯ç”±äºæ˜¯åœ¨æ’å€¼å†…éƒ¨ï¼Œä¼šè¿›å…¥ <a href="#parse-parseinterpolation">parseInterpolation</a> ä¹‹å
å°±è¢«è§£ææˆæ’å€¼çš„ sourceï¼Œå¹¶ä¸ä¼šè¿›å…¥ while é‡Œé¢çš„ä½œä¸ºæ ‡ç­¾çš„å¼€å§‹ <code class="verbatim">&lt;</code> æ¥è§£æã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;it can have tag-like notation&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;{{ a&lt;b }}&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">interpolation</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">interpolation</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="sb">`a&lt;b`</span><span class="p">,</span> <span class="c1">// content = preTrimContent.trim() å»æ‰å‰åç©ºæ ¼
</span><span class="c1"></span>        <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">4</span> <span class="p">},</span>
          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">7</span> <span class="p">},</span>
          <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;a&lt;b&#39;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">10</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;{{ a&lt;b }}&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="#link-04">é€šè¿‡è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ğŸ›¬</a></p>
</div>
</div>
<div id="outline-container-test-interpolation-01" class="outline-4">
<h4 id="test-interpolation-01">
01- simple interpolation
</h4>
<div id="outline-text-test-interpolation-01" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;simple interpolation&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;{{message}}&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">interpolation</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">interpolation</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="sb">`message`</span><span class="p">,</span>
        <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span> <span class="c1">// m ä½ç½®
</span><span class="c1"></span>          <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">10</span> <span class="p">},</span> <span class="c1">// æœ€åä¸€ä¸ª e ä½ç½®
</span><span class="c1"></span>          <span class="nx">source</span><span class="o">:</span> <span class="sb">`message`</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="c1">// ç¬¬ä¸€ä¸ª { ä½ç½®
</span><span class="c1"></span>        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">12</span> <span class="p">},</span> <span class="c1">// æœ€åä¸€ä¸ª } ä½ç½®
</span><span class="c1"></span>        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;{{message}}&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-29" class="outline-3">
<h3 id="headline-29">
Text æ–‡æœ¬è§£æ
</h3>
<div id="outline-text-headline-29" class="outline-text-3">
<div id="outline-container-test-text-06" class="outline-4">
<h4 id="test-text-06">
07-only &#34;{{&#34; don\&#39;t separate nodes
</h4>
<div id="outline-text-test-text-06" class="outline-text-4">
<p>
è¿™ä¸ªç”¨ä¾‹æ˜¯ç”¨æ¥æ£€æµ‹æ’å€¼ä¸å®Œæ•´çš„æƒ…å†µï¼Œæ­£å¸¸ä¼šçˆ†å‡º <code class="verbatim">X_MISSING_INTERPOLATION_END</code> å¼‚
å¸¸ï¼Œåœ¨è¯¥ç”¨ä¾‹ä¸­é‡å†™äº†è¯¥å¼‚å¸¸å¤„ç†ï¼Œå› æ­¤ä¸ä¼šæŠ¥é”™ï¼Œç”¨ä¾‹ä¼šå¾ˆé¡ºåˆ©é€šè¿‡ï¼Œå› ä¸ºæ²¡æœ‰å¼‚å¸¸ï¼Œ
<a href="#parse-parseinterpolation">parseInterpolation</a> ä¼šé€€å‡ºï¼Œæœ€å <code class="verbatim">{{</code> ä¼šè¢«å½“åšæ™®é€šæ–‡æœ¬å†…å®¹å¤„ç†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;lonly &#34;{{&#34; don\&#39;t separate nodes&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;a {{ b&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">!==</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_MISSING_INTERPOLATION_END</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="nx">error</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;a {{ b&#39;</span><span class="p">,</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">7</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;a {{ b&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span> <span class="c1">// lonly &#34;{{&#34; don\&#39;t separate nodes
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="#parse-parseInterpolation">parseInterpolation</a> è¯¥ç”¨ä¾‹å¤„ç†ä»£ç ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseInterpolation</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ‰¾å‡ºæ’å€¼æ¨¡æ¿çš„å¼€å§‹å’Œç»“æŸç¬¦å·ï¼Œé»˜è®¤æ˜¯ {{ å’Œ }}
</span><span class="c1"></span>    <span class="kr">const</span> <span class="p">[</span><span class="nx">open</span><span class="p">,</span> <span class="nx">close</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span>
    <span class="kr">const</span> <span class="nx">closeIndex</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">close</span><span class="p">,</span> <span class="nx">open</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">closeIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// è¿™é‡Œæ£€æµ‹åˆ°æ²¡æœ‰ }} é€€å‡ºï¼Œå¹¶ä¸”åˆ°è¿™é‡Œ context æŒ‡é’ˆä¿¡æ¯å¹¶æ²¡æœ‰æ”¹å˜
</span><span class="c1"></span>      <span class="c1">// å› æ­¤é€€å‡ºä¹‹åï¼Œé‡æ–° while æœ€åè¿›å…¥æ–‡æœ¬è§£æ parseText
</span><span class="c1"></span>      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_MISSING_INTERPOLATION_END</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">undefined</span>
    <span class="p">}</span>

    <span class="c1">// ... çœç•¥
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
test:</p>
<pre class="example">
  âœ  packages git:(master) âœ— jest compiler-core
   PASS  compiler-core/__tests__/parse.spec.js (19.233 s)
    compiler: parse
      Text
        âœ“ simple text (5 ms)
        âœ“ simple text with invalid end tag (2 ms)
        âœ“ text with interpolation (1 ms)
        âœ“ text with interpolation which has `&lt;` (1 ms)
        âœ“ text with mix of tags and interpolations (1 ms)
        âœ“ lonly &#34;&lt;&#34; don&#39;t separate nodes (7 ms)
        âœ“ lonly &#34;{{&#34; don&#39;t separate nodes

  Test Suites: 1 passed, 1 total
  Tests:       7 passed, 7 total
  Snapshots:   0 total
  Time:        23.277 s
  Ran all test suites matching /compiler-core/i
</pre>
</div>
</div>
<div id="outline-container-test-text-05" class="outline-4">
<h4 id="test-text-05">
06-only &#34;&lt;&#34; don\&#39;t separate nodes
</h4>
<div id="outline-text-test-text-05" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;lonly &#34;&lt;&#34; don\&#39;t separate nodes&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;a &lt; b&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="o">:</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">!==</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="nx">err</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;a &lt; b&#39;</span><span class="p">,</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">6</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;a &lt; b&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span> <span class="c1">// lonly &#34;&lt;&#34; don\&#39;t separate nodes
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™ä¸ªç”¨ä¾‹åœ¨å®ç°çš„ <a href="#test-text-05">test-05</a> ä¹‹åå°±å¯ä»¥é€šè¿‡ï¼Œå› ä¸º <code class="verbatim">a &lt; b</code> å¹¶ä¸æ˜¯æ’å€¼ä¸€éƒ¨åˆ†ï¼Œä¼šè¢«å½“åš
çº¯æ–‡æœ¬å¤„ç†ï¼Œè€Œä¸ºäº†é¿å…æŠ¥é”™ç”¨ä¾‹ä¸­é‡å†™äº† <code class="verbatim">onError=ï¼Œå› ä¸º while å¾ªç¯é‡Œåœ¨æ£€æµ‹åˆ° =&lt;</code>
å¼€å¤´çš„ if æ¡ä»¶åˆ†æ”¯ä¸­ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸ºç©ºæ ¼çš„æƒ…å†µä¼šè¿›å…¥æœ€åçš„ else åˆ†æ”¯å¤„ç†ï¼Œå³è§¦å‘
<code class="verbatim">INVALID_FIRST_CHARACTER_OF_TAG_NAME</code> å¼‚å¸¸ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... æ ‡ç­¾å¼€å¤´ &lt;...
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_BEFORE_TAG_NAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;!&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO æ³¨é‡Šå¤„ç†ï¼Œ&lt;!-- ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/[a-z]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// ä¼šè¿›å…¥åˆ°è¿™é‡Œï¼Œè§¦å‘å¼‚å¸¸ï¼Œä½†æ˜¯ç”±äº options é‡Œæä¾›äº† onError é‡å†™äº†å®ƒ
</span><span class="c1"></span>      <span class="c1">// å› æ­¤è¿™é‡Œä¸ä¼šè§¦å‘å¼‚å¸¸ï¼Œè€Œæ˜¯é€€å‡ºè¯¥åˆ†æ”¯è¿›å…¥ çº¯æ–‡æœ¬å¤„ç†ï¼Œåˆå¹¶æ–‡æœ¬ pushnode æ“ä½œ
</span><span class="c1"></span>      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-test-text-05" class="outline-4">
<h4 id="test-text-05">
05-text with mix of tags and interpolations
</h4>
<div id="outline-text-test-text-05" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;text with mix of tags and interpolations&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;some &lt;span&gt;{{ foo &lt; bar + foo }} text&lt;/span&gt;&#39;</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">text1</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">TextNode</span>
      <span class="kr">const</span> <span class="nx">text2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">ElementNode</span><span class="p">).</span><span class="nx">children</span><span class="o">!</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">TextNode</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">text1</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;some &#39;</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">0</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">1</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">5</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">6</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;some &#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">text2</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39; text&#39;</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">32</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">33</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">37</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">38</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39; text&#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™æ˜¯ä¸ªæ ‡ç­¾+æ’å€¼æ··åˆæ¨¡æ¿ï¼Œç°é˜¶æ®µçš„ä»£ç æ˜¯é€šä¸è¿‡è¯¥æµ‹è¯•çš„ï¼Œå› ä¸ºå®ƒä¼šè¿›å…¥åˆ°ä¸‹é¢è¿™ä¸ªåˆ†æ”¯ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/[a-z]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???
</span><span class="c1"></span>    <span class="c1">// åˆ°è¿™é‡Œå°±ä¼šæŠ¥é”™
</span><span class="c1"></span>    <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_INVALID_END_TAG</span><span class="p">)</span>
    <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
    <span class="k">continue</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¦‚æ§åˆ¶å°è¾“å‡ºï¼š</p>
<p>
<img src="/img/tmp/1596638044.png" alt="/img/tmp/1596638044.png" title="/img/tmp/1596638044.png" /></p>
<p>
é”™è¯¯ä¸Šé¢çš„è¾“å‡ºå…¶å®æ˜¯ }} å’Œ {{ çš„è§£æä½ç½®ä¿¡æ¯ï¼Œå¹¶ä¸” <code class="verbatim">&lt;div&gt;</code> å¹¶æ²¡æœ‰è§£ææ˜¯å› ä¸ºæˆ‘ä»¬
è¿˜æ²¡å®ç° <a href="#parse-parseelement">parseElement</a> åˆ†æ”¯é€»è¾‘ï¼Œæ‰€ä»¥ç›´æ¥è¿‡æ»¤æ‰å½“æˆæ–‡æœ¬å¤„ç†äº†ã€‚</p>
<ol>
<li>
<p><font color='blue'>å³è¾¹ï¼š offset=14 åˆšå¥½æ˜¯ `some &lt;span&gt;{{ ` å­—ç¬¦ä¸²é•¿åº¦ + 1 å³æ’å€¼å†…ç¬¬ä¸€ä¸ªç©ºæ ¼çš„ä½ç½®</font></p>
</li>
<li>
<p><font color='blue'>å·¦è¾¹ï¼šoffset=29 åˆšå¥½æ˜¯ 14 + `foo &lt; bar + foo` é•¿åº¦ä½ç½®(slice ä¸åŒ…å« endIdx)ï¼Œ å³æ’å€¼å†…æœ€åä¸€ä¸ªç©ºæ ¼çš„ä½ç½®</font></p>
</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¾—çœ‹ä¸‹æ€ä¹ˆä¸æŠ¥é”™èƒ½è§£æ <code class="verbatim">&lt;/div&gt;</code> ã€‚</p>
<p>
<font color='green'>
å¤§æ¦‚çš„çŒœæƒ³æ˜¯åœ¨è§£æ <code class="verbatim">&lt;div&gt;</code> çš„æ—¶å€™å‘ç°æ˜¯æ ‡ç­¾ï¼Œå¯èƒ½ä¼šé‡å†™
<code class="verbatim">onError</code> ï¼Œé¿å…åœ¨è§£æ <code class="verbatim">&lt;/div&gt;</code> è§¦å‘å¼‚å¸¸ï¼Œè€Œæ˜¯è¿›å…¥ <a href="#parse-parsetag">parseTag</a>
è§£æç»“æŸæ ‡ç­¾ã€‚ä½†å¾ˆå¯æƒœä¸æ˜¯è¿™æ ·ï¼Œè€Œæ˜¯åœ¨ <a href="#parse-parselement">parseElement</a> ä¸­é€’å½’
è°ƒç”¨ <a href="#parse-parsechildren">parseChildren</a> è§£ææ ‡ç­¾å†…éƒ¨çš„æ¨¡æ¿ï¼Œè§£æå®Œæˆä¹‹åæ£€æµ‹
ç»“æŸæ ‡ç­¾ï¼Œæ— ç»“æŸæ ‡ç­¾ï¼Œéæ³•å¼‚å¸¸ï¼Œå…·ä½“å®ç°è¯·çœ‹ <a href="#parse-parseelement">parseElement æºç å®
ç°</a>ã€‚
</font></p>
<p>
åœ¨å®ç°äº† <a href="#parse-parseelement">parseElement</a> å’Œéƒ¨åˆ† <a href="#parse-parsetag">parseTag</a> ä¹‹åç”¨ä¾‹é€šè¿‡ï¼š</p>
<pre class="example">
âœ  packages git:(master) âœ— jest compiler-core
 PASS  compiler-core/__tests__/parse.spec.js (14.492 s)
  compiler: parse
    Text
      âœ“ simple text (5 ms)
      âœ“ simple text with invalid end tag (2 ms)
      âœ“ text with interpolation (2 ms)
      âœ“ text with interpolation which has `&lt;` (1 ms)
      âœ“ text with mix of tags and interpolations (2 ms)

Test Suites: 1 passed, 1 total
Tests:       5 passed, 5 total
Snapshots:   0 total
Time:        15.743 s
Ran all test suites matching /compiler-core/i.
</pre>
<p>
æœŸé—´ç¢°åˆ°ä¸ªé—®é¢˜ï¼š</p>
<p>
&gt; Cannot find module &#39;core-js/modules/es6.string.iterator&#39; from &#39;packages/compiler-core/parse.js&#39;</p>
<p>
è§£å†³æ–¹æ¡ˆï¼š<a href="https://github.com/babel/babel/issues/9796">æ˜¯ core-js é™çº§åˆ° 2</a></p>
</div>
</div>
<div id="outline-container-test-text-04" class="outline-4">
<h4 id="test-text-04">
04-text with interpolation which has `&lt;`
</h4>
<div id="outline-text-test-text-04" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;text with interpolation which has `&lt;`&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;some {{ a&lt;b &amp;&amp; c&gt;d }} text&#39;</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">text1</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">TextNode</span>
      <span class="kr">const</span> <span class="nx">text2</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="kr">as</span> <span class="nx">TextNode</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">text1</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;some &#39;</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">0</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">1</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">5</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">6</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;some &#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">text2</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39; text&#39;</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">21</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">22</span> <span class="p">},</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">26</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">27</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39; text&#39;</span>
          <span class="p">}</span>
      <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™ä¸ªç”¨ä¾‹å…¶å®å’Œ <a href="#test-text-03">03-text with interpolation</a> ç”¨ä¾‹åŸç†ä¸€æ ·ï¼Œè™½ç„¶æ’å€¼é‡Œé¢æœ‰ç‰¹æ®Šå­—ç¬¦
<code class="verbatim">&lt;</code> ï¼Œä½†æ˜¯ç”±äºåœ¨ <a href="#parse-parseInterpolation">parseInterpolation</a> å‡½æ•°è§£æè¿‡ç¨‹ä¸­æ˜¯é€šè¿‡æˆªå– {{ åˆ° }} ç›´æ¥çš„å…¨éƒ¨
å­—ç¬¦ä¸²å»è§£æçš„ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">parseInterpolation</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="nx">mode</span>: <span class="kt">TextModes</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">InterpolationNode</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
      <span class="c1">// ... çœç•¥
</span><span class="c1"></span>
      <span class="c1">// ä¹Ÿå°±æ˜¯è¿™ä¸¤è¡Œï¼Œå°† {{ ... }} å†…çš„æ‰€æœ‰å†…å®¹ä¸€æ¬¡æ€§å–å‡ºæ¥è§£æäº†ï¼Œå› æ­¤å¹¶ä¸ä¼š
</span><span class="c1"></span>      <span class="c1">// è¿›å…¥åˆ° parseChildren çš„ while å¾ªç¯ä¸­å¤„ç†ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°å¼‚å¸¸æƒ…å†µ
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">rawContentLength</span> <span class="o">=</span> <span class="nx">closeIndex</span> <span class="o">-</span> <span class="nx">open</span><span class="p">.</span><span class="nx">length</span>
      <span class="kr">const</span> <span class="nx">rawContent</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">rawContentLength</span><span class="p">)</span>

      <span class="c1">// ... çœç•¥
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ‰€ä»¥è¿™ä¸ªç”¨ä¾‹ä¼šå¾ˆé¡ºåˆ©çš„é€šè¿‡(åœ¨ 03 ç”¨ä¾‹é€šè¿‡çš„å‰æä¸‹)ã€‚</p>
<pre class="example">
 PASS  packages/compiler-core/__tests__/parse.spec.js (5.375 s)
  compiler: parse
    Text
      âœ“ simple text (5 ms)
      âœ“ simple text with invalid end tag (3 ms)
      âœ“ text with interpolation (41 ms)
      âœ“ text with interpolation which has `&lt;` (3 ms)
</pre>
</div>
</div>
<div id="outline-container-test-text-03" class="outline-4">
<h4 id="test-text-03">
03-text with interpolation
</h4>
<div id="outline-text-test-text-03" class="outline-text-4">
<p>
<a href="#link-04">è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ -&gt;</a></p>
<p>
è¯¥ç”¨ä¾‹æ£€éªŒçš„å·®å€¼çš„å¤„ç†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;text with interpolation&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s2">&#34;some {{ foo + bar }} text&#34;</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">text1</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">text2</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">text1</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="s2">&#34;some &#34;</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">0</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">1</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s2">&#34;some &#34;</span><span class="p">,</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">5</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">6</span> <span class="p">},</span>
          <span class="p">},</span>
      <span class="p">});</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">text2</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="s2">&#34; text&#34;</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">20</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">21</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="s2">&#34; text&#34;</span><span class="p">,</span>
              <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span>: <span class="kt">25</span><span class="p">,</span> <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">column</span>: <span class="kt">26</span> <span class="p">},</span>
          <span class="p">},</span>
      <span class="p">});</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å·®å€¼çš„å¤„ç†åˆ†æ”¯åœ¨ parseChildren çš„</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="nx">startsWith</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
      <span class="c1">// &#39;{{&#39;
</span><span class="c1"></span>      <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseInterpolation</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å®Œæˆï¼Œå› ä¸ºéœ€è¦ <a href="#parse-parseInterpolation">parseInterpolation()</a> çš„æ”¯æŒã€‚</p>
<p>
ç”¨ä¾‹ç»“æœ(<font color='green'>OK</font> )ï¼š</p>
<pre class="example">
âœ  vue-next-code-read git:(master) âœ— jest parse.spec
 PASS  packages/compiler-core/__tests__/parse.spec.js
  compiler: parse
    Text
      âœ“ simple text (4 ms)
      âœ“ simple text with invalid end tag (2 ms)
      âœ“ text with interpolation (47 ms)

  console.log
    { column: 18, line: 1, offset: 17 } { column: 9, line: 1, offset: 8 } 1

      at parseInterpolation (packages/compiler-core/parse.js:262:11)

Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Snapshots:   0 total
Time:        8.776 s
Ran all test suites matching /parse.spec/i.
âœ  vue-next-code-read git:(master) âœ—
</pre>
</div>
</div>
<div id="outline-container-test-text-02" class="outline-4">
<h4 id="test-text-02">
02-simple text\&lt;div&gt;
</h4>
<div id="outline-text-test-text-02" class="outline-text-4">
<p>
<a href="#link-03">è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥-&gt;</a></p>
<p>
åœ¨è·‘è¿™ä¸ªç”¨ä¾‹çš„æ—¶å€™å‡ºç°å†…å­˜æº¢å‡ºäº†ï¼ŒæŸ¥äº†ä¸‹åŸå› æ˜¯å› ä¸ºåªæ˜¯<a href="#link-02">å¢åŠ äº† while é‡Œé¢çš„å„ç§
if åˆ†æ”¯</a>ï¼Œä½†æ˜¯å®é™…å¹¶æ²¡æœ‰å®ç°ï¼Œè¿™ä¸ªç”¨ä¾‹ä¼šèµ°åˆ°</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;&lt;&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... æ ‡ç­¾å¼€å¤´ &lt;...
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_BEFORE_TAG_NAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;!&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO æ³¨é‡Šå¤„ç†ï¼Œ&lt;!-- ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// &lt;/...
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_BEFORE_TAG_NAME</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;&gt;&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/[a-z]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">// ä¼šèµ°åˆ°è¿™ä¸ªåˆ†æ”¯é‡Œé¢ï¼Œä½†æ˜¯ç”±äºä¸‹é¢çš„ parseTag æœªå®ç°ï¼Œå› æ­¤ä¸€ç›´åœ¨è¿™ä¸ªåˆ†æ”¯é‡Œé¢å¾ªç¯
</span><span class="c1"></span>        <span class="c1">// åŠ ä¸Šç”¨ä¾‹é‡Œé¢é‡å†™äº† onError ä¸ä¼š throw err ç»ˆæ­¢ï¼Œå› æ­¤ä¼šå‡ºç°æ­»å¾ªç¯
</span><span class="c1"></span>        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_INVALID_END_TAG</span><span class="p">);</span>
        <span class="c1">// ä½†æ˜¯ä¸Šé¢éƒ½æŠ¥é”™äº†ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦åŠ ä¸ª parseTag??? æ­£å¸¸ç†è§£åº”è¯¥æ˜¯èµ°ä¸åˆ°è¿™é‡Œå•Š
</span><span class="c1"></span>        <span class="c1">// é™¤éæœ‰é‡å†™ onError æŠ¥é”™æœºåˆ¶???
</span><span class="c1"></span>        <span class="c1">// parseTag(context, TagType.End, parent);
</span><span class="c1"></span>        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å› æ­¤è¦é€šè¿‡è¿™ä¸ªç”¨ä¾‹ï¼Œå°±å¿…é¡»å¾—å®ç° <code class="verbatim">parseTag(context, TagType.End, parent)</code> å‡½æ•°è§£ææ ‡ç­¾ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;simple text with invalid end tag&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">onError</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s2">&#34;some text&lt;/div&gt;&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">onError</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">onError</span><span class="p">).</span><span class="nx">toBeCalled</span><span class="p">();</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s2">&#34;some text&#34;</span><span class="p">,</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">10</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s2">&#34;some text&#34;</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å› ä¸º baseparse è°ƒç”¨çš„æ—¶å€™æœ‰ä¼ é€’ onError è¦†ç›–æŠ¥é”™ä»£ç ï¼Œä¼šè¿›å…¥åˆ° parseTag è¿›è¡Œè§£æ
æ ‡ç­¾ï¼Œå¦‚æœä¸å®ç°ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚å› æ­¤è¿™é‡Œè¦é€šè¿‡è¿™ä¸ªç”¨ä¾‹å°±å¿…é¡»å®ç° <a href="#parse-parsetag">parseTag()</a>:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="c1">// åŒ¹é… &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ &gt; ç»™å¿½ç•¥æ‰???
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kr">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">getNamespace</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
    <span class="c1">// log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div&gt; çš„æœ€æœ‰ä¸€ä¸ª &gt; ä¸Š
</span><span class="c1"></span>    <span class="c1">// åœ¨è¿™é‡Œ context.offset = 10, context.line = 1
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
    <span class="c1">// è¿‡æ»¤æ‰ç©ºæ ¼
</span><span class="c1"></span>    <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="c1">// log2: ç»è¿‡ advance ä¹‹å context.offset = 15, context.line = 1
</span><span class="c1"></span>    <span class="c1">// æ­£å¥½è¿‡æ»¤ &lt;/div 5 ä¸ªå­—ç¬¦
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">currSource</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
parseTag å®ç°åˆ°è¿™é‡Œå°±å¯ä»¥æ»¡è¶³é€šè¿‡æµ‹è¯•ç”¨ä¾‹çš„æ¡ä»¶äº†ï¼Œè¿™é‡Œé¢ä¼šå»åŒ¹é… <code class="verbatim">&lt;/div</code> ç„¶åå°†
å…¶è¿‡æ»¤æ‰(é€šè¿‡ advanceBy å’Œ advanceSpaces æ¥æ”¹å˜ context é‡Œé¢çš„ offset å’Œ line å€¼)ï¼Œ
è¾“å‡ºç»“æœ(log1 å’Œ log2 ä½ç½® context çš„è¾“å‡º)ï¼š</p>
<p>
<img src="/img/tmp/1595444610.png" alt="/img/tmp/1595444610.png" title="/img/tmp/1595444610.png" /></p>
</div>
</div>
<div id="outline-container-test-text-01" class="outline-4">
<h4 id="test-text-01">
01-simple text
</h4>
<div id="outline-text-test-text-01" class="outline-text-4">
<p>
è¿™é‡Œç”¨åˆ°çš„å°±ä¸€ä¸ª baseParse å‡½æ•°ï¼Œéœ€è¦æˆ‘ä»¬æ¥å®ç°å…¶åŸºæœ¬çš„åŠŸèƒ½ä»¥é€šè¿‡è¯¥ç”¨ä¾‹ã€‚</p>
<p>
ç”¨ä¾‹æºç ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;simple text&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">baseParse</span><span class="p">(</span><span class="s1">&#39;some text&#39;</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nx">as</span> <span class="nx">TextNode</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;some text&#39;</span><span class="p">,</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
        <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">10</span> <span class="p">},</span>
        <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;some text&#39;</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/test-01-some-text">ç”¨ä¾‹çš„åŸºæœ¬åŠŸèƒ½ï¼ŒéªŒè¯ baseParse è§£æå‡ºæ¥çš„æ–‡æœ¬èŠ‚ç‚¹å¯¹è±¡æ˜¯å¦æ»¡è¶³åŸºæœ¬è¦æ±‚ã€‚</a></p>
<p>
æ”¯æŒè¯¥ç”¨ä¾‹çš„é‡è¦éƒ¨åˆ†ä»£ç ï¼š</p>
<ol>
<li>
<p>createParseContext æ„å»ºè¢«è§£æçš„å†…å®¹çš„å¯¹è±¡ç»“æ„</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">createParserContext</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="cm">/*ParserContext*/</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">defaultParserOptions</span><span class="p">,</span>
        <span class="p">...</span><span class="nx">options</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="c1">// åˆå§‹åŒ–ä»¥ä¸‹å†…å®¹
</span><span class="c1"></span>      <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">originalSource</span><span class="o">:</span> <span class="nx">context</span><span class="p">,</span>
      <span class="nx">source</span><span class="o">:</span> <span class="nx">context</span><span class="p">,</span>
      <span class="nx">inPref</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">inVPref</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>parseChildren</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseChildren</span><span class="p">(</span>
    <span class="nx">context</span> <span class="cm">/* ParserContext*/</span><span class="p">,</span>
    <span class="nx">mode</span> <span class="cm">/*TextModes*/</span><span class="p">,</span>
    <span class="nx">ancesotrs</span> <span class="cm">/*ElementNode[]*/</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">nodes</span> <span class="cm">/*TemplateChildNode[]*/</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEnd</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">ancesotrs</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// do sth
</span><span class="c1"></span>
      <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">node</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

      <span class="c1">// ç”±äº baseparse é‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ
</span><span class="c1"></span>      <span class="c1">// é¢å»è§£æ
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">||</span> <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RCDATA</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// è¿‡ç•¥æ‰éæ–‡æœ¬çš„
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
          <span class="c1">// ... æ’å€¼å¤„ç†{{}}
</span><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;&lt;&#34;</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// ... æ ‡ç­¾å¼€å¤´ &lt;...
</span><span class="c1"></span>        <span class="p">}</span>

        <span class="c1">// ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°
</span><span class="c1"></span>        <span class="c1">// !node ç»™ parseText è§£æ
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// çº¯æ–‡æœ¬é‡ç‚¹åœ¨è¿™é‡Œé¢å¤„ç†ï¼Œæˆªå–å­—ç¬¦ç›´åˆ°é‡åˆ° &lt;, {{, ]]&gt; æ ‡å¿—ç»“æŸ
</span><span class="c1"></span>        <span class="c1">// ç„¶åä¼ å…¥åˆ° parseTextData() åˆ¤æ–­æ˜¯å¦æ˜¯æ•°æ®ç»‘å®šçš„å˜é‡ï¼Œåœ¨
</span><span class="c1"></span>        <span class="c1">// context.options.decodeEntities() ä¸­å¤„ç†
</span><span class="c1"></span>        <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">removedWhitespace</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">removedWhitespace</span> <span class="o">?</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span> <span class="o">:</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>parseText</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å­—ç¬¦ä¸²è§£æç›´åˆ°é‡åˆ° &lt;, {{, ]]&gt; ä¸ºæ­¢
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">endTokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;&lt;&#34;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">CDATA</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">endTokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;]]&gt;&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">endIndex</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">endTokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">endTokens</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">endIndex</span> <span class="o">&gt;</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">endIndex</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="c1">// è§£æ &amp; å¼€å¤´çš„ html è¯­ä¹‰çš„ç¬¦å·(&gt;,&lt;,&amp;,&#39;,&#34;)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">endIndex</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
      <span class="nx">content</span><span class="p">,</span>
      <span class="c1">// loc:{ start, end, source}
</span><span class="c1"></span>      <span class="c1">// start,end: { line, column, offset }
</span><span class="c1"></span>      <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
    <span class="p">};</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>parseTextData</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// è§£ææ–‡æœ¬æ•°æ®ï¼Œçº¯æ–‡æœ¬å†…å®¹
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">parseTextData</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">rawText</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
    <span class="c1">// è§£ææ¢è¡Œï¼Œæ›´æ–° line, column, offsetï¼Œè¿”å›æ¢è¡Œä¹‹åçš„çš„ source
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RAWTEXT</span> <span class="o">||</span>
        <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">CDATA</span> <span class="o">||</span>
        <span class="nx">rawText</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;&amp;&#34;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">rawText</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">decodeEntities</span><span class="p">(</span>
      <span class="nx">rawText</span><span class="p">,</span>
      <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">ATTRIBUTE_VALUE</span>
    <span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>advancedBy è§£æå¤šä¸ªå­—ç¬¦ä¹‹åæ›´æ–° <code class="verbatim">start,end(line,column,offset)</code> ï¼Œå°¤å…¶æ˜¯æ¢è¡Œç¬¦çš„ç‰¹æ®Šå¤„ç†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">numberOfCharacters</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">source</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
    <span class="nx">advancePositionWithMutation</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">numberOfCharacters</span><span class="p">);</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">numberOfCharacters</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>advancePositionWithMutation</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">advancePositionWithMutation</span><span class="p">(</span>
    <span class="nx">pos</span><span class="p">,</span>
    <span class="nx">source</span><span class="p">,</span>
    <span class="nx">numberOfCharacters</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">length</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">linesCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">lastNewLinePos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numberOfCharacters</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">===</span> <span class="mi">10</span> <span class="cm">/* newline char code */</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">linesCount</span><span class="o">++</span><span class="p">;</span>
        <span class="nx">lastNewLinePos</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">pos</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="nx">numberOfCharacters</span><span class="p">;</span>
    <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">+=</span> <span class="nx">linesCount</span><span class="p">;</span>
    <span class="nx">pos</span><span class="p">.</span><span class="nx">column</span> <span class="o">=</span>
      <span class="nx">lastNewLinePos</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span>
      <span class="o">?</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">column</span> <span class="o">+</span> <span class="nx">numberOfCharacters</span>
      <span class="o">:</span> <span class="nx">numberOfCharacters</span> <span class="o">-</span> <span class="nx">lastNewLinePos</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-funcs" class="outline-2">
<h2 id="parse-funcs">
å‡½æ•°åˆ—è¡¨
</h2>
<div id="outline-text-parse-funcs" class="outline-text-2">
<div id="outline-container-parse-baseparse" class="outline-3">
<h3 id="parse-baseparse">
baseParse(context, options)
</h3>
<div id="outline-text-parse-baseparse" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">baseParse</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">options</span> <span class="cm">/* ParserOptions */</span><span class="p">)</span> <span class="cm">/*RootNode*/</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">createParserContext</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">createRoot</span><span class="p">(</span>
      <span class="nx">parseChildren</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span><span class="p">,</span> <span class="p">[]),</span>
      <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
baseParse å†…éƒ¨å®ç°åŸºæœ¬å°±æ˜¯è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å¾—é’ˆå¯¹å®ƒä½¿ç”¨çš„å‡ ä¸ªæ–¹æ³•å»é€ä¸€å®ç°ï¼š</p>
<ol>
<li>
<p><a href="#parse-createparsecontext">createParserContext</a>ï¼Œåˆ›å»ºèŠ‚ç‚¹è§£æå¯¹è±¡ï¼ŒåŒ…å«è§£æè¿‡ç¨‹ä¸­éœ€è¦æˆ–éœ€è¦ä¿å­˜çš„æ•°æ®</p>
</li>
<li>
<p><a href="#parse-getcursor">getCursor</a>ï¼Œè·å– context ä¸­çš„ offset, line, column, start, end ç­‰ä¿¡æ¯</p>
</li>
<li>
<p><a href="vue/vue3-source-code-compiler-core-ast_ts/#ast-createroot">createRoot</a>ï¼Œåˆ›å»ºæ ¹èŠ‚ç‚¹</p>
</li>
<li>
<p><a href="#parse-parsechildren">parseChildren</a>ï¼Œè§£æå­èŠ‚ç‚¹</p>
</li>
<li>
<p><a href="#parse-getselection">getSelection</a>ï¼Œè·å–é€‰ä¸­çš„æœªè§£æçš„å†…å®¹</p>
</li>
</ol>
<p><a href="#parse-baseparse">baseParse</a> å‡½æ•°å¤§ä½“ç»“æ„å’Œä»£ç è°ƒç”¨å›¾ç¤ºï¼š</p>
<p>
<img src="/img/vue3/compiler-core/functions/parse-ts-baseparse-0.png" alt="/img/vue3/compiler-core/functions/parse-ts-baseparse-0.png" title="/img/vue3/compiler-core/functions/parse-ts-baseparse-0.png" /></p>
</div>
</div>
<div id="outline-container-parse-createparsecontext" class="outline-3">
<h3 id="parse-createparsecontext">
createParseContext(context, options)
</h3>
<div id="outline-text-parse-createparsecontext" class="outline-text-3">
<p>
å‡½æ•°ä½œç”¨ï¼š*åˆ›å»ºè§£æå™¨ä¸Šä¸‹æ–‡å¯¹è±¡(åŒ…å«è§£æè¿‡ç¨‹ä¸­çš„ä¸€äº›è®°å½•ä¿¡æ¯)*</p>
<p>
å‡½æ•°å£°æ˜ï¼š</p>
<p>
<code class="verbatim">function createParserContext(context, options) /*ParserContext*/ {}</code></p>
<p>
å‚æ•°æ²¡ä»€ä¹ˆå¥½è®²çš„äº†ï¼Œä» baseParse ç»§æ‰¿è€Œæ¥ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª <a href="#td-parser-context">ParserContext</a> ç±»å‹ã€‚å…·ä½“
å®ç°å…¶å®å°±æ˜¯è¿”å›ä¸€ä¸ª ParserContext ç±»å‹çš„å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†æºç å­—ç¬¦ä¸²è¢«è§£ææ˜¯çš„ä¸€
äº›ä¿¡æ¯å­˜å‚¨ï¼Œæ¯”å¦‚ï¼šè§£ææ—¶æŒ‡é’ˆçš„ä½ç½® offsetï¼Œå½“å‰è¡Œåˆ—(line, column)ï¼ŒåŠå…¶ä»–ä¿¡æ¯ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">createParserContext</span><span class="p">(</span>
      <span class="nx">content</span>: <span class="kt">string</span><span class="p">,</span>
      <span class="nx">options</span>: <span class="kt">ParserOptions</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">ParserContext</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
          <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
              <span class="c1">// è§£æå™¨çš„é»˜è®¤é€‰é¡¹ç»™äº†äº›é»˜è®¤å€¼ï¼Œæ¯”å¦‚ï¼šisVoidTag: No, isPreTag: NOï¼Œ ç­‰ç­‰
</span><span class="c1"></span>              <span class="p">...</span><span class="nx">defaultParserOptions</span><span class="p">,</span>
              <span class="p">...</span><span class="nx">options</span>
          <span class="p">},</span>
          <span class="nx">column</span>: <span class="kt">1</span><span class="p">,</span>
          <span class="nx">line</span>: <span class="kt">1</span><span class="p">,</span>
          <span class="nx">offset</span>: <span class="kt">0</span><span class="p">,</span>
          <span class="nx">originalSource</span>: <span class="kt">content</span><span class="p">,</span>
          <span class="nx">source</span>: <span class="kt">content</span><span class="p">,</span>
          <span class="nx">inPre</span>: <span class="kt">false</span><span class="p">,</span>
          <span class="nx">inVPre</span>: <span class="kt">false</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-parsechildren" class="outline-3">
<h3 id="parse-parsechildren">
parseChildren(context, mode, ancestors)
</h3>
<div id="outline-text-parse-parsechildren" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseChildren</span><span class="p">(</span>
    <span class="nx">context</span> <span class="cm">/* ParserContext*/</span><span class="p">,</span>
    <span class="nx">mode</span> <span class="cm">/*TextModes*/</span><span class="p">,</span>
    <span class="nx">ancesotrs</span> <span class="cm">/*ElementNode[]*/</span>
  <span class="p">)</span> <span class="cm">/* TemplateChildNode[] */</span><span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å‚æ•°åˆ—è¡¨ï¼š</p>
<ol>
<li>
<p>contextï¼Œå¾…è§£æçš„æ¨¡æ¿å¯¹è±¡(<a href="#td-parser-context">ParserContext</a>)</p>
</li>
<li>
<p>modeï¼Œæ–‡æœ¬æ¨¡å¼(<a href="#td-vars-textmodes">TextModes</a>)</p>
</li>
<li>
<p>ancestorsï¼Œç¥–å…ˆå…ƒç´ (<a href="#td-ast-elementnode">ElementNode[]â€‹</a>)</p>
</li>
</ol>
<p>è¿”å›ç»“æœï¼š <a href="/vue/vue3-source-code-compiler-core-ast_ts/#td-ast-tcn">TemplateChildNode[]â€‹</a></p>
<div id="outline-container-headline-41" class="outline-4">
<h4 id="headline-41">
é˜¶æ®µä¸€(<a href="#test-01-sometext">test01 some text</a>)
</h4>
<div id="outline-text-headline-41" class="outline-text-4">
<p>
å®ç° <a href="#parse-parsetext">parseText()</a> ä¹‹åçš„ <a href="#parse-parsechildren">parseChildren() </a>ä»£ç ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseChildren</span><span class="p">(</span>
    <span class="nx">context</span> <span class="cm">/* ParserContext*/</span><span class="p">,</span>
    <span class="nx">mode</span> <span class="cm">/*TextModes*/</span><span class="p">,</span>
    <span class="nx">ancesotrs</span> <span class="cm">/*ElementNode[]*/</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">nodes</span> <span class="cm">/*TemplateChildNode[]*/</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEnd</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">ancesotrs</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// do sth
</span><span class="c1"></span>
      <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">node</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

      <span class="c1">// ç”±äº baseparseé‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ
</span><span class="c1"></span>      <span class="c1">// é¢å»è§£æ
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">||</span> <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RCDATA</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// è¿‡ç•¥æ‰éæ–‡æœ¬çš„
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
          <span class="c1">// ... æ’å€¼å¤„ç†{{}}
</span><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;&lt;&#34;</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// ... æ ‡ç­¾å¼€å¤´ &lt;...
</span><span class="c1"></span>        <span class="p">}</span>

        <span class="c1">// ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°
</span><span class="c1"></span>        <span class="c1">// !node ç»™ parseText è§£æ
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="s2">&#34;parse children&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">removedWhitespace</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">removedWhitespace</span> <span class="o">?</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span> <span class="o">:</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æœ€åå¤„ç†å®Œä¹‹åæ–‡æœ¬èŠ‚ç‚¹å¯¹è±¡å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="p">{</span>
    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">delimiters</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;{{&#39;</span><span class="p">,</span> <span class="s1">&#39;}}&#39;</span> <span class="p">],</span>
      <span class="nx">getNamespace</span><span class="o">:</span> <span class="p">[</span><span class="nb">Function</span><span class="o">:</span> <span class="nx">getNamespace</span><span class="p">],</span>
      <span class="nx">getTextMode</span><span class="o">:</span> <span class="p">[</span><span class="nb">Function</span><span class="o">:</span> <span class="nx">getTextMode</span><span class="p">],</span>
      <span class="nx">isVoidTag</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">isPreTag</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">isCustomElement</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">decodeEntities</span><span class="o">:</span> <span class="p">[</span><span class="nb">Function</span><span class="o">:</span> <span class="nx">decodeEntities</span><span class="p">],</span>
      <span class="nx">onError</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">},</span>
    <span class="c1">// è¿™é‡Œå‘ç”Ÿäº†å˜æ¢
</span><span class="c1"></span>    <span class="c1">// column: å®šä½åˆ°äº†å­—ç¬¦ä¸²æœ€åå³ &#39;simple text&#39; çš„é•¿åº¦ + 1ï¼Œå³ç»“æŸä½ç½®
</span><span class="c1"></span>    <span class="c1">// line: å› ä¸ºåªæœ‰ä¸€è¡Œï¼Œæ‰€ä»¥ line å¹¶æœªå‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœå‘ç”Ÿäº†æ”¹å˜ä¼šåœ¨ advancedBy é‡Œé¢è¿›è¡Œå¤„ç†æ›´æ–°
</span><span class="c1"></span>    <span class="c1">// offset: ç±»ä¼¼æ–‡ä»¶å¤„ç†æ—¶çš„æŒ‡é’ˆåç§»é‡ï¼Œå³å­—ç¬¦ä¸²é•¿åº¦
</span><span class="c1"></span>    <span class="nx">column</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">offset</span><span class="o">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="c1">// ä¼šå‘ç°å¤„ç†å®Œæˆä¹‹åï¼ŒoriginalSource ç»´æŒåŸæ ·
</span><span class="c1"></span>    <span class="nx">originalSource</span><span class="o">:</span> <span class="s1">&#39;simple text&#39;</span><span class="p">,</span>
    <span class="c1">// source å˜æˆäº†ç©ºå­—ç¬¦ä¸²ï¼Œå› ä¸ºå¤„ç†å®Œäº†
</span><span class="c1"></span>    <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">inPref</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">inVPref</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">}</span> <span class="c1">// parse children
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="#parse-baseparse">baseParse</a> ä¹‹åçš„ ast ç»“æ„ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// è¿™ä¸ªç»“æ„çš„å½¢æˆæ˜¯ç»è¿‡ createRoot å¤„ç†ä¹‹åçš„ç»“æœ
</span><span class="c1"></span>  <span class="c1">// ç»è¿‡ parseChildren ä¹‹åçš„ç»“æœä¼šè¢«å­˜æ”¾åˆ° root çš„children ä¸­ï¼Œå¦‚ä¸‹
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">children</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;\nsimple text 1\n simple text 2\n&#39;</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">30</span> <span class="p">},</span>
      <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;\nsimple text 1\n simple text 2\n&#39;</span>
    <span class="p">},</span>
    <span class="nx">helpers</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">components</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">directives</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">hoists</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">imports</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">cached</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">temps</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span>
  <span class="p">}</span> <span class="c1">//// ast
</span><span class="c1"></span>
  <span class="c1">// ç¬¬ä¸€ä¸ª children ç»“æ„ï¼š
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;\nsimple text 1\n simple text 2\n&#39;</span><span class="p">,</span>
    <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">start</span><span class="o">:</span> <span class="p">{</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="nx">end</span><span class="o">:</span> <span class="p">{</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">line</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">offset</span><span class="o">:</span> <span class="mi">30</span> <span class="p">},</span>
      <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;\nsimple text 1\n simple text 2\n&#39;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">//// ast
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é˜¶æ®µä»£ç ï¼š<a href="#link-01">test-01-some-text æµ‹è¯•ç”¨ä¾‹é€šè¿‡</a></p>
<p>
å›¾ç¤ºï¼šæ–‡æœ¬è§£æ</p>
<p>
<img src="/img/vue3/compiler-core/functions/parse-ts-parsechildren-text-part.png" alt="/img/vue3/compiler-core/functions/parse-ts-parsechildren-text-part.png" title="/img/vue3/compiler-core/functions/parse-ts-parsechildren-text-part.png" /></p>
</div>
</div>
<div id="outline-container-headline-42" class="outline-4">
<h4 id="headline-42">
é˜¶æ®µäºŒ(<a href="#test-element-12">&lt;div â€¦&gt;&lt;/div&gt;\n&lt;div â€¦&gt;&lt;/div&gt;</a>)
</h4>
<div id="outline-text-headline-42" class="outline-text-4">
<p>
å¢åŠ ç©ºè¡ŒèŠ‚ç‚¹è¿‡æ»¤ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseChildren</span><span class="p">(</span>
    <span class="nx">context</span> <span class="cm">/* ParserContext*/</span><span class="p">,</span>
    <span class="nx">mode</span> <span class="cm">/*TextModes*/</span><span class="p">,</span>
    <span class="nx">ancestors</span> <span class="cm">/*ElementNode[]*/</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="nx">ancestors</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">parent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">ns</span> <span class="o">:</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">nodes</span> <span class="cm">/*TemplateChildNode[]*/</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEnd</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// do sth
</span><span class="c1"></span>
      <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">node</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

      <span class="c1">// ç”±äº baseparseé‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ
</span><span class="c1"></span>      <span class="c1">// é¢å»è§£æ
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">||</span> <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RCDATA</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// è¿‡ç•¥æ‰éæ–‡æœ¬çš„
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
          <span class="c1">// ... æ’å€¼å¤„ç†{{}}
</span><span class="c1"></span>          <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseInterpolation</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;&lt;&#34;</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// ... æ ‡ç­¾å¼€å¤´ &lt;...
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_BEFORE_TAG_NAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;!&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// TODO æ³¨é‡Šå¤„ç†ï¼Œ&lt;!-- ...
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;&lt;!--&#34;</span><span class="p">))</span> <span class="p">{</span>
              <span class="c1">// æ™®é€šçš„ html æ³¨é‡Š
</span><span class="c1"></span>              <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseComment</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// &lt;/...
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_BEFORE_TAG_NAME</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;&gt;&#34;</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// &lt;/&gt; ä¸å¸¦æ ‡ç­¾åçš„æ— æ•ˆæ ‡ç­¾
</span><span class="c1"></span>              <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">MISSING_END_TAG_NAME</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
              <span class="c1">// è¿‡æ»¤æ‰ &lt;/&gt; è¿™ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼Œoffset&gt;&gt;3 é€€å‡ºæœ¬æ¬¡å¾ªç¯ç»§ç»­è§£æ
</span><span class="c1"></span>              <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
              <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/[a-z]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
              <span class="c1">// è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???
</span><span class="c1"></span>              <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_INVALID_END_TAG</span><span class="p">);</span>
              <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
              <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">emitError</span><span class="p">(</span>
                <span class="nx">context</span><span class="p">,</span>
                <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="p">,</span>
                <span class="mi">2</span>
              <span class="p">);</span>
              <span class="c1">// node = parseBogusComment(context)
</span><span class="c1"></span>            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/[a-z]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// è§£æèµ·å§‹æ ‡ç­¾ï¼Œå³è¿™é‡Œæ‰æ˜¯æ ‡ç­¾æœ€å¼€å§‹çš„ä½ç½®ã€‚
</span><span class="c1"></span>            <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseElement</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;?&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// &lt;? å¼€å§‹çš„
</span><span class="c1"></span>            <span class="nx">emitError</span><span class="p">(</span>
              <span class="nx">context</span><span class="p">,</span>
              <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME</span><span class="p">,</span>
              <span class="mi">1</span>
            <span class="p">);</span>
            <span class="c1">// node = parseBogusComment(context)
</span><span class="c1"></span>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// å…¶ä»–æƒ…å†µéƒ½è§†ä¸ºéæ³•
</span><span class="c1"></span>            <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°
</span><span class="c1"></span>        <span class="c1">// !node ç»™ parseText è§£æ
</span><span class="c1"></span>      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">nodes</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">removedWhitespace</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="c1">// TODO ç©ºæ ¼ç®¡ç†ï¼Œä¸ºäº†æ›´é«˜æ•ˆçš„è¾“å‡º
</span><span class="c1"></span>    <span class="c1">// `\n&lt;div&gt;...` åˆ é™¤å¼€å¤´çš„ç©ºæ ¼å­—ç¬¦ï¼Œä¹‹å‰è§£æ v-pre ç”¨ä¾‹æ˜¯å¡åœ¨è¿™é‡Œäº†
</span><span class="c1"></span>    <span class="c1">// è¿™é‡Œå¿˜è®°å®ç°äº†ï¼Œæ‰€ä»¥ç”¨ä¾‹ http://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/#headline-3
</span><span class="c1"></span>    <span class="c1">// å¾—åˆ°äº†ä¸‰ä¸ª childï¼Œç¬¬äºŒä¸ªæ˜¯ \nï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œæ²¡å®ç°è¿‡æ»¤
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">!==</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RAWTEXT</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inPre</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/[^\t\r\n\f ]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">))</span> <span class="p">{</span>
              <span class="kr">const</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
              <span class="kr">const</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
              <span class="c1">// 1. ç©ºæ ¼æ˜¯ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…
</span><span class="c1"></span>              <span class="c1">// 2. ç©ºæ ¼ä¸æ³¨é‡ŠèŠ‚ç‚¹ç›¸é‚»
</span><span class="c1"></span>              <span class="c1">// 3. ç©ºæ ¼åœ¨ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œå°±æˆ‘ä»¬é‡åˆ°çš„ &lt;div&gt;&lt;/div&gt;\n&lt;div&gt;...
</span><span class="c1"></span>              <span class="c1">// ä¸Šé¢ä¸‰ç§æƒ…å†µçš„ç©ºæ ¼ä¼šè¢«å¿½ç•¥
</span><span class="c1"></span>              <span class="k">if</span> <span class="p">(</span>
                <span class="o">!</span><span class="nx">prev</span> <span class="o">||</span>
                  <span class="o">!</span><span class="nx">next</span> <span class="o">||</span>
                  <span class="nx">prev</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span> <span class="o">||</span>
                  <span class="nx">next</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span> <span class="o">||</span>
                  <span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span>
                   <span class="nx">next</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span>
                   <span class="sr">/[\r\n]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">))</span>
              <span class="p">)</span> <span class="p">{</span>
                <span class="nx">removedWhitespace</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// å¦åˆ™æ›¿æ¢æˆç©ºæ ¼
</span><span class="c1"></span>                <span class="nx">node</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// æ›¿æ¢æˆç©ºæ ¼
</span><span class="c1"></span>              <span class="nx">node</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\t\r\n\f ]+/g</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">isPreTag</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">//å¦‚æœæ˜¯ &lt;pre&gt; åˆ æ‰ç¬¬ä¸€è¡Œçš„ç©ºè¡Œ
</span><span class="c1"></span>        <span class="kr">const</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="nx">first</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">first</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">first</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\r?\n/</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">removedWhitespace</span> <span class="o">?</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span> <span class="o">:</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-parsecomment" class="outline-3">
<h3 id="parse-parsecomment">
parseComment(context)
</h3>
<div id="outline-text-parse-parsecomment" class="outline-text-3">
<p>
æ³¨é‡Šå¤„ç†å‡½æ•°ï¼Œè§£æåŸåˆ™æ˜¯åŒ¹é… <code class="verbatim">&lt;!--</code> å¼€å¤´å’Œ <code class="verbatim">--&gt;</code> ç»“å°¾ï¼Œä¸­é—´éƒ¨åˆ†ç»Ÿç»Ÿè§†ä¸ºæ³¨é‡Šï¼Œä¸­
é—´éœ€è¦è€ƒè™‘åµŒå¥—æ³¨é‡Šé—®é¢˜ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseComment</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="cm">/* CommentNode */</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">content</span>

    <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/--(\!)?&gt;/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// æ²¡æœ‰é—­åˆæ³¨é‡Šï¼Œåé¢çš„æ‰€æœ‰éƒ½ä¼šè¢«å½“åšæ³¨é‡Šå¤„ç†
</span><span class="c1"></span>      <span class="nx">content</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="c1">// åé¢æ‰€æœ‰çš„éƒ½æˆä¸ºæ³¨é‡Š
</span><span class="c1"></span>      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_COMMENT</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ç©ºæ³¨é‡Šä¹ŸæŠ¥é”™
</span><span class="c1"></span>        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">ABRUPT_CLOSING_OF_EMPTY_COMMENT</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="c1">// éæ³•ç»“æŸï¼Œæ¯”å¦‚ï¼š &lt;!-xx--!&gt;ï¼Œæ­£åˆ™é‡Œé¢æœ‰ä¸ª (\!)? æ•è·ç»„
</span><span class="c1"></span>      <span class="c1">// match[1] å°±æ˜¯æŒ‡è¿™ä¸ªåŒ¹é…
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">INCORRECTLY_CLOSED_COMMENT</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="c1">// å–æ³¨é‡Šå†…å®¹ï¼Œmatch.index å³ /--(\!)?&gt;/ æ­£åˆ™åŒ¹é…çš„å¼€å§‹ç´¢å¼•ä½ç½®
</span><span class="c1"></span>      <span class="nx">content</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>

      <span class="c1">// åµŒå¥—æ³¨é‡Š??? è¿™é‡Œslice ä¹‹åçš„ s ä¸åŒ…å«ç»“æŸ --&gt;
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">prevIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">nestedIndex</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">s</span> <span class="p">})</span>
      <span class="c1">// é¦–å…ˆèƒ½è¿›å…¥ parseCommentï¼Œè¯´æ˜ source æ˜¯ä»¥ &lt;!-- å¼€å¤´çš„ï¼Œä¸”æ˜¯åŒ…å« --&gt; çš„
</span><span class="c1"></span>      <span class="c1">// å¦åˆ™å‰é¢å°±ä¼šå‡ºç°å¼‚å¸¸ï¼Œå› æ­¤å¦‚æœåµŒå¥—é‚£å¯èƒ½æƒ…å†µåªæœ‰&lt;!--x&lt;!--y--&gt;æ³¨é‡Šä¸­é—´
</span><span class="c1"></span>      <span class="c1">// å‡ºç°è¿‡ &lt;!--
</span><span class="c1"></span>      <span class="k">while</span> <span class="p">((</span><span class="nx">nestedIndex</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">,</span> <span class="nx">prevIndex</span><span class="p">))</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">nestedIndex</span><span class="p">,</span> <span class="nx">prevIndex</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">len</span><span class="o">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="p">})</span>
        <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">nestedIndex</span> <span class="o">-</span> <span class="nx">prevIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1">// + 4 å€¼æ˜¯ `&lt;!--`.lengthï¼Œå¦‚æœå°äº s.lengthï¼Œè¯´æ˜åµŒå¥—äº†æ³¨é‡Š
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">nestedIndex</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// éæ³•åµŒå¥—, å¦‚ï¼š&lt;!--&lt;!--x--&gt;
</span><span class="c1"></span>          <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">NESTED_COMMENT</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">/// ç„¶åå®šä½åˆ°åµŒå¥—çš„ç¬¬ä¸€ä¸ª &lt;!-- çš„ ! ç´¢å¼•ä¸Šï¼Œè¿›å…¥ä¸‹ä¸€è½®å¤„ç†ï¼Œç›´
</span><span class="c1"></span>        <span class="c1">// åˆ°æ‰¾åˆ°æœ€åä¸€ä¸ªåˆæ³•çš„ &lt;!--
</span><span class="c1"></span>        <span class="nx">prevIndex</span> <span class="o">=</span> <span class="nx">nestedIndex</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="p">}</span>

      <span class="c1">// è¿™é‡Œåº”è¯¥æ˜¯æ²¡åµŒå¥—çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ
</span><span class="c1"></span>      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">prevIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">,</span>
      <span class="nx">content</span><span class="p">,</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-parseelement" class="outline-3">
<h3 id="parse-parseelement">
parseElement(context, mode)
</h3>
<div id="outline-text-parse-parseelement" class="outline-text-3">
<p>
è¿™ä¸ªè§£æå‡½æ•°ï¼Œç”¨æ¥è§£æ <code class="verbatim">&lt;div&gt;</code> æ ‡ç­¾ã€‚</p>
<div id="outline-container-headline-45" class="outline-4">
<h4 id="headline-45">
é˜¶æ®µä¸€(<a href="#test-text-05">test-05</a>)
</h4>
<div id="outline-text-headline-45" class="outline-text-4">
<p>
<a href="#test-text-05">some \&lt;span&gt;{{ foo &lt; bar + foo }} text\&lt;/span&gt;</a></p>
<p>
æ­¤é˜¶æ®µåªå®ç°å¯¹ <code class="verbatim">&lt;div&gt;...&lt;/div&gt;</code> çš„è§£æï¼Œä¸åŒ…å«å±æ€§ç­‰ç­‰å…¶ä»–å¤æ‚æƒ…å†µï¼Œå› ä¸ºåªéœ€è¦èƒ½
é€šè¿‡ç”¨ä¾‹ 5 å°±è¡Œã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseElement</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// assert context.source æ˜¯ä»¥ &lt;[a-z] å¼€å¤´çš„
</span><span class="c1"></span>
    <span class="kr">const</span> <span class="nx">wasInPre</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">inPre</span>
    <span class="kr">const</span> <span class="nx">wasInVPre</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span>
    <span class="c1">// å– ancestors æœ€åä¸€ä¸ªèŠ‚ç‚¹ node
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="nx">ancestors</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">Start</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>

    <span class="c1">// pre or v-pre
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isPreBoundary</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">inPre</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">wasInVPre</span>
    <span class="kr">const</span> <span class="nx">isVPreBoundary</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">wasInVPre</span>

    <span class="c1">// è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">isSelfClosing</span> <span class="o">||</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">isVoidTag</span><span class="o">?</span><span class="p">.(</span><span class="nx">element</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">element</span>
    <span class="p">}</span>

    <span class="c1">// å­å…ƒç´  childrenï¼Œè¢«æ¼æ‰çš„ä»£ç ï¼Œä¼šè¿›å…¥é€’å½’è°ƒç”¨ parseChildren å»è§£æ
</span><span class="c1"></span>    <span class="c1">// &lt;span&gt;...&lt;/span&gt; æ ‡ç­¾å†…çš„æ¨¡æ¿
</span><span class="c1"></span>    <span class="nx">ancestors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">getTextMode</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">parseChildren</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">)</span>

    <span class="nx">ancestors</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">children</span>
    <span class="c1">// P1.... è§£æä¹‹å children é‡Œé¢åº”è¯¥åŒ…å«ä¸¤ä¸ª node
</span><span class="c1"></span>    <span class="c1">// node1: æ’å€¼å†…å®¹ `foo &lt; bar + foo`
</span><span class="c1"></span>    <span class="c1">// node2: æ–‡æœ¬èŠ‚ç‚¹ ` text`
</span><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>

    <span class="c1">// ç»“æŸæ ‡ç­¾ï¼Ÿ &lt;span&gt;&lt;/span&gt; è¿™ç§ç±»å‹ï¼Ÿ
</span><span class="c1"></span>    <span class="c1">// ä¸Šé¢ä¼šè§£ææ ‡ç­¾å†…çš„æ¨¡æ¿ï¼Œè§£æå®Œä¹‹å source æ­£å¸¸åº”è¯¥ä¼šæ˜¯ `&lt;/span&gt; ....`
</span><span class="c1"></span>    <span class="c1">// è¿›å…¥ if è§£æç»“æŸæ ‡ç­¾
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// ä¼šè¿›å…¥åˆ°è¿™é‡Œå‡ºç°æŠ¥é”™
</span><span class="c1"></span>      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_MISSING_END_TAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;script&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="nx">first</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">loc</span> <span class="o">=</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isPreBoundary</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">inPre</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isVPreBoundary</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">element</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å®ç°åˆ°è¿™é‡Œæ˜¯ä¸ºäº†æƒ³çœ‹ä¸‹ç»è¿‡ <a href="#parse-parsetag">parseTag</a> ä¹‹åçš„ element æ˜¯ä»€ä¹ˆï¼ŸparseTag é‡Œé¢æœ‰ä¸ªæ­£åˆ™
æ˜¯ç”¨æ¥åŒ¹é…å¼€å§‹æˆ–ç»“æŸæ ‡ç­¾çš„ï¼Œå³ï¼š <code class="verbatim">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i</code> è¿™ä¸ªæ—¢å¯ä»¥åŒ¹é…
å¼€å§‹æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥åŒ¹é…ç»“æŸæ ‡ç­¾ï¼Œå¹¶ä¸”è€ƒè™‘äº† <code class="verbatim">&lt;div &gt;</code> æœ‰ç©ºæ ¼çš„æƒ…å†µï¼Œå¿½ç•¥å¤§å°å†™ã€‚</p>
<p>
æ­£åˆ™åŒ¹é…æµ‹è¯•ç»“æœï¼š</p>
<pre class="example">
/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i.exec(&#39;&lt;span&gt;&#39;)
(2)Â [&#34;&lt;span&#34;, &#34;span&#34;, index: 0, input: &#34;&lt;span&gt;&#34;, groups: undefined]
</pre>
<p>
æ‰€ä»¥è¿™é‡Œé¦–å…ˆåŒ¹é…è§£æçš„æ˜¯å¼€å§‹æ ‡ç­¾ <code class="verbatim">&lt;div&gt;</code> ã€‚</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="err">//</span> <span class="err">some</span> <span class="err">&lt;span&gt;</span><span class="p">{</span><span class="err">{</span> <span class="err">foo</span> <span class="err">&lt;</span> <span class="err">bar</span> <span class="err">+</span> <span class="err">foo</span> <span class="p">}</span><span class="err">}</span> <span class="err">text&lt;/span&gt;</span>
  <span class="err">//</span> <span class="err">parseTag</span> <span class="err">ä¹‹åçš„</span> <span class="err">element</span>
  <span class="p">{</span>
    <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="err">//</span> <span class="err">èŠ‚ç‚¹ç±»å‹æ˜¯</span> <span class="err">NodeTypes.ELEMENT</span>
    <span class="nt">&#34;ns&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="err">//</span> <span class="err">å‘½åç©ºé—´å°±æ˜¯</span> <span class="err">HTML</span>
    <span class="nt">&#34;tag&#34;</span><span class="p">:</span><span class="s2">&#34;span&#34;</span><span class="p">,</span>
    <span class="nt">&#34;tagType&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="err">//</span> <span class="err">æ ‡ç­¾ç±»å‹</span> <span class="err">ElementTypes.ELEMENT</span>
    <span class="nt">&#34;props&#34;</span><span class="p">:[</span> <span class="err">//</span> <span class="err">æ ‡ç­¾å±æ€§ï¼Œè¿™é‡Œæ²¡æœ‰</span>
    <span class="p">],</span>
    <span class="nt">&#34;isSelfClosing&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span> <span class="err">//</span> <span class="err">æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œå¦‚ï¼š&lt;img/&gt;</span>
    <span class="nt">&#34;children&#34;</span><span class="p">:[],</span>
    <span class="nt">&#34;loc&#34;</span><span class="p">:{</span>
      <span class="nt">&#34;start&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="err">//</span> <span class="err">column</span> <span class="err">ä¸æ¢è¡Œçš„æƒ…å†µä¸‹ä¸º</span> <span class="err">offset</span> <span class="err">+</span> <span class="err">1ï¼Œä»</span> <span class="err">1</span> <span class="err">å¼€å§‹è®¡æ•°</span>
        <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="err">//</span> <span class="err">æ²¡æ¢è¡Œç¬¦</span>
        <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">5</span> <span class="err">//</span> <span class="err">&lt;span&gt;</span> <span class="err">çš„</span> <span class="err">&lt;</span> <span class="err">å¼€å§‹ä½ç½®ç´¢å¼•</span> <span class="err">`some</span> <span class="err">`.length</span> <span class="err">=</span> <span class="mi">5</span>
      <span class="p">},</span>
      <span class="nt">&#34;end&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
        <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="err">//</span> <span class="err">è¿™é‡Œå€¼çš„å˜åŒ–åˆ†ä¸¤æ­¥</span>
        <span class="err">//</span> <span class="err">parseTag:start</span> <span class="err">çš„æ—¶å€™</span>
        <span class="err">//</span> <span class="err">1.</span> <span class="err">è§£æå‡º</span> <span class="err">&lt;span</span> <span class="err">ï¼Œè¿™ä¸ªæ—¶å€™</span> <span class="err">offset</span> <span class="err">å…¶å®æ˜¯</span> <span class="err">10</span>
        <span class="err">//</span> <span class="err">2.</span> <span class="err">æ£€æµ‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œå†³å®š</span> <span class="err">advancedBy</span>
        <span class="err">//</span> <span class="err">ç§»åŠ¨æŒ‡é’ˆä½ç½®æ•°(è‡ªé—­åˆï¼š2ï¼Œéè‡ªé—­åˆï¼š1)ï¼Œåˆ°è¿™é‡Œ</span> <span class="err">offset</span> <span class="err">=</span> <span class="err">11</span>
        <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">11</span>
      <span class="p">},</span>
      <span class="nt">&#34;source&#34;</span><span class="p">:</span><span class="s2">&#34;&lt;span&gt;&#34;</span> <span class="err">//</span> <span class="err">ä¸ºä»€ä¹ˆä¸æ˜¯</span> <span class="err">`&lt;span&gt;`</span> <span class="err">???</span> <span class="err">æ¼äº†è‡ªé—­åˆæ ‡ç­¾æ£€æµ‹æŒ‡é’ˆç§»ä½</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è§£æä¹‹å context å†…å®¹å˜åŒ–ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="p">{</span>
    <span class="nt">&#34;options&#34;</span><span class="p">:{</span>
      <span class="err">//</span> <span class="err">å¿½ç•¥é€‰é¡¹ï¼Œç›®å‰å¯¹æˆ‘ä»¬æ²¡å•¥ç”¨</span>
    <span class="p">},</span>
    <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
    <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span> <span class="err">//</span> <span class="err">&lt;span&gt;</span> <span class="err">åé¢çš„</span> <span class="err">&gt;</span> <span class="err">ç´¢å¼•</span>
    <span class="nt">&#34;originalSource&#34;</span><span class="p">:</span><span class="s2">&#34;some &lt;span&gt;{{ foo &lt; bar + foo }} text&lt;/span&gt;&#34;</span><span class="p">,</span>
    <span class="err">//</span> <span class="err">è§£æä¹‹åçš„æ¨¡æ¿ï¼Œä¸ºä½•</span> <span class="err">&gt;</span> <span class="err">æ²¡è¢«å»æ‰???ï¼Œè§</span> <span class="err">é—®é¢˜1</span>
    <span class="nt">&#34;source&#34;</span><span class="p">:</span><span class="s2">&#34;{{ foo &lt; bar + foo }} text&lt;/span&gt;&#34;</span><span class="p">,</span>
    <span class="nt">&#34;inPref&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
    <span class="nt">&#34;inVPref&#34;</span><span class="p">:</span><span class="kc">false</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
åˆ°æ­¤æˆ‘ä»¬å·²ç»è§£æé™¤äº† <code class="verbatim">&lt;span&gt;</code> å¼€å§‹æ ‡ç­¾ï¼Œè¿™ä¸ªæ—¶å€™çš„ =node.childrens = []=ï¼Œä¸‹ä¸€æ­¥
è§£ææ ‡ç­¾é‡Œé¢çš„å†…å®¹ã€‚</p>
<p>
åœ¨å®ç°å®Œæ•´çš„ parseElement ä¹‹åå‘ç°æ‰§è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ªç”¨ä¾‹å¹¶ä¸æ˜¯ <code class="verbatim">&lt;span&gt;&lt;/span&gt;</code>
æ ‡ç­¾å†…æ²¡ä¸œè¥¿ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ else è§¦å‘ <code class="verbatim">emitError()</code> ï¼Œé‚£ä¸æ˜¯æ²¡æ³•å¾€ä¸‹èµ°äº†ï¼Ÿï¼Ÿï¼Ÿ</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// å­å…ƒç´  childrenï¼Œè¢«æ¼æ‰çš„ä»£ç ï¼Œä¼šè¿›å…¥é€’å½’è°ƒç”¨ parseChildren å»è§£æ
</span><span class="c1"></span>  <span class="c1">// &lt;span&gt;...&lt;/span&gt; æ ‡ç­¾å†…çš„æ¨¡æ¿
</span><span class="c1"></span>  <span class="nx">ancestors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">getTextMode</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">parseChildren</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">)</span>
  <span class="nx">ancestors</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">children</span>
  <span class="c1">// ...........â˜ğŸ».â˜ğŸ».â˜ğŸ».â˜ğŸ».â˜ğŸ»ï¼ŒåŠ å›å»
</span><span class="c1"></span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_MISSING_END_TAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;script&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="nx">first</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é‚£æ˜¯å› ä¸ºå‰é¢æ¼äº†ä¸€æ®µä»£ç ã€‚</p>
<p>
ä»£ç åŠ ä¸Šä¹‹åæœ€åä»£ç  P1 å‡ºçš„è¾“å‡º ancestors é‡Œé¢ä¼šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹(element)ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="err">//</span> <span class="err">ancestors</span><span class="p">[{</span><span class="err">...</span><span class="p">}]</span><span class="err">ï¼Œancestors</span> <span class="err">ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯</span> <span class="err">&lt;span&gt;</span> <span class="err">è¿™ä¸ªèŠ‚ç‚¹</span>
  <span class="err">//</span> <span class="err">é‡ç‚¹æˆ‘ä»¬è¦çœ‹çš„æ˜¯è¿™ä¸ªèŠ‚ç‚¹çš„</span> <span class="err">children</span> <span class="err">å› ä¸ºå…¶å†…éƒ¨æœ‰</span> <span class="err">`</span><span class="p">{</span><span class="err">{</span> <span class="err">foo</span> <span class="err">&lt;</span> <span class="err">bar</span> <span class="err">+</span> <span class="err">foo</span> <span class="p">}</span><span class="err">}</span> <span class="err">text`</span>
  <span class="err">//</span> <span class="err">æ‰€ä»¥å®ƒ</span> <span class="err">çš„</span> <span class="err">element</span> <span class="err">åº”è¯¥æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼š`foo</span> <span class="err">&lt;</span> <span class="err">bar</span> <span class="err">+</span> <span class="err">foo`</span> <span class="err">å’Œ</span> <span class="err">`</span> <span class="err">text`</span>
  <span class="p">{</span>
    <span class="err">//</span> <span class="err">&lt;span&gt;</span> <span class="err">èŠ‚ç‚¹æœ¬èº«çš„å±æ€§ï¼Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯</span> <span class="err">children</span>
    <span class="nt">&#34;children&#34;</span><span class="p">:[</span>
      <span class="p">{</span> <span class="err">//</span> <span class="err">ç¬¬ä¸€ä¸ª</span> <span class="err">child</span> <span class="err">æ˜¯</span> <span class="err">{{</span> <span class="err">...</span> <span class="p">}</span><span class="err">}</span> <span class="err">æ£€æµ‹åˆ°æ’å€¼è¿›å…¥</span> <span class="err">parseInterpolation</span> <span class="err">åˆ†æ”¯</span>
        <span class="err">//</span> <span class="err">å¤„ç†ï¼Œå¾—åˆ°ä¸‹é¢çš„èŠ‚ç‚¹ç»“æ„ï¼Œæ’å€¼è§£æåœ¨</span> <span class="err">parseInterpolation</span> <span class="err">ä¸€ç« æœ‰åˆ†æè¿‡äº†</span>
        <span class="s2">&#34;type&#34;</span><span class="err">:</span><span class="mi">5</span><span class="p">,</span>
        <span class="s2">&#34;content&#34;</span><span class="err">:</span><span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
          <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
          <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
          <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;foo &lt; bar + foo&#34;</span><span class="p">,</span>
          <span class="nt">&#34;loc&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;start&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span>
              <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
              <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">14</span>
            <span class="p">},</span>
            <span class="nt">&#34;end&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
              <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
              <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">29</span>
            <span class="p">},</span>
            <span class="nt">&#34;source&#34;</span><span class="p">:</span><span class="s2">&#34;foo &lt; bar + foo&#34;</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&#34;loc&#34;</span><span class="err">:</span><span class="p">{</span>
          <span class="nt">&#34;start&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
            <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">11</span>
          <span class="p">},</span>
          <span class="nt">&#34;end&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span>
            <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">32</span>
          <span class="p">},</span>
          <span class="nt">&#34;source&#34;</span><span class="p">:</span><span class="s2">&#34;{{ foo &lt; bar + foo }}&#34;</span>
        <span class="p">}</span>
      <span class="err">}</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
        <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34; text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;loc&#34;</span><span class="p">:{</span>
          <span class="nt">&#34;start&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span>
            <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">32</span>
          <span class="p">},</span>
          <span class="nt">&#34;end&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;column&#34;</span><span class="p">:</span><span class="mi">38</span><span class="p">,</span>
            <span class="nt">&#34;line&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&#34;offset&#34;</span><span class="p">:</span><span class="mi">37</span>
          <span class="p">},</span>
          <span class="nt">&#34;source&#34;</span><span class="p">:</span><span class="s2">&#34; text&#34;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="err">//</span> <span class="err">&lt;span&gt;</span> <span class="err">æœ¬èº«èŠ‚ç‚¹çš„</span> <span class="err">loc</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œä¹Ÿæ²¡ä»€ä¹ˆå¥½è§£é‡Šçš„ï¼Œæ’å€¼åœ¨ <a href="#parse-parseinterpolation">parseInterpolation</a> å¤„åˆ†æè¿‡äº†ï¼Œæ–‡æœ¬è§£æåœ¨ <a href="#parse-parsetext">parseText</a>
å¤„åˆ†æäº†ã€‚</p>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-parseinterpolation" class="outline-3">
<h3 id="parse-parseinterpolation">
parseInterpolation(context, mode)
</h3>
<div id="outline-text-parse-parseinterpolation" class="outline-text-3">
<p>
å‡½æ•°å£°æ˜ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">parseInterpolation</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="nx">mode</span>: <span class="kt">TextModes</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">InterpolationNode</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>context</strong>: å°†è¢«è§£æçš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è¿™é‡Œçš„ source åº”è¯¥æ˜¯ä»¥å·®å€¼ (<code class="verbatim">{{</code>)å¼€å§‹çš„å­—ç¬¦ä¸²ã€‚</p>
<p>
<strong>mode</strong>: æ–‡æœ¬æ¨¡å¼ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseInterpolation</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ‰¾å‡ºæ’å€¼æ¨¡æ¿çš„å¼€å§‹å’Œç»“æŸç¬¦å·ï¼Œé»˜è®¤æ˜¯ {{ å’Œ }}
</span><span class="c1"></span>    <span class="kr">const</span> <span class="p">[</span><span class="nx">open</span><span class="p">,</span> <span class="nx">close</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">closeIndex</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">close</span><span class="p">,</span> <span class="nx">open</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">closeIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_MISSING_INTERPOLATION_END</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">open</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

    <span class="c1">// ä¸‹é¢æ˜¯ä» {{ ä¹‹åçš„å­—ç¬¦ä¸²å¼€å§‹è§£æ
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">innerStart</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">),</span>
          <span class="nx">innerEnd</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">),</span>
          <span class="c1">// æ’å€¼é‡Œé¢çš„å­—ç¬¦ä¸²é•¿åº¦
</span><span class="c1"></span>          <span class="nx">rawContentLength</span> <span class="o">=</span> <span class="nx">closeIndex</span> <span class="o">-</span> <span class="nx">open</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="c1">// æ’å€¼é‡Œé¢çš„å­—ç¬¦ä¸²å†…å®¹
</span><span class="c1"></span>          <span class="nx">rawContent</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">rawContentLength</span><span class="p">),</span>
          <span class="nx">preTrimContent</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">rawContentLength</span><span class="p">,</span> <span class="nx">mode</span><span class="p">),</span>
          <span class="nx">content</span> <span class="o">=</span> <span class="nx">preTrimContent</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span>
          <span class="nx">startOffset</span> <span class="o">=</span> <span class="nx">preTrimContent</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">startOffset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">advancePositionWithMutation</span><span class="p">(</span><span class="nx">innerStart</span><span class="p">,</span> <span class="nx">rawContent</span><span class="p">,</span> <span class="nx">startOffset</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// {{ foo + bar }} -&gt;
</span><span class="c1"></span>    <span class="c1">// res = (&#39; foo + bar &#39;.length - &#39;foo + bar&#39;.length - &#39; &#39;.length)
</span><span class="c1"></span>    <span class="c1">// æ’å€¼é‡Œé¢å­—ç¬¦ä¸²çš„é•¿åº¦ - å»æ‰ç©ºæ ¼åçš„é•¿åº¦ - èµ·å§‹ç©ºæ ¼çš„é•¿åº¦ï¼Œå¾—åˆ°çš„
</span><span class="c1"></span>    <span class="c1">// å°±æ˜¯ç»“æŸä½ç½®çš„ offset
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">endOffset</span> <span class="o">=</span>
          <span class="nx">rawContentLength</span> <span class="o">-</span> <span class="p">(</span><span class="nx">preTrimContent</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">startOffset</span><span class="p">);</span>
    <span class="nx">advancePositionWithMutation</span><span class="p">(</span><span class="nx">innerEnd</span><span class="p">,</span> <span class="nx">rawContent</span><span class="p">,</span> <span class="nx">endOffset</span><span class="p">);</span>
    <span class="c1">// å®šä½åˆ° }} ä½ç½®
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">close</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">innerEnd</span><span class="p">,</span> <span class="nx">innerStart</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">INTERPOLATION</span><span class="p">,</span>
      <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
        <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">content</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">innerStart</span><span class="p">,</span> <span class="nx">innerEnd</span><span class="p">),</span>
      <span class="p">},</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
    <span class="p">};</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<img src="/img/tmp/1595570127.png" alt="/img/tmp/1595570127.png" title="/img/tmp/1595570127.png" /></p>
<p>
å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°åœ¨ç»è¿‡è§£æä¹‹å innerStart å’Œ innerEnd éƒ½æ•°æ®éƒ½æ­£ç¡®å®šä½åˆ°äº†ç›¸åº”ä½ç½®ï¼Œ
innerStart æ˜¯è§£æåæ’å€¼å­—ç¬¦ä¸²çš„å¼€å§‹ä½ç½®(ç¬¬ä¸€ä¸ª <code class="verbatim">{</code> offset = 8(</font>or=&#39;red&#39;&gt;</font>•¿åº¦&lt;/font&gt;))ï¼ŒinnerEnd æ˜¯è§£æåæ’å€¼å­—ç¬¦ä¸²çš„ç»“æŸä½ç½®
(æœ€åä¸€ä¸ª <code class="verbatim">}</code> offset = 17(&lt;font color=&#34;purple&#34;&gt;&#39;some {{ foo + bar &#39;çš„é•¿
åº¦))</font>ã€‚</p>
<p>
<img src="/img/vue3/compiler-core/functions/parse-ts-parseinterpolation.png" alt="/img/vue3/compiler-core/functions/parse-ts-parseinterpolation.png" title="/img/vue3/compiler-core/functions/parse-ts-parseinterpolation.png" /></p>
<p>
è§£æä¹‹åå¾—åˆ°çš„ <code class="verbatim">ast.children</code> å°†ä¼šæœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="err">(</span><span class="mi">3</span><span class="err">)</span> <span class="p">[{</span><span class="err">â€¦</span><span class="p">},</span> <span class="p">{</span><span class="err">â€¦</span><span class="p">},</span> <span class="p">{</span><span class="err">â€¦</span><span class="p">}]</span>
  <span class="mi">0</span><span class="err">:</span> <span class="p">{</span><span class="err">type:</span> <span class="err">2,</span> <span class="err">content:</span> <span class="nt">&#34;some &#34;</span><span class="p">,</span> <span class="err">loc:</span> <span class="err">{â€¦</span><span class="p">}</span><span class="err">}</span> <span class="err">//</span> <span class="err">å·¦ä¾§æ–‡æœ¬</span>
  <span class="mi">1</span><span class="err">:</span> <span class="p">{</span><span class="err">type:</span> <span class="err">5,</span> <span class="err">content:</span> <span class="err">{â€¦</span><span class="p">}</span><span class="err">,</span> <span class="err">loc:</span> <span class="p">{</span><span class="err">â€¦</span><span class="p">}</span><span class="err">}</span> <span class="err">//</span> <span class="err">æ’å€¼éƒ¨åˆ†</span>
  <span class="mi">2</span><span class="err">:</span> <span class="p">{</span><span class="err">type:</span> <span class="err">2,</span> <span class="err">content:</span> <span class="nt">&#34; text&#34;</span><span class="p">,</span> <span class="err">loc:</span> <span class="err">{â€¦</span><span class="p">}</span><span class="err">}</span> <span class="err">//</span> <span class="err">å³ä¾§æ–‡æœ¬</span>
  <span class="err">length:</span> <span class="mi">3</span>
  <span class="err">__proto__:</span> <span class="err">Array(</span><span class="mi">0</span><span class="err">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è§£æå›é¡¾(åˆ†åˆ«è§£æå‡ºäº†ä¸‰ä¸ªèŠ‚ç‚¹å¯¹è±¡)ï¼š</p>
<ol>
<li>
<p><code class="verbatim">0: {type: 2, content: &#34;some &#34;, loc: {â€¦}}</code></p>
<p>è¯¦ç»†ç»“æ„ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="mi">0</span><span class="err">:</span>
  <span class="err">content:</span> <span class="s2">&#34;some &#34;</span> <span class="err">//</span> <span class="err">è§£æå‡ºçš„æ–‡æœ¬å†…å®¹</span>
  <span class="err">loc:</span> <span class="err">//</span> <span class="err">ä½ç½®ä¿¡æ¯</span>
  <span class="err">end:</span> <span class="p">{</span><span class="err">column:</span> <span class="err">6,</span> <span class="err">line:</span> <span class="err">1,</span> <span class="err">offset:</span> <span class="err">5</span><span class="p">}</span> <span class="err">//</span> <span class="err">è¯¥èŠ‚ç‚¹åœ¨æ¨¡æ¿ä¸­çš„ä½ç½®ä¿¡æ¯</span>
  <span class="err">source:</span> <span class="s2">&#34;some &#34;</span> <span class="err">//</span> <span class="err">æ–‡æœ¬æºå†…å®¹</span>
  <span class="err">start:</span> <span class="p">{</span><span class="err">column:</span> <span class="err">1,</span> <span class="err">line:</span> <span class="err">1,</span> <span class="err">offset:</span> <span class="err">0</span><span class="p">}</span> <span class="err">//</span> <span class="err">è¯¥èŠ‚ç‚¹åœ¨æ¨¡æ¿ä¸­çš„ç»“æŸä¿¡æ¯</span>
  <span class="err">__proto__:</span> <span class="err">Object</span>
  <span class="err">type:</span> <span class="mi">2</span> <span class="err">//</span> <span class="err">èŠ‚ç‚¹ç±»å‹</span>
  <span class="err">__proto__:</span> <span class="err">Object</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é‚£ä¹ˆæ˜¯å¦‚ä½•å¾—åˆ°ä¸Šé¢çš„ç»“æœçš„å‘¢ï¼Ÿï¼Ÿï¼Ÿé‚£å¾—ä» <a href="#parse-parsechildren">parseChildren</a> è¯´èµ·äº†ï¼Œæ¨¡æ¿ï¼š</p>
<p>
<kbd>
â€”&gt;&gt; &#34;some {{ foo + bar }} text&#34;
</kbd></p>
<p>
<code class="verbatim">(!context.inVPre &amp;&amp; s.startsWith(context.options.delimiters[0]))</code>
<font color='red'>æ£€æµ‹å¤±è´¥</font></p>
<p>
<code>mode === TextModes.DATA &amp;&amp; s[0] === &#34;&lt;&#34;</code> <font color='red'>æ£€æµ‹å¤±è´¥</font></p>
<p>
å³ä¸€å¼€å§‹å¹¶ä¸ä¼šè¿›å…¥æ’å€¼å’Œæ ‡ç­¾è§£æä»£ç ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥ <a href="#parse-parsetext">parseText(context, mode)</a>
ä¸­è§£ææ–‡æœ¬ï¼Œè§£ææ—¶å€™ç›´åˆ°é‡åˆ° <code class="verbatim">{{</code> ä¹‹å‰éƒ½ä¸€ç›´ä¼šå½“åšæ–‡æœ¬è§£æï¼Œè€Œä¹‹å‰çš„æ–‡æœ¬ä¸­åˆ
ä¸åŒ…å« <code class="verbatim">decodeMap</code> ä¸­çš„å­—ç¬¦ï¼Œå› æ­¤çŸ¥é“é‡åˆ° <code class="verbatim">{</code> ä¹‹å‰ä¼šä¸€ç›´æ‰§è¡Œ while é‡Œé¢çš„ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">node</span> <span class="o">=</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">mode</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™æ®µä»£ç ï¼Œè€Œç”±äº &#34;some &#34; éƒ½æ˜¯æ™®é€šå­—ç¬¦ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²ä¼šå¯¹åº”ä¸€ä¸ª node ï¼Œç„¶ååˆéƒ½æ˜¯
æ™®é€šæ–‡æœ¬èŠ‚ç‚¹ï¼Œä¼šç»è¿‡ <a href="#parse-pushnode">pushNode(nodes, node[i])</a> å¤„ç†æ‰ï¼Œè¿›è¡Œåˆå¹¶æœ€åæˆä¸ºä¸Šé¢çš„
ä¸€ä¸ªå®Œæ•´çš„ &#34;some &#34; å¯¹åº”<a href="#x-1">æ–‡æœ¬èŠ‚ç‚¹ç»“æ„</a>ã€‚</p>
</li>
<li>
<p><code>1: {type: 5, content: {â€¦}, loc: {â€¦}}</code></p>
<p>èŠ‚ç‚¹ç»“æ„ï¼š</p>
<pre class="example">
1:
  content: // è¿™é‡Œçš„æ•°æ®æ˜¯ç»è¿‡æ’å€¼è§£æä¹‹åçš„æ¨¡æ¿å¯¹è±¡
    content: &#34;foo + bar&#34; // trim ä¹‹åçš„æ’å€¼å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰ }} ???
    isConstant: false // éå¸¸é‡ç±»å‹
    isStatic: false // éé™æ€èŠ‚ç‚¹
    loc:  // è§£æä¹‹åçš„è¯¥èŠ‚ç‚¹åœ¨æ•´ä¸ªæ¨¡æ¿ä¸­çš„ä½ç½®ä¿¡æ¯
     // 17 -&gt; r æ‰€åœ¨çš„ä½ç½®
      end: {column: 18, line: 1, offset: 17}
      source: &#34;foo + bar&#34;
     // 8 -&gt; f æ‰€åœ¨çš„ä½ç½®ï¼Œå³ start -&gt; end =&gt; &#39;f &lt;-&gt; r&#39;
      start: {column: 9, line: 1, offset: 8}
    __proto__: Object
    type: 4 // æ’å€¼è¡¨è¾¾å¼ç±»å‹
    __proto__: Object
 loc: // è¿™é‡Œæ˜¯æ²¡ç»è¿‡å»å°¾éƒ¨ç©ºæ ¼çš„ä½ç½®ä¿¡æ¯
   // 20 -&gt; &#39;some {{ foo + bar &#39; æœ€åä¸€ä¸ªç©ºæ ¼ä½ç½®
    end: {column: 21, line: 1, offset: 20}
    source: &#34;{{ foo + bar }}&#34;
   // 5 -&gt; &#39;some &#39; ç¬¬ä¸€ä¸ª { ä½ç½®
    start: {column: 6, line: 1, offset: 5}
    __proto__: Object
  type: 5 // æ’å€¼ç±»å‹
  __proto__: Object
</pre>
<p>
å¦‚ä¸Šæ‰€æ³¨é‡Šçš„ï¼Œç¬¬ä¸€çº§çš„ loc æ˜¯é€šè¿‡è§£æ <strong>&#34;{{ foo + bar}}&#34;</strong> åœ¨æ•´ä¸ªæ¨¡æ¿ä¸­çš„ä½ç½®
ä¿¡æ¯ï¼Œcontent é‡Œé¢åŒ…å«çš„æ˜¯æ’å€¼å†…éƒ¨çš„ä¿¡æ¯ï¼Œå³çœŸæ­£çš„è¡¨è¾¾å¼ç»“æ„ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><code>{type: 2, content: &#34; text&#34;, loc: {â€¦}}</code></p>
<p>
å’Œç¬¬ä¸€æ­¥ä¸­ä¸€æ ·ï¼Œåªä¼šç»è¿‡ <code class="verbatim">parseText(context, mode)</code> è§£æå‡ºçº¯æ–‡æœ¬å†…å®¹ï¼š&#34; text&#34;ï¼Œæœ€åçš„ç»“æ„ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="p">{</span>
    <span class="err">type:</span> <span class="err">2,</span>
    <span class="err">content:</span> <span class="nt">&#34; text&#34;</span><span class="p">,</span>
    <span class="err">loc:</span> <span class="err">{</span>
      <span class="err">//</span> <span class="err">ä»</span> <span class="err">text</span> <span class="err">å‰é¢çš„ç©ºæ ¼å¼€å§‹è®°å½•ï¼Œ</span><span class="nt">&#34;some {{ foo + bar }}&#34;</span> <span class="err">é•¿åº¦ä¸º</span> <span class="mi">20</span>
      <span class="err">start</span><span class="p">:</span> <span class="p">{</span> <span class="err">column:</span> <span class="err">21,</span> <span class="err">line:</span> <span class="err">1,</span> <span class="err">offset:</span> <span class="err">20</span> <span class="p">},</span>
      <span class="err">source:</span> <span class="nt">&#34; text&#34;</span><span class="p">,</span>
      <span class="err">end:</span> <span class="err">{</span> <span class="err">column:</span> <span class="err">26,</span> <span class="err">line:</span> <span class="err">1,</span> <span class="err">offset:</span> <span class="err">25</span><span class="p">}</span>
    <span class="err">}</span>
  <span class="err">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>ä¸‰æ­¥åˆ†æå®Œä¹‹åï¼Œåˆ°ç°åœ¨æˆ‘ä»¬åº”è¯¥å…·å¤‡è„±ç¦»ä»£ç å°±å¯ä»¥ç›´æ¥æ ¹æ®æ¨¡æ¿å¾—åˆ°è§£æåå¯¹åº”çš„
children ç»“æ„ã€‚åˆ†æçš„é‡ç‚¹æ˜¯è¦å¾—åˆ°ä¸€ä¸ª <code class="verbatim">{ type, content, loc: { start, source, end }}</code> ç»“æ„çš„å¯¹è±¡ã€‚</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="err">//</span> <span class="err">start/end:</span>
  <span class="p">{</span>
    <span class="err">column/*è¯¥èŠ‚ç‚¹èµ·å§‹ç»“æŸçš„åˆ—ï¼Œä»</span> <span class="err">1</span> <span class="err">å¼€å§‹è®¡æ•°çš„å€¼*/,</span>
    <span class="err">line/*è¯¥èŠ‚ç‚¹æ¨¡æ¿æ‰€åœ¨çš„è¡Œï¼Œä»</span> <span class="err">1</span> <span class="err">å¼€å§‹è®¡æ•°çš„å€¼*/,</span>
    <span class="err">offset/*è¯¥èŠ‚ç‚¹èµ·å§‹ç»“æŸçš„ç´¢å¼•ï¼Œä»</span> <span class="err">0</span> <span class="err">å¼€å§‹è®¡æ•°çš„å€¼*/</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<font color="blue">PS: å¯¹äº foo å’Œ bar å˜é‡æ•°æ®è§£ææ‰§è¡Œç»“æœè¿™å—æš‚æ—¶ä¸è®¨è®ºï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•åšåˆ°çš„ï¼Œç°é˜¶æ®µåªå…³å¿ƒæ¨¡æ¿çš„è§£æã€‚</font>
</div>
</div>
<div id="outline-container-parse-parsetag" class="outline-3">
<h3 id="parse-parsetag">
parseTag(context, type, parent)
</h3>
<div id="outline-text-parse-parsetag" class="outline-text-3">
<div id="outline-container-parse-parsetag-01" class="outline-4">
<h4 id="parse-parsetag-01">
é˜¶æ®µä¸€(<a href="#test-text-02">simple text&lt;\/div&gt;</a>)
</h4>
<div id="outline-text-parse-parsetag-01" class="outline-text-4">
<ol>
<li>
<p>ä¸ºä»€ä¹ˆåªåŒ¹é… <code class="verbatim">&lt;/div</code> è€Œå¿½ç•¥æ‰æœ€åä¸€ä¸ª <code class="verbatim">&gt;</code>???
å‚æ•°:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span> <span class="c1">// è¦ç»§ç»­è§£æçš„æ¨¡æ¿å¯¹è±¡ simple text&lt;/div&gt; é‡Œé¢çš„ &lt;/div&gt;
</span><span class="c1"></span>      <span class="kr">type</span><span class="o">:</span> <span class="nx">TagType</span><span class="p">,</span> <span class="c1">// Start(&lt;div&gt;), End(&lt;/div&gt;)å¼€å§‹ç»“æŸæ ‡ç­¾
</span><span class="c1"></span>      <span class="nx">parent</span>: <span class="kt">ElementNode</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="c1">// è¯¥æ ‡ç­¾çš„çˆ¶çº§
</span><span class="c1"></span>  <span class="p">)</span><span class="o">:</span> <span class="nx">ElementNode</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å…·ä½“å®ç°ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ simple text çš„é•¿åº¦
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="c1">// åŒ¹é… &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ &gt; ç»™å¿½ç•¥æ‰???
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kr">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">getNamespace</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
    <span class="c1">// æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div&gt; çš„æœ€æœ‰ä¸€ä¸ª &gt; ä¸Š
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
    <span class="c1">// è¿‡æ»¤æ‰ç©ºæ ¼
</span><span class="c1"></span>    <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">currSource</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-parse-parsetag-02" class="outline-4">
<h4 id="parse-parsetag-02">
é˜¶æ®µäºŒ(<a href="#test-text-05">test-text-05</a>)
</h4>
<div id="outline-text-parse-parsetag-02" class="outline-text-4">
<p>
æ»¡è¶³ç”¨ä¾‹ 5(<code class="verbatim">some &lt;span&gt;{{ foo &lt; bar + foo }} text&lt;/span&gt;</code>) çš„ä»£ç å®ç°ï¼Œè¿™é‡Œåªéœ€
è¦èƒ½è§£æ <code class="verbatim">&lt;span&gt; ... &lt;/span&gt;</code> æ ‡ç­¾å°±å¯ä»¥ï¼Œæ²¡æœ‰ <code class="verbatim">pre</code>, <code class="verbatim">v-pre</code>, <code class="verbatim">&lt;span/&gt;è‡ªé—­åˆæ ‡
ç­¾</code> ï¼Œå› æ­¤ä¸‹é¢çœç•¥è¿™å‡ éƒ¨åˆ†æ£€æµ‹ä»£ç ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="c1">// åŒ¹é… &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ &gt; ç»™å¿½ç•¥æ‰???
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">getNamespace</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
    <span class="c1">// log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div&gt; çš„æœ€æœ‰ä¸€ä¸ª &gt; ä¸Š
</span><span class="c1"></span>    <span class="c1">// åœ¨è¿™é‡Œ context.offset = 10, context.line = 1
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
    <span class="c1">// è¿‡æ»¤æ‰ç©ºæ ¼
</span><span class="c1"></span>    <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="c1">// log2: ç»è¿‡ advanceä¹‹å context.offset = 15, context.line = 1
</span><span class="c1"></span>    <span class="c1">// æ­£å¥½è¿‡æ»¤ &lt;/div 5ä¸ªå­—ç¬¦
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">currSource</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span>

    <span class="c1">// TODO-1 è§£ææ ‡ç­¾å…ƒç´ çš„å±æ€§
</span><span class="c1"></span>
    <span class="c1">// TODO-2 in pre ...
</span><span class="c1"></span>
    <span class="c1">// TODO-3 v-pre æŒ‡ä»¤
</span><span class="c1"></span>
    <span class="c1">// TODO-3 &lt;div/&gt; è‡ªé—­æ ‡ç­¾
</span><span class="c1"></span>    <span class="c1">// è¿™é‡Œè¦å®ç°ï¼Œä¸ç„¶æœ€åè§£æå®Œæˆä¹‹å source ä¼šæ˜¯ï¼š&gt;...&lt;/span&gt;
</span><span class="c1"></span>    <span class="c1">// éœ€è¦æ£€æµ‹ä¸‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾æ¥ç§»åŠ¨æŒ‡é’ˆä½ç½®
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_TAG</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// some &lt;div&gt; ... &lt;/div&gt; åˆ°è¿™é‡Œçš„ source = &gt; ... &lt;/div&gt;
</span><span class="c1"></span>      <span class="c1">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /&gt; å¼€å¤´çš„
</span><span class="c1"></span>      <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&gt;&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span> <span class="o">&amp;&amp;</span> <span class="nx">isSelfClosing</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/&gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(&gt;)
</span><span class="c1"></span>      <span class="c1">// åˆ°è¿™é‡Œ source = ... &lt;/div&gt;
</span><span class="c1"></span>      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">isSelfClosing</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span>
    <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span>
    <span class="c1">// ä¸æ˜¯ v-preï¼Œä¸”ä¸æ˜¯è‡ªå®šä¹‰ç»„ä»¶ï¼Œè¿™ä¸ª if ç›®çš„æ˜¯ä¸ºäº†æ£€æµ‹å¹¶æ”¹å˜
</span><span class="c1"></span>    <span class="c1">// tagType æ ‡ç­¾ç±»å‹
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isCustomElement</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// TODO-4 æ£€æµ‹ tagType
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="p">,</span>
      <span class="nx">tag</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="p">,</span>
      <span class="nx">props</span><span class="p">,</span>
      <span class="nx">isSelfClosing</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// TODO
</span><span class="c1"></span>      <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¦èƒ½é€šè¿‡<a href="#test-text-05">ç”¨ä¾‹5</a>å¿…é¡»æ­é… <a href="#parse-parseelement">parseElement(context, ancestors)</a> æ‰è¡Œï¼Œå¹¶ä¸”é‡ç‚¹åœ¨
<strong>parseElement</strong> ä¸­ï¼Œå› ä¸ºæœ‰äº†å¼€å§‹æ ‡ç­¾æ‰ä¼šæœ‰ç»“æŸæ ‡ç­¾çš„è§£æï¼Œä¸ç„¶ä¼šè§¦å‘ç»“æŸæ ‡ç­¾è§£æåˆ†
æ”¯é‡Œé¢çš„ error:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sr">/[a-z]/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
    <span class="c1">// è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???
</span><span class="c1"></span>    <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_INVALID_END_TAG</span><span class="p">)</span>
    <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
    <span class="k">continue</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å› æ­¤å¦‚æœè¿™é‡Œä¸ä¼šè§¦å‘ X_INVALID_END_TAG é‚£å¿…å®šæ˜¯ parseElement é‡Œé¢åšäº†ä»€ä¹ˆå¤„ç†ï¼Œ
è¿™ä¸ªå®ç°äº† parseElement æ‰å¾—ä»¥çŸ¥æ™“(ç›®å‰åªæ˜¯çŒœæµ‹~~~)ï¼Œ<a href="#parse-parseelement">ä¼ é€é—¨ğŸšª&gt;&gt;&gt;</a></p>
</div>
</div>
<div id="outline-container-parse-parsetag-03" class="outline-4">
<h4 id="parse-parsetag-03">
é˜¶æ®µä¸‰(<a href="#test-element-03">test-element-03</a>)
</h4>
<div id="outline-text-parse-parsetag-03" class="outline-text-4">
<p>
æ”¯æŒè‡ªé—­æ ‡ç­¾è§£æï¼Œå®ç°äº†é˜¶æ®µäºŒä¹‹åï¼Œè¿™é‡Œå…¶å®å¾ˆç®€å•ï¼Œåœ¨ä¸Šä¸€é˜¶æ®µä¸­çš„å®ç°åœ¨
parseTag ä¸­è¿”å›çš„æ—¶å€™ <code class="verbatim">isSelfClosing</code> å†™æ­»æˆäº† <code class="verbatim">false</code> ï¼Œè¦æ”¯æŒè¿™ä¸ªç”¨ä¾‹ï¼Œåªè¦å°†
å®ƒçš„å€¼èµ‹å€¼ä¸ºå®é™…çš„ <code class="verbatim">isSelfClosing</code> å°±å¯ä»¥äº†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">parseTag</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_TAG</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// some &lt;div&gt; ... &lt;/div&gt; åˆ°è¿™é‡Œçš„ source = &gt; ... &lt;/div&gt;
</span><span class="c1"></span>      <span class="c1">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /&gt; å¼€å¤´çš„
</span><span class="c1"></span>      <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&gt;&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span> <span class="o">&amp;&amp;</span> <span class="nx">isSelfClosing</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/&gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(&gt;)
</span><span class="c1"></span>      <span class="c1">// åˆ°è¿™é‡Œ source = ... &lt;/div&gt;
</span><span class="c1"></span>      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">isSelfClosing</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-parsetag-04" class="outline-4">
<h4 id="parse-parsetag-04">
é˜¶æ®µå››(æ”¯æŒ template + v-if)
</h4>
<div id="outline-text-parse-parsetag-04" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="c1">// åŒ¹é… &lt;div æˆ– &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ &gt; ç»™å¿½ç•¥æ‰???
</span><span class="c1"></span>    <span class="c1">// å…¶å®ä¸æ˜¯å¿½ç•¥æ‰ &gt; è€Œæ˜¯å› ä¸ºå¦‚æœæ˜¯ &lt;div å¼€å¤´ï¼Œé‚£ä¹ˆåé¢æœ‰å¯èƒ½æ˜¯ &lt; æˆ–
</span><span class="c1"></span>    <span class="c1">// /&gt; åé¢éœ€è¦å¤„ç†é—­åˆå’Œéé—­åˆé—®é¢˜
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">getNamespace</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span>
    <span class="c1">// log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div&gt; çš„æœ€æœ‰ä¸€ä¸ª &gt; ä¸Š
</span><span class="c1"></span>    <span class="c1">// åœ¨è¿™é‡Œ context.offset = 10, context.line = 1
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
    <span class="c1">// è¿‡æ»¤æ‰ç©ºæ ¼
</span><span class="c1"></span>    <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="c1">// log2: ç»è¿‡ advance ä¹‹å context.offset = 15, context.line = 1
</span><span class="c1"></span>    <span class="c1">// æ­£å¥½è¿‡æ»¤ &lt;/div 5 ä¸ªå­—ç¬¦
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">currSource</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span>

    <span class="c1">// è§£ææ ‡ç­¾å…ƒç´ çš„å±æ€§
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">parseAttributes</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span>

    <span class="c1">// TODO-2 in pre ...
</span><span class="c1"></span>
    <span class="c1">// TODO-3 v-pre æŒ‡ä»¤
</span><span class="c1"></span>
    <span class="c1">// ....
</span><span class="c1"></span>
    <span class="kd">let</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">ELEMENT</span>
    <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span>
    <span class="c1">// ä¸æ˜¯ v-preï¼Œä¸”ä¸æ˜¯è‡ªå®šä¹‰ç»„ä»¶ï¼Œè¿™ä¸ª if ç›®çš„æ˜¯ä¸ºäº†æ£€æµ‹å¹¶æ”¹å˜
</span><span class="c1"></span>    <span class="c1">// tagType æ ‡ç­¾ç±»å‹
</span><span class="c1"></span>    <span class="c1">// TODO-4 æ£€æµ‹ tagType
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isCustomElement</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// æ˜¯å¦æœ‰ is æŒ‡ä»¤ï¼Ÿ
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">hasVIs</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;is&#39;</span>
      <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasVIs</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ²¡æœ‰ is æŒ‡ä»¤ï¼Œä¸”ä¸æ˜¯åŸç”Ÿæ ‡ç­¾ï¼Œé‚£å°±æ˜¯è‡ªå®šä¹‰çš„ç»„ä»¶äº†
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">isNativeTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
        <span class="nx">hasVIs</span> <span class="o">||</span>
          <span class="nx">isCoreComponent</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">||</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">isBuiltInComponent</span><span class="o">?</span><span class="p">.(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">||</span>
          <span class="sr">/^[A-Z]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">||</span>
          <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;component&#39;</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æœ‰ is æŒ‡ä»¤ || vue æ ¸å¿ƒç»„ä»¶(keep-alive...) || å†…ç½®ç»„ä»¶
</span><span class="c1"></span>        <span class="c1">// || æ ‡ç­¾åå¤§å†™å¼€å¤´
</span><span class="c1"></span>        <span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;slot&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">SLOT</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
        <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;template&#39;</span> <span class="o">&amp;&amp;</span>
          <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
            <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">isSpecialTemplateDirective</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
          <span class="p">)</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ˜¯æ¨¡æ¿çš„å‰ææ˜¯æœ‰æŒ‡ä»¤ï¼Œå¹¶ä¸”æ˜¯ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤
</span><span class="c1"></span>        <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">val</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span>
      <span class="nx">ns</span><span class="p">,</span>
      <span class="nx">tag</span><span class="p">,</span>
      <span class="nx">tagType</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="p">[],</span> <span class="c1">// TODO
</span><span class="c1"></span>      <span class="nx">isSelfClosing</span><span class="p">,</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
      <span class="nx">codegenNode</span><span class="o">:</span> <span class="kc">undefined</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">val</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œçš„å®ç°æ¶‰åŠåˆ°å‡ ä¸ªæ–°çš„å‡½æ•°ï¼š</p>
<ol>
<li>
<p><code class="verbatim">options.isCustomElement(tag)</code> é»˜è®¤åœ¨ options é‡Œé¢æ˜¯ <code class="verbatim">NO</code></p>
</li>
<li>
<p><code class="verbatim">options.isNativeTag(tag)</code> ä½œä¸ºå¯é€‰ <code class="verbatim">OptionalOptions</code> é€‰é¡¹ç±»å‹ï¼Œå¹¶æ²¡é»˜è®¤å€¼</p>
</li>
<li>
<p><code class="verbatim">isCoreComponent(tag)</code> vue å†…éƒ¨ä½œä¸ºæ ¸å¿ƒç»„ä»¶çš„æ ‡ç­¾</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json">  <span class="p">{</span> <span class="err">//</span> <span class="err">ä¸»è¦å°±è¿™å››ä¸ª</span>
    <span class="err">Teleport:</span> <span class="err">TELEPORT,</span>
    <span class="err">Suspense:</span> <span class="err">SUSPENSE,</span>
    <span class="err">KeepAlive:</span> <span class="err">KEEP_ALIVE,</span>
    <span class="err">BaseTransition:</span> <span class="err">BASE_TRANSITION</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code class="verbatim">options.isBuiltInComponent?.(tag)</code>  å’Œ <code class="verbatim">isNativeTag</code> ä¸€æ ·ä½œä¸ºå¯é€‰é€‰é¡¹ï¼Œæ— é»˜è®¤å€¼</p>
</li>
<li>
<p><code class="verbatim">isSpecialTemplateDirective(p.name)</code> ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kr">const</span> <span class="nx">isSpecialTemplateDirective</span> <span class="o">=</span> <span class="cm">/*#__PURE__*/</span> <span class="nx">makeMap</span><span class="p">(</span>
      <span class="sb">`if,else,else-if,for,slot`</span>
  <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè¦è¢«å®šä¹‰ä¸ºæ˜¯ <code class="verbatim">&lt;template&gt;</code> ç±»å‹å¿…é¡»åŒ…å«
<code class="verbatim">if,else,else-if,for,slot</code> è¿™å…¶ä¸­çš„ä»»ä¸€ä¸ªæŒ‡ä»¤å±æ€§ï¼Œåˆ¤æ–­æ¡ä»¶ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;template&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="c1">// isSpecialTemplateDirective æ˜¯ä½¿ç”¨ makeMap åˆ›å»ºçš„å‡½æ•°
</span><span class="c1"></span>        <span class="c1">// å³ key =&gt; true/false çš„ä¸€äº›å‡½æ•°
</span><span class="c1"></span>        <span class="nx">p</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">isSpecialTemplateDirective</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
      <span class="p">)</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ˜¯æ¨¡æ¿çš„å‰ææ˜¯æœ‰æŒ‡ä»¤ï¼Œå¹¶ä¸”æ˜¯ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤(if, else, else-if, slot, for)
</span><span class="c1"></span>    <span class="nx">tagType</span> <span class="o">=</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-52" class="outline-4">
<h4 id="headline-52">
é˜¶æ®µäº”(<a href="#test-element-12">&lt;div â€¦&gt;&lt;/div&gt;\n&lt;div â€¦&gt;&lt;/div&gt;</a>)
</h4>
</div>
</div>
</div>
<div id="outline-container-parse-parsetext" class="outline-3">
<h3 id="parse-parsetext">
parseText(context, mode)
</h3>
<div id="outline-text-parse-parsetext" class="outline-text-3">
<p>
è§£ææ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°(<code class="verbatim">&lt;</code>, <code class="verbatim">{{</code>, <code class="verbatim">]]&gt;</code>)ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span> <span class="nx">mode</span>: <span class="kt">TextModes</span><span class="p">)</span><span class="o">:</span> <span class="nx">TextNode</span> <span class="p">{</span>
      <span class="nx">__TEST__</span> <span class="o">&amp;&amp;</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

      <span class="kr">const</span> <span class="nx">endTokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">CDATA</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">endTokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;]]&gt;&#39;</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nx">endIndex</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">endTokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">endTokens</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">endIndex</span> <span class="o">&gt;</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">endIndex</span> <span class="o">=</span> <span class="nx">index</span>
          <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">__TEST__</span> <span class="o">&amp;&amp;</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">endIndex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

      <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
      <span class="c1">// æ–‡æœ¬å†…å®¹å¯èƒ½åŒ…å« &amp;gt; &amp;lt; &amp;amp; &amp;apos; &amp;quot; ç­‰htmlç¬¦å·ï¼Œéœ€è¦
</span><span class="c1"></span>      <span class="c1">// å°†ä»–ä»¬æ›¿æ¢æˆå¯¹åº” &gt;    &lt;    &amp;     &#39;      &#34;
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">endIndex</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span>

      <span class="k">return</span> <span class="p">{</span>
          <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
          <span class="nx">content</span><span class="p">,</span>
          <span class="nx">loc</span>: <span class="kt">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¯¼å›¾ï¼š</p>
<p>
<img src="/img/vue3/compiler-core/functions/parse-ts-parsetext.png" alt="/img/vue3/compiler-core/functions/parse-ts-parsetext.png" title="/img/vue3/compiler-core/functions/parse-ts-parsetext.png" /></p>
</div>
</div>
<div id="outline-container-parse-parsetextdata" class="outline-3">
<h3 id="parse-parsetextdata">
parseTextData(context, length, mode)
</h3>
<div id="outline-text-parse-parsetextdata" class="outline-text-3">
<p>
æ–‡æœ¬èŠ‚ç‚¹å¯èƒ½åŒ…å«æ•°æ®ï¼Œé€šè¿‡ <strong>context.options.decodeEntities(???)</strong> æ¥è§£æã€‚</p>
<p>
ä¸€äº›å­—ç¬¦çš„ html ä¹¦å†™æ ¼å¼ï¼Œæœ‰ <code class="verbatim">/&amp;(gt|lt|amp|apos|quot);/</code> ï¼Œæœ€ç»ˆä¼šè¢«å¯¹åº”çš„å­—ç¬¦æ›¿æ¢æ‰ã€‚</p>
<p>
<code class="verbatim">decodeEntities: (rawText: string): string =&gt; rawText.replace(decodeRE, (_, p1) =&gt; decodeMap[p1])</code></p>
<p>
å­—ç¬¦é›†ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kr">const</span> <span class="nx">decodeMap</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">string</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">gt</span><span class="o">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
      <span class="nx">lt</span><span class="o">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
      <span class="nx">amp</span><span class="o">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
      <span class="nx">apos</span><span class="o">:</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">,</span>
      <span class="nx">quot</span><span class="o">:</span> <span class="s1">&#39;&#34;&#39;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="cm">/**
</span><span class="cm">   ,* Get text data with a given length from the current location.
</span><span class="cm">   ,* This translates HTML entities in the text data.
</span><span class="cm">   ,*/</span>
  <span class="kd">function</span> <span class="nx">parseTextData</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="nx">length</span>: <span class="kt">number</span><span class="p">,</span>
      <span class="nx">mode</span>: <span class="kt">TextModes</span>
  <span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">rawText</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span>
      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span>
          <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RAWTEXT</span> <span class="o">||</span>
              <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">CDATA</span> <span class="o">||</span>
              <span class="nx">rawText</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span>
      <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">rawText</span> <span class="c1">// å¦‚æœä¸åŒ…å« &amp;gt; &amp;lt; ç­‰htmlæ ‡è®°
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// DATA or RCDATA containing &#34;&amp;&#34;&#34;. Entity decoding required.
</span><span class="c1"></span>          <span class="c1">// å¦‚æœå­—ç¬¦ä¸²ä¸­åŒ…å«è¿™äº›å­—ç¬¦ï¼Œå¾—å»å°†ä»–ä»¬æ›¿æ¢æˆå¯¹åº”çš„æ˜æ–‡å­—ç¬¦ã€‚
</span><span class="c1"></span>          <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">decodeEntities</span><span class="p">(</span>
              <span class="nx">rawText</span><span class="p">,</span>
              <span class="nx">mode</span> <span class="o">===</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">ATTRIBUTE_VALUE</span>
          <span class="p">)</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¯¼å›¾ï¼š
<img src="/img/vue3/compiler-core/functions/parse-ts-parsetextdata.png" alt="/img/vue3/compiler-core/functions/parse-ts-parsetextdata.png" title="/img/vue3/compiler-core/functions/parse-ts-parsetextdata.png" /></p>
</div>
</div>
<div id="outline-container-parse-parseattributes" class="outline-3">
<h3 id="parse-parseattributes">
parseAttributes(context, type)
</h3>
<div id="outline-text-parse-parseattributes" class="outline-text-3">
<p>
è¿™é‡Œå®šä¹‰ <code class="verbatim">props[]</code> æ•°ç»„ï¼ŒçœŸæ­£è§£æå•ä¸ªå±æ€§çš„åœ¨ <a href="#parse-parseattribute">parseAttribute</a> ä¸­ï¼Œè§£æä¹‹åçš„å•ä¸ª
å±æ€§è§£æ„ä¿å­˜åˆ°æ•°ç»„ä¸­ï¼Œè¿”å›ç»™å½“å‰ç»„ä»¶ä½œä¸º <code class="verbatim">props</code> å±æ€§å­—æ®µå­˜åœ¨ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="c1">// è§£ææ ‡ç­¾æ‰€æœ‰å±æ€§
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">parseAttributes</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">props</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kr">const</span> <span class="nx">attributeNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;&gt;&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;/&gt;&#34;</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// éæ³•å±æ€§ï¼Œ &lt;div /v-if=&#34;ok&#34;&gt;&lt;/div&gt;??
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">UNEXPECTED_SOLIDUS_IN_TAG</span><span class="p">);</span>
        <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// &lt;/div&gt; ç»“æŸæ ‡ç­¾ï¼Œä»¥å±æ€§ç»“æŸçš„æ ‡ç­¾?
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">END_TAG_WITH_ATTRIBUTES</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// é€ä¸ªè§£æå±æ€§
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">parseAttribute</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">attributeNames</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">Start</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">props</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">attr</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="sr">/^[^\t\r\n\f /&gt;]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">MISSING_WHITESPACE_BETWEEN_ATTRIBUTES</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">props</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-parseattribute" class="outline-3">
<h3 id="parse-parseattribute">
parseAttribute(context, nameSet)
</h3>
<div id="outline-text-parse-parseattribute" class="outline-text-3">
<p>
è§£ææ ‡ç­¾å±æ€§æˆ–æŒ‡ä»¤ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseAttribute</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">nameSet</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">nameSet</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// é‡å¤å±æ€§å
</span><span class="c1"></span>      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">DUPLICATE_ATTRIBUTE</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">nameSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// =name=value ?
</span><span class="c1"></span>      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">UNEXPECTED_EQUALS_SIGN_BEFORE_ATTRIBUTE_NAME</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/[&#34;&#39;&lt;]/g</span>
      <span class="kd">let</span> <span class="nx">m</span>
      <span class="k">while</span> <span class="p">((</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">pater</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">name</span><span class="p">)))</span> <span class="p">{</span>
        <span class="c1">// ä¸åˆæ³•çš„å±æ€§å
</span><span class="c1"></span>        <span class="nx">emitError</span><span class="p">(</span>
          <span class="nx">context</span><span class="p">,</span>
          <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME</span><span class="p">,</span>
          <span class="nx">m</span><span class="p">.</span><span class="nx">index</span>
        <span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// ç§»åŠ¨æŒ‡é’ˆ
</span><span class="c1"></span>    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>

    <span class="c1">// type: { content, isQuoted, loc }
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">value</span>

    <span class="c1">// å»ç©ºæ ¼è§£æå±æ€§å€¼
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="sr">/^[\t\r\n\f ]*=/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// å±æ€§åä¸ = ä¹‹é—´å­˜åœ¨ç©ºæ ¼çš„æƒ…å†µï¼Œå»æ‰ç©ºæ ¼
</span><span class="c1"></span>      <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nx">advanceSpaces</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
      <span class="c1">// å»æ‰ç©ºæ ¼ä¹‹åè§£æå±æ€§å€¼
</span><span class="c1"></span>      <span class="nx">value</span> <span class="o">=</span> <span class="nx">parseAttributeValue</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">MISSING_ATTRIBUTE_VALUE</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">loc</span> <span class="o">=</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span>

    <span class="c1">// v-dir æˆ– ç¼©å†™
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">inVPre</span> <span class="o">&amp;&amp;</span> <span class="sr">/^(v-|:|@|#)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// ?: éæ•è·ç»„
</span><span class="c1"></span>      <span class="c1">// 1. (?:^v-([a-z0-9]+))? -&gt; åŒ¹é… v-dir æŒ‡ä»¤ï¼Œéè´ªå©ªåŒ¹é…ï¼Œæ•è·æŒ‡ä»¤å
</span><span class="c1"></span>      <span class="c1">//   ç§°([a-z0=9]+)
</span><span class="c1"></span>      <span class="c1">// 2. (?:(?::|^@|^#)([^\.]+))? -&gt; åŒ¹é… :,@,#
</span><span class="c1"></span>      <span class="c1">// 3. (.+)?$ åŒ¹é…ä»»æ„å­—ç¬¦
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/(?:^v-([a-z0-9]+))?(?:(?::|^@|^#)([^\.]+))?(.+)?$/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span>
        <span class="nx">name</span>
      <span class="p">)</span>

      <span class="kd">let</span> <span class="nx">arg</span>

      <span class="c1">// ([a-z0-9]+), ([^\.]+)
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">startOffset</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="kr">const</span> <span class="nx">loc</span> <span class="o">=</span> <span class="nx">getSelection</span><span class="p">(</span>
          <span class="nx">context</span><span class="p">,</span>
          <span class="nx">getNewPosition</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">startOffset</span><span class="p">),</span>
          <span class="nx">getNewPosition</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">startOffset</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="kd">let</span> <span class="nx">isStatic</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// é™æ€å±æ€§å
</span><span class="c1"></span>
        <span class="c1">// åŠ¨æ€å±æ€§åè§£æ
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">isStatic</span> <span class="o">=</span> <span class="kc">false</span>

          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">content</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// å¦‚æœæ˜¯åŠ¨æ€å±æ€§åï¼Œå¿…é¡»æ˜¯ [varName] å½¢å¼
</span><span class="c1"></span>            <span class="nx">emitError</span><span class="p">(</span>
              <span class="nx">context</span><span class="p">,</span>
              <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END</span>
            <span class="p">)</span>
          <span class="p">}</span>

          <span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">arg</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
          <span class="nx">content</span><span class="p">,</span>
          <span class="nx">isStatic</span><span class="p">,</span>
          <span class="nx">isConstant</span><span class="o">:</span> <span class="nx">isStatic</span><span class="p">,</span>
          <span class="nx">loc</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// å±æ€§æ˜¯å¦è¢«å¼•å·åŒ…èµ·æ¥
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">isQuoted</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">valueLoc</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">loc</span>
        <span class="nx">valueLoc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">offset</span><span class="o">++</span>
        <span class="nx">valueLoc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">column</span><span class="o">++</span>
        <span class="nx">valueLoc</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">advancePositionWithClone</span><span class="p">(</span><span class="nx">valueLoc</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
        <span class="c1">// å–å¼•å·å†…çš„æ‰€æœ‰å†…å®¹
</span><span class="c1"></span>        <span class="nx">valueLoc</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">valueLoc</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span><span class="p">,</span>
        <span class="c1">// : -&gt; v-bind, @ -&gt; v-on, # -&gt; v-slot çš„ç¼©å†™
</span><span class="c1"></span>        <span class="nx">name</span><span class="o">:</span>
        <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
          <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;bind&#39;</span> <span class="o">:</span> <span class="nx">name</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;on&#39;</span> <span class="o">:</span> <span class="s1">&#39;slot&#39;</span><span class="p">),</span>
        <span class="nx">exp</span><span class="o">:</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="p">{</span>
          <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">,</span>
          <span class="nx">content</span><span class="o">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
          <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">loc</span><span class="o">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">loc</span>
        <span class="p">},</span>
        <span class="nx">arg</span><span class="p">,</span>
        <span class="c1">// ä¿®é¥°ç¬¦å¤„ç†, v-bind.m1.m2 -&gt; .m1.m2 -&gt; [&#39;m1&#39;, &#39;m2&#39;]
</span><span class="c1"></span>        <span class="nx">modifiers</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nx">substr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="p">[],</span>
        <span class="nx">loc</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ATTRIBUTE</span><span class="p">,</span>
      <span class="nx">name</span><span class="p">,</span>
      <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">loc</span>
      <span class="p">},</span>
      <span class="nx">loc</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¯¥å‡½æ•°å®ç°ä¸»è¦æœ‰å‡ éƒ¨åˆ†(ä»¥ <code>&lt;div v-bind:keyup.enter.prevent=&#34;ok&#34;&gt;&lt;/div&gt;</code> ä¸ºä¾‹)ï¼š</p>
<ol>
<li>
<p>åŒ¹é…å±æ€§åï¼Œå…³é”®æ­£åˆ™ï¼š <code>/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</code> ä¼šå°†
<code>v-if=&#34;varname&#34;</code> ä¸­ç­‰å·å‰é¢çš„ <code>v-bind:keyup.enter.prevent</code> éƒ½åŒ¹é…å‡ºæ¥ã€‚</p>
</li>
<li>
<p>å°†åŒ¹é…åˆ°çš„å±æ€§åæ”¶é›†åˆ° <code class="verbatim">nameSet[]</code> ä¸­ï¼Œæ£€æµ‹é‡å¤æ€§ã€‚</p>
<p>
<font color='purple'>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå±æ€§ååŒ¹é…çš„ç»“æœä¼šå°†å˜é‡åï¼Œ
ä¿®é¥°ç¬¦éƒ½åŒ¹é…åˆ°ï¼Œå¦‚ï¼š <code>&lt;div v-bind:keyup.enter.prevent=&#34;ok&#34;&gt;</code> ï¼Œæœ€å
add åˆ° nameSet ä¸­çš„å®Œæ•´å±æ€§åä¸ºï¼š <code>v-bind:keyup.enter.prevent</code> ã€‚
</font></p>
</li>
<li>
<p>éæ³•å±æ€§åæ£€æµ‹(å¦‚ï¼š <code>=name=value</code> ï¼Œæˆ–å±æ€§åä¸­åŒ…å« <code class="verbatim">[&#34;&#39;&lt;]</code> å­—ç¬¦)ï¼Œå¼‚å¸¸</p>
</li>
<li>
<p>ç§»åŠ¨æŒ‡é’ˆ <code class="verbatim">advanceBy(context, name.length)</code> å®šä½åˆ°å±æ€§ååçš„ä½ç½®ï¼Œç›®çš„æ˜¯ä¸ºäº†å–
å±æ€§å€¼ï¼Œå‰©ä¸‹ï¼š <code class="verbatim">=&#34;ok&#34;</code> ã€‚</p>
</li>
<li>
<p>æ­£åˆ™ï¼š <code class="verbatim">/^[\t\r\n\f ]*=/</code> ï¼Œè§£æå±æ€§å€¼ï¼Œè°ƒç”¨ <a href="#pars-parseattributevalue">parseAttributeValue</a> è§£æå‡ºå±æ€§å€¼æ¥</p>
<ol>
<li>
<p>æŒ‡é’ˆå½’ä½è‡³å¼€å§‹ä½ç½®ï¼Œå¦‚ï¼š <code>v-bind:keyup.enter.prevent=&#34;ok&#34;</code> çš„å¼€å§‹ä½ç½®ä¸º
<code>v</code> ä½ç½®ï¼Œè§£æä¿®é¥°ç¬¦ï¼Œå¾—åˆ° <code>modifiers: []</code> ï¼Œè¿™é‡Œçš„å…³é”®åœ¨äºæ­£
åˆ™ï¼š <code>/(?:^v-([a-z0-9]+))?(?:(?::|^@|^#)([^\.]+))?(.+)?$/i</code> ï¼Œä¼šåŒ¹é… <code>v-if,
:, @, #...</code> æŒ‡ä»¤å’ŒæŒ‡ä»¤ç¼©å†™ä»¥åŠä¿®é¥°ç¬¦ã€‚</p>
</li>
<li>
<p>è§£ææŒ‡ä»¤åé¢çš„å˜é‡åç§°ï¼Œå¦‚ï¼š <code class="verbatim">keyup</code> ï¼Œæœ‰å¯èƒ½æ˜¯åŠ¨æ€å€¼ <code class="verbatim">v-bind:[varname]</code> ã€‚</p>
</li>
<li>
<p>æ£€æµ‹å±æ€§å€¼æœ‰æ²¡è¢«å¼•å·åŒ…èµ·æ¥ï¼Œå¦‚æœæœ‰ï¼Œè¦æ›´æ–° <code class="verbatim">value.loc</code> ï¼Œåªå–å¼•å·å†…çš„å†…å®¹
<code>content.source = valueLoc.source.slice(1, -1)</code></p>
</li>
<li>
<p>è¿”å›æŒ‡ä»¤èŠ‚ç‚¹ç±»å‹å¯¹è±¡</p>
</li>
</ol>
</li>
<li>
<p>å¦åˆ™è¿”å›æ™®é€šå±æ€§ç±»å‹èŠ‚ç‚¹</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-parse-parseattributevalue" class="outline-3">
<h3 id="parse-parseattributevalue">
parseAttributeValue(context)
</h3>
<div id="outline-text-parse-parseattributevalue" class="outline-text-3">
<p>
è§£æå±æ€§å€¼ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseAttributeValue</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ä¿å­˜æ¨¡æ¿å­—ç¬¦ä¸²æŒ‡é’ˆèµ·ç‚¹ä½ç½®
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nx">content</span>

    <span class="kr">const</span> <span class="nx">quote</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">isQuoted</span> <span class="o">=</span> <span class="nx">quote</span> <span class="o">===</span> <span class="sb">`&#34;`</span> <span class="o">||</span> <span class="nx">quote</span> <span class="o">===</span> <span class="sb">`&#39;`</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isQuoted</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// æœ‰å¼•å·
</span><span class="c1"></span>      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">endIndex</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">quote</span><span class="p">)</span>
      <span class="c1">// æ²¡æœ‰ç»“æŸå¼•å·??? æ•´ä¸ª source å½“åšæ–‡æœ¬æ•°æ®å¤„ç†???
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">((</span><span class="nx">endIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">content</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span>
          <span class="nx">context</span><span class="p">,</span>
          <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">TextModes</span><span class="p">.</span><span class="nx">ATTRIBUTE_VALUE</span>
        <span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">content</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">endIndex</span><span class="p">,</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">ATTRIBUTE_VALUE</span><span class="p">)</span>
        <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// æ²¡æœ‰å¼•å·
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="sr">/^[^\t\r\n\f &gt;]+/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ— å±æ€§å€¼
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">undefined</span>
      <span class="p">}</span>

      <span class="kr">const</span> <span class="nx">unexpectedChars</span> <span class="o">=</span> <span class="sr">/[&#34;&#39;&lt;=`]/g</span>
      <span class="kd">let</span> <span class="nx">m</span>
      <span class="k">while</span> <span class="p">((</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">unexpectedChars</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
        <span class="c1">// æ— å¼•å·å€¼ä¸­éæ³•å­—ç¬¦æ£€æµ‹
</span><span class="c1"></span>        <span class="nx">emitError</span><span class="p">(</span>
          <span class="nx">context</span><span class="p">,</span>
          <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE</span>
        <span class="p">)</span>
      <span class="p">}</span>

      <span class="c1">// è§£ææ–‡æœ¬æ•°æ®
</span><span class="c1"></span>      <span class="nx">content</span> <span class="o">=</span> <span class="nx">parseTextData</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">ATTRIBUTE_VALUE</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">isQuoted</span><span class="p">,</span> <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-58" class="outline-3">
<h3 id="headline-58">
<span class="todo">DONE</span>
parseCDATA(context, ancestors)
</h3>
<div id="outline-text-headline-58" class="outline-text-3">
<p>CLOSED: [2020-09-02 Wed 23:14]</p>
<ul>
<li>
<p>State &#34;DONE&#34;       from &#34;TODO&#34;       [2020-09-02 Wed 23:14]</p>
</li>
</ul>
<p>è§£æ <code>&lt;![CDATA[....]]</code> xml ç±»å‹æ³¨é‡Šã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="c1">// &lt;![CDATA[...
</span><span class="c1"></span>  <span class="kd">function</span> <span class="nx">parseCDATA</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span> <span class="c1">// `&lt;![CDATA[`.length = 9
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">parseChildren</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">CDATA</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_CDATA</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-59" class="outline-3">
<h3 id="headline-59">
<span class="todo">DONE</span>
parseBogusComment(context)
</h3>
<div id="outline-text-headline-59" class="outline-text-3">
<p>CLOSED: [2020-09-02 Wed 23:11]</p>
<ul>
<li>
<p>State &#34;DONE&#34;       from &#34;TODO&#34;       [2020-09-02 Wed 23:11]</p>
</li>
</ul>
<p>è§£æä¸€äº›æ³¨é‡Šæ€§çš„ç»“æ„ï¼Œå¦‚ï¼š <code>&lt;!DOCTYPE</code> ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">parseBogusComment</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">contentStart</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;?&#34;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">content</span><span class="p">;</span>

    <span class="kr">const</span> <span class="nx">closeIndex</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;&gt;&#34;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">closeIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// æ²¡æœ‰ç»“æŸç´¢å¼•ï¼Œåé¢æ‰€æœ‰çš„éƒ½å°†æˆä¸ºæ³¨é‡Š
</span><span class="c1"></span>      <span class="nx">content</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">contentStart</span><span class="p">);</span>
      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">contentStart</span><span class="p">,</span> <span class="nx">closeIndex</span><span class="p">);</span>
      <span class="c1">// å®šä½åˆ°æ³¨é‡Šåé¢çš„å­—ç¬¦
</span><span class="c1"></span>      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">closeIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">,</span>
      <span class="nx">content</span><span class="p">,</span>
      <span class="nx">loc</span><span class="o">:</span> <span class="nx">getSelection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span>
    <span class="p">};</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-pushnode" class="outline-3">
<h3 id="parse-pushnode">
pushNode(nodes, node)
</h3>
<div id="outline-text-parse-pushnode" class="outline-text-3">
<ol>
<li>
<p>æ³¨é‡ŠèŠ‚ç‚¹ä¸å¤„ç†</p>
</li>
<li>
<p>åˆå¹¶æ–‡æœ¬èŠ‚ç‚¹(å‰ææ˜¯ prev, node ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ç´§æŒ¨ç€çš„ï¼Œç”± <code class="verbatim">loc.end.offset</code> å’Œ
<code class="verbatim">loc.start.offset</code> åˆ¤æ–­)</p>
</li>
<li>
<p>è¿”å›æ–°å¢ node çš„ nodes èŠ‚ç‚¹æ•°ç»„</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">pushNode</span><span class="p">(</span><span class="nx">nodes</span><span class="o">:</span> <span class="nx">TemplateChildNode</span><span class="p">[],</span> <span class="nx">node</span><span class="o">:</span> <span class="nx">TemplateChildNode</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// ignore comments in production
</span><span class="c1"></span>    <span class="cm">/* istanbul ignore next */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ä¸¤ä¸ªè¿ç€çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‹¼å‡‘åˆ°ä¸€èµ·å»
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span>
      <span class="c1">// Merge if both this and the previous node are text and those are
</span><span class="c1"></span>      <span class="c1">// consecutive. This happens for cases like &#34;a &lt; b&#34;.
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">prev</span> <span class="o">&amp;&amp;</span>
          <span class="nx">prev</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span> <span class="o">&amp;&amp;</span>
          <span class="nx">prev</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">offset</span> <span class="o">===</span> <span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">offset</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="nx">prev</span><span class="p">.</span><span class="nx">content</span> <span class="o">+=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">content</span>
        <span class="nx">prev</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">end</span>
        <span class="nx">prev</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">source</span> <span class="o">+=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">source</span>
        <span class="k">return</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-isend" class="outline-3">
<h3 id="parse-isend">
isEnd(context, mode, ancestors)
</h3>
<div id="outline-text-parse-isend" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">isEnd</span><span class="p">(</span>
    <span class="nx">context</span><span class="o">:</span> <span class="nx">ParserContext</span><span class="p">,</span>
    <span class="nx">mode</span><span class="o">:</span> <span class="nx">TextModes</span><span class="p">,</span>
    <span class="nx">ancestors</span><span class="o">:</span> <span class="nx">ElementNode</span><span class="p">[]</span>
  <span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s1">&#39;&lt;/&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="c1">//TODO: probably bad performance
</span><span class="c1"></span>          <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">ancestors</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">ancestors</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span>

      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RCDATA</span><span class="o">:</span>
      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">RAWTEXT</span><span class="o">:</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="nx">ancestors</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">startsWithEndTagOpen</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">break</span>
      <span class="p">}</span>

      <span class="k">case</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">CDATA</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s1">&#39;]]&gt;&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">break</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">!</span><span class="nx">s</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-getCursor" class="outline-3">
<h3 id="parse-getCursor">
getCursor(context)
</h3>
<div id="outline-text-parse-getCursor" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">)</span><span class="o">:</span> <span class="nx">Position</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">column</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">offset</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">column</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">offset</span> <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-parse-getselection" class="outline-3">
<h3 id="parse-getselection">
getSelection(context, start, end?: Postion)
</h3>
<div id="outline-text-parse-getselection" class="outline-text-3">
<p>
å–å®æ—¶è§£æåçš„ sourceï¼Œstartï¼Œend çš„å€¼ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kd">function</span> <span class="nx">getSelection</span><span class="p">(</span>
      <span class="nx">context</span>: <span class="kt">ParserContext</span><span class="p">,</span>
      <span class="nx">start</span>: <span class="kt">Position</span><span class="p">,</span>
      <span class="nx">end?</span>: <span class="kt">Position</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">SourceLocation</span> <span class="p">{</span>
      <span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">||</span> <span class="nx">getCursor</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">{</span>
          <span class="nx">start</span><span class="p">,</span>
          <span class="nx">end</span><span class="p">,</span>
          <span class="nx">source</span>: <span class="kt">context.originalSource.slice</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">end</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-64" class="outline-2">
<h2 id="headline-64">
é‡è¦ç±»å‹å£°æ˜
</h2>
<div id="outline-text-headline-64" class="outline-text-2">
<p>
è¯¥æ¨¡å—æ‰€æœ‰ç±»å‹å£°æ˜ç»Ÿä¸€å½’ç±»åˆ°æ­¤ï¼Œé¡ºåºæŒ‰ç…§ç”¨ä¾‹è§£æé‡åˆ°çš„é¡ºåºä¸ºä¸»ã€‚</p>
<div id="outline-container-headline-65" class="outline-3">
<h3 id="headline-65">
defaultParserOptions
</h3>
<div id="outline-text-headline-65" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// é»˜è®¤çš„è§£æå™¨é€‰é¡¹
</span><span class="c1"></span>  <span class="kr">export</span> <span class="kr">const</span> <span class="nx">defaultParserOptions</span>: <span class="kt">MergedParserOptions</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">delimiters</span><span class="o">:</span> <span class="p">[</span><span class="sb">`{{`</span><span class="p">,</span> <span class="sb">`}}`</span><span class="p">],</span>
      <span class="nx">getNamespace</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">Namespaces</span><span class="p">.</span><span class="nx">HTML</span><span class="p">,</span> <span class="c1">// å‘½åç©ºé—´
</span><span class="c1"></span>      <span class="nx">getTextMode</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">TextModes</span><span class="p">.</span><span class="nx">DATA</span><span class="p">,</span> <span class="c1">// æ–‡æœ¬ç±»å‹
</span><span class="c1"></span>      <span class="nx">isVoidTag</span>: <span class="kt">NO</span><span class="p">,</span> <span class="c1">// è‡ªå…³é—­æ ‡ç­¾???ï¼Œå¦‚ï¼š&lt;img&gt;, &lt;hr&gt; ...
</span><span class="c1"></span>      <span class="nx">isPreTag</span>: <span class="kt">NO</span><span class="p">,</span> <span class="c1">// &lt;pre&gt; ä»£ç æ ‡ç­¾???ï¼Œéœ€è¦ä¿ç•™ç©ºæ ¼ä¿è¯ç¼©è¿›çš„
</span><span class="c1"></span>      <span class="nx">isCustomElement</span>: <span class="kt">NO</span><span class="p">,</span> <span class="c1">// è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¦‚ï¼šTransition
</span><span class="c1"></span>      <span class="nx">decodeEntities</span><span class="o">:</span> <span class="p">(</span><span class="nx">rawText</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="o">=&gt;</span>
          <span class="c1">// è§£ç å®ä¾‹ï¼Œä¸€äº›ç‰¹æ®Šç¬¦å·è¡¨ç¤ºï¼Œå¦‚ï¼š&amp;gt;, &amp;lt;, &amp;amp;, &amp;apos; &amp;quot;
</span><span class="c1"></span>          <span class="nx">rawText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">decodeRE</span><span class="p">,</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">p1</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">decodeMap</span><span class="p">[</span><span class="nx">p1</span><span class="p">]),</span>
      <span class="nx">onError</span>: <span class="kt">defaultOnError</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-td-vars-textmodes" class="outline-3">
<h3 id="td-vars-textmodes">
TextModes
</h3>
<div id="outline-text-td-vars-textmodes" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kr">export</span> <span class="kr">const</span> <span class="kr">enum</span> <span class="nx">TextModes</span> <span class="p">{</span>
      <span class="c1">//          | Elements | Entities | End sign              | Inside of
</span><span class="c1"></span>      <span class="nx">DATA</span><span class="p">,</span> <span class="c1">//    | âœ”        | âœ”        | End tags of ancestors |
</span><span class="c1"></span>      <span class="nx">RCDATA</span><span class="p">,</span> <span class="c1">//  | âœ˜        | âœ”        | End tag of the parent | &lt;textarea&gt;
</span><span class="c1"></span>      <span class="nx">RAWTEXT</span><span class="p">,</span> <span class="c1">// | âœ˜        | âœ˜        | End tag of the parent | &lt;style&gt;,&lt;script&gt;
</span><span class="c1"></span>      <span class="nx">CDATA</span><span class="p">,</span>
      <span class="nx">ATTRIBUTE_VALUE</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-td-parser-options" class="outline-3">
<h3 id="td-parser-options">
ParserOptions
</h3>
<div id="outline-text-td-parser-options" class="outline-text-3">
<p>
å®šä¹‰ä½ç½®ï¼š</p>
<font color="purple"> src/options.ts</font>
<p>
æ¥å£å†…å®¹ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ParserOptions</span> <span class="p">{</span>
      <span class="cm">/**
</span><span class="cm">       ,* e.g. platform native elements, e.g. &lt;div&gt; for browsers
</span><span class="cm">       ,*/</span>
      <span class="nx">isNativeTag</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span>
      <span class="cm">/**
</span><span class="cm">       ,* e.g. native elements that can self-close, e.g. &lt;img&gt;, &lt;br&gt;, &lt;hr&gt;
</span><span class="cm">       ,*/</span>
      <span class="nx">isVoidTag</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span>
      <span class="cm">/**
</span><span class="cm">       ,* e.g. elements that should preserve whitespace inside, e.g. &lt;pre&gt;
</span><span class="cm">       ,*/</span>
      <span class="nx">isPreTag</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span>
      <span class="cm">/**
</span><span class="cm">       ,* Platform-specific built-in components e.g. &lt;Transition&gt;
</span><span class="cm">       ,*/</span>
      <span class="nx">isBuiltInComponent</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">symbol</span> <span class="o">|</span> <span class="k">void</span>
      <span class="cm">/**
</span><span class="cm">       ,* Separate option for end users to extend the native elements list
</span><span class="cm">       ,*/</span>
      <span class="nx">isCustomElement</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span>
      <span class="cm">/**
</span><span class="cm">       ,* Get tag namespace
</span><span class="cm">       ,*/</span>
      <span class="nx">getNamespace</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">parent</span>: <span class="kt">ElementNode</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Namespace</span>
      <span class="cm">/**
</span><span class="cm">       ,* Get text parsing mode for this element
</span><span class="cm">       ,*/</span>
      <span class="nx">getTextMode</span><span class="o">?:</span> <span class="p">(</span>
          <span class="nx">node</span>: <span class="kt">ElementNode</span><span class="p">,</span>
          <span class="nx">parent</span>: <span class="kt">ElementNode</span> <span class="o">|</span> <span class="kc">undefined</span>
      <span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">TextModes</span>
      <span class="cm">/**
</span><span class="cm">       ,* @default [&#39;{{&#39;, &#39;}}&#39;]
</span><span class="cm">       ,*/</span>
      <span class="nx">delimiters</span><span class="o">?:</span> <span class="p">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">]</span>
      <span class="cm">/**
</span><span class="cm">       ,* Only needed for DOM compilers
</span><span class="cm">       ,*/</span>
      <span class="nx">decodeEntities</span><span class="o">?:</span> <span class="p">(</span><span class="nx">rawText</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">asAttr</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">string</span>
      <span class="nx">onError</span><span class="o">?:</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">CompilerError</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å­—æ®µè¯´æ˜ï¼š</p>
<ol>
<li>
<p><code>isNativeTag?: (tag: string) =&gt; boolean</code> ä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ˜¯åŸç”Ÿæ ‡ç­¾(å¦‚ï¼šli, div)</p>
</li>
<li>
<p><code>isVoidTag?: (tag: string) =&gt; boolean</code>,è‡ªå…³é—­æ ‡ç­¾ï¼Œå¦‚ï¼šimg, br, hr</p>
</li>
<li>
<p><code>isPreTag?: (tag: string) =&gt; boolean</code> ï¼Œä»£ç æ ‡ç­¾ï¼Œéœ€è¦ç©ºæ ¼ç¼©è¿›çš„ï¼Œå¦‚ï¼špre</p>
</li>
<li>
<p><code>isBuiltInComponent?: (tag: string) =&gt; symbol | void</code> ï¼Œå¹³å°ç›¸å…³çš„å†…ç½®ç»„ä»¶ï¼Œå¦‚ï¼šTransition</p>
</li>
<li>
<p><code>isCoustomElement?: (tag: string) =&gt; boolean</code> ï¼Œç”¨æˆ·è‡ªå®šçš„æ ‡ç­¾</p>
</li>
<li>
<p><code>getNamespace?: (tag: string, parent: ElementNode | undefined) =&gt; Nâ„amespace</code> ï¼Œè·å–æ ‡ç­¾å‘½åç©ºé—´</p>
</li>
<li>
<p><code>getTextMode?: (node: ElementNode, parent: ElementNode|undefined) =&gt;
TextModes</code> è·å–æ–‡æœ¬è§£ææ¨¡å¼</p>
</li>
<li>
<p><code>delimiters?: [string, string]</code> ï¼Œæ’å€¼åˆ†éš”ç¬¦ï¼Œé»˜è®¤ï¼š <code>[&#39;{{&#39;, &#39;}}&#39;]</code></p>
</li>
<li>
<p><code>decodeEntities?: (rawText: string, asAttr: boolean) =&gt; string</code> ï¼Œä»…ç”¨äº DOM compilers</p>
</li>
<li>
<p><code>onError?: (error: CompilerError) =&gt; void</code></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-td-parser-context" class="outline-3">
<h3 id="td-parser-context">
ParserContext
</h3>
<div id="outline-text-td-parser-context" class="outline-text-3">
<p>
å®šä¹‰ä½ç½®ï¼š</p>
<font color="purple"> src/parse.ts</font>
<p>
æ¥å£å†…å®¹ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ParserContext</span> <span class="p">{</span>
      <span class="nx">options</span>: <span class="kt">MergedParserOptions</span> <span class="c1">// è§£æå™¨é€‰é¡¹ï¼Œå³åˆå¹¶ä¹‹åçš„å‚æ•°å¯¹è±¡
</span><span class="c1"></span>      <span class="kr">readonly</span> <span class="nx">originalSource</span>: <span class="kt">string</span> <span class="c1">// æœ€åˆçš„æºç ï¼Œå³è§£æä¹‹å‰çš„æœ€åŸå§‹çš„å­—ç¬¦ä¸²ï¼Œåªè¯»ç‰ˆæœ¬
</span><span class="c1"></span>      <span class="nx">source</span>: <span class="kt">string</span> <span class="c1">// è§£æä¸­çš„æºç å­—ç¬¦ä¸²ï¼Œä¼šå‘ç”Ÿå˜åŒ–çš„å­—ç¬¦ä¸²
</span><span class="c1"></span>      <span class="nx">offset</span>: <span class="kt">number</span> <span class="c1">// è§£æçš„æŒ‡é’ˆä½ç½®ï¼Œç±»ä¼¼æ–‡ä»¶è¯»å–æ˜¯çš„æŒ‡é’ˆåç§»é‡
</span><span class="c1"></span>      <span class="nx">line</span>: <span class="kt">number</span> <span class="c1">// è§£æä½ç½®åœ¨æºç ä¸­çš„å½“å‰è¡Œ
</span><span class="c1"></span>      <span class="nx">column</span>: <span class="kt">number</span> <span class="c1">// è§£æä½ç½®åœ¨æºç ä¸­çš„å½“å‰åˆ—
</span><span class="c1"></span>      <span class="nx">inPre</span>: <span class="kt">boolean</span> <span class="c1">// æ ‡è¯†æ˜¯ä¸æ˜¯ &lt;pre&gt; æ ‡ç­¾ï¼Œå¦‚æœæ˜¯éœ€è¦ä¿ç•™ç©ºæ ¼ä¿è¯ç¼©è¿›
</span><span class="c1"></span>      <span class="nx">inVPre</span>: <span class="kt">boolean</span> <span class="c1">// v-pre æŒ‡ä»¤ï¼Œä¸å¤„ç†æŒ‡ä»¤å’Œæ’å€¼(v-xxx, {{...}})
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-69" class="outline-2">
<h2 id="headline-69">
utils.ts
</h2>
<div id="outline-text-headline-69" class="outline-text-2">
<div id="outline-container-util-advancepositionwithmutation" class="outline-3">
<h3 id="util-advancepositionwithmutation">
advancePositionWithMutation(pos,source, numberOfCharacters)
</h3>
<div id="outline-text-util-advancepositionwithmutation" class="outline-text-3">
<p>
æ›´æ–° context çš„ lineï¼Œcolumnï¼Œoffset çš„å€¼</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// advance by mutation without cloning (for performance reasons), since this
</span><span class="c1"></span>  <span class="c1">// gets called a lot in the parser
</span><span class="c1"></span>  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">advancePositionWithMutation</span><span class="p">(</span>
      <span class="nx">pos</span>: <span class="kt">Position</span><span class="p">,</span>
      <span class="nx">source</span>: <span class="kt">string</span><span class="p">,</span>
      <span class="nx">numberOfCharacters</span>: <span class="kt">number</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">length</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">Position</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">linesCount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="kd">let</span> <span class="nx">lastNewLinePos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numberOfCharacters</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">===</span> <span class="mi">10</span> <span class="cm">/* newline char code */</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">linesCount</span><span class="o">++</span>
              <span class="nx">lastNewLinePos</span> <span class="o">=</span> <span class="nx">i</span>
          <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">pos</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="nx">numberOfCharacters</span>
      <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">+=</span> <span class="nx">linesCount</span>
      <span class="nx">pos</span><span class="p">.</span><span class="nx">column</span> <span class="o">=</span>
          <span class="nx">lastNewLinePos</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span>
          <span class="o">?</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">column</span> <span class="o">+</span> <span class="nx">numberOfCharacters</span>
          : <span class="kt">numberOfCharacters</span> <span class="o">-</span> <span class="nx">lastNewLinePos</span>

      <span class="k">return</span> <span class="nx">pos</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-stage_code" class="outline-2">
<h2 id="stage_code">
é˜¶æ®µä»£ç è®°å½•
</h2>
<div id="outline-text-stage_code" class="outline-text-2">
<ol>
<li>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-01-some-text">text01: some text çš„ä»£ç å¤‡ä»½</a></p>
</li>
<li>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-02-some-text-div-01">text02: some text \&lt;div&gt; 01 ä»£ç å¤‡ä»½</a></p>
</li>
<li>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-02-some-text-div-02">text02: some text \&lt;div&gt; 02 ä»£ç å¤‡ä»½</a></p>
</li>
<li>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-03-interpolation">text03: some {{ foo + bar }} text ä»£ç å¤‡ä»½</a></p>
</li>
<li>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-03-interpolation">text04: some {{ a&lt;b &amp;&amp; c&gt;d }} text ä»£ç å¤‡ä»½</a></p>
</li>
<li>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/comment-test">comment: &lt;!â€“xâ€“&gt;æ³¨é‡Šè§£æä»£ç å¤‡ä»½</a></p>
</li>
<li>
<p><a href="#test-element-12">test-element-v-pre ä»£ç å¤‡ä»½</a>, æ”¯æŒ v-pre å’Œ <code>&lt;pre&gt;</code> æ ‡ç­¾ï¼Œä»¥åŠæ¢è¡Œ</p>
</li>
</ol>
<p>
æ‰€æœ‰ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="err">âœ</span>  <span class="nx">packages</span> <span class="nx">git</span><span class="o">:</span><span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">âœ—</span> <span class="nx">jest</span> <span class="nx">compiler</span><span class="o">-</span><span class="nx">core</span> <span class="o">-</span><span class="nx">u</span>
  <span class="nx">PASS</span>  <span class="nx">compiler</span><span class="o">-</span><span class="nx">core</span><span class="o">/</span><span class="nx">__tests__</span><span class="o">/</span><span class="nx">parse</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">js</span> <span class="p">(</span><span class="mf">5.287</span> <span class="nx">s</span><span class="p">)</span>
  <span class="nx">compiler</span><span class="o">:</span> <span class="nx">parse</span>
  <span class="nx">Text</span>
  <span class="err">âœ“</span> <span class="nx">simple</span> <span class="nx">text</span> <span class="p">(</span><span class="mi">8</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">simple</span> <span class="nx">text</span> <span class="kd">with</span> <span class="nx">invalid</span> <span class="nx">end</span> <span class="nx">tag</span> <span class="p">(</span><span class="mi">3</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">text</span> <span class="kd">with</span> <span class="nx">interpolation</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">text</span> <span class="kd">with</span> <span class="nx">interpolation</span> <span class="nx">which</span> <span class="nx">has</span> <span class="sb">`&lt;`</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">text</span> <span class="kd">with</span> <span class="nx">mix</span> <span class="k">of</span> <span class="nx">tags</span> <span class="nx">and</span> <span class="nx">interpolations</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">lonly</span> <span class="s2">&#34;&lt;&#34;</span> <span class="nx">don</span><span class="s1">&#39;t separate nodes
</span><span class="s1">        âœ“ lonly &#34;{{&#34; don&#39;</span><span class="nx">t</span> <span class="nx">separate</span> <span class="nx">nodes</span>
  <span class="nx">Interpolation</span>
  <span class="err">âœ“</span> <span class="nx">simple</span> <span class="nx">interpolation</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">it</span> <span class="nx">can</span> <span class="nx">have</span> <span class="nx">tag</span><span class="o">-</span><span class="nx">like</span> <span class="nx">notation</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">it</span> <span class="nx">can</span> <span class="nx">have</span> <span class="nx">tag</span><span class="o">-</span><span class="nx">like</span> <span class="nx">notation</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">it</span> <span class="nx">can</span> <span class="nx">have</span> <span class="nx">tag</span><span class="o">-</span><span class="nx">like</span> <span class="nx">notation</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">custom</span> <span class="nx">delimiters</span>
  <span class="nx">Comment</span>
  <span class="err">âœ“</span> <span class="nx">empty</span> <span class="nx">comment</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">simple</span> <span class="nx">comment</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">two</span> <span class="nx">comments</span>
  <span class="nx">Element</span>
  <span class="err">âœ“</span> <span class="nx">simple</span> <span class="nx">div</span>
  <span class="err">âœ“</span> <span class="nx">empty</span> <span class="nx">div</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">self</span> <span class="nx">closing</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="k">void</span> <span class="nx">element</span>
  <span class="err">âœ“</span> <span class="nx">template</span> <span class="nx">element</span> <span class="kd">with</span> <span class="nx">directives</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">template</span> <span class="nx">element</span> <span class="nx">without</span> <span class="nx">directives</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="kr">native</span> <span class="nx">element</span> <span class="kd">with</span> <span class="sb">`isNativeTag`</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="kr">native</span> <span class="nx">element</span> <span class="nx">without</span> <span class="sb">`isNativeTag`</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">is</span> <span class="kd">with</span> <span class="sb">`isNativeTag`</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">is</span> <span class="nx">without</span> <span class="sb">`isNativeTag`</span> <span class="p">(</span><span class="mi">5</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">custom</span> <span class="nx">element</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">attribute</span> <span class="kd">with</span> <span class="nx">no</span> <span class="nx">value</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">attribute</span> <span class="kd">with</span> <span class="nx">empty</span> <span class="nx">value</span><span class="p">,</span> <span class="kr">double</span> <span class="nx">quote</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">attribute</span> <span class="kd">with</span> <span class="nx">empty</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">single</span> <span class="nx">quote</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">attribute</span> <span class="kd">with</span> <span class="nx">value</span><span class="p">,</span> <span class="kr">double</span> <span class="nx">quote</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">attribute</span> <span class="kd">with</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">single</span> <span class="nx">quote</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">attribute</span> <span class="kd">with</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">unquoted</span>
  <span class="err">âœ“</span> <span class="nx">multiple</span> <span class="nx">attributes</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">directive</span> <span class="kd">with</span> <span class="nx">no</span> <span class="nx">value</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">directive</span> <span class="kd">with</span> <span class="nx">value</span>
  <span class="err">âœ“</span> <span class="nx">directive</span> <span class="kd">with</span> <span class="nx">argument</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">directive</span> <span class="kd">with</span> <span class="nx">a</span> <span class="nx">modifier</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">directive</span> <span class="kd">with</span> <span class="nx">two</span> <span class="nx">modifiers</span>
  <span class="err">âœ“</span> <span class="nx">directive</span> <span class="kd">with</span> <span class="nx">argument</span> <span class="nx">and</span> <span class="nx">modifiers</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">bind</span> <span class="nx">shorthand</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">bind</span> <span class="nx">shorthand</span> <span class="kd">with</span> <span class="nx">modifier</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">on</span> <span class="nx">shorthand</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">on</span> <span class="nx">shorthand</span> <span class="kd">with</span> <span class="nx">modifier</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">slot</span> <span class="nx">shorthand</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">v</span><span class="o">-</span><span class="nx">pre</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">end</span> <span class="nx">tags</span> <span class="nx">are</span> <span class="k">case</span><span class="o">-</span><span class="nx">insensitive</span><span class="p">.</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="nx">Others</span>
  <span class="err">âœ“</span> <span class="nx">self</span> <span class="nx">closing</span> <span class="nx">single</span> <span class="nx">tag</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">self</span> <span class="nx">closing</span> <span class="nx">multiple</span> <span class="nx">tag</span> <span class="p">(</span><span class="mi">5</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">valid</span> <span class="nx">html</span> <span class="p">(</span><span class="mi">5</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">invalid</span> <span class="nx">html</span> <span class="p">(</span><span class="mi">54</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">parse</span> <span class="kd">with</span> <span class="nx">correct</span> <span class="nx">location</span> <span class="nx">info</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="nx">decodeEntities</span> <span class="nx">option</span>
  <span class="err">âœ“</span> <span class="nx">use</span> <span class="nx">the</span> <span class="nx">given</span> <span class="nx">map</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="nx">whitespace</span> <span class="nx">management</span>
  <span class="err">âœ“</span> <span class="nx">should</span> <span class="nx">remove</span> <span class="nx">whitespaces</span> <span class="nx">at</span> <span class="nx">start</span><span class="o">/</span><span class="nx">end</span> <span class="nx">inside</span> <span class="nx">an</span> <span class="nx">element</span>
  <span class="err">âœ“</span> <span class="nx">should</span> <span class="nx">remove</span> <span class="nx">whitespaces</span> <span class="nx">w</span><span class="o">/</span> <span class="nx">newline</span> <span class="nx">between</span> <span class="nx">elements</span>
  <span class="err">âœ“</span> <span class="nx">should</span> <span class="nx">remove</span> <span class="nx">whitespaces</span> <span class="nx">adjacent</span> <span class="nx">to</span> <span class="nx">comments</span> <span class="p">(</span><span class="mi">3</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">should</span> <span class="nx">remove</span> <span class="nx">whitespaces</span> <span class="nx">w</span><span class="o">/</span> <span class="nx">newline</span> <span class="nx">between</span> <span class="nx">comments</span> <span class="nx">and</span> <span class="nx">elements</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">should</span> <span class="nx">NOT</span> <span class="nx">remove</span> <span class="nx">whitespaces</span> <span class="nx">w</span><span class="o">/</span> <span class="nx">newline</span> <span class="nx">between</span> <span class="nx">interpolations</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">should</span> <span class="nx">NOT</span> <span class="nx">remove</span> <span class="nx">whitespaces</span> <span class="nx">w</span><span class="o">/</span><span class="nx">o</span> <span class="nx">newline</span> <span class="nx">between</span> <span class="nx">elements</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="nx">should</span> <span class="nx">condense</span> <span class="nx">consecutive</span> <span class="nx">whitespaces</span> <span class="k">in</span> <span class="nx">text</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="nx">Errors</span>
  <span class="nx">ABRUPT_CLOSING_OF_EMPTY_COMMENT</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span><span class="c">&lt;!--</span><span class="o">&gt;&lt;</span><span class="err">/template&gt; (3 ms)</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span><span class="c">&lt;!--</span><span class="o">-&gt;&lt;</span><span class="err">/template&gt; (2 ms)</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span><span class="c">&lt;!--</span><span class="o">--&gt;&lt;</span><span class="err">/template&gt; (1 ms)</span>
  <span class="nx">CDATA_IN_HTML_CONTENT</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="nx">cdata</span><span class="p">]]</span><span class="o">&gt;&lt;</span><span class="err">/template&gt; (2 ms)</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">svg</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="nx">cdata</span><span class="p">]]</span><span class="o">&gt;&lt;</span><span class="err">/svg&gt;&lt;/template&gt; (1 ms)</span>
  <span class="nx">DUPLICATE_ATTRIBUTE</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;/template&gt; (3 ms)</span>
  <span class="nx">END_TAG_WITH_ATTRIBUTES</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span><span class="o">&gt;&lt;</span><span class="err">/div id=&#34;&#34;&gt;&lt;/template&gt; (1 ms)</span>
  <span class="nx">END_TAG_WITH_TRAILING_SOLIDUS</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span><span class="o">&gt;&lt;</span><span class="sr">/div/</span><span class="o">&gt;&lt;</span><span class="err">/template&gt; (2 ms)</span>
  <span class="nx">EOF_BEFORE_TAG_NAME</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="err">/ (2 ms)</span>
  <span class="nx">EOF_IN_CDATA</span>
  <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">svg</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="nx">cdata</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                            <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">svg</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="nx">EOF_IN_COMMENT</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span><span class="c">&lt;!--</span><span class="nx">comment</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span><span class="c">&lt;!--</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;!</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;!-</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;!</span><span class="nx">abc</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="nx">EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="c">&lt;!--</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span> <span class="p">(</span><span class="mi">3</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="nx">EOF_IN_TAG</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span>  <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">id</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">id</span>  <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">id</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s1">&#39;abc (1 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&#34;abc (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&#39;</span><span class="nx">abc</span><span class="s1">&#39; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&#34;abc&#34; (4 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=abc (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&#39;</span><span class="nx">abc</span><span class="s1">&#39;/ (3 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&#34;abc&#34;/ (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=abc / (1 ms)
</span><span class="s1">        INCORRECTLY_CLOSED_COMMENT
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!--comment--!&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">        INCORRECTLY_OPENED_COMMENT
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!-&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!ELEMENT br EMPTY&gt;&lt;/template&gt; (3 ms)
</span><span class="s1">          âœ“ &lt;!DOCTYPE html&gt; (2 ms)
</span><span class="s1">        INVALID_FIRST_CHARACTER_OF_TAG_NAME
</span><span class="s1">          âœ“ &lt;template&gt;a &lt; b&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;ï¿½&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;a &lt;/ b&lt;/template&gt; (1 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;/ï¿½&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">          âœ“ &lt;template&gt;{{a &lt; b}}&lt;/template&gt; (1 ms)
</span><span class="s1">        MISSING_ATTRIBUTE_VALUE
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&gt;&lt;/div&gt;&lt;/template&gt; (3 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id= &gt;&lt;/div&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id= /&gt;&lt;/div&gt;&lt;/template&gt; (5 ms)
</span><span class="s1">        MISSING_END_TAG_NAME
</span><span class="s1">          âœ“ &lt;template&gt;&lt;/&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">        MISSING_WHITESPACE_BETWEEN_ATTRIBUTES
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&#34;foo&#34;class=&#34;bar&#34;&gt;&lt;/div&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div id=&#34;foo&#34;\x0d;\x0a;class=&#34;bar&#34;&gt;&lt;/div&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">        NESTED_COMMENT
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!--a&lt;!--b--&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!--a&lt;!--b&lt;!--c--&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!--a&lt;!--&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;!--a&lt;!-- (4 ms)
</span><span class="s1">        UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div a&#34;bc=&#39;&#39;&gt;&lt;/div&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div a&#39;</span><span class="nx">bc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;/template&gt; (3 ms)</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">a</span><span class="o">&lt;</span><span class="nx">bc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;/template&gt; (3 ms)</span>
                                                       <span class="nx">UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE</span>
                                                       <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">foo</span><span class="o">=</span><span class="nx">bar</span><span class="err">&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;/template&gt; (2 ms)</span>
          <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">foo</span><span class="o">=</span><span class="nx">bar</span><span class="s1">&#39;&gt;&lt;/div&gt;&lt;/template&gt; (3 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div foo=bar&lt;div&gt;&lt;/div&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div foo=bar=baz&gt;&lt;/div&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div foo=bar`&gt;&lt;/div&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">        UNEXPECTED_EQUALS_SIGN_BEFORE_ATTRIBUTE_NAME
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div =foo=bar&gt;&lt;/div&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div =&gt;&lt;/div&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">        UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME
</span><span class="s1">          âœ“ &lt;template&gt;&lt;?xml?&gt;&lt;/template&gt; (1 ms)
</span><span class="s1">        UNEXPECTED_SOLIDUS_IN_TAG
</span><span class="s1">          âœ“ &lt;template&gt;&lt;div a/b&gt;&lt;/div&gt;&lt;/template&gt; (2 ms)
</span><span class="s1">        X_INVALID_END_TAG
</span><span class="s1">          âœ“ &lt;template&gt;&lt;/div&gt;&lt;/template&gt;
</span><span class="s1">          âœ“ &lt;template&gt;&lt;/div&gt;&lt;/div&gt;&lt;/template&gt;
</span><span class="s1">          âœ“ &lt;template&gt;{{&#39;</span><span class="o">&lt;</span><span class="err">/div&gt;&#39;}}&lt;/template&gt; (1 ms)</span>
          <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">textarea</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;/textarea&gt; (1 ms)</span>
          <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">svg</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="o">&lt;</span><span class="err">/div&gt;]]&gt;&lt;/svg&gt;</span>
          <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">svg</span><span class="o">&gt;</span><span class="c">&lt;!--</span><span class="o">&lt;</span><span class="err">/div&gt;--&gt;&lt;/svg&gt;</span>
        <span class="nx">X_MISSING_END_TAG</span>
          <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span><span class="o">&gt;&lt;</span><span class="err">/template&gt; (1 ms)</span>
          <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;&lt;</span><span class="nx">div</span><span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
        <span class="nx">X_MISSING_INTERPOLATION_END</span>
          <span class="err">âœ“</span> <span class="p">{{</span> <span class="nx">foo</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>
          <span class="err">âœ“</span> <span class="p">{{</span> <span class="p">(</span><span class="mi">2</span> <span class="nx">ms</span><span class="p">)</span>
          <span class="err">âœ“</span> <span class="p">{{}}</span>
        <span class="nx">X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END</span>
          <span class="err">âœ“</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">v</span><span class="o">-</span><span class="nx">foo</span><span class="o">:</span><span class="p">[</span><span class="nx">sef</span> <span class="nx">fsef</span><span class="p">]</span> <span class="o">/&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="nx">ms</span><span class="p">)</span>

  <span class="nx">Test</span> <span class="nx">Suites</span><span class="o">:</span> <span class="mi">1</span> <span class="nx">passed</span><span class="p">,</span> <span class="mi">1</span> <span class="nx">total</span>
  <span class="nx">Tests</span><span class="o">:</span>       <span class="mi">135</span> <span class="nx">passed</span><span class="p">,</span> <span class="mi">135</span> <span class="nx">total</span>
  <span class="nx">Snapshots</span><span class="o">:</span>   <span class="mi">79</span> <span class="nx">passed</span><span class="p">,</span> <span class="mi">79</span> <span class="nx">total</span>
  <span class="nx">Time</span><span class="o">:</span>        <span class="mf">6.398</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">estimated</span> <span class="mi">20</span> <span class="nx">s</span>
  <span class="nx">Ran</span> <span class="nx">all</span> <span class="nx">test</span> <span class="nx">suites</span> <span class="nx">matching</span> <span class="o">/</span><span class="nx">compiler</span><span class="o">-</span><span class="nx">core</span><span class="o">/</span><span class="nx">i</span><span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-issues" class="outline-2">
<h2 id="issues">
é—®é¢˜/ç–‘é—®åˆ—è¡¨
</h2>
<div id="outline-text-issues" class="outline-text-2">
<ol>
<li>
<p><font color='red'>å¦‚ä½•åŒºåˆ†å†…ç½®æ ‡ç­¾|å†…ç½®ç»„ä»¶|æ ¸å¿ƒç»„ä»¶|è‡ªå®šä¹‰ç»„ä»¶ï¼Ÿ<a href="#parse-parsetag-04">ğŸ›«</a></font></p>
</li>
<li>
<p><font color='red'>ä¸ºä»€ä¹ˆ <a href="#parse-parsetag">parseTag</a> è§£æ <code class="verbatim">&lt;div&gt;</code> ä¹‹ååªä¼šå¾—
åˆ° <code class="verbatim">&lt;div</code> è€Œä¸ä¼šå°† <code class="verbatim">&gt;</code> è§£æè¿›å»ï¼Ÿ<a href="#parse-parseelement">ğŸ›«</a> </font></p>
<pre class="example">
ç­”ï¼šæ˜¯å› ä¸ºæ¼æ‰å®ç°äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œè‡ªé—­åˆæ ‡ç­¾çš„æ£€æµ‹ï¼Œç§»åŠ¨æŒ‡é’ˆ(2/1ä½)
</pre>
<p>
å¦‚ä¸‹ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">parseTag</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// .... çœç•¥
</span><span class="c1"></span>

    <span class="c1">// TODO-3 &lt;div/&gt; è‡ªé—­æ ‡ç­¾
</span><span class="c1"></span>    <span class="c1">// è¿™é‡Œè¦å®ç°ï¼Œä¸ç„¶æœ€åè§£æå®Œæˆä¹‹å source ä¼šæ˜¯ï¼š&gt;...&lt;/span&gt;
</span><span class="c1"></span>    <span class="c1">// éœ€è¦æ£€æµ‹ä¸‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾æ¥ç§»åŠ¨æŒ‡é’ˆä½ç½®
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">EOF_IN_TAG</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// some &lt;div&gt; ... &lt;/div&gt; åˆ°è¿™é‡Œçš„ source = &gt; ... &lt;/div&gt;
</span><span class="c1"></span>      <span class="c1">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /&gt; å¼€å¤´çš„
</span><span class="c1"></span>      <span class="nx">isSelfClosing</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&gt;&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">TagType</span><span class="p">.</span><span class="nx">End</span> <span class="o">&amp;&amp;</span> <span class="nx">isSelfClosing</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emitError</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/&gt;)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(&gt;)
</span><span class="c1"></span>      <span class="c1">// åˆ°è¿™é‡Œ source = ... &lt;/div&gt;
</span><span class="c1"></span>      <span class="nx">advanceBy</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">isSelfClosing</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// ... çœç•¥
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><font color='red'>ä¸ºä»€ä¹ˆ <a href="#parse-parseelement">parseElement</a>Â è§£æ children çš„æ—¶å€™å…ˆ
ancestors.push(element) è§£æä¹‹ååˆ pop() æ‰ï¼Ÿ</font></p>
<pre class="example">
ç­”ï¼šè¦å›åˆ°è¿™ä¸ªé—®é¢˜è¦ä» parseChildren å’Œ parseElement ä¸¤ä¸ªå‡½æ•°ç»“åˆæ¥çœ‹ï¼Œå¦‚ä¸‹ä»£ç åˆ†æ
</pre>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// è§£ææµç¨‹(ç”¨ä¾‹5)ï¼š
</span><span class="c1"></span>  <span class="c1">// 1. å…ˆ parseChildren(context, mode, ancestors)
</span><span class="c1"></span>  <span class="c1">// è§£æ `some &lt;span&gt;{{ foo &lt; bar + foo }} text&lt;/span&gt;`
</span><span class="c1"></span>  <span class="c1">//   1) é¦–å…ˆå¾—åˆ°çš„æ˜¯ `some ` æ–‡æœ¬èŠ‚ç‚¹
</span><span class="c1"></span>  <span class="c1">//   2) æ£€æµ‹åˆ° &lt;span&gt; è¿›å…¥æ ‡ç­¾è§£æ parseElement(context, ancestors) æ³¨æ„è¿™é‡Œçš„     //				ancestorsï¼Œæ˜¯ç”± parseChildren ç»§æ‰¿è¿‡æ¥çš„
</span><span class="c1"></span>  <span class="c1">// 2. è¿›å…¥ parseElement è§£æè¿›ç¨‹
</span><span class="c1"></span>  <span class="c1">//     1) é‡åˆ° &lt;span&gt; è§£æå‡ºæ ‡ç­¾èŠ‚ç‚¹ span
</span><span class="c1"></span>  <span class="c1">//     2) åœ¨è‡ªèº«å‡½æ•°å†…æ£€æµ‹åˆ°æ ‡ç­¾å†…è¿˜æœ‰å†…å®¹ï¼Œé‡æ–°è°ƒç”¨ parseChildren(..., ancestors)
</span><span class="c1"></span>  <span class="c1">//    3) æ‰€ä»¥é‡ç‚¹æ¥äº†
</span><span class="c1"></span>  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// ...
</span><span class="c1"></span>  <span class="c1">// ancestors æ˜¯ parseChildren ä¼ é€’è¿‡æ¥çš„ï¼ŒparseElement é‡Œé¢å°†
</span><span class="c1"></span>  <span class="c1">// push çš„ç›®çš„ï¼šè®©å­èŠ‚ç‚¹æœ‰æ‰€ä¾èµ–ï¼ŒçŸ¥é“è‡ªå·±çš„çˆ¶çº§æ˜¯è°ï¼Œä½†å¥½åƒ parseChildren é‡Œé¢ç”¨åˆ°
</span><span class="c1"></span>  <span class="c1">//     parent ä¹Ÿæ˜¯ä¸ºäº†è·å–å‘½åç©ºé—´å»ç”¨äº†
</span><span class="c1"></span>  <span class="c1">// pop çš„ç›®çš„ï¼šéš¾é“æ˜¯ä¸ºäº†ä¸æ±¡æŸ“ ancestors ???
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¥½åƒè¿˜ä¸æ˜¯å¾ˆæ˜ç¡®ä¸ºä½•è¦ push-&gt;pop(DONE)ã€‚</p>
<p>
<strong>æ›´æ–°ï¼š2020-09-02 16:57:35</strong></p>
<p>
åœ¨æµ‹è¯•ç”¨ä¾‹ <a href="#parse-test-other-01">parse-test-other-01</a> æ—¶ï¼ŒåµŒå¥—æ ‡ç­¾è§£æçš„æ—¶å€™ ancestors ä¸­ä¿å­˜ç€å¤šçº§
åµŒå¥—æ ‡ç­¾çš„çˆ¶çº§(å½“å‰è¢«è§£æçš„èŠ‚ç‚¹çš„çˆ¶çº§)ã€‚</p>
<p>
æ¯”å¦‚ï¼š <code>&lt;div&gt;&lt;span&gt;\n&lt;/div&gt;&lt;/span&gt;</code> è¿™ä¸ªæ˜¯åä¾‹å“ˆï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹ã€‚</p>
<pre class="example">
ancestors: Array(2)
  0: {type: 1, ns: 0, tag: &#34;div&#34;, tagType: 0, props: Array(0), â€¦}
  1: {type: 1, ns: 0, tag: &#34;span&#34;, tagType: 0, props: Array(0), â€¦}
  length: 2
</pre>
<p>
è§£æé¡ºåºï¼š div -&gt; <code>push:ancestors[0]</code> -&gt; span -&gt; <code>push:ancestors[1]</code> -&gt; <code>\n</code> è§£
æå®Œæˆä¹‹åï¼Œå‘ç° parent æœ‰å†…å®¹ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹è§£æå®Œä¹‹åä¼šè¢« push åˆ°
<code>span.children~é‡Œé¢å»ï¼Œåˆ°è¿™é‡Œ span è§£æå®Œäº†ï¼Œæ‰€ä»¥è¦é€€å‡ºå½“å‰é€’å½’å›åˆ° div çš„è§£
æï¼Œå› æ­¤éœ€è¦å°†~ancestors.pop()</code> æ‰æœ€åä¸€ä¸ªï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ div çš„ child èƒ½æ­£ç¡®
push åˆ°~div.ancestors~ ä¸­å»ã€‚</p>
</li>
</ol>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2020-08-31
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/vuenext/">vuenext,</a>
          <a href="/tags/compiler/">compiler</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue3-source-picking-shell/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3.0æºç ç³»åˆ— -- é‡è¦çŸ¥è¯†ç‚¹æ¡æ¼</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/vue/vue3-source-code-compiler-core-ast_ts/">
            <span class="next-text nav-default">Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 2: ast.ts</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Zhicheng Lee</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.d33b84bebc7c384b56f2733fe2385c9017ee0b83c484f803130e9b7069175e0c.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
