<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1) - è‹¥å¶çŸ¥ç§‹</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-runtime-core-1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.9d6c07951e716411e0fdd9d1d7616cb41ced57b53993154c49ea809e194527af.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1)" />
<meta property="og:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-runtime-core-1/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2021-01-08T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-01-08T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1)">
<meta itemprop="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu"><meta itemprop="datePublished" content="2021-01-08T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-01-08T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="29119">
<meta itemprop="keywords" content="vue,,vue3,,runtime-core," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1)"/>
<meta name="twitter:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼švu"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1)</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-01-08 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 29119 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 59 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">âš  Tips</a>
</li>
<li><a href="#headline-2">ğŸ‚ init</a>
</li>
<li><a href="#h-function">ğŸ˜œ h function</a>
</li>
<li><a href="#createVNode">ğŸŒ¿ createVNode function</a>
<ul>
<li><a href="#headline-5">d3c6563 props</a>
</li>
<li><a href="#headline-6">class component</a>
</li>
<li><a href="#headline-7">stateful component &amp; key NaN</a>
</li>
<li><a href="#headline-8">88eaf09 type is vnode</a>
<ul>
<li><a href="#test-vnode-key">key test</a>
</li>
<li><a href="#test-vnode-ref">ref test</a>
</li>
<li><a href="#test-vnode-patchflag">patchFlag test</a>
</li>
<li><a href="#headline-12">shapeFlag test</a>
</li>
<li><a href="#headline-13">mergeProps test</a>
</li>
<li><a href="#headline-14">dynamic children test</a>
</li>
<li><a href="#headline-15">transformVNodeArgs test</a>
</li>
</ul>
</li>
<li><a href="#headline-16">7ec1d30 suspense component</a>
</li>
<li><a href="#vnode-currentBlock">23fc943 currentBlock ä¼˜åŒ–</a>
</li>
<li><a href="#block-related">block related(open/close/create)</a>
</li>
<li><a href="#normalize-children">normalizeChildren function</a>
<ul>
<li><a href="#headline-20">children is function</a>
</li>
<li><a href="#headline-21">children is array or æ™®é€šç±»å‹</a>
</li>
<li><a href="#headline-22">children is object</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#api-watch">â± api watch(source, cb, options)</a>
<ul>
<li><a href="#headline-24">source is ref</a>
</li>
<li><a href="#headline-25">source is reactive</a>
</li>
<li><a href="#watch-array">soure is array</a>
</li>
<li><a href="#headline-27">source is function</a>
</li>
<li><a href="#api-watch-deep">option deep</a>
<ul>
<li><a href="#headline-29">deep ref</a>
</li>
</ul>
</li>
<li><a href="#headline-30">option immediate</a>
</li>
<li><a href="#headline-31">option onTrack + onTrigger</a>
</li>
<li><a href="#headline-32">stop &amp; cleanup</a>
<ul>
<li><a href="#headline-33">stop</a>
</li>
<li><a href="#headline-34">cleanup(æ—  cb)</a>
</li>
<li><a href="#headline-35">cleanup(æœ‰ cb)</a>
</li>
</ul>
</li>
<li><a href="#watch-sync">flush sync</a>
</li>
<li><a href="#watch-shallow-ref">shallow ref</a>
</li>
<li><a href="#headline-38">flush pre(default) cb</a>
</li>
<li><a href="#headline-39">flush post cb</a>
</li>
<li><a href="#headline-40">ssr support</a>
</li>
<li><a href="#headline-41">instance watch</a>
</li>
<li><a href="#headline-42">ğŸº å°ç»“</a>
</li>
</ul>
</li>
<li><a href="#headline-43">ğŸ api createApp</a>
<ul>
<li><a href="#headline-44">declaration</a>
</li>
<li><a href="#headline-45">implementation</a>
<ul>
<li><a href="#headline-46">app.use(plugin, â€¦options)</a>
</li>
<li><a href="#headline-47">app.mixin(mixin)</a>
</li>
<li><a href="#headline-48">app.component(name, component)</a>
</li>
<li><a href="#headline-49">app.directive(name, directive)</a>
</li>
<li><a href="#headline-50">app.mount(rootContainer, isHydrate)</a>
</li>
<li><a href="#headline-51">app.unmount()</a>
</li>
<li><a href="#headline-52">app.provide(key, value)</a>
</li>
</ul>
</li>
<li><a href="#headline-53">test</a>
</li>
</ul>
</li>
<li><a href="#api-provide-inject">â› api provide &amp; inject</a>
<ul>
<li><a href="#headline-55">provide(key, value)</a>
</li>
<li><a href="#headline-56">inject(key, defaultValue, treatDefaultAsFactory = false)</a>
</li>
<li><a href="#headline-57">test</a>
</li>
</ul>
</li>
<li><a href="#headline-58">âœ¨ api computed</a>
</li>
<li><a href="#headline-59">ğŸŒ€ api lifecycle</a>
<ul>
<li><a href="#headline-60">test base</a>
</li>
<li><a href="#headline-61">test update</a>
</li>
<li><a href="#headline-62">test unmount</a>
</li>
<li><a href="#lc-test-order">test order</a>
</li>
<li><a href="#headline-64">test render track &amp; trigger</a>
</li>
</ul>
</li>
<li><a href="#define-component">ğŸ¦‰ api define component</a>
</li>
<li><a href="#headline-66">ğŸ†˜ api setup helpers</a>
</li>
<li><a href="#headline-67">ğŸŒŠ TODO api async comopnent</a>
<ul>
<li><a href="#headline-68">implementation(init)</a>
</li>
</ul>
</li>
<li><a href="#headline-69">ğŸ”¥ render function</a>
</li>
<li><a href="#scheduler">ğŸš’ scheduler ä»»åŠ¡è°ƒåº¦æœºåˆ¶</a>
<ul>
<li><a href="#nexttick">nextTick</a>
</li>
<li><a href="#job-queue-job">queueJob</a>
</li>
<li><a href="#headline-73">flushJobs</a>
</li>
<li><a href="#headline-74">queueJob while flushing</a>
</li>
<li><a href="#headline-75">queuePreFlushCb</a>
</li>
<li><a href="#job-flush-pre">flushPreFlushCbs</a>
</li>
<li><a href="#headline-77">queuePostFlushCb + flushPostFlushCbs</a>
</li>
<li><a href="#headline-78">test nested(pre/job/post)</a>
</li>
<li><a href="#headline-79">invalidateJob(job)</a>
</li>
<li><a href="#headline-80">job sort id ä»»åŠ¡å¯ä»¥æ’åº</a>
</li>
<li><a href="#headline-81">allowRecurse è‡ªèº«é€’å½’</a>
</li>
<li><a href="#headline-82">checkRecursiveUpdates</a>
</li>
<li><a href="#headline-83">å°ç»“</a>
</li>
</ul>
</li>
<li><a href="#headline-84">ğŸ› BUGs fix &amp; Questions</a>
<ul>
<li><a href="#q-nexttick">nextTick() åé¢çš„ä»£ç æœ€åæ‰§è¡Œï¼Ÿ</a>
</li>
</ul>
</li>
<li><a href="#runtime-test">runtime-test æ¨¡å—ç®€ä»‹</a>
</li>
<li><a href="#headline-87">é‡è¦ç±»å‹å£°æ˜</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> å®Œå…¨æ‹·è´äº <a href="https://github.com/vuejs/vue-next">vue-next</a> ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚</strong>
</kbd></p>
<blockquote>
<p><strong>å£°æ˜</strong> ï¼švue-next runtime-core è¿è¡Œæ—¶æ ¸å¿ƒä»£ç ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¾ƒå¤šï¼Œå¯èƒ½ä¼šåˆ†ä¸ºå‡ ç¯‡æ¥
å™è¿°, <code>f</code> è¿‡æ»¤æ‰å¯¹è±¡ç©ºå€¼å±æ€§ã€‚</p>
<p>
<strong>æ›´æ–°æ—¥å¿—&amp;Todos</strong> ï¼š</p>
<ol>
<li>
<p>[2021-01-08 10:12:50] åˆ›å»º</p>
</li>
<li>
<p>DONE [2021-01-15 10:24:00] scheduler</p>
</li>
<li>
<p>TODO apiWatch -&gt; post cb &amp; ssr</p>
</li>
<li>
<p>TODO STATEFUL_COMONENT</p>
</li>
<li>
<p>TODO patchFlag æµ‹è¯•å’Œç”¨é€”</p>
</li>
<li>
<p>TODO transformVNodeArgs</p>
</li>
<li>
<p>TODO Suspense ç»„ä»¶</p>
</li>
<li>
<p>TODO shouldTrack, currentBlock å’Œ <a href="#block-related">block ç›¸å…³å‡½æ•°</a>çš„ä½œç”¨</p>
</li>
<li>
<p>TODO setup() è¿”å›å€¼ç”¨æ¥åšäº†å•¥ï¼Ÿ</p>
</li>
<li>
<p>TODO setup() é‡Œé¢æ˜¯å¦‚ä½•æ”¶é›†ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œåˆæ˜¯å¦‚ä½•ï¼Ÿåœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿæ‰§è¡Œä»–ä»¬çš„ï¼Ÿ</p>
</li>
<li>
<p>TODO async component</p>
</li>
</ol>
</blockquote>
<p>
æ¨¡å—åˆå§‹åŒ–ï¼š <a href="https://github.com/gcclll/stb-vue-next/commit/b22b4db3506bf1ba4b266dcf9ff21f1e0b925a81">feat(init): runtime-core Â· gcclll/stb-vue-next@b22b4db Â· GitHub</a></p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core.svg" alt="/img/vue3/runtime-core/vue-runtime-core.svg" title="/img/vue3/runtime-core/vue-runtime-core.svg" /></p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
âš  Tips
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ol>
<li>
<p>class æ”¯æŒæ•°ç»„(<code>[&#39;foo&#39;, &#39;bar&#39;]</code>)ï¼Œå¯¹è±¡(<code>{foo:true,bar:false}</code>)ï¼Œå­—ç¬¦ä¸²(<code>&#39;foo bar&#39;</code>)</p>
</li>
<li>
<p>style æ”¯æŒæ•°ç»„(<code>[&#39;color:red&#39;, {foo:&#39;foo&#39;}]</code>)ï¼Œå¯¹è±¡(<code>{color:&#39;red&#39;,foo:&#39;foo&#39;}</code>)ï¼Œå­—ç¬¦ä¸²(<code>color:red</code>)</p>
</li>
<li>
<p>class component æ¡ä»¶ï¼š</p>
<ol>
<li>
<p>function</p>
</li>
<li>
<p>å« <code>__vccOpts = { template: &#39;&lt;div /&gt;&#39;}</code></p>
</li>
</ol>
</li>
<li>
<p><a href="#test-vnode-ref">vnode ref å±æ€§åˆå¹¶å¤„ç†é€»è¾‘ï¼Ÿ</a></p>
</li>
<li>
<p><a href="#test-vnode-key">vnode key å±æ€§ç®€å•çš„å€¼è¦†ç›–æ“ä½œï¼Ÿ</a></p>
</li>
<li>
<p><a href="#h-function">h()</a> å’Œ <a href="#createVNode">createVNode</a> å‡½æ•°å¤šç§ä½¿ç”¨æ–¹å¼ç»„åˆï¼Ÿ</p>
<p>
<code>h(type, propsOrChildren, ...children)</code>, å‚æ•°ä¸ªæ•°å¤šå˜ï¼Œå¯¹äºè¿™ä¸ªå‡½æ•°çš„ä½¿ç”¨æ–¹æ³•
è®°å¿†åªè¦è®°ä½ä¸€ç‚¹ï¼š</p>
<blockquote>
<p>props æ€»æ˜¯å¯¹è±¡ï¼Œchildren å¯ä»¥æ˜¯å¯¹è±¡(å¿…é¡»æ˜¯ VNode ç±»å‹ <code>__v_isVNode</code>)ä¹Ÿå¯ä»¥æ˜¯
æ•°ç»„ï¼Œæ‰€ä»¥ï¼š</p>
<ol>
<li>
<p>argc = 2, å¦‚æœæ˜¯æ•°ç»„å°±ä¸€å®šæ˜¯ children</p>
</li>
<li>
<p>argc = 2, å¦‚æœæ˜¯å¯¹è±¡ä¸”æœ‰ __v_isVNode æ ‡è¯†ï¼Œä¸€å®šæ˜¯ children å¦åˆ™æ˜¯ props</p>
</li>
<li>
<p>argc = 3, æŒ‰ç…§ <code>h(type, props, children)</code> å¤„ç†</p>
</li>
<li>
<p>argc &gt; 3, æŒ‰ç…§ <code>h(type, props, ...children)</code> å¤„ç†ï¼Œä»ç¬¬ä¸‰ä¸ªå¼€å§‹éƒ½æ˜¯ children</p>
</li>
</ol>
</blockquote>
<p>
<code>createVNode(type, props, children)</code>, å›ºå®šä¸‰ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªä¸€å®šæ˜¯ props, ç¬¬ä¸‰
ä¸ªä¸€å®šæ˜¯æ•°ç»„ç±»å‹çš„ childrenï¼Œå› ä¸ºå®ƒåé¢è¿˜æœ‰æ›´å¤šçš„å…¶ä»–å‚æ•°(patchFlag,
dynamicProps, isBlockNode)ï¼Œæ‰€ä»¥å‰ä¸‰ä¸ªå¿…é¡»ç¡®å®šä¸‹æ¥ã€‚</p>
</li>
<li>
<p><a href="#scheduler">scheduler, vue-next ä¸­çš„ä»»åŠ¡è°ƒåº¦å™¨å¦‚ä½•å®ç°ï¼Ÿ</a></p>
</li>
<li>
<p><a href="#api-watch">api watch(source, cb, option)</a> ä¸­çš„ source åªèƒ½æ˜¯ <code>reactive/ref/function/array</code> ç±»å‹ï¼Œ
å¦‚æœæ˜¯æ•°ç»„æ—¶å…¶å…ƒç´ åªèƒ½æ˜¯ <code>reactive/ref/function</code></p>
</li>
<li>
<p><a href="#api-watch-deep">api watch(â€¦, { deep: true }) æ˜¯å¦‚ä½•åšåˆ°æ·±åº¦ç›‘å¬çš„ï¼Ÿ</a></p>
</li>
<li>
<p><a href="#watch-shallow-ref">api watch(shallowRef, <em><strong>cb</strong></em> (newVal) =&gt; {}) æ˜¯å¦‚ä½•ç›´æ¥ä½¿ç”¨ newVal.a çš„ï¼Ÿ</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">shallowRef</span><span class="p">({</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
<span class="nx">watch</span><span class="p">(</span><span class="nx">shallowRef</span><span class="p">,</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span> <span class="c1">// è¿™é‡Œä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥è®¿é—® obj.aï¼Œobj åˆæ˜¯ä»€ä¹ˆï¼Ÿ
</span><span class="c1"></span><span class="p">});</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><a href="#api-provide-inject">provide &amp; inject å¦‚ä½•å®ç°ï¼Ÿ</a></p>
<p>
provide(key,value) å‘ç»„ä»¶ <code>provides[key] = value</code> è®¾ç½®</p>
<p>
inject(key) ä»ç»„ä»¶ <code>provides[key]</code> å–å€¼</p>
</li>
<li>
<p>TODO setup() è¿”å›å€¼ç”¨æ¥åšäº†å•¥ï¼Ÿ</p>
</li>
<li>
<p><a href="#lc-test-order">ç»„ä»¶å£°æ˜å‘¨æœŸå‡½æ•°(<code>onBeforeXxx</code>, <code>onXxx</code>)è§¦å‘é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ</a></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
ğŸ‚ init
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
å¯¼å‡ºå·²å®Œæˆæ¨¡å—(reactiviy)é‡Œçš„ Apis:
<a href="https://github.com/gcclll/stb-vue-next/commit/38e91a877635b51b56a2918ff173a48638b8760a">feat(init): runtime-core&gt; add exports from @vue/reactivity Â· gcclll/stb-vue-next@38e91a8 Â· GitHub</a></p>
<p>
è¿™éƒ¨åˆ†ä»£ç æœ‰ç‚¹å¤šï¼Œæ‰€ä»¥è¿™é‡Œäº‹å…ˆå°†æ‰€æœ‰ç±»å‹å®šä¹‰æ·»åŠ å¥½ï¼š</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e3f7b94ef39cf389aaf25f55ea81877941860f56">feat(add): runtime-core&gt;all types Â· gcclll/stb-vue-next@e3f7b94 Â· GitHub</a></p>
<p>
æœ‰å…³ç±»å‹å®šä¹‰è¯·ç§»æ­¥<a href="#defines">æœ€åä¸€èŠ‚</a>(çº¯è´´ä»£ç çš„ï¼Œæ‰€ä»¥æ”¾åˆ°æœ€å)</p>
</div>
</div>
<div id="outline-container-h-function" class="outline-2">
<h2 id="h-function">
ğŸ˜œ h function
</h2>
<div id="outline-text-h-function" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e48d5e28c4e1b55c6d6a326bcf0808047e23ceeb">feat(add): runtime-core&gt;h function Â· gcclll/stb-vue-next@e48d5e2 Â· GitHub</a></p>
<p>
<code>h</code>, render å‡½æ•°åˆå§‹åŒ–ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Actual implementation
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">h</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="kt">any</span><span class="p">,</span> <span class="nx">propsOrChildren?</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">children?</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å®ç°ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Actual implementation
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">h</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="kt">any</span><span class="p">,</span> <span class="nx">propsOrChildren?</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">children?</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">propsOrChildren</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">propsOrChildren</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// æ²¡æœ‰ props çš„ å•èŠ‚ç‚¹(single vnode)
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">isVNode</span><span class="p">(</span><span class="nx">propsOrChildren</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">propsOrChildren</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="c1">// æœ‰ props æ²¡æœ‰ children
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="nx">propsOrChildren</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// omit props
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">propsOrChildren</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// ä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹å…¨å½“åšå­©å­èŠ‚ç‚¹å¤„ç†
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">children</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">isVNode</span><span class="p">(</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">children</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="nx">propsOrChildren</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
h, æ¥å—ä¸å®šå‚æ•°</p>
<p>
é€»è¾‘è„‘å›¾:</p>
<p>
<img src="/img/tmp/20210108152508.png" alt="/img/tmp/20210108152508.png" title="/img/tmp/20210108152508.png" /></p>
<p>
ä»è„‘å›¾åˆ†æ”¯å¾—å‡ºæ”¯æŒçš„æƒ…å†µä»£ç ç¤ºä¾‹ï¼š</p>
<ol>
<li>
<p><code>h(&#39;div&#39;)</code> æ— å‚æ•°æ— å­©å­</p>
</li>
<li>
<p><code>h(&#39;div&#39;, { id: &#39;foo&#39; })</code> æœ‰ props æ—  children</p>
</li>
<li>
<p><code>h(&#39;div&#39;, [&#39;foo&#39;])</code> æ•°ç»„å½“åš chilren</p>
</li>
<li>
<p><code>h(&#39;div&#39;, vnode)</code> æœ‰ __v_isVNode æ ‡è¯†å½“åš childrenï¼Œå¹¶è½¬æˆæ•°ç»„ <code>[vnode]</code></p>
</li>
<li>
<p><code>h(&#39;div&#39;, {}, [&#39;foo&#39;])</code> æœ‰ props æœ‰ children</p>
</li>
<li>
<p><code>h(&#39;div&#39;, {}, vnode)</code> æœ‰ props, æœ‰ children ä¸” = <code>[vnode]</code></p>
</li>
</ol>
<p>æ¥ä¸‹æ¥éœ€è¦å…·ä½“å»å®ç° <code>createVNode</code> å‡½æ•°ã€‚</p>
</div>
</div>
<div id="outline-container-createVNode" class="outline-2">
<h2 id="createVNode">
ğŸŒ¿ createVNode function
</h2>
<div id="outline-text-createVNode" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/194f72fee239da947ef82a4da099c23c758d3d84">feat(add): rc-&gt;createVNode Â· gcclll/stb-vue-next@194f72f Â· GitHub</a></p>
<p>
è¿™ä¸ªå‡½æ•°æœ€ç»ˆæ˜¯æ„é€ äº† vnode: VNode è™šæ‹ŸèŠ‚ç‚¹ç»“æ„ï¼Œè¿”å›ã€‚</p>
<p>
è¿™é‡Œé¢åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤å®ç°ï¼š</p>
<ol>
<li>
<p>type æ˜¯ vnode æ—¶å€™å¤„ç†</p>
</li>
<li>
<p>class ç»„ä»¶å¤„ç†</p>
</li>
<li>
<p>props å¤„ç†</p>
</li>
<li>
<p>shapeFlag æ£€æµ‹ï¼Œæ˜¯ä»€ä¹ˆç±»å‹ çš„ vnode</p>
</li>
<li>
<p>ç»„ä»¶å¯¹è±¡ä¸åº”è¯¥ reactive(æœ‰çŠ¶æ€çš„ç»„ä»¶, STATEFUL_COMONENT)</p>
</li>
<li>
<p>æ„å»º vnode: VNode å¯¹è±¡</p>
</li>
<li>
<p>æ£€æµ‹ vnode.key æ˜¯ä¸æ˜¯ <code>NaN</code></p>
</li>
<li>
<p>normalize children</p>
</li>
<li>
<p>normalize suspense children</p>
</li>
<li>
<p>currentBlock å¤„ç†</p>
</li>
<li>
<p>è¿”å› vnode èŠ‚ç‚¹</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">h</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; type only\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; type + props\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">})]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; type + omit props\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">])]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; type only
 { __v_isVNode: true, __v_skip: true, type: &#39;div&#39;, shapeFlag: 1 }
&gt;&gt;&gt; type + props
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: { id: &#39;foo&#39; },
  shapeFlag: 1
}
&gt;&gt;&gt; type + omit props
 { __v_isVNode: true, __v_skip: true, type: &#39;div&#39;, shapeFlag: 1 }
&gt;&gt;&gt; default slot
 {
  __v_isVNode: true,
  __v_skip: true,
  type: { template: &#39;&lt;br /&gt;&#39; },
  shapeFlag: 4
}
undefined
</pre>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
d3c6563 props
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d3c656331e3e5a9206f0341dd2ca960a300f96ba">feat(add): rc-&gt;createVNode, props Â· gcclll/stb-vue-next@d3c6563 Â· GitHub</a></p>
<p>
å¤„ç† class å’Œ style å±æ€§ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 3. props å¤„ç†, class &amp; style normalization
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// for reactive or proxy objects, we need to clone it to enable mutation.
</span><span class="c1"></span>   <span class="k">if</span> <span class="p">(</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">||</span> <span class="nx">InternalObjectKey</span> <span class="k">in</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">props</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="nx">props</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="kd">let</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">style</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">klass</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isString</span><span class="p">(</span><span class="nx">klass</span><span class="p">))</span> <span class="p">{</span>
     <span class="c1">// 1. string -&gt; klass
</span><span class="c1"></span>     <span class="c1">// &#39;foo&#39; -&gt; &#39;foo&#39;
</span><span class="c1"></span>     <span class="c1">// 2. array -&gt; &#39;&#39; + arr.join(&#39; &#39;)
</span><span class="c1"></span>     <span class="c1">// [&#39;foo&#39;, &#39;bar&#39;] -&gt; &#39;foo bar&#39;
</span><span class="c1"></span>     <span class="c1">// 3. object -&gt; &#39;&#39; + value ? &#39; value&#39; : &#39;&#39;
</span><span class="c1"></span>     <span class="c1">// { foo: true, bar: false, baz: true } -&gt; &#39;foo baz&#39;
</span><span class="c1"></span>     <span class="nx">props</span><span class="p">.</span><span class="kr">class</span> <span class="o">=</span> <span class="nx">normalizeClass</span><span class="p">(</span><span class="nx">klass</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">style</span><span class="p">))</span> <span class="p">{</span>
     <span class="c1">// reactive state objects need to be cloned since they are likely to be
</span><span class="c1"></span>     <span class="c1">// mutated
</span><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">style</span><span class="p">))</span> <span class="p">{</span>
       <span class="nx">style</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="nx">style</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="c1">// 1. array -&gt; object
</span><span class="c1"></span>     <span class="c1">// [{ color: &#39;red&#39; }, &#39;font-size:10px;height:100px;&#39;] -&gt;
</span><span class="c1"></span>     <span class="c1">// { color: &#39;red&#39;, &#39;font-size&#39;: &#39;10px&#39;, height: &#39;100px&#39; }
</span><span class="c1"></span>     <span class="c1">// 2. object -&gt; object åŸæ ·è¿”å›
</span><span class="c1"></span>     <span class="nx">props</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="nx">normalizeStyle</span><span class="p">(</span><span class="nx">style</span><span class="p">);</span>
   <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>class æ•°ç»„ï¼Œå¯¹è±¡ï¼Œå­—ç¬¦ä¸²ï¼Ÿ</p>
<p>
æ•°ç»„ï¼š åˆå¹¶æˆå­—ç¬¦ä¸²ï¼Œ <code>[&#39;foo&#39;, &#39;bar&#39;]</code> -&gt; &#39;foo bar&#39;</p>
<p>
å¯¹è±¡ï¼š åˆå¹¶æˆå­—ç¬¦ä¸²ï¼Œ <code>{foo: true, bar: false, baz: true}</code> -&gt; &#39;foo baz&#39;</p>
<p>
å­—ç¬¦ä¸²ï¼š åŸæ ·è¾“å‡º</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeClass</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span> <span class="o">+=</span> <span class="nx">normalizeClass</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">+=</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>style æ•°ç»„ï¼Œå¯¹è±¡ï¼Œå­—ç¬¦ä¸²ï¼Ÿ</p>
<p>
æ•°ç»„ï¼š åˆå¹¶æˆå¯¹è±¡ï¼Œ <code>[&#39;color:red&#39;, { &#39;font-size&#39;: &#39;10px&#39;, height: &#39;100px&#39; }]</code> -&gt; <code>{color:
&#39;red&#39;, &#39;font-size&#39;: &#39;10px&#39;, height: &#39;100px&#39;}</code></p>
<p>
å¯¹è±¡ï¼š åŸæ ·è¿”å›</p>
<p>
å­—ç¬¦ä¸²ï¼šè§£ææˆå¯¹è±¡ï¼Œ å¦‚æ•°ç»„å†…å­—ç¬¦ä¸²éƒ¨åˆ†</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeStyle</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="nx">NormalizedStyle</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
     <span class="kr">const</span> <span class="nx">res</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">string</span> <span class="err">|</span> <span class="na">number</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{};</span>
     <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="kr">const</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
       <span class="kr">const</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="nx">normalizeStyle</span><span class="p">(</span>
         <span class="nx">isString</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">?</span> <span class="nx">parseStringStyle</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">:</span> <span class="nx">item</span>
       <span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">normalized</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">normalized</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">res</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">normalized</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
         <span class="p">}</span>
       <span class="p">}</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
   <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kd">let</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">),</span> <span class="s1">&#39;props&#39;</span><span class="p">)</span>

<span class="c1">// class åˆå¹¶æˆå­—ç¬¦ä¸²
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: string\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;foo baz&#39;</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: array\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">]</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: array&lt;object|string&gt;\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span>  <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}]</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: object\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">})])</span>

<span class="c1">// style åˆå¹¶æˆå¯¹è±¡
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; style: array\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">style</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}]</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; style: object\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}</span>
<span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; style: array&lt;object|string&gt;\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="s1">&#39;color:red&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}]</span>
<span class="p">})])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; class: string
 { props: { class: &#39;foo baz&#39; } }
&gt;&gt;&gt; class: array
 { props: { class: &#39;foo baz&#39; } }
&gt;&gt;&gt; class: array&lt;object|string&gt;
 { props: { class: &#39;foo baz baz&#39; } }
&gt;&gt;&gt; class: object
 { props: { class: &#39;foo bar&#39; } }
&gt;&gt;&gt; style: array
 { props: { style: { foo: &#39;foo&#39;, baz: &#39;baz&#39; } } }
&gt;&gt;&gt; style: object
 { props: { style: { foo: &#39;foo&#39;, baz: &#39;baz&#39; } } }
&gt;&gt;&gt; style: array&lt;object|string&gt;
 { props: { style: { foo: &#39;foo&#39;, color: &#39;red&#39;, baz: &#39;baz&#39; } } }
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
class component
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>
æ˜¯ç±»ç»„ä»¶å‰ææ˜¯ï¼š</p>
<ol>
<li>
<p>å¿…é¡»æ˜¯å‡½æ•°</p>
</li>
<li>
<p>å¿…é¡»åŒ…å« <code>__vccOpts</code> å±æ€§</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// 2. class component
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">isClassComponent</span><span class="p">(</span><span class="kr">type</span><span class="p">))</span> <span class="p">{</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="kr">type</span><span class="p">.</span><span class="nx">__vccOpts</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">isClassComponent</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="nx">value</span> <span class="k">is</span> <span class="nx">ClassComponent</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s2">&#34;__vccOpts&#34;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">))</span>

<span class="kr">class</span> <span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">$props</span>

  <span class="kr">static</span> <span class="mi">__</span><span class="nx">vccOpts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;div /&gt;&#39;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="nx">log</span><span class="p">(</span><span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="nx">Component</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  __v_isVNode: true,
  __v_skip: true,
  type: { template: &#39;&lt;div /&gt;&#39; },
  shapeFlag: 4 // STATEFUL_COMPONENT
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-7" class="outline-3">
<h3 id="headline-7">
<span class="todo">TODO</span>
stateful component &amp; key NaN
</h3>
<div id="outline-text-headline-7" class="outline-text-3">
<p>
æœ‰çŠ¶æ€çš„ç»„ä»¶ï¼Ÿ</p>
<p>
å³ type ä¸ºå¯¹è±¡æ—¶å€™è§†ä¸ºæœ‰çŠ¶æ€çš„ç»„ä»¶ã€‚</p>
<p>
å¦‚æœæ˜¯ STATEFUL_COMPONENT ä¸”æ˜¯ä¸ª proxy çš„æ—¶å€™ï¼Œå¼€å‘æ¨¡å¼ä¸‹ç»™å‡ºè­¦å‘Šâš ï¸ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">reactive</span><span class="o">:</span><span class="nx">r</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">))</span>

<span class="nx">log</span><span class="p">(</span><span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="kc">NaN</span> <span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: { key: NaN },
  shapeFlag: 1
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
88eaf09 type is vnode
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/88eaf090c3d1767bc4a1ca576eef449abf7d62d2">feat(add): rc-&gt;createVNode, type is vnode Â· gcclll/stb-vue-next@88eaf09 Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// &gt; in createVNode
</span><span class="c1"></span>  <span class="c1">// 1. type is vnode
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">isVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// createVNode receiving an existing vnode. This happens in cases like
</span><span class="c1"></span>    <span class="c1">// &lt;component :is=&#34;vnode&#34;/&gt;
</span><span class="c1"></span>    <span class="c1">// #2078 make sure to merge refs during the clone instead of overwriting it
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">cloned</span> <span class="o">=</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="kc">true</span> <span class="cm">/* mergeRef: true */</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">normalizeChildren</span><span class="p">(</span><span class="nx">cloned</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">cloned</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// cloneVNode
</span><span class="c1"></span>  <span class="c1">// çœç•¥ç›´æ¥å– vnode å€¼éƒ¨åˆ†
</span><span class="c1"></span>  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">cloneVNode</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">,</span> <span class="na">U</span><span class="p">&gt;(</span>
    <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">,</span> <span class="na">U</span><span class="p">&gt;,</span>
    <span class="nx">extraProps</span><span class="o">?:</span> <span class="p">(</span><span class="nx">Data</span> <span class="o">&amp;</span> <span class="nx">VNodeProps</span><span class="p">)</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">mergeRef</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">,</span> <span class="na">U</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// This is intentionally NOT using spread or extend to avoid the runtime
</span><span class="c1"></span>    <span class="c1">// key enumeration cost.
</span><span class="c1"></span>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">patchFlag</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">mergedProps</span> <span class="o">=</span> <span class="nx">extraProps</span> <span class="o">?</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">props</span> <span class="o">||</span> <span class="p">{},</span> <span class="nx">extraProps</span><span class="p">)</span> <span class="o">:</span> <span class="nx">props</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">__v_isVNode</span>: <span class="kt">true</span><span class="p">,</span>
      <span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">SKIP</span><span class="p">]</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="kr">type</span><span class="o">:</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span><span class="p">,</span>
      <span class="nx">props</span>: <span class="kt">mergedProps</span><span class="p">,</span>
      <span class="nx">key</span>: <span class="kt">mergedProps</span> <span class="o">&amp;&amp;</span> <span class="nx">normalizeKey</span><span class="p">(</span><span class="nx">mergedProps</span><span class="p">),</span>
      <span class="nx">ref</span>:
        <span class="kt">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">extraProps</span><span class="p">.</span><span class="nx">ref</span>
          <span class="o">?</span> <span class="c1">// #2078 in the case of &lt;component :is=&#34;vnode&#34; ref=&#34;extra&#34;/&gt;
</span><span class="c1"></span>            <span class="c1">// if the vnode itself already has a ref, cloneVNode will need to merge
</span><span class="c1"></span>            <span class="c1">// the refs so the single vnode can be set on multiple refs
</span><span class="c1"></span>            <span class="nx">mergeRef</span> <span class="o">&amp;&amp;</span> <span class="nx">ref</span>
            <span class="o">?</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
              <span class="o">?</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
              <span class="o">:</span> <span class="p">[</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">]</span>
            <span class="o">:</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">ref</span><span class="p">,</span>
      <span class="c1">// if the vnode is cloned with extra props, we can no longer assume its
</span><span class="c1"></span>      <span class="c1">// existing patch flag to be reliable and need to add the FULL_PROPS flag.
</span><span class="c1"></span>      <span class="c1">// note: perserve flag for fragments since they use the flag for children
</span><span class="c1"></span>      <span class="c1">// fast paths only.
</span><span class="c1"></span>      <span class="nx">patchFlag</span>:
        <span class="kt">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">Fragment</span>
          <span class="o">?</span> <span class="nx">patchFlag</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// hoisted node
</span><span class="c1"></span>            <span class="o">?</span> <span class="nx">PatchFlags.FULL_PROPS</span>
            : <span class="kt">patchFlag</span> <span class="o">|</span> <span class="nx">PatchFlags.FULL_PROPS</span>
          : <span class="kt">patchFlag</span><span class="p">,</span>

      <span class="nx">ssContent</span>: <span class="kt">vnode.ssContent</span> <span class="o">&amp;&amp;</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">ssContent</span><span class="p">),</span>
      <span class="nx">ssFallback</span>: <span class="kt">vnode.ssFallback</span> <span class="o">&amp;&amp;</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">ssFallback</span><span class="p">),</span>
    <span class="p">};</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
cloneVNode ç»å¤§éƒ¨åˆ†å±æ€§éƒ½æ˜¯ç›´æ¥å¼•ç”¨è‡ª vnodeï¼Œä¸Šé¢åˆ—å‡ºçš„éƒ½æ˜¯éœ€è¦å¤„ç†çš„å±æ€§ï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>
<p>props ä¼šå°† vnode å’Œ cloneVNode ä¼ å…¥çš„ props è¿›è¡Œåˆå¹¶ï¼Œå¹¶ä¸”æ˜¯ä¼ å…¥çš„ props è¦†ç›– vnode.propsã€‚</p>
</li>
<li>
<p>key å±æ€§ï¼Œå–åˆå¹¶ä¹‹åçš„ key(<a href="#test-vnode-key">æµ‹è¯•-&gt;</a>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// normalize åˆå¹¶åçš„ key
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">mergedProps</span> <span class="o">&amp;&amp;</span> <span class="nx">normalizeKey</span><span class="p">(</span><span class="nx">mergedProps</span><span class="p">);</span>

 <span class="kr">const</span> <span class="nx">normalizeKey</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">key</span> <span class="p">}</span><span class="o">:</span> <span class="nx">VNodeProps</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span><span class="p">[</span><span class="s2">&#34;key&#34;</span><span class="p">]</span> <span class="o">=&gt;</span>
   <span class="nx">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">key</span> : <span class="kt">null</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>ref å±æ€§ï¼Œåˆå¹¶è§„åˆ™(<a href="#test-vnode-ref">æµ‹è¯•-&gt;</a>)ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 1. mergeRef: boolean å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ˜¯å¦éœ€è¦åˆå¹¶
</span><span class="c1"></span> <span class="c1">// 2. extraProps.ref è°ƒç”¨ cloneVNode æ—¶å€™ä¼ å…¥çš„ props ref
</span><span class="c1"></span> <span class="c1">// 3. ref å¦‚æœæ˜¯æ•°ç»„ï¼ŒåŠ ä¸Šæ–°çš„ ref æ‰©å±•åŸæ•°ç»„
</span><span class="c1"></span> <span class="c1">// 4. ref ä¸æ˜¯æ•°ç»„ï¼Œç”¨ ref å’Œ extra ref åˆå¹¶æˆæ–°æ•°ç»„
</span><span class="c1"></span> <span class="c1">// 5. å¦‚æœ ref null, åˆ™ç›´æ¥ç”¨ extra ref normalize å‡ºæ–°çš„ ref
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">ref</span> <span class="o">=</span>
   <span class="nx">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">extraProps</span><span class="p">.</span><span class="nx">ref</span>
     <span class="o">?</span> <span class="c1">// #2078 in the case of &lt;component :is=&#34;vnode&#34; ref=&#34;extra&#34;/&gt;
</span><span class="c1"></span>       <span class="c1">// if the vnode itself already has a ref, cloneVNode will need to merge
</span><span class="c1"></span>       <span class="c1">// the refs so the single vnode can be set on multiple refs
</span><span class="c1"></span>       <span class="nx">mergeRef</span> <span class="o">&amp;&amp;</span> <span class="nx">ref</span>
       <span class="o">?</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
         <span class="o">?</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
         <span class="o">:</span> <span class="p">[</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">]</span>
       <span class="o">:</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span>
     <span class="o">:</span> <span class="nx">ref</span><span class="p">;</span>

 <span class="c1">// normalization
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">normalizeRef</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">ref</span> <span class="p">}</span><span class="o">:</span> <span class="nx">VNodeProps</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNodeNormalizedRefAtom</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="nx">ref</span> <span class="o">!=</span> <span class="kc">null</span>
     <span class="o">?</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isRef</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
       <span class="o">?</span> <span class="p">{</span> <span class="nx">i</span>: <span class="kt">currentRenderingInstance</span><span class="p">,</span> <span class="nx">r</span>: <span class="kt">ref</span> <span class="p">}</span>
       <span class="o">:</span> <span class="nx">ref</span>
     : <span class="kt">null</span><span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
 <span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>patchFlag å±æ€§(<a href="#test-vnode-patchflag">æµ‹è¯•-&gt;</a>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">patchFlag</span> <span class="o">=</span>
   <span class="nx">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">Fragment</span>
     <span class="o">?</span> <span class="nx">patchFlag</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// hoisted node
</span><span class="c1"></span>       <span class="o">?</span> <span class="nx">PatchFlags.FULL_PROPS</span>
       : <span class="kt">patchFlag</span> <span class="o">|</span> <span class="nx">PatchFlags.FULL_PROPS</span>
     : <span class="kt">patchFlag</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>ssContent é€’å½’è°ƒç”¨ <code>cloneVNode(vnode.ssContent)</code></p>
</li>
<li>
<p>ssFallback é€’å½’è°ƒç”¨ <code>cloneVNode(vnode.ssFallback)</code></p>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">node1</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="kc">null</span> <span class="cm">/* children */</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; vnode 1\n&#34;</span><span class="p">,</span> <span class="nx">node1</span><span class="p">]);</span>

<span class="kr">const</span> <span class="nx">node2</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">h</span><span class="p">({},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">node1</span><span class="p">]);</span>
<span class="kr">const</span> <span class="nx">cloned2</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">node2</span><span class="p">);</span>
<span class="c1">// cloneVNode åªæ˜¯ä¸€æ¬¡æµ…æ‹·è´
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; node2 == cloned2\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned2</span><span class="p">),</span> <span class="s2">&#34;\n &gt; node2 \n&#34;</span><span class="p">,</span> <span class="nx">node2</span><span class="p">]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; vnode 1
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: { foo: 1 },
  shapeFlag: 1
}
&gt;&gt;&gt; node2 == cloned2
 {
  __v_isVNode: true,
  __v_skip: true,
  type: {},
  children: [
    {
      __v_isVNode: true,
      __v_skip: true,
      type: &#39;div&#39;,
      props: [Object],
      shapeFlag: 1
    }
  ],
  shapeFlag: 20
}
 &gt; node2
 {
  __v_isVNode: true,
  __v_skip: true,
  type: {},
  children: [
    {
      __v_isVNode: true,
      __v_skip: true,
      type: &#39;div&#39;,
      props: [Object],
      shapeFlag: 1
    }
  ],
  shapeFlag: 20
}
undefined
</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/4fbd98f4be00f3fdfcb14839d29ed4a5f45a179c">feat(add): rc-&gt;createVNode, currentRenderingInstance Â· gcclll/stb-vue-next@4fbd98f Â· GitHub</a></p>
<div id="outline-container-test-vnode-key" class="outline-4">
<h4 id="test-vnode-key">
key test
</h4>
<div id="outline-text-test-vnode-key" class="outline-text-4">
<p>
vnode.key çš„ clone æ“ä½œï¼Œå±äºå•çº¯çš„å€¼è¦†ç›–æ“ä½œã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; ä¿ç•™ vnode.key å€¼\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cv</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})),</span> <span class="s2">&#34;key&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span>
  <span class="s2">&#34;&gt;&gt;&gt; æ›¿æ¢ vnode.key å€¼\n&#34;</span><span class="p">,</span>
  <span class="nx">f</span><span class="p">(</span><span class="nx">cv</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}),</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}),</span> <span class="s2">&#34;key&#34;</span><span class="p">),</span>
<span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; æ–° props.key å€¼\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cv</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">),</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}),</span> <span class="s2">&#34;key&#34;</span><span class="p">)]);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; æµ‹è¯• vnode.key å„ç§æƒ…å†µå€¼&#34;</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">of</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">NaN</span><span class="p">])</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span> <span class="p">}),</span> <span class="s2">&#34;key&#34;</span><span class="p">));</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; ä¿ç•™ vnode.key å€¼
 { key: 1 }
&gt;&gt;&gt; æ›¿æ¢ vnode.key å€¼
 { key: 2 }
&gt;&gt;&gt; æ–° props.key å€¼
 { key: 2 }
&gt;&gt;&gt; æµ‹è¯• vnode.key å„ç§æƒ…å†µå€¼
{}
{ key: &#39;a&#39; }
{}
{ key: 1 }
[Vue warn]: VNode created with invalid key (NaN). VNode type:div
{}
undefined
</pre>
</div>
</div>
<div id="outline-container-test-vnode-ref" class="outline-4">
<h4 id="test-vnode-ref">
ref test
</h4>
<div id="outline-text-test-vnode-ref" class="outline-text-4">
<p>
æµç¨‹è„‘å›¾ï¼š
<img src="/img/vue3/runtime-core/vue-runtime-core-vnode-ref.svg" alt="/img/vue3/runtime-core/vue-runtime-core-vnode-ref.svg" title="/img/vue3/runtime-core/vue-runtime-core-vnode-ref.svg" /></p>
<p>
æµ‹è¯•</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span>
    <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span>
    <span class="nx">ssrUtils</span><span class="o">:</span> <span class="p">{</span> <span class="nx">setCurrentRenderingInstance</span><span class="o">:</span> <span class="nx">s</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">mockIns1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">ins</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="nx">mockIns2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">ins</span><span class="o">:</span> <span class="mi">2</span> <span class="p">};</span>
<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns1</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">});</span>
<span class="c1">// æœ¬èº«æ²¡æœ‰çš„æ—¶å€™ä¼šå°† extraProps.ref ä½œä¸ºæ–°çš„ vnode.ref å€¼
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 1. vnode æœ¬èº«æ—  ref\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">cloned1</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 2. ä¿ç•™åŸæœ‰çš„ vnode.ref\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="c1">// è¿™é‡Œæ²¡æŒ‡å®š mergeProp æ‰€ä»¥ä¼šæ›¿æ¢åŸæ¥çš„
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cloned2</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">});</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; 3. ref: &#34;bar&#34; æ›¿æ¢åŸæœ‰çš„ vnode.ref\n&#39;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned2</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">original2</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">cloned3</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original2</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">});</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 4. æ²¡æœ‰ vnode.ref æƒ…å†µï¼Œæ–°å¢ ref\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned3</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>

<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns2</span><span class="p">);</span>
<span class="c1">// åº”è¯¥ä¿ç•™åŸæœ‰çš„ context instance
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cloned4</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 5. åº”è¯¥ä¿ç•™åŸæœ‰çš„ context instance\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned4</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="c1">// ref è¦†ç›–ï¼Œä½¿ç”¨æ–°çš„ context instance: mockIns2
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cloned5</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">});</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 6. ref æ”¹å˜ï¼Œä½¿ç”¨æ–°çš„ context instance\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned5</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="nx">s</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span> <span class="c1">// ç½®ç©º context instance
</span><span class="c1"></span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n\n// mergeRef æƒ…å†µæµ‹è¯•\n&#39;</span><span class="p">)</span>
<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns1</span><span class="p">)</span>
<span class="nx">original</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">})</span>
<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns2</span><span class="p">)</span>
<span class="nx">cloned1</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span> <span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; mergeRef: true åˆå¹¶ vnode.ref\n&#39;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">)])</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">.</span><span class="nx">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">.</span><span class="nx">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 1. vnode æœ¬èº«æ—  ref
 { ref: { i: { ins: 1 }, r: &#39;foo&#39; } }
&gt;&gt;&gt; 2. ä¿ç•™åŸæœ‰çš„ vnode.ref
 { ref: { i: { ins: 1 }, r: &#39;foo&#39; } }
&gt;&gt;&gt; 3. ref: &#34;bar&#34; æ›¿æ¢åŸæœ‰çš„ vnode.ref
 { ref: { i: { ins: 1 }, r: &#39;bar&#39; } }
&gt;&gt;&gt; 4. æ²¡æœ‰ vnode.ref æƒ…å†µï¼Œæ–°å¢ ref
 { ref: { i: { ins: 1 }, r: &#39;bar&#39; } }
&gt;&gt;&gt; 5. åº”è¯¥ä¿ç•™åŸæœ‰çš„ context instance
 { ref: { i: { ins: 1 }, r: &#39;foo&#39; } }
&gt;&gt;&gt; 6. ref æ”¹å˜ï¼Œä½¿ç”¨æ–°çš„ context instance
 { ref: { i: { ins: 2 }, r: &#39;bar&#39; } }


// mergeRef æƒ…å†µæµ‹è¯•

&gt;&gt;&gt; mergeRef: true åˆå¹¶ vnode.ref
 { ref: [ { i: [Object], r: &#39;foo&#39; }, { i: [Object], r: &#39;bar&#39; } ] }
{ i: { ins: 1 }, r: &#39;foo&#39; }
{ i: { ins: 2 }, r: &#39;bar&#39; }
undefined
</pre>
</div>
</div>
<div id="outline-container-test-vnode-patchflag" class="outline-4">
<h4 id="test-vnode-patchflag">
<span class="todo">TODO</span>
patchFlag test
</h4>
<div id="outline-text-test-vnode-patchflag" class="outline-text-4">
<p>
TODO need openBlock&amp;createBlock support.</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span>
    <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span>
    <span class="nx">ssrUtils</span><span class="o">:</span> <span class="p">{</span> <span class="nx">setCurrentRenderingInstance</span><span class="o">:</span> <span class="nx">s</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">hoist</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span> <span class="c1">// é™æ€èŠ‚ç‚¹
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">vnode1</span>
<span class="kr">const</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="nx">createBlock</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
shapeFlag test
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span> <span class="nx">Text</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; ELEMENT\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">),</span> <span class="s2">&#34;shapeFlag&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; STATEFUL_COMONENT\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">({}),</span> <span class="s2">&#34;shapeFlag&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span>
  <span class="s2">&#34;&gt;&gt;&gt; FUNCTION_COMONENT\n&#34;</span><span class="p">,</span>
  <span class="nx">f</span><span class="p">(</span>
    <span class="nx">c</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{}),</span>
    <span class="s2">&#34;shapeFlag&#34;</span>
  <span class="p">),</span>
<span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; Text\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="nx">Text</span><span class="p">),</span> <span class="s2">&#34;shapeFlag&#34;</span><span class="p">)]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; ELEMENT
 { shapeFlag: 1 }
&gt;&gt;&gt; STATEFUL_COMONENT
 { shapeFlag: 4 }
&gt;&gt;&gt; FUNCTION_COMONENT
 { shapeFlag: 2 }
&gt;&gt;&gt; Text
 { shapeFlag: 0 }
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-13" class="outline-4">
<h4 id="headline-13">
mergeProps test
</h4>
<div id="outline-text-headline-13" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">mergeProps</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&#34;c&#34;</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;cc&#34;</span><span class="p">]</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">p3</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">ccc</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}]</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">p4</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">{</span> <span class="nx">cccc</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">};</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; merge class\n&#34;</span><span class="p">,</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">,</span> <span class="nx">p4</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">ps1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&#34;red&#34;</span><span class="p">,</span> <span class="nx">fontSize</span><span class="o">:</span> <span class="mi">10</span> <span class="p">},</span>
<span class="p">};</span>
<span class="kd">let</span> <span class="nx">ps2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&#34;blue&#34;</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="s2">&#34;200px&#34;</span> <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span> <span class="s2">&#34;300px&#34;</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="s2">&#34;300px&#34;</span><span class="p">,</span>
      <span class="nx">fontSize</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">],</span>
<span class="p">};</span>
<span class="kd">let</span> <span class="nx">ps3</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;width:100px;right:10;top:10&#39;</span> <span class="p">}</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; merge style\n&#34;</span><span class="p">,</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">ps1</span><span class="p">,</span> <span class="nx">ps2</span><span class="p">,</span> <span class="nx">ps3</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">clickHandler1</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>
<span class="kd">let</span> <span class="nx">clickHandler2</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>
<span class="kd">let</span> <span class="nx">focusHandler3</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>
<span class="kd">let</span> <span class="nx">ph1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">clickHandler1</span> <span class="p">}</span>
<span class="kd">let</span> <span class="nx">ph2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">clickHandler2</span><span class="p">,</span> <span class="nx">onFocus</span><span class="o">:</span> <span class="nx">focusHandler3</span> <span class="p">}</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; merge handlers\n&#39;</span><span class="p">,</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">ph1</span><span class="p">,</span> <span class="nx">ph2</span><span class="p">)])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; merge class
 { class: &#39;c cc ccc cccc&#39; }
&gt;&gt;&gt; merge style
 {
  style: {
    color: &#39;blue&#39;,
    fontSize: 30,
    width: &#39;100px&#39;,
    height: &#39;300px&#39;,
    right: &#39;10&#39;,
    top: &#39;10&#39;
  }
}
&gt;&gt;&gt; merge handlers
 {
  onClick: [ [Function: clickHandler1], [Function: clickHandler2] ],
  onFocus: [Function: focusHandler3]
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-14" class="outline-4">
<h4 id="headline-14">
<span class="todo">TODO</span>
dynamic children test
</h4>
<div id="outline-text-headline-14" class="outline-text-4">
<p>
&gt; need openBlock&amp;createBlock support</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">mergeProps</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">hoist</span> <span class="o">=</span> <span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">vnode1</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-15" class="outline-4">
<h4 id="headline-15">
<span class="todo">TODO</span>
transformVNodeArgs test
</h4>
</div>
</div>
</div>
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
<span class="todo">TODO</span>
7ec1d30 suspense component
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7ec1d3053a5881d476e535923edce07f36fe77f0">feat(add): rc-&gt;createVNode, type is suspense component Â· gcclll/stb-vue-next@7ec1d30 Â· GitHub</a></p>
<p>
Suspense çš„ children å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// 7. normalize suspense children
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_SUSPENSE__</span> <span class="o">&amp;&amp;</span> <span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SUSPENSE</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">fallback</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">normalizeSuspenseChildren</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
    <span class="nx">vnode</span><span class="p">.</span><span class="nx">ssContent</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
    <span class="nx">vnode</span><span class="p">.</span><span class="nx">ssFallback</span> <span class="o">=</span> <span class="nx">fallback</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// normalizeSuspenseChildren
</span><span class="c1"></span>  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeSuspenseChildren</span><span class="p">(</span>
    <span class="nx">vnode</span>: <span class="kt">VNode</span>
  <span class="p">)</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">content</span>: <span class="kt">VNode</span><span class="p">;</span>
    <span class="nx">fallback</span>: <span class="kt">VNode</span><span class="p">;</span>
  <span class="p">}</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">shapeFlag</span><span class="p">,</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">content</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">fallback</span>: <span class="kt">VNode</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">((</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">Slots</span><span class="p">).</span><span class="k">default</span><span class="p">);</span>
      <span class="nx">fallback</span> <span class="o">=</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">((</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">Slots</span><span class="p">).</span><span class="nx">fallback</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNodeChild</span><span class="p">);</span>
      <span class="nx">fallback</span> <span class="o">=</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">content</span><span class="p">,</span>
      <span class="nx">fallback</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">}</span>

<span class="c1">// &gt;&gt;&gt; normalizeSuspenseSlot
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">(</span><span class="nx">s</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ROOT å¿…é¡»æ˜¯å•èŠ‚ç‚¹ &lt;div&gt;...&lt;/div&gt;
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">singleChild</span> <span class="o">=</span> <span class="nx">filterSingleRoot</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">singleChild</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="sb">`&lt;Suspense&gt; slots expect a single root node.`</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">singleChild</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// normalizeVNode
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">VNodeChild</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">child</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">child</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// empty placeholder
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Comment</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// fragment
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Fragment</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">child</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// already vnode, this should be the most common since compiled templates
</span><span class="c1"></span>    <span class="c1">// always produce all-vnode children arrays
</span><span class="c1"></span>    <span class="c1">// è¿™æ˜¯æœ€å¸¸ç”¨çš„æƒ…å†µï¼Œå› ä¸ºä½¿ç”¨æ¨¡æ¿çš„æ—¶å€™æœ€åç”Ÿæˆçš„ children æ˜¯æ•°ç»„
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">child</span><span class="p">.</span><span class="nx">el</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">child</span> : <span class="kt">cloneVNode</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// strings and numbers
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ£€æµ‹æ˜¯ä¸æ˜¯ single root å‡½æ•°ï¼š <code>filterSingleRoot</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">filterSingleRoot</span><span class="p">(</span>
  <span class="nx">children</span>: <span class="kt">VNodeArrayChildren</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">singleRoot</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isVNode</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// ignore user comment
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">Comment</span> <span class="o">||</span> <span class="nx">child</span><span class="p">.</span><span class="nx">children</span> <span class="o">===</span> <span class="s2">&#34;v-if&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">singleRoot</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// has more than 1 non-comment child, return now
</span><span class="c1"></span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">singleRoot</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">singleRoot</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-vnode-currentBlock" class="outline-3">
<h3 id="vnode-currentBlock">
<span class="todo">TODO</span>
23fc943 currentBlock ä¼˜åŒ–
</h3>
<div id="outline-text-vnode-currentBlock" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/23fc9437e9fba7bb562f79a51410ef59e6b82f8c">feat(add): rc-&gt;createVNode, optimize diff, currentBlock Â·
gcclll/stb-vue-next@23fc943 Â· GitHub</a></p>
<blockquote>
<p>è¿™é‡Œçš„å¤„ç†æ²¡æ€ä¹ˆææ˜ç™½â“</p>
</blockquote>
<p>
æ³¨æ„è¿™é‡Œå¢åŠ çš„å‡ ä¸ªå˜é‡â€¼</p>
<p>
blockStack, currentBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="c1">// Since v-if and v-for are the two possible ways node structure can dynamically
</span><span class="c1">// change, once we consider v-if branches and each v-for fragment a block, we
</span><span class="c1">// can divide a template into nested blocks, and within each block the node
</span><span class="c1">// structure would be stable. This allows us to skip most children diffing
</span><span class="c1">// and only worry about the dynamic nodes (indicated by patch flags).
</span><span class="c1">// é’ˆå¯¹ v-if, v-for åŠ¨æ€æ€§åšçš„ç”±äºï¼Œå‡å°‘å¯¹é™æ€èŠ‚ç‚¹çš„ diff ï¼Œåªéœ€è¦å…³å¿ƒåŠ¨æ€èŠ‚ç‚¹å³å¯
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">blockStack</span><span class="o">:</span> <span class="p">(</span><span class="nx">VNode</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)[]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kd">let</span> <span class="nx">currentBlock</span>: <span class="kt">VNode</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
shouldTrack:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Whether we should be tracking dynamic child nodes inside a block.
</span><span class="c1">// Only tracks when this value is &gt; 0
</span><span class="c1">// We are not using a simple boolean because this value may need to be
</span><span class="c1">// incremented/decremented by nested usage of v-once (see below)
</span><span class="c1">// æ˜¯å¦åº”è¯¥ tracking block å†…åŠ¨æ€çš„å­©å­èŠ‚ç‚¹
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">shouldTrack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ–°å¢å¤„ç†é€»è¾‘ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 8. currentBlock
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span>
   <span class="nx">shouldTrack</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// é¿å… block èŠ‚ç‚¹ tracking è‡ªå·±
</span><span class="c1"></span>   <span class="o">!</span><span class="nx">isBlockNode</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// has current parent block
</span><span class="c1"></span>   <span class="nx">currentBlock</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// presence of a patch flag indicates this node needs patching on updates.
</span><span class="c1"></span>   <span class="c1">// component nodes also should always be patched, because even if the
</span><span class="c1"></span>   <span class="c1">// component doesn&#39;t need to update, it needs to persist the instance on to
</span><span class="c1"></span>   <span class="c1">// the next vnode so that it can be properly unmounted later.
</span><span class="c1"></span>   <span class="p">(</span><span class="nx">patchFlag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// the EVENTS flag is only for hydration and if it is the only flag, the
</span><span class="c1"></span>   <span class="c1">// vnode should not be considered dynamic due to handler caching.
</span><span class="c1"></span>   <span class="nx">patchFlag</span> <span class="o">!==</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">HYDRATE_EVENTS</span>
 <span class="p">)</span> <span class="p">{</span>
   <span class="nx">currentBlock</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è·Ÿè¿™å‡ ä¸ªå˜é‡æœ‰å…³çš„å‡½æ•°ï¼š</p>
</div>
</div>
<div id="outline-container-block-related" class="outline-3">
<h3 id="block-related">
<span class="todo">TODO</span>
block related(open/close/create)
</h3>
<div id="outline-text-block-related" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a2afc70cc89fc0bb7c1b1f6810bea73ab4e40c82">feat(add): rc-&gt;block related, open/create/closeBlock Â· gcclll/stb-vue-next@a2afc70 Â· GitHub</a></p>
<p>
è¿™é‡Œçš„æ‰€æœ‰å‡½æ•°éƒ½å’Œ <a href="#vnode-currentBlock">createVNode é‡Œé¢çš„ currentBlock</a> æœ‰å…³ã€‚</p>
<p>
openBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> ,* Open a block.
</span><span class="cm"> ,* This must be called before `createBlock`. It cannot be part of `createBlock`
</span><span class="cm"> ,* because the children of the block are evaluated before `createBlock` itself
</span><span class="cm"> ,* is called. The generated code typically looks like this:
</span><span class="cm"> ,*
</span><span class="cm"> ,* ```js
</span><span class="cm"> ,* function render() {
</span><span class="cm"> ,*   return (openBlock(),createBlock(&#39;div&#39;, null, [...]))
</span><span class="cm"> ,* }
</span><span class="cm"> ,* ```
</span><span class="cm"> ,* disableTracking is true when creating a v-for fragment block, since a v-for
</span><span class="cm"> ,* fragment always diffs its children.
</span><span class="cm"> ,*
</span><span class="cm"> ,* @private
</span><span class="cm"> ,*/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">openBlock</span><span class="p">(</span><span class="nx">disableTracking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">blockStack</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="nx">currentBlock</span> <span class="o">=</span> <span class="nx">disableTracking</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">[]));</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
closeBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">closeBlock() {</span>
  <span class="nx">blockStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  <span class="nx">currentBlock</span> <span class="o">=</span> <span class="nx">blockStack</span><span class="p">[</span><span class="nx">blockStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
setBlockTracking:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> * Block tracking sometimes needs to be disabled, for example during the
</span><span class="cm"> * creation of a tree that needs to be cached by v-once. The compiler generates
</span><span class="cm"> * code like this:
</span><span class="cm"> *
</span><span class="cm"> * ``` js
</span><span class="cm"> * _cache[1] || (
</span><span class="cm"> *   setBlockTracking(-1),
</span><span class="cm"> *   _cache[1] = createVNode(...),
</span><span class="cm"> *   setBlockTracking(1),
</span><span class="cm"> *   _cache[1]
</span><span class="cm"> * )
</span><span class="cm"> * ```
</span><span class="cm"> *
</span><span class="cm"> * @private
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">setBlockTracking</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">shouldTrack</span> <span class="o">+=</span> <span class="nx">value</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
createBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> * Create a block root vnode. Takes the same exact arguments as `createVNode`.
</span><span class="cm"> * A block root keeps track of dynamic nodes within the block in the
</span><span class="cm"> * `dynamicChildren` array.
</span><span class="cm"> *
</span><span class="cm"> * @private
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">createBlock</span><span class="p">(</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">VNodeTypes</span> <span class="o">|</span> <span class="nx">ClassComponent</span><span class="p">,</span>
  <span class="nx">props?</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">children?</span>: <span class="kt">any</span><span class="p">,</span>
  <span class="nx">patchFlag?</span>: <span class="kt">number</span><span class="p">,</span>
  <span class="nx">dynamicProps?</span>: <span class="kt">string</span><span class="p">[]</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="nx">createVNode</span><span class="p">(</span>
    <span class="kr">type</span><span class="p">,</span>
    <span class="nx">props</span><span class="p">,</span>
    <span class="nx">children</span><span class="p">,</span>
    <span class="nx">patchFlag</span><span class="p">,</span>
    <span class="nx">dynamicProps</span><span class="p">,</span>
    <span class="kc">true</span> <span class="cm">/* isBlock: prevent a block from tracking itself */</span>
  <span class="p">);</span>
  <span class="c1">// save current block children on the block vnode
</span><span class="c1"></span>  <span class="nx">vnode</span><span class="p">.</span><span class="nx">dynamicChildren</span> <span class="o">=</span> <span class="nx">currentBlock</span> <span class="o">||</span> <span class="p">(</span><span class="nx">EMPTY_ARR</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">);</span>
  <span class="c1">// close block
</span><span class="c1"></span>  <span class="nx">closeBlock</span><span class="p">();</span>
  <span class="c1">// a block is always going to be patched, so track it as a child of its
</span><span class="c1"></span>  <span class="c1">// parent block
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">shouldTrack</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">currentBlock</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currentBlock</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">vnode</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç›¸å…³è„‘å›¾ï¼š
<img src="/img/vue3/runtime-core/vue-runtime-core-block-shouldtrack.svg" alt="/img/vue3/runtime-core/vue-runtime-core-block-shouldtrack.svg" title="/img/vue3/runtime-core/vue-runtime-core-block-shouldtrack.svg" /></p>
</div>
</div>
<div id="outline-container-normalize-children" class="outline-3">
<h3 id="normalize-children">
normalizeChildren function
</h3>
<div id="outline-text-normalize-children" class="outline-text-3">
<p>
shapeFlag åˆå§‹å€¼æ£€æµ‹ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// encode the vnode type information into a bitmap
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">shapeFlag</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="c1">// 1
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">__FEATURE_SUSPENSE__</span> <span class="o">&amp;&amp;</span> <span class="nx">isSuspense</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SUSPENSE</span> <span class="c1">// 1 &lt;&lt; 7, 128
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">isTeleport</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TELEPORT</span> <span class="c1">// 1 &lt;&lt; 6, 64
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">isObject</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">STATEFUL_COMPONENT</span> <span class="c1">// 1 &lt;&lt; 2, 4
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">isFunction</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">FUNCTIONAL_COMPONENT</span> <span class="c1">// 1 &lt;&lt; 1, 2
</span><span class="c1"></span>  <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">))</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; only tag\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; tag + props\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; tag + props + children\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">])])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; only tag
 { __v_isVNode: true, __v_skip: true, type: &#39;p&#39;, shapeFlag: 1 }
&gt;&gt;&gt; tag + props
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;p&#39;,
  props: { foo: &#39;foo&#39; },
  shapeFlag: 1
}
&gt;&gt;&gt; tag + props + children
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;p&#39;,
  props: { foo: &#39;foo&#39; },
  children: [ &#39;foo&#39; ],
  shapeFlag: 17
}
undefined
</pre>
<div id="outline-container-headline-20" class="outline-4">
<h4 id="headline-20">
children is function
</h4>
<div id="outline-text-headline-20" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/28d4a55250c6f02264bbb77ca04a87770d358c7c">feat(add): rc-&gt;propsOrChildren is function Â· gcclll/stb-vue-next@28d4a55 Â· GitHub</a></p>
<p>
å¦‚æœæ˜¯å‡½æ•°ï¼Œå½“åš slot çš„ children å¤„ç†ã€‚</p>
<p>
normalizeChildren:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeChildren</span><span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">children</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="kr">type</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">children</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*array*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*object*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// å¦‚æœæ˜¯å‡½æ•°å½“åš slot children ?
</span><span class="c1"></span>    <span class="nx">children</span> <span class="o">=</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">_ctx</span>: <span class="kt">currentRenderingInstance</span> <span class="p">}</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// TODO æ™®é€šç±»å‹
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNodeNormalizedChildren</span>
  <span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">|=</span> <span class="kr">type</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span><span class="nx">c</span> <span class="p">},</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">h</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">c</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">Component</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;br /&gt;&#39;</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">slot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{}</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; default slot\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="nx">Component</span><span class="p">,</span> <span class="nx">slot</span><span class="p">)])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; children is function\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">slot</span><span class="p">)])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; default slot
 {
  __v_isVNode: true,
  __v_skip: true,
  type: { template: &#39;&lt;br /&gt;&#39; },
  children: { default: [Function: slot], _ctx: null },
  shapeFlag: 36
}
&gt;&gt;&gt; children is function
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: {},
  children: { default: [Function: slot], _ctx: null },
  shapeFlag: 33
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-21" class="outline-4">
<h4 id="headline-21">
children is array or æ™®é€šç±»å‹
</h4>
<div id="outline-text-headline-21" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/850c0bc0d8b74e1b88d2158df505c83cb9a71408">feat(add): rc-&gt;createVNode, children is array or primitive Â·
gcclll/stb-vue-next@850c0bc Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// æ•°ç»„ç±»å‹
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
  <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// éå¯¹è±¡ï¼Œæ•°ç»„ï¼Œå‡½æ•°çš„æ™®é€šç±»å‹å¤„ç†
</span><span class="c1"></span><span class="p">{</span>
  <span class="nx">children</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">children</span><span class="p">);</span>
  <span class="c1">// force teleport children to array so it can be moved around
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TELEPORT</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">;</span>
    <span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">)];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// createTextVNode
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createTextVNode</span><span class="p">(</span><span class="nx">text</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="nx">flag</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">Text</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">(</span><span class="nx">__DEV__</span> <span class="o">?</span> <span class="s1">&#39;Text&#39;</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ™®é€šç±»å‹å¤„ç†ä¸­å¦‚æœæ˜¯ <code>ShapeFlags.TELETPORT</code> å½“åš <code>ARRAY_CHILDREN</code> å¤„ç†ï¼Œä¸”
children æŒ‰ç…§æ–‡æœ¬èŠ‚ç‚¹å¤„ç†ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">h</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">c</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="sb">`&gt;&gt;&gt; array will be children(</span><span class="si">${</span><span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="sb">)\n`</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">])]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; string will be children()\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;foo&#34;</span><span class="p">)]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; array will be children(17)
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  children: [ &#39;foo&#39; ],
  shapeFlag: 17
}
&gt;&gt;&gt; string will be children()
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  children: &#39;foo&#39;,
  shapeFlag: 9
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-22" class="outline-4">
<h4 id="headline-22">
children is object
</h4>
<div id="outline-text-headline-22" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/959879e825fb225b39c7fb219ec7e46feb6c7537">feat(add): rc-&gt;createVNode, normalizeChildren is object Â· gcclll/stb-vue-next@959879e Â· GitHub</a></p>
<p>
shapeFlag å¯èƒ½æ˜¯ <code>ShapeFlags.ELEMENT</code> æˆ–è€… <code>ShapeFalgs.TELEPORT</code> ã€‚</p>
<p>
è¿™é‡Œå…ˆæµ‹è¯• ELEMENT æƒ…å†µï¼Œå› ä¸º TELEPORT è¿˜éœ€è¦å®ç° components/Teleport ã€‚</p>
<p>
å¦‚æœ type æ˜¯ å¯¹è±¡ï¼Œ shapeFlag åˆå§‹ç±»å‹ä¼šæ˜¯ <code>ShapeFlags.STATEFULL_COMPONENT, 1 &lt;&lt;
2</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="c1">// å› ä¸º type = {} , shapeFlag = 1 &lt;&lt; 2, 4
</span><span class="c1">// æ‰€ä»¥åœ¨ normalizeChildren é‡Œé¢ isObject åˆ†æ”¯ä¼šè¿›å…¥ else
</span><span class="c1">// è¿›è¡Œå¤„ç†ï¼Œç»è¿‡å¤„ç†ä¹‹åæˆä¸º 4 | SLOTS_CHILDREN,2&lt;&lt;5,32 = 36
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; object\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">({},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">})]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; object
 {
  __v_isVNode: true,
  __v_skip: true,
  type: {},
  children: { foo: &#39;foo&#39;, _ctx: null },
  shapeFlag: 36
}
undefined
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-api-watch" class="outline-2">
<h2 id="api-watch">
â± api watch(source, cb, options)
</h2>
<div id="outline-text-api-watch" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/4f0301ea5d7839e8ce5274ea170dd09bd129f5ee">feat(add): api watch TODOs Â· gcclll/stb-vue-next@4f0301e Â· GitHub</a></p>
<p>
è„‘å›¾ï¼š
<img src="/img/vue3/runtime-core/vue-runtime-core-api-watch.svg" alt="/img/vue3/runtime-core/vue-runtime-core-api-watch.svg" title="/img/vue3/runtime-core/vue-runtime-core-api-watch.svg" /></p>
<blockquote>
<p>ä¸ºäº†æ›´å¥½çš„å®Œæˆ apiWatchï¼Œ éœ€è¦å…ˆå®Œæˆäº† <a href="#scheduler">scheduler</a> ä»»åŠ¡è°ƒåº¦éƒ¨åˆ†ã€‚</p>
</blockquote>
<p>
<code>watch(source, cb, options)</code> å‡½æ•°ä»¥ä¸‹ç§ä½¿ç”¨æ–¹å¼(ä¸‹é¢çš„ cb å‡å¯é€‰å‚æ•°)ï¼š</p>
<ol>
<li>
<p><code>watch(fn)</code> ç­‰ä»·äº <code>watchEffect(fn)</code>, æ—  cb</p>
</li>
<li>
<p><code>watch(fn, cb)</code> ç›‘å¬å‡½æ•°</p>
</li>
<li>
<p><code>watch(ref(0), cb)</code></p>
</li>
<li>
<p><code>watch(reactive({ count: 0}), cb)</code> , reactive å¯¹è±¡é»˜è®¤ <code>deep = true</code></p>
</li>
<li>
<p><code>watch([ref(0), reactive({count: 0})], cb)</code></p>
</li>
<li>
<p><code>watch(fn, cb, { immediate: true })</code> æ­¤æ—¶ï¼Œ cb å¿…é¡»ä¸ºå‡½æ•°ï¼Œ job-&gt;fn è¢«ç«‹å³æ‰§
è¡Œä¸€æ¬¡ï¼Œ cb æ¥å—æ–°æ—§å€¼</p>
</li>
<li>
<p><code>watch(ref({ count: 0}), cb, { deep: true })</code> æ‰‹åŠ¨æŒ‡å®š <code>deep: true</code> æ·±åº¦ç›‘å¬</p>
</li>
<li>
<p>â€¦</p>
</li>
</ol>
<p>æ‰§è¡Œå…·ä½“å®ç°çš„å‡½æ•°ï¼š <code>doWatch()</code></p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>value</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>source</td>
<td>WatchSource, WatchSource[], WatchEffect, object</td>
<td>object watched</td>
</tr>
<tr>
<td>cb</td>
<td>WatchCallback or null</td>
<td>callback</td>
</tr>
</tbody>
<tbody>
<tr>
<td>options</td>
<td>WatchOptions = EMPTY_OBJ</td>
<td></td>
</tr>
<tr>
<td></td>
<td>immediate</td>
<td></td>
</tr>
<tr>
<td></td>
<td>deep</td>
<td></td>
</tr>
<tr>
<td></td>
<td>flush</td>
<td></td>
</tr>
<tr>
<td></td>
<td>onTrack</td>
<td></td>
</tr>
<tr>
<td></td>
<td>onTrigger</td>
<td></td>
</tr>
</tbody>
<tbody>
<tr>
<td>instance</td>
<td>currentInstance</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p><code>watch(source, cb, options?)</code> å‡½æ•°ä¸­çš„ cb æ˜¯å¿…é€‰é¡¹ï¼Œå¦‚æœæƒ³ç›´æ¥ watch effectï¼Œå¯ä½¿
ç”¨ <code>watchEffect(fn, options?)</code> api ã€‚</p>
</blockquote>
<p>
watch å‡½æ•°åŸºæœ¬æµç¨‹ï¼š</p>
<ol>
<li>
<p>cb, immediate, deep æ£€æµ‹</p>
</li>
<li>
<p>getterï¼Œ æ ¹æ® source ä¸åŒç±»å‹è®¾ç½® getter</p>
</li>
<li>
<p>cb + deep: true</p>
</li>
<li>
<p>SSR node env</p>
</li>
<li>
<p>å°† cb å°è£…æˆ job</p>
</li>
<li>
<p><code>runner = effect(getter, option)</code></p>
</li>
<li>
<p>runner å¦‚ä½•æ‰§è¡Œï¼Ÿ</p>
</li>
<li>
<p>stop, removeï¼Œå‡½æ•°è¿”å›ä¸€ä¸ª stop+remove è¯¥ runner æ“ä½œçš„å‡½æ•°</p>
</li>
</ol>
<p>
ä¸‹é¢ç« èŠ‚ä¸­æµ‹è¯•çš„ç”¨ä¾‹åˆ†æè„‘å›¾ï¼š
<img src="/img/vue3/runtime-core/vue-runtime-core-api-watch-tests.svg" alt="/img/vue3/runtime-core/vue-runtime-core-api-watch-tests.svg" title="/img/vue3/runtime-core/vue-runtime-core-api-watch-tests.svg" /></p>
<div id="outline-container-headline-24" class="outline-3">
<h3 id="headline-24">
source is ref
</h3>
<div id="outline-text-headline-24" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b9b7ac6aa908cc375d698fd5762e0ff9a52dbcc5">feat(add): apiWatch-&gt;no cb, getter is ref Â· gcclll/stb-vue-next@b9b7ac6 Â· GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/67523262e127d72237f50e3c437210cc5c2e3d76">fix: watch-&gt;source is ref, cb -&gt; job Â· gcclll/stb-vue-next@6752326 Â· GitHub</a>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">prevCount</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\nvalue changed: &#34;</span> <span class="o">+</span> <span class="nx">i</span><span class="o">++</span><span class="p">);</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">prevCount</span><span class="p">];</span>
    <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">prevCount</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">prevCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
value changed: 0
1 0
</pre>
<p>
æœ‰å…³ä»£ç (doWatch):</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// -&gt; getter
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">getter</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kt">any</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">forceTrigger</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="c1">// 2.1 source is ref
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">source</span> <span class="kr">as</span> <span class="nx">Ref</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
  <span class="nx">forceTrigger</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="nx">source</span> <span class="kr">as</span> <span class="nx">Ref</span><span class="p">).</span><span class="nx">_shallow</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// cb -&gt; job å°è£…
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nx">INITIAL_WATCHER_VALUE</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">job</span>: <span class="kt">SchedulerJob</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// watch(source, cb)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">||</span> <span class="nx">forceTrigger</span> <span class="o">||</span> <span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// cleanup
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="nx">callWithAsyncErrorHandling</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CALLBACK</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">newValue</span><span class="p">,</span>
        <span class="c1">// pass undefined as the old value when it&#39;s changed for the first time
</span><span class="c1"></span>        <span class="c1">// ç¬¬ä¸€æ¬¡çš„æ—¶å€™ oldValue ä¸º undefined
</span><span class="c1"></span>        <span class="nx">oldValue</span> <span class="o">===</span> <span class="nx">INITIAL_WATCHER_VALUE</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">oldValue</span><span class="p">,</span>
        <span class="nx">onInvalidate</span><span class="p">,</span>
      <span class="p">]);</span>
      <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// scheduler å°è£…
</span><span class="c1"></span><span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span> <span class="o">||</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// ä»€ä¹ˆæ–¹å¼æ‰§è¡Œ runner?
</span><span class="c1">// 8. TODO runner å¦‚ä½•æ‰§è¡Œï¼Ÿ
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">immediate</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*flush-&gt;post*/</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">runner</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-25" class="outline-3">
<h3 id="headline-25">
source is reactive
</h3>
<div id="outline-text-headline-25" class="outline-text-3">
<p>
å¦‚æœè¦ watch çš„å¯¹è±¡æ˜¯ä¸ª reactive ï¼Œéœ€è¦è¿›è¡Œé€’å½’ watch ï¼Œå¾—åˆ° getter.</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/697f7f25d2bdafdda09a76ee8b00c949e61d6acb">fix: watch-&gt;source is reactive Â· gcclll/stb-vue-next@697f7f2 Â· GitHub</a></p>
<p>
æ–°å¢ç›¸å…³ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 1. å¦‚æœæ˜¯ reactiveï¼Œéœ€è¦æ·±åº¦ç›‘å¬
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">source</span><span class="p">;</span>
  <span class="nx">deep</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 2. deep: true
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">deep</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">baseGetter</span> <span class="o">=</span> <span class="nx">getter</span><span class="p">;</span>
  <span class="c1">// a. deep: true
</span><span class="c1"></span>  <span class="c1">// b. source is reactive
</span><span class="c1"></span>  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">baseGetter</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// traverse å‡½æ•°
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">seen</span>: <span class="kt">Set</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">seen</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">seen</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">seen</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">seen</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isSet</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isMap</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">v</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">traverse</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">seen</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">seen</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é€’å½’ç›‘å¬ reactive å¯¹è±¡ä»»æ„å±‚çº§ä¸Šçš„å±æ€§å˜åŒ–ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">watch</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">r1</span><span class="o">:</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">10</span> <span class="p">}</span> <span class="p">});</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">preVal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">preVal</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">r1</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">)</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

{ count: 1, r1: { count: 10 } } { count: 1, r1: { count: 10 } }


{ count: 1, r1: { count: 9 } } { count: 1, r1: { count: 9 } }
</pre>
<blockquote>
<p><strong>æ³¨æ„</strong>: newVal å’Œ preVal è¿”å›çš„æ˜¯æ•´ä¸ª state è€Œéå½“å‰æ‰€å‘ç”Ÿå˜æ›´çš„å±æ€§
(count/r1.count)ï¼Œå› ä¸ºåœ¨ job é‡Œé¢æ‰§è¡Œ  runner() å¾—åˆ°æ–°å€¼æ˜¯åœ¨
traverse(baseGetter()) ä¹‹å‰å‘ç”Ÿçš„ï¼Œæ­¤æ—¶å–åˆ°çš„å€¼æ˜¯ state è‡ªèº«ã€‚</p>
</blockquote>
<p>
<img src="/img/tmp/20210115141244.png" alt="/img/tmp/20210115141244.png" title="/img/tmp/20210115141244.png" /></p>
</div>
</div>
<div id="outline-container-watch-array" class="outline-3">
<h3 id="watch-array">
soure is array
</h3>
<div id="outline-text-watch-array" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/af1e590b3bb528f8fb9db4a06ead3978426130c1">feat(add): apiWatch-&gt;source is array Â· gcclll/stb-vue-next@af1e590 Â· GitHub</a></p>
<p>
å¦‚æœè¦ç›‘å¬çš„å¯¹è±¡æ˜¯ä¸ªæ•°ç»„çš„æ—¶å€™ï¼Œéœ€è¦æ£€æµ‹æ•°ç»„å…ƒç´ çš„ç±»å‹ï¼Œé’ˆå¯¹ä¸åŒç±»å‹è¿›è¡Œå¤„ç†ã€‚</p>
<p>
è¦ç‚¹ï¼š</p>
<ol>
<li>
<p>æ•°ç»„å…ƒç´ ä¸èƒ½æ˜¯é™¤ ref/reactive/function ä¹‹å¤–çš„ç±»å‹</p>
</li>
<li>
<p>å¯¹æ•°ç»„å…ƒç´ è®¾å€¼æ—¶å¿…é¡»é€šè¿‡å…ƒç´ åŸå§‹è®¾å€¼æ–¹å¼è¿›è¡Œ(æ¯”å¦‚ï¼š ref è¦ <code>ref.value = xxx</code>)ï¼Œ
å› ä¸ºè¯¥æ•°ç»„æœ¬èº«ä¸æ˜¯ reactive çš„</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span>
    <span class="nx">source</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_GETTER</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// TODO warn invalid source
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>isRef -&gt; ç›‘å¬ item.value</p>
</li>
<li>
<p>isReactive -&gt; traverse(item) é€’å½’</p>
</li>
<li>
<p>isFunction -&gt; callWithErrorHandling(item, instance, â€¦) ç›‘å¬å‡½æ•°è¿”å›å€¼</p>
</li>
<li>
<p>å…¶ä»–ç±»å‹ä¸æ”¯æŒ -&gt; warn invalid source</p>
</li>
</ol>
<p>æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">array</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([]);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">(</span><span class="nx">newArr</span><span class="p">,</span> <span class="nx">preArr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">newArr</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

[ 1 ]

</pre>
<p>
æ•°ç»„æ··åˆæ¨¡å¼(å…ƒç´ åªæ”¯æŒ ref, reactive, function)ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">effect</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
  <span class="nx">val</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">});</span>
<span class="nx">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&#34;---&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
  <span class="kr">const</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">([()</span> <span class="p">=&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="nx">status</span><span class="p">],</span> <span class="p">(</span><span class="nx">vals</span><span class="p">,</span> <span class="nx">oldVals</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">vals</span><span class="p">,</span> <span class="nx">oldVals</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">status</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
dummy = 11

undefined
 [ [ 2, true ], [ 1, false ] ]
</pre>
<blockquote>
<p>Tip. watch æ•°ç»„çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡æ•°ç»„å…ƒç´ åŸæ¥çš„å¯¹è±¡å»æ“ä½œå€¼çš„å˜æ›´ï¼Œå¦‚æœé€šè¿‡æ•°ç»„ä¸‹
æ ‡è®¾å€¼æ˜¯ä¸ä¼šæˆåŠŸçš„ï¼Œå› ä¸ºè¿™ä¸ªæ•°ç»„æœ¬èº«ä¸æ˜¯ reactive çš„ã€‚</p>
<p>
æ¯”å¦‚ï¼š <code>array[0]++</code> å¹¶ä¸ä¼šæ”¹å˜ <code>state.count</code></p>
<p>
åªæœ‰é€šè¿‡ <code>state.count++</code> è‡ªèº«èµ‹å€¼æ“ä½œæ‰ä¼šè§¦å‘æ›´æ–°ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-27" class="outline-3">
<h3 id="headline-27">
source is function
</h3>
<div id="outline-text-headline-27" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/694a389fdeca9e3aaa8e70673da22f74552319fc">feat(add): rc-&gt;api watch-&gt;source is function Â· gcclll/stb-vue-next@694a389 Â·
GitHub</a></p>
<p>
å½“è¦ watch çš„å¯¹è±¡æ˜¯ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å¦æœ‰ cb æœ€åçš„ getter éƒ½æ˜¯é€šè¿‡</p>
<p>
<code>callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER)</code></p>
<p>
æˆ–æ—  cb æ—¶ç­‰ä»·äºæ™®é€šçš„ effect å‡½æ•°</p>
<p>
<code>callWithErrorHandling(source, instance,ErrorCodes.WATCH_CALLBACK,[onInvalidate])</code></p>
<p>
ç›´æ¥æ‰§è¡Œè¿™ä¸ªå‡½æ•°å»æ”¶é›†ä¾èµ–ã€‚</p>
<p>
<img src="/img/tmp/20210115180348.png" alt="/img/tmp/20210115180348.png" title="/img/tmp/20210115180348.png" /></p>
<p>
æ–°å¢ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// å¦‚æœæ˜¯å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œå–å¾—å‡½æ•°æ‰§è¡Œç»“æœ
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// getter with cb
</span><span class="c1"></span>    <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_GETTER</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no cb -&gt; simple effect
</span><span class="c1"></span>    <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isUnmounted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ç»„ä»¶å·²ç»å¸è½½äº†
</span><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>

      <span class="k">return</span> <span class="nx">callWithErrorHandling</span><span class="p">(</span>
        <span class="nx">source</span><span class="p">,</span>
        <span class="nx">instance</span><span class="p">,</span>
        <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CALLBACK</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">onInvalidate</span><span class="p">]</span>
      <span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9565b4aa7a9d05e5551777254c385c7e79f9b840">feat(add): rc-&gt;api watch-&gt;source is function without cb Â·
gcclll/stb-vue-next@9565b4a Â· GitHub</a></p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="nx">watch</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">value</span><span class="p">));</span>
  <span class="nx">val</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>

  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;with cb\n&#34;</span><span class="p">);</span>
  <span class="c1">// function with cb
</span><span class="c1"></span>  <span class="nx">watch</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">val</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">val</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">);</span>
  <span class="nx">val</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="nx">dummy</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">]);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

{ dummy: 1 }
with cb

[ 100, 1 ]

</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/11ee8ef39efe740a5154939352fe7b3193e3d4c2">feat(add): rc-&gt;api watch-&gt;source invalid warning Â· gcclll/stb-vue-next@11ee8ef Â· GitHub</a></p>
<blockquote>
<ol>
<li>
<p>è¿™é‡Œæœ‰ä¸ªå®¹æ˜“ææ··æ·†çš„åœ°æ–¹ï¼Œ <code>watch(fn, cb)</code> çš„æ—¶å€™ï¼Œè™½ç„¶ fn å’Œ cb éƒ½æ˜¯å‡½æ•°ï¼Œä½†
æ˜¯è¦åŒºåˆ†å¼€è¿™ä¸¤è€…ï¼Œå¹¶ææ¸…æ¥šä»–ä»¬æ˜¯å•¥å’Œå…³ç³»æ˜¯å•¥ã€‚</p>
<ol>
<li>
<p>fn æ˜¯è¢«æ£€æµ‹çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯ function é‚£åœ¨è¢«ç›‘å¬ä¹‹å‰éœ€è¦å…ˆæ‰§è¡Œå®ƒï¼Œç­‰äºæ˜¯ç›‘å¬
å‡½æ•°é‡Œé¢çš„å†…å®¹ï¼Œæ¯”å¦‚ï¼šå‡½æ•°å†…æœ‰è®¿é—®æŸä¸ª reactive å˜é‡</p>
</li>
<li>
<p>è€Œ cb æ˜¯å±äºå›è°ƒæ€§è´¨ï¼Œä¸”æ˜¯å½“æ•°æ®æœ‰æ›´æ–°çš„æ—¶å€™çš„å›è°ƒå‡½æ•°ï¼Œå®ƒåªä¼šåœ¨ä¸€ä¸ªåœ°æ–¹è¢«
æ‰§è¡Œï¼Œå³å°è£… job çš„æ—¶å€™ï¼Œéœ€è¦å°†æ•°æ®æ›´æ–°å‰åçš„å˜åŒ–å€¼é€šè¿‡å®ƒä¼ é€’å‡ºæ¥(å¦‚ä¸‹é¢ğŸ‘‡çš„
ä»£ç )</p>
</li>
</ol>
</li>
</ol>
</blockquote>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">job</span>: <span class="kt">SchedulerJob</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// watch(source, cb)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">||</span> <span class="nx">forceTrigger</span> <span class="o">||</span> <span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// cleanup
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="nx">callWithAsyncErrorHandling</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CALLBACK</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">newValue</span><span class="p">,</span>
        <span class="c1">// pass undefined as the old value when it&#39;s changed for the first time
</span><span class="c1"></span>        <span class="c1">// ç¬¬ä¸€æ¬¡çš„æ—¶å€™ oldValue ä¸º undefined
</span><span class="c1"></span>        <span class="nx">oldValue</span> <span class="o">===</span> <span class="nx">INITIAL_WATCHER_VALUE</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">oldValue</span><span class="p">,</span>
        <span class="nx">onInvalidate</span><span class="p">,</span>
      <span class="p">]);</span>
      <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// watchEffect, no cb
</span><span class="c1"></span>    <span class="nx">runner</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-api-watch-deep" class="outline-3">
<h3 id="api-watch-deep">
option deep
</h3>
<div id="outline-text-api-watch-deep" class="outline-text-3">
<p>
å¯¹äºæ·±åº¦ç›‘å¬ä¸»è¦æ˜¯å› ä¸º <code>traverse()</code> å‡½æ•°å¯¹ reactive å¯¹è±¡è¿›è¡Œäº†é€’å½’éå†ï¼Œå¯¹æ¯ä¸ªå±
æ€§è¿›è¡Œäº†è®¿é—®ï¼Œä»è€Œè®©å®ƒæ”¶é›†åˆ°å½“å‰çš„ effect ä½œä¸ºä¾èµ–ï¼Œè¿™æ ·å°†æ¥è¿™äº›è¢«éå†åˆ°çš„å€¼å‘ç”Ÿ
æ”¹å˜æ—¶å°±ä¼šè§¦å‘è¿™ä¸ªæ”¶é›†åˆ°çš„ effect æ‰§è¡Œï¼Œè¾¾åˆ°æ·±åº¦ç›‘å¬æ•ˆæœã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 3. cb + deep: true
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">deep</span><span class="p">)</span> <span class="p">{</span>
   <span class="kr">const</span> <span class="nx">baseGetter</span> <span class="o">=</span> <span class="nx">getter</span><span class="p">;</span>
   <span class="c1">// a. deep: true
</span><span class="c1"></span>
   <span class="c1">// b. source is reactive
</span><span class="c1"></span>   <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">baseGetter</span><span class="p">());</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p><code>traverse()</code> ä½œç”¨å°±æ˜¯é€’å½’éå†æ‰€æœ‰å±æ€§é€šè¿‡ <code>return value</code> æ¥æ‰§è¡Œ get æ“ä½œæ”¶é›†ä¾èµ–ã€‚</p>
</blockquote>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span>
    <span class="nx">nested</span><span class="o">:</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">},</span>
    <span class="nx">array</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="nx">map</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([</span>
      <span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
      <span class="p">[</span><span class="s2">&#34;b&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">]),</span>
    <span class="nx">set</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
  <span class="p">});</span>

  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">state</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">nested</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;a&#34;</span><span class="p">),</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="p">];</span>
    <span class="p">},</span>
    <span class="p">{</span> <span class="nx">deep</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">nested</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
 [ 1, 1, 1, true ]

 [ 1, 2, 1, true ]

 [ 1, 2, 100, true ]

 [ 1, 2, 100, false ]
</pre>
<div id="outline-container-headline-29" class="outline-4">
<h4 id="headline-29">
<span class="todo">TODO</span>
deep ref
</h4>
</div>
</div>
</div>
<div id="outline-container-headline-30" class="outline-3">
<h3 id="headline-30">
option immediate
</h3>
<div id="outline-text-headline-30" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/204ce6824b3f645d79f77f350b78a70bc3a47980">feat(add): rc-&gt;api watch-&gt;immediate option Â· gcclll/stb-vue-next@204ce68 Â·
GitHub</a></p>
<p>
<strong>immediate</strong> é€‰é¡¹ï¼Œä¼šè®© cb/job ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸æ˜¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¼‚æ­¥æ‰§è¡Œã€‚</p>
<p>
æ–°å¢ä»£ç åªéœ€è¦åŠ ä¸€è¡Œï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">immediate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">job</span><span class="p">();</span> <span class="c1">// è¿™é‡Œç›´æ¥è°ƒç”¨ Job
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*flush-&gt;post*/</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">runner</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="mi">_</span><span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">desc</span><span class="p">,</span> <span class="nx">newline</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="nx">log</span><span class="p">([</span><span class="nx">newline</span> <span class="o">?</span> <span class="s2">&#34;\n&#34;</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="sb">`</span><span class="si">${</span><span class="nx">desc</span><span class="si">}</span><span class="sb"> &gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">]);</span>
  <span class="kr">const</span> <span class="nx">cb</span> <span class="o">=</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">val</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">option</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">immediate</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">option</span><span class="p">);</span>

  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;æ”¹å˜å€¼ä¹‹å‰&#34;</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;æ”¹å˜å€¼ä¹‹å&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">nul</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="nx">watch</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">nul</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">option</span><span class="p">);</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;å½“åˆå§‹å€¼ä¸º null&#34;</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">undef</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">();</span>
  <span class="nx">watch</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">option</span><span class="p">);</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;å½“åˆå§‹å€¼ä¸º undefined&#34;</span><span class="p">);</span>
  <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;å½“åˆå§‹å€¼ä¸º undefined, set 3&#34;</span><span class="p">);</span>
  <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;å½“åˆå§‹å€¼ä¸º undefined, set undefined&#34;</span><span class="p">);</span>
  <span class="c1">// undefined === undefined -&gt; hasChanged() -&gt; false
</span><span class="c1"></span>  <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;å½“åˆå§‹å€¼ä¸º undefined, set undefined&#34;</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
 æ”¹å˜å€¼ä¹‹å‰ &gt; dummy = 0
undefined
 æ”¹å˜å€¼ä¹‹å &gt; dummy = 1
 å½“åˆå§‹å€¼ä¸º null &gt; dummy = null
 å½“åˆå§‹å€¼ä¸º undefined &gt; dummy = undefined
 å½“åˆå§‹å€¼ä¸º undefined, set 3 &gt; dummy = 3
 å½“åˆå§‹å€¼ä¸º undefined, set undefined &gt; dummy = undefined
 å½“åˆå§‹å€¼ä¸º undefined, set undefined &gt; dummy = undefined
</pre>
<p>
å¦‚ä¸Šç»“æœï¼Œ cb ä¼šç«‹å³æ‰§è¡Œã€‚</p>
<p>
åœ¨ä½¿ç”¨ deep å’Œ immediate é€‰é¡¹çš„æ—¶å€™å¦‚æœæ²¡æœ‰ cb ä¼šç»™å‡ºè­¦å‘Šï¼Œç›´æ¥çœ‹æºç å§:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 1. cb, immediate, deep æ£€æµ‹
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">immediate</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`watch() &#34;immediate&#34; option is only respected when using the `</span> <span class="o">+</span>
        <span class="sb">`watch(source, callback, options?) signature.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`watch() &#34;deep&#34; option is only respected when using the `</span> <span class="o">+</span>
        <span class="sb">`watch(source, callback, options?) signature.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ <code>deep</code> å’Œ <code>immediate</code> å»ºè®®åœ¨ <code>watch(s, cb, options)</code> å½¢å¼ä¸‹ä½¿ç”¨ï¼Œå³åœ¨
æœ‰ cb å‚æ•°çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p>
<p>
é‚£ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-31" class="outline-3">
<h3 id="headline-31">
option onTrack + onTrigger
</h3>
<div id="outline-text-headline-31" class="outline-text-3">
<p>
è¿™éƒ¨åˆ†å®ç°é€»è¾‘ä¸»è¦åœ¨ <a href="/vue/vue-mind-map-house-reactivity">reactivity</a> æ¨¡å—ã€‚</p>
<p>
onTrack åœ¨ reactivity ä¸­ä½¿ç”¨çš„ï¼Œç”¨æ¥åœ¨è§¦å‘ get å–å€¼æ“ä½œæ—¶è°ƒç”¨ <a href="/vue/vue-mind-map-house-reactivity/#r-track">track()</a> å‡½æ•°æ”¶é›†ä¾
èµ–æ—¶çš„ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶å›è°ƒã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// track() å‡½æˆæœ€å add æ“ä½œä¹‹å
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">dep</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">);</span>
  <span class="c1">// è‡ªèº«ä¿å­˜ä¸€ä»½è¢«ä¾èµ–è€…åå•
</span><span class="c1"></span>  <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">({</span>
      <span class="nx">effect</span>: <span class="kt">activeEffect</span><span class="p">,</span>
      <span class="nx">target</span><span class="p">,</span>
      <span class="kr">type</span><span class="p">,</span>
      <span class="nx">key</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// trigger() å‡½æ•°ä¸­å®ç°
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">({</span>
    <span class="nx">effect</span><span class="p">,</span>
    <span class="nx">target</span><span class="p">,</span>
    <span class="nx">key</span><span class="p">,</span>
    <span class="kr">type</span><span class="p">,</span>
    <span class="nx">newValue</span><span class="p">,</span>
    <span class="nx">oldValue</span><span class="p">,</span>
    <span class="nx">oldTarget</span><span class="p">,</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œä¼šå°† å½“å‰ target çš„ key å±æ€§æ‰€æ”¶é›†çš„ä¾èµ– activeEffect æš´éœ²å‡ºæ¥ã€‚</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">trackEvents</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">triggerEvents</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">onTrack</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span> <span class="cm">/* activeEffect */</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">trackEvents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">onTrigger</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span> <span class="cm">/* effect */</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">triggerEvents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">});</span>
  <span class="nx">watchEffect</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">)];</span>
    <span class="p">},</span>
    <span class="p">{</span> <span class="nx">onTrack</span><span class="p">,</span> <span class="nx">onTrigger</span> <span class="p">}</span>
  <span class="p">);</span>

  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>
  <span class="c1">// æœ‰å¤šå°‘ä¸ªå°±ç­‰äºå‘—è°ƒç”¨äº†å¤šå°‘æ¬¡
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;track events count = &#34;</span> <span class="o">+</span> <span class="nx">trackEvents</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="nx">trackEvents</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;target&#34;</span><span class="p">,</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span> <span class="s2">&#34;key&#34;</span><span class="p">,</span> <span class="s2">&#34;deps&#34;</span><span class="p">]));</span>

  <span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;trigger events count = &#34;</span> <span class="o">+</span> <span class="nx">triggerEvents</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="nx">triggerEvents</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">,</span> <span class="s2">&#34;key&#34;</span><span class="p">,</span> <span class="s2">&#34;oldValue&#34;</span><span class="p">,</span> <span class="s2">&#34;newValue&#34;</span><span class="p">])</span>
  <span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
 [ 1, true, [ &#39;foo&#39;, &#39;bar&#39; ] ]
track events count = 3
{ target: { foo: 1, bar: 2 }, type: &#39;get&#39;, key: &#39;foo&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;has&#39;, key: &#39;bar&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;iterate&#39;, key: Symbol(iterate) }
trigger events count = 2
{ key: &#39;foo&#39;, type: &#39;set&#39;, newValue: 3, oldValue: 1 }
{ key: &#39;bar&#39;, type: &#39;set&#39;, newValue: 4, oldValue: 2 }
</pre>
<div class="comment-block">
<p>è¿™é‡Œè¿˜éœ€è¦å¼€å‘ç¯å¢ƒæ‰èƒ½æµ‹è¯• onTrackï¼Œåªèƒ½æ”¹ä¸€æ”¹å»æ‰ <code>__DEV__</code> è¯•è¯•ã€‚</p>
</div>
</div>
</div>
<div id="outline-container-headline-32" class="outline-3">
<h3 id="headline-32">
stop &amp; cleanup
</h3>
<div id="outline-text-headline-32" class="outline-text-3">
<p>
<strong>stop</strong>: watch() çš„è¿”å›å€¼ï¼Œç”¨æ¥åœæ‰ effect ä½¿å…¶ effect.active = falseï¼Œè®© effect å¤±æ•ˆã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 9. return runner-&gt;stop, remove runner from instance.effects
</span><span class="c1"></span><span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">remove</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">effects</span><span class="o">!</span><span class="p">,</span> <span class="nx">runner</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>cleanup</strong>: æ¸…ç†å·¥ä½œï¼Œè¿™æœ‰ä¸¤ä¸ªè¢«è°ƒç”¨çš„åœ°æ–¹(cleanup + onStopå®ƒä»¬è¢«æ³¨å†Œäº†åŒä¸€ä¸ªå‡½æ•°)ï¼Œ
ä¸€ä¸ªæ˜¯è°ƒåŠ¨ cb/fn ä¹‹å‰ï¼Œä¸€ä¸ªæ˜¯ runner effect è°ƒç”¨ stop çš„æ—¶å€™ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">let</span> <span class="nx">cleanup</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">onInvalidate</span>: <span class="kt">InvalidateCbRegistrator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">cleanup</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onStop</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CLEANUP</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<div id="outline-container-headline-33" class="outline-4">
<h4 id="headline-33">
stop
</h4>
<div id="outline-text-headline-33" class="outline-text-4">
<p>stop æ˜¯ watch è°ƒç”¨çš„è¿”å›å€¼ï¼Œé‡Œé¢ä¼š stop runner ç„¶åå°† runner ä» <code>instance.effects</code>
é‡Œé¢åˆ é™¤ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">watch</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>

  <span class="nx">stop</span><span class="p">();</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
 { dummy: 1 }
{ dummy: 1 }
</pre>
<p>
å¯ä»¥çœ‹åˆ° stop ä¹‹åä¸¤æ¬¡è¾“å‡ºç»“æœæ˜¯ä¸€æ ·ï¼Œå³ stop åé¢çš„ state.count å¤±æ•ˆäº†ï¼Œå› ä¸º
stop effect ä¼šå°† effect.active ç½®ä¸º  false ï¼Œæœ‰å¦‚ä¸‹ä»£ç è¢«æ‰§è¡Œ:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// reactivity/src/effect.ts -&gt; createReactiveEffect()
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effect</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
åˆï¼Œ watch å‡½æ•°é‡Œé¢æ— è®ºå¦‚ä½• scheduler éƒ½æ˜¯æœ‰å€¼çš„ï¼Œæ‰€ä»¥å½“ effect ä¸ºéæ¿€æ´»çŠ¶æ€ï¼Œä»€
ä¹ˆéƒ½ä¸ä¼šå¹²ã€‚</p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-4">
<h4 id="headline-34">
cleanup(æ—  cb)
</h4>
<div id="outline-text-headline-34" class="outline-text-4">
<p>
cleanup ç›¸å…³æºç ï¼Œå¯èƒ½æœ‰ç‚¹ç»•:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// cleanup å’Œæ³¨å†Œ cleanup çš„ä¸€ä¸ªå‡½æ•°
</span><span class="c1">// å¦‚ä¸‹ï¼Œcleanup å’Œ effect onStop æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œæ¸…ç† effect ç”¨
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cleanup</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">onInvalidate</span>: <span class="kt">InvalidateCbRegistrator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">cleanup</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onStop</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CLEANUP</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="c1">// runtime-core/src/apiWatch.ts:watch(source, cb, option)
</span><span class="c1">// Job å°è£…ä¸­å’Œ cleanup æœ‰å…³çš„
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">job</span>: <span class="kt">SchedulerJob</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">runner</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// watch(source, cb)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">||</span> <span class="nx">forceTrigger</span> <span class="o">||</span> <span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// cleanupï¼Œåœ¨æ‰§è¡Œ cb ä¹‹å‰å…ˆæ‰§è¡Œ cleanup
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="c1">// call cb with catch error
</span><span class="c1"></span>      <span class="c1">// è¿™é‡Œç­‰ä»·äº cb(newValue, oldValue, onInvalidate)
</span><span class="c1"></span>      <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="cm">/* else... */</span>
<span class="p">};</span>

<span class="c1">// ç„¶åè¿˜æœ‰ä¸ªåœ°æ–¹ä¸ cleanup æœ‰å…³ï¼Œä¸”è¿™é‡Œè¦è®²åˆ°çš„å†…å®¹ä¼šåœ¨è¿™éƒ¨åˆ†æ‰§è¡Œ
</span><span class="c1">// è·å– getterå‡½æ•°æ—¶å€™ï¼Œå¦‚æœ source æ˜¯å‡½æ•°ç­‰ä»·äº
</span><span class="c1">// watchEffect(source)
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// å¦‚æœæ˜¯å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œå–å¾—å‡½æ•°æ‰§è¡Œç»“æœ
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no cb -&gt; simple effect
</span><span class="c1"></span>    <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isUnmounted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ç»„ä»¶å·²ç»å¸è½½äº†
</span><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="c1">// ç­‰ä»·äº return source(onInvalidate)
</span><span class="c1"></span>    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
  <span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">cleanup</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="sb">`\ncalled </span><span class="si">${</span><span class="o">++</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times.`</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">watchEffect</span><span class="p">((</span><span class="nx">onCleanup</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// è¿™é‡Œæ‰§è¡Œçš„å®é™…ä¸Šæ˜¯ onInvalidate å‡½æ•°ï¼Œå°†cleanup å°è£…åæ³¨å†Œåˆ°
</span><span class="c1"></span>    <span class="c1">// cleanup å’Œ onStop ä¸Šï¼Œåœ¨ cb æ‰§è¡Œä¹‹å‰æˆ– effect stop æ—¶å€™è°ƒç”¨
</span><span class="c1"></span>    <span class="nx">onCleanup</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">);</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="c1">// è¿™é‡Œä¼šè¾“å‡ºä¸€æ¬¡ &#39;called 1 times.&#39;
</span><span class="c1"></span>  <span class="c1">// å› ä¸º cb ä¹‹å‰ä¹‹å‰è¿›è¡Œäº†æ¸…ç†å·¥ä½œ(cleanup())
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>

  <span class="c1">// è¿™é‡Œä¼šè¾“å‡ºä¸€æ¬¡ &#39;called 2 times.&#39;
</span><span class="c1"></span>  <span class="c1">// è¿™é‡Œæ˜¯ effect stop çš„ onStop è§¦å‘çš„
</span><span class="c1"></span>  <span class="nx">stop</span><span class="p">();</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
called 1 times.

 { dummy: 1 }

called 2 times.
</pre>
<blockquote>
<p>å³. å¦‚æœæƒ³åœ¨ effect fn ä¹‹å‰æˆ–åœæ­¢çš„æ—¶å€™è¿›è¡Œæ¸…ç†å·¥ä½œï¼Œå¯ä»¥ä½¿ç”¨
<code>watchEffect(effect)</code> çš„å‚æ•° effect å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ¥æ³¨å†Œ ä¸€ä¸ªå‡½æ•°ä½œä¸ºæ¸…ç†å·¥ä½œ
æˆ–åšå…¶ä»–äº‹æƒ…ã€‚
å¦‚ï¼š <code>watchEffect((onCleanup) =&gt; { onCleanup(cleanup) ... }</code></p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-35" class="outline-4">
<h4 id="headline-35">
cleanup(æœ‰ cb)
</h4>
<div id="outline-text-headline-35" class="outline-text-4">
<p>
å½“æœ‰ cb çš„æ—¶å€™ï¼š <code>watch(source, cb, ...)</code> ï¼Œå°† onCleanup æ³¨å†Œå‡½æ•°ä» cb çš„ç¬¬ä¸‰ä¸ªå‚æ•°æš´éœ²å‡ºæ¥</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">cleanup</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="sb">`\ncalled </span><span class="si">${</span><span class="o">++</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">watch</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">,</span> <span class="nx">onCleanup</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">onCleanup</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">);</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
  <span class="p">});</span>
<span class="c1">// è¿™é‡Œ cleanup å°šä¸ä¼šæ‰§è¡Œ
</span><span class="c1">// å› ä¸ºç¬¬ä¸€æ¬¡æ‰§è¡Œæ˜¯æ³¨å†Œ cleanup è¡Œä¸º
</span><span class="c1"></span>  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>

<span class="c1">// è¿™é‡Œä¼šæ‰§è¡Œä¸€æ¬¡ cleanup ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡èµ‹å€¼æ—¶æ³¨å†Œè¿‡äº†
</span><span class="c1"></span>  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>

<span class="c1">// stop æ—¶å€™æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥æ€»å…±ä¼šæ‰§è¡Œä¸¤æ¬¡ cleanup, n = 2
</span><span class="c1"></span>  <span class="nx">stop</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">({</span><span class="nx">n</span><span class="p">})</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
called 1 times, dummy = 1

called 2 times, dummy = 100
{ n: 2 }
</pre>
<p>
è„‘å›¾åˆ†æï¼š</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-api-watch-cleanup.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-api-watch-cleanup.jpg" title="/img/vue3/runtime-core/vue-runtime-core-api-watch-cleanup.jpg" /></p>
<p>
æ–‡å­—åˆ†æï¼š</p>
<ol>
<li>
<p>cleanup æ³¨å†Œæ—¶æœºåˆ†ä¸ºä¸¤ç§æƒ…å†µ</p>
<ul>
<li>
<p>ä¸€æ˜¯æ—  cb çš„ <code>watchEffect(fn)</code> ï¼Œæ˜¯åœ¨ getter è®¾ç½®é˜¶æ®µå°è£…åˆ° getter å‡½æ•°é‡Œé¢
æ³¨å†Œçš„ï¼Œæ­¤æ—¶ä½œä¸º fn çš„ç¬¬ä¸€ä¸ªå‚æ•°æš´éœ²å‡ºæ¥ <code>fn(onCleanUp)</code> ï¼Œ</p>
</li>
<li>
<p>äºŒæ˜¯æœ‰ cb çš„ <code>watch(ref(0), cb)</code> , åœ¨ job å°è£…æœŸé—´åœ¨è°ƒç”¨ cb çš„æ—¶å€™æ³¨å†Œï¼Œæ­¤
æ—¶ä½œä¸º cb çš„ç¬¬ä¸‰ä¸ªå‚æ•°æš´éœ²å‡ºæ¥ <code>cb(newVal, oldVal, onCleanup)</code></p>
</li>
</ul>
<blockquote>
<p><strong>ä¸¤è€…åŒºåˆ«</strong> ï¼š watchEffect ç”±äºæ—  cb ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ runner, æ­¤æ—¶å°±æ”¶é›†åˆ°äº† cleanupï¼Œ
è€Œ watch æœ‰ cb æ—¶åˆ™æ˜¯ä¼šåœ¨ç¬¬ä¸€æ¬¡å€¼æ›´æ–°è§¦å‘ runner æ‰§è¡Œæ‰å¼€å§‹æ”¶é›† cleanupã€‚</p>
</blockquote>
</li>
<li>
<p>æ‰§è¡Œæ—¶æœºï¼Œè¯¥é˜¶æ®µå’Œæ³¨å†Œæ—¶æœºç›¸è¾…ç›¸æˆï¼Œä¸”åœ¨ cb/fn æ‰§è¡Œä¹‹å‰å°±ä¼šè¢«æ‰§è¡Œï¼Œå› æ­¤ cb/fn
çš„ç¬¬ä¸€æ¬¡æ‰§è¡Œéƒ½å±äºå¯¹ cleanup çš„æ³¨å†Œ</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-watch-sync" class="outline-3">
<h3 id="watch-sync">
flush sync
</h3>
<div id="outline-text-watch-sync" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e1436f2cfe78cdc64c31c03d876c5b743a44fc18">feat(add): rc-&gt;api watch-&gt;option flush=sync Â· gcclll/stb-vue-next@e1436f2 Â· GitHub</a></p>
<p>
æ”¯æŒåŒæ­¥ä»£ç ï¼Œå³æ‰€æœ‰ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼ˆåœ¨å€¼å‘ç”Ÿæ”¹å˜ä¹‹åï¼‰ï¼Œè€Œä¸æ˜¯è¿›å…¥é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œã€‚</p>
<p>
åªéœ€è¦å¢åŠ ä¸€è¡Œä»£ç å°±è¡Œï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 6. TODO scheduler è®¾ç½®
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">scheduler</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;scheduler&#34;</span><span class="p">];</span>
<span class="c1">// 6.1 flush is &#39;sync&#39;
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;sync&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">scheduler</span> <span class="o">=</span> <span class="nx">job</span><span class="p">;</span>  <span class="c1">// æ–°å¢
</span><span class="c1"></span><span class="p">}</span>
<span class="c1">// 6.2 TODO flush is &#39;post&#39;
</span><span class="c1"></span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/* post */</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
<span class="c1">// 6.3 TODO flush is &#39;pre&#39;(default)
</span><span class="c1"></span><span class="k">else</span> <span class="p">{</span>
  <span class="c1">// default: &#39;pre&#39;
</span><span class="c1"></span>  <span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span> <span class="o">||</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// å¸¦ { pre: true } é€‰é¡¹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å¿…é¡»å‘ç”Ÿåœ¨ç»„ä»¶ mounted ä¹‹å‰
</span><span class="c1"></span>      <span class="c1">// ä»è€Œä½¿ä»–è¢«åŒæ­¥è°ƒç”¨ï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡
</span><span class="c1"></span>      <span class="nx">job</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ–°å¢ <code>scheduler = job</code> ç›´æ¥è®©ä»»åŠ¡å‡½æ•°èµ‹å€¼ç»™è°ƒåº¦å™¨ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæœ‰å€¼å‘ç”Ÿå˜åŒ–ï¼Œä¼š
è§¦å‘ effect&gt; <code>trigger()</code> åœ¨è¿™é‡Œé¢ä¼šæ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ <code>option.scheduler</code> å¦‚æœæœ‰ä¼šç«‹å³æ‰§è¡Œè¿™
ä¸ªå‡½æ•°ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// reactivity/effect.ts&gt;trigger()
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">(</span><span class="nx">effect</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">effect</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="o">++</span><span class="nx">calls</span><span class="p">,</span> <span class="p">{</span> <span class="nx">flush</span><span class="o">:</span> <span class="s2">&#34;sync&#34;</span> <span class="p">});</span>

  <span class="nx">log</span><span class="p">({</span> <span class="nx">calls</span> <span class="p">});</span> <span class="c1">// -&gt; 0
</span><span class="c1"></span>  <span class="nx">value</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">({</span> <span class="nx">calls</span> <span class="p">});</span> <span class="c1">// -&gt; 1
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{ calls: 0 }
{ calls: 1 }
undefined
</pre>
<p>
æ³¨æ„çœ‹ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹å¹¶æ²¡æœ‰ç”¨ <code>await nextTick()</code> ï¼Œè€Œæ˜¯åŒæ­¥ä»£ç æ‰§è¡Œã€‚</p>
</div>
</div>
<div id="outline-container-watch-shallow-ref" class="outline-3">
<h3 id="watch-shallow-ref">
shallow ref
</h3>
<div id="outline-text-watch-shallow-ref" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">shallowRef</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">triggerRef</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">shallowRef</span><span class="p">({</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span> <span class="c1">// #1
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">sideEffect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #2 cb -&gt; cb(newVal, oldVal, onCleanUp)
</span><span class="c1"></span>    <span class="nx">sideEffect</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">v</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="c1">// #3
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nshould not trigger: &#34;</span><span class="p">,</span> <span class="nx">sideEffect</span><span class="p">]);</span> <span class="c1">// #4
</span><span class="c1"></span>
  <span class="nx">v</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="o">++</span><span class="p">;</span> <span class="c1">// #5
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nshould not trigger: &#34;</span><span class="p">,</span> <span class="nx">sideEffect</span><span class="p">]);</span> <span class="c1">// #6
</span><span class="c1"></span>
  <span class="nx">triggerRef</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span> <span class="c1">// #7
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nshould trigger now: &#34;</span><span class="p">,</span> <span class="nx">sideEffect</span><span class="p">]);</span> <span class="c1">// #8
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
should not trigger:  0

should not trigger:  0

should trigger now:  2
</pre>
<blockquote>
<p>ref è¿™ä¸€å—è¿˜æ²¡æ·±å…¥å»åˆ†æè¿‡ï¼Œå…ˆæš‚åœâ¸å»å®Œæˆä¸‹è¿™éƒ¨åˆ†ã€‚</p>
<ol>
<li>
<p>DONE [2021-01-20 15:18:37] <a href="/vue/vue-mind-map-house-reactivity/#ref">ref å®Œæˆï¼Œå¯ä»¥å¾€ä¸‹ç»§ç»­äº†</a></p>
</li>
</ol>
</blockquote>
<p>
triggerRef ä½œç”¨æ˜¯æ‰‹åŠ¨è§¦å‘ ref.value ä¸Šæ”¶é›†çš„æ‰€æœ‰ä¾èµ–ã€‚</p>
<p>
ç»“æœåˆ†æï¼š</p>
<ol>
<li>
<p><strong>#1</strong> shallowRef æ„å‘³ç€ <code>{a: 1}</code> ä¸­çš„å±æ€§ a é reactive</p>
</li>
<li>
<p><strong>#2</strong> watch v åŸºäº <strong>1</strong> æ‰€ä»¥åªæ˜¯å¯¹ ref value è¿›è¡Œäº†ç›‘å¬ï¼Œåé¢æ˜¯å€¼å˜æ›´å›è°ƒ</p>
</li>
<li>
<p><strong>#3</strong> å€¼æ²¡å‘ç”Ÿæ”¹å˜ï¼Œæ‰€æœ‰ <strong>#4</strong> è¾“å‡ºè¿˜æ˜¯ 0</p>
</li>
<li>
<p><strong>#5</strong> ç”±äº <code>a</code> å±æ€§é reactive æ‰€ä»¥å®ƒæ²¡æœ‰ä¾èµ–æ”¶é›†æ‰€ä»¥ä¸ä¼šæ‰§è¡Œ cbï¼Œæ‰€ä»¥ <strong>#6</strong> å‡º
ä¾ç„¶æ˜¯ 0</p>
</li>
<li>
<p><strong>#7</strong> è¿™é‡Œæ‰‹åŠ¨è°ƒç”¨ <code>triggerRef(v)</code> ç­‰ä»·äº <code>trigger(v, SET, &#39;value&#39;)</code> è§¦å‘ ref
value çš„ä¾èµ–æ‰§è¡Œï¼Œæ­¤æ—¶ cb ä¼šå¾—åˆ°æ‰§è¡Œï¼ŒsideEffect è¢«èµ‹å€¼æ–°çš„ <code>v.a</code> å€¼</p>
<p>
è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œåœ¨ cb é‡Œé¢æ˜¯ç”¨çš„ v.a è€Œä¸æ˜¯ v.value.a å› ä¸ºåœ¨
<code>watch(s,cb,option)</code> é‡Œé¢æ£€æµ‹åˆ°å¦‚æœ <code>s</code> æ˜¯ ref ç±»å‹ï¼Œä¼šå°† getter è®¾ç½®ä¸º
<code>getter = () =&gt; s.value</code></p>
<p>
è€Œåœ¨æ‰§è¡Œ cb ä¹‹å‰å–æ–°å€¼æ˜¯é€šè¿‡ <code>newVal = runner()</code> å¾—åˆ°çš„ï¼Œè€Œè¿™ä¸ª <code>runner =
effect(getter, {...})</code> æ‰€ä»¥ç­‰äºæ˜¯ <code>effect(() =&gt; s.value, {...})</code></p>
<p>
æ‰€ä»¥å¯¹äº ref ç±»å‹ effect å°è£…çš„å…¶å®æ˜¯ <code>() =&gt; s.value</code> è¿™ä¸ªå‡½
æ•°ï¼Œé‚£ä¹ˆå¯¹äº <code>s.value</code> çš„ä¾èµ–åˆ—è¡¨ä¸­å°±ä¼šæœ‰è¿™ä¸ªç®­å¤´å‡½æ•°ã€‚</p>
<p>
ç„¶ååœ¨ watch é‡Œé¢ä¼šå°† cb çš„æ‰§è¡Œå°è£…è¿› job ï¼Œç„¶åæ ¹æ®æƒ…å†µå°† job å°è£…æˆ–ç›´æ¥èµ‹å€¼
ç»™ scheduler ï¼Œè¿™ä¸ªä¼šä½œä¸º <code>effect(, { scheduler })</code> çš„é€‰é¡¹ä¼ é€’è¿›å»ã€‚</p>
<p>
é‚£ä¹ˆåœ¨ trigger çš„æ—¶å€™æ£€æµ‹åˆ°æä¾›äº† scheduler å°±ä¼šè°ƒç”¨å®ƒï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨
triggerRef(v) ä¼šè§¦å‘ cb çš„è°ƒç”¨å°† <code>obj.a~å¤åˆ¶ç»™ ~sideEffect</code> ï¼Œè¿™ä¸ª obj å°±æ˜¯
runner() æ‰§è¡Œçš„è¿”å›å€¼ä¹Ÿå°±æ˜¯ <code>() =&gt; s.value</code> è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-38" class="outline-3">
<h3 id="headline-38">
<span class="todo">TODO</span>
flush pre(default) cb
</h3>
</div>
<div id="outline-container-headline-39" class="outline-3">
<h3 id="headline-39">
<span class="todo">TODO</span>
flush post cb
</h3>
<div id="outline-text-headline-39" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ec14879bf13deb83cea3401279ea75e1cf44eaf6">feat(add): rc-&gt;watch-&gt;flush = &#39;post&#39; Â· gcclll/stb-vue-next@ec14879 Â· GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9f3ac7dff18926df602a7f0eff08da4b253e26a7">feat(add): rc-&gt;watch-&gt;cb-&gt;flush = &#39;post&#39; Â· gcclll/stb-vue-next@9f3ac7d Â· GitHub</a></p>
<p>
æ–°å¢ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// apiWatch.ts -&gt; scheduler when flush=post
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;post&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">job</span><span class="p">,</span> <span class="nx">instance</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">suspense</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// renderer.ts -&gt; queuePostRenderEffect
</span><span class="c1">// å°†ä»»åŠ¡åŠ å…¥åˆ° suspense.effects æˆ– è°ƒç”¨ queuePostFlushCb
</span><span class="c1">// åŠ å…¥åˆ° pendingPostFlushCbs
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">queuePostRenderEffect</span> <span class="o">=</span> <span class="nx">__FEATURE_SUSPENSE__</span>
  <span class="o">?</span> <span class="nx">queueEffectWithSuspense</span>
  : <span class="kt">queuePostFlushCb</span><span class="p">;</span>

<span class="c1">// components/Suspense.ts
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queueEffectWithSuspense</span><span class="p">(</span>
  <span class="nx">fn</span>: <span class="kt">Function</span> <span class="o">|</span> <span class="nb">Function</span><span class="p">[],</span>
  <span class="nx">suspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span>
<span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">suspense</span> <span class="o">&amp;&amp;</span> <span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingBranch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">fn</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">suspense</span><span class="p">.</span><span class="nx">effects</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">fn</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">suspense</span><span class="p">.</span><span class="nx">effects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-40" class="outline-3">
<h3 id="headline-40">
<span class="todo">TODO</span>
ssr support
</h3>
</div>
<div id="outline-container-headline-41" class="outline-3">
<h3 id="headline-41">
<span class="todo">TODO</span>
instance watch
</h3>
<div id="outline-text-headline-41" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9ec5d5131019fe67bcc7232e39bde1cfe239dbca">feat(add): rc-&gt;watch-&gt;instance watch Â· gcclll/stb-vue-next@9ec5d51 Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// this.$watch
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">instanceWatch</span><span class="p">(</span>
  <span class="k">this</span><span class="o">:</span> <span class="nx">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">source</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">Function</span><span class="p">,</span>
  <span class="nx">cb</span>: <span class="kt">WatchCallback</span><span class="p">,</span>
  <span class="nx">options?</span>: <span class="kt">WatchOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WatchStopHandle</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">publicThis</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="kr">const</span> <span class="nx">getter</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
    <span class="o">?</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">publicThis</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span>
    <span class="o">:</span> <span class="nx">source</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">publicThis</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">doWatch</span><span class="p">(</span><span class="nx">getter</span><span class="p">,</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">publicThis</span><span class="p">),</span> <span class="nx">options</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å°†ç›‘å¬æºï¼Œä¸å½“å‰å®ä¾‹ç»‘å®šï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²è½¬æˆå‡½æ•°ã€‚</p>
</div>
</div>
<div id="outline-container-headline-42" class="outline-3">
<h3 id="headline-42">
ğŸº å°ç»“
</h3>
<div id="outline-text-headline-42" class="outline-text-3">
<p>
è¿™ä¸€èŠ‚æ‰€æè¿°çš„ä¸»è¦æ˜¯ watch/watchEffect å‡½æ•°çš„å®ç°å’Œä½¿ç”¨ï¼Œç”¨æ¥ç›‘å¬æ•°æ®å˜åŒ–åšå‡ºç›¸
åº”ã€‚</p>
<p>
<code>watch(source, cb, option)</code> -&gt; <code>doWatch(source, cb, option)</code></p>
<p>
<code>watchEffect(effect, option)</code> -&gt; <code>doWatch(source /*function*/, null, option)</code></p>
<p>
é‡ç‚¹å›é¡¾ watch ï¼Œå› ä¸º watchEffect æ˜¯åœ¨ source ä¸º function ä¸”æ—  cb æ—¶å€™çš„æƒ…å†µã€‚</p>
<p>
ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ watch å‡½æ•°çš„å®ç°å†…å®¹æ¥é€ä¸ªå›é¡¾ï¼Œå‡½æ•°å®ç°ä»£ç æœ‰ä¸‰ä¸ªé‡ç‚¹</p>
<blockquote>
<p>æ³¨ğŸ–ï¼šwatch é‡Œé¢å‡½æ•°çš„è°ƒç”¨(source æˆ– cb) éƒ½æ˜¯é€šè¿‡ callWithErrorHandling å»å®Œæˆçš„ï¼Œ
è¿™é‡Œå…¶å®å°±æ˜¯ä¸ªå¼‚å¸¸æ‹¦æˆªçš„ä½œç”¨(tryâ€¦catch)ï¼Œé˜²æ­¢æ‰§è¡ŒæŠ¥é”™é˜»ç¢æ•´ä½“é¡µé¢çš„æ‰§è¡Œã€‚</p>
</blockquote>
<ol>
<li>
<p>getter: æ ¹æ® source ç±»å‹å°è£… getter</p>
<p>
<strong>Ref</strong> : getter = () =&gt; source.value</p>
<p>
<strong>Reactive</strong>: deep = true, traverse(source) å¯¹å¯¹è±¡æ‰€æœ‰å±æ€§è§¦å‘ä¸€æ¬¡ getter æ“ä½œã€‚</p>
<p>
<strong>Array</strong>: æ ¹æ®å…ƒç´ ç±»å‹ä¸åŒåšä¸åŒå¤„ç†(æ¯”å¦‚ï¼š <code>ref/reactive/function</code> ä¸”åªæ”¯æŒè¿™
ä¸‰ç§)</p>
<p>
<strong>Function</strong>: getter =&gt; { â€¦ç›´æ¥æ‰§è¡Œ source } ä¸åŒç‚¹åœ¨äºå¦‚æœæœ‰ cb æ—¶ï¼Œæ‰§è¡Œ
<code>source()</code> ï¼Œæ²¡æœ‰æ—¶ <code>source(onInvalidate)</code> è¿™ä¸ª onInvalidate æ˜¯ watch æš´éœ²å‡º
å»çš„ä¸€ä¸ªæ¸…ç†å‡½æ•°å®ƒä¼šè¢«ç»‘å®šåˆ° <code>cleanup</code> å’Œ <code>option.onStop</code> ä¸Šï¼Œåœ¨ effect è¢«
stop æˆ–åœ¨è°ƒç”¨ä¹‹å‰åšçš„ä¸€äº›æ¸…ç†å·¥ä½œã€‚</p>
<p>
è¿™ä¸ªæœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†å¯¹æ¯ä¸ªå±æ€§è¿›è¡Œä¸€æ¬¡ getter è°ƒç”¨ï¼Œç”¨æ¥ effect -&gt; track æ”¶é›†æ¯
ä¸ªå±æ€§çš„ä¾èµ–åˆ—è¡¨(<a href="/vue/vue-mind-map-reactivity/#r-track">reactivity</a>: targetMap -&gt; depsMap -&gt; dep)ã€‚</p>
</li>
<li>
<p>job: æ ¹æ® cb å‚æ•°å°è£… job(å°†æ¥åœ¨å€¼å˜æ›´æ˜¯è§¦å‘æ‰§è¡Œçš„å‡½æ•°)</p>
<p>
job çš„å°è£…åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ cb æ˜¯å‡½æ•°æˆ–ä¸ºç©ºå€¼æ—¶å€™ï¼Œè¿™é‡Œçš„åŒºåˆ«ä¹Ÿæ˜¯ä½“ç°åœ¨ cb
çš„è°ƒç”¨ä¸Šé¢(å…·ä½“å°±æ˜¯ç»™ cb çš„å‚æ•°)ã€‚</p>
<p>
<code>if(cb)</code> é‚£ä¹ˆå…¶è°ƒç”¨å‚æ•°ä¼šæ˜¯ï¼š <code>cb(newVal, oldVal, onCleanup/*onInvalidate*/)</code></p>
<p>
<code>else</code> æ²¡æœ‰ cb çš„æ—¶å€™ä¼šç›´æ¥æ‰§è¡Œ runner() è§¦å‘æ›´æ–°ã€‚</p>
<blockquote>
<p>æ³¨æ„åˆ°å’Œ <strong>1</strong> ä¸­æœ‰ç‚¹ç±»ä¼¼åœ°æ–¹äº†æ²¡ï¼Œè¿™é‡Œçš„ cb(â€¦) å’Œ getter å°è£…é˜¶æ®µå¯¹
<code>source(onInvalidate)</code> çš„è°ƒç”¨ï¼Œå³ä¸ç®¡æ˜¯æœ‰ cb è¿˜æ˜¯æ²¡æœ‰ cbï¼Œ onInvalidate è¿™ä¸ª
å›è°ƒæ€»æ˜¯ä¼šè¢«æš´éœ²å‡ºå»ï¼Œæ— éæ˜¯ä½œä¸º cb å‚æ•°è¿˜æ˜¯ function source çš„å‚æ•°ï¼Œè¿™ä½¿å¾—æˆ‘
ä»¬å¯ä»¥åœ¨æ¯ä¸ªä»»åŠ¡æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œç»“æŸçš„æ—¶é—´ç‚¹åšä¸€äº›äº‹æƒ…(æ¯”å¦‚ï¼š cleanup)ã€‚</p>
</blockquote>
</li>
<li>
<p>scheduler çš„å°è£…(æ ¹æ®é€‰é¡¹ç±»å‹ï¼Œä¸»è¦æ˜¯ <code>flush = sync|post|pre</code>)ï¼Œå€¼å˜æ›´ effect
trigger ä¸­è°ƒç”¨çš„å‡½æ•°</p>
<p>
scheduler æ˜¯å°† job è¿›ä¸€æ­¥å°è£…ï¼Œå°†æ¥å½“å€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ effect -&gt; trigger é‡Œé¢
ä¼šè¢«è°ƒç”¨åˆ°ã€‚</p>
<p>
è¿™ä¸ªå‡½æ•°çš„å€¼ä¸»è¦ç”± <code>flush</code> é€‰é¡¹å†³å®šï¼Œé»˜è®¤å€¼æ˜¯ <code>pre</code> ï¼Œå…¶æ¬¡æœ‰ <code>post|sync</code></p>
<p>
<strong>post</strong>: å¼‚æ­¥æ‰§è¡Œï¼Œä¼šæ·»åŠ åˆ°å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ(<code>pendingPostFlushCbs</code>)</p>
<p>
<strong>sync</strong>: è¡¨ç¤ºä¸ºåŒæ­¥æ›´æ–°ï¼Œå³å½“å€¼å‘ç”Ÿå˜åŒ–äº†ä¼šç«‹å³æ›´æ–°ï¼Œ<a href="#watch-sync">è¯¦æƒ…</a>ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æ¯”å¦‚ï¼šref.value = 0
</span><span class="c1"></span><span class="nx">ref</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
<span class="nx">ref</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// true, è€Œä¸ç”¨ await nextTick() å°±å¯ä»¥å–åˆ°æ›´æ–°åçš„å€¼
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>pre</strong>: é»˜è®¤æ˜¯ pre ç±»å‹ï¼Œè¿™é‡ŒåŒºåˆ†ç»„ä»¶æ˜¯å¦åŠ è½½å®Œæˆï¼Œ <code>instance.isUnmounted</code> å¦‚æœ
åŠ è½½å®Œæˆï¼Œè°ƒç”¨ <code>queuePreFlushCb(job)</code> æ·»åŠ åˆ° <code>pendingPreFlushCbs[]</code> ä¸­ç­‰å¾…æ‰§
è¡Œï¼Œå¦‚æœç»„ä»¶æ²¡æœ‰åŠ è½½å®Œæˆéœ€è¦ç«‹å³æ‰§è¡Œ <code>job()</code> ã€‚</p>
</li>
</ol>
<p>
åœ¨å‰é¢ä¸‰ä¸ªåŸºæœ¬æ¡ä»¶(<code>getter/job/scheduler</code>)å°è£…å®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥æ˜¯è°ƒç”¨
<code>effect(getter, { lazy: true, scheduler, ... })</code> å¾—åˆ° <code>runner()</code> è¿™ä¸ª runner æ˜¯
å¯¹ getter å‡½æ•°çš„ <a href="/vue/vue-mind-map-reactivity">ReactiveEffect å°è£…ã€‚</a></p>
<p>
<strong>runner</strong>: éšåå†³å®šä»€ä¹ˆæ—¶æœºæ‰§è¡Œè¿™ä¸ª <code>runner()</code> è§¦å‘ track æ”¶é›†ä¾èµ–ï¼Œåˆ¤å®šæ¡ä»¶æœ‰
 <code>cb</code>, <code>option.immediate</code>, <code>option.flush=&#34;post&#34;</code></p>
<ol>
<li>
<p><code>cb &amp;&amp; immediate</code> æ—¶å€™ç«‹å³æ‰§è¡Œ <code>job()</code> ä¸èµ° runner</p>
</li>
<li>
<p><code>cb &amp;&amp; !immediate</code> ç«‹å³æ‰§è¡Œ <code>runner()</code> æ ¹æ®ä»»åŠ¡æ€§è´¨å†³å®šæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥</p>
</li>
<li>
<p><code>!cb &amp;&amp; flush===&#39;post&#39;</code> æ£€æµ‹å¦‚æœæ˜¯ suspense åŠ å…¥åˆ°
<code>instance.suspense.effects</code> å¦åˆ™ç›´æ¥ <code>queuePostFlushCb(runner)</code></p>
<p>
è¿™ä¸ªéœ€è¦å¼€å¯ <code>Suspense</code> ç»„ä»¶æ”¯æŒï¼Œè¿™ä¸ª ast render å‡½æ•°å…¶å®å°±æ˜¯åœ¨ä¸€ä¸ª <code>async</code>
å‡½æ•°é‡Œé¢æ‰§è¡Œçš„ä»£ç ã€‚</p>
</li>
<li>
<p><code>else</code> ç›´æ¥æ‰§è¡Œ <code>runner()</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-43" class="outline-2">
<h2 id="headline-43">
ğŸ api createApp
</h2>
<div id="outline-text-headline-43" class="outline-text-2">
<div id="outline-container-headline-44" class="outline-3">
<h3 id="headline-44">
declaration
</h3>
<div id="outline-text-headline-44" class="outline-text-3">
<p>è¿™é‡Œå°±ä¸¤ä¸ªå‡½æ•°</p>
<ol>
<li>
<p><code>createAppContext</code> ä¸Šä¸‹æ–‡åˆ›å»º</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">createAppContext</span><span class="p">()</span><span class="o">:</span> <span class="nx">AppContext</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">{</span>
     <span class="nx">app</span>: <span class="kt">null</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">,</span>
     <span class="nx">config</span><span class="o">:</span> <span class="p">{</span>
       <span class="nx">isNativeTag</span>: <span class="kt">NO</span><span class="p">,</span>
       <span class="nx">performance</span>: <span class="kt">false</span><span class="p">,</span>
       <span class="nx">globalProperties</span><span class="o">:</span> <span class="p">{},</span>
       <span class="nx">optionMergeStrategies</span><span class="o">:</span> <span class="p">{},</span>
       <span class="nx">isCustomElement</span>: <span class="kt">NO</span><span class="p">,</span>
       <span class="nx">errorHandler</span>: <span class="kt">undefined</span><span class="p">,</span>
       <span class="nx">warnHandler</span>: <span class="kt">undefined</span><span class="p">,</span>
     <span class="p">},</span>
     <span class="nx">mixins</span><span class="o">:</span> <span class="p">[],</span>
     <span class="nx">components</span><span class="o">:</span> <span class="p">{},</span>
     <span class="nx">directives</span><span class="o">:</span> <span class="p">{},</span>
     <span class="nx">provides</span>: <span class="kt">Object.create</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>
   <span class="p">};</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>createAppAPI</code> åˆ›å»º <code>createApp</code> å‡½æ•°</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createAppAPI</span><span class="p">&lt;</span><span class="nt">HostElement</span><span class="p">&gt;(</span>
  <span class="nx">render</span>: <span class="kt">RootRenderFunction</span><span class="p">,</span>
  <span class="nx">hydrate?</span>: <span class="kt">RootHydrateFunction</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">CreateAppFunction</span><span class="p">&lt;</span><span class="nt">HostElement</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">rootComponent</span><span class="p">,</span> <span class="nx">rootProps</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{};</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>æ‰€ä»¥ä¸€ä¸ª App ä¸Šä¸‹æ–‡åŒ…å«å†…å®¹ï¼š</p>
<table>
<thead>
<tr>
<th>name</th>
<th>-</th>
<th>-</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>app</code></td>
<td>-</td>
<td></td>
</tr>
<tr>
<td><code>config</code></td>
<td>-</td>
<td></td>
</tr>
<tr>
<td></td>
<td>isNativeTag</td>
<td>NO</td>
</tr>
<tr>
<td></td>
<td>performance</td>
<td>false</td>
</tr>
<tr>
<td></td>
<td>globalProperties</td>
<td>{}</td>
</tr>
<tr>
<td></td>
<td>optionMergeStrategies</td>
<td>{}</td>
</tr>
<tr>
<td></td>
<td>isCustomElement</td>
<td>NO</td>
</tr>
<tr>
<td></td>
<td>errorHandler</td>
<td>undefined</td>
</tr>
<tr>
<td></td>
<td>warnHandler</td>
<td>undefined</td>
</tr>
<tr>
<td>mixins</td>
<td>[]</td>
<td></td>
</tr>
<tr>
<td>components</td>
<td>{}</td>
<td></td>
</tr>
<tr>
<td>directives</td>
<td>{}</td>
<td></td>
</tr>
<tr>
<td>provides</td>
<td>Object.create(null)</td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-headline-45" class="outline-3">
<h3 id="headline-45">
implementation
</h3>
<div id="outline-text-headline-45" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1facd1b3ad797775b298ecfba0d363d4f364b821">feat(add): createApp app apis Â· gcclll/stb-vue-next@1facd1b Â· GitHub</a></p>
<ol>
<li>
<p><code>context = createAppContext()</code> åˆ›å»ºä¸Šä¸‹æ–‡</p>
</li>
<li>
<p><code>installedPlugins = new Set()</code> æ’ä»¶åˆ—è¡¨</p>
</li>
<li>
<p><code>isMounted = false</code> åŠ è½½å®Œæˆæ ‡è¯†</p>
</li>
<li>
<p><code>app = context.app = {...}</code></p>
</li>
<li>
<p><code>return app</code></p>
</li>
</ol>
<p>
æ‰€ä»¥é‡ç‚¹å°±åœ¨ <strong>4</strong> æ„é€  appï¼Œå…¶åŒ…å«çš„ API å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>name</th>
<th>function</th>
</tr>
</thead>
<tbody>
<tr>
<td>get config()</td>
<td>è·å–ä¸Šä¸‹æ–‡é…ç½®ä¿¡æ¯ï¼Œä¸å¯æ›´æ”¹ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºå®ä¾‹æ—¶çš„ option æ”¹å˜</td>
</tr>
<tr>
<td>use(pugin, â€¦options)</td>
<td>æ’ä»¶ç³»ç»Ÿ</td>
</tr>
<tr>
<td>mixin(mixin)</td>
<td>æ··åˆå™¨ç³»ç»Ÿ</td>
</tr>
<tr>
<td>component(name, component)</td>
<td>ç»„ä»¶ç³»ç»Ÿ</td>
</tr>
<tr>
<td>directive(name, directive)</td>
<td>æŒ‡ä»¤ç³»ç»Ÿ</td>
</tr>
<tr>
<td>mount(rootContainer, isHydrate)</td>
<td>mount å‡½æ•°</td>
</tr>
<tr>
<td>unmount()</td>
<td>-</td>
</tr>
<tr>
<td>provide(key, value)</td>
<td>æ³¨å…¥ç³»ç»Ÿ</td>
</tr>
</tbody>
</table>
<div id="outline-container-headline-46" class="outline-4">
<h4 id="headline-46">
app.use(plugin, â€¦options)
</h4>
<div id="outline-text-headline-46" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a3abcbaa931fa622b2a1920434575bf6b5fc83a8">feat(add): createApp use plugin Â· gcclll/stb-vue-next@a3abcba Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">use</span><span class="p">(</span><span class="nx">plugin</span>: <span class="kt">Plugin</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">installedPlugins</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">plugin</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">warn</span><span class="p">(</span><span class="sb">`Plugin has already been applied to target app.`</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">plugin</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">install</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// å‡½æ•°ç›´æ¥æ‰§è¡Œ
</span><span class="c1"></span>    <span class="nx">installedPlugins</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">plugin</span><span class="p">);</span>
    <span class="nx">plugin</span><span class="p">.</span><span class="nx">install</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">plugin</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// æ²¡æœ‰ install å‡½æ•°æ—¶
</span><span class="c1"></span>    <span class="nx">installedPlugins</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">plugin</span><span class="p">);</span>
    <span class="nx">plugin</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// plugin å¿…é¡»è¦ä¹ˆè‡ªå·±æ˜¯å‡½æ•°ï¼Œè¦ä¹ˆæ˜¯åŒ…å« install å‡½æ•°çš„å¯¹è±¡
</span><span class="c1"></span>    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`A plugin must either be a function or an object with an &#34;install&#34; `</span> <span class="o">+</span>
        <span class="sb">`function.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ‰€ä»¥æ’ä»¶ plugin å¿…é¡»è¦ä¹ˆè‡ªå·±æ˜¯å‡½æ•°ã€‚</p>
</div>
</div>
<div id="outline-container-headline-47" class="outline-4">
<h4 id="headline-47">
app.mixin(mixin)
</h4>
<div id="outline-text-headline-47" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b96afcf3b83510071e8fcd6da95b39123b85e241">feat(add): createApp mixin api Â· gcclll/stb-vue-next@b96afcf Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">mixin</span>: <span class="kt">ComponentOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_OPTIONS_API__</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">mixins</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">mixin</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">mixins</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mixin</span><span class="p">);</span>
      <span class="c1">// å¸¦æœ‰ props/emits çš„å…¨å±€ mixin ä¼šæ˜¯çš„ props/emits ç¼“å­˜ä¼˜åŒ–å¤±æ•ˆ
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">props</span> <span class="o">||</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">emits</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">deopt</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span>
        <span class="s2">&#34;Mixin has already been applied to target app&#34;</span> <span class="o">+</span>
          <span class="p">(</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">name</span> <span class="o">?</span> <span class="sb">`: </span><span class="si">${</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å¿…é¡»å¼€å¯äº† options api ç‰¹æ€§æ‰èƒ½ä½¿ç”¨ï¼Œå³ vue3 é‡Œé¢å¯æ ¹æ®éœ€è¦
</span><span class="c1"></span>    <span class="c1">// å…³é—­è¿™ä¸ªåŠŸèƒ½
</span><span class="c1"></span>    <span class="nx">warn</span><span class="p">(</span><span class="s2">&#34;Mixins are only available in builds supporting Options API&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¯æ ¹æ®éœ€è¦åœ¨æ‰“åŒ…çš„æ—¶å€™ç”± <code>__FEATURE_OPTIONS_API__</code> å†³å®šæ˜¯å¦ç»§ç»­æ”¯æŒ mixin åŠŸèƒ½ã€‚</p>
</div>
</div>
<div id="outline-container-headline-48" class="outline-4">
<h4 id="headline-48">
app.component(name, component)
</h4>
<div id="outline-text-headline-48" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9b2579d2b7fbe8e5fe6e8fb9df7381475fd1f247">feat(add): createApp component api Â· gcclll/stb-vue-next@9b2579d Â· GitHub</a></p>
<p>
å†…ç½®æ ‡ç­¾ï¼š <code>slot,component</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">component</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">component?</span>: <span class="kt">Component</span><span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// éªŒè¯ç»„ä»¶åç§°æ˜¯å¦åˆæ³•
</span><span class="c1"></span>    <span class="nx">validateComponentName</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// æ²¡æœ‰å¯¹åº”ç»„ä»¶ï¼Œè§†ä¸ºæ ¹æ®åç§°è·å–ç»„ä»¶æ“ä½œ
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// ç»„ä»¶å·²ç»æ³¨å†Œè¿‡äº†ï¼Œå†æ¬¡æ³¨å†Œç­‰äºè¦†ç›–åŸæœ‰çš„
</span><span class="c1"></span>    <span class="nx">warn</span><span class="p">(</span><span class="sb">`Component &#34;</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">&#34; has already been registered in target app.`</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">context</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">component</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>éªŒè¯ç»„ä»¶åï¼Œä¸èƒ½ç”¨å†…ç½®(<code>isBuiltInTag()</code>)æˆ–è‡ªå®šä¹‰(<code>isCustomElement()</code>)çš„æ ‡ç­¾ä½œä¸ºç»„ä»¶å</p>
</li>
<li>
<p>æ²¡æœ‰ component å‚æ•°çš„æ—¶å€™è§†ä¸ºæ ¹æ® name å»è·å–ç»„ä»¶</p>
</li>
<li>
<p>å½“ name - component å­˜åœ¨æ—¶å±äºè¦†ç›–æ“ä½œï¼Œç»™å‡ºè­¦å‘Š</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-49" class="outline-4">
<h4 id="headline-49">
app.directive(name, directive)
</h4>
<div id="outline-text-headline-49" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ec1a20eb64bf3b482984faaa70ee4337143b5449">feat(add): createApp directive api Â· gcclll/stb-vue-next@ec1a20e Â· GitHub</a></p>
<p>
å†…ç½®æŒ‡ä»¤é›†ï¼š <code>bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">directive</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">directive?</span>: <span class="kt">Directive</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">validateDirectiveName</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">directive</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">directives</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">directives</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`Directive &#34;</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">&#34; has already been registered in target app.`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">directives</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">directive</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-50" class="outline-4">
<h4 id="headline-50">
app.mount(rootContainer, isHydrate)
</h4>
<div id="outline-text-headline-50" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">rootContainer</span>: <span class="kt">HostElement</span><span class="p">,</span> <span class="nx">isHydrate?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">rootComponent</span> <span class="kr">as</span> <span class="nx">ConcreteComponent</span><span class="p">,</span> <span class="nx">rootProps</span><span class="p">);</span>

    <span class="c1">// ä¿å­˜ app context åˆ° root VNode èŠ‚ç‚¹ä¸Š
</span><span class="c1"></span>    <span class="c1">// è¿™ä¸ªå°†ä¼šåœ¨åˆå§‹åŒ– mount æ—¶å€™è¢«è®¾ç½®åˆ°æ ¹å®ä¾‹ä¸Š
</span><span class="c1"></span>    <span class="nx">vnode</span><span class="p">.</span><span class="nx">appContext</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>

    <span class="c1">// HMR root reload
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">reload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">render</span><span class="p">(</span><span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">),</span> <span class="nx">rootContainer</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isHydrate</span> <span class="o">&amp;&amp;</span> <span class="nx">hydrate</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hydrate</span><span class="p">(</span><span class="nx">vnode</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">&lt;</span><span class="nt">Node</span><span class="err">,</span> <span class="na">Element</span><span class="p">&gt;,</span> <span class="nx">rootContainer</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">rootContainer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">isMounted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">_container</span> <span class="o">=</span> <span class="nx">rootContainer</span><span class="p">;</span>
    <span class="c1">// for devtools and telemetry
</span><span class="c1"></span>    <span class="p">(</span><span class="nx">rootContainer</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">__vue_app__</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">||</span> <span class="nx">__FEATURE_PROD_DEVTOOLS__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">devtoolsInitApp</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">version</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">.</span><span class="nx">proxy</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`App has already been mounted.</span><span class="err">\</span><span class="sb">n`</span> <span class="o">+</span>
        <span class="sb">`If you want to remount the same app, move your app creation logic `</span> <span class="o">+</span>
        <span class="sb">`into a factory function and create fresh app instances for each `</span> <span class="o">+</span>
        <span class="sb">`mount - e.g. \`const createMyApp = () =&gt; createApp(App)\``</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p><code>vnode = createVNode(rootComponent, rootProps)</code> åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹</p>
</li>
<li>
<p><code>vnode.appContext = context</code> ä¿å­˜ä¸Šä¸‹æ–‡åˆ°è™šæ‹ŸèŠ‚ç‚¹ä¸Šï¼Œç»„ä»¶åˆå§‹åŒ–æ—¶ä½¿ç”¨</p>
</li>
<li>
<p><code>context.reload = () =&gt; render(cloneVNode(vnode), rootContainer)</code> HMR å¼€å‘æ—¶
æœ‰å˜æ›´çš„çƒ­åŠ è½½</p>
</li>
<li>
<p><code>rootContainer.__vue_app__ = app</code></p>
</li>
<li>
<p>devtool å¼€å‘å·¥å…·ç›¸å…³</p>
</li>
<li>
<p>è¿”å› <code>vnode.component.proxy</code> è¿™ä¸ªæ˜¯å¹²å•¥çš„ï¼Ÿ</p>
</li>
</ol>
<p>
æœ€åï¼Œå¦‚æœ app å·²ç»è¢«åŠ è½½äº†ä¸èƒ½é‡å¤ mountã€‚å¦‚æœéœ€è¦å¯¹ä¸€ä¸ªappåšé‡å¤ mountï¼Œå¯èƒ½çš„
éœ€æ±‚æ˜¯å­˜åœ¨åŒæ—¶åˆ›å»ºå¤šä¸ª app æƒ…å†µï¼Ÿ</p>
<p>
é‚£ä¹ˆè¿™ä¸ªæ—¶å€™åº”è¯¥ä½¿ç”¨å‡½æ•°æ–¹å¼ä½¿ç”¨ï¼Œå¦‚ï¼š</p>
<p>
<code>myCreateApp = (...) =&gt; createApp(App)</code></p>
</div>
</div>
<div id="outline-container-headline-51" class="outline-4">
<h4 id="headline-51">
app.unmount()
</h4>
<div id="outline-text-headline-51" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/63354d31cc1f7591cad8118a33c3be2b96dd788c">feat(add): createApp unmount api Â· gcclll/stb-vue-next@63354d3 Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">unmount() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">_container</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">||</span> <span class="nx">__FEATURE_PROD_DEVTOOLS__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">devtoolsUnmountApp</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`Cannot unmount an app that is not mounted.`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>render(null, ...)</code> ?</p>
</div>
</div>
<div id="outline-container-headline-52" class="outline-4">
<h4 id="headline-52">
app.provide(key, value)
</h4>
<div id="outline-text-headline-52" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/18fb22bf22b613378119d272db1b52d1efd17a90">feat(add): createApp provide api Â· gcclll/stb-vue-next@18fb22b Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">provide</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span> <span class="k">in</span> <span class="nx">context</span><span class="p">.</span><span class="nx">provides</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`App already provides property with key &#34;</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="si">}</span><span class="sb">&#34;. `</span> <span class="o">+</span>
        <span class="sb">`It will be overwritten with the new value.`</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// TypeScript doesn&#39;t allow symbols as index type
</span><span class="c1"></span>  <span class="c1">// https://github.com/Microsoft/TypeScript/issues/24587
</span><span class="c1"></span>  <span class="nx">context</span><span class="p">.</span><span class="nx">provides</span><span class="p">[</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å°±æ˜¯ç®€å•çš„ç»™ <code>context.provides</code> è®¾ç½®æ“ä½œã€‚</p>
<blockquote>
<ol>
<li>
<p>åšä»€ä¹ˆçš„å‘¢ï¼Ÿ</p>
</li>
</ol>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-53" class="outline-3">
<h3 id="headline-53">
test
</h3>
<div id="outline-text-headline-53" class="outline-text-3">
<p>
è¿™é‡Œç›®å‰åªèƒ½æµ‹è¯• mount å’Œ unmount å…¶ä»–çš„ api(provide/â€¦) éœ€è¦ç­‰å®ƒä»¬è¢«å®ç°äº†æ‰èƒ½
ç»§ç»­æµ‹è¯•ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span> <span class="nx">defineComponent</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">createApp</span><span class="p">,</span> <span class="nx">serializeInner</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="nx">defineComponent</span><span class="p">({</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">count</span><span class="o">:</span> <span class="p">{</span>
      <span class="k">default</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">root1</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">).</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root1</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">si</span> <span class="o">=</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root1</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root1 serialize, &#34;</span> <span class="o">+</span> <span class="nx">si</span><span class="p">);</span>

<span class="c1">// mount with props
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">root2</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app2</span> <span class="o">=</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
<span class="nx">app2</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root2</span><span class="p">);</span>
<span class="nx">si</span> <span class="o">=</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root2</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root2 serialize, &#34;</span> <span class="o">+</span> <span class="nx">si</span><span class="p">);</span>

<span class="c1">// unmount
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">root3</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app3</span> <span class="o">=</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>

<span class="c1">// åœ¨ mount ä¹‹å‰å¸è½½
</span><span class="c1"></span><span class="k">try</span> <span class="p">{</span>
  <span class="nx">app3</span><span class="p">.</span><span class="nx">unmount</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span> <span class="c1">// warnning
</span><span class="c1"></span><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;unmount failed.&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">app3</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span>
<span class="nx">app3</span><span class="p">.</span><span class="nx">unmount</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span>
<span class="nx">si</span> <span class="o">=</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root3 serialize, &#34;</span> <span class="o">+</span> <span class="nx">si</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
root1 serialize, 0
root2 serialize, 1
root3 serialize,
undefined
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-api-provide-inject" class="outline-2">
<h2 id="api-provide-inject">
â› api provide &amp; inject
</h2>
<div id="outline-text-api-provide-inject" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b4a1cbc65081f0d91bf02faabccb050218223b02">feat(add): provide &amp; inject api Â· gcclll/stb-vue-next@b4a1cbc Â· GitHub</a></p>
<p>
ä½œç”¨ï¼š åœ¨çˆ¶ç»„ä»¶ä¸­ <code>provide(key,value)</code> å‘å­ç»„ä»¶ä¼ å€¼ï¼Œ <code>inject(key)</code> åœ¨å­ç»„ä»¶ä¸­å¯ä»¥å–åˆ°è¯¥å€¼ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">provide</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">number</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">inject</span><span class="p">(</span>
  <span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span><span class="p">,</span>
  <span class="nx">defaultValue?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">treatDefaultAsFactory</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ¶‰åŠå†…å®¹</p>
<ol>
<li>
<p>provides ç»§æ‰¿ parent providesï¼Œéœ€è¦è‡ªå·±çš„å°±åˆ›å»ºæ–°å¯¹è±¡ç»§æ‰¿è‡ª parent providesï¼Œ
æ‰€ä»¥æŸ¥æ‰¾ injections å¯ä»¥åœ¨åŸå‹é“¾æŸ¥æ‰¾ã€‚</p>
</li>
<li>
<p><code>inject(key, defaultValue, treatDefaultAsFactory = false)</code> ä½ åªæ˜¯ä¸ªç®€å•çš„å–å€¼
æ“ä½œ (<code>provides[key]</code>)ï¼ŸğŸ˜­ï¼ŸğŸ˜­ï¼Ÿ</p>
</li>
</ol>
<blockquote>
<p><strong>Imp</strong>. provide å’Œ inject åªèƒ½åœ¨ <code>setup()</code> æˆ–å‡½æ•°å¼ç»„ä»¶ä¸­ä½¿ç”¨ï¼Œå®ƒä»¬çš„ä½œç”¨æ˜¯æ ¹æ®åŸ
 å‹é“¾ç‰¹æ€§å®ç°ä»çˆ¶ç»„ä»¶å‘å­ç»„ä»¶ä¼ é€’ä¸€äº›å€¼ã€‚</p>
</blockquote>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-inject-provide.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-inject-provide.jpg" title="/img/vue3/runtime-core/vue-runtime-core-inject-provide.jpg" /></p>
<div id="outline-container-headline-55" class="outline-3">
<h3 id="headline-55">
provide(key, value)
</h3>
<div id="outline-text-headline-55" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/42f3d053f2b72d6d504c7cc64c48cfa7a1bee89a">feat(add): provide &amp; inject provide implementation Â· gcclll/stb-vue-next@42f3d05
Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">provide</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">number</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">currentInstance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="sb">`provide() can only be used inside setup().`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">provides</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">provides</span><span class="p">;</span>

    <span class="c1">// é»˜è®¤æƒ…å†µå®ä¾‹ä¼šç»§æ‰¿å®ƒçˆ¶äº²çš„ provides å¯¹è±¡
</span><span class="c1"></span>    <span class="c1">// ä½†æ˜¯å½“å®ƒéœ€è¦ provide è‡ªå·±çš„ values æ—¶å€™ï¼Œé‚£ä¹ˆä½¿ç”¨å®ƒ
</span><span class="c1"></span>    <span class="c1">// çˆ¶äº²çš„ provides ä½œä¸ºåŸå‹åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡å‡ºæ¥å˜æˆè‡ªå·±çš„ provides
</span><span class="c1"></span>    <span class="c1">// è¿™æ ·åœ¨ `inject` é‡Œé¢å¯ä»¥ç®€ä¾¿çš„ä»åŸå‹é“¾ä¸­æŸ¥æ‰¾ injections
</span><span class="c1"></span>    <span class="c1">// ç®€å•è¯´å°±æ˜¯ï¼š
</span><span class="c1"></span>    <span class="c1">// 1. éœ€è¦è‡ªå·±çš„å°±åˆ›å»ºä¸ªæ–°çš„å¯¹è±¡ç»§æ‰¿è‡ª Parent provides
</span><span class="c1"></span>    <span class="c1">// 2. è¿™æ ·åœ¨æŸ¥æ‰¾çš„æ—¶å€™å°±å¯ä»¥å«æ–¹ä¾¿çš„é€šè¿‡åŸå‹é“¾æŸ¥æ‰¾ injections
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">parentProvides</span> <span class="o">=</span>
      <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">provides</span><span class="p">;</span>

    <span class="c1">// å½“çˆ¶ç»„ä»¶å’Œå½“å‰å®ä¾‹ç›¸åŒçš„æ—¶å€™ï¼Œä»çˆ¶ç»„ä»¶çš„ provides åˆ›å»ºä¸€ä¸ªå¤‡ä»½å‡ºæ¥
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">parentProvides</span> <span class="o">===</span> <span class="nx">provides</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">provides</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">provides</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">parentProvides</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// TS doesn&#39;t allow symbol as index type
</span><span class="c1"></span>    <span class="nx">provides</span><span class="p">[</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p><code>Object.create(parentProvides)</code> åˆ›æ–°æ–°çš„å¯¹è±¡æ¥å®¹çº³æ–°çš„ key-value</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-56" class="outline-3">
<h3 id="headline-56">
inject(key, defaultValue, treatDefaultAsFactory = false)
</h3>
<div id="outline-text-headline-56" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">inject</span><span class="p">(</span><span class="nx">defaultValue?</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">treatDefaultAsFactory</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="c1">// currentRenderingInstance å…¼å®¹å‡½æ•°å¼ç»„ä»¶
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">currentInstance</span> <span class="o">||</span> <span class="nx">currentRenderingInstance</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// #2400
</span><span class="c1"></span>    <span class="c1">// to support `app.use` plugins,
</span><span class="c1"></span>    <span class="c1">// fallback to appContext&#39;s `provides` if the intance is at root
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">provides</span> <span class="o">=</span>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="kc">null</span> <span class="c1">// root
</span><span class="c1"></span>        <span class="o">?</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">appContext</span> <span class="o">&amp;&amp;</span> <span class="nx">instance.vnode.appContext.provides</span>
        : <span class="kt">instance.parent.provides</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">provides</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span> <span class="k">in</span> <span class="nx">provides</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TS doesn&#39;t allow symbol as index type
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">provides</span><span class="p">[</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">treatDefaultAsFactory</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">)</span>
        <span class="o">?</span> <span class="nx">defaultValue</span><span class="p">()</span>
        <span class="o">:</span> <span class="nx">defaultValue</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="sb">`injection &#34;</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="si">}</span><span class="sb">&#34; not found.`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`inject() can only be used inside setup() or functional components.`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
inject å°±æ˜¯ä¸ªç®€å•çš„å–å€¼æ“ä½œè€Œå·²ã€‚</p>
<p>
å–å€¼æ¥æºéœ€è¦æ£€æµ‹æ˜¯ä¸æ˜¯æ ¹èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯æ ¹èŠ‚ç‚¹</p>
<p>
<code>provides = instance.vnode.appContext.provides</code></p>
<p>
å¦åˆ™ï¼Œä½¿ç”¨ <code>instance.parent.provides</code></p>
<p>
ç„¶åæ ¹æ® <code>key</code> å–å‡ºå€¼ <code>provides[key]</code></p>
<p>
å¦‚æœæœ‰é»˜è®¤å€¼éœ€è¦è¿”å›é»˜è®¤å€¼?</p>
<p>
<code>defaultValue</code> æˆ– <code>defaultValue()</code></p>
<p>
å±…ç„¶å¦‚æ­¤ç®€å•~~~ï¼Œè¿˜æ˜¯å…ˆçœ‹ä¸‹æ€ä¹ˆç”¨å§ï¼ï¼ï¼</p>
</div>
</div>
<div id="outline-container-headline-57" class="outline-3">
<h3 id="headline-57">
test
</h3>
<div id="outline-text-headline-57" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span> <span class="nx">provide</span><span class="p">,</span> <span class="nx">inject</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">serialize</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">skey</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">Provider</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;foo-p1&#34;</span><span class="p">);</span>
      <span class="c1">// æ”¯æŒç¬¦å·å±æ€§å
</span><span class="c1"></span>      <span class="nx">provide</span><span class="p">(</span><span class="nx">skey</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="c1">// å¯ä»¥æ˜¯å…¶ä»–ç±»å‹ ref, reactive, ...
</span><span class="c1"></span>      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Provider2</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Provider2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;foo-p2&#34;</span><span class="p">);</span>
      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;baz&#34;</span><span class="p">,</span> <span class="s2">&#34;baz&#34;</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Middle</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Middle</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Consumer</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Consumer</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">symb</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="nx">skey</span><span class="p">);</span>
      <span class="c1">// è¿™é‡Œ foo æ‹¿åˆ°çš„ä¼šæ˜¯ Provider2 çš„ foo å€¼
</span><span class="c1"></span>      <span class="c1">// å› ä¸º provides åŸå‹é“¾æ˜¯åŸºäºç»„ä»¶çˆ¶å­å…³ç³»æ¥åˆ›å»ºçš„
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">);</span>
      <span class="c1">// é»˜è®¤å€¼
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">bar</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span><span class="p">);</span>
      <span class="c1">// å› ä¸ºæ˜¯ç®€å•çš„èµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œçš„ count å°±æ˜¯ ref(1) è¿”å›çš„é‚£ä¸ª count
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="nx">symb</span><span class="p">,</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Provider</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;1. root serialize, &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">s</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;2. root serialize, &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
1. root serialize, &lt;div&gt;2,foo-p2,bar,1&lt;/div&gt;
undefined2. root serialize, &lt;div&gt;2,foo-p2,bar,2&lt;/div&gt;
</pre>
<p>
ç»„ä»¶å±‚çº§å…³ç³»(çˆ¶-&gt;å­)ï¼š <code>Provider -&gt; Middle -&gt; Consumer</code></p>
<p>
åœ¨ <code>provide(&#39;foo&#39;, 1)</code> åˆ™åœ¨ Provider ç»„ä»¶çš„ provides ä¸­å¢åŠ äº† <code>{ foo: 1 }</code> ,ç”±äº
å­ç»„ä»¶çš„ provides æ˜¯æ²¿ç”¨æˆ–ç»§æ‰¿äº†çˆ¶çº§çš„ providesã€‚</p>
<p>
æ‰€ä»¥åœ¨å­ç»„ä»¶ <code>Consumer</code> ä¸­ç›´æ¥è°ƒç”¨ <code>inject(&#39;foo&#39;)</code> æ˜¯åœ¨ instance.provides é‡Œé¢å»
æ‰¾è¿™ä¸ªå±æ€§å¯¹åº”çš„å€¼ï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™ä¸€ç›´åœ¨åŸå‹é“¾ä¸Šå¾€ä¸Šæ‰¾ï¼Œæœ€åæ‰¾åˆ°é¡¶çº§çˆ¶ç»„ä»¶
<code>Provider</code> ä¸Šæ‰¾åˆ°åŒ…å« <code>&#39;foo&#39;</code> å±æ€§ï¼Œåˆ™è¿”å›è¿™ä¸ªå€¼ã€‚</p>
<p>
æ‰€ä»¥ï¼Œ <code>inject&amp;provide</code> çš„åº”ç”¨å…¶å®å°±æ˜¯åŸå‹é“¾çš„åº”ç”¨ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©çˆ¶ç»„ä»¶å¯ä»¥åƒå­ç»„
ä»¶æ³¨å…¥ä¸€äº›å€¼ã€‚</p>
<blockquote>
<ol>
<li>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆæ³¨å…¥çš„å€¼ç›´æ¥å˜æˆäº† <code>&lt;div&gt;1&lt;/div&gt;</code> å­èŠ‚ç‚¹äº†ï¼Ÿ</p>
</li>
</ol>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-58" class="outline-2">
<h2 id="headline-58">
âœ¨ api computed
</h2>
<div id="outline-text-headline-58" class="outline-text-2">
<p>
è¿™ä¸ª api æ˜¯å¯¹ reactivity&gt;computed çš„ä¸€æ¬¡ç®€å•å°è£…ï¼Œè¯¦æƒ…è¯·ç›´æ¥æŸ¥çœ‹ <a href="/vue/vue-mind-map-reactivity/#computed">reactivityå¯¹åº”çš„ computed ä¸€èŠ‚</a>ã€‚</p>
<p>
ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">options</span>: <span class="kt">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">getterOrOptions</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">_computed</span><span class="p">(</span><span class="nx">getterOrOptions</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span>
  <span class="nx">recordInstanceBoundEffect</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">effect</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-59" class="outline-2">
<h2 id="headline-59">
ğŸŒ€ api lifecycle
</h2>
<div id="outline-text-headline-59" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/071d8689ca31c9b7c9452986d82e02d3a1769abc">feat(add): api lifecycle init Â· gcclll/stb-vue-next@071d868 Â· GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ee888568952467086d445d2c6f8bb40b4c5be9e9">feat(add): api lifecycle exports Â· gcclll/stb-vue-next@ee88856 Â· GitHub</a>
ç»„ä»¶å£°æ˜å‘¨æœŸ api ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">injectHook</span><span class="p">(</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">LifecycleHooks</span><span class="p">,</span>
  <span class="nx">hook</span>: <span class="kt">Function</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="nx">__weh?</span>: <span class="kt">Function</span> <span class="p">},</span>
  <span class="nx">target</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">,</span>
  <span class="nx">prepend</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="k">return</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">createHook</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">Function </span><span class="o">=</span> <span class="err">()</span> <span class="err">=</span><span class="p">&gt;</span> <span class="kt">any</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="nx">lifecycle</span>: <span class="kt">LifecycleHooks</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">hook</span>: <span class="kt">T</span><span class="p">,</span> <span class="nx">target</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="o">!</span><span class="nx">isInSSRComponentSetup</span> <span class="o">&amp;&amp;</span> <span class="nx">injectHook</span><span class="p">(</span><span class="nx">lifecycle</span><span class="p">,</span> <span class="nx">hook</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onBeforeMount</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_MOUNT</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onMounted</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">MOUNTED</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onBeforeUpdate</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_UPDATE</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onUpdated</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UPDATED</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onUnMount</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UNMOUNTED</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¦‚ä¸Šï¼Œæ‰€æœ‰çš„å£°æ˜å‘¨æœŸå‡½æ•°éƒ½æ˜¯é€šè¿‡ createHook -&gt; injectHook å®ç°ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†çš„é‡ç‚¹
å°±æ˜¯è¿™ä¸ª <code>injectHook(type, hook, targt, prepend)</code> ã€‚</p>
<p>
åœ¨ <code>createHook()</code> é‡Œé¢æœ‰æ£€æµ‹æ˜¯ä¸æ˜¯ SSR ç¯å¢ƒï¼Œåªæœ‰é SSR ç¯å¢ƒä¸‹æ‰ä¼šæœ‰å£°æ˜å‘¨æœŸã€‚</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6e9cd1443626bda721740e7dd1dad8cbc9a8cc1f">feat(add): api lifecycle injectHook Â· gcclll/stb-vue-next@6e9cd14 Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">injectHook</span><span class="p">(</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">LifecycleHooks</span><span class="p">,</span>
  <span class="nx">hook</span>: <span class="kt">Function</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="nx">__weh?</span>: <span class="kt">Function</span> <span class="p">},</span>
  <span class="nx">target</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">,</span>
  <span class="nx">prepend</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">hooks</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="kr">type</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="kr">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="c1">// å°† hook çš„æ‰§è¡Œå°è£…æˆä¸€ä¸ª error handling warpper å‡½æ•°ï¼Œå¹¶ä¸”ç¼“å­˜åˆ° hook.__weh
</span><span class="c1"></span>    <span class="c1">// ä¸Šï¼Œè¿™æ ·åœ¨è°ƒåº¦å™¨é‡Œé¢è°ƒç”¨çš„æ—¶å€™å¯ä»¥è¿›è¡Œå»é‡ï¼Œå› ä¸º scheduler é‡Œé¢æ‰§è¡Œçš„æ—¶å€™
</span><span class="c1"></span>    <span class="c1">// æœ‰å»é‡æ“ä½œï¼Œè¿™é‡Œçš„ __weh = &#39;with error handling&#39;
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">wrappedHook</span> <span class="o">=</span>
      <span class="nx">hook</span><span class="p">.</span><span class="nx">__weh</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">hook</span><span class="p">.</span><span class="nx">__weh</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">isUnmounted</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// åœ¨æ‰€æœ‰çš„å£°æ˜å‘¨æœŸå‡½æ•°ä¸­éƒ½ disable tracking
</span><span class="c1"></span>        <span class="c1">// å› ä¸ºå®ƒä»¬æœ‰å¯èƒ½åœ¨ effects ä¸­è¢«è°ƒç”¨
</span><span class="c1"></span>        <span class="nx">pauseTracking</span><span class="p">();</span>
        <span class="c1">// åœ¨ hook æ‰§è¡ŒæœŸé—´è®¾ç½® currentInstance = targt
</span><span class="c1"></span>        <span class="c1">// å‡è®¾ hook æ²¡æœ‰åŒæ­¥åœ°è§¦å‘å…¶ä»– hooksï¼Œå³åœ¨ä¸€ä¸ª hook é‡Œé¢åŒæ­¥è°ƒç”¨
</span><span class="c1"></span>        <span class="c1">// å¦ä¸€ä¸ªå£°æ˜å‘¨æœŸå‡½æ•°ï¼Ÿ
</span><span class="c1"></span>        <span class="nx">setCurrentInstance</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
        <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">callWithAsyncErrorHandling</span><span class="p">(</span><span class="nx">hook</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="kr">type</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="nx">setCurrentInstance</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="nx">resetTracking</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
      <span class="p">});</span>

    <span class="nx">prepend</span> <span class="o">?</span> <span class="nx">hooks</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">wrappedHook</span><span class="p">)</span> <span class="o">:</span> <span class="nx">hooks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">wrappedHook</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">wrappedHook</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>lifecycle hook å¯ä»¥åœ¨ setup() ä¸­æ‰§è¡Œ</p>
</li>
<li>
<p>è¿™é‡Œçš„æ‰€æœ‰å£°æ˜å‘¨æœŸå‡½æ•°éƒ½ä»¥äº‹ä»¶å½¢å¼å­˜åœ¨ï¼Œæ„å‘³ç€å¯ä»¥é€šè¿‡è¿™äº› api æ³¨å†Œå“ªä¸ªå£°æ˜å‘¨
æœŸéœ€è¦æ‰§è¡Œæ“ä½œçš„å‡½æ•°</p>
</li>
<li>
<p>åœ¨å£°æ˜å‘¨æœŸå‡½æ•°æ‰§è¡ŒæœŸé—´ä¸è¿›è¡Œ <code>track</code> æ”¶é›†ä¾èµ–æ“ä½œï¼Œå®ƒæœ‰å¯èƒ½åœ¨ setup() ä¸­è¿›è¡Œ</p>
</li>
</ol>
<blockquote>
<p>ä½¿ç”¨åŸç†ï¼šè°ƒç”¨ <code>onXxx(fn, ins)</code> å£°æ˜å‘¨æœŸå‡½æ•°æ—¶ï¼Œå®é™…ä¸Šåªæ˜¯å‘å½“å‰çš„å®ä¾‹
<code>currentInstane[type] = []</code> ä¸Šæ³¨å†Œäº†ä¸€ä¸ªå›è°ƒå‡½æ•° fnã€‚æ¯”å¦‚ï¼š</p>
<p>
<code>target.onMounted = [fn1, fn2] // target -&gt; currentInstance å½“å‰å®ä¾‹</code></p>
<p>
ç„¶ååœ¨ç»„ä»¶ render/update è¿‡ç¨‹ä¸­æ ¹æ®å£°æ˜å‘¨æœŸçš„é˜¶æ®µè°ƒç”¨å¯¹åº”çš„ fns ã€‚</p>
</blockquote>
<div id="outline-container-headline-60" class="outline-3">
<h3 id="headline-60">
test base
</h3>
<div id="outline-text-headline-60" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onMounted</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">onBeforeUnmount</span><span class="p">,</span>
    <span class="nx">onBeforeUnmounted</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="sb">`\n-&gt; </span><span class="si">${</span><span class="nx">stage</span><span class="si">}</span><span class="sb">, called = </span><span class="si">${</span><span class="nx">called</span><span class="si">}</span><span class="sb">, serialize root = &#34;</span><span class="si">${</span><span class="nx">s</span><span class="p">()</span><span class="si">}</span><span class="sb">&#34; }`</span><span class="p">);</span>
  <span class="c1">// count.value++
</span><span class="c1"></span><span class="p">};</span>

<span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// è¿™é‡Œæ•…æ„å°† onMounted æ”¾åœ¨å‰é¢
</span><span class="c1"></span>      <span class="c1">// ç»“æœä¼šå‘ç°è¿™ä¸ªè¿˜æ˜¯æœ€åæ‰æ‰§è¡Œ
</span><span class="c1"></span>      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onMounted&#34;</span><span class="p">));</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeMount&#34;</span><span class="p">));</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeUpdate&#34;</span><span class="p">));</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onUpdated&#34;</span><span class="p">));</span>

      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after set value...&#34;</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

-&gt; onBeforeMount, called = 1, serialize root = &#34;&#34; }

-&gt; onMounted, called = 2, serialize root = &#34;&lt;div&gt;0&lt;/div&gt;&#34; }
undefined
-&gt; onBeforeUpdate, called = 3, serialize root = &#34;&lt;div&gt;0&lt;/div&gt;&#34; }

-&gt; onUpdated, called = 4, serialize root = &#34;&lt;div&gt;1&lt;/div&gt;&#34; }
after set value...
&lt;div&gt;1&lt;/div&gt;
</pre>
</div>
</div>
<div id="outline-container-headline-61" class="outline-3">
<h3 id="headline-61">
test update
</h3>
<div id="outline-text-headline-61" class="outline-text-3">
<p>
æµ‹è¯•åœ¨ <code>onBeforeUpdate</code> ä¸­æ‰§è¡Œå€¼æ›´æ–°æ“ä½œä¼šæ€æ ·ï¼Ÿ</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="sb">`\n-&gt; </span><span class="si">${</span><span class="nx">stage</span><span class="si">}</span><span class="sb">, called = </span><span class="si">${</span><span class="nx">called</span><span class="si">}</span><span class="sb">, serialize root = &#34;</span><span class="si">${</span><span class="nx">s</span><span class="p">()</span><span class="si">}</span><span class="sb">&#34; }`</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;-&gt; onUpdated, count.value = &#39;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">()))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeUpdate&#34;</span><span class="p">));</span>

      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after set value...&#34;</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
-&gt; onBeforeUpdate, called = 1, serialize root = &#34;&lt;div&gt;0&lt;/div&gt;&#34; }
-&gt; onUpdated, count.value = 2, &lt;div&gt;2&lt;/div&gt;
after set value...
&lt;div&gt;2&lt;/div&gt;
</pre>
<blockquote>
<ol>
<li>
<p>æœ€å count.value æ¸²æŸ“å‡ºæ¥æ˜¯ 2ï¼Ÿ</p>
</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-headline-62" class="outline-3">
<h3 id="headline-62">
test unmount
</h3>
<div id="outline-text-headline-62" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">onBeforeUnmount</span><span class="p">,</span>
    <span class="nx">onUnmounted</span><span class="p">,</span>
    <span class="nx">onMounted</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="sb">`\n-&gt; </span><span class="si">${</span><span class="nx">stage</span><span class="si">}</span><span class="sb">, called = </span><span class="si">${</span><span class="nx">called</span><span class="si">}</span><span class="sb">, serialize root = &#34;</span><span class="si">${</span><span class="nx">s</span><span class="p">()</span><span class="si">}</span><span class="sb">&#34; }`</span><span class="p">);</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">toggle</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Child</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Child</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeUnmount&#34;</span><span class="p">));</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onUnmounted&#34;</span><span class="p">));</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// è¿™ç­‰äºæ˜¯ç­‰ç»„ä»¶åŠ è½½å®Œæˆä¹‹ååœ¨æ³¨å†Œ unmount
</span><span class="c1"></span>        <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;-&gt; onBeforeUnmount called in onMounted&#34;</span><span class="p">));</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\nafter set value...&#34;</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
-&gt; onBeforeUnmount, called = 1, serialize root = &#34;&lt;div&gt;&lt;/div&gt;&#34; }
-&gt; onBeforeUnmount called in onMounted

-&gt; onUnmounted, called = 2, serialize root = &#34;&lt;!----&gt;&#34; }

after set value...
&lt;!----&gt;
</pre>
</div>
</div>
<div id="outline-container-lc-test-order" class="outline-3">
<h3 id="lc-test-order">
test order
</h3>
<div id="outline-text-lc-test-order" class="outline-text-3">
<p>
æµ‹è¯•å£°æ˜å‘¨æœŸå‡½æ•°æ‰§è¡Œé¡ºåº(å’Œè°ƒç”¨é¡ºåºæ— å…³)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">onMounted</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">onBeforeUnmount</span><span class="p">,</span>
    <span class="nx">onUnmounted</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Root</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onBeforeMount&#39;</span><span class="p">))</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onMounted&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onBeforeUpdate&#39;</span><span class="p">))</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onUpdated&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onBeforeUnmount&#39;</span><span class="p">))</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onUnmounted&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Mid</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="p">});</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Mid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onBeforeMount&#39;</span><span class="p">))</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onMounted&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onBeforeUpdate&#39;</span><span class="p">))</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onUpdated&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onBeforeUnmount&#39;</span><span class="p">))</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onUnmounted&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Child</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">count</span> <span class="p">});</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Child</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onBeforeMount&#39;</span><span class="p">))</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onMounted&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onBeforeUpdate&#39;</span><span class="p">))</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onUpdated&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onBeforeUnmount&#39;</span><span class="p">))</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onUnmounted&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>


  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Root</span><span class="p">),</span> <span class="nx">root</span><span class="p">)</span>
 <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n0. before update value &gt;&#39;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">])</span>
  <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1">// update
</span><span class="c1"></span>  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n1. update value &gt;&#39;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">])</span>
  <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1">// unmount
</span><span class="c1"></span>  <span class="nx">render</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">root</span><span class="p">)</span>
  <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n2. unmount &gt;&#39;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">])</span>
  <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

0. before update value &gt; [
  &#39;root onBeforeMount&#39;,
  &#39;Mid onBeforeMount&#39;,
  &#39;Child onBeforeMount&#39;,
  &#39;Child onMounted&#39;,
  &#39;Mid onMounted&#39;,
  &#39;root onMounted&#39;
]
undefined
1. update value &gt; [
  &#39;root onBeforeUpdate&#39;,
  &#39;Mid onBeforeUpdate&#39;,
  &#39;Child onBeforeUpdate&#39;,
  &#39;Child onUpdated&#39;,
  &#39;Mid onUpdated&#39;,
  &#39;root onUpdated&#39;
]

2. unmount &gt; [
  &#39;root onBeforeUnmount&#39;,
  &#39;Mid onBeforeUnmount&#39;,
  &#39;Child onBeforeUnmount&#39;,
  &#39;Child onUnmounted&#39;,
  &#39;Mid onUnmounted&#39;,
  &#39;root onUnmounted&#39;
]
</pre>
<p>
ä»ä¸Šé¢çš„ç»“æœå¯çŸ¥æ•´ä¸ªç»„ä»¶å£°æ˜å‘¨æœŸå‘ç”Ÿè¿‡ç¨‹ã€‚</p>
<ol>
<li>
<p>ç»„ä»¶ mount é¡ºåºï¼Œ child -&gt; mid -&gt; compï¼Œå­ç»„ä»¶ -&gt; â€¦ -&gt; çˆ¶ç»„ä»¶</p>
</li>
<li>
<p>ç»„ä»¶ update é¡ºåºï¼Œ child -&gt; mid -&gt; comp, å­ç»„ä»¶ -&gt; â€¦ -&gt; çˆ¶ç»„ä»¶</p>
</li>
<li>
<p>ç»„ä»¶ unmount é¡ºåºï¼Œ child -&gt; mid -&gt; comp, å­ç»„ä»¶ -&gt; â€¦ -&gt; çˆ¶ç»„ä»¶</p>
</li>
</ol>
<p>ç»„ä»¶çš„ before å£°æ˜å‘¨æœŸè§¦å‘é¡ºåºæ˜¯ï¼š child -&gt; mid -&gt; comp å®Œæˆä¹‹åçš„é¡ºåºåˆšå¥½ç›¸åã€‚</p>
</div>
</div>
<div id="outline-container-headline-64" class="outline-3">
<h3 id="headline-64">
test render track &amp; trigger
</h3>
<div id="outline-text-headline-64" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
    <span class="nx">reactive</span><span class="p">,</span>
    <span class="nx">onRenderTracked</span><span class="p">,</span>
    <span class="nx">onRenderTriggered</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">events</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">});</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onRenderTriggered</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
      <span class="nx">onRenderTracked</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)]);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">))</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;called = &#39;</span> <span class="o">+</span> <span class="nx">called</span><span class="p">)</span> <span class="c1">// 3
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; track events&#39;</span><span class="p">)</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; trigger events&#39;</span><span class="p">)</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span><span class="o">++</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">bar</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">baz</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>

<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
called = 3
&gt;&gt; track events
{ target: { foo: 1, bar: 2 }, type: &#39;get&#39;, key: &#39;foo&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;has&#39;, key: &#39;bar&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;iterate&#39;, key: Symbol(iterate) }
&gt;&gt; trigger events
{ target: { foo: 2, bar: 2 }, key: &#39;foo&#39;, type: &#39;set&#39; }
{ target: { foo: 2 }, key: &#39;bar&#39;, type: &#39;delete&#39; }
{ target: { foo: 2, baz: 3 }, key: &#39;baz&#39;, type: &#39;add&#39; }
undefined
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-define-component" class="outline-2">
<h2 id="define-component">
ğŸ¦‰ api define component
</h2>
<div id="outline-text-define-component" class="outline-text-2">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// implementation, close to no-op
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineComponent</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">?</span> <span class="p">{</span> <span class="nx">setup</span>: <span class="kt">options</span><span class="p">,</span> <span class="nx">name</span>: <span class="kt">options.name</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">options</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-66" class="outline-2">
<h2 id="headline-66">
ğŸ†˜ api setup helpers
</h2>
<div id="outline-text-headline-66" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3e71787313dbc4a2eb7624bb75ef140b0cd2247b">feat(add): api setup helpers Â· gcclll/stb-vue-next@3e71787 Â· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// runtime-core/src/apiSetupHelpers.ts
</span><span class="c1">// implementation
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineProps() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`defineProps() is a compiler-hint helper that is only usable inside `</span> <span class="o">+</span>
        <span class="sb">`&lt;script setup&gt; of a single file component. Its arguments should be `</span> <span class="o">+</span>
        <span class="sb">`compiled away and passing it at runtime has no effect.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineEmit() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`defineEmit() is a compiler-hint helper that is only usable inside `</span> <span class="o">+</span>
        <span class="sb">`&lt;script setup&gt; of a single file component. Its arguments should be `</span> <span class="o">+</span>
        <span class="sb">`compiled away and passing it at runtime has no effect.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">useContext</span><span class="p">()</span><span class="o">:</span> <span class="nx">SetupContext</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">getCurrentInstance</span><span class="p">()</span><span class="o">!</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`useContext() called without active instance.`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">i</span><span class="p">.</span><span class="nx">setupContext</span> <span class="o">||</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">setupContext</span> <span class="o">=</span> <span class="nx">createSetupContext</span><span class="p">());</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡ŒåŒ…å«ä¸‰ä¸ªå‡½æ•°ï¼Œå…¶ä¸­ <code>defineProps&amp;defineEmit</code> éƒ½æ˜¯ä¸”åªä¼šåœ¨ <code>&lt;script setup&gt;</code> é‡Œ
é¢ä½¿ç”¨ï¼Œä»–ä»¬çš„ä½œç”¨åªæ˜¯ç”¨äº <code>compiler-sfc</code> åŒ…ä¸­åœ¨ <code>babel/parser</code> è§£æè¯­æ³•æ ‘æœŸé—´ï¼Œ
ç”¨æ¥æ ‡è¯†ä»–ä»¬æ˜¯ propsæˆ– emits çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åç»™ä»–ä»¬çš„å‚æ•°ä¼šè¢«å½“åš props å’Œ emits
åˆå¹¶åˆ°æœ€ç»ˆ export å‡ºå»çš„å¯¹åº”å±æ€§ä¸Šï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ª define å‡½æ•°å®é™…ä¸Šä»€ä¹ˆéƒ½æ²¡åšã€‚</p>
<p>
çœ‹å®ä¾‹å§ -&gt;</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineProps, defineEmit } from &#39;vue&#39;
</span><span class="sb">ref: value = 1
</span><span class="sb">const myEmit = defineEmit([&#39;foo&#39;, &#39;bar&#39;])
</span><span class="sb">const props = defineProps({
</span><span class="sb">  fox: String,
</span><span class="sb">  foy: () =&gt; baz &gt; 1
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default {
</span><span class="sb">  props: {
</span><span class="sb">    box: 2
</span><span class="sb">  }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { ref as _ref } from &#39;vue&#39;


function setup(__props, { emit: myEmit }) {

const props = __props
const value = _ref(1)



return { value, myEmit, props }
}


const __default__ = {
  props: {
    box: 2
  }
}

export default /*#__PURE__*/ Object.assign(__default__, {
  expose: [],
  props: {
  fox: String,
  foy: () =&gt; baz &gt; 1
},
  emits: [&#39;foo&#39;, &#39;bar&#39;],
  setup
})
undefined
</pre>
<p>
æˆ‘ä»¬æŠŠä¸Šé¢ç»“æœæ ¼å¼åŒ–ä¸‹ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ref</span> <span class="nx">as</span> <span class="mi">_</span><span class="nx">ref</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;vue&#34;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">setup</span><span class="p">(</span><span class="mi">__</span><span class="nx">props</span><span class="p">,</span> <span class="p">{</span> <span class="nx">emit</span><span class="o">:</span> <span class="nx">myEmit</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">props</span> <span class="o">=</span> <span class="mi">__</span><span class="nx">props</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">myEmit</span><span class="p">,</span> <span class="nx">props</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="mi">__</span><span class="nx">default__</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">box</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="cm">/*#__PURE__*/</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="mi">__</span><span class="nx">default__</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">expose</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">fox</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">foy</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">baz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">emits</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span><span class="p">],</span>
  <span class="nx">setup</span><span class="p">,</span>
<span class="p">});</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä»ä¸Šé¢çš„ä»£ç å¯å‘ç°ï¼š</p>
<ol>
<li>
<p>defineProps æœ€åè¢«åˆå¹¶æˆä¸€ä¸ª props å¯¹è±¡ï¼Œå¹¶ä¸”ä¼šå’Œ <code>&lt;script&gt;</code> ä¸­çš„ export
default ä¸­çš„ props è¿›è¡Œå†æ¬¡åˆå¹¶ï¼Œå¹¶ä¸”è¿™ç§åˆå¹¶å±äºç®€å•çš„æ›¿æ¢æ“ä½œ</p>
<p>
æ‰€ä»¥å¦‚æœ <code>defineProps</code> å’Œ <code>script</code> ä¸­åŒæ—¶å­˜åœ¨ props çš„æƒ…å†µæœ€ç»ˆ <code>&lt;script&gt;</code> ä¸­
çš„ props ä¼šè¢«ä¸¢å¼ƒæ‰ï¼Œæ‰€ä»¥å°½é‡é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿã€‚</p>
</li>
<li>
<p>defineEmit ä¸­çš„å±æ€§ä¼šè¢«åˆå¹¶åˆ° <code>emits</code> ä¸Š</p>
</li>
</ol>
<p><a href="/vue/vue-mind-map-compiler-sfc/">æ›´å¤šæœ‰å…³ &lt;script setup&gt; çš„å†…å®¹è¯·æŸ¥çœ‹ <code>compiler-sfc</code> åŒ…çš„åˆ†æ -&gt;</a></p>
<blockquote>
<p><code>useContext()</code> æ˜¯è·å–å½“å‰å®ä¾‹çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿™ä¸ªéœ€è¦ç»§ç»­å®ç°å¤æ‚çš„ render éƒ¨åˆ†æ‰
å¯èƒ½ä¼šä½¿ç”¨åˆ°ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-67" class="outline-2">
<h2 id="headline-67">
ğŸŒŠ TODO api async comopnent
</h2>
<div id="outline-text-headline-67" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cb4474ae9c0c040bfed54178a63a3e65c16894b9">feat(add): async component Â· gcclll/stb-vue-next@cb4474a Â· GitHub</a></p>
<p>
å®šä¹‰å¼‚æ­¥ç»„ä»¶(<code>defineAsyncComponent(source)</code>)ã€‚</p>
<p>
æ–°å¢åˆå§‹åŒ–ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">isAsyncWrapper</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="nx">VNode</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="o">!!</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ComponentOptions</span><span class="p">).</span><span class="nx">__asyncLoader</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineAsyncComponent</span><span class="o">&lt;</span>
  <span class="nx">T</span> <span class="kr">extends</span> <span class="nx">Component</span> <span class="o">=</span> <span class="p">{</span> <span class="k">new</span> <span class="p">()</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span> <span class="p">}</span>
<span class="o">&gt;</span><span class="p">(</span><span class="nx">source</span>: <span class="kt">AsyncComponentLoader</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">AsyncComponentOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="c1">// 1. TODO retry å°è£…
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// 2. TODO å‡½æ•°å°è£…
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// 3. TODO è¿”å›ç»„ä»¶ï¼Œæ£€æµ‹å¦‚æœæ˜¯å¯¹è±¡ç›´æ¥è¿”å›ï¼Œor å‡½æ•°å½“åš setup() å‡½æ•°å¤„ç†
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">defineComponent</span><span class="p">({}</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>é€šè¿‡æœç´¢ <code>__asyncLoader</code> åªåœ¨ <code>hydration.ts</code> ä¸­æœ‰ä½¿ç”¨åˆ°ï¼Œè€Œè¿™ä¸ªè²Œä¼¼åˆå’Œ SSR æœåŠ¡
ç«¯æ¸²æŸ“ç”±å…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆæš‚æ—¶ä¸ç»§ç»­äº†ï¼Œå…ˆå®Œæˆ renderer.ts çš„ render å‡½æ•°éƒ¨åˆ†ï¼Œç„¶
ååœ¨å®ç°äº† SSR + hydration ä¹‹åå†å›å¤´æ¥ç»§ç»­ã€‚</p>
</blockquote>
<div id="outline-container-headline-68" class="outline-3">
<h3 id="headline-68">
implementation(init)
</h3>
<div id="outline-text-headline-68" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/bd6e903b261cf277dac3f1b8ab4506f7354c0cb4">feat(add): async component-&gt;load Â· gcclll/stb-vue-next@bd6e903 Â· GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1c73e72de509b7e8070b6c3064cfdbf6aadb616f">feat: async component pause await render Â· gcclll/stb-vue-next@1c73e72 Â· GitHub</a>
å®ç°ä¸»è¦åˆ†å‡ æ­¥ï¼š</p>
<ol>
<li>
<p>å°è£… <code>retry()</code> é‡è¯•å‡½æ•°</p>
</li>
<li>
<p><code>load()</code> å‡½æ•°ï¼Œåˆ†æ”¯ <code>source.loader()</code> å¼‚æ­¥å‡½æ•°</p>
</li>
<li>
<p>ç»„è£…ç»„ä»¶è¿”å› <code>defineComponent({__asyncLoader: load, setup() {...}, ...})</code></p>
<p>
å‰é¢ <strong>1</strong>, <strong>2</strong> éƒ½æ˜¯å¯¹ <code>source.loader</code> è¿›è¡Œå°è£…å¤„ç†ï¼Œè¿™ä¸€æ­¥æ˜¯çœŸæ­£çš„åˆ›å»ºå¼‚æ­¥ç»„ä»¶ã€‚</p>
<p>
<a href="#define-component">defineComponent(option)</a> å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯æ£€æµ‹ option å¦‚æœæ˜¯å‡½æ•°å½“åš</p>
<p>
<code>{setup: option, name: option.name}</code> å¤„ç†ï¼Œå¦åˆ™ç›´æ¥è¿”å› option</p>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">defineAsyncComponent</span> <span class="p">},</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span> <span class="nx">createApp</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">si</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">n</span><span class="p">));</span>
  <span class="kd">let</span> <span class="nx">resolve</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">defineAsyncComponent</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">resolve</span> <span class="o">=</span> <span class="nx">r</span><span class="p">)));</span>

  <span class="kr">const</span> <span class="nx">toggle</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
  <span class="nx">createApp</span><span class="p">({</span>
    <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s2">&#34;xxx&#34;</span><span class="p">),</span> <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Foo</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
    <span class="p">),</span>
  <span class="p">}).</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

  <span class="c1">// æ‰‹åŠ¨ resolve, è§¦å‘ loader().then(comp =&gt; { ... })
</span><span class="c1"></span>  <span class="nx">resolve</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="s2">&#34;resolved&#34;</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">timeout</span><span class="p">();</span>
  <span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>

  <span class="c1">// åˆ°è¿™é‡Œ component å·²ç» resolved äº†
</span><span class="c1"></span>  <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span> <span class="c1">// -&gt; null
</span><span class="c1"></span>
  <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span> <span class="c1">// -&gt; resolved
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
true xxx

 resolved comp before
loaded.value =  false
&lt;!----&gt;
undefined
async comp load ok,  resolved
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-69" class="outline-2">
<h2 id="headline-69">
ğŸ”¥ render function
</h2>
<div id="outline-text-headline-69" class="outline-text-2">
<p>
ç¯‡å¹…å¤ªé•¿ï¼Œå¦èµ·å•ç‹¬æ–‡ç«  -&gt; <a href="/vue/vue-mind-map-runtime-core-render">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render</a></p>
</div>
</div>
<div id="outline-container-scheduler" class="outline-2">
<h2 id="scheduler">
ğŸš’ scheduler ä»»åŠ¡è°ƒåº¦æœºåˆ¶
</h2>
<div id="outline-text-scheduler" class="outline-text-2">
<p>
è®©æˆ‘ä»¬è·Ÿç€ <code>scheduler.spec.ts</code> æµ‹è¯•ç”¨ä¾‹æ¥é€æ­¥å±æ€§ scheduler çš„è°ƒåº¦æœºåˆ¶ã€‚</p>
<p>
åœ¨åšè¿™ä¸ªä¹‹å‰å…ˆæŠŠ scheduler.ts ä¸­é€»è¾‘ä»£ç å…¨æ¸…ç©ºï¼Œè¿™ä¸ªæ–‡ä»¶è¿˜æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a54cc00ee93057839de620a152ca1fe691671f63">feat: rc-&gt;reset scheduler.ts Â· gcclll/stb-vue-next@a54cc00 Â· GitHub</a></p>
<p>
æˆ‘ä»¬ä»é›¶å¼€å§‹ä¸€æ­¥æ­¥æ¥åˆ†æå®ç°ã€‚</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" alt="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" title="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" /></p>
<p>
è¿™éƒ¨åˆ†åŒ…å«ä¸‰ç§ä»»åŠ¡çš„ flush é€»è¾‘ä»£ç ï¼š</p>
<ol>
<li>
<p>queue jobs -&gt; <code>flushIndex</code> -&gt; <code>queue[]</code> -&gt; <code>queueJob()</code> -&gt; <code>queueFlush()</code> -&gt; <code>flushJobs()</code></p>
</li>
<li>
<p>pre jobs -&gt; <code>preFlushIndex</code> -&gt; <code>pendingPreFlushCbs[]</code> -&gt; <code>activePreFlushCbs[]</code> -&gt;
<code>queuePreFlushCb()</code> -&gt; <code>flushPreFlushCbs()</code> -&gt; <code>flushJobs()</code></p>
</li>
<li>
<p>TODO post jobs -&gt; â€¦</p>
</li>
</ol>
<div id="outline-container-nexttick" class="outline-3">
<h3 id="nexttick">
nextTick
</h3>
<div id="outline-text-nexttick" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/32b482762b074d3123906887df35231efea7dcc7">feat(add): rc-&gt;scheduler -&gt; nextTick Â· gcclll/stb-vue-next@32b4827 Â· GitHub</a></p>
<p>
åœ¨ queue æ‰€æœ‰é˜Ÿåˆ—æ¸…ç©ºä¹‹åæ‰§è¡Œçš„ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰é‡è¦å…³è”çš„ä¸¤ä¸ªå˜é‡ï¼š</p>
<ol>
<li>
<p>resolvedPromiseï¼Œä¸€ä¸ªç©ºçš„ promise then</p>
</li>
<li>
<p>currentFlushPromiseï¼Œå½“ queue é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åè¿”å›çš„ä¸€ä¸ª promise</p>
<p>
æ˜¯çš„ï¼Œæ˜¯æ‰€æœ‰ queue jobs å®Œæˆä¹‹åï¼Œå› ä¸º flushJobs å‡½æ•°é‡Œé¢éƒ½æ˜¯åŒæ­¥æ“ä½œï¼Œé‡è¦ä»£
ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">for</span> <span class="p">(</span><span class="nx">flushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">flushIndex</span> <span class="o">&lt;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">flushIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">flushIndex</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">job</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO DEV -&gt; æ£€æŸ¥é€’å½’æ›´æ–°é—®é¢˜
</span><span class="c1"></span>    <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">job</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">SCHEDULER</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ nextTick ä»»åŠ¡æ€»æ˜¯åœ¨ queue jobs æ‰€æœ‰ä»»åŠ¡å®Œæˆä¹‹åæ‰§è¡Œã€‚</p>
</blockquote>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">resolvedPromise</span>: <span class="kt">Promise</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
<span class="c1">// å½“å‰æ­£åœ¨è¢«æ‰§è¡Œçš„ promise ä»»åŠ¡
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">currentFlushPromise</span>: <span class="kt">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">nextTick</span><span class="p">(</span>
  <span class="k">this</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span> <span class="o">|</span> <span class="k">void</span><span class="p">,</span>
  <span class="nx">fn</span><span class="o">?:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">currentFlushPromise</span> <span class="o">||</span> <span class="nx">resolvedPromise</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">fn</span> <span class="o">?</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span> <span class="o">?</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å‡½æ•°ä½œç”¨ï¼šåœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„ job promise ä¹‹åæ‰§è¡Œ nextTick çš„ä»»åŠ¡ï¼Œç­‰äºè¯´ nextTick
å±äºä¸ªæ’é˜Ÿä»»åŠ¡ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">pr</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">dummyThen</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="nx">nextTick</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">job2</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nbefore await, &#34;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">]);</span>
  <span class="kr">await</span> <span class="nx">dummyThen</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nafter await, &#34;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">]);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">calls</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

before await,  1

after await,  2

job2-job1
</pre>
<blockquote>
<p>Tip. nextTick() å¼‚æ­¥ä»£ç æ‰§è¡Œï¼Œç»è¿‡ babel è½¬æ¢åçš„ä»£ç ï¼Œè¯·æŸ¥çœ‹ <a href="#q-nexttick">nextTick question</a></p>
</blockquote>
</div>
</div>
<div id="outline-container-job-queue-job" class="outline-3">
<h3 id="job-queue-job">
queueJob
</h3>
<div id="outline-text-job-queue-job" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/eb33b40b7e8e87165fa2149b1a1354d078f33c40">feat(add): rc-&gt;scheduler-&gt;queueJob Â· gcclll/stb-vue-next@eb33b40 Â· GitHub</a></p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" alt="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" title="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" /></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span>: <span class="kt">SchedulerJob</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// the dedupe search uses the startIndex argument of Array.includes()
</span><span class="c1"></span>  <span class="c1">// by default the search index includes the current job that is being run
</span><span class="c1"></span>  <span class="c1">// so it cannot recursively trigger itself again.
</span><span class="c1"></span>  <span class="c1">// if the job is a watch() callback, the search will start with a +1 index to
</span><span class="c1"></span>  <span class="c1">// allow it recursively trigger itself - it is the user&#39;s responsibility to
</span><span class="c1"></span>  <span class="c1">// ensure it doesn&#39;t end up in an infinite loop.
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span>
    <span class="p">(</span><span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span>
      <span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span>
        <span class="nx">job</span><span class="p">,</span>
        <span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">?</span> <span class="nx">flushIndex</span> <span class="o">+</span> <span class="nx">1</span> : <span class="kt">flushIndex</span>
      <span class="p">))</span> <span class="o">&amp;&amp;</span>
    <span class="nx">job</span> <span class="o">!==</span> <span class="nx">currentPreFlushParentJob</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">job</span><span class="p">)</span>
    <span class="nx">queueFlush</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">queueFlush() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFlushPending</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">isFlushPending</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">currentFlushPromise</span> <span class="o">=</span> <span class="nx">resolvedPromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">flushJobs</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// è¯·æŸ¥çœ‹ä¸‹ä¸€èŠ‚çš„å®ç°
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">flushJobs</span><span class="p">(</span><span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
éœ€è¦ flushJobs æ”¯æŒï¼Œè¯·åˆ° flushJobs(ğŸ‘‡) ä¸€èŠ‚æŸ¥çœ‹æµ‹è¯•æƒ…å†µã€‚</p>
</div>
</div>
<div id="outline-container-headline-73" class="outline-3">
<h3 id="headline-73">
flushJobs
</h3>
<div id="outline-text-headline-73" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e23be119f8b67f8c828f01f031f2488afa55c0c9">feat(add): rc-&gt;scheduler-&gt;flushJobs function Â· gcclll/stb-vue-next@e23be11 Â· GitHub</a></p>
<ol>
<li>
<p>isFlushPending, isFlushing æ ‡è¯†é‡ç½®</p>
</li>
<li>
<p><a href="#job-flush-pre">flushPreFlushCbs</a>, å¯¹ pre ç±»å‹çš„ jobs è¿›è¡Œ flush æ“ä½œï¼Œæœ‰å…³å‡½æ•°
<code>flushPreFlushCbs(flushå‡½æ•°)</code> å’Œ <code>queuePreFlushCb(å…¥åˆ—å‡½æ•°)</code></p>
</li>
<li>
<p>flush ä¹‹å‰è¿›è¡Œæ’åº</p>
</li>
<li>
<p>try -&gt; callWithErrorHandling æ‰§è¡Œä»»åŠ¡å›è°ƒ</p>
</li>
<li>
<p>finally -&gt; é‡ç½®ï¼Œæ¸…ç©º queue é˜Ÿåˆ—å†…å®¹å’Œæ ‡è¯†</p>
</li>
<li>
<p>TODO flushPostFlushCbs, å¯¹ post ç±»å‹çš„ jobs è¿›è¡Œ flush æ“ä½œï¼Œæœ‰å…³å‡½æ•°
<code>flushPostFlushCbs</code> å’Œ <code>queuePostFlushCb</code></p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">flushJobs</span><span class="p">(</span><span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">isFlushPending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">isFlushing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">seen</span> <span class="o">=</span> <span class="nx">seen</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// flushPreFLushCbs(seen)ï¼Œé»˜è®¤çš„ job ç±»å‹
</span><span class="c1"></span>
  <span class="c1">// flush ä¹‹å‰å¯¹ queue æ’åº
</span><span class="c1"></span>  <span class="c1">// 1. ç»„ä»¶æ›´æ–°é¡ºåºï¼šparent -&gt; childï¼Œå› ä¸º parent æ€»æ˜¯åœ¨ child ä¹‹å‰
</span><span class="c1"></span>  <span class="c1">//    è¢«åˆ›å»ºï¼Œå› æ­¤ parent render effect æœ‰æ›´ä½çš„ä¼˜å…ˆçº§æ•°å­—(æ•°å­—è¶Šå°è¶Šå…ˆåˆ›å»ºï¼Ÿ)
</span><span class="c1"></span>  <span class="c1">// 2. å¦‚æœç»„ä»¶åœ¨ parent æ›´æ–°æœŸé—´è¢«å¸è½½äº†ï¼Œé‚£ä¹ˆå®ƒçš„æ›´æ–°éƒ½ä¼šè¢«å¿½ç•¥æ‰
</span><span class="c1"></span>
  <span class="nx">queue</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">b</span><span class="p">));</span>

  <span class="c1">// å¼€å§‹ flush
</span><span class="c1"></span>  <span class="k">try</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">flushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">flushIndex</span> <span class="o">&lt;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">flushIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">flushIndex</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">job</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO DEV -&gt; æ£€æŸ¥é€’å½’æ›´æ–°é—®é¢˜
</span><span class="c1"></span>        <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">job</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">SCHEDULER</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="c1">// æƒ…å†µé˜Ÿåˆ—
</span><span class="c1"></span>    <span class="nx">flushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// TODO flush `post` ç±»å‹çš„ flush cbs
</span><span class="c1"></span>
    <span class="nx">isFlushing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">currentFlushPromise</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="c1">// TDOO ä»£ç æ‰§è¡Œåˆ°å½“å‰ tick çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½æœ‰æ–°çš„ job åŠ å…¥
</span><span class="c1"></span>    <span class="c1">// some postFlushCb queued jobs!
</span><span class="c1"></span>    <span class="c1">// keep flushing until it drains.
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #1
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;job1 running&#34;</span><span class="p">);</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #2
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;job2 running&#34;</span><span class="p">);</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="c1">// æ”¯æŒå»é‡
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span> <span class="c1">// #3
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span> <span class="c1">// #4
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before await  &#34;</span> <span class="o">+</span> <span class="nx">calls</span><span class="p">);</span> <span class="c1">// #5
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span> <span class="c1">// #6
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after await  &#34;</span> <span class="o">+</span> <span class="nx">calls</span><span class="p">);</span> <span class="c1">// #7
</span><span class="c1"></span><span class="p">};</span>

<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
before await
undefined

job1 running


job2 running
after await  job1,job2
</pre>
<p>
å¦‚æœåœ¨æ²¡æœ‰ <strong>#6</strong> çš„æƒ…å†µä¸‹ï¼Œåœ¨æ‰€æœ‰ Log ä¹‹åä¼šç«‹å³æ‰§è¡Œ queue jobsã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">queueFlush() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFlushPending</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">isFlushPending</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">currentFlushPromise</span> <span class="o">=</span> <span class="nx">resolvedPromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">flushJobs</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œ nextTick() è°ƒç”¨å¹¶æ²¡æœ‰ä¼ é€’ fn ï¼Œå› æ­¤ <code>await nextTick()</code> åœ¨è¿™é‡Œçš„ä½œç”¨å°±æ˜¯ç­‰
<code>resolvedPromise</code> æ‰§è¡Œå®Œæˆ(æ­¤æ—¶å¹¶æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ promise)</p>
<p>
<code>const resolvedPromise: Promise&lt;any&gt; = Promise.resolve()</code></p>
<p>
å†æ‰§è¡Œåé¢çš„ä»£ç ã€‚</p>
<p>
queueJob å‡½æ•°åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ol>
<li>
<p>push æ”¶é›†ä»»åŠ¡ <code>queue.push(job)</code> ï¼ŒåŒæ­¥æ‰§è¡Œ</p>
</li>
<li>
<p>éšåç«‹å³è°ƒç”¨ <code>queueFlush()</code> åˆ·æ‰ä»»åŠ¡ï¼Œä»»åŠ¡å¼‚æ­¥ flush</p>
</li>
</ol>
<p>åœ¨è¿™ä¸ªå®ä¾‹ä¸­ï¼ŒæŒ‰ç…§åŒæ­¥æ‰§è¡Œé¡ºåºï¼Œ</p>
<ol>
<li>
<p><code>queueJob(job1)</code> æ‰§è¡Œï¼Œå°† job1 -&gt; push -&gt; queue ä¸­ï¼Œ queueFlush ä¸­çš„ promise ç­‰å¾…</p>
</li>
<li>
<p><code>queueJob(job2)</code> æ‰§è¡Œï¼Œå°† job2 -&gt; push -&gt; queue ä¸­ï¼Œ
queueFlush ä¸­çš„ promise ç»§ç»­ç­‰å¾…</p>
</li>
<li>
<p><code>log before</code> æ‰§è¡Œï¼Œç”±äº job è™½ç„¶å·²ç»åœ¨ queue ä¸­äº†ï¼Œä½†æ˜¯éœ€è¦ç­‰å¾… queueFlush å»
å¼‚æ­¥æ‰§è¡Œä»–ä»¬ï¼Œæ‰€ä»¥è¿™é‡Œ calls ä¾æ—§æ˜¯ç©ºçš„</p>
</li>
<li>
<p><code>await nextTick()</code> å¼‚æ­¥æ“ä½œ</p>
<p>
è¿™ä¸€å¥ç›®çš„åªæ˜¯ä¸ºäº†è®©åé¢çš„ log åœ¨ job1,job2 åé¢æ‰§è¡Œã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">currentFlushPromise</span> <span class="o">||</span> <span class="nx">resolvedPromise</span><span class="p">;</span>
 <span class="k">return</span> <span class="nx">fn</span> <span class="o">?</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span> <span class="o">?</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
nextTick ä¼šåœ¨åˆšåˆšæ‰§è¡Œå®Œæ¯•çš„ promise åé¢å–æ‰§è¡Œåé¢çš„ä»»åŠ¡ï¼Œæ‰€ä»¥ log after è‚¯å®šæ˜¯åäº job1,job2 çš„æ‰§è¡Œçš„ã€‚</p>
</li>
<li>
<p>æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¼€å§‹è¿›å…¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œï¼Œç”±äº job1,job2 å…ˆå…¥é˜Ÿåˆ—ï¼Œåœ¨äº‹ä»¶å¾ª
ç¯ä¸­ä¼šå…ˆäº log after æ‰§è¡Œï¼Œç„¶ååœ¨æ‰§è¡Œ log afterï¼Œæ‰€ä»¥å°±æœ‰äº†ä¸Šé¢çš„è¾“å‡ºç»“æœã€‚</p>
</li>
</ol>
<p>
å®ä¾‹æ‰§è¡Œè„‘å›¾ï¼š</p>
<p>
<img src="/img/tmp/20210112173934.png" alt="/img/tmp/20210112173934.png" title="/img/tmp/20210112173934.png" /></p>
</div>
</div>
<div id="outline-container-headline-74" class="outline-3">
<h3 id="headline-74">
queueJob while flushing
</h3>
<div id="outline-text-headline-74" class="outline-text-3">
<p>
å½“ queue ä¸­ jobs æ­£åœ¨è¢«æ‰§è¡Œçš„æ—¶å€™è°ƒç”¨ queueJob è¿›å…¥æ–°çš„ä»»åŠ¡ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
    <span class="c1">// job2 ä»»åŠ¡ä¼šåœ¨ job1 æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™åŠ å…¥åˆ°äº† queue
</span><span class="c1"></span>    <span class="c1">// ä½†æ˜¯å®ƒçš„æ‰§è¡Œéœ€ç­‰åˆ° queue ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œ
</span><span class="c1"></span>    <span class="c1">// å› ä¸ºä»»åŠ¡æ”¶é›†æ˜¯åŒæ­¥çš„ï¼Œä»»åŠ¡æ‰§è¡Œæ˜¯å¼‚æ­¥çš„ï¼Œè€Œ queue flush æ“ä½œåˆæ˜¯åŒæ­¥çš„
</span><span class="c1"></span>    <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nafter await\n&#34;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">]);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
after await
 [ &#39;job1&#39;, &#39;job2&#39; ]
</pre>
<p>
çœ‹ä¸‹é¢çš„æµ‹è¯•ä»£ç ï¼ˆåœ¨ for å¾ªç¯è¿‡ç¨‹ä¸­æ”¹å˜æ•°ç»„é•¿åº¦ï¼Œä¼šæ£€æµ‹åˆ°è¿™ç§æ”¹å˜ï¼‰ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span>
<span class="kr">const</span> <span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">add</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="o">:</span> <span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">l</span><span class="o">:</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{ i: 0, v: 1, l: 3 }
{ i: 1, v: 2, l: 4 }
{ i: 2, v: 3, l: 4 }
{ i: 3, v: 2, l: 4 }
undefined
</pre>
<p>
æ‰€ä»¥ä¸Šé¢çš„ Job å®ä¾‹ï¼Œå°±å¾ˆå¥½ç†è§£äº†</p>
<p>
åœ¨ for queue jobs è¿‡ç¨‹ä¸­å‘ç°æœ‰æ–°çš„ job è¿›å…¥ï¼Œä¹‹å‰è¯´è¿‡äº†  queue çš„å…¥åˆ—æ“ä½œæ˜¯åŒæ­¥
çš„ï¼Œæ‰€ä»¥ä¼šç«‹å³æ‰§è¡Œæ”¹å˜ queue é•¿åº¦ï¼Œæœ€ååŠ å…¥çš„ä»»åŠ¡ä¼šåœ¨ for å¾ªç¯è¿‡ç¨‹ä¸­æœ€åå¾—åˆ°æ‰§è¡Œã€‚</p>
</div>
</div>
<div id="outline-container-headline-75" class="outline-3">
<h3 id="headline-75">
queuePreFlushCb
</h3>
<div id="outline-text-headline-75" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2c72cdc8734a3317041e4b14f288732379b4f1d2">feat(add): rc-&gt;scheduler-&gt;queuePreFlushCb -&gt; pre jobs, pendingPreFlusâ€¦ Â· gcclll/stb-vue-next@2c72cdc Â· GitHub</a></p>
<p>
æ–°å¢ä»£ç ï¼š</p>
<ol>
<li>
<p><code>queuePreFlushCb</code>, å…¥åˆ— pre jobs å‡½æ•°</p>
</li>
<li>
<p><code>flushPreFlushCbs</code>, flush pre jobs å‡½æ•°</p>
</li>
<li>
<p><code>flushJobs</code> ä¸­è°ƒç”¨ <code>flushPreFlushCbs()</code> åˆ·æ‰ pre jobs</p>
</li>
</ol>
<p>è¿™ä¸ªæ˜¯ç”¨æ¥æ”¶é›†å’Œ flush pre ç±»å‹(é»˜è®¤ç±»å‹çš„ä»»åŠ¡)çš„é˜Ÿåˆ— <code>pendingPreFlushCbs[]</code>  çš„å‡½æ•°ã€‚</p>
<p>
é€»è¾‘è„‘å›¾ï¼š
<img src="/img/tmp/20210113103504.png" alt="/img/tmp/20210113103504.png" title="/img/tmp/20210113103504.png" /></p>
<p>
ç›¸å…³ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb</span>: <span class="kt">SchedulerCb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">queueCb</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">activePreFlushCbs</span><span class="p">,</span> <span class="nx">pendingPreFlushCbs</span><span class="p">,</span> <span class="nx">preFlushIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">queueCb</span><span class="p">(</span>
  <span class="nx">cb</span>: <span class="kt">SchedulerCbs</span><span class="p">,</span>
  <span class="nx">activeQueue</span>: <span class="kt">SchedulerCb</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">pendingQueue</span>: <span class="kt">SchedulerCb</span><span class="p">[],</span>
  <span class="nx">index</span>: <span class="kt">number</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">cb</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">activeQueue</span> <span class="o">||</span>
      <span class="o">!</span><span class="nx">activeQueue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span>
        <span class="nx">cb</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">cb</span> <span class="kr">as</span> <span class="nx">SchedulerJob</span><span class="p">).</span><span class="nx">allowRecurse</span> <span class="o">?</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">1</span> : <span class="kt">index</span>
      <span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nx">pendingQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">pendingQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">cb</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">queueFlush</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¯¹æ¯” queueCb å’Œ queueJob ä¼šå‘ç°ä¸¤è€…æ²¡å¤šå¤§çš„å·®åˆ«ï¼Œå…ˆåŒæ­¥æ”¶é›†å†å¼‚æ­¥ flushï¼Œä¸¤è€…åˆ¤
æ–­æ¡ä»¶æœ‰ç»†å¾®å·®åˆ«ï¼Œå¦å¤– queueJob æ”¯æŒæ•°ç»„å½¢å¼çš„ cbï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// queueJob
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span>
  <span class="p">(</span><span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span>
    <span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span>
      <span class="nx">job</span><span class="p">,</span>
      <span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">?</span> <span class="nx">flushIndex</span> <span class="o">+</span> <span class="nx">1</span> : <span class="kt">flushIndex</span>
    <span class="p">))</span> <span class="o">&amp;&amp;</span>
  <span class="nx">job</span> <span class="o">!==</span> <span class="nx">currentPreFlushParentJob</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="nx">queueFlush</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æœ€åä¹Ÿéƒ½æ˜¯è°ƒç”¨ queueFlush() -&gt; flushJobs() æ¥æ¸…ç©ºé˜Ÿåˆ— pendingQueue/queue ã€‚</p>
<p>
æ‰€ä»¥ä¸‹é¢è¿˜éœ€è¦åœ¨ flushJobs() é‡Œé¢å»å®ç°å¯¹ pre -&gt; pendingQueue ç±»å‹é˜Ÿåˆ— flush æ“
ä½œ(<code>flushPreFlushCbs()</code>)ã€‚</p>
</div>
</div>
<div id="outline-container-job-flush-pre" class="outline-3">
<h3 id="job-flush-pre">
flushPreFlushCbs
</h3>
<div id="outline-text-job-flush-pre" class="outline-text-3">
<p>
æœ‰å…³å‡½æ•°å’Œå˜é‡</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>preFlushIndex</code></td>
<td>number</td>
<td>used in `for` to flush pre jobs</td>
</tr>
<tr>
<td><code>pendingPreFlushCbs</code></td>
<td>array</td>
<td>the queue to store pre jobs</td>
</tr>
<tr>
<td><code>activePreFlushCbs</code></td>
<td>array</td>
<td>the non-repeat copy of <code>pendingPreFlushCbs</code>, used to flushing</td>
</tr>
<tr>
<td><code>queuePreFlushCb</code></td>
<td>function</td>
<td>ä¸ flushPreFlushCbs å¯¹åº”çš„ pre job å…¥åˆ—å‡½æ•°</td>
</tr>
<tr>
<td><code>queueFlush</code></td>
<td>function</td>
<td>æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡çš„å‡½æ•°ï¼Œä¸‰ä¸ªç±»å‹çš„ä»»åŠ¡éƒ½åœ¨è¿™é‡Œé¢æ‰§è¡Œ(pre,post,queue)</td>
</tr>
<tr>
<td><code>flushJobs</code></td>
<td>function</td>
<td>å…·ä½“æ‰§è¡Œä»»åŠ¡çš„å‡½æ•°ï¼Œä¸‰ç§ä»»åŠ¡æ‰§è¡Œé¡ºåºæ˜¯ï¼š pre -&gt; queue -&gt; post</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Tip</strong>. <code>activePreFlushCbs</code> å’Œ <code>pendingPreFlushCbs</code> çš„å…³ç³»ï¼š å‰è€…æ˜¯åè€…çš„ä¸€ä¸ªæ‹·è´ï¼Œ
æ‹·è´å®Œä¼šç«‹å³æ¸…ç©º pending, ç›®çš„æ˜¯ä¸ºäº†è®© pending åœ¨ active flushing æœŸé—´èƒ½ç»§ç»­æ”¶é›†
æ–°çš„ä»»åŠ¡ï¼Œè¿™æ ·å¦‚æœåœ¨æ‰§è¡ŒæœŸé—´æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—ï¼Œé‚£ä¹ˆåœ¨å‡½æ•°æœ€åçš„é€’å½’æ“ä½œä¼šå¯¹è¿™äº›æ–°å…¥
åˆ—çš„ä»»åŠ¡ç»§ç»­ flush æ‰ï¼Œç›´åˆ°å†ä¹Ÿæ²¡æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—ä¸ºæ­¢ã€‚</p>
<p>
<strong>æ³¨æ„ç‚¹</strong> ï¼šå½“ <code>queuePreFlushCb</code> åœ¨ queueJob ä¸­ä½¿ç”¨æ—¶ä¸ä¼šä¸»åŠ¨è§¦å‘ cbs æ‰§è¡Œï¼Œå¦‚æœ
éœ€è¦ç«‹å³æ‰§è¡Œè¿™äº› cbs éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>flushPreFlushCbs(seen, parentJob)</code> å»åˆ·æ‰ pre
cbs ä»»åŠ¡ï¼Œæˆ–è€…ç­‰åˆ°å½“å‰ job æ‰§è¡Œå®Œäº†ä¸‹ä¸€ä¸ª <code>flushJobs()</code> è°ƒç”¨ä¸­æ‰§è¡Œï¼Œå› ä¸º
<code>queueJob()</code> æ‰§è¡ŒæœŸé—´ <code>isFlushing = true</code> ï¼Œè€Œåœ¨ <code>queueFlush()</code> ä¸­æœ‰æ£€æµ‹è¿™ä¸ªå€¼ï¼Œ
å¦‚æœæ­£åœ¨æ‰§è¡Œ flushing æ˜¯ä¸ä¼šç»§ç»­æ‰§è¡Œçš„ï¼Œæ›´å¤šè¯¦æƒ…æŸ¥çœ‹åé¢çš„æµ‹è¯•å’Œåˆ†æã€‚</p>
</blockquote>
<p>
æºç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">flushPreFlushCbs</span><span class="p">(</span>
  <span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">,</span>
  <span class="nx">parentJob</span>: <span class="kt">SchedulerJob</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">pendingPreFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currentPreFlushParentJob</span> <span class="o">=</span> <span class="nx">parentJob</span><span class="p">;</span>
    <span class="nx">activePreFlushCbs</span> <span class="o">=</span> <span class="p">[...</span><span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">pendingPreFlushCbs</span><span class="p">)];</span>
    <span class="nx">pendingPreFlushCbs</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">seen</span> <span class="o">=</span> <span class="nx">seen</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span>
      <span class="nx">preFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">preFlushIndex</span> <span class="o">&lt;</span> <span class="nx">activePreFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">preFlushIndex</span><span class="o">++</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO æ£€æŸ¥é€’å½’æ›´æ–°é—®é¢˜
</span><span class="c1"></span>      <span class="nx">activePreFlushCbs</span><span class="p">[</span><span class="nx">preFlushIndex</span><span class="p">]();</span>
    <span class="p">}</span>

    <span class="nx">activePreFlushCbs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">preFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">currentPreFlushParentJob</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="c1">// é€’å½’ flush ç›´åˆ°æ‰€æœ‰ pre jobs è¢«æ‰§è¡Œå®Œæˆ
</span><span class="c1"></span>    <span class="nx">flushPreFlushCbs</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">parentJob</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç”¨é€”ï¼š api watch é‡Œé¢å¯¹é»˜è®¤ç±»å‹(<code>pre</code>)çš„ä»»åŠ¡çš„å…¥åˆ—æ“ä½œï¼Œå¦‚ä¸‹ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// default: &#39;pre&#39;
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">doWatch</span><span class="p">(</span>
  <span class="nx">source</span>: <span class="kt">WatchSource</span> <span class="o">|</span> <span class="nx">WatchSource</span><span class="p">[]</span> <span class="o">|</span> <span class="nx">WatchEffect</span> <span class="o">|</span> <span class="kt">object</span><span class="p">,</span>
  <span class="nx">cb</span>: <span class="kt">WatchCallback</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">immediate</span><span class="p">,</span> <span class="nx">deep</span><span class="p">,</span> <span class="nx">flush</span><span class="p">,</span> <span class="nx">onTrack</span><span class="p">,</span> <span class="nx">onTrigger</span> <span class="p">}</span><span class="o">:</span> <span class="nx">WatchOptions</span> <span class="o">=</span> <span class="nx">EMPTY_OBJ</span><span class="p">,</span>
  <span class="nx">instance</span> <span class="o">=</span> <span class="nx">currentInstance</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WatchStopHandle</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">scheduler</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;scheduler&#34;</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;sync&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;post&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// default: &#39;pre&#39;
</span><span class="c1"></span>    <span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span> <span class="o">||</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// with &#39;pre&#39; option, the first call must happen before
</span><span class="c1"></span>        <span class="c1">// the component is mounted so it is called synchronously.
</span><span class="c1"></span>        <span class="nx">job</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePreFlushCb</span><span class="p">,</span> <span class="nx">flushPreFlushCbs</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #1
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span> <span class="c1">// #2
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span> <span class="c1">// #3
</span><span class="c1"></span>    <span class="c1">// æ‰‹åŠ¨è§¦å‘ cb1, cb2
</span><span class="c1"></span>    <span class="nx">flushPreFlushCbs</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">job1</span><span class="p">);</span> <span class="c1">// #4
</span><span class="c1"></span>    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span> <span class="c1">// #5
</span><span class="c1"></span>  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span> <span class="c1">// #6
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span> <span class="c1">// #7
</span><span class="c1"></span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span> <span class="c1">// #8
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span> <span class="c1">// #9
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span> <span class="c1">// #10
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

cb1 cb2 job1
</pre>
<p>
æµ‹è¯•åˆ†æä»£ç è„‘å›¾ï¼š
<img src="/img/vue3/runtime-core/vue-runtime-core-test-preflush-inside-queuejob.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-test-preflush-inside-queuejob.jpg" title="/img/vue3/runtime-core/vue-runtime-core-test-preflush-inside-queuejob.jpg" /></p>
<p>
æ–‡å­—åˆ†æï¼š</p>
<ol>
<li>
<p><strong>#8</strong> å…ˆæ‰§è¡Œï¼Œ queueJob -&gt; push job1 -&gt; queue:[job1] -&gt; queueFlush()</p>
<p>
åœ¨ queueFlush() ä¸­è°ƒç”¨ <code>resolvedPromise.then(flushJobs)</code> å¼‚æ­¥æ‰§è¡Œ flushJobs()
å‡½æ•°åˆ·æ‰æ‰€æœ‰ä»»åŠ¡(pre/job/post)</p>
<p>
å¹¶ä¸”è®°å½•å½“å‰ tick ä¸‹çš„ promise: <code>currentFlushPromise</code></p>
<p>
æ­¤æ—¶çš„ <code>pendingPreFlushCbs[]</code> ä¸­æ˜¯æ²¡æœ‰ä»»ä½•ä»»åŠ¡çš„ï¼Œæ‰€ä»¥ç»§ç»­æ‰§è¡Œ try{â€¦} å¼€å§‹
flush queue[] jobsï¼Œè¿™ä¸ªæ—¶å€™ flushIndex = 0 å¾—åˆ° job1ï¼Œå¼€å§‹æŒ‰é¡ºåºæ‰§è¡Œ job1</p>
</li>
<li>
<p><strong>#1</strong> å¼€å§‹æ‰§è¡Œ</p>
</li>
<li>
<p><strong>#2</strong> å°† cb1 push -&gt; <code>pendingPreFlushCbs=[cb1]</code></p>
</li>
<li>
<p><strong>#3</strong> å°† cb2 push -&gt; <code>pendingPreFlushCbs=[cb1, cb2]</code></p>
</li>
<li>
<p><strong>#4</strong> æ‰‹åŠ¨ flush pre cbs</p>
<p>
åœ¨ <code>flushPreFlushCbs(undefind, job1)</code> ä¸­ä¼šè®°å½• <code>currentPreFlushParentJob =
job1</code> è¿™ä¸ªå˜é‡å°†ä¼šåœ¨ <code>queueJob(job)</code> ä¸­ç”¨æ¥æ£€æµ‹ job æ˜¯ä¸æ˜¯å½“å‰çš„ job1 å¦‚æœæ˜¯
å°±ä¸å…è®¸ pushï¼Œå› ä¸º job1 ä¸‹æœ‰å­ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œå¿…é¡»ç­‰è¿™äº›å­ä»»åŠ¡(cb1, cb2) æ‰§è¡Œå®Œã€‚</p>
</li>
<li>
<p><strong>#6</strong> å¼€å§‹æ‰§è¡Œï¼Œ push &#39;cb1&#39; -&gt; calls: [&#39;cb1&#39;]</p>
</li>
<li>
<p><strong>#7</strong> å¼€å§‹æ‰§è¡Œï¼Œ push &#39;cb2&#39; -&gt; calls: [&#39;cb1&#39;, &#39;cb2&#39;]</p>
</li>
<li>
<p><strong>#5</strong> å¼€å§‹æ‰§è¡Œï¼Œ push &#39;job1&#39; -&gt; alls: [&#39;cb1&#39;, &#39;cb2&#39;, &#39;job1&#39;]</p>
</li>
<li>
<p><strong>#9</strong> å¼€å§‹æ‰§è¡Œï¼Œå› ä¸º nextTick()</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">nextTick</span><span class="p">(</span>
  <span class="k">this</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span> <span class="o">|</span> <span class="k">void</span><span class="p">,</span>
  <span class="nx">fn</span><span class="o">?:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">currentFlushPromise</span> <span class="o">||</span> <span class="nx">resolvedPromise</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">fn</span> <span class="o">?</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span> <span class="o">?</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œçš„ await ä¼šç­‰ job1 queueFlush() è§¦å‘çš„ promise.then(flushJobs) è¿”å›çš„
promise å®Œæˆä¹‹åå†æ‰§è¡Œåé¢çš„ä»£ç ã€‚</p>
</li>
<li>
<p><strong>#10</strong> log è¾“å‡º <code>&#39;cb1,cb2,job1&#39;</code></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-77" class="outline-3">
<h3 id="headline-77">
queuePostFlushCb + flushPostFlushCbs
</h3>
<div id="outline-text-headline-77" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/845c21bfc0ef1797d39a9fd789d79a4fdc3bd399">feat(add): rc-&gt;scheduler-&gt;queuePostFlushCb+flushPostFlushCbs Â· gcclll/stb-vue-next@845c21b Â· GitHub</a></p>
<p>
é€»è¾‘è„‘å›¾ï¼š
<img src="/img/tmp/20210113143628.png" alt="/img/tmp/20210113143628.png" title="/img/tmp/20210113143628.png" /></p>
<p>
æœ‰äº† queue job å’Œ pre cb çš„åŸºç¡€åˆ†æï¼Œè¿™éƒ¨åˆ†ä¹Ÿå°±å¾ˆå¥½ç†è§£äº†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb</span>: <span class="kt">SchedulerCbs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">queueCb</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">activePostFlushCbs</span><span class="p">,</span> <span class="nx">pendingPostFlushCbs</span><span class="p">,</span> <span class="nx">postFlushIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">flushPostFlushCbs</span><span class="p">(</span><span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">pendingPostFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">deduped</span> <span class="o">=</span> <span class="p">[...</span><span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">pendingPostFlushCbs</span><span class="p">)];</span>
    <span class="nx">pendingPostFlushCbs</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// #1947 already has active queue, nested flushPostFlushCbs call
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">activePostFlushCbs</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">activePostFlushCbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">deduped</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">activePostFlushCbs</span> <span class="o">=</span> <span class="nx">deduped</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">seen</span> <span class="o">=</span> <span class="nx">seen</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">activePostFlushCbs</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">b</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span>
      <span class="nx">postFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">postFlushIndex</span> <span class="o">&lt;</span> <span class="nx">activePostFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">postFlushIndex</span><span class="o">++</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO é€’å½’ update æ£€æŸ¥
</span><span class="c1"></span>      <span class="nx">activePostFlushCbs</span><span class="p">[</span><span class="nx">postFlushIndex</span><span class="p">]();</span>
    <span class="p">}</span>

    <span class="nx">activePostFlushCbs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">postFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å’Œ pre cb çš„å¤„ç†æœ‰ä¸¤ä¸ªä¸åŒç‚¹ï¼š</p>
<ol>
<li>
<p>éå›è°ƒå½¢å¼å¤„ç† flushing æœŸé—´æ¥å—åˆ°çš„æ–°ä»»åŠ¡ï¼Œè€Œæ˜¯é€šè¿‡æ”¹å˜æ‰§è¡Œå™¨
activePostFlushCbs æ¥å®ç°(å’Œ queue job ç±»ä¼¼)</p>
</li>
<li>
<p>æ²¡æœ‰é€’å½’å›è°ƒå½¢å¼å¤„ç†åç»­çš„æ–°ä»»åŠ¡ï¼Œå‚è€ƒ <strong>1</strong></p>
</li>
</ol>
<p>æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queuePostFlushCb</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">queueJob</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="c1">// len = activePostFlushCbs.length
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span>
    <span class="c1">// ä¼šåœ¨åŒä¸€ä¸ª tick æœŸé—´æ‰§è¡Œï¼Œå› ä¸ºå®ƒåœ¨for flushing æœŸé—´æ”¹å˜äº†
</span><span class="c1"></span>    <span class="c1">// activePostFlushCbsï¼Œå¹¶ä¸”ç´§éš cb1,cb2,cb3 ä¹‹åæ‰§è¡Œ
</span><span class="c1"></span>    <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb4</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb3&#34;</span><span class="p">);</span>
  <span class="c1">// job1 ä¼šåœ¨ cb4 ä¹‹åæ‰§è¡Œï¼Œå› ä¸º flushJobs åœ¨æŒ‰é¡ºåºæ‰§è¡Œå®Œ
</span><span class="c1"></span>  <span class="c1">// pre -&gt; job -&gt; post æœ€åçš„ finally é‡Œé¢å¯¹ queue è¿›è¡Œäº†æ£€æµ‹
</span><span class="c1"></span>  <span class="c1">// æ­¤æ—¶ queue = [job1] éšæ„ä¼šé€’å½’è°ƒç”¨ flushJobs() ç»§ç»­åˆ·
</span><span class="c1"></span>  <span class="c1">// ä½†æ˜¯ä¸ºä»€ä¹ˆ cb5 ä¼šåœ¨ job1 ä¹‹åå‘¢ï¼Ÿï¼Ÿï¼Ÿ
</span><span class="c1"></span>  <span class="c1">// å› ä¸º queuePostFlushCb push çš„æ˜¯ pendingPostFlushCbs è€Œä¸æ˜¯
</span><span class="c1"></span>  <span class="c1">// activePostFlushCbsï¼Œæ‰€ä»¥åœ¨ queuePostFlushCb ä¸­è°ƒç”¨è‡ªèº«å¢åŠ çš„æ–°
</span><span class="c1"></span>  <span class="c1">// cbs ä¼šåœ¨ finally åé¢çš„æ£€æµ‹é€’å½’ flushJobs() è°ƒç”¨ä¸­æ‰§è¡Œ
</span><span class="c1"></span>  <span class="c1">// è€Œ post çš„ä¼˜å…ˆçº§åˆä½äº job æ‰€ä»¥ job1 ä¼šä¼˜å…ˆè¾“å‡º
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cb4</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb5</span><span class="p">),</span> <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">),</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb4&#34;</span><span class="p">));</span>
  <span class="c1">// ä¼šåœ¨ job1,cb5 ä¹‹åæ‰§è¡Œ
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb6</span><span class="p">),</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">));</span>
  <span class="kr">const</span> <span class="nx">cb5</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb5&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb6</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb6&#34;</span><span class="p">);</span>

  <span class="nx">queuePostFlushCb</span><span class="p">([</span><span class="nx">cb1</span><span class="p">,</span> <span class="nx">cb2</span><span class="p">]);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb3</span><span class="p">);</span>

  <span class="c1">// åº”è¯¥å»é‡
</span><span class="c1"></span>  <span class="nx">queuePostFlushCb</span><span class="p">([</span><span class="nx">cb1</span><span class="p">,</span> <span class="nx">cb3</span><span class="p">]);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

cb1 cb2 cb3 cb4 job1 cb5 cb6
</pre>
<blockquote>
<p>å¯¹äº <code>queuePostFlushCb</code> å’Œ <code>queueJob</code> çš„æ··ç”¨åªè¦è®°ä½ä¸€ç‚¹ï¼Œ <code>queuePostFlushCb</code> ä¸
ä¼šè§¦å‘ <code>activePostFlushCbs</code> æ”¹å˜ï¼Œå› ä¸º isFlushing = trueï¼Œæ‰€ä»¥åªä¼šåœ¨å½“å‰
<code>flushJobs()</code> æ‰§è¡Œåˆ°æœ€åé€’å½’æ£€æµ‹çš„æ—¶å€™æ‰ä¼šè¿›å…¥ä¸‹ä¸€æ¬¡çš„ post+job è°ƒç”¨ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-78" class="outline-3">
<h3 id="headline-78">
test nested(pre/job/post)
</h3>
<div id="outline-text-headline-78" class="outline-text-3">
<p>
å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç»“åˆ pre, post, queue ä¸‰ç§ç±»å‹çš„ä»»åŠ¡è¿›è¡Œæµ‹è¯•ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePreFlushCb</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">flushPreFlushCbs</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span>
    <span class="c1">// queueJob å’Œ queuePreFlushCb ç»“åˆä½¿ç”¨
</span><span class="c1"></span>    <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb3&#34;</span><span class="p">);</span>
    <span class="c1">// é“¾å¼ä½¿ç”¨ï¼Œcb4 ä¼šåœ¨ cb1,2,3 æ‰§è¡Œå®Œæˆä¹‹åæ‰ä¼šæ‰§è¡Œ
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb4</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb4</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb4&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb5</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb5&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
    <span class="c1">// queuePreFlushCb åœ¨ queueJob ä¸­è°ƒç”¨
</span><span class="c1"></span>    <span class="c1">// pre cbs åœ¨ job ä¸­è°ƒç”¨çš„æ—¶å€™ä¸ä¼šè¢«æ‰§è¡Œï¼Œé™¤éåœ¨è¿™åé¢æ‰‹åŠ¨ flush
</span><span class="c1"></span>    <span class="c1">// æˆ–è€…æœ‰æ–°çš„ä»»åŠ¡è¿›æ¥ï¼Œå‘èµ· flushJobs è°ƒç”¨æ‰ä¼šæ‰§è¡Œ
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb5</span><span class="p">);</span>
    <span class="c1">// å¿…é¡»æ‰‹åŠ¨è§¦å‘, è¿™æ · cb5 æ‰ä¼šè¾“å‡º
</span><span class="c1"></span>    <span class="nx">flushPreFlushCbs</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">job1</span> <span class="cm">/* currentPreFlushParentJob */</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb6</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb6&#34;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb3</span><span class="p">);</span>

  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n&#34;</span> <span class="o">+</span> <span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
cb1,cb2,cb3,cb4,job1,cb5
</pre>
<ol>
<li>
<p>pendingPreFlushCbs è™½ç„¶æ˜¯ä¸ªæ•°ç»„ï¼Œä½†æ˜¯ flush æœŸé—´é€šè¿‡ <code>[...new
Set(pendingPreFlushCbs)]</code> è¿›è¡Œäº†å»é‡æ“ä½œã€‚</p>
</li>
<li>
<p>é“¾å¼æ“ä½œï¼Œå› ä¸ºåœ¨æ‰§è¡ŒæœŸé—´ä½¿ç”¨çš„æ˜¯ <code>activePreFlushCbs</code> ä¸”æ­¤æ—¶çš„
<code>pendingPreFlushCbs</code> æ¸…ç©ºäº†ï¼Œç­‰å¾…æ–°ä»»åŠ¡å…¥åˆ—</p>
<p>
åœ¨æ‰§è¡Œ cb3 æœŸé—´ï¼Œè°ƒç”¨ <code>queuePreFlushCb(cb4)</code> æ­¤æ—¶ push cb4 -&gt;
<code>pendingPreFlushCbs</code> ï¼Œä½†å®é™…ä¸ä¼šå½±å“æœ¬æ¬¡çš„ for å¾ªç¯æ‰§è¡Œ</p>
<p>
<a href="#job-queue-job">è¿™ç‚¹å’Œ queueJob æœ‰ç‚¹ä¸åŒï¼Œå®ƒç›´æ¥ä½¿ç”¨çš„æ˜¯ queue -&gt; for æ‰€ä»¥æœ‰æ–°çš„ä»»åŠ¡å…¥åˆ—ä¼šæ”¹
å˜ for çš„æ‰§è¡Œé•¿åº¦(queue.length)</a></p>
<p>
pre å¤„ç†ä¼šç­‰åˆ° activePreFlushCbs for æ‰§è¡Œå¾ªç¯ç»“æŸåï¼Œåœ¨å‡½æ•°çš„æœ€åé€’å½’è°ƒç”¨
<code>flushPreFlushCbs()</code> æ¥åˆ·æ‰æ–°å…¥åˆ—çš„ä»»åŠ¡(å¦‚ï¼š <strong>cb4</strong>)</p>
</li>
<li>
<p>queueJob åœ¨ queuePreFlushCb ä¸­è°ƒç”¨çš„æ—¶å€™ï¼Œ queue job æ€»æ˜¯åœ¨ pre cb ä¹‹åè¢«æ‰§è¡Œï¼Œè¿™ä¹Ÿ
æ˜¯ flushJobs ä¸­å¤„ç†ä»£ç åº”ä½“ç°å‡ºçš„ç»“æœã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">flushJobs() {</span>
  <span class="c1">// 1. flush pre -&gt; flushPreFlushCbs()
</span><span class="c1"></span>  <span class="c1">// 2. for -&gt; queue job -&gt; callWithErrorHandling(job, ...)
</span><span class="c1"></span>  <span class="c1">// 3. flush post -&gt; flushPostFlushCbs()
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å¹¶ä¸”å¦‚ä¸Šé¢å®ä¾‹ç»“æœ cb4 åµŒå¥—åœ¨ cb3 ï¼Œjob1 åµŒå¥—åœ¨äº† cb2 ä¸­ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯ cb4 å…ˆ
å¾—åˆ°æ‰§è¡Œäº†ï¼Œjob1 å†æ‰§è¡Œã€‚</p>
<blockquote>
<p>Tip. å› æ­¤ï¼Œå¯¹äº pre cbs å’Œ queue jobs ä¸¤ä¸ªç±»å‹çš„ä»»åŠ¡ï¼Œä¸ç®¡ä»€ä¹ˆæ—¶æœºå…¥åˆ—çš„ï¼Œéƒ½ä¼š
æ˜¯å…ˆæ‰§è¡Œ pre cbs å†æ‰§è¡Œ queue jobs</p>
</blockquote>
</li>
<li>
<p>queuePreFlushCb åœ¨ queueJob ä¸­è°ƒç”¨çš„æ—¶å€™ï¼Œæ–°çš„ pre job ä¼šåœ¨ queue job åæ‰§è¡Œ</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b0155c5405deba3da37c60d2beb8d08a377f699d">fix: rc-&gt;scheduler-&gt;flushJobs recursive Â· gcclll/stb-vue-next@b0155c5 Â·
GitHub</a></p>
<p>
åŸå› ï¼š <code>flushPreFlushCbs</code> å…ˆäº queue jobs æ‰§è¡Œï¼Œå› æ­¤ queue jobs(<code>job1</code>) æ‰§è¡Œ
çš„æ—¶å€™ <code>queuePreFlushCb()</code> åŠ å…¥çš„ä»»åŠ¡(<code>cb5</code>)æ­¤æ—¶ä¸ä¼šæ‰§è¡Œï¼Œè€Œæ˜¯ç­‰ queue jobs
éƒ½æ‰§è¡Œå®Œä¹‹ååœ¨finally é‡Œé¢ä¼šåšä¸€æ¬¡æ£€æµ‹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">pendingPreFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">flushJobs</span><span class="p">(</span><span class="nx">seen</span><span class="p">)</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™ä¸ªæ—¶å€™ä¼šå»é€’å½’ <code>flushJobs()</code> æ­¤æ—¶æ‰å‘ç°æœ‰æ–°çš„ <code>pendingPreFlushCbs</code> (å¦‚ï¼š
<code>cb5</code>)ï¼Œåˆ™å°†æ‰§è¡Œä»–ä»¬ï¼Œæ‰€ä»¥ç»“æœæ˜¯ <code>job1,cb5</code> ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-79" class="outline-3">
<h3 id="headline-79">
invalidateJob(job)
</h3>
<div id="outline-text-headline-79" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/24808b106cfaad8af29a7343918a21836f1aff5d">feat(add): rc-&gt;scheduler-&gt;invalidateJob Â· gcclll/stb-vue-next@24808b1 Â· GitHub</a></p>
<p>
æ˜¯ä»»åŠ¡å¤±æ•ˆï¼Œå…¶å®å°±æ˜¯å•çº¯çš„å°† Job ä» queue ä¸­åˆ é™¤äº†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">invalidateJob</span><span class="p">(</span><span class="nx">job</span>: <span class="kt">SchedulerJob</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePostFlushCb</span><span class="p">,</span> <span class="nx">invalidateJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
    <span class="nx">invalidateJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span> <span class="c1">// è¿™é‡Œå°† job2 ä» queue[] ä¸­åˆ é™¤äº†
</span><span class="c1"></span>    <span class="nx">job2</span><span class="p">();</span> <span class="c1">// æ³¨é‡Šè¿™ä¸ªç»“æœä¼šæ˜¯ï¼š job1 job3 job4
</span><span class="c1"></span>  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job3&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job4</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job4&#34;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job3</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">job4</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

job1 job2 job3 job4
</pre>
</div>
</div>
<div id="outline-container-headline-80" class="outline-3">
<h3 id="headline-80">
job sort id ä»»åŠ¡å¯ä»¥æ’åº
</h3>
<div id="outline-text-headline-80" class="outline-text-3">
<p>
åªæœ‰ post å’Œ job æ”¯æŒæ’åºã€‚</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePostFlushCb</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">job3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job3&#34;</span><span class="p">);</span>
  <span class="c1">// job1 no id
</span><span class="c1"></span>  <span class="nx">job2</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="nx">job3</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb3&#34;</span><span class="p">);</span>
  <span class="nx">cb1</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="c1">// cb2 no id
</span><span class="c1"></span>  <span class="nx">cb3</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job3</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb3</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

job3 job2 job1 cb3 cb1 cb2
</pre>
</div>
</div>
<div id="outline-container-headline-81" class="outline-3">
<h3 id="headline-81">
allowRecurse è‡ªèº«é€’å½’
</h3>
<div id="outline-text-headline-81" class="outline-text-3">
<p>
ç”¨ job.allowRecurse æ¥æ§åˆ¶ job æ˜¯å¦å¯ä»¥è‡ªå·±è§¦å‘è‡ªå·±æ‰§è¡Œ(PS. pre/job/post éƒ½æ”¯æŒ
è¯¥å±æ€§)ã€‚</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-job-allowRecurse.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-job-allowRecurse.jpg" title="/img/vue3/runtime-core/vue-runtime-core-job-allowRecurse.jpg" /></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;before count: &#34;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>
  <span class="c1">// è®¾ç½® allowRecurse = true å…è®¸è‡ªæˆ‘è°ƒåº¦
</span><span class="c1"></span>  <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="c1">// é‡å¤å…¥åˆ—åŒä¸€ä¸ªä»»åŠ¡ä¼šåœ¨ push é˜¶æ®µå°±æ£€æµ‹å’Œè‡ªèº«é€’å½’è°ƒç”¨ä¸åŒ
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;after count: &#34;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

before count: 1


after count: 3
</pre>
</div>
</div>
<div id="outline-container-headline-82" class="outline-3">
<h3 id="headline-82">
checkRecursiveUpdates
</h3>
<div id="outline-text-headline-82" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7bcc14b6be11693ddb0cc9d4202727f2ebc83995">feat(add): rc-&gt;scheduler-&gt;checkRecursiveUpdates Â· gcclll/stb-vue-next@7bcc14b Â·
GitHub</a></p>
<p>
é™åˆ¶è°ƒç”¨è‡ªèº«çš„æ¬¡æ•°ï¼Œåœ¨ allowRecurse = true æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// æºæ–‡ä»¶ï¼š/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="mi">101</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

Maximum recursive updates exceeded. This means you have a reactive effect that is mutating its own dependencies and thus recursively triggering itself. Possible sources include component template, render function, updated hook or watcher source function.
</pre>
</div>
</div>
<div id="outline-container-headline-83" class="outline-3">
<h3 id="headline-83">
å°ç»“
</h3>
<div id="outline-text-headline-83" class="outline-text-3">
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-scheduler-comparation.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-scheduler-comparation.jpg" title="/img/vue3/runtime-core/vue-runtime-core-scheduler-comparation.jpg" /></p>
<p>
<strong>pre cbs</strong>: æ‰§è¡Œä¼˜å…ˆçº§æœ€é«˜ï¼Œåœ¨åŒä¸€ tick ä¸­ä¼šé€’å½’è°ƒç”¨è‡ªèº«æ¸…ç©º <code>pendingPreFlushCbs</code>
 ä¸­çš„ä»»åŠ¡ï¼Œåœ¨ <code>queueJob</code> ä¸­è°ƒç”¨æ—¶ä¸ä¼šè‡ªåŠ¨è§¦å‘éœ€è¦æ‰‹åŠ¨è§¦å‘æ‰§è¡Œï¼Œå› ä¸ºæ­¤æ—¶
 <code>isFlushing = true</code> ã€‚</p>
<p>
<strong>job</strong>: æ‰§è¡Œä¼˜å…ˆçº§æ¬¡ä¹‹ï¼Œåœ¨åŒä¸€ tick ä¸­åŒä¸€ä¸ª for queue -&gt; flushIndex ä¸‹ä¼šå¤„ç†æ­¤
  æ—¶æ¥å—åˆ°çš„æ–°ä»»åŠ¡ï¼Œåœ¨ pre cbs ä¸­è°ƒç”¨æ—¶ä¼šåœ¨æ‰€æœ‰ pre cbs æ‰§è¡Œä¹‹åæ‰§è¡Œã€‚</p>
<p>
<strong>post cbs</strong>: æ‰§è¡Œä¼˜å…ˆçº§æœ€ä½ï¼Œåœ¨åŒä¸€ tick åŒä¸€æ¬¡ <code>flushPostFlushCbs()</code> è°ƒç”¨ä¸­ä¸ä¼š
 å¤„ç†æ–°çš„ post ä»»åŠ¡ï¼Œè€Œæ˜¯åœ¨ <code>flushJobs()</code> æ‰§è¡Œåˆ°æœ€å finally éƒ¨åˆ†æ£€
 æµ‹ <code>pendingPostFlushCbs</code> ä»»åŠ¡é˜Ÿåˆ—æ¥å¤„ç†å½“å‰ tick ä¸‹æ–°æ¥å—åˆ°çš„ä»»åŠ¡ï¼Œ
 åœ¨ <code>queuePreFlushCb()</code> å’Œ <code>queueJob()</code> ä¸­è°ƒç”¨çš„æ—¶å€™ä¼šåœ¨ä»–ä»¬çš„ä»»åŠ¡ä¹‹åæ‰§è¡Œã€‚</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-84" class="outline-2">
<h2 id="headline-84">
ğŸ› BUGs fix &amp; Questions
</h2>
<div id="outline-text-headline-84" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2a1ab0448919ea75c5794410a03265bd99e05d75">fix: no import EMPTY_ARR Â· gcclll/stb-vue-next@2a1ab04 Â· GitHub</a></p>
<div id="outline-container-q-nexttick" class="outline-3">
<h3 id="q-nexttick">
nextTick() åé¢çš„ä»£ç æœ€åæ‰§è¡Œï¼Ÿ
</h3>
<div id="outline-text-q-nexttick" class="outline-text-3">
<p>
æµ‹è¯•ä»£ç ï¼š <a href="#nexttick">nextTick</a></p>
<p>
å…ˆçœ‹ä¸€æ®µä»£ç ï¼Œä»¥åŠ <a href="https://babeljs.io/repl">babeljs.io</a> è½¬æ¢ä¹‹åçš„ç»“æœï¼š</p>
<p>
babel ä¹‹å‰ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before await&#34;</span><span class="p">));</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;between await and p1&#34;</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">p1</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after await&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">p2</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after p2&#34;</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
babel ä¹‹å(åªè´´å‡ºæ ¸å¿ƒéƒ¨åˆ†)ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">((</span><span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">next</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
      <span class="nx">p1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before await&#34;</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;between await and p1&#34;</span><span class="p">);</span>
      <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">p1</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after await&#34;</span><span class="p">);</span>
      <span class="nx">p2</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
      <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">p2</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">9</span><span class="o">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after p2&#34;</span><span class="p">);</span>

    <span class="k">case</span> <span class="mi">10</span><span class="o">:</span>
    <span class="k">case</span> <span class="s2">&#34;end&#34;</span><span class="o">:</span>
      <span class="k">return</span> <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å³ä¸Šé¢çš„ä»£ç è¢«è½¬æ¢ä¹‹åå˜æˆäº†ä¸€ä¸ª switchï¼Œé‡Œé¢æ˜¯ä¸€ä¸ª while å¾ªç¯ï¼Œå¼‚æ­¥ä»£ç æœ€ç»ˆçš„é¡º
åºæ‰§è¡Œç”± _context.next æ¥è¡”æ¥ã€‚</p>
<p>
<code>case 0</code> -&gt; <code>next = 5</code> -&gt; <code>case 5</code> -&gt; <code>next = 9</code> -&gt; â€¦</p>
<p>
æ‰€ä»¥è¯´ nextTick() åé¢çš„ä»£ç éƒ½ä¼šè¢«æ”¾åˆ°å¼‚æ­¥ä»£ç </p>
</div>
</div>
</div>
</div>
<div id="outline-container-runtime-test" class="outline-2">
<h2 id="runtime-test">
runtime-test æ¨¡å—ç®€ä»‹
</h2>
<div id="outline-text-runtime-test" class="outline-text-2">
<p>
è¿™é‡Œæµ‹è¯•éœ€è¦ç”¨åˆ°è¿™ä¸ªæ¨¡å—ï¼Œæ‰€ä»¥ç®€å•ç”¨è„‘å›¾æè¿°ä¸‹è¿™é‡Œé¢æœ‰å“ªäº›ä¸œè¥¿å’Œå¹²ä»€ä¹ˆçš„ã€‚</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-test.svg" alt="/img/vue3/runtime-core/vue-runtime-test.svg" title="/img/vue3/runtime-core/vue-runtime-test.svg" /></p>
<p>
é‡è¦ä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// nodeOpts.ts
</span><span class="c1"></span>
<span class="c1">// 1. createElement
</span><span class="c1">// 2. createText
</span><span class="c1">// 3. createComment
</span><span class="c1">// ä¸Šé¢ä¸‰ä¸ªå‡½æ•°åˆ†åˆ«åˆ›å»ºäº†ä¸‰ç§ç±»å‹èŠ‚ç‚¹
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">id</span>: <span class="kt">nodeId</span><span class="o">++</span><span class="p">,</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span> <span class="c1">// TEXT | COMMENT
</span><span class="c1"></span>  <span class="nx">text</span>: <span class="kt">value</span><span class="p">,</span> <span class="c1">// èŠ‚ç‚¹å…·ä½“å†…å®¹
</span><span class="c1"></span>  <span class="nx">parentNode</span>: <span class="kt">null</span><span class="p">,</span>
  <span class="c1">// ä¸‹é¢æ˜¯ ELEMENT ç±»å‹æ‹¥æœ‰çš„å±æ€§
</span><span class="c1"></span>  <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">tag</span><span class="p">,</span>
  <span class="nx">eventListeners</span>: <span class="kt">null</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// 4. setText(node, text), ç›´æ¥ä¿®æ”¹ node.text
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">setText</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">TestText</span><span class="p">,</span> <span class="nx">text</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">logNodeOp</span><span class="p">({</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeOpTypes</span><span class="p">.</span><span class="nx">SET_TEXT</span><span class="p">,</span>
    <span class="nx">targetNode</span>: <span class="kt">node</span><span class="p">,</span>
    <span class="nx">text</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 5. æ’å…¥ insert(child, parent, ref?)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">insert</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">TestNode</span><span class="p">,</span> <span class="nx">parent</span>: <span class="kt">TestElement</span><span class="p">,</span> <span class="nx">ref?</span>: <span class="kt">TestNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">refIndex</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">refIndex</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ref</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">refIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;ref: &#34;</span><span class="p">,</span> <span class="nx">ref</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;parent: &#34;</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;ref is not a child of parent&#34;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...log
</span><span class="c1"></span>  <span class="c1">// remove the node first, but don&#39;t log it as a REMOVE op
</span><span class="c1"></span>  <span class="nx">remove</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="c1">// re-calculate the ref index because the child&#39;s removal may have affected it
</span><span class="c1"></span>  <span class="nx">refIndex</span> <span class="o">=</span> <span class="nx">ref</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">refIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">refIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">child</span><span class="p">);</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 6. remove(child)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">remove</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">TestNode</span><span class="p">,</span> <span class="nx">logOp</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;target: &#34;</span><span class="p">,</span> <span class="nx">child</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;parent: &#34;</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;target is not a childNode of parent&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 7. setElementText(), ç›´æ¥æ¸…ç©ºæ›¿æ¢ childrenï¼Œä¸å¦‚ patchChildren ä¸­
</span><span class="c1">// å¯¹ new/old ç±»å‹ä¸åŒçš„æ—¶å€™éœ€è¦ full diff æ—¶æ›´æ–°èŠ‚ç‚¹
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">setElementText</span><span class="p">(</span><span class="nx">el</span>: <span class="kt">TestElement</span><span class="p">,</span> <span class="nx">text</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">id</span>: <span class="kt">nodeId</span><span class="o">++</span><span class="p">,</span>
        <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
        <span class="nx">text</span><span class="p">,</span>
        <span class="nx">parentNode</span>: <span class="kt">el</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-87" class="outline-2">
<h2 id="headline-87">
é‡è¦ç±»å‹å£°æ˜
</h2>
<div id="outline-text-headline-87" class="outline-text-2">
<ol>
<li>
<p>å¼‚æ­¥ç»„ä»¶é€‰é¡¹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">AsyncComponentOptions</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="p">{</span>
<span class="nx">loader</span>: <span class="kt">AsyncComponentLoader</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="nx">loadingComponent?</span>: <span class="kt">Component</span>
<span class="nx">errorComponent?</span>: <span class="kt">Component</span>
<span class="nx">delay?</span>: <span class="kt">number</span>
<span class="nx">timeout?</span>: <span class="kt">number</span>
<span class="nx">suspensible?</span>: <span class="kt">boolean</span>
<span class="nx">onError</span><span class="o">?:</span> <span class="p">(</span>
    <span class="nx">error</span>: <span class="kt">Error</span><span class="p">,</span>
    <span class="nx">retry</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
    <span class="nx">fail</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
    <span class="nx">attempts</span>: <span class="kt">number</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>Vue App ç±»å‹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">App</span><span class="p">&lt;</span><span class="nt">HostElement</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="p">{</span>
   <span class="nx">version</span>: <span class="kt">string</span><span class="p">;</span>
   <span class="nx">config</span>: <span class="kt">AppConfig</span><span class="p">;</span>
   <span class="nx">use</span><span class="p">(</span><span class="nx">plugin</span>: <span class="kt">Plugin</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">[])</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">mixin</span><span class="p">(</span><span class="nx">mixin</span>: <span class="kt">ComponentOptions</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">component</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Component</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
   <span class="nx">component</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">component</span>: <span class="kt">Component</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">directive</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Directive</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
   <span class="nx">directive</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">directive</span>: <span class="kt">Directive</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">mount</span><span class="p">(</span>
     <span class="nx">rootContainer</span>: <span class="kt">HostElement</span> <span class="o">|</span> <span class="kt">string</span><span class="p">,</span>
     <span class="nx">isHydrate?</span>: <span class="kt">boolean</span>
   <span class="p">)</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span><span class="p">;</span>
   <span class="nx">unmount</span><span class="p">(</span><span class="nx">rootContainer</span>: <span class="kt">HostElement</span> <span class="o">|</span> <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
   <span class="nx">provide</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>

   <span class="c1">// internal, but we need to expose these for the server-renderer and devtools
</span><span class="c1"></span>   <span class="nx">_uid</span>: <span class="kt">number</span><span class="p">;</span>
   <span class="nx">_component</span>: <span class="kt">ConcreteComponent</span><span class="p">;</span>
   <span class="nx">_props</span>: <span class="kt">Data</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">_container</span>: <span class="kt">HostElement</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">_context</span>: <span class="kt">AppContext</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
App é…ç½®:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">AppConfig</span> <span class="p">{</span>
   <span class="c1">// @private
</span><span class="c1"></span>   <span class="kr">readonly</span> <span class="nx">isNativeTag</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span><span class="p">;</span>

   <span class="nx">performance</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">optionMergeStrategies</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">OptionMergeFunction</span><span class="p">&gt;;</span>
   <span class="nx">globalProperties</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;;</span>
   <span class="nx">isCustomElement</span><span class="o">:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span><span class="p">;</span>
   <span class="nx">errorHandler</span><span class="o">?:</span> <span class="p">(</span>
     <span class="nx">err</span>: <span class="kt">unknown</span><span class="p">,</span>
     <span class="nx">instance</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">info</span>: <span class="kt">string</span>
   <span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
   <span class="nx">warnHandler</span><span class="o">?:</span> <span class="p">(</span>
     <span class="nx">msg</span>: <span class="kt">string</span><span class="p">,</span>
     <span class="nx">instance</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">trace</span>: <span class="kt">string</span>
   <span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
Vue æ’ä»¶ç±»å‹ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">type</span> <span class="nx">PluginInstallFunction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">app</span>: <span class="kt">App</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="kt">any</span><span class="p">;</span>
 <span class="kr">export</span> <span class="kr">type</span> <span class="nx">Plugin</span> <span class="o">=</span>
   <span class="o">|</span> <span class="p">(</span><span class="nx">PluginInstallFunction</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="nx">install?</span>: <span class="kt">PluginInstallFunction</span> <span class="p">})</span>
   <span class="o">|</span> <span class="p">{</span>
       <span class="nx">install</span>: <span class="kt">PluginInstallFunction</span><span class="p">;</span>
     <span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>api watch ç±»å‹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WatchOptionsBase</span> <span class="p">{</span>
   <span class="nx">flush</span><span class="o">?:</span> <span class="s2">&#34;pre&#34;</span> <span class="o">|</span> <span class="s2">&#34;post&#34;</span> <span class="o">|</span> <span class="s2">&#34;sync&#34;</span><span class="p">;</span>
   <span class="nx">onTrack?</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;onTrack&#34;</span><span class="p">];</span>
   <span class="nx">onTrigger?</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;onTrigger&#34;</span><span class="p">];</span>
 <span class="p">}</span>

 <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WatchOptions</span><span class="p">&lt;</span><span class="nt">Immediate</span> <span class="err">=</span> <span class="na">boolean</span><span class="p">&gt;</span> <span class="kr">extends</span> <span class="nx">WatchOptionsBase</span> <span class="p">{</span>
   <span class="nx">immediate?</span>: <span class="kt">Immediate</span><span class="p">;</span>
   <span class="nx">deep?</span>: <span class="kt">boolean</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>component ç»„ä»¶ç±»å‹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// å†…éƒ¨é€‰é¡¹
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ComponentInternalOptions</span> <span class="p">{</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__props?</span>: <span class="kt">NormalizedPropsOptions</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__emits?</span>: <span class="kt">ObjectEmitsOptions</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__scopeId?</span>: <span class="kt">string</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__cssModules?</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__hmrId?</span>: <span class="kt">string</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* This one should be exposed so that devtools can make use of it
</span><span class="cm"> ,*/</span>
   <span class="nx">__file?</span>: <span class="kt">string</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// å‡½æ•°å¼ç»„ä»¶
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">FunctionalComponent</span><span class="p">&lt;</span><span class="nt">P</span> <span class="err">=</span> <span class="p">{}</span><span class="err">,</span> <span class="na">E</span> <span class="na">extends</span> <span class="na">EmitsOptions </span><span class="o">=</span> <span class="p">{}&gt;</span>
   <span class="kr">extends</span> <span class="nx">ComponentInternalOptions</span> <span class="p">{</span>
   <span class="c1">// use of any here is intentional so it can be a valid JSX Element constructor
</span><span class="c1"></span>   <span class="p">(</span><span class="nx">props</span>: <span class="kt">P</span><span class="p">,</span> <span class="nx">ctx</span>: <span class="kt">Omit</span><span class="p">&lt;</span><span class="nt">SetupContext</span><span class="err">&lt;</span><span class="na">E</span><span class="p">&gt;,</span> <span class="s2">&#34;expose&#34;</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span> <span class="kt">any</span><span class="p">;</span>
   <span class="nx">props?</span>: <span class="kt">ComponentPropsOptions</span><span class="p">&lt;</span><span class="nt">P</span><span class="p">&gt;;</span>
   <span class="nx">emits?</span>: <span class="kt">E</span> <span class="o">|</span> <span class="p">(</span><span class="k">keyof</span> <span class="nx">E</span><span class="p">)[];</span>
   <span class="nx">inheritAttrs?</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">displayName?</span>: <span class="kt">string</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// ç±»ç»„ä»¶
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ClassComponent</span> <span class="p">{</span>
   <span class="k">new</span> <span class="p">(...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span><span class="p">&lt;</span><span class="nt">any</span><span class="err">,</span> <span class="na">any</span><span class="err">,</span> <span class="na">any</span><span class="err">,</span> <span class="na">any</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;;</span>
   <span class="nx">__vccOpts</span>: <span class="kt">ComponentOptions</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç¼©å†™
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">const</span> <span class="kr">enum</span> <span class="nx">LifecycleHooks</span> <span class="p">{</span>
   <span class="nx">BEFORE_CREATE</span> <span class="o">=</span> <span class="s2">&#34;bc&#34;</span><span class="p">,</span>
   <span class="nx">CREATED</span> <span class="o">=</span> <span class="s2">&#34;c&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_MOUNT</span> <span class="o">=</span> <span class="s2">&#34;bm&#34;</span><span class="p">,</span>
   <span class="nx">MOUNTED</span> <span class="o">=</span> <span class="s2">&#34;m&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UPDATE</span> <span class="o">=</span> <span class="s2">&#34;bu&#34;</span><span class="p">,</span>
   <span class="nx">UPDATED</span> <span class="o">=</span> <span class="s2">&#34;u&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UNMOUNT</span> <span class="o">=</span> <span class="s2">&#34;bum&#34;</span><span class="p">,</span>
   <span class="nx">UNMOUNTED</span> <span class="o">=</span> <span class="s2">&#34;um&#34;</span><span class="p">,</span>
   <span class="nx">DEACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;da&#34;</span><span class="p">,</span>
   <span class="nx">ACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRIGGERED</span> <span class="o">=</span> <span class="s2">&#34;rtg&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRACKED</span> <span class="o">=</span> <span class="s2">&#34;rtc&#34;</span><span class="p">,</span>
   <span class="nx">ERROR_CAPTURED</span> <span class="o">=</span> <span class="s2">&#34;ec&#34;</span><span class="p">,</span>
 <span class="p">}</span>

 <span class="c1">// setup å‡½æ•°
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SetupContext</span><span class="p">&lt;</span><span class="nt">E</span> <span class="err">=</span> <span class="na">EmitsOptions</span><span class="p">&gt;</span> <span class="p">{</span>
   <span class="nx">attrs</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">slots</span>: <span class="kt">Slots</span><span class="p">;</span>
   <span class="nx">emit</span>: <span class="kt">EmitFn</span><span class="p">&lt;</span><span class="nt">E</span><span class="p">&gt;;</span>
   <span class="nx">expose</span><span class="o">:</span> <span class="p">(</span><span class="nx">exposed</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>component internal instance</p>
<p>
è¿™é‡Œæ¶µç›–äº†ä¸€ä¸ªç»„ä»¶éƒ½æœ‰å“ªäº›å±æ€§ï¼š</p>
<p>
<code>uid, type, parent, root, appContext, vnode, next, subTree, update</code>,</p>
<p>
<code>render, ssrRender, provides, effects, accessCache, renderCache</code>,</p>
<p>
<code>components, directives, propsOptions, emitsOptions</code>,</p>
<p>
<code>proxy, exposed, withProxy, ctx</code>,</p>
<p>
<code>data, props, attrs, slots, refs, emit</code>,</p>
<p>
<code>emitted, setupState, devtoolsRawSetupState, setupContext</code>,</p>
<p>
<code>suspense, suspenseId, asyncDep, asyncResolved</code>,</p>
<p>
<code>isMounted, isUnmounted, isDeactivated</code>,</p>
<p>
<code>bc, c, bm, m, bu, u, bum, um, da, a, rtg, rtc, ec</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">const</span> <span class="kr">enum</span> <span class="nx">LifecycleHooks</span> <span class="p">{</span>
   <span class="nx">BEFORE_CREATE</span> <span class="o">=</span> <span class="s2">&#34;bc&#34;</span><span class="p">,</span>
   <span class="nx">CREATED</span> <span class="o">=</span> <span class="s2">&#34;c&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_MOUNT</span> <span class="o">=</span> <span class="s2">&#34;bm&#34;</span><span class="p">,</span>
   <span class="nx">MOUNTED</span> <span class="o">=</span> <span class="s2">&#34;m&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UPDATE</span> <span class="o">=</span> <span class="s2">&#34;bu&#34;</span><span class="p">,</span>
   <span class="nx">UPDATED</span> <span class="o">=</span> <span class="s2">&#34;u&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UNMOUNT</span> <span class="o">=</span> <span class="s2">&#34;bum&#34;</span><span class="p">,</span>
   <span class="nx">UNMOUNTED</span> <span class="o">=</span> <span class="s2">&#34;um&#34;</span><span class="p">,</span>
   <span class="nx">DEACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;da&#34;</span><span class="p">,</span>
   <span class="nx">ACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRIGGERED</span> <span class="o">=</span> <span class="s2">&#34;rtg&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRACKED</span> <span class="o">=</span> <span class="s2">&#34;rtc&#34;</span><span class="p">,</span>
   <span class="nx">ERROR_CAPTURED</span> <span class="o">=</span> <span class="s2">&#34;ec&#34;</span><span class="p">,</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç±»å‹ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="cm">/**
</span><span class="cm">  * We expose a subset of properties on the internal instance as they are
</span><span class="cm">  * useful for advanced external libraries and tools.
</span><span class="cm">  */</span>
 <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ComponentInternalInstance</span> <span class="p">{</span>
   <span class="nx">uid</span>: <span class="kt">number</span><span class="p">;</span>
   <span class="kr">type</span><span class="o">:</span> <span class="nx">ConcreteComponent</span><span class="p">;</span>
   <span class="nx">parent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">root</span>: <span class="kt">ComponentInternalInstance</span><span class="p">;</span>
   <span class="nx">appContext</span>: <span class="kt">AppContext</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Vnode representing this component in its parent&#39;s vdom tree
</span><span class="cm">    */</span>
   <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * The pending new vnode from parent updates
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">next</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Root vnode of this component&#39;s own vdom tree
</span><span class="cm">    */</span>
   <span class="nx">subTree</span>: <span class="kt">VNode</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * The reactive effect for rendering and patching the component. Callable.
</span><span class="cm">    */</span>
   <span class="nx">update</span>: <span class="kt">ReactiveEffect</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * The render function that returns vdom tree.
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">render</span>: <span class="kt">InternalRenderFunction</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * SSR render function
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">ssrRender?</span>: <span class="kt">Function</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Object containing values this component provides for its descendents
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">provides</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Tracking reactive effects (e.g. watchers) associated with this component
</span><span class="cm">    * so that they can be automatically stopped on component unmount
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">effects</span>: <span class="kt">ReactiveEffect</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * cache for proxy access type to avoid hasOwnProperty calls
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">accessCache</span>: <span class="kt">Data</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * cache for render function values that rely on _ctx but won&#39;t need updates
</span><span class="cm">    * after initialized (e.g. inline handlers)
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">renderCache</span><span class="o">:</span> <span class="p">(</span><span class="nb">Function</span> <span class="o">|</span> <span class="nx">VNode</span><span class="p">)[];</span>

   <span class="cm">/**
</span><span class="cm">    * Resolved component registry, only for components with mixins or extends
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">components</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">ConcreteComponent</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Resolved directive registry, only for components with mixins or extends
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">directives</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Directive</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * reoslved props options
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">propsOptions</span>: <span class="kt">NormalizedPropsOptions</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * resolved emits options
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">emitsOptions</span>: <span class="kt">ObjectEmitsOptions</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="c1">// the rest are only for stateful components ---------------------------------
</span><span class="c1"></span>
   <span class="c1">// main proxy that serves as the public instance (`this`)
</span><span class="c1"></span>   <span class="nx">proxy</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="c1">// exposed properties via expose()
</span><span class="c1"></span>   <span class="nx">exposed</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="cm">/**
</span><span class="cm">    * alternative proxy used only for runtime-compiled render functions using
</span><span class="cm">    * `with` block
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">withProxy</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * This is the target for the public instance proxy. It also holds properties
</span><span class="cm">    * injected by user options (computed, methods etc.) and user-attached
</span><span class="cm">    * custom properties (via `this.x = ...`)
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">ctx</span>: <span class="kt">Data</span><span class="p">;</span>

   <span class="c1">// state
</span><span class="c1"></span>   <span class="nx">data</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">props</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">attrs</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">slots</span>: <span class="kt">InternalSlots</span><span class="p">;</span>
   <span class="nx">refs</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">emit</span>: <span class="kt">EmitFn</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * used for keeping track of .once event handlers on components
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">emitted</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">boolean</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="cm">/**
</span><span class="cm">    * setup related
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">setupState</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * devtools access to additional info
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">devtoolsRawSetupState?</span>: <span class="kt">any</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">setupContext</span>: <span class="kt">SetupContext</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="cm">/**
</span><span class="cm">    * suspense related
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">suspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * suspense pending batch id
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">suspenseId</span>: <span class="kt">number</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">asyncDep</span>: <span class="kt">Promise</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">asyncResolved</span>: <span class="kt">boolean</span><span class="p">;</span>

   <span class="c1">// lifecycle
</span><span class="c1"></span>   <span class="nx">isMounted</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">isUnmounted</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">isDeactivated</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_CREATE</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">CREATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_MOUNT</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">MOUNTED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_UPDATE</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UPDATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_UNMOUNT</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UNMOUNTED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">RENDER_TRACKED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">RENDER_TRIGGERED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">ACTIVATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">DEACTIVATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">ERROR_CAPTURED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>emit fn äº‹ä»¶</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">type</span> <span class="nx">EmitFn</span><span class="o">&lt;</span>
   <span class="nx">Options</span> <span class="o">=</span> <span class="nx">ObjectEmitsOptions</span><span class="p">,</span>
   <span class="nx">Event</span> <span class="kr">extends</span> <span class="k">keyof</span> <span class="nx">Options</span> <span class="o">=</span> <span class="k">keyof</span> <span class="nx">Options</span>
 <span class="o">&gt;</span> <span class="o">=</span> <span class="nx">Options</span> <span class="kr">extends</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">infer</span> <span class="na">V</span><span class="p">&gt;</span>
   <span class="o">?</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">V</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="k">void</span>
   <span class="o">:</span> <span class="p">{}</span> <span class="kr">extends</span> <span class="nx">Options</span> <span class="c1">// if the emit is empty object (usually the default value for emit) should be converted to function
</span><span class="c1"></span>   <span class="o">?</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">string</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="k">void</span>
   <span class="o">:</span> <span class="nx">UnionToIntersection</span><span class="o">&lt;</span>
       <span class="p">{</span>
         <span class="p">[</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">Event</span><span class="p">]</span><span class="o">:</span> <span class="nx">Options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="kr">extends</span> <span class="p">(...</span><span class="nx">args</span>: <span class="kt">infer</span> <span class="nx">Args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span>
           <span class="o">?</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">key</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">Args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>
           <span class="o">:</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">key</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
       <span class="p">}[</span><span class="nx">Event</span><span class="p">]</span>
     <span class="o">&gt;</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2021-01-08
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/runtime-core/">runtime-core</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-runtime-core-2-render/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-compiler-ssr/">
            <span class="next-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 6 â˜compiler-ssr</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2021-01-08 00:00:00 \u002b0000 UTC',
        title: 'Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(1)',
        clientID: '7251a6b30d0d6c0f4aa2',
        clientSecret: '320c43a98b0d5ae30535d8cf6cb3be7a05895c77',
        repo: 'cheng92-comments',
        owner: 'gcclll',
        admin: ['gcclll'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
