<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 源码头脑风暴之 7 ☞ runtime-core(1) - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-runtime-core-1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.9d6c07951e716411e0fdd9d1d7616cb41ced57b53993154c49ea809e194527af.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 源码头脑风暴之 7 ☞ runtime-core(1)" />
<meta property="og:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-runtime-core-1/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2021-01-08T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-01-08T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 源码头脑风暴之 7 ☞ runtime-core(1)">
<meta itemprop="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu"><meta itemprop="datePublished" content="2021-01-08T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-01-08T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="29119">
<meta itemprop="keywords" content="vue,,vue3,,runtime-core," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 源码头脑风暴之 7 ☞ runtime-core(1)"/>
<meta name="twitter:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：vu"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 源码头脑风暴之 7 ☞ runtime-core(1)</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-01-08 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> 约 29119 字 </span>
          <span class="more-meta"> 预计阅读 59 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">⚠ Tips</a>
</li>
<li><a href="#headline-2">🐂 init</a>
</li>
<li><a href="#h-function">😜 h function</a>
</li>
<li><a href="#createVNode">🌿 createVNode function</a>
<ul>
<li><a href="#headline-5">d3c6563 props</a>
</li>
<li><a href="#headline-6">class component</a>
</li>
<li><a href="#headline-7">stateful component &amp; key NaN</a>
</li>
<li><a href="#headline-8">88eaf09 type is vnode</a>
<ul>
<li><a href="#test-vnode-key">key test</a>
</li>
<li><a href="#test-vnode-ref">ref test</a>
</li>
<li><a href="#test-vnode-patchflag">patchFlag test</a>
</li>
<li><a href="#headline-12">shapeFlag test</a>
</li>
<li><a href="#headline-13">mergeProps test</a>
</li>
<li><a href="#headline-14">dynamic children test</a>
</li>
<li><a href="#headline-15">transformVNodeArgs test</a>
</li>
</ul>
</li>
<li><a href="#headline-16">7ec1d30 suspense component</a>
</li>
<li><a href="#vnode-currentBlock">23fc943 currentBlock 优化</a>
</li>
<li><a href="#block-related">block related(open/close/create)</a>
</li>
<li><a href="#normalize-children">normalizeChildren function</a>
<ul>
<li><a href="#headline-20">children is function</a>
</li>
<li><a href="#headline-21">children is array or 普通类型</a>
</li>
<li><a href="#headline-22">children is object</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#api-watch">⏱ api watch(source, cb, options)</a>
<ul>
<li><a href="#headline-24">source is ref</a>
</li>
<li><a href="#headline-25">source is reactive</a>
</li>
<li><a href="#watch-array">soure is array</a>
</li>
<li><a href="#headline-27">source is function</a>
</li>
<li><a href="#api-watch-deep">option deep</a>
<ul>
<li><a href="#headline-29">deep ref</a>
</li>
</ul>
</li>
<li><a href="#headline-30">option immediate</a>
</li>
<li><a href="#headline-31">option onTrack + onTrigger</a>
</li>
<li><a href="#headline-32">stop &amp; cleanup</a>
<ul>
<li><a href="#headline-33">stop</a>
</li>
<li><a href="#headline-34">cleanup(无 cb)</a>
</li>
<li><a href="#headline-35">cleanup(有 cb)</a>
</li>
</ul>
</li>
<li><a href="#watch-sync">flush sync</a>
</li>
<li><a href="#watch-shallow-ref">shallow ref</a>
</li>
<li><a href="#headline-38">flush pre(default) cb</a>
</li>
<li><a href="#headline-39">flush post cb</a>
</li>
<li><a href="#headline-40">ssr support</a>
</li>
<li><a href="#headline-41">instance watch</a>
</li>
<li><a href="#headline-42">🍺 小结</a>
</li>
</ul>
</li>
<li><a href="#headline-43">🍎 api createApp</a>
<ul>
<li><a href="#headline-44">declaration</a>
</li>
<li><a href="#headline-45">implementation</a>
<ul>
<li><a href="#headline-46">app.use(plugin, …options)</a>
</li>
<li><a href="#headline-47">app.mixin(mixin)</a>
</li>
<li><a href="#headline-48">app.component(name, component)</a>
</li>
<li><a href="#headline-49">app.directive(name, directive)</a>
</li>
<li><a href="#headline-50">app.mount(rootContainer, isHydrate)</a>
</li>
<li><a href="#headline-51">app.unmount()</a>
</li>
<li><a href="#headline-52">app.provide(key, value)</a>
</li>
</ul>
</li>
<li><a href="#headline-53">test</a>
</li>
</ul>
</li>
<li><a href="#api-provide-inject">⛏ api provide &amp; inject</a>
<ul>
<li><a href="#headline-55">provide(key, value)</a>
</li>
<li><a href="#headline-56">inject(key, defaultValue, treatDefaultAsFactory = false)</a>
</li>
<li><a href="#headline-57">test</a>
</li>
</ul>
</li>
<li><a href="#headline-58">✨ api computed</a>
</li>
<li><a href="#headline-59">🌀 api lifecycle</a>
<ul>
<li><a href="#headline-60">test base</a>
</li>
<li><a href="#headline-61">test update</a>
</li>
<li><a href="#headline-62">test unmount</a>
</li>
<li><a href="#lc-test-order">test order</a>
</li>
<li><a href="#headline-64">test render track &amp; trigger</a>
</li>
</ul>
</li>
<li><a href="#define-component">🦉 api define component</a>
</li>
<li><a href="#headline-66">🆘 api setup helpers</a>
</li>
<li><a href="#headline-67">🌊 TODO api async comopnent</a>
<ul>
<li><a href="#headline-68">implementation(init)</a>
</li>
</ul>
</li>
<li><a href="#headline-69">🔥 render function</a>
</li>
<li><a href="#scheduler">🚒 scheduler 任务调度机制</a>
<ul>
<li><a href="#nexttick">nextTick</a>
</li>
<li><a href="#job-queue-job">queueJob</a>
</li>
<li><a href="#headline-73">flushJobs</a>
</li>
<li><a href="#headline-74">queueJob while flushing</a>
</li>
<li><a href="#headline-75">queuePreFlushCb</a>
</li>
<li><a href="#job-flush-pre">flushPreFlushCbs</a>
</li>
<li><a href="#headline-77">queuePostFlushCb + flushPostFlushCbs</a>
</li>
<li><a href="#headline-78">test nested(pre/job/post)</a>
</li>
<li><a href="#headline-79">invalidateJob(job)</a>
</li>
<li><a href="#headline-80">job sort id 任务可以排序</a>
</li>
<li><a href="#headline-81">allowRecurse 自身递归</a>
</li>
<li><a href="#headline-82">checkRecursiveUpdates</a>
</li>
<li><a href="#headline-83">小结</a>
</li>
</ul>
</li>
<li><a href="#headline-84">🐛 BUGs fix &amp; Questions</a>
<ul>
<li><a href="#q-nexttick">nextTick() 后面的代码最后执行？</a>
</li>
</ul>
</li>
<li><a href="#runtime-test">runtime-test 模块简介</a>
</li>
<li><a href="#headline-87">重要类型声明</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> 完全拷贝于 <a href="https://github.com/vuejs/vue-next">vue-next</a> ，主要目的用于学习。</strong>
</kbd></p>
<blockquote>
<p><strong>声明</strong> ：vue-next runtime-core 运行时核心代码，这部分内容较多，可能会分为几篇来
叙述, <code>f</code> 过滤掉对象空值属性。</p>
<p>
<strong>更新日志&amp;Todos</strong> ：</p>
<ol>
<li>
<p>[2021-01-08 10:12:50] 创建</p>
</li>
<li>
<p>DONE [2021-01-15 10:24:00] scheduler</p>
</li>
<li>
<p>TODO apiWatch -&gt; post cb &amp; ssr</p>
</li>
<li>
<p>TODO STATEFUL_COMONENT</p>
</li>
<li>
<p>TODO patchFlag 测试和用途</p>
</li>
<li>
<p>TODO transformVNodeArgs</p>
</li>
<li>
<p>TODO Suspense 组件</p>
</li>
<li>
<p>TODO shouldTrack, currentBlock 和 <a href="#block-related">block 相关函数</a>的作用</p>
</li>
<li>
<p>TODO setup() 返回值用来做了啥？</p>
</li>
<li>
<p>TODO setup() 里面是如何收集生命周期函数，又是如何？在什么时候？执行他们的？</p>
</li>
<li>
<p>TODO async component</p>
</li>
</ol>
</blockquote>
<p>
模块初始化： <a href="https://github.com/gcclll/stb-vue-next/commit/b22b4db3506bf1ba4b266dcf9ff21f1e0b925a81">feat(init): runtime-core · gcclll/stb-vue-next@b22b4db · GitHub</a></p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core.svg" alt="/img/vue3/runtime-core/vue-runtime-core.svg" title="/img/vue3/runtime-core/vue-runtime-core.svg" /></p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
⚠ Tips
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ol>
<li>
<p>class 支持数组(<code>[&#39;foo&#39;, &#39;bar&#39;]</code>)，对象(<code>{foo:true,bar:false}</code>)，字符串(<code>&#39;foo bar&#39;</code>)</p>
</li>
<li>
<p>style 支持数组(<code>[&#39;color:red&#39;, {foo:&#39;foo&#39;}]</code>)，对象(<code>{color:&#39;red&#39;,foo:&#39;foo&#39;}</code>)，字符串(<code>color:red</code>)</p>
</li>
<li>
<p>class component 条件：</p>
<ol>
<li>
<p>function</p>
</li>
<li>
<p>含 <code>__vccOpts = { template: &#39;&lt;div /&gt;&#39;}</code></p>
</li>
</ol>
</li>
<li>
<p><a href="#test-vnode-ref">vnode ref 属性合并处理逻辑？</a></p>
</li>
<li>
<p><a href="#test-vnode-key">vnode key 属性简单的值覆盖操作？</a></p>
</li>
<li>
<p><a href="#h-function">h()</a> 和 <a href="#createVNode">createVNode</a> 函数多种使用方式组合？</p>
<p>
<code>h(type, propsOrChildren, ...children)</code>, 参数个数多变，对于这个函数的使用方法
记忆只要记住一点：</p>
<blockquote>
<p>props 总是对象，children 可以是对象(必须是 VNode 类型 <code>__v_isVNode</code>)也可以是
数组，所以：</p>
<ol>
<li>
<p>argc = 2, 如果是数组就一定是 children</p>
</li>
<li>
<p>argc = 2, 如果是对象且有 __v_isVNode 标识，一定是 children 否则是 props</p>
</li>
<li>
<p>argc = 3, 按照 <code>h(type, props, children)</code> 处理</p>
</li>
<li>
<p>argc &gt; 3, 按照 <code>h(type, props, ...children)</code> 处理，从第三个开始都是 children</p>
</li>
</ol>
</blockquote>
<p>
<code>createVNode(type, props, children)</code>, 固定三个参数，第二个一定是 props, 第三
个一定是数组类型的 children，因为它后面还有更多的其他参数(patchFlag,
dynamicProps, isBlockNode)，所以前三个必须确定下来。</p>
</li>
<li>
<p><a href="#scheduler">scheduler, vue-next 中的任务调度器如何实现？</a></p>
</li>
<li>
<p><a href="#api-watch">api watch(source, cb, option)</a> 中的 source 只能是 <code>reactive/ref/function/array</code> 类型，
如果是数组时其元素只能是 <code>reactive/ref/function</code></p>
</li>
<li>
<p><a href="#api-watch-deep">api watch(…, { deep: true }) 是如何做到深度监听的？</a></p>
</li>
<li>
<p><a href="#watch-shallow-ref">api watch(shallowRef, <em><strong>cb</strong></em> (newVal) =&gt; {}) 是如何直接使用 newVal.a 的？</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">shallowRef</span><span class="p">({</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
<span class="nx">watch</span><span class="p">(</span><span class="nx">shallowRef</span><span class="p">,</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span> <span class="c1">// 这里为什么可以直接访问 obj.a，obj 又是什么？
</span><span class="c1"></span><span class="p">});</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><a href="#api-provide-inject">provide &amp; inject 如何实现？</a></p>
<p>
provide(key,value) 向组件 <code>provides[key] = value</code> 设置</p>
<p>
inject(key) 从组件 <code>provides[key]</code> 取值</p>
</li>
<li>
<p>TODO setup() 返回值用来做了啥？</p>
</li>
<li>
<p><a href="#lc-test-order">组件声明周期函数(<code>onBeforeXxx</code>, <code>onXxx</code>)触发顺序是什么？</a></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
🐂 init
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
导出已完成模块(reactiviy)里的 Apis:
<a href="https://github.com/gcclll/stb-vue-next/commit/38e91a877635b51b56a2918ff173a48638b8760a">feat(init): runtime-core&gt; add exports from @vue/reactivity · gcclll/stb-vue-next@38e91a8 · GitHub</a></p>
<p>
这部分代码有点多，所以这里事先将所有类型定义添加好：</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e3f7b94ef39cf389aaf25f55ea81877941860f56">feat(add): runtime-core&gt;all types · gcclll/stb-vue-next@e3f7b94 · GitHub</a></p>
<p>
有关类型定义请移步<a href="#defines">最后一节</a>(纯贴代码的，所以放到最后)</p>
</div>
</div>
<div id="outline-container-h-function" class="outline-2">
<h2 id="h-function">
😜 h function
</h2>
<div id="outline-text-h-function" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e48d5e28c4e1b55c6d6a326bcf0808047e23ceeb">feat(add): runtime-core&gt;h function · gcclll/stb-vue-next@e48d5e2 · GitHub</a></p>
<p>
<code>h</code>, render 函数初始化。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Actual implementation
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">h</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="kt">any</span><span class="p">,</span> <span class="nx">propsOrChildren?</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">children?</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
实现：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Actual implementation
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">h</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="kt">any</span><span class="p">,</span> <span class="nx">propsOrChildren?</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">children?</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">propsOrChildren</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">propsOrChildren</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 没有 props 的 单节点(single vnode)
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">isVNode</span><span class="p">(</span><span class="nx">propsOrChildren</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">propsOrChildren</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="c1">// 有 props 没有 children
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="nx">propsOrChildren</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// omit props
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">propsOrChildren</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 从第三个参数开始全当做孩子节点处理
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">children</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">isVNode</span><span class="p">(</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">children</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="nx">propsOrChildren</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
h, 接受不定参数</p>
<p>
逻辑脑图:</p>
<p>
<img src="/img/tmp/20210108152508.png" alt="/img/tmp/20210108152508.png" title="/img/tmp/20210108152508.png" /></p>
<p>
从脑图分支得出支持的情况代码示例：</p>
<ol>
<li>
<p><code>h(&#39;div&#39;)</code> 无参数无孩子</p>
</li>
<li>
<p><code>h(&#39;div&#39;, { id: &#39;foo&#39; })</code> 有 props 无 children</p>
</li>
<li>
<p><code>h(&#39;div&#39;, [&#39;foo&#39;])</code> 数组当做 chilren</p>
</li>
<li>
<p><code>h(&#39;div&#39;, vnode)</code> 有 __v_isVNode 标识当做 children，并转成数组 <code>[vnode]</code></p>
</li>
<li>
<p><code>h(&#39;div&#39;, {}, [&#39;foo&#39;])</code> 有 props 有 children</p>
</li>
<li>
<p><code>h(&#39;div&#39;, {}, vnode)</code> 有 props, 有 children 且 = <code>[vnode]</code></p>
</li>
</ol>
<p>接下来需要具体去实现 <code>createVNode</code> 函数。</p>
</div>
</div>
<div id="outline-container-createVNode" class="outline-2">
<h2 id="createVNode">
🌿 createVNode function
</h2>
<div id="outline-text-createVNode" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/194f72fee239da947ef82a4da099c23c758d3d84">feat(add): rc-&gt;createVNode · gcclll/stb-vue-next@194f72f · GitHub</a></p>
<p>
这个函数最终是构造了 vnode: VNode 虚拟节点结构，返回。</p>
<p>
这里面分为以下几个步骤实现：</p>
<ol>
<li>
<p>type 是 vnode 时候处理</p>
</li>
<li>
<p>class 组件处理</p>
</li>
<li>
<p>props 处理</p>
</li>
<li>
<p>shapeFlag 检测，是什么类型 的 vnode</p>
</li>
<li>
<p>组件对象不应该 reactive(有状态的组件, STATEFUL_COMONENT)</p>
</li>
<li>
<p>构建 vnode: VNode 对象</p>
</li>
<li>
<p>检测 vnode.key 是不是 <code>NaN</code></p>
</li>
<li>
<p>normalize children</p>
</li>
<li>
<p>normalize suspense children</p>
</li>
<li>
<p>currentBlock 处理</p>
</li>
<li>
<p>返回 vnode 节点</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">h</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; type only\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; type + props\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">})]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; type + omit props\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">])]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; type only
 { __v_isVNode: true, __v_skip: true, type: &#39;div&#39;, shapeFlag: 1 }
&gt;&gt;&gt; type + props
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: { id: &#39;foo&#39; },
  shapeFlag: 1
}
&gt;&gt;&gt; type + omit props
 { __v_isVNode: true, __v_skip: true, type: &#39;div&#39;, shapeFlag: 1 }
&gt;&gt;&gt; default slot
 {
  __v_isVNode: true,
  __v_skip: true,
  type: { template: &#39;&lt;br /&gt;&#39; },
  shapeFlag: 4
}
undefined
</pre>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
d3c6563 props
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/d3c656331e3e5a9206f0341dd2ca960a300f96ba">feat(add): rc-&gt;createVNode, props · gcclll/stb-vue-next@d3c6563 · GitHub</a></p>
<p>
处理 class 和 style 属性。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 3. props 处理, class &amp; style normalization
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// for reactive or proxy objects, we need to clone it to enable mutation.
</span><span class="c1"></span>   <span class="k">if</span> <span class="p">(</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">||</span> <span class="nx">InternalObjectKey</span> <span class="k">in</span> <span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">props</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="nx">props</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="kd">let</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">style</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">klass</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isString</span><span class="p">(</span><span class="nx">klass</span><span class="p">))</span> <span class="p">{</span>
     <span class="c1">// 1. string -&gt; klass
</span><span class="c1"></span>     <span class="c1">// &#39;foo&#39; -&gt; &#39;foo&#39;
</span><span class="c1"></span>     <span class="c1">// 2. array -&gt; &#39;&#39; + arr.join(&#39; &#39;)
</span><span class="c1"></span>     <span class="c1">// [&#39;foo&#39;, &#39;bar&#39;] -&gt; &#39;foo bar&#39;
</span><span class="c1"></span>     <span class="c1">// 3. object -&gt; &#39;&#39; + value ? &#39; value&#39; : &#39;&#39;
</span><span class="c1"></span>     <span class="c1">// { foo: true, bar: false, baz: true } -&gt; &#39;foo baz&#39;
</span><span class="c1"></span>     <span class="nx">props</span><span class="p">.</span><span class="kr">class</span> <span class="o">=</span> <span class="nx">normalizeClass</span><span class="p">(</span><span class="nx">klass</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">style</span><span class="p">))</span> <span class="p">{</span>
     <span class="c1">// reactive state objects need to be cloned since they are likely to be
</span><span class="c1"></span>     <span class="c1">// mutated
</span><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span><span class="nx">isProxy</span><span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">style</span><span class="p">))</span> <span class="p">{</span>
       <span class="nx">style</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="nx">style</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="c1">// 1. array -&gt; object
</span><span class="c1"></span>     <span class="c1">// [{ color: &#39;red&#39; }, &#39;font-size:10px;height:100px;&#39;] -&gt;
</span><span class="c1"></span>     <span class="c1">// { color: &#39;red&#39;, &#39;font-size&#39;: &#39;10px&#39;, height: &#39;100px&#39; }
</span><span class="c1"></span>     <span class="c1">// 2. object -&gt; object 原样返回
</span><span class="c1"></span>     <span class="nx">props</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="nx">normalizeStyle</span><span class="p">(</span><span class="nx">style</span><span class="p">);</span>
   <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>class 数组，对象，字符串？</p>
<p>
数组： 合并成字符串， <code>[&#39;foo&#39;, &#39;bar&#39;]</code> -&gt; &#39;foo bar&#39;</p>
<p>
对象： 合并成字符串， <code>{foo: true, bar: false, baz: true}</code> -&gt; &#39;foo baz&#39;</p>
<p>
字符串： 原样输出</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeClass</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span> <span class="o">+=</span> <span class="nx">normalizeClass</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">+=</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>style 数组，对象，字符串？</p>
<p>
数组： 合并成对象， <code>[&#39;color:red&#39;, { &#39;font-size&#39;: &#39;10px&#39;, height: &#39;100px&#39; }]</code> -&gt; <code>{color:
&#39;red&#39;, &#39;font-size&#39;: &#39;10px&#39;, height: &#39;100px&#39;}</code></p>
<p>
对象： 原样返回</p>
<p>
字符串：解析成对象， 如数组内字符串部分</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeStyle</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="nx">NormalizedStyle</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
     <span class="kr">const</span> <span class="nx">res</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">string</span> <span class="err">|</span> <span class="na">number</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">{};</span>
     <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="kr">const</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
       <span class="kr">const</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="nx">normalizeStyle</span><span class="p">(</span>
         <span class="nx">isString</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">?</span> <span class="nx">parseStringStyle</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">:</span> <span class="nx">item</span>
       <span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">normalized</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">normalized</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">res</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">normalized</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
         <span class="p">}</span>
       <span class="p">}</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
   <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kd">let</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">),</span> <span class="s1">&#39;props&#39;</span><span class="p">)</span>

<span class="c1">// class 合并成字符串
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: string\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;foo baz&#39;</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: array\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">]</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: array&lt;object|string&gt;\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span>  <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}]</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; class: object\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">})])</span>

<span class="c1">// style 合并成对象
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; style: array\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">style</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}]</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; style: object\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}</span>
<span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; style: array&lt;object|string&gt;\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="s1">&#39;color:red&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">baz</span><span class="o">:</span> <span class="s1">&#39;baz&#39;</span> <span class="p">}]</span>
<span class="p">})])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; class: string
 { props: { class: &#39;foo baz&#39; } }
&gt;&gt;&gt; class: array
 { props: { class: &#39;foo baz&#39; } }
&gt;&gt;&gt; class: array&lt;object|string&gt;
 { props: { class: &#39;foo baz baz&#39; } }
&gt;&gt;&gt; class: object
 { props: { class: &#39;foo bar&#39; } }
&gt;&gt;&gt; style: array
 { props: { style: { foo: &#39;foo&#39;, baz: &#39;baz&#39; } } }
&gt;&gt;&gt; style: object
 { props: { style: { foo: &#39;foo&#39;, baz: &#39;baz&#39; } } }
&gt;&gt;&gt; style: array&lt;object|string&gt;
 { props: { style: { foo: &#39;foo&#39;, color: &#39;red&#39;, baz: &#39;baz&#39; } } }
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
class component
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>
是类组件前提是：</p>
<ol>
<li>
<p>必须是函数</p>
</li>
<li>
<p>必须包含 <code>__vccOpts</code> 属性</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// 2. class component
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">isClassComponent</span><span class="p">(</span><span class="kr">type</span><span class="p">))</span> <span class="p">{</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="kr">type</span><span class="p">.</span><span class="nx">__vccOpts</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">isClassComponent</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">)</span><span class="o">:</span> <span class="nx">value</span> <span class="k">is</span> <span class="nx">ClassComponent</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s2">&#34;__vccOpts&#34;</span> <span class="k">in</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">))</span>

<span class="kr">class</span> <span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">$props</span>

  <span class="kr">static</span> <span class="mi">__</span><span class="nx">vccOpts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;div /&gt;&#39;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="nx">log</span><span class="p">(</span><span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="nx">Component</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  __v_isVNode: true,
  __v_skip: true,
  type: { template: &#39;&lt;div /&gt;&#39; },
  shapeFlag: 4 // STATEFUL_COMPONENT
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-7" class="outline-3">
<h3 id="headline-7">
<span class="todo">TODO</span>
stateful component &amp; key NaN
</h3>
<div id="outline-text-headline-7" class="outline-text-3">
<p>
有状态的组件？</p>
<p>
即 type 为对象时候视为有状态的组件。</p>
<p>
如果是 STATEFUL_COMPONENT 且是个 proxy 的时候，开发模式下给出警告⚠️。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">reactive</span><span class="o">:</span><span class="nx">r</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">))</span>

<span class="nx">log</span><span class="p">(</span><span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="kc">NaN</span> <span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: { key: NaN },
  shapeFlag: 1
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
88eaf09 type is vnode
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/88eaf090c3d1767bc4a1ca576eef449abf7d62d2">feat(add): rc-&gt;createVNode, type is vnode · gcclll/stb-vue-next@88eaf09 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// &gt; in createVNode
</span><span class="c1"></span>  <span class="c1">// 1. type is vnode
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">isVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// createVNode receiving an existing vnode. This happens in cases like
</span><span class="c1"></span>    <span class="c1">// &lt;component :is=&#34;vnode&#34;/&gt;
</span><span class="c1"></span>    <span class="c1">// #2078 make sure to merge refs during the clone instead of overwriting it
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">cloned</span> <span class="o">=</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="kr">type</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="kc">true</span> <span class="cm">/* mergeRef: true */</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">normalizeChildren</span><span class="p">(</span><span class="nx">cloned</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">cloned</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// cloneVNode
</span><span class="c1"></span>  <span class="c1">// 省略直接取 vnode 值部分
</span><span class="c1"></span>  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">cloneVNode</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">,</span> <span class="na">U</span><span class="p">&gt;(</span>
    <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">,</span> <span class="na">U</span><span class="p">&gt;,</span>
    <span class="nx">extraProps</span><span class="o">?:</span> <span class="p">(</span><span class="nx">Data</span> <span class="o">&amp;</span> <span class="nx">VNodeProps</span><span class="p">)</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">mergeRef</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span><span class="p">&lt;</span><span class="nt">T</span><span class="err">,</span> <span class="na">U</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">// This is intentionally NOT using spread or extend to avoid the runtime
</span><span class="c1"></span>    <span class="c1">// key enumeration cost.
</span><span class="c1"></span>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">patchFlag</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">mergedProps</span> <span class="o">=</span> <span class="nx">extraProps</span> <span class="o">?</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">props</span> <span class="o">||</span> <span class="p">{},</span> <span class="nx">extraProps</span><span class="p">)</span> <span class="o">:</span> <span class="nx">props</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">__v_isVNode</span>: <span class="kt">true</span><span class="p">,</span>
      <span class="p">[</span><span class="nx">ReactiveFlags</span><span class="p">.</span><span class="nx">SKIP</span><span class="p">]</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="kr">type</span><span class="o">:</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span><span class="p">,</span>
      <span class="nx">props</span>: <span class="kt">mergedProps</span><span class="p">,</span>
      <span class="nx">key</span>: <span class="kt">mergedProps</span> <span class="o">&amp;&amp;</span> <span class="nx">normalizeKey</span><span class="p">(</span><span class="nx">mergedProps</span><span class="p">),</span>
      <span class="nx">ref</span>:
        <span class="kt">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">extraProps</span><span class="p">.</span><span class="nx">ref</span>
          <span class="o">?</span> <span class="c1">// #2078 in the case of &lt;component :is=&#34;vnode&#34; ref=&#34;extra&#34;/&gt;
</span><span class="c1"></span>            <span class="c1">// if the vnode itself already has a ref, cloneVNode will need to merge
</span><span class="c1"></span>            <span class="c1">// the refs so the single vnode can be set on multiple refs
</span><span class="c1"></span>            <span class="nx">mergeRef</span> <span class="o">&amp;&amp;</span> <span class="nx">ref</span>
            <span class="o">?</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
              <span class="o">?</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
              <span class="o">:</span> <span class="p">[</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">]</span>
            <span class="o">:</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">ref</span><span class="p">,</span>
      <span class="c1">// if the vnode is cloned with extra props, we can no longer assume its
</span><span class="c1"></span>      <span class="c1">// existing patch flag to be reliable and need to add the FULL_PROPS flag.
</span><span class="c1"></span>      <span class="c1">// note: perserve flag for fragments since they use the flag for children
</span><span class="c1"></span>      <span class="c1">// fast paths only.
</span><span class="c1"></span>      <span class="nx">patchFlag</span>:
        <span class="kt">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">Fragment</span>
          <span class="o">?</span> <span class="nx">patchFlag</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// hoisted node
</span><span class="c1"></span>            <span class="o">?</span> <span class="nx">PatchFlags.FULL_PROPS</span>
            : <span class="kt">patchFlag</span> <span class="o">|</span> <span class="nx">PatchFlags.FULL_PROPS</span>
          : <span class="kt">patchFlag</span><span class="p">,</span>

      <span class="nx">ssContent</span>: <span class="kt">vnode.ssContent</span> <span class="o">&amp;&amp;</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">ssContent</span><span class="p">),</span>
      <span class="nx">ssFallback</span>: <span class="kt">vnode.ssFallback</span> <span class="o">&amp;&amp;</span> <span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">ssFallback</span><span class="p">),</span>
    <span class="p">};</span>
  <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
cloneVNode 绝大部分属性都是直接引用自 vnode，上面列出的都是需要处理的属性，比如：</p>
<ol>
<li>
<p>props 会将 vnode 和 cloneVNode 传入的 props 进行合并，并且是传入的 props 覆盖 vnode.props。</p>
</li>
<li>
<p>key 属性，取合并之后的 key(<a href="#test-vnode-key">测试-&gt;</a>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// normalize 合并后的 key
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">mergedProps</span> <span class="o">&amp;&amp;</span> <span class="nx">normalizeKey</span><span class="p">(</span><span class="nx">mergedProps</span><span class="p">);</span>

 <span class="kr">const</span> <span class="nx">normalizeKey</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">key</span> <span class="p">}</span><span class="o">:</span> <span class="nx">VNodeProps</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span><span class="p">[</span><span class="s2">&#34;key&#34;</span><span class="p">]</span> <span class="o">=&gt;</span>
   <span class="nx">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">key</span> : <span class="kt">null</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>ref 属性，合并规则(<a href="#test-vnode-ref">测试-&gt;</a>)：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 1. mergeRef: boolean 可以手动指定是否需要合并
</span><span class="c1"></span> <span class="c1">// 2. extraProps.ref 调用 cloneVNode 时候传入的 props ref
</span><span class="c1"></span> <span class="c1">// 3. ref 如果是数组，加上新的 ref 扩展原数组
</span><span class="c1"></span> <span class="c1">// 4. ref 不是数组，用 ref 和 extra ref 合并成新数组
</span><span class="c1"></span> <span class="c1">// 5. 如果 ref null, 则直接用 extra ref normalize 出新的 ref
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">ref</span> <span class="o">=</span>
   <span class="nx">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">extraProps</span><span class="p">.</span><span class="nx">ref</span>
     <span class="o">?</span> <span class="c1">// #2078 in the case of &lt;component :is=&#34;vnode&#34; ref=&#34;extra&#34;/&gt;
</span><span class="c1"></span>       <span class="c1">// if the vnode itself already has a ref, cloneVNode will need to merge
</span><span class="c1"></span>       <span class="c1">// the refs so the single vnode can be set on multiple refs
</span><span class="c1"></span>       <span class="nx">mergeRef</span> <span class="o">&amp;&amp;</span> <span class="nx">ref</span>
       <span class="o">?</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
         <span class="o">?</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
         <span class="o">:</span> <span class="p">[</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span><span class="o">!</span><span class="p">]</span>
       <span class="o">:</span> <span class="nx">normalizeRef</span><span class="p">(</span><span class="nx">extraProps</span><span class="p">)</span>
     <span class="o">:</span> <span class="nx">ref</span><span class="p">;</span>

 <span class="c1">// normalization
</span><span class="c1"></span> <span class="kr">const</span> <span class="nx">normalizeRef</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">ref</span> <span class="p">}</span><span class="o">:</span> <span class="nx">VNodeProps</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNodeNormalizedRefAtom</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="nx">ref</span> <span class="o">!=</span> <span class="kc">null</span>
     <span class="o">?</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isRef</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
       <span class="o">?</span> <span class="p">{</span> <span class="nx">i</span>: <span class="kt">currentRenderingInstance</span><span class="p">,</span> <span class="nx">r</span>: <span class="kt">ref</span> <span class="p">}</span>
       <span class="o">:</span> <span class="nx">ref</span>
     : <span class="kt">null</span><span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
 <span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>patchFlag 属性(<a href="#test-vnode-patchflag">测试-&gt;</a>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">patchFlag</span> <span class="o">=</span>
   <span class="nx">extraProps</span> <span class="o">&amp;&amp;</span> <span class="nx">vnode</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">Fragment</span>
     <span class="o">?</span> <span class="nx">patchFlag</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// hoisted node
</span><span class="c1"></span>       <span class="o">?</span> <span class="nx">PatchFlags.FULL_PROPS</span>
       : <span class="kt">patchFlag</span> <span class="o">|</span> <span class="nx">PatchFlags.FULL_PROPS</span>
     : <span class="kt">patchFlag</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>ssContent 递归调用 <code>cloneVNode(vnode.ssContent)</code></p>
</li>
<li>
<p>ssFallback 递归调用 <code>cloneVNode(vnode.ssFallback)</code></p>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">node1</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="kc">null</span> <span class="cm">/* children */</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; vnode 1\n&#34;</span><span class="p">,</span> <span class="nx">node1</span><span class="p">]);</span>

<span class="kr">const</span> <span class="nx">node2</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">h</span><span class="p">({},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">node1</span><span class="p">]);</span>
<span class="kr">const</span> <span class="nx">cloned2</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">node2</span><span class="p">);</span>
<span class="c1">// cloneVNode 只是一次浅拷贝
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; node2 == cloned2\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned2</span><span class="p">),</span> <span class="s2">&#34;\n &gt; node2 \n&#34;</span><span class="p">,</span> <span class="nx">node2</span><span class="p">]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; vnode 1
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: { foo: 1 },
  shapeFlag: 1
}
&gt;&gt;&gt; node2 == cloned2
 {
  __v_isVNode: true,
  __v_skip: true,
  type: {},
  children: [
    {
      __v_isVNode: true,
      __v_skip: true,
      type: &#39;div&#39;,
      props: [Object],
      shapeFlag: 1
    }
  ],
  shapeFlag: 20
}
 &gt; node2
 {
  __v_isVNode: true,
  __v_skip: true,
  type: {},
  children: [
    {
      __v_isVNode: true,
      __v_skip: true,
      type: &#39;div&#39;,
      props: [Object],
      shapeFlag: 1
    }
  ],
  shapeFlag: 20
}
undefined
</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/4fbd98f4be00f3fdfcb14839d29ed4a5f45a179c">feat(add): rc-&gt;createVNode, currentRenderingInstance · gcclll/stb-vue-next@4fbd98f · GitHub</a></p>
<div id="outline-container-test-vnode-key" class="outline-4">
<h4 id="test-vnode-key">
key test
</h4>
<div id="outline-text-test-vnode-key" class="outline-text-4">
<p>
vnode.key 的 clone 操作，属于单纯的值覆盖操作。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 保留 vnode.key 值\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cv</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})),</span> <span class="s2">&#34;key&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span>
  <span class="s2">&#34;&gt;&gt;&gt; 替换 vnode.key 值\n&#34;</span><span class="p">,</span>
  <span class="nx">f</span><span class="p">(</span><span class="nx">cv</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}),</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}),</span> <span class="s2">&#34;key&#34;</span><span class="p">),</span>
<span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 新 props.key 值\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cv</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">),</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}),</span> <span class="s2">&#34;key&#34;</span><span class="p">)]);</span>

<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; 测试 vnode.key 各种情况值&#34;</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">of</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">NaN</span><span class="p">])</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span> <span class="p">}),</span> <span class="s2">&#34;key&#34;</span><span class="p">));</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 保留 vnode.key 值
 { key: 1 }
&gt;&gt;&gt; 替换 vnode.key 值
 { key: 2 }
&gt;&gt;&gt; 新 props.key 值
 { key: 2 }
&gt;&gt;&gt; 测试 vnode.key 各种情况值
{}
{ key: &#39;a&#39; }
{}
{ key: 1 }
[Vue warn]: VNode created with invalid key (NaN). VNode type:div
{}
undefined
</pre>
</div>
</div>
<div id="outline-container-test-vnode-ref" class="outline-4">
<h4 id="test-vnode-ref">
ref test
</h4>
<div id="outline-text-test-vnode-ref" class="outline-text-4">
<p>
流程脑图：
<img src="/img/vue3/runtime-core/vue-runtime-core-vnode-ref.svg" alt="/img/vue3/runtime-core/vue-runtime-core-vnode-ref.svg" title="/img/vue3/runtime-core/vue-runtime-core-vnode-ref.svg" /></p>
<p>
测试</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span>
    <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span>
    <span class="nx">ssrUtils</span><span class="o">:</span> <span class="p">{</span> <span class="nx">setCurrentRenderingInstance</span><span class="o">:</span> <span class="nx">s</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">mockIns1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">ins</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="nx">mockIns2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">ins</span><span class="o">:</span> <span class="mi">2</span> <span class="p">};</span>
<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns1</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">});</span>
<span class="c1">// 本身没有的时候会将 extraProps.ref 作为新的 vnode.ref 值
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 1. vnode 本身无 ref\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">cloned1</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 2. 保留原有的 vnode.ref\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="c1">// 这里没指定 mergeProp 所以会替换原来的
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cloned2</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">});</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; 3. ref: &#34;bar&#34; 替换原有的 vnode.ref\n&#39;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned2</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">original2</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">cloned3</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original2</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">});</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 4. 没有 vnode.ref 情况，新增 ref\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned3</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>

<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns2</span><span class="p">);</span>
<span class="c1">// 应该保留原有的 context instance
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cloned4</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 5. 应该保留原有的 context instance\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned4</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="c1">// ref 覆盖，使用新的 context instance: mockIns2
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cloned5</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">});</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; 6. ref 改变，使用新的 context instance\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned5</span><span class="p">,</span> <span class="s2">&#34;ref&#34;</span><span class="p">)]);</span>
<span class="nx">s</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span> <span class="c1">// 置空 context instance
</span><span class="c1"></span>
<span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n\n// mergeRef 情况测试\n&#39;</span><span class="p">)</span>
<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns1</span><span class="p">)</span>
<span class="nx">original</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">})</span>
<span class="nx">s</span><span class="p">(</span><span class="nx">mockIns2</span><span class="p">)</span>
<span class="nx">cloned1</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ref</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span> <span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; mergeRef: true 合并 vnode.ref\n&#39;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">)])</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">.</span><span class="nx">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">cloned1</span><span class="p">.</span><span class="nx">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 1. vnode 本身无 ref
 { ref: { i: { ins: 1 }, r: &#39;foo&#39; } }
&gt;&gt;&gt; 2. 保留原有的 vnode.ref
 { ref: { i: { ins: 1 }, r: &#39;foo&#39; } }
&gt;&gt;&gt; 3. ref: &#34;bar&#34; 替换原有的 vnode.ref
 { ref: { i: { ins: 1 }, r: &#39;bar&#39; } }
&gt;&gt;&gt; 4. 没有 vnode.ref 情况，新增 ref
 { ref: { i: { ins: 1 }, r: &#39;bar&#39; } }
&gt;&gt;&gt; 5. 应该保留原有的 context instance
 { ref: { i: { ins: 1 }, r: &#39;foo&#39; } }
&gt;&gt;&gt; 6. ref 改变，使用新的 context instance
 { ref: { i: { ins: 2 }, r: &#39;bar&#39; } }


// mergeRef 情况测试

&gt;&gt;&gt; mergeRef: true 合并 vnode.ref
 { ref: [ { i: [Object], r: &#39;foo&#39; }, { i: [Object], r: &#39;bar&#39; } ] }
{ i: { ins: 1 }, r: &#39;foo&#39; }
{ i: { ins: 2 }, r: &#39;bar&#39; }
undefined
</pre>
</div>
</div>
<div id="outline-container-test-vnode-patchflag" class="outline-4">
<h4 id="test-vnode-patchflag">
<span class="todo">TODO</span>
patchFlag test
</h4>
<div id="outline-text-test-vnode-patchflag" class="outline-text-4">
<p>
TODO need openBlock&amp;createBlock support.</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span>
    <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span>
    <span class="nx">ssrUtils</span><span class="o">:</span> <span class="p">{</span> <span class="nx">setCurrentRenderingInstance</span><span class="o">:</span> <span class="nx">s</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">hoist</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span> <span class="c1">// 静态节点
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">vnode1</span>
<span class="kr">const</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="nx">createBlock</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
shapeFlag test
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span> <span class="nx">Text</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; ELEMENT\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">),</span> <span class="s2">&#34;shapeFlag&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; STATEFUL_COMONENT\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">({}),</span> <span class="s2">&#34;shapeFlag&#34;</span><span class="p">)]);</span>
<span class="nx">log</span><span class="p">([</span>
  <span class="s2">&#34;&gt;&gt;&gt; FUNCTION_COMONENT\n&#34;</span><span class="p">,</span>
  <span class="nx">f</span><span class="p">(</span>
    <span class="nx">c</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{}),</span>
    <span class="s2">&#34;shapeFlag&#34;</span>
  <span class="p">),</span>
<span class="p">]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; Text\n&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="nx">Text</span><span class="p">),</span> <span class="s2">&#34;shapeFlag&#34;</span><span class="p">)]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; ELEMENT
 { shapeFlag: 1 }
&gt;&gt;&gt; STATEFUL_COMONENT
 { shapeFlag: 4 }
&gt;&gt;&gt; FUNCTION_COMONENT
 { shapeFlag: 2 }
&gt;&gt;&gt; Text
 { shapeFlag: 0 }
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-13" class="outline-4">
<h4 id="headline-13">
mergeProps test
</h4>
<div id="outline-text-headline-13" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">mergeProps</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="s2">&#34;c&#34;</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;cc&#34;</span><span class="p">]</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">p3</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">ccc</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}]</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">p4</span> <span class="o">=</span> <span class="p">{</span> <span class="kr">class</span><span class="o">:</span> <span class="p">{</span> <span class="nx">cccc</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">};</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; merge class\n&#34;</span><span class="p">,</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">,</span> <span class="nx">p4</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">ps1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&#34;red&#34;</span><span class="p">,</span> <span class="nx">fontSize</span><span class="o">:</span> <span class="mi">10</span> <span class="p">},</span>
<span class="p">};</span>
<span class="kd">let</span> <span class="nx">ps2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">style</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&#34;blue&#34;</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="s2">&#34;200px&#34;</span> <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span> <span class="s2">&#34;300px&#34;</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="s2">&#34;300px&#34;</span><span class="p">,</span>
      <span class="nx">fontSize</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">],</span>
<span class="p">};</span>
<span class="kd">let</span> <span class="nx">ps3</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;width:100px;right:10;top:10&#39;</span> <span class="p">}</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; merge style\n&#34;</span><span class="p">,</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">ps1</span><span class="p">,</span> <span class="nx">ps2</span><span class="p">,</span> <span class="nx">ps3</span><span class="p">)]);</span>
<span class="kd">let</span> <span class="nx">clickHandler1</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>
<span class="kd">let</span> <span class="nx">clickHandler2</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>
<span class="kd">let</span> <span class="nx">focusHandler3</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>
<span class="kd">let</span> <span class="nx">ph1</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">clickHandler1</span> <span class="p">}</span>
<span class="kd">let</span> <span class="nx">ph2</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">clickHandler2</span><span class="p">,</span> <span class="nx">onFocus</span><span class="o">:</span> <span class="nx">focusHandler3</span> <span class="p">}</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; merge handlers\n&#39;</span><span class="p">,</span> <span class="nx">mergeProps</span><span class="p">(</span><span class="nx">ph1</span><span class="p">,</span> <span class="nx">ph2</span><span class="p">)])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; merge class
 { class: &#39;c cc ccc cccc&#39; }
&gt;&gt;&gt; merge style
 {
  style: {
    color: &#39;blue&#39;,
    fontSize: 30,
    width: &#39;100px&#39;,
    height: &#39;300px&#39;,
    right: &#39;10&#39;,
    top: &#39;10&#39;
  }
}
&gt;&gt;&gt; merge handlers
 {
  onClick: [ [Function: clickHandler1], [Function: clickHandler2] ],
  onFocus: [Function: focusHandler3]
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-14" class="outline-4">
<h4 id="headline-14">
<span class="todo">TODO</span>
dynamic children test
</h4>
<div id="outline-text-headline-14" class="outline-text-4">
<p>
&gt; need openBlock&amp;createBlock support</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">cloneVNode</span><span class="o">:</span> <span class="nx">cv</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">mergeProps</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">hoist</span> <span class="o">=</span> <span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">vnode1</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-15" class="outline-4">
<h4 id="headline-15">
<span class="todo">TODO</span>
transformVNodeArgs test
</h4>
</div>
</div>
</div>
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
<span class="todo">TODO</span>
7ec1d30 suspense component
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7ec1d3053a5881d476e535923edce07f36fe77f0">feat(add): rc-&gt;createVNode, type is suspense component · gcclll/stb-vue-next@7ec1d30 · GitHub</a></p>
<p>
Suspense 的 children 必须有且只有一个根节点。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="c1">// 7. normalize suspense children
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_SUSPENSE__</span> <span class="o">&amp;&amp;</span> <span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SUSPENSE</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">fallback</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">normalizeSuspenseChildren</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
    <span class="nx">vnode</span><span class="p">.</span><span class="nx">ssContent</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
    <span class="nx">vnode</span><span class="p">.</span><span class="nx">ssFallback</span> <span class="o">=</span> <span class="nx">fallback</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// normalizeSuspenseChildren
</span><span class="c1"></span>  <span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeSuspenseChildren</span><span class="p">(</span>
    <span class="nx">vnode</span>: <span class="kt">VNode</span>
  <span class="p">)</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">content</span>: <span class="kt">VNode</span><span class="p">;</span>
    <span class="nx">fallback</span>: <span class="kt">VNode</span><span class="p">;</span>
  <span class="p">}</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">shapeFlag</span><span class="p">,</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">content</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">fallback</span>: <span class="kt">VNode</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">((</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">Slots</span><span class="p">).</span><span class="k">default</span><span class="p">);</span>
      <span class="nx">fallback</span> <span class="o">=</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">((</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">Slots</span><span class="p">).</span><span class="nx">fallback</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNodeChild</span><span class="p">);</span>
      <span class="nx">fallback</span> <span class="o">=</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">content</span><span class="p">,</span>
      <span class="nx">fallback</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">}</span>

<span class="c1">// &gt;&gt;&gt; normalizeSuspenseSlot
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">normalizeSuspenseSlot</span><span class="p">(</span><span class="nx">s</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ROOT 必须是单节点 &lt;div&gt;...&lt;/div&gt;
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">singleChild</span> <span class="o">=</span> <span class="nx">filterSingleRoot</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">singleChild</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="sb">`&lt;Suspense&gt; slots expect a single root node.`</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">singleChild</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// normalizeVNode
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeVNode</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">VNodeChild</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">child</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">child</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// empty placeholder
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Comment</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// fragment
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Fragment</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">child</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// already vnode, this should be the most common since compiled templates
</span><span class="c1"></span>    <span class="c1">// always produce all-vnode children arrays
</span><span class="c1"></span>    <span class="c1">// 这是最常用的情况，因为使用模板的时候最后生成的 children 是数组
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">child</span><span class="p">.</span><span class="nx">el</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">child</span> : <span class="kt">cloneVNode</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// strings and numbers
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
检测是不是 single root 函数： <code>filterSingleRoot</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">filterSingleRoot</span><span class="p">(</span>
  <span class="nx">children</span>: <span class="kt">VNodeArrayChildren</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">singleRoot</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isVNode</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// ignore user comment
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">Comment</span> <span class="o">||</span> <span class="nx">child</span><span class="p">.</span><span class="nx">children</span> <span class="o">===</span> <span class="s2">&#34;v-if&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">singleRoot</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// has more than 1 non-comment child, return now
</span><span class="c1"></span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">singleRoot</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">singleRoot</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-vnode-currentBlock" class="outline-3">
<h3 id="vnode-currentBlock">
<span class="todo">TODO</span>
23fc943 currentBlock 优化
</h3>
<div id="outline-text-vnode-currentBlock" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/23fc9437e9fba7bb562f79a51410ef59e6b82f8c">feat(add): rc-&gt;createVNode, optimize diff, currentBlock ·
gcclll/stb-vue-next@23fc943 · GitHub</a></p>
<blockquote>
<p>这里的处理没怎么搞明白❓</p>
</blockquote>
<p>
注意这里增加的几个变量‼</p>
<p>
blockStack, currentBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="c1">// Since v-if and v-for are the two possible ways node structure can dynamically
</span><span class="c1">// change, once we consider v-if branches and each v-for fragment a block, we
</span><span class="c1">// can divide a template into nested blocks, and within each block the node
</span><span class="c1">// structure would be stable. This allows us to skip most children diffing
</span><span class="c1">// and only worry about the dynamic nodes (indicated by patch flags).
</span><span class="c1">// 针对 v-if, v-for 动态性做的由于，减少对静态节点的 diff ，只需要关心动态节点即可
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">blockStack</span><span class="o">:</span> <span class="p">(</span><span class="nx">VNode</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)[]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kd">let</span> <span class="nx">currentBlock</span>: <span class="kt">VNode</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
shouldTrack:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Whether we should be tracking dynamic child nodes inside a block.
</span><span class="c1">// Only tracks when this value is &gt; 0
</span><span class="c1">// We are not using a simple boolean because this value may need to be
</span><span class="c1">// incremented/decremented by nested usage of v-once (see below)
</span><span class="c1">// 是否应该 tracking block 内动态的孩子节点
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">shouldTrack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
新增处理逻辑：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 8. currentBlock
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span>
   <span class="nx">shouldTrack</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// 避免 block 节点 tracking 自己
</span><span class="c1"></span>   <span class="o">!</span><span class="nx">isBlockNode</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// has current parent block
</span><span class="c1"></span>   <span class="nx">currentBlock</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// presence of a patch flag indicates this node needs patching on updates.
</span><span class="c1"></span>   <span class="c1">// component nodes also should always be patched, because even if the
</span><span class="c1"></span>   <span class="c1">// component doesn&#39;t need to update, it needs to persist the instance on to
</span><span class="c1"></span>   <span class="c1">// the next vnode so that it can be properly unmounted later.
</span><span class="c1"></span>   <span class="p">(</span><span class="nx">patchFlag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">COMPONENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
   <span class="c1">// the EVENTS flag is only for hydration and if it is the only flag, the
</span><span class="c1"></span>   <span class="c1">// vnode should not be considered dynamic due to handler caching.
</span><span class="c1"></span>   <span class="nx">patchFlag</span> <span class="o">!==</span> <span class="nx">PatchFlags</span><span class="p">.</span><span class="nx">HYDRATE_EVENTS</span>
 <span class="p">)</span> <span class="p">{</span>
   <span class="nx">currentBlock</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
跟这几个变量有关的函数：</p>
</div>
</div>
<div id="outline-container-block-related" class="outline-3">
<h3 id="block-related">
<span class="todo">TODO</span>
block related(open/close/create)
</h3>
<div id="outline-text-block-related" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a2afc70cc89fc0bb7c1b1f6810bea73ab4e40c82">feat(add): rc-&gt;block related, open/create/closeBlock · gcclll/stb-vue-next@a2afc70 · GitHub</a></p>
<p>
这里的所有函数都和 <a href="#vnode-currentBlock">createVNode 里面的 currentBlock</a> 有关。</p>
<p>
openBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> ,* Open a block.
</span><span class="cm"> ,* This must be called before `createBlock`. It cannot be part of `createBlock`
</span><span class="cm"> ,* because the children of the block are evaluated before `createBlock` itself
</span><span class="cm"> ,* is called. The generated code typically looks like this:
</span><span class="cm"> ,*
</span><span class="cm"> ,* ```js
</span><span class="cm"> ,* function render() {
</span><span class="cm"> ,*   return (openBlock(),createBlock(&#39;div&#39;, null, [...]))
</span><span class="cm"> ,* }
</span><span class="cm"> ,* ```
</span><span class="cm"> ,* disableTracking is true when creating a v-for fragment block, since a v-for
</span><span class="cm"> ,* fragment always diffs its children.
</span><span class="cm"> ,*
</span><span class="cm"> ,* @private
</span><span class="cm"> ,*/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">openBlock</span><span class="p">(</span><span class="nx">disableTracking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">blockStack</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="nx">currentBlock</span> <span class="o">=</span> <span class="nx">disableTracking</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">[]));</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
closeBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">closeBlock() {</span>
  <span class="nx">blockStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  <span class="nx">currentBlock</span> <span class="o">=</span> <span class="nx">blockStack</span><span class="p">[</span><span class="nx">blockStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
setBlockTracking:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> * Block tracking sometimes needs to be disabled, for example during the
</span><span class="cm"> * creation of a tree that needs to be cached by v-once. The compiler generates
</span><span class="cm"> * code like this:
</span><span class="cm"> *
</span><span class="cm"> * ``` js
</span><span class="cm"> * _cache[1] || (
</span><span class="cm"> *   setBlockTracking(-1),
</span><span class="cm"> *   _cache[1] = createVNode(...),
</span><span class="cm"> *   setBlockTracking(1),
</span><span class="cm"> *   _cache[1]
</span><span class="cm"> * )
</span><span class="cm"> * ```
</span><span class="cm"> *
</span><span class="cm"> * @private
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">setBlockTracking</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">shouldTrack</span> <span class="o">+=</span> <span class="nx">value</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
createBlock:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm"> * Create a block root vnode. Takes the same exact arguments as `createVNode`.
</span><span class="cm"> * A block root keeps track of dynamic nodes within the block in the
</span><span class="cm"> * `dynamicChildren` array.
</span><span class="cm"> *
</span><span class="cm"> * @private
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">createBlock</span><span class="p">(</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">VNodeTypes</span> <span class="o">|</span> <span class="nx">ClassComponent</span><span class="p">,</span>
  <span class="nx">props?</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">children?</span>: <span class="kt">any</span><span class="p">,</span>
  <span class="nx">patchFlag?</span>: <span class="kt">number</span><span class="p">,</span>
  <span class="nx">dynamicProps?</span>: <span class="kt">string</span><span class="p">[]</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="nx">createVNode</span><span class="p">(</span>
    <span class="kr">type</span><span class="p">,</span>
    <span class="nx">props</span><span class="p">,</span>
    <span class="nx">children</span><span class="p">,</span>
    <span class="nx">patchFlag</span><span class="p">,</span>
    <span class="nx">dynamicProps</span><span class="p">,</span>
    <span class="kc">true</span> <span class="cm">/* isBlock: prevent a block from tracking itself */</span>
  <span class="p">);</span>
  <span class="c1">// save current block children on the block vnode
</span><span class="c1"></span>  <span class="nx">vnode</span><span class="p">.</span><span class="nx">dynamicChildren</span> <span class="o">=</span> <span class="nx">currentBlock</span> <span class="o">||</span> <span class="p">(</span><span class="nx">EMPTY_ARR</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">);</span>
  <span class="c1">// close block
</span><span class="c1"></span>  <span class="nx">closeBlock</span><span class="p">();</span>
  <span class="c1">// a block is always going to be patched, so track it as a child of its
</span><span class="c1"></span>  <span class="c1">// parent block
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">shouldTrack</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">currentBlock</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currentBlock</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vnode</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">vnode</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
相关脑图：
<img src="/img/vue3/runtime-core/vue-runtime-core-block-shouldtrack.svg" alt="/img/vue3/runtime-core/vue-runtime-core-block-shouldtrack.svg" title="/img/vue3/runtime-core/vue-runtime-core-block-shouldtrack.svg" /></p>
</div>
</div>
<div id="outline-container-normalize-children" class="outline-3">
<h3 id="normalize-children">
normalizeChildren function
</h3>
<div id="outline-text-normalize-children" class="outline-text-3">
<p>
shapeFlag 初始值检测：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// encode the vnode type information into a bitmap
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">shapeFlag</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="c1">// 1
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">__FEATURE_SUSPENSE__</span> <span class="o">&amp;&amp;</span> <span class="nx">isSuspense</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SUSPENSE</span> <span class="c1">// 1 &lt;&lt; 7, 128
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">isTeleport</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TELEPORT</span> <span class="c1">// 1 &lt;&lt; 6, 64
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">isObject</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">STATEFUL_COMPONENT</span> <span class="c1">// 1 &lt;&lt; 2, 4
</span><span class="c1"></span>  <span class="o">:</span> <span class="nx">isFunction</span><span class="p">(</span><span class="kr">type</span><span class="p">)</span>
  <span class="o">?</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">FUNCTIONAL_COMPONENT</span> <span class="c1">// 1 &lt;&lt; 1, 2
</span><span class="c1"></span>  <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">))</span>

<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; only tag\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; tag + props\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">})])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; tag + props + children\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">])])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; only tag
 { __v_isVNode: true, __v_skip: true, type: &#39;p&#39;, shapeFlag: 1 }
&gt;&gt;&gt; tag + props
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;p&#39;,
  props: { foo: &#39;foo&#39; },
  shapeFlag: 1
}
&gt;&gt;&gt; tag + props + children
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;p&#39;,
  props: { foo: &#39;foo&#39; },
  children: [ &#39;foo&#39; ],
  shapeFlag: 17
}
undefined
</pre>
<div id="outline-container-headline-20" class="outline-4">
<h4 id="headline-20">
children is function
</h4>
<div id="outline-text-headline-20" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/28d4a55250c6f02264bbb77ca04a87770d358c7c">feat(add): rc-&gt;propsOrChildren is function · gcclll/stb-vue-next@28d4a55 · GitHub</a></p>
<p>
如果是函数，当做 slot 的 children 处理。</p>
<p>
normalizeChildren:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">normalizeChildren</span><span class="p">(</span><span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">,</span> <span class="nx">children</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="kr">type</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">children</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*array*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*object*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 如果是函数当做 slot children ?
</span><span class="c1"></span>    <span class="nx">children</span> <span class="o">=</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">_ctx</span>: <span class="kt">currentRenderingInstance</span> <span class="p">}</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">SLOTS_CHILDREN</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// TODO 普通类型
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">children</span> <span class="kr">as</span> <span class="nx">VNodeNormalizedChildren</span>
  <span class="nx">vnode</span><span class="p">.</span><span class="nx">shapeFlag</span> <span class="o">|=</span> <span class="kr">type</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span><span class="nx">c</span> <span class="p">},</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">f</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">h</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">c</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">Component</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;br /&gt;&#39;</span> <span class="p">}</span>
<span class="kr">const</span> <span class="nx">slot</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{}</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; default slot\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="nx">Component</span><span class="p">,</span> <span class="nx">slot</span><span class="p">)])</span>
<span class="nx">log</span><span class="p">([</span><span class="s1">&#39;&gt;&gt;&gt; children is function\n&#39;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">slot</span><span class="p">)])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; default slot
 {
  __v_isVNode: true,
  __v_skip: true,
  type: { template: &#39;&lt;br /&gt;&#39; },
  children: { default: [Function: slot], _ctx: null },
  shapeFlag: 36
}
&gt;&gt;&gt; children is function
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  props: {},
  children: { default: [Function: slot], _ctx: null },
  shapeFlag: 33
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-21" class="outline-4">
<h4 id="headline-21">
children is array or 普通类型
</h4>
<div id="outline-text-headline-21" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/850c0bc0d8b74e1b88d2158df505c83cb9a71408">feat(add): rc-&gt;createVNode, children is array or primitive ·
gcclll/stb-vue-next@850c0bc · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 数组类型
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">children</span><span class="p">))</span> <span class="p">{</span>
  <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 非对象，数组，函数的普通类型处理
</span><span class="c1"></span><span class="p">{</span>
  <span class="nx">children</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">children</span><span class="p">);</span>
  <span class="c1">// force teleport children to array so it can be moved around
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">shapeFlag</span> <span class="o">&amp;</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TELEPORT</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">ARRAY_CHILDREN</span><span class="p">;</span>
    <span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="nx">children</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">)];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kr">type</span> <span class="o">=</span> <span class="nx">ShapeFlags</span><span class="p">.</span><span class="nx">TEXT_CHILDREN</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// createTextVNode
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createTextVNode</span><span class="p">(</span><span class="nx">text</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="nx">flag</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">:</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">Text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">Text</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">(</span><span class="nx">__DEV__</span> <span class="o">?</span> <span class="s1">&#39;Text&#39;</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
普通类型处理中如果是 <code>ShapeFlags.TELETPORT</code> 当做 <code>ARRAY_CHILDREN</code> 处理，且
children 按照文本节点处理。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">h</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">c</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="nx">log</span><span class="p">([</span><span class="sb">`&gt;&gt;&gt; array will be children(</span><span class="si">${</span><span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="sb">)\n`</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">])]);</span>
<span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; string will be children()\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="s2">&#34;foo&#34;</span><span class="p">)]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; array will be children(17)
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  children: [ &#39;foo&#39; ],
  shapeFlag: 17
}
&gt;&gt;&gt; string will be children()
 {
  __v_isVNode: true,
  __v_skip: true,
  type: &#39;div&#39;,
  children: &#39;foo&#39;,
  shapeFlag: 9
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-22" class="outline-4">
<h4 id="headline-22">
children is object
</h4>
<div id="outline-text-headline-22" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/959879e825fb225b39c7fb219ec7e46feb6c7537">feat(add): rc-&gt;createVNode, normalizeChildren is object · gcclll/stb-vue-next@959879e · GitHub</a></p>
<p>
shapeFlag 可能是 <code>ShapeFlags.ELEMENT</code> 或者 <code>ShapeFalgs.TELEPORT</code> 。</p>
<p>
这里先测试 ELEMENT 情况，因为 TELEPORT 还需要实现 components/Teleport 。</p>
<p>
如果 type 是 对象， shapeFlag 初始类型会是 <code>ShapeFlags.STATEFULL_COMPONENT, 1 &lt;&lt;
2</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">h</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">c</span><span class="p">(...</span><span class="nx">args</span><span class="p">));</span>

<span class="c1">// 因为 type = {} , shapeFlag = 1 &lt;&lt; 2, 4
</span><span class="c1">// 所以在 normalizeChildren 里面 isObject 分支会进入 else
</span><span class="c1">// 进行处理，经过处理之后成为 4 | SLOTS_CHILDREN,2&lt;&lt;5,32 = 36
</span><span class="c1"></span><span class="nx">log</span><span class="p">([</span><span class="s2">&#34;&gt;&gt;&gt; object\n&#34;</span><span class="p">,</span> <span class="mi">_</span><span class="nx">h</span><span class="p">({},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">})]);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; object
 {
  __v_isVNode: true,
  __v_skip: true,
  type: {},
  children: { foo: &#39;foo&#39;, _ctx: null },
  shapeFlag: 36
}
undefined
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-api-watch" class="outline-2">
<h2 id="api-watch">
⏱ api watch(source, cb, options)
</h2>
<div id="outline-text-api-watch" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/4f0301ea5d7839e8ce5274ea170dd09bd129f5ee">feat(add): api watch TODOs · gcclll/stb-vue-next@4f0301e · GitHub</a></p>
<p>
脑图：
<img src="/img/vue3/runtime-core/vue-runtime-core-api-watch.svg" alt="/img/vue3/runtime-core/vue-runtime-core-api-watch.svg" title="/img/vue3/runtime-core/vue-runtime-core-api-watch.svg" /></p>
<blockquote>
<p>为了更好的完成 apiWatch， 需要先完成了 <a href="#scheduler">scheduler</a> 任务调度部分。</p>
</blockquote>
<p>
<code>watch(source, cb, options)</code> 函数以下种使用方式(下面的 cb 均可选参数)：</p>
<ol>
<li>
<p><code>watch(fn)</code> 等价于 <code>watchEffect(fn)</code>, 无 cb</p>
</li>
<li>
<p><code>watch(fn, cb)</code> 监听函数</p>
</li>
<li>
<p><code>watch(ref(0), cb)</code></p>
</li>
<li>
<p><code>watch(reactive({ count: 0}), cb)</code> , reactive 对象默认 <code>deep = true</code></p>
</li>
<li>
<p><code>watch([ref(0), reactive({count: 0})], cb)</code></p>
</li>
<li>
<p><code>watch(fn, cb, { immediate: true })</code> 此时， cb 必须为函数， job-&gt;fn 被立即执
行一次， cb 接受新旧值</p>
</li>
<li>
<p><code>watch(ref({ count: 0}), cb, { deep: true })</code> 手动指定 <code>deep: true</code> 深度监听</p>
</li>
<li>
<p>…</p>
</li>
</ol>
<p>执行具体实现的函数： <code>doWatch()</code></p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>value</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>source</td>
<td>WatchSource, WatchSource[], WatchEffect, object</td>
<td>object watched</td>
</tr>
<tr>
<td>cb</td>
<td>WatchCallback or null</td>
<td>callback</td>
</tr>
</tbody>
<tbody>
<tr>
<td>options</td>
<td>WatchOptions = EMPTY_OBJ</td>
<td></td>
</tr>
<tr>
<td></td>
<td>immediate</td>
<td></td>
</tr>
<tr>
<td></td>
<td>deep</td>
<td></td>
</tr>
<tr>
<td></td>
<td>flush</td>
<td></td>
</tr>
<tr>
<td></td>
<td>onTrack</td>
<td></td>
</tr>
<tr>
<td></td>
<td>onTrigger</td>
<td></td>
</tr>
</tbody>
<tbody>
<tr>
<td>instance</td>
<td>currentInstance</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p><code>watch(source, cb, options?)</code> 函数中的 cb 是必选项，如果想直接 watch effect，可使
用 <code>watchEffect(fn, options?)</code> api 。</p>
</blockquote>
<p>
watch 函数基本流程：</p>
<ol>
<li>
<p>cb, immediate, deep 检测</p>
</li>
<li>
<p>getter， 根据 source 不同类型设置 getter</p>
</li>
<li>
<p>cb + deep: true</p>
</li>
<li>
<p>SSR node env</p>
</li>
<li>
<p>将 cb 封装成 job</p>
</li>
<li>
<p><code>runner = effect(getter, option)</code></p>
</li>
<li>
<p>runner 如何执行？</p>
</li>
<li>
<p>stop, remove，函数返回一个 stop+remove 该 runner 操作的函数</p>
</li>
</ol>
<p>
下面章节中测试的用例分析脑图：
<img src="/img/vue3/runtime-core/vue-runtime-core-api-watch-tests.svg" alt="/img/vue3/runtime-core/vue-runtime-core-api-watch-tests.svg" title="/img/vue3/runtime-core/vue-runtime-core-api-watch-tests.svg" /></p>
<div id="outline-container-headline-24" class="outline-3">
<h3 id="headline-24">
source is ref
</h3>
<div id="outline-text-headline-24" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b9b7ac6aa908cc375d698fd5762e0ff9a52dbcc5">feat(add): apiWatch-&gt;no cb, getter is ref · gcclll/stb-vue-next@b9b7ac6 · GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/67523262e127d72237f50e3c437210cc5c2e3d76">fix: watch-&gt;source is ref, cb -&gt; job · gcclll/stb-vue-next@6752326 · GitHub</a>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">prevCount</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\nvalue changed: &#34;</span> <span class="o">+</span> <span class="nx">i</span><span class="o">++</span><span class="p">);</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">prevCount</span><span class="p">];</span>
    <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">prevCount</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">prevCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
value changed: 0
1 0
</pre>
<p>
有关代码(doWatch):</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// -&gt; getter
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">getter</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kt">any</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">forceTrigger</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="c1">// 2.1 source is ref
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">source</span> <span class="kr">as</span> <span class="nx">Ref</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
  <span class="nx">forceTrigger</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="nx">source</span> <span class="kr">as</span> <span class="nx">Ref</span><span class="p">).</span><span class="nx">_shallow</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// cb -&gt; job 封装
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nx">INITIAL_WATCHER_VALUE</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">job</span>: <span class="kt">SchedulerJob</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// watch(source, cb)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">||</span> <span class="nx">forceTrigger</span> <span class="o">||</span> <span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// cleanup
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="nx">callWithAsyncErrorHandling</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CALLBACK</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">newValue</span><span class="p">,</span>
        <span class="c1">// pass undefined as the old value when it&#39;s changed for the first time
</span><span class="c1"></span>        <span class="c1">// 第一次的时候 oldValue 为 undefined
</span><span class="c1"></span>        <span class="nx">oldValue</span> <span class="o">===</span> <span class="nx">INITIAL_WATCHER_VALUE</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">oldValue</span><span class="p">,</span>
        <span class="nx">onInvalidate</span><span class="p">,</span>
      <span class="p">]);</span>
      <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// scheduler 封装
</span><span class="c1"></span><span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span> <span class="o">||</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// 什么方式执行 runner?
</span><span class="c1">// 8. TODO runner 如何执行？
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">immediate</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*flush-&gt;post*/</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">runner</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-25" class="outline-3">
<h3 id="headline-25">
source is reactive
</h3>
<div id="outline-text-headline-25" class="outline-text-3">
<p>
如果要 watch 的对象是个 reactive ，需要进行递归 watch ，得到 getter.</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/697f7f25d2bdafdda09a76ee8b00c949e61d6acb">fix: watch-&gt;source is reactive · gcclll/stb-vue-next@697f7f2 · GitHub</a></p>
<p>
新增相关代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 1. 如果是 reactive，需要深度监听
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">source</span><span class="p">;</span>
  <span class="nx">deep</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 2. deep: true
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">deep</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">baseGetter</span> <span class="o">=</span> <span class="nx">getter</span><span class="p">;</span>
  <span class="c1">// a. deep: true
</span><span class="c1"></span>  <span class="c1">// b. source is reactive
</span><span class="c1"></span>  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">baseGetter</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// traverse 函数
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">seen</span>: <span class="kt">Set</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="p">&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">seen</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">seen</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">seen</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">seen</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isSet</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isMap</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">v</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">traverse</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">seen</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">traverse</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">seen</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
递归监听 reactive 对象任意层级上的属性变化。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">watch</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">r1</span><span class="o">:</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">10</span> <span class="p">}</span> <span class="p">});</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">preVal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">preVal</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">r1</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">)</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

{ count: 1, r1: { count: 10 } } { count: 1, r1: { count: 10 } }


{ count: 1, r1: { count: 9 } } { count: 1, r1: { count: 9 } }
</pre>
<blockquote>
<p><strong>注意</strong>: newVal 和 preVal 返回的是整个 state 而非当前所发生变更的属性
(count/r1.count)，因为在 job 里面执行  runner() 得到新值是在
traverse(baseGetter()) 之前发生的，此时取到的值是 state 自身。</p>
</blockquote>
<p>
<img src="/img/tmp/20210115141244.png" alt="/img/tmp/20210115141244.png" title="/img/tmp/20210115141244.png" /></p>
</div>
</div>
<div id="outline-container-watch-array" class="outline-3">
<h3 id="watch-array">
soure is array
</h3>
<div id="outline-text-watch-array" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/af1e590b3bb528f8fb9db4a06ead3978426130c1">feat(add): apiWatch-&gt;source is array · gcclll/stb-vue-next@af1e590 · GitHub</a></p>
<p>
如果要监听的对象是个数组的时候，需要检测数组元素的类型，针对不同类型进行处理。</p>
<p>
要点：</p>
<ol>
<li>
<p>数组元素不能是除 ref/reactive/function 之外的类型</p>
</li>
<li>
<p>对数组元素设值时必须通过元素原始设值方式进行(比如： ref 要 <code>ref.value = xxx</code>)，
因为该数组本身不是 reactive 的</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span>
    <span class="nx">source</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isRef</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isReactive</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_GETTER</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// TODO warn invalid source
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>isRef -&gt; 监听 item.value</p>
</li>
<li>
<p>isReactive -&gt; traverse(item) 递归</p>
</li>
<li>
<p>isFunction -&gt; callWithErrorHandling(item, instance, …) 监听函数返回值</p>
</li>
<li>
<p>其他类型不支持 -&gt; warn invalid source</p>
</li>
</ol>
<p>测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">array</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([]);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">(</span><span class="nx">newArr</span><span class="p">,</span> <span class="nx">preArr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">newArr</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

[ 1 ]

</pre>
<p>
数组混合模式(元素只支持 ref, reactive, function)：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">effect</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
  <span class="nx">val</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">});</span>
<span class="nx">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&#34;---&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
  <span class="kr">const</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">([()</span> <span class="p">=&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="nx">status</span><span class="p">],</span> <span class="p">(</span><span class="nx">vals</span><span class="p">,</span> <span class="nx">oldVals</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">vals</span><span class="p">,</span> <span class="nx">oldVals</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">status</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">(</span><span class="nx">dummy</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
dummy = 11

undefined
 [ [ 2, true ], [ 1, false ] ]
</pre>
<blockquote>
<p>Tip. watch 数组的时候，需要通过数组元素原来的对象去操作值的变更，如果通过数组下
标设值是不会成功的，因为这个数组本身不是 reactive 的。</p>
<p>
比如： <code>array[0]++</code> 并不会改变 <code>state.count</code></p>
<p>
只有通过 <code>state.count++</code> 自身赋值操作才会触发更新。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-27" class="outline-3">
<h3 id="headline-27">
source is function
</h3>
<div id="outline-text-headline-27" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/694a389fdeca9e3aaa8e70673da22f74552319fc">feat(add): rc-&gt;api watch-&gt;source is function · gcclll/stb-vue-next@694a389 ·
GitHub</a></p>
<p>
当要 watch 的对象是个函数的时候，无论是否有 cb 最后的 getter 都是通过</p>
<p>
<code>callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER)</code></p>
<p>
或无 cb 时等价于普通的 effect 函数</p>
<p>
<code>callWithErrorHandling(source, instance,ErrorCodes.WATCH_CALLBACK,[onInvalidate])</code></p>
<p>
直接执行这个函数去收集依赖。</p>
<p>
<img src="/img/tmp/20210115180348.png" alt="/img/tmp/20210115180348.png" title="/img/tmp/20210115180348.png" /></p>
<p>
新增代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// 如果是函数，直接执行取得函数执行结果
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// getter with cb
</span><span class="c1"></span>    <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_GETTER</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no cb -&gt; simple effect
</span><span class="c1"></span>    <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isUnmounted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 组件已经卸载了
</span><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>

      <span class="k">return</span> <span class="nx">callWithErrorHandling</span><span class="p">(</span>
        <span class="nx">source</span><span class="p">,</span>
        <span class="nx">instance</span><span class="p">,</span>
        <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CALLBACK</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">onInvalidate</span><span class="p">]</span>
      <span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9565b4aa7a9d05e5551777254c385c7e79f9b840">feat(add): rc-&gt;api watch-&gt;source is function without cb ·
gcclll/stb-vue-next@9565b4a · GitHub</a></p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">,</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="nx">watch</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">value</span><span class="p">));</span>
  <span class="nx">val</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>

  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;with cb\n&#34;</span><span class="p">);</span>
  <span class="c1">// function with cb
</span><span class="c1"></span>  <span class="nx">watch</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">val</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">val</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">);</span>
  <span class="nx">val</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="nx">dummy</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">]);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

{ dummy: 1 }
with cb

[ 100, 1 ]

</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/11ee8ef39efe740a5154939352fe7b3193e3d4c2">feat(add): rc-&gt;api watch-&gt;source invalid warning · gcclll/stb-vue-next@11ee8ef · GitHub</a></p>
<blockquote>
<ol>
<li>
<p>这里有个容易搞混淆的地方， <code>watch(fn, cb)</code> 的时候，虽然 fn 和 cb 都是函数，但
是要区分开这两者，并搞清楚他们是啥和关系是啥。</p>
<ol>
<li>
<p>fn 是被检测的对象，如果是 function 那在被监听之前需要先执行它，等于是监听
函数里面的内容，比如：函数内有访问某个 reactive 变量</p>
</li>
<li>
<p>而 cb 是属于回调性质，且是当数据有更新的时候的回调函数，它只会在一个地方被
执行，即封装 job 的时候，需要将数据更新前后的变化值通过它传递出来(如下面👇的
代码)</p>
</li>
</ol>
</li>
</ol>
</blockquote>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">job</span>: <span class="kt">SchedulerJob</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// watch(source, cb)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">||</span> <span class="nx">forceTrigger</span> <span class="o">||</span> <span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// cleanup
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="nx">callWithAsyncErrorHandling</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CALLBACK</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">newValue</span><span class="p">,</span>
        <span class="c1">// pass undefined as the old value when it&#39;s changed for the first time
</span><span class="c1"></span>        <span class="c1">// 第一次的时候 oldValue 为 undefined
</span><span class="c1"></span>        <span class="nx">oldValue</span> <span class="o">===</span> <span class="nx">INITIAL_WATCHER_VALUE</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">oldValue</span><span class="p">,</span>
        <span class="nx">onInvalidate</span><span class="p">,</span>
      <span class="p">]);</span>
      <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// watchEffect, no cb
</span><span class="c1"></span>    <span class="nx">runner</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-api-watch-deep" class="outline-3">
<h3 id="api-watch-deep">
option deep
</h3>
<div id="outline-text-api-watch-deep" class="outline-text-3">
<p>
对于深度监听主要是因为 <code>traverse()</code> 函数对 reactive 对象进行了递归遍历，对每个属
性进行了访问，从而让它收集到当前的 effect 作为依赖，这样将来这些被遍历到的值发生
改变时就会触发这个收集到的 effect 执行，达到深度监听效果。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 3. cb + deep: true
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="nx">deep</span><span class="p">)</span> <span class="p">{</span>
   <span class="kr">const</span> <span class="nx">baseGetter</span> <span class="o">=</span> <span class="nx">getter</span><span class="p">;</span>
   <span class="c1">// a. deep: true
</span><span class="c1"></span>
   <span class="c1">// b. source is reactive
</span><span class="c1"></span>   <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">traverse</span><span class="p">(</span><span class="nx">baseGetter</span><span class="p">());</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p><code>traverse()</code> 作用就是递归遍历所有属性通过 <code>return value</code> 来执行 get 操作收集依赖。</p>
</blockquote>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span>
    <span class="nx">nested</span><span class="o">:</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">},</span>
    <span class="nx">array</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="nx">map</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">([</span>
      <span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
      <span class="p">[</span><span class="s2">&#34;b&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">]),</span>
    <span class="nx">set</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
  <span class="p">});</span>

  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">state</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">nested</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;a&#34;</span><span class="p">),</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="p">];</span>
    <span class="p">},</span>
    <span class="p">{</span> <span class="nx">deep</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">nested</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
 [ 1, 1, 1, true ]

 [ 1, 2, 1, true ]

 [ 1, 2, 100, true ]

 [ 1, 2, 100, false ]
</pre>
<div id="outline-container-headline-29" class="outline-4">
<h4 id="headline-29">
<span class="todo">TODO</span>
deep ref
</h4>
</div>
</div>
</div>
<div id="outline-container-headline-30" class="outline-3">
<h3 id="headline-30">
option immediate
</h3>
<div id="outline-text-headline-30" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/204ce6824b3f645d79f77f350b78a70bc3a47980">feat(add): rc-&gt;api watch-&gt;immediate option · gcclll/stb-vue-next@204ce68 ·
GitHub</a></p>
<p>
<strong>immediate</strong> 选项，会让 cb/job 立即执行一次，而不是在队列中等待异步执行。</p>
<p>
新增代码只需要加一行：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">immediate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">job</span><span class="p">();</span> <span class="c1">// 这里直接调用 Job
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/*flush-&gt;post*/</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">runner</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="mi">_</span><span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">desc</span><span class="p">,</span> <span class="nx">newline</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="nx">log</span><span class="p">([</span><span class="nx">newline</span> <span class="o">?</span> <span class="s2">&#34;\n&#34;</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="sb">`</span><span class="si">${</span><span class="nx">desc</span><span class="si">}</span><span class="sb"> &gt; dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">]);</span>
  <span class="kr">const</span> <span class="nx">cb</span> <span class="o">=</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">dummy</span> <span class="o">=</span> <span class="nx">val</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">option</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">immediate</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">option</span><span class="p">);</span>

  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;改变值之前&#34;</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;改变值之后&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">nul</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="nx">watch</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">nul</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">option</span><span class="p">);</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;当初始值为 null&#34;</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">undef</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">();</span>
  <span class="nx">watch</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">option</span><span class="p">);</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;当初始值为 undefined&#34;</span><span class="p">);</span>
  <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;当初始值为 undefined, set 3&#34;</span><span class="p">);</span>
  <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;当初始值为 undefined, set undefined&#34;</span><span class="p">);</span>
  <span class="c1">// undefined === undefined -&gt; hasChanged() -&gt; false
</span><span class="c1"></span>  <span class="nx">undef</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="mi">_</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;当初始值为 undefined, set undefined&#34;</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
 改变值之前 &gt; dummy = 0
undefined
 改变值之后 &gt; dummy = 1
 当初始值为 null &gt; dummy = null
 当初始值为 undefined &gt; dummy = undefined
 当初始值为 undefined, set 3 &gt; dummy = 3
 当初始值为 undefined, set undefined &gt; dummy = undefined
 当初始值为 undefined, set undefined &gt; dummy = undefined
</pre>
<p>
如上结果， cb 会立即执行。</p>
<p>
在使用 deep 和 immediate 选项的时候如果没有 cb 会给出警告，直接看源码吧:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 1. cb, immediate, deep 检测
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">immediate</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`watch() &#34;immediate&#34; option is only respected when using the `</span> <span class="o">+</span>
        <span class="sb">`watch(source, callback, options?) signature.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`watch() &#34;deep&#34; option is only respected when using the `</span> <span class="o">+</span>
        <span class="sb">`watch(source, callback, options?) signature.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>也就是说， <code>deep</code> 和 <code>immediate</code> 建议在 <code>watch(s, cb, options)</code> 形式下使用，即在
有 cb 参数的情况下使用。</p>
<p>
那为什么呢？</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-31" class="outline-3">
<h3 id="headline-31">
option onTrack + onTrigger
</h3>
<div id="outline-text-headline-31" class="outline-text-3">
<p>
这部分实现逻辑主要在 <a href="/vue/vue-mind-map-house-reactivity">reactivity</a> 模块。</p>
<p>
onTrack 在 reactivity 中使用的，用来在触发 get 取值操作时调用 <a href="/vue/vue-mind-map-house-reactivity/#r-track">track()</a> 函数收集依
赖时的一个自定义事件回调。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// track() 函授最后 add 操作之后
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">dep</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">);</span>
  <span class="c1">// 自身保存一份被依赖者名单
</span><span class="c1"></span>  <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrack</span><span class="p">({</span>
      <span class="nx">effect</span>: <span class="kt">activeEffect</span><span class="p">,</span>
      <span class="nx">target</span><span class="p">,</span>
      <span class="kr">type</span><span class="p">,</span>
      <span class="nx">key</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// trigger() 函数中实现
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onTrigger</span><span class="p">({</span>
    <span class="nx">effect</span><span class="p">,</span>
    <span class="nx">target</span><span class="p">,</span>
    <span class="nx">key</span><span class="p">,</span>
    <span class="kr">type</span><span class="p">,</span>
    <span class="nx">newValue</span><span class="p">,</span>
    <span class="nx">oldValue</span><span class="p">,</span>
    <span class="nx">oldTarget</span><span class="p">,</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里会将 当前 target 的 key 属性所收集的依赖 activeEffect 暴露出来。</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span><span class="p">,</span> <span class="nx">reactive</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">trackEvents</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">triggerEvents</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">onTrack</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span> <span class="cm">/* activeEffect */</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">trackEvents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">onTrigger</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span> <span class="cm">/* effect */</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">triggerEvents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">});</span>
  <span class="nx">watchEffect</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">)];</span>
    <span class="p">},</span>
    <span class="p">{</span> <span class="nx">onTrack</span><span class="p">,</span> <span class="nx">onTrigger</span> <span class="p">}</span>
  <span class="p">);</span>

  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\n&#34;</span><span class="p">,</span> <span class="nx">dummy</span><span class="p">]);</span>
  <span class="c1">// 有多少个就等于呗调用了多少次
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;track events count = &#34;</span> <span class="o">+</span> <span class="nx">trackEvents</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="nx">trackEvents</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;target&#34;</span><span class="p">,</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span> <span class="s2">&#34;key&#34;</span><span class="p">,</span> <span class="s2">&#34;deps&#34;</span><span class="p">]));</span>

  <span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;trigger events count = &#34;</span> <span class="o">+</span> <span class="nx">triggerEvents</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="nx">triggerEvents</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">props</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">,</span> <span class="s2">&#34;key&#34;</span><span class="p">,</span> <span class="s2">&#34;oldValue&#34;</span><span class="p">,</span> <span class="s2">&#34;newValue&#34;</span><span class="p">])</span>
  <span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
 [ 1, true, [ &#39;foo&#39;, &#39;bar&#39; ] ]
track events count = 3
{ target: { foo: 1, bar: 2 }, type: &#39;get&#39;, key: &#39;foo&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;has&#39;, key: &#39;bar&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;iterate&#39;, key: Symbol(iterate) }
trigger events count = 2
{ key: &#39;foo&#39;, type: &#39;set&#39;, newValue: 3, oldValue: 1 }
{ key: &#39;bar&#39;, type: &#39;set&#39;, newValue: 4, oldValue: 2 }
</pre>
<div class="comment-block">
<p>这里还需要开发环境才能测试 onTrack，只能改一改去掉 <code>__DEV__</code> 试试。</p>
</div>
</div>
</div>
<div id="outline-container-headline-32" class="outline-3">
<h3 id="headline-32">
stop &amp; cleanup
</h3>
<div id="outline-text-headline-32" class="outline-text-3">
<p>
<strong>stop</strong>: watch() 的返回值，用来停掉 effect 使其 effect.active = false，让 effect 失效。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 9. return runner-&gt;stop, remove runner from instance.effects
</span><span class="c1"></span><span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">stop</span><span class="p">(</span><span class="nx">runner</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">remove</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">effects</span><span class="o">!</span><span class="p">,</span> <span class="nx">runner</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>cleanup</strong>: 清理工作，这有两个被调用的地方(cleanup + onStop它们被注册了同一个函数)，
一个是调动 cb/fn 之前，一个是 runner effect 调用 stop 的时候。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">let</span> <span class="nx">cleanup</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">onInvalidate</span>: <span class="kt">InvalidateCbRegistrator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">cleanup</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onStop</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CLEANUP</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
<div id="outline-container-headline-33" class="outline-4">
<h4 id="headline-33">
stop
</h4>
<div id="outline-text-headline-33" class="outline-text-4">
<p>stop 是 watch 调用的返回值，里面会 stop runner 然后将 runner 从 <code>instance.effects</code>
里面删除。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">watch</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>

  <span class="nx">stop</span><span class="p">();</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
 { dummy: 1 }
{ dummy: 1 }
</pre>
<p>
可以看到 stop 之后两次输出结果是一样，即 stop 后面的 state.count 失效了，因为
stop effect 会将 effect.active 置为  false ，有如下代码被执行:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// reactivity/src/effect.ts -&gt; createReactiveEffect()
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">effect</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
又， watch 函数里面无论如何 scheduler 都是有值的，所以当 effect 为非激活状态，什
么都不会干。</p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-4">
<h4 id="headline-34">
cleanup(无 cb)
</h4>
<div id="outline-text-headline-34" class="outline-text-4">
<p>
cleanup 相关源码，可能有点绕:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// cleanup 和注册 cleanup 的一个函数
</span><span class="c1">// 如下，cleanup 和 effect onStop 是同一个函数，清理 effect 用
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">cleanup</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">onInvalidate</span>: <span class="kt">InvalidateCbRegistrator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">cleanup</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onStop</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">WATCH_CLEANUP</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="c1">// runtime-core/src/apiWatch.ts:watch(source, cb, option)
</span><span class="c1">// Job 封装中和 cleanup 有关的
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">job</span>: <span class="kt">SchedulerJob</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">runner</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// watch(source, cb)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deep</span> <span class="o">||</span> <span class="nx">forceTrigger</span> <span class="o">||</span> <span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// cleanup，在执行 cb 之前先执行 cleanup
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="c1">// call cb with catch error
</span><span class="c1"></span>      <span class="c1">// 这里等价于 cb(newValue, oldValue, onInvalidate)
</span><span class="c1"></span>      <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="cm">/* else... */</span>
<span class="p">};</span>

<span class="c1">// 然后还有个地方与 cleanup 有关，且这里要讲到的内容会在这部分执行
</span><span class="c1">// 获取 getter函数时候，如果 source 是函数等价于
</span><span class="c1">// watchEffect(source)
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// 如果是函数，直接执行取得函数执行结果
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no cb -&gt; simple effect
</span><span class="c1"></span>    <span class="nx">getter</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isUnmounted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 组件已经卸载了
</span><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span> <span class="nx">cleanup</span><span class="p">();</span>
      <span class="c1">// 等价于 return source(onInvalidate)
</span><span class="c1"></span>    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">reactive</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watchEffect</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
  <span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">cleanup</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="sb">`\ncalled </span><span class="si">${</span><span class="o">++</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times.`</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">watchEffect</span><span class="p">((</span><span class="nx">onCleanup</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 这里执行的实际上是 onInvalidate 函数，将cleanup 封装后注册到
</span><span class="c1"></span>    <span class="c1">// cleanup 和 onStop 上，在 cb 执行之前或 effect stop 时候调用
</span><span class="c1"></span>    <span class="nx">onCleanup</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">);</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">state</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="c1">// 这里会输出一次 &#39;called 1 times.&#39;
</span><span class="c1"></span>  <span class="c1">// 因为 cb 之前之前进行了清理工作(cleanup())
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nx">br</span><span class="p">({</span> <span class="nx">dummy</span> <span class="p">});</span>

  <span class="c1">// 这里会输出一次 &#39;called 2 times.&#39;
</span><span class="c1"></span>  <span class="c1">// 这里是 effect stop 的 onStop 触发的
</span><span class="c1"></span>  <span class="nx">stop</span><span class="p">();</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
called 1 times.

 { dummy: 1 }

called 2 times.
</pre>
<blockquote>
<p>即. 如果想在 effect fn 之前或停止的时候进行清理工作，可以使用
<code>watchEffect(effect)</code> 的参数 effect 函数的第一个参数来注册 一个函数作为清理工作
或做其他事情。
如： <code>watchEffect((onCleanup) =&gt; { onCleanup(cleanup) ... }</code></p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-35" class="outline-4">
<h4 id="headline-35">
cleanup(有 cb)
</h4>
<div id="outline-text-headline-35" class="outline-text-4">
<p>
当有 cb 的时候： <code>watch(source, cb, ...)</code> ，将 onCleanup 注册函数从 cb 的第三个参数暴露出来</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">cleanup</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="sb">`\ncalled </span><span class="si">${</span><span class="o">++</span><span class="nx">n</span><span class="si">}</span><span class="sb"> times, dummy = </span><span class="si">${</span><span class="nx">dummy</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">dummy</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">watch</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">,</span> <span class="nx">onCleanup</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">onCleanup</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">);</span>
    <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
  <span class="p">});</span>
<span class="c1">// 这里 cleanup 尚不会执行
</span><span class="c1">// 因为第一次执行是注册 cleanup 行为
</span><span class="c1"></span>  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>

<span class="c1">// 这里会执行一次 cleanup ，因为第一次赋值时注册过了
</span><span class="c1"></span>  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>

<span class="c1">// stop 时候执行一次，所以总共会执行两次 cleanup, n = 2
</span><span class="c1"></span>  <span class="nx">stop</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">({</span><span class="nx">n</span><span class="p">})</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
called 1 times, dummy = 1

called 2 times, dummy = 100
{ n: 2 }
</pre>
<p>
脑图分析：</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-api-watch-cleanup.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-api-watch-cleanup.jpg" title="/img/vue3/runtime-core/vue-runtime-core-api-watch-cleanup.jpg" /></p>
<p>
文字分析：</p>
<ol>
<li>
<p>cleanup 注册时机分为两种情况</p>
<ul>
<li>
<p>一是无 cb 的 <code>watchEffect(fn)</code> ，是在 getter 设置阶段封装到 getter 函数里面
注册的，此时作为 fn 的第一个参数暴露出来 <code>fn(onCleanUp)</code> ，</p>
</li>
<li>
<p>二是有 cb 的 <code>watch(ref(0), cb)</code> , 在 job 封装期间在调用 cb 的时候注册，此
时作为 cb 的第三个参数暴露出来 <code>cb(newVal, oldVal, onCleanup)</code></p>
</li>
</ul>
<blockquote>
<p><strong>两者区别</strong> ： watchEffect 由于无 cb 会立即执行一次 runner, 此时就收集到了 cleanup，
而 watch 有 cb 时则是会在第一次值更新触发 runner 执行才开始收集 cleanup。</p>
</blockquote>
</li>
<li>
<p>执行时机，该阶段和注册时机相辅相成，且在 cb/fn 执行之前就会被执行，因此 cb/fn
的第一次执行都属于对 cleanup 的注册</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-watch-sync" class="outline-3">
<h3 id="watch-sync">
flush sync
</h3>
<div id="outline-text-watch-sync" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e1436f2cfe78cdc64c31c03d876c5b743a44fc18">feat(add): rc-&gt;api watch-&gt;option flush=sync · gcclll/stb-vue-next@e1436f2 · GitHub</a></p>
<p>
支持同步代码，即所有任务立即执行（在值发生改变之后），而不是进入队列异步执行。</p>
<p>
只需要增加一行代码就行：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 6. TODO scheduler 设置
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">scheduler</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;scheduler&#34;</span><span class="p">];</span>
<span class="c1">// 6.1 flush is &#39;sync&#39;
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;sync&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">scheduler</span> <span class="o">=</span> <span class="nx">job</span><span class="p">;</span>  <span class="c1">// 新增
</span><span class="c1"></span><span class="p">}</span>
<span class="c1">// 6.2 TODO flush is &#39;post&#39;
</span><span class="c1"></span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="cm">/* post */</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
<span class="c1">// 6.3 TODO flush is &#39;pre&#39;(default)
</span><span class="c1"></span><span class="k">else</span> <span class="p">{</span>
  <span class="c1">// default: &#39;pre&#39;
</span><span class="c1"></span>  <span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span> <span class="o">||</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 带 { pre: true } 选项，第一次调用必须发生在组件 mounted 之前
</span><span class="c1"></span>      <span class="c1">// 从而使他被同步调用，立即执行一次
</span><span class="c1"></span>      <span class="nx">job</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
新增 <code>scheduler = job</code> 直接让任务函数赋值给调度器，这个时候如果有值发生变化，会
触发 effect&gt; <code>trigger()</code> 在这里面会检测是不是有 <code>option.scheduler</code> 如果有会立即执行这
个函数。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// reactivity/effect.ts&gt;trigger()
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">effect</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scheduler</span><span class="p">(</span><span class="nx">effect</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">effect</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="o">++</span><span class="nx">calls</span><span class="p">,</span> <span class="p">{</span> <span class="nx">flush</span><span class="o">:</span> <span class="s2">&#34;sync&#34;</span> <span class="p">});</span>

  <span class="nx">log</span><span class="p">({</span> <span class="nx">calls</span> <span class="p">});</span> <span class="c1">// -&gt; 0
</span><span class="c1"></span>  <span class="nx">value</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">({</span> <span class="nx">calls</span> <span class="p">});</span> <span class="c1">// -&gt; 1
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{ calls: 0 }
{ calls: 1 }
undefined
</pre>
<p>
注意看上面的测试用例并没有用 <code>await nextTick()</code> ，而是同步代码执行。</p>
</div>
</div>
<div id="outline-container-watch-shallow-ref" class="outline-3">
<h3 id="watch-shallow-ref">
shallow ref
</h3>
<div id="outline-text-watch-shallow-ref" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">watch</span><span class="p">,</span> <span class="nx">shallowRef</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">triggerRef</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">shallowRef</span><span class="p">({</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span> <span class="c1">// #1
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">sideEffect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">watch</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #2 cb -&gt; cb(newVal, oldVal, onCleanUp)
</span><span class="c1"></span>    <span class="nx">sideEffect</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">a</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">v</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="c1">// #3
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nshould not trigger: &#34;</span><span class="p">,</span> <span class="nx">sideEffect</span><span class="p">]);</span> <span class="c1">// #4
</span><span class="c1"></span>
  <span class="nx">v</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">a</span><span class="o">++</span><span class="p">;</span> <span class="c1">// #5
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nshould not trigger: &#34;</span><span class="p">,</span> <span class="nx">sideEffect</span><span class="p">]);</span> <span class="c1">// #6
</span><span class="c1"></span>
  <span class="nx">triggerRef</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span> <span class="c1">// #7
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nshould trigger now: &#34;</span><span class="p">,</span> <span class="nx">sideEffect</span><span class="p">]);</span> <span class="c1">// #8
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
should not trigger:  0

should not trigger:  0

should trigger now:  2
</pre>
<blockquote>
<p>ref 这一块还没深入去分析过，先暂停⏸去完成下这部分。</p>
<ol>
<li>
<p>DONE [2021-01-20 15:18:37] <a href="/vue/vue-mind-map-house-reactivity/#ref">ref 完成，可以往下继续了</a></p>
</li>
</ol>
</blockquote>
<p>
triggerRef 作用是手动触发 ref.value 上收集的所有依赖。</p>
<p>
结果分析：</p>
<ol>
<li>
<p><strong>#1</strong> shallowRef 意味着 <code>{a: 1}</code> 中的属性 a 非 reactive</p>
</li>
<li>
<p><strong>#2</strong> watch v 基于 <strong>1</strong> 所以只是对 ref value 进行了监听，后面是值变更回调</p>
</li>
<li>
<p><strong>#3</strong> 值没发生改变，所有 <strong>#4</strong> 输出还是 0</p>
</li>
<li>
<p><strong>#5</strong> 由于 <code>a</code> 属性非 reactive 所以它没有依赖收集所以不会执行 cb，所以 <strong>#6</strong> 出
依然是 0</p>
</li>
<li>
<p><strong>#7</strong> 这里手动调用 <code>triggerRef(v)</code> 等价于 <code>trigger(v, SET, &#39;value&#39;)</code> 触发 ref
value 的依赖执行，此时 cb 会得到执行，sideEffect 被赋值新的 <code>v.a</code> 值</p>
<p>
这里有一点需要注意，在 cb 里面是用的 v.a 而不是 v.value.a 因为在
<code>watch(s,cb,option)</code> 里面检测到如果 <code>s</code> 是 ref 类型，会将 getter 设置为
<code>getter = () =&gt; s.value</code></p>
<p>
而在执行 cb 之前取新值是通过 <code>newVal = runner()</code> 得到的，而这个 <code>runner =
effect(getter, {...})</code> 所以等于是 <code>effect(() =&gt; s.value, {...})</code></p>
<p>
所以对于 ref 类型 effect 封装的其实是 <code>() =&gt; s.value</code> 这个函
数，那么对于 <code>s.value</code> 的依赖列表中就会有这个箭头函数。</p>
<p>
然后在 watch 里面会将 cb 的执行封装进 job ，然后根据情况将 job 封装或直接赋值
给 scheduler ，这个会作为 <code>effect(, { scheduler })</code> 的选项传递进去。</p>
<p>
那么在 trigger 的时候检测到提供了 scheduler 就会调用它，所以最终调用
triggerRef(v) 会触发 cb 的调用将 <code>obj.a~复制给 ~sideEffect</code> ，这个 obj 就是
runner() 执行的返回值也就是 <code>() =&gt; s.value</code> 这个函数执行的返回值。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-38" class="outline-3">
<h3 id="headline-38">
<span class="todo">TODO</span>
flush pre(default) cb
</h3>
</div>
<div id="outline-container-headline-39" class="outline-3">
<h3 id="headline-39">
<span class="todo">TODO</span>
flush post cb
</h3>
<div id="outline-text-headline-39" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ec14879bf13deb83cea3401279ea75e1cf44eaf6">feat(add): rc-&gt;watch-&gt;flush = &#39;post&#39; · gcclll/stb-vue-next@ec14879 · GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9f3ac7dff18926df602a7f0eff08da4b253e26a7">feat(add): rc-&gt;watch-&gt;cb-&gt;flush = &#39;post&#39; · gcclll/stb-vue-next@9f3ac7d · GitHub</a></p>
<p>
新增代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// apiWatch.ts -&gt; scheduler when flush=post
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;post&#34;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">queuePostRenderEffect</span><span class="p">(</span><span class="nx">job</span><span class="p">,</span> <span class="nx">instance</span> <span class="o">&amp;&amp;</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">suspense</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// renderer.ts -&gt; queuePostRenderEffect
</span><span class="c1">// 将任务加入到 suspense.effects 或 调用 queuePostFlushCb
</span><span class="c1">// 加入到 pendingPostFlushCbs
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">queuePostRenderEffect</span> <span class="o">=</span> <span class="nx">__FEATURE_SUSPENSE__</span>
  <span class="o">?</span> <span class="nx">queueEffectWithSuspense</span>
  : <span class="kt">queuePostFlushCb</span><span class="p">;</span>

<span class="c1">// components/Suspense.ts
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queueEffectWithSuspense</span><span class="p">(</span>
  <span class="nx">fn</span>: <span class="kt">Function</span> <span class="o">|</span> <span class="nb">Function</span><span class="p">[],</span>
  <span class="nx">suspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span>
<span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">suspense</span> <span class="o">&amp;&amp;</span> <span class="nx">suspense</span><span class="p">.</span><span class="nx">pendingBranch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">fn</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">suspense</span><span class="p">.</span><span class="nx">effects</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">fn</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">suspense</span><span class="p">.</span><span class="nx">effects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-40" class="outline-3">
<h3 id="headline-40">
<span class="todo">TODO</span>
ssr support
</h3>
</div>
<div id="outline-container-headline-41" class="outline-3">
<h3 id="headline-41">
<span class="todo">TODO</span>
instance watch
</h3>
<div id="outline-text-headline-41" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9ec5d5131019fe67bcc7232e39bde1cfe239dbca">feat(add): rc-&gt;watch-&gt;instance watch · gcclll/stb-vue-next@9ec5d51 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// this.$watch
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">instanceWatch</span><span class="p">(</span>
  <span class="k">this</span><span class="o">:</span> <span class="nx">ComponentInternalInstance</span><span class="p">,</span>
  <span class="nx">source</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">Function</span><span class="p">,</span>
  <span class="nx">cb</span>: <span class="kt">WatchCallback</span><span class="p">,</span>
  <span class="nx">options?</span>: <span class="kt">WatchOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WatchStopHandle</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">publicThis</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span> <span class="kr">as</span> <span class="kt">any</span>
  <span class="kr">const</span> <span class="nx">getter</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
    <span class="o">?</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">publicThis</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span>
    <span class="o">:</span> <span class="nx">source</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">publicThis</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">doWatch</span><span class="p">(</span><span class="nx">getter</span><span class="p">,</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">publicThis</span><span class="p">),</span> <span class="nx">options</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
将监听源，与当前实例绑定，如果是字符串转成函数。</p>
</div>
</div>
<div id="outline-container-headline-42" class="outline-3">
<h3 id="headline-42">
🍺 小结
</h3>
<div id="outline-text-headline-42" class="outline-text-3">
<p>
这一节所描述的主要是 watch/watchEffect 函数的实现和使用，用来监听数据变化做出相
应。</p>
<p>
<code>watch(source, cb, option)</code> -&gt; <code>doWatch(source, cb, option)</code></p>
<p>
<code>watchEffect(effect, option)</code> -&gt; <code>doWatch(source /*function*/, null, option)</code></p>
<p>
重点回顾 watch ，因为 watchEffect 是在 source 为 function 且无 cb 时候的情况。</p>
<p>
使用方法，我们可以按照 watch 函数的实现内容来逐个回顾，函数实现代码有三个重点</p>
<blockquote>
<p>注🐖：watch 里面函数的调用(source 或 cb) 都是通过 callWithErrorHandling 去完成的，
这里其实就是个异常拦截的作用(try…catch)，防止执行报错阻碍整体页面的执行。</p>
</blockquote>
<ol>
<li>
<p>getter: 根据 source 类型封装 getter</p>
<p>
<strong>Ref</strong> : getter = () =&gt; source.value</p>
<p>
<strong>Reactive</strong>: deep = true, traverse(source) 对对象所有属性触发一次 getter 操作。</p>
<p>
<strong>Array</strong>: 根据元素类型不同做不同处理(比如： <code>ref/reactive/function</code> 且只支持这
三种)</p>
<p>
<strong>Function</strong>: getter =&gt; { …直接执行 source } 不同点在于如果有 cb 时，执行
<code>source()</code> ，没有时 <code>source(onInvalidate)</code> 这个 onInvalidate 是 watch 暴露出
去的一个清理函数它会被绑定到 <code>cleanup</code> 和 <code>option.onStop</code> 上，在 effect 被
stop 或在调用之前做的一些清理工作。</p>
<p>
这个最终目的是为了对每个属性进行一次 getter 调用，用来 effect -&gt; track 收集每
个属性的依赖列表(<a href="/vue/vue-mind-map-reactivity/#r-track">reactivity</a>: targetMap -&gt; depsMap -&gt; dep)。</p>
</li>
<li>
<p>job: 根据 cb 参数封装 job(将来在值变更是触发执行的函数)</p>
<p>
job 的封装分为两种情况，分别是 cb 是函数或为空值时候，这里的区别也是体现在 cb
的调用上面(具体就是给 cb 的参数)。</p>
<p>
<code>if(cb)</code> 那么其调用参数会是： <code>cb(newVal, oldVal, onCleanup/*onInvalidate*/)</code></p>
<p>
<code>else</code> 没有 cb 的时候会直接执行 runner() 触发更新。</p>
<blockquote>
<p>注意到和 <strong>1</strong> 中有点类似地方了没，这里的 cb(…) 和 getter 封装阶段对
<code>source(onInvalidate)</code> 的调用，即不管是有 cb 还是没有 cb， onInvalidate 这个
回调总是会被暴露出去，无非是作为 cb 参数还是 function source 的参数，这使得我
们可以在每个任务执行之前和执行结束的时间点做一些事情(比如： cleanup)。</p>
</blockquote>
</li>
<li>
<p>scheduler 的封装(根据选项类型，主要是 <code>flush = sync|post|pre</code>)，值变更 effect
trigger 中调用的函数</p>
<p>
scheduler 是将 job 进一步封装，将来当值发生变化的时候 effect -&gt; trigger 里面
会被调用到。</p>
<p>
这个函数的值主要由 <code>flush</code> 选项决定，默认值是 <code>pre</code> ，其次有 <code>post|sync</code></p>
<p>
<strong>post</strong>: 异步执行，会添加到异步任务队列中等待执行(<code>pendingPostFlushCbs</code>)</p>
<p>
<strong>sync</strong>: 表示为同步更新，即当值发生变化了会立即更新，<a href="#watch-sync">详情</a>。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 比如：ref.value = 0
</span><span class="c1"></span><span class="nx">ref</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
<span class="nx">ref</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// true, 而不用 await nextTick() 就可以取到更新后的值
</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<strong>pre</strong>: 默认是 pre 类型，这里区分组件是否加载完成， <code>instance.isUnmounted</code> 如果
加载完成，调用 <code>queuePreFlushCb(job)</code> 添加到 <code>pendingPreFlushCbs[]</code> 中等待执
行，如果组件没有加载完成需要立即执行 <code>job()</code> 。</p>
</li>
</ol>
<p>
在前面三个基本条件(<code>getter/job/scheduler</code>)封装完成之后，接下来是调用
<code>effect(getter, { lazy: true, scheduler, ... })</code> 得到 <code>runner()</code> 这个 runner 是
对 getter 函数的 <a href="/vue/vue-mind-map-reactivity">ReactiveEffect 封装。</a></p>
<p>
<strong>runner</strong>: 随后决定什么时机执行这个 <code>runner()</code> 触发 track 收集依赖，判定条件有
 <code>cb</code>, <code>option.immediate</code>, <code>option.flush=&#34;post&#34;</code></p>
<ol>
<li>
<p><code>cb &amp;&amp; immediate</code> 时候立即执行 <code>job()</code> 不走 runner</p>
</li>
<li>
<p><code>cb &amp;&amp; !immediate</code> 立即执行 <code>runner()</code> 根据任务性质决定是同步还是异步</p>
</li>
<li>
<p><code>!cb &amp;&amp; flush===&#39;post&#39;</code> 检测如果是 suspense 加入到
<code>instance.suspense.effects</code> 否则直接 <code>queuePostFlushCb(runner)</code></p>
<p>
这个需要开启 <code>Suspense</code> 组件支持，这个 ast render 函数其实就是在一个 <code>async</code>
函数里面执行的代码。</p>
</li>
<li>
<p><code>else</code> 直接执行 <code>runner()</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-43" class="outline-2">
<h2 id="headline-43">
🍎 api createApp
</h2>
<div id="outline-text-headline-43" class="outline-text-2">
<div id="outline-container-headline-44" class="outline-3">
<h3 id="headline-44">
declaration
</h3>
<div id="outline-text-headline-44" class="outline-text-3">
<p>这里就两个函数</p>
<ol>
<li>
<p><code>createAppContext</code> 上下文创建</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">createAppContext</span><span class="p">()</span><span class="o">:</span> <span class="nx">AppContext</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">{</span>
     <span class="nx">app</span>: <span class="kt">null</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">,</span>
     <span class="nx">config</span><span class="o">:</span> <span class="p">{</span>
       <span class="nx">isNativeTag</span>: <span class="kt">NO</span><span class="p">,</span>
       <span class="nx">performance</span>: <span class="kt">false</span><span class="p">,</span>
       <span class="nx">globalProperties</span><span class="o">:</span> <span class="p">{},</span>
       <span class="nx">optionMergeStrategies</span><span class="o">:</span> <span class="p">{},</span>
       <span class="nx">isCustomElement</span>: <span class="kt">NO</span><span class="p">,</span>
       <span class="nx">errorHandler</span>: <span class="kt">undefined</span><span class="p">,</span>
       <span class="nx">warnHandler</span>: <span class="kt">undefined</span><span class="p">,</span>
     <span class="p">},</span>
     <span class="nx">mixins</span><span class="o">:</span> <span class="p">[],</span>
     <span class="nx">components</span><span class="o">:</span> <span class="p">{},</span>
     <span class="nx">directives</span><span class="o">:</span> <span class="p">{},</span>
     <span class="nx">provides</span>: <span class="kt">Object.create</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>
   <span class="p">};</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>createAppAPI</code> 创建 <code>createApp</code> 函数</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createAppAPI</span><span class="p">&lt;</span><span class="nt">HostElement</span><span class="p">&gt;(</span>
  <span class="nx">render</span>: <span class="kt">RootRenderFunction</span><span class="p">,</span>
  <span class="nx">hydrate?</span>: <span class="kt">RootHydrateFunction</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">CreateAppFunction</span><span class="p">&lt;</span><span class="nt">HostElement</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">rootComponent</span><span class="p">,</span> <span class="nx">rootProps</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{};</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>所以一个 App 上下文包含内容：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>-</th>
<th>-</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>app</code></td>
<td>-</td>
<td></td>
</tr>
<tr>
<td><code>config</code></td>
<td>-</td>
<td></td>
</tr>
<tr>
<td></td>
<td>isNativeTag</td>
<td>NO</td>
</tr>
<tr>
<td></td>
<td>performance</td>
<td>false</td>
</tr>
<tr>
<td></td>
<td>globalProperties</td>
<td>{}</td>
</tr>
<tr>
<td></td>
<td>optionMergeStrategies</td>
<td>{}</td>
</tr>
<tr>
<td></td>
<td>isCustomElement</td>
<td>NO</td>
</tr>
<tr>
<td></td>
<td>errorHandler</td>
<td>undefined</td>
</tr>
<tr>
<td></td>
<td>warnHandler</td>
<td>undefined</td>
</tr>
<tr>
<td>mixins</td>
<td>[]</td>
<td></td>
</tr>
<tr>
<td>components</td>
<td>{}</td>
<td></td>
</tr>
<tr>
<td>directives</td>
<td>{}</td>
<td></td>
</tr>
<tr>
<td>provides</td>
<td>Object.create(null)</td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-headline-45" class="outline-3">
<h3 id="headline-45">
implementation
</h3>
<div id="outline-text-headline-45" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1facd1b3ad797775b298ecfba0d363d4f364b821">feat(add): createApp app apis · gcclll/stb-vue-next@1facd1b · GitHub</a></p>
<ol>
<li>
<p><code>context = createAppContext()</code> 创建上下文</p>
</li>
<li>
<p><code>installedPlugins = new Set()</code> 插件列表</p>
</li>
<li>
<p><code>isMounted = false</code> 加载完成标识</p>
</li>
<li>
<p><code>app = context.app = {...}</code></p>
</li>
<li>
<p><code>return app</code></p>
</li>
</ol>
<p>
所以重点就在 <strong>4</strong> 构造 app，其包含的 API 如下：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>function</th>
</tr>
</thead>
<tbody>
<tr>
<td>get config()</td>
<td>获取上下文配置信息，不可更改，可以通过创建实例时的 option 改变</td>
</tr>
<tr>
<td>use(pugin, …options)</td>
<td>插件系统</td>
</tr>
<tr>
<td>mixin(mixin)</td>
<td>混合器系统</td>
</tr>
<tr>
<td>component(name, component)</td>
<td>组件系统</td>
</tr>
<tr>
<td>directive(name, directive)</td>
<td>指令系统</td>
</tr>
<tr>
<td>mount(rootContainer, isHydrate)</td>
<td>mount 函数</td>
</tr>
<tr>
<td>unmount()</td>
<td>-</td>
</tr>
<tr>
<td>provide(key, value)</td>
<td>注入系统</td>
</tr>
</tbody>
</table>
<div id="outline-container-headline-46" class="outline-4">
<h4 id="headline-46">
app.use(plugin, …options)
</h4>
<div id="outline-text-headline-46" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a3abcbaa931fa622b2a1920434575bf6b5fc83a8">feat(add): createApp use plugin · gcclll/stb-vue-next@a3abcba · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">use</span><span class="p">(</span><span class="nx">plugin</span>: <span class="kt">Plugin</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">installedPlugins</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">plugin</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">warn</span><span class="p">(</span><span class="sb">`Plugin has already been applied to target app.`</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">plugin</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">install</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 函数直接执行
</span><span class="c1"></span>    <span class="nx">installedPlugins</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">plugin</span><span class="p">);</span>
    <span class="nx">plugin</span><span class="p">.</span><span class="nx">install</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">plugin</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 没有 install 函数时
</span><span class="c1"></span>    <span class="nx">installedPlugins</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">plugin</span><span class="p">);</span>
    <span class="nx">plugin</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// plugin 必须要么自己是函数，要么是包含 install 函数的对象
</span><span class="c1"></span>    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`A plugin must either be a function or an object with an &#34;install&#34; `</span> <span class="o">+</span>
        <span class="sb">`function.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
所以插件 plugin 必须要么自己是函数。</p>
</div>
</div>
<div id="outline-container-headline-47" class="outline-4">
<h4 id="headline-47">
app.mixin(mixin)
</h4>
<div id="outline-text-headline-47" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b96afcf3b83510071e8fcd6da95b39123b85e241">feat(add): createApp mixin api · gcclll/stb-vue-next@b96afcf · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">mixin</span>: <span class="kt">ComponentOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__FEATURE_OPTIONS_API__</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">mixins</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">mixin</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">mixins</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mixin</span><span class="p">);</span>
      <span class="c1">// 带有 props/emits 的全局 mixin 会是的 props/emits 缓存优化失效
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">props</span> <span class="o">||</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">emits</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">deopt</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span>
        <span class="s2">&#34;Mixin has already been applied to target app&#34;</span> <span class="o">+</span>
          <span class="p">(</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">name</span> <span class="o">?</span> <span class="sb">`: </span><span class="si">${</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span> <span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 必须开启了 options api 特性才能使用，即 vue3 里面可根据需要
</span><span class="c1"></span>    <span class="c1">// 关闭这个功能
</span><span class="c1"></span>    <span class="nx">warn</span><span class="p">(</span><span class="s2">&#34;Mixins are only available in builds supporting Options API&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
可根据需要在打包的时候由 <code>__FEATURE_OPTIONS_API__</code> 决定是否继续支持 mixin 功能。</p>
</div>
</div>
<div id="outline-container-headline-48" class="outline-4">
<h4 id="headline-48">
app.component(name, component)
</h4>
<div id="outline-text-headline-48" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9b2579d2b7fbe8e5fe6e8fb9df7381475fd1f247">feat(add): createApp component api · gcclll/stb-vue-next@9b2579d · GitHub</a></p>
<p>
内置标签： <code>slot,component</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">component</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">component?</span>: <span class="kt">Component</span><span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 验证组件名称是否合法
</span><span class="c1"></span>    <span class="nx">validateComponentName</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 没有对应组件，视为根据名称获取组件操作
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// 组件已经注册过了，再次注册等于覆盖原有的
</span><span class="c1"></span>    <span class="nx">warn</span><span class="p">(</span><span class="sb">`Component &#34;</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">&#34; has already been registered in target app.`</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">context</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">component</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>验证组件名，不能用内置(<code>isBuiltInTag()</code>)或自定义(<code>isCustomElement()</code>)的标签作为组件名</p>
</li>
<li>
<p>没有 component 参数的时候视为根据 name 去获取组件</p>
</li>
<li>
<p>当 name - component 存在时属于覆盖操作，给出警告</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-49" class="outline-4">
<h4 id="headline-49">
app.directive(name, directive)
</h4>
<div id="outline-text-headline-49" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ec1a20eb64bf3b482984faaa70ee4337143b5449">feat(add): createApp directive api · gcclll/stb-vue-next@ec1a20e · GitHub</a></p>
<p>
内置指令集： <code>bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">directive</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">directive?</span>: <span class="kt">Directive</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">validateDirectiveName</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">directive</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">directives</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">directives</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`Directive &#34;</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">&#34; has already been registered in target app.`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">directives</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">directive</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-50" class="outline-4">
<h4 id="headline-50">
app.mount(rootContainer, isHydrate)
</h4>
<div id="outline-text-headline-50" class="outline-text-4">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">rootContainer</span>: <span class="kt">HostElement</span><span class="p">,</span> <span class="nx">isHydrate?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">vnode</span> <span class="o">=</span> <span class="nx">createVNode</span><span class="p">(</span><span class="nx">rootComponent</span> <span class="kr">as</span> <span class="nx">ConcreteComponent</span><span class="p">,</span> <span class="nx">rootProps</span><span class="p">);</span>

    <span class="c1">// 保存 app context 到 root VNode 节点上
</span><span class="c1"></span>    <span class="c1">// 这个将会在初始化 mount 时候被设置到根实例上
</span><span class="c1"></span>    <span class="nx">vnode</span><span class="p">.</span><span class="nx">appContext</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>

    <span class="c1">// HMR root reload
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">reload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">render</span><span class="p">(</span><span class="nx">cloneVNode</span><span class="p">(</span><span class="nx">vnode</span><span class="p">),</span> <span class="nx">rootContainer</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isHydrate</span> <span class="o">&amp;&amp;</span> <span class="nx">hydrate</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hydrate</span><span class="p">(</span><span class="nx">vnode</span> <span class="kr">as</span> <span class="nx">VNode</span><span class="p">&lt;</span><span class="nt">Node</span><span class="err">,</span> <span class="na">Element</span><span class="p">&gt;,</span> <span class="nx">rootContainer</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">render</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">rootContainer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">isMounted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">_container</span> <span class="o">=</span> <span class="nx">rootContainer</span><span class="p">;</span>
    <span class="c1">// for devtools and telemetry
</span><span class="c1"></span>    <span class="p">(</span><span class="nx">rootContainer</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">__vue_app__</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">||</span> <span class="nx">__FEATURE_PROD_DEVTOOLS__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">devtoolsInitApp</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">version</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">component</span><span class="o">!</span><span class="p">.</span><span class="nx">proxy</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`App has already been mounted.</span><span class="err">\</span><span class="sb">n`</span> <span class="o">+</span>
        <span class="sb">`If you want to remount the same app, move your app creation logic `</span> <span class="o">+</span>
        <span class="sb">`into a factory function and create fresh app instances for each `</span> <span class="o">+</span>
        <span class="sb">`mount - e.g. \`const createMyApp = () =&gt; createApp(App)\``</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p><code>vnode = createVNode(rootComponent, rootProps)</code> 创建虚拟节点</p>
</li>
<li>
<p><code>vnode.appContext = context</code> 保存上下文到虚拟节点上，组件初始化时使用</p>
</li>
<li>
<p><code>context.reload = () =&gt; render(cloneVNode(vnode), rootContainer)</code> HMR 开发时
有变更的热加载</p>
</li>
<li>
<p><code>rootContainer.__vue_app__ = app</code></p>
</li>
<li>
<p>devtool 开发工具相关</p>
</li>
<li>
<p>返回 <code>vnode.component.proxy</code> 这个是干啥的？</p>
</li>
</ol>
<p>
最后，如果 app 已经被加载了不能重复 mount。如果需要对一个app做重复 mount，可能的
需求是存在同时创建多个 app 情况？</p>
<p>
那么这个时候应该使用函数方式使用，如：</p>
<p>
<code>myCreateApp = (...) =&gt; createApp(App)</code></p>
</div>
</div>
<div id="outline-container-headline-51" class="outline-4">
<h4 id="headline-51">
app.unmount()
</h4>
<div id="outline-text-headline-51" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/63354d31cc1f7591cad8118a33c3be2b96dd788c">feat(add): createApp unmount api · gcclll/stb-vue-next@63354d3 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">unmount() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">_container</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">||</span> <span class="nx">__FEATURE_PROD_DEVTOOLS__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">devtoolsUnmountApp</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`Cannot unmount an app that is not mounted.`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>render(null, ...)</code> ?</p>
</div>
</div>
<div id="outline-container-headline-52" class="outline-4">
<h4 id="headline-52">
app.provide(key, value)
</h4>
<div id="outline-text-headline-52" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/18fb22bf22b613378119d272db1b52d1efd17a90">feat(add): createApp provide api · gcclll/stb-vue-next@18fb22b · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">provide</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span> <span class="k">in</span> <span class="nx">context</span><span class="p">.</span><span class="nx">provides</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`App already provides property with key &#34;</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="si">}</span><span class="sb">&#34;. `</span> <span class="o">+</span>
        <span class="sb">`It will be overwritten with the new value.`</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// TypeScript doesn&#39;t allow symbols as index type
</span><span class="c1"></span>  <span class="c1">// https://github.com/Microsoft/TypeScript/issues/24587
</span><span class="c1"></span>  <span class="nx">context</span><span class="p">.</span><span class="nx">provides</span><span class="p">[</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
就是简单的给 <code>context.provides</code> 设置操作。</p>
<blockquote>
<ol>
<li>
<p>做什么的呢？</p>
</li>
</ol>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-53" class="outline-3">
<h3 id="headline-53">
test
</h3>
<div id="outline-text-headline-53" class="outline-text-3">
<p>
这里目前只能测试 mount 和 unmount 其他的 api(provide/…) 需要等它们被实现了才能
继续测试。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span> <span class="nx">defineComponent</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">createApp</span><span class="p">,</span> <span class="nx">serializeInner</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="nx">defineComponent</span><span class="p">({</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">count</span><span class="o">:</span> <span class="p">{</span>
      <span class="k">default</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">root1</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">).</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root1</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">si</span> <span class="o">=</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root1</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root1 serialize, &#34;</span> <span class="o">+</span> <span class="nx">si</span><span class="p">);</span>

<span class="c1">// mount with props
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">root2</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app2</span> <span class="o">=</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
<span class="nx">app2</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root2</span><span class="p">);</span>
<span class="nx">si</span> <span class="o">=</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root2</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root2 serialize, &#34;</span> <span class="o">+</span> <span class="nx">si</span><span class="p">);</span>

<span class="c1">// unmount
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">root3</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app3</span> <span class="o">=</span> <span class="nx">createApp</span><span class="p">(</span><span class="nx">Comp</span><span class="p">,</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>

<span class="c1">// 在 mount 之前卸载
</span><span class="c1"></span><span class="k">try</span> <span class="p">{</span>
  <span class="nx">app3</span><span class="p">.</span><span class="nx">unmount</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span> <span class="c1">// warnning
</span><span class="c1"></span><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;unmount failed.&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">app3</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span>
<span class="nx">app3</span><span class="p">.</span><span class="nx">unmount</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span>
<span class="nx">si</span> <span class="o">=</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root3</span><span class="p">);</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;root3 serialize, &#34;</span> <span class="o">+</span> <span class="nx">si</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
root1 serialize, 0
root2 serialize, 1
root3 serialize,
undefined
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-api-provide-inject" class="outline-2">
<h2 id="api-provide-inject">
⛏ api provide &amp; inject
</h2>
<div id="outline-text-api-provide-inject" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b4a1cbc65081f0d91bf02faabccb050218223b02">feat(add): provide &amp; inject api · gcclll/stb-vue-next@b4a1cbc · GitHub</a></p>
<p>
作用： 在父组件中 <code>provide(key,value)</code> 向子组件传值， <code>inject(key)</code> 在子组件中可以取到该值。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">provide</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">number</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">inject</span><span class="p">(</span>
  <span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span><span class="p">,</span>
  <span class="nx">defaultValue?</span>: <span class="kt">unknown</span><span class="p">,</span>
  <span class="nx">treatDefaultAsFactory</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
涉及内容</p>
<ol>
<li>
<p>provides 继承 parent provides，需要自己的就创建新对象继承自 parent provides，
所以查找 injections 可以在原型链查找。</p>
</li>
<li>
<p><code>inject(key, defaultValue, treatDefaultAsFactory = false)</code> 你只是个简单的取值
操作 (<code>provides[key]</code>)？😭？😭？</p>
</li>
</ol>
<blockquote>
<p><strong>Imp</strong>. provide 和 inject 只能在 <code>setup()</code> 或函数式组件中使用，它们的作用是根据原
 型链特性实现从父组件向子组件传递一些值。</p>
</blockquote>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-inject-provide.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-inject-provide.jpg" title="/img/vue3/runtime-core/vue-runtime-core-inject-provide.jpg" /></p>
<div id="outline-container-headline-55" class="outline-3">
<h3 id="headline-55">
provide(key, value)
</h3>
<div id="outline-text-headline-55" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/42f3d053f2b72d6d504c7cc64c48cfa7a1bee89a">feat(add): provide &amp; inject provide implementation · gcclll/stb-vue-next@42f3d05
· GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">provide</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">number</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">currentInstance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="sb">`provide() can only be used inside setup().`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">provides</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">provides</span><span class="p">;</span>

    <span class="c1">// 默认情况实例会继承它父亲的 provides 对象
</span><span class="c1"></span>    <span class="c1">// 但是当它需要 provide 自己的 values 时候，那么使用它
</span><span class="c1"></span>    <span class="c1">// 父亲的 provides 作为原型创建一个新的对象出来变成自己的 provides
</span><span class="c1"></span>    <span class="c1">// 这样在 `inject` 里面可以简便的从原型链中查找 injections
</span><span class="c1"></span>    <span class="c1">// 简单说就是：
</span><span class="c1"></span>    <span class="c1">// 1. 需要自己的就创建个新的对象继承自 Parent provides
</span><span class="c1"></span>    <span class="c1">// 2. 这样在查找的时候就可以含方便的通过原型链查找 injections
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">parentProvides</span> <span class="o">=</span>
      <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">provides</span><span class="p">;</span>

    <span class="c1">// 当父组件和当前实例相同的时候，从父组件的 provides 创建一个备份出来
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">parentProvides</span> <span class="o">===</span> <span class="nx">provides</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">provides</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">.</span><span class="nx">provides</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">parentProvides</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// TS doesn&#39;t allow symbol as index type
</span><span class="c1"></span>    <span class="nx">provides</span><span class="p">[</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p><code>Object.create(parentProvides)</code> 创新新的对象来容纳新的 key-value</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-56" class="outline-3">
<h3 id="headline-56">
inject(key, defaultValue, treatDefaultAsFactory = false)
</h3>
<div id="outline-text-headline-56" class="outline-text-3">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">inject</span><span class="p">(</span><span class="nx">defaultValue?</span>: <span class="kt">unknown</span><span class="p">,</span> <span class="nx">treatDefaultAsFactory</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="c1">// currentRenderingInstance 兼容函数式组件
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">currentInstance</span> <span class="o">||</span> <span class="nx">currentRenderingInstance</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// #2400
</span><span class="c1"></span>    <span class="c1">// to support `app.use` plugins,
</span><span class="c1"></span>    <span class="c1">// fallback to appContext&#39;s `provides` if the intance is at root
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">provides</span> <span class="o">=</span>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="kc">null</span> <span class="c1">// root
</span><span class="c1"></span>        <span class="o">?</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">vnode</span><span class="p">.</span><span class="nx">appContext</span> <span class="o">&amp;&amp;</span> <span class="nx">instance.vnode.appContext.provides</span>
        : <span class="kt">instance.parent.provides</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">provides</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">symbol</span><span class="p">)</span> <span class="k">in</span> <span class="nx">provides</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TS doesn&#39;t allow symbol as index type
</span><span class="c1"></span>      <span class="k">return</span> <span class="nx">provides</span><span class="p">[</span><span class="nx">key</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">treatDefaultAsFactory</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">)</span>
        <span class="o">?</span> <span class="nx">defaultValue</span><span class="p">()</span>
        <span class="o">:</span> <span class="nx">defaultValue</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">warn</span><span class="p">(</span><span class="sb">`injection &#34;</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="si">}</span><span class="sb">&#34; not found.`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`inject() can only be used inside setup() or functional components.`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
inject 就是个简单的取值操作而已。</p>
<p>
取值来源需要检测是不是根节点，如果是根节点</p>
<p>
<code>provides = instance.vnode.appContext.provides</code></p>
<p>
否则，使用 <code>instance.parent.provides</code></p>
<p>
然后根据 <code>key</code> 取出值 <code>provides[key]</code></p>
<p>
如果有默认值需要返回默认值?</p>
<p>
<code>defaultValue</code> 或 <code>defaultValue()</code></p>
<p>
居然如此简单~~~，还是先看下怎么用吧！！！</p>
</div>
</div>
<div id="outline-container-headline-57" class="outline-3">
<h3 id="headline-57">
test
</h3>
<div id="outline-text-headline-57" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span> <span class="nx">provide</span><span class="p">,</span> <span class="nx">inject</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">serialize</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">skey</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">Provider</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;foo-p1&#34;</span><span class="p">);</span>
      <span class="c1">// 支持符号属性名
</span><span class="c1"></span>      <span class="nx">provide</span><span class="p">(</span><span class="nx">skey</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="c1">// 可以是其他类型 ref, reactive, ...
</span><span class="c1"></span>      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Provider2</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Provider2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;foo-p2&#34;</span><span class="p">);</span>
      <span class="nx">provide</span><span class="p">(</span><span class="s2">&#34;baz&#34;</span><span class="p">,</span> <span class="s2">&#34;baz&#34;</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Middle</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Middle</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Consumer</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Consumer</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">symb</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="nx">skey</span><span class="p">);</span>
      <span class="c1">// 这里 foo 拿到的会是 Provider2 的 foo 值
</span><span class="c1"></span>      <span class="c1">// 因为 provides 原型链是基于组件父子关系来创建的
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">);</span>
      <span class="c1">// 默认值
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">bar</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span><span class="p">);</span>
      <span class="c1">// 因为是简单的赋值操作，所以这里的 count 就是 ref(1) 返回的那个 count
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">inject</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="nx">symb</span><span class="p">,</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Provider</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;1. root serialize, &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">s</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;2. root serialize, &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
1. root serialize, &lt;div&gt;2,foo-p2,bar,1&lt;/div&gt;
undefined2. root serialize, &lt;div&gt;2,foo-p2,bar,2&lt;/div&gt;
</pre>
<p>
组件层级关系(父-&gt;子)： <code>Provider -&gt; Middle -&gt; Consumer</code></p>
<p>
在 <code>provide(&#39;foo&#39;, 1)</code> 则在 Provider 组件的 provides 中增加了 <code>{ foo: 1 }</code> ,由于
子组件的 provides 是沿用或继承了父级的 provides。</p>
<p>
所以在子组件 <code>Consumer</code> 中直接调用 <code>inject(&#39;foo&#39;)</code> 是在 instance.provides 里面去
找这个属性对应的值，如果没找到则一直在原型链上往上找，最后找到顶级父组件
<code>Provider</code> 上找到包含 <code>&#39;foo&#39;</code> 属性，则返回这个值。</p>
<p>
所以， <code>inject&amp;provide</code> 的应用其实就是原型链的应用，目的是为了让父组件可以像子组
件注入一些值。</p>
<blockquote>
<ol>
<li>
<p>那么为什么注入的值直接变成了 <code>&lt;div&gt;1&lt;/div&gt;</code> 子节点了？</p>
</li>
</ol>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-58" class="outline-2">
<h2 id="headline-58">
✨ api computed
</h2>
<div id="outline-text-headline-58" class="outline-text-2">
<p>
这个 api 是对 reactivity&gt;computed 的一次简单封装，详情请直接查看 <a href="/vue/vue-mind-map-reactivity/#computed">reactivity对应的 computed 一节</a>。</p>
<p>
代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">getter</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">ComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">options</span>: <span class="kt">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WritableComputedRef</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">computed</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span>
  <span class="nx">getterOrOptions</span>: <span class="kt">ComputedGetter</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">WritableComputedOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">_computed</span><span class="p">(</span><span class="nx">getterOrOptions</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span>
  <span class="nx">recordInstanceBoundEffect</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">effect</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-59" class="outline-2">
<h2 id="headline-59">
🌀 api lifecycle
</h2>
<div id="outline-text-headline-59" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/071d8689ca31c9b7c9452986d82e02d3a1769abc">feat(add): api lifecycle init · gcclll/stb-vue-next@071d868 · GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ee888568952467086d445d2c6f8bb40b4c5be9e9">feat(add): api lifecycle exports · gcclll/stb-vue-next@ee88856 · GitHub</a>
组件声明周期 api 。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">injectHook</span><span class="p">(</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">LifecycleHooks</span><span class="p">,</span>
  <span class="nx">hook</span>: <span class="kt">Function</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="nx">__weh?</span>: <span class="kt">Function</span> <span class="p">},</span>
  <span class="nx">target</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">,</span>
  <span class="nx">prepend</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span>  <span class="k">return</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">createHook</span> <span class="o">=</span> <span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">Function </span><span class="o">=</span> <span class="err">()</span> <span class="err">=</span><span class="p">&gt;</span> <span class="kt">any</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="nx">lifecycle</span>: <span class="kt">LifecycleHooks</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">hook</span>: <span class="kt">T</span><span class="p">,</span> <span class="nx">target</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="o">!</span><span class="nx">isInSSRComponentSetup</span> <span class="o">&amp;&amp;</span> <span class="nx">injectHook</span><span class="p">(</span><span class="nx">lifecycle</span><span class="p">,</span> <span class="nx">hook</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onBeforeMount</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_MOUNT</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onMounted</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">MOUNTED</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onBeforeUpdate</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_UPDATE</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onUpdated</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UPDATED</span><span class="p">)</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">onUnMount</span> <span class="o">=</span> <span class="nx">createHook</span><span class="p">(</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UNMOUNTED</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
如上，所有的声明周期函数都是通过 createHook -&gt; injectHook 实现，所以这部分的重点
就是这个 <code>injectHook(type, hook, targt, prepend)</code> 。</p>
<p>
在 <code>createHook()</code> 里面有检测是不是 SSR 环境，只有非 SSR 环境下才会有声明周期。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6e9cd1443626bda721740e7dd1dad8cbc9a8cc1f">feat(add): api lifecycle injectHook · gcclll/stb-vue-next@6e9cd14 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">injectHook</span><span class="p">(</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">LifecycleHooks</span><span class="p">,</span>
  <span class="nx">hook</span>: <span class="kt">Function</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="nx">__weh?</span>: <span class="kt">Function</span> <span class="p">},</span>
  <span class="nx">target</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">currentInstance</span><span class="p">,</span>
  <span class="nx">prepend</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">hooks</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="kr">type</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="kr">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="c1">// 将 hook 的执行封装成一个 error handling warpper 函数，并且缓存到 hook.__weh
</span><span class="c1"></span>    <span class="c1">// 上，这样在调度器里面调用的时候可以进行去重，因为 scheduler 里面执行的时候
</span><span class="c1"></span>    <span class="c1">// 有去重操作，这里的 __weh = &#39;with error handling&#39;
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">wrappedHook</span> <span class="o">=</span>
      <span class="nx">hook</span><span class="p">.</span><span class="nx">__weh</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">hook</span><span class="p">.</span><span class="nx">__weh</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span>: <span class="kt">unknown</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">isUnmounted</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// 在所有的声明周期函数中都 disable tracking
</span><span class="c1"></span>        <span class="c1">// 因为它们有可能在 effects 中被调用
</span><span class="c1"></span>        <span class="nx">pauseTracking</span><span class="p">();</span>
        <span class="c1">// 在 hook 执行期间设置 currentInstance = targt
</span><span class="c1"></span>        <span class="c1">// 假设 hook 没有同步地触发其他 hooks，即在一个 hook 里面同步调用
</span><span class="c1"></span>        <span class="c1">// 另一个声明周期函数？
</span><span class="c1"></span>        <span class="nx">setCurrentInstance</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
        <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">callWithAsyncErrorHandling</span><span class="p">(</span><span class="nx">hook</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="kr">type</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="nx">setCurrentInstance</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="nx">resetTracking</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
      <span class="p">});</span>

    <span class="nx">prepend</span> <span class="o">?</span> <span class="nx">hooks</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">wrappedHook</span><span class="p">)</span> <span class="o">:</span> <span class="nx">hooks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">wrappedHook</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">wrappedHook</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>
<p>lifecycle hook 可以在 setup() 中执行</p>
</li>
<li>
<p>这里的所有声明周期函数都以事件形式存在，意味着可以通过这些 api 注册哪个声明周
期需要执行操作的函数</p>
</li>
<li>
<p>在声明周期函数执行期间不进行 <code>track</code> 收集依赖操作，它有可能在 setup() 中进行</p>
</li>
</ol>
<blockquote>
<p>使用原理：调用 <code>onXxx(fn, ins)</code> 声明周期函数时，实际上只是向当前的实例
<code>currentInstane[type] = []</code> 上注册了一个回调函数 fn。比如：</p>
<p>
<code>target.onMounted = [fn1, fn2] // target -&gt; currentInstance 当前实例</code></p>
<p>
然后在组件 render/update 过程中根据声明周期的阶段调用对应的 fns 。</p>
</blockquote>
<div id="outline-container-headline-60" class="outline-3">
<h3 id="headline-60">
test base
</h3>
<div id="outline-text-headline-60" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onMounted</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">onBeforeUnmount</span><span class="p">,</span>
    <span class="nx">onBeforeUnmounted</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="sb">`\n-&gt; </span><span class="si">${</span><span class="nx">stage</span><span class="si">}</span><span class="sb">, called = </span><span class="si">${</span><span class="nx">called</span><span class="si">}</span><span class="sb">, serialize root = &#34;</span><span class="si">${</span><span class="nx">s</span><span class="p">()</span><span class="si">}</span><span class="sb">&#34; }`</span><span class="p">);</span>
  <span class="c1">// count.value++
</span><span class="c1"></span><span class="p">};</span>

<span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// 这里故意将 onMounted 放在前面
</span><span class="c1"></span>      <span class="c1">// 结果会发现这个还是最后才执行
</span><span class="c1"></span>      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onMounted&#34;</span><span class="p">));</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeMount&#34;</span><span class="p">));</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeUpdate&#34;</span><span class="p">));</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onUpdated&#34;</span><span class="p">));</span>

      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after set value...&#34;</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

-&gt; onBeforeMount, called = 1, serialize root = &#34;&#34; }

-&gt; onMounted, called = 2, serialize root = &#34;&lt;div&gt;0&lt;/div&gt;&#34; }
undefined
-&gt; onBeforeUpdate, called = 3, serialize root = &#34;&lt;div&gt;0&lt;/div&gt;&#34; }

-&gt; onUpdated, called = 4, serialize root = &#34;&lt;div&gt;1&lt;/div&gt;&#34; }
after set value...
&lt;div&gt;1&lt;/div&gt;
</pre>
</div>
</div>
<div id="outline-container-headline-61" class="outline-3">
<h3 id="headline-61">
test update
</h3>
<div id="outline-text-headline-61" class="outline-text-3">
<p>
测试在 <code>onBeforeUpdate</code> 中执行值更新操作会怎样？</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="sb">`\n-&gt; </span><span class="si">${</span><span class="nx">stage</span><span class="si">}</span><span class="sb">, called = </span><span class="si">${</span><span class="nx">called</span><span class="si">}</span><span class="sb">, serialize root = &#34;</span><span class="si">${</span><span class="nx">s</span><span class="p">()</span><span class="si">}</span><span class="sb">&#34; }`</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;-&gt; onUpdated, count.value = &#39;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">()))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeUpdate&#34;</span><span class="p">));</span>

      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after set value...&#34;</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
-&gt; onBeforeUpdate, called = 1, serialize root = &#34;&lt;div&gt;0&lt;/div&gt;&#34; }
-&gt; onUpdated, count.value = 2, &lt;div&gt;2&lt;/div&gt;
after set value...
&lt;div&gt;2&lt;/div&gt;
</pre>
<blockquote>
<ol>
<li>
<p>最后 count.value 渲染出来是 2？</p>
</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-headline-62" class="outline-3">
<h3 id="headline-62">
test unmount
</h3>
<div id="outline-text-headline-62" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">onBeforeUnmount</span><span class="p">,</span>
    <span class="nx">onUnmounted</span><span class="p">,</span>
    <span class="nx">onMounted</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">serializeInner</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stage</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">(</span><span class="sb">`\n-&gt; </span><span class="si">${</span><span class="nx">stage</span><span class="si">}</span><span class="sb">, called = </span><span class="si">${</span><span class="nx">called</span><span class="si">}</span><span class="sb">, serialize root = &#34;</span><span class="si">${</span><span class="nx">s</span><span class="p">()</span><span class="si">}</span><span class="sb">&#34; }`</span><span class="p">);</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">toggle</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Child</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Child</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onBeforeUnmount&#34;</span><span class="p">));</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="s2">&#34;onUnmounted&#34;</span><span class="p">));</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// 这等于是等组件加载完成之后在注册 unmount
</span><span class="c1"></span>        <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;-&gt; onBeforeUnmount called in onMounted&#34;</span><span class="p">));</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">root</span><span class="p">);</span>
  <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\nafter set value...&#34;</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
-&gt; onBeforeUnmount, called = 1, serialize root = &#34;&lt;div&gt;&lt;/div&gt;&#34; }
-&gt; onBeforeUnmount called in onMounted

-&gt; onUnmounted, called = 2, serialize root = &#34;&lt;!----&gt;&#34; }

after set value...
&lt;!----&gt;
</pre>
</div>
</div>
<div id="outline-container-lc-test-order" class="outline-3">
<h3 id="lc-test-order">
test order
</h3>
<div id="outline-text-lc-test-order" class="outline-text-3">
<p>
测试声明周期函数执行顺序(和调用顺序无关)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">onBeforeMount</span><span class="p">,</span>
    <span class="nx">onMounted</span><span class="p">,</span>
    <span class="nx">onBeforeUpdate</span><span class="p">,</span>
    <span class="nx">onUpdated</span><span class="p">,</span>
    <span class="nx">onBeforeUnmount</span><span class="p">,</span>
    <span class="nx">onUnmounted</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Root</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onBeforeMount&#39;</span><span class="p">))</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onMounted&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onBeforeUpdate&#39;</span><span class="p">))</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onUpdated&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onBeforeUnmount&#39;</span><span class="p">))</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;root onUnmounted&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Mid</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="p">});</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Mid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onBeforeMount&#39;</span><span class="p">))</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onMounted&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onBeforeUpdate&#39;</span><span class="p">))</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onUpdated&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onBeforeUnmount&#39;</span><span class="p">))</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Mid onUnmounted&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Child</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">count</span> <span class="p">});</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">Child</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">onBeforeMount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onBeforeMount&#39;</span><span class="p">))</span>
      <span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onMounted&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUpdate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onBeforeUpdate&#39;</span><span class="p">))</span>
      <span class="nx">onUpdated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onUpdated&#39;</span><span class="p">))</span>
      <span class="nx">onBeforeUnmount</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onBeforeUnmount&#39;</span><span class="p">))</span>
      <span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Child onUnmounted&#39;</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>


  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Root</span><span class="p">),</span> <span class="nx">root</span><span class="p">)</span>
 <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n0. before update value &gt;&#39;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">])</span>
  <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1">// update
</span><span class="c1"></span>  <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n1. update value &gt;&#39;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">])</span>
  <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1">// unmount
</span><span class="c1"></span>  <span class="nx">render</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">root</span><span class="p">)</span>
  <span class="nx">log</span><span class="p">([</span><span class="s1">&#39;\n2. unmount &gt;&#39;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">])</span>
  <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

0. before update value &gt; [
  &#39;root onBeforeMount&#39;,
  &#39;Mid onBeforeMount&#39;,
  &#39;Child onBeforeMount&#39;,
  &#39;Child onMounted&#39;,
  &#39;Mid onMounted&#39;,
  &#39;root onMounted&#39;
]
undefined
1. update value &gt; [
  &#39;root onBeforeUpdate&#39;,
  &#39;Mid onBeforeUpdate&#39;,
  &#39;Child onBeforeUpdate&#39;,
  &#39;Child onUpdated&#39;,
  &#39;Mid onUpdated&#39;,
  &#39;root onUpdated&#39;
]

2. unmount &gt; [
  &#39;root onBeforeUnmount&#39;,
  &#39;Mid onBeforeUnmount&#39;,
  &#39;Child onBeforeUnmount&#39;,
  &#39;Child onUnmounted&#39;,
  &#39;Mid onUnmounted&#39;,
  &#39;root onUnmounted&#39;
]
</pre>
<p>
从上面的结果可知整个组件声明周期发生过程。</p>
<ol>
<li>
<p>组件 mount 顺序， child -&gt; mid -&gt; comp，子组件 -&gt; … -&gt; 父组件</p>
</li>
<li>
<p>组件 update 顺序， child -&gt; mid -&gt; comp, 子组件 -&gt; … -&gt; 父组件</p>
</li>
<li>
<p>组件 unmount 顺序， child -&gt; mid -&gt; comp, 子组件 -&gt; … -&gt; 父组件</p>
</li>
</ol>
<p>组件的 before 声明周期触发顺序是： child -&gt; mid -&gt; comp 完成之后的顺序刚好相反。</p>
</div>
</div>
<div id="outline-container-headline-64" class="outline-3">
<h3 id="headline-64">
test render track &amp; trigger
</h3>
<div id="outline-text-headline-64" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">render</span><span class="p">,</span>
    <span class="nx">nodeOps</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">,</span>
    <span class="nx">serializeInner</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">,</span>
    <span class="nx">nextTick</span><span class="p">,</span>
    <span class="nx">reactive</span><span class="p">,</span>
    <span class="nx">onRenderTracked</span><span class="p">,</span>
    <span class="nx">onRenderTriggered</span>
  <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">let</span> <span class="nx">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">called</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">events</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">bar</span><span class="o">:</span> <span class="mi">2</span> <span class="p">});</span>
  <span class="kr">const</span> <span class="nx">Comp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">onRenderTriggered</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
      <span class="nx">onRenderTracked</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)]);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span><span class="p">(</span><span class="nx">Comp</span><span class="p">),</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">))</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;called = &#39;</span> <span class="o">+</span> <span class="nx">called</span><span class="p">)</span> <span class="c1">// 3
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; track events&#39;</span><span class="p">)</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; trigger events&#39;</span><span class="p">)</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">foo</span><span class="o">++</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">bar</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">baz</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">])))</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>

<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
called = 3
&gt;&gt; track events
{ target: { foo: 1, bar: 2 }, type: &#39;get&#39;, key: &#39;foo&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;has&#39;, key: &#39;bar&#39; }
{ target: { foo: 1, bar: 2 }, type: &#39;iterate&#39;, key: Symbol(iterate) }
&gt;&gt; trigger events
{ target: { foo: 2, bar: 2 }, key: &#39;foo&#39;, type: &#39;set&#39; }
{ target: { foo: 2 }, key: &#39;bar&#39;, type: &#39;delete&#39; }
{ target: { foo: 2, baz: 3 }, key: &#39;baz&#39;, type: &#39;add&#39; }
undefined
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-define-component" class="outline-2">
<h2 id="define-component">
🦉 api define component
</h2>
<div id="outline-text-define-component" class="outline-text-2">
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// implementation, close to no-op
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineComponent</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">unknown</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">?</span> <span class="p">{</span> <span class="nx">setup</span>: <span class="kt">options</span><span class="p">,</span> <span class="nx">name</span>: <span class="kt">options.name</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">options</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-66" class="outline-2">
<h2 id="headline-66">
🆘 api setup helpers
</h2>
<div id="outline-text-headline-66" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3e71787313dbc4a2eb7624bb75ef140b0cd2247b">feat(add): api setup helpers · gcclll/stb-vue-next@3e71787 · GitHub</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// runtime-core/src/apiSetupHelpers.ts
</span><span class="c1">// implementation
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineProps() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`defineProps() is a compiler-hint helper that is only usable inside `</span> <span class="o">+</span>
        <span class="sb">`&lt;script setup&gt; of a single file component. Its arguments should be `</span> <span class="o">+</span>
        <span class="sb">`compiled away and passing it at runtime has no effect.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineEmit() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span>
      <span class="sb">`defineEmit() is a compiler-hint helper that is only usable inside `</span> <span class="o">+</span>
        <span class="sb">`&lt;script setup&gt; of a single file component. Its arguments should be `</span> <span class="o">+</span>
        <span class="sb">`compiled away and passing it at runtime has no effect.`</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">useContext</span><span class="p">()</span><span class="o">:</span> <span class="nx">SetupContext</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">getCurrentInstance</span><span class="p">()</span><span class="o">!</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">warn</span><span class="p">(</span><span class="sb">`useContext() called without active instance.`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">i</span><span class="p">.</span><span class="nx">setupContext</span> <span class="o">||</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">setupContext</span> <span class="o">=</span> <span class="nx">createSetupContext</span><span class="p">());</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里包含三个函数，其中 <code>defineProps&amp;defineEmit</code> 都是且只会在 <code>&lt;script setup&gt;</code> 里
面使用，他们的作用只是用于 <code>compiler-sfc</code> 包中在 <code>babel/parser</code> 解析语法树期间，
用来标识他们是 props或 emits 的一部分，然后给他们的参数会被当做 props 和 emits
合并到最终 export 出去的对应属性上，所以这两个 define 函数实际上什么都没做。</p>
<p>
看实例吧 -&gt;</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">compile</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">log</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s1">&#39;/vue/lib.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;script setup&gt;
</span><span class="sb">import { defineProps, defineEmit } from &#39;vue&#39;
</span><span class="sb">ref: value = 1
</span><span class="sb">const myEmit = defineEmit([&#39;foo&#39;, &#39;bar&#39;])
</span><span class="sb">const props = defineProps({
</span><span class="sb">  fox: String,
</span><span class="sb">  foy: () =&gt; baz &gt; 1
</span><span class="sb">})
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">&lt;script&gt;
</span><span class="sb">export default {
</span><span class="sb">  props: {
</span><span class="sb">    box: 2
</span><span class="sb">  }
</span><span class="sb">}
</span><span class="sb">&lt;/script&gt;
</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
import { ref as _ref } from &#39;vue&#39;


function setup(__props, { emit: myEmit }) {

const props = __props
const value = _ref(1)



return { value, myEmit, props }
}


const __default__ = {
  props: {
    box: 2
  }
}

export default /*#__PURE__*/ Object.assign(__default__, {
  expose: [],
  props: {
  fox: String,
  foy: () =&gt; baz &gt; 1
},
  emits: [&#39;foo&#39;, &#39;bar&#39;],
  setup
})
undefined
</pre>
<p>
我们把上面结果格式化下：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ref</span> <span class="nx">as</span> <span class="mi">_</span><span class="nx">ref</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;vue&#34;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">setup</span><span class="p">(</span><span class="mi">__</span><span class="nx">props</span><span class="p">,</span> <span class="p">{</span> <span class="nx">emit</span><span class="o">:</span> <span class="nx">myEmit</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">props</span> <span class="o">=</span> <span class="mi">__</span><span class="nx">props</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">myEmit</span><span class="p">,</span> <span class="nx">props</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="mi">__</span><span class="nx">default__</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">box</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kr">export</span> <span class="k">default</span> <span class="cm">/*#__PURE__*/</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="mi">__</span><span class="nx">default__</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">expose</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">fox</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">foy</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">baz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">emits</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span><span class="p">],</span>
  <span class="nx">setup</span><span class="p">,</span>
<span class="p">});</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
从上面的代码可发现：</p>
<ol>
<li>
<p>defineProps 最后被合并成一个 props 对象，并且会和 <code>&lt;script&gt;</code> 中的 export
default 中的 props 进行再次合并，并且这种合并属于简单的替换操作</p>
<p>
所以如果 <code>defineProps</code> 和 <code>script</code> 中同时存在 props 的情况最终 <code>&lt;script&gt;</code> 中
的 props 会被丢弃掉，所以尽量避免这种情况发生。</p>
</li>
<li>
<p>defineEmit 中的属性会被合并到 <code>emits</code> 上</p>
</li>
</ol>
<p><a href="/vue/vue-mind-map-compiler-sfc/">更多有关 &lt;script setup&gt; 的内容请查看 <code>compiler-sfc</code> 包的分析 -&gt;</a></p>
<blockquote>
<p><code>useContext()</code> 是获取当前实例的上下文对象，这个需要继续实现复杂的 render 部分才
可能会使用到。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-67" class="outline-2">
<h2 id="headline-67">
🌊 TODO api async comopnent
</h2>
<div id="outline-text-headline-67" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cb4474ae9c0c040bfed54178a63a3e65c16894b9">feat(add): async component · gcclll/stb-vue-next@cb4474a · GitHub</a></p>
<p>
定义异步组件(<code>defineAsyncComponent(source)</code>)。</p>
<p>
新增初始化：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">isAsyncWrapper</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="nx">VNode</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="o">!!</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="kr">type</span> <span class="kr">as</span> <span class="nx">ComponentOptions</span><span class="p">).</span><span class="nx">__asyncLoader</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">defineAsyncComponent</span><span class="o">&lt;</span>
  <span class="nx">T</span> <span class="kr">extends</span> <span class="nx">Component</span> <span class="o">=</span> <span class="p">{</span> <span class="k">new</span> <span class="p">()</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span> <span class="p">}</span>
<span class="o">&gt;</span><span class="p">(</span><span class="nx">source</span>: <span class="kt">AsyncComponentLoader</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="nx">AsyncComponentOptions</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;)</span><span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="c1">// 1. TODO retry 封装
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// 2. TODO 函数封装
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// 3. TODO 返回组件，检测如果是对象直接返回，or 函数当做 setup() 函数处理
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">defineComponent</span><span class="p">({}</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<blockquote>
<p>通过搜索 <code>__asyncLoader</code> 只在 <code>hydration.ts</code> 中有使用到，而这个貌似又和 SSR 服务
端渲染由关系，所以这里先暂时不继续了，先完成 renderer.ts 的 render 函数部分，然
后在实现了 SSR + hydration 之后再回头来继续。</p>
</blockquote>
<div id="outline-container-headline-68" class="outline-3">
<h3 id="headline-68">
implementation(init)
</h3>
<div id="outline-text-headline-68" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/bd6e903b261cf277dac3f1b8ab4506f7354c0cb4">feat(add): async component-&gt;load · gcclll/stb-vue-next@bd6e903 · GitHub</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1c73e72de509b7e8070b6c3064cfdbf6aadb616f">feat: async component pause await render · gcclll/stb-vue-next@1c73e72 · GitHub</a>
实现主要分几步：</p>
<ol>
<li>
<p>封装 <code>retry()</code> 重试函数</p>
</li>
<li>
<p><code>load()</code> 函数，分支 <code>source.loader()</code> 异步函数</p>
</li>
<li>
<p>组装组件返回 <code>defineComponent({__asyncLoader: load, setup() {...}, ...})</code></p>
<p>
前面 <strong>1</strong>, <strong>2</strong> 都是对 <code>source.loader</code> 进行封装处理，这一步是真正的创建异步组件。</p>
<p>
<a href="#define-component">defineComponent(option)</a> 实现很简单，就是检测 option 如果是函数当做</p>
<p>
<code>{setup: option, name: option.name}</code> 处理，否则直接返回 option</p>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">defineAsyncComponent</span> <span class="p">},</span>
  <span class="nx">rcTest</span><span class="o">:</span> <span class="p">{</span> <span class="nx">createApp</span><span class="p">,</span> <span class="nx">nodeOps</span><span class="p">,</span> <span class="nx">serializeInner</span><span class="o">:</span> <span class="nx">si</span> <span class="p">},</span>
  <span class="nx">f</span><span class="p">,</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">n</span><span class="p">));</span>
  <span class="kd">let</span> <span class="nx">resolve</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">defineAsyncComponent</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">resolve</span> <span class="o">=</span> <span class="nx">r</span><span class="p">)));</span>

  <span class="kr">const</span> <span class="nx">toggle</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodeOps</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">);</span>
  <span class="nx">createApp</span><span class="p">({</span>
    <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s2">&#34;xxx&#34;</span><span class="p">),</span> <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="nx">h</span><span class="p">(</span><span class="nx">Foo</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
    <span class="p">),</span>
  <span class="p">}).</span><span class="nx">mount</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">));</span>

  <span class="c1">// 手动 resolve, 触发 loader().then(comp =&gt; { ... })
</span><span class="c1"></span>  <span class="nx">resolve</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="s2">&#34;resolved&#34;</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">timeout</span><span class="p">();</span>
  <span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>

  <span class="c1">// 到这里 component 已经 resolved 了
</span><span class="c1"></span>  <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span> <span class="c1">// -&gt; null
</span><span class="c1"></span>
  <span class="nx">toggle</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">si</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span> <span class="c1">// -&gt; resolved
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
true xxx

 resolved comp before
loaded.value =  false
&lt;!----&gt;
undefined
async comp load ok,  resolved
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-69" class="outline-2">
<h2 id="headline-69">
🔥 render function
</h2>
<div id="outline-text-headline-69" class="outline-text-2">
<p>
篇幅太长，另起单独文章 -&gt; <a href="/vue/vue-mind-map-runtime-core-render">Vue3 源码头脑风暴之 7 ☞ runtime-core(2) - render</a></p>
</div>
</div>
<div id="outline-container-scheduler" class="outline-2">
<h2 id="scheduler">
🚒 scheduler 任务调度机制
</h2>
<div id="outline-text-scheduler" class="outline-text-2">
<p>
让我们跟着 <code>scheduler.spec.ts</code> 测试用例来逐步属性 scheduler 的调度机制。</p>
<p>
在做这个之前先把 scheduler.ts 中逻辑代码全清空，这个文件还是相对独立的</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a54cc00ee93057839de620a152ca1fe691671f63">feat: rc-&gt;reset scheduler.ts · gcclll/stb-vue-next@a54cc00 · GitHub</a></p>
<p>
我们从零开始一步步来分析实现。</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" alt="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" title="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" /></p>
<p>
这部分包含三种任务的 flush 逻辑代码：</p>
<ol>
<li>
<p>queue jobs -&gt; <code>flushIndex</code> -&gt; <code>queue[]</code> -&gt; <code>queueJob()</code> -&gt; <code>queueFlush()</code> -&gt; <code>flushJobs()</code></p>
</li>
<li>
<p>pre jobs -&gt; <code>preFlushIndex</code> -&gt; <code>pendingPreFlushCbs[]</code> -&gt; <code>activePreFlushCbs[]</code> -&gt;
<code>queuePreFlushCb()</code> -&gt; <code>flushPreFlushCbs()</code> -&gt; <code>flushJobs()</code></p>
</li>
<li>
<p>TODO post jobs -&gt; …</p>
</li>
</ol>
<div id="outline-container-nexttick" class="outline-3">
<h3 id="nexttick">
nextTick
</h3>
<div id="outline-text-nexttick" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/32b482762b074d3123906887df35231efea7dcc7">feat(add): rc-&gt;scheduler -&gt; nextTick · gcclll/stb-vue-next@32b4827 · GitHub</a></p>
<p>
在 queue 所有队列清空之后执行的一个异步操作，有重要关联的两个变量：</p>
<ol>
<li>
<p>resolvedPromise，一个空的 promise then</p>
</li>
<li>
<p>currentFlushPromise，当 queue 队列中的所有任务执行完成之后返回的一个 promise</p>
<p>
是的，是所有 queue jobs 完成之后，因为 flushJobs 函数里面都是同步操作，重要代
码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">for</span> <span class="p">(</span><span class="nx">flushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">flushIndex</span> <span class="o">&lt;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">flushIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">flushIndex</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">job</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO DEV -&gt; 检查递归更新问题
</span><span class="c1"></span>    <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">job</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">SCHEDULER</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<blockquote>
<p>所以 nextTick 任务总是在 queue jobs 所有任务完成之后执行。</p>
</blockquote>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">resolvedPromise</span>: <span class="kt">Promise</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
<span class="c1">// 当前正在被执行的 promise 任务
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">currentFlushPromise</span>: <span class="kt">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">nextTick</span><span class="p">(</span>
  <span class="k">this</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span> <span class="o">|</span> <span class="k">void</span><span class="p">,</span>
  <span class="nx">fn</span><span class="o">?:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">currentFlushPromise</span> <span class="o">||</span> <span class="nx">resolvedPromise</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">fn</span> <span class="o">?</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span> <span class="o">?</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
函数作用：在当前正在执行的 job promise 之后执行 nextTick 的任务，等于说 nextTick
属于个插队任务。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">pr</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">dummyThen</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="nx">nextTick</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">job2</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nbefore await, &#34;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">]);</span>
  <span class="kr">await</span> <span class="nx">dummyThen</span><span class="p">;</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nafter await, &#34;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&#34;\n&#34;</span><span class="p">]);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">calls</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

before await,  1

after await,  2

job2-job1
</pre>
<blockquote>
<p>Tip. nextTick() 异步代码执行，经过 babel 转换后的代码，请查看 <a href="#q-nexttick">nextTick question</a></p>
</blockquote>
</div>
</div>
<div id="outline-container-job-queue-job" class="outline-3">
<h3 id="job-queue-job">
queueJob
</h3>
<div id="outline-text-job-queue-job" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/eb33b40b7e8e87165fa2149b1a1354d078f33c40">feat(add): rc-&gt;scheduler-&gt;queueJob · gcclll/stb-vue-next@eb33b40 · GitHub</a></p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" alt="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" title="/img/vue3/runtime-core/vue-runtime-core-scheduler.svg" /></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span>: <span class="kt">SchedulerJob</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// the dedupe search uses the startIndex argument of Array.includes()
</span><span class="c1"></span>  <span class="c1">// by default the search index includes the current job that is being run
</span><span class="c1"></span>  <span class="c1">// so it cannot recursively trigger itself again.
</span><span class="c1"></span>  <span class="c1">// if the job is a watch() callback, the search will start with a +1 index to
</span><span class="c1"></span>  <span class="c1">// allow it recursively trigger itself - it is the user&#39;s responsibility to
</span><span class="c1"></span>  <span class="c1">// ensure it doesn&#39;t end up in an infinite loop.
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span>
    <span class="p">(</span><span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span>
      <span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span>
        <span class="nx">job</span><span class="p">,</span>
        <span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">?</span> <span class="nx">flushIndex</span> <span class="o">+</span> <span class="nx">1</span> : <span class="kt">flushIndex</span>
      <span class="p">))</span> <span class="o">&amp;&amp;</span>
    <span class="nx">job</span> <span class="o">!==</span> <span class="nx">currentPreFlushParentJob</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">job</span><span class="p">)</span>
    <span class="nx">queueFlush</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">queueFlush() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFlushPending</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">isFlushPending</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">currentFlushPromise</span> <span class="o">=</span> <span class="nx">resolvedPromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">flushJobs</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 请查看下一节的实现
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">flushJobs</span><span class="p">(</span><span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
需要 flushJobs 支持，请到 flushJobs(👇) 一节查看测试情况。</p>
</div>
</div>
<div id="outline-container-headline-73" class="outline-3">
<h3 id="headline-73">
flushJobs
</h3>
<div id="outline-text-headline-73" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e23be119f8b67f8c828f01f031f2488afa55c0c9">feat(add): rc-&gt;scheduler-&gt;flushJobs function · gcclll/stb-vue-next@e23be11 · GitHub</a></p>
<ol>
<li>
<p>isFlushPending, isFlushing 标识重置</p>
</li>
<li>
<p><a href="#job-flush-pre">flushPreFlushCbs</a>, 对 pre 类型的 jobs 进行 flush 操作，有关函数
<code>flushPreFlushCbs(flush函数)</code> 和 <code>queuePreFlushCb(入列函数)</code></p>
</li>
<li>
<p>flush 之前进行排序</p>
</li>
<li>
<p>try -&gt; callWithErrorHandling 执行任务回调</p>
</li>
<li>
<p>finally -&gt; 重置，清空 queue 队列内容和标识</p>
</li>
<li>
<p>TODO flushPostFlushCbs, 对 post 类型的 jobs 进行 flush 操作，有关函数
<code>flushPostFlushCbs</code> 和 <code>queuePostFlushCb</code></p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">flushJobs</span><span class="p">(</span><span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">isFlushPending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">isFlushing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">seen</span> <span class="o">=</span> <span class="nx">seen</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// flushPreFLushCbs(seen)，默认的 job 类型
</span><span class="c1"></span>
  <span class="c1">// flush 之前对 queue 排序
</span><span class="c1"></span>  <span class="c1">// 1. 组件更新顺序：parent -&gt; child，因为 parent 总是在 child 之前
</span><span class="c1"></span>  <span class="c1">//    被创建，因此 parent render effect 有更低的优先级数字(数字越小越先创建？)
</span><span class="c1"></span>  <span class="c1">// 2. 如果组件在 parent 更新期间被卸载了，那么它的更新都会被忽略掉
</span><span class="c1"></span>
  <span class="nx">queue</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">b</span><span class="p">));</span>

  <span class="c1">// 开始 flush
</span><span class="c1"></span>  <span class="k">try</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">flushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">flushIndex</span> <span class="o">&lt;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">flushIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">flushIndex</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">job</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO DEV -&gt; 检查递归更新问题
</span><span class="c1"></span>        <span class="nx">callWithErrorHandling</span><span class="p">(</span><span class="nx">job</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">SCHEDULER</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="c1">// 情况队列
</span><span class="c1"></span>    <span class="nx">flushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// TODO flush `post` 类型的 flush cbs
</span><span class="c1"></span>
    <span class="nx">isFlushing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">currentFlushPromise</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="c1">// TDOO 代码执行到当前 tick 的时候，有可能有新的 job 加入
</span><span class="c1"></span>    <span class="c1">// some postFlushCb queued jobs!
</span><span class="c1"></span>    <span class="c1">// keep flushing until it drains.
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #1
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;job1 running&#34;</span><span class="p">);</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #2
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;job2 running&#34;</span><span class="p">);</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="c1">// 支持去重
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span> <span class="c1">// #3
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span> <span class="c1">// #4
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before await  &#34;</span> <span class="o">+</span> <span class="nx">calls</span><span class="p">);</span> <span class="c1">// #5
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span> <span class="c1">// #6
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after await  &#34;</span> <span class="o">+</span> <span class="nx">calls</span><span class="p">);</span> <span class="c1">// #7
</span><span class="c1"></span><span class="p">};</span>

<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
before await
undefined

job1 running


job2 running
after await  job1,job2
</pre>
<p>
如果在没有 <strong>#6</strong> 的情况下，在所有 Log 之后会立即执行 queue jobs。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">queueFlush() {</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFlushPending</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">isFlushPending</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">currentFlushPromise</span> <span class="o">=</span> <span class="nx">resolvedPromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">flushJobs</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里 nextTick() 调用并没有传递 fn ，因此 <code>await nextTick()</code> 在这里的作用就是等
<code>resolvedPromise</code> 执行完成(此时并没有正在执行的 promise)</p>
<p>
<code>const resolvedPromise: Promise&lt;any&gt; = Promise.resolve()</code></p>
<p>
再执行后面的代码。</p>
<p>
queueJob 函数分为两步：</p>
<ol>
<li>
<p>push 收集任务 <code>queue.push(job)</code> ，同步执行</p>
</li>
<li>
<p>随后立即调用 <code>queueFlush()</code> 刷掉任务，任务异步 flush</p>
</li>
</ol>
<p>在这个实例中，按照同步执行顺序，</p>
<ol>
<li>
<p><code>queueJob(job1)</code> 执行，将 job1 -&gt; push -&gt; queue 中， queueFlush 中的 promise 等待</p>
</li>
<li>
<p><code>queueJob(job2)</code> 执行，将 job2 -&gt; push -&gt; queue 中，
queueFlush 中的 promise 继续等待</p>
</li>
<li>
<p><code>log before</code> 执行，由于 job 虽然已经在 queue 中了，但是需要等待 queueFlush 去
异步执行他们，所以这里 calls 依旧是空的</p>
</li>
<li>
<p><code>await nextTick()</code> 异步操作</p>
<p>
这一句目的只是为了让后面的 log 在 job1,job2 后面执行。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">currentFlushPromise</span> <span class="o">||</span> <span class="nx">resolvedPromise</span><span class="p">;</span>
 <span class="k">return</span> <span class="nx">fn</span> <span class="o">?</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span> <span class="o">?</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
nextTick 会在刚刚执行完毕的 promise 后面取执行后面的任务，所以 log after 肯定是后于 job1,job2 的执行的。</p>
</li>
<li>
<p>所有同步任务执行完成，开始进入异步任务执行，由于 job1,job2 先入队列，在事件循
环中会先于 log after 执行，然后在执行 log after，所以就有了上面的输出结果。</p>
</li>
</ol>
<p>
实例执行脑图：</p>
<p>
<img src="/img/tmp/20210112173934.png" alt="/img/tmp/20210112173934.png" title="/img/tmp/20210112173934.png" /></p>
</div>
</div>
<div id="outline-container-headline-74" class="outline-3">
<h3 id="headline-74">
queueJob while flushing
</h3>
<div id="outline-text-headline-74" class="outline-text-3">
<p>
当 queue 中 jobs 正在被执行的时候调用 queueJob 进入新的任务。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
    <span class="c1">// job2 任务会在 job1 执行到这里的时候加入到了 queue
</span><span class="c1"></span>    <span class="c1">// 但是它的执行需等到 queue 中的任务执行完成之后再执行
</span><span class="c1"></span>    <span class="c1">// 因为任务收集是同步的，任务执行是异步的，而 queue flush 操作又是同步的
</span><span class="c1"></span>    <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">([</span><span class="s2">&#34;\nafter await\n&#34;</span><span class="p">,</span> <span class="nx">calls</span><span class="p">]);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
after await
 [ &#39;job1&#39;, &#39;job2&#39; ]
</pre>
<p>
看下面的测试代码（在 for 循环过程中改变数组长度，会检测到这种改变）：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span>
<span class="kr">const</span> <span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">add</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="o">:</span> <span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">l</span><span class="o">:</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{ i: 0, v: 1, l: 3 }
{ i: 1, v: 2, l: 4 }
{ i: 2, v: 3, l: 4 }
{ i: 3, v: 2, l: 4 }
undefined
</pre>
<p>
所以上面的 Job 实例，就很好理解了</p>
<p>
在 for queue jobs 过程中发现有新的 job 进入，之前说过了  queue 的入列操作是同步
的，所以会立即执行改变 queue 长度，最后加入的任务会在 for 循环过程中最后得到执行。</p>
</div>
</div>
<div id="outline-container-headline-75" class="outline-3">
<h3 id="headline-75">
queuePreFlushCb
</h3>
<div id="outline-text-headline-75" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2c72cdc8734a3317041e4b14f288732379b4f1d2">feat(add): rc-&gt;scheduler-&gt;queuePreFlushCb -&gt; pre jobs, pendingPreFlus… · gcclll/stb-vue-next@2c72cdc · GitHub</a></p>
<p>
新增代码：</p>
<ol>
<li>
<p><code>queuePreFlushCb</code>, 入列 pre jobs 函数</p>
</li>
<li>
<p><code>flushPreFlushCbs</code>, flush pre jobs 函数</p>
</li>
<li>
<p><code>flushJobs</code> 中调用 <code>flushPreFlushCbs()</code> 刷掉 pre jobs</p>
</li>
</ol>
<p>这个是用来收集和 flush pre 类型(默认类型的任务)的队列 <code>pendingPreFlushCbs[]</code>  的函数。</p>
<p>
逻辑脑图：
<img src="/img/tmp/20210113103504.png" alt="/img/tmp/20210113103504.png" title="/img/tmp/20210113103504.png" /></p>
<p>
相关代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb</span>: <span class="kt">SchedulerCb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">queueCb</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">activePreFlushCbs</span><span class="p">,</span> <span class="nx">pendingPreFlushCbs</span><span class="p">,</span> <span class="nx">preFlushIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">queueCb</span><span class="p">(</span>
  <span class="nx">cb</span>: <span class="kt">SchedulerCbs</span><span class="p">,</span>
  <span class="nx">activeQueue</span>: <span class="kt">SchedulerCb</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">pendingQueue</span>: <span class="kt">SchedulerCb</span><span class="p">[],</span>
  <span class="nx">index</span>: <span class="kt">number</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">cb</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">activeQueue</span> <span class="o">||</span>
      <span class="o">!</span><span class="nx">activeQueue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span>
        <span class="nx">cb</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">cb</span> <span class="kr">as</span> <span class="nx">SchedulerJob</span><span class="p">).</span><span class="nx">allowRecurse</span> <span class="o">?</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">1</span> : <span class="kt">index</span>
      <span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nx">pendingQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">pendingQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">cb</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">queueFlush</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
对比 queueCb 和 queueJob 会发现两者没多大的差别，先同步收集再异步 flush，两者判
断条件有细微差别，另外 queueJob 支持数组形式的 cb：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// queueJob
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span>
  <span class="p">(</span><span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span>
    <span class="o">!</span><span class="nx">queue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span>
      <span class="nx">job</span><span class="p">,</span>
      <span class="nx">isFlushing</span> <span class="o">&amp;&amp;</span> <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">?</span> <span class="nx">flushIndex</span> <span class="o">+</span> <span class="nx">1</span> : <span class="kt">flushIndex</span>
    <span class="p">))</span> <span class="o">&amp;&amp;</span>
  <span class="nx">job</span> <span class="o">!==</span> <span class="nx">currentPreFlushParentJob</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="nx">queueFlush</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
最后也都是调用 queueFlush() -&gt; flushJobs() 来清空队列 pendingQueue/queue 。</p>
<p>
所以下面还需要在 flushJobs() 里面去实现对 pre -&gt; pendingQueue 类型队列 flush 操
作(<code>flushPreFlushCbs()</code>)。</p>
</div>
</div>
<div id="outline-container-job-flush-pre" class="outline-3">
<h3 id="job-flush-pre">
flushPreFlushCbs
</h3>
<div id="outline-text-job-flush-pre" class="outline-text-3">
<p>
有关函数和变量</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>preFlushIndex</code></td>
<td>number</td>
<td>used in `for` to flush pre jobs</td>
</tr>
<tr>
<td><code>pendingPreFlushCbs</code></td>
<td>array</td>
<td>the queue to store pre jobs</td>
</tr>
<tr>
<td><code>activePreFlushCbs</code></td>
<td>array</td>
<td>the non-repeat copy of <code>pendingPreFlushCbs</code>, used to flushing</td>
</tr>
<tr>
<td><code>queuePreFlushCb</code></td>
<td>function</td>
<td>与 flushPreFlushCbs 对应的 pre job 入列函数</td>
</tr>
<tr>
<td><code>queueFlush</code></td>
<td>function</td>
<td>执行队列任务的函数，三个类型的任务都在这里面执行(pre,post,queue)</td>
</tr>
<tr>
<td><code>flushJobs</code></td>
<td>function</td>
<td>具体执行任务的函数，三种任务执行顺序是： pre -&gt; queue -&gt; post</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Tip</strong>. <code>activePreFlushCbs</code> 和 <code>pendingPreFlushCbs</code> 的关系： 前者是后者的一个拷贝，
拷贝完会立即清空 pending, 目的是为了让 pending 在 active flushing 期间能继续收集
新的任务，这样如果在执行期间有新的任务入列，那么在函数最后的递归操作会对这些新入
列的任务继续 flush 掉，直到再也没有新的任务入列为止。</p>
<p>
<strong>注意点</strong> ：当 <code>queuePreFlushCb</code> 在 queueJob 中使用时不会主动触发 cbs 执行，如果
需要立即执行这些 cbs 需要手动调用 <code>flushPreFlushCbs(seen, parentJob)</code> 去刷掉 pre
cbs 任务，或者等到当前 job 执行完了下一个 <code>flushJobs()</code> 调用中执行，因为
<code>queueJob()</code> 执行期间 <code>isFlushing = true</code> ，而在 <code>queueFlush()</code> 中有检测这个值，
如果正在执行 flushing 是不会继续执行的，更多详情查看后面的测试和分析。</p>
</blockquote>
<p>
源码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">flushPreFlushCbs</span><span class="p">(</span>
  <span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">,</span>
  <span class="nx">parentJob</span>: <span class="kt">SchedulerJob</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">pendingPreFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currentPreFlushParentJob</span> <span class="o">=</span> <span class="nx">parentJob</span><span class="p">;</span>
    <span class="nx">activePreFlushCbs</span> <span class="o">=</span> <span class="p">[...</span><span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">pendingPreFlushCbs</span><span class="p">)];</span>
    <span class="nx">pendingPreFlushCbs</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">seen</span> <span class="o">=</span> <span class="nx">seen</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span>
      <span class="nx">preFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">preFlushIndex</span> <span class="o">&lt;</span> <span class="nx">activePreFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">preFlushIndex</span><span class="o">++</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO 检查递归更新问题
</span><span class="c1"></span>      <span class="nx">activePreFlushCbs</span><span class="p">[</span><span class="nx">preFlushIndex</span><span class="p">]();</span>
    <span class="p">}</span>

    <span class="nx">activePreFlushCbs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">preFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">currentPreFlushParentJob</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="c1">// 递归 flush 直到所有 pre jobs 被执行完成
</span><span class="c1"></span>    <span class="nx">flushPreFlushCbs</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">parentJob</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
用途： api watch 里面对默认类型(<code>pre</code>)的任务的入列操作，如下代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// default: &#39;pre&#39;
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">doWatch</span><span class="p">(</span>
  <span class="nx">source</span>: <span class="kt">WatchSource</span> <span class="o">|</span> <span class="nx">WatchSource</span><span class="p">[]</span> <span class="o">|</span> <span class="nx">WatchEffect</span> <span class="o">|</span> <span class="kt">object</span><span class="p">,</span>
  <span class="nx">cb</span>: <span class="kt">WatchCallback</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">immediate</span><span class="p">,</span> <span class="nx">deep</span><span class="p">,</span> <span class="nx">flush</span><span class="p">,</span> <span class="nx">onTrack</span><span class="p">,</span> <span class="nx">onTrigger</span> <span class="p">}</span><span class="o">:</span> <span class="nx">WatchOptions</span> <span class="o">=</span> <span class="nx">EMPTY_OBJ</span><span class="p">,</span>
  <span class="nx">instance</span> <span class="o">=</span> <span class="nx">currentInstance</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">WatchStopHandle</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">scheduler</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;scheduler&#34;</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;sync&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">===</span> <span class="s2">&#34;post&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// default: &#39;pre&#39;
</span><span class="c1"></span>    <span class="nx">scheduler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">instance</span> <span class="o">||</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">isMounted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// with &#39;pre&#39; option, the first call must happen before
</span><span class="c1"></span>        <span class="c1">// the component is mounted so it is called synchronously.
</span><span class="c1"></span>        <span class="nx">job</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePreFlushCb</span><span class="p">,</span> <span class="nx">flushPreFlushCbs</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// #1
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span> <span class="c1">// #2
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span> <span class="c1">// #3
</span><span class="c1"></span>    <span class="c1">// 手动触发 cb1, cb2
</span><span class="c1"></span>    <span class="nx">flushPreFlushCbs</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">job1</span><span class="p">);</span> <span class="c1">// #4
</span><span class="c1"></span>    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span> <span class="c1">// #5
</span><span class="c1"></span>  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span> <span class="c1">// #6
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span> <span class="c1">// #7
</span><span class="c1"></span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span> <span class="c1">// #8
</span><span class="c1"></span>  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span> <span class="c1">// #9
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span> <span class="c1">// #10
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

cb1 cb2 job1
</pre>
<p>
测试分析代码脑图：
<img src="/img/vue3/runtime-core/vue-runtime-core-test-preflush-inside-queuejob.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-test-preflush-inside-queuejob.jpg" title="/img/vue3/runtime-core/vue-runtime-core-test-preflush-inside-queuejob.jpg" /></p>
<p>
文字分析：</p>
<ol>
<li>
<p><strong>#8</strong> 先执行， queueJob -&gt; push job1 -&gt; queue:[job1] -&gt; queueFlush()</p>
<p>
在 queueFlush() 中调用 <code>resolvedPromise.then(flushJobs)</code> 异步执行 flushJobs()
函数刷掉所有任务(pre/job/post)</p>
<p>
并且记录当前 tick 下的 promise: <code>currentFlushPromise</code></p>
<p>
此时的 <code>pendingPreFlushCbs[]</code> 中是没有任何任务的，所以继续执行 try{…} 开始
flush queue[] jobs，这个时候 flushIndex = 0 得到 job1，开始按顺序执行 job1</p>
</li>
<li>
<p><strong>#1</strong> 开始执行</p>
</li>
<li>
<p><strong>#2</strong> 将 cb1 push -&gt; <code>pendingPreFlushCbs=[cb1]</code></p>
</li>
<li>
<p><strong>#3</strong> 将 cb2 push -&gt; <code>pendingPreFlushCbs=[cb1, cb2]</code></p>
</li>
<li>
<p><strong>#4</strong> 手动 flush pre cbs</p>
<p>
在 <code>flushPreFlushCbs(undefind, job1)</code> 中会记录 <code>currentPreFlushParentJob =
job1</code> 这个变量将会在 <code>queueJob(job)</code> 中用来检测 job 是不是当前的 job1 如果是
就不允许 push，因为 job1 下有子任务正在执行，必须等这些子任务(cb1, cb2) 执行完。</p>
</li>
<li>
<p><strong>#6</strong> 开始执行， push &#39;cb1&#39; -&gt; calls: [&#39;cb1&#39;]</p>
</li>
<li>
<p><strong>#7</strong> 开始执行， push &#39;cb2&#39; -&gt; calls: [&#39;cb1&#39;, &#39;cb2&#39;]</p>
</li>
<li>
<p><strong>#5</strong> 开始执行， push &#39;job1&#39; -&gt; alls: [&#39;cb1&#39;, &#39;cb2&#39;, &#39;job1&#39;]</p>
</li>
<li>
<p><strong>#9</strong> 开始执行，因为 nextTick()</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">nextTick</span><span class="p">(</span>
  <span class="k">this</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span> <span class="o">|</span> <span class="k">void</span><span class="p">,</span>
  <span class="nx">fn</span><span class="o">?:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">currentFlushPromise</span> <span class="o">||</span> <span class="nx">resolvedPromise</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">fn</span> <span class="o">?</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span> <span class="o">?</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">:</span> <span class="nx">fn</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里的 await 会等 job1 queueFlush() 触发的 promise.then(flushJobs) 返回的
promise 完成之后再执行后面的代码。</p>
</li>
<li>
<p><strong>#10</strong> log 输出 <code>&#39;cb1,cb2,job1&#39;</code></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-77" class="outline-3">
<h3 id="headline-77">
queuePostFlushCb + flushPostFlushCbs
</h3>
<div id="outline-text-headline-77" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/845c21bfc0ef1797d39a9fd789d79a4fdc3bd399">feat(add): rc-&gt;scheduler-&gt;queuePostFlushCb+flushPostFlushCbs · gcclll/stb-vue-next@845c21b · GitHub</a></p>
<p>
逻辑脑图：
<img src="/img/tmp/20210113143628.png" alt="/img/tmp/20210113143628.png" title="/img/tmp/20210113143628.png" /></p>
<p>
有了 queue job 和 pre cb 的基础分析，这部分也就很好理解了。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb</span>: <span class="kt">SchedulerCbs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">queueCb</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">activePostFlushCbs</span><span class="p">,</span> <span class="nx">pendingPostFlushCbs</span><span class="p">,</span> <span class="nx">postFlushIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">flushPostFlushCbs</span><span class="p">(</span><span class="nx">seen?</span>: <span class="kt">CountMap</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">pendingPostFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">deduped</span> <span class="o">=</span> <span class="p">[...</span><span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">pendingPostFlushCbs</span><span class="p">)];</span>
    <span class="nx">pendingPostFlushCbs</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// #1947 already has active queue, nested flushPostFlushCbs call
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">activePostFlushCbs</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">activePostFlushCbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">deduped</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">activePostFlushCbs</span> <span class="o">=</span> <span class="nx">deduped</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__DEV__</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">seen</span> <span class="o">=</span> <span class="nx">seen</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">activePostFlushCbs</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-</span> <span class="nx">getId</span><span class="p">(</span><span class="nx">b</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span>
      <span class="nx">postFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">postFlushIndex</span> <span class="o">&lt;</span> <span class="nx">activePostFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">postFlushIndex</span><span class="o">++</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO 递归 update 检查
</span><span class="c1"></span>      <span class="nx">activePostFlushCbs</span><span class="p">[</span><span class="nx">postFlushIndex</span><span class="p">]();</span>
    <span class="p">}</span>

    <span class="nx">activePostFlushCbs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">postFlushIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
和 pre cb 的处理有两个不同点：</p>
<ol>
<li>
<p>非回调形式处理 flushing 期间接受到的新任务，而是通过改变执行器
activePostFlushCbs 来实现(和 queue job 类似)</p>
</li>
<li>
<p>没有递归回调形式处理后续的新任务，参考 <strong>1</strong></p>
</li>
</ol>
<p>测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queuePostFlushCb</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">queueJob</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="c1">// len = activePostFlushCbs.length
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span>
    <span class="c1">// 会在同一个 tick 期间执行，因为它在for flushing 期间改变了
</span><span class="c1"></span>    <span class="c1">// activePostFlushCbs，并且紧随 cb1,cb2,cb3 之后执行
</span><span class="c1"></span>    <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb4</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb3&#34;</span><span class="p">);</span>
  <span class="c1">// job1 会在 cb4 之后执行，因为 flushJobs 在按顺序执行完
</span><span class="c1"></span>  <span class="c1">// pre -&gt; job -&gt; post 最后的 finally 里面对 queue 进行了检测
</span><span class="c1"></span>  <span class="c1">// 此时 queue = [job1] 随意会递归调用 flushJobs() 继续刷
</span><span class="c1"></span>  <span class="c1">// 但是为什么 cb5 会在 job1 之后呢？？？
</span><span class="c1"></span>  <span class="c1">// 因为 queuePostFlushCb push 的是 pendingPostFlushCbs 而不是
</span><span class="c1"></span>  <span class="c1">// activePostFlushCbs，所以在 queuePostFlushCb 中调用自身增加的新
</span><span class="c1"></span>  <span class="c1">// cbs 会在 finally 后面的检测递归 flushJobs() 调用中执行
</span><span class="c1"></span>  <span class="c1">// 而 post 的优先级又低于 job 所以 job1 会优先输出
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cb4</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb5</span><span class="p">),</span> <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">),</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb4&#34;</span><span class="p">));</span>
  <span class="c1">// 会在 job1,cb5 之后执行
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb6</span><span class="p">),</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">));</span>
  <span class="kr">const</span> <span class="nx">cb5</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb5&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb6</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb6&#34;</span><span class="p">);</span>

  <span class="nx">queuePostFlushCb</span><span class="p">([</span><span class="nx">cb1</span><span class="p">,</span> <span class="nx">cb2</span><span class="p">]);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb3</span><span class="p">);</span>

  <span class="c1">// 应该去重
</span><span class="c1"></span>  <span class="nx">queuePostFlushCb</span><span class="p">([</span><span class="nx">cb1</span><span class="p">,</span> <span class="nx">cb3</span><span class="p">]);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

cb1 cb2 cb3 cb4 job1 cb5 cb6
</pre>
<blockquote>
<p>对于 <code>queuePostFlushCb</code> 和 <code>queueJob</code> 的混用只要记住一点， <code>queuePostFlushCb</code> 不
会触发 <code>activePostFlushCbs</code> 改变，因为 isFlushing = true，所以只会在当前
<code>flushJobs()</code> 执行到最后递归检测的时候才会进入下一次的 post+job 调用。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-78" class="outline-3">
<h3 id="headline-78">
test nested(pre/job/post)
</h3>
<div id="outline-text-headline-78" class="outline-text-3">
<p>
完整的测试用例，结合 pre, post, queue 三种类型的任务进行测试。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePreFlushCb</span><span class="p">,</span> <span class="nx">nextTick</span><span class="p">,</span> <span class="nx">flushPreFlushCbs</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span>
    <span class="c1">// queueJob 和 queuePreFlushCb 结合使用
</span><span class="c1"></span>    <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb3&#34;</span><span class="p">);</span>
    <span class="c1">// 链式使用，cb4 会在 cb1,2,3 执行完成之后才会执行
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb4</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb4</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb4&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb5</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb5&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
    <span class="c1">// queuePreFlushCb 在 queueJob 中调用
</span><span class="c1"></span>    <span class="c1">// pre cbs 在 job 中调用的时候不会被执行，除非在这后面手动 flush
</span><span class="c1"></span>    <span class="c1">// 或者有新的任务进来，发起 flushJobs 调用才会执行
</span><span class="c1"></span>    <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb5</span><span class="p">);</span>
    <span class="c1">// 必须手动触发, 这样 cb5 才会输出
</span><span class="c1"></span>    <span class="nx">flushPreFlushCbs</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">job1</span> <span class="cm">/* currentPreFlushParentJob */</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">cb6</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb6&#34;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="nx">queuePreFlushCb</span><span class="p">(</span><span class="nx">cb3</span><span class="p">);</span>

  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">(</span><span class="s2">&#34;\n&#34;</span> <span class="o">+</span> <span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined
cb1,cb2,cb3,cb4,job1,cb5
</pre>
<ol>
<li>
<p>pendingPreFlushCbs 虽然是个数组，但是 flush 期间通过 <code>[...new
Set(pendingPreFlushCbs)]</code> 进行了去重操作。</p>
</li>
<li>
<p>链式操作，因为在执行期间使用的是 <code>activePreFlushCbs</code> 且此时的
<code>pendingPreFlushCbs</code> 清空了，等待新任务入列</p>
<p>
在执行 cb3 期间，调用 <code>queuePreFlushCb(cb4)</code> 此时 push cb4 -&gt;
<code>pendingPreFlushCbs</code> ，但实际不会影响本次的 for 循环执行</p>
<p>
<a href="#job-queue-job">这点和 queueJob 有点不同，它直接使用的是 queue -&gt; for 所以有新的任务入列会改
变 for 的执行长度(queue.length)</a></p>
<p>
pre 处理会等到 activePreFlushCbs for 执行循环结束后，在函数的最后递归调用
<code>flushPreFlushCbs()</code> 来刷掉新入列的任务(如： <strong>cb4</strong>)</p>
</li>
<li>
<p>queueJob 在 queuePreFlushCb 中调用的时候， queue job 总是在 pre cb 之后被执行，这也
是 flushJobs 中处理代码应体现出的结果。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">flushJobs() {</span>
  <span class="c1">// 1. flush pre -&gt; flushPreFlushCbs()
</span><span class="c1"></span>  <span class="c1">// 2. for -&gt; queue job -&gt; callWithErrorHandling(job, ...)
</span><span class="c1"></span>  <span class="c1">// 3. flush post -&gt; flushPostFlushCbs()
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
并且如上面实例结果 cb4 嵌套在 cb3 ，job1 嵌套在了 cb2 中，但是最后还是 cb4 先
得到执行了，job1 再执行。</p>
<blockquote>
<p>Tip. 因此，对于 pre cbs 和 queue jobs 两个类型的任务，不管什么时机入列的，都会
是先执行 pre cbs 再执行 queue jobs</p>
</blockquote>
</li>
<li>
<p>queuePreFlushCb 在 queueJob 中调用的时候，新的 pre job 会在 queue job 后执行</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b0155c5405deba3da37c60d2beb8d08a377f699d">fix: rc-&gt;scheduler-&gt;flushJobs recursive · gcclll/stb-vue-next@b0155c5 ·
GitHub</a></p>
<p>
原因： <code>flushPreFlushCbs</code> 先于 queue jobs 执行，因此 queue jobs(<code>job1</code>) 执行
的时候 <code>queuePreFlushCb()</code> 加入的任务(<code>cb5</code>)此时不会执行，而是等 queue jobs
都执行完之后在finally 里面会做一次检测</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">pendingPreFlushCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">flushJobs</span><span class="p">(</span><span class="nx">seen</span><span class="p">)</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这个时候会去递归 <code>flushJobs()</code> 此时才发现有新的 <code>pendingPreFlushCbs</code> (如：
<code>cb5</code>)，则将执行他们，所以结果是 <code>job1,cb5</code> 。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-79" class="outline-3">
<h3 id="headline-79">
invalidateJob(job)
</h3>
<div id="outline-text-headline-79" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/24808b106cfaad8af29a7343918a21836f1aff5d">feat(add): rc-&gt;scheduler-&gt;invalidateJob · gcclll/stb-vue-next@24808b1 · GitHub</a></p>
<p>
是任务失效，其实就是单纯的将 Job 从 queue 中删除了。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">invalidateJob</span><span class="p">(</span><span class="nx">job</span>: <span class="kt">SchedulerJob</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePostFlushCb</span><span class="p">,</span> <span class="nx">invalidateJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
    <span class="nx">invalidateJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span> <span class="c1">// 这里将 job2 从 queue[] 中删除了
</span><span class="c1"></span>    <span class="nx">job2</span><span class="p">();</span> <span class="c1">// 注释这个结果会是： job1 job3 job4
</span><span class="c1"></span>  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job3&#34;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="kr">const</span> <span class="nx">job4</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job4&#34;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job3</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">job4</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

job1 job2 job3 job4
</pre>
</div>
</div>
<div id="outline-container-headline-80" class="outline-3">
<h3 id="headline-80">
job sort id 任务可以排序
</h3>
<div id="outline-text-headline-80" class="outline-text-3">
<p>
只有 post 和 job 支持排序。</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">queuePostFlushCb</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kr">const</span> <span class="nx">job1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job1&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">job2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job2&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">job3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;job3&#34;</span><span class="p">);</span>
  <span class="c1">// job1 no id
</span><span class="c1"></span>  <span class="nx">job2</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="nx">job3</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="kr">const</span> <span class="nx">cb1</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb1&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb2&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">cb3</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;cb3&#34;</span><span class="p">);</span>
  <span class="nx">cb1</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="c1">// cb2 no id
</span><span class="c1"></span>  <span class="nx">cb3</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job1</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job2</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job3</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb1</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb2</span><span class="p">);</span>
  <span class="nx">queuePostFlushCb</span><span class="p">(</span><span class="nx">cb3</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">calls</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

job3 job2 job1 cb3 cb1 cb2
</pre>
</div>
</div>
<div id="outline-container-headline-81" class="outline-3">
<h3 id="headline-81">
allowRecurse 自身递归
</h3>
<div id="outline-text-headline-81" class="outline-text-3">
<p>
用 job.allowRecurse 来控制 job 是否可以自己触发自己执行(PS. pre/job/post 都支持
该属性)。</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-job-allowRecurse.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-job-allowRecurse.jpg" title="/img/vue3/runtime-core/vue-runtime-core-job-allowRecurse.jpg" /></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;before count: &#34;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>
  <span class="c1">// 设置 allowRecurse = true 允许自我调度
</span><span class="c1"></span>  <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="c1">// 重复入列同一个任务会在 push 阶段就检测和自身递归调用不同
</span><span class="c1"></span>  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="s2">&#34;after count: &#34;</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

before count: 1


after count: 3
</pre>
</div>
</div>
<div id="outline-container-headline-82" class="outline-3">
<h3 id="headline-82">
checkRecursiveUpdates
</h3>
<div id="outline-text-headline-82" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7bcc14b6be11693ddb0cc9d4202727f2ebc83995">feat(add): rc-&gt;scheduler-&gt;checkRecursiveUpdates · gcclll/stb-vue-next@7bcc14b ·
GitHub</a></p>
<p>
限制调用自身的次数，在 allowRecurse = true 情况下使用。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 源文件：/js/vue/lib.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">rc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queueJob</span><span class="p">,</span> <span class="nx">nextTick</span> <span class="p">},</span>
  <span class="nx">log</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BLOG_JS</span> <span class="o">+</span> <span class="s2">&#34;/vue/lib.js&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">job</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&lt;</span> <span class="mi">101</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">job</span><span class="p">.</span><span class="nx">allowRecurse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">queueJob</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nx">nextTick</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">newline</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
undefined

Maximum recursive updates exceeded. This means you have a reactive effect that is mutating its own dependencies and thus recursively triggering itself. Possible sources include component template, render function, updated hook or watcher source function.
</pre>
</div>
</div>
<div id="outline-container-headline-83" class="outline-3">
<h3 id="headline-83">
小结
</h3>
<div id="outline-text-headline-83" class="outline-text-3">
<p>
<img src="/img/vue3/runtime-core/vue-runtime-core-scheduler-comparation.jpg" alt="/img/vue3/runtime-core/vue-runtime-core-scheduler-comparation.jpg" title="/img/vue3/runtime-core/vue-runtime-core-scheduler-comparation.jpg" /></p>
<p>
<strong>pre cbs</strong>: 执行优先级最高，在同一 tick 中会递归调用自身清空 <code>pendingPreFlushCbs</code>
 中的任务，在 <code>queueJob</code> 中调用时不会自动触发需要手动触发执行，因为此时
 <code>isFlushing = true</code> 。</p>
<p>
<strong>job</strong>: 执行优先级次之，在同一 tick 中同一个 for queue -&gt; flushIndex 下会处理此
  时接受到的新任务，在 pre cbs 中调用时会在所有 pre cbs 执行之后执行。</p>
<p>
<strong>post cbs</strong>: 执行优先级最低，在同一 tick 同一次 <code>flushPostFlushCbs()</code> 调用中不会
 处理新的 post 任务，而是在 <code>flushJobs()</code> 执行到最后 finally 部分检
 测 <code>pendingPostFlushCbs</code> 任务队列来处理当前 tick 下新接受到的任务，
 在 <code>queuePreFlushCb()</code> 和 <code>queueJob()</code> 中调用的时候会在他们的任务之后执行。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-84" class="outline-2">
<h2 id="headline-84">
🐛 BUGs fix &amp; Questions
</h2>
<div id="outline-text-headline-84" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2a1ab0448919ea75c5794410a03265bd99e05d75">fix: no import EMPTY_ARR · gcclll/stb-vue-next@2a1ab04 · GitHub</a></p>
<div id="outline-container-q-nexttick" class="outline-3">
<h3 id="q-nexttick">
nextTick() 后面的代码最后执行？
</h3>
<div id="outline-text-q-nexttick" class="outline-text-3">
<p>
测试代码： <a href="#nexttick">nextTick</a></p>
<p>
先看一段代码，以及 <a href="https://babeljs.io/repl">babeljs.io</a> 转换之后的结果：</p>
<p>
babel 之前：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before await&#34;</span><span class="p">));</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;between await and p1&#34;</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">p1</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after await&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">p2</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after p2&#34;</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">run</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
babel 之后(只贴出核心部分)：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">((</span><span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">next</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
      <span class="nx">p1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;before await&#34;</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;between await and p1&#34;</span><span class="p">);</span>
      <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">p1</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after await&#34;</span><span class="p">);</span>
      <span class="nx">p2</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>
      <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">p2</span><span class="p">;</span>

    <span class="k">case</span> <span class="mi">9</span><span class="o">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;after p2&#34;</span><span class="p">);</span>

    <span class="k">case</span> <span class="mi">10</span><span class="o">:</span>
    <span class="k">case</span> <span class="s2">&#34;end&#34;</span><span class="o">:</span>
      <span class="k">return</span> <span class="mi">_</span><span class="nx">context</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
即上面的代码被转换之后变成了一个 switch，里面是一个 while 循环，异步代码最终的顺
序执行由 _context.next 来衔接。</p>
<p>
<code>case 0</code> -&gt; <code>next = 5</code> -&gt; <code>case 5</code> -&gt; <code>next = 9</code> -&gt; …</p>
<p>
所以说 nextTick() 后面的代码都会被放到异步代码</p>
</div>
</div>
</div>
</div>
<div id="outline-container-runtime-test" class="outline-2">
<h2 id="runtime-test">
runtime-test 模块简介
</h2>
<div id="outline-text-runtime-test" class="outline-text-2">
<p>
这里测试需要用到这个模块，所以简单用脑图描述下这里面有哪些东西和干什么的。</p>
<p>
<img src="/img/vue3/runtime-core/vue-runtime-test.svg" alt="/img/vue3/runtime-core/vue-runtime-test.svg" title="/img/vue3/runtime-core/vue-runtime-test.svg" /></p>
<p>
重要代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// nodeOpts.ts
</span><span class="c1"></span>
<span class="c1">// 1. createElement
</span><span class="c1">// 2. createText
</span><span class="c1">// 3. createComment
</span><span class="c1">// 上面三个函数分别创建了三种类型节点
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">id</span>: <span class="kt">nodeId</span><span class="o">++</span><span class="p">,</span>
  <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">,</span> <span class="c1">// TEXT | COMMENT
</span><span class="c1"></span>  <span class="nx">text</span>: <span class="kt">value</span><span class="p">,</span> <span class="c1">// 节点具体内容
</span><span class="c1"></span>  <span class="nx">parentNode</span>: <span class="kt">null</span><span class="p">,</span>
  <span class="c1">// 下面是 ELEMENT 类型拥有的属性
</span><span class="c1"></span>  <span class="nx">children</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">tag</span><span class="p">,</span>
  <span class="nx">eventListeners</span>: <span class="kt">null</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// 4. setText(node, text), 直接修改 node.text
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">setText</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">TestText</span><span class="p">,</span> <span class="nx">text</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">logNodeOp</span><span class="p">({</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeOpTypes</span><span class="p">.</span><span class="nx">SET_TEXT</span><span class="p">,</span>
    <span class="nx">targetNode</span>: <span class="kt">node</span><span class="p">,</span>
    <span class="nx">text</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 5. 插入 insert(child, parent, ref?)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">insert</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">TestNode</span><span class="p">,</span> <span class="nx">parent</span>: <span class="kt">TestElement</span><span class="p">,</span> <span class="nx">ref?</span>: <span class="kt">TestNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">refIndex</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">refIndex</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ref</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">refIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;ref: &#34;</span><span class="p">,</span> <span class="nx">ref</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;parent: &#34;</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;ref is not a child of parent&#34;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...log
</span><span class="c1"></span>  <span class="c1">// remove the node first, but don&#39;t log it as a REMOVE op
</span><span class="c1"></span>  <span class="nx">remove</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="c1">// re-calculate the ref index because the child&#39;s removal may have affected it
</span><span class="c1"></span>  <span class="nx">refIndex</span> <span class="o">=</span> <span class="nx">ref</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">refIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">refIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">child</span><span class="p">);</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 6. remove(child)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">remove</span><span class="p">(</span><span class="nx">child</span>: <span class="kt">TestNode</span><span class="p">,</span> <span class="nx">logOp</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;target: &#34;</span><span class="p">,</span> <span class="nx">child</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;parent: &#34;</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;target is not a childNode of parent&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 7. setElementText(), 直接清空替换 children，不如 patchChildren 中
</span><span class="c1">// 对 new/old 类型不同的时候需要 full diff 时更新节点
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">setElementText</span><span class="p">(</span><span class="nx">el</span>: <span class="kt">TestElement</span><span class="p">,</span> <span class="nx">text</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">id</span>: <span class="kt">nodeId</span><span class="o">++</span><span class="p">,</span>
        <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span>
        <span class="nx">text</span><span class="p">,</span>
        <span class="nx">parentNode</span>: <span class="kt">el</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-87" class="outline-2">
<h2 id="headline-87">
重要类型声明
</h2>
<div id="outline-text-headline-87" class="outline-text-2">
<ol>
<li>
<p>异步组件选项</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">AsyncComponentOptions</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="p">{</span>
<span class="nx">loader</span>: <span class="kt">AsyncComponentLoader</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
<span class="nx">loadingComponent?</span>: <span class="kt">Component</span>
<span class="nx">errorComponent?</span>: <span class="kt">Component</span>
<span class="nx">delay?</span>: <span class="kt">number</span>
<span class="nx">timeout?</span>: <span class="kt">number</span>
<span class="nx">suspensible?</span>: <span class="kt">boolean</span>
<span class="nx">onError</span><span class="o">?:</span> <span class="p">(</span>
    <span class="nx">error</span>: <span class="kt">Error</span><span class="p">,</span>
    <span class="nx">retry</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
    <span class="nx">fail</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>
    <span class="nx">attempts</span>: <span class="kt">number</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>Vue App 类型</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">App</span><span class="p">&lt;</span><span class="nt">HostElement</span> <span class="err">=</span> <span class="na">any</span><span class="p">&gt;</span> <span class="p">{</span>
   <span class="nx">version</span>: <span class="kt">string</span><span class="p">;</span>
   <span class="nx">config</span>: <span class="kt">AppConfig</span><span class="p">;</span>
   <span class="nx">use</span><span class="p">(</span><span class="nx">plugin</span>: <span class="kt">Plugin</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">[])</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">mixin</span><span class="p">(</span><span class="nx">mixin</span>: <span class="kt">ComponentOptions</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">component</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Component</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
   <span class="nx">component</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">component</span>: <span class="kt">Component</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">directive</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Directive</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
   <span class="nx">directive</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">directive</span>: <span class="kt">Directive</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>
   <span class="nx">mount</span><span class="p">(</span>
     <span class="nx">rootContainer</span>: <span class="kt">HostElement</span> <span class="o">|</span> <span class="kt">string</span><span class="p">,</span>
     <span class="nx">isHydrate?</span>: <span class="kt">boolean</span>
   <span class="p">)</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span><span class="p">;</span>
   <span class="nx">unmount</span><span class="p">(</span><span class="nx">rootContainer</span>: <span class="kt">HostElement</span> <span class="o">|</span> <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
   <span class="nx">provide</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;(</span><span class="nx">key</span>: <span class="kt">InjectionKey</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span><span class="o">:</span> <span class="k">this</span><span class="p">;</span>

   <span class="c1">// internal, but we need to expose these for the server-renderer and devtools
</span><span class="c1"></span>   <span class="nx">_uid</span>: <span class="kt">number</span><span class="p">;</span>
   <span class="nx">_component</span>: <span class="kt">ConcreteComponent</span><span class="p">;</span>
   <span class="nx">_props</span>: <span class="kt">Data</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">_container</span>: <span class="kt">HostElement</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">_context</span>: <span class="kt">AppContext</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
App 配置:</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">AppConfig</span> <span class="p">{</span>
   <span class="c1">// @private
</span><span class="c1"></span>   <span class="kr">readonly</span> <span class="nx">isNativeTag</span><span class="o">?:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span><span class="p">;</span>

   <span class="nx">performance</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">optionMergeStrategies</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">OptionMergeFunction</span><span class="p">&gt;;</span>
   <span class="nx">globalProperties</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;;</span>
   <span class="nx">isCustomElement</span><span class="o">:</span> <span class="p">(</span><span class="nx">tag</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span><span class="p">;</span>
   <span class="nx">errorHandler</span><span class="o">?:</span> <span class="p">(</span>
     <span class="nx">err</span>: <span class="kt">unknown</span><span class="p">,</span>
     <span class="nx">instance</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">info</span>: <span class="kt">string</span>
   <span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
   <span class="nx">warnHandler</span><span class="o">?:</span> <span class="p">(</span>
     <span class="nx">msg</span>: <span class="kt">string</span><span class="p">,</span>
     <span class="nx">instance</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">trace</span>: <span class="kt">string</span>
   <span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
Vue 插件类型：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">type</span> <span class="nx">PluginInstallFunction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">app</span>: <span class="kt">App</span><span class="p">,</span> <span class="p">...</span><span class="nx">options</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="kt">any</span><span class="p">;</span>
 <span class="kr">export</span> <span class="kr">type</span> <span class="nx">Plugin</span> <span class="o">=</span>
   <span class="o">|</span> <span class="p">(</span><span class="nx">PluginInstallFunction</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="nx">install?</span>: <span class="kt">PluginInstallFunction</span> <span class="p">})</span>
   <span class="o">|</span> <span class="p">{</span>
       <span class="nx">install</span>: <span class="kt">PluginInstallFunction</span><span class="p">;</span>
     <span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>api watch 类型</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WatchOptionsBase</span> <span class="p">{</span>
   <span class="nx">flush</span><span class="o">?:</span> <span class="s2">&#34;pre&#34;</span> <span class="o">|</span> <span class="s2">&#34;post&#34;</span> <span class="o">|</span> <span class="s2">&#34;sync&#34;</span><span class="p">;</span>
   <span class="nx">onTrack?</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;onTrack&#34;</span><span class="p">];</span>
   <span class="nx">onTrigger?</span>: <span class="kt">ReactiveEffectOptions</span><span class="p">[</span><span class="s2">&#34;onTrigger&#34;</span><span class="p">];</span>
 <span class="p">}</span>

 <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">WatchOptions</span><span class="p">&lt;</span><span class="nt">Immediate</span> <span class="err">=</span> <span class="na">boolean</span><span class="p">&gt;</span> <span class="kr">extends</span> <span class="nx">WatchOptionsBase</span> <span class="p">{</span>
   <span class="nx">immediate?</span>: <span class="kt">Immediate</span><span class="p">;</span>
   <span class="nx">deep?</span>: <span class="kt">boolean</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>component 组件类型</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="c1">// 内部选项
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ComponentInternalOptions</span> <span class="p">{</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__props?</span>: <span class="kt">NormalizedPropsOptions</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__emits?</span>: <span class="kt">ObjectEmitsOptions</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__scopeId?</span>: <span class="kt">string</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__cssModules?</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* @internal
</span><span class="cm"> ,*/</span>
   <span class="nx">__hmrId?</span>: <span class="kt">string</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm"> ,* This one should be exposed so that devtools can make use of it
</span><span class="cm"> ,*/</span>
   <span class="nx">__file?</span>: <span class="kt">string</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// 函数式组件
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">FunctionalComponent</span><span class="p">&lt;</span><span class="nt">P</span> <span class="err">=</span> <span class="p">{}</span><span class="err">,</span> <span class="na">E</span> <span class="na">extends</span> <span class="na">EmitsOptions </span><span class="o">=</span> <span class="p">{}&gt;</span>
   <span class="kr">extends</span> <span class="nx">ComponentInternalOptions</span> <span class="p">{</span>
   <span class="c1">// use of any here is intentional so it can be a valid JSX Element constructor
</span><span class="c1"></span>   <span class="p">(</span><span class="nx">props</span>: <span class="kt">P</span><span class="p">,</span> <span class="nx">ctx</span>: <span class="kt">Omit</span><span class="p">&lt;</span><span class="nt">SetupContext</span><span class="err">&lt;</span><span class="na">E</span><span class="p">&gt;,</span> <span class="s2">&#34;expose&#34;</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span> <span class="kt">any</span><span class="p">;</span>
   <span class="nx">props?</span>: <span class="kt">ComponentPropsOptions</span><span class="p">&lt;</span><span class="nt">P</span><span class="p">&gt;;</span>
   <span class="nx">emits?</span>: <span class="kt">E</span> <span class="o">|</span> <span class="p">(</span><span class="k">keyof</span> <span class="nx">E</span><span class="p">)[];</span>
   <span class="nx">inheritAttrs?</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">displayName?</span>: <span class="kt">string</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// 类组件
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ClassComponent</span> <span class="p">{</span>
   <span class="k">new</span> <span class="p">(...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span><span class="o">:</span> <span class="nx">ComponentPublicInstance</span><span class="p">&lt;</span><span class="nt">any</span><span class="err">,</span> <span class="na">any</span><span class="err">,</span> <span class="na">any</span><span class="err">,</span> <span class="na">any</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;;</span>
   <span class="nx">__vccOpts</span>: <span class="kt">ComponentOptions</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// 生命周期函数缩写
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">const</span> <span class="kr">enum</span> <span class="nx">LifecycleHooks</span> <span class="p">{</span>
   <span class="nx">BEFORE_CREATE</span> <span class="o">=</span> <span class="s2">&#34;bc&#34;</span><span class="p">,</span>
   <span class="nx">CREATED</span> <span class="o">=</span> <span class="s2">&#34;c&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_MOUNT</span> <span class="o">=</span> <span class="s2">&#34;bm&#34;</span><span class="p">,</span>
   <span class="nx">MOUNTED</span> <span class="o">=</span> <span class="s2">&#34;m&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UPDATE</span> <span class="o">=</span> <span class="s2">&#34;bu&#34;</span><span class="p">,</span>
   <span class="nx">UPDATED</span> <span class="o">=</span> <span class="s2">&#34;u&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UNMOUNT</span> <span class="o">=</span> <span class="s2">&#34;bum&#34;</span><span class="p">,</span>
   <span class="nx">UNMOUNTED</span> <span class="o">=</span> <span class="s2">&#34;um&#34;</span><span class="p">,</span>
   <span class="nx">DEACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;da&#34;</span><span class="p">,</span>
   <span class="nx">ACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRIGGERED</span> <span class="o">=</span> <span class="s2">&#34;rtg&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRACKED</span> <span class="o">=</span> <span class="s2">&#34;rtc&#34;</span><span class="p">,</span>
   <span class="nx">ERROR_CAPTURED</span> <span class="o">=</span> <span class="s2">&#34;ec&#34;</span><span class="p">,</span>
 <span class="p">}</span>

 <span class="c1">// setup 函数
</span><span class="c1"></span> <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">SetupContext</span><span class="p">&lt;</span><span class="nt">E</span> <span class="err">=</span> <span class="na">EmitsOptions</span><span class="p">&gt;</span> <span class="p">{</span>
   <span class="nx">attrs</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">slots</span>: <span class="kt">Slots</span><span class="p">;</span>
   <span class="nx">emit</span>: <span class="kt">EmitFn</span><span class="p">&lt;</span><span class="nt">E</span><span class="p">&gt;;</span>
   <span class="nx">expose</span><span class="o">:</span> <span class="p">(</span><span class="nx">exposed</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>component internal instance</p>
<p>
这里涵盖了一个组件都有哪些属性：</p>
<p>
<code>uid, type, parent, root, appContext, vnode, next, subTree, update</code>,</p>
<p>
<code>render, ssrRender, provides, effects, accessCache, renderCache</code>,</p>
<p>
<code>components, directives, propsOptions, emitsOptions</code>,</p>
<p>
<code>proxy, exposed, withProxy, ctx</code>,</p>
<p>
<code>data, props, attrs, slots, refs, emit</code>,</p>
<p>
<code>emitted, setupState, devtoolsRawSetupState, setupContext</code>,</p>
<p>
<code>suspense, suspenseId, asyncDep, asyncResolved</code>,</p>
<p>
<code>isMounted, isUnmounted, isDeactivated</code>,</p>
<p>
<code>bc, c, bm, m, bu, u, bum, um, da, a, rtg, rtc, ec</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">const</span> <span class="kr">enum</span> <span class="nx">LifecycleHooks</span> <span class="p">{</span>
   <span class="nx">BEFORE_CREATE</span> <span class="o">=</span> <span class="s2">&#34;bc&#34;</span><span class="p">,</span>
   <span class="nx">CREATED</span> <span class="o">=</span> <span class="s2">&#34;c&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_MOUNT</span> <span class="o">=</span> <span class="s2">&#34;bm&#34;</span><span class="p">,</span>
   <span class="nx">MOUNTED</span> <span class="o">=</span> <span class="s2">&#34;m&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UPDATE</span> <span class="o">=</span> <span class="s2">&#34;bu&#34;</span><span class="p">,</span>
   <span class="nx">UPDATED</span> <span class="o">=</span> <span class="s2">&#34;u&#34;</span><span class="p">,</span>
   <span class="nx">BEFORE_UNMOUNT</span> <span class="o">=</span> <span class="s2">&#34;bum&#34;</span><span class="p">,</span>
   <span class="nx">UNMOUNTED</span> <span class="o">=</span> <span class="s2">&#34;um&#34;</span><span class="p">,</span>
   <span class="nx">DEACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;da&#34;</span><span class="p">,</span>
   <span class="nx">ACTIVATED</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRIGGERED</span> <span class="o">=</span> <span class="s2">&#34;rtg&#34;</span><span class="p">,</span>
   <span class="nx">RENDER_TRACKED</span> <span class="o">=</span> <span class="s2">&#34;rtc&#34;</span><span class="p">,</span>
   <span class="nx">ERROR_CAPTURED</span> <span class="o">=</span> <span class="s2">&#34;ec&#34;</span><span class="p">,</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
类型：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="cm">/**
</span><span class="cm">  * We expose a subset of properties on the internal instance as they are
</span><span class="cm">  * useful for advanced external libraries and tools.
</span><span class="cm">  */</span>
 <span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ComponentInternalInstance</span> <span class="p">{</span>
   <span class="nx">uid</span>: <span class="kt">number</span><span class="p">;</span>
   <span class="kr">type</span><span class="o">:</span> <span class="nx">ConcreteComponent</span><span class="p">;</span>
   <span class="nx">parent</span>: <span class="kt">ComponentInternalInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">root</span>: <span class="kt">ComponentInternalInstance</span><span class="p">;</span>
   <span class="nx">appContext</span>: <span class="kt">AppContext</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Vnode representing this component in its parent&#39;s vdom tree
</span><span class="cm">    */</span>
   <span class="nx">vnode</span>: <span class="kt">VNode</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * The pending new vnode from parent updates
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">next</span>: <span class="kt">VNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Root vnode of this component&#39;s own vdom tree
</span><span class="cm">    */</span>
   <span class="nx">subTree</span>: <span class="kt">VNode</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * The reactive effect for rendering and patching the component. Callable.
</span><span class="cm">    */</span>
   <span class="nx">update</span>: <span class="kt">ReactiveEffect</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * The render function that returns vdom tree.
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">render</span>: <span class="kt">InternalRenderFunction</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * SSR render function
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">ssrRender?</span>: <span class="kt">Function</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Object containing values this component provides for its descendents
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">provides</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Tracking reactive effects (e.g. watchers) associated with this component
</span><span class="cm">    * so that they can be automatically stopped on component unmount
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">effects</span>: <span class="kt">ReactiveEffect</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * cache for proxy access type to avoid hasOwnProperty calls
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">accessCache</span>: <span class="kt">Data</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * cache for render function values that rely on _ctx but won&#39;t need updates
</span><span class="cm">    * after initialized (e.g. inline handlers)
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">renderCache</span><span class="o">:</span> <span class="p">(</span><span class="nb">Function</span> <span class="o">|</span> <span class="nx">VNode</span><span class="p">)[];</span>

   <span class="cm">/**
</span><span class="cm">    * Resolved component registry, only for components with mixins or extends
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">components</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">ConcreteComponent</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * Resolved directive registry, only for components with mixins or extends
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">directives</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Directive</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * reoslved props options
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">propsOptions</span>: <span class="kt">NormalizedPropsOptions</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * resolved emits options
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">emitsOptions</span>: <span class="kt">ObjectEmitsOptions</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="c1">// the rest are only for stateful components ---------------------------------
</span><span class="c1"></span>
   <span class="c1">// main proxy that serves as the public instance (`this`)
</span><span class="c1"></span>   <span class="nx">proxy</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="c1">// exposed properties via expose()
</span><span class="c1"></span>   <span class="nx">exposed</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="cm">/**
</span><span class="cm">    * alternative proxy used only for runtime-compiled render functions using
</span><span class="cm">    * `with` block
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">withProxy</span>: <span class="kt">ComponentPublicInstance</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * This is the target for the public instance proxy. It also holds properties
</span><span class="cm">    * injected by user options (computed, methods etc.) and user-attached
</span><span class="cm">    * custom properties (via `this.x = ...`)
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">ctx</span>: <span class="kt">Data</span><span class="p">;</span>

   <span class="c1">// state
</span><span class="c1"></span>   <span class="nx">data</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">props</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">attrs</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">slots</span>: <span class="kt">InternalSlots</span><span class="p">;</span>
   <span class="nx">refs</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="nx">emit</span>: <span class="kt">EmitFn</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * used for keeping track of .once event handlers on components
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">emitted</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">boolean</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="cm">/**
</span><span class="cm">    * setup related
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">setupState</span>: <span class="kt">Data</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * devtools access to additional info
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">devtoolsRawSetupState?</span>: <span class="kt">any</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">setupContext</span>: <span class="kt">SetupContext</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

   <span class="cm">/**
</span><span class="cm">    * suspense related
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">suspense</span>: <span class="kt">SuspenseBoundary</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * suspense pending batch id
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">suspenseId</span>: <span class="kt">number</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">asyncDep</span>: <span class="kt">Promise</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="nx">asyncResolved</span>: <span class="kt">boolean</span><span class="p">;</span>

   <span class="c1">// lifecycle
</span><span class="c1"></span>   <span class="nx">isMounted</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">isUnmounted</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="nx">isDeactivated</span>: <span class="kt">boolean</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_CREATE</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">CREATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_MOUNT</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">MOUNTED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_UPDATE</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UPDATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">BEFORE_UNMOUNT</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">UNMOUNTED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">RENDER_TRACKED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">RENDER_TRIGGERED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">ACTIVATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">DEACTIVATED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
   <span class="cm">/**
</span><span class="cm">    * @internal
</span><span class="cm">    */</span>
   <span class="p">[</span><span class="nx">LifecycleHooks</span><span class="p">.</span><span class="nx">ERROR_CAPTURED</span><span class="p">]</span><span class="o">:</span> <span class="nx">LifecycleHook</span><span class="p">;</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>emit fn 事件</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kr">type</span> <span class="nx">EmitFn</span><span class="o">&lt;</span>
   <span class="nx">Options</span> <span class="o">=</span> <span class="nx">ObjectEmitsOptions</span><span class="p">,</span>
   <span class="nx">Event</span> <span class="kr">extends</span> <span class="k">keyof</span> <span class="nx">Options</span> <span class="o">=</span> <span class="k">keyof</span> <span class="nx">Options</span>
 <span class="o">&gt;</span> <span class="o">=</span> <span class="nx">Options</span> <span class="kr">extends</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">infer</span> <span class="na">V</span><span class="p">&gt;</span>
   <span class="o">?</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">V</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="k">void</span>
   <span class="o">:</span> <span class="p">{}</span> <span class="kr">extends</span> <span class="nx">Options</span> <span class="c1">// if the emit is empty object (usually the default value for emit) should be converted to function
</span><span class="c1"></span>   <span class="o">?</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">string</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="k">void</span>
   <span class="o">:</span> <span class="nx">UnionToIntersection</span><span class="o">&lt;</span>
       <span class="p">{</span>
         <span class="p">[</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">Event</span><span class="p">]</span><span class="o">:</span> <span class="nx">Options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="kr">extends</span> <span class="p">(...</span><span class="nx">args</span>: <span class="kt">infer</span> <span class="nx">Args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span>
           <span class="o">?</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">key</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">Args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>
           <span class="o">:</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">key</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span>: <span class="kt">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
       <span class="p">}[</span><span class="nx">Event</span><span class="p">]</span>
     <span class="o">&gt;</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-01-08
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/runtime-core/">runtime-core</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-runtime-core-2-render/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 源码头脑风暴之 7 ☞ runtime-core(2) - render</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-compiler-ssr/">
            <span class="next-text nav-default">Vue3 源码头脑风暴之 6 ☞compiler-ssr</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2021-01-08 00:00:00 \u002b0000 UTC',
        title: 'Vue3 源码头脑风暴之 7 ☞ runtime-core(1)',
        clientID: '7251a6b30d0d6c0f4aa2',
        clientSecret: '320c43a98b0d5ae30535d8cf6cb3be7a05895c77',
        repo: 'cheng92-comments',
        owner: 'gcclll',
        admin: ['gcclll'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
