<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 源码头脑风暴之 3 ☞compiler-core - transform &#43; codegen - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：该篇" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-compiler-core-transform-generate/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.06b20cf21b1dff0a19c6a6fd2770439ed0c003d544ece3c4e1fbfb34fc217e45.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 源码头脑风暴之 3 ☞compiler-core - transform &#43; codegen" />
<meta property="og:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：该篇" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-compiler-core-transform-generate/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2020-11-30T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-11-30T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 源码头脑风暴之 3 ☞compiler-core - transform &#43; codegen">
<meta itemprop="description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：该篇"><meta itemprop="datePublished" content="2020-11-30T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-11-30T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="19784">
<meta itemprop="keywords" content="vue,,vue3,,compiler-core,,parser,,compiler,,transform," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 源码头脑风暴之 3 ☞compiler-core - transform &#43; codegen"/>
<meta name="twitter:description" content="诗号：六道同坠，魔劫万千，引渡如来。 stb-vue-next 完全拷贝于 vue-next ，主要目的用于学习。 声明 ：该篇"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 源码头脑风暴之 3 ☞compiler-core - transform &#43; codegen</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-30 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> 约 19784 字 </span>
          <span class="more-meta"> 预计阅读 40 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">关键知识点</a>
</li>
<li><a href="#headline-2">脑图</a>
</li>
<li><a href="#headline-3">e03a03c init transform module</a>
</li>
<li><a href="#headline-4">fc6f1f1 add transform function</a>
</li>
<li><a href="#headline-5">b0d72da add compile.ts&gt;compile()</a>
</li>
<li><a href="#headline-6">35248ce add exports maybe needs</a>
</li>
<li><a href="#pure-text">05a223b add transform pure text</a>
<ul>
<li><a href="#headline-8">61ce406 add createRootCodegen() to create root.codegenNode</a>
</li>
<li><a href="#headline-9">b9f3cb7 add transform text</a>
</li>
<li><a href="#headline-10">f6d5271 add generate text codegen</a>
</li>
<li><a href="#headline-11">测试</a>
<ul>
<li><a href="#headline-12">function preamble 形式(作为全局 <code>Vue</code> 对象引入)</a>
</li>
<li><a href="#headline-13">module preamble 形式(<strong>es6</strong> 模块化导出导入)</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#interpolation">2f749b2 add interpolation generator</a>
</li>
<li><a href="#element">add element transfrom and generator</a>
<ul>
<li><a href="#headline-16">准备工作 <code>compiler-core/src/utils.ts</code></a>
</li>
<li><a href="#element-transform">87339d2 add element transform</a>
</li>
<li><a href="#headline-18">2f58786 add element generator</a>
</li>
<li><a href="#headline-19">05ca2f8 root.children 有多个孩子</a>
</li>
</ul>
</li>
<li><a href="#headline-20">7cb3dbf add hoist static 静态提升</a>
</li>
<li><a href="#headline-21">prop transform and generator</a>
<ul>
<li><a href="#headline-22">1792f93 props transform</a>
<ul>
<li><a href="#headline-23">buildProps</a>
</li>
<li><a href="#headline-24">transform props</a>
</li>
</ul>
</li>
<li><a href="#headline-25">e4acc0d props generator</a>
</li>
<li><a href="#headline-26">static props</a>
</li>
<li><a href="#headline-27">6951dd1 merge props</a>
</li>
</ul>
</li>
<li><a href="#headline-28">6c43451 add v-on transform</a>
</li>
<li><a href="#v-bind">f805858 add v-bind transform</a>
</li>
<li><a href="#headline-30">0cc76f0 add v-model transform</a>
</li>
<li><a href="#headline-31">bf18a84 add v-once transform</a>
</li>
<li><a href="#headline-32">acdea14 add v-if transform</a>
<ul>
<li><a href="#headline-33">acdea14 v-if transform init</a>
</li>
<li><a href="#headline-34">9039a3e v-if transform processIf</a>
</li>
<li><a href="#headline-35">44985b4 v-if transform createIfBranch</a>
</li>
<li><a href="#headline-36">742757e v-if generator</a>
</li>
<li><a href="#headline-37">fa77b51 v-else/v-else-if</a>
</li>
</ul>
</li>
<li><a href="#headline-38">6c82066 add v-for transform</a>
</li>
<li><a href="#headline-39">39a20fe add v-for generator</a>
</li>
<li><a href="#headline-40">7cb8908 add slot outlet transform</a>
<ul>
<li><a href="#headline-41">ebdb1ed add track slot scopes</a>
</li>
</ul>
</li>
<li><a href="#v-slot">36c1f36 (v-slot)build user component as slots</a>
<ul>
<li><a href="#headline-43">fbed5cf add component with default slot without &lt;template&gt; transform</a>
</li>
<li><a href="#headline-44">8bed175 add component with default slot without &lt;template&gt; generator</a>
</li>
<li><a href="#headline-45">9f58154 fix: 文本节点没有合并(<code>transformText</code>)</a>
</li>
<li><a href="#headline-46">0773374 add component nested slots scoping</a>
</li>
<li><a href="#headline-47">c1ace74 add component with v-slot inside v-for</a>
</li>
<li><a href="#headline-48">cfef20e add named slot with v-if</a>
</li>
<li><a href="#headline-49">c1ace74 add v-for on v-slot component</a>
</li>
<li><a href="#slot-usage">小结：v-slot 几种用法</a>
</li>
</ul>
</li>
<li><a href="#headline-51">update vue-next merge into stb-vue-next[2020-12-11 16:54:06]</a>
</li>
<li><a href="#headline-52">6efbc86 add expression transform(node-env)</a>
</li>
<li><a href="#headline-53">TODOs(ssr render, node env, setup meta)</a>
</li>
<li><a href="#headline-54">non-browser testing(非浏览器环境测试)</a>
</li>
<li><a href="#headline-55">jest 跑🏃用例</a>
</li>
<li><a href="#headline-56">综合测试</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> 完全拷贝于 <a href="https://github.com/vuejs/vue-next">vue-next</a> ，主要目的用于学习。</strong>
</kbd></p>
<blockquote>
<p><strong>声明</strong> ：该篇为 ts 源码(<em>commit</em>)版本，之前做过一遍完整的 js 版本，更详细，也可参考</p>
<p>
<a href="https://www.cheng92.com/vue/vue3-source-code-compiler-core-compile_ts/">Vue3.0 源码系列（二）编译器核心 - Compiler core 3: compile.ts - 若叶知秋</a></p>
<p>
由于 transform 阶段直接测试不太好直观的看出结果，因此这里会结合 codegen 来一起实
现，即该文包含 compiler-core 三大阶段的最后两个阶段(transform + generate)</p>
<p>
<strong>调试</strong> ：所有测试用例可通过 <code>&lt;F12&gt;</code> 控制台查看</p>
<p>
<strong>更新日志&amp;Todos</strong> ：</p>
<ol>
<li>
<p>DONE [2020-12-12 18:33:33] 阶段性完成，浏览器支持的所有基本功能(浏览器环境所
有用例测试均已通过，可通过控制台查看测试用例及其运行过程结果)</p>
</li>
<li>
<p>TODO ssr 服务端渲染</p>
</li>
<li>
<p>TODO &lt;setup&gt; 标签处理</p>
</li>
<li>
<p>TODO 非浏览器环境支持(<code>prefixIdentifiers, cacheHandlers</code> 选项需要非浏览器环境)</p>
</li>
<li>
<p>TODO ref 类型处理</p>
</li>
</ol>
</blockquote>
<script src="/js/vue/compiler-core.global.js"></script>
<script src="/js/utils.js"></script>
<script>
i = 0, j = 0
const { baseCompile } = VueCompilerCore
const compile = (tpl, title, logAst = false) => {
    l2(title)
    // if (!tpl) return null
    const { code, ast } = baseCompile(tpl, {
        onError: (e) => console.warn(e.message),
        hoistStatic: true,
        ...( compile.options || {} )
    })

    log.grey(tpl)
    log([code])
    logAst && log(typeof logAst === 'function' ? logAst(ast) : ast)
    return ast
}
const c = (tpl, desc, fn) => compile(tpl, desc, fn || (ast => ast.codegenNode&&ast.codegenNode.props))

</script>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
关键知识点
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ol>
<li>
<p><a href="#element-transform">🔗</a> root.children.length = 1 且类型是 ELEMENT的时候将 <code>CREATE_VNODE</code> 改成
<code>CREATE_BLOCK</code>   </p>
</li>
<li>
<p><a href="#v-bind">🔗</a> 动态属性为表达式时，中间不能有空格</p>
<p>
如： <code>&lt;div :[first + second]=&#34;third&#34; ...</code> 是非法的。</p>
<p>
因为 <code>parseAttribute()</code> 中的正则是不支持中间有空格的：</p>
<p>
取参数名的正则： <code>/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</code></p>
</li>
<li>
<p><a href="#v-bind">🔗</a> v-bind 指令的几种用法 -&gt;</p>
</li>
<li>
<p><a href="#slot-usage">🔗</a> 用户组件 -&gt; 插槽处理 -&gt; v-slot 使用方法</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
脑图
</h2>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
e03a03c init transform module
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e03a03c5d775ff9315cc027d88b0669a775cf590">feat(init): transform section · gcclll/stb-vue-next@e03a03c</a></p>
<p>
初始化函数。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createTransformContext</span><span class="p">(</span>
  <span class="nx">root</span>: <span class="kt">RootNode</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">prefixIdentifiers</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">hoistStatic</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">cacheHandlers</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">nodeTransforms</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">directiveTransforms</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">transformHoist</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isBuiltInComponent</span> <span class="o">=</span> <span class="nx">NOOP</span><span class="p">,</span>
    <span class="nx">isCustomElement</span> <span class="o">=</span> <span class="nx">NOOP</span><span class="p">,</span>
    <span class="nx">expressionPlugins</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">scopeId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">ssr</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">ssrCssVars</span> <span class="o">=</span> <span class="sb">``</span><span class="p">,</span>
    <span class="nx">bindingMetadata</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">onError</span> <span class="o">=</span> <span class="nx">defaultOnError</span>
  <span class="p">}</span><span class="o">:</span> <span class="nx">TransformOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">TransformContext</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">context</span>: <span class="kt">TransformContext</span> <span class="o">=</span> <span class="p">{</span>

    <span class="c1">// ...
</span><span class="c1"></span>
    <span class="c1">// methods
</span><span class="c1"></span>    <span class="nx">helper</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">name</span>
    <span class="p">},</span>
    <span class="nx">helperString</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="sb">``</span>
    <span class="p">},</span>
    <span class="nx">replaceNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{},</span>
    <span class="nx">removeNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{},</span>
    <span class="nx">onNodeRemoved</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{},</span>
    <span class="nx">addIdentifiers</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">},</span>
    <span class="nx">removeIdentifiers</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">},</span>
    <span class="nx">hoist</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>      <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="kt">any</span>
    <span class="p">},</span>
    <span class="nx">cache</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">isVNode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>      <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="kt">any</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">context</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">root</span>: <span class="kt">RootNode</span><span class="p">,</span> <span class="nx">options</span>: <span class="kt">TransformOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// TODO
</span><span class="c1">// createRootCodegen
</span><span class="c1"></span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseChildren</span><span class="p">(</span>
  <span class="nx">parent</span>: <span class="kt">ParentNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseNode</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">RootNode</span> <span class="o">|</span> <span class="nx">TemplateChildNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">createStructuralDirectiveTransform</span><span class="p">(</span>
  <span class="nx">name</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span><span class="p">,</span>
  <span class="nx">fn</span>: <span class="kt">StructuralDirectiveTransform</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">NodeTransform</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="kt">any</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
fc6f1f1 add transform function
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fc6f1f112ae0e98b7e2e9a432d3dca1d6420307a">feat: transform function · gcclll/stb-vue-next@fc6f1f1</a></p>
<ol>
<li>
<p>create transform context</p>
</li>
<li>
<p>traverse nodes, 递归遍历所有节点，构造器 codegenNode</p>
</li>
<li>
<p>hoist static, 静态节点提升，复用</p>
</li>
<li>
<p>ssr render, 不需要创建根节点 codegenNode</p>
</li>
<li>
<p>复制 context 属性到 -&gt; root</p>
</li>
</ol>
<p>
<img src="http://qiniu.ii6g.com/img/20201130231832.png" alt="http://qiniu.ii6g.com/img/20201130231832.png" title="http://qiniu.ii6g.com/img/20201130231832.png" /></p>
<p>
transform 作用就是通过 <code>traverseNode()</code> 递归遍历所有节点，解析，构造对应的节点
codegenNode 。</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
b0d72da add compile.ts&gt;compile()
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b0d72dac2738fd270b0ea7fe0bb33f47597a233b">feat(add): compile function · gcclll/stb-vue-next@b0d72da</a></p>
<p>
对外的 compile 函数，执行分为三个阶段：</p>
<ul>
<li>
<p>ast(<code>baseParse()</code>) -&gt; 解析出 ast 结构</p>
</li>
<li>
<p>transform(<code>transform()</code>) -&gt; 解析 ast 得到 codegenNode</p>
</li>
<li>
<p>codegen(<code>generate()</code>) -&gt; 将 codegenNode 解析成 Render 函数</p>
</li>
</ul>
<p>
这是后面测试的基础，所以得提前实现了。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">baseCompile</span><span class="p">(</span>
  <span class="nx">template</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nx">RootNode</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">CompilerOptions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">CodegenResult</span> <span class="p">{</span>
  <span class="c1">// const onError = options.onError || defaultOnError
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">isModuleMode</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;module&#39;</span>

  <span class="kr">const</span> <span class="nx">prefixIdentifiers</span> <span class="o">=</span>
    <span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">prefixIdentifiers</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">isModuleMode</span><span class="p">)</span>

  <span class="c1">// TODO errors
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="o">?</span> <span class="nx">baseParse</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">:</span> <span class="nx">template</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">nodeTransforms</span><span class="p">,</span> <span class="nx">directiveTransforms</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getBaseTransformPreset</span><span class="p">(</span>
    <span class="nx">prefixIdentifiers</span>
  <span class="p">)</span>

  <span class="nx">transform</span><span class="p">(</span>
    <span class="nx">ast</span><span class="p">,</span>
    <span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">prefixIdentifiers</span><span class="p">,</span>
      <span class="nx">nodeTransforms</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">...</span><span class="nx">nodeTransforms</span><span class="p">,</span>
        <span class="p">...(</span><span class="nx">options</span><span class="p">.</span><span class="nx">nodeTransforms</span> <span class="o">||</span> <span class="p">[])</span> <span class="c1">// user transforms
</span><span class="c1"></span>      <span class="p">],</span>
      <span class="nx">directiveTransforms</span>: <span class="kt">extend</span><span class="p">(</span>
        <span class="p">{},</span>
        <span class="nx">directiveTransforms</span><span class="p">,</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">directiveTransforms</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="p">)</span>
    <span class="p">})</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="nx">generate</span><span class="p">(</span>
    <span class="nx">ast</span><span class="p">,</span>
    <span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">prefixIdentifiers</span>
    <span class="p">})</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
35248ce add exports maybe needs
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/35248ceece1aa8650b65f7f7ce13612660a65397">feat(add): compiler-core exports · gcclll/stb-vue-next@35248ce</a></p>
<p>
增加 compiler-core 模块的导出(<code>export</code>)内容</p>
</div>
</div>
<div id="outline-container-pure-text" class="outline-2">
<h2 id="pure-text">
05a223b add transform pure text
</h2>
<div id="outline-text-pure-text" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/05a223b7b1eb2ab877aec3b11feace484a7dde82">feat(add): transform pure text · gcclll/stb-vue-next@05a223b</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseNode</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">RootNode</span> <span class="o">|</span> <span class="nx">TemplateChildNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 保存当前被处理的 节点
</span><span class="c1"></span>  <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">node</span>
  <span class="c1">// 应用 transform 插件
</span><span class="c1"></span>  <span class="kr">const</span> <span class="p">{</span> <span class="nx">nodeTransforms</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
  <span class="c1">// 针对每个节点会收集到一个或多个 transformXxx 函数，用来解析它的 ast
</span><span class="c1"></span>  <span class="c1">// 得到 codegenNode ，这些函数会在当前的节点树被递归遍历完之后调用
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">exitFns</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nodeTransforms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">onExit</span> <span class="o">=</span> <span class="nx">nodeTransforms</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">onExit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">onExit</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">exitFns</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">onExit</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">exitFns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onExit</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 节点可能被删除了，比如： v-else-if, v-else 会合并到 v-if 的 branches[] 中
</span><span class="c1"></span>      <span class="k">return</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 节点可能会替换了，需要更新
</span><span class="c1"></span>      <span class="nx">node</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">switch</span> <span class="p">(</span>
    <span class="nx">node</span><span class="p">.</span><span class="kr">type</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">node</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">exitFns</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exitFns</span><span class="p">[</span><span class="nx">i</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
transform 阶段代码毕竟的三个阶段</p>
<ol>
<li>
<p>收集 transformXxx 函数到 exitFns</p>
</li>
<li>
<p>根据 ast节点类型递归遍历子孙节点</p>
</li>
<li>
<p>按照收集时相反的顺序执行 exitFns，解析出 codegenNode</p>
</li>
</ol>
<p>
为了方便测试，在 <code>generate()</code> 中直接返回 ast :
<a href="https://github.com/gcclll/stb-vue-next/commit/999d8d6b611443f8fd04282786d4a67f018d6319">test: generate return ast for test · gcclll/stb-vue-next@999d8d6</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{
  type: 2,
  content: &#39;pure text&#39;,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: &#39;pure text&#39;
  }
}
</pre>
<p>
结果显示并没有 codegenNode 因为在transformText 中满足条件</p>
<p>
<code>children.length === 1 &amp;&amp; node.type === NodeTypes.ROOT</code> 而直接退出了。</p>
<p>
至于 <code>root.codegenNode = undefined</code> 需要实现 <code>createRootCodegen()</code></p>
<div id="outline-container-headline-8" class="outline-4">
<h4 id="headline-8">
61ce406 add createRootCodegen() to create root.codegenNode
</h4>
<div id="outline-text-headline-8" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/61ce4066c9b49e11399da0b499220f426da444a0">feat: createRootCodegen() for pure text · gcclll/stb-vue-next@61ce406</a></p>
<p>
只增加了针对非 ELEMENT 类型或者孩子节点没有 codegenNode 的情况实现(当前 commit
最简化)。</p>
<p>
当 root.children 只有一个孩子节点且该节点没有自己的 codegenNode 时候：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createRootCodegen</span><span class="p">(</span><span class="nx">root</span>: <span class="kt">RootNode</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">TransformContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// const { helper } = context
</span><span class="c1"></span>  <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">root</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 只有一个孩子节点，直接取该孩子节点 的 codegenNode
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isSingleElementRoot</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 当 root 节点下只有一个 element 元素的孩子节点时，不进行提升
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// - single &lt;slot/&gt;, IfNode, ForNode: already blocks.
</span><span class="c1"></span>      <span class="c1">// - single text node: always patched.
</span><span class="c1"></span>      <span class="c1">// root codegen falls through via genNode()
</span><span class="c1"></span>
      <span class="nx">root</span><span class="p">.</span><span class="nx">codegenNode</span> <span class="o">=</span> <span class="nx">child</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no children = noop, codegen will return null.
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 0,
  children: [ { type: 2, content: &#39;pure text&#39;, loc: [Object] } ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 2,
    content: &#39;pure text&#39;,
    loc: { start: [Object], end: [Object], source: &#39;pure text&#39; }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: &#39;pure text&#39;
  }
}
</pre>
<p>
注意 codegenNode 其实就是 <code>root.children[0]</code> 节点本身。</p>
</div>
</div>
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
b9f3cb7 add transform text
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b9f3cb762e36e7f7090987db9cba77948845cdaf">feat: transformText function · gcclll/stb-vue-next@b9f3cb7</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201130150054.png" alt="http://qiniu.ii6g.com/img/20201130150054.png" title="http://qiniu.ii6g.com/img/20201130150054.png" /></p>
<ol>
<li>
<p>必须是文本节点或者类型是组合表达式类型(<code>COMPOUND_EXPRESSION</code>)</p>
</li>
<li>
<p>patch flag 处理</p>
</li>
<li>
<p>构造 TEXT_CALL 类型节点</p>
</li>
<li>
<p>codegenNode -&gt; createCallExpression</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-10" class="outline-4">
<h4 id="headline-10">
f6d5271 add generate text codegen
</h4>
<div id="outline-text-headline-10" class="outline-text-4">
<p>
codegen 阶段目的是将 codegenNode 解析成 Render 函数的一部分。</p>
<ol>
<li>
<p><em>f6d5271</em> add <code>createCodegenContext()</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f6d52713ae8154d438c2ed94641525fa3c05edef">feat(add): codegen context creator · gcclll/stb-vue-next@f6d5271</a></p>
<p>
上下文对象创建函数，重点方法有两个(<code>push(code, node)</code> 和 <code>helper(key)</code>)。</p>
<p>
FIX1: lint errors, <a href="https://github.com/gcclll/stb-vue-next/commit/0ac8c2f4b6b5022caa0f83a7f850226c30a99d33">fix: f6d5271 lint errors · gcclll/stb-vue-next@0ac8c2f</a></p>
</li>
<li>
<p><em>2ef2699</em> 增加 text codegen generator 实现</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2ef2699b95457be4456b736b70467b98bf240ddd">feat: generate text codegen · gcclll/stb-vue-next@2ef2699</a></p>
<p>
该部分涉及到一个较为完整的 codegen generator 流程，所以增加内容较多，因此这里
不直接贴代码了，请点击上面 commit 链接查看实际增加的源码。</p>
<p>
处理流程：</p>
<ul>
<li>
<p>preamble 处理，如果是 Node 环境需要通过 <code>import { ...} from &#39;vue&#39;</code> 语法，如
果是浏览器环境使用 <code>const { ... } = Vue</code> 解构语法。</p>
</li>
<li>
<p>是否使用 <code>with() {}</code> 作用域语法，默认是使用的</p>
</li>
<li>
<p><code>return ...</code> 返回实际 render 函数返回结果，这里将返回最后被渲染的 DOM 结构。</p>
</li>
<li>
<p><code>genNode()</code> 递归处理 ast 生成 render 函数的对应部分代码</p>
</li>
</ul>
</li>
<li>
<p><em>6b901f9</em> 增加 node 环境或 module 环境处理(<code>genModulePreamble</code>)</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6b901f9f3d8af3dc415d31a6c5027d8e262fa74f">feat: module preamble · gcclll/stb-vue-next@6b901f9</a>
modue preamble : <code>export { ... } from &#39;vue&#39;</code>
function preamble: <code>const { ... } = Vue</code></p>
</li>
</ol>
<p>
重点增加的 genXxx 函数 <code>genText(node, context)</code> 专门用来处理文本节点的。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genText</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">TextNode</span> <span class="o">|</span> <span class="nx">SimpleExpressionNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">),</span> <span class="nx">node</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
测试
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<p>
测试将分为两个部分，</p>
<div id="outline-container-headline-12" class="outline-5">
<h5 id="headline-12">
function preamble 形式(作为全局 <code>Vue</code> 对象引入)
</h5>
<div id="outline-text-headline-12" class="outline-text-5">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

return function render(_ctx, _cache) {
  with (_ctx) {
    return &#34;pure text&#34;
  }
}
undefined
</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6b3bd2e4c20dc7a325ff7c0575c127595da91b42">fix: less the last } paren · gcclll/stb-vue-next@6b3bd2e</a></p>
</div>
</div>
<div id="outline-container-headline-13" class="outline-5">
<h5 id="headline-13">
module preamble 形式(<strong>es6</strong> 模块化导出导入)
</h5>
<div id="outline-text-headline-13" class="outline-text-5">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

return function render(_ctx, _cache) {
  return &#34;pure text&#34;
}
undefined
</pre>
<p>
这里好像看不出啥区别，后面再说吧。</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-interpolation" class="outline-2">
<h2 id="interpolation">
2f749b2 add interpolation generator
</h2>
<div id="outline-text-interpolation" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2f749b2a5d0872713704a52943bb18b550c559c0">feat(add): transform -&gt; generate interpolation · gcclll/stb-vue-next@2f749b2</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`{{ a &gt; b }}`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里实现分几个部分：</p>
<p>
<strong>transform</strong>: traverseNode() 增加对插值的处理，后面增加了 traverseChildren 处理，因为所有的
ast 都是挂在 <code>root.children</code> 中的，所以最开始解析的是 <code>ROOT</code> 节点，因此这里必须
要增加 <code>ROOT</code> 类型的解析，调用 <code>traverseChildren(node, ctx)</code> 去递归解析 <code>root.children</code></p>
<blockquote>
<p>transform() -&gt; traverseNode(): ROOT 解析 -&gt; traverseChildren() -&gt;
traverseNode(): INTERPOLATION</p>
</blockquote>
<p>
新增核心函数：遍历所有 <code>children[]</code> 调用 <code>traverseNode()</code> </p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseChildren</span><span class="p">(</span>
  <span class="nx">parent</span>: <span class="kt">ParentNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO	  let i = 0
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">nodeRemoved</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">i</span><span class="o">--</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span> <span class="k">continue</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">childIndex</span> <span class="o">=</span> <span class="nx">i</span> <span class="c1">// 方便在 transformXxx 函数中能快速定位到当前节点
</span><span class="c1"></span>    <span class="nx">context</span><span class="p">.</span><span class="nx">onNodeRemoved</span> <span class="o">=</span> <span class="nx">nodeRemoved</span>
    <span class="nx">traverseNode</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<img src="http://qiniu.ii6g.com/img/20201201155917.png" alt="http://qiniu.ii6g.com/img/20201201155917.png" title="http://qiniu.ii6g.com/img/20201201155917.png" /></p>
<p>
<strong>codegen</strong>: <code>genNode()</code> 中新增 <code>INTERPOLATION</code> 和 <code>SIMPLE_EXPRESSION</code> 类型的处理，
 因为 INTERPOLATION 的 ast.content(如上面代码执行结果) 类型是 SIMPLE_EXPRESSION。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genExpression</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">SimpleExpressionNode</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
 <span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">isStatic</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">node</span>
 <span class="nx">context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">isStatic</span> <span class="o">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">:</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">genInterpolation</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">InterpolationNode</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
 <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">pure</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">pure</span><span class="p">)</span> <span class="nx">push</span><span class="p">(</span><span class="nx">PURE_ANNOTATION</span><span class="p">)</span>
 <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">TO_DISPLAY_STRING</span><span class="p">)</span><span class="si">}</span><span class="sb">(`</span><span class="p">)</span>
 <span class="nx">genNode</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
 <span class="nx">push</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<hr>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2d0e2a6f7610059f37aef798d37eaafdf8c43377">feat(add): comment generator · gcclll/stb-vue-next@2d0e2a6</a></p>
<p>
拓展：add comment generator</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;!-- i&#39;m a comment --&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createCommentVNode : _createCommentVNode } = _Vue

    return _createCommentVNode(&#34; i&#39;m a comment &#34;)
  }
}
undefined
</pre>
</div>
</div>
<div id="outline-container-element" class="outline-2">
<h2 id="element">
add element transfrom and generator
</h2>
<div id="outline-text-element" class="outline-text-2">
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
准备工作 <code>compiler-core/src/utils.ts</code>
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9436d8fe155767391a278807ae02a6ae9eff94a3">feat: utils for compiler-core · gcclll/stb-vue-next@9436d8f</a></p>
<p>
相关正则： <code>const memberExpRE = /^[A-Za-z_$][\w$]*(?:\s*\.\s*[A-Za-z_$][\w$]*|\[[^\]]+\])*$/</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/image.png" alt="http://qiniu.ii6g.com/img/image.png" title="http://qiniu.ii6g.com/img/image.png" /></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2265e466e6daea95614d5fe96968b30ff11a2e19">feat(add): resolveComponentType · gcclll/stb-vue-next@2265e46</a></p>
<p>
解析出组件的类型，大体分为四类：</p>
<ol>
<li>
<p>动态组件： <code>&lt;component is=&#34;xx&#34;&gt;</code> 或 <code>&lt;component v-is=&#34;xx&#34;&gt;</code></p>
</li>
<li>
<p>内置组件： <code>Teleport, Transition, KeepAlive, Suspense</code></p>
</li>
<li>
<p>用户组件： <code>$setup[]</code> 上的组件</p>
</li>
<li>
<p>用户组件： <code>context.components[]</code> 上的组件</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-element-transform" class="outline-3">
<h3 id="element-transform">
87339d2 add element transform
</h3>
<div id="outline-text-element-transform" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/87339d25f1fa43ed5e0a13dabc60fec9479451c1">feat(add): transformElement function · gcclll/stb-vue-next@87339d2</a></p>
<p>
普通标签的 transform codegenNode阶段。</p>
<ol>
<li>
<p>add <code>createVNodeCall()</code> 函数，创建基本的 ELEMENT 类型节点 codegenNode</p>
<p>
根据 <code>isBlock</code> 参数决定使用 BLOCK 函数还是 VNODE 函数。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">createVNodeCall</span><span class="p">(</span>
     <span class="nx">context</span>: <span class="kt">TransformContext</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">tag</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">],</span>
     <span class="nx">props?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;props&#39;</span><span class="p">],</span>
     <span class="nx">children?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">],</span>
     <span class="nx">patchFlag?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;patchFlag&#39;</span><span class="p">],</span>
     <span class="nx">dynamicProps?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;dynamicProps&#39;</span><span class="p">],</span>
     <span class="nx">directives?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;directives&#39;</span><span class="p">],</span>
     <span class="nx">isBlock</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;isBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">disableTracking</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;disableTracking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">loc</span> <span class="o">=</span> <span class="nx">locStub</span>
 <span class="p">)</span><span class="o">:</span> <span class="nx">VNodeCall</span> <span class="p">{</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">isBlock</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">OPEN_BLOCK</span><span class="p">)</span>
         <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">CREATE_BLOCK</span><span class="p">)</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">CREATE_VNODE</span><span class="p">)</span>
     <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">return</span> <span class="p">{</span>
     <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">VNODE_CALL</span><span class="p">,</span>
     <span class="nx">tag</span><span class="p">,</span>
     <span class="nx">props</span><span class="p">,</span>
     <span class="nx">children</span><span class="p">,</span>
     <span class="nx">patchFlag</span><span class="p">,</span>
     <span class="nx">dynamicProps</span><span class="p">,</span>
     <span class="nx">directives</span><span class="p">,</span>
     <span class="nx">isBlock</span><span class="p">,</span>
     <span class="nx">disableTracking</span><span class="p">,</span>
     <span class="nx">loc</span>
 <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>add <code>createObjectExpression()</code> 函数</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">createObjectExpression</span><span class="p">(</span>
     <span class="nx">properties</span>: <span class="kt">ObjectExpression</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">],</span>
     <span class="nx">loc</span>: <span class="kt">SourceLocation</span> <span class="o">=</span> <span class="nx">locStub</span>
 <span class="p">)</span><span class="o">:</span> <span class="nx">ObjectExpression</span> <span class="p">{</span>
 <span class="k">return</span> <span class="p">{</span>
     <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_OBJECT_EXPRESSION</span><span class="p">,</span>
     <span class="nx">loc</span><span class="p">,</span>
     <span class="nx">properties</span>
 <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>add <code>getStaticType()</code> 判断节点是否需要做静态提升处理</p>
</li>
<li>
<p>add <code>transformElement: postTransformElement()</code> 函数</p>
</li>
<li>
<p>add <code>stringifyDynamicPropNames()</code> 将属性转成数组结构</p>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;root codegenNode: &#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
root codegenNode:  undefined
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode } = _Vue

    return null
  }
}
undefined
</pre>
<p>
正确结果：</p>
<pre class="example">
ƒ render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;))
  }
}
</pre>
<p>
问题：</p>
<ol>
<li>
<p>根节点 codegenNode 为空</p>
</li>
<li>
<p>render 函数内没有 <code>openBlock, createBlock</code> 导出</p>
</li>
<li>
<p>return 后面没内容(这是 generator 范畴，此节不展开)</p>
</li>
</ol>
<p>
问题1，2都是在同一个地方处理的，因为当 ROOT 节点只有一个孩子节点的时候，不会用
CREATE_VNODE 创建，而是改用 CREATE_BLOCK，所以这两个问题一起处理</p>
<p>
FIX 1,2: <a href="https://github.com/gcclll/stb-vue-next/commit/97cf290240fa937f167f8aadd6e6527744da4cbe">fix: no export open/create block function from Vue · gcclll/stb-vue-next@97cf290</a></p>
<p>
修改： <code>createRootCodegen(root: RootNode, context: TransformContext)</code></p>
</div>
</div>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
2f58786 add element generator
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2f58786c56986672c6b7cabdcd541363bf05b4dd">feat: element generator · gcclll/stb-vue-next@2f58786</a></p>
<p>
路径：</p>
<ol>
<li>
<p><code>VNODE_CALL</code> -&gt;</p>
</li>
<li>
<p><code>genVNodeCall()</code> -&gt;</p>
</li>
<li>
<p><code>genNodeList([], ctx)</code> -&gt;</p>
<ul>
<li>
<p>string: <code>push(node)</code></p>
</li>
<li>
<p>array: <code>genNodeListAsArray(node, ctx)</code> </p>
</li>
<li>
<p>other: <code>genNode(node, ctx)</code></p>
</li>
</ul>
</li>
</ol>
<p>
测试:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;root codegenNode: &#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
root codegenNode:  {
  type: 13,
  tag: &#39;&#34;div&#34;&#39;,
  props: undefined,
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 12, line: 1, offset: 11 },
    source: &#39;&lt;div&gt;&lt;/div&gt;&#39;
  }
}
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;))
  }
}
</pre>
</div>
</div>
<div id="outline-container-headline-19" class="outline-3">
<h3 id="headline-19">
05ca2f8 root.children 有多个孩子
</h3>
<div id="outline-text-headline-19" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/05ca2f8bedf21d146a01ad5694c727bbe776145c">feat: root.children has multi child · gcclll/stb-vue-next@05ca2f8 · GitHub</a></p>
<p>
当有多个孩子节点的时候，会创建一个 <code>fragment</code> 将他们包起来。</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201201232048.png" alt="http://qiniu.ii6g.com/img/20201201232048.png" title="http://qiniu.ii6g.com/img/20201201232048.png" /></p>
<p>
FIX: 死循环， <code>genNode(node.codegenNode, ctx)</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201201232120.png" alt="http://qiniu.ii6g.com/img/20201201232120.png" title="http://qiniu.ii6g.com/img/20201201232120.png" /></p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment,null,[
      _createVNode(&#34;div&#34;),
      _createVNode(&#34;div&#34;)
    ],64 /* STABLE_FRAGMENT */))
  }
}
undefined
</pre>
<p>
FIX: 参数之间少了空格(<a href="https://github.com/gcclll/stb-vue-next/commit/05ca2f8bedf21d146a01ad5694c727bbe776145c?branch=05ca2f8bedf21d146a01ad5694c727bbe776145c&amp;diff=split">feat: root.children has multi child · gcclll/stb-vue-next@05ca2f8</a>)</p>
<p>
正解：</p>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, Fragment: _Fragment, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment, null, [
      _hoisted_1,
      _hoisted_2
    ], 64 /* STABLE_FRAGMENT */))
  }
}
</pre>
<p>
正确答案中做了静态提升处理，代码在 <code>transform()</code> 函数中 <code>hoistStatic(root,
context)</code> 的调用，会从 ROOT 节点开始遍历，将需要提升的节点进行提升处理。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-20" class="outline-2">
<h2 id="headline-20">
7cb3dbf add hoist static 静态提升
</h2>
<div id="outline-text-headline-20" class="outline-text-2">
<p>
满足提升的三种情况：</p>
<ol>
<li>
<p>tag 和 tagType 都是 ELEMENT 且整棵树都是静态</p>
</li>
<li>
<p>包含动态孩子节点，但是有静态属性的，将属性提升</p>
</li>
<li>
<p>纯文本节点</p>
</li>
</ol>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7d7dbd4e20198e73df5c93804dce122656252c8f">feat(add): hoist static · gcclll/stb-vue-next@7d7dbd4</a></p>
<p>
transform() 中增加静态提升处理：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">hoistStatic</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">hoistStatic</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7cb3dbf94bd17c5af68dc55103a8031da28be55b">feat: hoist static · gcclll/stb-vue-next@7cb3dbf</a></p>
<ol>
<li>
<p>修改 <code>genFunctionPreamble(ast: RootNode, context: CodegenContext)</code> 解构出需要用到的函数(<code>_createVNode</code>)</p>
<p>
<img src="/img/commit/diff-hoist-decon-functions.png" alt="/img/commit/diff-hoist-decon-functions.png" title="/img/commit/diff-hoist-decon-functions.png" /></p>
</li>
<li>
<p>增加 <code>genHoists()</code> 函数，生成 <code>ast.hoists</code> 中需要提升的节点</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genHoists</span><span class="p">(</span><span class="nx">hoists</span><span class="o">:</span> <span class="p">(</span><span class="nx">JSChildNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)[],</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hoists</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="nx">context</span><span class="p">.</span><span class="nx">pure</span> <span class="o">=</span> <span class="kc">true</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">newline</span><span class="p">,</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">scopeId</span><span class="p">,</span> <span class="nx">mode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
<span class="kr">const</span> <span class="nx">genScopeId</span> <span class="o">=</span> <span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="nx">scopeId</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">mode</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span>
<span class="nx">newline</span><span class="p">()</span>

<span class="c1">// push scope Id before initializing hoisted vnodes so that these vnodes
</span><span class="c1">// get the proper scopeId as well.
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">genScopeId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">PUSH_SCOPE_ID</span><span class="p">)</span><span class="si">}</span><span class="sb">(&#34;</span><span class="si">${</span><span class="nx">scopeId</span><span class="si">}</span><span class="sb">&#34;)`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">hoists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`const _hoisted_</span><span class="si">${</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="sb"> = `</span><span class="p">)</span>
    <span class="nx">genNode</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">genScopeId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">POP_SCOPE_ID</span><span class="p">)</span><span class="si">}</span><span class="sb">()`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">context</span><span class="p">.</span><span class="nx">pure</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment, null, [
      _hoisted_1,
      _hoisted_2
    ], 64 /* STABLE_FRAGMENT */))
  }
}
undefined
</pre>
<blockquote>
<p>PS: 静态属性提升 <a href="https://github.com/gcclll/stb-vue-next/commit/1e58eeb605b0dc88c90dac550b927f89dd18e07d">feat: props hoist static · gcclll/stb-vue-next@1e58eeb</a></p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-21" class="outline-2">
<h2 id="headline-21">
prop transform and generator
</h2>
<div id="outline-text-headline-21" class="outline-text-2">
<p>
在这之前我们完成了以下几个基本部分：</p>
<ul>
<li>
<p><a href="#pure-text">文本</a></p>
</li>
<li>
<p><a href="#interpolation">插值</a></p>
</li>
<li>
<p><a href="#element">普通标签(一个和多个)</a></p>
</li>
</ul>
<p>
接下来需要完成属性的解析才能进行下一步，因为 <code>v-if, v-for, v-slot, ...</code> 都需要属
性解析。</p>
<p>
属性转换这里异常复杂，需要慢慢展开来讲，并且涉及到各种指令，因此对于完整的测试需
要等所有指令 transform 完成之后再进行。</p>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
1792f93 props transform
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<div id="outline-container-headline-23" class="outline-4">
<h4 id="headline-23">
buildProps
</h4>
<div id="outline-text-headline-23" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1792f93b26aff5d0db60d83b946a83fb0fa6e776">feat(add): transform props · gcclll/stb-vue-next@1792f93</a></p>
<ul>
<li>
<p>将 <code>codegenNode.props</code> 构建成 如下结构：</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span>
  <span class="nt">&#34;properties&#34;</span><span class="p">:[</span>
      <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span>
          <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;class&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span>
          <span class="p">},</span>
          <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;second&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span>
          <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span>
          <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;onClick&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span>
          <span class="p">},</span>
          <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;clickHandle&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>v-bind,v-on 指令，没有参数，需要将 props 合并</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-24" class="outline-4">
<h4 id="headline-24">
transform props
</h4>
<div id="outline-text-headline-24" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/20a5fa8bfefa9dd98a7965f78ff1f84de2591962">feat: transform props in codgenNode · gcclll/stb-vue-next@20a5fa8</a></p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-25" class="outline-3">
<h3 id="headline-25">
e4acc0d props generator
</h3>
<div id="outline-text-headline-25" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e4acc0dd5e33ceab3420f9e5ca8857f090bb536c">feat: props generator · gcclll/stb-vue-next@e4acc0d</a></p>
<p>
修改点：</p>
<ol>
<li>
<p>add <code>genExpressionAsPropertyKey()</code> 生成属性 key 函数</p>
<p>
三种可能的属性名</p>
<ul>
<li>
<p>静态属性名: <code>&lt;div class=&#34;value&#34;&gt;</code> -&gt; <code>{ class: &#34;value&#34; }</code></p>
</li>
<li>
<p>动态属性名: <code>&lt;div :[propName]=&#34;value&#34;</code> -&gt; <code>{ [propName]: &#34;value&#34;}</code></p>
</li>
<li>
<p>组合表达式属性名：TODO</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// 生成对象的属性 key (可能是静态，动态)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">genExpressionAsPropertyKey</span><span class="p">(</span>
 <span class="nx">node</span>: <span class="kt">ExpressionNode</span><span class="p">,</span>
 <span class="nx">context</span>: <span class="kt">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
 <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMPOUND_EXPRESSION</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// TODO 动态属性名或表达式
</span><span class="c1"></span> <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">isStatic</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// only quote key if necessary
</span><span class="c1"></span>   <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">isSimpleIdentifier</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
     <span class="o">?</span> <span class="nx">node.content</span>
     : <span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

   <span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="nx">push</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">]`</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
 <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>add <code>genObjectExpression()</code> 将属性列表生成对象</p>
<p>
遍历节点的 <code>node.properties</code> 先生成 key(<code>genExpressionAsPropertyKey(key)</code>) 再生成 value(<code>genNode(value)</code>) 。</p>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;first&#34; name=&#34;div&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = {
  class: &#34;first&#34;,
  name: &#34;div&#34;
}

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, _hoisted_1))
  }
}
undefined
</pre>
<blockquote>
<p>实例中最后是用的 <code>createBlock()</code> 是因为 root.children 只有一个 child 。</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-26" class="outline-3">
<h3 id="headline-26">
static props
</h3>
<div id="outline-text-headline-26" class="outline-text-3">
<p>
修改函数： <code>transforms/transformElement</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;first&#34;&gt;&lt;/div&gt;&lt;div class=&#34;second&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">props</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 6,
  name: &#39;class&#39;,
  value: {
    type: 2,
    content: &#39;first&#39;,
    loc: { start: [Object], end: [Object], source: &#39;&#34;first&#34;&#39; }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 19, line: 1, offset: 18 },
    source: &#39;class=&#34;first&#34;&#39;
  }
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-27" class="outline-3">
<h3 id="headline-27">
6951dd1 merge props
</h3>
<div id="outline-text-headline-27" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6951dd1ff97da1ef803e97770162fe0293ef76cc">feat: merge props · gcclll/stb-vue-next@6951dd1</a></p>
<p>
合并属性的条件：存在没有参数的指令，如： <code>&lt;div v-bind=&#34;{...}&#34; v-on=&#34;{...}&#34;</code></p>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/12a66f0ebef241b282b4ccf746ddabc1a2f45ef1">fix: merge toHandlers props · gcclll/stb-vue-next@12a66f0</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">title</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; </span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>
 
<span class="nx">log</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;div class=&#34;first&#34; v-on=&#34;{ click: clickHandle  }&#34; v-bind=&#34;{ style: &#39;color:red&#39; }&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="s1">&#39;无参数的指令，合并所有属性&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;second&#34; v-on:click=&#34;clickHandle&#34; v-bind:style=&#34;color:red&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="s1">&#39;有参数的指令，不合并&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 无参数的指令，合并所有属性
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toHandlers : _toHandlers, mergeProps : _mergeProps, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, _mergeProps({ class: &#34;first&#34; }, _toHandlers({ click: clickHandle  }), { style: &#39;color:red&#39; }), null, 16 /* FULL_PROPS */))
  }
}
&gt;&gt;&gt; 有参数的指令，不合并
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock(&#34;div&#34;, { class: &#34;second&#34; }, null, 512 /* NEED_PATCH */)), )
  }
}
undefined
</pre>
<p>
有参数指令时，需要结合 <code>v-on</code> 指令解析，因此需要先实现了 transform 指令才能得到下面的正确结果。</p>
<p>
不合并(<code>mergeProps()</code>) 的正解：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="kd">function</span> <span class="nx">anonymous</span><span class="p">(</span>
<span class="p">)</span> <span class="p">{</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">Vue</span> <span class="o">=</span> <span class="nx">Vue</span>

<span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">openBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="kr">class</span><span class="o">:</span> <span class="s2">&#34;second&#34;</span><span class="p">,</span>
      <span class="nx">onClick</span><span class="o">:</span> <span class="nx">clickHandle</span><span class="p">,</span>
      <span class="nx">style</span><span class="o">:</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span> <span class="p">}</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">12</span> <span class="cm">/* STYLE, PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;onClick&#34;</span><span class="p">]))</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
下面将继续完成指令相关的 transform</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-28" class="outline-2">
<h2 id="headline-28">
6c43451 add v-on transform
</h2>
<div id="outline-text-headline-28" class="outline-text-2">
<p>
init: <a href="https://github.com/gcclll/stb-vue-next/commit/98dcc9653790a319c3bc04222322167db21546df">feat(init): v-on directive · gcclll/stb-vue-next@98dcc96</a></p>
<p>
实现：<a href="https://github.com/gcclll/stb-vue-next/commit/6c4345156ffc86542120bb97deb438097b36efca">feat: v-on directive transform · gcclll/stb-vue-next@6c43451</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;second&#34; v-on:click=&#34;clickHandle&#34; v-bind:style=&#34;color:red&#34;&gt;&lt;/div&gt;`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock(&#34;div&#34;, {
      class: &#34;second&#34;,
      onClick: clickHandle
    }, null, 8 /* PROPS */, [&#34;onClick&#34;])), )
  }
}
undefined
</pre>
<p>
问题： <code>v-bind</code> 没有被解析出来。</p>
<p>
如果 v-on的 exp 是个简单的表达式，需要将其转成函数 <code>$event =&gt; (i++)</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1542b412cef3a1c81e3099e52bb5f7aa1fee2abe">feat(add): v-on with simple expression as handler · gcclll/stb-vue-next@1542b41</a></p>
<p>
判断是简单表达式的依据：</p>
<p>
<code>const isInlineStatement = !(isMemberExp || fnExpRE.test(exp.content))</code></p>
<p>
即不是 member expression 也不是 function expression 。</p>
<p>
member expression: <code>/^[A-Za-z_$][\w$]*(?:\s*\.\s*[A-Za-z_$][\w$]*|\[[^\]]+\])*$/</code>
<img src="http://qiniu.ii6g.com/img/20201212163019.png" alt="http://qiniu.ii6g.com/img/20201212163019.png" title="http://qiniu.ii6g.com/img/20201212163019.png" /></p>
<p>
function expresstion: <code>/^\s*([\w$_]+|\([^)]*?\))\s*=&gt;|^\s*function(?:\s+[\w$]+)?\s*\(/</code>
<img src="http://qiniu.ii6g.com/img/20201212163123.png" alt="http://qiniu.ii6g.com/img/20201212163123.png" title="http://qiniu.ii6g.com/img/20201212163123.png" /></p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div v-on:click=&#34;i++&#34;&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; event name`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">key</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; event handler`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, {
      onClick: $event =&gt; (i++)
    }, null, 8 /* PROPS */, [&#34;onClick&#34;]))
  }
}
&gt;&gt;&gt; event name
{
  type: 4,
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 16, line: 1, offset: 15 },
    source: &#39;click&#39;
  },
  content: &#39;onClick&#39;,
  isStatic: true,
  constType: 3
}
&gt;&gt;&gt; event handler
{
  type: 8,
  loc: {
    source: &#39;&#39;,
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  },
  children: [
    &#39;$event =&gt; (&#39;,
    {
      type: 4,
      content: &#39;i++&#39;,
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    &#39;)&#39;
  ]
}
undefined
</pre>
<div class="comment-block">
<p>更多测试用例(<code>&lt;f12&gt;</code>)打开控制台查看 -&gt;&gt; 。</p>
</div>
<script>
l1(`v-on 指令`)
c(`<div v-on:click="onClick"/>`, `v-on click`)
c(`<div v-on:[event]="handler"/>`, `v-on动态事件名`)
l2(`TODO 'dynamic arg with prefixing'`)
l2(`TODO dynamic arg with complex exp prefixing`)
c(`<div @click="i++"/>`, '如果 v-on 的exp 是个简单表达式，要用函数封装起来')
c(`<div @click="foo();bar()"/>`, `支持多个表达式`)
c(`<div @click="\nfoo();\nbar()\n"/>`, `支持多行表达式`)
c(`<div @click="foo($event)"/>`, `函数调用`)
c(`<div @click="foo($event);bar()"/>`, `函数调用加表达式混合`)
c(`<div @click="$event => foo($event)"/>`, `如果本身是函数不用多余处理`)
c(`<div @click="
      $event => {
        foo($event)
      }
    "/>`, `=> 如果表达式已经是函数原样输出就行`)
c(`<div @click="
      function($event) {
        foo($event)
      }
    "/>`, `function, 如果表达式已经是函数原样输出就行`)
c(`<div @click="a['b' + c]"/>`, `如果表达式是对象取值表达式，不用处理`)
c(`<div v-on:click />`, `如果没有表达式和修饰符，报错`)
c(`<div v-on:click.prevent />`, `如果没表达式但是有修饰符，不报错`)
c(`<div v-on:foo-bar="onMount"/>`, `事件名为 foo-bar 要转成驼峰 onFooBar`)
c(`<div v-on:vnode-mounted="onMount"/>`, 'case conversion for vnode hooks')
compile.options = { cacheHandlers: true }
c(`<div v-on:click.prevent />`, `empty handler`)
c(`<div v-on:click="foo" />`, 'member expression handler')
c(`<div v-on:click="foo.bar" />`, 'compound member expression handler')
c(`<comp v-on:click="foo" />`, 'bail on component member expression handler')
c(`<div v-on:click="() => foo()" />`, 'inline function expression handler')
c(`<div v-on:click="foo++" />`, 'inline statement handler')
</script>
<p>
<code>options.cacheHandlers</code> 属性要配合 <code>options.prefixIdentifiers</code> 使用。</p>
<p>
作用是缓存事件处理函数，原理是:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">createVNode</span> <span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">openBlock</span> <span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span> <span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">onClick</span><span class="o">:</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="mi">_</span><span class="nx">cache</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{})</span>
    <span class="p">}))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
缓存的附加条件： <code>let shouldCache: boolean = context.cacheHandlers &amp;&amp; !exp</code></p>
<p>
没有表达式值的情况下才缓存，因为此时会创建一个空的函数作为事件 handler，为了避免
创建过多的无意义的空函数，使用缓存是个不错的选择(<del>但，一般绑定了事件应该不至于不
给处理函数吧!!!</del>)。</p>
</div>
</div>
<div id="outline-container-v-bind" class="outline-2">
<h2 id="v-bind">
f805858 add v-bind transform
</h2>
<div id="outline-text-v-bind" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f80585802218bcc75aad502880c571b642257ef0">feat(add): v-bind transform · gcclll/stb-vue-next@f805858</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;div v-bind:name=&#34;test&#34;
</span><span class="sb">  :age=&#34;100&#34;
</span><span class="sb">  :[propName]=&#34;myName&#34;
</span><span class="sb">  :[first+second]=&#34;thrid&#34;
</span><span class="sb">  :no-need-camel-prop=&#34;noNeedCamelProp&#34;
</span><span class="sb">  :need-camel-prop.camel=&#34;needCamelProp&#34;
</span><span class="sb">  :no-exp-prop.camel
</span><span class="sb">&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; render function\n`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
v-bind is missing expression.
&gt;&gt;&gt; render function

const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, {
      name: test,
      age: 100,
      [propName || &#34;&#34;]: myName,
      [first+second || &#34;&#34;]: thrid,
      &#34;no-need-camel-prop&#34;: noNeedCamelProp,
      needCamelProp: needCamelProp,
      noExpProp: &#34;&#34;
    }, null, 16 /* FULL_PROPS */, [&#34;name&#34;,&#34;age&#34;,&#34;no-need-camel-prop&#34;,&#34;needCamelProp&#34;,&#34;noExpProp&#34;]))
  }
}
undefined
</pre>
<p>
v-bind 属性支持以下几种方式：</p>
<ul>
<li>
<p><code>v-bind:name=&#34;test&#34;</code> 无缩写属性，最普通的一种用法</p>
</li>
<li>
<p><code>:age=&#34;100&#34;</code> 缩写形式</p>
</li>
<li>
<p><code>:[propName]=&#34;myName&#34;</code> 普通动态属性名</p>
</li>
<li>
<p><code>:[first+second]=&#34;third&#34;</code> 表达式动态属性名</p>
</li>
<li>
<p><code>:no-need-camel-prop=&#34;noNeedCamelProp&#34;</code> 不需要转驼峰的属性名</p>
</li>
<li>
<p><code>:need-camel-prop.camel=&#34;needCamelProp&#34;</code> 需要转成驼峰的属性名，需要制定
<code>.camel</code> 修饰符</p>
</li>
<li>
<p><code>no-exp-prop.camel</code> 无属性值的属性，会给默认 <code>&#34;&#34;</code> 值，同时给出警告，不建议使用。</p>
</li>
</ul>
<div class="comment-block">
<p>更多测试用例(<code>&lt;f12&gt;</code>)打开控制台查看 -&gt;&gt; 。</p>
</div>
<script>
l1(`v-bind 指令 >>>>>`)
c(`<div v-bind:id="id"/>`, 'basic')
c(`<div v-bind:[id]="id"/>`, `dynamic arg`)
c(`<div v-bind:arg />`, `should error if no expression`)
c(`<div v-bind:foo-bar.camel="id"/>`, '.camel modifier')
c(`<div v-bind:[foo].camel="id"/>`, '.camel modifier w/ dynamic arg')
c(`<div v-bind:[foo(bar)].camel="id"/>`, '.camel modifier w/ dynamic arg + prefixIdentifiers')
</script>
</div>
</div>
<div id="outline-container-headline-30" class="outline-2">
<h2 id="headline-30">
0cc76f0 add v-model transform
</h2>
<div id="outline-text-headline-30" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0cc76f04112b1194e0a5cafae0a49bc399462ebf">feat(add): v-model transform · gcclll/stb-vue-next@0cc76f0</a></p>
<p>
<code>&lt;input v-model=&#34;model&#34; /&gt;</code></p>
<p>
经过 <code>transformModel</code> 之后的 node.props:</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="err">//</span> <span class="err">JS_PROPERTY</span>
        <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="err">//</span> <span class="err">SIMPLE_EXPRESSION</span>
            <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;modelValue&#34;</span><span class="p">,</span>
            <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
            <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">3</span>
        <span class="p">},</span>
        <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
            <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;model&#34;</span><span class="p">,</span>
            <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
            <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span>
        <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
            <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="p">,</span>
            <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
            <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">3</span>
        <span class="p">},</span>
        <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="err">//</span> <span class="err">COMPOUND_EXPRESSION</span>
            <span class="nt">&#34;children&#34;</span><span class="p">:[</span>
                <span class="s2">&#34;$event =&gt; (&#34;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                    <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;model&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
                    <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&#34; = $event)&#34;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
compiler-core 阶段的解析脑图：
<img src="/img/vue3/compiler-core/pcg/pcg-08-v-model-cc.svg" alt="/img/vue3/compiler-core/pcg/pcg-08-v-model-cc.svg" title="/img/vue3/compiler-core/pcg/pcg-08-v-model-cc.svg" /></p>
<p>
从图中可以看出， v-model 指令的解析也是在 buildProps 中完成的，关于这个函数的脑
图也可以查看 <a href="/vue/vue-mind-map-house-cc/#key-01-build-props">buildProps(node, context) 如何构建 props ?</a></p>
<p>
vue/baseCompile 解析之后的结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">Vue</span> <span class="o">=</span> <span class="nx">Vue</span>

<span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">openBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">modelValue</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      <span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="o">:</span> <span class="nx">$event</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">$event</span><span class="p">)</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span> <span class="cm">/* PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;modelValue&#34;</span><span class="p">,</span> <span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="p">]))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
vue/compile 经过 compile-dom package(<em>未完成</em>) 的 transformModel 之后的结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="kd">function</span> <span class="nx">anonymous</span><span class="p">(</span>
<span class="p">)</span> <span class="p">{</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">Vue</span> <span class="o">=</span> <span class="nx">Vue</span>

<span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">vModelText</span><span class="o">:</span> <span class="mi">_</span><span class="nx">vModelText</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">withDirectives</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withDirectives</span><span class="p">,</span> <span class="nx">openBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="mi">_</span><span class="nx">withDirectives</span><span class="p">((</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="o">:</span> <span class="nx">$event</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">$event</span><span class="p">)</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span> <span class="cm">/* PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="p">])),</span> <span class="p">[</span>
      <span class="p">[</span><span class="mi">_</span><span class="nx">vModelText</span><span class="p">,</span> <span class="nx">model</span><span class="p">]</span>
    <span class="p">])</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a537be0fc265243012032750a801b6e6582751d5">fix: v-model no value · gcclll/stb-vue-next@a537be0</a></p>
<p>
修复之后(<code>genNode</code> 没有实现 <code>8,COMPOUND_EXPRESSION</code> 类型)，测试</p>
<ol>
<li>
<p>不带参数的 <code>v-model</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">baseParse</span><span class="p">,</span>
     <span class="nx">baseCompile</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

 <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model=&#34;model&#34; /&gt;`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      modelValue: model,
      &#34;onUpdate:modelValue&#34;: $event =&gt; (model = $event)
    }, null, 8 /* PROPS */, [&#34;modelValue&#34;,&#34;onUpdate:modelValue&#34;]))
  }
}
</pre>
</li>
<li>
<p>指令 <code>{ prefixIdentifiers: true }</code> 选项(需要 node 环境, <strong>TODO</strong>)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">baseParse</span><span class="p">,</span>
     <span class="nx">baseCompile</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

 <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model=&#34;model&#34; /&gt;`</span><span class="p">,</span> <span class="p">{</span>
   <span class="nx">prefixIdentifiers</span><span class="o">:</span> <span class="kc">true</span>
 <span class="p">})</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      modelValue: model,
      &#34;onUpdate:modelValue&#34;: $event =&gt; (model = $event)
    }, null, 8 /* PROPS */, [&#34;modelValue&#34;,&#34;onUpdate:modelValue&#34;]))
  }
}
undefined
</pre>
</li>
<li>
<p>组合表达式(<code>8,COMPOUND_EXPRESSION</code>)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
<span class="nx">baseParse</span><span class="p">,</span>
<span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model=&#34;model[index]&#34; /&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      modelValue: model[index],
      &#34;onUpdate:modelValue&#34;: $event =&gt; (model[index] = $event)
    }, null, 8 /* PROPS */, [&#34;modelValue&#34;,&#34;onUpdate:modelValue&#34;]))
  }
}
undefined
</pre>
</li>
<li>
<p>带参数</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
<span class="nx">baseParse</span><span class="p">,</span>
<span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model:value=&#34;model&#34; /&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      value: model,
      &#34;onUpdate:value&#34;: $event =&gt; (model = $event)
    }, null, 40 /* PROPS, HYDRATE_EVENTS */, [&#34;value&#34;,&#34;onUpdate:value&#34;]))
  }
}
undefined
</pre>
<p>
 不带参数的时候参数名会给一个默认值： <code>modelValue</code>, 如果有自己的参数会直接使
用提供的参数名。</p>
</li>
<li>
<p>动态参数</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
<span class="nx">baseParse</span><span class="p">,</span>
<span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model:[value]=&#34;model&#34; /&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
有问题结果：</p>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      [value]: model,
      : $event =&gt; (model = $event)
    }, null, 16 /* FULL_PROPS */))
  }
}
</pre>
<p>
结果显示，动态属性的事件名没有被解析出来 <code>: $event =&gt; (model = $event)</code> 。</p>
<p>
修复之后结果(<a href="https://github.com/gcclll/stb-vue-next/commit/94a7a850d7e060e948c5672cdb170c47489feda9">fix: v-model dynamic arg generate · gcclll/stb-vue-next@94a7a85</a>)：</p>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      [value]: model,
      [&#34;onUpdate:&#34; + value]: $event =&gt; (model = $event)
    }, null, 16 /* FULL_PROPS */))
  }
}
</pre>
</li>
<li>
<p>缓存事件回调函数(<code>cacheHandlers: true</code>, <strong>TODO</strong>)</p>
<p>
需要结合 <code>prefixIdentifiers: true</code> 使用。</p>
</li>
</ol>
<div class="comment-block">
<p>针对 v-model 还需要 compile-runtime 阶段的支持，由于这里还没完成，所以这里的结果
和 vue-next 测试结果会有些出入，出入点在于 compiler-runtime 期会将 <code>modelValue:
model</code> 删除。</p>
</div>
<div class="comment-block">
<p>更多测试用例(<code>&lt;f12&gt;</code>)打开控制台查看 -&gt;&gt; 。</p>
</div>
<script>
l1(`v-model 指令`)
c('<input v-model="model" />', 'simple expression')
c('<input v-model="\n model\n.\nfoo \n" />', 'simple expression (with multilines)')
c('<input v-model="model[index]" />', 'compound expression')
c('<input v-model:value="model" />', 'with argument')
c('<input v-model:[value]="model" />', 'with dynamic argument')
c('<input v-model="foo" />', 'should cache update handler w/ cacheHandlers: true')
c('<input v-for="i in list" v-model="foo[i]" />', 'should not cache update handler if it refers v-for scope variables')
c('<Comp v-slot="{ foo }"><input v-model="foo.bar"/></Comp>', 'should mark update handler dynamic if it refers slot scope variables')
c('<Comp v-model.trim.bar-baz="foo" />', 'should generate modelModifiers for component v-model')
c('<Comp v-model:foo.trim="foo" v-model:bar.number="bar" />', 'should generate modelModifiers for component v-model with arguments')
c('<span v-model />', 'missing expression')
c('<span v-model="" />', 'empty expression')
c('<span v-model="a + b" />', 'mal-formed expression')
c('<span v-for="i in list" v-model="i" />', 'used on scope variable')
</script>
</div>
</div>
<div id="outline-container-headline-31" class="outline-2">
<h2 id="headline-31">
bf18a84 add v-once transform
</h2>
<div id="outline-text-headline-31" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/bf18a84650adaf68004a0ce0977d33b1436a4587">feat(add): v-once · gcclll/stb-vue-next@bf18a84</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">seen</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakSet</span><span class="p">()</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">transformOnce</span>: <span class="kt">NodeTransform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span> <span class="nx">findDir</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;once&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 缓存实现 v-once，就算有数据更新也不会重新生成 render 函数
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">seen</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">seen</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SET_BLOCK_TRACKING</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span> <span class="kr">as</span> <span class="nx">ElementNode</span> <span class="o">|</span> <span class="nx">IfNode</span> <span class="o">|</span> <span class="nx">ForNode</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cur</span><span class="p">.</span><span class="nx">codegenNode</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">,</span> <span class="kc">true</span> <span class="cm">/* isVNode */</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>v-once</code> 指令的实现看似挺简单的，将解析后的 node 节点缓存到 <code>seen: WeakSet</code> 中，
下次使用的时候直接取缓存(<code>context.cache(...)</code>)，而不是重新生成 <code>codegenNode</code></p>
<p>
<code>JS_CACHE_EXPRESSION</code> 结构：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createCacheExpression</span><span class="p">(</span>
  <span class="nx">index</span>: <span class="kt">number</span><span class="p">,</span>
  <span class="nx">value</span>: <span class="kt">JSChildNode</span><span class="p">,</span>
  <span class="nx">isVNode</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">CacheExpression</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CACHE_EXPRESSION</span><span class="p">,</span>
    <span class="nx">index</span><span class="p">,</span> <span class="c1">// 在 context.cached 中的索引
</span><span class="c1"></span>    <span class="nx">value</span><span class="p">,</span> <span class="c1">// v-once节点的 ast
</span><span class="c1"></span>    <span class="nx">isVNode</span><span class="p">,</span> <span class="c1">// block 或 vnode ?
</span><span class="c1"></span>    <span class="nx">loc</span>: <span class="kt">locStub</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
generator 阶段实现：<a href="https://github.com/gcclll/stb-vue-next/commit/8bacf14f156f0ca357d4c0efdbc75dc2120a3ec5">feat(add): v-once generator · gcclll/stb-vue-next@8bacf14</a></p>
<p>
在 <code>genNode()</code> 中增加 <code>JS_CACHE_EXPRESSION</code> 类型的分支处理。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genCacheExpression</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">CacheExpression</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">indent</span><span class="p">,</span> <span class="nx">deindent</span><span class="p">,</span> <span class="nx">newline</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">isVNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">indent</span><span class="p">()</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SET_BLOCK_TRACKING</span><span class="p">)</span><span class="si">}</span><span class="sb">(-1),`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="nx">push</span><span class="p">(</span><span class="sb">`_cache[</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">index</span><span class="si">}</span><span class="sb">] = `</span><span class="p">)</span>
  <span class="nx">genNode</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">isVNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`,`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SET_BLOCK_TRACKING</span><span class="p">)</span><span class="si">}</span><span class="sb">(1),`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`_cache[</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">index</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>
    <span class="nx">deindent</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">push</span><span class="p">(</span><span class="sb">`)`</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">tpl</span><span class="p">,</span> <span class="nx">desc</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">desc</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">tpl</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div :id=&#34;foo&#34; v-once /&gt;`</span><span class="p">,</span> <span class="sb">`&gt;&gt;&gt; &lt;div :id=&#34;foo&#34; v-once /&gt;`</span><span class="p">)</span>
<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;div :id=&#34;foo&#34; v-once /&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="sb">`&gt;&gt;&gt; 标签中嵌套使用`</span><span class="p">)</span>
<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;Comp :id=&#34;foo&#34; v-once /&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="sb">`&gt;&gt;&gt; 在自定义组件上`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; &lt;div :id=&#34;foo&#34; v-once /&gt;
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { setBlockTracking : _setBlockTracking, createVNode : _createVNode } = _Vue

    return _cache[1] || (
      _setBlockTracking(-1),
      _cache[1] = _createVNode(&#34;div&#34;, { id: foo }, null, 8 /* PROPS */, [&#34;id&#34;]),
      _setBlockTracking(1),
      _cache[1]
    )
  }
}
&gt;&gt;&gt; 标签中嵌套使用
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { setBlockTracking : _setBlockTracking, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, null, [
      _cache[1] || (
        _setBlockTracking(-1),
        _cache[1] = _createVNode(&#34;div&#34;, { id: foo }, null, 8 /* PROPS */, [&#34;id&#34;]),
        _setBlockTracking(1),
        _cache[1]
      )
    ]))
  }
}
&gt;&gt;&gt; 在自定义组件上
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { setBlockTracking : _setBlockTracking, resolveComponent : _resolveComponent, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, null, [
      _cache[1] || (
        _setBlockTracking(-1),
        _cache[1] = _createVNode(_component_Comp, { id: foo }, null, 8 /* PROPS */, [&#34;id&#34;]),
        _setBlockTracking(1),
        _cache[1]
      )
    ]))
  }
}
undefined
</pre>
<p>
TODO 缺少： <code>const _component_Comp = _resolveComponent(&#34;Comp&#34;)</code></p>
<div class="comment-block">
<p>更多测试用例(<code>&lt;f12&gt;</code>)打开控制台查看 -&gt;&gt; 。</p>
</div>
<script>
l1(`v-once 指令`)
c(`<div :id="foo" v-once />`, 'as root node', ast => ast.codegenNode)
c(`<div><div :id="foo" v-once /></div>`, 'on nested plain element')
c(`<div><Comp :id="foo" v-once /></div>`, 'on component')
c(`<div><slot v-once /></div>`, 'on slot outlet')
c(`<div><div v-once /></div>`, 'with hoistStatic: true')
c(`<div v-if="BOOLEAN" v-once /><p v-else/>`, 'with v-if/else')
c(`<div v-for="i in list" v-once />`, 'with v-for')
</script>
</div>
</div>
<div id="outline-container-headline-32" class="outline-2">
<h2 id="headline-32">
acdea14 add v-if transform
</h2>
<div id="outline-text-headline-32" class="outline-text-2">
<p>
<code>v-if</code> 指令源码脑图可参考： <a href="/vue/vue-mind-map-house-cc/#pcg-v-if">05 v-if 指令(git:0a591b6)</a></p>
<p>
对于 <code>v-if|else|else-if</code> 指令在 transform 阶段，转换收集 transformXxx 函数过程中，
会先针对指令进行处理，比如： <code>v-else, v-else-if</code> 指令的组件会被解析到 <code>v-if</code> 节
点的 <code>node.branches[]</code> 分支数组里面之后被删除，这些都是在收集 transformXxx 之前需要完成的。</p>
<p>
包括 <code>v-for</code> 指令都需要经过 <code>createStructuralDirectiveTransform()</code> 函数封装一层
之后，返回对应的 <code>transformXxx</code> 函数。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">createStructuralDirectiveTransform</span><span class="p">(</span>
  <span class="nx">name</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span><span class="p">,</span>
  <span class="nx">fn</span>: <span class="kt">StructuralDirectiveTransform</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">NodeTransform</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
    <span class="o">?</span> <span class="p">(</span><span class="nx">n</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">n</span> <span class="o">===</span> <span class="nx">name</span>
    <span class="o">:</span> <span class="p">(</span><span class="nx">n</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">name</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">props</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">node</span>
      <span class="c1">// structural directive transforms are not concerned with slots
</span><span class="c1"></span>      <span class="c1">// as they are handled separately in vSlot.ts
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">isVSlot</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="kr">const</span> <span class="nx">exitFns</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">prop</span> <span class="o">=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
          <span class="c1">// structural directives are removed to avoid infinite recursion
</span><span class="c1"></span>          <span class="c1">// also we remove them *before* applying so that it can further
</span><span class="c1"></span>          <span class="c1">// traverse itself in case it moves the node around
</span><span class="c1"></span>          <span class="nx">props</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="nx">i</span><span class="o">--</span>
          <span class="kr">const</span> <span class="nx">onExit</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">onExit</span><span class="p">)</span> <span class="nx">exitFns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onExit</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">exitFns</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
通过 <code>for (...)</code> 将所有 v-if/v-for 相关指令经过他们自己的处理函数(比如：
<code>processIf</code> ) 之后得到最终的 <code>onExit</code> 收集到 <code>exitFns</code> 中，在处理过程中随时会出
现节点的删除操作(比如： <code>v-else</code> 节点会在解析完之后被删除)，在正常的 traverse 过
程中这些节点都不会再存在。</p>
<blockquote>
<p>PS: 正确理解应该属于移动操作，因为原始的 AST 结构并没改变，只不过是在原有的 AST
数结构中移除到新的 AST 节点下面了。</p>
</blockquote>
<div id="outline-container-headline-33" class="outline-3">
<h3 id="headline-33">
acdea14 v-if transform init
</h3>
<div id="outline-text-headline-33" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/acdea1419d0361a4566a5f2a53ffc8bb1f941878">feat(init): v-if transform · gcclll/stb-vue-next@acdea14</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">transformIf</span> <span class="o">=</span> <span class="nx">createStructuralDirectiveTransform</span><span class="p">(</span>
  <span class="sr">/^(if|else|else-if)$/</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">processIf</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="p">(</span><span class="nx">ifNode</span><span class="p">,</span> <span class="nx">branch</span><span class="p">,</span> <span class="nx">isRoot</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ifNode</span><span class="p">,</span> <span class="nx">branch</span><span class="p">,</span> <span class="nx">isRoot</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{}</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">)</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">processIf</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">ElementNode</span><span class="p">,</span>
  <span class="nx">dir</span>: <span class="kt">DirectiveNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span><span class="p">,</span>
  <span class="nx">processCodegen</span><span class="o">?:</span> <span class="p">(</span>
    <span class="nx">node</span>: <span class="kt">IfNode</span><span class="p">,</span>
    <span class="nx">branch</span>: <span class="kt">IfBranchNode</span><span class="p">,</span>
    <span class="nx">isRoot</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">|</span> <span class="kc">undefined</span>
<span class="p">)</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
初始化 v-if process 函数， processIf 函数里面会针对 v-if 节点甚至它的兄弟节点做
一系列操作，比如将下一个是 <code>v-else</code> 的兄弟节点删除移到自己的 <code>branches[]</code> 里面。</p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-3">
<h3 id="headline-34">
9039a3e v-if transform processIf
</h3>
<div id="outline-text-headline-34" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9039a3e567260d33c0bc617d4c58639b14b66fec">feat: v-if processIf · gcclll/stb-vue-next@9039a3e</a></p>
<p>
这里增加了两个函数的实现：</p>
<ol>
<li>
<p>processIf, 解析 if，创建 <code>IF,9</code> 类型的结构，替换 v-if 原来的 ast</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">ifNode</span>: <span class="kt">IfNode</span> <span class="o">=</span> <span class="p">{</span>
   <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">IF</span><span class="p">,</span>
   <span class="nx">loc</span>: <span class="kt">node.loc</span><span class="p">,</span>
   <span class="nx">branches</span><span class="o">:</span> <span class="p">[</span><span class="nx">branch</span><span class="p">]</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
其中 branches 保存着所有 v-else, v-else-if 分支节点，这里其实是创建了一个默认
的分支节点，因为 <code>v-if</code> 系列指令在 <code>render</code> 函数中是以三元运算符(<code>?:</code>)形式存
在的，所以 if 后面必须要有一个分支，即 <code>condition ? node1 : node2</code> 中的 node2
必须是个有效的值，才能正常使用 <code>?:</code> 运算符。</p>
<p>
所以，如果只有 <code>v-if</code> 指令的时候三元符后面的值起始是个空值(好像是 <code>null</code>)</p>
</li>
<li>
<p>createIfBranch, 创建 <code>v-if</code> 的分支节点的</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createIfBranch</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">ElementNode</span><span class="p">,</span> <span class="nx">dir</span>: <span class="kt">DirectiveNode</span><span class="p">)</span><span class="o">:</span> <span class="nx">IfBranchNode</span> <span class="p">{</span>
<span class="k">return</span> <span class="p">{</span>
 <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">IF_BRANCH</span><span class="p">,</span>
 <span class="nx">loc</span>: <span class="kt">node.loc</span><span class="p">,</span>
 <span class="c1">// condition ? v-if node : v-else node
</span><span class="c1"></span> <span class="nx">condition</span>: <span class="kt">dir.name</span> <span class="o">===</span> <span class="s1">&#39;else&#39;</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">exp</span><span class="p">,</span>
 <span class="c1">// 如果用的是 &lt;template v-if=&#34;condition&#34; ... 就需要 node.children
</span><span class="c1"></span> <span class="c1">// 因为 template 本身是不该被渲染的
</span><span class="c1"></span> <span class="nx">children</span>:
   <span class="kt">node.tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">findDir</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">)</span>
     <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span>
     <span class="o">:</span> <span class="p">[</span><span class="nx">node</span><span class="p">],</span>
 <span class="c1">// 对于 v-for, v-if/... 都应该给它个 key, 这里是用户编写是的提供的唯一 key
</span><span class="c1"></span> <span class="c1">// 如果没有解析器会默认生成一个全局唯一的 key
</span><span class="c1"></span> <span class="nx">userKey</span>: <span class="kt">findProp</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="sb">`key`</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 注意看最后一个属性， <code>v-if</code> 分支也是需要一个 <code>key</code> 属性的。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-35" class="outline-3">
<h3 id="headline-35">
44985b4 v-if transform createIfBranch
</h3>
<div id="outline-text-headline-35" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/44985b49e031752a7c84464b29adb769050cb1fb">feat: v-if createIfBranch · gcclll/stb-vue-next@44985b4</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createConditionalExpression</span><span class="p">(</span>
  <span class="nx">test</span>: <span class="kt">ConditionalExpression</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
  <span class="nx">consequent</span>: <span class="kt">ConditionalExpression</span><span class="p">[</span><span class="s1">&#39;consequent&#39;</span><span class="p">],</span>
  <span class="nx">alternate</span>: <span class="kt">ConditionalExpression</span><span class="p">[</span><span class="s1">&#39;alternate&#39;</span><span class="p">],</span>
  <span class="nx">newline</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CONDITIONAL_EXPRESSION</span><span class="p">,</span>
    <span class="nx">test</span><span class="p">,</span>
    <span class="nx">consequent</span><span class="p">,</span>
    <span class="nx">alternate</span><span class="p">,</span>
    <span class="nx">newline</span><span class="p">,</span>
    <span class="nx">loc</span>: <span class="kt">locStub</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里的结构(<code>v-if</code>)在 render 函数中的对应关系：</p>
<p>
<code>test ? consequent : alternate</code></p>
<p>
如果有 v-else-if 时候， <code>alternate</code> 结构会是个完整的 <code>JS_CONDITIONAL_EXPRESSION</code>
，即： <code>alternate: { test, consequent, alternate, ...}</code> 所以：</p>
<p>
<code>test ? consequent : test1 ? consequent 1 : alternate</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1e24eb7a30588690a4e83f888623b97f0085e899">fix: no v-if transform · gcclll/stb-vue-next@1e24eb7</a></p>
<p>
到这里 v-if 指令 transform 阶段已经完成，测试结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;ok&#34;/&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; ast.codegenNode 结果`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; ast.codegenNode 结果
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 17, line: 1, offset: 16 },
    source: &#39;&lt;div v-if=&#34;ok&#34;/&gt;&#39;
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: &#39;ok&#39;,
      isStatic: false,
      isConstant: false,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: &#39;&#34;div&#34;&#39;,
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: &#39;&#39;, start: [Object], end: [Object] }
  }
}
undefined
</pre>
<p>
+RESULTS: 错误结果</p>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, { key: 0 }))
  }
}
&gt;&gt;&gt; ast.codegenNode 结果
{
  type: 13,
  tag: &#39;&#34;div&#34;&#39;,
  props: {
    type: 15,
    loc: { source: &#39;&#39;, start: [Object], end: [Object] },
    properties: [ [Object] ]
  },
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 17, line: 1, offset: 16 },
    source: &#39;&lt;div v-if=&#34;ok&#34;/&gt;&#39;
  }
}
undefined
</pre>
<p>
结果显示是不对的，因为创建的 <code>IF</code> 结构没有替换 ast 🌲中原来的节点，追踪后发现是
漏掉了 <code>context.replaceNode(node)</code> 的实现。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/47c30d296b2f42759aea8de4730ae1802dbb6e32">fix: v-if codegenNode is incorrect · gcclll/stb-vue-next@47c30d2</a></p>
<p>
traverseNode 中需要增加 <code>case 9,IF</code> 分支处理，遍历所有的 <code>branches[]</code> 。</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/179f06f716687166b167f5d190073bfe65a9393f">fix: v-if branches no codegenNode · gcclll/stb-vue-next@179f06f</a></p>
</div>
</div>
<div id="outline-container-headline-36" class="outline-3">
<h3 id="headline-36">
742757e v-if generator
</h3>
<div id="outline-text-headline-36" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/742757ebe2c4d1faaadf32b6606d43cef2900934?branch=742757ebe2c4d1faaadf32b6606d43cef2900934&amp;diff=split">feat: v-if generator · gcclll/stb-vue-next@742757e</a></p>
<p>
genNode 增加 <code>JS_CONDITIONAL_EXPRESSION</code> 分支处理(<code>genConditionalExpression</code>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genConditionalExpression</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">ConditionalExpression</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">test</span><span class="p">,</span> <span class="nx">consequent</span><span class="p">,</span> <span class="nx">alternate</span><span class="p">,</span> <span class="nx">newline</span>: <span class="kt">needNewline</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">node</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">indent</span><span class="p">,</span> <span class="nx">deindent</span><span class="p">,</span> <span class="nx">newline</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 非简单的标识符需要用括号，可能是表达式，所以需要 (a + b) ? ... : ...
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">needsParams</span> <span class="o">=</span> <span class="o">!</span><span class="nx">isSimpleIdentifier</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
    <span class="nx">needsParams</span> <span class="o">&amp;&amp;</span> <span class="nx">push</span><span class="p">(</span><span class="sb">`(`</span><span class="p">)</span>
    <span class="nx">genExpression</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="nx">needsParams</span> <span class="o">&amp;&amp;</span> <span class="nx">push</span><span class="p">(</span><span class="sb">`)`</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`(`</span><span class="p">)</span>
    <span class="nx">genNode</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`)`</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">needNewline</span> <span class="o">&amp;&amp;</span> <span class="nx">indent</span><span class="p">()</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">++</span>
  <span class="nx">needNewline</span> <span class="o">||</span> <span class="nx">push</span><span class="p">(</span><span class="sb">` `</span><span class="p">)</span>
  <span class="nx">push</span><span class="p">(</span><span class="sb">`? `</span><span class="p">)</span>
  <span class="nx">genNode</span><span class="p">(</span><span class="nx">consequent</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">--</span>
  <span class="nx">needNewline</span> <span class="o">&amp;&amp;</span> <span class="nx">newline</span><span class="p">()</span>
  <span class="nx">needNewline</span> <span class="o">||</span> <span class="nx">push</span><span class="p">(</span><span class="sb">` `</span><span class="p">)</span>
  <span class="nx">push</span><span class="p">(</span><span class="sb">`: `</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">isNested</span> <span class="o">=</span> <span class="nx">alternate</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CONDITIONAL_EXPRESSION</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNested</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 不是嵌套
</span><span class="c1"></span>    <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">++</span>
  <span class="p">}</span>
  <span class="nx">genNode</span><span class="p">(</span><span class="nx">alternate</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNested</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">--</span>
  <span class="p">}</span>

  <span class="nx">needNewline</span> <span class="o">&amp;&amp;</span> <span class="nx">deindent</span><span class="p">(</span><span class="kc">true</span> <span class="cm">/* without newline */</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>genConditionalExpression</code> 处理分为三个部分</p>
<ol>
<li>
<p><code>test</code> 生成条件表达式，这里是: <code>ok</code> ，如果是表达式需要括号： <code>(a + b)</code></p>
</li>
<li>
<p><code>consequent</code> 用来生成 <code>?</code> 后面的表达式，即 <code>ok</code> 结果为 truth 时执行</p>
</li>
<li>
<p><code>alternate</code> 用来生成 <code>:</code> 后面的表达式，即 <code>ok</code> 结果为 falsy 时执行</p>
<p>
<code>alternate</code> 中的结构可能也是个 <code>JS_CONDITIONAL_EXPRESSION</code> 结构，代表可能有
<code>v-else-if</code> 分支，如： <code>(a + b) ? node1 : (c + d) ? node2 : othernode</code> 。</p>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">tpl</span><span class="p">,</span> <span class="nx">desc</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; `</span> <span class="o">+</span> <span class="nx">desc</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">tpl</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;ok&#34;/&gt;`</span><span class="p">,</span> <span class="s1">&#39;basic v-if&#39;</span><span class="p">)</span>
<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;template v-if=&#34;ok&#34;&gt;&lt;div/&gt;hello&lt;p/&gt;&lt;/template&gt;`</span><span class="p">,</span> <span class="s1">&#39;template v-if&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic v-if
const _Vue = Vue
const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue

const _hoisted_1 = { key: 0 }

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return ok
      ? (_openBlock(), _createBlock(&#34;div&#34;, _hoisted_1))
      : _createCommentVNode(&#34;v-if&#34;, true)
  }
}
&gt;&gt;&gt; template v-if
const _Vue = Vue
const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createTextVNode(&#34;hello&#34;)
const _hoisted_3 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, createTextVNode : _createTextVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return ok
      ? (_openBlock(), _createBlock(_Fragment, { key: 0 }, [
          _hoisted_1,
          _hoisted_2,
          _hoisted_3
        ], 64 /* STABLE_FRAGMENT */))
      : _createCommentVNode(&#34;v-if&#34;, true)
  }
}
undefined
</pre>
<p>
BUG: 这里居然少了个 <code>_hoisted_2</code> ???</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">[</span>
  <span class="mi">_</span><span class="nx">hoisted_1</span><span class="p">,</span>
  <span class="p">,</span>
  <span class="mi">_</span><span class="nx">hoisted_3</span>
<span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
答： <code>genNode()</code> 中缺少对 <code>4,TEXT_CALL</code> 纯文本类型处理。</p>
<p>
解：<a href="https://github.com/gcclll/stb-vue-next/commit/2372b5fb793da98a8330aa843137e852d5c375c1">fix: v-if TEXT_CALL gen node · gcclll/stb-vue-next@2372b5f</a></p>
<div class="comment-block">
<p>更多测试用例(<code>&lt;f12&gt;</code>)打开控制台查看 -&gt;&gt; 。</p>
</div>
<script>
l1(`v-if 指令`)
compile(`<div v-if="ok"/>`, 'basic v-if')
compile(`<template v-if="ok"><div/>hello<p/></template>`, 'template v-if')
compile(`<Component v-if="ok"></Component>`, 'component v-if')
</script>
</div>
</div>
<div id="outline-container-headline-37" class="outline-3">
<h3 id="headline-37">
fa77b51 v-else/v-else-if
</h3>
<div id="outline-text-headline-37" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fa77b5146f3a3af6c8372012cb6a4d8482adb0c6">feat(add): v-else · gcclll/stb-vue-next@fa77b51</a></p>
<p>
修改点：</p>
<ol>
<li>
<p><code>processCodegen()</code> 函数里面增加分支处理</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201209164845.png" alt="http://qiniu.ii6g.com/img/20201209164845.png" title="http://qiniu.ii6g.com/img/20201209164845.png" /> 
 这里有一个需要注意的点: <code>getParentCondition()</code> 会一直查找
<code>JS_CONDITIONAL_EXPRESSION</code> 类型节点的 <code>alternate</code> ，如果它依旧是个
<code>JS_CONDITIONAL_EXPRESSION</code> 类型，说明是多级的 <code>if/else</code> 条件语句，直到找到最
后一个不是为止。</p>
<p>
相当于 ： <code>c1 ? cons1 : c2 ? cons2 : c3 ? cons3 : alt</code> 会一直从 <code>c1</code> 节点开始
查找直到找到最后的那个 <code>alt</code> 节点为止，然后将新的分支挂到 <code>alt</code> 后面组织成新
的分支:  <code>c1 ? cons1 : c2 ? cons2 : c3 ? cons3 : c4 ? cons4 : newalt</code></p>
<div class="comment-block">
<p>PS: c1, c2, c3, c4 分别代表分支节点的 <code>test</code> ，最后追加的 <code>c4 ? cons4 :
 newalt</code> 三个对象都属于新加的节点， <code>{test -&gt; c4, cons4 -&gt; consequent,
 alternate -&gt; newalt }</code></p>
</div>
</li>
<li>
<p><code>processIf()</code> 里增加分支处理</p>
<p>
新增代码里有个 <code>while</code> 循环去从当前的分支节点开始在它的兄弟节点里面往回找，直
到找到第一个 <code>9,IF</code> 节点，这中间不允许出现其他有效节点(除注释，空文本节点外)，
因为 <code>v-if/else</code> 指令节点必须紧靠着。</p>
<p>
找到之后，要将当前分支节点删除，并且同时要去手动 <code>traverseNode(branch)</code> 一次，
因为他在原来的 ast 树种删除了，所以原来的 traverse 进程不会遍历它，因此需要手
动执行 traverse 去处理它及其孩子节点生成对应的 codegenNode 。</p>
<p>
然后将其 push 到 <code>9,IF</code> 节点的 <code>node.branches</code> 里面作为分支。</p>
</li>
<li>
<p><code>isSameKey(a,b)</code> 新增，检测两个 key 属性是不是相同</p>
<p>
几种判定为不相同的条件：</p>
<ol>
<li>
<p>key 类型不同 (<code>a.type !== b.type</code>)</p>
</li>
<li>
<p>key 值不同 (<code>a.value.content !== b.value.content</code>)</p>
</li>
<li>
<p>key 如果是指令类型，检测表达式类型，静态属性异同(<code>isStatic</code>)</p>
</li>
</ol>
</li>
<li>
<p><code>getParentCondition()</code> 新增，递归 <code>9，IF</code> 节点的
<code>node.alternate.alternate.alternate...</code> 直到找到 <code>alternate</code> 不是
<code>JS_CONDITIONAL_EXPRESSION</code> 的情况</p>
</li>
</ol>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/464d6815adf49596065440001e0bc5397ad2aa69">fix: v-else current node dont removed · gcclll/stb-vue-next@464d681</a></p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;ok&#34;/&gt;&lt;p v-else/&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return ok
      ? (_openBlock(), _createBlock(&#34;div&#34;, { key: 0 }))
      : (_openBlock(), _createBlock(&#34;p&#34;, { key: 1 }))
  }
}
undefined
</pre>
<div class="comment-block">
<p>更多测试(<code>&lt;f12&gt;</code>)打开控制台查看 -&gt;&gt; 。</p>
</div>
<script>
compile(`<div v-if="ok"/><p v-else/>`, 'v-if + v-else')
compile(`<template v-if="ok"><div/>hello<p/></template>`, 'template v-if')
compile(`<div v-if="ok"/><p v-else-if="orNot"/>`, 'v-if + v-else-if')
compile(`<div v-if="ok"/><p v-else-if="orNot"/><template v-else>fine</template>`, 'v-if + v-else-if + v-else')
compile(`
        <div v-if="ok"/>
        <!--foo-->
        <p v-else-if="orNot"/>
        <!--bar-->
        <template v-else>fine</template>
      `, 'comment between branches')

l1(`with prefixIdentifiers ... TODO`)
l1(`errors`)
compile(`<div v-else/>`, `<div v-else/> 没有匹配的 v-if`)
compile(`<div v-else-if="foo"/>`, `<div v-else-if="foo"/>, 没有匹配的 v-if`)
compile(`<div v-if="ok" :key="a + 1" /><div v-else :key="a + 1" />`,
`<div v-if="ok" :key="a + 1" /><div v-else :key="a + 1" />, 相同的 key`
)
log.red(`不允许不同分支使用相似的 key，因为 key 是指令属性，因此会对比它的类型及表达式`)
l1(`v-on with v-if`)
compile(`<button v-on="{ click: clickEvent }" v-if="true">w/ v-if</button>`, 'v-if 上使用 v-on 指令')
log.blue(`因为这里用的是无参数的 v-on 所以会导致所有属性被合并(_mergeProps(...))。`)
</script>
<p>
BUG: v-else-if 被解析成了 <code>else</code> 因为 parser 阶段匹配正则不对。
<a href="https://github.com/gcclll/stb-vue-next/commit/5b83d1c12a8580638d7952e712f7c6776a099a50">fix: parser v-else-if failed · gcclll/stb-vue-next@5b83d1c</a></p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-38" class="outline-2">
<h2 id="headline-38">
6c82066 add v-for transform
</h2>
<div id="outline-text-headline-38" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3a1662ecde9600525088a48420e526b6f9820931">feat(init): v-for · gcclll/stb-vue-next@3a1662e</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6c8206676c5d5229c853fb21cb91aad1a9f1d4a2">feat: v-for directive · gcclll/stb-vue-next@6c82066</a></p>
<p>
v-for 指令实现过程中需要用到的几个函数：</p>
<ul>
<li>
<p><code>transformFor()</code> 最终生成的 tranformXxx 函数</p>
</li>
<li>
<p><code>createStructuralDirectiveTransform()</code> 同 <code>v-if</code> 指令</p>
</li>
<li>
<p><code>processFor()</code> 处理 <code>v-for</code> 指令入口</p>
</li>
<li>
<p><code>processCodegen()</code> 同 <code>v-if</code> 用来生成 <code>codegenNode</code> 的函数</p>
</li>
<li>
<p><code>parseForExpression()</code> 将 <code>v-for=&#34;item in items&#34;</code> 表达式解析成
<code>ForParseResult{source, value, key, index}</code> 类型 AST 。</p>
</li>
<li>
<p><code>createAliasExpression()</code> 给 <code>value, key, index</code> 创建 <code>SIMPLE_EXPRESSION</code> 类型
结构。</p>
</li>
<li>
<p><code>createForLoopParams()</code> 创建 <code>_renderList</code> 函数回调的参数 <code>[value, key,
index]</code> ，如果没有使用默认变量： <code>_</code> 或 <code>__</code> ，如： <code>(_, __, index)</code></p>
</li>
</ul>
<p>
其中 <code>parseForExpression()</code> 函数是解析 <code>v-for</code> 表达式的核心函数，里面使用了三个
正则，用来匹配指令表达式：</p>
<ol>
<li>
<p><code>const forAliasRE = /([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201210155617.png" alt="http://qiniu.ii6g.com/img/20201210155617.png" title="http://qiniu.ii6g.com/img/20201210155617.png" /></p>
<p>
匹配 <code>v-for=&#34;item in items&#34;</code> 中的值部分</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="sb">`</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">p</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="sb">`\n`</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>

<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 匹配 item in items`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;item in items&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 匹配 (item, key) in items`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;( item, key ) in items&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 匹配 item in items
0, item in items
1, item
2, items
&gt;&gt;&gt; 匹配 (item, key) in items
0, ( item, key ) in items
1, ( item, key )
2, items
undefined
</pre>
</li>
<li>
<p><code>const forIteratorRE = /,([^,\}\]]*)(?:,([^,\}\]]*))?$/</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201210161642.png" alt="http://qiniu.ii6g.com/img/20201210161642.png" title="http://qiniu.ii6g.com/img/20201210161642.png" /></p>
<p>
这个正则表达式用来匹配 <code>(item, key) in items</code> 中的 <code>item</code> 和 <code>key</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/,([^,\}\]]*)(?:,([^,\}\]]*))?$/</span> 
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="sb">`</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">p</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="sb">`\n`</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>

<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 匹配 &#39;item, key, index&#39; 中的 key 和 index`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;item, key, index&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 匹配 &#34;item, key&#34; 中的 key`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;item, key&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 匹配 &#39;item, key, index&#39; 中的 key 和 index
0, , key, index
1,  key
2,  index
&gt;&gt;&gt; 匹配 &#34;item, key&#34; 中的 key
0, , key
1,  key
2, undefined
undefined
</pre>
</li>
<li>
<p><code>const stripParensRE = /^\(|\)$/g</code> 这个用来匹配 <code>(item, key, index)</code> 前后括号</p>
</li>
</ol>
<p>
<code>parseForExpression()</code> 核心实现：</p>
<ol>
<li>
<p><code>source</code> 数据源， <code>forAliasRE</code> 匹配后的 <code>RHS</code> 值</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">source:</span> <span class="p">{</span>
 <span class="err">type:</span> <span class="err">4,</span> <span class="err">//</span> <span class="err">SIMPLE_EXPRESSION</span>
 <span class="err">loc:</span> <span class="err">{</span> <span class="err">source:</span> <span class="err">&#39;obj&#39;,</span> <span class="err">start:</span> <span class="err">[Object],</span> <span class="err">end:</span> <span class="err">[Object]</span> <span class="p">}</span><span class="err">,</span>
 <span class="err">isConstant:</span> <span class="kc">false</span><span class="err">,</span>
 <span class="err">content:</span> <span class="err">&#39;obj&#39;,</span>
 <span class="err">isStatic:</span> <span class="kc">false</span>
<span class="err">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>value</code> 的取值，在 AST 中对应 <code>valueAlias</code></p>
<p>
<code>valueContent = valueContent.replace(forIteratorRE,
&#39;&#39;).trim()</code></p>
<p>
通过匹配 <code>key, index</code> 的正则，反向替换得到 <code>value</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/,([^,\}\]]*)(?:,([^,\}\]]*))?$/</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`item, key, index`</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">())</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 支持解构`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[ id, value ], key, index`</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">())</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
item
&gt;&gt;&gt; 支持解构
[ id, value ]
undefined
</pre>
<p>
 解析后的结构：</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">valueAlias:</span> <span class="p">{</span>
    <span class="err">type:</span> <span class="err">4,</span> <span class="err">//</span> <span class="err">SIMPLE_EXPRESSION</span>
    <span class="err">loc:</span> <span class="err">{</span> <span class="err">source:</span> <span class="err">&#39;value&#39;,</span> <span class="err">start:</span> <span class="err">[Object],</span> <span class="err">end:</span> <span class="err">[Object]</span> <span class="p">}</span><span class="err">,</span>
    <span class="err">isConstant:</span> <span class="kc">false</span><span class="err">,</span>
    <span class="err">content:</span> <span class="err">&#39;value&#39;,</span>
    <span class="err">isStatic:</span> <span class="kc">false</span>
<span class="err">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>key</code> 取值处理，在 AST 中对应 <code>keyAlias</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="nx">keyAlias</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">type</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
     <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="nx">end</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">},</span>
     <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span>
     <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>index</code> 取值处理，在 AST中对应 <code>objectIndexAlias</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="nx">objectIndexAlias</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">type</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
     <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="nx">end</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">},</span>
     <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
     <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;span v-for=&#34;(value, key, index) in obj&#34; /&gt;`</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">valueAlias</span><span class="p">,</span> <span class="nx">keyAlias</span><span class="p">,</span> <span class="nx">objectIndexAlias</span><span class="p">,</span> <span class="nx">type</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`type: </span><span class="si">${</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 数据源`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; value`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">valueAlias</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; key`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">keyAlias</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; index`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">objectIndexAlias</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; _renderList(obj, (value, key, index) =&gt; {...}) 第二个参数`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
type: 11
&gt;&gt;&gt; 数据源
{
  type: 4,
  loc: {
    source: &#39;obj&#39;,
    start: { column: 37, line: 1, offset: 36 },
    end: { column: 40, line: 1, offset: 39 }
  },
  isConstant: false,
  content: &#39;obj&#39;,
  isStatic: false
}
&gt;&gt;&gt; value
{
  type: 4,
  loc: {
    source: &#39;value&#39;,
    start: { column: 15, line: 1, offset: 14 },
    end: { column: 20, line: 1, offset: 19 }
  },
  isConstant: false,
  content: &#39;value&#39;,
  isStatic: false
}
&gt;&gt;&gt; key
{
  type: 4,
  loc: {
    source: &#39;key&#39;,
    start: { column: 22, line: 1, offset: 21 },
    end: { column: 25, line: 1, offset: 24 }
  },
  isConstant: false,
  content: &#39;key&#39;,
  isStatic: false
}
&gt;&gt;&gt; index
{
  type: 4,
  loc: {
    source: &#39;index&#39;,
    start: { column: 27, line: 1, offset: 26 },
    end: { column: 32, line: 1, offset: 31 }
  },
  isConstant: false,
  content: &#39;index&#39;,
  isStatic: false
}
&gt;&gt;&gt; _renderList(obj, (value, key, index) =&gt; {...}) 第二个参数
{
  type: 18, // JS_FUNCTION_EXPRESSION
  params: [
    {
      type: 4,
      loc: [Object],
      isConstant: false,
      content: &#39;value&#39;,
      isStatic: false
    },
    {
      type: 4,
      loc: [Object],
      isConstant: false,
      content: &#39;key&#39;,
      isStatic: false
    },
    {
      type: 4,
      loc: [Object],
      isConstant: false,
      content: &#39;index&#39;,
      isStatic: false
    }
  ],
  returns: {
    type: 13,
    tag: &#39;&#34;span&#34;&#39;,
    props: undefined,
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    loc: {
      start: [Object],
      end: [Object],
      source: &#39;&lt;span v-for=&#34;(value, key, index) in obj&#34; /&gt;&#39;
    }
  },
  newline: true,
  isSlot: false,
  loc: {
    source: &#39;&#39;,
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  }
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-39" class="outline-2">
<h2 id="headline-39">
39a20fe add v-for generator
</h2>
<div id="outline-text-headline-39" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/39a20fef0001cf22de6632f96df474c87a127a9d">feat(add): v-for generator · gcclll/stb-vue-next@39a20fe</a></p>
<p>
codegen 阶段新增对应的实现： <code>18,JS_FUNCTION_EXPRESSION</code></p>
<p>
这个主要是用来解析 <code>_renderList(source, (value, key, index) =&gt; { ... })</code> 函数的
第二个参数的，这是个用来 render 列表项的函数。</p>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="s1">&#39;&lt;span v-for=&#34;(item) in items&#34; /&gt;&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { renderList : _renderList, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock, createVNode : _createVNode } = _Vue

    return (_openBlock(true), _createBlock(_Fragment, null, _renderList(items, (item) =&gt; {
      return (_openBlock(), _createBlock(&#34;span&#34;))
    )), 256 /* UNKEYED_FRAGMENT */))
  }
}
undefined
</pre>
<blockquote>
<p>更多测试用例请 <code>&lt;f12&gt;</code> 打开控制台查看。</p>
</blockquote>
<script>
l1(`v-for directive`)
compile(`<span v-for="(item) in items" />`, `basic v-for`)
compile('<span v-for="(item, key, index) in items" />', 'value + key + index')
compile('<span v-for="(, key, index) in items" />', `skipped value`)
compile('<span v-for="(item,,index) in items" />', `skipped key`)
compile('<span v-for="(,,index) in items" />', `skipped value & key`)
compile('<p v-for="item in 10">{{item}}</p>', `v-for with constant expression`)
compile(`<template v-for="item in items">hello<span/></template>`, `template v-for`)
compile('<template v-for="item in items"><slot/></template>', `template v-for w/ <slot/>`)
log.red(`TODO <slot> 待完成......`)
compile('<template v-for="item in items" :key="item.id"><span :id="item.id" /></template>', `template v-for key injection with single child`)
compile('<slot v-for="item in items"></slot>', `v-for on <slot/>`)
log.red(`TODO <slot> 待完成......`)
compile('<span v-for="(item) in items" :key="item" />', `keyed v-for`)
compile('<template v-for="item in items" :key="item">hello<span/></template>', `keyed template v-for`)
compile(`<div v-if="ok" v-for="i in list"/>`, `v-if + v-for`)
compile(`<template v-if="ok" v-for="i in list"/>`, 'v-if + v-for on <template>')
compile('<div v-for="i in list" v-foo/>', `v-for on element with custom directive`)

</script>
</div>
</div>
<div id="outline-container-headline-40" class="outline-2">
<h2 id="headline-40">
7cb8908 add slot outlet transform
</h2>
<div id="outline-text-headline-40" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7cb8908700da1bf0c3888a2fcd6857263d09aedd">feat(add): v-slot transform · gcclll/stb-vue-next@7cb8908</a></p>
<p>
transform <code>&lt;slot /&gt;</code> 标签。</p>
<p>
<code>&lt;slot/&gt;</code> 在 render 函数中是以 <code>_renderSlot($slot, name, props, children)</code> 形式存在。</p>
<div class="comment-block">
<p>&lt;slot&gt; 上不允许自定义的指令存在？</p>
</div>
<p>
相关函数/参数：</p>
<ol>
<li>
<p><code>transformSlotOutlet()</code> 该阶段的 <code>tranformXxx</code> 函数</p>
</li>
<li>
<p><code>SlotOutletProcessResult</code> 类型定义 <code>{slotName, slotProps}</code></p>
</li>
<li>
<p><code>processSlotOutlet()</code>, <code>&lt;slot/&gt;</code> 的处理过程</p>
<p>
首先是解析插槽名称(<code>name</code> 属性)，该属性可以是动态(<code>&lt;slot :name=&#34;myslot&#34;/&gt;</code>)也
可以是静态的(<code>&lt;slot name=&#34;myslot&#34;/&gt;</code>)。</p>
<p>
然后解析出插槽上定义的一些属性(静态)，除了 <code>:name</code> 之外插槽上 <strong>不允许有其他的
指令类型的属性存在</strong> 。</p>
</li>
<li>
<p><code>children</code> 参数</p>
<p>
<code>&lt;slot&gt;&lt;div/&gt;&lt;p/&gt;&lt;/slot&gt;</code></p>
<p>
在 <code>&lt;slot&gt;</code> 标签内的所有元素(<code>&lt;div/&gt;&lt;p/&gt;</code>)会被解析成 <code>_renderSlot</code> 的第四个参数。</p>
</li>
</ol>
<p>测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;slot/&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 1,
  ns: 0,
  tag: &#39;slot&#39;,
  tagType: 2,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: &#39;&lt;slot/&gt;&#39;
  },
  codegenNode: {
    type: 14, // JS_CALL_EXPRESSION
    loc: { start: [Object], end: [Object], source: &#39;&lt;slot/&gt;&#39; },
    callee: Symbol(renderSlot),
    arguments: [ &#39;$slots&#39;, &#39;&#34;default&#34;&#39; ]
  }
}
undefined
</pre>
<blockquote>
<p>更多 codegenNode 结果请 <code>&lt;f12&gt;</code> 打开控制台查看。</p>
</blockquote>
<script>
l1(`<slot/> 插槽 transform 阶段`)

const _a = ast => [`_renderSlot 参数列表：` , ast.children[0].codegenNode.arguments ]
const c1 = (tpl, desc, ast = _a) => compile.call(null, tpl, desc, ast)
c1(`<slot/>`, `default slot outlet`)
c1(`<slot name="foo" />`, `statically named slot outlet，含静态名字`)
c1(`<slot :name="foo" />`, `dynamically named slot outlet, 含动态名字`)
c1(`<div/>`, `TODO dynamically named slot outlet w/ prefixIdentifiers: true`)
c1(`<slot foo="bar" :baz="qux" />`, `default slot outlet with props，默认插槽+静动态属性`)
c1(`<slot name="foo" foo="bar" :baz="qux" />`, `statically named slot outlet with props，静态具名插槽+其他静动态属性`)
c1(`<slot :name="foo" foo="bar" :baz="qux" />`, `dynamically named slot outlet with props，动态具名插槽+其他静动态属性`)
c1(`<slot><div/></slot>`, `default slot outlet with fallback`)
c1(`<slot name="foo"><div/></slot>`, `named slot outlet with fallback`)
c1(`<slot :foo="bar"><div/></slot>`, `default slot outlet with props & fallback`)
c1(`<slot name="foo" :foo="bar"><div/></slot>`, `named slot outlet with props & fallback`)
c1(`<slot v-foo />`, `error on unexpected custom directive on <slot>，不允许有自定义指令？`)
</script>
<div id="outline-container-headline-41" class="outline-3">
<h3 id="headline-41">
ebdb1ed add track slot scopes
</h3>
<div id="outline-text-headline-41" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ebdb1edbfd23312d5fb079a3955917745cac2622">feat: add track slot scopes · gcclll/stb-vue-next@ebdb1ed</a></p>
<p>
还不知道干吗的❓ </p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// A NodeTransform that:
</span><span class="c1">// 1. Tracks scope identifiers for scoped slots so that they don&#39;t get prefixed
</span><span class="c1">//    by transformExpression. This is only applied in non-browser builds with
</span><span class="c1">//    { prefixIdentifiers: true }.
</span><span class="c1">// 2. Track v-slot depths so that we know a slot is inside another slot.
</span><span class="c1">//    Note the exit callback is executed before buildSlots() on the same node,
</span><span class="c1">//    so only nested slots see positive numbers.
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">trackSlotScopes</span>: <span class="kt">NodeTransform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// &lt;component&gt; or &lt;template&gt;
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span> <span class="o">||</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span><span class="p">)</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We are only checking non-empty v-slot here
</span><span class="c1"></span>    <span class="c1">// since we only care about slots that introduce scope variables.
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">vSlot</span> <span class="o">=</span> <span class="nx">findDir</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;slot&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">vSlot</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">slotProps</span> <span class="o">=</span> <span class="nx">vSlot</span><span class="p">.</span><span class="nx">exp</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">prefixIdentifiers</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">slotProps</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">addIdentifiers</span><span class="p">(</span><span class="nx">slotProps</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="nx">context</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">vSlot</span><span class="o">++</span>
      <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">prefixIdentifiers</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">slotProps</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">removeIdentifiers</span><span class="p">(</span><span class="nx">slotProps</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">vSlot</span><span class="o">--</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-v-slot" class="outline-2">
<h2 id="v-slot">
36c1f36 (v-slot)build user component as slots
</h2>
<div id="outline-text-v-slot" class="outline-text-2">
<p>
组件是如何当做 slot 处理的</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/36c1f36ea2a92119d2a61f3012972229e85b1e30">feat(add): user component treat as slot to build · gcclll/stb-vue-next@36c1f36</a></p>
<p>
完整用户组件当 slot 处理流程图：
<img src="/img/vue3/compiler-core/pcg/pcg-v-slot.svg" alt="/img/vue3/compiler-core/pcg/pcg-v-slot.svg" title="/img/vue3/compiler-core/pcg/pcg-v-slot.svg" /></p>
<p>
<code>&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;</code></p>
<p>
这里 <code>Comp</code> 是组件类型(<code>tagType=1,COMPONENT</code>) 会在 <code>transformElement</code> 中被当做
<code>slot</code> 来处理调用 <code>buildSlots()</code> 。</p>
<div class="comment-block">
<p>更多测试用例(<code>&lt;f12&gt;</code>)打开控制台查看 -&gt;&gt; 。</p>
</div>
<script>
l1(`<slot /> 插槽 generator 阶段`)
compile(`<Comp><div/></Comp>`, 'implicit default slot')
compile(`<Comp v-slot="{ foo }">{{ foo }}{{ bar }}</Comp>`, 'on-component default slot')
compile(`<Comp v-slot:named="{ foo }">{{ foo }}{{ bar }}</Comp>`, 'on component named slot')
compile(`<Comp>
        <template v-slot:one="{ foo }">
          {{ foo }}{{ bar }}
        </template>
        <template #two="{ bar }">
          {{ foo }}{{ bar }}
        </template>
      </Comp>`, 'template named slots')
compile(`<Comp v-slot:[named]="{ foo }">{{ foo }}{{ bar }}</Comp>`, 'on component dynamically named slot')
compile(`<Comp>
        <template #one>foo</template>bar<span/>
      </Comp>`, 'named slots w/ implicit default slot')
compile(`<Comp>
        <template v-slot:[one]="{ foo }">
          {{ foo }}{{ bar }}
        </template>
        <template #[two]="{ bar }">
          {{ foo }}{{ bar }}
        </template>
      </Comp>`, 'dynamically named slots')
compile(`<Comp>
        <template #default="{ foo }">
          <Inner v-slot="{ bar }">
            {{ foo }}{{ bar }}{{ baz }}
          </Inner>
          {{ foo }}{{ bar }}{{ baz }}
        </template>
      </Comp>`, 'nested slots scoping')

compile(`<div v-for="i in list">
        <Comp v-slot="bar">foo</Comp>
      </div>`, 'should force dynamic when inside v-for')
l2(` TODO should only force dynamic slots when actually using scope vars w/ prefixIdentifiers: true`)
compile(`<Comp>
        <template #one v-if="ok">hello</template>
      </Comp>`, 'named slot with v-if')
l2(` TODO named slot with v-if + prefixIdentifiers: true`)
compile(`<Comp>
        <template #one v-if="ok">foo</template>
        <template #two="props" v-else-if="orNot">bar</template>
        <template #one v-else>baz</template>
      </Comp>`, 'named slot with v-if + v-else-if + v-else')
l2(` TODO 'named slot with v-for w/ prefixIdentifiers: true'`)
compile(`<Comp>
        <template v-for="name in list" #[name]>{{ name }}</template>
      </Comp>`, 'named slot with v-for')
compile(`<Comp><template v-slot:named="slotProps"><div/></template><div :id="defaultSlotId"/></Comp>`, '具名插槽+其他非 template 元素全当做默认插槽处理')
</script>
<div id="outline-container-headline-43" class="outline-3">
<h3 id="headline-43">
fbed5cf add component with default slot without &lt;template&gt; transform
</h3>
<div id="outline-text-headline-43" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fbed5cf508e91ea20195af4dafa491957a4d1d60">feat(add): default slot without template · gcclll/stb-vue-next@fbed5cf</a></p>
<p>
<code>&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;</code></p>
<p>
这种情况，用户组件上既没有 <code>v-slot</code> 孩子节点里面也没有 <code>&lt;template v-slot&gt;</code> 最后
的处理是 <code>&lt;Comp&gt;&lt;/Comp&gt;</code> 里面的所有 children 被当做默认插槽处理。</p>
<p>
该示例符合：</p>
<ol>
<li>
<p>组件上没有 <code>v-slot</code> 指令</p>
</li>
<li>
<p>孩子节点里面没有 <code>&lt;template v-slot:name=&#34;slotProps&#34;&gt;</code></p>
</li>
</ol>
<p>因此，这里的处理是将 <code>&lt;div/&gt;</code> 即 <code>comp.children</code> 全部作为默认的 <code>slot:default</code>
来处理。</p>
<p>
处理流程： <code>&lt;Comp&gt;</code> -&gt; <code>transformElement</code> -&gt; <code>isComponent</code> -&gt; <code>buildSlots()</code> -&gt;
<code>{slots, hasDynamicSlots}</code> -&gt; <code>vnodeChildren</code> -&gt; <code>{type: 13,VNODE_CALL,
children: vnodeChildren, ... }</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 13,
  tag: &#39;_component_Comp&#39;,
  props: undefined,
  children: {
    type: 15,
    loc: { start: [Object], end: [Object], source: &#39;&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;&#39; },
    properties: [ [Object], [Object] ]
  },
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 20, line: 1, offset: 19 },
    source: &#39;&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;&#39;
  }
}
undefined
</pre>
<p>
另外在 <code>transformElement()</code> 函数中通过 <code>isComponent = node.tagType ===
ElementTypes.COMPONENT</code> 检测是不是用户组件，如果是继续解析该组件类型(<code>resolveComponentType()</code>)。</p>
<p>
这里最终得到的结果是： <code>vnodeTag = _component_Comp</code> 作为标签名，也是该 <code>&lt;Comp/&gt;</code>
组件在 Vue 实例过程中的存在的标签名(组件名称)。</p>
</div>
</div>
<div id="outline-container-headline-44" class="outline-3">
<h3 id="headline-44">
8bed175 add component with default slot without &lt;template&gt; generator
</h3>
<div id="outline-text-headline-44" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/8bed17574988042023be8ac420254918232ef7c4">feat(add): user component resolver generator · gcclll/stb-vue-next@8bed175</a></p>
<p>
因为在 transform 阶段 transformElement 过程中，检测到 <code>&lt;Comp&gt;</code> 是个用户组件，所
以将其增加到了 <code>context.components.add(&#39;Comp&#39;)</code> 中了，在 generator 阶段会去检测
这个 <code>components</code> 用来解析组件得到组件的引用：</p>
<p>
<code>_component_Comp = _resolveComponent(&#34;Comp&#34;)</code></p>
<p>
新增的代码主要由两部分：</p>
<ol>
<li>
<p>新增 <code>genAssets()</code> 函数处理 <code>context.components</code></p>
<p>
处理之后的结果就是增加 <code>_component_Comp = _resolveComponent(&#34;Comp&#34;)</code></p>
</li>
<li>
<p>在 <code>generate()</code> 中增加 <code>ast.components</code> 检测，如果有内容调用 <code>genAssets()</code> 解
析</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// generate() 中增加
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">components</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">genAssets</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">components</span><span class="p">,</span> <span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">directives</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">temps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newline</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="c1">// 新增
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">genAssets</span><span class="p">(</span>
  <span class="nx">assets</span>: <span class="kt">string</span><span class="p">[],</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;component&#39;</span> <span class="o">|</span> <span class="s1">&#39;directive&#39;</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">newline</span> <span class="p">}</span><span class="o">:</span> <span class="nx">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">resolver</span> <span class="o">=</span> <span class="nx">helper</span><span class="p">(</span>
    <span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;component&#39;</span> <span class="o">?</span> <span class="nx">RESOLVE_COMPONENT</span> : <span class="kt">RESOLVE_DIRECTIVE</span>
  <span class="p">)</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">assets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">assets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="nx">push</span><span class="p">(</span>
      <span class="sb">`const </span><span class="si">${</span><span class="nx">toValidAssetId</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kr">type</span><span class="p">)</span><span class="si">}</span><span class="sb"> = </span><span class="si">${</span><span class="nx">resolver</span><span class="si">}</span><span class="sb">(</span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="si">}</span><span class="sb">)`</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">assets</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newline</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    const _component_Comp = _resolveComponent(&#34;Comp&#34;)

    return (_openBlock(), _createBlock(_component_Comp, null, {
      default: _withCtx(() =&gt; [
        _hoisted_1
      ]),
      _: 1
    }))
  }
}
undefined
</pre>
<p>
缺少 <code>1 /* STABLE */</code> 注释: <a href="https://github.com/gcclll/stb-vue-next/commit/08a6fcaab9224552dbd7876930d964e6bcc534d9">fix: slot flag text · gcclll/stb-vue-next@08a6fca</a></p>
<p>
注意 <code>_createBlock()</code> 的第三个参数变成了一个对象(<code>children</code>) 对象里面包含了两个
属性: <code>default</code> 和 <code>_</code> 分别代表了默认插槽下的孩子节点，和该插槽标识(<code>1-STABLE,2-FORWARDED,3-DYNAMIC</code>)</p>
</div>
</div>
<div id="outline-container-headline-45" class="outline-3">
<h3 id="headline-45">
9f58154 fix: 文本节点没有合并(<code>transformText</code>)
</h3>
<div id="outline-text-headline-45" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9f58154809447e6b718e1579149165fc848e8185">fix: adjacent text node need merge · gcclll/stb-vue-next@9f58154</a></p>
<p>
对于 <code>`&lt;Comp v-slot=&#34;{ foo }&#34;&gt;{{ foo }}{{ bar }}&lt;/Comp&gt;`</code> 用例得到的结果非预期。</p>
<p>
vue-next 正确结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/vue/vue.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp v-slot=&#34;{ foo }&#34;&gt;{{ foo }}{{ bar }}&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">returns</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">returns</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 解析后的 {{ foo }} {{ bar }} 应该合并`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 下面正是合并之后的两个插值`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
You are running a development build of Vue.
Make sure to use the production build (*.prod.js) when deploying for production.
[
  {
    type: 12,
    content: { type: 8, loc: [Object], children: [Array] },
    loc: { start: [Object], end: [Object], source: &#39;{{ foo }}&#39; },
    codegenNode: {
      type: 14,
      loc: [Object],
      callee: Symbol(createTextVNode),
      arguments: [Array]
    }
  }
]
&gt;&gt;&gt; 解析后的 {{ foo }} {{ bar }} 应该合并
{
  type: 8,
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 33, line: 1, offset: 32 },
    source: &#39;{{ foo }}&#39;
  },
  children: [
    { type: 5, content: [Object], loc: [Object] },
    &#39; + &#39;,
    { type: 5, content: [Object], loc: [Object] }
  ]
}
&gt;&gt;&gt; 下面正是合并之后的两个插值
[
  {
    type: 5,
    content: {
      type: 4,
      isStatic: false,
      constType: 0,
      content: &#39;foo&#39;,
      loc: [Object]
    },
    loc: { start: [Object], end: [Object], source: &#39;{{ foo }}&#39; }
  },
  &#39; + &#39;,
  {
    type: 5,
    content: {
      type: 4,
      isStatic: false,
      constType: 0,
      content: &#39;bar&#39;,
      loc: [Object]
    },
    loc: { start: [Object], end: [Object], source: &#39;{{ bar }}&#39; }
  }
]
undefined
</pre>
<p>
看下现阶段 stb-vue-next 输出结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp v-slot=&#34;{ foo }&#34;&gt;{{ foo }}{{ bar }}&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">returns</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">returns</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    isConstant: false,
    content: &#39;foo&#39;,
    loc: { start: [Object], end: [Object], source: &#39;foo&#39; }
  },
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 33, line: 1, offset: 32 },
    source: &#39;{{ foo }}&#39;
  }
}
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    isConstant: false,
    content: &#39;bar&#39;,
    loc: { start: [Object], end: [Object], source: &#39;bar&#39; }
  },
  loc: {
    start: { column: 33, line: 1, offset: 32 },
    end: { column: 42, line: 1, offset: 41 },
    source: &#39;{{ bar }}&#39;
  }
}
undefined
</pre>
<p>
stb-vue-next 明显 returns 里面包含了两个元素分别是： <code>{{ foo }}</code> 和 <code>{{ bar }}</code></p>
<p>
这是因为在 <code>transformText</code> 里面没有进行文本(插值也算)合并。</p>
</div>
</div>
<div id="outline-container-headline-46" class="outline-3">
<h3 id="headline-46">
0773374 add component nested slots scoping
</h3>
<div id="outline-text-headline-46" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0773374334feb1ed86ff38c65dea917480b6cb89">fix: patchFlag should |= but != · gcclll/stb-vue-next@0773374</a></p>
<p>
插槽嵌套使用。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;Comp&gt;
</span><span class="sb">    &lt;template #default=&#34;{ foo }&#34;&gt;
</span><span class="sb">        &lt;Inner v-slot=&#34;{ bar }&#34;&gt;
</span><span class="sb">        {{ foo }}{{ bar }}{{ baz }}
</span><span class="sb">        &lt;/Inner&gt;
</span><span class="sb">        {{ foo }}{{ bar }}{{ baz }}
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">&lt;/Comp&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
插槽嵌套使用时的解析是先里后外，因为在 transform 阶段 ast 阶段转换之后，会进行回
溯，回溯过程是相反的。</p>
<p>
如：</p>
<p>
ast 结构 transform：</p>
<p>
<code>Comp.children -&gt; [template] -&gt; template.children -&gt; [Inner, foo, bar, baz] -&gt;
Inner.children -&gt; [foo, bar, baz]</code></p>
<p>
ast回溯:</p>
<p>
<code>Inner.children -&gt; Inner -&gt; template.children -&gt; template -&gt; Comp.children -&gt; Comp</code></p>
<p>
所以首先执行 <code>transformElement()</code> 的是 <code>Inner</code> 所以它会先进入 <code>buildSlots()</code> 构
建插槽结构，完了之后是 <code>&lt;template&gt;</code> 最后是 <code>&lt;Comp&gt;</code></p>
<hr>
<p>
render 推导过程：</p>
<ol>
<li>
<p><code>&lt;Inner v-slot=&#34;{bar}&#34;&gt;{{foo}}{{bar}}{{baz}}&lt;/Inner&gt;</code></p>
<p>
是在用户组件上应用了 <code>v-slot</code> 且是默认插槽，因此它的所有孩子节点都会成为默认
插槽一部分。</p>
<p>
结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Inner</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">bar</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">baz</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* DYNAMIC */</span>
<span class="p">},</span> <span class="mi">1024</span> <span class="cm">/* DYNAMIC_SLOTS */</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里使用的是 <code>_createVNode</code> 因为 <code>Inner</code> 非唯一的孩子节点。</p>
</li>
<li>
<p><code>&lt;template #default=&#34;{foo}&#34;&gt;...&lt;/template&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">foo</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Inner</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
       <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">bar</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
          <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">baz</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
        <span class="p">]),</span>
       <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span>
    <span class="p">},</span> <span class="mi">1024</span> <span class="cm">/* DYNAMIC_SLOTS */</span><span class="p">),</span>
    <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">baz</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
这里有个判断 <code>Inner</code> 为动态 slot 的关键点： <code>context.scopes.vSlot &gt; 0</code> 而这个
值是在收集 <code>transformXxx</code> 阶段递增 +1 而后回溯过程中 -1 的。</p>
<p>
在收集阶段 <code>&lt;template&gt;</code> 收集到 <code>trackSlotScopes()</code> 函数此时
<code>context.scopes.vSlot = 1</code> 然后递归 children执行到 <code>Inner</code> 收集阶段的时候
<code>context.scopes.vSlot = 2</code> 直到递归结束。</p>
<p>
开始回溯，先是在 <code>Inner</code> 上应用 transformElement 直到 <code>Inner</code> 回溯到执行
<code>trackSlotScopes()</code> 应为它也有 <code>v-slot</code> 指令，所以 <code>Inner</code> 能收集到这个函数，
它回溯结束执行 <code>trackSlotScopes()</code> 随之 <code>context.scopes.vSlot--</code> 所以此时，在
回溯 <code>Inner</code> 结束之后在开始回溯 <code>&lt;template&gt;</code> 之前 <code>context.scopes.vSlot = 1</code>
。</p>
<p>
这就是 <code>Inner</code> 为什么没有动态属性名但是依旧会判断为动态插槽的原理。</p>
<blockquote>
<p>一句话：如果在 <code>&lt;template v-slot&gt;</code> 里面嵌套另一个 <code>v-slot</code> 那个这个不管有没有
动态属性名都会被当做动态插槽来处理。</p>
</blockquote>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-47" class="outline-3">
<h3 id="headline-47">
c1ace74 add component with v-slot inside v-for
</h3>
<div id="outline-text-headline-47" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;div v-for=&#34;i in list&#34;&gt;
</span><span class="sb">  &lt;Comp v-slot=&#34;bar&#34;&gt;foo&lt;/Comp&gt;
</span><span class="sb">&lt;/div&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>let hasDynamicSlots = context.scopes.vSlot &gt; 0 || context.scopes.vFor &gt; 0;</code></p>
<p>
根据这个判断决定 v-for 里面的 v-slot 为动态插槽。</p>
</div>
</div>
<div id="outline-container-headline-48" class="outline-3">
<h3 id="headline-48">
cfef20e add named slot with v-if
</h3>
<div id="outline-text-headline-48" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cfef20efd83d030924c23308cfb1e38c2b63e228">feat(add): slot with v-if · gcclll/stb-vue-next@cfef20e</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;Comp&gt;
</span><span class="sb">  &lt;template #one v-if=&#34;ok&#34;&gt;hello&lt;/template&gt;
</span><span class="sb">&lt;/Comp&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;
</span><span class="sb">  &lt;template #one v-if=&#34;ok&#34;&gt;hello&lt;/template&gt;
</span><span class="sb">&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, createSlots : _createSlots, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    const _component_Comp = _resolveComponent(&#34;Comp&#34;)

    return (_openBlock(), _createBlock(_component_Comp, null, _createSlots({ _: 2 /* DYNAMIC */ }, [
      ok
        ? {
            name: &#34;one&#34;,
            fn: _withCtx(() =&gt; [
              _createTextVNode(&#34;hello&#34;)
            ])
          }
        : undefined
    ]), 1024 /* DYNAMIC_SLOTS */))
  }
}
undefined
</pre>
<p>
动态 slots 处理之后：
<code>_createSlots({ /* 静态 slots */, [ /* 动态 slots 列表 */ ] })</code></p>
<p>
看下面的运行时的 <code>createSlots(slots, dynamicSlots)</code> 其实就是讲两者合并在一起了
v-if 是个对象 <code>{ fn, name }</code> v-for 是该对象的数组。</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createSlots</span><span class="p">(</span>
  <span class="nx">slots</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Slot</span><span class="p">&gt;,</span>
  <span class="nx">dynamicSlots</span><span class="o">:</span> <span class="p">(</span>
    <span class="o">|</span> <span class="nx">CompiledSlotDescriptor</span>
    <span class="o">|</span> <span class="nx">CompiledSlotDescriptor</span><span class="p">[]</span>
    <span class="o">|</span> <span class="kc">undefined</span><span class="p">)[]</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Slot</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dynamicSlots</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">slot</span> <span class="o">=</span> <span class="nx">dynamicSlots</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="c1">// array of dynamic slot generated by &lt;template v-for=&#34;...&#34; #[...]&gt;
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">slot</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">slots</span><span class="p">[</span><span class="nx">slot</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slot</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">fn</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// conditional single slot generated by &lt;template v-if=&#34;...&#34; #foo&gt;
</span><span class="c1"></span>      <span class="nx">slots</span><span class="p">[</span><span class="nx">slot</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">fn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">slots</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
拓展： <code>v-else, v-else-if</code>
<a href="https://github.com/gcclll/stb-vue-next/commit/e48d46a759478d28eea223c4884ec4815ceb5ac0">feat(add): v-else/v-else-if with v-slot · gcclll/stb-vue-next@e48d46a</a></p>
<p>
与普通的 v-else/v-else-if 处理机制一样，首先是要找到他们兄弟节点前面的 v-if 节点，
然后将该节点挂接到 v-if 节点后面。</p>
<p>
核心代码：</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// v-else/if on slot
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span>
<span class="kd">let</span> <span class="nx">prev</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 找到相邻的 v-if
</span><span class="c1"></span>    <span class="nx">prev</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
    <span class="c1">// 往回找第一个非注释的节点
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 如果该节点是 v-if 合法，否则不合法使用情况
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">prev</span> <span class="o">&amp;&amp;</span> <span class="nx">isTemplateNode</span><span class="p">(</span><span class="nx">prev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">findDir</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="s1">&#39;if&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// remove node
</span><span class="c1"></span>    <span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">i</span><span class="o">--</span>
    <span class="nx">__TEST__</span> <span class="o">&amp;&amp;</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">dynamicSlots</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">// attach this slot to previous conditional
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">conditional</span> <span class="o">=</span> <span class="nx">dynamicSlots</span><span class="p">[</span>
        <span class="nx">dynamicSlots</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">]</span> <span class="kr">as</span> <span class="nx">ConditionalExpression</span>

  <span class="c1">// 这目的是找到 ?: 表达式最后的那个节点
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span>
        <span class="nx">conditional</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CONDITIONAL_EXPRESSION</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nx">conditional</span> <span class="o">=</span> <span class="nx">conditional</span><span class="p">.</span><span class="nx">alternate</span>
    <span class="p">}</span>

  <span class="c1">// 将当前的 v-else/v-else-if 挂到最后那个节点表达式位置
</span><span class="c1"></span>  <span class="c1">// vElse.exp 检测是 v-else-if 还是 v-else(没有值exp)
</span><span class="c1"></span>    <span class="nx">conditional</span><span class="p">.</span><span class="nx">alternate</span> <span class="o">=</span> <span class="nx">vElse</span><span class="p">.</span><span class="nx">exp</span>
        <span class="o">?</span> <span class="nx">createConditionalExpression</span><span class="p">(</span>
            <span class="nx">vElse</span><span class="p">.</span><span class="nx">exp</span><span class="p">,</span>
            <span class="nx">buildDynamicSlot</span><span class="p">(</span><span class="nx">slotName</span><span class="p">,</span> <span class="nx">slotFunction</span><span class="p">),</span>
            <span class="nx">defaultFallback</span>
        <span class="p">)</span>
        <span class="o">:</span> <span class="nx">buildDynamicSlot</span><span class="p">(</span><span class="nx">slotName</span><span class="p">,</span> <span class="nx">slotFunction</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span>
        <span class="nx">createCompilerError</span><span class="p">(</span><span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_V_ELSE_NO_ADJACENT_IF</span><span class="p">,</span> <span class="nx">vElse</span><span class="p">.</span><span class="nx">loc</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-49" class="outline-3">
<h3 id="headline-49">
c1ace74 add v-for on v-slot component
</h3>
<div id="outline-text-headline-49" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c1ace746e229db02a9b311d1becfe4deb1513048">feat(add): v-slot inside v-for · gcclll/stb-vue-next@c1ace74</a></p>
<p>
v-for 的处理和 v-if 原理是一样的，最后返回的都是  <code>{name, fn}</code> 类型，只不过
v-for 返回的是这个类型的数组。</p>
<p>
v-for _renderList 和 slot 的结合：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="mi">_</span><span class="nx">renderList</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
    <span class="nx">fn</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
      <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
    <span class="p">])</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="c1">// 等于是： [ { name, fn }, { name1, fn1 }]
</span><span class="c1">// 然后 _renderSlots -&gt;
</span><span class="c1"></span><span class="mi">_</span><span class="nx">renderSlots</span><span class="p">({</span> <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span> <span class="p">},</span> <span class="p">[</span>
  <span class="mi">_</span><span class="nx">renderList</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">])</span>

<span class="c1">// -&gt; _createBlock
</span><span class="c1"></span><span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">_</span><span class="nx">renderSlots</span><span class="p">({</span>
  <span class="cm">/* 静态，最终动态插槽会合并到该对象来 */</span>
<span class="p">},</span> <span class="p">[</span>
  <span class="cm">/* ... 动态列表 */</span>
<span class="p">]))</span>

<span class="c1">// 对比无动态插槽情况：
</span><span class="c1"></span><span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;
</span><span class="sb">        &lt;template v-for=&#34;name in list&#34; #[name]&gt;{{ name }}&lt;/template&gt;
</span><span class="sb">      &lt;/Comp&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toDisplayString : _toDisplayString, createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, renderList : _renderList, createSlots : _createSlots, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    const _component_Comp = _resolveComponent(&#34;Comp&#34;)

    return (_openBlock(), _createBlock(_component_Comp, null, _createSlots({ _: 2 /* DYNAMIC */ }, [
      _renderList(list, (name) =&gt; {
        return {
          name: name,
          fn: _withCtx(() =&gt; [
            _createTextVNode(_toDisplayString(name), 1 /* TEXT */)
          ])
        }
      ))
    ]), 1024 /* DYNAMIC_SLOTS */))
  }
}
undefined
</pre>
<p>
无非就是不同类型元素、组件 render 方式的组合。</p>
</div>
</div>
<div id="outline-container-slot-usage" class="outline-3">
<h3 id="slot-usage">
小结：v-slot 几种用法
</h3>
<div id="outline-text-slot-usage" class="outline-text-3">
<ol>
<li>
<p><code>&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;</code> , 用户组件上的默认插槽</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>&lt;Comp v-slot=&#34;slotProps&#34;&gt;&lt;div/&gt;&lt;/Comp&gt;</code>, 用户组件上带 <code>slotProps</code> 的默认插槽</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>&lt;Comp v-slot:named=&#34;slotProps&#34;&gt;</code>, 用户组件上具名插槽</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">named</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">])</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>&lt;Comp v-slot:[named]=&#34;slotProps&#34;&gt;</code>, 用户组件上动态具名插槽</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">named</span><span class="p">]</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">])</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>&lt;template&gt; 默认插槽</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot=&#34;slotProps&#34;&gt;&lt;div/&gt;&lt;/template&gt;&lt;/Comp&gt;</code></p>
<p>
<code>&lt;template&gt;</code> 上的默认插槽，这个时候 <code>&lt;Comp&gt;</code> 不能在使用 <code>v-slot</code> ，下同 </p>
</li>
<li>
<p>&lt;template&gt; 具名插槽</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot:named=&#34;slotProps&#34;&gt;&lt;/Comp&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">named</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>&lt;template&gt; 动态具名插槽</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot:[named]=&#34;slotProps&#34;&gt;&lt;/Comp&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">named</span><span class="p">]</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>&lt;template&gt; 具名插槽，其余非 template 元素当做默认插槽处理</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot:named=&#34;slotProps&#34;&gt;&lt;div/&gt;&lt;/template&gt;&lt;div :id=&#34;defaultSlotId&#34;/&gt;&lt;/Comp&gt;</code></p>
<p>
<code>&lt;template&gt;</code> 上的具名插槽 + 默认插槽，在组件内的非 &lt;template&gt; 元素(即： <code>&lt;div/&gt;</code>)都会被动作默认插槽来处理</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">named</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">]),</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">defaultSlotId</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span> <span class="cm">/* PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">])</span>
  <span class="p">])</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>v-slot + v-if 插槽使用</p>
<p>
<code>&lt;Comp&gt;&lt;template v-if=&#34;ok&#34; #named=&#34;slotProps&#34;&gt;{{ bar }}&lt;/template&gt;&lt;/Comp&gt;</code></p>
<p>
配合 v-if 使用的 slot template, 最后解析成 ：
<code>ok ? { name: &#39;named&#39;, fn : _withCtx(() =&gt; [ _createTextVNode(_toDisplayString(bar)) ]) } : undefined</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">_</span><span class="nx">renderSlots</span><span class="p">(</span>
  <span class="p">{</span> <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span> <span class="p">},</span> <span class="p">[</span>
    <span class="nx">ok</span> <span class="o">?</span>
     <span class="p">{</span>
       <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;named&#39;</span><span class="p">,</span>
       <span class="nx">fn</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
         <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
       <span class="p">])</span>
     <span class="p">}</span> <span class="o">:</span> <span class="kc">undefined</span>
  <span class="p">]</span>
<span class="p">)))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>v-slot + v-for 插槽上使用</p>
<p>
<code>&lt;Comp&gt;&lt;template v-for=&#34;i in list&#34; #named=&#34;{ prop }&#34;&gt;{{ bar }}&lt;/template&gt;&lt;/Comp&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">_</span><span class="nx">renderSlots</span><span class="p">(</span>
  <span class="p">{</span> <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span> <span class="p">},</span>
  <span class="mi">_</span><span class="nx">renderList</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;named&#39;</span><span class="p">,</span>
      <span class="nx">fn</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">prop</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
        <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
      <span class="p">])</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">)))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<blockquote>
<p>插槽按状态分为：</p>
<ol>
<li>
<p>静态插槽，动态插槽除外的插槽</p>
</li>
<li>
<p>动态插槽，有 <code>v-if/v-for/v-else[-if]</code> 指令或 <code>v-slot:[named]</code> 或作为 <code>v-for</code>
节点的孩子节点都视为动态插槽</p>
</li>
</ol>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-51" class="outline-2">
<h2 id="headline-51">
update vue-next merge into stb-vue-next[2020-12-11 16:54:06]
</h2>
<div id="outline-text-headline-51" class="outline-text-2">
<p>
更新 vue-next 合并到 stb-vue-next。</p>
<ol>
<li>
<p>ast.ts 更新</p>
<ul>
<li>
<p><code>SimpleExpressionNode</code> : 去掉 <code>isConstant</code> 属性，增加 <code>constType</code></p>
</li>
<li>
<p>去掉了 <code>StaticType</code> 增加 <code>ConstantType</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm">* Static types have several levels.
</span><span class="cm">* Higher levels implies lower levels. e.g. a node that can be stringified
</span><span class="cm">* can always be hoisted and skipped for patch.
</span><span class="cm">*/</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="kr">enum</span> <span class="nx">ConstantTypes</span> <span class="p">{</span>
<span class="nx">NOT_CONSTANT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="nx">CAN_SKIP_PATCH</span><span class="p">,</span>
<span class="nx">CAN_HOIST</span><span class="p">,</span>
<span class="nx">CAN_STRINGIFY</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>codegen.ts 更新</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/521b879d80b9c982f1a15dbc89404725141674d6">fix: merge vue-next codegen.ts · gcclll/stb-vue-next@521b879</a></p>
</li>
<li>
<p>parse.ts 更新</p>
<p>
ast 结构中的 <code>isConstant</code> 改成 <code>ConstantTypes</code> 类型值</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fdbdc4f93ad04f6544d77bf3ebf20e4f58673930">fix: merge vue-next parse.ts isConstant -&gt; constType · gcclll/stb-vue-next@fdbdc4f</a></p>
</li>
<li>
<p>transform.ts 更新</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/22a8f0be4405592621f805848533396642b4b2f2">fix: merge vue-next transform.ts · gcclll/stb-vue-next@22a8f0b</a></p>
<ul>
<li>
<p>add <code>filename</code></p>
</li>
<li>
<p>add <code>isTS, inline</code></p>
</li>
</ul>
</li>
<li>
<p>transformElement.ts</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1d85990627d0383741c7050fb4af8929377691e1">fix: merge vue-next transformElement.ts · gcclll/stb-vue-next@1d85990</a></p>
</li>
<li>
<p>transformSlotOutlet.ts</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/58e87f3adcfa0657602d459043468ac5ce8859cb">fix: merge vue-next transformSlotOutlet.ts · gcclll/stb-vue-next@58e87f3</a>
修改 <code>&lt;slot&gt;&lt;/slot&gt;</code> 属性解析逻辑。</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-52" class="outline-2">
<h2 id="headline-52">
6efbc86 add expression transform(node-env)
</h2>
<div id="outline-text-headline-52" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6efbc86490fdc353c57fcaead5201c46696bb3d4">feat: transformExpression -&gt; processExpression · gcclll/stb-vue-next@6efbc86</a></p>
<p>
transformExpression 处理的是复杂表达式情况，且需要在非浏览器环境，因为它需要依赖
一些 JavaScript 解析器来协助完成。</p>
<p>
需要处理的两种类型：</p>
<ol>
<li>
<p><code>INTERPOLATION</code> 插值类型</p>
</li>
<li>
<p><code>ELEMENT</code> 类型且没有 <code>v-for</code> 指令的标签，对于指令需要处理的有 <code>arg, exp</code> 如果
参数是动态的情况</p>
</li>
</ol>
<p>
两者最终都是调用 <code>processExpression(node, context, asPrarms, asRawStatement)</code> 这
个函数，这个函数有点复杂，需要慢慢消化🐕 🐕 🐕 </p>
</div>
</div>
<div id="outline-container-headline-53" class="outline-2">
<h2 id="headline-53">
TODOs(ssr render, node env, setup meta)
</h2>
<div id="outline-text-headline-53" class="outline-text-2">
<p>
在此之前都是基于浏览器去完成和测试的，但是由于后面 compiler-dom 有些测试同样需要
node 环境支持，因此这里必须先完成所有浏览器的支持，这样 <code>prefixIdentifiers</code>
和 <code>cacheHandlers</code> 也将支持。</p>
<p>
add generate imports and module mode:
<a href="https://github.com/gcclll/stb-vue-next/commit/ea7f16b87df7ffc9aa5018889488b963240acb71">feat: gen imports · gcclll/stb-vue-next@ea7f16b</a></p>
<p>
<strong>TODO</strong> ssr template literal:
<a href="https://github.com/gcclll/stb-vue-next/commit/356bc93c3086500a5a41211bbeb3faa8267bd727">feat(add): gen template literal · gcclll/stb-vue-next@356bc93</a></p>
<p>
<strong>TODO</strong> ssr if generate:
<a href="https://github.com/gcclll/stb-vue-next/commit/1c424beb5e2cf21515799cbce245ef3337ff4f41">feat(add): ssr gen if statement · gcclll/stb-vue-next@1c424be</a> </p>
<p>
<strong>TODO</strong> ssr assigment expression generate: 生成赋值表达式
<a href="https://github.com/gcclll/stb-vue-next/commit/1f99a11193478460a572708fa9829969f443c9be">feat(add): ssr gen assignment expression · gcclll/stb-vue-next@1f99a11</a></p>
<p>
<strong>TODO</strong> ssr generate sequence exprssion:
<a href="https://github.com/gcclll/stb-vue-next/commit/81aa0b009f7978f7ef5f9d1f9bcbc0d99f70c1c3">feat(add): ssr gen sequence expression · gcclll/stb-vue-next@81aa0b0</a></p>
<p>
<strong>TODO</strong> ssr generate return statement:
<a href="https://github.com/gcclll/stb-vue-next/commit/c85406cbfbc356bb00562ea4366907f1fbb1980b">feat(add): ssr gen return statement · gcclll/stb-vue-next@c85406c</a></p>
<p>
<strong>TODO</strong> ssr v-on transform:
<a href="https://github.com/gcclll/stb-vue-next/commit/adefeeceddccf23bdf2c3373d3d28be1bd35878f">feat(add): ssr v-on transform · gcclll/stb-vue-next@adefeec</a></p>
<p>
<strong>TODO</strong> setup mode v-model on ref:
<a href="https://github.com/gcclll/stb-vue-next/commit/20bb40dd2fdb9222005a71ac019ef96a820268e5">feat(add): setup mode v-model on ref · gcclll/stb-vue-next@20bb40d</a></p>
<p>
<strong>TODO</strong> process expression in vIf.ts
<a href="https://github.com/gcclll/stb-vue-next/commit/56c49c7f8924e786f8648b063c9a6d8a4252c4c2">feat(add): v-if process expression · gcclll/stb-vue-next@56c49c7</a></p>
<p>
<strong>TODO</strong> setup mode ref in transformElement
<a href="https://github.com/gcclll/stb-vue-next/commit/54f467f57f2ed0deb061b6602c3154a2be407840">feat(add): transform ref in setup mode in transformElement · gcclll/stb-vue-next@54f467f</a></p>
</div>
</div>
<div id="outline-container-headline-54" class="outline-2">
<h2 id="headline-54">
non-browser testing(非浏览器环境测试)
</h2>
<div id="outline-text-headline-54" class="outline-text-2">
<p>
本章节测试都是基于 node 环境进行测试的，测试代码位于各个 package 目录下的
<code>__nests__</code> (node tests 缩写)里面。</p>
<p>
由于测试输出结果较多，因此采用控制台形式输出，请 <code>&lt;f12&gt;</code> 打开控制台查看</p>
<script>
l1(`hoist static testing 静态提升测试`)
c(`<div/>`, 'should NOT hoist root node')
</script>
<script src="/js/vue/node.env.test.js"></script>
</div>
</div>
<div id="outline-container-headline-55" class="outline-2">
<h2 id="headline-55">
jest 跑🏃用例
</h2>
<div id="outline-text-headline-55" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2085dd62df2c63d76475988a88f1e3fdc2586e7d">fix: jest errors · gcclll/stb-vue-next@2085dd6</a></p>
<pre class="example">
@vue/runtime-dom (guessing &#39;runtimeDom&#39;)
created packages/vue/dist/vue.global.js in 5.1s
 PASS  packages/compiler-core/__tests__/transforms/transformElement.spec.ts (9.278 s)
 PASS  packages/compiler-core/__tests__/transforms/vModel.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vFor.spec.ts
 PASS  packages/compiler-core/__tests__/parse.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/hoistStatic.spec.ts
 PASS  packages/compiler-core/__tests__/codegen.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vIf.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vSlot.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/transformExpressions.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vOn.spec.ts
 PASS  packages/compiler-core/__tests__/transform.spec.ts
 PASS  packages/compiler-core/__tests__/compile.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/transformSlotOutlet.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/transformText.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vOnce.spec.ts
 PASS  packages/compiler-core/__tests__/scopeId.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vBind.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/noopDirectiveTransform.spec.ts
 PASS  packages/compiler-core/__tests__/utils.spec.ts

Test Suites: 19 passed, 19 total
Tests:       480 passed, 480 total
Snapshots:   205 passed, 205 total
Time:        17.699 s
</pre>
<p>
全部通过测试，期间出现两个小问题：</p>
<ol>
<li>
<p>transformElement 里面解析动态属性(<code>vnodeDynamicProps</code>)的时候会将这些属性组成
字符串数组，这里少了个逗号</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201218162357.png" alt="http://qiniu.ii6g.com/img/20201218162357.png" title="http://qiniu.ii6g.com/img/20201218162357.png" /></p>
</li>
<li>
<p><code>genFunctionExpression()</code> 里面将函数 <code>}</code> 错写成了 <code>)</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201218162509.png" alt="http://qiniu.ii6g.com/img/20201218162509.png" title="http://qiniu.ii6g.com/img/20201218162509.png" /></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-56" class="outline-2">
<h2 id="headline-56">
综合测试
</h2>
<div id="outline-text-headline-56" class="outline-text-2">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">tpl</span> <span class="p">=&gt;</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">tpl</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">code</span>
<span class="kd">let</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="sb">``</span><span class="p">,</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">``</span>
<span class="nx">tpl</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;div :id=&#34;status&#34; class=&#34;status&#34; :style=&#34;{ color: &#39;red&#39; }&#34;&gt;
</span><span class="sb">  &lt;button v-if=&#34;opened&#34; @click=&#34;opened = !opened&#34;&gt;关闭&lt;/button&gt;
</span><span class="sb">  &lt;button v-else-if=&#34;invalid&#34; v-on.enter=&#34;{ clicked: toggleValid }&#34;&gt;有效&lt;/button&gt;
</span><span class="sb">  &lt;button v-else @click.prevent=&#34;() =&gt; opened = true&#34;&gt;打开&lt;/button&gt;
</span><span class="sb">  &lt;p :name=&#34;vbind&#34;&gt;v-bind 缩写&lt;/p&gt;
</span><span class="sb">  &lt;p class=&#34;vbind-no-arg&#34; v-bind=&#34;{ name: &#39;vbind&#39; }&#34;&gt;无参数的 v-bind&lt;/p&gt;
</span><span class="sb">&lt;/div&gt;
</span><span class="sb">&lt;div id=&#34;list&#34; :class=&#34;list&#34; style=&#34;color:red;&#34;&gt;
</span><span class="sb">  &lt;ul&gt;
</span><span class="sb">    &lt;li v-for=&#34;(value, key, index) in list&#34;&gt;{{ value }}&lt;/li&gt;
</span><span class="sb">  &lt;/ul&gt;
</span><span class="sb">&lt;/div&gt;
</span><span class="sb">&lt;div id=&#34;once&#34; :class=&#34;once&#34;&gt;{{ once }}&lt;/div&gt;
</span><span class="sb">&lt;div id=&#34;user-comp&#34; :class=&#34;user-comp&#34;&gt;
</span><span class="sb">  &lt;!-- 我是注释：用户组件 --&gt;
</span><span class="sb">  &lt;List&gt;{{ &#34;我是 &lt;List/&gt; 的默认插槽&#34; }}&lt;/List&gt;
</span><span class="sb">  &lt;List v-slot=&#34;{ prop }&#34;&gt;&lt;p class=&#34;title&#34;&gt;我是带 slotProps({{ prop }}) 的默认插槽&lt;/p&gt;&lt;/List&gt;
</span><span class="sb">  &lt;List v-slot:title=&#34;{ prop }&#34;&gt;&#34;我是带名字{{ prop }}的插槽&#34;&lt;/List&gt;
</span><span class="sb">  &lt;List&gt;
</span><span class="sb">    &lt;template v-slot:one=&#34;slotProps&#34;&gt;&lt;p&gt;{{ slotProps.title }}&lt;/p&gt;&lt;/template&gt;
</span><span class="sb">    &lt;p&gt;我是默认插槽的一部分&lt;/p&gt;
</span><span class="sb">    &lt;p&gt;我也是默认插槽的一部分&lt;/p&gt;
</span><span class="sb">    &lt;p&gt;我也是。。。。。。。&lt;/p&gt;
</span><span class="sb">    &lt;p&gt;我们都是。。。。。。&lt;/p&gt;
</span><span class="sb">  &lt;/List&gt;
</span><span class="sb">  &lt;List&gt;
</span><span class="sb">    &lt;template&gt;
</span><span class="sb">      &lt;p&gt;我是默认插槽&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">    &lt;template v-slot:one=&#34;{ prop }&#34;&gt;
</span><span class="sb">      &lt;p&gt;我是名字为 one 的具名插槽插槽({{ prop }})&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">  &lt;/List&gt;
</span><span class="sb">  &lt;List v-if=&#34;ok&#34; v-slot:one=&#34;slotProps&#34;&gt;&lt;p&gt;我是带 v-if 指令的且 v-slot 引用在组件上的具名 &#34;one&#34; 插槽，标题属性： {{ slotProps.title }}&lt;/p&gt;&lt;/List&gt;
</span><span class="sb">  &lt;List&gt;
</span><span class="sb">    &lt;template&gt;&lt;!-- 我是默认插槽，给你们注释用的！！！！！！ --&gt;&lt;/template&gt;
</span><span class="sb">    &lt;template v-if=&#34;ok&#34; v-slot:one=&#34;{ prop }&#34;&gt;
</span><span class="sb">      &lt;p&gt;带 v-if + v-slot + template 的动态插槽，我应该要用到 _createSlots(staticSlots, dynamicSLots) 函数&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">    &lt;template v-for=&#34;(value, key, index) in list&#34; v-slot:two=&#34;slotProps&#34;&gt;
</span><span class="sb">      &lt;p&gt;带 v-for + v-slot + template 的动态插槽，我应该要用到 _createSlots(staticSlots, dynamicSLots) 函数&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">  &lt;/List&gt;
</span><span class="sb">&lt;/div&gt;
</span><span class="sb">`</span>
<span class="nx">code</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="nx">tpl</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; 复杂应用场景`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`\n&gt; 注释\n`</span><span class="p">,</span>
    <span class="sb">`1. v-on 表达式为简单表达式时会被处理成一个箭头函数\n`</span><span class="p">,</span>
    <span class="sb">`2. v-on 如果没有参数时，会触发该组件上的所有属性合并(_mergeProps(...))\n`</span><span class="p">,</span>
    <span class="sb">`3. v-on 表达式为一个函数式，不需要额外处理\n`</span><span class="p">,</span>
    <span class="sb">`4. v-for 调用 _renderList(list, fn) 渲染列表，list 列表数据来源，fn 列表项渲染函数\n`</span><span class="p">,</span>
    <span class="sb">`5. v-slot 应用在用户组件上时，里面就不能在使用 v-slot\n`</span><span class="p">,</span>
    <span class="sb">`6. 只要在 template 上应用了 v-if/v-for 或者将用户组件放在 v-for 下面这些插槽都会被当做动态插槽处理\n`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; 复杂应用场景
const _Vue = Vue
const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode } = _Vue

const _hoisted_1 = { class: &#34;title&#34; }
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;我是默认插槽的一部分&#34;, -1 /* HOISTED */)
const _hoisted_3 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;我也是默认插槽的一部分&#34;, -1 /* HOISTED */)
const _hoisted_4 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;我也是。。。。。。。&#34;, -1 /* HOISTED */)
const _hoisted_5 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;我们都是。。。。。。&#34;, -1 /* HOISTED */)
const _hoisted_6 = /*#__PURE__*/_createVNode(&#34;template&#34;, null, [
  /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;我是默认插槽&#34;)
], -1 /* HOISTED */)
const _hoisted_7 = /*#__PURE__*/_createVNode(&#34;template&#34;, null, [
  /*#__PURE__*/_createCommentVNode(&#34; 我是默认插槽，给你们注释用的！！！！！！ &#34;)
], -1 /* HOISTED */)
const _hoisted_8 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;带 v-if + v-slot + template 的动态插槽，我应该要用到 _createSlots(staticSlots, dynamicSLots) 函数&#34;, -1 /* HOISTED */)
const _hoisted_9 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;带 v-for + v-slot + template 的动态插槽，我应该要用到 _createSlots(staticSlots, dynamicSLots) 函数&#34;, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode, toHandlers : _toHandlers, mergeProps : _mergeProps, renderList : _renderList, Fragment : _Fragment, toDisplayString : _toDisplayString, createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, createSlots : _createSlots } = _Vue

    const _component_List = _resolveComponent(&#34;List&#34;)

    return (_openBlock(), _createBlock(_Fragment, null, [
      _createVNode(&#34;div&#34;, {
        id: status,
        class: &#34;status&#34;,
        style: { color: &#39;red&#39; }
      }, [
        opened
          ? (_openBlock(), _createBlock(&#34;button&#34;, {
              key: 0,
              onClick: $event =&gt; (opened = !opened)
            }, &#34;关闭&#34;, 8 /* PROPS */, [&#34;onClick&#34;]))
          : invalid
            ? (_openBlock(), _createBlock(&#34;button&#34;, _mergeProps({ key: 1 }, _toHandlers({ clicked: toggleValid })), &#34;有效&#34;, 16 /* FULL_PROPS */))
            : (_openBlock(), _createBlock(&#34;button&#34;, {
                key: 2,
                onClick: () =&gt; opened = true
              }, &#34;打开&#34;, 8 /* PROPS */, [&#34;onClick&#34;])),
        _createVNode(&#34;p&#34;, { name: vbind }, &#34;v-bind 缩写&#34;, 8 /* PROPS */, [&#34;name&#34;]),
        _createVNode(&#34;p&#34;, _mergeProps({ class: &#34;vbind-no-arg&#34; }, { name: &#39;vbind&#39; }), &#34;无参数的 v-bind&#34;, 16 /* FULL_PROPS */)
      ], 12 /* STYLE, PROPS */, [&#34;id&#34;]),
      _createVNode(&#34;div&#34;, {
        id: &#34;list&#34;,
        class: list,
        style: &#34;color:red;&#34;
      }, [
        _createVNode(&#34;ul&#34;, null, [
          (_openBlock(true), _createBlock(_Fragment, null, _renderList(list, (value, key, index) =&gt; {
            return (_openBlock(), _createBlock(&#34;li&#34;, null, _toDisplayString(value), 1 /* TEXT */))
          )), 256 /* UNKEYED_FRAGMENT */))
        ])
      ], 2 /* CLASS */),
      _createVNode(&#34;div&#34;, {
        id: &#34;once&#34;,
        class: once
      }, _toDisplayString(once), 3 /* TEXT, CLASS */),
      _createVNode(&#34;div&#34;, {
        id: &#34;user-comp&#34;,
        class: user-comp
      }, [
        _createCommentVNode(&#34; 我是注释：用户组件 &#34;),
        _createVNode(_component_List, null, {
          default: _withCtx(() =&gt; [
            _createTextVNode(_toDisplayString(&#34;我是 &lt;List/&gt; 的默认插槽&#34;), 1 /* TEXT */)
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          default: _withCtx(({ prop }) =&gt; [
            _createVNode(&#34;p&#34;, _hoisted_1, &#34;我是带 slotProps(&#34; + _toDisplayString(prop) + &#34;) 的默认插槽&#34;, 1 /* TEXT */)
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          title: _withCtx(({ prop }) =&gt; [
            _createTextVNode(&#34;\&#34;我是带名字&#34; + _toDisplayString(prop) + &#34;的插槽\&#34;&#34;, 1 /* TEXT */)
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          one: _withCtx((slotProps) =&gt; [
            _createVNode(&#34;p&#34;, null, _toDisplayString(slotProps.title), 1 /* TEXT */)
          ]),
          default: _withCtx(() =&gt; [
            _hoisted_2,
            _hoisted_3,
            _hoisted_4,
            _hoisted_5
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          one: _withCtx(({ prop }) =&gt; [
            _createVNode(&#34;p&#34;, null, &#34;我是名字为 one 的具名插槽插槽(&#34; + _toDisplayString(prop) + &#34;)&#34;, 1 /* TEXT */)
          ]),
          default: _withCtx(() =&gt; [
            _hoisted_6
          ]),
          _: 1 /* STABLE */
        }),
        ok
          ? (_openBlock(), _createBlock(_component_List, { key: 0 }, {
              one: _withCtx((slotProps) =&gt; [
                _createVNode(&#34;p&#34;, null, &#34;我是带 v-if 指令的且 v-slot 引用在组件上的具名 \&#34;one\&#34; 插槽，标题属性： &#34; + _toDisplayString(slotProps.title), 1 /* TEXT */)
              ]),
              _: 1 /* STABLE */
            }))
          : _createCommentVNode(&#34;v-if&#34;, true),
        _createVNode(_component_List, null, _createSlots({
          default: _withCtx(() =&gt; [
            _hoisted_7
          ]),
          _: 2 /* DYNAMIC */
        }, [
          ok
            ? {
                name: &#34;one&#34;,
                fn: _withCtx(({ prop }) =&gt; [
                  _hoisted_8
                ])
              }
            : undefined,
          _renderList(list, (value, key, index) =&gt; {
            return {
              name: &#34;two&#34;,
              fn: _withCtx((slotProps) =&gt; [
                _hoisted_9
              ])
            }
          ))
        ]), 1024 /* DYNAMIC_SLOTS */)
      ], 2 /* CLASS */)
    ], 64 /* STABLE_FRAGMENT */))
  }
}

&gt; 注释
 1. v-on 表达式为简单表达式时会被处理成一个箭头函数
 2. v-on 如果没有参数时，会触发该组件上的所有属性合并(_mergeProps(...))
 3. v-on 表达式为一个函数式，不需要额外处理
 4. v-for 调用 _renderList(list, fn) 渲染列表，list 列表数据来源，fn 列表项渲染函数
 5. v-slot 应用在用户组件上时，里面就不能在使用 v-slot
 6. 只要在 template 上应用了 v-if/v-for 或者将用户组件放在 v-for 下面这些插槽都会被当做动态插槽处理

undefined
</pre>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-11-30
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/compiler-core/">compiler-core,</a>
          <a href="/tags/parser/">parser,</a>
          <a href="/tags/compiler/">compiler,</a>
          <a href="/tags/transform/">transform</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-compiler-dom/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 源码头脑风暴之 4 ☞compiler-dom</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-compiler-core-parser/">
            <span class="next-text nav-default">Vue3 源码头脑风暴之 2 ☞compiler-core - ast parser</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
