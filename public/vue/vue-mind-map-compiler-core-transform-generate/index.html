<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform &#43; codegen - è‹¥å¶çŸ¥ç§‹</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼šè¯¥ç¯‡" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/vue/vue-mind-map-compiler-core-transform-generate/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.06b20cf21b1dff0a19c6a6fd2770439ed0c003d544ece3c4e1fbfb34fc217e45.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform &#43; codegen" />
<meta property="og:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼šè¯¥ç¯‡" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/vue/vue-mind-map-compiler-core-transform-generate/" /><meta property="article:section" content="vue" />
<meta property="article:published_time" content="2020-11-30T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-11-30T00:00:00&#43;00:00" />

<meta itemprop="name" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform &#43; codegen">
<meta itemprop="description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼šè¯¥ç¯‡"><meta itemprop="datePublished" content="2020-11-30T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-11-30T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="19784">
<meta itemprop="keywords" content="vue,,vue3,,compiler-core,,parser,,compiler,,transform," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform &#43; codegen"/>
<meta name="twitter:description" content="è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ stb-vue-next å®Œå…¨æ‹·è´äº vue-next ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚ å£°æ˜ ï¼šè¯¥ç¯‡"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/web/">
        <li class="mobile-menu-item">Web</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">è‹¥å¶çŸ¥ç§‹</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/web/">Web</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform &#43; codegen</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-30 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 19784 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 40 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">å…³é”®çŸ¥è¯†ç‚¹</a>
</li>
<li><a href="#headline-2">è„‘å›¾</a>
</li>
<li><a href="#headline-3">e03a03c init transform module</a>
</li>
<li><a href="#headline-4">fc6f1f1 add transform function</a>
</li>
<li><a href="#headline-5">b0d72da add compile.ts&gt;compile()</a>
</li>
<li><a href="#headline-6">35248ce add exports maybe needs</a>
</li>
<li><a href="#pure-text">05a223b add transform pure text</a>
<ul>
<li><a href="#headline-8">61ce406 add createRootCodegen() to create root.codegenNode</a>
</li>
<li><a href="#headline-9">b9f3cb7 add transform text</a>
</li>
<li><a href="#headline-10">f6d5271 add generate text codegen</a>
</li>
<li><a href="#headline-11">æµ‹è¯•</a>
<ul>
<li><a href="#headline-12">function preamble å½¢å¼(ä½œä¸ºå…¨å±€ <code>Vue</code> å¯¹è±¡å¼•å…¥)</a>
</li>
<li><a href="#headline-13">module preamble å½¢å¼(<strong>es6</strong> æ¨¡å—åŒ–å¯¼å‡ºå¯¼å…¥)</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#interpolation">2f749b2 add interpolation generator</a>
</li>
<li><a href="#element">add element transfrom and generator</a>
<ul>
<li><a href="#headline-16">å‡†å¤‡å·¥ä½œ <code>compiler-core/src/utils.ts</code></a>
</li>
<li><a href="#element-transform">87339d2 add element transform</a>
</li>
<li><a href="#headline-18">2f58786 add element generator</a>
</li>
<li><a href="#headline-19">05ca2f8 root.children æœ‰å¤šä¸ªå­©å­</a>
</li>
</ul>
</li>
<li><a href="#headline-20">7cb3dbf add hoist static é™æ€æå‡</a>
</li>
<li><a href="#headline-21">prop transform and generator</a>
<ul>
<li><a href="#headline-22">1792f93 props transform</a>
<ul>
<li><a href="#headline-23">buildProps</a>
</li>
<li><a href="#headline-24">transform props</a>
</li>
</ul>
</li>
<li><a href="#headline-25">e4acc0d props generator</a>
</li>
<li><a href="#headline-26">static props</a>
</li>
<li><a href="#headline-27">6951dd1 merge props</a>
</li>
</ul>
</li>
<li><a href="#headline-28">6c43451 add v-on transform</a>
</li>
<li><a href="#v-bind">f805858 add v-bind transform</a>
</li>
<li><a href="#headline-30">0cc76f0 add v-model transform</a>
</li>
<li><a href="#headline-31">bf18a84 add v-once transform</a>
</li>
<li><a href="#headline-32">acdea14 add v-if transform</a>
<ul>
<li><a href="#headline-33">acdea14 v-if transform init</a>
</li>
<li><a href="#headline-34">9039a3e v-if transform processIf</a>
</li>
<li><a href="#headline-35">44985b4 v-if transform createIfBranch</a>
</li>
<li><a href="#headline-36">742757e v-if generator</a>
</li>
<li><a href="#headline-37">fa77b51 v-else/v-else-if</a>
</li>
</ul>
</li>
<li><a href="#headline-38">6c82066 add v-for transform</a>
</li>
<li><a href="#headline-39">39a20fe add v-for generator</a>
</li>
<li><a href="#headline-40">7cb8908 add slot outlet transform</a>
<ul>
<li><a href="#headline-41">ebdb1ed add track slot scopes</a>
</li>
</ul>
</li>
<li><a href="#v-slot">36c1f36 (v-slot)build user component as slots</a>
<ul>
<li><a href="#headline-43">fbed5cf add component with default slot without &lt;template&gt; transform</a>
</li>
<li><a href="#headline-44">8bed175 add component with default slot without &lt;template&gt; generator</a>
</li>
<li><a href="#headline-45">9f58154 fix: æ–‡æœ¬èŠ‚ç‚¹æ²¡æœ‰åˆå¹¶(<code>transformText</code>)</a>
</li>
<li><a href="#headline-46">0773374 add component nested slots scoping</a>
</li>
<li><a href="#headline-47">c1ace74 add component with v-slot inside v-for</a>
</li>
<li><a href="#headline-48">cfef20e add named slot with v-if</a>
</li>
<li><a href="#headline-49">c1ace74 add v-for on v-slot component</a>
</li>
<li><a href="#slot-usage">å°ç»“ï¼šv-slot å‡ ç§ç”¨æ³•</a>
</li>
</ul>
</li>
<li><a href="#headline-51">update vue-next merge into stb-vue-next[2020-12-11 16:54:06]</a>
</li>
<li><a href="#headline-52">6efbc86 add expression transform(node-env)</a>
</li>
<li><a href="#headline-53">TODOs(ssr render, node env, setup meta)</a>
</li>
<li><a href="#headline-54">non-browser testing(éæµè§ˆå™¨ç¯å¢ƒæµ‹è¯•)</a>
</li>
<li><a href="#headline-55">jest è·‘ğŸƒç”¨ä¾‹</a>
</li>
<li><a href="#headline-56">ç»¼åˆæµ‹è¯•</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<p>
<img src="/img/bdx/yiyeshu-001.jpg" alt="/img/bdx/yiyeshu-001.jpg" title="/img/bdx/yiyeshu-001.jpg" /></p>
<p>
<kbd>
<strong><a href="https://github.com/gcclll/stb-vue-next">stb-vue-next</a> å®Œå…¨æ‹·è´äº <a href="https://github.com/vuejs/vue-next">vue-next</a> ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚</strong>
</kbd></p>
<blockquote>
<p><strong>å£°æ˜</strong> ï¼šè¯¥ç¯‡ä¸º ts æºç (<em>commit</em>)ç‰ˆæœ¬ï¼Œä¹‹å‰åšè¿‡ä¸€éå®Œæ•´çš„ js ç‰ˆæœ¬ï¼Œæ›´è¯¦ç»†ï¼Œä¹Ÿå¯å‚è€ƒ</p>
<p>
<a href="https://www.cheng92.com/vue/vue3-source-code-compiler-core-compile_ts/">Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 3: compile.ts - è‹¥å¶çŸ¥ç§‹</a></p>
<p>
ç”±äº transform é˜¶æ®µç›´æ¥æµ‹è¯•ä¸å¤ªå¥½ç›´è§‚çš„çœ‹å‡ºç»“æœï¼Œå› æ­¤è¿™é‡Œä¼šç»“åˆ codegen æ¥ä¸€èµ·å®
ç°ï¼Œå³è¯¥æ–‡åŒ…å« compiler-core ä¸‰å¤§é˜¶æ®µçš„æœ€åä¸¤ä¸ªé˜¶æ®µ(transform + generate)</p>
<p>
<strong>è°ƒè¯•</strong> ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å¯é€šè¿‡ <code>&lt;F12&gt;</code> æ§åˆ¶å°æŸ¥çœ‹</p>
<p>
<strong>æ›´æ–°æ—¥å¿—&amp;Todos</strong> ï¼š</p>
<ol>
<li>
<p>DONE [2020-12-12 18:33:33] é˜¶æ®µæ€§å®Œæˆï¼Œæµè§ˆå™¨æ”¯æŒçš„æ‰€æœ‰åŸºæœ¬åŠŸèƒ½(æµè§ˆå™¨ç¯å¢ƒæ‰€
æœ‰ç”¨ä¾‹æµ‹è¯•å‡å·²é€šè¿‡ï¼Œå¯é€šè¿‡æ§åˆ¶å°æŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹åŠå…¶è¿è¡Œè¿‡ç¨‹ç»“æœ)</p>
</li>
<li>
<p>TODO ssr æœåŠ¡ç«¯æ¸²æŸ“</p>
</li>
<li>
<p>TODO &lt;setup&gt; æ ‡ç­¾å¤„ç†</p>
</li>
<li>
<p>TODO éæµè§ˆå™¨ç¯å¢ƒæ”¯æŒ(<code>prefixIdentifiers, cacheHandlers</code> é€‰é¡¹éœ€è¦éæµè§ˆå™¨ç¯å¢ƒ)</p>
</li>
<li>
<p>TODO ref ç±»å‹å¤„ç†</p>
</li>
</ol>
</blockquote>
<script src="/js/vue/compiler-core.global.js"></script>
<script src="/js/utils.js"></script>
<script>
i = 0, j = 0
const { baseCompile } = VueCompilerCore
const compile = (tpl, title, logAst = false) => {
    l2(title)
    // if (!tpl) return null
    const { code, ast } = baseCompile(tpl, {
        onError: (e) => console.warn(e.message),
        hoistStatic: true,
        ...( compile.options || {} )
    })

    log.grey(tpl)
    log([code])
    logAst && log(typeof logAst === 'function' ? logAst(ast) : ast)
    return ast
}
const c = (tpl, desc, fn) => compile(tpl, desc, fn || (ast => ast.codegenNode&&ast.codegenNode.props))

</script>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
å…³é”®çŸ¥è¯†ç‚¹
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ol>
<li>
<p><a href="#element-transform">ğŸ”—</a> root.children.length = 1 ä¸”ç±»å‹æ˜¯ ELEMENTçš„æ—¶å€™å°† <code>CREATE_VNODE</code> æ”¹æˆ
<code>CREATE_BLOCK</code>   </p>
</li>
<li>
<p><a href="#v-bind">ğŸ”—</a> åŠ¨æ€å±æ€§ä¸ºè¡¨è¾¾å¼æ—¶ï¼Œä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼</p>
<p>
å¦‚ï¼š <code>&lt;div :[first + second]=&#34;third&#34; ...</code> æ˜¯éæ³•çš„ã€‚</p>
<p>
å› ä¸º <code>parseAttribute()</code> ä¸­çš„æ­£åˆ™æ˜¯ä¸æ”¯æŒä¸­é—´æœ‰ç©ºæ ¼çš„ï¼š</p>
<p>
å–å‚æ•°åçš„æ­£åˆ™ï¼š <code>/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</code></p>
</li>
<li>
<p><a href="#v-bind">ğŸ”—</a> v-bind æŒ‡ä»¤çš„å‡ ç§ç”¨æ³• -&gt;</p>
</li>
<li>
<p><a href="#slot-usage">ğŸ”—</a> ç”¨æˆ·ç»„ä»¶ -&gt; æ’æ§½å¤„ç† -&gt; v-slot ä½¿ç”¨æ–¹æ³•</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
è„‘å›¾
</h2>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
e03a03c init transform module
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e03a03c5d775ff9315cc027d88b0669a775cf590">feat(init): transform section Â· gcclll/stb-vue-next@e03a03c</a></p>
<p>
åˆå§‹åŒ–å‡½æ•°ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createTransformContext</span><span class="p">(</span>
  <span class="nx">root</span>: <span class="kt">RootNode</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">prefixIdentifiers</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">hoistStatic</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">cacheHandlers</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">nodeTransforms</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">directiveTransforms</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">transformHoist</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isBuiltInComponent</span> <span class="o">=</span> <span class="nx">NOOP</span><span class="p">,</span>
    <span class="nx">isCustomElement</span> <span class="o">=</span> <span class="nx">NOOP</span><span class="p">,</span>
    <span class="nx">expressionPlugins</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">scopeId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">ssr</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">ssrCssVars</span> <span class="o">=</span> <span class="sb">``</span><span class="p">,</span>
    <span class="nx">bindingMetadata</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">onError</span> <span class="o">=</span> <span class="nx">defaultOnError</span>
  <span class="p">}</span><span class="o">:</span> <span class="nx">TransformOptions</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">TransformContext</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">context</span>: <span class="kt">TransformContext</span> <span class="o">=</span> <span class="p">{</span>

    <span class="c1">// ...
</span><span class="c1"></span>
    <span class="c1">// methods
</span><span class="c1"></span>    <span class="nx">helper</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">name</span>
    <span class="p">},</span>
    <span class="nx">helperString</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="sb">``</span>
    <span class="p">},</span>
    <span class="nx">replaceNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{},</span>
    <span class="nx">removeNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{},</span>
    <span class="nx">onNodeRemoved</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{},</span>
    <span class="nx">addIdentifiers</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">},</span>
    <span class="nx">removeIdentifiers</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">},</span>
    <span class="nx">hoist</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>      <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="kt">any</span>
    <span class="p">},</span>
    <span class="nx">cache</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">isVNode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>      <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="kt">any</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">context</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">root</span>: <span class="kt">RootNode</span><span class="p">,</span> <span class="nx">options</span>: <span class="kt">TransformOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// TODO
</span><span class="c1">// createRootCodegen
</span><span class="c1"></span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseChildren</span><span class="p">(</span>
  <span class="nx">parent</span>: <span class="kt">ParentNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseNode</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">RootNode</span> <span class="o">|</span> <span class="nx">TemplateChildNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">createStructuralDirectiveTransform</span><span class="p">(</span>
  <span class="nx">name</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span><span class="p">,</span>
  <span class="nx">fn</span>: <span class="kt">StructuralDirectiveTransform</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">NodeTransform</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{}</span> <span class="kr">as</span> <span class="kt">any</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
fc6f1f1 add transform function
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fc6f1f112ae0e98b7e2e9a432d3dca1d6420307a">feat: transform function Â· gcclll/stb-vue-next@fc6f1f1</a></p>
<ol>
<li>
<p>create transform context</p>
</li>
<li>
<p>traverse nodes, é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ„é€ å™¨ codegenNode</p>
</li>
<li>
<p>hoist static, é™æ€èŠ‚ç‚¹æå‡ï¼Œå¤ç”¨</p>
</li>
<li>
<p>ssr render, ä¸éœ€è¦åˆ›å»ºæ ¹èŠ‚ç‚¹ codegenNode</p>
</li>
<li>
<p>å¤åˆ¶ context å±æ€§åˆ° -&gt; root</p>
</li>
</ol>
<p>
<img src="http://qiniu.ii6g.com/img/20201130231832.png" alt="http://qiniu.ii6g.com/img/20201130231832.png" title="http://qiniu.ii6g.com/img/20201130231832.png" /></p>
<p>
transform ä½œç”¨å°±æ˜¯é€šè¿‡ <code>traverseNode()</code> é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè§£æï¼Œæ„é€ å¯¹åº”çš„èŠ‚ç‚¹
codegenNode ã€‚</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
b0d72da add compile.ts&gt;compile()
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b0d72dac2738fd270b0ea7fe0bb33f47597a233b">feat(add): compile function Â· gcclll/stb-vue-next@b0d72da</a></p>
<p>
å¯¹å¤–çš„ compile å‡½æ•°ï¼Œæ‰§è¡Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>
<p>ast(<code>baseParse()</code>) -&gt; è§£æå‡º ast ç»“æ„</p>
</li>
<li>
<p>transform(<code>transform()</code>) -&gt; è§£æ ast å¾—åˆ° codegenNode</p>
</li>
<li>
<p>codegen(<code>generate()</code>) -&gt; å°† codegenNode è§£ææˆ Render å‡½æ•°</p>
</li>
</ul>
<p>
è¿™æ˜¯åé¢æµ‹è¯•çš„åŸºç¡€ï¼Œæ‰€ä»¥å¾—æå‰å®ç°äº†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">baseCompile</span><span class="p">(</span>
  <span class="nx">template</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nx">RootNode</span><span class="p">,</span>
  <span class="nx">options</span>: <span class="kt">CompilerOptions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">CodegenResult</span> <span class="p">{</span>
  <span class="c1">// const onError = options.onError || defaultOnError
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">isModuleMode</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;module&#39;</span>

  <span class="kr">const</span> <span class="nx">prefixIdentifiers</span> <span class="o">=</span>
    <span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">prefixIdentifiers</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">isModuleMode</span><span class="p">)</span>

  <span class="c1">// TODO errors
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="o">?</span> <span class="nx">baseParse</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">:</span> <span class="nx">template</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">nodeTransforms</span><span class="p">,</span> <span class="nx">directiveTransforms</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getBaseTransformPreset</span><span class="p">(</span>
    <span class="nx">prefixIdentifiers</span>
  <span class="p">)</span>

  <span class="nx">transform</span><span class="p">(</span>
    <span class="nx">ast</span><span class="p">,</span>
    <span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">prefixIdentifiers</span><span class="p">,</span>
      <span class="nx">nodeTransforms</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">...</span><span class="nx">nodeTransforms</span><span class="p">,</span>
        <span class="p">...(</span><span class="nx">options</span><span class="p">.</span><span class="nx">nodeTransforms</span> <span class="o">||</span> <span class="p">[])</span> <span class="c1">// user transforms
</span><span class="c1"></span>      <span class="p">],</span>
      <span class="nx">directiveTransforms</span>: <span class="kt">extend</span><span class="p">(</span>
        <span class="p">{},</span>
        <span class="nx">directiveTransforms</span><span class="p">,</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">directiveTransforms</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="p">)</span>
    <span class="p">})</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="nx">generate</span><span class="p">(</span>
    <span class="nx">ast</span><span class="p">,</span>
    <span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">prefixIdentifiers</span>
    <span class="p">})</span>
  <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
35248ce add exports maybe needs
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/35248ceece1aa8650b65f7f7ce13612660a65397">feat(add): compiler-core exports Â· gcclll/stb-vue-next@35248ce</a></p>
<p>
å¢åŠ  compiler-core æ¨¡å—çš„å¯¼å‡º(<code>export</code>)å†…å®¹</p>
</div>
</div>
<div id="outline-container-pure-text" class="outline-2">
<h2 id="pure-text">
05a223b add transform pure text
</h2>
<div id="outline-text-pure-text" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/05a223b7b1eb2ab877aec3b11feace484a7dde82">feat(add): transform pure text Â· gcclll/stb-vue-next@05a223b</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseNode</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">RootNode</span> <span class="o">|</span> <span class="nx">TemplateChildNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ä¿å­˜å½“å‰è¢«å¤„ç†çš„ èŠ‚ç‚¹
</span><span class="c1"></span>  <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">node</span>
  <span class="c1">// åº”ç”¨ transform æ’ä»¶
</span><span class="c1"></span>  <span class="kr">const</span> <span class="p">{</span> <span class="nx">nodeTransforms</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
  <span class="c1">// é’ˆå¯¹æ¯ä¸ªèŠ‚ç‚¹ä¼šæ”¶é›†åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª transformXxx å‡½æ•°ï¼Œç”¨æ¥è§£æå®ƒçš„ ast
</span><span class="c1"></span>  <span class="c1">// å¾—åˆ° codegenNode ï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨å½“å‰çš„èŠ‚ç‚¹æ ‘è¢«é€’å½’éå†å®Œä¹‹åè°ƒç”¨
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">exitFns</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nodeTransforms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">onExit</span> <span class="o">=</span> <span class="nx">nodeTransforms</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">onExit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">onExit</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">exitFns</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">onExit</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">exitFns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onExit</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// èŠ‚ç‚¹å¯èƒ½è¢«åˆ é™¤äº†ï¼Œæ¯”å¦‚ï¼š v-else-if, v-else ä¼šåˆå¹¶åˆ° v-if çš„ branches[] ä¸­
</span><span class="c1"></span>      <span class="k">return</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// èŠ‚ç‚¹å¯èƒ½ä¼šæ›¿æ¢äº†ï¼Œéœ€è¦æ›´æ–°
</span><span class="c1"></span>      <span class="nx">node</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">switch</span> <span class="p">(</span>
    <span class="nx">node</span><span class="p">.</span><span class="kr">type</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">node</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">exitFns</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exitFns</span><span class="p">[</span><span class="nx">i</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
transform é˜¶æ®µä»£ç æ¯•ç«Ÿçš„ä¸‰ä¸ªé˜¶æ®µ</p>
<ol>
<li>
<p>æ”¶é›† transformXxx å‡½æ•°åˆ° exitFns</p>
</li>
<li>
<p>æ ¹æ® astèŠ‚ç‚¹ç±»å‹é€’å½’éå†å­å­™èŠ‚ç‚¹</p>
</li>
<li>
<p>æŒ‰ç…§æ”¶é›†æ—¶ç›¸åçš„é¡ºåºæ‰§è¡Œ exitFnsï¼Œè§£æå‡º codegenNode</p>
</li>
</ol>
<p>
ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ <code>generate()</code> ä¸­ç›´æ¥è¿”å› ast :
<a href="https://github.com/gcclll/stb-vue-next/commit/999d8d6b611443f8fd04282786d4a67f018d6319">test: generate return ast for test Â· gcclll/stb-vue-next@999d8d6</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS:</p>
<pre class="example">
{
  type: 2,
  content: &#39;pure text&#39;,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: &#39;pure text&#39;
  }
}
</pre>
<p>
ç»“æœæ˜¾ç¤ºå¹¶æ²¡æœ‰ codegenNode å› ä¸ºåœ¨transformText ä¸­æ»¡è¶³æ¡ä»¶</p>
<p>
<code>children.length === 1 &amp;&amp; node.type === NodeTypes.ROOT</code> è€Œç›´æ¥é€€å‡ºäº†ã€‚</p>
<p>
è‡³äº <code>root.codegenNode = undefined</code> éœ€è¦å®ç° <code>createRootCodegen()</code></p>
<div id="outline-container-headline-8" class="outline-4">
<h4 id="headline-8">
61ce406 add createRootCodegen() to create root.codegenNode
</h4>
<div id="outline-text-headline-8" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/61ce4066c9b49e11399da0b499220f426da444a0">feat: createRootCodegen() for pure text Â· gcclll/stb-vue-next@61ce406</a></p>
<p>
åªå¢åŠ äº†é’ˆå¯¹é ELEMENT ç±»å‹æˆ–è€…å­©å­èŠ‚ç‚¹æ²¡æœ‰ codegenNode çš„æƒ…å†µå®ç°(å½“å‰ commit
æœ€ç®€åŒ–)ã€‚</p>
<p>
å½“ root.children åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è‡ªå·±çš„ codegenNode æ—¶å€™ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createRootCodegen</span><span class="p">(</span><span class="nx">root</span>: <span class="kt">RootNode</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">TransformContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// const { helper } = context
</span><span class="c1"></span>  <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">root</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œç›´æ¥å–è¯¥å­©å­èŠ‚ç‚¹ çš„ codegenNode
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isSingleElementRoot</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// å½“ root èŠ‚ç‚¹ä¸‹åªæœ‰ä¸€ä¸ª element å…ƒç´ çš„å­©å­èŠ‚ç‚¹æ—¶ï¼Œä¸è¿›è¡Œæå‡
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// - single &lt;slot/&gt;, IfNode, ForNode: already blocks.
</span><span class="c1"></span>      <span class="c1">// - single text node: always patched.
</span><span class="c1"></span>      <span class="c1">// root codegen falls through via genNode()
</span><span class="c1"></span>
      <span class="nx">root</span><span class="p">.</span><span class="nx">codegenNode</span> <span class="o">=</span> <span class="nx">child</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// no children = noop, codegen will return null.
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 0,
  children: [ { type: 2, content: &#39;pure text&#39;, loc: [Object] } ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 2,
    content: &#39;pure text&#39;,
    loc: { start: [Object], end: [Object], source: &#39;pure text&#39; }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: &#39;pure text&#39;
  }
}
</pre>
<p>
æ³¨æ„ codegenNode å…¶å®å°±æ˜¯ <code>root.children[0]</code> èŠ‚ç‚¹æœ¬èº«ã€‚</p>
</div>
</div>
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
b9f3cb7 add transform text
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/b9f3cb762e36e7f7090987db9cba77948845cdaf">feat: transformText function Â· gcclll/stb-vue-next@b9f3cb7</a></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201130150054.png" alt="http://qiniu.ii6g.com/img/20201130150054.png" title="http://qiniu.ii6g.com/img/20201130150054.png" /></p>
<ol>
<li>
<p>å¿…é¡»æ˜¯æ–‡æœ¬èŠ‚ç‚¹æˆ–è€…ç±»å‹æ˜¯ç»„åˆè¡¨è¾¾å¼ç±»å‹(<code>COMPOUND_EXPRESSION</code>)</p>
</li>
<li>
<p>patch flag å¤„ç†</p>
</li>
<li>
<p>æ„é€  TEXT_CALL ç±»å‹èŠ‚ç‚¹</p>
</li>
<li>
<p>codegenNode -&gt; createCallExpression</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-10" class="outline-4">
<h4 id="headline-10">
f6d5271 add generate text codegen
</h4>
<div id="outline-text-headline-10" class="outline-text-4">
<p>
codegen é˜¶æ®µç›®çš„æ˜¯å°† codegenNode è§£ææˆ Render å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚</p>
<ol>
<li>
<p><em>f6d5271</em> add <code>createCodegenContext()</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f6d52713ae8154d438c2ed94641525fa3c05edef">feat(add): codegen context creator Â· gcclll/stb-vue-next@f6d5271</a></p>
<p>
ä¸Šä¸‹æ–‡å¯¹è±¡åˆ›å»ºå‡½æ•°ï¼Œé‡ç‚¹æ–¹æ³•æœ‰ä¸¤ä¸ª(<code>push(code, node)</code> å’Œ <code>helper(key)</code>)ã€‚</p>
<p>
FIX1: lint errors, <a href="https://github.com/gcclll/stb-vue-next/commit/0ac8c2f4b6b5022caa0f83a7f850226c30a99d33">fix: f6d5271 lint errors Â· gcclll/stb-vue-next@0ac8c2f</a></p>
</li>
<li>
<p><em>2ef2699</em> å¢åŠ  text codegen generator å®ç°</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2ef2699b95457be4456b736b70467b98bf240ddd">feat: generate text codegen Â· gcclll/stb-vue-next@2ef2699</a></p>
<p>
è¯¥éƒ¨åˆ†æ¶‰åŠåˆ°ä¸€ä¸ªè¾ƒä¸ºå®Œæ•´çš„ codegen generator æµç¨‹ï¼Œæ‰€ä»¥å¢åŠ å†…å®¹è¾ƒå¤šï¼Œå› æ­¤è¿™é‡Œ
ä¸ç›´æ¥è´´ä»£ç äº†ï¼Œè¯·ç‚¹å‡»ä¸Šé¢ commit é“¾æ¥æŸ¥çœ‹å®é™…å¢åŠ çš„æºç ã€‚</p>
<p>
å¤„ç†æµç¨‹ï¼š</p>
<ul>
<li>
<p>preamble å¤„ç†ï¼Œå¦‚æœæ˜¯ Node ç¯å¢ƒéœ€è¦é€šè¿‡ <code>import { ...} from &#39;vue&#39;</code> è¯­æ³•ï¼Œå¦‚
æœæ˜¯æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ <code>const { ... } = Vue</code> è§£æ„è¯­æ³•ã€‚</p>
</li>
<li>
<p>æ˜¯å¦ä½¿ç”¨ <code>with() {}</code> ä½œç”¨åŸŸè¯­æ³•ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨çš„</p>
</li>
<li>
<p><code>return ...</code> è¿”å›å®é™… render å‡½æ•°è¿”å›ç»“æœï¼Œè¿™é‡Œå°†è¿”å›æœ€åè¢«æ¸²æŸ“çš„ DOM ç»“æ„ã€‚</p>
</li>
<li>
<p><code>genNode()</code> é€’å½’å¤„ç† ast ç”Ÿæˆ render å‡½æ•°çš„å¯¹åº”éƒ¨åˆ†ä»£ç </p>
</li>
</ul>
</li>
<li>
<p><em>6b901f9</em> å¢åŠ  node ç¯å¢ƒæˆ– module ç¯å¢ƒå¤„ç†(<code>genModulePreamble</code>)</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6b901f9f3d8af3dc415d31a6c5027d8e262fa74f">feat: module preamble Â· gcclll/stb-vue-next@6b901f9</a>
modue preamble : <code>export { ... } from &#39;vue&#39;</code>
function preamble: <code>const { ... } = Vue</code></p>
</li>
</ol>
<p>
é‡ç‚¹å¢åŠ çš„ genXxx å‡½æ•° <code>genText(node, context)</code> ä¸“é—¨ç”¨æ¥å¤„ç†æ–‡æœ¬èŠ‚ç‚¹çš„ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genText</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">TextNode</span> <span class="o">|</span> <span class="nx">SimpleExpressionNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">),</span> <span class="nx">node</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
æµ‹è¯•
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<p>
æµ‹è¯•å°†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œ</p>
<div id="outline-container-headline-12" class="outline-5">
<h5 id="headline-12">
function preamble å½¢å¼(ä½œä¸ºå…¨å±€ <code>Vue</code> å¯¹è±¡å¼•å…¥)
</h5>
<div id="outline-text-headline-12" class="outline-text-5">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

return function render(_ctx, _cache) {
  with (_ctx) {
    return &#34;pure text&#34;
  }
}
undefined
</pre>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6b3bd2e4c20dc7a325ff7c0575c127595da91b42">fix: less the last } paren Â· gcclll/stb-vue-next@6b3bd2e</a></p>
</div>
</div>
<div id="outline-container-headline-13" class="outline-5">
<h5 id="headline-13">
module preamble å½¢å¼(<strong>es6</strong> æ¨¡å—åŒ–å¯¼å‡ºå¯¼å…¥)
</h5>
<div id="outline-text-headline-13" class="outline-text-5">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`pure text`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">

return function render(_ctx, _cache) {
  return &#34;pure text&#34;
}
undefined
</pre>
<p>
è¿™é‡Œå¥½åƒçœ‹ä¸å‡ºå•¥åŒºåˆ«ï¼Œåé¢å†è¯´å§ã€‚</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-interpolation" class="outline-2">
<h2 id="interpolation">
2f749b2 add interpolation generator
</h2>
<div id="outline-text-interpolation" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2f749b2a5d0872713704a52943bb18b550c559c0">feat(add): transform -&gt; generate interpolation Â· gcclll/stb-vue-next@2f749b2</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`{{ a &gt; b }}`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œå®ç°åˆ†å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<p>
<strong>transform</strong>: traverseNode() å¢åŠ å¯¹æ’å€¼çš„å¤„ç†ï¼Œåé¢å¢åŠ äº† traverseChildren å¤„ç†ï¼Œå› ä¸ºæ‰€æœ‰çš„
ast éƒ½æ˜¯æŒ‚åœ¨ <code>root.children</code> ä¸­çš„ï¼Œæ‰€ä»¥æœ€å¼€å§‹è§£æçš„æ˜¯ <code>ROOT</code> èŠ‚ç‚¹ï¼Œå› æ­¤è¿™é‡Œå¿…é¡»
è¦å¢åŠ  <code>ROOT</code> ç±»å‹çš„è§£æï¼Œè°ƒç”¨ <code>traverseChildren(node, ctx)</code> å»é€’å½’è§£æ <code>root.children</code></p>
<blockquote>
<p>transform() -&gt; traverseNode(): ROOT è§£æ -&gt; traverseChildren() -&gt;
traverseNode(): INTERPOLATION</p>
</blockquote>
<p>
æ–°å¢æ ¸å¿ƒå‡½æ•°ï¼šéå†æ‰€æœ‰ <code>children[]</code> è°ƒç”¨ <code>traverseNode()</code> </p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">traverseChildren</span><span class="p">(</span>
  <span class="nx">parent</span>: <span class="kt">ParentNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO	  let i = 0
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">nodeRemoved</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">i</span><span class="o">--</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span> <span class="k">continue</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">childIndex</span> <span class="o">=</span> <span class="nx">i</span> <span class="c1">// æ–¹ä¾¿åœ¨ transformXxx å‡½æ•°ä¸­èƒ½å¿«é€Ÿå®šä½åˆ°å½“å‰èŠ‚ç‚¹
</span><span class="c1"></span>    <span class="nx">context</span><span class="p">.</span><span class="nx">onNodeRemoved</span> <span class="o">=</span> <span class="nx">nodeRemoved</span>
    <span class="nx">traverseNode</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<img src="http://qiniu.ii6g.com/img/20201201155917.png" alt="http://qiniu.ii6g.com/img/20201201155917.png" title="http://qiniu.ii6g.com/img/20201201155917.png" /></p>
<p>
<strong>codegen</strong>: <code>genNode()</code> ä¸­æ–°å¢ <code>INTERPOLATION</code> å’Œ <code>SIMPLE_EXPRESSION</code> ç±»å‹çš„å¤„ç†ï¼Œ
 å› ä¸º INTERPOLATION çš„ ast.content(å¦‚ä¸Šé¢ä»£ç æ‰§è¡Œç»“æœ) ç±»å‹æ˜¯ SIMPLE_EXPRESSIONã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genExpression</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">SimpleExpressionNode</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
 <span class="kr">const</span> <span class="p">{</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">isStatic</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">node</span>
 <span class="nx">context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">isStatic</span> <span class="o">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">:</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">genInterpolation</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">InterpolationNode</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
 <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">pure</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">pure</span><span class="p">)</span> <span class="nx">push</span><span class="p">(</span><span class="nx">PURE_ANNOTATION</span><span class="p">)</span>
 <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">TO_DISPLAY_STRING</span><span class="p">)</span><span class="si">}</span><span class="sb">(`</span><span class="p">)</span>
 <span class="nx">genNode</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
 <span class="nx">push</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<hr>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2d0e2a6f7610059f37aef798d37eaafdf8c43377">feat(add): comment generator Â· gcclll/stb-vue-next@2d0e2a6</a></p>
<p>
æ‹“å±•ï¼šadd comment generator</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;!-- i&#39;m a comment --&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createCommentVNode : _createCommentVNode } = _Vue

    return _createCommentVNode(&#34; i&#39;m a comment &#34;)
  }
}
undefined
</pre>
</div>
</div>
<div id="outline-container-element" class="outline-2">
<h2 id="element">
add element transfrom and generator
</h2>
<div id="outline-text-element" class="outline-text-2">
<div id="outline-container-headline-16" class="outline-3">
<h3 id="headline-16">
å‡†å¤‡å·¥ä½œ <code>compiler-core/src/utils.ts</code>
</h3>
<div id="outline-text-headline-16" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9436d8fe155767391a278807ae02a6ae9eff94a3">feat: utils for compiler-core Â· gcclll/stb-vue-next@9436d8f</a></p>
<p>
ç›¸å…³æ­£åˆ™ï¼š <code>const memberExpRE = /^[A-Za-z_$][\w$]*(?:\s*\.\s*[A-Za-z_$][\w$]*|\[[^\]]+\])*$/</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/image.png" alt="http://qiniu.ii6g.com/img/image.png" title="http://qiniu.ii6g.com/img/image.png" /></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2265e466e6daea95614d5fe96968b30ff11a2e19">feat(add): resolveComponentType Â· gcclll/stb-vue-next@2265e46</a></p>
<p>
è§£æå‡ºç»„ä»¶çš„ç±»å‹ï¼Œå¤§ä½“åˆ†ä¸ºå››ç±»ï¼š</p>
<ol>
<li>
<p>åŠ¨æ€ç»„ä»¶ï¼š <code>&lt;component is=&#34;xx&#34;&gt;</code> æˆ– <code>&lt;component v-is=&#34;xx&#34;&gt;</code></p>
</li>
<li>
<p>å†…ç½®ç»„ä»¶ï¼š <code>Teleport, Transition, KeepAlive, Suspense</code></p>
</li>
<li>
<p>ç”¨æˆ·ç»„ä»¶ï¼š <code>$setup[]</code> ä¸Šçš„ç»„ä»¶</p>
</li>
<li>
<p>ç”¨æˆ·ç»„ä»¶ï¼š <code>context.components[]</code> ä¸Šçš„ç»„ä»¶</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-element-transform" class="outline-3">
<h3 id="element-transform">
87339d2 add element transform
</h3>
<div id="outline-text-element-transform" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/87339d25f1fa43ed5e0a13dabc60fec9479451c1">feat(add): transformElement function Â· gcclll/stb-vue-next@87339d2</a></p>
<p>
æ™®é€šæ ‡ç­¾çš„ transform codegenNodeé˜¶æ®µã€‚</p>
<ol>
<li>
<p>add <code>createVNodeCall()</code> å‡½æ•°ï¼Œåˆ›å»ºåŸºæœ¬çš„ ELEMENT ç±»å‹èŠ‚ç‚¹ codegenNode</p>
<p>
æ ¹æ® <code>isBlock</code> å‚æ•°å†³å®šä½¿ç”¨ BLOCK å‡½æ•°è¿˜æ˜¯ VNODE å‡½æ•°ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">createVNodeCall</span><span class="p">(</span>
     <span class="nx">context</span>: <span class="kt">TransformContext</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
     <span class="nx">tag</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">],</span>
     <span class="nx">props?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;props&#39;</span><span class="p">],</span>
     <span class="nx">children?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">],</span>
     <span class="nx">patchFlag?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;patchFlag&#39;</span><span class="p">],</span>
     <span class="nx">dynamicProps?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;dynamicProps&#39;</span><span class="p">],</span>
     <span class="nx">directives?</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;directives&#39;</span><span class="p">],</span>
     <span class="nx">isBlock</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;isBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">disableTracking</span>: <span class="kt">VNodeCall</span><span class="p">[</span><span class="s1">&#39;disableTracking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">loc</span> <span class="o">=</span> <span class="nx">locStub</span>
 <span class="p">)</span><span class="o">:</span> <span class="nx">VNodeCall</span> <span class="p">{</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">isBlock</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">OPEN_BLOCK</span><span class="p">)</span>
         <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">CREATE_BLOCK</span><span class="p">)</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">CREATE_VNODE</span><span class="p">)</span>
     <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">return</span> <span class="p">{</span>
     <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">VNODE_CALL</span><span class="p">,</span>
     <span class="nx">tag</span><span class="p">,</span>
     <span class="nx">props</span><span class="p">,</span>
     <span class="nx">children</span><span class="p">,</span>
     <span class="nx">patchFlag</span><span class="p">,</span>
     <span class="nx">dynamicProps</span><span class="p">,</span>
     <span class="nx">directives</span><span class="p">,</span>
     <span class="nx">isBlock</span><span class="p">,</span>
     <span class="nx">disableTracking</span><span class="p">,</span>
     <span class="nx">loc</span>
 <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>add <code>createObjectExpression()</code> å‡½æ•°</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">export</span> <span class="kd">function</span> <span class="nx">createObjectExpression</span><span class="p">(</span>
     <span class="nx">properties</span>: <span class="kt">ObjectExpression</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">],</span>
     <span class="nx">loc</span>: <span class="kt">SourceLocation</span> <span class="o">=</span> <span class="nx">locStub</span>
 <span class="p">)</span><span class="o">:</span> <span class="nx">ObjectExpression</span> <span class="p">{</span>
 <span class="k">return</span> <span class="p">{</span>
     <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_OBJECT_EXPRESSION</span><span class="p">,</span>
     <span class="nx">loc</span><span class="p">,</span>
     <span class="nx">properties</span>
 <span class="p">}</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>add <code>getStaticType()</code> åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦åšé™æ€æå‡å¤„ç†</p>
</li>
<li>
<p>add <code>transformElement: postTransformElement()</code> å‡½æ•°</p>
</li>
<li>
<p>add <code>stringifyDynamicPropNames()</code> å°†å±æ€§è½¬æˆæ•°ç»„ç»“æ„</p>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;root codegenNode: &#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
root codegenNode:  undefined
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode } = _Vue

    return null
  }
}
undefined
</pre>
<p>
æ­£ç¡®ç»“æœï¼š</p>
<pre class="example">
Æ’ render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;))
  }
}
</pre>
<p>
é—®é¢˜ï¼š</p>
<ol>
<li>
<p>æ ¹èŠ‚ç‚¹ codegenNode ä¸ºç©º</p>
</li>
<li>
<p>render å‡½æ•°å†…æ²¡æœ‰ <code>openBlock, createBlock</code> å¯¼å‡º</p>
</li>
<li>
<p>return åé¢æ²¡å†…å®¹(è¿™æ˜¯ generator èŒƒç•´ï¼Œæ­¤èŠ‚ä¸å±•å¼€)</p>
</li>
</ol>
<p>
é—®é¢˜1ï¼Œ2éƒ½æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹å¤„ç†çš„ï¼Œå› ä¸ºå½“ ROOT èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸ä¼šç”¨
CREATE_VNODE åˆ›å»ºï¼Œè€Œæ˜¯æ”¹ç”¨ CREATE_BLOCKï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªé—®é¢˜ä¸€èµ·å¤„ç†</p>
<p>
FIX 1,2: <a href="https://github.com/gcclll/stb-vue-next/commit/97cf290240fa937f167f8aadd6e6527744da4cbe">fix: no export open/create block function from Vue Â· gcclll/stb-vue-next@97cf290</a></p>
<p>
ä¿®æ”¹ï¼š <code>createRootCodegen(root: RootNode, context: TransformContext)</code></p>
</div>
</div>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
2f58786 add element generator
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2f58786c56986672c6b7cabdcd541363bf05b4dd">feat: element generator Â· gcclll/stb-vue-next@2f58786</a></p>
<p>
è·¯å¾„ï¼š</p>
<ol>
<li>
<p><code>VNODE_CALL</code> -&gt;</p>
</li>
<li>
<p><code>genVNodeCall()</code> -&gt;</p>
</li>
<li>
<p><code>genNodeList([], ctx)</code> -&gt;</p>
<ul>
<li>
<p>string: <code>push(node)</code></p>
</li>
<li>
<p>array: <code>genNodeListAsArray(node, ctx)</code> </p>
</li>
<li>
<p>other: <code>genNode(node, ctx)</code></p>
</li>
</ul>
</li>
</ol>
<p>
æµ‹è¯•:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;root codegenNode: &#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
root codegenNode:  {
  type: 13,
  tag: &#39;&#34;div&#34;&#39;,
  props: undefined,
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 12, line: 1, offset: 11 },
    source: &#39;&lt;div&gt;&lt;/div&gt;&#39;
  }
}
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;))
  }
}
</pre>
</div>
</div>
<div id="outline-container-headline-19" class="outline-3">
<h3 id="headline-19">
05ca2f8 root.children æœ‰å¤šä¸ªå­©å­
</h3>
<div id="outline-text-headline-19" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/05ca2f8bedf21d146a01ad5694c727bbe776145c">feat: root.children has multi child Â· gcclll/stb-vue-next@05ca2f8 Â· GitHub</a></p>
<p>
å½“æœ‰å¤šä¸ªå­©å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ª <code>fragment</code> å°†ä»–ä»¬åŒ…èµ·æ¥ã€‚</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201201232048.png" alt="http://qiniu.ii6g.com/img/20201201232048.png" title="http://qiniu.ii6g.com/img/20201201232048.png" /></p>
<p>
FIX: æ­»å¾ªç¯ï¼Œ <code>genNode(node.codegenNode, ctx)</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201201232120.png" alt="http://qiniu.ii6g.com/img/20201201232120.png" title="http://qiniu.ii6g.com/img/20201201232120.png" /></p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment,null,[
      _createVNode(&#34;div&#34;),
      _createVNode(&#34;div&#34;)
    ],64 /* STABLE_FRAGMENT */))
  }
}
undefined
</pre>
<p>
FIX: å‚æ•°ä¹‹é—´å°‘äº†ç©ºæ ¼(<a href="https://github.com/gcclll/stb-vue-next/commit/05ca2f8bedf21d146a01ad5694c727bbe776145c?branch=05ca2f8bedf21d146a01ad5694c727bbe776145c&amp;diff=split">feat: root.children has multi child Â· gcclll/stb-vue-next@05ca2f8</a>)</p>
<p>
æ­£è§£ï¼š</p>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, Fragment: _Fragment, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment, null, [
      _hoisted_1,
      _hoisted_2
    ], 64 /* STABLE_FRAGMENT */))
  }
}
</pre>
<p>
æ­£ç¡®ç­”æ¡ˆä¸­åšäº†é™æ€æå‡å¤„ç†ï¼Œä»£ç åœ¨ <code>transform()</code> å‡½æ•°ä¸­ <code>hoistStatic(root,
context)</code> çš„è°ƒç”¨ï¼Œä¼šä» ROOT èŠ‚ç‚¹å¼€å§‹éå†ï¼Œå°†éœ€è¦æå‡çš„èŠ‚ç‚¹è¿›è¡Œæå‡å¤„ç†ã€‚</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-20" class="outline-2">
<h2 id="headline-20">
7cb3dbf add hoist static é™æ€æå‡
</h2>
<div id="outline-text-headline-20" class="outline-text-2">
<p>
æ»¡è¶³æå‡çš„ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>
<p>tag å’Œ tagType éƒ½æ˜¯ ELEMENT ä¸”æ•´æ£µæ ‘éƒ½æ˜¯é™æ€</p>
</li>
<li>
<p>åŒ…å«åŠ¨æ€å­©å­èŠ‚ç‚¹ï¼Œä½†æ˜¯æœ‰é™æ€å±æ€§çš„ï¼Œå°†å±æ€§æå‡</p>
</li>
<li>
<p>çº¯æ–‡æœ¬èŠ‚ç‚¹</p>
</li>
</ol>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7d7dbd4e20198e73df5c93804dce122656252c8f">feat(add): hoist static Â· gcclll/stb-vue-next@7d7dbd4</a></p>
<p>
transform() ä¸­å¢åŠ é™æ€æå‡å¤„ç†ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">hoistStatic</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">hoistStatic</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7cb3dbf94bd17c5af68dc55103a8031da28be55b">feat: hoist static Â· gcclll/stb-vue-next@7cb3dbf</a></p>
<ol>
<li>
<p>ä¿®æ”¹ <code>genFunctionPreamble(ast: RootNode, context: CodegenContext)</code> è§£æ„å‡ºéœ€è¦ç”¨åˆ°çš„å‡½æ•°(<code>_createVNode</code>)</p>
<p>
<img src="/img/commit/diff-hoist-decon-functions.png" alt="/img/commit/diff-hoist-decon-functions.png" title="/img/commit/diff-hoist-decon-functions.png" /></p>
</li>
<li>
<p>å¢åŠ  <code>genHoists()</code> å‡½æ•°ï¼Œç”Ÿæˆ <code>ast.hoists</code> ä¸­éœ€è¦æå‡çš„èŠ‚ç‚¹</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genHoists</span><span class="p">(</span><span class="nx">hoists</span><span class="o">:</span> <span class="p">(</span><span class="nx">JSChildNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)[],</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hoists</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="nx">context</span><span class="p">.</span><span class="nx">pure</span> <span class="o">=</span> <span class="kc">true</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">newline</span><span class="p">,</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">scopeId</span><span class="p">,</span> <span class="nx">mode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
<span class="kr">const</span> <span class="nx">genScopeId</span> <span class="o">=</span> <span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="nx">scopeId</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">mode</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span>
<span class="nx">newline</span><span class="p">()</span>

<span class="c1">// push scope Id before initializing hoisted vnodes so that these vnodes
</span><span class="c1">// get the proper scopeId as well.
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">genScopeId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">PUSH_SCOPE_ID</span><span class="p">)</span><span class="si">}</span><span class="sb">(&#34;</span><span class="si">${</span><span class="nx">scopeId</span><span class="si">}</span><span class="sb">&#34;)`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">hoists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`const _hoisted_</span><span class="si">${</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="sb"> = `</span><span class="p">)</span>
    <span class="nx">genNode</span><span class="p">(</span><span class="nx">exp</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">genScopeId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">POP_SCOPE_ID</span><span class="p">)</span><span class="si">}</span><span class="sb">()`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">context</span><span class="p">.</span><span class="nx">pure</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment, null, [
      _hoisted_1,
      _hoisted_2
    ], 64 /* STABLE_FRAGMENT */))
  }
}
undefined
</pre>
<blockquote>
<p>PS: é™æ€å±æ€§æå‡ <a href="https://github.com/gcclll/stb-vue-next/commit/1e58eeb605b0dc88c90dac550b927f89dd18e07d">feat: props hoist static Â· gcclll/stb-vue-next@1e58eeb</a></p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-21" class="outline-2">
<h2 id="headline-21">
prop transform and generator
</h2>
<div id="outline-text-headline-21" class="outline-text-2">
<p>
åœ¨è¿™ä¹‹å‰æˆ‘ä»¬å®Œæˆäº†ä»¥ä¸‹å‡ ä¸ªåŸºæœ¬éƒ¨åˆ†ï¼š</p>
<ul>
<li>
<p><a href="#pure-text">æ–‡æœ¬</a></p>
</li>
<li>
<p><a href="#interpolation">æ’å€¼</a></p>
</li>
<li>
<p><a href="#element">æ™®é€šæ ‡ç­¾(ä¸€ä¸ªå’Œå¤šä¸ª)</a></p>
</li>
</ul>
<p>
æ¥ä¸‹æ¥éœ€è¦å®Œæˆå±æ€§çš„è§£ææ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå› ä¸º <code>v-if, v-for, v-slot, ...</code> éƒ½éœ€è¦å±
æ€§è§£æã€‚</p>
<p>
å±æ€§è½¬æ¢è¿™é‡Œå¼‚å¸¸å¤æ‚ï¼Œéœ€è¦æ…¢æ…¢å±•å¼€æ¥è®²ï¼Œå¹¶ä¸”æ¶‰åŠåˆ°å„ç§æŒ‡ä»¤ï¼Œå› æ­¤å¯¹äºå®Œæ•´çš„æµ‹è¯•éœ€
è¦ç­‰æ‰€æœ‰æŒ‡ä»¤ transform å®Œæˆä¹‹åå†è¿›è¡Œã€‚</p>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
1792f93 props transform
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<div id="outline-container-headline-23" class="outline-4">
<h4 id="headline-23">
buildProps
</h4>
<div id="outline-text-headline-23" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1792f93b26aff5d0db60d83b946a83fb0fa6e776">feat(add): transform props Â· gcclll/stb-vue-next@1792f93</a></p>
<ul>
<li>
<p>å°† <code>codegenNode.props</code> æ„å»ºæˆ å¦‚ä¸‹ç»“æ„ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span>
  <span class="nt">&#34;properties&#34;</span><span class="p">:[</span>
      <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span>
          <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;class&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span>
          <span class="p">},</span>
          <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;second&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span>
          <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span>
          <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;onClick&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span>
          <span class="p">},</span>
          <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
              <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
              <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;clickHandle&#34;</span><span class="p">,</span>
              <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
              <span class="nt">&#34;isConstant&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>v-bind,v-on æŒ‡ä»¤ï¼Œæ²¡æœ‰å‚æ•°ï¼Œéœ€è¦å°† props åˆå¹¶</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-24" class="outline-4">
<h4 id="headline-24">
transform props
</h4>
<div id="outline-text-headline-24" class="outline-text-4">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/20a5fa8bfefa9dd98a7965f78ff1f84de2591962">feat: transform props in codgenNode Â· gcclll/stb-vue-next@20a5fa8</a></p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-25" class="outline-3">
<h3 id="headline-25">
e4acc0d props generator
</h3>
<div id="outline-text-headline-25" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/e4acc0dd5e33ceab3420f9e5ca8857f090bb536c">feat: props generator Â· gcclll/stb-vue-next@e4acc0d</a></p>
<p>
ä¿®æ”¹ç‚¹ï¼š</p>
<ol>
<li>
<p>add <code>genExpressionAsPropertyKey()</code> ç”Ÿæˆå±æ€§ key å‡½æ•°</p>
<p>
ä¸‰ç§å¯èƒ½çš„å±æ€§å</p>
<ul>
<li>
<p>é™æ€å±æ€§å: <code>&lt;div class=&#34;value&#34;&gt;</code> -&gt; <code>{ class: &#34;value&#34; }</code></p>
</li>
<li>
<p>åŠ¨æ€å±æ€§å: <code>&lt;div :[propName]=&#34;value&#34;</code> -&gt; <code>{ [propName]: &#34;value&#34;}</code></p>
</li>
<li>
<p>ç»„åˆè¡¨è¾¾å¼å±æ€§åï¼šTODO</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// ç”Ÿæˆå¯¹è±¡çš„å±æ€§ key (å¯èƒ½æ˜¯é™æ€ï¼ŒåŠ¨æ€)
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">genExpressionAsPropertyKey</span><span class="p">(</span>
 <span class="nx">node</span>: <span class="kt">ExpressionNode</span><span class="p">,</span>
 <span class="nx">context</span>: <span class="kt">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
 <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
 <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMPOUND_EXPRESSION</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// TODO åŠ¨æ€å±æ€§åæˆ–è¡¨è¾¾å¼
</span><span class="c1"></span> <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">isStatic</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// only quote key if necessary
</span><span class="c1"></span>   <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">isSimpleIdentifier</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
     <span class="o">?</span> <span class="nx">node.content</span>
     : <span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

   <span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="nx">push</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">]`</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
 <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>add <code>genObjectExpression()</code> å°†å±æ€§åˆ—è¡¨ç”Ÿæˆå¯¹è±¡</p>
<p>
éå†èŠ‚ç‚¹çš„ <code>node.properties</code> å…ˆç”Ÿæˆ key(<code>genExpressionAsPropertyKey(key)</code>) å†ç”Ÿæˆ value(<code>genNode(value)</code>) ã€‚</p>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;first&#34; name=&#34;div&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = {
  class: &#34;first&#34;,
  name: &#34;div&#34;
}

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, _hoisted_1))
  }
}
undefined
</pre>
<blockquote>
<p>å®ä¾‹ä¸­æœ€åæ˜¯ç”¨çš„ <code>createBlock()</code> æ˜¯å› ä¸º root.children åªæœ‰ä¸€ä¸ª child ã€‚</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-26" class="outline-3">
<h3 id="headline-26">
static props
</h3>
<div id="outline-text-headline-26" class="outline-text-3">
<p>
ä¿®æ”¹å‡½æ•°ï¼š <code>transforms/transformElement</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;first&#34;&gt;&lt;/div&gt;&lt;div class=&#34;second&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">props</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 6,
  name: &#39;class&#39;,
  value: {
    type: 2,
    content: &#39;first&#39;,
    loc: { start: [Object], end: [Object], source: &#39;&#34;first&#34;&#39; }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 19, line: 1, offset: 18 },
    source: &#39;class=&#34;first&#34;&#39;
  }
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-27" class="outline-3">
<h3 id="headline-27">
6951dd1 merge props
</h3>
<div id="outline-text-headline-27" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6951dd1ff97da1ef803e97770162fe0293ef76cc">feat: merge props Â· gcclll/stb-vue-next@6951dd1</a></p>
<p>
åˆå¹¶å±æ€§çš„æ¡ä»¶ï¼šå­˜åœ¨æ²¡æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œå¦‚ï¼š <code>&lt;div v-bind=&#34;{...}&#34; v-on=&#34;{...}&#34;</code></p>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/12a66f0ebef241b282b4ccf746ddabc1a2f45ef1">fix: merge toHandlers props Â· gcclll/stb-vue-next@12a66f0</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">title</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; </span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>
 
<span class="nx">log</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;div class=&#34;first&#34; v-on=&#34;{ click: clickHandle  }&#34; v-bind=&#34;{ style: &#39;color:red&#39; }&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="s1">&#39;æ— å‚æ•°çš„æŒ‡ä»¤ï¼Œåˆå¹¶æ‰€æœ‰å±æ€§&#39;</span><span class="p">)</span>

<span class="nx">log</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;second&#34; v-on:click=&#34;clickHandle&#34; v-bind:style=&#34;color:red&#34;&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="s1">&#39;æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œä¸åˆå¹¶&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; æ— å‚æ•°çš„æŒ‡ä»¤ï¼Œåˆå¹¶æ‰€æœ‰å±æ€§
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toHandlers : _toHandlers, mergeProps : _mergeProps, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, _mergeProps({ class: &#34;first&#34; }, _toHandlers({ click: clickHandle  }), { style: &#39;color:red&#39; }), null, 16 /* FULL_PROPS */))
  }
}
&gt;&gt;&gt; æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œä¸åˆå¹¶
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock(&#34;div&#34;, { class: &#34;second&#34; }, null, 512 /* NEED_PATCH */)), )
  }
}
undefined
</pre>
<p>
æœ‰å‚æ•°æŒ‡ä»¤æ—¶ï¼Œéœ€è¦ç»“åˆ <code>v-on</code> æŒ‡ä»¤è§£æï¼Œå› æ­¤éœ€è¦å…ˆå®ç°äº† transform æŒ‡ä»¤æ‰èƒ½å¾—åˆ°ä¸‹é¢çš„æ­£ç¡®ç»“æœã€‚</p>
<p>
ä¸åˆå¹¶(<code>mergeProps()</code>) çš„æ­£è§£ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="kd">function</span> <span class="nx">anonymous</span><span class="p">(</span>
<span class="p">)</span> <span class="p">{</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">Vue</span> <span class="o">=</span> <span class="nx">Vue</span>

<span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">openBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="kr">class</span><span class="o">:</span> <span class="s2">&#34;second&#34;</span><span class="p">,</span>
      <span class="nx">onClick</span><span class="o">:</span> <span class="nx">clickHandle</span><span class="p">,</span>
      <span class="nx">style</span><span class="o">:</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span> <span class="p">}</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">12</span> <span class="cm">/* STYLE, PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;onClick&#34;</span><span class="p">]))</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ä¸‹é¢å°†ç»§ç»­å®ŒæˆæŒ‡ä»¤ç›¸å…³çš„ transform</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-28" class="outline-2">
<h2 id="headline-28">
6c43451 add v-on transform
</h2>
<div id="outline-text-headline-28" class="outline-text-2">
<p>
init: <a href="https://github.com/gcclll/stb-vue-next/commit/98dcc9653790a319c3bc04222322167db21546df">feat(init): v-on directive Â· gcclll/stb-vue-next@98dcc96</a></p>
<p>
å®ç°ï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/6c4345156ffc86542120bb97deb438097b36efca">feat: v-on directive transform Â· gcclll/stb-vue-next@6c43451</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div class=&#34;second&#34; v-on:click=&#34;clickHandle&#34; v-bind:style=&#34;color:red&#34;&gt;&lt;/div&gt;`</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock(&#34;div&#34;, {
      class: &#34;second&#34;,
      onClick: clickHandle
    }, null, 8 /* PROPS */, [&#34;onClick&#34;])), )
  }
}
undefined
</pre>
<p>
é—®é¢˜ï¼š <code>v-bind</code> æ²¡æœ‰è¢«è§£æå‡ºæ¥ã€‚</p>
<p>
å¦‚æœ v-onçš„ exp æ˜¯ä¸ªç®€å•çš„è¡¨è¾¾å¼ï¼Œéœ€è¦å°†å…¶è½¬æˆå‡½æ•° <code>$event =&gt; (i++)</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1542b412cef3a1c81e3099e52bb5f7aa1fee2abe">feat(add): v-on with simple expression as handler Â· gcclll/stb-vue-next@1542b41</a></p>
<p>
åˆ¤æ–­æ˜¯ç®€å•è¡¨è¾¾å¼çš„ä¾æ®ï¼š</p>
<p>
<code>const isInlineStatement = !(isMemberExp || fnExpRE.test(exp.content))</code></p>
<p>
å³ä¸æ˜¯ member expression ä¹Ÿä¸æ˜¯ function expression ã€‚</p>
<p>
member expression: <code>/^[A-Za-z_$][\w$]*(?:\s*\.\s*[A-Za-z_$][\w$]*|\[[^\]]+\])*$/</code>
<img src="http://qiniu.ii6g.com/img/20201212163019.png" alt="http://qiniu.ii6g.com/img/20201212163019.png" title="http://qiniu.ii6g.com/img/20201212163019.png" /></p>
<p>
function expresstion: <code>/^\s*([\w$_]+|\([^)]*?\))\s*=&gt;|^\s*function(?:\s+[\w$]+)?\s*\(/</code>
<img src="http://qiniu.ii6g.com/img/20201212163123.png" alt="http://qiniu.ii6g.com/img/20201212163123.png" title="http://qiniu.ii6g.com/img/20201212163123.png" /></p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div v-on:click=&#34;i++&#34;&gt;&lt;/div&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; event name`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">key</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; event handler`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, {
      onClick: $event =&gt; (i++)
    }, null, 8 /* PROPS */, [&#34;onClick&#34;]))
  }
}
&gt;&gt;&gt; event name
{
  type: 4,
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 16, line: 1, offset: 15 },
    source: &#39;click&#39;
  },
  content: &#39;onClick&#39;,
  isStatic: true,
  constType: 3
}
&gt;&gt;&gt; event handler
{
  type: 8,
  loc: {
    source: &#39;&#39;,
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  },
  children: [
    &#39;$event =&gt; (&#39;,
    {
      type: 4,
      content: &#39;i++&#39;,
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    &#39;)&#39;
  ]
}
undefined
</pre>
<div class="comment-block">
<p>æ›´å¤šæµ‹è¯•ç”¨ä¾‹(<code>&lt;f12&gt;</code>)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -&gt;&gt; ã€‚</p>
</div>
<script>
l1(`v-on æŒ‡ä»¤`)
c(`<div v-on:click="onClick"/>`, `v-on click`)
c(`<div v-on:[event]="handler"/>`, `v-onåŠ¨æ€äº‹ä»¶å`)
l2(`TODO 'dynamic arg with prefixing'`)
l2(`TODO dynamic arg with complex exp prefixing`)
c(`<div @click="i++"/>`, 'å¦‚æœ v-on çš„exp æ˜¯ä¸ªç®€å•è¡¨è¾¾å¼ï¼Œè¦ç”¨å‡½æ•°å°è£…èµ·æ¥')
c(`<div @click="foo();bar()"/>`, `æ”¯æŒå¤šä¸ªè¡¨è¾¾å¼`)
c(`<div @click="\nfoo();\nbar()\n"/>`, `æ”¯æŒå¤šè¡Œè¡¨è¾¾å¼`)
c(`<div @click="foo($event)"/>`, `å‡½æ•°è°ƒç”¨`)
c(`<div @click="foo($event);bar()"/>`, `å‡½æ•°è°ƒç”¨åŠ è¡¨è¾¾å¼æ··åˆ`)
c(`<div @click="$event => foo($event)"/>`, `å¦‚æœæœ¬èº«æ˜¯å‡½æ•°ä¸ç”¨å¤šä½™å¤„ç†`)
c(`<div @click="
      $event => {
        foo($event)
      }
    "/>`, `=> å¦‚æœè¡¨è¾¾å¼å·²ç»æ˜¯å‡½æ•°åŸæ ·è¾“å‡ºå°±è¡Œ`)
c(`<div @click="
      function($event) {
        foo($event)
      }
    "/>`, `function, å¦‚æœè¡¨è¾¾å¼å·²ç»æ˜¯å‡½æ•°åŸæ ·è¾“å‡ºå°±è¡Œ`)
c(`<div @click="a['b' + c]"/>`, `å¦‚æœè¡¨è¾¾å¼æ˜¯å¯¹è±¡å–å€¼è¡¨è¾¾å¼ï¼Œä¸ç”¨å¤„ç†`)
c(`<div v-on:click />`, `å¦‚æœæ²¡æœ‰è¡¨è¾¾å¼å’Œä¿®é¥°ç¬¦ï¼ŒæŠ¥é”™`)
c(`<div v-on:click.prevent />`, `å¦‚æœæ²¡è¡¨è¾¾å¼ä½†æ˜¯æœ‰ä¿®é¥°ç¬¦ï¼Œä¸æŠ¥é”™`)
c(`<div v-on:foo-bar="onMount"/>`, `äº‹ä»¶åä¸º foo-bar è¦è½¬æˆé©¼å³° onFooBar`)
c(`<div v-on:vnode-mounted="onMount"/>`, 'case conversion for vnode hooks')
compile.options = { cacheHandlers: true }
c(`<div v-on:click.prevent />`, `empty handler`)
c(`<div v-on:click="foo" />`, 'member expression handler')
c(`<div v-on:click="foo.bar" />`, 'compound member expression handler')
c(`<comp v-on:click="foo" />`, 'bail on component member expression handler')
c(`<div v-on:click="() => foo()" />`, 'inline function expression handler')
c(`<div v-on:click="foo++" />`, 'inline statement handler')
</script>
<p>
<code>options.cacheHandlers</code> å±æ€§è¦é…åˆ <code>options.prefixIdentifiers</code> ä½¿ç”¨ã€‚</p>
<p>
ä½œç”¨æ˜¯ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°ï¼ŒåŸç†æ˜¯:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">createVNode</span> <span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">openBlock</span> <span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span> <span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">onClick</span><span class="o">:</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="mi">_</span><span class="nx">cache</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{})</span>
    <span class="p">}))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç¼“å­˜çš„é™„åŠ æ¡ä»¶ï¼š <code>let shouldCache: boolean = context.cacheHandlers &amp;&amp; !exp</code></p>
<p>
æ²¡æœ‰è¡¨è¾¾å¼å€¼çš„æƒ…å†µä¸‹æ‰ç¼“å­˜ï¼Œå› ä¸ºæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªç©ºçš„å‡½æ•°ä½œä¸ºäº‹ä»¶ handlerï¼Œä¸ºäº†é¿å…
åˆ›å»ºè¿‡å¤šçš„æ— æ„ä¹‰çš„ç©ºå‡½æ•°ï¼Œä½¿ç”¨ç¼“å­˜æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©(<del>ä½†ï¼Œä¸€èˆ¬ç»‘å®šäº†äº‹ä»¶åº”è¯¥ä¸è‡³äºä¸
ç»™å¤„ç†å‡½æ•°å§!!!</del>)ã€‚</p>
</div>
</div>
<div id="outline-container-v-bind" class="outline-2">
<h2 id="v-bind">
f805858 add v-bind transform
</h2>
<div id="outline-text-v-bind" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/f80585802218bcc75aad502880c571b642257ef0">feat(add): v-bind transform Â· gcclll/stb-vue-next@f805858</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`
</span><span class="sb">&lt;div v-bind:name=&#34;test&#34;
</span><span class="sb">  :age=&#34;100&#34;
</span><span class="sb">  :[propName]=&#34;myName&#34;
</span><span class="sb">  :[first+second]=&#34;thrid&#34;
</span><span class="sb">  :no-need-camel-prop=&#34;noNeedCamelProp&#34;
</span><span class="sb">  :need-camel-prop.camel=&#34;needCamelProp&#34;
</span><span class="sb">  :no-exp-prop.camel
</span><span class="sb">&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; render function\n`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
v-bind is missing expression.
&gt;&gt;&gt; render function

const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, {
      name: test,
      age: 100,
      [propName || &#34;&#34;]: myName,
      [first+second || &#34;&#34;]: thrid,
      &#34;no-need-camel-prop&#34;: noNeedCamelProp,
      needCamelProp: needCamelProp,
      noExpProp: &#34;&#34;
    }, null, 16 /* FULL_PROPS */, [&#34;name&#34;,&#34;age&#34;,&#34;no-need-camel-prop&#34;,&#34;needCamelProp&#34;,&#34;noExpProp&#34;]))
  }
}
undefined
</pre>
<p>
v-bind å±æ€§æ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p>
<ul>
<li>
<p><code>v-bind:name=&#34;test&#34;</code> æ— ç¼©å†™å±æ€§ï¼Œæœ€æ™®é€šçš„ä¸€ç§ç”¨æ³•</p>
</li>
<li>
<p><code>:age=&#34;100&#34;</code> ç¼©å†™å½¢å¼</p>
</li>
<li>
<p><code>:[propName]=&#34;myName&#34;</code> æ™®é€šåŠ¨æ€å±æ€§å</p>
</li>
<li>
<p><code>:[first+second]=&#34;third&#34;</code> è¡¨è¾¾å¼åŠ¨æ€å±æ€§å</p>
</li>
<li>
<p><code>:no-need-camel-prop=&#34;noNeedCamelProp&#34;</code> ä¸éœ€è¦è½¬é©¼å³°çš„å±æ€§å</p>
</li>
<li>
<p><code>:need-camel-prop.camel=&#34;needCamelProp&#34;</code> éœ€è¦è½¬æˆé©¼å³°çš„å±æ€§åï¼Œéœ€è¦åˆ¶å®š
<code>.camel</code> ä¿®é¥°ç¬¦</p>
</li>
<li>
<p><code>no-exp-prop.camel</code> æ— å±æ€§å€¼çš„å±æ€§ï¼Œä¼šç»™é»˜è®¤ <code>&#34;&#34;</code> å€¼ï¼ŒåŒæ—¶ç»™å‡ºè­¦å‘Šï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p>
</li>
</ul>
<div class="comment-block">
<p>æ›´å¤šæµ‹è¯•ç”¨ä¾‹(<code>&lt;f12&gt;</code>)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -&gt;&gt; ã€‚</p>
</div>
<script>
l1(`v-bind æŒ‡ä»¤ >>>>>`)
c(`<div v-bind:id="id"/>`, 'basic')
c(`<div v-bind:[id]="id"/>`, `dynamic arg`)
c(`<div v-bind:arg />`, `should error if no expression`)
c(`<div v-bind:foo-bar.camel="id"/>`, '.camel modifier')
c(`<div v-bind:[foo].camel="id"/>`, '.camel modifier w/ dynamic arg')
c(`<div v-bind:[foo(bar)].camel="id"/>`, '.camel modifier w/ dynamic arg + prefixIdentifiers')
</script>
</div>
</div>
<div id="outline-container-headline-30" class="outline-2">
<h2 id="headline-30">
0cc76f0 add v-model transform
</h2>
<div id="outline-text-headline-30" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0cc76f04112b1194e0a5cafae0a49bc399462ebf">feat(add): v-model transform Â· gcclll/stb-vue-next@0cc76f0</a></p>
<p>
<code>&lt;input v-model=&#34;model&#34; /&gt;</code></p>
<p>
ç»è¿‡ <code>transformModel</code> ä¹‹åçš„ node.props:</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="err">//</span> <span class="err">JS_PROPERTY</span>
        <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="err">//</span> <span class="err">SIMPLE_EXPRESSION</span>
            <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;modelValue&#34;</span><span class="p">,</span>
            <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
            <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">3</span>
        <span class="p">},</span>
        <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
            <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;model&#34;</span><span class="p">,</span>
            <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
            <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span>
        <span class="nt">&#34;key&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
            <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="p">,</span>
            <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
            <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">3</span>
        <span class="p">},</span>
        <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="err">//</span> <span class="err">COMPOUND_EXPRESSION</span>
            <span class="nt">&#34;children&#34;</span><span class="p">:[</span>
                <span class="s2">&#34;$event =&gt; (&#34;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                    <span class="nt">&#34;content&#34;</span><span class="p">:</span><span class="s2">&#34;model&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;isStatic&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
                    <span class="nt">&#34;constType&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&#34; = $event)&#34;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
compiler-core é˜¶æ®µçš„è§£æè„‘å›¾ï¼š
<img src="/img/vue3/compiler-core/pcg/pcg-08-v-model-cc.svg" alt="/img/vue3/compiler-core/pcg/pcg-08-v-model-cc.svg" title="/img/vue3/compiler-core/pcg/pcg-08-v-model-cc.svg" /></p>
<p>
ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ v-model æŒ‡ä»¤çš„è§£æä¹Ÿæ˜¯åœ¨ buildProps ä¸­å®Œæˆçš„ï¼Œå…³äºè¿™ä¸ªå‡½æ•°çš„è„‘
å›¾ä¹Ÿå¯ä»¥æŸ¥çœ‹ <a href="/vue/vue-mind-map-house-cc/#key-01-build-props">buildProps(node, context) å¦‚ä½•æ„å»º props ?</a></p>
<p>
vue/baseCompile è§£æä¹‹åçš„ç»“æœï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">Vue</span> <span class="o">=</span> <span class="nx">Vue</span>

<span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">openBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">modelValue</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      <span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="o">:</span> <span class="nx">$event</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">$event</span><span class="p">)</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span> <span class="cm">/* PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;modelValue&#34;</span><span class="p">,</span> <span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="p">]))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
vue/compile ç»è¿‡ compile-dom package(<em>æœªå®Œæˆ</em>) çš„ transformModel ä¹‹åçš„ç»“æœï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="kd">function</span> <span class="nx">anonymous</span><span class="p">(</span>
<span class="p">)</span> <span class="p">{</span>
<span class="kr">const</span> <span class="mi">_</span><span class="nx">Vue</span> <span class="o">=</span> <span class="nx">Vue</span>

<span class="k">return</span> <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">_</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">with</span> <span class="p">(</span><span class="mi">_</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">vModelText</span><span class="o">:</span> <span class="mi">_</span><span class="nx">vModelText</span><span class="p">,</span> <span class="nx">createVNode</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createVNode</span><span class="p">,</span> <span class="nx">withDirectives</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withDirectives</span><span class="p">,</span> <span class="nx">openBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">openBlock</span><span class="p">,</span> <span class="nx">createBlock</span><span class="o">:</span> <span class="mi">_</span><span class="nx">createBlock</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">Vue</span>

    <span class="k">return</span> <span class="mi">_</span><span class="nx">withDirectives</span><span class="p">((</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="p">{</span>
      <span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="o">:</span> <span class="nx">$event</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">$event</span><span class="p">)</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span> <span class="cm">/* PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;onUpdate:modelValue&#34;</span><span class="p">])),</span> <span class="p">[</span>
      <span class="p">[</span><span class="mi">_</span><span class="nx">vModelText</span><span class="p">,</span> <span class="nx">model</span><span class="p">]</span>
    <span class="p">])</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/a537be0fc265243012032750a801b6e6582751d5">fix: v-model no value Â· gcclll/stb-vue-next@a537be0</a></p>
<p>
ä¿®å¤ä¹‹å(<code>genNode</code> æ²¡æœ‰å®ç° <code>8,COMPOUND_EXPRESSION</code> ç±»å‹)ï¼Œæµ‹è¯•</p>
<ol>
<li>
<p>ä¸å¸¦å‚æ•°çš„ <code>v-model</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">baseParse</span><span class="p">,</span>
     <span class="nx">baseCompile</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

 <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model=&#34;model&#34; /&gt;`</span><span class="p">)</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      modelValue: model,
      &#34;onUpdate:modelValue&#34;: $event =&gt; (model = $event)
    }, null, 8 /* PROPS */, [&#34;modelValue&#34;,&#34;onUpdate:modelValue&#34;]))
  }
}
</pre>
</li>
<li>
<p>æŒ‡ä»¤ <code>{ prefixIdentifiers: true }</code> é€‰é¡¹(éœ€è¦ node ç¯å¢ƒ, <strong>TODO</strong>)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="p">{</span>
     <span class="nx">baseParse</span><span class="p">,</span>
     <span class="nx">baseCompile</span>
 <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

 <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model=&#34;model&#34; /&gt;`</span><span class="p">,</span> <span class="p">{</span>
   <span class="nx">prefixIdentifiers</span><span class="o">:</span> <span class="kc">true</span>
 <span class="p">})</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      modelValue: model,
      &#34;onUpdate:modelValue&#34;: $event =&gt; (model = $event)
    }, null, 8 /* PROPS */, [&#34;modelValue&#34;,&#34;onUpdate:modelValue&#34;]))
  }
}
undefined
</pre>
</li>
<li>
<p>ç»„åˆè¡¨è¾¾å¼(<code>8,COMPOUND_EXPRESSION</code>)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
<span class="nx">baseParse</span><span class="p">,</span>
<span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model=&#34;model[index]&#34; /&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      modelValue: model[index],
      &#34;onUpdate:modelValue&#34;: $event =&gt; (model[index] = $event)
    }, null, 8 /* PROPS */, [&#34;modelValue&#34;,&#34;onUpdate:modelValue&#34;]))
  }
}
undefined
</pre>
</li>
<li>
<p>å¸¦å‚æ•°</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
<span class="nx">baseParse</span><span class="p">,</span>
<span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model:value=&#34;model&#34; /&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      value: model,
      &#34;onUpdate:value&#34;: $event =&gt; (model = $event)
    }, null, 40 /* PROPS, HYDRATE_EVENTS */, [&#34;value&#34;,&#34;onUpdate:value&#34;]))
  }
}
undefined
</pre>
<p>
 ä¸å¸¦å‚æ•°çš„æ—¶å€™å‚æ•°åä¼šç»™ä¸€ä¸ªé»˜è®¤å€¼ï¼š <code>modelValue</code>, å¦‚æœæœ‰è‡ªå·±çš„å‚æ•°ä¼šç›´æ¥ä½¿
ç”¨æä¾›çš„å‚æ•°åã€‚</p>
</li>
<li>
<p>åŠ¨æ€å‚æ•°</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
<span class="nx">baseParse</span><span class="p">,</span>
<span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;input v-model:[value]=&#34;model&#34; /&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æœ‰é—®é¢˜ç»“æœï¼š</p>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      [value]: model,
      : $event =&gt; (model = $event)
    }, null, 16 /* FULL_PROPS */))
  }
}
</pre>
<p>
ç»“æœæ˜¾ç¤ºï¼ŒåŠ¨æ€å±æ€§çš„äº‹ä»¶åæ²¡æœ‰è¢«è§£æå‡ºæ¥ <code>: $event =&gt; (model = $event)</code> ã€‚</p>
<p>
ä¿®å¤ä¹‹åç»“æœ(<a href="https://github.com/gcclll/stb-vue-next/commit/94a7a850d7e060e948c5672cdb170c47489feda9">fix: v-model dynamic arg generate Â· gcclll/stb-vue-next@94a7a85</a>)ï¼š</p>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;input&#34;, {
      [value]: model,
      [&#34;onUpdate:&#34; + value]: $event =&gt; (model = $event)
    }, null, 16 /* FULL_PROPS */))
  }
}
</pre>
</li>
<li>
<p>ç¼“å­˜äº‹ä»¶å›è°ƒå‡½æ•°(<code>cacheHandlers: true</code>, <strong>TODO</strong>)</p>
<p>
éœ€è¦ç»“åˆ <code>prefixIdentifiers: true</code> ä½¿ç”¨ã€‚</p>
</li>
</ol>
<div class="comment-block">
<p>é’ˆå¯¹ v-model è¿˜éœ€è¦ compile-runtime é˜¶æ®µçš„æ”¯æŒï¼Œç”±äºè¿™é‡Œè¿˜æ²¡å®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œçš„ç»“æœ
å’Œ vue-next æµ‹è¯•ç»“æœä¼šæœ‰äº›å‡ºå…¥ï¼Œå‡ºå…¥ç‚¹åœ¨äº compiler-runtime æœŸä¼šå°† <code>modelValue:
model</code> åˆ é™¤ã€‚</p>
</div>
<div class="comment-block">
<p>æ›´å¤šæµ‹è¯•ç”¨ä¾‹(<code>&lt;f12&gt;</code>)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -&gt;&gt; ã€‚</p>
</div>
<script>
l1(`v-model æŒ‡ä»¤`)
c('<input v-model="model" />', 'simple expression')
c('<input v-model="\n model\n.\nfoo \n" />', 'simple expression (with multilines)')
c('<input v-model="model[index]" />', 'compound expression')
c('<input v-model:value="model" />', 'with argument')
c('<input v-model:[value]="model" />', 'with dynamic argument')
c('<input v-model="foo" />', 'should cache update handler w/ cacheHandlers: true')
c('<input v-for="i in list" v-model="foo[i]" />', 'should not cache update handler if it refers v-for scope variables')
c('<Comp v-slot="{ foo }"><input v-model="foo.bar"/></Comp>', 'should mark update handler dynamic if it refers slot scope variables')
c('<Comp v-model.trim.bar-baz="foo" />', 'should generate modelModifiers for component v-model')
c('<Comp v-model:foo.trim="foo" v-model:bar.number="bar" />', 'should generate modelModifiers for component v-model with arguments')
c('<span v-model />', 'missing expression')
c('<span v-model="" />', 'empty expression')
c('<span v-model="a + b" />', 'mal-formed expression')
c('<span v-for="i in list" v-model="i" />', 'used on scope variable')
</script>
</div>
</div>
<div id="outline-container-headline-31" class="outline-2">
<h2 id="headline-31">
bf18a84 add v-once transform
</h2>
<div id="outline-text-headline-31" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/bf18a84650adaf68004a0ce0977d33b1436a4587">feat(add): v-once Â· gcclll/stb-vue-next@bf18a84</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">seen</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakSet</span><span class="p">()</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">transformOnce</span>: <span class="kt">NodeTransform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span> <span class="nx">findDir</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;once&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ç¼“å­˜å®ç° v-onceï¼Œå°±ç®—æœ‰æ•°æ®æ›´æ–°ä¹Ÿä¸ä¼šé‡æ–°ç”Ÿæˆ render å‡½æ•°
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">seen</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">seen</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SET_BLOCK_TRACKING</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">currentNode</span> <span class="kr">as</span> <span class="nx">ElementNode</span> <span class="o">|</span> <span class="nx">IfNode</span> <span class="o">|</span> <span class="nx">ForNode</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cur</span><span class="p">.</span><span class="nx">codegenNode</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">,</span> <span class="kc">true</span> <span class="cm">/* isVNode */</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>v-once</code> æŒ‡ä»¤çš„å®ç°çœ‹ä¼¼æŒºç®€å•çš„ï¼Œå°†è§£æåçš„ node èŠ‚ç‚¹ç¼“å­˜åˆ° <code>seen: WeakSet</code> ä¸­ï¼Œ
ä¸‹æ¬¡ä½¿ç”¨çš„æ—¶å€™ç›´æ¥å–ç¼“å­˜(<code>context.cache(...)</code>)ï¼Œè€Œä¸æ˜¯é‡æ–°ç”Ÿæˆ <code>codegenNode</code></p>
<p>
<code>JS_CACHE_EXPRESSION</code> ç»“æ„ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createCacheExpression</span><span class="p">(</span>
  <span class="nx">index</span>: <span class="kt">number</span><span class="p">,</span>
  <span class="nx">value</span>: <span class="kt">JSChildNode</span><span class="p">,</span>
  <span class="nx">isVNode</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">CacheExpression</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CACHE_EXPRESSION</span><span class="p">,</span>
    <span class="nx">index</span><span class="p">,</span> <span class="c1">// åœ¨ context.cached ä¸­çš„ç´¢å¼•
</span><span class="c1"></span>    <span class="nx">value</span><span class="p">,</span> <span class="c1">// v-onceèŠ‚ç‚¹çš„ ast
</span><span class="c1"></span>    <span class="nx">isVNode</span><span class="p">,</span> <span class="c1">// block æˆ– vnode ?
</span><span class="c1"></span>    <span class="nx">loc</span>: <span class="kt">locStub</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
generator é˜¶æ®µå®ç°ï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/8bacf14f156f0ca357d4c0efdbc75dc2120a3ec5">feat(add): v-once generator Â· gcclll/stb-vue-next@8bacf14</a></p>
<p>
åœ¨ <code>genNode()</code> ä¸­å¢åŠ  <code>JS_CACHE_EXPRESSION</code> ç±»å‹çš„åˆ†æ”¯å¤„ç†ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genCacheExpression</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">CacheExpression</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">CodegenContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">indent</span><span class="p">,</span> <span class="nx">deindent</span><span class="p">,</span> <span class="nx">newline</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">isVNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">indent</span><span class="p">()</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SET_BLOCK_TRACKING</span><span class="p">)</span><span class="si">}</span><span class="sb">(-1),`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="nx">push</span><span class="p">(</span><span class="sb">`_cache[</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">index</span><span class="si">}</span><span class="sb">] = `</span><span class="p">)</span>
  <span class="nx">genNode</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">isVNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`,`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">helper</span><span class="p">(</span><span class="nx">SET_BLOCK_TRACKING</span><span class="p">)</span><span class="si">}</span><span class="sb">(1),`</span><span class="p">)</span>
    <span class="nx">newline</span><span class="p">()</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`_cache[</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">index</span><span class="si">}</span><span class="sb">]`</span><span class="p">)</span>
    <span class="nx">deindent</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">push</span><span class="p">(</span><span class="sb">`)`</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">tpl</span><span class="p">,</span> <span class="nx">desc</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">desc</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">tpl</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div :id=&#34;foo&#34; v-once /&gt;`</span><span class="p">,</span> <span class="sb">`&gt;&gt;&gt; &lt;div :id=&#34;foo&#34; v-once /&gt;`</span><span class="p">)</span>
<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;div :id=&#34;foo&#34; v-once /&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="sb">`&gt;&gt;&gt; æ ‡ç­¾ä¸­åµŒå¥—ä½¿ç”¨`</span><span class="p">)</span>
<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div&gt;&lt;Comp :id=&#34;foo&#34; v-once /&gt;&lt;/div&gt;`</span><span class="p">,</span> <span class="sb">`&gt;&gt;&gt; åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸Š`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; &lt;div :id=&#34;foo&#34; v-once /&gt;
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { setBlockTracking : _setBlockTracking, createVNode : _createVNode } = _Vue

    return _cache[1] || (
      _setBlockTracking(-1),
      _cache[1] = _createVNode(&#34;div&#34;, { id: foo }, null, 8 /* PROPS */, [&#34;id&#34;]),
      _setBlockTracking(1),
      _cache[1]
    )
  }
}
&gt;&gt;&gt; æ ‡ç­¾ä¸­åµŒå¥—ä½¿ç”¨
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { setBlockTracking : _setBlockTracking, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, null, [
      _cache[1] || (
        _setBlockTracking(-1),
        _cache[1] = _createVNode(&#34;div&#34;, { id: foo }, null, 8 /* PROPS */, [&#34;id&#34;]),
        _setBlockTracking(1),
        _cache[1]
      )
    ]))
  }
}
&gt;&gt;&gt; åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸Š
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { setBlockTracking : _setBlockTracking, resolveComponent : _resolveComponent, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, null, [
      _cache[1] || (
        _setBlockTracking(-1),
        _cache[1] = _createVNode(_component_Comp, { id: foo }, null, 8 /* PROPS */, [&#34;id&#34;]),
        _setBlockTracking(1),
        _cache[1]
      )
    ]))
  }
}
undefined
</pre>
<p>
TODO ç¼ºå°‘ï¼š <code>const _component_Comp = _resolveComponent(&#34;Comp&#34;)</code></p>
<div class="comment-block">
<p>æ›´å¤šæµ‹è¯•ç”¨ä¾‹(<code>&lt;f12&gt;</code>)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -&gt;&gt; ã€‚</p>
</div>
<script>
l1(`v-once æŒ‡ä»¤`)
c(`<div :id="foo" v-once />`, 'as root node', ast => ast.codegenNode)
c(`<div><div :id="foo" v-once /></div>`, 'on nested plain element')
c(`<div><Comp :id="foo" v-once /></div>`, 'on component')
c(`<div><slot v-once /></div>`, 'on slot outlet')
c(`<div><div v-once /></div>`, 'with hoistStatic: true')
c(`<div v-if="BOOLEAN" v-once /><p v-else/>`, 'with v-if/else')
c(`<div v-for="i in list" v-once />`, 'with v-for')
</script>
</div>
</div>
<div id="outline-container-headline-32" class="outline-2">
<h2 id="headline-32">
acdea14 add v-if transform
</h2>
<div id="outline-text-headline-32" class="outline-text-2">
<p>
<code>v-if</code> æŒ‡ä»¤æºç è„‘å›¾å¯å‚è€ƒï¼š <a href="/vue/vue-mind-map-house-cc/#pcg-v-if">05 v-if æŒ‡ä»¤(git:0a591b6)</a></p>
<p>
å¯¹äº <code>v-if|else|else-if</code> æŒ‡ä»¤åœ¨ transform é˜¶æ®µï¼Œè½¬æ¢æ”¶é›† transformXxx å‡½æ•°è¿‡ç¨‹ä¸­ï¼Œ
ä¼šå…ˆé’ˆå¯¹æŒ‡ä»¤è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ï¼š <code>v-else, v-else-if</code> æŒ‡ä»¤çš„ç»„ä»¶ä¼šè¢«è§£æåˆ° <code>v-if</code> èŠ‚
ç‚¹çš„ <code>node.branches[]</code> åˆ†æ”¯æ•°ç»„é‡Œé¢ä¹‹åè¢«åˆ é™¤ï¼Œè¿™äº›éƒ½æ˜¯åœ¨æ”¶é›† transformXxx ä¹‹å‰éœ€è¦å®Œæˆçš„ã€‚</p>
<p>
åŒ…æ‹¬ <code>v-for</code> æŒ‡ä»¤éƒ½éœ€è¦ç»è¿‡ <code>createStructuralDirectiveTransform()</code> å‡½æ•°å°è£…ä¸€å±‚
ä¹‹åï¼Œè¿”å›å¯¹åº”çš„ <code>transformXxx</code> å‡½æ•°ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript">
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">createStructuralDirectiveTransform</span><span class="p">(</span>
  <span class="nx">name</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span><span class="p">,</span>
  <span class="nx">fn</span>: <span class="kt">StructuralDirectiveTransform</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">NodeTransform</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">isString</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
    <span class="o">?</span> <span class="p">(</span><span class="nx">n</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">n</span> <span class="o">===</span> <span class="nx">name</span>
    <span class="o">:</span> <span class="p">(</span><span class="nx">n</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">name</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">props</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">node</span>
      <span class="c1">// structural directive transforms are not concerned with slots
</span><span class="c1"></span>      <span class="c1">// as they are handled separately in vSlot.ts
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">isVSlot</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="kr">const</span> <span class="nx">exitFns</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">prop</span> <span class="o">=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">DIRECTIVE</span> <span class="o">&amp;&amp;</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
          <span class="c1">// structural directives are removed to avoid infinite recursion
</span><span class="c1"></span>          <span class="c1">// also we remove them *before* applying so that it can further
</span><span class="c1"></span>          <span class="c1">// traverse itself in case it moves the node around
</span><span class="c1"></span>          <span class="nx">props</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="nx">i</span><span class="o">--</span>
          <span class="kr">const</span> <span class="nx">onExit</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">onExit</span><span class="p">)</span> <span class="nx">exitFns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">onExit</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">exitFns</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
é€šè¿‡ <code>for (...)</code> å°†æ‰€æœ‰ v-if/v-for ç›¸å…³æŒ‡ä»¤ç»è¿‡ä»–ä»¬è‡ªå·±çš„å¤„ç†å‡½æ•°(æ¯”å¦‚ï¼š
<code>processIf</code> ) ä¹‹åå¾—åˆ°æœ€ç»ˆçš„ <code>onExit</code> æ”¶é›†åˆ° <code>exitFns</code> ä¸­ï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­éšæ—¶ä¼šå‡º
ç°èŠ‚ç‚¹çš„åˆ é™¤æ“ä½œ(æ¯”å¦‚ï¼š <code>v-else</code> èŠ‚ç‚¹ä¼šåœ¨è§£æå®Œä¹‹åè¢«åˆ é™¤)ï¼Œåœ¨æ­£å¸¸çš„ traverse è¿‡
ç¨‹ä¸­è¿™äº›èŠ‚ç‚¹éƒ½ä¸ä¼šå†å­˜åœ¨ã€‚</p>
<blockquote>
<p>PS: æ­£ç¡®ç†è§£åº”è¯¥å±äºç§»åŠ¨æ“ä½œï¼Œå› ä¸ºåŸå§‹çš„ AST ç»“æ„å¹¶æ²¡æ”¹å˜ï¼Œåªä¸è¿‡æ˜¯åœ¨åŸæœ‰çš„ AST
æ•°ç»“æ„ä¸­ç§»é™¤åˆ°æ–°çš„ AST èŠ‚ç‚¹ä¸‹é¢äº†ã€‚</p>
</blockquote>
<div id="outline-container-headline-33" class="outline-3">
<h3 id="headline-33">
acdea14 v-if transform init
</h3>
<div id="outline-text-headline-33" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/acdea1419d0361a4566a5f2a53ffc8bb1f941878">feat(init): v-if transform Â· gcclll/stb-vue-next@acdea14</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">transformIf</span> <span class="o">=</span> <span class="nx">createStructuralDirectiveTransform</span><span class="p">(</span>
  <span class="sr">/^(if|else|else-if)$/</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">processIf</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="p">(</span><span class="nx">ifNode</span><span class="p">,</span> <span class="nx">branch</span><span class="p">,</span> <span class="nx">isRoot</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ifNode</span><span class="p">,</span> <span class="nx">branch</span><span class="p">,</span> <span class="nx">isRoot</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{}</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">)</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">processIf</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">ElementNode</span><span class="p">,</span>
  <span class="nx">dir</span>: <span class="kt">DirectiveNode</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">TransformContext</span><span class="p">,</span>
  <span class="nx">processCodegen</span><span class="o">?:</span> <span class="p">(</span>
    <span class="nx">node</span>: <span class="kt">IfNode</span><span class="p">,</span>
    <span class="nx">branch</span>: <span class="kt">IfBranchNode</span><span class="p">,</span>
    <span class="nx">isRoot</span>: <span class="kt">boolean</span>
  <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">|</span> <span class="kc">undefined</span>
<span class="p">)</span> <span class="p">{}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
åˆå§‹åŒ– v-if process å‡½æ•°ï¼Œ processIf å‡½æ•°é‡Œé¢ä¼šé’ˆå¯¹ v-if èŠ‚ç‚¹ç”šè‡³å®ƒçš„å…„å¼ŸèŠ‚ç‚¹åš
ä¸€ç³»åˆ—æ“ä½œï¼Œæ¯”å¦‚å°†ä¸‹ä¸€ä¸ªæ˜¯ <code>v-else</code> çš„å…„å¼ŸèŠ‚ç‚¹åˆ é™¤ç§»åˆ°è‡ªå·±çš„ <code>branches[]</code> é‡Œé¢ã€‚</p>
</div>
</div>
<div id="outline-container-headline-34" class="outline-3">
<h3 id="headline-34">
9039a3e v-if transform processIf
</h3>
<div id="outline-text-headline-34" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9039a3e567260d33c0bc617d4c58639b14b66fec">feat: v-if processIf Â· gcclll/stb-vue-next@9039a3e</a></p>
<p>
è¿™é‡Œå¢åŠ äº†ä¸¤ä¸ªå‡½æ•°çš„å®ç°ï¼š</p>
<ol>
<li>
<p>processIf, è§£æ ifï¼Œåˆ›å»º <code>IF,9</code> ç±»å‹çš„ç»“æ„ï¼Œæ›¿æ¢ v-if åŸæ¥çš„ ast</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="kr">const</span> <span class="nx">ifNode</span>: <span class="kt">IfNode</span> <span class="o">=</span> <span class="p">{</span>
   <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">IF</span><span class="p">,</span>
   <span class="nx">loc</span>: <span class="kt">node.loc</span><span class="p">,</span>
   <span class="nx">branches</span><span class="o">:</span> <span class="p">[</span><span class="nx">branch</span><span class="p">]</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
å…¶ä¸­ branches ä¿å­˜ç€æ‰€æœ‰ v-else, v-else-if åˆ†æ”¯èŠ‚ç‚¹ï¼Œè¿™é‡Œå…¶å®æ˜¯åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤
çš„åˆ†æ”¯èŠ‚ç‚¹ï¼Œå› ä¸º <code>v-if</code> ç³»åˆ—æŒ‡ä»¤åœ¨ <code>render</code> å‡½æ•°ä¸­æ˜¯ä»¥ä¸‰å…ƒè¿ç®—ç¬¦(<code>?:</code>)å½¢å¼å­˜
åœ¨çš„ï¼Œæ‰€ä»¥ if åé¢å¿…é¡»è¦æœ‰ä¸€ä¸ªåˆ†æ”¯ï¼Œå³ <code>condition ? node1 : node2</code> ä¸­çš„ node2
å¿…é¡»æ˜¯ä¸ªæœ‰æ•ˆçš„å€¼ï¼Œæ‰èƒ½æ­£å¸¸ä½¿ç”¨ <code>?:</code> è¿ç®—ç¬¦ã€‚</p>
<p>
æ‰€ä»¥ï¼Œå¦‚æœåªæœ‰ <code>v-if</code> æŒ‡ä»¤çš„æ—¶å€™ä¸‰å…ƒç¬¦åé¢çš„å€¼èµ·å§‹æ˜¯ä¸ªç©ºå€¼(å¥½åƒæ˜¯ <code>null</code>)</p>
</li>
<li>
<p>createIfBranch, åˆ›å»º <code>v-if</code> çš„åˆ†æ”¯èŠ‚ç‚¹çš„</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">createIfBranch</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">ElementNode</span><span class="p">,</span> <span class="nx">dir</span>: <span class="kt">DirectiveNode</span><span class="p">)</span><span class="o">:</span> <span class="nx">IfBranchNode</span> <span class="p">{</span>
<span class="k">return</span> <span class="p">{</span>
 <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">IF_BRANCH</span><span class="p">,</span>
 <span class="nx">loc</span>: <span class="kt">node.loc</span><span class="p">,</span>
 <span class="c1">// condition ? v-if node : v-else node
</span><span class="c1"></span> <span class="nx">condition</span>: <span class="kt">dir.name</span> <span class="o">===</span> <span class="s1">&#39;else&#39;</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">exp</span><span class="p">,</span>
 <span class="c1">// å¦‚æœç”¨çš„æ˜¯ &lt;template v-if=&#34;condition&#34; ... å°±éœ€è¦ node.children
</span><span class="c1"></span> <span class="c1">// å› ä¸º template æœ¬èº«æ˜¯ä¸è¯¥è¢«æ¸²æŸ“çš„
</span><span class="c1"></span> <span class="nx">children</span>:
   <span class="kt">node.tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">findDir</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">)</span>
     <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span>
     <span class="o">:</span> <span class="p">[</span><span class="nx">node</span><span class="p">],</span>
 <span class="c1">// å¯¹äº v-for, v-if/... éƒ½åº”è¯¥ç»™å®ƒä¸ª key, è¿™é‡Œæ˜¯ç”¨æˆ·ç¼–å†™æ˜¯çš„æä¾›çš„å”¯ä¸€ key
</span><span class="c1"></span> <span class="c1">// å¦‚æœæ²¡æœ‰è§£æå™¨ä¼šé»˜è®¤ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ key
</span><span class="c1"></span> <span class="nx">userKey</span>: <span class="kt">findProp</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="sb">`key`</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
 æ³¨æ„çœ‹æœ€åä¸€ä¸ªå±æ€§ï¼Œ <code>v-if</code> åˆ†æ”¯ä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ª <code>key</code> å±æ€§çš„ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-35" class="outline-3">
<h3 id="headline-35">
44985b4 v-if transform createIfBranch
</h3>
<div id="outline-text-headline-35" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/44985b49e031752a7c84464b29adb769050cb1fb">feat: v-if createIfBranch Â· gcclll/stb-vue-next@44985b4</a></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createConditionalExpression</span><span class="p">(</span>
  <span class="nx">test</span>: <span class="kt">ConditionalExpression</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
  <span class="nx">consequent</span>: <span class="kt">ConditionalExpression</span><span class="p">[</span><span class="s1">&#39;consequent&#39;</span><span class="p">],</span>
  <span class="nx">alternate</span>: <span class="kt">ConditionalExpression</span><span class="p">[</span><span class="s1">&#39;alternate&#39;</span><span class="p">],</span>
  <span class="nx">newline</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="kr">type</span><span class="o">:</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CONDITIONAL_EXPRESSION</span><span class="p">,</span>
    <span class="nx">test</span><span class="p">,</span>
    <span class="nx">consequent</span><span class="p">,</span>
    <span class="nx">alternate</span><span class="p">,</span>
    <span class="nx">newline</span><span class="p">,</span>
    <span class="nx">loc</span>: <span class="kt">locStub</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œçš„ç»“æ„(<code>v-if</code>)åœ¨ render å‡½æ•°ä¸­çš„å¯¹åº”å…³ç³»ï¼š</p>
<p>
<code>test ? consequent : alternate</code></p>
<p>
å¦‚æœæœ‰ v-else-if æ—¶å€™ï¼Œ <code>alternate</code> ç»“æ„ä¼šæ˜¯ä¸ªå®Œæ•´çš„ <code>JS_CONDITIONAL_EXPRESSION</code>
ï¼Œå³ï¼š <code>alternate: { test, consequent, alternate, ...}</code> æ‰€ä»¥ï¼š</p>
<p>
<code>test ? consequent : test1 ? consequent 1 : alternate</code></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1e24eb7a30588690a4e83f888623b97f0085e899">fix: no v-if transform Â· gcclll/stb-vue-next@1e24eb7</a></p>
<p>
åˆ°è¿™é‡Œ v-if æŒ‡ä»¤ transform é˜¶æ®µå·²ç»å®Œæˆï¼Œæµ‹è¯•ç»“æœï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;ok&#34;/&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; ast.codegenNode ç»“æœ`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; ast.codegenNode ç»“æœ
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 17, line: 1, offset: 16 },
    source: &#39;&lt;div v-if=&#34;ok&#34;/&gt;&#39;
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: &#39;ok&#39;,
      isStatic: false,
      isConstant: false,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: &#39;&#34;div&#34;&#39;,
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: &#39;&#39;, start: [Object], end: [Object] }
  }
}
undefined
</pre>
<p>
+RESULTS: é”™è¯¯ç»“æœ</p>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return (_openBlock(), _createBlock(&#34;div&#34;, { key: 0 }))
  }
}
&gt;&gt;&gt; ast.codegenNode ç»“æœ
{
  type: 13,
  tag: &#39;&#34;div&#34;&#39;,
  props: {
    type: 15,
    loc: { source: &#39;&#39;, start: [Object], end: [Object] },
    properties: [ [Object] ]
  },
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 17, line: 1, offset: 16 },
    source: &#39;&lt;div v-if=&#34;ok&#34;/&gt;&#39;
  }
}
undefined
</pre>
<p>
ç»“æœæ˜¾ç¤ºæ˜¯ä¸å¯¹çš„ï¼Œå› ä¸ºåˆ›å»ºçš„ <code>IF</code> ç»“æ„æ²¡æœ‰æ›¿æ¢ ast ğŸŒ²ä¸­åŸæ¥çš„èŠ‚ç‚¹ï¼Œè¿½è¸ªåå‘ç°æ˜¯
æ¼æ‰äº† <code>context.replaceNode(node)</code> çš„å®ç°ã€‚</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/47c30d296b2f42759aea8de4730ae1802dbb6e32">fix: v-if codegenNode is incorrect Â· gcclll/stb-vue-next@47c30d2</a></p>
<p>
traverseNode ä¸­éœ€è¦å¢åŠ  <code>case 9,IF</code> åˆ†æ”¯å¤„ç†ï¼Œéå†æ‰€æœ‰çš„ <code>branches[]</code> ã€‚</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/179f06f716687166b167f5d190073bfe65a9393f">fix: v-if branches no codegenNode Â· gcclll/stb-vue-next@179f06f</a></p>
</div>
</div>
<div id="outline-container-headline-36" class="outline-3">
<h3 id="headline-36">
742757e v-if generator
</h3>
<div id="outline-text-headline-36" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/742757ebe2c4d1faaadf32b6606d43cef2900934?branch=742757ebe2c4d1faaadf32b6606d43cef2900934&amp;diff=split">feat: v-if generator Â· gcclll/stb-vue-next@742757e</a></p>
<p>
genNode å¢åŠ  <code>JS_CONDITIONAL_EXPRESSION</code> åˆ†æ”¯å¤„ç†(<code>genConditionalExpression</code>)</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">function</span> <span class="nx">genConditionalExpression</span><span class="p">(</span>
  <span class="nx">node</span>: <span class="kt">ConditionalExpression</span><span class="p">,</span>
  <span class="nx">context</span>: <span class="kt">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">test</span><span class="p">,</span> <span class="nx">consequent</span><span class="p">,</span> <span class="nx">alternate</span><span class="p">,</span> <span class="nx">newline</span>: <span class="kt">needNewline</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">node</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">indent</span><span class="p">,</span> <span class="nx">deindent</span><span class="p">,</span> <span class="nx">newline</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">SIMPLE_EXPRESSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// éç®€å•çš„æ ‡è¯†ç¬¦éœ€è¦ç”¨æ‹¬å·ï¼Œå¯èƒ½æ˜¯è¡¨è¾¾å¼ï¼Œæ‰€ä»¥éœ€è¦ (a + b) ? ... : ...
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">needsParams</span> <span class="o">=</span> <span class="o">!</span><span class="nx">isSimpleIdentifier</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
    <span class="nx">needsParams</span> <span class="o">&amp;&amp;</span> <span class="nx">push</span><span class="p">(</span><span class="sb">`(`</span><span class="p">)</span>
    <span class="nx">genExpression</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="nx">needsParams</span> <span class="o">&amp;&amp;</span> <span class="nx">push</span><span class="p">(</span><span class="sb">`)`</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`(`</span><span class="p">)</span>
    <span class="nx">genNode</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="nx">push</span><span class="p">(</span><span class="sb">`)`</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">needNewline</span> <span class="o">&amp;&amp;</span> <span class="nx">indent</span><span class="p">()</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">++</span>
  <span class="nx">needNewline</span> <span class="o">||</span> <span class="nx">push</span><span class="p">(</span><span class="sb">` `</span><span class="p">)</span>
  <span class="nx">push</span><span class="p">(</span><span class="sb">`? `</span><span class="p">)</span>
  <span class="nx">genNode</span><span class="p">(</span><span class="nx">consequent</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">--</span>
  <span class="nx">needNewline</span> <span class="o">&amp;&amp;</span> <span class="nx">newline</span><span class="p">()</span>
  <span class="nx">needNewline</span> <span class="o">||</span> <span class="nx">push</span><span class="p">(</span><span class="sb">` `</span><span class="p">)</span>
  <span class="nx">push</span><span class="p">(</span><span class="sb">`: `</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">isNested</span> <span class="o">=</span> <span class="nx">alternate</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CONDITIONAL_EXPRESSION</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNested</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ä¸æ˜¯åµŒå¥—
</span><span class="c1"></span>    <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">++</span>
  <span class="p">}</span>
  <span class="nx">genNode</span><span class="p">(</span><span class="nx">alternate</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNested</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">indentLevel</span><span class="o">--</span>
  <span class="p">}</span>

  <span class="nx">needNewline</span> <span class="o">&amp;&amp;</span> <span class="nx">deindent</span><span class="p">(</span><span class="kc">true</span> <span class="cm">/* without newline */</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>genConditionalExpression</code> å¤„ç†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†</p>
<ol>
<li>
<p><code>test</code> ç”Ÿæˆæ¡ä»¶è¡¨è¾¾å¼ï¼Œè¿™é‡Œæ˜¯: <code>ok</code> ï¼Œå¦‚æœæ˜¯è¡¨è¾¾å¼éœ€è¦æ‹¬å·ï¼š <code>(a + b)</code></p>
</li>
<li>
<p><code>consequent</code> ç”¨æ¥ç”Ÿæˆ <code>?</code> åé¢çš„è¡¨è¾¾å¼ï¼Œå³ <code>ok</code> ç»“æœä¸º truth æ—¶æ‰§è¡Œ</p>
</li>
<li>
<p><code>alternate</code> ç”¨æ¥ç”Ÿæˆ <code>:</code> åé¢çš„è¡¨è¾¾å¼ï¼Œå³ <code>ok</code> ç»“æœä¸º falsy æ—¶æ‰§è¡Œ</p>
<p>
<code>alternate</code> ä¸­çš„ç»“æ„å¯èƒ½ä¹Ÿæ˜¯ä¸ª <code>JS_CONDITIONAL_EXPRESSION</code> ç»“æ„ï¼Œä»£è¡¨å¯èƒ½æœ‰
<code>v-else-if</code> åˆ†æ”¯ï¼Œå¦‚ï¼š <code>(a + b) ? node1 : (c + d) ? node2 : othernode</code> ã€‚</p>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">tpl</span><span class="p">,</span> <span class="nx">desc</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; `</span> <span class="o">+</span> <span class="nx">desc</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">tpl</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;ok&#34;/&gt;`</span><span class="p">,</span> <span class="s1">&#39;basic v-if&#39;</span><span class="p">)</span>
<span class="nx">c</span><span class="p">(</span><span class="sb">`&lt;template v-if=&#34;ok&#34;&gt;&lt;div/&gt;hello&lt;p/&gt;&lt;/template&gt;`</span><span class="p">,</span> <span class="s1">&#39;template v-if&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; basic v-if
const _Vue = Vue
const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue

const _hoisted_1 = { key: 0 }

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return ok
      ? (_openBlock(), _createBlock(&#34;div&#34;, _hoisted_1))
      : _createCommentVNode(&#34;v-if&#34;, true)
  }
}
&gt;&gt;&gt; template v-if
const _Vue = Vue
const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createTextVNode(&#34;hello&#34;)
const _hoisted_3 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, createTextVNode : _createTextVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return ok
      ? (_openBlock(), _createBlock(_Fragment, { key: 0 }, [
          _hoisted_1,
          _hoisted_2,
          _hoisted_3
        ], 64 /* STABLE_FRAGMENT */))
      : _createCommentVNode(&#34;v-if&#34;, true)
  }
}
undefined
</pre>
<p>
BUG: è¿™é‡Œå±…ç„¶å°‘äº†ä¸ª <code>_hoisted_2</code> ???</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">[</span>
  <span class="mi">_</span><span class="nx">hoisted_1</span><span class="p">,</span>
  <span class="p">,</span>
  <span class="mi">_</span><span class="nx">hoisted_3</span>
<span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
ç­”ï¼š <code>genNode()</code> ä¸­ç¼ºå°‘å¯¹ <code>4,TEXT_CALL</code> çº¯æ–‡æœ¬ç±»å‹å¤„ç†ã€‚</p>
<p>
è§£ï¼š<a href="https://github.com/gcclll/stb-vue-next/commit/2372b5fb793da98a8330aa843137e852d5c375c1">fix: v-if TEXT_CALL gen node Â· gcclll/stb-vue-next@2372b5f</a></p>
<div class="comment-block">
<p>æ›´å¤šæµ‹è¯•ç”¨ä¾‹(<code>&lt;f12&gt;</code>)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -&gt;&gt; ã€‚</p>
</div>
<script>
l1(`v-if æŒ‡ä»¤`)
compile(`<div v-if="ok"/>`, 'basic v-if')
compile(`<template v-if="ok"><div/>hello<p/></template>`, 'template v-if')
compile(`<Component v-if="ok"></Component>`, 'component v-if')
</script>
</div>
</div>
<div id="outline-container-headline-37" class="outline-3">
<h3 id="headline-37">
fa77b51 v-else/v-else-if
</h3>
<div id="outline-text-headline-37" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fa77b5146f3a3af6c8372012cb6a4d8482adb0c6">feat(add): v-else Â· gcclll/stb-vue-next@fa77b51</a></p>
<p>
ä¿®æ”¹ç‚¹ï¼š</p>
<ol>
<li>
<p><code>processCodegen()</code> å‡½æ•°é‡Œé¢å¢åŠ åˆ†æ”¯å¤„ç†</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201209164845.png" alt="http://qiniu.ii6g.com/img/20201209164845.png" title="http://qiniu.ii6g.com/img/20201209164845.png" /> 
 è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹: <code>getParentCondition()</code> ä¼šä¸€ç›´æŸ¥æ‰¾
<code>JS_CONDITIONAL_EXPRESSION</code> ç±»å‹èŠ‚ç‚¹çš„ <code>alternate</code> ï¼Œå¦‚æœå®ƒä¾æ—§æ˜¯ä¸ª
<code>JS_CONDITIONAL_EXPRESSION</code> ç±»å‹ï¼Œè¯´æ˜æ˜¯å¤šçº§çš„ <code>if/else</code> æ¡ä»¶è¯­å¥ï¼Œç›´åˆ°æ‰¾åˆ°æœ€
åä¸€ä¸ªä¸æ˜¯ä¸ºæ­¢ã€‚</p>
<p>
ç›¸å½“äº ï¼š <code>c1 ? cons1 : c2 ? cons2 : c3 ? cons3 : alt</code> ä¼šä¸€ç›´ä» <code>c1</code> èŠ‚ç‚¹å¼€å§‹
æŸ¥æ‰¾ç›´åˆ°æ‰¾åˆ°æœ€åçš„é‚£ä¸ª <code>alt</code> èŠ‚ç‚¹ä¸ºæ­¢ï¼Œç„¶åå°†æ–°çš„åˆ†æ”¯æŒ‚åˆ° <code>alt</code> åé¢ç»„ç»‡æˆæ–°
çš„åˆ†æ”¯:  <code>c1 ? cons1 : c2 ? cons2 : c3 ? cons3 : c4 ? cons4 : newalt</code></p>
<div class="comment-block">
<p>PS: c1, c2, c3, c4 åˆ†åˆ«ä»£è¡¨åˆ†æ”¯èŠ‚ç‚¹çš„ <code>test</code> ï¼Œæœ€åè¿½åŠ çš„ <code>c4 ? cons4 :
 newalt</code> ä¸‰ä¸ªå¯¹è±¡éƒ½å±äºæ–°åŠ çš„èŠ‚ç‚¹ï¼Œ <code>{test -&gt; c4, cons4 -&gt; consequent,
 alternate -&gt; newalt }</code></p>
</div>
</li>
<li>
<p><code>processIf()</code> é‡Œå¢åŠ åˆ†æ”¯å¤„ç†</p>
<p>
æ–°å¢ä»£ç é‡Œæœ‰ä¸ª <code>while</code> å¾ªç¯å»ä»å½“å‰çš„åˆ†æ”¯èŠ‚ç‚¹å¼€å§‹åœ¨å®ƒçš„å…„å¼ŸèŠ‚ç‚¹é‡Œé¢å¾€å›æ‰¾ï¼Œç›´
åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ª <code>9,IF</code> èŠ‚ç‚¹ï¼Œè¿™ä¸­é—´ä¸å…è®¸å‡ºç°å…¶ä»–æœ‰æ•ˆèŠ‚ç‚¹(é™¤æ³¨é‡Šï¼Œç©ºæ–‡æœ¬èŠ‚ç‚¹å¤–)ï¼Œ
å› ä¸º <code>v-if/else</code> æŒ‡ä»¤èŠ‚ç‚¹å¿…é¡»ç´§é ç€ã€‚</p>
<p>
æ‰¾åˆ°ä¹‹åï¼Œè¦å°†å½“å‰åˆ†æ”¯èŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶ä¸”åŒæ—¶è¦å»æ‰‹åŠ¨ <code>traverseNode(branch)</code> ä¸€æ¬¡ï¼Œ
å› ä¸ºä»–åœ¨åŸæ¥çš„ ast æ ‘ç§åˆ é™¤äº†ï¼Œæ‰€ä»¥åŸæ¥çš„ traverse è¿›ç¨‹ä¸ä¼šéå†å®ƒï¼Œå› æ­¤éœ€è¦æ‰‹
åŠ¨æ‰§è¡Œ traverse å»å¤„ç†å®ƒåŠå…¶å­©å­èŠ‚ç‚¹ç”Ÿæˆå¯¹åº”çš„ codegenNode ã€‚</p>
<p>
ç„¶åå°†å…¶ push åˆ° <code>9,IF</code> èŠ‚ç‚¹çš„ <code>node.branches</code> é‡Œé¢ä½œä¸ºåˆ†æ”¯ã€‚</p>
</li>
<li>
<p><code>isSameKey(a,b)</code> æ–°å¢ï¼Œæ£€æµ‹ä¸¤ä¸ª key å±æ€§æ˜¯ä¸æ˜¯ç›¸åŒ</p>
<p>
å‡ ç§åˆ¤å®šä¸ºä¸ç›¸åŒçš„æ¡ä»¶ï¼š</p>
<ol>
<li>
<p>key ç±»å‹ä¸åŒ (<code>a.type !== b.type</code>)</p>
</li>
<li>
<p>key å€¼ä¸åŒ (<code>a.value.content !== b.value.content</code>)</p>
</li>
<li>
<p>key å¦‚æœæ˜¯æŒ‡ä»¤ç±»å‹ï¼Œæ£€æµ‹è¡¨è¾¾å¼ç±»å‹ï¼Œé™æ€å±æ€§å¼‚åŒ(<code>isStatic</code>)</p>
</li>
</ol>
</li>
<li>
<p><code>getParentCondition()</code> æ–°å¢ï¼Œé€’å½’ <code>9ï¼ŒIF</code> èŠ‚ç‚¹çš„
<code>node.alternate.alternate.alternate...</code> ç›´åˆ°æ‰¾åˆ° <code>alternate</code> ä¸æ˜¯
<code>JS_CONDITIONAL_EXPRESSION</code> çš„æƒ…å†µ</p>
</li>
</ol>
<p>
FIX: <a href="https://github.com/gcclll/stb-vue-next/commit/464d6815adf49596065440001e0bc5397ad2aa69">fix: v-else current node dont removed Â· gcclll/stb-vue-next@464d681</a></p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;div v-if=&#34;ok&#34;/&gt;&lt;p v-else/&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode } = _Vue

    return ok
      ? (_openBlock(), _createBlock(&#34;div&#34;, { key: 0 }))
      : (_openBlock(), _createBlock(&#34;p&#34;, { key: 1 }))
  }
}
undefined
</pre>
<div class="comment-block">
<p>æ›´å¤šæµ‹è¯•(<code>&lt;f12&gt;</code>)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -&gt;&gt; ã€‚</p>
</div>
<script>
compile(`<div v-if="ok"/><p v-else/>`, 'v-if + v-else')
compile(`<template v-if="ok"><div/>hello<p/></template>`, 'template v-if')
compile(`<div v-if="ok"/><p v-else-if="orNot"/>`, 'v-if + v-else-if')
compile(`<div v-if="ok"/><p v-else-if="orNot"/><template v-else>fine</template>`, 'v-if + v-else-if + v-else')
compile(`
        <div v-if="ok"/>
        <!--foo-->
        <p v-else-if="orNot"/>
        <!--bar-->
        <template v-else>fine</template>
      `, 'comment between branches')

l1(`with prefixIdentifiers ... TODO`)
l1(`errors`)
compile(`<div v-else/>`, `<div v-else/> æ²¡æœ‰åŒ¹é…çš„ v-if`)
compile(`<div v-else-if="foo"/>`, `<div v-else-if="foo"/>, æ²¡æœ‰åŒ¹é…çš„ v-if`)
compile(`<div v-if="ok" :key="a + 1" /><div v-else :key="a + 1" />`,
`<div v-if="ok" :key="a + 1" /><div v-else :key="a + 1" />, ç›¸åŒçš„ key`
)
log.red(`ä¸å…è®¸ä¸åŒåˆ†æ”¯ä½¿ç”¨ç›¸ä¼¼çš„ keyï¼Œå› ä¸º key æ˜¯æŒ‡ä»¤å±æ€§ï¼Œå› æ­¤ä¼šå¯¹æ¯”å®ƒçš„ç±»å‹åŠè¡¨è¾¾å¼`)
l1(`v-on with v-if`)
compile(`<button v-on="{ click: clickEvent }" v-if="true">w/ v-if</button>`, 'v-if ä¸Šä½¿ç”¨ v-on æŒ‡ä»¤')
log.blue(`å› ä¸ºè¿™é‡Œç”¨çš„æ˜¯æ— å‚æ•°çš„ v-on æ‰€ä»¥ä¼šå¯¼è‡´æ‰€æœ‰å±æ€§è¢«åˆå¹¶(_mergeProps(...))ã€‚`)
</script>
<p>
BUG: v-else-if è¢«è§£ææˆäº† <code>else</code> å› ä¸º parser é˜¶æ®µåŒ¹é…æ­£åˆ™ä¸å¯¹ã€‚
<a href="https://github.com/gcclll/stb-vue-next/commit/5b83d1c12a8580638d7952e712f7c6776a099a50">fix: parser v-else-if failed Â· gcclll/stb-vue-next@5b83d1c</a></p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-38" class="outline-2">
<h2 id="headline-38">
6c82066 add v-for transform
</h2>
<div id="outline-text-headline-38" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/3a1662ecde9600525088a48420e526b6f9820931">feat(init): v-for Â· gcclll/stb-vue-next@3a1662e</a></p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6c8206676c5d5229c853fb21cb91aad1a9f1d4a2">feat: v-for directive Â· gcclll/stb-vue-next@6c82066</a></p>
<p>
v-for æŒ‡ä»¤å®ç°è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„å‡ ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>
<p><code>transformFor()</code> æœ€ç»ˆç”Ÿæˆçš„ tranformXxx å‡½æ•°</p>
</li>
<li>
<p><code>createStructuralDirectiveTransform()</code> åŒ <code>v-if</code> æŒ‡ä»¤</p>
</li>
<li>
<p><code>processFor()</code> å¤„ç† <code>v-for</code> æŒ‡ä»¤å…¥å£</p>
</li>
<li>
<p><code>processCodegen()</code> åŒ <code>v-if</code> ç”¨æ¥ç”Ÿæˆ <code>codegenNode</code> çš„å‡½æ•°</p>
</li>
<li>
<p><code>parseForExpression()</code> å°† <code>v-for=&#34;item in items&#34;</code> è¡¨è¾¾å¼è§£ææˆ
<code>ForParseResult{source, value, key, index}</code> ç±»å‹ AST ã€‚</p>
</li>
<li>
<p><code>createAliasExpression()</code> ç»™ <code>value, key, index</code> åˆ›å»º <code>SIMPLE_EXPRESSION</code> ç±»å‹
ç»“æ„ã€‚</p>
</li>
<li>
<p><code>createForLoopParams()</code> åˆ›å»º <code>_renderList</code> å‡½æ•°å›è°ƒçš„å‚æ•° <code>[value, key,
index]</code> ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨é»˜è®¤å˜é‡ï¼š <code>_</code> æˆ– <code>__</code> ï¼Œå¦‚ï¼š <code>(_, __, index)</code></p>
</li>
</ul>
<p>
å…¶ä¸­ <code>parseForExpression()</code> å‡½æ•°æ˜¯è§£æ <code>v-for</code> è¡¨è¾¾å¼çš„æ ¸å¿ƒå‡½æ•°ï¼Œé‡Œé¢ä½¿ç”¨äº†ä¸‰ä¸ª
æ­£åˆ™ï¼Œç”¨æ¥åŒ¹é…æŒ‡ä»¤è¡¨è¾¾å¼ï¼š</p>
<ol>
<li>
<p><code>const forAliasRE = /([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201210155617.png" alt="http://qiniu.ii6g.com/img/20201210155617.png" title="http://qiniu.ii6g.com/img/20201210155617.png" /></p>
<p>
åŒ¹é… <code>v-for=&#34;item in items&#34;</code> ä¸­çš„å€¼éƒ¨åˆ†</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="sb">`</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">p</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="sb">`\n`</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>

<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; åŒ¹é… item in items`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;item in items&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; åŒ¹é… (item, key) in items`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;( item, key ) in items&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; åŒ¹é… item in items
0, item in items
1, item
2, items
&gt;&gt;&gt; åŒ¹é… (item, key) in items
0, ( item, key ) in items
1, ( item, key )
2, items
undefined
</pre>
</li>
<li>
<p><code>const forIteratorRE = /,([^,\}\]]*)(?:,([^,\}\]]*))?$/</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201210161642.png" alt="http://qiniu.ii6g.com/img/20201210161642.png" title="http://qiniu.ii6g.com/img/20201210161642.png" /></p>
<p>
è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ç”¨æ¥åŒ¹é… <code>(item, key) in items</code> ä¸­çš„ <code>item</code> å’Œ <code>key</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/,([^,\}\]]*)(?:,([^,\}\]]*))?$/</span> 
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="sb">`</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">p</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="sb">`\n`</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>

<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; åŒ¹é… &#39;item, key, index&#39; ä¸­çš„ key å’Œ index`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;item, key, index&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; åŒ¹é… &#34;item, key&#34; ä¸­çš„ key`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="s2">&#34;item, key&#34;</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; åŒ¹é… &#39;item, key, index&#39; ä¸­çš„ key å’Œ index
0, , key, index
1,  key
2,  index
&gt;&gt;&gt; åŒ¹é… &#34;item, key&#34; ä¸­çš„ key
0, , key
1,  key
2, undefined
undefined
</pre>
</li>
<li>
<p><code>const stripParensRE = /^\(|\)$/g</code> è¿™ä¸ªç”¨æ¥åŒ¹é… <code>(item, key, index)</code> å‰åæ‹¬å·</p>
</li>
</ol>
<p>
<code>parseForExpression()</code> æ ¸å¿ƒå®ç°ï¼š</p>
<ol>
<li>
<p><code>source</code> æ•°æ®æºï¼Œ <code>forAliasRE</code> åŒ¹é…åçš„ <code>RHS</code> å€¼</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">source:</span> <span class="p">{</span>
 <span class="err">type:</span> <span class="err">4,</span> <span class="err">//</span> <span class="err">SIMPLE_EXPRESSION</span>
 <span class="err">loc:</span> <span class="err">{</span> <span class="err">source:</span> <span class="err">&#39;obj&#39;,</span> <span class="err">start:</span> <span class="err">[Object],</span> <span class="err">end:</span> <span class="err">[Object]</span> <span class="p">}</span><span class="err">,</span>
 <span class="err">isConstant:</span> <span class="kc">false</span><span class="err">,</span>
 <span class="err">content:</span> <span class="err">&#39;obj&#39;,</span>
 <span class="err">isStatic:</span> <span class="kc">false</span>
<span class="err">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>value</code> çš„å–å€¼ï¼Œåœ¨ AST ä¸­å¯¹åº” <code>valueAlias</code></p>
<p>
<code>valueContent = valueContent.replace(forIteratorRE,
&#39;&#39;).trim()</code></p>
<p>
é€šè¿‡åŒ¹é… <code>key, index</code> çš„æ­£åˆ™ï¼Œåå‘æ›¿æ¢å¾—åˆ° <code>value</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/,([^,\}\]]*)(?:,([^,\}\]]*))?$/</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`item, key, index`</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">())</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; æ”¯æŒè§£æ„`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[ id, value ], key, index`</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">())</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
item
&gt;&gt;&gt; æ”¯æŒè§£æ„
[ id, value ]
undefined
</pre>
<p>
 è§£æåçš„ç»“æ„ï¼š</p>
<div class="src src-json">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">valueAlias:</span> <span class="p">{</span>
    <span class="err">type:</span> <span class="err">4,</span> <span class="err">//</span> <span class="err">SIMPLE_EXPRESSION</span>
    <span class="err">loc:</span> <span class="err">{</span> <span class="err">source:</span> <span class="err">&#39;value&#39;,</span> <span class="err">start:</span> <span class="err">[Object],</span> <span class="err">end:</span> <span class="err">[Object]</span> <span class="p">}</span><span class="err">,</span>
    <span class="err">isConstant:</span> <span class="kc">false</span><span class="err">,</span>
    <span class="err">content:</span> <span class="err">&#39;value&#39;,</span>
    <span class="err">isStatic:</span> <span class="kc">false</span>
<span class="err">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>key</code> å–å€¼å¤„ç†ï¼Œåœ¨ AST ä¸­å¯¹åº” <code>keyAlias</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="nx">keyAlias</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">type</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
     <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="nx">end</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">},</span>
     <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span>
     <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>index</code> å–å€¼å¤„ç†ï¼Œåœ¨ ASTä¸­å¯¹åº” <code>objectIndexAlias</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"> <span class="nx">objectIndexAlias</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">type</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
     <span class="nx">loc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">source</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">],</span> <span class="nx">end</span><span class="o">:</span> <span class="p">[</span><span class="nb">Object</span><span class="p">]</span> <span class="p">},</span>
     <span class="nx">isConstant</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
     <span class="nx">content</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
     <span class="nx">isStatic</span><span class="o">:</span> <span class="kc">false</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;span v-for=&#34;(value, key, index) in obj&#34; /&gt;`</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">valueAlias</span><span class="p">,</span> <span class="nx">keyAlias</span><span class="p">,</span> <span class="nx">objectIndexAlias</span><span class="p">,</span> <span class="nx">type</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`type: </span><span class="si">${</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; æ•°æ®æº`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; value`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">valueAlias</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; key`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">keyAlias</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; index`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">objectIndexAlias</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; _renderList(obj, (value, key, index) =&gt; {...}) ç¬¬äºŒä¸ªå‚æ•°`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
type: 11
&gt;&gt;&gt; æ•°æ®æº
{
  type: 4,
  loc: {
    source: &#39;obj&#39;,
    start: { column: 37, line: 1, offset: 36 },
    end: { column: 40, line: 1, offset: 39 }
  },
  isConstant: false,
  content: &#39;obj&#39;,
  isStatic: false
}
&gt;&gt;&gt; value
{
  type: 4,
  loc: {
    source: &#39;value&#39;,
    start: { column: 15, line: 1, offset: 14 },
    end: { column: 20, line: 1, offset: 19 }
  },
  isConstant: false,
  content: &#39;value&#39;,
  isStatic: false
}
&gt;&gt;&gt; key
{
  type: 4,
  loc: {
    source: &#39;key&#39;,
    start: { column: 22, line: 1, offset: 21 },
    end: { column: 25, line: 1, offset: 24 }
  },
  isConstant: false,
  content: &#39;key&#39;,
  isStatic: false
}
&gt;&gt;&gt; index
{
  type: 4,
  loc: {
    source: &#39;index&#39;,
    start: { column: 27, line: 1, offset: 26 },
    end: { column: 32, line: 1, offset: 31 }
  },
  isConstant: false,
  content: &#39;index&#39;,
  isStatic: false
}
&gt;&gt;&gt; _renderList(obj, (value, key, index) =&gt; {...}) ç¬¬äºŒä¸ªå‚æ•°
{
  type: 18, // JS_FUNCTION_EXPRESSION
  params: [
    {
      type: 4,
      loc: [Object],
      isConstant: false,
      content: &#39;value&#39;,
      isStatic: false
    },
    {
      type: 4,
      loc: [Object],
      isConstant: false,
      content: &#39;key&#39;,
      isStatic: false
    },
    {
      type: 4,
      loc: [Object],
      isConstant: false,
      content: &#39;index&#39;,
      isStatic: false
    }
  ],
  returns: {
    type: 13,
    tag: &#39;&#34;span&#34;&#39;,
    props: undefined,
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    loc: {
      start: [Object],
      end: [Object],
      source: &#39;&lt;span v-for=&#34;(value, key, index) in obj&#34; /&gt;&#39;
    }
  },
  newline: true,
  isSlot: false,
  loc: {
    source: &#39;&#39;,
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  }
}
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-39" class="outline-2">
<h2 id="headline-39">
39a20fe add v-for generator
</h2>
<div id="outline-text-headline-39" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/39a20fef0001cf22de6632f96df474c87a127a9d">feat(add): v-for generator Â· gcclll/stb-vue-next@39a20fe</a></p>
<p>
codegen é˜¶æ®µæ–°å¢å¯¹åº”çš„å®ç°ï¼š <code>18,JS_FUNCTION_EXPRESSION</code></p>
<p>
è¿™ä¸ªä¸»è¦æ˜¯ç”¨æ¥è§£æ <code>_renderList(source, (value, key, index) =&gt; { ... })</code> å‡½æ•°çš„
ç¬¬äºŒä¸ªå‚æ•°çš„ï¼Œè¿™æ˜¯ä¸ªç”¨æ¥ render åˆ—è¡¨é¡¹çš„å‡½æ•°ã€‚</p>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="s1">&#39;&lt;span v-for=&#34;(item) in items&#34; /&gt;&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { renderList : _renderList, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock, createVNode : _createVNode } = _Vue

    return (_openBlock(true), _createBlock(_Fragment, null, _renderList(items, (item) =&gt; {
      return (_openBlock(), _createBlock(&#34;span&#34;))
    )), 256 /* UNKEYED_FRAGMENT */))
  }
}
undefined
</pre>
<blockquote>
<p>æ›´å¤šæµ‹è¯•ç”¨ä¾‹è¯· <code>&lt;f12&gt;</code> æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ã€‚</p>
</blockquote>
<script>
l1(`v-for directive`)
compile(`<span v-for="(item) in items" />`, `basic v-for`)
compile('<span v-for="(item, key, index) in items" />', 'value + key + index')
compile('<span v-for="(, key, index) in items" />', `skipped value`)
compile('<span v-for="(item,,index) in items" />', `skipped key`)
compile('<span v-for="(,,index) in items" />', `skipped value & key`)
compile('<p v-for="item in 10">{{item}}</p>', `v-for with constant expression`)
compile(`<template v-for="item in items">hello<span/></template>`, `template v-for`)
compile('<template v-for="item in items"><slot/></template>', `template v-for w/ <slot/>`)
log.red(`TODO <slot> å¾…å®Œæˆ......`)
compile('<template v-for="item in items" :key="item.id"><span :id="item.id" /></template>', `template v-for key injection with single child`)
compile('<slot v-for="item in items"></slot>', `v-for on <slot/>`)
log.red(`TODO <slot> å¾…å®Œæˆ......`)
compile('<span v-for="(item) in items" :key="item" />', `keyed v-for`)
compile('<template v-for="item in items" :key="item">hello<span/></template>', `keyed template v-for`)
compile(`<div v-if="ok" v-for="i in list"/>`, `v-if + v-for`)
compile(`<template v-if="ok" v-for="i in list"/>`, 'v-if + v-for on <template>')
compile('<div v-for="i in list" v-foo/>', `v-for on element with custom directive`)

</script>
</div>
</div>
<div id="outline-container-headline-40" class="outline-2">
<h2 id="headline-40">
7cb8908 add slot outlet transform
</h2>
<div id="outline-text-headline-40" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/7cb8908700da1bf0c3888a2fcd6857263d09aedd">feat(add): v-slot transform Â· gcclll/stb-vue-next@7cb8908</a></p>
<p>
transform <code>&lt;slot /&gt;</code> æ ‡ç­¾ã€‚</p>
<p>
<code>&lt;slot/&gt;</code> åœ¨ render å‡½æ•°ä¸­æ˜¯ä»¥ <code>_renderSlot($slot, name, props, children)</code> å½¢å¼å­˜åœ¨ã€‚</p>
<div class="comment-block">
<p>&lt;slot&gt; ä¸Šä¸å…è®¸è‡ªå®šä¹‰çš„æŒ‡ä»¤å­˜åœ¨ï¼Ÿ</p>
</div>
<p>
ç›¸å…³å‡½æ•°/å‚æ•°ï¼š</p>
<ol>
<li>
<p><code>transformSlotOutlet()</code> è¯¥é˜¶æ®µçš„ <code>tranformXxx</code> å‡½æ•°</p>
</li>
<li>
<p><code>SlotOutletProcessResult</code> ç±»å‹å®šä¹‰ <code>{slotName, slotProps}</code></p>
</li>
<li>
<p><code>processSlotOutlet()</code>, <code>&lt;slot/&gt;</code> çš„å¤„ç†è¿‡ç¨‹</p>
<p>
é¦–å…ˆæ˜¯è§£ææ’æ§½åç§°(<code>name</code> å±æ€§)ï¼Œè¯¥å±æ€§å¯ä»¥æ˜¯åŠ¨æ€(<code>&lt;slot :name=&#34;myslot&#34;/&gt;</code>)ä¹Ÿ
å¯ä»¥æ˜¯é™æ€çš„(<code>&lt;slot name=&#34;myslot&#34;/&gt;</code>)ã€‚</p>
<p>
ç„¶åè§£æå‡ºæ’æ§½ä¸Šå®šä¹‰çš„ä¸€äº›å±æ€§(é™æ€)ï¼Œé™¤äº† <code>:name</code> ä¹‹å¤–æ’æ§½ä¸Š <strong>ä¸å…è®¸æœ‰å…¶ä»–çš„
æŒ‡ä»¤ç±»å‹çš„å±æ€§å­˜åœ¨</strong> ã€‚</p>
</li>
<li>
<p><code>children</code> å‚æ•°</p>
<p>
<code>&lt;slot&gt;&lt;div/&gt;&lt;p/&gt;&lt;/slot&gt;</code></p>
<p>
åœ¨ <code>&lt;slot&gt;</code> æ ‡ç­¾å†…çš„æ‰€æœ‰å…ƒç´ (<code>&lt;div/&gt;&lt;p/&gt;</code>)ä¼šè¢«è§£ææˆ <code>_renderSlot</code> çš„ç¬¬å››ä¸ªå‚æ•°ã€‚</p>
</li>
</ol>
<p>æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;slot/&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 1,
  ns: 0,
  tag: &#39;slot&#39;,
  tagType: 2,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: &#39;&lt;slot/&gt;&#39;
  },
  codegenNode: {
    type: 14, // JS_CALL_EXPRESSION
    loc: { start: [Object], end: [Object], source: &#39;&lt;slot/&gt;&#39; },
    callee: Symbol(renderSlot),
    arguments: [ &#39;$slots&#39;, &#39;&#34;default&#34;&#39; ]
  }
}
undefined
</pre>
<blockquote>
<p>æ›´å¤š codegenNode ç»“æœè¯· <code>&lt;f12&gt;</code> æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ã€‚</p>
</blockquote>
<script>
l1(`<slot/> æ’æ§½ transform é˜¶æ®µ`)

const _a = ast => [`_renderSlot å‚æ•°åˆ—è¡¨ï¼š` , ast.children[0].codegenNode.arguments ]
const c1 = (tpl, desc, ast = _a) => compile.call(null, tpl, desc, ast)
c1(`<slot/>`, `default slot outlet`)
c1(`<slot name="foo" />`, `statically named slot outletï¼Œå«é™æ€åå­—`)
c1(`<slot :name="foo" />`, `dynamically named slot outlet, å«åŠ¨æ€åå­—`)
c1(`<div/>`, `TODO dynamically named slot outlet w/ prefixIdentifiers: true`)
c1(`<slot foo="bar" :baz="qux" />`, `default slot outlet with propsï¼Œé»˜è®¤æ’æ§½+é™åŠ¨æ€å±æ€§`)
c1(`<slot name="foo" foo="bar" :baz="qux" />`, `statically named slot outlet with propsï¼Œé™æ€å…·åæ’æ§½+å…¶ä»–é™åŠ¨æ€å±æ€§`)
c1(`<slot :name="foo" foo="bar" :baz="qux" />`, `dynamically named slot outlet with propsï¼ŒåŠ¨æ€å…·åæ’æ§½+å…¶ä»–é™åŠ¨æ€å±æ€§`)
c1(`<slot><div/></slot>`, `default slot outlet with fallback`)
c1(`<slot name="foo"><div/></slot>`, `named slot outlet with fallback`)
c1(`<slot :foo="bar"><div/></slot>`, `default slot outlet with props & fallback`)
c1(`<slot name="foo" :foo="bar"><div/></slot>`, `named slot outlet with props & fallback`)
c1(`<slot v-foo />`, `error on unexpected custom directive on <slot>ï¼Œä¸å…è®¸æœ‰è‡ªå®šä¹‰æŒ‡ä»¤ï¼Ÿ`)
</script>
<div id="outline-container-headline-41" class="outline-3">
<h3 id="headline-41">
ebdb1ed add track slot scopes
</h3>
<div id="outline-text-headline-41" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/ebdb1edbfd23312d5fb079a3955917745cac2622">feat: add track slot scopes Â· gcclll/stb-vue-next@ebdb1ed</a></p>
<p>
è¿˜ä¸çŸ¥é“å¹²å—çš„â“ </p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// A NodeTransform that:
</span><span class="c1">// 1. Tracks scope identifiers for scoped slots so that they don&#39;t get prefixed
</span><span class="c1">//    by transformExpression. This is only applied in non-browser builds with
</span><span class="c1">//    { prefixIdentifiers: true }.
</span><span class="c1">// 2. Track v-slot depths so that we know a slot is inside another slot.
</span><span class="c1">//    Note the exit callback is executed before buildSlots() on the same node,
</span><span class="c1">//    so only nested slots see positive numbers.
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">trackSlotScopes</span>: <span class="kt">NodeTransform</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// &lt;component&gt; or &lt;template&gt;
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">node</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">ELEMENT</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">COMPONENT</span> <span class="o">||</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">tagType</span> <span class="o">===</span> <span class="nx">ElementTypes</span><span class="p">.</span><span class="nx">TEMPLATE</span><span class="p">)</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We are only checking non-empty v-slot here
</span><span class="c1"></span>    <span class="c1">// since we only care about slots that introduce scope variables.
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">vSlot</span> <span class="o">=</span> <span class="nx">findDir</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;slot&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">vSlot</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">slotProps</span> <span class="o">=</span> <span class="nx">vSlot</span><span class="p">.</span><span class="nx">exp</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">prefixIdentifiers</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">slotProps</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">addIdentifiers</span><span class="p">(</span><span class="nx">slotProps</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="nx">context</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">vSlot</span><span class="o">++</span>
      <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">__BROWSER__</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">prefixIdentifiers</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">slotProps</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">removeIdentifiers</span><span class="p">(</span><span class="nx">slotProps</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">scopes</span><span class="p">.</span><span class="nx">vSlot</span><span class="o">--</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-v-slot" class="outline-2">
<h2 id="v-slot">
36c1f36 (v-slot)build user component as slots
</h2>
<div id="outline-text-v-slot" class="outline-text-2">
<p>
ç»„ä»¶æ˜¯å¦‚ä½•å½“åš slot å¤„ç†çš„</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/36c1f36ea2a92119d2a61f3012972229e85b1e30">feat(add): user component treat as slot to build Â· gcclll/stb-vue-next@36c1f36</a></p>
<p>
å®Œæ•´ç”¨æˆ·ç»„ä»¶å½“ slot å¤„ç†æµç¨‹å›¾ï¼š
<img src="/img/vue3/compiler-core/pcg/pcg-v-slot.svg" alt="/img/vue3/compiler-core/pcg/pcg-v-slot.svg" title="/img/vue3/compiler-core/pcg/pcg-v-slot.svg" /></p>
<p>
<code>&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;</code></p>
<p>
è¿™é‡Œ <code>Comp</code> æ˜¯ç»„ä»¶ç±»å‹(<code>tagType=1,COMPONENT</code>) ä¼šåœ¨ <code>transformElement</code> ä¸­è¢«å½“åš
<code>slot</code> æ¥å¤„ç†è°ƒç”¨ <code>buildSlots()</code> ã€‚</p>
<div class="comment-block">
<p>æ›´å¤šæµ‹è¯•ç”¨ä¾‹(<code>&lt;f12&gt;</code>)æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ -&gt;&gt; ã€‚</p>
</div>
<script>
l1(`<slot /> æ’æ§½ generator é˜¶æ®µ`)
compile(`<Comp><div/></Comp>`, 'implicit default slot')
compile(`<Comp v-slot="{ foo }">{{ foo }}{{ bar }}</Comp>`, 'on-component default slot')
compile(`<Comp v-slot:named="{ foo }">{{ foo }}{{ bar }}</Comp>`, 'on component named slot')
compile(`<Comp>
        <template v-slot:one="{ foo }">
          {{ foo }}{{ bar }}
        </template>
        <template #two="{ bar }">
          {{ foo }}{{ bar }}
        </template>
      </Comp>`, 'template named slots')
compile(`<Comp v-slot:[named]="{ foo }">{{ foo }}{{ bar }}</Comp>`, 'on component dynamically named slot')
compile(`<Comp>
        <template #one>foo</template>bar<span/>
      </Comp>`, 'named slots w/ implicit default slot')
compile(`<Comp>
        <template v-slot:[one]="{ foo }">
          {{ foo }}{{ bar }}
        </template>
        <template #[two]="{ bar }">
          {{ foo }}{{ bar }}
        </template>
      </Comp>`, 'dynamically named slots')
compile(`<Comp>
        <template #default="{ foo }">
          <Inner v-slot="{ bar }">
            {{ foo }}{{ bar }}{{ baz }}
          </Inner>
          {{ foo }}{{ bar }}{{ baz }}
        </template>
      </Comp>`, 'nested slots scoping')

compile(`<div v-for="i in list">
        <Comp v-slot="bar">foo</Comp>
      </div>`, 'should force dynamic when inside v-for')
l2(` TODO should only force dynamic slots when actually using scope vars w/ prefixIdentifiers: true`)
compile(`<Comp>
        <template #one v-if="ok">hello</template>
      </Comp>`, 'named slot with v-if')
l2(` TODO named slot with v-if + prefixIdentifiers: true`)
compile(`<Comp>
        <template #one v-if="ok">foo</template>
        <template #two="props" v-else-if="orNot">bar</template>
        <template #one v-else>baz</template>
      </Comp>`, 'named slot with v-if + v-else-if + v-else')
l2(` TODO 'named slot with v-for w/ prefixIdentifiers: true'`)
compile(`<Comp>
        <template v-for="name in list" #[name]>{{ name }}</template>
      </Comp>`, 'named slot with v-for')
compile(`<Comp><template v-slot:named="slotProps"><div/></template><div :id="defaultSlotId"/></Comp>`, 'å…·åæ’æ§½+å…¶ä»–é template å…ƒç´ å…¨å½“åšé»˜è®¤æ’æ§½å¤„ç†')
</script>
<div id="outline-container-headline-43" class="outline-3">
<h3 id="headline-43">
fbed5cf add component with default slot without &lt;template&gt; transform
</h3>
<div id="outline-text-headline-43" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fbed5cf508e91ea20195af4dafa491957a4d1d60">feat(add): default slot without template Â· gcclll/stb-vue-next@fbed5cf</a></p>
<p>
<code>&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;</code></p>
<p>
è¿™ç§æƒ…å†µï¼Œç”¨æˆ·ç»„ä»¶ä¸Šæ—¢æ²¡æœ‰ <code>v-slot</code> å­©å­èŠ‚ç‚¹é‡Œé¢ä¹Ÿæ²¡æœ‰ <code>&lt;template v-slot&gt;</code> æœ€å
çš„å¤„ç†æ˜¯ <code>&lt;Comp&gt;&lt;/Comp&gt;</code> é‡Œé¢çš„æ‰€æœ‰ children è¢«å½“åšé»˜è®¤æ’æ§½å¤„ç†ã€‚</p>
<p>
è¯¥ç¤ºä¾‹ç¬¦åˆï¼š</p>
<ol>
<li>
<p>ç»„ä»¶ä¸Šæ²¡æœ‰ <code>v-slot</code> æŒ‡ä»¤</p>
</li>
<li>
<p>å­©å­èŠ‚ç‚¹é‡Œé¢æ²¡æœ‰ <code>&lt;template v-slot:name=&#34;slotProps&#34;&gt;</code></p>
</li>
</ol>
<p>å› æ­¤ï¼Œè¿™é‡Œçš„å¤„ç†æ˜¯å°† <code>&lt;div/&gt;</code> å³ <code>comp.children</code> å…¨éƒ¨ä½œä¸ºé»˜è®¤çš„ <code>slot:default</code>
æ¥å¤„ç†ã€‚</p>
<p>
å¤„ç†æµç¨‹ï¼š <code>&lt;Comp&gt;</code> -&gt; <code>transformElement</code> -&gt; <code>isComponent</code> -&gt; <code>buildSlots()</code> -&gt;
<code>{slots, hasDynamicSlots}</code> -&gt; <code>vnodeChildren</code> -&gt; <code>{type: 13,VNODE_CALL,
children: vnodeChildren, ... }</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 13,
  tag: &#39;_component_Comp&#39;,
  props: undefined,
  children: {
    type: 15,
    loc: { start: [Object], end: [Object], source: &#39;&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;&#39; },
    properties: [ [Object], [Object] ]
  },
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 20, line: 1, offset: 19 },
    source: &#39;&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;&#39;
  }
}
undefined
</pre>
<p>
å¦å¤–åœ¨ <code>transformElement()</code> å‡½æ•°ä¸­é€šè¿‡ <code>isComponent = node.tagType ===
ElementTypes.COMPONENT</code> æ£€æµ‹æ˜¯ä¸æ˜¯ç”¨æˆ·ç»„ä»¶ï¼Œå¦‚æœæ˜¯ç»§ç»­è§£æè¯¥ç»„ä»¶ç±»å‹(<code>resolveComponentType()</code>)ã€‚</p>
<p>
è¿™é‡Œæœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯ï¼š <code>vnodeTag = _component_Comp</code> ä½œä¸ºæ ‡ç­¾åï¼Œä¹Ÿæ˜¯è¯¥ <code>&lt;Comp/&gt;</code>
ç»„ä»¶åœ¨ Vue å®ä¾‹è¿‡ç¨‹ä¸­çš„å­˜åœ¨çš„æ ‡ç­¾å(ç»„ä»¶åç§°)ã€‚</p>
</div>
</div>
<div id="outline-container-headline-44" class="outline-3">
<h3 id="headline-44">
8bed175 add component with default slot without &lt;template&gt; generator
</h3>
<div id="outline-text-headline-44" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/8bed17574988042023be8ac420254918232ef7c4">feat(add): user component resolver generator Â· gcclll/stb-vue-next@8bed175</a></p>
<p>
å› ä¸ºåœ¨ transform é˜¶æ®µ transformElement è¿‡ç¨‹ä¸­ï¼Œæ£€æµ‹åˆ° <code>&lt;Comp&gt;</code> æ˜¯ä¸ªç”¨æˆ·ç»„ä»¶ï¼Œæ‰€
ä»¥å°†å…¶å¢åŠ åˆ°äº† <code>context.components.add(&#39;Comp&#39;)</code> ä¸­äº†ï¼Œåœ¨ generator é˜¶æ®µä¼šå»æ£€æµ‹
è¿™ä¸ª <code>components</code> ç”¨æ¥è§£æç»„ä»¶å¾—åˆ°ç»„ä»¶çš„å¼•ç”¨ï¼š</p>
<p>
<code>_component_Comp = _resolveComponent(&#34;Comp&#34;)</code></p>
<p>
æ–°å¢çš„ä»£ç ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>
<p>æ–°å¢ <code>genAssets()</code> å‡½æ•°å¤„ç† <code>context.components</code></p>
<p>
å¤„ç†ä¹‹åçš„ç»“æœå°±æ˜¯å¢åŠ  <code>_component_Comp = _resolveComponent(&#34;Comp&#34;)</code></p>
</li>
<li>
<p>åœ¨ <code>generate()</code> ä¸­å¢åŠ  <code>ast.components</code> æ£€æµ‹ï¼Œå¦‚æœæœ‰å†…å®¹è°ƒç”¨ <code>genAssets()</code> è§£
æ</p>
</li>
</ol>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// generate() ä¸­å¢åŠ 
</span><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">components</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">genAssets</span><span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">components</span><span class="p">,</span> <span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">directives</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">temps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newline</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="c1">// æ–°å¢
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">genAssets</span><span class="p">(</span>
  <span class="nx">assets</span>: <span class="kt">string</span><span class="p">[],</span>
  <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;component&#39;</span> <span class="o">|</span> <span class="s1">&#39;directive&#39;</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">helper</span><span class="p">,</span> <span class="nx">push</span><span class="p">,</span> <span class="nx">newline</span> <span class="p">}</span><span class="o">:</span> <span class="nx">CodegenContext</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">resolver</span> <span class="o">=</span> <span class="nx">helper</span><span class="p">(</span>
    <span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;component&#39;</span> <span class="o">?</span> <span class="nx">RESOLVE_COMPONENT</span> : <span class="kt">RESOLVE_DIRECTIVE</span>
  <span class="p">)</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">assets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">assets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="nx">push</span><span class="p">(</span>
      <span class="sb">`const </span><span class="si">${</span><span class="nx">toValidAssetId</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kr">type</span><span class="p">)</span><span class="si">}</span><span class="sb"> = </span><span class="si">${</span><span class="nx">resolver</span><span class="si">}</span><span class="sb">(</span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="si">}</span><span class="sb">)`</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">assets</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newline</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode(&#34;div&#34;, null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    const _component_Comp = _resolveComponent(&#34;Comp&#34;)

    return (_openBlock(), _createBlock(_component_Comp, null, {
      default: _withCtx(() =&gt; [
        _hoisted_1
      ]),
      _: 1
    }))
  }
}
undefined
</pre>
<p>
ç¼ºå°‘ <code>1 /* STABLE */</code> æ³¨é‡Š: <a href="https://github.com/gcclll/stb-vue-next/commit/08a6fcaab9224552dbd7876930d964e6bcc534d9">fix: slot flag text Â· gcclll/stb-vue-next@08a6fca</a></p>
<p>
æ³¨æ„ <code>_createBlock()</code> çš„ç¬¬ä¸‰ä¸ªå‚æ•°å˜æˆäº†ä¸€ä¸ªå¯¹è±¡(<code>children</code>) å¯¹è±¡é‡Œé¢åŒ…å«äº†ä¸¤ä¸ª
å±æ€§: <code>default</code> å’Œ <code>_</code> åˆ†åˆ«ä»£è¡¨äº†é»˜è®¤æ’æ§½ä¸‹çš„å­©å­èŠ‚ç‚¹ï¼Œå’Œè¯¥æ’æ§½æ ‡è¯†(<code>1-STABLE,2-FORWARDED,3-DYNAMIC</code>)</p>
</div>
</div>
<div id="outline-container-headline-45" class="outline-3">
<h3 id="headline-45">
9f58154 fix: æ–‡æœ¬èŠ‚ç‚¹æ²¡æœ‰åˆå¹¶(<code>transformText</code>)
</h3>
<div id="outline-text-headline-45" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/9f58154809447e6b718e1579149165fc848e8185">fix: adjacent text node need merge Â· gcclll/stb-vue-next@9f58154</a></p>
<p>
å¯¹äº <code>`&lt;Comp v-slot=&#34;{ foo }&#34;&gt;{{ foo }}{{ bar }}&lt;/Comp&gt;`</code> ç”¨ä¾‹å¾—åˆ°çš„ç»“æœéé¢„æœŸã€‚</p>
<p>
vue-next æ­£ç¡®ç»“æœï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/vue/vue.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp v-slot=&#34;{ foo }&#34;&gt;{{ foo }}{{ bar }}&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">returns</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">returns</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; è§£æåçš„ {{ foo }} {{ bar }} åº”è¯¥åˆå¹¶`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; ä¸‹é¢æ­£æ˜¯åˆå¹¶ä¹‹åçš„ä¸¤ä¸ªæ’å€¼`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
You are running a development build of Vue.
Make sure to use the production build (*.prod.js) when deploying for production.
[
  {
    type: 12,
    content: { type: 8, loc: [Object], children: [Array] },
    loc: { start: [Object], end: [Object], source: &#39;{{ foo }}&#39; },
    codegenNode: {
      type: 14,
      loc: [Object],
      callee: Symbol(createTextVNode),
      arguments: [Array]
    }
  }
]
&gt;&gt;&gt; è§£æåçš„ {{ foo }} {{ bar }} åº”è¯¥åˆå¹¶
{
  type: 8,
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 33, line: 1, offset: 32 },
    source: &#39;{{ foo }}&#39;
  },
  children: [
    { type: 5, content: [Object], loc: [Object] },
    &#39; + &#39;,
    { type: 5, content: [Object], loc: [Object] }
  ]
}
&gt;&gt;&gt; ä¸‹é¢æ­£æ˜¯åˆå¹¶ä¹‹åçš„ä¸¤ä¸ªæ’å€¼
[
  {
    type: 5,
    content: {
      type: 4,
      isStatic: false,
      constType: 0,
      content: &#39;foo&#39;,
      loc: [Object]
    },
    loc: { start: [Object], end: [Object], source: &#39;{{ foo }}&#39; }
  },
  &#39; + &#39;,
  {
    type: 5,
    content: {
      type: 4,
      isStatic: false,
      constType: 0,
      content: &#39;bar&#39;,
      loc: [Object]
    },
    loc: { start: [Object], end: [Object], source: &#39;{{ bar }}&#39; }
  }
]
undefined
</pre>
<p>
çœ‹ä¸‹ç°é˜¶æ®µ stb-vue-next è¾“å‡ºç»“æœï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">ast</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp v-slot=&#34;{ foo }&#34;&gt;{{ foo }}{{ bar }}&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">returns</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">codegenNode</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">returns</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">returns</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">content</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    isConstant: false,
    content: &#39;foo&#39;,
    loc: { start: [Object], end: [Object], source: &#39;foo&#39; }
  },
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 33, line: 1, offset: 32 },
    source: &#39;{{ foo }}&#39;
  }
}
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    isConstant: false,
    content: &#39;bar&#39;,
    loc: { start: [Object], end: [Object], source: &#39;bar&#39; }
  },
  loc: {
    start: { column: 33, line: 1, offset: 32 },
    end: { column: 42, line: 1, offset: 41 },
    source: &#39;{{ bar }}&#39;
  }
}
undefined
</pre>
<p>
stb-vue-next æ˜æ˜¾ returns é‡Œé¢åŒ…å«äº†ä¸¤ä¸ªå…ƒç´ åˆ†åˆ«æ˜¯ï¼š <code>{{ foo }}</code> å’Œ <code>{{ bar }}</code></p>
<p>
è¿™æ˜¯å› ä¸ºåœ¨ <code>transformText</code> é‡Œé¢æ²¡æœ‰è¿›è¡Œæ–‡æœ¬(æ’å€¼ä¹Ÿç®—)åˆå¹¶ã€‚</p>
</div>
</div>
<div id="outline-container-headline-46" class="outline-3">
<h3 id="headline-46">
0773374 add component nested slots scoping
</h3>
<div id="outline-text-headline-46" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/0773374334feb1ed86ff38c65dea917480b6cb89">fix: patchFlag should |= but != Â· gcclll/stb-vue-next@0773374</a></p>
<p>
æ’æ§½åµŒå¥—ä½¿ç”¨ã€‚</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;Comp&gt;
</span><span class="sb">    &lt;template #default=&#34;{ foo }&#34;&gt;
</span><span class="sb">        &lt;Inner v-slot=&#34;{ bar }&#34;&gt;
</span><span class="sb">        {{ foo }}{{ bar }}{{ baz }}
</span><span class="sb">        &lt;/Inner&gt;
</span><span class="sb">        {{ foo }}{{ bar }}{{ baz }}
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">&lt;/Comp&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ’æ§½åµŒå¥—ä½¿ç”¨æ—¶çš„è§£ææ˜¯å…ˆé‡Œåå¤–ï¼Œå› ä¸ºåœ¨ transform é˜¶æ®µ ast é˜¶æ®µè½¬æ¢ä¹‹åï¼Œä¼šè¿›è¡Œå›
æº¯ï¼Œå›æº¯è¿‡ç¨‹æ˜¯ç›¸åçš„ã€‚</p>
<p>
å¦‚ï¼š</p>
<p>
ast ç»“æ„ transformï¼š</p>
<p>
<code>Comp.children -&gt; [template] -&gt; template.children -&gt; [Inner, foo, bar, baz] -&gt;
Inner.children -&gt; [foo, bar, baz]</code></p>
<p>
astå›æº¯:</p>
<p>
<code>Inner.children -&gt; Inner -&gt; template.children -&gt; template -&gt; Comp.children -&gt; Comp</code></p>
<p>
æ‰€ä»¥é¦–å…ˆæ‰§è¡Œ <code>transformElement()</code> çš„æ˜¯ <code>Inner</code> æ‰€ä»¥å®ƒä¼šå…ˆè¿›å…¥ <code>buildSlots()</code> æ„
å»ºæ’æ§½ç»“æ„ï¼Œå®Œäº†ä¹‹åæ˜¯ <code>&lt;template&gt;</code> æœ€åæ˜¯ <code>&lt;Comp&gt;</code></p>
<hr>
<p>
render æ¨å¯¼è¿‡ç¨‹ï¼š</p>
<ol>
<li>
<p><code>&lt;Inner v-slot=&#34;{bar}&#34;&gt;{{foo}}{{bar}}{{baz}}&lt;/Inner&gt;</code></p>
<p>
æ˜¯åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šåº”ç”¨äº† <code>v-slot</code> ä¸”æ˜¯é»˜è®¤æ’æ§½ï¼Œå› æ­¤å®ƒçš„æ‰€æœ‰å­©å­èŠ‚ç‚¹éƒ½ä¼šæˆä¸ºé»˜è®¤
æ’æ§½ä¸€éƒ¨åˆ†ã€‚</p>
<p>
ç»“æœï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Inner</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">bar</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">baz</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* DYNAMIC */</span>
<span class="p">},</span> <span class="mi">1024</span> <span class="cm">/* DYNAMIC_SLOTS */</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>_createVNode</code> å› ä¸º <code>Inner</code> éå”¯ä¸€çš„å­©å­èŠ‚ç‚¹ã€‚</p>
</li>
<li>
<p><code>&lt;template #default=&#34;{foo}&#34;&gt;...&lt;/template&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">foo</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Inner</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
       <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">bar</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
          <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">baz</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
        <span class="p">]),</span>
       <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span>
    <span class="p">},</span> <span class="mi">1024</span> <span class="cm">/* DYNAMIC_SLOTS */</span><span class="p">),</span>
    <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="o">+</span> <span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">baz</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
è¿™é‡Œæœ‰ä¸ªåˆ¤æ–­ <code>Inner</code> ä¸ºåŠ¨æ€ slot çš„å…³é”®ç‚¹ï¼š <code>context.scopes.vSlot &gt; 0</code> è€Œè¿™ä¸ª
å€¼æ˜¯åœ¨æ”¶é›† <code>transformXxx</code> é˜¶æ®µé€’å¢ +1 è€Œåå›æº¯è¿‡ç¨‹ä¸­ -1 çš„ã€‚</p>
<p>
åœ¨æ”¶é›†é˜¶æ®µ <code>&lt;template&gt;</code> æ”¶é›†åˆ° <code>trackSlotScopes()</code> å‡½æ•°æ­¤æ—¶
<code>context.scopes.vSlot = 1</code> ç„¶åé€’å½’ childrenæ‰§è¡Œåˆ° <code>Inner</code> æ”¶é›†é˜¶æ®µçš„æ—¶å€™
<code>context.scopes.vSlot = 2</code> ç›´åˆ°é€’å½’ç»“æŸã€‚</p>
<p>
å¼€å§‹å›æº¯ï¼Œå…ˆæ˜¯åœ¨ <code>Inner</code> ä¸Šåº”ç”¨ transformElement ç›´åˆ° <code>Inner</code> å›æº¯åˆ°æ‰§è¡Œ
<code>trackSlotScopes()</code> åº”ä¸ºå®ƒä¹Ÿæœ‰ <code>v-slot</code> æŒ‡ä»¤ï¼Œæ‰€ä»¥ <code>Inner</code> èƒ½æ”¶é›†åˆ°è¿™ä¸ªå‡½æ•°ï¼Œ
å®ƒå›æº¯ç»“æŸæ‰§è¡Œ <code>trackSlotScopes()</code> éšä¹‹ <code>context.scopes.vSlot--</code> æ‰€ä»¥æ­¤æ—¶ï¼Œåœ¨
å›æº¯ <code>Inner</code> ç»“æŸä¹‹ååœ¨å¼€å§‹å›æº¯ <code>&lt;template&gt;</code> ä¹‹å‰ <code>context.scopes.vSlot = 1</code>
ã€‚</p>
<p>
è¿™å°±æ˜¯ <code>Inner</code> ä¸ºä»€ä¹ˆæ²¡æœ‰åŠ¨æ€å±æ€§åä½†æ˜¯ä¾æ—§ä¼šåˆ¤æ–­ä¸ºåŠ¨æ€æ’æ§½çš„åŸç†ã€‚</p>
<blockquote>
<p>ä¸€å¥è¯ï¼šå¦‚æœåœ¨ <code>&lt;template v-slot&gt;</code> é‡Œé¢åµŒå¥—å¦ä¸€ä¸ª <code>v-slot</code> é‚£ä¸ªè¿™ä¸ªä¸ç®¡æœ‰æ²¡æœ‰
åŠ¨æ€å±æ€§åéƒ½ä¼šè¢«å½“åšåŠ¨æ€æ’æ§½æ¥å¤„ç†ã€‚</p>
</blockquote>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-47" class="outline-3">
<h3 id="headline-47">
c1ace74 add component with v-slot inside v-for
</h3>
<div id="outline-text-headline-47" class="outline-text-3">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;div v-for=&#34;i in list&#34;&gt;
</span><span class="sb">  &lt;Comp v-slot=&#34;bar&#34;&gt;foo&lt;/Comp&gt;
</span><span class="sb">&lt;/div&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<code>let hasDynamicSlots = context.scopes.vSlot &gt; 0 || context.scopes.vFor &gt; 0;</code></p>
<p>
æ ¹æ®è¿™ä¸ªåˆ¤æ–­å†³å®š v-for é‡Œé¢çš„ v-slot ä¸ºåŠ¨æ€æ’æ§½ã€‚</p>
</div>
</div>
<div id="outline-container-headline-48" class="outline-3">
<h3 id="headline-48">
cfef20e add named slot with v-if
</h3>
<div id="outline-text-headline-48" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/cfef20efd83d030924c23308cfb1e38c2b63e228">feat(add): slot with v-if Â· gcclll/stb-vue-next@cfef20e</a></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`&lt;Comp&gt;
</span><span class="sb">  &lt;template #one v-if=&#34;ok&#34;&gt;hello&lt;/template&gt;
</span><span class="sb">&lt;/Comp&gt;`</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;
</span><span class="sb">  &lt;template #one v-if=&#34;ok&#34;&gt;hello&lt;/template&gt;
</span><span class="sb">&lt;/Comp&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, createSlots : _createSlots, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    const _component_Comp = _resolveComponent(&#34;Comp&#34;)

    return (_openBlock(), _createBlock(_component_Comp, null, _createSlots({ _: 2 /* DYNAMIC */ }, [
      ok
        ? {
            name: &#34;one&#34;,
            fn: _withCtx(() =&gt; [
              _createTextVNode(&#34;hello&#34;)
            ])
          }
        : undefined
    ]), 1024 /* DYNAMIC_SLOTS */))
  }
}
undefined
</pre>
<p>
åŠ¨æ€ slots å¤„ç†ä¹‹åï¼š
<code>_createSlots({ /* é™æ€ slots */, [ /* åŠ¨æ€ slots åˆ—è¡¨ */ ] })</code></p>
<p>
çœ‹ä¸‹é¢çš„è¿è¡Œæ—¶çš„ <code>createSlots(slots, dynamicSlots)</code> å…¶å®å°±æ˜¯è®²ä¸¤è€…åˆå¹¶åœ¨ä¸€èµ·äº†
v-if æ˜¯ä¸ªå¯¹è±¡ <code>{ fn, name }</code> v-for æ˜¯è¯¥å¯¹è±¡çš„æ•°ç»„ã€‚</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createSlots</span><span class="p">(</span>
  <span class="nx">slots</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Slot</span><span class="p">&gt;,</span>
  <span class="nx">dynamicSlots</span><span class="o">:</span> <span class="p">(</span>
    <span class="o">|</span> <span class="nx">CompiledSlotDescriptor</span>
    <span class="o">|</span> <span class="nx">CompiledSlotDescriptor</span><span class="p">[]</span>
    <span class="o">|</span> <span class="kc">undefined</span><span class="p">)[]</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">Slot</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dynamicSlots</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">slot</span> <span class="o">=</span> <span class="nx">dynamicSlots</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="c1">// array of dynamic slot generated by &lt;template v-for=&#34;...&#34; #[...]&gt;
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">slot</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">slots</span><span class="p">[</span><span class="nx">slot</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slot</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">fn</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">slot</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// conditional single slot generated by &lt;template v-if=&#34;...&#34; #foo&gt;
</span><span class="c1"></span>      <span class="nx">slots</span><span class="p">[</span><span class="nx">slot</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">fn</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">slots</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æ‹“å±•ï¼š <code>v-else, v-else-if</code>
<a href="https://github.com/gcclll/stb-vue-next/commit/e48d46a759478d28eea223c4884ec4815ceb5ac0">feat(add): v-else/v-else-if with v-slot Â· gcclll/stb-vue-next@e48d46a</a></p>
<p>
ä¸æ™®é€šçš„ v-else/v-else-if å¤„ç†æœºåˆ¶ä¸€æ ·ï¼Œé¦–å…ˆæ˜¯è¦æ‰¾åˆ°ä»–ä»¬å…„å¼ŸèŠ‚ç‚¹å‰é¢çš„ v-if èŠ‚ç‚¹ï¼Œ
ç„¶åå°†è¯¥èŠ‚ç‚¹æŒ‚æ¥åˆ° v-if èŠ‚ç‚¹åé¢ã€‚</p>
<p>
æ ¸å¿ƒä»£ç ï¼š</p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// v-else/if on slot
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span>
<span class="kd">let</span> <span class="nx">prev</span>
<span class="k">while</span> <span class="p">(</span><span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ‰¾åˆ°ç›¸é‚»çš„ v-if
</span><span class="c1"></span>    <span class="nx">prev</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
    <span class="c1">// å¾€å›æ‰¾ç¬¬ä¸€ä¸ªéæ³¨é‡Šçš„èŠ‚ç‚¹
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="kr">type</span> <span class="o">!==</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">COMMENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¦‚æœè¯¥èŠ‚ç‚¹æ˜¯ v-if åˆæ³•ï¼Œå¦åˆ™ä¸åˆæ³•ä½¿ç”¨æƒ…å†µ
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">prev</span> <span class="o">&amp;&amp;</span> <span class="nx">isTemplateNode</span><span class="p">(</span><span class="nx">prev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">findDir</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="s1">&#39;if&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// remove node
</span><span class="c1"></span>    <span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">i</span><span class="o">--</span>
    <span class="nx">__TEST__</span> <span class="o">&amp;&amp;</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">dynamicSlots</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">// attach this slot to previous conditional
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">conditional</span> <span class="o">=</span> <span class="nx">dynamicSlots</span><span class="p">[</span>
        <span class="nx">dynamicSlots</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">]</span> <span class="kr">as</span> <span class="nx">ConditionalExpression</span>

  <span class="c1">// è¿™ç›®çš„æ˜¯æ‰¾åˆ° ?: è¡¨è¾¾å¼æœ€åçš„é‚£ä¸ªèŠ‚ç‚¹
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span>
        <span class="nx">conditional</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="nx">NodeTypes</span><span class="p">.</span><span class="nx">JS_CONDITIONAL_EXPRESSION</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nx">conditional</span> <span class="o">=</span> <span class="nx">conditional</span><span class="p">.</span><span class="nx">alternate</span>
    <span class="p">}</span>

  <span class="c1">// å°†å½“å‰çš„ v-else/v-else-if æŒ‚åˆ°æœ€åé‚£ä¸ªèŠ‚ç‚¹è¡¨è¾¾å¼ä½ç½®
</span><span class="c1"></span>  <span class="c1">// vElse.exp æ£€æµ‹æ˜¯ v-else-if è¿˜æ˜¯ v-else(æ²¡æœ‰å€¼exp)
</span><span class="c1"></span>    <span class="nx">conditional</span><span class="p">.</span><span class="nx">alternate</span> <span class="o">=</span> <span class="nx">vElse</span><span class="p">.</span><span class="nx">exp</span>
        <span class="o">?</span> <span class="nx">createConditionalExpression</span><span class="p">(</span>
            <span class="nx">vElse</span><span class="p">.</span><span class="nx">exp</span><span class="p">,</span>
            <span class="nx">buildDynamicSlot</span><span class="p">(</span><span class="nx">slotName</span><span class="p">,</span> <span class="nx">slotFunction</span><span class="p">),</span>
            <span class="nx">defaultFallback</span>
        <span class="p">)</span>
        <span class="o">:</span> <span class="nx">buildDynamicSlot</span><span class="p">(</span><span class="nx">slotName</span><span class="p">,</span> <span class="nx">slotFunction</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span>
        <span class="nx">createCompilerError</span><span class="p">(</span><span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">X_V_ELSE_NO_ADJACENT_IF</span><span class="p">,</span> <span class="nx">vElse</span><span class="p">.</span><span class="nx">loc</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-49" class="outline-3">
<h3 id="headline-49">
c1ace74 add v-for on v-slot component
</h3>
<div id="outline-text-headline-49" class="outline-text-3">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/c1ace746e229db02a9b311d1becfe4deb1513048">feat(add): v-slot inside v-for Â· gcclll/stb-vue-next@c1ace74</a></p>
<p>
v-for çš„å¤„ç†å’Œ v-if åŸç†æ˜¯ä¸€æ ·çš„ï¼Œæœ€åè¿”å›çš„éƒ½æ˜¯  <code>{name, fn}</code> ç±»å‹ï¼Œåªä¸è¿‡
v-for è¿”å›çš„æ˜¯è¿™ä¸ªç±»å‹çš„æ•°ç»„ã€‚</p>
<p>
v-for _renderList å’Œ slot çš„ç»“åˆï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="mi">_</span><span class="nx">renderList</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
    <span class="nx">fn</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
      <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
    <span class="p">])</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="c1">// ç­‰äºæ˜¯ï¼š [ { name, fn }, { name1, fn1 }]
</span><span class="c1">// ç„¶å _renderSlots -&gt;
</span><span class="c1"></span><span class="mi">_</span><span class="nx">renderSlots</span><span class="p">({</span> <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span> <span class="p">},</span> <span class="p">[</span>
  <span class="mi">_</span><span class="nx">renderList</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">])</span>

<span class="c1">// -&gt; _createBlock
</span><span class="c1"></span><span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">_</span><span class="nx">renderSlots</span><span class="p">({</span>
  <span class="cm">/* é™æ€ï¼Œæœ€ç»ˆåŠ¨æ€æ’æ§½ä¼šåˆå¹¶åˆ°è¯¥å¯¹è±¡æ¥ */</span>
<span class="p">},</span> <span class="p">[</span>
  <span class="cm">/* ... åŠ¨æ€åˆ—è¡¨ */</span>
<span class="p">]))</span>

<span class="c1">// å¯¹æ¯”æ— åŠ¨æ€æ’æ§½æƒ…å†µï¼š
</span><span class="c1"></span><span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">foo</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
<p>
æµ‹è¯•ï¼š</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>
 
<span class="kr">const</span> <span class="p">{</span> <span class="nx">code</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="sb">`&lt;Comp&gt;
</span><span class="sb">        &lt;template v-for=&#34;name in list&#34; #[name]&gt;{{ name }}&lt;/template&gt;
</span><span class="sb">      &lt;/Comp&gt;`</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toDisplayString : _toDisplayString, createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, renderList : _renderList, createSlots : _createSlots, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    const _component_Comp = _resolveComponent(&#34;Comp&#34;)

    return (_openBlock(), _createBlock(_component_Comp, null, _createSlots({ _: 2 /* DYNAMIC */ }, [
      _renderList(list, (name) =&gt; {
        return {
          name: name,
          fn: _withCtx(() =&gt; [
            _createTextVNode(_toDisplayString(name), 1 /* TEXT */)
          ])
        }
      ))
    ]), 1024 /* DYNAMIC_SLOTS */))
  }
}
undefined
</pre>
<p>
æ— éå°±æ˜¯ä¸åŒç±»å‹å…ƒç´ ã€ç»„ä»¶ render æ–¹å¼çš„ç»„åˆã€‚</p>
</div>
</div>
<div id="outline-container-slot-usage" class="outline-3">
<h3 id="slot-usage">
å°ç»“ï¼šv-slot å‡ ç§ç”¨æ³•
</h3>
<div id="outline-text-slot-usage" class="outline-text-3">
<ol>
<li>
<p><code>&lt;Comp&gt;&lt;div/&gt;&lt;/Comp&gt;</code> , ç”¨æˆ·ç»„ä»¶ä¸Šçš„é»˜è®¤æ’æ§½</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>&lt;Comp v-slot=&#34;slotProps&#34;&gt;&lt;div/&gt;&lt;/Comp&gt;</code>, ç”¨æˆ·ç»„ä»¶ä¸Šå¸¦ <code>slotProps</code> çš„é»˜è®¤æ’æ§½</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>&lt;Comp v-slot:named=&#34;slotProps&#34;&gt;</code>, ç”¨æˆ·ç»„ä»¶ä¸Šå…·åæ’æ§½</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">named</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">])</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p><code>&lt;Comp v-slot:[named]=&#34;slotProps&#34;&gt;</code>, ç”¨æˆ·ç»„ä»¶ä¸ŠåŠ¨æ€å…·åæ’æ§½</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">named</span><span class="p">]</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">])</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>&lt;template&gt; é»˜è®¤æ’æ§½</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot=&#34;slotProps&#34;&gt;&lt;div/&gt;&lt;/template&gt;&lt;/Comp&gt;</code></p>
<p>
<code>&lt;template&gt;</code> ä¸Šçš„é»˜è®¤æ’æ§½ï¼Œè¿™ä¸ªæ—¶å€™ <code>&lt;Comp&gt;</code> ä¸èƒ½åœ¨ä½¿ç”¨ <code>v-slot</code> ï¼Œä¸‹åŒ </p>
</li>
<li>
<p>&lt;template&gt; å…·åæ’æ§½</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot:named=&#34;slotProps&#34;&gt;&lt;/Comp&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">named</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>&lt;template&gt; åŠ¨æ€å…·åæ’æ§½</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot:[named]=&#34;slotProps&#34;&gt;&lt;/Comp&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">named</span><span class="p">]</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[]),</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">}))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>&lt;template&gt; å…·åæ’æ§½ï¼Œå…¶ä½™é template å…ƒç´ å½“åšé»˜è®¤æ’æ§½å¤„ç†</p>
<p>
<code>&lt;Comp&gt;&lt;template v-slot:named=&#34;slotProps&#34;&gt;&lt;div/&gt;&lt;/template&gt;&lt;div :id=&#34;defaultSlotId&#34;/&gt;&lt;/Comp&gt;</code></p>
<p>
<code>&lt;template&gt;</code> ä¸Šçš„å…·åæ’æ§½ + é»˜è®¤æ’æ§½ï¼Œåœ¨ç»„ä»¶å†…çš„é &lt;template&gt; å…ƒç´ (å³ï¼š <code>&lt;div/&gt;</code>)éƒ½ä¼šè¢«åŠ¨ä½œé»˜è®¤æ’æ§½æ¥å¤„ç†</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="mi">_</span><span class="nx">hoisted_1</span> <span class="o">=</span> <span class="cm">/*# __PURE__ */</span><span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* HOISTED */</span><span class="p">)</span>
<span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">named</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">hoisted_1</span>
  <span class="p">]),</span>
  <span class="k">default</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">[</span>
    <span class="mi">_</span><span class="nx">createVNode</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">defaultSlotId</span>
    <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">8</span> <span class="cm">/* PROPS */</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">])</span>
  <span class="p">])</span>
  <span class="mi">_</span><span class="o">:</span> <span class="mi">1</span> <span class="cm">/* STABLE */</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>v-slot + v-if æ’æ§½ä½¿ç”¨</p>
<p>
<code>&lt;Comp&gt;&lt;template v-if=&#34;ok&#34; #named=&#34;slotProps&#34;&gt;{{ bar }}&lt;/template&gt;&lt;/Comp&gt;</code></p>
<p>
é…åˆ v-if ä½¿ç”¨çš„ slot template, æœ€åè§£ææˆ ï¼š
<code>ok ? { name: &#39;named&#39;, fn : _withCtx(() =&gt; [ _createTextVNode(_toDisplayString(bar)) ]) } : undefined</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">_</span><span class="nx">renderSlots</span><span class="p">(</span>
  <span class="p">{</span> <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span> <span class="p">},</span> <span class="p">[</span>
    <span class="nx">ok</span> <span class="o">?</span>
     <span class="p">{</span>
       <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;named&#39;</span><span class="p">,</span>
       <span class="nx">fn</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">((</span><span class="nx">slotProps</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span>
         <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
       <span class="p">])</span>
     <span class="p">}</span> <span class="o">:</span> <span class="kc">undefined</span>
  <span class="p">]</span>
<span class="p">)))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li>
<p>v-slot + v-for æ’æ§½ä¸Šä½¿ç”¨</p>
<p>
<code>&lt;Comp&gt;&lt;template v-for=&#34;i in list&#34; #named=&#34;{ prop }&#34;&gt;{{ bar }}&lt;/template&gt;&lt;/Comp&gt;</code></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="k">return</span> <span class="p">(</span><span class="mi">_</span><span class="nx">openBlock</span><span class="p">(),</span> <span class="mi">_</span><span class="nx">createBlock</span><span class="p">(</span><span class="mi">_</span><span class="nx">component_Comp</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">_</span><span class="nx">renderSlots</span><span class="p">(</span>
  <span class="p">{</span> <span class="mi">_</span><span class="o">:</span> <span class="mi">2</span> <span class="cm">/* DYNAMIC */</span> <span class="p">},</span>
  <span class="mi">_</span><span class="nx">renderList</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;named&#39;</span><span class="p">,</span>
      <span class="nx">fn</span><span class="o">:</span> <span class="mi">_</span><span class="nx">withCtx</span><span class="p">(({</span> <span class="nx">prop</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">[</span>
        <span class="mi">_</span><span class="nx">createTextVNode</span><span class="p">(</span><span class="mi">_</span><span class="nx">toDisplayString</span><span class="p">(</span><span class="nx">bar</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* TEXT */</span><span class="p">)</span>
      <span class="p">])</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">)))</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ol>
<blockquote>
<p>æ’æ§½æŒ‰çŠ¶æ€åˆ†ä¸ºï¼š</p>
<ol>
<li>
<p>é™æ€æ’æ§½ï¼ŒåŠ¨æ€æ’æ§½é™¤å¤–çš„æ’æ§½</p>
</li>
<li>
<p>åŠ¨æ€æ’æ§½ï¼Œæœ‰ <code>v-if/v-for/v-else[-if]</code> æŒ‡ä»¤æˆ– <code>v-slot:[named]</code> æˆ–ä½œä¸º <code>v-for</code>
èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹éƒ½è§†ä¸ºåŠ¨æ€æ’æ§½</p>
</li>
</ol>
</blockquote>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-51" class="outline-2">
<h2 id="headline-51">
update vue-next merge into stb-vue-next[2020-12-11 16:54:06]
</h2>
<div id="outline-text-headline-51" class="outline-text-2">
<p>
æ›´æ–° vue-next åˆå¹¶åˆ° stb-vue-nextã€‚</p>
<ol>
<li>
<p>ast.ts æ›´æ–°</p>
<ul>
<li>
<p><code>SimpleExpressionNode</code> : å»æ‰ <code>isConstant</code> å±æ€§ï¼Œå¢åŠ  <code>constType</code></p>
</li>
<li>
<p>å»æ‰äº† <code>StaticType</code> å¢åŠ  <code>ConstantType</code></p>
<div class="src src-typescript">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/**
</span><span class="cm">* Static types have several levels.
</span><span class="cm">* Higher levels implies lower levels. e.g. a node that can be stringified
</span><span class="cm">* can always be hoisted and skipped for patch.
</span><span class="cm">*/</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="kr">enum</span> <span class="nx">ConstantTypes</span> <span class="p">{</span>
<span class="nx">NOT_CONSTANT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="nx">CAN_SKIP_PATCH</span><span class="p">,</span>
<span class="nx">CAN_HOIST</span><span class="p">,</span>
<span class="nx">CAN_STRINGIFY</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>codegen.ts æ›´æ–°</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/521b879d80b9c982f1a15dbc89404725141674d6">fix: merge vue-next codegen.ts Â· gcclll/stb-vue-next@521b879</a></p>
</li>
<li>
<p>parse.ts æ›´æ–°</p>
<p>
ast ç»“æ„ä¸­çš„ <code>isConstant</code> æ”¹æˆ <code>ConstantTypes</code> ç±»å‹å€¼</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/fdbdc4f93ad04f6544d77bf3ebf20e4f58673930">fix: merge vue-next parse.ts isConstant -&gt; constType Â· gcclll/stb-vue-next@fdbdc4f</a></p>
</li>
<li>
<p>transform.ts æ›´æ–°</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/22a8f0be4405592621f805848533396642b4b2f2">fix: merge vue-next transform.ts Â· gcclll/stb-vue-next@22a8f0b</a></p>
<ul>
<li>
<p>add <code>filename</code></p>
</li>
<li>
<p>add <code>isTS, inline</code></p>
</li>
</ul>
</li>
<li>
<p>transformElement.ts</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/1d85990627d0383741c7050fb4af8929377691e1">fix: merge vue-next transformElement.ts Â· gcclll/stb-vue-next@1d85990</a></p>
</li>
<li>
<p>transformSlotOutlet.ts</p>
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/58e87f3adcfa0657602d459043468ac5ce8859cb">fix: merge vue-next transformSlotOutlet.ts Â· gcclll/stb-vue-next@58e87f3</a>
ä¿®æ”¹ <code>&lt;slot&gt;&lt;/slot&gt;</code> å±æ€§è§£æé€»è¾‘ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-52" class="outline-2">
<h2 id="headline-52">
6efbc86 add expression transform(node-env)
</h2>
<div id="outline-text-headline-52" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/6efbc86490fdc353c57fcaead5201c46696bb3d4">feat: transformExpression -&gt; processExpression Â· gcclll/stb-vue-next@6efbc86</a></p>
<p>
transformExpression å¤„ç†çš„æ˜¯å¤æ‚è¡¨è¾¾å¼æƒ…å†µï¼Œä¸”éœ€è¦åœ¨éæµè§ˆå™¨ç¯å¢ƒï¼Œå› ä¸ºå®ƒéœ€è¦ä¾èµ–
ä¸€äº› JavaScript è§£æå™¨æ¥ååŠ©å®Œæˆã€‚</p>
<p>
éœ€è¦å¤„ç†çš„ä¸¤ç§ç±»å‹ï¼š</p>
<ol>
<li>
<p><code>INTERPOLATION</code> æ’å€¼ç±»å‹</p>
</li>
<li>
<p><code>ELEMENT</code> ç±»å‹ä¸”æ²¡æœ‰ <code>v-for</code> æŒ‡ä»¤çš„æ ‡ç­¾ï¼Œå¯¹äºæŒ‡ä»¤éœ€è¦å¤„ç†çš„æœ‰ <code>arg, exp</code> å¦‚æœ
å‚æ•°æ˜¯åŠ¨æ€çš„æƒ…å†µ</p>
</li>
</ol>
<p>
ä¸¤è€…æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ <code>processExpression(node, context, asPrarms, asRawStatement)</code> è¿™
ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ‰ç‚¹å¤æ‚ï¼Œéœ€è¦æ…¢æ…¢æ¶ˆåŒ–ğŸ• ğŸ• ğŸ• </p>
</div>
</div>
<div id="outline-container-headline-53" class="outline-2">
<h2 id="headline-53">
TODOs(ssr render, node env, setup meta)
</h2>
<div id="outline-text-headline-53" class="outline-text-2">
<p>
åœ¨æ­¤ä¹‹å‰éƒ½æ˜¯åŸºäºæµè§ˆå™¨å»å®Œæˆå’Œæµ‹è¯•çš„ï¼Œä½†æ˜¯ç”±äºåé¢ compiler-dom æœ‰äº›æµ‹è¯•åŒæ ·éœ€è¦
node ç¯å¢ƒæ”¯æŒï¼Œå› æ­¤è¿™é‡Œå¿…é¡»å…ˆå®Œæˆæ‰€æœ‰æµè§ˆå™¨çš„æ”¯æŒï¼Œè¿™æ · <code>prefixIdentifiers</code>
å’Œ <code>cacheHandlers</code> ä¹Ÿå°†æ”¯æŒã€‚</p>
<p>
add generate imports and module mode:
<a href="https://github.com/gcclll/stb-vue-next/commit/ea7f16b87df7ffc9aa5018889488b963240acb71">feat: gen imports Â· gcclll/stb-vue-next@ea7f16b</a></p>
<p>
<strong>TODO</strong> ssr template literal:
<a href="https://github.com/gcclll/stb-vue-next/commit/356bc93c3086500a5a41211bbeb3faa8267bd727">feat(add): gen template literal Â· gcclll/stb-vue-next@356bc93</a></p>
<p>
<strong>TODO</strong> ssr if generate:
<a href="https://github.com/gcclll/stb-vue-next/commit/1c424beb5e2cf21515799cbce245ef3337ff4f41">feat(add): ssr gen if statement Â· gcclll/stb-vue-next@1c424be</a> </p>
<p>
<strong>TODO</strong> ssr assigment expression generate: ç”Ÿæˆèµ‹å€¼è¡¨è¾¾å¼
<a href="https://github.com/gcclll/stb-vue-next/commit/1f99a11193478460a572708fa9829969f443c9be">feat(add): ssr gen assignment expression Â· gcclll/stb-vue-next@1f99a11</a></p>
<p>
<strong>TODO</strong> ssr generate sequence exprssion:
<a href="https://github.com/gcclll/stb-vue-next/commit/81aa0b009f7978f7ef5f9d1f9bcbc0d99f70c1c3">feat(add): ssr gen sequence expression Â· gcclll/stb-vue-next@81aa0b0</a></p>
<p>
<strong>TODO</strong> ssr generate return statement:
<a href="https://github.com/gcclll/stb-vue-next/commit/c85406cbfbc356bb00562ea4366907f1fbb1980b">feat(add): ssr gen return statement Â· gcclll/stb-vue-next@c85406c</a></p>
<p>
<strong>TODO</strong> ssr v-on transform:
<a href="https://github.com/gcclll/stb-vue-next/commit/adefeeceddccf23bdf2c3373d3d28be1bd35878f">feat(add): ssr v-on transform Â· gcclll/stb-vue-next@adefeec</a></p>
<p>
<strong>TODO</strong> setup mode v-model on ref:
<a href="https://github.com/gcclll/stb-vue-next/commit/20bb40dd2fdb9222005a71ac019ef96a820268e5">feat(add): setup mode v-model on ref Â· gcclll/stb-vue-next@20bb40d</a></p>
<p>
<strong>TODO</strong> process expression in vIf.ts
<a href="https://github.com/gcclll/stb-vue-next/commit/56c49c7f8924e786f8648b063c9a6d8a4252c4c2">feat(add): v-if process expression Â· gcclll/stb-vue-next@56c49c7</a></p>
<p>
<strong>TODO</strong> setup mode ref in transformElement
<a href="https://github.com/gcclll/stb-vue-next/commit/54f467f57f2ed0deb061b6602c3154a2be407840">feat(add): transform ref in setup mode in transformElement Â· gcclll/stb-vue-next@54f467f</a></p>
</div>
</div>
<div id="outline-container-headline-54" class="outline-2">
<h2 id="headline-54">
non-browser testing(éæµè§ˆå™¨ç¯å¢ƒæµ‹è¯•)
</h2>
<div id="outline-text-headline-54" class="outline-text-2">
<p>
æœ¬ç« èŠ‚æµ‹è¯•éƒ½æ˜¯åŸºäº node ç¯å¢ƒè¿›è¡Œæµ‹è¯•çš„ï¼Œæµ‹è¯•ä»£ç ä½äºå„ä¸ª package ç›®å½•ä¸‹çš„
<code>__nests__</code> (node tests ç¼©å†™)é‡Œé¢ã€‚</p>
<p>
ç”±äºæµ‹è¯•è¾“å‡ºç»“æœè¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨æ§åˆ¶å°å½¢å¼è¾“å‡ºï¼Œè¯· <code>&lt;f12&gt;</code> æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹</p>
<script>
l1(`hoist static testing é™æ€æå‡æµ‹è¯•`)
c(`<div/>`, 'should NOT hoist root node')
</script>
<script src="/js/vue/node.env.test.js"></script>
</div>
</div>
<div id="outline-container-headline-55" class="outline-2">
<h2 id="headline-55">
jest è·‘ğŸƒç”¨ä¾‹
</h2>
<div id="outline-text-headline-55" class="outline-text-2">
<p>
<a href="https://github.com/gcclll/stb-vue-next/commit/2085dd62df2c63d76475988a88f1e3fdc2586e7d">fix: jest errors Â· gcclll/stb-vue-next@2085dd6</a></p>
<pre class="example">
@vue/runtime-dom (guessing &#39;runtimeDom&#39;)
created packages/vue/dist/vue.global.js in 5.1s
 PASS  packages/compiler-core/__tests__/transforms/transformElement.spec.ts (9.278 s)
 PASS  packages/compiler-core/__tests__/transforms/vModel.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vFor.spec.ts
 PASS  packages/compiler-core/__tests__/parse.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/hoistStatic.spec.ts
 PASS  packages/compiler-core/__tests__/codegen.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vIf.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vSlot.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/transformExpressions.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vOn.spec.ts
 PASS  packages/compiler-core/__tests__/transform.spec.ts
 PASS  packages/compiler-core/__tests__/compile.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/transformSlotOutlet.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/transformText.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vOnce.spec.ts
 PASS  packages/compiler-core/__tests__/scopeId.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/vBind.spec.ts
 PASS  packages/compiler-core/__tests__/transforms/noopDirectiveTransform.spec.ts
 PASS  packages/compiler-core/__tests__/utils.spec.ts

Test Suites: 19 passed, 19 total
Tests:       480 passed, 480 total
Snapshots:   205 passed, 205 total
Time:        17.699 s
</pre>
<p>
å…¨éƒ¨é€šè¿‡æµ‹è¯•ï¼ŒæœŸé—´å‡ºç°ä¸¤ä¸ªå°é—®é¢˜ï¼š</p>
<ol>
<li>
<p>transformElement é‡Œé¢è§£æåŠ¨æ€å±æ€§(<code>vnodeDynamicProps</code>)çš„æ—¶å€™ä¼šå°†è¿™äº›å±æ€§ç»„æˆ
å­—ç¬¦ä¸²æ•°ç»„ï¼Œè¿™é‡Œå°‘äº†ä¸ªé€—å·</p>
<p>
<img src="http://qiniu.ii6g.com/img/20201218162357.png" alt="http://qiniu.ii6g.com/img/20201218162357.png" title="http://qiniu.ii6g.com/img/20201218162357.png" /></p>
</li>
<li>
<p><code>genFunctionExpression()</code> é‡Œé¢å°†å‡½æ•° <code>}</code> é”™å†™æˆäº† <code>)</code></p>
<p>
<img src="http://qiniu.ii6g.com/img/20201218162509.png" alt="http://qiniu.ii6g.com/img/20201218162509.png" title="http://qiniu.ii6g.com/img/20201218162509.png" /></p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-56" class="outline-2">
<h2 id="headline-56">
ç»¼åˆæµ‹è¯•
</h2>
<div id="outline-text-headline-56" class="outline-text-2">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
<span class="kr">const</span> <span class="p">{</span>
  <span class="nx">baseParse</span><span class="p">,</span>
  <span class="nx">baseCompile</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span> <span class="o">+</span> <span class="s1">&#39;/../../static/js/vue/compiler-core.global.js&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">tpl</span> <span class="p">=&gt;</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">tpl</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">hoistStatic</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">code</span>
<span class="kd">let</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="sb">``</span><span class="p">,</span> <span class="nx">code</span> <span class="o">=</span> <span class="sb">``</span>
<span class="nx">tpl</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">&lt;div :id=&#34;status&#34; class=&#34;status&#34; :style=&#34;{ color: &#39;red&#39; }&#34;&gt;
</span><span class="sb">  &lt;button v-if=&#34;opened&#34; @click=&#34;opened = !opened&#34;&gt;å…³é—­&lt;/button&gt;
</span><span class="sb">  &lt;button v-else-if=&#34;invalid&#34; v-on.enter=&#34;{ clicked: toggleValid }&#34;&gt;æœ‰æ•ˆ&lt;/button&gt;
</span><span class="sb">  &lt;button v-else @click.prevent=&#34;() =&gt; opened = true&#34;&gt;æ‰“å¼€&lt;/button&gt;
</span><span class="sb">  &lt;p :name=&#34;vbind&#34;&gt;v-bind ç¼©å†™&lt;/p&gt;
</span><span class="sb">  &lt;p class=&#34;vbind-no-arg&#34; v-bind=&#34;{ name: &#39;vbind&#39; }&#34;&gt;æ— å‚æ•°çš„ v-bind&lt;/p&gt;
</span><span class="sb">&lt;/div&gt;
</span><span class="sb">&lt;div id=&#34;list&#34; :class=&#34;list&#34; style=&#34;color:red;&#34;&gt;
</span><span class="sb">  &lt;ul&gt;
</span><span class="sb">    &lt;li v-for=&#34;(value, key, index) in list&#34;&gt;{{ value }}&lt;/li&gt;
</span><span class="sb">  &lt;/ul&gt;
</span><span class="sb">&lt;/div&gt;
</span><span class="sb">&lt;div id=&#34;once&#34; :class=&#34;once&#34;&gt;{{ once }}&lt;/div&gt;
</span><span class="sb">&lt;div id=&#34;user-comp&#34; :class=&#34;user-comp&#34;&gt;
</span><span class="sb">  &lt;!-- æˆ‘æ˜¯æ³¨é‡Šï¼šç”¨æˆ·ç»„ä»¶ --&gt;
</span><span class="sb">  &lt;List&gt;{{ &#34;æˆ‘æ˜¯ &lt;List/&gt; çš„é»˜è®¤æ’æ§½&#34; }}&lt;/List&gt;
</span><span class="sb">  &lt;List v-slot=&#34;{ prop }&#34;&gt;&lt;p class=&#34;title&#34;&gt;æˆ‘æ˜¯å¸¦ slotProps({{ prop }}) çš„é»˜è®¤æ’æ§½&lt;/p&gt;&lt;/List&gt;
</span><span class="sb">  &lt;List v-slot:title=&#34;{ prop }&#34;&gt;&#34;æˆ‘æ˜¯å¸¦åå­—{{ prop }}çš„æ’æ§½&#34;&lt;/List&gt;
</span><span class="sb">  &lt;List&gt;
</span><span class="sb">    &lt;template v-slot:one=&#34;slotProps&#34;&gt;&lt;p&gt;{{ slotProps.title }}&lt;/p&gt;&lt;/template&gt;
</span><span class="sb">    &lt;p&gt;æˆ‘æ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†&lt;/p&gt;
</span><span class="sb">    &lt;p&gt;æˆ‘ä¹Ÿæ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†&lt;/p&gt;
</span><span class="sb">    &lt;p&gt;æˆ‘ä¹Ÿæ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&lt;/p&gt;
</span><span class="sb">    &lt;p&gt;æˆ‘ä»¬éƒ½æ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&lt;/p&gt;
</span><span class="sb">  &lt;/List&gt;
</span><span class="sb">  &lt;List&gt;
</span><span class="sb">    &lt;template&gt;
</span><span class="sb">      &lt;p&gt;æˆ‘æ˜¯é»˜è®¤æ’æ§½&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">    &lt;template v-slot:one=&#34;{ prop }&#34;&gt;
</span><span class="sb">      &lt;p&gt;æˆ‘æ˜¯åå­—ä¸º one çš„å…·åæ’æ§½æ’æ§½({{ prop }})&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">  &lt;/List&gt;
</span><span class="sb">  &lt;List v-if=&#34;ok&#34; v-slot:one=&#34;slotProps&#34;&gt;&lt;p&gt;æˆ‘æ˜¯å¸¦ v-if æŒ‡ä»¤çš„ä¸” v-slot å¼•ç”¨åœ¨ç»„ä»¶ä¸Šçš„å…·å &#34;one&#34; æ’æ§½ï¼Œæ ‡é¢˜å±æ€§ï¼š {{ slotProps.title }}&lt;/p&gt;&lt;/List&gt;
</span><span class="sb">  &lt;List&gt;
</span><span class="sb">    &lt;template&gt;&lt;!-- æˆ‘æ˜¯é»˜è®¤æ’æ§½ï¼Œç»™ä½ ä»¬æ³¨é‡Šç”¨çš„ï¼ï¼ï¼ï¼ï¼ï¼ --&gt;&lt;/template&gt;
</span><span class="sb">    &lt;template v-if=&#34;ok&#34; v-slot:one=&#34;{ prop }&#34;&gt;
</span><span class="sb">      &lt;p&gt;å¸¦ v-if + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">    &lt;template v-for=&#34;(value, key, index) in list&#34; v-slot:two=&#34;slotProps&#34;&gt;
</span><span class="sb">      &lt;p&gt;å¸¦ v-for + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°&lt;/p&gt;
</span><span class="sb">    &lt;/template&gt;
</span><span class="sb">  &lt;/List&gt;
</span><span class="sb">&lt;/div&gt;
</span><span class="sb">`</span>
<span class="nx">code</span> <span class="o">=</span> <span class="nx">c</span><span class="p">(</span><span class="nx">tpl</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`&gt;&gt;&gt; å¤æ‚åº”ç”¨åœºæ™¯`</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">log</span><span class="p">(</span><span class="sb">`\n&gt; æ³¨é‡Š\n`</span><span class="p">,</span>
    <span class="sb">`1. v-on è¡¨è¾¾å¼ä¸ºç®€å•è¡¨è¾¾å¼æ—¶ä¼šè¢«å¤„ç†æˆä¸€ä¸ªç®­å¤´å‡½æ•°\n`</span><span class="p">,</span>
    <span class="sb">`2. v-on å¦‚æœæ²¡æœ‰å‚æ•°æ—¶ï¼Œä¼šè§¦å‘è¯¥ç»„ä»¶ä¸Šçš„æ‰€æœ‰å±æ€§åˆå¹¶(_mergeProps(...))\n`</span><span class="p">,</span>
    <span class="sb">`3. v-on è¡¨è¾¾å¼ä¸ºä¸€ä¸ªå‡½æ•°å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†\n`</span><span class="p">,</span>
    <span class="sb">`4. v-for è°ƒç”¨ _renderList(list, fn) æ¸²æŸ“åˆ—è¡¨ï¼Œlist åˆ—è¡¨æ•°æ®æ¥æºï¼Œfn åˆ—è¡¨é¡¹æ¸²æŸ“å‡½æ•°\n`</span><span class="p">,</span>
    <span class="sb">`5. v-slot åº”ç”¨åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šæ—¶ï¼Œé‡Œé¢å°±ä¸èƒ½åœ¨ä½¿ç”¨ v-slot\n`</span><span class="p">,</span>
    <span class="sb">`6. åªè¦åœ¨ template ä¸Šåº”ç”¨äº† v-if/v-for æˆ–è€…å°†ç”¨æˆ·ç»„ä»¶æ”¾åœ¨ v-for ä¸‹é¢è¿™äº›æ’æ§½éƒ½ä¼šè¢«å½“åšåŠ¨æ€æ’æ§½å¤„ç†\n`</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
&gt;&gt;&gt; å¤æ‚åº”ç”¨åœºæ™¯
const _Vue = Vue
const { createVNode: _createVNode, createCommentVNode: _createCommentVNode, createTextVNode: _createTextVNode } = _Vue

const _hoisted_1 = { class: &#34;title&#34; }
const _hoisted_2 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;æˆ‘æ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†&#34;, -1 /* HOISTED */)
const _hoisted_3 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;æˆ‘ä¹Ÿæ˜¯é»˜è®¤æ’æ§½çš„ä¸€éƒ¨åˆ†&#34;, -1 /* HOISTED */)
const _hoisted_4 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;æˆ‘ä¹Ÿæ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&#34;, -1 /* HOISTED */)
const _hoisted_5 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;æˆ‘ä»¬éƒ½æ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&#34;, -1 /* HOISTED */)
const _hoisted_6 = /*#__PURE__*/_createVNode(&#34;template&#34;, null, [
  /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;æˆ‘æ˜¯é»˜è®¤æ’æ§½&#34;)
], -1 /* HOISTED */)
const _hoisted_7 = /*#__PURE__*/_createVNode(&#34;template&#34;, null, [
  /*#__PURE__*/_createCommentVNode(&#34; æˆ‘æ˜¯é»˜è®¤æ’æ§½ï¼Œç»™ä½ ä»¬æ³¨é‡Šç”¨çš„ï¼ï¼ï¼ï¼ï¼ï¼ &#34;)
], -1 /* HOISTED */)
const _hoisted_8 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;å¸¦ v-if + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°&#34;, -1 /* HOISTED */)
const _hoisted_9 = /*#__PURE__*/_createVNode(&#34;p&#34;, null, &#34;å¸¦ v-for + v-slot + template çš„åŠ¨æ€æ’æ§½ï¼Œæˆ‘åº”è¯¥è¦ç”¨åˆ° _createSlots(staticSlots, dynamicSLots) å‡½æ•°&#34;, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock, createCommentVNode : _createCommentVNode, toHandlers : _toHandlers, mergeProps : _mergeProps, renderList : _renderList, Fragment : _Fragment, toDisplayString : _toDisplayString, createTextVNode : _createTextVNode, resolveComponent : _resolveComponent, withCtx : _withCtx, createSlots : _createSlots } = _Vue

    const _component_List = _resolveComponent(&#34;List&#34;)

    return (_openBlock(), _createBlock(_Fragment, null, [
      _createVNode(&#34;div&#34;, {
        id: status,
        class: &#34;status&#34;,
        style: { color: &#39;red&#39; }
      }, [
        opened
          ? (_openBlock(), _createBlock(&#34;button&#34;, {
              key: 0,
              onClick: $event =&gt; (opened = !opened)
            }, &#34;å…³é—­&#34;, 8 /* PROPS */, [&#34;onClick&#34;]))
          : invalid
            ? (_openBlock(), _createBlock(&#34;button&#34;, _mergeProps({ key: 1 }, _toHandlers({ clicked: toggleValid })), &#34;æœ‰æ•ˆ&#34;, 16 /* FULL_PROPS */))
            : (_openBlock(), _createBlock(&#34;button&#34;, {
                key: 2,
                onClick: () =&gt; opened = true
              }, &#34;æ‰“å¼€&#34;, 8 /* PROPS */, [&#34;onClick&#34;])),
        _createVNode(&#34;p&#34;, { name: vbind }, &#34;v-bind ç¼©å†™&#34;, 8 /* PROPS */, [&#34;name&#34;]),
        _createVNode(&#34;p&#34;, _mergeProps({ class: &#34;vbind-no-arg&#34; }, { name: &#39;vbind&#39; }), &#34;æ— å‚æ•°çš„ v-bind&#34;, 16 /* FULL_PROPS */)
      ], 12 /* STYLE, PROPS */, [&#34;id&#34;]),
      _createVNode(&#34;div&#34;, {
        id: &#34;list&#34;,
        class: list,
        style: &#34;color:red;&#34;
      }, [
        _createVNode(&#34;ul&#34;, null, [
          (_openBlock(true), _createBlock(_Fragment, null, _renderList(list, (value, key, index) =&gt; {
            return (_openBlock(), _createBlock(&#34;li&#34;, null, _toDisplayString(value), 1 /* TEXT */))
          )), 256 /* UNKEYED_FRAGMENT */))
        ])
      ], 2 /* CLASS */),
      _createVNode(&#34;div&#34;, {
        id: &#34;once&#34;,
        class: once
      }, _toDisplayString(once), 3 /* TEXT, CLASS */),
      _createVNode(&#34;div&#34;, {
        id: &#34;user-comp&#34;,
        class: user-comp
      }, [
        _createCommentVNode(&#34; æˆ‘æ˜¯æ³¨é‡Šï¼šç”¨æˆ·ç»„ä»¶ &#34;),
        _createVNode(_component_List, null, {
          default: _withCtx(() =&gt; [
            _createTextVNode(_toDisplayString(&#34;æˆ‘æ˜¯ &lt;List/&gt; çš„é»˜è®¤æ’æ§½&#34;), 1 /* TEXT */)
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          default: _withCtx(({ prop }) =&gt; [
            _createVNode(&#34;p&#34;, _hoisted_1, &#34;æˆ‘æ˜¯å¸¦ slotProps(&#34; + _toDisplayString(prop) + &#34;) çš„é»˜è®¤æ’æ§½&#34;, 1 /* TEXT */)
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          title: _withCtx(({ prop }) =&gt; [
            _createTextVNode(&#34;\&#34;æˆ‘æ˜¯å¸¦åå­—&#34; + _toDisplayString(prop) + &#34;çš„æ’æ§½\&#34;&#34;, 1 /* TEXT */)
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          one: _withCtx((slotProps) =&gt; [
            _createVNode(&#34;p&#34;, null, _toDisplayString(slotProps.title), 1 /* TEXT */)
          ]),
          default: _withCtx(() =&gt; [
            _hoisted_2,
            _hoisted_3,
            _hoisted_4,
            _hoisted_5
          ]),
          _: 1 /* STABLE */
        }),
        _createVNode(_component_List, null, {
          one: _withCtx(({ prop }) =&gt; [
            _createVNode(&#34;p&#34;, null, &#34;æˆ‘æ˜¯åå­—ä¸º one çš„å…·åæ’æ§½æ’æ§½(&#34; + _toDisplayString(prop) + &#34;)&#34;, 1 /* TEXT */)
          ]),
          default: _withCtx(() =&gt; [
            _hoisted_6
          ]),
          _: 1 /* STABLE */
        }),
        ok
          ? (_openBlock(), _createBlock(_component_List, { key: 0 }, {
              one: _withCtx((slotProps) =&gt; [
                _createVNode(&#34;p&#34;, null, &#34;æˆ‘æ˜¯å¸¦ v-if æŒ‡ä»¤çš„ä¸” v-slot å¼•ç”¨åœ¨ç»„ä»¶ä¸Šçš„å…·å \&#34;one\&#34; æ’æ§½ï¼Œæ ‡é¢˜å±æ€§ï¼š &#34; + _toDisplayString(slotProps.title), 1 /* TEXT */)
              ]),
              _: 1 /* STABLE */
            }))
          : _createCommentVNode(&#34;v-if&#34;, true),
        _createVNode(_component_List, null, _createSlots({
          default: _withCtx(() =&gt; [
            _hoisted_7
          ]),
          _: 2 /* DYNAMIC */
        }, [
          ok
            ? {
                name: &#34;one&#34;,
                fn: _withCtx(({ prop }) =&gt; [
                  _hoisted_8
                ])
              }
            : undefined,
          _renderList(list, (value, key, index) =&gt; {
            return {
              name: &#34;two&#34;,
              fn: _withCtx((slotProps) =&gt; [
                _hoisted_9
              ])
            }
          ))
        ]), 1024 /* DYNAMIC_SLOTS */)
      ], 2 /* CLASS */)
    ], 64 /* STABLE_FRAGMENT */))
  }
}

&gt; æ³¨é‡Š
 1. v-on è¡¨è¾¾å¼ä¸ºç®€å•è¡¨è¾¾å¼æ—¶ä¼šè¢«å¤„ç†æˆä¸€ä¸ªç®­å¤´å‡½æ•°
 2. v-on å¦‚æœæ²¡æœ‰å‚æ•°æ—¶ï¼Œä¼šè§¦å‘è¯¥ç»„ä»¶ä¸Šçš„æ‰€æœ‰å±æ€§åˆå¹¶(_mergeProps(...))
 3. v-on è¡¨è¾¾å¼ä¸ºä¸€ä¸ªå‡½æ•°å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
 4. v-for è°ƒç”¨ _renderList(list, fn) æ¸²æŸ“åˆ—è¡¨ï¼Œlist åˆ—è¡¨æ•°æ®æ¥æºï¼Œfn åˆ—è¡¨é¡¹æ¸²æŸ“å‡½æ•°
 5. v-slot åº”ç”¨åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šæ—¶ï¼Œé‡Œé¢å°±ä¸èƒ½åœ¨ä½¿ç”¨ v-slot
 6. åªè¦åœ¨ template ä¸Šåº”ç”¨äº† v-if/v-for æˆ–è€…å°†ç”¨æˆ·ç»„ä»¶æ”¾åœ¨ v-for ä¸‹é¢è¿™äº›æ’æ§½éƒ½ä¼šè¢«å½“åšåŠ¨æ€æ’æ§½å¤„ç†

undefined
</pre>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2020-11-30
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue/">vue,</a>
          <a href="/tags/vue3/">vue3,</a>
          <a href="/tags/compiler-core/">compiler-core,</a>
          <a href="/tags/parser/">parser,</a>
          <a href="/tags/compiler/">compiler,</a>
          <a href="/tags/transform/">transform</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/vue/vue-mind-map-compiler-dom/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 4 â˜compiler-dom</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/vue/vue-mind-map-compiler-core-parser/">
            <span class="next-text nav-default">Vue3 æºç å¤´è„‘é£æš´ä¹‹ 2 â˜compiler-core - ast parser</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Zhicheng Lee</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.db4c43431f3833e1a48d3c8754f77c8250eedde3c20810a308f35779fdf8acd1.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
