<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>JavaScript - Promise 实现(0-1) - 若叶知秋</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhicheng Lee" /><meta name="description" content="源码参考链接：https://github.com/stefanpenner/e" /><meta name="keywords" content="Vue, React, JavaScript, Python" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />




<meta name="generator" content="Hugo 0.76.5 with theme even" />


<link rel="canonical" href="https://www.cheng92.com/post/javascript-ecma-promise/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.82a3cd5d48f8908f385c7cb4088edc324ee1dcab1ade8b3f6f6c51097e700594.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/global.css">


<meta property="og:title" content="JavaScript - Promise 实现(0-1)" />
<meta property="og:description" content="源码参考链接：https://github.com/stefanpenner/e" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cheng92.com/post/javascript-ecma-promise/" />
<meta property="article:published_time" content="2020-10-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-10-12T00:00:00+00:00" />
<meta itemprop="name" content="JavaScript - Promise 实现(0-1)">
<meta itemprop="description" content="源码参考链接：https://github.com/stefanpenner/e">
<meta itemprop="datePublished" content="2020-10-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-10-12T00:00:00+00:00" />
<meta itemprop="wordCount" content="9652">



<meta itemprop="keywords" content="javascript,,es6,,promise," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JavaScript - Promise 实现(0-1)"/>
<meta name="twitter:description" content="源码参考链接：https://github.com/stefanpenner/e"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">若叶知秋</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/emacs/">
        <li class="mobile-menu-item">Emacs</li>
      </a><a href="/algo/">
        <li class="mobile-menu-item">Algorithm</li>
      </a><a href="/vue/">
        <li class="mobile-menu-item">Vue</li>
      </a><a href="/react/">
        <li class="mobile-menu-item">React</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">若叶知秋</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/emacs/">Emacs</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/algo/">Algorithm</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/vue/">Vue</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/react/">React</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li id="search">
        <img class="icon" src="/img/search.png"/>
        <input type="search" class="docsearch-input" placeholder="Search" style="display:none;" />
      </li></ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">JavaScript - Promise 实现(0-1)</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-10-12 </span>
        <div class="post-category">
            <a href="/categories/javascript/"> javascript </a>
            </div>
          <span class="more-meta"> 约 9652 字 </span>
          <span class="more-meta"> 预计阅读 20 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">构造函数 Promise</a>
</li>
<li><a href="#headline-2">resolve 和 reject 函数</a>
</li>
<li><a href="#headline-3">asap 函数</a>
</li>
<li><a href="#headline-4">then 函数实现</a>
<ul>
<li><a href="#headline-5">then 功能说明：</a>
</li>
<li><a href="#headline-6">需要完成的函数： </a>
</li>
<li><a href="#headline-7">then 链式调用：</a>
</li>
</ul>
</li>
<li><a href="#headline-8">then callback 返回对象或函数</a>
<ul>
<li><a href="#headline-9">value 可能是 <code>null</code></a>
</li>
<li><a href="#headline-10">value 返回的是一个 <code>Promise</code> 实例</a>
</li>
<li><a href="#headline-11">value 有可能有自己的 <code>then</code> 函数呢？</a>
</li>
</ul>
</li>
<li><a href="#headline-12">Promise Api 实现</a>
<ul>
<li><a href="#headline-13">Promise.reject(rejectHandler)</a>
</li>
<li><a href="#headline-14">Promise.race(entries)</a>
</li>
<li><a href="#headline-15">Promise.any(entries)</a>
</li>
<li><a href="#headline-16">Promise.all(entries)</a>
</li>
<li><a href="#headline-17">Promise.allSettled(entries)<sup>es2020</sup></a>
</li>
<li><a href="#headline-18">Promise.prototype.finally(onFinally)</a>
</li>
<li><a href="#headline-19">Promise.prototype.catch(onRejection)</a>
</li>
</ul>
</li>
<li><a href="#headline-20">完整脑图</a>
</li>
<li><a href="#headline-21">Jest 测试</a>
</li>
<li><a href="#headline-22">总结</a>
</li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      
<script src="/js/promise.js"></script>
<blockquote>
<p>源码参考链接：<a href="https://github.com/stefanpenner/es6-promise">https://github.com/stefanpenner/es6-promise</a></p>
</blockquote>
<p>
<kbd>
<a href="/js/promise.js">完整的 promise.js 链接</a>
</kbd> </p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
构造函数 Promise
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<ol>
<li>
<p>三个状态: <code>PENDING</code>, <code>FULFILL</code>, <code>REJECT</code> 。</p>
</li>
<li>
<p>PID 记录 promise id 属性</p>
</li>
<li>
<p><code>_state</code> 当前 promise 的状态(pending/fulfill/reject)</p>
</li>
<li>
<p><code>_result</code> 当前 promise 任务执行的结果值</p>
</li>
<li>
<p><code>_subs</code> 当前 promise 的订阅者(then 时注册的 resolver/rejection)</p>
</li>
<li>
<p>构造函数中立即执行 resolver 根据任务执行情况由使用者决定是调用
resolvePromise 还是 rejectPromise</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">var</span> <span class="nx">PID</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">PENDING</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">FULFILL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">REJECT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">proto</span> <span class="o">=</span> <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">noop</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>

  <span class="kd">function</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolver</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">[</span><span class="nx">PID</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="nx">PENDING</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_result</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_subs</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nb">Promise</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&#34;只能通过new 构造 Promise 实例。&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">resolver</span><span class="p">(</span>
        <span class="kd">function</span> <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">(</span><span class="nx">_this</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="kd">function</span> <span class="nx">rejectPromise</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">_this</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="nx">then</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;resolve&#39;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">reject</span><span class="p">()</span> <span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
  测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 resolve
</pre>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
resolve 和 reject 函数
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
这两个函数至关重要，他们负责改变 promise 的状态值，也是整个 Promise 实现过程中唯
一能改变状态值的地方。</p>
<p>
他们的执行会触发所有回调的执行(<code>promise._subs</code>)。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">returnSelfPromise</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Util</span><span class="p">.</span><span class="nx">isObjectOrFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span><span class="p">.</span><span class="nx">_state</span> <span class="o">!==</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">promise</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="nx">REJECT</span><span class="p">;</span>
    <span class="nx">promise</span><span class="p">.</span><span class="nx">_result</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>

    <span class="nx">asap</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">publish</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
asap 函数
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// 将所有任务添加到一个队列，根据平台决定调用那个异步函数
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">qlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">asap</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">[</span><span class="nx">qlen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>

    <span class="nx">qlen</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">qlen</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 这里是通过第一次入列操作来触发 flush 队列操作
</span><span class="c1"></span>      <span class="c1">// 因为 flush 是异步执行，所以在它还没之前之前有可能有新的任务入列
</span><span class="c1"></span>      <span class="c1">// 这个时候 qlen &gt; 1 ，直到 flush 执行，通过 qlen 遍 queue 确保在执行的时刻
</span><span class="c1"></span>      <span class="c1">// 可以将这之前的所有入列的任务都得到执行
</span><span class="c1"></span>      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">flush</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">flush</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">qlen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>

      <span class="c1">// 清空已执行的任务
</span><span class="c1"></span>      <span class="nx">queue</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 在此刻至 Flush之前入列的任务都得到了执行，重置重新接受新的任务
</span><span class="c1"></span>    <span class="nx">qlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
按照 Promise 的定义，被 Promise 定义的任务不论代码是异步的还是同步的，都会被当做
异步任务来执行，比如：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)=&gt;</span> <span class="p">{</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
200
100
</pre>
<p>
结果显示 200 先输出，后输出 100，但是其实我们在 <code>new Promise()</code> 的时候传入的函数
里面其实都是同步代码，经过 Promise 封装置后都成了异步的了。</p>
<p>
因此这里的 asap 就是这个作用，当任务就算是同步代码的时候，依然将其变成异步任务去
执行。</p>
<p>
并且这里使用了一个队列 <code>queue</code> 来管理这些任务，针对原作者的代码做了一些改动，去
掉了平台有关的代码，并将任务直接二次封装成了一个函数，所以这里是 <code>qlen++</code> 而不是
<code>qlen +=2</code> 。</p>
<p>
这里如果不仔细思考可能还不太好理解原作者为什么这么做？？？</p>
<ol>
<li>
<p>为什么 <code>qlen === 1</code> 的时候触发 <code>flush</code> ?</p>
<blockquote>
<p><strong>答</strong> ：其实想明白了也简单，就是为了只要队列是空的时候一旦有新的任务进来就立即触发任务
 出列 flush 掉队列中所有的任务，并且是顺序执行，顺序执行，顺序执行，重要的事
 情说三遍嘛，想象下如果没有这个机制，一旦有 promise settled 了，就调用一个
 setTimeout ? </p>
<p>
 有了这个机制之后，在 当前的 setTimeout flush 之前，会尽可能的让当前队列承载
 更多的 promise 任务，直到 flush 结束，重启另一个 setTimeout。</p>
</blockquote>
</li>
<li>
<p>为什么不直接使用 queue 数组的长度来控制 ?</p>
<blockquote>
<p>TODO</p>
</blockquote>
</li>
</ol>
<p>
情景测试：在 flush 之前 qlen 值发生变化了，需要做点修改让效果更直观。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">asap</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">[</span><span class="nx">qlen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>

    <span class="nx">qlen</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">qlen</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 这里加大 flush 的时间点，让 asap 有足够的时间来响应更多的异步任务
</span><span class="c1"></span>      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">flush</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试代码：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;p1 then 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>

   <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;p2 then 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;p3 then 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;p4 then 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
{ qlen: 1 }
{ qlen: 2 }
{ qlen: 3 }
{ qlen: 4 }
100 p1 then 1
100 p2 then 1
100 p3 then 1
100 p4 then 1
</pre>
<p>
看到没， <code>qlen=4</code> 了，因为我们在 asap 中调用 flush 的时候加了 3 秒的延时，所以能
很直观的看得到在一个 settimeout 回调之前会接受到多个 promise 任务。</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
then 函数实现
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<div id="outline-container-headline-5" class="outline-4">
<h4 id="headline-5">
then 功能说明：
</h4>
<div id="outline-text-headline-5" class="outline-text-4">
<ol>
<li>
<p>收集 pending 状态 promise 的 callback(存放到 <code class="verbatim">_subs</code> 中)</p>
<p>
因为 promise 任务如果异步的，调用 <code>then(resolve,reject)</code> 的时候，resolve 和
reject 是不应该立即执行的，必须等异步任务结束之后再执行，否则就不符合了 promise
原则(异步任务同步化)。</p>
<p>
所以当 promise 任务是异步情况下，then 函数的功能应该是用来收集 resolve/reject
的，等待任务结束后调用。</p>
</li>
<li>
<p>作为 then 链式调用的桥梁，即这个桥梁必须是在这个函数里面去完成的。</p>
</li>
</ol>
<p>
既然有了收集，那必然就有触发动作，触发也必须等待任务执行完成才会触发，也就是说这
个动作必须是在 <code>resolve()</code> 里面完成，因为 Promise 使用者会根据自己任务情况去在适
当的位置调用 resolve 和 reject。</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-4">
<h4 id="headline-6">
需要完成的函数： 
</h4>
<div id="outline-text-headline-6" class="outline-text-4">
<ul>
<li class="indeterminate">
<p><code>fulfill(promise, value)</code> ，任务成功完成</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span><span class="p">.</span><span class="nx">_state</span> <span class="o">!==</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 状态已经完成不能再改变状态
</span><span class="c1"></span>      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">promise</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="nx">FULFILL</span><span class="p">;</span>
    <span class="nx">promise</span><span class="p">.</span><span class="nx">_result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span><span class="p">.</span><span class="nx">_subs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">asap</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">publish</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="indeterminate">
<p><code>publish(promise)</code> </p>
<p>
任务完成之后 flush 掉所有回调(then pending 阶段收集的 <code class="verbatim">_subs[]</code>)</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">publish</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">subs</span> <span class="o">=</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">_subs</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">child</span><span class="p">,</span>
        <span class="nx">callback</span><span class="p">,</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">subs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">child</span> <span class="o">=</span> <span class="nx">subs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">subs</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">_state</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO 异步任务
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">subs</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="indeterminate">
<p><code>subscribe(parent, child, onFulfillment, onRejection)</code></p>
<p>
如果任务是个异步任务就不会立即执行，要等到任务结束才能执行回调，所以就必须要有
个地方能将这些回调收集到当前的 <strong>promise</strong> 实例中，等待调用。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">subscribe</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">onFulfillment</span><span class="p">,</span> <span class="nx">onRejection</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">subs</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_subs</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">subs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="c1">// PENDING
</span><span class="c1"></span>    <span class="nx">subs</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
    <span class="nx">subs</span><span class="p">[</span><span class="nx">len</span> <span class="o">+</span> <span class="nx">FULFILL</span><span class="p">]</span> <span class="o">=</span> <span class="nx">onFulfillment</span><span class="p">;</span>
    <span class="nx">subs</span><span class="p">[</span><span class="nx">len</span> <span class="o">+</span> <span class="nx">REJECT</span><span class="p">]</span> <span class="o">=</span> <span class="nx">onRejection</span><span class="p">;</span>

    <span class="c1">// parent promise 状态如果完成了，立即触发当前 child 的 promise
</span><span class="c1"></span>    <span class="c1">// 可能执行到这里的时候任务刚好完成了???
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_state</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">asap</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">publish</span><span class="p">(</span><span class="nx">parent</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="indeterminate">
<p><code>then(onFulfillment, onRejection)</code>  </p>
<p>
这里要区分两种情况，一种是 pending 状态和非 pending 状态的处理，pending 说明可
能是异步任务还没结束，不能立即 settled，调用 subscribe() 去收集回调。</p>
<p>
一种是非 pending 状态，在调用 then 之后只有一种情况会使得 promise 状态改变了，
那就是任务立即执行，调用了 <strong>resolve</strong> 或 <strong>reject</strong> 设置了 <code>promise._state</code> 改变
了状态，因为只有这两个函数才会改变 promise 状态值。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">then</span><span class="p">(</span><span class="nx">onFulfillment</span><span class="p">,</span> <span class="nx">onRejection</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="c1">// 创建一个新的 promise，用来衔接后面的 then
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">(</span><span class="nx">noop</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_state</span><span class="p">;</span>
    <span class="c1">// 根据状态决定执行哪个回调
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_state</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_state</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 状态已经改变，任务已经完成了，直接执行回调
</span><span class="c1"></span>      <span class="nx">invokeCallback</span><span class="p">(</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 订阅所有回调
</span><span class="c1"></span>      <span class="nx">subscribe</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">onFulfillment</span><span class="p">,</span> <span class="nx">onRejection</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">child</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
<li class="indeterminate">
<p><code>invokeCallback(settled, promise, callback, detail)</code></p>
<p>
这个函数承载了当前 then promise1 的回调执行并解析结果(异常处理)，然后将值传递
给下一个 then promise2(then 里面 <code>new this.constructor(noop)</code> 出来的)，调用
<code>resolve(child)~或 ~reject(child)</code> 去触发 promise2 的回调。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">invokeCallback</span><span class="p">(</span><span class="nx">settled</span><span class="p">,</span> <span class="nx">promise</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">detail</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span><span class="p">;</span> <span class="c1">// 记录 callback 执行的结果
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">hasCallback</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">&#34;function&#34;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">succeeded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// callback 可能执行失败
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">error</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">hasCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 开始执行 callback, 即 then(resolve, reject) 的 Resolve/Reject
</span><span class="c1"></span>      <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// 将上一个 promise 结果作为参数传递到 then 回调
</span><span class="c1"></span>        <span class="nx">value</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">detail</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 回调执行失败，有错误或者异常
</span><span class="c1"></span>        <span class="nx">error</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
        <span class="nx">succeeded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">returnSelfPromise</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 没有回调的时候 then() ???
</span><span class="c1"></span>      <span class="nx">value</span> <span class="o">=</span> <span class="nx">detail</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 这里要检测下一个新 new 的 promise 状态
</span><span class="c1"></span>    <span class="c1">// 下面的动作都是为了下一个 then 做准备的，这里的promise
</span><span class="c1"></span>    <span class="c1">// 是在上一个 then 里面的new 出来的 promise 衔接下一个 then 用
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span><span class="p">.</span><span class="nx">_state</span> <span class="o">!==</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// noop 状态完成了的 promise
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hasCallback</span> <span class="o">&amp;&amp;</span> <span class="nx">succeeded</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 执行成功， resolve
</span><span class="c1"></span>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">succeeded</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// then 中的回调执行失败了
</span><span class="c1"></span>      <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">settled</span> <span class="o">===</span> <span class="nx">FULFILL</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">settled</span> <span class="o">===</span> <span class="nx">REJECT</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</li>
</ul>
<p>测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 1 resolve&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
+RESULTS 实现 invokeCallback 之前:</p>
<pre class="example">
undefined
</pre>
<p>
这里没任何输出，因为还没实现 <code>invokeCallback(settled, promise, callback,
detail)</code> 这里面会针对 then 的 resolve 或 reject 执行结果做出相应的处理。</p>
<p>
实现关键点： </p>
<ol>
<li>
<p>callback 实际上是 <code>then(resolve, reject)</code> 中的 resolve/reject ，根据上一个
promise 状态 <code>settled</code> 决定的。</p>
</li>
<li>
<p>使用 try…catch 捕获 callback 执行异常，确保 then 回调也能受 Promise 规则约
束。</p>
</li>
<li>
<p>几种情况决定调用 resolve 还是 reject 进入下一个链式回调(<strong>then</strong>)。</p>
</li>
</ol>
<p>+RESULTS 实现 invokeCallback 之后:</p>
<pre class="example">
100 then 1 resolve
</pre>
<p>
此时的 promise._subs 如下：</p>
<pre class="example">
[
  MyPromise {
    &#39;8st4da5md17&#39;: 1,
    _state: 0,
    _result: undefined,
    _subs: [] // 这是那个 child promise
  },
  [Function (anonymous)], // 这里是 then resolver
  undefined // 这里是 then rejection 因为没传所以是 undefined
]
</pre>
</div>
</div>
<div id="outline-container-headline-7" class="outline-4">
<h4 id="headline-7">
then 链式调用：
</h4>
<div id="outline-text-headline-7" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="cm">/* p1 */</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 1 resolve&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">200</span>
  <span class="p">},</span> <span class="cm">/* p2 */</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="cm">/* p3 */</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 2 resolve&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">300</span>
  <span class="p">},</span> <span class="cm">/* p4 */</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 then 1 resolve
200 then 2 resolve
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-8" class="outline-2">
<h2 id="headline-8">
then callback 返回对象或函数
</h2>
<div id="outline-text-headline-8" class="outline-text-2">
<p>
针对返回对象的情况，其实也可以跟普通类型处理一样：</p>
<p>
首先要把 Resolve 里面对对象和函数的检测去掉，或者也让它执行 <code>fulfill(promise,
value)</code> :</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">returnSelfPromise</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Util</span><span class="p">.</span><span class="nx">isObjectOrFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
实例：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, then 1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;then 1 return&#39;</span> <span class="p">}</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, then 2&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 , then 1
{ name: &#39;then 1 return&#39; } , then 2
</pre>
<p>
但是如果有多个 then 链式调用的情况，一般都会返回一个对象，并且常见情况会是一个异
步的 promise ，这样统一当成普通类型处理就显得不太合理了，这也是为何<a href="https://github.com/stefanpenner/es6-promise">原作者</a>将返回
值是 <strong>函数或对象</strong> 的时候分开处理了。</p>
<p>
因为在实际使用中，有以下几种场景：</p>
<ul>
<li>
<p>返回纯对象类型(非 promise 或 带有 then 的对象)</p>
</li>
<li>
<p>返回一个新的 promise 实例</p>
</li>
<li>
<p>返回一个带有 then 的对象或函数</p>
</li>
</ul>
<p>所以需要做一些特殊处理。</p>
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
value 可能是 <code>null</code>
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<p>
   捕获这种情况异常执行 reject。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">returnSelfPromise</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Util</span><span class="p">.</span><span class="nx">isObjectOrFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">then</span><span class="p">;</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">then</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// value 可能是 undefined 或 null，或其他非法类型(如：数字)
</span><span class="c1"></span>        <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// handleMaybeThenable(promise, value, then);
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="kc">null</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;p then resolve 1&#39;</span><span class="p">)</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;, p then reject 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
Cannot read property &#39;then&#39; of null , p then reject 1
</pre>
</div>
</div>
<div id="outline-container-headline-10" class="outline-4">
<h4 id="headline-10">
value 返回的是一个 <code>Promise</code> 实例
</h4>
<div id="outline-text-headline-10" class="outline-text-4">
<p>
   即使用者在 then 回调里面 new 了一个 Promise 实例返回出来，这也是常见的使用场
   景之一，经常会有多个有依赖前后结果的异步请求的时候，通过 promise then 来链
   式同步执行。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">returnSelfPromise</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Util</span><span class="p">.</span><span class="nx">isObjectOrFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">then</span><span class="p">;</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">then</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// value 可能是 undefined 或 null，或其他非法类型(如：数字)
</span><span class="c1"></span>        <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">handleMaybeThenable</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">then</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   增加 <code>handleMaybeThenable(promise, value, then);</code> 函数处理其他情况。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">handleMaybeThenable</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">thenable</span><span class="p">,</span> <span class="nx">then</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// originalThen 实现的 then 函数，即 MyPromise.prototype.then
</span><span class="c1"></span>    <span class="c1">// 这能确保 thenable 的确是我们的 MyPromise 实例
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">thenable</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">&amp;&amp;</span> <span class="nx">thenable</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">===</span> <span class="nx">originalResolve</span> <span class="o">&amp;&amp;</span> <span class="nx">thenable</span><span class="p">.</span><span class="nx">then</span> <span class="o">===</span> <span class="nx">originalThen</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 这里要做的处理是直接针对 thenable 状态做出判断
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">thenable</span><span class="p">.</span><span class="nx">_state</span> <span class="o">===</span> <span class="nx">FULFILL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">thenable</span><span class="p">.</span><span class="nx">_result</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">thenable</span><span class="p">.</span><span class="nx">_state</span> <span class="o">===</span> <span class="nx">REJECT</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">thenable</span><span class="p">.</span><span class="nx">_result</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 直接构造 resolver 和 rejection
</span><span class="c1"></span>        <span class="nx">subscribe</span><span class="p">(</span><span class="nx">thenable</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">val</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">val</span><span class="p">),</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">reason</span><span class="p">))</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// TODO
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   这样，我们就可以处理 then 回调中返回一个 Promise 实例的情况了。</p>
<p>
   测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 1 resolve&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
    <span class="p">})</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 2 resolve&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 , p then 1 resolve
200 , p then 2 resolve
undefined
</pre>
<p>
   所以很顺利的就看到了正确的结果，因为返回的本身就是 MyPromise ，所以只需要根据
   其状态做相应的处理即可(<code>fulfill</code> / <code>reject</code> / <code>subscribe</code>)。</p>
</div>
</div>
<div id="outline-container-headline-11" class="outline-4">
<h4 id="headline-11">
value 有可能有自己的 <code>then</code> 函数呢？
</h4>
<div id="outline-text-headline-11" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">handleForeignThenable</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">thenable</span><span class="p">,</span> <span class="nx">then</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">asap</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">sealed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// 保证只会执行一次
</span><span class="c1"></span>      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">then</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
          <span class="nx">thenable</span><span class="p">,</span>
          <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sealed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="nx">sealed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">thenable</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sealed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="nx">sealed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sealed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 1 resolve&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">,</span> <span class="s1">&#39;object then&#39;</span><span class="p">)</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 2 resolve&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 , p then 1 resolve
[Function (anonymous)] [Function (anonymous)] object then
200 , p then 2 resolve
</pre>
<p>
   如果返回的对象类型属性有一个 then 函数的话，则 MyPromise 的处理是将 resolve 和
   reject 封装一层传递给外部的 then ，由它决定何时使用？。</p>
<p>
   注释 <code>resolve(200)</code> 之后：</p>
<pre class="example">
100 , p then 1 resolve
[Function (anonymous)] [Function (anonymous)] object then
</pre>
<blockquote>
<p>对比下原生的 Promise 呢，将 MyPromise 换成 Promise </p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 1 resolve&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">,</span> <span class="s1">&#39;object then&#39;</span><span class="p">)</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 2 resolve&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 , p then 1 resolve
[Function (anonymous)] [Function (anonymous)] object then
200 , p then 2 resolve
</pre>
<p>
   结果和 MyPromise 一样，如果在 object then 中不调用 resolve 或 reject 结果，
   那么 then 链也会断开：</p>
<pre class="example">
100 , p then 1 resolve
[Function (anonymous)] [Function (anonymous)] object then
</pre>
</blockquote>
<p>
   <span style="text-decoration: underline;"><strong>疑问 1： foreign then 的 resolve 为什么要判断返回值是不是等于该对象自身？</strong></span></p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">thenable</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fulfill</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   <strong>答</strong> ：如果 <code>value === thenable</code> ，直接调用 <code>resolve(promise, value)</code> 会造成死循
   环 resolve -&gt; value.then is function -&gt; handleMaybeThenable -&gt;
   handleForeignThenable -&gt; resolve -&gt; …</p>
<p>
   验证方法，将 asap 延迟时间加大，并且给 asap 套一层，加上延时时间，如下：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">asap</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">[</span><span class="nx">qlen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>

    <span class="nx">qlen</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">qlen</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 这里是通过第一次入列操作来触发 flush 队列操作
</span><span class="c1"></span>      <span class="c1">// 因为 flush 是异步执行，所以在它还没之前之前有可能有新的任务入列
</span><span class="c1"></span>      <span class="c1">// 这个时候 qlen &gt; 1 ，直到 flush 执行，通过 qlen 遍 queue 确保在执行的时刻
</span><span class="c1"></span>      <span class="c1">// 可以将这之前的所有入列的任务都得到执行
</span><span class="c1"></span>      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">flush</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">bakAsap</span> <span class="o">=</span> <span class="nx">asap</span>
  <span class="nx">asap</span> <span class="o">=</span> <span class="nx">cb</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">bakAsap</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   这样可以避免卡死，每隔 500ms 会执行一次 asap，3000ms 之后 flush queue。</p>
<p>
   修改如下，直接 resolve：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sealed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">sealed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">resolve</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>

    <span class="c1">// if (value !== thenable) {
</span><span class="c1"></span>    <span class="c1">//   resolve(promise, value);
</span><span class="c1"></span>    <span class="c1">// } else {
</span><span class="c1"></span>    <span class="c1">//   fulfill(promise, value);
</span><span class="c1"></span>    <span class="c1">// }
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   修改用例：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 1 resolve&#39;</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="s1">&#39;, object then&#39;</span><span class="p">)</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">obj</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, p then 2 resolve&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
   执行结果：</p>
<pre class="example">
 ➜  js git:(master) ✗ node promise.js
 100 , p then 1 resolve
 0 , object then
 1 , object then
 2 , object then
 3 , object then
 4 , object then
 5 , object then
 6 , object then
 // 如果不停止会一直执行下去，因为死循环了
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-12" class="outline-2">
<h2 id="headline-12">
Promise Api 实现
</h2>
<div id="outline-text-headline-12" class="outline-text-2">
<p>
在 <a href="https://tc39.es/ecma262/#sec-promise-objects">ecma262 文档</a>中我们知道 Promise 有如下 APIs：</p>
<table>
<thead>
<tr>
<th></th>
<th>名称</th>
<th>简介</th>
</tr>
</thead>
<tbody>
<tr>
<td>Promise</td>
<td><code>all(iterable)</code></td>
<td>满足条件：所有 promises 都 fulfilled</td>
</tr>
<tr>
<td></td>
<td><code>allSettled(iterable)</code></td>
<td>不在乎结果是 FULFILL 还是 REJECT，只要所有的任务状态都改变了就 FULFILL 否则 REJECT</td>
</tr>
<tr>
<td></td>
<td><code>any(iterable)</code></td>
<td>只要有一个任务 FULFILL 结果就是 FULFILL 否则 REJECT</td>
</tr>
<tr>
<td></td>
<td><code>race(iterable)</code></td>
<td>竞争关系，第一个状态改变发生改变 race 状态就跟着改变，是啥就是啥，FULFILL -&gt; FULFILL, REJECT -&gt; REJECT</td>
</tr>
<tr>
<td></td>
<td><code>reject(rejectHandler)</code></td>
<td>返回一个必定 REJECT 的 promise</td>
</tr>
<tr>
<td></td>
<td><code>resolve(fulfillHandler)</code></td>
<td>返回一个必定 FULFILL 的 promise</td>
</tr>
</tbody>
<tbody>
<tr>
<td>Promise.prototype</td>
<td><code>catch(onRejected)</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>finally(onFinally)</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>then(onFulfilled, onRejected)</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>
当目前表中的函数只实现了 <code>then</code> 和 <code>resolve</code> 下面将一一实现它们。</p>
<div id="outline-container-headline-13" class="outline-4">
<h4 id="headline-13">
Promise.reject(rejectHandler)
</h4>
<div id="outline-text-headline-13" class="outline-text-4">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;test reject result&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="s1">&#39;, p reject then&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
test reject result , p reject then
</pre>
<p>
这个跟 Promise.resolve 一样，直接创建一个 Promise 实例 ins，调用 <code>reject(ins,
reason)</code> </p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">
  <span class="kd">function</span> <span class="nx">originalReject</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ctor</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&#34;object&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nx">ctor</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">ins</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">(</span><span class="nx">noop</span><span class="p">);</span>
    <span class="nx">reject</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">ins</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-14" class="outline-4">
<h4 id="headline-14">
Promise.race(entries)
</h4>
<div id="outline-text-headline-14" class="outline-text-4">
<p>
race 竞争机制，只要有一个 fulfilled 了就立即结束。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, race then resolve&#39;</span><span class="p">)</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="s1">&#39;, race then reject&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
200 , race then reject
</pre>
<p>
只要有一个状态改变了就里面结束 race ，它不在乎结束的时候那个 promise 是
<strong>fulfilled</strong> 还是 <strong>rejected</strong> 。</p>
<p>
实现：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">race</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entries</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ctor</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">entries</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&#34;race 参数必须是一个数组&#34;</span><span class="p">))</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// 遍历所有任务
</span><span class="c1"></span>        <span class="kr">const</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// 直接调用 resolve 去执行任务，然后挂一个 then
</span><span class="c1"></span>          <span class="c1">// 因为 resolve 和 reject 只会被执行一次，所以一旦只要有个 entry
</span><span class="c1"></span>          <span class="c1">// 结束了就会执行后面的 then 去调用 resolve 或 reject，
</span><span class="c1"></span>          <span class="c1">// 后面的就算执行到了也 settled 了，也不会重复执行 resolve 和 reject
</span><span class="c1"></span>          <span class="nx">ctor</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">entries</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-15" class="outline-4">
<h4 id="headline-15">
Promise.any(entries)
</h4>
<div id="outline-text-headline-15" class="outline-text-4">
<p>只要有个 promise fulfilled 了，返回的 promise 状态就会变成 fulfilled，否则是
rejected，并且 rejected then 的回调接受的参数 reason 会是 entries 中所有
rejected promise 结果值数组.</p>
<p>
修改点：将应该 <code>fulfill()</code> 地方换成 <code>reject()</code> 。</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">Enumerator</span><span class="p">(</span><span class="nx">entries</span><span class="p">,</span> <span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ctor</span><span class="p">(</span><span class="nx">noop</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">option</span> <span class="o">=</span> <span class="nx">option</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="c1">// 保存结束的函数，所有任务都 settled 之后调用的函数
</span><span class="c1"></span>    <span class="c1">// Promise.any 所有的 REJECT 会调用 reject
</span><span class="c1"></span>    <span class="c1">// Promise.all 所有的都 FULFILL 会调用 fulfill
</span><span class="c1"></span>    <span class="c1">// 所以要区分开
</span><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">$settle</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">isPromiseAnyFlag</span> <span class="o">?</span> <span class="nx">reject</span> <span class="o">:</span> <span class="nx">fulfill</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">entries</span><span class="p">))</span> <span class="p">{</span>

      <span class="c1">// ... 省略
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 结束了
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">$settle</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_enumerate</span><span class="p">(</span><span class="nx">entries</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// 所有任务状态改变了
</span><span class="c1"></span>          <span class="k">this</span><span class="p">.</span><span class="nx">$settle</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 必须是数组类型
</span><span class="c1"></span>      <span class="nx">reject</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&#34;必须提供数组类型&#34;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">Enumerator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_enumerate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entries</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="c1">// 当前 promise 状态处于 PENDING 状态下进行遍历
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">_state</span> <span class="o">===</span> <span class="nx">PENDING</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">then</span><span class="p">,</span> <span class="nx">error</span><span class="p">;</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">then</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">error</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">then</span> <span class="o">===</span> <span class="nx">originalThen</span> <span class="o">&amp;&amp;</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">_state</span> <span class="o">!==</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ... 省略
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">then</span> <span class="o">!==</span> <span class="s2">&#34;function&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ... 省略
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nx">Ctor</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ctor</span><span class="p">(</span><span class="nx">noop</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// 这里如果执行错误要区分下是 Promise.any 还是 Promise.all
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">isPromiseAnyFlag</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span><span class="o">--</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="nx">entry</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">}</span>

        <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Enumerator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_settle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">opt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">option</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">_state</span> <span class="o">===</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span><span class="o">--</span><span class="p">;</span>

      <span class="c1">// 修改点
</span><span class="c1"></span>      <span class="c1">// for Promise.any
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">isPromiseAnyFlag</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="nx">REJECT</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Promise.any 应该 reject
</span><span class="c1"></span>      <span class="c1">// 修改点
</span><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">$settle</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">any</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, any then resolve 1&#39;</span><span class="p">)</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="s1">&#39;, any then reject 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">any</span><span class="p">([</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, any then resolve 2&#39;</span><span class="p">)</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="s1">&#39;, any then reject 2&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
[ 200, 300 ] , any then reject 2
100 , any then resolve 1
</pre>
<p>
第一行输出：p2, p3 都是 <strong>REJECT</strong> ，所以最后结果是 <strong>REJECT</strong>
第二行输出：p1, p2 中 p1 是 <strong>FULFILL</strong> ，所以最后结果是 <strong>FULFILL</strong></p>
</div>
</div>
<div id="outline-container-headline-16" class="outline-4">
<h4 id="headline-16">
Promise.all(entries)
</h4>
<div id="outline-text-headline-16" class="outline-text-4">
<p>
all 函数的实现关键：要等到所有的 promise 状态都 settled 了，才能 fulfill。</p>
<p>
然后任务有异步也可能有同步任务(即 promise 状态是否立即改变)，不管如何都要等到他
们状态发生改变了之后才能让 all 结束，所以两种处理情况</p>
<ol>
<li>
<p>状态立即发生改变了的，直接记录</p>
</li>
<li>
<p>状态是 PENDING 的注册记录回调直到所有任务都完成</p>
</li>
<li>
<p>如果遇到有一个 rejected 的立即结束，否则等待所有都 fulfilled 才结束，并且将所
有 fulfilled 结果组成数组传递给下一个 promise。</p>
</li>
</ol>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="c1">// 简化版本，只处理：
</span><span class="c1"></span>  <span class="c1">// 1. entry 是 promise 类型，
</span><span class="c1"></span>  <span class="c1">// 2. entry 是普通类型(非 promise，then 不是函数)
</span><span class="c1"></span>  <span class="nx">Enumerator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_enumerateSimple</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entries</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">_state</span> <span class="o">===</span> <span class="nx">PENDING</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nx">Ctor</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 是个 promise 任务
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">_state</span> <span class="o">!==</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_settle</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_willSettle</span><span class="p">(</span><span class="nx">entry</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 非 promise 类型处理
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span><span class="o">--</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Enumerator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_enumerate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entries</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    <span class="c1">// 当前 promise 状态处于 PENDING 状态下进行遍历
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">_state</span> <span class="o">===</span> <span class="nx">PENDING</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">then</span><span class="p">,</span> <span class="nx">error</span><span class="p">;</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">then</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">error</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">then</span> <span class="o">===</span> <span class="nx">originalThen</span> <span class="o">&amp;&amp;</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">_state</span> <span class="o">!==</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// entry 不一定是 Promise 但有 then 函数，且状态改变了的
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">_settle</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">then</span> <span class="o">!==</span> <span class="s2">&#34;function&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 普通类型值
</span><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span><span class="o">--</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nx">Ctor</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 到这里前提条件：
</span><span class="c1"></span>        <span class="c1">// 1. then 不是 originalThen 或 entry._state = PENDING
</span><span class="c1"></span>        <span class="c1">// 2. then 是个函数
</span><span class="c1"></span>        <span class="c1">// 3. this.promise 是我们定义的 MyPromise
</span><span class="c1"></span>        <span class="c1">// 那么将 entry 用 MyPromise 封装
</span><span class="c1"></span>        <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ctor</span><span class="p">(</span><span class="nx">noop</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">entry</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">handleMaybeThenable</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">entry</span><span class="p">,</span> <span class="nx">then</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_willSettle</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_willSettle</span><span class="p">(</span><span class="k">new</span> <span class="nx">Ctor</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">entry</span><span class="p">)),</span> <span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Enumerator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_settle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">_state</span> <span class="o">!==</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span><span class="o">--</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="nx">REJECT</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">Enumerator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_willSettle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 订阅结果
</span><span class="c1"></span>    <span class="nx">subscribe</span><span class="p">(</span>
      <span class="nx">promise</span><span class="p">,</span>
      <span class="kc">undefined</span><span class="p">,</span>
      <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_settle</span><span class="p">(</span><span class="nx">FULFILL</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">value</span><span class="p">),</span>
      <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_settle</span><span class="p">(</span><span class="nx">REJECT</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">reason</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
<a href="https://github.com/stefanpenner/es6-promise">原作者的实现</a>通过封装了一个 <code>Enumerator</code> 来实现 <code>Promise.all</code> 其中有一个构造函数
(<code>Enumerator</code>)和三个原型函数(<code>_settle</code>, <code>_willSettle</code>, <code>_enumrate</code>)。</p>
<ol>
<li>
<p><code>Enumerator</code> 接受一个 <strong>entries</strong> 是一个数组</p>
<p>
构造函数初始化了几个变量：</p>
<ul>
<li>
<p><code>_length</code> 即 entries 任务的个数</p>
</li>
<li>
<p><code>_remaining</code> 任务状态是 PENDING 的个数，通过检测这个是不是为零来判断是不是
所有任务都结束了。</p>
</li>
<li>
<p><code>_result</code> 一个结果数组，保存所有任务执行的结果。</p>
</li>
</ul>
</li>
<li>
<p><code>_settle</code> 检测当前 entry 的状态，如果是 <code>REJECT</code> 就让 <code>this.promise</code> <strong>REJECT</strong>
，结束循环，否则保存结果，最后检测 <code>this._remaining</code> 。</p>
</li>
<li>
<p><code>_willSettle</code> 因为 entry 的状态可能是 <strong>PENDING</strong> 所以要执行订阅，等待它结束再进
入 <code>_settle</code> 回到第 2 步。</p>
</li>
</ol>
<p>
所以这个函数的实现关键取决于 entry 状态是否是立即改变了，如果是直接检测结果，否
则构造该 entry 的 <code>onFulfillment</code> 和 <code>onRejection</code> 并执行订阅，等待它结束再检测
结果。最后根据结果决定 <code>this.promise</code> 状态，因为 <code>Promise.all</code> <strong>FULFILL</strong> 的条件
是所有任务都 <strong>FULFILL</strong> 才行，所以只要遇到一个 entry rejected 了那么
<code>this.promise</code> 就应该结束且状态是 <strong>REJECT</strong> 。</p>
<p>
测试</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s1">&#39;, promise all 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="s1">&#39;, promise all 2&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
300 , promise all 2
[ 100, 200 ] , promise all 1
</pre>
<p>
改成原生 Promise 结果：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s1">&#39;, promise all 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="s1">&#39;, promise all 2&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
300 , promise all 2
[ 100, 200 ] , promise all 1
</pre>
<p>
结果 OK。</p>
</div>
</div>
<div id="outline-container-headline-17" class="outline-4">
<h4 id="headline-17">
Promise.allSettled(entries)<sup>es2020</sup>
</h4>
<div id="outline-text-headline-17" class="outline-text-4">
<p>这个和 <code>Promise.all</code> 区别在于，它不在乎 entries 中任务的状态是 <strong>FULFILL</strong> 还是 <strong>REJECT</strong> ，
只要它状态 settled 即可，且会等到所有任务都 settled 了才会 <strong>FULFILL</strong> 。</p>
<p>
所以这里的实现和 <code>Promise.all</code> 会有所差别，但依然可以通过对 <code>Enumerator</code> 做细微
改动来实现。</p>
<p>
修改点：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">Enumerator</span><span class="p">(</span><span class="nx">entries</span><span class="p">,</span> <span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ctor</span><span class="p">(</span><span class="nx">noop</span><span class="p">));</span>
    <span class="c1">// 修改点1：增加 Promise.allSettled flag
</span><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">isAllSettledFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">option</span> <span class="o">===</span> <span class="s2">&#34;object&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">isAllSettledFlag</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">option</span><span class="p">.</span><span class="nx">isAllSettledFlag</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ... 省略
</span><span class="c1"></span>  <span class="p">}</span>


  <span class="nx">Enumerator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_settle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">_state</span> <span class="o">===</span> <span class="nx">PENDING</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span><span class="o">--</span><span class="p">;</span>

      <span class="c1">// api 不是 Promise.allSettled
</span><span class="c1"></span>      <span class="c1">// 修改点2：增加判断是不是 Promise.allSettled 调用
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="nx">REJECT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isAllSettledFlag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_remaining</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fulfill</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_result</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span> <span class="mi">80</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s1">&#39;, promise allSettled 1 resolve&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">value</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s1">&#39;, promise allSettled 2 resolve&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
[ 100, 200 ] , promise allSettled 1 resolve
[ 100, 300 ] , promise allSettled 2 resolve
</pre>
</div>
</div>
<div id="outline-container-headline-18" class="outline-4">
<h4 id="headline-18">
Promise.prototype.finally(onFinally)
</h4>
<div id="outline-text-headline-18" class="outline-text-4">
<p>
这个函数目的就是不管 promise 任务最重是 fulfilled 还是 rejected 都会被执行。</p>
<p>
实现如下：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kd">function</span> <span class="nx">originalFinally</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ctor</span> <span class="o">=</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
    <span class="c1">// 1. 保证 callback 总是执行，即相当于在最后又挂了个 then，
</span><span class="c1"></span>    <span class="c1">//   这样就能保证之前有多少 then 且这些 then 结果是 fulfilled 还是 rejected
</span><span class="c1"></span>    <span class="c1">//   这个都会被执行
</span><span class="c1"></span>    <span class="c1">// 2. 回调 callback 要被执行且要保证 callback 的执行结果
</span><span class="c1"></span>    <span class="c1">//   也能符合 promise then 链规则
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s2">&#34;function&#34;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">)).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">),</span>
        <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">ctor</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">callback</span><span class="p">(</span><span class="nx">reason</span><span class="p">)).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="nx">reason</span><span class="p">;</span>
        <span class="p">})</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 1&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="k">finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;finally 1&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">val</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 2&#39;</span><span class="p">)</span>
    <span class="c1">// 这里引用未声明类型，会报错
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;reject 2&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="k">finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;finally 2&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="k">finally</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 3&#39;</span><span class="p">)</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;reject 3&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
原生 Promise 执行结果</p>
<pre class="example">
100 then 1
finally 1
undefined then 2
finally 2
a is not defined reject 3
</pre>
<p>
注意这里有几点功能需要完成：</p>
<ol>
<li>
<p>finally 总是要被执行</p>
</li>
<li>
<p>finally 的参数可以是普通类型的值</p>
</li>
<li>
<p>finally 调用之后后面还可以继续链式调用，即它执行完也要返回一个 Promise 实例</p>
</li>
</ol>
<p>换成 MyPromise:</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 1&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="k">finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;finally 1&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">val</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 2&#39;</span><span class="p">)</span>
    <span class="c1">// 这里引用未声明类型，会报错
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;reject 2&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="k">finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;finally 2&#39;</span><span class="p">)</span>
  <span class="p">}).</span><span class="k">finally</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 3&#39;</span><span class="p">)</span>
  <span class="p">},</span> <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;reject 3&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 then 1
finally 1
undefined then 2
finally 2
a is not defined reject 3
</pre>
<p>
使用 MyPromise 之后又两个异常，被后面两个 then rejection 捕获到了： <strong>promise is
not defined</strong> ，这说明 finally</p>
<p>
增加返回值传递给 finally 回调，测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;then 1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">200</span>
  <span class="p">}).</span><span class="k">finally</span><span class="p">((</span><span class="nx">val</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, finally 1&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 then 1
200 , finally 1
undefined
</pre>
</div>
</div>
<div id="outline-container-headline-19" class="outline-4">
<h4 id="headline-19">
Promise.prototype.catch(onRejection)
</h4>
<div id="outline-text-headline-19" class="outline-text-4">
<p>
<a href="https://tc39.es/ecma262/#sec-promise.prototype.catch">ECMA262标准流程</a>：</p>
<pre class="example">
26.6.5.1 Promise.prototype.catch ( onRejected )
When the catch method is called with argument onRejected, the following steps are taken:

  1. Let promise be the this value.
  2. Return ? Invoke(promise, &#34;then&#34;, « undefined, onRejected »).
</pre>
<p>
实现：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="nx">MyPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="k">catch</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">onRejection</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 因为如果有异常，异常会随着链式调用链中一直往后流，知道被处理掉
</span><span class="c1"></span>    <span class="c1">// 所以这里只要挂一个 then 去接受错误并处理就可以了
</span><span class="c1"></span>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">onRejection</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
测试：</p>
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">MyPromise</span><span class="p">,</span> <span class="nx">Util</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PWD</span><span class="si">}</span><span class="sb">/../../static/js/promise.js`</span><span class="p">)</span>

  <span class="k">new</span> <span class="nx">MyPromise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">Util</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, then 1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
  <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">200</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">val</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;, then 2&#39;</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<pre class="example">
100 , then 1
a is not defined
200 , then 2
</pre>
<p>
<strong>then 2</strong> 能够输出是因为 <strong>then 1</strong> 的错误被 catch 处理掉了，所以 <strong>then 2</strong> 可以正常 resolve。</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-20" class="outline-2">
<h2 id="headline-20">
完整脑图
</h2>
<div id="outline-text-headline-20" class="outline-text-2">
<p>
<img src="/img/es/es6-promise.svg" alt="/img/es/es6-promise.svg" title="/img/es/es6-promise.svg" /></p>
</div>
</div>
<div id="outline-container-headline-21" class="outline-2">
<h2 id="headline-21">
Jest 测试
</h2>
<div id="outline-text-headline-21" class="outline-text-2">
<div class="src src-js">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">  <span class="kr">const</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;./promise.js&#34;</span><span class="p">).</span><span class="nx">MyPromise</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">delay</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s2">&#34;Promise&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise then resolve&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">))).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise then reject&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;test reject&#34;</span><span class="p">))</span>
      <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s2">&#34;test reject&#34;</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise catch&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">a</span> <span class="cm">/* a is not defined */</span><span class="p">)</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s2">&#34;a is not defined&#34;</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise finally&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="k">finally</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise finally with catch&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">a</span><span class="p">)</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
        <span class="p">.</span><span class="k">finally</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s2">&#34;a is not defined&#34;</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise all&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">200</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span> <span class="mi">80</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p4</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">400</span><span class="p">),</span> <span class="mi">120</span><span class="p">));</span>

      <span class="kd">let</span> <span class="nx">pa1</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p4</span><span class="p">]).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">value</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">pa2</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">reason</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">pa3</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">reason</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">([</span><span class="nx">pa1</span><span class="p">,</span> <span class="nx">pa2</span><span class="p">,</span> <span class="nx">pa3</span><span class="p">]).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">([[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
      <span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise allSettled&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;p2 reject&#34;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
      <span class="p">);</span>
      <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span> <span class="mi">120</span><span class="p">));</span>

      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">([</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&#34;p2 reject&#34;</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
      <span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise race resolve&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;p2 reject&#34;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
      <span class="p">);</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">p1</span><span class="p">]).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise race reject&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;p2 reject&#34;</span><span class="p">),</span> <span class="mi">80</span><span class="p">));</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">p1</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s2">&#34;p2 reject&#34;</span><span class="p">)</span>
      <span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise any resolve&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;p2 reject&#34;</span><span class="p">),</span> <span class="mi">80</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;p3 reject&#34;</span><span class="p">),</span> <span class="mi">80</span><span class="p">));</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">any</span><span class="p">([</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="nx">test</span><span class="p">(</span><span class="s2">&#34;Promise any reject&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="mi">100</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;p2 reject&#34;</span><span class="p">),</span> <span class="mi">80</span><span class="p">));</span>
      <span class="kr">const</span> <span class="nx">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">delay</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="s2">&#34;p3 reject&#34;</span><span class="p">),</span> <span class="mi">80</span><span class="p">));</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">any</span><span class="p">([</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toStrictEqual</span><span class="p">([</span><span class="s2">&#34;p2 reject&#34;</span><span class="p">,</span> <span class="s2">&#34;p3 reject&#34;</span><span class="p">])</span>
      <span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
结果：</p>
<pre class="example">
  ➜  js git:(master) ✗ jest
  jest
  PASS ./promise.spec.js (5.19s)
    Promise
      ✓ Promise then resolve (11ms)
      ✓ Promise then reject (3ms)
      ✓ Promise catch (5ms)
      ✓ Promise finally (4ms)
      ✓ Promise finally with catch (6ms)
      ✓ Promise all (205ms)
      ✓ Promise allSettled (204ms)
      ✓ Promise race resolve (101ms)
      ✓ Promise race reject (85ms)
      ✓ Promise any resolve (102ms)
      ✓ Promise any reject (85ms)

  Test Suites: 1 passed, 1 total
  Tests:       11 passed, 11 total
  Snapshots:   0 total
  Time:        9.801s
  Ran all test suites.
</pre>
</div>
</div>
<div id="outline-container-headline-22" class="outline-2">
<h2 id="headline-22">
总结
</h2>
<div id="outline-text-headline-22" class="outline-text-2">
<p>
Promise 实现关键点：</p>
<ol>
<li>
<p>resolver 立即执行， resolve/reject 封装之后暴露给 resolver 的使用者调用，比
如：请求成功调用 <code>resolve(value)</code>, 请求失败调用 <code>reject(reason)</code> 。</p>
</li>
<li>
<p>resolve 函数实现需要判断各种情况，主要包含：</p>
<ul>
<li>
<p>不能处理自身，会造成死循环，即 then 的 callback 里面不能返回当前 promise 实
例自身</p>
</li>
<li>
<p>如果是对象或函数，要考虑到提供了 <code>then(resolve, reject)</code> 函数情况</p>
</li>
<li>
<p>是一个新的 Promise 实例。</p>
</li>
</ul>
</li>
<li>
<p>任务分立即完成和延时完成情况，立即完成的代表状态立即改变了直接在 then 函数中
<code>fulfill</code> 或 <code>reject</code> 即可，如果是异步的，需要通过订阅(<code>subscribe</code>)来实现。</p>
</li>
<li>
<p>then 函数中为了链式调用，需要新建一个 child promise 作为返回值。</p>
</li>
<li>
<p><code>Promise.all</code>, <code>allSettled</code>, <code>any</code> 这几个 api 的实现通过 Enumerator 封装。</p>
</li>
<li>
<p><code>Promise.all</code> 实现原理，遍历所有任务，同步的直接记录结果，异步的订阅结果，异
步完成之后检测最终的值，整个过程中只要中间有任一个 <strong>REJECT</strong> 了,
<code>Promise.all()</code> 状态立即改变为 <strong>REJECT</strong> 结束，返回结果是： <strong>FULFILL</strong>-结果数组，
<strong>REJECT</strong>-失败原因。</p>
</li>
<li>
<p><code>Promise.allSettled</code> 实现原理与 <code>Promise.all</code> 大相径庭，只要将 <code>Promise.all</code> 里面
遇到 <strong>REJECT</strong> 的处理改成记录结果就行，最后所有的完成之后就 <strong>FULFILL</strong> ，返回结果
是所有任务 <strong>FULFILL</strong> 结果或所有 <strong>REJECT</strong> 原因组成的数组。</p>
</li>
<li>
<p><code>Promise.any</code> 的实现与 <code>Promise.all</code> 刚好相反，它只要遇到有一个 <strong>FULFILL</strong> 就结束，
返回 <strong>FULFILL</strong> 状态，除非所有的都 <strong>REJECT</strong> 了才会 <strong>REJECT</strong> ，返回结果值为：
<strong>FULFILL</strong>-成功结果值， <strong>REJECT</strong>-返回所有失败任务的原因组成的数组。</p>
</li>
</ol>
</div>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Zhicheng Lee</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-10-12
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/javascript/">javascript,</a>
          <a href="/tags/es6/">es6,</a>
          <a href="/tags/promise/">promise</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/javascript-native-dev-with-rollupjs/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">用 Rollupjs 打包原生项目</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/life-bdx-persons/">
            <span class="next-text nav-default">si道友免si贫道</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'zcheng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="lv-container" data-id="city" data-uid="MTAyMC81MTQwMC8yNzg4MQ==">
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
    <noscript>Please enable JavaScript to view the comments powered by <a href="https://livere.com/">LiveRe.</a></noscript>
    </div>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:gccll.love@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/6062239/simon" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/gccll_love" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/profile.php?id=100013995916088" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://github.com/gcclll" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/gccll" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://space.bilibili.com/384410681" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://www.cheng92.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Zhicheng Lee</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
    docsearch({
    apiKey: "ac1e64640788e5697016a58be1ec7232",
    indexName: "cheng92.com",
    appId: "EDIKM3W4HV",
    inputSelector: '.docsearch-input',
    debug: false,
    });
</script>



<script type="text/javascript" src="/js/main.min.d33b84bebc7c384b56f2733fe2385c9017ee0b83c484f803130e9b7069175e0c.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-175986456-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script src="/js/global.js"></script>


</body>
</html>
