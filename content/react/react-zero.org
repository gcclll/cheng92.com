#+TITLE: Build Your Own React
#+DATE: <2021-05-06 18:32:24>
#+TAGS[]: react, mini-react
#+CATEGORIES[]: react 
#+LANGUAGE: zh-cn
#+STARTUP: indent


#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šåŠç¥åŠåœ£äº¦åŠä»™ï¼Œå…¨å„’å…¨é“æ˜¯å…¨è´¤ï¼Œè„‘ä¸­çœŸä¹¦è—ä¸‡å·ï¼ŒæŒæ¡æ–‡æ­¦åŠè¾¹å¤©ã€‚
</font>
</kbd><br><br>
<script src="/js/react/didact.js"></script>
<img  src="/img/bdx/shz-001.jpg"/>
#+end_export

#+begin_quote
è¯¥æ–‡ä»£ç å‡æ¥è‡ªï¼š[[https://pomb.us/build-your-own-react/][Build your own React]]ï¼Œ æ‰€ä»¥æ–‡ä¸­ä»£ç ä¼šä¿æŒå’ŒåŸä½œè€…å®šä¹‰ä¸€è‡´ã€‚
#+end_quote

* ä»£ç è„‘å›¾
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map
:END:

#+begin_src js
const element = <h1 title="foo">Hello</h1>;
const container = document.getElementById("root");
ReactDOM.render(element, container);
#+end_src

[[/img/react/react-zero.svg]]

å®ç°ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤

1. createElement å‡½æ•°å®ç°
2. render å‡½æ•°å®ç°
3. å¹¶å‘æ¨¡å¼ï¼Œæ¸²æŸ“ä»»åŠ¡çš„æ‰§è¡Œ ~workLoop()~ å‡½æ•°
4. Fibers react ä¸­é€šè¿‡ fiber ç»“æ„æ¥é“¾æ¥ parent, first child, sibling ä»¥åŠä½œä¸ºèŠ‚
   ç‚¹çš„ç»“æ„ï¼Œç±»ä¼¼ vue çš„ VNode
5. æ¸²æŸ“å’Œ commit é˜¶æ®µï¼Œä¸ºäº†è§£å†³æ¸²æŸ“è¿›ç¨‹å¯èƒ½è¢«æµè§ˆå™¨ä¸­æ–­çš„é—®é¢˜ï¼Œé‡‡å–çš„æ˜¯å»¶è¿Ÿæ¸²æŸ“ï¼Œ
   å³åœ¨æ‰€æœ‰çš„ fiber å¤„ç†å®Œä¹‹åï¼Œåœ¨æœ€åæ‰§è¡Œæ¸²æŸ“æ“ä½œã€‚
6. æ›´æ–°ï¼Œæ–°å¢ï¼Œåˆ é™¤æ“ä½œ
7. å‡½æ•°å¼ç»„ä»¶å®ç°
8. é’©å­å‡½æ•°çš„å®ç° ~useState~

* é¢„è§ˆ
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: preview
:END:

react ä½¿ç”¨å®ä¾‹ï¼š
#+begin_src js
const element = <h1 title="foo">Hello</h1>;
const container = document.getElementById('root');
ReactDOM.render(element, container)
#+end_src

é¦–å…ˆ ~const element = <h1 title="foo">Hello</h1>;~ å±äº JSX ä¹¦å†™é£æ ¼ï¼Œè¿™ä¸ªä¼šè¢«è½¬
æ¢æˆ JS ä»£ç :

#+begin_src js
// å‚æ•°ï¼š
// 1. type: 'h1' æ ‡ç­¾å
// 2. props: {title: 'foo'} ä¸ºå…ƒç´ çš„å±æ€§å¯¹è±¡
// 3. children: 'Hello' ä¸ºå­å…ƒç´ 
const element = React.createElement("h1", { title: "foo" }, "Hello");
#+end_src

å…¶æ¬¡æ˜¯ ~ReactDOM.render(element, container)~ è¿›è¡Œæ¸²æŸ“åˆ°çœŸå®DOMçš„æ“ä½œï¼Œè¿™ä¸ªå‡½æ•°çš„
åŠŸèƒ½ç®€è¿°ï¼š

#+begin_src js
// 1. æ ¹æ® element.type å»åˆ›å»º off-dom å…ƒç´ 
const node = document.createElement(element.type);
// 2. è®¾ç½®å±æ€§ props
node['title'] = element.props.title

// 3. å¤„ç† children å­å…ƒç´ 
const text = document.createTextNode('')
text['nodeValue'] = element.props.children

// 4. æœ€åæ›´æ–°åˆ°çœŸå®DOMæ ‘
node.appendChild(text)
container.appendChild(node)
#+end_src

æ‰€ä»¥ render å‡½æ•°çš„åŠŸèƒ½æ€»ç»“ä¸‹æ¥å°±åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š

1. æ‹¿åˆ°èŠ‚ç‚¹çš„ fiber ç»“æ„ï¼Œåˆ›å»º off-dom å…ƒç´ 
2. å¤„ç† element.props å±æ€§(å¯èƒ½æ˜¯åŠ¨æ€ï¼Œé™æ€ï¼Œä¹Ÿå¯èƒ½æ˜¯äº‹ä»¶å±æ€§)
3. å¤„ç† element.children å­å…ƒç´ 
4. æ›´æ–°åˆ°çœŸå®çš„ DOM æ ‘


å…·ä½“çš„å®ç°éƒ½æ˜¯å›´ç»•è¿™ä¸ªç‚¹å»å®Œæˆçš„ï¼Œ

æ¯”å¦‚ *1* ä¼šä½¿ç”¨ fiber ç»“æ„æ¥ç»„ç»‡æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹ç»“æ„ä¸€èˆ¬ä¼šæœ‰ä¸‰ä¸ªå¼•ç”¨ï¼š
parentã€first childã€sibling è¿™ä¸‰ä¸ªé“¾æ¥è¿™ä¸ªæ•´ä¸ªfiber æ ‘çš„ï¼Œè¿™ä¹Ÿä¸ºäº†åé¢èŠ‚ç‚¹æ“ä½œ
æ—¶æ–¹ä¾¿æŸ¥æ‰¾ã€‚

åˆæ¯”å¦‚ *2* ä¸­å¯¹ props çš„å¤„ç†ï¼Œä¼šè€ƒè™‘æ˜¯ä¸æ˜¯äº‹ä»¶å±æ€§ onXxx ã€‚

ä»¥åŠæœ€åæ›´æ–°çœŸå®DOMçš„æ—¶æœºç­‰å¾…ã€‚

#+begin_quote
nodeValue: [[https://www.w3schools.com/jsref/prop_node_nodevalue.asp][HTML DOM nodeValue Property]]

[[/img/tmp/dom-prop-nodeValue.png]]
#+end_quote

å®Œæ•´ä»£ç ï¼š
#+begin_src js
// createElement: jsx -> js vnode ç»“æ„
const element = {
  type: 'h1',
  props: {
    title: 'foo',
    children: 'Hello'
  }
}

const container = document.getElementById('root')

// åˆ›å»ºèŠ‚ç‚¹
const node = document.createElement(element.type)
node['title'] = element.props.title

// åˆ›å»ºå­èŠ‚ç‚¹
const text = document.createTextNode('')
text['nodeValue'] = element.props.children

node.appendChild(text)
container.appendChild(node)
#+end_src

#+begin_export html
<font color="blue">æµ‹è¯•ï¼š</font>
<div id="c07Rp8"></div>
<script>
// createElement: jsx -> js vnode ç»“æ„
const element = {
  type: 'h1',
  props: {
    title: 'foo',
    children: 'Hello'
  }
}

const container = document.getElementById('c07Rp8')

// åˆ›å»ºèŠ‚ç‚¹
const node = document.createElement(element.type)
node['title'] = element.props.title

// åˆ›å»ºå­èŠ‚ç‚¹
const text = document.createTextNode('')
text['nodeValue'] = element.props.children

node.appendChild(text)
container.appendChild(node)
</script>
#+end_export

[[/img/react/react-render-brief.svg]]

* createElement
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: create-element
:END: 

JSX å®ä¾‹:
#+begin_src js
const element = (
  <div id="foo">
    <a>bar</a>
    <b />
  </div>
)
#+end_src

è½¬æˆ JS åè°ƒç”¨ createElement:
#+begin_src js
React.createElement(
  "div",
  {
    id: "foo",
  },
  React.createElement("a", null, "bar"),
  React.createElement("b")
);
#+end_src

ä¸€ä¸ªèŠ‚ç‚¹åœ¨æ¸²æŸ“åˆ° DOM ä¹‹å‰éƒ½ä¼šæ˜¯ä»¥ä¸€ä¸ªVNode å½¢å¼å­˜åœ¨ï¼Œå…¶ä¸­å°±åŒ…å«æœ€åŸºæœ¬çš„ type,
props å±æ€§ã€‚

~{type: 'div', props: { id: 'foo', children: ... } }~

è¿™å’Œ vue vnode ç»“æ„æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡ vue vnode çš„ children ä¸æ˜¯åœ¨ props é‡Œé¢ï¼š

~{type: 'div', props: {id: 'foo'}, children: [...] }~

è¿™é‡Œåªè¦çŸ¥é“ createElement ç›®çš„æ˜¯è§£æèŠ‚ç‚¹ï¼Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹ç»“æ„å¯¹è±¡ï¼Œä¸‹é¢å°±å¯ä»¥å¼€å§‹å°
è¯•å®ç° createElement äº†

æœ€ç®€å•çš„å®ç°ï¼š
#+begin_src js
// ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹éƒ½å½“åšå­å…ƒç´ 
function createElement(type, props, ...children) {
  return {
    type,
    props: {
      ...props,
      children,
    },
  };
}

// æ‰€ä»¥ï¼Œä¸Šé¢çš„å®ä¾‹ä¼šæœ‰å¦‚ä¸‹ç»“æ„ï¼š
var div = {
  type: "div",
  props: { id: "foo", children: [a, b] },
};

var a = {
  type: "a",
  props: {
    children: ["bar"],
  },
};

var b = {
  type: "b",
  props: {
    children: [], // æ²¡æœ‰çš„æ—¶å€™é»˜è®¤è¿”å›ç©ºæ•°ç»„
  },
};
#+end_src

è¿™é‡Œé¢å¯¹äº children æœ‰ä¸¤ç§ç±»å‹

1. ~<a>bar</a>~ çš„ children åªæœ‰ "bar" æ˜¯ä¸ªçº¯æ–‡æœ¬ç±»å‹
2. ~<div>...</div>~ çš„ children æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ a å’Œ b ï¼Œä»–ä»¬ç»è¿‡ createElement ä¹‹å
   éƒ½æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ä¸‹ï¼Œçº¯æ–‡æœ¬å»åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹


#+begin_src js
function createElement(type, props, ...children) {
  return {
    type,
    props: {
      ...props,
      // è¿™é‡Œå¯¹äºæ–‡æœ¬å†…å®¹ï¼Œå»åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
      children: children.map((child) =>
        typeof child === "object" ? child : createTextElement(child)
      ),
    },
  };
}

function createTextElement(text) {
  return {
    type: "TEXT_ELEMENT", // æ ‡è®°ç±»å‹
    props: {
      // node.nodeValue å±æ€§å¯ä»¥è®¾ç½®æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹ï¼Œç±»ä¼¼ textContent
      nodeValue: text,
      children: [],
    },
  };
}

// æµ‹è¯•
const element = createElement(
  "div",
  { id: "foo" },
  createElement("a", null, "bar"),
  createElement("b")
);
console.log(
  "è¾“å‡ºç»“æ„>>> \n",
  element,
  "\n > element children: \n",
  element.props.children,
  "\n > a children: \n",
  element.props.children[0].props.children
);

// ä¸ºäº†åŒºåˆ« Reactï¼Œè¿™é‡Œé‡‡ç”¨æ–‡å­—ä½œè€…çš„å‘½åç©ºé—´ï¼š Didact
const Didact = {
  createElement
}
#+end_src

#+RESULTS:
#+begin_example
è¾“å‡ºç»“æ„>>>
 { type: 'div', props: { id: 'foo', children: [ [Object], [Object] ] } }
 > element children:
 [
  { type: 'a', props: { children: [Array] } },
  { type: 'b', props: { children: [] } }
]
 > a children:
 [ { type: 'TEXT_ELEMENT', props: { nodeValue: 'bar', children: [] } } ]
undefined
#+end_example

ä¸ºäº†æ–¹ä¾¿åé¢çš„æµ‹è¯•ï¼Œè€ƒè™‘åˆ°ä»£ç ä¼šæ…¢æ…¢å˜é•¿é—®é¢˜ï¼Œåé¢çš„ä»£ç ä¼šç§»åˆ°
[[/js/react/didact.js]] ä¸­å»ã€‚

ä¹‹åæµ‹è¯•æ–¹å¼ï¼š
#+begin_src js
import(process.env.BLOG_JS + "/react/didact.js").then(({ default: Didact }) => {
  console.log(Didact);
  // è¿™æ ·ç…§æ ·å¯ä»¥å®Œæˆä¸Šé¢çš„æµ‹è¯•
  const element = Didact.createElement(
    "div",
    { id: "foo" },
    Didact.createElement("a", null, "bar"),
    Didact.createElement("b")
  );
  console.log(element);
});
#+end_src

#+RESULTS:
: undefined
:
: { createElement: [Function: createElement] }
: { type: 'div', props: { id: 'foo', children: [ [Object], [Object] ] } }

* render
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: render
:END:

å¢åŠ  render å‡½æ•°ï¼Œå®ƒçš„ç›®çš„åœ¨ä¸€å¼€å§‹ä¹Ÿè¯´äº†ï¼Œå°±æ˜¯å°† vnode æ¸²æŸ“åˆ°çœŸå®DOMï¼Œè‡³äºæ€ä¹ˆæ¸²
æŸ“ï¼Œç»“æ„åˆæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œè¿™ä¹‹åä¼šæ…¢æ…¢çš„å»å®Œæˆã€‚
#+begin_src js
const Didact = {
  createElement,
  render
}

// ReactDOM.render
function render(element, container) {
  // TODO
}
#+end_src

æ¸²æŸ“å½“å‰æ ‘æ ¹èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹å…ƒç´ æ¸²æŸ“å·¥ä½œï¼š
#+begin_src js
// ReactDOM.render
function render(element, container) {
  // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ 
  const dom = document.createElement(element.type)

  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ 
  element.props.children.forEach(child => render(child, dom /*parent*/))

  container.appendChild(dom)
}
#+end_src

ä½†æ˜¯èŠ‚ç‚¹ç±»å‹æœ‰å¯èƒ½æ˜¯çº¯æ–‡æœ¬çš„ï¼Œæ¯”å¦‚ [[#create-element][createElement ä¸€èŠ‚]] ä¸­çš„ä¾‹å­é‡Œé¢çš„
~<a>bar</a>~ å°±æœ‰ä¸€ä¸ªçº¯æ–‡æœ¬çš„ ~"bar"~ èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ç»è¿‡ createElement ä¹‹åç»“æ„
æ˜¯ï¼š ~{type: 'TEXT_ELEMENT', props: {...}}~ ï¼Œæ‰€ä»¥è¿™é‡Œé¢åªéœ€è¦é’ˆå¯¹
~TEXT_ELEMENT~ åšä¸‹ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœæ˜¯æ–‡æœ¬å°±åˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡æœ¬èŠ‚ç‚¹æ¥å®¹ä¹ƒè¯¥æ–‡æœ¬å†…å®¹ã€‚

#+begin_src diff
// ReactDOM.render
function render(element, container) {
  // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ 
-  const dom = document.createElement(element.type)
+  const dom =
+    element.type === "TEXT_ELEMENT"
+      ? document.createTextNode("")
+      : document.createElement(element.type);

  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ 
  element.props.children.forEach((child) => render(child, dom /*parent*/));

  container.appendChild(dom);
}
#+end_src

æœ€åæ˜¯ props çš„å¤„ç†ï¼Œè¿™é‡Œè®°å¾—è¦æ’é™¤ ~props.children~

#+begin_src diff
// ReactDOM.render
function render(element, container) {
  // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ 
  const dom =
    element.type === "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(element.type);

+  const isProperty = (key) => key !== "children";
+  Object.keys(element.props)
+    .filter(isProperty)
+    .forEach((name) => (dom[name] = element.props[name]));

  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ 
  element.props.children.forEach((child) => render(child, dom /*parent*/));

  container.appendChild(dom);
}
#+end_src

æœ€åè¯¥é˜¶æ®µå®Œæ•´çš„ä»£ç ï¼š
#+begin_src js
console.log("\n");
const Didact = {
  createElement,
  render,
};

// ReactDOM.render
function render(element, container) {
  // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ 
  const dom =
    element.type === "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(element.type);

  const isProperty = (key) => key !== "children";
  Object.keys(element.props)
    .filter(isProperty)
    .forEach((name) => (dom[name] = element.props[name]));

  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ 
  element.props.children.forEach((child) => render(child, dom /*parent*/));

  container.appendChild(dom);
}

// React.createElement
function createElement(type, props, ...children) {
  return {
    type,
    props: {
      ...props,
      children: children.map((child) =>
        typeof child === "object" ? child : createTextElement(child)
      ),
    },
  };
}

function createTextElement(text) {
  return {
    type: "TEXT_ELEMENT",
    props: {
      nodeValue: text, // ç±»ä¼¼ textContent å¯ä»¥ä¿®æ”¹èŠ‚ç‚¹æ–‡æœ¬å†…å®¹çš„å±æ€§
      children: [],
    },
  };
}
#+end_src

æµ‹è¯•:
#+begin_export html
<div id="qoCIUr"></div>
<script>
(function() {
console.log(Didact)

const container = document.getElementById('qoCIUr')
const element = Didact.createElement('div', {
  id: 'foo',
}, Didact.createElement('a', null, 'bar'),
Didact.createElement('b'))

Didact.render(element, container)
}());
</script>
#+end_export

æµ‹è¯•ä»£ç ï¼š
#+begin_src js
console.log(Didact);

const container = document.getElementById("qoCIUr");
const element = Didact.createElement(
  "div",
  {
    id: "foo",
  },
  Didact.createElement("a", null, "bar"),
  Didact.createElement("b")
);

Didact.render(element, container);
#+end_src
* å¹¶å‘æ¨¡å¼(workLoop())
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: concurrent
:END:


æ³¨æ„çœ‹ä¸Šä¸€èŠ‚æœ€åçš„ä»£ç ï¼Œåœ¨ [[#render][render]] ä¸­ä¼šé€’å½’è°ƒç”¨æ¥å®Œæˆ children çš„æ¸²æŸ“å·¥ä½œï¼Œè¿™é‡Œå°±
ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåªè¦ render ä¸€æ—¦æ‰§è¡Œï¼Œåœ¨æ¸²æŸ“å®Œæ•´æ£µæ ‘ä¹‹å‰æ˜¯ä¸èƒ½åœæ­¢çš„ï¼Œå¦åˆ™å°†å¯¼è‡´
é¡µé¢ä¸å®Œæ•´ã€‚

#+begin_quote
æ˜¨å¤©å¾®ä¿¡é‡Œé¢çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼š

[[https://mp.weixin.qq.com/s/g_-blGV4CVF5EogYZaPMzQ][Event Loop å’Œ JS å¼•æ“ã€æ¸²æŸ“å¼•æ“çš„å…³ç³»]]

è¿™é‡Œé¢å¤§æ¦‚è®²è¿°äº†ä¸€äº›JS å’Œ æ¸²æŸ“ä¹‹é—´çš„ä¸€äº›å…³ç³»ï¼Œè€Œè¿™é‡Œçš„å®ç°å’Œè¿™æ–‡ç« é‡Œè®²è¿°çš„ä¸€äº›åŸ
ç†æ˜¯ç›¸é€šçš„ã€‚
#+end_quote

è¦è§£å†³ render é€’å½’çš„é—®é¢˜ï¼Œå¤§è‡´çš„æ€æƒ³æ˜¯é€šè¿‡ Fiber å°†æ¸²æŸ“ä»»åŠ¡å°è£…ï¼Œåœ¨æŸä¸€ä¸ªç©ºé—²çš„
æ—¶åˆ»å»æ‰§è¡Œè¿™äº› Fibers è¿›è¡Œå®é™…çš„æ¸²æŸ“ï¼Œè¿™æ ·ä¸è‡³äºé˜»å¡ä¸»ä»»åŠ¡çš„æ‰§è¡Œã€‚

è¿™é‡Œçš„æ¯ä¸ª Fiber ä¹Ÿè¢«ç§°ä½œ work unitï¼Œå½“ä¸€ä¸ª work unit å®Œæˆä¼šè‡ªåŠ¨æ‰¾åˆ°ä¸‹ä¸€ä¸ªåº”è¯¥æ‰§
è¡Œçš„ work unit ä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ª Fiberï¼Œä¸ºä»€ä¹ˆå«åº”è¯¥å‘¢ï¼Œå› ä¸ºæ¯ä¸ª Fiber ä¸Šé¢ä¸æ­¢æœ‰ä¸€ä¸ª
å¼•ç”¨æŒ‡å‘ä¸‹ä¸€ä¸ª Fiberï¼Œç„¶åå¦‚ä½•å†³å®šä¸‹ä¸€ä¸ª work unit è·Ÿæ¸²æŸ“çš„ä¼˜å…ˆçº§æœ‰å…³ç³»ã€‚

æ¯ä¸ª Fiber ä¸Šé¢æœ€å¤šæœ‰ä¸‰ä¸ªå¼•ç”¨ parent, first child, parent sibling ä¸‰ä¸ªèŠ‚ç‚¹ã€‚

ä¼˜å…ˆçº§æ˜¯: first child > parent sibling > parentã€‚

å¦‚ä½•æ‰§è¡Œ work unit ?

#+begin_src js
let nextUnitOfWork = null
function workLoop(deadline) {
  let shouldYield = false
  while (nextUnitOfWork && !shouldYield) {
    // æ‰§è¡Œå½“å‰çš„ work unit è¿”å›ä¸‹ä¸€ä¸ªå°†è¦æ‰§è¡Œçš„ work unit
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork)
    // æ²¡æœ‰ç©ºé—²çš„æ—¶é—´äº†
    shouldYield = deadline.timeRemaining() < 1
  }
  // ä¸‹ä¸ªç©ºé—²æ—¶é—´å»æ‰§è¡Œä¸‹ä¸€æ¬¡ work unit loop
  requestIdleCallback(workLoop)
}

function performUnitOfWork(nextUnitOfWork) {
  // TODO
}
#+end_src

[[/img/js/request-idle-callback.png]]

è¿™é‡Œä½¿ç”¨ ~requestIdleCallback~ è¿™ä¸ªå‡½æ•°ä¼šåœ¨æ¸²æŸ“ä¹‹å‰æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰ç©ºé—²çš„æ—¶é—´ï¼Œå¦‚æœ
æœ‰åˆ™æ‰§è¡Œå›è°ƒï¼Œæˆ–è€…è¶…æ—¶äº†å¼ºåˆ¶æ‰§è¡Œå›è°ƒã€‚

#+begin_quote
React å·²ç»ä¸ç”¨è¿™ä¸ªäº†ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº† [[https://github.com/facebook/react/tree/master/packages/scheduler][react/packages/scheduler at master Â·
facebook/react]] æ¥ç®¡ç† fiber çš„æ‰§è¡Œæ—¶æœºã€‚
#+end_quote
* Fibers
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fibers
:END:

ä¸Šä¸€èŠ‚åœ¨å®ç° ~workLoop()~ æåˆ°äº† work unit å³ fiberã€‚

ä¸ºäº†æ–¹ä¾¿ç®¡ç†ä¸€ä¸ª work unit ï¼Œéœ€è¦ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„ç»“æ„ï¼Œé‡Œé¢èƒ½ä¿å­˜ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ï¼Œ
æ¯”å¦‚ parent, first child, parent sibling å¼•ç”¨ï¼Œ VNode èŠ‚ç‚¹ä¿¡æ¯ï¼Œç­‰å¾…ã€‚

è¿™ä¸ªç»“æœå°±æ˜¯: Fiber tree ç”±ä¸€ä¸ªä¸ª fiber ç»“æ„é€šè¿‡é“¾æ¥ç»„æˆçš„æ ‘ï¼Œå…¶å®å°±æ˜¯ç±»ä¼¼ Vue
ä¸­çš„ VNode èŠ‚ç‚¹æ ‘ã€‚

ä¾‹å¦‚ï¼š
#+begin_src js
Didact.render(
  <div>
    <h1>
      <p />
      <a />
    </h1>
    <h2 />
  </div>,
  container
)
#+end_src

æœ‰å¦‚ä¸‹çš„ç»“æ„ï¼Œè¯¥ç»“æ„è®©æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ€å¤šæŒæœ‰ä¸‰ä¸ªå¼•ç”¨ï¼Œä»è€Œæ›´æ–¹ä¾¿çš„æ‰¾åˆ°ä¸‹ä¸€ä¸ª work unit:

[[/img/react/fiber-0.png]]

render æŸ¥æ‰¾æ­¥éª¤æ‹†è§£ï¼š

~root~ -> ~<div>~ -> ~<h1>~ -> ~<p>~ è¿™æ˜¯éµå¾ª first child ä¼˜å…ˆçº§æœ€é«˜æŸ¥æ‰¾çš„ç»“æœï¼Œä¸€æ—¦è¿™ä¸ª
è¿‡ç¨‹æ¸²æŸ“å®Œæˆï¼Œæ¥ä¸‹æ¥åº”è¯¥æ‰¾ ~<p>~ çš„ sibling(å› ä¸º sibling ä¼˜å…ˆçº§é«˜äº parent ä½äº
first child):

~<a>~ -> ~<h2>~ å› ä¸º ~<a>~ æ—¢æ²¡æœ‰ first child ä¹Ÿæ²¡æœ‰ sibling æ‰€ä»¥æ‰¾ parent
sibling å³ ~<h2>~ ç„¶åç»§ç»­æ‰¾å‘ç° ~<div>~ å¹¶æ²¡æœ‰ siblingï¼Œä¸€ç›´å¦‚æ­¤çŸ¥é“æ ¹èŠ‚ç‚¹ã€‚

æ›´æ–° render å‡½æ•°ï¼Œå°† DOM å…ƒç´ çš„åˆ›å»ºä» render ä¸­æŠ½ç¦»å‡ºæ¥æˆ ~createDom~ å‡½æ•°ï¼Œè¿™é‡Œå¼€å§‹ä½¿ç”¨ fiber:
#+begin_src js
function createDom(fiber) {
  // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ 
  const dom =
    fiber.type === "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(fiber.type);

  const isProperty = (key) => key !== "children";
  Object.keys(fiber.props)
    .filter(isProperty)
    .forEach((name) => (fiber[name] = fiber.props[name]));

  return dom;
}

let nextUnitOfWork = null
function render(element, container) {
  // æ„å»º root fiber ä½œä¸ºç¬¬ä¸€ä¸ª nextUnitOfWork
  nextUnitOfWork = {
    dom: container,
    props: {
      children: [element]
    }
  }
}
#+end_src

åœ¨ render ä¸€å¼€å§‹ä¼šåˆ›å»ºä¸€ä¸ª root fiber å¹¶ä¸”å°†å®ƒä½œä¸ºç¬¬ä¸€ä¸ª ~nextUnitOfWork~ ï¼Œè€Œå
é¢åˆ™æ˜¯æ‰§è¡Œ ~performUnitOfWork~ è¿™é‡Œé¢ä¸»è¦å®Œæˆä¸‰éƒ¨åˆ†ä»»åŠ¡ï¼š

1. å°† fiber å¯¹åº”çš„ element æ·»åŠ åˆ° DOM
2. ä¸º *1* ä¸­çš„ ~element.children~ åˆ›å»º fibers
3. æ‰¾åˆ°åˆé€‚çš„ä¸‹ä¸€ä¸ª work unit è¿”å›

#+begin_src js
function performUnitOfWork(fiber) {
  // 1. åˆ›å»º fiber dom å…ƒç´ 
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }

  // 2. å°† fiber dom æ·»åŠ åˆ° parent DOM æ ‘ä¸­å»
  if (fiber.parent) {
    fiber.parent.dom.appendChild(fiber.dom);
  }

  // 3. å¤„ç† children
  const elements = fiber.props.children;
  let index = 0;
  let prevSibling = null;

  while (index < elements.length) {
    const element = elements[index];

    // ä¸ºæ¯ä¸ª child æ„å»º fiber ç»“æ„
    const newFiber = {
      type: element.type,
      props: element.props,
      parent: fiber, // æŒ‡å‘çˆ¶çº§ fiber çš„å¼•ç”¨
      dom: null, // æŒ‡å‘çœŸå®DOMå…ƒç´ çš„å¼•ç”¨
    };

    if (indx === 0) {
      // è¡¨ç¤ºæ˜¯ parent çš„ç¬¬ä¸€ä¸ª childï¼Œæ ‡è®°ä¸º first child
      firber.child = newFiber; // ç¬¬ä¸€ä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§æœ€é«˜
    } else {
      // éç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œç­‰äºæ˜¯èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹
      // ç¬¬äºŒä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§ä½äº first child
      prevSibling.sibling = newFiber;
    }

    prevSibling = newFiber;
    index++;
  }

  // åˆ°è¿™é‡Œ fiber ç»“æ„åˆå§‹åŒ–å®Œæˆï¼Œæ­¤æ—¶æ¯ä¸ª fiber ä¹Ÿæœ‰äº†è‡ªå·±çš„
  // ä¸‰ä¸ªå¼•ç”¨ fiber.child, fiber.parent, fiber.sibling
  // ä¸‹é¢å°†è¦å»æ‰¾åˆ°å½“å‰ Fiber çš„ä¸‹ä¸€ä¸ª work unitï¼ŒæŸ¥æ‰¾éµå¾ªä¼˜å…ˆçº§:
  // fiber.child > fiber.sibling > fiber.parent.sibling
  if (fiber.child) {
    return fiber.child;
  }
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      // ç¬¬ä¸€æ¬¡è¿™é‡Œæ‰¾çš„æ˜¯å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æ‰¾åˆ°
      // ä¾ç€ fiber æ ‘å¾€ä¸Šæ‰¾ parent çš„ sibling
      return nextFiber.sibling;
    }

    nextFiber = fiber.parent;
  }
}
#+end_src
* Render and Commit é˜¶æ®µ
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: render-commit
:END:

åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå‰é¢éƒ½åªæ˜¯åœ¨ fiber tree åŸºç¡€ä¸Šå»åšäº†å¤„ç†ï¼ˆåˆ›å»º DOM å…ƒç´ ï¼Œé“¾æ¥ fiber
treeï¼Œæ‰¾ä¸‹ä¸€ä¸ª work unitï¼‰ï¼Œä½†å®é™…å¹¶æ²¡æœ‰å¼€å§‹æ¸²æŸ“ã€‚

å¹¶ä¸”è¿™é‡Œ performUnitOfWork å®ç°ä¸­æœ‰ä¸ªé—®é¢˜ï¼š
#+begin_src js
if (fiber.parent) {
  fiber.parent.dom.appendChild(fiber.dom);
}
#+end_src

å³è¿™é‡Œæ¯æ¬¡æ‰§è¡Œ work unit çš„æ—¶å€™éƒ½ä¼šç«‹å³å°† fiber.dom æ·»åŠ åˆ° parent çš„ DOM ğŸŒ²ä¸­å»ï¼Œ
ç„¶åè¿™ä¸ªæ“ä½œå¾ˆæœ‰å¯èƒ½åœ¨å®Œæˆæ•´æ£µæ ‘çš„æ¸²æŸ“ä¹‹å‰è¢«æµè§ˆå™¨ç»™ç»ˆæ­¢äº†ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

ä»æ ¹ä¸Šå»è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³åœ¨ render ä¸­ä¸ç”¨ä¸€å¼€å§‹å°±å»è¿›è¡Œ append æ“ä½œï¼Œè€Œæ˜¯ä» root
å¼€å§‹å»è·Ÿè¸ªæ•´ä¸ªæ ‘çš„ç»“æ„å˜åŒ–ï¼Œå°† root ä¹Ÿå°è£…æˆ fiberã€‚

#+begin_src js
let wipRoot = null
function render(element, container) {
  wipRoot = {
    dom: container,
    props: {
      children: [element]
    }
  }

  nextUnitOfWork = wipRoot
}
#+end_src

ç„¶åï¼Œä¸€æ—¦ wookLoop() çš„ä¸€æ¬¡å¾ªç¯ç»“æŸäº†å°±è¿›è¡Œä¸€æ¬¡æäº¤ï¼Œå»ä¸€æ¬¡æ€§å®Œæˆæ¸²æŸ“ä»»åŠ¡ã€‚

é‚£æ€ä¹ˆåˆ¤æ–­è¯´ä¸€æ¬¡å¾ªç¯ç»“æŸäº†ï¼Ÿ

#+begin_src js
function commitRoot() {
  // æ‰§è¡Œ DOM æ¸²æŸ“
  commitWork(wipRoot.child);
  // æäº¤å®Œæˆä¹‹åè¦é‡ç½®ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ›´æ–°çš„ä»»åŠ¡
  wipRoot = null;
}

function commitWork(fiber) {
  if (!fiber) return;

  // è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -> fiber.child -> fiber.sibling
  const domParent = fiber.parent.dom;
  domParent.appendChild(fiber.dom);
  commitWork(fiber.child);
  commitWork(fiber.sibling);
}

function workLoop(deadline) {
  let shouldYield = false;
  while (nextUnitOfWork && !shouldYield) {
    // æ‰§è¡Œå½“å‰çš„ work unit è¿”å›ä¸‹ä¸€ä¸ªå°†è¦æ‰§è¡Œçš„ work unit
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    // æ²¡æœ‰ç©ºé—²çš„æ—¶é—´äº†
    shouldYield = deadline.timeRemaining() < 1;
  }

  // è¿™é‡Œæ£€æµ‹æ²¡æœ‰ä¸‹ä¸€ä¸ª work unit äº†ï¼Œè¯´æ˜æ•´ä¸ªæ ‘éå†å®Œæˆäº†
  if (!nextUnitOfWork && wipRoot) {
    commitRoot();
  }

  // ä¸‹ä¸ªç©ºé—²æ—¶é—´å»æ‰§è¡Œä¸‹ä¸€æ¬¡ work unit loop
  requestIdleCallback(workLoop);
}
#+end_src
* updating and deleting æ›´æ–°å’Œåˆ é™¤
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: update-delete
:END:

è¿™ä¸€èŠ‚å°†è®²è¿°å¦‚ä½•å°† old fiber å’Œ new fiber è¿›è¡Œæ¯”è¾ƒæ¥åˆ¤æ–­æ˜¯è¿›è¡Œ update è¿˜æ˜¯
delete æ“ä½œã€‚

æ‰€ä»¥ Fiber é‡Œé¢éœ€è¦å¯¹ä¸Šä¸€æ¬¡çš„æäº¤çš„ fiber tree è¿›è¡Œå¤‡ä»½ã€‚

è¿™é‡Œç”¨ ~currentRoot~ è¡¨ç¤º new fiber ç”¨ fiber.alternate æ¥ä¿å­˜ old fiberã€‚

#+begin_src diff
+ let currentRoot = null
function commitRoot() {
  commitWork(wipRoot.child)
+  // å½“å‰æ¸²æŸ“çš„æ ‘è¿›è¡Œå¤‡ä»½
+  currentRoot = wipRoot
  wipRoot = null
}

function render(element, container) {
  wipRoot = {
    dom: container,
    props: {
      children: [element]
    },
+    // ä¿å­˜ä¸€ä»½è€æ ‘
+    alternate: currentRoot
  }

  nextUnitOfWork = wipRoot
}
#+end_src

å°† ~performUnitOfWork~ ä¸­åˆ›å»º Fiber çš„æŠ½ç¦»åˆ° ~reconcileChildren~ ä¸­å»æ–¹ä¾¿æ·»åŠ æ›´
æ–°å’Œåˆ é™¤æ“ä½œã€‚

#+begin_src js
function reconcileChildren(wipFiber, elements) {
  let index = 0;
  let oldFiber = wipFiber.alternate && wipFiber.alternate.child
  let prevSibling = null;

  while (index < elements.length) {
    // è¿™ä¸ª element æ˜¯å°†è¦æ›´æ–°åˆ°DOMä¸­çš„èŠ‚ç‚¹
    const element = elements[index];
    let newFiber = null

    // æ¯”è¾ƒ oldFiber å’Œ element
    // ç±»å‹ä¸€æ ·ï¼Œå±äºæ›´æ–°
    const sameType = oldFiber && element && oldFiber.type === element.type
    // ä¸‹é¢çš„æ›´æ–°å¹¶éæ˜¯ç›´æ¥ç«‹å³æ›´æ–°ï¼Œè€Œæ˜¯ä¸º Fiber èµ‹äºˆæ–°çš„å±æ€§æ¥æ ‡è¯†è¯¥èŠ‚ç‚¹
    // åœ¨ commit é˜¶æ®µåº”è¯¥æ‰§è¡Œä»€ä¹ˆæ“ä½œ

    if (sameType) {
      // æ›´æ–°èŠ‚ç‚¹
      newFiber = {
        type: oldFiber.type,
        props: element.props,
        dom: oldFiber.dom,
        parent: wipFiber,
        alternate: oldFiber,
        effectTag: 'UPDATE'
      }
    }

    if (element && !sameType) {
      // æ·»åŠ èŠ‚ç‚¹
      newFiber = {
        type: element.type,
        props: element.props,
        dom: null,
        parent: wipFiber,
        alternate: null,
        effectTag: 'PLACEMENT'
      }
    }

    if (oldFiber && !sameType) {
      // åˆ é™¤èŠ‚ç‚¹
      oldFiber.effecTag = 'DELETION'
      // å› ä¸º commit æ˜¯ä» root ä»ä¸Šå¾€ä¸‹æäº¤çš„ï¼Œä¸”åœ¨æäº¤é˜¶æ®µ
      // å·²ç»ä¸¢å¤±äº† old fiberï¼Œå› ä¸ºä¸Šé¢ç»“æ„å·²ç»æ›´æ–°äº†ï¼Œå› æ­¤è¿™é‡Œéœ€è¦è®°å½•
      // å“ªäº›èŠ‚ç‚¹éœ€è¦åˆ é™¤
      deletion.push(oldFiber)
    }

    // ä¸ºæ¯ä¸ª child æ„å»º fiber ç»“æ„
    newFiber = {
      type: element.type,
      props: element.props,
      parent: fiber, // æŒ‡å‘çˆ¶çº§ fiber çš„å¼•ç”¨
      dom: null, // æŒ‡å‘çœŸå®DOMå…ƒç´ çš„å¼•ç”¨
    };

    if (indx === 0) {
      // è¡¨ç¤ºæ˜¯ parent çš„ç¬¬ä¸€ä¸ª childï¼Œæ ‡è®°ä¸º first child
      firber.child = newFiber; // ç¬¬ä¸€ä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§æœ€é«˜
    } else {
      // éç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œç­‰äºæ˜¯èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹
      // ç¬¬äºŒä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§ä½äº first child
      prevSibling.sibling = newFiber;
    }

    prevSibling = newFiber;
    index++;
  }
}
#+end_src

ç„¶åä¿®æ”¹ render ï¼Œåˆå§‹åŒ–æˆ–é‡ç½® deletion:
#+begin_src js
let deletion = null
// ReactDOM.render
function render(element, container) {
  wipRoot = {
    dom: container,
    props: {
      children: [element],
    },
    alternate: currentRoot,
  };

  // åˆå§‹åŒ–æˆ–é‡ç½®å¾…åˆ é™¤çš„èŠ‚ç‚¹ï¼Œå› ä¸º fiber tree æ›´æ–°å‘ç”Ÿåœ¨ commit ä¹‹å‰
  // å› æ­¤åœ¨ commit é˜¶æ®µ old fiber å·²ç»è¢«æ›¿æ¢äº†ï¼Œæ‰€ä»¥åœ¨ fiber tree æ›´æ–°çš„
  // æ—¶å€™å°±è¦å°†è¦åˆ é™¤çš„ old fiber ç¼“å­˜èµ·æ¥
  deletion = [];
  nextUnitOfWork = wipRoot;
}
#+end_src

ç„¶ååœ¨æäº¤é˜¶æ®µ commitRoot ä¸­æ‰§è¡Œåˆ é™¤
#+begin_src js
function commitRoot() {
  deletion.forEach(commitWork) // æ‰§è¡ŒèŠ‚ç‚¹åˆ é™¤
  commitWork(wipRoot.child)
  currentRoot = wipRoot
  wipRoot = null
}

#+end_src

æœ€åä¿®æ”¹ commitWork å»å¤„ç†æ–°å¢çš„ fiber.effectTag æ ¹æ®ä¸åŒç±»å‹æ‰§è¡Œç›¸åº”çš„å¢åŠ ã€åˆ 
é™¤ã€æ›´æ–°æ“ä½œã€‚

#+begin_src js
function commitWork(fiber) {
  if (!fiber) return;

  // è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -> fiber.child -> fiber.sibling
  const domParent = fiber.parent.dom;
  if (fiber.effectTag === "PLACEMENT" && fiber.dom != null) {
    // æ·»åŠ æ–°èŠ‚ç‚¹
    domParent.appendChild(fiber.dom);
  } else if (fiber.effectTag === "DELETION") {
    domParent.removeChild(fiber.dom);
  } else if (fiber.effectTag === "UPDATE" && fiber.dom != null) {
    // æ›´æ–°èŠ‚ç‚¹
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  }

  commitWork(fiber.child);
  commitWork(fiber.sibling);
}
#+end_src

æ›´æ–°èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹çŠ¶æ€è¿›è¡Œå¯¹æ¯”ï¼Œè¿›è¡Œæ›´æ–°ï¼š
#+begin_src js
const isProperty = (key) => key !== "children";
// æ–°å±æ€§
const isNew = (prev, next) => (key) => prev[key] !== next[key];
// è¦åˆ é™¤çš„å±æ€§
const isGone = (prev, next) => (key) => !key in next;
function updateDom(dom, prevProps, nextProps) {
  // åˆ é™¤
  Object.keys(prevProps)
    .filter(isProperty)
    .filter(isGone(prevProps, nextProps))
    .forEach((name) => (dom[name] = ""));

  // æ›´æ–°æ–°å¢
  Object.keys(nextProps)
  .filter(isProperty)
  .filter(isNew(prevProps, nextProps))
  .forEach(name => (dom[name] = nextProps[name]))
}
#+end_src

å¤„ç†ç‰¹æ®Šå±æ€§ï¼šäº‹ä»¶å±æ€§çš„å¤„ç†ï¼Œéœ€è¦å°†åŸæ¥çš„ handler å…ˆç§»é™¤å†æ·»åŠ æ–°çš„ handlerã€‚
#+begin_src js
const isEvent = (key) => key.startsWith("on");
const isProperty = (key) => key !== "children" && !isEvent(key);
// æ–°å±æ€§
const isNew = (prev, next) => (key) => prev[key] !== next[key];
// è¦åˆ é™¤çš„å±æ€§
const isGone = (prev, next) => (key) => !key in next;
function updateDom(dom, prevProps, nextProps) {
  // ç§»é™¤æˆ–æ›´æ–° event listeners
  Object.keys(prevProps)
    .filter(isEvent)
    .filter((key) => !(key in nextProps) || isNew(prevProps, nextProps)(key))
    .forEach((name) => {
      const eventType = name.toLowerCase().substring(2);
      dom.removeEventListener(eventType, prevProps[name]);
    });
  // åˆ é™¤
  Object.keys(prevProps)
    .filter(isProperty)
    .filter(isGone(prevProps, nextProps))
    .forEach((name) => (dom[name] = ""));

  // æ›´æ–°æ–°å¢
  Object.keys(nextProps)
    .filter(isProperty)
    .filter(isNew(prevProps, nextProps))
    .forEach((name) => (dom[name] = nextProps[name]));

  // æ–°å¢äº‹ä»¶å±æ€§
  Object.keys(nextProps)
    .filter(isEvent)
    .filter(isNew(prevProps, nextProps))
    .forEach((name) => {
      const eventType = name.toLowerCase().substring(2);
      dom.addEventListener(eventType, nextProps[name]);
    });
}
#+end_src

ä¿®æ”¹ createDom åˆåˆ›å»º DOM å…ƒç´ çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ ~updateDom(dom, {}, fiber.props)~

#+begin_src diff
function createDom(fiber) {
  const dom = fiber.type === 'TEXT_ELEMENT'
    ? document.createTextNode('')
    : document.createElement(fiber.type)

-  const isProperty = (key) => key !== "children";
-  Object.keys(fiber.props)
-    .filter(isProperty)
-    .forEach((name) => (fiber[name] = fiber.props[name]));

+  updateDom(dom, {}, fiber.props)

  return dom
}
#+end_src

* å‡½æ•°ç»„ä»¶
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: function-component
:END:

å¦‚å®ä¾‹ï¼š
#+begin_src js
function App(props) {
  return <h1>Hi {props.name}</h1>
}
const element = <App name="foo"/>
// jsx -> js
function App(props) {
  return Didact.createElement('h1', null, "Hi ", props.name)
}
const element = Didact.createElement(App, {
  name: 'foo'
})
#+end_src

å‡½æ•°ç»„ä»¶ä¸æ™®é€šç»„ä»¶ä¸åŒç‚¹:

1. æ¥è‡ªå‡½æ•°ç»„ä»¶çš„ Fiber æ²¡æœ‰ DOM èŠ‚ç‚¹
2. fiber.children æ¥è‡ªå‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œè€Œä¸æ˜¯ç›´æ¥ä» props ä¸­å–


ä¿®æ”¹ performUnitOfWork å¢åŠ å‡½æ•°ç»„ä»¶åˆ¤æ–­:
#+begin_src js
function performUnitOfWork(fiber) {
  const isFunctionComponent = fiber.type instanceof Function
  if (isFunctionComponent) {
    updateFunctionComponent(fiber)
  } else {
    updateHostComponent(fiber)
  }

  // åˆ°è¿™é‡Œ fiber ç»“æ„åˆå§‹åŒ–å®Œæˆï¼Œæ­¤æ—¶æ¯ä¸ª fiber ä¹Ÿæœ‰äº†è‡ªå·±çš„
  // ä¸‰ä¸ªå¼•ç”¨ fiber.child, fiber.parent, fiber.sibling
  // ä¸‹é¢å°†è¦å»æ‰¾åˆ°å½“å‰ Fiber çš„ä¸‹ä¸€ä¸ª work unitï¼ŒæŸ¥æ‰¾éµå¾ªä¼˜å…ˆçº§:
  // fiber.child > fiber.sibling > fiber.parent.sibling
  if (fiber.child) {
    return fiber.child;
  }
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      // ç¬¬ä¸€æ¬¡è¿™é‡Œæ‰¾çš„æ˜¯å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æ‰¾åˆ°
      // ä¾ç€ fiber æ ‘å¾€ä¸Šæ‰¾ parent çš„ sibling
      return nextFiber.sibling;
    }

    nextFiber = nextFiber.parent;
  }
}
#+end_src

æ›´æ–°å‡½æ•°ç»„ä»¶ ~updateFunctionComponent(fiber)~ :
#+begin_src js
function updateFunctionComponent(fiber) {
  // æ‰§è¡Œå‡½æ•°ç»„ä»¶å¾—åˆ° children
  const children = [fiber.type(fiber.props)]
  reconcileChildren(fiber, children)
}
#+end_src

æ›´æ–°æ™®é€šç»„ä»¶ ~updateHostComponent(fiber)~ ç›´æ¥æŠŠ performUnitOfWork ä¸­åŸæ¥çš„å¤„ç†
æŒªè¿›æ¥å°± OK:
#+begin_src js
function updateHostComponent(fiber) {
  // 1. åˆ›å»º fiber dom å…ƒç´ 
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }

  reconcileChildren(fiber, fiber.props.children);
}
#+end_src

å› ä¸ºå‡½æ•°ç»„ä»¶å¹¶æ²¡æœ‰ DOM å…ƒç´ ï¼Œæ‰€ä»¥ commit é˜¶æ®µéœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰å°±å¾€ä¸Šæ‰¾çˆ¶çº§
çš„ dom å…ƒç´ ä½œä¸º parent ã€‚
#+begin_src js
function commitWork(fiber) {
  if (!fiber) return;

  // è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -> fiber.child -> fiber.sibling
  const domParentFiber = fiber.parent;
  // å¦‚æœæ˜¯å‡½æ•°ç»„ä»¶æ˜¯æ²¡æœ‰ dom çš„ï¼Œé‚£ä¹ˆéœ€è¦æ‰¾åˆ°å®ƒçš„çˆ¶çº§ä½œä¸ºç›®æ ‡ parent
  while (!domParentFiber.dom) {
    domParentFiber = domParentFiber.parent;
  }
  const domParent = domParentFiber.dom;

  if (fiber.effectTag === "PLACEMENT" && fiber.dom != null) {
    // æ·»åŠ æ–°èŠ‚ç‚¹
    domParent.appendChild(fiber.dom);
  } else if (fiber.effectTag === "UPDATE" && fiber.dom != null) {
    // æ›´æ–°èŠ‚ç‚¹
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  } else if (fiber.effectTag === "DELETION") {
    commitDeletion(fiber, domParent);
  }

  commitWork(fiber.child);
  commitWork(fiber.sibling);
}
#+end_src

åˆ é™¤çš„æ—¶å€™ä¹Ÿå¿…é¡»æ‰¾åˆ°æœ‰ child çš„ fiber, commitDeletion ï¼š
#+begin_src js
function commitDeletion(fiber, domParent) {
  if (fiber.dom) {
    domParent.removeChild(fiber.dom)
  } else {
    commitDeletion(fiber.child, domParent)
  }
}
#+end_src
* hooks
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hooks
:END:

æ·»åŠ çŠ¶æ€å’Œ hooksã€‚

åœ¨å‡½æ•°ç»„ä»¶ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ ~useState~ hook æ¥è·å–çŠ¶æ€ä»¥åŠæ”¹å˜çŠ¶æ€çš„å‡½æ•° ~setState~
è®©æˆ‘ä»¬èƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­æ¥æ›´æ–°çŠ¶æ€ï¼Œä»è€Œæ¥æ›´æ–°UIã€‚

å®ä¾‹ï¼š
#+begin_src js
function Counter() {
const [state, setState] = useState(1)
  return (
    <h1 onClick={() => setState(c => c+1)}>
      Count: { state }
    </h1>
  )
}
const elment = <Counter/>
#+end_src

å®ç° useState å¹¶ä¸”ä¿®æ”¹å‡½æ•°ç»„ä»¶çš„æ›´æ–°å‡½æ•° updateFunctionComponent è®©çŠ¶æ€çš„ä¿®æ”¹èƒ½
è§¦å‘è¯¥å‡½æ•°æ‰§è¡Œ:
#+begin_src js
function useState(initial) {
}

let wipFiber = null
let hookIndex = null
function updateFunctionComponent(fiber) {
  wipFiber = fiber
  hookIndex = 0
  wipFiber.hooks = []

  const children = [fiber.type(fiber.props)]
  reconcileChildren(fiber, children)
}
#+end_src

æ–°å¢ fiber.hooks ç›®çš„æ˜¯ä¸ºäº†åœ¨åŒä¸€ä¸ªç»„ä»¶å†…å¯ä»¥å¤šæ¬¡è°ƒç”¨ ~useState~, å¹¶ä¸”è®°å½•æ¯ä¸ª
hook æ‰€åœ¨çš„ç´¢å¼• hookIndex ã€‚

å½“ç»„ä»¶è°ƒç”¨ ~useState~ æ—¶å€™ï¼Œåœ¨é‡Œé¢è¦å»æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ old hookï¼Œä» fiber.alternate
æ ¹æ® hookIndex å»æ‰¾ã€‚
#+begin_src js
function useState(initial) {
  const oldHook =
    wipFiber.alternate &&
    wipFiber.alternate.hooks &&
    wipFiber.alternate.hooks[hookIndex];

  // å¦‚æœæœ‰è€çš„ hook ï¼Œè¦å°†è€çš„ hook state æ›´æ–°è¿‡æ¥
  const hook = {
    state: oldHook ? oldHook.state : initial,
    // ç¼“å­˜çŠ¶æ€æ›´æ–°çš„ action
    queue: [],
  };

  // æ›´æ–°ä¹‹å‰å…ˆæ‰§è¡Œ actions æ›´æ–°çŠ¶æ€ï¼Œå› æ­¤åœ¨çŠ¶æ€è¿”å›ä¹‹å‰æ˜¯æœ€æ–°çš„
  const actions = oldHook ? oldHook.queue : [];
  actions.forEach((action) => (hook.state = action(hook.state)));

  const setState = (action) => {
    hook.queue.push(action);
    wipRoot = {
      dom: currentRoot.dom,
      props: currentRoot.props,
      alternate: currentRoot,
    };
    // çŠ¶æ€æ›´æ–°ï¼Œæ’å…¥æ–°çš„ work unit
    nextUnitOfWork = wipRoot;
    deletion = [];
  };

  wipFiber.hooks.push(hook);
  hookIndex++;
  return [hook.state, setState];
}
#+end_src

* æœ€ç»ˆæºç æµç¨‹å›¾
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: src-map
:END:

[[/img/react/react-src-code.svg]]

* æµ‹è¯•
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: test
:END:

#+begin_export html
<div id="qvJvTTqyJw"></div>
<script src="/js/react/tests/qvJvTTqyJw.js"></script>
#+end_export

* æ€»ç»“
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: summary
:END:

é€šè¿‡[[https://pomb.us/build-your-own-react/][ä½œè€…]]çš„è¿™ä¸ªå®ç°ï¼Œå¯¹ react çš„éƒ¨åˆ†ä¸»è¦åŠŸèƒ½æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ï¼Œæ–‡å†…æ¶‰åŠçš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼š

1. createElement å®ç°
2. render å‡½æ•°çš„å®ç°
3. fiber tree çš„å¤„ç†(åˆå§‹åŒ–ï¼Œæ›´æ–°ï¼Œåˆ é™¤ï¼Œæ–°å¢ç­‰)
4. commit é˜¶æ®µå¤„ç†ï¼Œå®é™…æ¸²æŸ“DOMå’Œ fiber tree çš„éå†æ˜¯åˆ†å¼€çš„
5. useState hook å‡½æ•°å®ç°çš„åŸºç¡€åŸç†ï¼Œé€šè¿‡ wipFiber + hookIndex æ¥å®ç°å‡½æ•°ç»„ä»¶å’Œ
   useState çš„è¿æ¥ï¼Œä»è€Œäº’ç›¸å½±å“ã€‚
