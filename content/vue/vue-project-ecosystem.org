#+TITLE: Vue3 å¼€å‘ç”Ÿæ€é“¾(vuex, vue-router, ...)
#+DATE: <2021-04-21 16:53:02>
#+TAGS[]: vue, vue3, vue-router, vuex, i18n
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent shrink inlineimages

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<script src="/js/utils.js"></script>
<script src="/js/vue/vue-next.js"></script>
<script>
insertCssLink("https://unpkg.com/element-plus/lib/theme-chalk/index.css");
</script>
<script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

#+begin_quote
è¯¥æ–‡è®°å½•ç€å®é™…å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„ vue3 åŠå…¶ç”Ÿæ€ä¸­ç›¸å…³çš„æ¡†æ¶æˆ–åº“é‡åˆ°çš„å„ç§é—®é¢˜ï¼Œå’Œ
å…¶ä»–æ”¶é›†ã€‚
#+end_quote

* ç›¸å…³é¡¹ç›®
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: link
:END:

[[https://github.com/xiaoxian521/vue-pure-admin][xiaoxian521/vue-pure-admin: âœ¨ ğŸš€Vue3.0+TypeScript+Vite2.0+Element-Plusç¼–å†™çš„ä¸€
å¥—åå°ç®¡ç†ç³»ç»Ÿ]]
* vue-next
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: vue-next
:END:

** template ref ä½¿ç”¨
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: tpl-ref
:END:

[[/vue/vue-mind-map-runtime-core-3-component/#ref][runtime-core ref å±æ€§è§£æ&åˆ†æ]]

æ¨¡æ¿ï¼š attrs å½¢å¼ä½¿ç”¨ ref å°†ä¼šç»‘å®š elForm ã€‚
#+begin_src html
<templet>
  <el-form ref="elForm"/>
</templet>
#+end_src

setup:

#+begin_src typescript
defineComponent({
  setup(props, ctx) {
    // å£°æ˜ element ref å˜é‡
    const elForm = ref(null)

    // ä½¿ç”¨
    onMounted(() => {
      elForm.value.validate(/* bala bala... */)
    })

    return { elForm }
  }
})
#+end_src

æ³¨æ„ç‚¹ï¼š
1. ~ref="elForm"~ ä¸èƒ½ä½¿ç”¨ ~v-bind:ref~ åªèƒ½æ˜¯ ~attrs~
2. ä½¿ç”¨æ—¶ ~elForm.value~ å› ä¸ºå®ƒæ˜¯ä¸ª ~Ref~ ç±»å‹

* vue-router-next
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: vue-router-next
:END:

[[https://github.com/vuejs/vue-router-next][vuejs/vue-router-next: The Vue 3 official router]]

* vuex
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: vuex
:END:

[[https://github.com/vuejs/vuex/tree/4.0][vuejs/vuex at 4.0]]

[[https://next.vuex.vuejs.org/installation.html#npm][Installation | Vuex]]

** ä½¿ç”¨
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: vuex-usage
:END:

creation:

#+begin_src typescript
import { createStore } from "vuex";
import permission from "./modules/permission";

const store = createStore({
  modules: {
    permission,
  },
});

export default store;
#+end_src

æ¨¡å—ï¼š æƒé™èœå• (permission)
#+begin_src typescript
// './modules/permission'
// State
const state: PermissionState = {
  asyncMenus: [] as MenuItem[],
  minorRoutes: [] as RouteConfigRecord[],
  get mountedRoutes(): RouteConfigRecord[] {
    // TODO æ ¹æ®å½“å‰ç”¨æˆ·ä»æœåŠ¡å™¨è·å–æƒé™èœå•ï¼Œè·Ÿæ–°åˆ° asyncMenus ä¸­
    // æ ¹æ®è¿‡æ»¤åçš„ç»“æœè¿›è¡Œæ¸²æŸ“
    return toBeMounted;
  },
};

// mutation ä¸å¯ç›´æ¥è°ƒç”¨çš„ï¼Œå¿…é¡»é€šè¿‡ commit(SET_MENUS) æ¥è°ƒç”¨
// æ›´æ–°çŠ¶æ€
const mutations = {
  [SET_MENUS](state: PermissionState, menus: MenuItem[]): void {
    state.asyncMenus = menus;
  },

  [SET_MINOR_ROUTES](state: PermissionState, routes: RouteConfigRecord[]) {
    state.minorRoutes = routes;
  },
};

// action ç»„ä»¶ä¸­å¯é€šè¿‡ store.dispatch('permission/getMenus') æ¥è§¦å‘
// å¯¹åº”çš„ action, æ³¨æ„è¿™é‡Œå¦‚æœæ˜¯æ¨¡å—åŒ–éœ€è¦åŠ ä¸Š 'permission/'
const actions = {
  async getMenus({ commit }: ActionContext) {
    if (state.asyncMenus.length) {
      return state.asyncMenus;
    }

    const res = await getMenuList();
    commit(SET_MENUS, res.data);
    return res.data;
  },
};

// æœ€åå°†ç»“æœå¯¼å‡ºï¼Œå½¢æˆä¸€ä¸ª store æ¨¡å— permission
export default {
  state,
  mutations,
  actions,
  namespaced: true,
};
#+end_src
** æ•°æ®æŒä¹…åŒ–
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: vuex-persist
:END:

[[/vue/vue-vuex-persist/][vuex-persist æ•°æ®æŒä¹…åŒ–ï¼Œæºç ç®€æ]]
** ç–‘éš¾æ‚ç—‡

*** state: get mountedRoutes æ²¡æœ‰è§¦å‘ï¼Ÿ

é—®é¢˜ç¼˜ç”±:

1. getMenus ä»æœåŠ¡ç«¯è¯·æ±‚æƒæ§èœå•

   #+begin_src typescript
   const actions: ActionTree<PermissionState, RootState> = {
     async getMenus({ commit, state }: ActionContext<PermissionState, RootState>) {
       if (state.asyncMenus.length) {
         return state.asyncMenus;
       }

       const res = await getMenuList();
       commit(SET_MENUS, res.data);
       console.log(state.mountedRoutes, "xxx");
       return res.data;
     },
   };
   #+end_src

2. state: get mountedRoutes()

   ç„¶åï¼Œå¸Œæœ›åœ¨ä¹‹åå– mountedRoutes çš„æ—¶å€™èƒ½ä» asyncMenus ä¸­è¿‡æ»¤å‡ºç‰¹å®šæƒé™çš„è·¯ç”±ï¼Œ
   ä½†æ˜¯è²Œä¼¼è¿™ä¸ª getter æ€ä¹ˆéƒ½æ²¡æ‰§è¡Œï¼Œå› ä¸ºé‡Œé¢çš„ console.log å¹¶æ²¡æœ‰æ‰“å°å‡ºæ¥ã€‚
   #+begin_src typescript
   const state = {
     get mountedRoutes(): RouteConfigRecord[] {
       console.log(this.asyncMenus, asyncRoutes, "0000");
       const toBeMounted = filterRoutesByMenu(asyncRoutes, this.asyncMenus);

       toBeMounted.forEach((r: RouteConfigRecord) => {
         if (r.children && r.children.length && r.meta!.showInMenu) {
           const menuRoutes = r.children.filter((child) => child.meta!.showInMenu);
           if (menuRoutes.length) {
             r.redirect = menuRoutes[0].path;
           }
         }
       });
       return toBeMounted;
     },
   };
   #+end_src


#+begin_quote
â— åœ¨ vue3 ä¸­å“åº”å¼é€šè¿‡ Proxy + Reflect æ¥å®ç°çš„ï¼Œå» get mountedRoutes æœ€åæ‰§è¡Œçš„æ˜¯
~Reflect.get(state, 'mountedRoutes', ...)~ è¿™åº•å±‚ä¼°è®¡ä¸ä¼šå»è®¿é—® getter è®¿é—®å™¨ï¼Œ
æ‰å¯¼è‡´ä¸ç”Ÿæ•ˆã€‚
#+end_quote

è§£å†³æ–¹æ¡ˆ(æŠ˜ä¸­æ–¹æ¡ˆ)ï¼š
#+begin_src typescript
const state: PermissionState = {
  asyncMenus: [] as MenuItem[],
  minorRoutes: [] as RouteConfigRecord[],
  // ADD1 ä¸ä½¿ç”¨ getter
  mountedRoutes: [] as RouteConfigRecord[]
}

const mutations: MutationTree<PermissionState> = {
  // ADD2 å¢åŠ ä¸€ä¸ª mutation å»æ›´æ–°è·¯ç”±åˆ—è¡¨
  [SET_MOUNTED_ROUTES](state: PermissionState) {
    const menus: MenuItem[] = state.asyncMenus
    const toBeMounted = filterRoutesByMenu(asyncRoutes, menus)
    toBeMounted.forEach((r: RouteConfigRecord) => {
      if (r.children?.length && r.meta?.showInMenu) {
        const menuRoutes = r.children.filter((child) => child.meta!.showInMenu)
        if (menuRoutes.length) {
          r.redirect = menuRoutes[0].path
        }
      }
    })
    state.mountedRoutes = toBeMounted
  }
}

const actions: ActionTree<PermissionState, RootState> = {
  async getMenus({ commit, state }: ActionContext<PermissionState, RootState>) {
    if (state.asyncMenus.length) {
      return state.asyncMenus
    }

    const res = await getMenuList()
    commit(SET_MENUS, res.data)
    // ADD3 è¿™é‡Œå½“æ›´æ–°èœå•çš„æ—¶å€™åŒæ­¥è¿‡æ»¤å‡ºæœ‰æ•ˆè·¯ç”±
    commit(SET_MOUNTED_ROUTES)
    return res.data
  },
}
#+end_src

ç»“æœï¼š
#+begin_src console
[[Target]]: Object
asyncMenus: (4) [{â€¦}, {â€¦}, {â€¦}, {â€¦}]
minorRoutes: []
mountedRoutes: (4) [{â€¦}, {â€¦}, {â€¦}, {â€¦}]
#+end_src

* vue-i18n-next
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: i18n
:END:

[[https://github.com/intlify/vue-i18n-next][intlify/vue-i18n-next: Vue I18n for Vue 3]]

Docs: [[https://vue-i18n.intlify.dev/installation.html][Installation | Vue I18n]]

Usageï¼š [[https://lokalise.com/blog/vue-i18n/?utm_source=google&utm_medium=cpc&utm_campaign=GENERIC_i18n-vuejs&gclid=CjwKCAjwmv-DBhAMEiwA7xYrd7ANX_aqFQTLUvwubzttdV17rEvpRlq8m8GZjCjk6kqQ1bGFg_kdhBoCaKwQAvD_BwE][Vue i18n: Building a multi-lingual app - Lokalise Blog]]

1. vue-i18n esm-bundler è­¦å‘Š

   #+begin_quote
   You are running the esm-bundler build of vue-i18n. It is recommended to configure your bundler to explicitly replace feature flag globals with boolean literals to get proper tree-shaking in the final bundle.
   #+end_quote

   [[https://github.com/xiaoxian521/vue-pure-admin/commit/f2db3acee2629ec26bc531a5b0b4be9eaec14dab][fixï¼šè§£å†³vue-i18nåœ¨å¼€å‘ç¯å¢ƒä¸‹çš„å‘Šè­¦ Â· xiaoxian521/vue-pure-admin@f2db3ac]]

   #+begin_src diff
   alias: {
     "@": path.resolve(__dirname, "./src"),
+  "vue-i18n": "vue-i18n/dist/vue-i18n.cjs.js",
   };
   #+end_src

