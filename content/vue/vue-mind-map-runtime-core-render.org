#+TITLE: Vue3 æºç å¤´è„‘é£æš´ä¹‹ 7 â˜ runtime-core(2) - render
#+DATE: <2021-01-26 14:14:35>
#+TAGS[]: vue, vue3, runtime-core, render
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent shrink

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

@@html:<kbd>@@
*[[https://github.com/gcclll/stb-vue-next][stb-vue-next]] å®Œå…¨æ‹·è´äº [[https://github.com/vuejs/vue-next][vue-next]] ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚*
@@html:</kbd>@@

#+begin_quote
*å£°æ˜* ï¼švue-next runtime-core ä¸­çš„ render å‡½æ•°éƒ¨åˆ†ã€‚

*æ›´æ–°æ—¥å¿—&Todos* ï¼š
1. [2021-01-26 14:15:15] åˆ›å»º
#+end_quote

[[/img/tmp/20210126143153.png]]

#+begin_quote
2229 - 423 = 1806 ğŸ¤¦â€â™€ï¸ ä¸€ä¸ªå‡½æ•°å°±å°†è¿‘ä¸¤åƒè¡Œï¼ŒğŸ˜²ï¼ï¼

è¯¶ï¼ï¼!

è·¯æ¼«æ¼«ç³»å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢ï¼!!

åŠ æ²¹å§ï¼Œå¤§å”ï¼ŒåšæŒä¸‹å»ï¼ï¼ï¼

å¼€å§‹ä¹‹å‰ç»™è‡ªå·±æ‰“æ‰“æ°”ï¼Œè¿˜æœ‰è¯¸å¤šçš„ç–‘æƒ‘ç­‰ç€å»è§£å¯†å‘¢ğŸ”¥ğŸ”¥
#+end_quote

[[/img/vue3/runtime-core/vue-runtime-core-render.svg]]

* init

[[https://github.com/gcclll/stb-vue-next/commit/fb9738c18c624fe7525afa48b12b6589a3ac0dfe][feat(init): render function Â· gcclll/stb-vue-next@fb9738c Â· GitHub]]


ä¸¤ä¸ª create render å‡½æ•°ï¼š

1. ~createRenderer(options)~
2. ~createHydrationRenderer(options)~

   è¿™ä¸ªè¿˜ä¸æ¸…æ¥šæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œé€šè¿‡ä»£ç è§‚å¯Ÿè²Œä¼¼è·Ÿ SSR æœ‰å…³ï¼Œå…ˆæç½®å…ˆä¸ç®¡ã€‚


ä¸¤ä¸ªå‡½æ•°æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„ ~baseCreateRenderer(options, createHydrationFns)~

å¹¶ä¸”å°±æ˜¯è¿™ä¸ªå‡½æ•°å°†è¿‘ä¸¤åƒè¡Œ~~~~

#+begin_src typescript
export function createRenderer<
  HostNode = RendererNode,
  HostElement = RendererElement
>(options: RendererOptions<HostNode, HostElement>) {
  return baseCreateRenderer<HostNode, HostElement>(options);
}

export function createHydrationRenderer(
  options: RendererOptions<Node, Element>
) {
  return baseCreateRenderer(options, createHydrationFunctions);
}

// implementation
function baseCreateRenderer(
  options: RendererOptions,
  createHydrationFns?: typeof createHydrationFunctions
) {
  // TODO
}
#+end_src
* function list

[[https://github.com/gcclll/stb-vue-next/commit/b7f55a8fe0f70a58b6af48278f601777b8b3d36a][feat(init): renderer -> baseCreateRenderer TODOs Â· gcclll/stb-vue-next@b7f55a8 Â· GitHub]]

~baseCreateRenderer(options, createHydrationFns)~ ä¹‹æ‰€ä»¥è¿™ä¹ˆé•¿ï¼Œæ˜¯å› ä¸ºè¿™é‡Œé¢åŒ…å«
äº†ä¸‰åå‡ ä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œä¸‹é¢å°†ä¸€ä¸ªä¸ªæŒ‰ç…§æµç¨‹é€ä¸€å®ç°ã€‚

| step                     | what?                | step               | what?        |
|--------------------------+----------------------+--------------------+--------------|
| options                  | è§£æ„                 | patch              | function     |
| processText              | æ–‡æœ¬å¤„ç†             | processCommentNode | æ³¨é‡ŠèŠ‚ç‚¹     |
| mountStaticNode          | åŠ è½½é™æ€èŠ‚ç‚¹         | patchStaticNode    | -            |
| moveStaticNode           | -                    | removeStaticNode   | åˆ é™¤é™æ€èŠ‚ç‚¹ |
| processElement           | -                    | *mountElement*       | -            |
| setScopeId               | -                    | *mountChildren*      | -            |
| patchElement             | -                    | patchBlockChildren | -            |
| patchProps               | -                    | processFragment    | -            |
| processComponent         | -                    | *mountComponent*     | -            |
| *updateComponent*        | -                    | setupRenderEffect  | -            |
| updateComponentPreRender | -                    | patchChildren      | -            |
| patchUnkeyedChildren     | -                    | patchKeyedChildren | -            |
| *move*                   |                      | *unmount*            |              |
| *remove*                 | -                    | removeFragment     | -            |
| unmountComponent         | -                    | *unmountChildren*    | -            |
| getNextHostNode          | -                    | *render*             | -            |
| internals                | object, ä¸Šè¿°å‡½æ•°åˆ«å | createHydrationFns | -            |

æœ€åå‡½æ•°è¿”å› ~{ render, hydrate, createApp }~
* render(vnode, container)

[[https://github.com/gcclll/stb-vue-next/commit/9f5b40b943cf24c21bb2ee01459254df0be42972][feat(init): baseCreateRender-> render Â· gcclll/stb-vue-next@9f5b40b Â· GitHub]]

[[https://github.com/gcclll/stb-vue-next/commit/d4e10d444605e1b8096a8e335262a2561f7376be][feat(init): baseCreateRender-> render with unmount Â· gcclll/stb-vue-next@d4e10d4
Â· GitHub]]

#+begin_src typescript
const render: RootRenderFunction = (vnode, container) => {
  // render(h('div'), root)
  if (vnode == null) {
    if (container._vnode) {
      unmount(container._vnode, null, null, true);
    }
  } else {
    patch(container._vnode || null, vnode, container);
  }
  // æ‰§è¡Œæ‰€æœ‰ post å¼‚æ­¥ä»»åŠ¡
  flushPostFlushCbs();
  container._vnode = vnode;
};
#+end_src

1. vnode ä¸ºç©ºï¼Œä¸” conatainer ä¸Šæœ‰æ³¨å†Œè¿‡ _vnodeï¼Œç»„è¦è¿›è¡Œå¸è½½

   å¦‚ï¼š ~render(ref.value ? h('div') : null)~

   ref.value = true æ—¶å€™è¿›å…¥ else -> patch

   ref.value = false æ—¶å€™è¿›å…¥ if -> unmount

2. å¦åˆ™æ‰§è¡Œ patch()ï¼Œå¹²ä»€ä¹ˆäº†?

3. ~flushPostFlushCbs()~ æ­¤æ—¶ç»„ä»¶åº”è¯¥ mounted äº†ï¼Œæ‰‹åŠ¨åˆ·æ‰æ‰€æœ‰ post cbs ã€‚

4. ä¿å­˜ _vnodeï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¿›å…¥æ˜¯æ£€æµ‹


æ¥ä¸‹æ¥ï¼Œéœ€è¦ç»§ç»­å®ç° ~unmount()~ å’Œ ~patch()~
* patch(...args)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-patch
:END:

[[https://github.com/gcclll/stb-vue-next/commit/eb48eb9b6a14b0654ed2a4eb966338c2bfe8afe1][feat(init): baseCreateRender-> patch -> processElement Â· gcclll/stb-vue-next@eb48eb9 Â· GitHub]]

å‚æ•°:

| å‚æ•°å          | æè¿°          |
|-----------------+---------------|
| n1              | VNode, è€èŠ‚ç‚¹ |
| n2              | VNode, æ–°èŠ‚ç‚¹ |
| container       | å®¹å™¨          |
| anchor          | ?             |
| parentComponent | çˆ¶çº§ç»„ä»¶      |
| parentSuspense  | Suspense ?    |
| isSVG           | ?             |
| optimized       | æ˜¯å¦ä¼˜åŒ–è¿‡ï¼Ÿ  |

1. æ£€æµ‹èŠ‚ç‚¹ç±»å‹æ˜¯ä¸æ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸ä¸€æ ·ç›´æ¥å¸è½½è€çš„

   å› ä¸ºç±»å‹éƒ½ä¸ä¸€æ ·äº†ï¼Œå¯èƒ½æ•´ä¸ªğŸŒ²éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œç›´æ¥å¸è½½è€çš„é‡æ–° patch æ–°çš„(*n2*)ã€‚

   #+begin_src typescript
   export function isSameVNodeType(n1: VNode, n2: VNode): boolean {
     if (
       __DEV__ &&
       n2.shapeFlag & ShapeFlags.COMPONENT &&
       hmrDirtyComponents.has(n2.type as ConcreteComponent)
     ) {
       // HMR only: if the component has been hot-updated, force a reload.
       // ç»„ä»¶è¢«çƒ­æ›´æ–°ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
       return false;
     }
     return n1.type === n2.type && n1.key === n2.key;
   }
   #+end_src

   - ç»„ä»¶å‘ç”Ÿäº†çƒ­æ›´æ–°(HMRå¯ç”¨æƒ…å†µä¸‹)ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½ç»„ä»¶

   - åŒæ—¶åˆ¤æ–­ type å’Œ keyï¼Œæœ‰å¯èƒ½ type ä¸€æ ·(æ¯”å¦‚ï¼š ~ul>li~ åŒç±»å‹å…ƒç´ çš„åˆ é™¤ç§»åŠ¨æ“ä½œ)

2. switch -> n2.type æ ¹æ®ç±»å‹ä¸åŒèµ°ä¸åŒåˆ†æ”¯è¿›è¡Œå¤„ç†

   åªæ”¯æŒçš„ç±»å‹ï¼š ~Text|Comment|Static~ èŠ‚ç‚¹ç±»å‹

   ç»„ä»¶ç±»å‹(default åˆ†æ”¯): ~ELEMENT/TELEPORT/COMPONENT/SUSPENSE~
* processElement(...args)

[[https://github.com/gcclll/stb-vue-next/commit/761db2b532ceaaf9554b7df07e2fffe686cd98f0][feat(init): baseCreateRender-> patch -> processElement imp Â·
gcclll/stb-vue-next@761db2b Â· GitHub]]

args åŒ [[#fn-patch][patch çš„ args]] ã€‚

#+begin_src typescript
const processElement = (
  n1: VNode | null,
  n2: VNode,
  container: RendererElement,
  anchor: RendererNode | null,
  parentComponent: ComponentInternalInstance | null,
  parentSuspense: SuspenseBoundary | null,
  isSVB: boolean,
  isSVG: boolean,
  optimized: boolean
) => {
  isSVG = isSVG || (n2.type as string) === "svg";
  if (n1 == null) {
    // no old
    mountElement(
      n2,
      container,
      anchor,
      parentComponent,
      parentSuspense,
      isSVG,
      optimized
    );
  } else {
    patchElement(n1, n2, parentComponent, parentSuspense, isSVG, optimized);
  }
};
#+end_src

1. æ²¡æœ‰ n1 è€èŠ‚ç‚¹ï¼Œç›´æ¥ mount æ–°çš„ n2 èŠ‚ç‚¹
2. å¦åˆ™ï¼Œè¿›è¡Œ patch æ“ä½œ


æ¥ä¸‹æ¥æŒ‰ç…§ [[#fn-patchElement][patchElement]] -> [[#fn-mountElement][mountElement]] é¡ºåºå®ç°ã€‚

* patchElement(...args)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-patchElement
:END:

è¿›è¡Œåˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆæ­¥çš„åˆ¤æ–­ï¼Œ patch å’Œ mount çš„åŒºåˆ«ï¼Œ

*patch*: éé¦–æ¬¡åŠ è½½ç»„ä»¶çš„æ—¶å€™ï¼Œç”¨ new å’Œ old vnode èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒç„¶åå¯¹å‘ç”Ÿå˜æ›´çš„
èŠ‚ç‚¹è¿›è¡Œæ›¿æ¢æˆ–æ›´æ–°æ“ä½œã€‚

*mount*: å±äºé¦–æ¬¡åŠ è½½ç»„ä»¶çš„æ—¶å€™ï¼Œå±äºé‡æ–°åˆ›å»ºèŠ‚ç‚¹çš„æ“ä½œï¼Œä¸å­˜åœ¨æ¯”è¾ƒä»€ä¹ˆçš„ä¸€äº›æ“
ä½œã€‚

æ¯”å¦‚ï¼š ~render~ é‡Œé¢çš„æ ¹æ® vnode æ¥åˆ¤æ–­æ˜¯ Unmount è¿˜æ˜¯ patchï¼Œä»¥åŠ
processElement ä¸­æ ¹æ® old vnode æ¥æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰æ—§çš„èŠ‚ç‚¹(éé¦–æ¬¡)æ¥åˆ¤å®šæ˜¯ç›´æ¥ Mount
ç»„ä»¶è¿˜æ˜¯ patch æ¯”è¾ƒæ›´æ–°ç»„ä»¶ã€‚

** default ELEMENT

[[https://github.com/gcclll/stb-vue-next/commit/81af3859c02379dac8aec3a08374c2936fdc4fe2][feat(add): patch element Â· gcclll/stb-vue-next@81af385 Â· GitHub]]

render å‡½æ•°å®ç°ï¼Œ vnode ä¸ºç©ºä¼šè¿›å…¥å¸è½½ unmount æµç¨‹ï¼Œå¦åˆ™æ‰§è¡Œçš„æ˜¯ patch ï¼Œè¿™ä¸ªåº”
è¯¥å°±æ˜¯é€šè¿‡ vnode èŠ‚ç‚¹ç»“æ„æ‰§è¡Œ diff å’Œ dom æ“ä½œçš„å…¥å£äº†ã€‚

#+begin_src typescript
const render: RootRenderFunction = (vnode, container) => {
    console.log('render.......xxx')
    // render(h('div'), root)
    if (vnode == null) {
      if (container._vnode) {
        unmount(container._vnode, null, null, true)
      }
    } else {
      patch(container._vnode || null, vnode, container)
    }
    // æ‰§è¡Œæ‰€æœ‰ post å¼‚æ­¥ä»»åŠ¡
    flushPostFlushCbs()
    container._vnode = vnode
  }
#+end_src

æ³¨æ„ä¸Šé¢çš„ ~flushPostFlushCbs()~ æ˜¯åœ¨ patch ä¹‹åæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ post cbs ä¼šåœ¨ç»„
ä»¶ mount/unmount å®Œæˆä¹‹åçš„ä¸‹ä¸€ä¸ª tick å»æ‰§è¡Œçš„å›è°ƒã€‚

#+begin_src typescript
const patch: PatchFn = (
    n1,
    n2,
    container,
    anchor = null,
    parentComponent = null,
    parentSuspense = null,
    isSVG = false,
    optimized = false
  ) => {
    console.log('patching...')
    // ä¸åŒç±»å‹èŠ‚ç‚¹ï¼Œç›´æ¥å¸è½½è€çš„ğŸŒ²
    if (n1 && !isSameVNodeType(n1, n2)) {
      // TODO
    }

    // TODO patch bail, è¿›è¡Œå…¨æ¯”è¾ƒ(full diff)

    // æ–°èŠ‚ç‚¹å¤„ç†
    const { type, ref, shapeFlag } = n2
    switch (type) {
      default:
        // ELEMENT/COMPONENT/TELEPORT/SUSPENSE
        // é»˜è®¤åªæ”¯æŒè¿™å››ç§ç»„ä»¶
        if (shapeFlag & ShapeFlags.ELEMENT) {
          processElement(
            n1,
            n2,
            container,
            anchor,
            parentComponent,
            parentSuspense,
            isSVG,
            optimized
          )
        }
        break
    }

    if (ref != null && parentComponent) {
      // TODO set ref
    }
  }
#+end_src

patch å‡½æ•°é‡Œé¢é€šè¿‡ switch åˆ†æ”¯æ ¹æ® ~ShapeFlags~ çš„ç±»å‹ç±»è°ƒç”¨å¯¹åº”çš„  ~processXxx~
å‡½æ•°è¿›è¡Œå¤„ç† old/new vnode èŠ‚ç‚¹ï¼Œè€Œè¿™é‡Œçš„ ~ShapeFlags~ å€¼çš„ä¾æ®æ¥è‡ªå“ªé‡Œï¼Ÿæ˜¯åœ¨å“ª
é‡Œèµ‹å€¼çš„ï¼Œç”±ç”±ä»€ä¹ˆä½œç”¨ï¼Ÿ ã€‚

è¿™é‡Œä»¥æ™®é€šçš„ ELEMENT æ ‡ç­¾ä½œä¸ºåˆ‡å…¥ç‚¹æ¥å®ç°ä¸€ä¸ªå®Œæ•´çš„è¿‡ç¨‹ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°
processElement ã€‚

#+begin_src typescript
const processElement = (
    n1: VNode | null,
    n2: VNode,
    container: RendererElement,
    anchor: RendererNode | null,
    parentComponent: ComponentInternalInstance | null,
    parentSuspense: SuspenseBoundary | null,
    isSVG: boolean,
    optimized: boolean
  ) => {
    isSVG = isSVG || (n2.type as string) === 'svg'
    if (n1 == null) {
      // no old
      mountElement(
        n2,
        container,
        anchor,
        parentComponent,
        parentSuspense,
        isSVG,
        optimized
      )
    } else {
      // è¯¥é˜¶æ®µè¿˜ä¸ä¼šåˆ°è¿™é‡Œ
      patchElement(n1, n2, parentComponent, parentSuspense, isSVG, optimized)
    }
  }
#+end_src

è¿™é‡Œå°±æ˜¯ä¸ªå¾ˆç®€å• if...else åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰æ—§çš„èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ˜¯ mount æœ‰åˆ™æ˜¯ patch æ“ä½œï¼Œ
æ‰€ä»¥éœ€è¦å®Œæˆ mountElement
#+begin_src typescript
const mountElement = (
    vnode: VNode,
    container: RendererElement,
    anchor: RendererNode | null,
    parentComponent: ComponentInternalInstance | null,
    parentSuspense: SuspenseBoundary | null,
    isSVG: boolean,
    optimized: boolean
  ) => {
    console.log('mount element...')
    let el: RendererElement
    let vnodeHook: VNodeHook | undefined | null
    const { type, shapeFlag, patchFlag, props } = vnode

    if (
      !__DEV__ &&
      vnode.el &&
      hostCloneNode !== undefined &&
      patchFlag === PatchFlags.HOISTED
    ) {
      // TODO
    } else {
      el = vnode.el = hostCreateElement(
        vnode.type as string,
        isSVG,
        props && props.is
      )
    }

    // hostInsert
    hostInsert(el, container, anchor)
  }
#+end_src

mountElement é‡Œé¢ä¸¤ä¸ªæ ¸å¿ƒçš„å‡½æ•° ~hostCreateElement~ å’Œ ~hostInsert~ åˆ†åˆ«æ¥è‡ª
~baseCreateRender(option)~ çš„ option å‚æ•°ã€‚

è¿™é‡Œå°±éœ€è¦æ·±å…¥äº†è§£ ~runtime-test~ è¿™ä¸ªåŒ…ï¼Œå®ƒæ˜¯ä½œç”¨ä¸ºäº†èƒ½æµ‹è¯• runtime-core ç¼–å†™çš„
ä¸€ä¸ªæµ‹è¯•æŠ¥ï¼Œè¿™é‡ŒåŒ…å«äº†ä¸€äº›åˆ—çš„ DOM æ“ä½œå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¹Ÿä¼šåœ¨å°è£… ~render~ çš„æ—¶å€™
ä¼ é€’ç»™ ~baseCreateRender(option)~ ï¼Œæ‰€ä»¥ä¸Šé¢çš„ hostElement å’Œ hostInsert å°±æ˜¯æ¥
è‡ª ~runtime-test~ ï¼Œ[[/vue/vue-mind-map-runtime-core/#runtime-test][è¿™é‡Œé“¾æ¥]]å¯ä»¥è·³è½¬æŸ¥çœ‹è¯¥åŒ…é‡Œé¢å…·ä½“åŒ…å«å“ªäº›å‡½æ•°ï¼Œåˆæ˜¯åšä»€ä¹ˆçš„ï¼Œ
è¿™é‡Œå°±ä¸å±•å¼€ç»†è®²ï¼Œä¸»è¦çœ‹ä¸‹ç›¸å…³çš„ä¸¤ä¸ªå‡½æ•°å®ç°ã€‚

#+begin_src typescript
function createElement(tag: string): TestElement {
  const node: TestElement = {
    id: nodeId++,
    type: NodeTypes.ELEMENT,
    tag,
    children: [],
    props: {},
    parentNode: null,
    eventListeners: null
  }
  // ... log
  // avoid test nodes from being observed
  markRaw(node)
  return node
}

function insert(child: TestNode, parent: TestElement, ref?: TestNode | null) {
  let refIndex
  if (ref) {
    refIndex = parent.children.indexOf(ref)
    if (refIndex === -1) {
      console.error('ref: ', ref)
      console.error('parent: ', parent)
      throw new Error('ref is not a child of parent')
    }
  }
  //...log
  // remove the node first, but don't log it as a REMOVE op
  remove(child, false)
  // re-calculate the ref index because the child's removal may have affected it
  refIndex = ref ? parent.children.indexOf(ref) : -1
  if (refIndex === -1) {
    parent.children.push(child)
    child.parentNode = parent
  } else {
    parent.children.splice(refIndex, 0, child)
    child.parentNode = parent
  }
}
#+end_src

æ‰€ä»¥è¯´ï¼Œæˆªè‡³ç›®å‰è¿˜å¹¶æ²¡æœ‰æ¶‰åŠåˆ°å®é™…çš„ DOM æ“ä½œï¼Œè¿˜åªæ˜¯åœ¨ vnode ç»“æ„ä¸Šè¿›è¡Œæ’å…¥åˆ é™¤
æ“ä½œã€‚

è¿™é‡Œå¼€å§‹åº”è¯¥å¯ä»¥æµ‹è¯•äº†ï¼š
#+begin_src js
const { log, runtime_test } = require(process.env.BLOG_DIR_VUE + "/lib.js");
log("xx");
runtime_test().then(
  ({ h, render, nodeOps, serializeInner: inner }) => {
    let root = nodeOps.createElement("div");
    log('>>> root ast, è¿™é‡Œ children é‡Œé¢åº”è¯¥è¿˜æ²¡æœ‰èŠ‚ç‚¹')
    log.f(root, ['type', 'children'])
    log.f(h("div"), ["type"]);
    log('>>> begin render...')
    render(h("div"), root);
    log('>>> after seririlize inner')
    log(inner(root), ['type', 'children']);
  },
  (e) => console.log(e.message)
);
#+end_src

#+RESULTS:
#+begin_example
xx
undefinedfalse
>>> root ast, è¿™é‡Œ children é‡Œé¢åº”è¯¥è¿˜æ²¡æœ‰èŠ‚ç‚¹
{ type: 'element', children: [] }
{ type: 'div' }
>>> begin render...
render.......xxx
patching...
mount element...
mountElment else...
el = vnode.el = hostCreateElement =  {
  id: 1,
  type: 'element',
  tag: 'div',
  children: [],
  props: {},
  parentNode: null,
  eventListeners: null
}
<ref *1> {
  id: 0,
  type: 'element',
  tag: 'div',
  children: [
    {
      id: 1,
      type: 'element',
      tag: 'div',
      children: [],
      props: {},
      parentNode: [Circular *1],
      eventListeners: null
    }
  ],
  props: {},
  parentNode: null,
  eventListeners: null
}
>>> after seririlize inner
<div></div>
#+end_example

æ³¨æ„çœ‹ä¸Šé¢çš„ç»“æœï¼Œæœ€å ~h('div')~ ç”Ÿæˆçš„èŠ‚ç‚¹åˆ« insert è¿›äº† ~root.children~ ä¸­ï¼Œ
ç„¶åæ³¨æ„ ~insert~ æœ€åçš„å®ç°æ’å…¥æ›¿æ¢éƒ¨åˆ†: *å½“æ²¡æœ‰æ‰¾åˆ°æ—¶ refIndex = -1ï¼Œç›´æ¥æ‰§è¡Œ
å°¾éƒ¨æ’å…¥æ“ä½œ ~push(...)~, å¦‚æœæ‰¾åˆ°äº†å°±æ‰§è¡Œ ~splice(refIndex, 1, child)~*

æ‰€ä»¥è¿™é‡Œç›´æ¥æ‰§è¡Œçš„æ˜¯ç›´æ¥å°¾éƒ¨æ’å…¥æ“ä½œã€‚

æœ€åè¾“å‡ºçš„ ~<div></div>~ æ˜¯ç”±äºè°ƒç”¨äº† ~serializeInner(root)~ ç»“æœï¼Œä¹Ÿæ˜¯ç›¸å½“äº
DOM æ“ä½œäº†(~serializeInner~ -> ~seririlize>children~ -> ~serializeElement~ -> æœ€åæ ¹æ®
tag, props, children é€’å½’è§£æç”Ÿæˆå¯¹åº”çš„ DOM å…ƒç´ ç»“æ„)ã€‚

serializeElement å®ç°ï¼š
#+begin_src typescript
function serializeElement(
  node: TestElement,
  indent: number,
  depth: number
): string {
  const props = Object.keys(node.props)
    .map(key => {
      const value = node.props[key]
      return isOn(key) || value == null
        ? ``
        : value === ``
          ? key
          : `${key}=${JSON.stringify(value)}`
    })
    .filter(Boolean)
    .join(' ')
  const padding = indent ? ` `.repeat(indent).repeat(depth) : ``
  return (
    `${padding}<${node.tag}${props ? ` ${props}` : ``}>` +
    `${serializeInner(node, indent, depth)}` +
    `${padding}</${node.tag}>`
  )
}
#+end_src

æ‰€ä»¥åˆ°æ­¤åº”è¯¥æ˜¯å®Œæˆäº†æœ€æ™®é€šçš„ ~ELEMENT~ ç±»å‹å…ƒç´ ä»

ast -> compiler-dom >> compiler-core >> compiler-sfc
vnode -> runtime-core >> runtime-test(æµ‹è¯•ç”¨)
render -> runtime-core >> baseCreateRender >> render >>
mount/unmount/patch ->
ç”Ÿæˆ DOM å…ƒç´ ç»“æ„è¾ƒä¸ºå®Œæ•´çš„ä»£ç ã€‚
** with props

[[https://github.com/gcclll/stb-vue-next/commit/46fc2a0ab59c591c3c1a737e3b604e0aece6cf0b][feat(add): baseRenderer->element with props Â· gcclll/stb-vue-next@46fc2a0 Â·
GitHub]]

#+begin_src js
const { log, f, runtime_test } = require(process.env.BLOG_DIR_VUE + "/lib.js");
import(process.env.BLOG_DIR_VUE + "/runtime-test.global.js").then(
  ({ h, render, nodeOps, serializeInner: inner }) => {
    const root = nodeOps.createElement("div");
    render(h("div", { id: "foo", class: "bar" }), root);
    log(inner(root));
  },
  (err) => {
    console.log(err.message);
  }
);
#+end_src

#+RESULTS:
: undefinedfalse
: render.......
: patching...
: mount element...
: mountElment else...
: <div id="foo" class="bar"></div>

æœ€åè¾“å‡ºç»“æœï¼š ~<div id="foo" class="bar"></div>~

è¿˜è®°å¾— [[/vue/vue-mind-map-runtime-core/#h-function][runtime-core > h function]] ä¸€èŠ‚æˆ‘ä»¬è¯¦ç»†æè¿°äº† h å‡½æ•°çš„ç”¨æ³•ï¼Œè¿™é‡Œç®€å•å›é¡¾ä¸‹

| h ç¬¬äºŒä¸ªå‚æ•°        | æè¿°                                                      |
|---------------------+-----------------------------------------------------------|
| æ™®é€šå¯¹è±¡            | å½“åš props å¤„ç†                                           |
| æ•°ç»„ç±»å‹            | å½“åš children å¤„ç†                                        |
| æ˜¯ä¸ª VNode ç±»å‹å¯¹è±¡ | å¸¦æœ‰ __v_isVNode = true å±æ€§ï¼Œ [vnode] å½“åš children å¤„ç† |

æ‰€ä»¥ä¸Šé¢çš„ ~{ id: 'foo', class: 'bar' }~ è¢«å½“åšå±æ€§ä¼ é€’ç»™ ~createVNode(type,
props, children ...)~ å‡½æ•°

æ–°å¢ä»£ç ï¼š
#+begin_src typescript
// mountElement å¢åŠ  props å¤„ç†é€»è¾‘
const mountElement = (
    vnode: VNode,
    container: RendererElement,
    anchor: RendererNode | null,
    parentComponent: ComponentInternalInstance | null,
    parentSuspense: SuspenseBoundary | null,
    isSVG: boolean,
    optimized: boolean
  ) => {
    console.log('mount element...')
    // TODO
    let el: RendererElement
    let vnodeHook: VNodeHook | undefined | null
    const { type, shapeFlag, patchFlag, props } = vnode

    if (
      !__DEV__ &&
      vnode.el &&
      hostCloneNode !== undefined &&
      patchFlag === PatchFlags.HOISTED
    ) {
      // ...
    } else {


      // æ–°å¢ start
      if (props) {
        for (const key in props) {
          // vue ä¿ç•™å±æ€§ ref/key/onVnodeXxx ç”Ÿå‘½å‘¨æœŸ
          if (!isReservedProp(key)) {
            hostPatchProp(
              el,
              key,
              null,
              props[key],
              isSVG,
              vnode.children as VNode[],
              parentComponent,
              parentSuspense,
              unmountChildren
            )
          }
        }

        if ((vnodeHook = props.onVnodeBeforeMount)) {
          // æ‰§è¡Œ before mount hook
          invokeVNodeHook(vnodeHook, parentComponent, vnode)
        }
      } // end æ–°å¢
    }


    // ...

  }
#+end_src

render -> patch -> case ELEMENT -> processElement -> mountElement

åœ¨ mountElement ä¸­å¢åŠ  props å¤„ç†é€»è¾‘ï¼Œé’ˆå¯¹æ¯ä¸ª prop æ£€æµ‹æ˜¯ä¸æ˜¯ä¿ç•™åå­—

~key/ref/onVnodeXxx~ ç­‰ç”Ÿå‘½å‘¨æœŸåï¼Œéä¿ç•™åå­—æ‰éœ€è¦å¤„ç†ï¼Œè°ƒç”¨ hostPatchProp() å¤„
ç†ï¼Œåé¢åŠ ä¸Š ~BeforeMount~ ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°è°ƒç”¨ã€‚

#+begin_src typescript
// runtime-test/src/patchProp.ts
export function patchProp(
  el: TestElement,
  key: string,
  prevValue: any,
  nextValue: any
) {
  logNodeOp({
    type: NodeOpTypes.PATCH,
    targetNode: el,
    propKey: key,
    propPrevValue: prevValue,
    propNextValue: nextValue
  })
  el.props[key] = nextValue
  if (isOn(key)) {
    const event = key.slice(2).toLowerCase()
    ;(el.eventListeners || (el.eventListeners = {}))[event] = nextValue
  }
}
#+end_src

æ™®é€šå±æ€§ç›´æ¥æ›´æ–°åˆ° ~el.props~ ä¸­ï¼Œå¦‚æœæ˜¯ ~onXxx~ ç±»å‹çš„äº‹ä»¶ï¼Œå–å‡º ~xxx~ ä½œä¸º
~el.eventListeners~ çš„ key å°†äº‹ä»¶åå’Œå…¶å¤„ç†å¥æŸ„ä¿å­˜èµ·æ¥ã€‚

è¿™é‡Œçš„ ~el~ å®é™…ä¸Šæ˜¯ä¸ª ast ç»“æ„ç±»å‹çš„å¯¹è±¡ï¼Œä¿å­˜è¿™æ¯ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ä¿¡æ¯ã€‚
** with text children

*** çº¯æ–‡æœ¬å•èŠ‚ç‚¹ child

å°†çº¯æ–‡æœ¬åšä¸º child ï¼Œå°†ä¼šè¢« ~h~ å‡½æ•°è½¬æˆ ~[child]~ ä¼ é€’ç»™ ~createVNode(type,
props, children, ...)~ åšä¸ºå®ƒçš„children å‚æ•°å¤„ç†ã€‚

#+begin_src js
const { log, f, runtime_test } = require(process.env.BLOG_DIR_VUE + "/lib.js");
import(process.env.BLOG_DIR_VUE + "/runtime-test.global.js").then(
  ({ h, render, nodeOps, serializeInner: inner }) => {
    const _root = tag => nodeOps.createElement(tag || "div")
    log('>>> çº¯æ–‡æœ¬ä½œä¸º children')
    const r1 = _root()
    render(h('div', 'pure test as children'), r1);
    log(inner(r1));
  },
  (err) => {
    console.log(err.message);
  }
);
#+end_src

#+RESULTS:
: undefinedfalse
: >>> çº¯æ–‡æœ¬ä½œä¸º children
: render.......
: patching...
: mount element...
: mountElment else...
: <div>pure test as children</div>

ä¸Šé¢ç¤ºä¾‹æ˜¯å°†çº¯æ–‡æœ¬ä½œä¸º children å»æ¸²æŸ“è¿› root èŠ‚ç‚¹ï¼Œæ¶‰åŠä»£ç ä¿®æ”¹(~mountElement()~):

[[https://github.com/gcclll/stb-vue-next/commit/43b868e7f26f3e6ef1c0672d58bae842f1b8720f][feat(add): pure text as children to render Â· gcclll/stb-vue-next@43b868e Â·
GitHub]]


[[/img/tmp/diff-mountElement.png]]

*** æ•°ç»„ç±»å‹(å¤šä¸ª) children:

å½“ h(type, propsOrChildren) ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ•°ç»„æ—¶ä¼šè¢«å½“åš children ç»™ ~createVNode~
ã€‚

#+begin_src js
const { log, f, runtime_test } = require(process.env.BLOG_DIR_VUE + "/lib.js");
import(process.env.BLOG_DIR_VUE + "/runtime-test.global.js").then(
  ({ h, render, nodeOps, serializeInner: inner }) => {
    const root = nodeOps.createElement("div");
    render(h("div", ["foo", " ", "bar"]), root);
    log(inner(root));
  },
  (err) => {
    console.log(err.message);
  }
);
#+end_src

#+RESULTS:
#+begin_example
undefinedfalse
render.......
patching...
{ type: 'div', shapeFlag: 17 }
xxxx
case default...
process element...
mount element...
mountElment else...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
patching...
{ type: Symbol(Text), shapeFlag: 8 }
process text...
<div>foo bar</div>
#+end_example

ä»ä¸Šé¢çš„è¾“å‡ºå¯å¾—å‡º ~render(h('div'), ['foo', ' ', 'bar']), root)~ å¤§æ¦‚æ‰§è¡Œæµç¨‹:

1. root->div

   - *render*, æ ¹æ® vnode ä¸ºç©ºæ£€æµ‹å†³å®šæ˜¯ unmount è¿˜æ˜¯ patch
   - *patch*, æ ¹æ® new vnode çš„ type(å››ç§ç±»
     å‹ ~Text|Comment|Fragment|Static|default~ ) å†³
     å®šè°ƒç”¨ä»€ä¹ˆ ~processXxx~ è¿›è¡Œå¤„ç†
   - *case default* ç”±äºè¿™é‡Œæ˜¯æ ¹èŠ‚ç‚¹ï¼Œä¸”æ˜¯ 'div' æ™®é€šç±»å‹å…ƒç´ ï¼Œè¿›å…¥ processElement
   - *processElement*, æ ¹æ® old vnode åˆ¤æ–­æ˜¯ mount è¿˜æ˜¯ patch æ“ä½œ
   - æ—  old vnode, æ²¡æœ‰æ—§çš„vnodeè¡¨ç¤ºæ˜¯æ–°èŠ‚ç‚¹ï¼Œéœ€è¦æ‰§è¡Œ mount æ“ä½œ
   - *mountElement*, éœ€è¦æ£€æµ‹ vnode.el æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯é™æ€æå‡çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯é™æ€èŠ‚ç‚¹
     å±äºå¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œéœ€è¦ cloneVNode å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„
   - *else: hostCreateElement* åˆ›å»ºæ–°çš„å…ƒç´ ï¼Œç„¶åé€šè¿‡ ~shapeFlag~ åˆ¤æ–­ children
     æ˜¯ä»€ä¹ˆç±»å‹è¿›å…¥ä¸åŒåˆ†æ”¯è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œæ˜¯æ•°ç»„(~ShapeFlags.ARRAY_CHILDREN~) æ‰€
     ä»¥ä¼šè°ƒç”¨ ~mountChildren(vnode.children, el, ...)~ å¼€å§‹ mount children.
   - *mountChldren* , ä¼šå¯¹ children è¿›è¡Œéå†ï¼Œå¦‚æœ child.el å­˜åœ¨è¯´æ˜æ˜¯å¯å¤ç”¨èŠ‚ç‚¹
     (é™æ€æå‡çš„)ï¼Œåˆ™å°† child clone å‡ºæ¥ä½¿ç”¨ï¼Œå¦åˆ™è¿›è¡Œ normailize å¤„ç†(å…¶å®ä¹Ÿå°±
     æ˜¯æ ¹æ® child æ•°æ®ç±»å‹ä¸åŒæ‰§è¡Œ createVNode è¿”å›æ–°çš„ vnode ç»™ child)ï¼Œæœ€åå°† child ä¼ å…¥ patch å›åˆ°ç¬¬
     äºŒæ­¥è¿›è¡Œé€’å½’ mount children

2. root->div->'foo'

   åœ¨ *1* æœ€åè¿›å…¥é€’å½’ä¹‹åï¼Œä¼šè¿›å…¥åˆ° patch æ£€æµ‹åˆ° type æ˜¯ Text ç±»å‹ï¼Œå»è°ƒç”¨
   ~processText()~ å¤„ç† ~'foo'~ å®Œæˆä¹‹åï¼Œå†å›æº¯é€’å½’å¤„ç†ä¸‹ä¸€ä¸ªå…ƒç´  ~' '~ ç›´åˆ°ç»“æŸã€‚

3. root->div->' ' åŒ *2*

4. root->idv->'bar' åŒ *2*
