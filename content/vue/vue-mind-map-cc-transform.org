#+TITLE: Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform + codegen
#+DATE: <2020-11-30 10:07:11>
#+TAGS[]: vue, vue3, compiler-core, parser, compiler, transform
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

@@html:<kbd>@@
*[[https://github.com/gcclll/stb-vue-next][stb-vue-next]] å®Œå…¨æ‹·è´äº [[https://github.com/vuejs/vue-next][vue-next]] ï¼Œä¸»è¦ç›®çš„å­¦ä¹ åŠå°è¯•åº”ç”¨äºæœºé¡¶ç›’ç¯å¢ƒã€‚*
@@html:</kbd>@@

@@html:<kbd>@@ *æœ¬æ–‡ä¾æ® commit è¿›ç¨‹è¿›è¡Œè®°å½•ï¼Œåªè¦è·Ÿç€ä¸‹é¢çš„è¿›ç¨‹èµ°ï¼Œä½ å°†èƒ½å®Œæ•´å®
ç° vue ast transform å’Œ codegen generate æœ€åç”Ÿæˆ render å‡½æ•° ğŸ’ƒğŸ¼ğŸ’ƒğŸ¼ğŸ’ƒğŸ¼* @@html:</kbd>@@

#+begin_quote
å£°æ˜ï¼šè¯¥ç¯‡ä¸º ts æºç (/commit/)ç‰ˆæœ¬ï¼Œä¹‹å‰åšè¿‡ä¸€éå®Œæ•´çš„ js ç‰ˆæœ¬ï¼Œæ›´è¯¦ç»†ï¼Œä¹Ÿå¯å‚è€ƒ

[[https://www.cheng92.com/vue/vue3-source-code-compiler-core-compile_ts/][Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 3: compile.ts - è‹¥å¶çŸ¥ç§‹]]

ç”±äº transform é˜¶æ®µç›´æ¥æµ‹è¯•ä¸å¤ªå¥½ç›´è§‚çš„çœ‹å‡ºç»“æœï¼Œå› æ­¤è¿™é‡Œä¼šç»“åˆ codegen æ¥ä¸€èµ·å®
ç°ï¼Œå³è¯¥æ–‡åŒ…å« compiler-core ä¸‰å¤§é˜¶æ®µçš„æœ€åä¸¤ä¸ªé˜¶æ®µ(transform + generate)
#+end_quote

#+begin_export html
<script src="/js/vue/compiler-core.global.js"></script>
#+end_export


* è„‘å›¾

# [[/img/vue3/compiler-core/compiler-core-parser.svg]]

* e03a03c init transform module

[[https://github.com/gcclll/stb-vue-next/commit/e03a03c5d775ff9315cc027d88b0669a775cf590][feat(init): transform section Â· gcclll/stb-vue-next@e03a03c]]

åˆå§‹åŒ–å‡½æ•°ã€‚

#+begin_src typescript
export function createTransformContext(
  root: RootNode,
  {
    prefixIdentifiers = false,
    hoistStatic = false,
    cacheHandlers = false,
    nodeTransforms = [],
    directiveTransforms = {},
    transformHoist = null,
    isBuiltInComponent = NOOP,
    isCustomElement = NOOP,
    expressionPlugins = [],
    scopeId = null,
    ssr = false,
    ssrCssVars = ``,
    bindingMetadata = {},
    onError = defaultOnError
  }: TransformOptions
): TransformContext {
  const context: TransformContext = {

    // ...

    // methods
    helper(name) {
      context.helpers.add(name)
      return name
    },
    helperString(name) {
      return ``
    },
    replaceNode(node) {},
    removeNode(node) {},
    onNodeRemoved: () => {},
    addIdentifiers(exp) {
      // TODO
    },
    removeIdentifiers(exp) {
      // TODO
    },
    hoist(exp) {
      // TODO
      return {} as any
    },
    cache(exp, isVNode = false) {
      // TODO
      return {} as any
    }
  }

  return context
}

export function transform(root: RootNode, options: TransformOptions) {
  // TODO
}

// TODO
// createRootCodegen

export function traverseChildren(
  parent: ParentNode,
  context: TransformContext
) {
  // TODO
}

export function traverseNode(
  node: RootNode | TemplateChildNode,
  context: TransformContext
) {}

export function createStructuralDirectiveTransform(
  name: string | RegExp,
  fn: StructuralDirectiveTransform
): NodeTransform {
  return {} as any
}
#+end_src

* fc6f1f1 add transform function

[[https://github.com/gcclll/stb-vue-next/commit/fc6f1f112ae0e98b7e2e9a432d3dca1d6420307a][feat: transform function Â· gcclll/stb-vue-next@fc6f1f1]]

1. create transform context
2. traverse nodes, é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ„é€ å™¨ codegenNode
3. hoist static, é™æ€èŠ‚ç‚¹æå‡ï¼Œå¤ç”¨
4. ssr render, ä¸éœ€è¦åˆ›å»ºæ ¹èŠ‚ç‚¹ codegenNode
5. å¤åˆ¶ context å±æ€§åˆ° -> root


[[http://qiniu.ii6g.com/img/20201130231832.png]]

transform ä½œç”¨å°±æ˜¯é€šè¿‡ ~traverseNode()~ é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè§£æï¼Œæ„é€ å¯¹åº”çš„èŠ‚ç‚¹
codegenNode ã€‚
* b0d72da add compile.ts>compile()

[[https://github.com/gcclll/stb-vue-next/commit/b0d72dac2738fd270b0ea7fe0bb33f47597a233b][feat(add): compile function Â· gcclll/stb-vue-next@b0d72da]]

å¯¹å¤–çš„ compile å‡½æ•°ï¼Œæ‰§è¡Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

- ast(~baseParse()~) -> è§£æå‡º ast ç»“æ„
- transform(~transform()~) -> è§£æ ast å¾—åˆ° codegenNode
- codegen(~generate()~) -> å°† codegenNode è§£ææˆ Render å‡½æ•°


è¿™æ˜¯åé¢æµ‹è¯•çš„åŸºç¡€ï¼Œæ‰€ä»¥å¾—æå‰å®ç°äº†ã€‚

#+begin_src typescript

export function baseCompile(
  template: string | RootNode,
  options: CompilerOptions = {}
): CodegenResult {
  // const onError = options.onError || defaultOnError
  const isModuleMode = options.mode === 'module'

  const prefixIdentifiers =
    !__BROWSER__ && (options.prefixIdentifiers === true || isModuleMode)

  // TODO errors
  const ast = isString(template) ? baseParse(template, options) : template
  const [nodeTransforms, directiveTransforms] = getBaseTransformPreset(
    prefixIdentifiers
  )

  transform(
    ast,
    extend({}, options, {
      prefixIdentifiers,
      nodeTransforms: [
        ...nodeTransforms,
        ...(options.nodeTransforms || []) // user transforms
      ],
      directiveTransforms: extend(
        {},
        directiveTransforms,
        options.directiveTransforms || {}
      )
    })
  )

  return generate(
    ast,
    extend({}, options, {
      prefixIdentifiers
    })
  )
}
#+end_src

* 35248ce add exports maybe needs

[[https://github.com/gcclll/stb-vue-next/commit/35248ceece1aa8650b65f7f7ce13612660a65397][feat(add): compiler-core exports Â· gcclll/stb-vue-next@35248ce]]

å¢åŠ  compiler-core æ¨¡å—çš„å¯¼å‡º(~export~)å†…å®¹
* 05a223b add transform pure text

[[https://github.com/gcclll/stb-vue-next/commit/05a223b7b1eb2ab877aec3b11feace484a7dde82][feat(add): transform pure text Â· gcclll/stb-vue-next@05a223b]]

#+begin_src typescript
export function traverseNode(
  node: RootNode | TemplateChildNode,
  context: TransformContext
) {
  // ä¿å­˜å½“å‰è¢«å¤„ç†çš„ èŠ‚ç‚¹
  context.currentNode = node
  // åº”ç”¨ transform æ’ä»¶
  const { nodeTransforms } = context
  // é’ˆå¯¹æ¯ä¸ªèŠ‚ç‚¹ä¼šæ”¶é›†åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª transformXxx å‡½æ•°ï¼Œç”¨æ¥è§£æå®ƒçš„ ast
  // å¾—åˆ° codegenNode ï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨å½“å‰çš„èŠ‚ç‚¹æ ‘è¢«é€’å½’éå†å®Œä¹‹åè°ƒç”¨
  const exitFns = []
  for (let i = 0; i < nodeTransforms.length; i++) {
    const onExit = nodeTransforms[i](node, context)
    if (onExit) {
      if (isArray(onExit)) {
        exitFns.push(...onExit)
      } else {
        exitFns.push(onExit)
      }
    }

    if (!context.currentNode) {
      // èŠ‚ç‚¹å¯èƒ½è¢«åˆ é™¤äº†ï¼Œæ¯”å¦‚ï¼š v-else-if, v-else ä¼šåˆå¹¶åˆ° v-if çš„ branches[] ä¸­
      return
    } else {
      // èŠ‚ç‚¹å¯èƒ½ä¼šæ›¿æ¢äº†ï¼Œéœ€è¦æ›´æ–°
      node = context.currentNode
    }
  }

  switch (
    node.type
    // TODO
  ) {
  }

  context.currentNode = node
  let i = exitFns.length
  while (i--) {
    exitFns[i]()
  }
}
#+end_src

transform é˜¶æ®µä»£ç æ¯•ç«Ÿçš„ä¸‰ä¸ªé˜¶æ®µ

1. æ”¶é›† transformXxx å‡½æ•°åˆ° exitFns
2. æ ¹æ® astèŠ‚ç‚¹ç±»å‹é€’å½’éå†å­å­™èŠ‚ç‚¹
3. æŒ‰ç…§æ”¶é›†æ—¶ç›¸åçš„é¡ºåºæ‰§è¡Œ exitFnsï¼Œè§£æå‡º codegenNode


ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ ~generate()~ ä¸­ç›´æ¥è¿”å› ast :
[[https://github.com/gcclll/stb-vue-next/commit/999d8d6b611443f8fd04282786d4a67f018d6319][test: generate return ast for test Â· gcclll/stb-vue-next@999d8d6]]
#+begin_src js
const {
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`)
console.log(res.children[0])
#+end_src

+RESULTS:
#+begin_example
{
  type: 2,
  content: 'pure text',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'pure text'
  }
}
#+end_example

ç»“æœæ˜¾ç¤ºå¹¶æ²¡æœ‰ codegenNode å› ä¸ºåœ¨transformText ä¸­æ»¡è¶³æ¡ä»¶

~children.length === 1 && node.type === NodeTypes.ROOT~ è€Œç›´æ¥é€€å‡ºäº†ã€‚

è‡³äº ~root.codegenNode = undefined~ éœ€è¦å®ç° ~createRootCodegen()~

*** 61ce406 add createRootCodegen() to create root.codegenNode

[[https://github.com/gcclll/stb-vue-next/commit/61ce4066c9b49e11399da0b499220f426da444a0][feat: createRootCodegen() for pure text Â· gcclll/stb-vue-next@61ce406]]

åªå¢åŠ äº†é’ˆå¯¹é ELEMENT ç±»å‹æˆ–è€…å­©å­èŠ‚ç‚¹æ²¡æœ‰ codegenNode çš„æƒ…å†µå®ç°(å½“å‰ commit
æœ€ç®€åŒ–)ã€‚

å½“ root.children åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è‡ªå·±çš„ codegenNode æ—¶å€™ï¼š
#+begin_src typescript
function createRootCodegen(root: RootNode, context: TransformContext) {
  // const { helper } = context
  const { children } = root
  if (children.length === 1) {
    // åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œç›´æ¥å–è¯¥å­©å­èŠ‚ç‚¹ çš„ codegenNode
    const child = children[0]
    if (isSingleElementRoot(root, child) && child.codegenNode) {
      // å½“ root èŠ‚ç‚¹ä¸‹åªæœ‰ä¸€ä¸ª element å…ƒç´ çš„å­©å­èŠ‚ç‚¹æ—¶ï¼Œä¸è¿›è¡Œæå‡
    } else {
      // - single <slot/>, IfNode, ForNode: already blocks.
      // - single text node: always patched.
      // root codegen falls through via genNode()

      root.codegenNode = child
    }
  } else if (children.length > 1) {
    // TODO
  } else {
    // no children = noop, codegen will return null.
  }
}
#+end_src

æµ‹è¯•
#+begin_src js
const {
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`)
console.log(res)
#+end_src

#+RESULTS:
#+begin_example
{
  type: 0,
  children: [ { type: 2, content: 'pure text', loc: [Object] } ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 2,
    content: 'pure text',
    loc: { start: [Object], end: [Object], source: 'pure text' }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'pure text'
  }
}
#+end_example

æ³¨æ„ codegenNode å…¶å®å°±æ˜¯ ~root.children[0]~ èŠ‚ç‚¹æœ¬èº«ã€‚
*** b9f3cb7 add transform text

[[https://github.com/gcclll/stb-vue-next/commit/b9f3cb762e36e7f7090987db9cba77948845cdaf][feat: transformText function Â· gcclll/stb-vue-next@b9f3cb7]]

[[http://qiniu.ii6g.com/img/20201130150054.png]]

1. å¿…é¡»æ˜¯æ–‡æœ¬èŠ‚ç‚¹æˆ–è€…ç±»å‹æ˜¯ç»„åˆè¡¨è¾¾å¼ç±»å‹(~COMPOUND_EXPRESSION~)
2. patch flag å¤„ç†
3. æ„é€  TEXT_CALL ç±»å‹èŠ‚ç‚¹
4. codegenNode -> createCallExpression
*** f6d5271 add generate text codegen

codegen é˜¶æ®µç›®çš„æ˜¯å°† codegenNode è§£ææˆ Render å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚

1. /f6d5271/ add ~createCodegenContext()~

   [[https://github.com/gcclll/stb-vue-next/commit/f6d52713ae8154d438c2ed94641525fa3c05edef][feat(add): codegen context creator Â· gcclll/stb-vue-next@f6d5271]]

   ä¸Šä¸‹æ–‡å¯¹è±¡åˆ›å»ºå‡½æ•°ï¼Œé‡ç‚¹æ–¹æ³•æœ‰ä¸¤ä¸ª(~push(code, node)~ å’Œ ~helper(key)~)ã€‚

   FIX1: lint errors, [[https://github.com/gcclll/stb-vue-next/commit/0ac8c2f4b6b5022caa0f83a7f850226c30a99d33][fix: f6d5271 lint errors Â· gcclll/stb-vue-next@0ac8c2f]]

2. /2ef2699/ å¢åŠ  text codegen generator å®ç°

   [[https://github.com/gcclll/stb-vue-next/commit/2ef2699b95457be4456b736b70467b98bf240ddd][feat: generate text codegen Â· gcclll/stb-vue-next@2ef2699]]

   è¯¥éƒ¨åˆ†æ¶‰åŠåˆ°ä¸€ä¸ªè¾ƒä¸ºå®Œæ•´çš„ codegen generator æµç¨‹ï¼Œæ‰€ä»¥å¢åŠ å†…å®¹è¾ƒå¤šï¼Œå› æ­¤è¿™é‡Œ
   ä¸ç›´æ¥è´´ä»£ç äº†ï¼Œè¯·ç‚¹å‡»ä¸Šé¢ commit é“¾æ¥æŸ¥çœ‹å®é™…å¢åŠ çš„æºç ã€‚

   å¤„ç†æµç¨‹ï¼š

   - preamble å¤„ç†ï¼Œå¦‚æœæ˜¯ Node ç¯å¢ƒéœ€è¦é€šè¿‡ ~import { ...} from 'vue'~ è¯­æ³•ï¼Œå¦‚
     æœæ˜¯æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ ~const { ... } = Vue~ è§£æ„è¯­æ³•ã€‚

   - æ˜¯å¦ä½¿ç”¨ ~with() {}~ ä½œç”¨åŸŸè¯­æ³•ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨çš„

   - ~return ...~ è¿”å›å®é™… render å‡½æ•°è¿”å›ç»“æœï¼Œè¿™é‡Œå°†è¿”å›æœ€åè¢«æ¸²æŸ“çš„ DOM ç»“æ„ã€‚

   - ~genNode()~ é€’å½’å¤„ç† ast ç”Ÿæˆ render å‡½æ•°çš„å¯¹åº”éƒ¨åˆ†ä»£ç 

3. /6b901f9/ å¢åŠ  node ç¯å¢ƒæˆ– module ç¯å¢ƒå¤„ç†(~genModulePreamble~)

   [[https://github.com/gcclll/stb-vue-next/commit/6b901f9f3d8af3dc415d31a6c5027d8e262fa74f][feat: module preamble Â· gcclll/stb-vue-next@6b901f9]]
   modue preamble : ~export { ... } from 'vue'~
   function preamble: ~const { ... } = Vue~


é‡ç‚¹å¢åŠ çš„ genXxx å‡½æ•° ~genText(node, context)~ ä¸“é—¨ç”¨æ¥å¤„ç†æ–‡æœ¬èŠ‚ç‚¹çš„ã€‚

#+begin_src typescript
function genText(
  node: TextNode | SimpleExpressionNode,
  context: CodegenContext
) {
  context.push(JSON.stringify(node.content), node)
}
#+end_src
*** æµ‹è¯•

æµ‹è¯•å°†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œ
**** function preamble å½¢å¼(ä½œä¸ºå…¨å±€ ~Vue~ å¯¹è±¡å¼•å…¥)

#+begin_src js
const {
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`)
console.log(res.code)
#+end_src

#+RESULTS:
:
: return function render(_ctx, _cache) {
:   with (_ctx) {
:     return "pure text"
:   }
: }
: undefined

[[https://github.com/gcclll/stb-vue-next/commit/6b3bd2e4c20dc7a325ff7c0575c127595da91b42][fix: less the last } paren Â· gcclll/stb-vue-next@6b3bd2e]]

**** module preamble å½¢å¼(*es6* æ¨¡å—åŒ–å¯¼å‡ºå¯¼å…¥)

#+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`, { mode: 'module' })
console.log(res.code)
#+end_src

#+RESULTS:
:
: return function render(_ctx, _cache) {
:   return "pure text"
: }
: undefined

è¿™é‡Œå¥½åƒçœ‹ä¸å‡ºå•¥åŒºåˆ«ï¼Œåé¢å†è¯´å§ã€‚
