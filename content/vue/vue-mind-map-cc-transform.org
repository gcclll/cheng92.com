#+TITLE: Vue3 æºç å¤´è„‘é£æš´ä¹‹ 3 â˜compiler-core - transform + codegen
#+DATE: <2020-11-30 10:07:11>
#+TAGS[]: vue, vue3, compiler-core, parser, compiler, transform
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

@@html:<kbd>@@
*[[https://github.com/gcclll/stb-vue-next][stb-vue-next]] å®Œå…¨æ‹·è´äº [[https://github.com/vuejs/vue-next][vue-next]] ï¼Œä¸»è¦ç›®çš„å­¦ä¹ åŠå°è¯•åº”ç”¨äºæœºé¡¶ç›’ç¯å¢ƒã€‚*
@@html:</kbd>@@

@@html:<kbd>@@ *æœ¬æ–‡ä¾æ® commit è¿›ç¨‹è¿›è¡Œè®°å½•ï¼Œåªè¦è·Ÿç€ä¸‹é¢çš„è¿›ç¨‹èµ°ï¼Œä½ å°†èƒ½å®Œæ•´å®
ç° vue ast transform å’Œ codegen generate æœ€åç”Ÿæˆ render å‡½æ•° ğŸ’ƒğŸ¼ğŸ’ƒğŸ¼ğŸ’ƒğŸ¼* @@html:</kbd>@@

#+begin_quote
å£°æ˜ï¼šè¯¥ç¯‡ä¸º ts æºç (/commit/)ç‰ˆæœ¬ï¼Œä¹‹å‰åšè¿‡ä¸€éå®Œæ•´çš„ js ç‰ˆæœ¬ï¼Œæ›´è¯¦ç»†ï¼Œä¹Ÿå¯å‚è€ƒ

[[https://www.cheng92.com/vue/vue3-source-code-compiler-core-compile_ts/][Vue3.0 æºç ç³»åˆ—ï¼ˆäºŒï¼‰ç¼–è¯‘å™¨æ ¸å¿ƒ - Compiler core 3: compile.ts - è‹¥å¶çŸ¥ç§‹]]

ç”±äº transform é˜¶æ®µç›´æ¥æµ‹è¯•ä¸å¤ªå¥½ç›´è§‚çš„çœ‹å‡ºç»“æœï¼Œå› æ­¤è¿™é‡Œä¼šç»“åˆ codegen æ¥ä¸€èµ·å®
ç°ï¼Œå³è¯¥æ–‡åŒ…å« compiler-core ä¸‰å¤§é˜¶æ®µçš„æœ€åä¸¤ä¸ªé˜¶æ®µ(transform + generate)
#+end_quote

#+begin_export html
<script src="/js/vue/compiler-core.global.js"></script>
#+end_export


* å…³é”®çŸ¥è¯†ç‚¹

1. [[#element-transform][ğŸ”—]] root.children.length = 1 ä¸”ç±»å‹æ˜¯ ELEMENTçš„æ—¶å€™å°† ~CREATE_VNODE~ æ”¹æˆ
   ~CREATE_BLOCK~   
2. [[#v-bind][ğŸ”—]] åŠ¨æ€å±æ€§ä¸ºè¡¨è¾¾å¼æ—¶ï¼Œä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼

   å¦‚ï¼š ~<div :[first + second]="third" ...~ æ˜¯éæ³•çš„ã€‚

   å› ä¸º ~parseAttribute()~ ä¸­çš„æ­£åˆ™æ˜¯ä¸æ”¯æŒä¸­é—´æœ‰ç©ºæ ¼çš„ï¼š

   å–å‚æ•°åçš„æ­£åˆ™ï¼š ~/^[^\t\r\n\f />][^\t\r\n\f />=]*/~
3. [[#v-bind][ğŸ”—]] v-bind æŒ‡ä»¤çš„å‡ ç§ç”¨æ³• ->
* è„‘å›¾

# [[/img/vue3/compiler-core/compiler-core-parser.svg]]

* e03a03c init transform module

[[https://github.com/gcclll/stb-vue-next/commit/e03a03c5d775ff9315cc027d88b0669a775cf590][feat(init): transform section Â· gcclll/stb-vue-next@e03a03c]]

åˆå§‹åŒ–å‡½æ•°ã€‚

#+begin_src typescript
export function createTransformContext(
  root: RootNode,
  {
    prefixIdentifiers = false,
    hoistStatic = false,
    cacheHandlers = false,
    nodeTransforms = [],
    directiveTransforms = {},
    transformHoist = null,
    isBuiltInComponent = NOOP,
    isCustomElement = NOOP,
    expressionPlugins = [],
    scopeId = null,
    ssr = false,
    ssrCssVars = ``,
    bindingMetadata = {},
    onError = defaultOnError
  }: TransformOptions
): TransformContext {
  const context: TransformContext = {

    // ...

    // methods
    helper(name) {
      context.helpers.add(name)
      return name
    },
    helperString(name) {
      return ``
    },
    replaceNode(node) {},
    removeNode(node) {},
    onNodeRemoved: () => {},
    addIdentifiers(exp) {
      // TODO
    },
    removeIdentifiers(exp) {
      // TODO
    },
    hoist(exp) {
      // TODO
      return {} as any
    },
    cache(exp, isVNode = false) {
      // TODO
      return {} as any
    }
  }

  return context
}

export function transform(root: RootNode, options: TransformOptions) {
  // TODO
}

// TODO
// createRootCodegen

export function traverseChildren(
  parent: ParentNode,
  context: TransformContext
) {
  // TODO
}

export function traverseNode(
  node: RootNode | TemplateChildNode,
  context: TransformContext
) {}

export function createStructuralDirectiveTransform(
  name: string | RegExp,
  fn: StructuralDirectiveTransform
): NodeTransform {
  return {} as any
}
#+end_src

* fc6f1f1 add transform function

[[https://github.com/gcclll/stb-vue-next/commit/fc6f1f112ae0e98b7e2e9a432d3dca1d6420307a][feat: transform function Â· gcclll/stb-vue-next@fc6f1f1]]

1. create transform context
2. traverse nodes, é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ„é€ å™¨ codegenNode
3. hoist static, é™æ€èŠ‚ç‚¹æå‡ï¼Œå¤ç”¨
4. ssr render, ä¸éœ€è¦åˆ›å»ºæ ¹èŠ‚ç‚¹ codegenNode
5. å¤åˆ¶ context å±æ€§åˆ° -> root


[[http://qiniu.ii6g.com/img/20201130231832.png]]

transform ä½œç”¨å°±æ˜¯é€šè¿‡ ~traverseNode()~ é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè§£æï¼Œæ„é€ å¯¹åº”çš„èŠ‚ç‚¹
codegenNode ã€‚
* b0d72da add compile.ts>compile()

[[https://github.com/gcclll/stb-vue-next/commit/b0d72dac2738fd270b0ea7fe0bb33f47597a233b][feat(add): compile function Â· gcclll/stb-vue-next@b0d72da]]

å¯¹å¤–çš„ compile å‡½æ•°ï¼Œæ‰§è¡Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

- ast(~baseParse()~) -> è§£æå‡º ast ç»“æ„
- transform(~transform()~) -> è§£æ ast å¾—åˆ° codegenNode
- codegen(~generate()~) -> å°† codegenNode è§£ææˆ Render å‡½æ•°


è¿™æ˜¯åé¢æµ‹è¯•çš„åŸºç¡€ï¼Œæ‰€ä»¥å¾—æå‰å®ç°äº†ã€‚

#+begin_src typescript

export function baseCompile(
  template: string | RootNode,
  options: CompilerOptions = {}
): CodegenResult {
  // const onError = options.onError || defaultOnError
  const isModuleMode = options.mode === 'module'

  const prefixIdentifiers =
    !__BROWSER__ && (options.prefixIdentifiers === true || isModuleMode)

  // TODO errors
  const ast = isString(template) ? baseParse(template, options) : template
  const [nodeTransforms, directiveTransforms] = getBaseTransformPreset(
    prefixIdentifiers
  )

  transform(
    ast,
    extend({}, options, {
      prefixIdentifiers,
      nodeTransforms: [
        ...nodeTransforms,
        ...(options.nodeTransforms || []) // user transforms
      ],
      directiveTransforms: extend(
        {},
        directiveTransforms,
        options.directiveTransforms || {}
      )
    })
  )

  return generate(
    ast,
    extend({}, options, {
      prefixIdentifiers
    })
  )
}
#+end_src

* 35248ce add exports maybe needs

[[https://github.com/gcclll/stb-vue-next/commit/35248ceece1aa8650b65f7f7ce13612660a65397][feat(add): compiler-core exports Â· gcclll/stb-vue-next@35248ce]]

å¢åŠ  compiler-core æ¨¡å—çš„å¯¼å‡º(~export~)å†…å®¹
* 05a223b add transform pure text
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pure-text
:END: 

[[https://github.com/gcclll/stb-vue-next/commit/05a223b7b1eb2ab877aec3b11feace484a7dde82][feat(add): transform pure text Â· gcclll/stb-vue-next@05a223b]]

#+begin_src typescript
export function traverseNode(
  node: RootNode | TemplateChildNode,
  context: TransformContext
) {
  // ä¿å­˜å½“å‰è¢«å¤„ç†çš„ èŠ‚ç‚¹
  context.currentNode = node
  // åº”ç”¨ transform æ’ä»¶
  const { nodeTransforms } = context
  // é’ˆå¯¹æ¯ä¸ªèŠ‚ç‚¹ä¼šæ”¶é›†åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª transformXxx å‡½æ•°ï¼Œç”¨æ¥è§£æå®ƒçš„ ast
  // å¾—åˆ° codegenNode ï¼Œè¿™äº›å‡½æ•°ä¼šåœ¨å½“å‰çš„èŠ‚ç‚¹æ ‘è¢«é€’å½’éå†å®Œä¹‹åè°ƒç”¨
  const exitFns = []
  for (let i = 0; i < nodeTransforms.length; i++) {
    const onExit = nodeTransforms[i](node, context)
    if (onExit) {
      if (isArray(onExit)) {
        exitFns.push(...onExit)
      } else {
        exitFns.push(onExit)
      }
    }

    if (!context.currentNode) {
      // èŠ‚ç‚¹å¯èƒ½è¢«åˆ é™¤äº†ï¼Œæ¯”å¦‚ï¼š v-else-if, v-else ä¼šåˆå¹¶åˆ° v-if çš„ branches[] ä¸­
      return
    } else {
      // èŠ‚ç‚¹å¯èƒ½ä¼šæ›¿æ¢äº†ï¼Œéœ€è¦æ›´æ–°
      node = context.currentNode
    }
  }

  switch (
    node.type
    // TODO
  ) {
  }

  context.currentNode = node
  let i = exitFns.length
  while (i--) {
    exitFns[i]()
  }
}
#+end_src

transform é˜¶æ®µä»£ç æ¯•ç«Ÿçš„ä¸‰ä¸ªé˜¶æ®µ

1. æ”¶é›† transformXxx å‡½æ•°åˆ° exitFns
2. æ ¹æ® astèŠ‚ç‚¹ç±»å‹é€’å½’éå†å­å­™èŠ‚ç‚¹
3. æŒ‰ç…§æ”¶é›†æ—¶ç›¸åçš„é¡ºåºæ‰§è¡Œ exitFnsï¼Œè§£æå‡º codegenNode


ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ ~generate()~ ä¸­ç›´æ¥è¿”å› ast :
[[https://github.com/gcclll/stb-vue-next/commit/999d8d6b611443f8fd04282786d4a67f018d6319][test: generate return ast for test Â· gcclll/stb-vue-next@999d8d6]]
#+begin_src js
const {
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`)
console.log(res.children[0])
#+end_src

+RESULTS:
#+begin_example
{
  type: 2,
  content: 'pure text',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'pure text'
  }
}
#+end_example

ç»“æœæ˜¾ç¤ºå¹¶æ²¡æœ‰ codegenNode å› ä¸ºåœ¨transformText ä¸­æ»¡è¶³æ¡ä»¶

~children.length === 1 && node.type === NodeTypes.ROOT~ è€Œç›´æ¥é€€å‡ºäº†ã€‚

è‡³äº ~root.codegenNode = undefined~ éœ€è¦å®ç° ~createRootCodegen()~

*** 61ce406 add createRootCodegen() to create root.codegenNode

[[https://github.com/gcclll/stb-vue-next/commit/61ce4066c9b49e11399da0b499220f426da444a0][feat: createRootCodegen() for pure text Â· gcclll/stb-vue-next@61ce406]]

åªå¢åŠ äº†é’ˆå¯¹é ELEMENT ç±»å‹æˆ–è€…å­©å­èŠ‚ç‚¹æ²¡æœ‰ codegenNode çš„æƒ…å†µå®ç°(å½“å‰ commit
æœ€ç®€åŒ–)ã€‚

å½“ root.children åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ä¸”è¯¥èŠ‚ç‚¹æ²¡æœ‰è‡ªå·±çš„ codegenNode æ—¶å€™ï¼š
#+begin_src typescript
function createRootCodegen(root: RootNode, context: TransformContext) {
  // const { helper } = context
  const { children } = root
  if (children.length === 1) {
    // åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œç›´æ¥å–è¯¥å­©å­èŠ‚ç‚¹ çš„ codegenNode
    const child = children[0]
    if (isSingleElementRoot(root, child) && child.codegenNode) {
      // å½“ root èŠ‚ç‚¹ä¸‹åªæœ‰ä¸€ä¸ª element å…ƒç´ çš„å­©å­èŠ‚ç‚¹æ—¶ï¼Œä¸è¿›è¡Œæå‡
    } else {
      // - single <slot/>, IfNode, ForNode: already blocks.
      // - single text node: always patched.
      // root codegen falls through via genNode()

      root.codegenNode = child
    }
  } else if (children.length > 1) {
    // TODO
  } else {
    // no children = noop, codegen will return null.
  }
}
#+end_src

æµ‹è¯•
#+begin_src js
const {
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`)
console.log(res)
#+end_src

#+RESULTS:
#+begin_example
{
  type: 0,
  children: [ { type: 2, content: 'pure text', loc: [Object] } ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 2,
    content: 'pure text',
    loc: { start: [Object], end: [Object], source: 'pure text' }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'pure text'
  }
}
#+end_example

æ³¨æ„ codegenNode å…¶å®å°±æ˜¯ ~root.children[0]~ èŠ‚ç‚¹æœ¬èº«ã€‚
*** b9f3cb7 add transform text

[[https://github.com/gcclll/stb-vue-next/commit/b9f3cb762e36e7f7090987db9cba77948845cdaf][feat: transformText function Â· gcclll/stb-vue-next@b9f3cb7]]

[[http://qiniu.ii6g.com/img/20201130150054.png]]

1. å¿…é¡»æ˜¯æ–‡æœ¬èŠ‚ç‚¹æˆ–è€…ç±»å‹æ˜¯ç»„åˆè¡¨è¾¾å¼ç±»å‹(~COMPOUND_EXPRESSION~)
2. patch flag å¤„ç†
3. æ„é€  TEXT_CALL ç±»å‹èŠ‚ç‚¹
4. codegenNode -> createCallExpression
*** f6d5271 add generate text codegen

codegen é˜¶æ®µç›®çš„æ˜¯å°† codegenNode è§£ææˆ Render å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚

1. /f6d5271/ add ~createCodegenContext()~

   [[https://github.com/gcclll/stb-vue-next/commit/f6d52713ae8154d438c2ed94641525fa3c05edef][feat(add): codegen context creator Â· gcclll/stb-vue-next@f6d5271]]

   ä¸Šä¸‹æ–‡å¯¹è±¡åˆ›å»ºå‡½æ•°ï¼Œé‡ç‚¹æ–¹æ³•æœ‰ä¸¤ä¸ª(~push(code, node)~ å’Œ ~helper(key)~)ã€‚

   FIX1: lint errors, [[https://github.com/gcclll/stb-vue-next/commit/0ac8c2f4b6b5022caa0f83a7f850226c30a99d33][fix: f6d5271 lint errors Â· gcclll/stb-vue-next@0ac8c2f]]

2. /2ef2699/ å¢åŠ  text codegen generator å®ç°

   [[https://github.com/gcclll/stb-vue-next/commit/2ef2699b95457be4456b736b70467b98bf240ddd][feat: generate text codegen Â· gcclll/stb-vue-next@2ef2699]]

   è¯¥éƒ¨åˆ†æ¶‰åŠåˆ°ä¸€ä¸ªè¾ƒä¸ºå®Œæ•´çš„ codegen generator æµç¨‹ï¼Œæ‰€ä»¥å¢åŠ å†…å®¹è¾ƒå¤šï¼Œå› æ­¤è¿™é‡Œ
   ä¸ç›´æ¥è´´ä»£ç äº†ï¼Œè¯·ç‚¹å‡»ä¸Šé¢ commit é“¾æ¥æŸ¥çœ‹å®é™…å¢åŠ çš„æºç ã€‚

   å¤„ç†æµç¨‹ï¼š

   - preamble å¤„ç†ï¼Œå¦‚æœæ˜¯ Node ç¯å¢ƒéœ€è¦é€šè¿‡ ~import { ...} from 'vue'~ è¯­æ³•ï¼Œå¦‚
     æœæ˜¯æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ ~const { ... } = Vue~ è§£æ„è¯­æ³•ã€‚

   - æ˜¯å¦ä½¿ç”¨ ~with() {}~ ä½œç”¨åŸŸè¯­æ³•ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨çš„

   - ~return ...~ è¿”å›å®é™… render å‡½æ•°è¿”å›ç»“æœï¼Œè¿™é‡Œå°†è¿”å›æœ€åè¢«æ¸²æŸ“çš„ DOM ç»“æ„ã€‚

   - ~genNode()~ é€’å½’å¤„ç† ast ç”Ÿæˆ render å‡½æ•°çš„å¯¹åº”éƒ¨åˆ†ä»£ç 

3. /6b901f9/ å¢åŠ  node ç¯å¢ƒæˆ– module ç¯å¢ƒå¤„ç†(~genModulePreamble~)

   [[https://github.com/gcclll/stb-vue-next/commit/6b901f9f3d8af3dc415d31a6c5027d8e262fa74f][feat: module preamble Â· gcclll/stb-vue-next@6b901f9]]
   modue preamble : ~export { ... } from 'vue'~
   function preamble: ~const { ... } = Vue~


é‡ç‚¹å¢åŠ çš„ genXxx å‡½æ•° ~genText(node, context)~ ä¸“é—¨ç”¨æ¥å¤„ç†æ–‡æœ¬èŠ‚ç‚¹çš„ã€‚

#+begin_src typescript
function genText(
  node: TextNode | SimpleExpressionNode,
  context: CodegenContext
) {
  context.push(JSON.stringify(node.content), node)
}
#+end_src
*** æµ‹è¯•

æµ‹è¯•å°†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œ
**** function preamble å½¢å¼(ä½œä¸ºå…¨å±€ ~Vue~ å¯¹è±¡å¼•å…¥)

#+begin_src js
const {
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`)
console.log(res.code)
#+end_src

#+RESULTS:
:
: return function render(_ctx, _cache) {
:   with (_ctx) {
:     return "pure text"
:   }
: }
: undefined

[[https://github.com/gcclll/stb-vue-next/commit/6b3bd2e4c20dc7a325ff7c0575c127595da91b42][fix: less the last } paren Â· gcclll/stb-vue-next@6b3bd2e]]

**** module preamble å½¢å¼(*es6* æ¨¡å—åŒ–å¯¼å‡ºå¯¼å…¥)

#+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`pure text`, { mode: 'module' })
console.log(res.code)
#+end_src

#+RESULTS:
:
: return function render(_ctx, _cache) {
:   return "pure text"
: }
: undefined

è¿™é‡Œå¥½åƒçœ‹ä¸å‡ºå•¥åŒºåˆ«ï¼Œåé¢å†è¯´å§ã€‚
* 2f749b2 add interpolation generator
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: interpolation
:END: 

[[https://github.com/gcclll/stb-vue-next/commit/2f749b2a5d0872713704a52943bb18b550c559c0][feat(add): transform -> generate interpolation Â· gcclll/stb-vue-next@2f749b2]]

#+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`{{ a > b }}`)
console.log(res.code)
console.log(res.ast.children[0])
#+end_src

è¿™é‡Œå®ç°åˆ†å‡ ä¸ªéƒ¨åˆ†ï¼š

*transform*: traverseNode() å¢åŠ å¯¹æ’å€¼çš„å¤„ç†ï¼Œåé¢å¢åŠ äº† traverseChildren å¤„ç†ï¼Œå› ä¸ºæ‰€æœ‰çš„
ast éƒ½æ˜¯æŒ‚åœ¨ ~root.children~ ä¸­çš„ï¼Œæ‰€ä»¥æœ€å¼€å§‹è§£æçš„æ˜¯ ~ROOT~ èŠ‚ç‚¹ï¼Œå› æ­¤è¿™é‡Œå¿…é¡»
è¦å¢åŠ  ~ROOT~ ç±»å‹çš„è§£æï¼Œè°ƒç”¨ ~traverseChildren(node, ctx)~ å»é€’å½’è§£æ ~root.children~

#+begin_quote
transform() -> traverseNode(): ROOT è§£æ -> traverseChildren() ->
traverseNode(): INTERPOLATION
#+end_quote

æ–°å¢æ ¸å¿ƒå‡½æ•°ï¼šéå†æ‰€æœ‰ ~children[]~ è°ƒç”¨ ~traverseNode()~ 
#+begin_src typescript
export function traverseChildren(
  parent: ParentNode,
  context: TransformContext
) {
  // TODO	  let i = 0
  const nodeRemoved = () => {
    i--
  }

  for (; i < parent.children.length; i++) {
    const child = parent.children[i]
    if (isString(child)) continue
    context.parent = parent
    context.childIndex = i // æ–¹ä¾¿åœ¨ transformXxx å‡½æ•°ä¸­èƒ½å¿«é€Ÿå®šä½åˆ°å½“å‰èŠ‚ç‚¹
    context.onNodeRemoved = nodeRemoved
    traverseNode(child, context)
  }
}
#+end_src

[[http://qiniu.ii6g.com/img/20201201155917.png]]

*codegen*: ~genNode()~ ä¸­æ–°å¢ ~INTERPOLATION~ å’Œ ~SIMPLE_EXPRESSION~ ç±»å‹çš„å¤„ç†ï¼Œ
 å› ä¸º INTERPOLATION çš„ ast.content(å¦‚ä¸Šé¢ä»£ç æ‰§è¡Œç»“æœ) ç±»å‹æ˜¯ SIMPLE_EXPRESSIONã€‚

 #+begin_src typescript
function genExpression(node: SimpleExpressionNode, context: CodegenContext) {
  const { content, isStatic } = node
  context.push(isStatic ? JSON.stringify(content) : content, node)
}

function genInterpolation(node: InterpolationNode, context: CodegenContext) {
  const { push, helper, pure } = context
  if (pure) push(PURE_ANNOTATION)
  push(`${helper(TO_DISPLAY_STRING)}(`)
  genNode(node.content, context)
  push(')')
}
 #+end_src

-----

[[https://github.com/gcclll/stb-vue-next/commit/2d0e2a6f7610059f37aef798d37eaafdf8c43377][feat(add): comment generator Â· gcclll/stb-vue-next@2d0e2a6]]
 
æ‹“å±•ï¼šadd comment generator

#+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const res = baseCompile(`<!-- i'm a comment -->`)
console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createCommentVNode : _createCommentVNode } = _Vue

    return _createCommentVNode(" i'm a comment ")
  }
}
undefined
#+end_example
* add element transfrom and generator
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: element
:END: 

** å‡†å¤‡å·¥ä½œ ~compiler-core/src/utils.ts~

[[https://github.com/gcclll/stb-vue-next/commit/9436d8fe155767391a278807ae02a6ae9eff94a3][feat: utils for compiler-core Â· gcclll/stb-vue-next@9436d8f]]

ç›¸å…³æ­£åˆ™ï¼š ~const memberExpRE = /^[A-Za-z_$][\w$]*(?:\s*\.\s*[A-Za-z_$][\w$]*|\[[^\]]+\])*$/~

[[http://qiniu.ii6g.com/img/image.png]]

[[https://github.com/gcclll/stb-vue-next/commit/2265e466e6daea95614d5fe96968b30ff11a2e19][feat(add): resolveComponentType Â· gcclll/stb-vue-next@2265e46]]

è§£æå‡ºç»„ä»¶çš„ç±»å‹ï¼Œå¤§ä½“åˆ†ä¸ºå››ç±»ï¼š

1. åŠ¨æ€ç»„ä»¶ï¼š ~<component is="xx">~ æˆ– ~<component v-is="xx">~
2. å†…ç½®ç»„ä»¶ï¼š ~Teleport, Transition, KeepAlive, Suspense~
3. ç”¨æˆ·ç»„ä»¶ï¼š ~$setup[]~ ä¸Šçš„ç»„ä»¶
4. ç”¨æˆ·ç»„ä»¶ï¼š ~context.components[]~ ä¸Šçš„ç»„ä»¶

** 87339d2 add element transform
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: element-transform
:END: 

[[https://github.com/gcclll/stb-vue-next/commit/87339d25f1fa43ed5e0a13dabc60fec9479451c1][feat(add): transformElement function Â· gcclll/stb-vue-next@87339d2]]

æ™®é€šæ ‡ç­¾çš„ transform codegenNodeé˜¶æ®µã€‚

1. add ~createVNodeCall()~ å‡½æ•°ï¼Œåˆ›å»ºåŸºæœ¬çš„ ELEMENT ç±»å‹èŠ‚ç‚¹ codegenNode

  æ ¹æ® ~isBlock~ å‚æ•°å†³å®šä½¿ç”¨ BLOCK å‡½æ•°è¿˜æ˜¯ VNODE å‡½æ•°ã€‚
   
  #+begin_src typescript
   export function createVNodeCall(
       context: TransformContext | null,
       tag: VNodeCall['tag'],
       props?: VNodeCall['props'],
       children?: VNodeCall['children'],
       patchFlag?: VNodeCall['patchFlag'],
       dynamicProps?: VNodeCall['dynamicProps'],
       directives?: VNodeCall['directives'],
       isBlock: VNodeCall['isBlock'] = false,
       disableTracking: VNodeCall['disableTracking'] = false,
       loc = locStub
   ): VNodeCall {
   if (context) {
       if (isBlock) {
           context.helper(OPEN_BLOCK)
           context.helper(CREATE_BLOCK)
       } else {
           context.helper(CREATE_VNODE)
       }
   }

   return {
       type: NodeTypes.VNODE_CALL,
       tag,
       props,
       children,
       patchFlag,
       dynamicProps,
       directives,
       isBlock,
       disableTracking,
       loc
   }
 }
 #+end_src

2. add ~createObjectExpression()~ å‡½æ•°

   #+begin_src typescript
    export function createObjectExpression(
        properties: ObjectExpression['properties'],
        loc: SourceLocation = locStub
    ): ObjectExpression {
    return {
        type: NodeTypes.JS_OBJECT_EXPRESSION,
        loc,
        properties
    }
    }
   #+end_src

3. add ~getStaticType()~ åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦åšé™æ€æå‡å¤„ç†

4. add ~transformElement: postTransformElement()~ å‡½æ•°

5. add ~stringifyDynamicPropNames()~ å°†å±æ€§è½¬æˆæ•°ç»„ç»“æ„


æµ‹è¯•ï¼š
#+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`<div></div>`)
console.log('root codegenNode: ', res.ast.codegenNode)
console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
root codegenNode:  undefined
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode } = _Vue

    return null
  }
}
undefined
#+end_example

æ­£ç¡®ç»“æœï¼š
#+begin_example
Æ’ render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock("div"))
  }
}
#+end_example

é—®é¢˜ï¼š
1. æ ¹èŠ‚ç‚¹ codegenNode ä¸ºç©º
2. render å‡½æ•°å†…æ²¡æœ‰ ~openBlock, createBlock~ å¯¼å‡º
3. return åé¢æ²¡å†…å®¹(è¿™æ˜¯ generator èŒƒç•´ï¼Œæ­¤èŠ‚ä¸å±•å¼€)


é—®é¢˜1ï¼Œ2éƒ½æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹å¤„ç†çš„ï¼Œå› ä¸ºå½“ ROOT èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸ä¼šç”¨
CREATE_VNODE åˆ›å»ºï¼Œè€Œæ˜¯æ”¹ç”¨ CREATE_BLOCKï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªé—®é¢˜ä¸€èµ·å¤„ç†

FIX 1,2: [[https://github.com/gcclll/stb-vue-next/commit/97cf290240fa937f167f8aadd6e6527744da4cbe][fix: no export open/create block function from Vue Â· gcclll/stb-vue-next@97cf290]]

ä¿®æ”¹ï¼š ~createRootCodegen(root: RootNode, context: TransformContext)~

** 2f58786 add element generator

[[https://github.com/gcclll/stb-vue-next/commit/2f58786c56986672c6b7cabdcd541363bf05b4dd][feat: element generator Â· gcclll/stb-vue-next@2f58786]]

è·¯å¾„ï¼š

1. ~VNODE_CALL~ ->

2. ~genVNodeCall()~ ->

3. ~genNodeList([], ctx)~ ->

    - string: ~push(node)~
    - array: ~genNodeListAsArray(node, ctx)~ 
    - other: ~genNode(node, ctx)~


æµ‹è¯•:
#+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`<div></div>`)
console.log('root codegenNode: ', res.ast.codegenNode)
console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
root codegenNode:  {
  type: 13,
  tag: '"div"',
  props: undefined,
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 12, line: 1, offset: 11 },
    source: '<div></div>'
  }
}
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div"))
  }
}
#+end_example
** 05ca2f8 root.children æœ‰å¤šä¸ªå­©å­

[[https://github.com/gcclll/stb-vue-next/commit/05ca2f8bedf21d146a01ad5694c727bbe776145c][feat: root.children has multi child Â· gcclll/stb-vue-next@05ca2f8 Â· GitHub]]

å½“æœ‰å¤šä¸ªå­©å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ª ~fragment~ å°†ä»–ä»¬åŒ…èµ·æ¥ã€‚

[[http://qiniu.ii6g.com/img/20201201232048.png]]

FIX: æ­»å¾ªç¯ï¼Œ ~genNode(node.codegenNode, ctx)~

[[http://qiniu.ii6g.com/img/20201201232120.png]]

æµ‹è¯•ï¼š

#+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`<div></div><div></div>`)
console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment,null,[
      _createVNode("div"),
      _createVNode("div")
    ],64 /* STABLE_FRAGMENT */))
  }
}
undefined
#+end_example

FIX: å‚æ•°ä¹‹é—´å°‘äº†ç©ºæ ¼([[https://github.com/gcclll/stb-vue-next/commit/05ca2f8bedf21d146a01ad5694c727bbe776145c?branch=05ca2f8bedf21d146a01ad5694c727bbe776145c&diff=split][feat: root.children has multi child Â· gcclll/stb-vue-next@05ca2f8]])

æ­£è§£ï¼š
#+begin_example
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode("div", null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createVNode("div", null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, Fragment: _Fragment, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment, null, [
      _hoisted_1,
      _hoisted_2
    ], 64 /* STABLE_FRAGMENT */))
  }
}
#+end_example

æ­£ç¡®ç­”æ¡ˆä¸­åšäº†é™æ€æå‡å¤„ç†ï¼Œä»£ç åœ¨ ~transform()~ å‡½æ•°ä¸­ ~hoistStatic(root,
context)~ çš„è°ƒç”¨ï¼Œä¼šä» ROOT èŠ‚ç‚¹å¼€å§‹éå†ï¼Œå°†éœ€è¦æå‡çš„èŠ‚ç‚¹è¿›è¡Œæå‡å¤„ç†ã€‚
* 7cb3dbf add hoist static é™æ€æå‡

æ»¡è¶³æå‡çš„ä¸‰ç§æƒ…å†µï¼š

1. tag å’Œ tagType éƒ½æ˜¯ ELEMENT ä¸”æ•´æ£µæ ‘éƒ½æ˜¯é™æ€
2. åŒ…å«åŠ¨æ€å­©å­èŠ‚ç‚¹ï¼Œä½†æ˜¯æœ‰é™æ€å±æ€§çš„ï¼Œå°†å±æ€§æå‡
3. çº¯æ–‡æœ¬èŠ‚ç‚¹


[[https://github.com/gcclll/stb-vue-next/commit/7d7dbd4e20198e73df5c93804dce122656252c8f][feat(add): hoist static Â· gcclll/stb-vue-next@7d7dbd4]]

transform() ä¸­å¢åŠ é™æ€æå‡å¤„ç†ï¼š

#+begin_src typescript
if (options.hoistStatic) {
  hoistStatic(root, context)
}
#+end_src

[[https://github.com/gcclll/stb-vue-next/commit/7cb3dbf94bd17c5af68dc55103a8031da28be55b][feat: hoist static Â· gcclll/stb-vue-next@7cb3dbf]]

1. ä¿®æ”¹ ~genFunctionPreamble(ast: RootNode, context: CodegenContext)~ è§£æ„å‡ºéœ€è¦ç”¨åˆ°çš„å‡½æ•°(~_createVNode~)

   [[/img/commit/diff-hoist-decon-functions.png]]

2. å¢åŠ  ~genHoists()~ å‡½æ•°ï¼Œç”Ÿæˆ ~ast.hoists~ ä¸­éœ€è¦æå‡çš„èŠ‚ç‚¹

    #+begin_src typescript
    function genHoists(hoists: (JSChildNode | null)[], context: CodegenContext) {
    if (!hoists.length) {
        return
    }

    context.pure = true
    const { push, newline, helper, scopeId, mode } = context
    const genScopeId = !__BROWSER__ && scopeId != null && mode !== 'function'
    newline()

    // push scope Id before initializing hoisted vnodes so that these vnodes
    // get the proper scopeId as well.
    if (genScopeId) {
        push(`${helper(PUSH_SCOPE_ID)}("${scopeId}")`)
        newline()
    }

    hoists.forEach((exp, i) => {
        if (exp) {
        push(`const _hoisted_${i + 1} = `)
        genNode(exp, context)
        newline()
        }
    })

    if (genScopeId) {
        push(`${helper(POP_SCOPE_ID)}()`)
        newline()
    }

    context.pure = false
    }
    #+end_src


æµ‹è¯•ï¼š
#+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`<div></div><div></div>`, { hoistStatic: true })
console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = /*#__PURE__*/_createVNode("div", null, null, -1 /* HOISTED */)
const _hoisted_2 = /*#__PURE__*/_createVNode("div", null, null, -1 /* HOISTED */)

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, Fragment : _Fragment, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock(_Fragment, null, [
      _hoisted_1,
      _hoisted_2
    ], 64 /* STABLE_FRAGMENT */))
  }
}
undefined
#+end_example

#+begin_quote
PS: é™æ€å±æ€§æå‡ [[https://github.com/gcclll/stb-vue-next/commit/1e58eeb605b0dc88c90dac550b927f89dd18e07d][feat: props hoist static Â· gcclll/stb-vue-next@1e58eeb]]
#+end_quote

* prop transform and generator

åœ¨è¿™ä¹‹å‰æˆ‘ä»¬å®Œæˆäº†ä»¥ä¸‹å‡ ä¸ªåŸºæœ¬éƒ¨åˆ†ï¼š

- [[#pure-text][æ–‡æœ¬]]
- [[#interpolation][æ’å€¼]]
- [[#element][æ™®é€šæ ‡ç­¾(ä¸€ä¸ªå’Œå¤šä¸ª)]]


æ¥ä¸‹æ¥éœ€è¦å®Œæˆå±æ€§çš„è§£ææ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå› ä¸º ~v-if, v-for, v-slot, ...~ éƒ½éœ€è¦å±
æ€§è§£æã€‚

å±æ€§è½¬æ¢è¿™é‡Œå¼‚å¸¸å¤æ‚ï¼Œéœ€è¦æ…¢æ…¢å±•å¼€æ¥è®²ï¼Œå¹¶ä¸”æ¶‰åŠåˆ°å„ç§æŒ‡ä»¤ï¼Œå› æ­¤å¯¹äºå®Œæ•´çš„æµ‹è¯•éœ€
è¦ç­‰æ‰€æœ‰æŒ‡ä»¤ transform å®Œæˆä¹‹åå†è¿›è¡Œã€‚

** 1792f93 props transform

*** buildProps

[[https://github.com/gcclll/stb-vue-next/commit/1792f93b26aff5d0db60d83b946a83fb0fa6e776][feat(add): transform props Â· gcclll/stb-vue-next@1792f93]]


- å°† ~codegenNode.props~ æ„å»ºæˆ å¦‚ä¸‹ç»“æ„ï¼š

  #+begin_src json
{
    "type":15,
    "properties":[
        {
            "type":16,
            "key":{
                "type":4,
                "isConstant":false,
                "content":"class",
                "isStatic":true
            },
            "value":{
                "type":4,
                "isConstant":false,
                "content":"second",
                "isStatic":true
            }
        },
        {
            "type":16,
            "key":{
                "type":4,
                "isConstant":false,
                "content":"onClick",
                "isStatic":true
            },
            "value":{
                "type":4,
                "content":"clickHandle",
                "isStatic":false,
                "isConstant":false,
            }
        }
    ]
}
  #+end_src

- v-bind,v-on æŒ‡ä»¤ï¼Œæ²¡æœ‰å‚æ•°ï¼Œéœ€è¦å°† props åˆå¹¶

*** transform props

[[https://github.com/gcclll/stb-vue-next/commit/20a5fa8bfefa9dd98a7965f78ff1f84de2591962][feat: transform props in codgenNode Â· gcclll/stb-vue-next@20a5fa8]]
** e4acc0d props generator

[[https://github.com/gcclll/stb-vue-next/commit/e4acc0dd5e33ceab3420f9e5ca8857f090bb536c][feat: props generator Â· gcclll/stb-vue-next@e4acc0d]]

ä¿®æ”¹ç‚¹ï¼š

1. add ~genExpressionAsPropertyKey()~ ç”Ÿæˆå±æ€§ key å‡½æ•°

   ä¸‰ç§å¯èƒ½çš„å±æ€§å

   - é™æ€å±æ€§å: ~<div class="value">~ -> ~{ class: "value" }~

   - åŠ¨æ€å±æ€§å: ~<div :[propName]="value"~ -> ~{ [propName]: "value"}~

   - ç»„åˆè¡¨è¾¾å¼å±æ€§åï¼šTODO

    #+begin_src typescript
   // ç”Ÿæˆå¯¹è±¡çš„å±æ€§ key (å¯èƒ½æ˜¯é™æ€ï¼ŒåŠ¨æ€)
   function genExpressionAsPropertyKey(
     node: ExpressionNode,
     context: CodegenContext
   ) {
     const { push } = context
     if (node.type === NodeTypes.COMPOUND_EXPRESSION) {
       // TODO åŠ¨æ€å±æ€§åæˆ–è¡¨è¾¾å¼
     } else if (node.isStatic) {
       // only quote key if necessary
       const text = isSimpleIdentifier(node.content)
         ? node.content
         : JSON.stringify(node.content)

       push(text, node)
     } else {
       push(`[${node.content}]`, node)
     }
   }
    #+end_src

2. add ~genObjectExpression()~ å°†å±æ€§åˆ—è¡¨ç”Ÿæˆå¯¹è±¡

   éå†èŠ‚ç‚¹çš„ ~node.properties~ å…ˆç”Ÿæˆ key(~genExpressionAsPropertyKey(key)~) å†ç”Ÿæˆ value(~genNode(value)~) ã€‚


æµ‹è¯•ï¼š
#+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`<div class="first" name="div"></div>`, { hoistStatic: true })
console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue
const { createVNode: _createVNode } = _Vue

const _hoisted_1 = {
  class: "first",
  name: "div"
}

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", _hoisted_1))
  }
}
undefined
#+end_example

#+begin_quote
å®ä¾‹ä¸­æœ€åæ˜¯ç”¨çš„ ~createBlock()~ æ˜¯å› ä¸º root.children åªæœ‰ä¸€ä¸ª child ã€‚
#+end_quote

** static props

ä¿®æ”¹å‡½æ•°ï¼š ~transforms/transformElement~

#+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`<div class="first"></div><div class="second"></div>`, { hoistStatic: true })
console.log(res.ast.codegenNode.children[0].props[0])
#+end_src

#+RESULTS:
#+begin_example
{
  type: 6,
  name: 'class',
  value: {
    type: 2,
    content: 'first',
    loc: { start: [Object], end: [Object], source: '"first"' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 19, line: 1, offset: 18 },
    source: 'class="first"'
  }
}
undefined
#+end_example
** 6951dd1 merge props

[[https://github.com/gcclll/stb-vue-next/commit/6951dd1ff97da1ef803e97770162fe0293ef76cc][feat: merge props Â· gcclll/stb-vue-next@6951dd1]]

åˆå¹¶å±æ€§çš„æ¡ä»¶ï¼šå­˜åœ¨æ²¡æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œå¦‚ï¼š ~<div v-bind="{...}" v-on="{...}"~

FIX: [[https://github.com/gcclll/stb-vue-next/commit/12a66f0ebef241b282b4ccf746ddabc1a2f45ef1][fix: merge toHandlers props Â· gcclll/stb-vue-next@12a66f0]]

#+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
const log = (code, title) => {
  console.log(`>>> ${title}`)
  const res = baseCompile(code)
  console.log(res.code)
}
 
log(`
<div class="first" v-on="{ click: clickHandle  }" v-bind="{ style: 'color:red' }"></div>`, 'æ— å‚æ•°çš„æŒ‡ä»¤ï¼Œåˆå¹¶æ‰€æœ‰å±æ€§')

log(`<div class="second" v-on:click="clickHandle" v-bind:style="color:red"></div>`, 'æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œä¸åˆå¹¶')
#+end_src

#+RESULTS:
#+begin_example
>>> æ— å‚æ•°çš„æŒ‡ä»¤ï¼Œåˆå¹¶æ‰€æœ‰å±æ€§
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toHandlers : _toHandlers, mergeProps : _mergeProps, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", _mergeProps({ class: "first" }, _toHandlers({ click: clickHandle  }), { style: 'color:red' }), null, 16 /* FULL_PROPS */))
  }
}
>>> æœ‰å‚æ•°çš„æŒ‡ä»¤ï¼Œä¸åˆå¹¶
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock("div", { class: "second" }, null, 512 /* NEED_PATCH */)), )
  }
}
undefined
#+end_example

æœ‰å‚æ•°æŒ‡ä»¤æ—¶ï¼Œéœ€è¦ç»“åˆ ~v-on~ æŒ‡ä»¤è§£æï¼Œå› æ­¤éœ€è¦å…ˆå®ç°äº† transform æŒ‡ä»¤æ‰èƒ½å¾—åˆ°ä¸‹é¢çš„æ­£ç¡®ç»“æœã€‚

ä¸åˆå¹¶(~mergeProps()~) çš„æ­£è§£ï¼š

#+begin_src js
(function anonymous(
) {
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", {
      class: "second",
      onClick: clickHandle,
      style: { color: 'red' }
    }, null, 12 /* STYLE, PROPS */, ["onClick"]))
  }
}
})
#+end_src

ä¸‹é¢å°†ç»§ç»­å®ŒæˆæŒ‡ä»¤ç›¸å…³çš„ transform
* 6c43451 add v-on transform

init: [[https://github.com/gcclll/stb-vue-next/commit/98dcc9653790a319c3bc04222322167db21546df][feat(init): v-on directive Â· gcclll/stb-vue-next@98dcc96]]

å®ç°ï¼š[[https://github.com/gcclll/stb-vue-next/commit/6c4345156ffc86542120bb97deb438097b36efca][feat: v-on directive transform Â· gcclll/stb-vue-next@6c43451]]

#+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`<div class="second" v-on:click="clickHandle" v-bind:style="color:red"></div>`)

console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { resolveDirective : _resolveDirective, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock("div", {
      class: "second",
      onClick: clickHandle
    }, null, 8 /* PROPS */, ["onClick"])), )
  }
}
undefined
#+end_example

é—®é¢˜ï¼š ~v-bind~ æ²¡æœ‰è¢«è§£æå‡ºæ¥ã€‚
* f805858 add v-bind transform
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: v-bind
:END: 

[[https://github.com/gcclll/stb-vue-next/commit/f80585802218bcc75aad502880c571b642257ef0][feat(add): v-bind transform Â· gcclll/stb-vue-next@f805858]]

#+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const res = baseCompile(`
<div v-bind:name="test"
  :age="100"
  :[propName]="myName"
  :[first+second]="thrid"
  :no-need-camel-prop="noNeedCamelProp"
  :need-camel-prop.camel="needCamelProp"
  :no-exp-prop.camel
></div>`, {
  onError(e) {
    console.log(e.message)
  }
})
console.log(`>>> render function\n`)
console.log(res.code)
#+end_src

#+RESULTS:
#+begin_example
v-bind is missing expression.
>>> render function

const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", {
      name: test,
      age: 100,
      [propName || ""]: myName,
      [first+second || ""]: thrid,
      "no-need-camel-prop": noNeedCamelProp,
      needCamelProp: needCamelProp,
      noExpProp: ""
    }, null, 16 /* FULL_PROPS */, ["name","age","no-need-camel-prop","needCamelProp","noExpProp"]))
  }
}
undefined
#+end_example

v-bind å±æ€§æ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

- ~v-bind:name="test"~ æ— ç¼©å†™å±æ€§ï¼Œæœ€æ™®é€šçš„ä¸€ç§ç”¨æ³•
- ~:age="100"~ ç¼©å†™å½¢å¼
- ~:[propName]="myName"~ æ™®é€šåŠ¨æ€å±æ€§å
- ~:[first+second]="third"~ è¡¨è¾¾å¼åŠ¨æ€å±æ€§å
- ~:no-need-camel-prop="noNeedCamelProp"~ ä¸éœ€è¦è½¬é©¼å³°çš„å±æ€§å
- ~:need-camel-prop.camel="needCamelProp"~ éœ€è¦è½¬æˆé©¼å³°çš„å±æ€§åï¼Œéœ€è¦åˆ¶å®š
  ~.camel~ ä¿®é¥°ç¬¦
- ~no-exp-prop.camel~ æ— å±æ€§å€¼çš„å±æ€§ï¼Œä¼šç»™é»˜è®¤ ~""~ å€¼ï¼ŒåŒæ—¶ç»™å‡ºè­¦å‘Šï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚
* 0cc76f0 add v-model transform

[[https://github.com/gcclll/stb-vue-next/commit/0cc76f04112b1194e0a5cafae0a49bc399462ebf][feat(add): v-model transform Â· gcclll/stb-vue-next@0cc76f0]]

~<input v-model="model" />~

ç»è¿‡ ~transformModel~ ä¹‹åçš„ node.props:

#+begin_src json
[
    {
        "type":16, // JS_PROPERTY
        "key":{
            "type":4, // SIMPLE_EXPRESSION
            "content":"modelValue",
            "isStatic":true,
            "constType":3
        },
        "value":{
            "type":4,
            "content":"model",
            "isStatic":false,
            "constType":0,
        }
    },
    {
        "type":16,
        "key":{
            "type":4,
            "content":"onUpdate:modelValue",
            "isStatic":true,
            "constType":3
        },
        "value":{
            "type":8, // COMPOUND_EXPRESSION
            "children":[
                "$event => (",
                {
                    "type":4,
                    "content":"model",
                    "isStatic":false,
                    "constType":0,
                },
                " = $event)"
            ]
        }
    }
]
#+end_src

compiler-core é˜¶æ®µçš„è§£æè„‘å›¾ï¼š
[[/img/vue3/compiler-core/pcg/pcg-08-v-model-cc.svg]]

ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ v-model æŒ‡ä»¤çš„è§£æä¹Ÿæ˜¯åœ¨ buildProps ä¸­å®Œæˆçš„ï¼Œå…³äºè¿™ä¸ªå‡½æ•°çš„è„‘
å›¾ä¹Ÿå¯ä»¥æŸ¥çœ‹ [[/vue/vue-mind-map-house-cc/#key-01-build-props][buildProps(node, context) å¦‚ä½•æ„å»º props ?]]

vue/baseCompile è§£æä¹‹åçš„ç»“æœï¼š

#+begin_src js
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return (_openBlock(), _createBlock("input", {
      modelValue: model,
      "onUpdate:modelValue": $event => (model = $event)
    }, null, 8 /* PROPS */, ["modelValue", "onUpdate:modelValue"]))
  }
}
#+end_src

vue/compile ç»è¿‡ compile-dom package(/æœªå®Œæˆ/) çš„ transformModel ä¹‹åçš„ç»“æœï¼š

#+begin_src js
(function anonymous(
) {
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { vModelText: _vModelText, createVNode: _createVNode, withDirectives: _withDirectives, openBlock: _openBlock, createBlock: _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock("input", {
      "onUpdate:modelValue": $event => (model = $event)
    }, null, 8 /* PROPS */, ["onUpdate:modelValue"])), [
      [_vModelText, model]
    ])
  }
}
})
#+end_src

[[https://github.com/gcclll/stb-vue-next/commit/a537be0fc265243012032750a801b6e6582751d5][fix: v-model no value Â· gcclll/stb-vue-next@a537be0]]

ä¿®å¤ä¹‹å(~genNode~ æ²¡æœ‰å®ç° ~8,COMPOUND_EXPRESSION~ ç±»å‹)ï¼Œæµ‹è¯•

1. ä¸å¸¦å‚æ•°çš„ ~v-model~

   #+begin_src js
    const {
        baseParse,
        baseCompile
    } = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

    const { code } = baseCompile(`<input v-model="model" />`)
    console.log(code)
    #+end_src

    #+RESULTS:
    #+begin_example
    const _Vue = Vue

    return function render(_ctx, _cache) {
      with (_ctx) {
        const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

        return (_openBlock(), _createBlock("input", {
          modelValue: model,
          "onUpdate:modelValue": $event => (model = $event)
        }, null, 8 /* PROPS */, ["modelValue","onUpdate:modelValue"]))
      }
    }
    #+end_example

2. æŒ‡ä»¤ ~{ prefixIdentifiers: true }~ é€‰é¡¹(éœ€è¦ node ç¯å¢ƒ, *TODO*)

   #+begin_src js
    const {
        baseParse,
        baseCompile
    } = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

    const { code } = baseCompile(`<input v-model="model" />`, {
      prefixIdentifiers: true
    })
    console.log(code)
   #+end_src

   #+RESULTS:
   #+begin_example
   const _Vue = Vue

   return function render(_ctx, _cache) {
     with (_ctx) {
       const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

       return (_openBlock(), _createBlock("input", {
         modelValue: model,
         "onUpdate:modelValue": $event => (model = $event)
       }, null, 8 /* PROPS */, ["modelValue","onUpdate:modelValue"]))
     }
   }
   undefined
   #+end_example

3. ç»„åˆè¡¨è¾¾å¼(~8,COMPOUND_EXPRESSION~)

   #+begin_src js
const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')

const { code } = baseCompile(`<input v-model="model[index]" />`)
console.log(code)
 
   #+end_src

   #+RESULTS:
   #+begin_example
   const _Vue = Vue

   return function render(_ctx, _cache) {
     with (_ctx) {
       const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

       return (_openBlock(), _createBlock("input", {
         modelValue: model[index],
         "onUpdate:modelValue": $event => (model[index] = $event)
       }, null, 8 /* PROPS */, ["modelValue","onUpdate:modelValue"]))
     }
   }
   undefined
   #+end_example

4. å¸¦å‚æ•°

   #+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const { code } = baseCompile(`<input v-model:value="model" />`)
console.log(code)
   #+end_src

   #+RESULTS:
   #+begin_example
   const _Vue = Vue

   return function render(_ctx, _cache) {
     with (_ctx) {
       const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

       return (_openBlock(), _createBlock("input", {
         value: model,
         "onUpdate:value": $event => (model = $event)
       }, null, 40 /* PROPS, HYDRATE_EVENTS */, ["value","onUpdate:value"]))
     }
   }
   undefined
   #+end_example

    ä¸å¸¦å‚æ•°çš„æ—¶å€™å‚æ•°åä¼šç»™ä¸€ä¸ªé»˜è®¤å€¼ï¼š ~modelValue~, å¦‚æœæœ‰è‡ªå·±çš„å‚æ•°ä¼šç›´æ¥ä½¿
   ç”¨æä¾›çš„å‚æ•°åã€‚

5. åŠ¨æ€å‚æ•°

   #+begin_src js

const {
  baseParse,
  baseCompile
} = require(process.env.PWD + '/../../static/js/vue/compiler-core.global.js')
 
const { code } = baseCompile(`<input v-model:[value]="model" />`)
console.log(code)
   #+end_src

   æœ‰é—®é¢˜ç»“æœï¼š
   #+RESULTS:
   #+begin_example
   const _Vue = Vue

   return function render(_ctx, _cache) {
     with (_ctx) {
       const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

       return (_openBlock(), _createBlock("input", {
         [value]: model,
         : $event => (model = $event)
       }, null, 16 /* FULL_PROPS */))
     }
   }
   #+end_example

   ç»“æœæ˜¾ç¤ºï¼ŒåŠ¨æ€å±æ€§çš„äº‹ä»¶åæ²¡æœ‰è¢«è§£æå‡ºæ¥ ~: $event => (model = $event)~ ã€‚

   ä¿®å¤ä¹‹åç»“æœ([[https://github.com/gcclll/stb-vue-next/commit/94a7a850d7e060e948c5672cdb170c47489feda9][fix: v-model dynamic arg generate Â· gcclll/stb-vue-next@94a7a85]])ï¼š
   #+RESULTS:
   #+begin_example
   const _Vue = Vue

   return function render(_ctx, _cache) {
     with (_ctx) {
       const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

       return (_openBlock(), _createBlock("input", {
         [value]: model,
         ["onUpdate:" + value]: $event => (model = $event)
       }, null, 16 /* FULL_PROPS */))
     }
   }
   #+end_example

6. ç¼“å­˜äº‹ä»¶å›è°ƒå‡½æ•°(~cacheHandlers: true~, *TODO*)

   éœ€è¦ç»“åˆ ~prefixIdentifiers: true~ ä½¿ç”¨ã€‚
