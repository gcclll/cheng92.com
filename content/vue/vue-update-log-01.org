#+TITLE: Vue3 更新日志 01(3.0.5 ~ 3.2.0-beta.1)
#+DATE: <2021-06-28 11:29:18>
#+TAGS[]: vue, vue3
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent


#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<link href="/js/vue/formatters-styles/style.css" rel="stylesheet">
<link href="/js/vue/formatters-styles/annotated.css" rel="stylesheet">
<link href="/js/vue/formatters-styles/html.css" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  诗号：六道同坠，魔劫万千，引渡如来。
</font>
</kbd><br><br>
<script src="/js/utils.js"></script>
<script src="/js/vue/vue-next.js"></script>
<!--<script src="https://unpkg.com/vue@next"></script>-->
<script>
insertCssLink("https://unpkg.com/element-plus/lib/theme-chalk/index.css");
</script>
<script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
<script type='text/javascript' src="https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/jsondiffpatch.umd.min.js"></script>
<script src="/js/vue/tests/common.js"></script>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

* 前言

#+begin_tip
@@html:<p><strong>TIP</strong></p>@@

本系列文说明：会不定期的更新本地的 vue-next 仓库，本系列文章则是针对 git pull 后
的更新内容的分析和记录， 。

@@html:<strong><font color="red">可参过链接跳转到对应的分析文章</font></strong>@@
#+end_tip

更新内容：

很久没更新了，惨~~~~~~~~~

捡点重要的来看下吧，以后还是要保持每周拉一次代码比较好！！！

最初分析拉取的代码是： *3.0.4*, 现在都 *3.1.2* 了 尴尬！！!

* v3.0.5

[[https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md][vue-next/CHANGELOG.md at master · vuejs/vue-next]]

#+begin_tip
@@html:<p><strong>TIP</strong></p>@@

*Note*: this release contains a type-only change that requires TypeScript 4.0+,
which may cause build issues in projects still using TS 3.x.

#+end_tip

只包含一些类型的变更。

*Bug Fixes*

- compiler-core: fix missing createVNode import on nested v-for ([[https://github.com/vuejs/vue-next/commit/ad4d3915d39515a3e9ff2de691f82cb922a314b9][ad4d391]]),
  closes [[https://github.com/vuejs/vue-next/issues/2718][#2718]]
- compiler-sfc: should keep template nodes with no content ([[https://github.com/vuejs/vue-next/issues/2468][#2468]]) ([[https://github.com/vuejs/vue-next/commit/5b9b37fc9b363be2989c1e9d76ab6e950cdfe2ad][5b9b37f]]),
  closes [[https://github.com/vuejs/vue-next/issues/2463][#2463]]

  #+begin_src diff
   -> packages/compiler-sfc/src/parse.ts

   if (node.type !== NodeTypes.ELEMENT) {
      return
    }
-    if (!node.children.length && !hasSrc(node)) {
+    if (!node.children.length && !hasSrc(node) && node.tag !== 'template') {
      return
    }
    switch (node.tag) {
  #+end_src

- [[/vue/vue-teardown-7-asset-transform/][compiler-sfc: support transforming asset urls with full base url.]] ([[https://github.com/vuejs/vue-next/issues/2477][#2477]]) ([[https://github.com/vuejs/vue-next/commit/db786b1afe41c26611a215e6d6599d50312b9c2f][db786b1]])

    针对相对路径而言，当提供了 base 选项的时候，会使用这个值去拼接，如：

    ~{ transformAssetUrls: { base: 'https://www.cheng92.com' } }~

    ~<img src="./vue/img/test.png" />~ 会被编译成：

    ~createVNode('img', { src: 'https://www.cheng92.com/vue/img/test.png' })~

- runtime-core: component mount anchor memory leak ([[https://github.com/vuejs/vue-next/issues/2459][#2459]]) ([[https://github.com/vuejs/vue-next/commit/3867bb4c14131ef94098a62bffba97a5b7d1fe66][3867bb4]]), closes [[https://github.com/vuejs/vue-next/issues/2458][#2458]]

  [[/img/tmp/vue-bug-2459.png]]

- runtime-core: skip patchBlockChildren if n1.dynamicChildren is null ([[https://github.com/vuejs/vue-next/issues/2717][#2717]]) ([[https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8][c59897c]]), closes [[https://github.com/vuejs/vue-next/issues/2715][#2715]] [[https://github.com/vuejs/vue-next/issues/2485][#2485]]

  #+begin_export html
    <script src="https://unpkg.com/vue@3.0.4/dist/vue.global.js"></script>
    <div id="IR8Cl"></div>
    <script src="/js/vue/tests/IR8Cl.js"></script>
    #+end_export

  这个问题原因是，一开始 HelloWorld 的 dynamicChildren 是 null。

  当点击 ADD 按钮的时候增加了一项数据，会进入 mountChildren -> patchBlockChildren

  #+begin_src typescript
  const patchBlockChildren: PatchBlockChildrenFn = (
    oldChildren,
    newChildren,
    fallbackContainer,
    parentComponent,
    parentSuspense,
    isSVG,
    slotScopeIds
  ) => {
    for (let i = 0; i < newChildren.length; i++) {
      const oldVNode = oldChildren[i] // dynamicChildren
      const newVNode = newChildren[i]

      // ...
      }
    }
  #+end_src

  而 ~dynamicChildren~ 在初始化的时候是个 ~null~ 值, 一开始就访问了
  ~dynamicChildren[i]~ 所以导致报错。

  修复代码([[https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8][c59897c]])，加个判断条件：

  #+begin_src diff
  if (
        patchFlag > 0 &&
        patchFlag & PatchFlags.STABLE_FRAGMENT &&
-        dynamicChildren &&
+        dynamicChildren &&
+        n1.dynamicChildren
      ) {
        // a stable fragment (template root or <template v-for>) doesn't need to
        // patch children order, but it may contain dynamicChildren.
        patchBlockChildren(
-         n1.dynamicChildren!,
+          n1.dynamicChildren,
          dynamicChildren,
          container,
          parentComponent,
          parentSuspense,
          isSVG,
          slotScopeIds
        )

  #+end_src

- +runtime-dom: support mounting app on ShadowRoot+ ([[https://github.com/vuejs/vue-next/pull/2447][#2447]]) (b2189ba), closes [[https://github.com/vuejs/vue-next/issues/2399][#2399]]

  *>3.2* 中已经没有 ~__isShadowRoot~ 相关的代码了。

- TODO ssr: properly handle ssr empty slot and fallback (88f6b33)

- transition: ensure manual style manipulation in transition leave hooks work (cbaa380), closes #2720
- transition: ensure styles from *-leave-active trigger transition (#2716) (3f8f9b6), closes #2712
Features
- devtools: send instance (3626ff0)
