#+TITLE: Vue + Vite + TS(Vitesse) è„šæ‰‹æ¶ä½¿ç”¨è®°å½•
#+DATE: <2022-02-08 10:02:11>
#+EMAIL: Lee ZhiCheng<gccll.love@gmail.com>
#+TAGS[]: vue, vite, vitesse
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<script src="/js/utils.js"></script>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

è¯¥è„šæ‰‹æ¶è¯¦æƒ…è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š [[https://github.com/gcclll/vitesse][gcclll/vitesse: ğŸ• Opinionated Vite Starter Template]]

æœ¬æ–‡æ˜¯ä½¿ç”¨å’Œå­¦ä¹ è¿‡ç¨‹ä¸­çš„ä¸€äº›ç¬”è®°ï¼

é¡¹ç›®ç›®å½•ç»“æ„ï¼š

#+begin_src sh
 vitesse git:(main) âœ— tree -I "node_modules|dist"
.
â”œâ”€â”€ cypress
â”‚Â Â  â”œâ”€â”€ integration
â”‚Â Â  â”‚Â Â  â””â”€â”€ basic.spec.ts
â”‚Â Â  â””â”€â”€ tsconfig.json
â”œâ”€â”€ cypress.json
â”œâ”€â”€ index.html # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ locales # å¤šè¯­è¨€å›½é™…åŒ–
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â””â”€â”€ zh-CN.yml
â”œâ”€â”€ netlify.toml
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ public
â”‚Â Â  â”œâ”€â”€ _headers
â”‚Â Â  â”œâ”€â”€ favicon.svg
â”‚Â Â  â”œâ”€â”€ pwa-192x192.png
â”‚Â Â  â”œâ”€â”€ pwa-512x512.png
â”‚Â Â  â”œâ”€â”€ robots.txt
â”‚Â Â  â””â”€â”€ safari-pinned-tab.svg
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ App.vue
â”‚Â Â  â”œâ”€â”€ auto-imports.d.ts # è‡ªåŠ¨å¼•å…¥å£°æ˜ï¼Œè¯¥æ–‡ä»¶ä¸­å£°æ˜ï¼Œåœ¨é¡¹ç›®ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨è€Œä¸éœ€è¦é€šè¿‡ import å¼•å…¥
â”‚Â Â  â”œâ”€â”€ components # ç»„ä»¶ç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹çš„ç»„ä»¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è€Œä¸éœ€è¦ import å¼•å…¥
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Counter.vue
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Footer.vue
â”‚Â Â  â”‚Â Â  â””â”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ components.d.ts
â”‚Â Â  â”œâ”€â”€ composables # å¤šä¸»é¢˜
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dark.ts
â”‚Â Â  â”‚Â Â  â””â”€â”€ index.ts
â”‚Â Â  â”œâ”€â”€ layouts # é¡µé¢å¸ƒå±€
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 404.vue
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ default.vue
â”‚Â Â  â”‚Â Â  â””â”€â”€ home.vue
â”‚Â Â  â”œâ”€â”€ main.ts
â”‚Â Â  â”œâ”€â”€ modules # é¡¹ç›®ä¸­ä½¿ç”¨åˆ°äº†ä¸€äº›æ’ä»¶æ¨¡å—åŒ–
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ i18n.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nprogress.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pinia.ts
â”‚Â Â  â”‚Â Â  â””â”€â”€ pwa.ts
â”‚Â Â  â”œâ”€â”€ pages # é¡µé¢ç›®å½•ï¼Œè‡ªåŠ¨è·¯ç”±åŒ–ï¼Œä¼šæ ¹æ®ç›®å½•ç»“æ„å’Œæ–‡ä»¶åç§°ç”Ÿæˆå¯¹åº”çš„è·¯ç”±
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ [...all].vue
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ about.md # å¦‚ï¼š /about åŠ è½½è¿™ä¸ª
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hi
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ [name].vue # å¦‚ï¼š /hi/100 åŠ è½½è¿™ä¸ªé¡µé¢
â”‚Â Â  â”‚Â Â  â””â”€â”€ index.vue
â”‚Â Â  â”œâ”€â”€ shims.d.ts
â”‚Â Â  â”œâ”€â”€ stores # pinia çŠ¶æ€ç®¡ç†æ’ä»¶
â”‚Â Â  â”‚Â Â  â””â”€â”€ user.ts
â”‚Â Â  â”œâ”€â”€ styles # å…¨å±€æ ·å¼
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ main.css
â”‚Â Â  â”‚Â Â  â””â”€â”€ markdown.css
â”‚Â Â  â””â”€â”€ types.ts # tsç±»å‹å£°æ˜
â”œâ”€â”€ test
â”‚Â Â  â”œâ”€â”€ __snapshots__
â”‚Â Â  â”‚Â Â  â””â”€â”€ component.test.ts.snap
â”‚Â Â  â”œâ”€â”€ basic.test.ts
â”‚Â Â  â””â”€â”€ component.test.ts
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts # vite é…ç½®
â””â”€â”€ windi.config.ts # windi css æ¡†æ¶é…ç½®
#+end_src

ç‰¹æ€§(æ¥è‡ªå®˜æ–¹)ï¼Œä¸‹é¢ä¼šå¯¹æ¯ä¸ªç‰¹æ€§ä½¿ç”¨åˆ°çš„æ’ä»¶è¿›è¡Œåˆ†æï¼š

- âš¡ï¸ +Vue 3, Vite 2, pnpm, ESBuild - born with fastness+

- ğŸ—‚ File based routing

  åŸºäºæ–‡ä»¶ç»“æ„çš„è·¯ç”±ç³»ç»Ÿï¼Œä½¿ç”¨æ’ä»¶ [[https://github.com/hannoeru/vite-plugin-pages][hannoeru/vite-plugin-pages: File system based route generator for âš¡ï¸Vite]]

  ä»£ç å…¥å£ï¼š [[https://github.com/hannoeru/vite-plugin-pages/blob/main/src/index.ts][vite-plugin-pages/index.ts at main Â· hannoeru/vite-plugin-pages]]

  #+begin_src typescript
  async load(id) {
    if (id !== MODULE_ID_VIRTUAL)
       return

       return ctx.resolveRoutes()
  },
  #+end_src

  =resolveRoutes()= è§£æ =src/pages= è·¯ç”±ï¼š[[https://github.com/hannoeru/vite-plugin-pages/blob/771e956fd41589d8c9012c05016503e227d15b21/src/context.ts#L129][vite-plugin-pages/context.ts at 771e956fd41589d8c9012c05016503e227d15b21 Â· hannoeru/vite-plugin-pages]]

  #+begin_src typescript
  async resolveRoutes() {
    if (this.options.resolver === 'vue')
      return await resolveVueRoutes(this)
    if (this.options.resolver === 'react')
      return await resolveReactRoutes(this)
  }
  #+end_src

  -> =resolveVueRoutes(this)= [[https://github.com/hannoeru/vite-plugin-pages/blob/771e956fd41589d8c9012c05016503e227d15b21/src/resolvers/vue.ts#L58][vite-plugin-pages/vue.ts at 771e956fd41589d8c9012c05016503e227d15b21 Â· hannoeru/vite-plugin-pages]]

  #+begin_src typescript
export async function resolveVueRoutes(ctx: PageContext) {
  const { nuxtStyle, caseSensitive } = ctx.options

  // ctx.pageRouteMap è¿™ä¸ªåº”è¯¥å°±æ˜¯ src/pages/* ä¸‹æ‰€æœ‰æ–‡ä»¶è§£æå‡ºæ¥çš„ç»“æ„
  const pageRoutes = [...ctx.pageRouteMap.values()]
    // sort routes for HMR
    .sort((a, b) => countSlash(a.route) - countSlash(b.route))

  const routes: Route[] = []

  pageRoutes.forEach((page) => {
    const pathNodes = page.route.split('/')

    // add leading slash to component path if not already there
    const component = page.path.replace(ctx.root, '')
    const customBlock = ctx.customBlockMap.get(page.path)

    const route: Route = {
      name: '',
      path: '',
      component,
      customBlock,
      rawRoute: page.route,
    }

    let parentRoutes = routes

    for (let i = 0; i < pathNodes.length; i++) {
      // ..., å°† pathNode è§£ææˆ Route ç»“æ„
    }
    parentRoutes.push(route)
  })

  let finalRoutes = prepareRoutes(ctx, routes)

  finalRoutes = (await ctx.options.onRoutesGenerated?.(finalRoutes)) || finalRoutes

  let client = generateClientCode(finalRoutes, ctx.options)
  client = (await ctx.options.onClientGenerated?.(client)) || client
  return client
}
  #+end_src

  =PageContext= é€šè¿‡ =setupViteServer= å€Ÿç”¨ vite èµ·çš„æœåŠ¡æ¥ç›‘å¬(=setupWatcher=)ç›®å½•æ–‡
  ä»¶çš„å˜åŒ–(=unlink,add,change=)ï¼Œæ‰§è¡Œå¯¹åº”çš„æ“ä½œ(=removePage, addPage,
  checkCustomBlockChange=) ç›®çš„éƒ½æ˜¯ä¸ºäº†æ›´æ–° =pageRouteMap= è¿™ä¸ªç»“æ„ã€‚

  =searchGlob= ä¼šæ‰«æ ~options.dirs~ æŒ‡å®šçš„ç›®å½•(é»˜è®¤æ˜¯ =src/pages=)ï¼Œæ‰¾å‡ºç¬¦åˆæ¡ä»¶çš„é¡µ
  é¢è§£ææˆè·¯ç”±ã€‚

  #+begin_quote
  ç®€å•æ¥è¯´ [[https://github.com/hannoeru/vite-plugin-pages][vite-plugin-pages]] å°±æ˜¯é€šè¿‡å€Ÿç”¨ =vite= èµ·çš„æœåŠ¡å»ç›‘å¬ =src/pages= ç›®å½•çš„å˜
  åŒ–ï¼Œå¦‚æœæœ‰æ–‡ä»¶å˜åŒ–å°±å°†å…¶æ ¹æ®å…¶è·¯å¾„å’Œæ–‡ä»¶åè§£ææˆå¯¹åº”çš„è·¯ç”±å¯¹è±¡ã€‚
  #+end_quote

- ğŸ“¦ Components auto importing
  @@html:<span id="cai"></span>@@

  ä½¿ç”¨çš„æ’ä»¶ï¼š[[https://github.com/antfu/unplugin-vue-components][antfu/unplugin-vue-components: ğŸ“² On-demand components auto importing for Vue]]

  _src/index.ts_ -> _src/core/unplugin.ts_

  ç»™ vite æœåŠ¡å¢åŠ  watcher : ~ctx.setupWatcher(chokidar.watch(ctx.options.globs))~

  transform è½¬æ¢å‡½æ•°ï¼š
  #+begin_src typescript
  async transform(code, id) {
  // ...
        const result = await ctx.transform(code, id)
        ctx.generateDeclaration()
        return result
  // ...
  },
  #+end_src

  å¯ä»¥è½¬æ¢çš„æ—¶å€™è¿›è¡Œè½¬æ¢ï¼Œç„¶åç”Ÿæˆå£°æ˜ï¼Œå³ ~src/components.d.ts~ ä¸­çš„å†…å®¹ã€‚

  =Context= ä¸­åŒæ ·ä¹Ÿæ˜¯é€šè¿‡ vite server ç›‘å¬æ–‡ä»¶ unlink,add å˜åŒ–ï¼Œæ‰§è¡Œ
  ~removeComponents~ æˆ– ~addCompnents~, ä»¥ ~addComponents~ ä¸ºä¾‹ï¼š

  #+begin_src typescript
addComponents(paths: string | string[]) {
  debug.components('add', paths)

  const size = this._componentPaths.size
  toArray(paths).forEach(p => this._componentPaths.add(p))
  if (this._componentPaths.size !== size) {
    this.updateComponentNameMap()
    return true
  }
  return false
}
  #+end_src

  -> =updateComponentNameMap()= æ›´æ–°çš„æ˜¯ =componentNameMap= è¿™ä¸ªå¯¹è±¡ï¼Œå®ƒä¼šè¢«

  [[https://github.com/antfu/unplugin-vue-components/blob/40fb687990071e485a11ddb73b8e1beec1694249/src/core/declaration.ts#L13][unplugin-vue-components/declaration.ts at 40fb687990071e485a11ddb73b8e1beec1694249 Â· antfu/unplugin-vue-components]]

  ä¸­çš„ =generateDeclaration= å‡½æ•°è§£ææœ€åç”Ÿæˆå¯¹åº”çš„ä»£ç å†™å…¥(~await
  fs.writeFile(filepath, code, 'utf-8')~)åˆ° =src/components.d.ts= ä¸­

- ğŸ State Management via Pinia

- ğŸ“‘ Layout system

- ğŸ“² PWA

- ğŸ¨ Windi CSS - next generation utility-first CSS framework

- ğŸ˜ƒ Use icons from any icon sets, with no compromise

  [[https://github.com/antfu/unplugin-icons][antfu/unplugin-icons: ğŸ¤¹ Access thousands of icons as components on-demand universally.]]

  ä»£ç å…¥å£ =src/index.ts= loader å‡½æ•° -> =generateComponentFromPath()= ï¼š

  [[https://github.com/antfu/unplugin-icons/blob/4fde686174e0d054eac180c179dbae820afefba1/src/core/loader.ts#L112][unplugin-icons/loader.ts at 4fde686174e0d054eac180c179dbae820afefba1 Â· antfu/unplugin-icons]]
  #+begin_src typescript
export async function generateComponentFromPath(path: string, options: ResolvedOptions) {
  const resolved = resolveIconsPath(path)
  if (!resolved)
    return null
  return generateComponent(resolved, options)
}
  #+end_src

  loadCollection -> ~`@iconify-json/${name}/icons.json`~ -> install ~await tryInstallPkg(`@iconify-json/${name}`)~

  #+begin_src typescript

export async function tryInstallPkg(name: string) {
  if (pending)
    await pending

  if (!tasks[name]) {
    // eslint-disable-next-line no-console
    console.log(cyan(`Installing ${name}...`))
    tasks[name] = pending = installPackage(name, { dev: true, preferOffline: true })
      .then(() => sleep(300))
      .catch((e) => {
        warnOnce(`Failed to install ${name}`)
        console.error(e)
      })
      .finally(() => {
        pending = undefined
      })
  }

  return tasks[name]!
}
  #+end_src

  ä½¿ç”¨ [[https://github.com/antfu/install-pkg][antfu/install-pkg: Install package programmatically.]] ä¸‹è½½å®‰è£… icon, æ‰§è¡Œï¼š
  #+begin_src typescript
  execa(
    agent,
    [
      agent === 'yarn'
        ? 'add'
        : 'install',
      options.dev ? '-D' : '',
      ...args,
      ...names,
    ].filter(Boolean),
    {
      stdio: options.silent ? 'ignore' : 'inherit',
      cwd: options.cwd,
    },
  )
  #+end_src

  ç­‰äºæ˜¯ =yarn add -D @iconify-json/icon-name= å®‰è£…ã€‚

  æ ¹æ®è§£æå‡ºæ¥çš„è·¯å¾„ =resolved= å»ä¸‹è½½ icon =let svg = await getIcon(collection,
  icon, query, options)= ä¸‹è½½æˆåŠŸåè½¬æˆ svg
  #+begin_src typescript
  return await mergeIconProps(
    `<svg>${body}</svg>`,
    collection,
    id,
    query,
    () => attributes,
    options,
  )
  #+end_src

- ğŸŒ I18n ready

- ğŸ—’ Markdown Support

- ğŸ”¥ +Use the new <script setup> syntax+

- ğŸ“¥ APIs auto importing - use Composition API and others directly

  [[https://github.com/antfu/unplugin-auto-import][antfu/unplugin-auto-import: Auto import APIs on-demand for Vite, Webpack and Rollup]]

  å¼•å…¥ [[https://github.com/antfu/unplugin-auto-import][unplugin-auto-import]] ç„¶ååœ¨ vite.config.ts ä¸­å¢åŠ :
  #+begin_src js
  plugins: ]
    AutoImport({
      imports: [
        'vue',
        'vue-router',
        'vue-i18n',
        '@vueuse/head',
        '@vueuse/core',
      ],
      dts: 'src/auto-imports.d.ts',
    }),
  ]
  #+end_src

  å…¶å®å’Œ @@html:<a href="#cai">:link: components auto import</a>@@ åŸç†å·®ä¸å¤šï¼Œ
  å·®å¼‚åœ¨è¿™ä¸ªæ˜¯ç›´æ¥é€šè¿‡ vite.config.ts ä¸­çš„é…ç½®ä¸­è·å–éœ€è¦è‡ªåŠ¨å¯¼å…¥çš„æ’ä»¶ã€‚

  ä»£ç ï¼š =src/index.ts= -> transform -> =generateConfigFiles()=
  #+begin_src typescript

  const generateConfigFiles = throttle(500, false, () => {
    if (resolved.dts)
      fs.writeFile(resolved.dts, generateDeclaration(resolved.imports, resolved.resolvedImports), 'utf-8')

    const { eslintrc } = resolved
    if (eslintrc.enabled && eslintrc.filepath)
      fs.writeFile(eslintrc.filepath, generateESLintConfigs(resolved.imports, resolved.resolvedImports, eslintrc), 'utf-8')
  })
  #+end_src

  æ ¹æ® ~resolved.imports~ é…ç½®ï¼Œç”Ÿæˆå£°æ˜ä»£ç å†™å…¥åˆ° ~resolved.dts~ æŒ‡å®šçš„æ–‡ä»¶ã€‚åé¢æ˜¯
  å°†è‡ªåŠ¨å¼•å…¥çš„æ–‡ä»¶åŠ å…¥ eslint çš„é…ç½®æ–‡ä»¶ã€‚

  æœ€åç”Ÿæˆç±»ä¼¼ä¸‹é¢çš„ä»£ç ï¼š
  #+begin_src typescript
declare global {
  const asyncComputed: typeof import('@vueuse/core')['asyncComputed']
  // ...
}
  #+end_src

- ğŸ–¨ Static-site generation (SSG) via vite-ssg

- ğŸ¦” Critical CSS via critters

- ğŸ¦¾ TypeScript, of course

- âš™ï¸ Unit Testing with Vitest, E2E Testing with Cypress on GitHub Actions

- â˜ï¸ Deploy on Netlify, zero-config
