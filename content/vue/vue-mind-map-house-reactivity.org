#+TITLE: Vue3 æºç å¤´è„‘é£æš´ä¹‹â˜reactivity
#+DATE: <2020-11-09 11:45:36>
#+TAGS[]: vue, vue3, compiler-core, parser, compiler
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent shrink

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
<script src="/js/vue/reactivity.global.prod.js"></script>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

* TODO Proxy & Reflect åŠŸèƒ½å›é¡¾

[[/post/javascript-apis/#api-proxy-reflect][Proxy å’Œ Reflect ç›¸å…³çš„ Apis ä¼ªç å’Œè¯´æ˜è¿æ¥ ğŸ›«]]

* Reactivity
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: rt
:END:

vue-next æœ€æ–°çš„å“åº”å¼åŸç† ~Proxy + Reflect~ ã€‚

[[#while-mind-map][ç”±äºå®Œæ•´è„‘å›¾ä¼šæ¯”è¾ƒå…¨è€Œå¤§æ‰€ä»¥æ”¾åˆ°æ–‡å­—æœ€åå»ã€‚ã€‚ã€‚]]

[[/img/vue3/reactivity/reactivity.svg][ä¹Ÿå¯ä»¥ç‚¹å‡»è¯¥é“¾æ¥ç›´æ¥æ–°çª—å£æ‰“å¼€ï¼Œæ•ˆæœæ›´ä½³ã€‚]]

* reactive(target)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-rt
:END:

commit: [[https://github.com/gcclll/stb-vue-next/commit/cb3470d7c3f2944fd23e9155fc8a6afb7a51a732][cb3470d7c3f2944fd23e9155fc8a6afb7a51a732]]

è¯¥å‡½æ•°æ˜¯ä½œä¸ºå“åº”å¼æ¨¡å—çš„å…¥å£å‡½æ•°ï¼Œä¸€ä¸ªéå¸¸ç®€å•çš„å¤„ç†å‡½æ•°ï¼š

1. åªè¯»ä»£ç†ï¼Œç›´æ¥è¿”å›è¯¥å¯¹è±¡
2. å¦åˆ™è°ƒç”¨ [[#rt-cro][createReactiveObject(...args)]]

[[/img/vue3/reactivity/reactivity-reactive.svg]]

#+begin_src typescript
export function reactive(target: object) {
  // å¦‚æœè¯•å›¾ observe ä¸€ä¸ªåªè¯» proxyï¼Œè¿”å›åªè¯»ç‰ˆæœ¬
  if (target && (target as Target)[ReactiveFlags.IS_READONLY]) {
    return target
  }

  return createReactiveObject(
    target,
    false,
    {},
    // mutableHandlers,
    {}
    // mutableCollectionHandlers
  )
#+end_src

*mutableHandlers*: æ™®é€šå¯¹è±¡ç±»å‹çš„ proxy handlers

*mutableCollectionHandlers*: é›†åˆç±»å‹çš„ proxy handlersï¼Œå› ä¸º ~Reflect~ å¹¶æ²¡æœ‰å¯¹é›†
åˆç±»å‹åšåº•å±‚æ˜ å°„ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚
* createReactiveObject(...args)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-cro
:END:

commit: [[https://github.com/gcclll/stb-vue-next/commit/443a0b5920efaf714de08b0975c17f1d652815e4][443a0b5920efaf714de08b0975c17f1d652815e4]]

è„‘å›¾ï¼š
[[/img/vue3/reactivity/reactivity-create-reactive-object.svg]]

#+begin_src typescript

function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>
) {
  if (!isObject(target)) {
    if (__DEV__) {
      console.warn(`value cannot be made reactive: ${String(target)}`)
    }

    return target
  }

  // target å·²ç»æ˜¯ Proxyï¼Œä¸ç”¨é‡å¤ä»£ç†
  // å¼‚å¸¸æƒ…å†µï¼šåœ¨ä¸€ä¸ª reactive object ä¸Šè°ƒç”¨ readonly()
  if (
    target[ReactiveFlags.RAW] &&
    !(isReadonly && target[ReactiveFlags.IS_REACTIVE])
  ) {
    return target
  }

  // ä»£ç†ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥å–å·²ç¼“å­˜çš„
  const proxyMap = isReadonly ? readonlyMap : reactiveMap
  const existingProxy = proxyMap.get(target)
  if (existingProxy) {
    return existingProxy
  }

  // åªæœ‰åˆæ³•çš„ç±»å‹(Object|Array|[Weak]Map|[Weak]Set)æ‰èƒ½è¢«ä»£ç†
  const targetType = getTargetType(target)
  if (targetType === TargetType.INVALID) {
    return target
  }

  const proxy = new Proxy(
    target,
    targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers
  )

  // ç¼“å­˜ä»£ç†æ˜ å°„å…³ç³»
  proxyMap.set(target, proxy)
  return proxy
#+end_src
* mutableHandlers
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hm
:END:

é’ˆå¯¹éé›†åˆå‹å¯¹è±¡è€Œè¨€ï¼Œç»“åˆ ~Reflect~ æ„å»º Proxy çš„ handlersã€‚

** get handler
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hm-get
:END:

*** only get proxy
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hm-get-proxy
:END:

æœ¬èŠ‚åªå®ç°å¯¹è±¡çš„ ~get proxy handler~ ï¼Œå¯¹è±¡å±æ€§è¢«è®¿é—®çš„æ—¶å€™ä¼šè§¦å‘ä»£ç†ï¼Œæ¯”å¦‚ä¸‹é¢
å®ä¾‹ä¸­ï¼Œå½“è®¿é—® ~observed.count~ æ—¶å€™ä¼šè§¦å‘ ~console.log({ res }, "get")~ æ‰§è¡Œã€‚

commit: [[https://github.com/gcclll/stb-vue-next/commit/598e047407fe52183468037beb45328878431a55][598e047407fe52183468037beb45328878431a55]]

æœ€ç®€å• proxy get handler è„‘å›¾ï¼š
[[/img/vue3/reactivity/reactivity-basehd-get-01.svg]]
1. è°ƒç”¨ ~Reflect.get(target, key, receiver)~ æ‰§è¡ŒåŸå­æ“ä½œ
2. è¿”å›æ‰§è¡Œç»“æœ

ä¸»è¦æ›´æ–°ä»£ç ï¼š
#+begin_src typescript

function createGetter(isReadonly = false, shallow = false) {
  // target: è¢«å–å€¼çš„å¯¹è±¡ï¼Œkey: å–å€¼çš„å±æ€§ï¼Œreceiver: this çš„å€¼
  return function get(target: Target, key: string | symbol, receiver: object) {
    // TODO 1. key is reactive
    // TODO 2. key is readonly
    // TODO 3. key is the raw target

    // TODO 4. target is array

    const res = Reflect.get(target, key, receiver)

    // TODO 5. key is symbol, or `__protot__ | __v_isRef`

    // TODO 6. not readonly, need to track and collect deps

    // æ˜¯å¦åªéœ€è¦ reactive ä¸€çº§å±æ€§(ä¸é€’å½’ reactive)
    if (shallow) {
      return res
    }

    // TODO 6. res isRef

    // TODO 7. res is object -> reactive recursivly

    console.log({ res }, "get")
    return res
  }
#+end_src

è¿™é‡Œåªä¿ç•™çš„æœ€ç®€å•çš„ä»£ç†éƒ¨åˆ†ã€‚

æµ‹è¯•ä»£ç ï¼š
#+begin_src js
var counter = { count: 0 }
var observed = VueReactivity.reactive(counter)

observed.count // trigger get handler
// æ‰“å¼€æ§åˆ¶å°ä¼šå‘ç°æœ‰è¾“å‡º: {res: 0} "get"
#+end_src

#+begin_export html
<script type="text/javascript">
var counter = { count: 0 }
var observed = VueReactivity.reactive(counter)

observed.count // trigger get handler
// è¿™é‡Œä¼šè¾“å‡º {res: 0} "get"
</script>
#+end_export

è¿›è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œå¯¹äºæµ‹è¯•å¹¶ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¸èƒ½åªç®¡çš„çœ‹åˆ°è¾“å‡ºç»“æœï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°†å®ç°
~effect()~ æ¥æ”¶é›†ä¾èµ–ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡ä¾èµ–æ›´æ–° DOM ã€‚
*** track get operation(è¿½è¸ª get æ“ä½œï¼Œæ”¶é›†ä¾èµ–)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hm-get-track
:END:

commit: [[https://github.com/gcclll/stb-vue-next/commit/6c50273e3225761c2b1da63ce19c773603dbd523][6c50273e3225761c2b1da63ce19c773603dbd523]]

1. [[#effect-track][track(target, type, key)]] æ‰§è¡Œä¾èµ–æ”¶é›†ï¼š
2. [[#effect-effect][effect(fn, options)]] å°è£…ä¾èµ–å‡½æ•°ï¼Œå¹¶ç«‹å³æ‰§è¡Œ fn(~options.lazy = false~, æ—¶)

[[/img/vue3/reactivity/reactivity-basehd-get-02-track.svg]]

å¯¹äº ~effect()~ ç›¸å¯¹æ¯”è¾ƒç‹¬ç«‹çš„ä¸€ä¸ªå‡½æ•°ï¼Œç›®å‰é˜¶æ®µæ˜¯éœ€è¦æ‰‹åŠ¨å»è°ƒç”¨çš„ï¼Œæ‰€ä»¥è„‘å›¾å°±å•
ç‹¬å»ç»˜åˆ¶ã€‚
* effect.ts
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: file-effect
:END:

commit: [[https://github.com/gcclll/stb-vue-next/commit/3fc963486868ca3583b02852f07a5aa5969ac354][3fc963486868ca3583b02852f07a5aa5969ac354]]

å‡½æ•°åŠå˜é‡åˆ—è¡¨
| name                                | type             | desc                                                                              |
|-------------------------------------+------------------+-----------------------------------------------------------------------------------|
| ~activeEffect~                      | /ReactiveEffect/ | å½“å‰æ­£åœ¨å¤„ç†çš„ Effectï¼Œfn è¿˜æœªæ‰§è¡Œå®Œæˆï¼Œfinally è¿˜æ²¡ç»“æŸ                          |
| ~effectStack~                       | /Array, []/      | ç¼“å­˜æ‰€æœ‰çŠ¶æ€è¿˜æ²¡å®Œæˆçš„ Effect                                                     |
| ~shouldTrack~                       | /boolean, true/  | track() ä¸­ç”¨æ¥æ£€æµ‹å½“å‰ effect æ˜¯å¦ç»“æŸï¼Œä»è€Œåˆ¤å®šæ˜¯å¦å¯ä»¥ç»§ç»­æ‰§è¡Œ track() æ”¶é›†ä¾èµ– |
| ~trackStack~                        | /Array, []/      | ä¿å­˜ç€æ‰€æœ‰ Effect çš„ shouldTrack å€¼                                               |
| ~effect()~                          | /function/       | å°è£… fnæˆ ReactiveEffect ç»“æ„                                                     |
| ~track(target, type, key)~          | /function/       | æ”¶é›†ä¾èµ–ï¼Œå¹¶ä¸”å“åº”å¼é€’å½’                                                          |
| ~trigger(...)~                      | /function/       | å½“å€¼æ›´æ–°æ—¶è§¦å‘æ‰€æœ‰ä¾èµ–æ›´æ–°                                                        |
| ~createReactiveEffect(fn, options)~ | /function/       | effect() å‡½æ•°ä¸»é¢˜åŠŸèƒ½åˆ†ç¦»å‡ºæ¥                                                     |
| ~cleanup(effect: ReactiveEffect)~   | /function/       | æ¸…ç©ºæ‰€æœ‰ fn çš„ä¾èµ– effect.deps[]                                                  |
| ~enableTracking()~                  | /function/       | ä½¿èƒ½ Effect ï¼ŒshouldTrack = true, å¹¶å°†å…¶åŠ å…¥ trackStack                           |
| ~resetTracking()~                   | /function/       | é‡ç½® Effect, shouldTrack = ä¸Šä¸€ä¸ª Effect çš„ shouldTrack å€¼æˆ– true                 |

[[/img/vue3/reactivity/reactivity-effect.svg]]

ä¾èµ–å’Œå±æ€§å˜æ›´å‘ç”Ÿè”ç³»çš„æ¡¥æ¢æ¨¡å—ã€‚

1. ~effect(fn, options)~ å°è£…æ‰§è¡Œ fnï¼Œè§¦å‘å–å€¼æ“ä½œ ->
2. ~track(target, type, key)~ æ”¶é›†å¯¹è±¡åŠå±æ€§æ‰€æœ‰ä¾èµ– ->
3. fn ä¸­è®¾å€¼æ“ä½œè§¦å‘ ~trigger(...)~ æ‰§è¡Œæ‰€æœ‰ depsï¼Œæ›´æ–° DOMã€‚
   
** track(target, type, key)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-effect-track
:END:

*å‚æ•°åˆ—è¡¨* ï¼š
    - ~target~ : è¢«ä»£ç†çš„å¯¹è±¡
    - ~type~ : ä»£ç†æ“ä½œç±»å‹(~get/has/iterate~)
    - ~key~ : å–å€¼æ“ä½œæ—¶å¯¹åº”çš„å±æ€§å

*ä¸»è¦åŠŸèƒ½* ï¼šå®ç°ä¾èµ–æ”¶é›†

*å®ç°åŸç†* ï¼šç»“åˆ [[#fn-effect-effect][effect(fn, options)]]è§¦å‘ /get proxy handler/ é‡Œé¢æ‰§
è¡Œ ~track(target, type, key)~ å°†å½“å‰çš„ ~activeEffect~ æ”¶é›†åˆ° ~depsMap~ , æ‰€
ä»¥ ~activeEffect~ æ˜¯é“¾æ¥ä¾èµ–å‡½æ•°å’Œå±æ€§æ“ä½œçš„æ¡¥æ¢ï¼Œè¿™å°†æ˜¯æœªæ¥è®¾ç½®å€¼çš„æ—¶å€™è§¦å‘ä¾èµ–
çš„å‘½è„‰ã€‚


 #+begin_src typescript
    export function track(target: object, type: TrackOpTypes, key: unknown) {
    if (!shouldTrack || activeEffect === undefined) {
        return
    }

    // Map< obj -> Map<key, Set[...deps]> >
    let depsMap = targetMap.get(target)
    if (!depsMap) {
        // åˆå§‹åŒ–
        targetMap.set(target, (depsMap = new Map()))
    }

    let dep = depsMap.get(key)
    if (!dep) {
        depsMap.set(key, (dep = new Set()))
    }

    // æ­£åœ¨è¯·æ±‚æ”¶é›†çš„ effect ï¼Œæ˜¯åˆæ¬¡å‡ºç°
    if (!dep.has(activeEffect)) {
        dep.add(activeEffect)
        // è‡ªèº«ä¿å­˜ä¸€ä»½è¢«ä¾èµ–è€…åå•
        activeEffect.deps.push(dep)
        if (__DEV__ && activeEffect.options.onTrack) {
        activeEffect.options.onTrack({
            effect: activeEffect,
            target,
            type,
            key
        })
        }
    }
#+end_src

- targetMap ä¿å­˜æ‰€ä»¥ä¾èµ–å…³ç³»ï¼Œå­˜å‚¨å½¢å¼ï¼š ~Map<target -> Map<key,
     Set[...deps]>>~

- å‰é¢ä¸¤ä¸ª if æ£€æµ‹ä¾èµ–æ˜¯å¦æœ‰ç¼“å­˜ï¼Œé¿å…é‡å¤

- æœ€åä¸¤ä¸ª ~add~ æ“ä½œï¼Œä¸€ä¸ªæ˜¯æ‰‹æœºä¾èµ–ï¼Œä¸€ä¸ªè®©å½“å‰çš„ ~effect~ æŒæœ‰è‡ªå·±èº«çš„è¢«ä¾èµ–
  è€…åå•
** effect(fn, options)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-effect-effect
:END:

*å‚æ•°åˆ—è¡¨* ï¼š

    - ~fn~ ï¼šä¾èµ–å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸­å¯¹å¯¹è±¡å–å€¼ï¼Œè§¦å‘ track å°†å®ƒå°è£…åçš„
      ~ReactiveEffect~ æ”¶é›†åˆ°å–å€¼å±æ€§å¯¹åº”çš„ ~depsMap~ ä¸­
    - ~options~ : å…è®¸ä½¿ç”¨è€…æä¾›å¤–éƒ¨é€‰é¡¹ï¼Œæ§åˆ¶ effect è¡Œä¸ºï¼Œæ¯”å¦‚ï¼š ~lazy: true~
      å¯ä»¥æ§åˆ¶ effect æ˜¯å¦ä¼šç«‹å³æ‰§è¡Œï¼Œç«‹å³è§¦å‘ track ç­‰ä¸€ç³»åˆ—æ“ä½œã€‚

*ä¸»è¦åŠŸèƒ½* : å°è£…ä¾èµ–å‡½æ•°ï¼Œå¹¶ç«‹å³æ‰§è¡Œå®ƒï¼Œè§¦å‘ track æ”¶é›†ä¾èµ–ï¼Œä¸»è¦å®ç°è¿˜æ˜¯åœ¨
~createReactiveEffect(fn, options)~ ä¸­

#+begin_src typescript
export function effect<T = any>(
  fn: () => T,
  options: ReactiveEffectOptions = EMPTY_OBJ
): ReactiveEffect<T> {
  if (isEffect(fn)) {
    fn = fn.raw // å–å‡ºåŸå§‹çš„å‡½æ•°ï¼Œå°è£…ä¹‹å‰çš„
  }

  // å°è£…æˆ ReactiveEffect
  const effect = createReactiveEffect(fn, options)

  if (!options.lazy) {
    // å¦‚æœå¹¶æ²¡æŒ‡å®š lazy: true é€‰é¡¹ï¼Œåˆ™ç«‹å³æ‰§è¡Œ effect æ”¶é›†ä¾èµ–
    // å› ä¸º effect ä¸€èˆ¬éƒ½ä¼šæœ‰å–å€¼æ“ä½œï¼Œæ­¤æ—¶ä¼šè§¦å‘ proxy get handler
    // ç„¶åæ‰§è¡Œ track() ç»“åˆå½“å‰çš„ activeEffect å³ effect() æ‰§è¡Œæ—¶å€™çš„è¿™ä¸ª
    // effectï¼Œè¿™æ ·å–å€¼æ“ä½œå°±å’Œå½“å‰å–å€¼ä½œç”¨åŸŸä¸‹çš„ä¾èµ–å‡½æ•°å»ºç«‹çš„ä¾èµ–å…³ç³»
    effect()
  }
  return effect

#+end_src

** createReactiveEffect(fn, options)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-effect-createReactiveEffect
:END:

*å‚æ•°åˆ—è¡¨* ï¼šæ²¿ç”¨ [[#fn-effect-effect][effect(fn, options)]]

*ä¸»è¦åŠŸèƒ½* ï¼šå°† fn å°è£…æˆ ~ReactiveEffect~ å‡½æ•°

    #+begin_src typescript
    export interface ReactiveEffect<T = any> {
        (): T // effectå‡½æ•°ä¸»é¢˜
        _isEffect: true // æ ‡è®°è‡ªèº«æ˜¯ä¸æ˜¯ä¸€ä¸ª ReactiveEffect ç±»å‹
        id: number // uid++ è€Œæ¥ï¼Œå…¨å±€çš„ä¸€ä¸ªç›¸å¯¹å”¯ä¸€çš„ id
        active: boolean // è®°å½•å½“å‰çš„ effect æ˜¯ä¸æ˜¯æ¿€æ´»çŠ¶æ€
        raw: () => T // å°è£…ä¹‹å‰çš„é‚£ä¸ª fn
        deps: Array<Dep> // fn çš„è¢«ä¾èµ–è€…åˆ—è¡¨
        options: ReactiveEffectOptions // é¢å¤–é€‰é¡¹ï¼Œå¦‚ï¼šlazy
        allowRecurse: boolean // ???
    }
    #+end_src

*è§£å†³é—®é¢˜* :

    1. fn å°è£…ä¹‹åï¼Œæ‰§è¡Œ fn è¿‡ç¨‹ä¸­ä½¿ç”¨ try...finally ï¼Œé˜²æ­¢ fn æ‰§è¡Œå¼‚å¸¸å¯¼è‡´
       effect è¿›ç¨‹ä¸­æ–­
    2. ç»“åˆ shouldTrack, activeEffect å’Œ track() å‡½æ•°ï¼Œæœ‰æ•ˆçš„é¿å…äº†åœ¨ fn ä¸­æ‰§è¡Œ
       obj.value++ å¯¼è‡´ effect æ­»å¾ªç¯é—®é¢˜ï¼Œå› ä¸º try...finally ç¡®ä¿äº†åªæœ‰ fn å‡½æ•°
       å®Œæˆä¹‹åæ‰ä¼šè¿›å…¥ finally æ¢å¤ effect çŠ¶æ€(~shouldTrack = true,
       activeEffect = last || null~)ã€‚

#+begin_src typescript
function createReactiveEffect<T = any>(
  fn: () => T,
  options: ReactiveEffectOptions
): ReactiveEffect<T> {
  // å°† fn æ‰§è¡Œå°è£…æˆ  ReactiveEffect ç±»å‹çš„å‡½æ•°
  const effect = function reactiveEffect(): unknown {
    if (!effect.active) {
      // éæ¿€æ´»çŠ¶æ€ï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨è°ƒç”¨äº† stop
      // é‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™å°±éœ€è¦è€ƒè™‘è°ƒç”¨ stop è€…æ˜¯å¦æä¾›äº†æ‰‹åŠ¨è°ƒåº¦è¯¥ effect
      // çš„å‡½æ•° scheduler ? ä¹Ÿå°±æ˜¯è¯´ä½ åœæ­¢ä½ å¯ä»¥é‡æ–°å¯åŠ¨
      return options.scheduler ? undefined : fn()
    }

    if (!effectStack.includes(effect)) {
      // 1. cleanup, ä¿æŒçº¯å‡€
      cleanup(effect)
      try {
        // 2. ä½¿å…¶ tracking çŠ¶æ€æœ‰æ•ˆï¼Œtrack() ä¸­æœ‰ç”¨
        enableTracking() // track() å¯ä»¥æ‰§è¡Œæ”¶é›†æ“ä½œ
        effectStack.push(effect) // effect å…¥æ ˆ
        // 3. ä¿å­˜ä¸ºå½“å‰çš„ activeEffect, track() ä¸­æœ‰ç”¨
        activeEffect = effect // è®°å½•å½“å‰çš„ effect -> track/trigger
        // 4. æ‰§è¡Œ fn å¹¶è¿”å›ç»“æœ
        return fn() // è¿”å›æ‰§è¡Œç»“æœ
      } finally {
        // å§‹ç»ˆéƒ½ä¼šæ‰§è¡Œï¼Œé¿å…å‡ºç°å¼‚å¸¸å°† effect è¿›ç¨‹å¡æ­»
        // 5. å¦‚æœæ‰§è¡Œå¼‚å¸¸ï¼Œä¸¢å¼ƒå½“å‰çš„ effect ï¼Œå¹¶å°†çŠ¶æ€é‡ç½®ä¸ºä¸Šä¸€ä¸ª effect
        //   ç”±ä¸€ä¸ª effect æ ˆæ¥ç»´æŠ¤ã€‚

        effectStack.pop()
        resetTracking()
        activeEffect = effectStack[effectStack.length - 1]
      }
    }
  } as ReactiveEffect

  effect.id = uid++
  effect.allowRecurse = !!options.allowRecurse
  effect._isEffect = true
  effect.active = true
  effect.raw = fn // è¿™é‡Œä¿å­˜åŸå§‹å‡½æ•°å¼•ç”¨
  effect.deps = []
  effect.options = options

  return effect

#+end_src
** effect -> track -> trigger å…³ç³»å›¾
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: effect-track-trigger
:END: 

[[/img/vue3/reactivity/reactivity-effect-track-trigger.svg]]
** æµ‹è¯•
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: effect-test
:END: 

*** effect + track å®Œæˆä¾èµ–æ”¶é›†
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: effect-test-01
:END: 

ä¸Šé¢ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½• ~reactive~ ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åé€šè¿‡ ~effect~ æ¥å°è£…æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ª
å‡½æ•°é‡Œé¢å»å–å€¼å’Œè®¾å€¼æ“ä½œï¼Œä»è€Œåˆ†åˆ«è§¦å‘ [[#fn-effect-track][track()]] å’Œ [[#fn-effect-trigger][trigger()]] æ”¶é›†ä¾èµ–å’Œè§¦å‘æ›´æ–°ã€‚

~trigger()~ è¿˜æ²¡å®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œåªèƒ½æ¼”ç¤º track å’Œ effect åŠŸèƒ½ã€‚

#+begin_src js
var effect = VueReactivity.effect
var reactive = VueReactivity.reactive
var counter = reactive({ count: 0 })

var $el = $("#_effect_test_01")

var exec = effect(
    function fn() {
    var c = counter.count++
    $el.find(".result").append('<p>ç¬¬ ' + c + ' æ¬¡å–å€¼æ“ä½œ...</p>')
    }, { lazy: true }
)
$el.children(".getval").click(function() {
    exec()
})
$el.children(".reset").click(function() {
    $el.children(".result").html('')
})

#+end_src
ä¸ºäº†æ›´ç›´è§‚çš„çœ‹åˆ°æ”¶é›†åŠ¨ä½œï¼Œå¯ä»¥é€šè¿‡å¢åŠ æŒ‰é’®æ¥ç»“åˆ effect options çš„ lazy é€‰é¡¹ï¼Œæ¥æ‰‹åŠ¨è§¦å‘ ~effect()~

#+begin_export html
<body>
<div id="_effect_test_01">
<button class="getval">ç‚¹æˆ‘è§¦å‘å–å€¼æ“ä½œï¼</button>
<button class="reset">é‡ç½®</button>
<div class="result"></div>
<code></code>
</div>
</body>
<script>
setTimeout(function test() {
    if (typeof $ === 'undefined') return
    
    var effect = VueReactivity.effect
    var reactive = VueReactivity.reactive
    var counter = reactive({ count: 0 })
    
    var $el = $("#_effect_test_01")
    
    var exec = effect(
      function fn() {
        var c = counter.count++
        $el.find(".result").append('<p>ç¬¬ ' + c + ' æ¬¡å–å€¼æ“ä½œ...</p>')
      }, { lazy: true }
    )
    $el.children(".getval").click(function() {
      exec()
    })
    $el.children(".reset").click(function() {
      $el.children(".result").html('')
    })

}, 1000)
    
</script>
#+end_export

debugger:
#+begin_example
e: {count: 0} // counter å¯¹è±¡
i: Set(1) // "count" å±æ€§çš„ä¾èµ–å‡½æ•° targetMap -> depsMap -> deps
    > [[Entries]]
        // 0 -> effect(fn) -> fn è¢«å°è£…ä¹‹åçš„ç»“æœ
        > 0: function(){if(!n.active)return t.scheduler?void 0:e();if(!i.includes(n)){!function(e){const{deps:t}=e;if(t.length){for(let n=0;n<t.length;n++)t[n].delete(e);t.length=0}}(n);try{return f(),i.push(n),o=n,e()}finally{i.pop(),l(),o=i[i.length-1]}}}
        > size: 1
depsMap: Map(1) // counter å¯¹è±¡çš„å±æ€§ä¾èµ–å¯¹åº”å…³ç³» targetMap -> depsMap { key => Set[...deps] }
    > [[Entries]]
        > 0: {"count" => Set(1)}
        > size: 1

// Closure éƒ¨åˆ†
targetMaps: WeakMap
   > [[Entries]]
   > 0: {Object => Map(1)}
        > key: {count: 0}
        > value: Map(1) {"count" => Set(1)}
#+end_example

* å®Œæ•´è„‘å›¾
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: whole-mind-map
:END:

[[/img/vue3/reactivity/reactivity.svg]]
