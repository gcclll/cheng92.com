#+TITLE: Vue3 æºç å¤´è„‘é£æš´ä¹‹â˜reactivity
#+DATE: <2020-11-09 11:45:36>
#+TAGS[]: vue, vue3, compiler-core, parser, compiler
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent shrink

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

* TODO Proxy & Reflect åŠŸèƒ½å›é¡¾

[[/post/javascript-apis/#api-proxy-reflect][Proxy å’Œ Reflect ç›¸å…³çš„ Apis ä¼ªç å’Œè¯´æ˜è¿æ¥ ğŸ›«]]

* Reactivity
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: rt
:END:

vue-next æœ€æ–°çš„å“åº”å¼åŸç† ~Proxy + Reflect~ ã€‚

[[#while-mind-map][ç”±äºå®Œæ•´è„‘å›¾ä¼šæ¯”è¾ƒå…¨è€Œå¤§æ‰€ä»¥æ”¾åˆ°æ–‡å­—æœ€åå»ã€‚ã€‚ã€‚]]

[[/img/vue3/reactivity/reactivity.svg][ä¹Ÿå¯ä»¥ç‚¹å‡»è¯¥é“¾æ¥ç›´æ¥æ–°çª—å£æ‰“å¼€ï¼Œæ•ˆæœæ›´ä½³ã€‚]]

* reactivity(target)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-rt
:END:

commit: [[https://github.com/gcclll/stb-vue-next/commit/cb3470d7c3f2944fd23e9155fc8a6afb7a51a732][cb3470d7c3f2944fd23e9155fc8a6afb7a51a732]]

è¯¥å‡½æ•°æ˜¯ä½œä¸ºå“åº”å¼æ¨¡å—çš„å…¥å£å‡½æ•°ï¼Œä¸€ä¸ªéå¸¸ç®€å•çš„å¤„ç†å‡½æ•°ï¼š

1. åªè¯»ä»£ç†ï¼Œç›´æ¥è¿”å›è¯¥å¯¹è±¡
2. å¦åˆ™è°ƒç”¨ [[#rt-cro][createReactiveObject(...args)]]

[[/img/vue3/reactivity/reactivity-reactive.svg]]

#+begin_src typescript
export function reactive(target: object) {
  // å¦‚æœè¯•å›¾ observe ä¸€ä¸ªåªè¯» proxyï¼Œè¿”å›åªè¯»ç‰ˆæœ¬
  if (target && (target as Target)[ReactiveFlags.IS_READONLY]) {
    return target
  }

  return createReactiveObject(
    target,
    false,
    {},
    // mutableHandlers,
    {}
    // mutableCollectionHandlers
  )
#+end_src

*mutableHandlers*: æ™®é€šå¯¹è±¡ç±»å‹çš„ proxy handlers

*mutableCollectionHandlers*: é›†åˆç±»å‹çš„ proxy handlersï¼Œå› ä¸º ~Reflect~ å¹¶æ²¡æœ‰å¯¹é›†
åˆç±»å‹åšåº•å±‚æ˜ å°„ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚
* createReactiveObject(...args)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: fn-cro
:END:

commit: [[https://github.com/gcclll/stb-vue-next/commit/443a0b5920efaf714de08b0975c17f1d652815e4][443a0b5920efaf714de08b0975c17f1d652815e4]]

è„‘å›¾ï¼š
[[/img/vue3/reactivity/reactivity-create-reactive-object.svg]]

#+begin_src typescript

function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>
) {
  if (!isObject(target)) {
    if (__DEV__) {
      console.warn(`value cannot be made reactive: ${String(target)}`)
    }

    return target
  }

  // target å·²ç»æ˜¯ Proxyï¼Œä¸ç”¨é‡å¤ä»£ç†
  // å¼‚å¸¸æƒ…å†µï¼šåœ¨ä¸€ä¸ª reactive object ä¸Šè°ƒç”¨ readonly()
  if (
    target[ReactiveFlags.RAW] &&
    !(isReadonly && target[ReactiveFlags.IS_REACTIVE])
  ) {
    return target
  }

  // ä»£ç†ç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥å–å·²ç¼“å­˜çš„
  const proxyMap = isReadonly ? readonlyMap : reactiveMap
  const existingProxy = proxyMap.get(target)
  if (existingProxy) {
    return existingProxy
  }

  // åªæœ‰åˆæ³•çš„ç±»å‹(Object|Array|[Weak]Map|[Weak]Set)æ‰èƒ½è¢«ä»£ç†
  const targetType = getTargetType(target)
  if (targetType === TargetType.INVALID) {
    return target
  }

  const proxy = new Proxy(
    target,
    targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers
  )

  // ç¼“å­˜ä»£ç†æ˜ å°„å…³ç³»
  proxyMap.set(target, proxy)
  return proxy
#+end_src
* mutableHandlers

:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hm
:END:

é’ˆå¯¹éé›†åˆå‹å¯¹è±¡è€Œè¨€ï¼Œç»“åˆ ~Reflect~ æ„å»º Proxy çš„ handlersã€‚

** get handler
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hm-get
:END:

*** only get proxy
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: hm-get-proxy
:END:


commit: [[https://github.com/gcclll/stb-vue-next/commit/598e047407fe52183468037beb45328878431a55][598e047407fe52183468037beb45328878431a55]]

ä¸»è¦æ›´æ–°ä»£ç ï¼š
#+begin_src typescript

function createGetter(isReadonly = false, shallow = false) {
  // target: è¢«å–å€¼çš„å¯¹è±¡ï¼Œkey: å–å€¼çš„å±æ€§ï¼Œreceiver: this çš„å€¼
  return function get(target: Target, key: string | symbol, receiver: object) {
    // TODO 1. key is reactive
    // TODO 2. key is readonly
    // TODO 3. key is the raw target

    // TODO 4. target is array

    const res = Reflect.get(target, key, receiver)

    // TODO 5. key is symbol, or `__protot__ | __v_isRef`

    // TODO 6. not readonly, need to track and collect deps

    // æ˜¯å¦åªéœ€è¦ reactive ä¸€çº§å±æ€§(ä¸é€’å½’ reactive)
    if (shallow) {
      return res
    }

    // TODO 6. res isRef

    // TODO 7. res is object -> reactive recursivly

    return res
  }
#+end_src

è¿™é‡Œå€¼ä¿ç•™çš„æœ€ç®€å•çš„ä»£ç†éƒ¨åˆ†ã€‚
* å®Œæ•´è„‘å›¾
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: whole-mind-map
:END:

[[/img/vue3/reactivity/reactivity.svg]]
