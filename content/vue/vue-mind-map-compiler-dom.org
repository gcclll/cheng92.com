#+TITLE: Vue3 æºç å¤´è„‘é£æš´ä¹‹ 4 â˜compiler-dom
#+DATE: <2020-12-16 19:39:26>
#+TAGS[]: vue, vue3, compiler-dom
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent shrink

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

@@html:<kbd>@@
*[[https://github.com/gcclll/stb-vue-next][stb-vue-next]] å®Œå…¨æ‹·è´äº [[https://github.com/vuejs/vue-next][vue-next]] ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚*
@@html:</kbd>@@

#+begin_quote
*å£°æ˜* ï¼švue-next compiler-dom æ¨¡å—
*è°ƒè¯•* ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å¯é€šè¿‡ ~<F12>~ æ§åˆ¶å°æŸ¥çœ‹

*æ›´æ–°æ—¥å¿—&Todos* ï¼š
1. [2020-12-16 19:40:21] åˆ›å»º
2. [2020-12-19 13:01:02] å®Œæˆ
3. TODO å®Œå–„æµ‹è¯•ç”¨ä¾‹
#+end_quote

#+begin_export html
<script src="/js/vue/compiler-dom.global.js"></script>
<script src="/js/utils.js"></script>
<script>
i = 0, j = 0
const { compile: compile2, parse } = VueCompilerDOM
const compile = (tpl, title, logAst = false) => {
    l2(title)
    const { code, ast } = compile2(tpl, {
        onError: (e) => console.warn(e.message),
        hoistStatic: true,
        ...( compile.options || {} )
    })

    log.gray(tpl)
    log([code])
    logAst && log(typeof logAst === 'function' ? logAst(ast) : ast)
    return ast
}
const c = (tpl, desc, fn) => compile(tpl, desc, fn || (ast => ast.codegenNode))
</script>
#+end_export

* 0062974 compiler-domæ¨¡å—åˆå§‹åŒ–
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: init
:END: 

[[https://github.com/gcclll/stb-vue-next/commit/0062974d50531aa5e51f229968fd582d567a090c][feat(init): compiler-dom Â· gcclll/stb-vue-next@0062974]]

æ—¥å¸¸æ“ä½œå…ˆ copyï¼šå…ˆå°† /vue-next/packages/compiler-dom// ä¸‹é¢çš„å†…å®¹æ‹·è´è¿‡æ¥ï¼Œåˆ é™¤ src ç›®å½•ä¸‹çš„æ‰€æœ‰ä»£
ç ã€‚

äº†è§£ç›®å½•ç»“æ„ï¼š

#+begin_example
â•°â”€$ tree -C -I 'dist|__tests__'
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ api-extractor.json
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â””â”€â”€ src
    â”œâ”€â”€ decodeHtml.ts
    â”œâ”€â”€ decodeHtmlBrowser.ts
    â”œâ”€â”€ errors.ts
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ namedChars.json
    â”œâ”€â”€ parserOptions.ts
    â”œâ”€â”€ runtimeHelpers.ts
    â””â”€â”€ transforms
        â”œâ”€â”€ ignoreSideEffectTags.ts
        â”œâ”€â”€ stringifyStatic.ts
        â”œâ”€â”€ transformStyle.ts
        â”œâ”€â”€ vHtml.ts
        â”œâ”€â”€ vModel.ts
        â”œâ”€â”€ vOn.ts
        â”œâ”€â”€ vShow.ts
        â”œâ”€â”€ vText.ts
        â””â”€â”€ warnTransitionChildren.ts

2 directories, 21 files
#+end_example

åŠŸèƒ½é¢„è§ˆï¼š

1. ~ignoreSideEffectTags.ts~ å¿½ç•¥æ¨¡æ¿ä¸­çš„ ~style, script~ æ ‡ç­¾
2. ~stringifyStatic.ts~ å¯¹é™æ€æå‡åšçš„ä¸€äº›å¤„ç†
3. ~transformStyle.ts~ å°†é™æ€ style å±æ€§è½¬æˆæŒ‡ä»¤ç±»å‹å±æ€§ï¼Œä¸”å°†å†…å®¹è½¬æˆå¯¹è±¡

   å¦‚ï¼š ~<div style="color:red" />~ ä¼šè½¬æˆï¼š

   #+begin_src js
   _createBlock('div', {
     style: { color: "red" }
   }, null, 1 /* TEXT */)
   #+end_src
4. ~vHtml.ts~ å°† v-html è¡¨è¾¾å¼è½¬æˆ ~innerHTML~ å†…å®¹
5. ~vModel.ts~ å¤„ç† ~<input>~ ç±»å‹ï¼Œåˆ é™¤ ~modelValue: value~ å±æ€§ï¼Œä¸å…è®¸æœ‰å‚æ•°
6. ~vOn.ts~  äº‹ä»¶ä¿®é¥°ç¬¦å¤„ç†, è¯¦æƒ…è¯·æŸ¥[[#v-on][ç›¸å…³ç« èŠ‚ >>>]] 

   åˆ†ä¸ºä¸‰ç±»ï¼š
   - äº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦ ~passive, capture, once~ ä¼šè¢«è§£æåˆ°äº‹ä»¶ååé¢

     å¦‚ï¼š ~<div @click.capture.once="i++" />~ ç»“æœï¼š
     #+begin_src js
     _createBlock('div', {
       'onClickCaptureOnce': $event => (i++)
     }, null, 40 /* PROPS, HYDRATE_EVENTS */, ["onClickCaptureOnce"])
     #+end_src

   - é”®ç›˜ç±»äº‹ä»¶(~onkeydown,onkeyup,onkeypress~)ä¿®é¥°ç¬¦ ~~

   - ç³»ç»ŸæŒ‰é”®ç±»å‹ä¿®é¥°ç¬¦(~ctrl,alt,shift,meta,exact~)ï¼Œæ•è·å†’æ³¡(~stop,prevent,self~)ï¼Œé¼ 
     æ ‡(~middle,left,right~)
7. ~vShow.ts~ é’ˆå¯¹ v-show æŒ‡ä»¤ï¼Œè¿™ä¸ªå¯èƒ½éœ€è¦åœ¨ runtime æœŸé—´å¤„ç†
8. ~vText.ts~ v-text æŒ‡ä»¤çš„å¤„ç†ï¼Œå°†è¡¨è¾¾å¼å†…å®¹è§£ææˆ ~textContent~ å±æ€§å†…å®¹
9. ~warnTransitionChildren.ts~ æ–‡ä»¶æ˜¯é’ˆå¯¹ ~<transition>~ å†…ç½®æ ‡ç­¾çš„æ£€æµ‹ï¼Œå®ƒçš„å­©
   å­èŠ‚ç‚¹åªèƒ½æœ‰ä¸€ä¸ª
10. ~decodeHtml[Browser].ts~ æ˜¯ç”¨æ¥å¤„ç† html ç¬¦å·è¯­ä¹‰åŒ–çš„ï¼Œåˆ†åˆ«æ˜¯ NODE ç¯å¢ƒå’Œæµè§ˆå™¨ç¯
    å¢ƒçš„å¤„ç†é€»è¾‘
11. ~parserOptions.ts~ é’ˆå¯¹ compiler-core çš„é€‰é¡¹åšäº†è¿›ä¸€æ­¥æ‰©å±•(namespace, native
    tag, decodeEntities ç­‰)
     

* 4fa13bf init parse + compile function

[[https://github.com/gcclll/stb-vue-next/commit/4fa13bfe57f414f158041122119096f3fb8a859d][feat(init): compiler-dom index.ts> compile + parse function Â· gcclll/stb-vue-next@4fa13bf]]

åˆå§‹åŒ–ç¼–è¯‘å’Œè§£æå‡½æ•°ï¼Œå¯¹åº”ç€ compile-core çš„ ~baseCompile~ å’Œ ~baseParse~ å‡½æ•°ã€‚

å³ï¼š compiler-dom æ˜¯é’ˆå¯¹ compiler-core çš„è¿›ä¸€æ­¥å°è£…å¤„ç†ï¼Œä¼ é€’ä¸€äº› ~transformXxx~
å‡½æ•°ï¼Œè‡³äºè¿™äº›å‡½æ•°åšäº†ä»€ä¹ˆå¤„ç†ï¼Œéœ€è¦ä¸‹é¢ä¸€æ­¥æ­¥æ¥æ­å¼€ã€‚

compile :
#+begin_src typescript
export function compile(
  template: string,
  options: CompilerOptions
): CodegenResult {
  return baseCompile(
    template,
    extend({}, parserOptions, {
      nodeTransforms: [],
      directiveTransforms: extend({}),
      // é™æ€æå‡ transform
      transformHoist: __BROWSER__ ? null : stringifyStatic
    })
  )
}
#+end_src

parse:
#+begin_src typescript
export function parse(template: string, options: ParserOptions = {}): RootNode {
  return baseParse(template, extend({}, parserOptions, options))
}
#+end_src

å…¶å®åˆ°è¿™é‡Œä¹Ÿæ˜¯åº”è¯¥å¯ä»¥æ‰§è¡Œçš„ï¼Œæ¥æµ‹è¯•ä¸‹ï¼š

#+begin_src js
const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code, ast } = compile(`<div>{{ test }}</div>`)
console.log(code, '\n>>> AST: \n', ast)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", null, _toDisplayString(test), 1 /* TEXT */))
  }
}
>>> AST:
 {
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: [Object]
    }
  ],
  codegenNode: {
    type: 13,
    tag: '"div"',
    props: undefined,
    children: { type: 5, content: [Object], loc: [Object] },
    patchFlag: '1 /* TEXT */',
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    loc: { start: [Object], end: [Object], source: '<div>{{ test }}</div>' }
  },
}
#+end_example

æ¥ä¸‹æ¥æ‰æ˜¯è¿›å…¥æ­£é¢˜ â›³...ğŸš„ğŸš„ğŸš„
* 8c86624 add transformStyle node transform

[[https://github.com/gcclll/stb-vue-next/commit/8c8662439d651e95f2036040e4d31f95dd52b836][feat: add transformStyle transform Â· gcclll/stb-vue-next@8c86624]]

ä½œç”¨æ˜¯å°† ~node.props~ é‡Œé¢çš„ ~style~ å†…è”å±æ€§è½¬æˆå¯¹è±¡ç±»å‹ã€‚

æ ¹æ®æ¡ä»¶ï¼Œè¿™é‡Œåªæ£€æµ‹é™æ€å±æ€§ï¼Œç„¶åå°†å…¶è½¬æˆ ~v-bind~ å‹çš„åŠ¨æ€å±æ€§ï¼Œå°†å†…è”è½¬æˆå¯¹è±¡ã€‚
#+begin_src typescript
export const transformStyle: NodeTransform = node => {
  if (node.type === NodeTypes.ELEMENT) {
    node.props.forEach((p, i) => {
      if (p.type === NodeTypes.ATTRIBUTE && p.name === 'style' && p.value) {
        // replace p with an expression node
        node.props[i] = {
          type: NodeTypes.DIRECTIVE,
          name: `bind`,
          arg: createSimpleExpression(`style`, true, p.loc),
          exp: parseInlineCSS(p.value.content, p.loc),
          modifiers: [],
          loc: p.loc
        }
      }
    })
  }
}
#+end_src

å†…è”è½¬å¯¹è±¡è§£æå‡½æ•°ï¼š ~parseInlineCSS~

#+begin_src typescript
const parseInlineCSS = (
  cssText: string,
  loc: SourceLocation
): SimpleExpressionNode => {
  const normalized = parseStringStyle(cssText)
  return createSimpleExpression(
    JSON.stringify(normalized),
    false,
    loc,
    ConstantTypes.CAN_STRINGIFY
  )
}
#+end_src

~parseStringStyle~ å¤„ç†å…¶å®å°±æ˜¯ä»¥ ~;~ ä¸ºåˆ†éš”ç¬¦ï¼Œå°† ~name:value~ åˆ†å‰²å‡ºæ¥ï¼Œè§£æå‡º
~name~ å’Œ ~value~ ç»„æˆå¯¹è±¡ã€‚

æµ‹è¯•ï¼š
#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code } = compile(`<div style="color:red;font-size:30px;">{{ text }}</div>`)
console.log(code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", { style: {"color":"red","font-size":"30px"} }, _toDisplayString(text), 1 /* TEXT */))
  }
}
undefined
#+end_example

* 7ea8dfe add v-html transform

[[https://github.com/gcclll/stb-vue-next/commit/7ea8dfe5c57ec712fe7f87d2fcce7320aa0f2560][feat: add transform v-html Â· gcclll/stb-vue-next@7ea8dfe]]

v-html æŒ‡ä»¤è½¬æ¢ã€‚

ä»£ç å¾ˆç®€å•ï¼š
#+begin_src typescript

export const transformVHtml: DirectiveTransform = (dir, node, context) => {
  const { exp, loc } = dir
  if (!exp) {
    context.onError(
      createDOMCompilerError(DOMErrorCodes.X_V_HTML_NO_EXPRESSION, loc)
    )
  }

  if (node.children.length) {
    context.onError(
      createDOMCompilerError(DOMErrorCodes.X_V_HTML_WITH_CHILDREN, loc)
    )
    node.children.length = 0
  }

  return {
    props: [
      createObjectProperty(
        createSimpleExpression(`innerHTML`, true, loc),
        exp || createSimpleExpression('', true)
      )
    ]
  }
}
#+end_src

å…¶å®å°±æ˜¯é’ˆå¯¹ ~v-html~ å°†å…¶è½¬æˆ ~innerHTML~ åŠ¨æ€å±æ€§ï¼Œæ£€æµ‹ä¸¤ä¸ªä¸åˆæ³•ä½¿ç”¨æƒ…å†µ
1. æ²¡æœ‰è¡¨è¾¾å¼
2. åŒ…å«å­©å­èŠ‚ç‚¹

æµ‹è¯•ï¼š
#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const _c = tpl => compile(tpl, {
  onError: e => console.log(`é”™è¯¯æè¿°ï¼š` + e.message)
}).code
console.log(_c(`<div v-html="test"/>`))
console.log(`>>> v-html ä¸‹ä¸èƒ½æœ‰ä»»ä½•å­©å­èŠ‚ç‚¹`)
console.log(_c(`<div v-html="test">hello</div>`))
console.log(`>>> v-html ä¸èƒ½æ²¡æœ‰è¡¨è¾¾å¼`)
console.log(_c(`<div v-html></div>`))
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", { innerHTML: test }, null, 8 /* PROPS */, ["innerHTML"]))
  }
}
>>> v-html ä¸‹ä¸èƒ½æœ‰ä»»ä½•å­©å­èŠ‚ç‚¹
é”™è¯¯æè¿°ï¼šv-html will override element children.
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", { innerHTML: test }, null, 8 /* PROPS */, ["innerHTML"]))
  }
}
>>> v-html ä¸èƒ½æ²¡æœ‰è¡¨è¾¾å¼
é”™è¯¯æè¿°ï¼šv-html is missing expression.
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", { innerHTML: "" }))
  }
}
undefined
#+end_example

1. è¿™é‡Œ v-html å±æ€§ä¼šè¢«è§£ææˆ ~node.props~ é‡Œé¢åŠ¨æ€å±æ€§ï¼Œå±æ€§åä¸º ~innerHTML~ ã€‚

2. å¦‚æœæœ‰ ~v-html~ æŒ‡ä»¤æ˜¯è¯¥ç»„ä»¶ä¸‹é¢å°±ä¸èƒ½æœ‰ä»»ä½•å­©å­èŠ‚ç‚¹
* 4f3a4ee add v-text transform

[[https://github.com/gcclll/stb-vue-next/commit/4f3a4eeec6394537b38587a47d3ac948155d1995][feat(add): v-text transform Â· gcclll/stb-vue-next@4f3a4ee]]

v-text æŒ‡ä»¤è½¬æ¢å‡½æ•°ï¼Œè½¬æˆå±æ€§ä¸º ~textContent~ ã€‚

ä»£ç :
#+begin_src typescript

export const transformVText: DirectiveTransform = (dir, node, context) => {
  const { exp, loc } = dir

  if (!exp) {
    context.onError(
      createDOMCompilerError(DOMErrorCodes.X_V_TEXT_NO_EXPRESSION, loc)
    )
  }

  if (node.children.length) {
    context.onError(
      createDOMCompilerError(DOMErrorCodes.X_V_TEXT_WITH_CHILDREN, loc)
    )

    node.children.length = 0
  }

  return {
    props: [
      createObjectProperty(
        createSimpleExpression(`textContent`, true),
        exp
          ? createCallExpression(
              context.helperString(TO_DISPLAY_STRING),
              [exp],
              loc
            )
          : createSimpleExpression('', true)
      )
    ]
  }
}
#+end_src

æµ‹è¯•ï¼š
#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const c = tpl => compile(tpl, {
  onError: e => console.log(`é”™è¯¯æè¿°: ${e.message}`)
}).code

console.log(c(`<div v-text="test"/>`))
console.log(`>>> åŒ…å«å­©å­èŠ‚ç‚¹`)
console.log(c(`<div v-text="test">hello</div>`))
console.log(`>>> æ— è¡¨è¾¾å¼`)
console.log(c(`<div v-text></div>`))
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", {
      textContent: _toDisplayString(test)
    }, null, 8 /* PROPS */, ["textContent"]))
  }
}
>>> åŒ…å«å­©å­èŠ‚ç‚¹
é”™è¯¯æè¿°: v-text will override element children.
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", {
      textContent: _toDisplayString(test)
    }, null, 8 /* PROPS */, ["textContent"]))
  }
}
>>> æ— è¡¨è¾¾å¼
é”™è¯¯æè¿°: v-text is missing expression.
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", { textContent: "" }))
  }
}
undefined
#+end_example
* 588d5f1 add v-model transform

v-model æŒ‡ä»¤è½¬æ¢ã€‚

åœ¨å®Œæˆ v-model æŒ‡ä»¤è½¬æ¢ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹ compiler-core é‡Œé¢çš„ v-model å¤„ç†çš„æœ€åç»“
æœæ˜¯ä»€ä¹ˆâ“

#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code } = compile(`<input v-model:value="result" />`)
console.log(code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("input", {
      value: result,
      "onUpdate:value": $event => (result = $event)
    }, null, 40 /* PROPS, HYDRATE_EVENTS */, ["value","onUpdate:value"]))
  }
}
undefined
#+end_example

ç»“æœæ˜¾ç¤ºï¼šv-model æœ€ç»ˆè½¬æˆäº†ä¸¤ä¸ªå±æ€§

~{ value: result, "onUpdate:value": $event => (result = $event)}~

è¿™ä¸ªåŸç†åº”è¯¥æ˜¯è¿™æ ·ï¼š è¾“å…¥æ¡†å†…å®¹ç»‘å®š ~result~ ï¼Œå½“è¾“å…¥æ¡†å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘
~onUpdate:value~ äº‹ä»¶ï¼Œæ‰§è¡Œè¯¥å‡½æ•°é‡æ–°å¤åˆ¶ ~result~ å˜æ›´æ•°æ®ã€‚ 


åŠ ä¸Š compiler-dom é˜¶æ®µçš„ v-model transform ä¹‹åï¼š
[[https://github.com/gcclll/stb-vue-next/commit/588d5f1d088ad48a71fa89a3070a1ad58666f431][feat(add): v-model transform Â· gcclll/stb-vue-next@588d5f1]]

#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code } = compile(`<input v-model="result" />`)
console.log(code)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { vModelText : _vModelText, createVNode : _createVNode, withDirectives : _withDirectives, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock("input", {
      "onUpdate:modelValue": $event => (result = $event)
    }, null, 8 /* PROPS */, ["onUpdate:modelValue"])), [
      [_vModelText, result]
    ])
  }
}
undefined
#+end_example


å˜åŒ–ï¼š
1) ä¸æ”¯æŒå‚æ•°äº†
2) åˆ é™¤äº† ~value: result~ å±æ€§(é»˜è®¤æ˜¯ ~modelValue~)ã€‚
3) ç”¨ ~_withDirectives~ å°† ~<input>~ åŒ…èµ·æ¥äº†

   è¿™ä¸ªå‡½æ•°å®šä¹‰æ˜¯åœ¨ ~runtime-core~ é‡Œé¢å®šä¹‰äº†ï¼Œä½œç”¨å°±æ˜¯å°† ç¬¬äºŒä¸ªå‚æ•° ~[
   [_vModelText, result] ]~ é‡Œé¢çš„æŒ‡ä»¤å¡åˆ° ~vnode.dirs~ æŒ‡ä»¤é›†ä¸­å»ã€‚


ä»£ç :
#+begin_src typescript

export const transformModel: DirectiveTransform = (dir, node, context) => {
  const baseResult = baseTransform(dir, node, context)
  // base transform has errors OR component v-model (only need props)
  // æ²¡æœ‰ v-modelæŒ‡ä»¤ï¼Œæˆ–åº”ç”¨åœ¨ç”¨æˆ·ç»„ä»¶ä¸Šäº†
  if (!baseResult.props.length || node.tagType === ElementTypes.COMPONENT) {
    return baseResult
  }

  // ä¸èƒ½æœ‰å‚æ•°ï¼Ÿ
  if (dir.arg) {
    // ... æŠ¥é”™ï¼Œä¸èƒ½æœ‰å‚æ•°ï¼Œå³å¿…é¡»æ˜¯ ~v-model="xxx"~ æ¥ä½¿ç”¨
  }

  // ä¸èƒ½æœ‰ value å±æ€§ï¼Œå› ä¸º input ç»‘å®šçš„å°±æ˜¯ value å±æ€§
  function checkDuplicateValue() {
    // ... è¿™é‡Œæ—¢æ˜¯æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ <input value="xx"> value å±æ€§
  }

  const { tag } = node
  const isCustomElement = context.isCustomElement(tag)
  if (
    tag === 'input' ||
    tag === 'textarea' ||
    tag === 'select' ||
    isCustomElement
  ) {
    let directiveToUse = V_MODEL_TEXT
    let isInvalidType = false
    if (tag === 'input' || isCustomElement) {
      const type = findProp(node, `type`)
      if (type) {
        if (type.type === NodeTypes.DIRECTIVE) {
          // :type='foo'
          directiveToUse = V_MODEL_DYNAMIC
        } else if (type.value) {
          switch (type.value.content) {
            case 'radio':
              directiveToUse = V_MODEL_RADIO
              break
            case 'checkbox':
              directiveToUse = V_MODEL_CHECKBOX
              break
            case 'file':
              isInvalidType = true
              // ERROR ä¸èƒ½ç”¨åœ¨ <file> æ ‡ç­¾ä¸Š
              break
            default:
              __DEV__ && checkDuplicateValue()
              break
          }
        }
      } else if (hasDynamicKeyVBind(node)) {
        // element has bindings with dynamic keys, which can possibly contain
        // "type".
        directiveToUse = V_MODEL_DYNAMIC
      } else {
        // text type
        __DEV__ && checkDuplicateValue()
      }
    } else if (tag === 'select') {
      directiveToUse = V_MODEL_SELECT
    } else {
      // textarea
      __DEV__ && checkDuplicateValue()
    }

    // inject runtime directive
    // by returning the helper symbol via needRuntime
    // the import will replaced a resolveDirective call.
    if (!isInvalidType) {
      baseResult.needRuntime = context.helper(directiveToUse)
    }
  } else {
    // v-model åº”ç”¨åˆ°ä¸åˆæ³•çš„å…ƒç´ ä¸Š
  }

  // native vmodel doesn't need the `modelValue` props since they are also
  // passed to the runtime as `binding.value`. removing it reduces code size.
  // æœ€åè¿‡æ»¤æ‰ modelValue: xxx å±æ€§
  baseResult.props = baseResult.props.filter(
    p =>
      !(
        p.key.type === NodeTypes.SIMPLE_EXPRESSION &&
        p.key.content === 'modelValue'
      )
  )
  return baseResult
}
#+end_src

æºç åˆ†æï¼š

1) åªå¤„ç† ~input, textarea, select~ æ–‡æœ¬æ¡†æ ‡ç­¾ï¼Œæˆ–è‡ªå®šä¹‰çš„æ ‡ç­¾
2) ~<input>~ æ ‡ç­¾ç±»å‹åˆ†ä¸º ~radio~ å’Œ ~checkbox~ å•å¤é€‰é¡¹æ¡†å¤„ç†ï¼Œä¸èƒ½ä½¿ç”¨
   ~type='file'~ ç±»å‹
3) ~<select>~ ä¸‹æ‹‰é€‰é¡¹æ¡†çš„å¤„ç†
4) è¿‡æ»¤æ‰ transform ä¹‹åçš„ ~{modelValue: value, 'onUpdate:value': $event =>
   value = $event}~ é‡Œé¢çš„ ~modelValueï¼švalue~ å±æ€§ï¼Œå› ä¸ºåœ¨ runtime-core æ—¶æœŸçš„
   ~withDirectives()~ å¤„ç†é‡Œé¢ä¼šè¢«ç»‘å®šåˆ° ~value~ å±æ€§ä¸Š
* a94aacd add v-on transform
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: v-on
:END: 

[[https://github.com/gcclll/stb-vue-next/commit/a94aacdb3983e06b11476394b9413310e827aab5][feat(add): v-on transform Â· gcclll/stb-vue-next@a94aacd]]

compiler-core é˜¶æ®µï¼š

#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code, ast } = compile(`<div v-on:keyup.enter.prevent="pressKeyup" />`)
console.log(code)
console.log(ast.codegenNode.props.properties)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", { onKeyup: pressKeyup }, null, 40 /* PROPS, HYDRATE_EVENTS */, ["onKeyup"]))
  }
}
[
  {
    type: 16,
    loc: { source: '', start: [Object], end: [Object] },
    key: {
      type: 4,
      loc: [Object],
      content: 'onKeyup',
      isStatic: true,
      constType: 3
    },
    value: {
      type: 4,
      content: 'pressKeyup',
      isStatic: false,
      constType: 0,
      loc: [Object]
    }
  }
]
undefined
#+end_example

å¯ä»¥çœ‹åˆ° compile-core é˜¶æ®µæ˜¯æ²¡æœ‰å¤„ç†ä¿®é¥°ç¬¦çš„ã€‚

v-on æŒ‡ä»¤æœ€åè§£ææˆ ~{ key, value, type: 16 }~ ç»“æ„ã€‚

compiler-dom v-on å¤„ç†é€»è¾‘ï¼š

1. ~resolveModifiers(key, modifiers)~ è§£æå‡ºä¸‰ç±»ä¿®é¥°ç¬¦

   - ~keyModifiers~ ä¿®é¥°ç¬¦

      é”®ç›˜äº‹ä»¶ï¼š ~onkeyup, onkeydown, onkeypress~

   - ~eventOptionModifiers~ äº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦ï¼Œåªæœ‰ä¸‰ç§ ~passive, once, capture~
     
   - ~nonKeyModifiers~ éæŒ‰é”®ç±»ä¿®é¥°ç¬¦

      äº‹ä»¶å†’æ³¡ç®¡ç†ï¼š ~stop,prevent,self~

      ç³»ç»Ÿä¿®é¥°ç¬¦+exact: ~ctrl,shift,alt,meta,exact~ , exact è¡¨ç¤ºç²¾ç¡®åŒ¹é…æŒ‰é”®ã€‚

      é¼ æ ‡æŒ‰é”®ä¿®é¥°ç¬¦ï¼š ~middle~

2. ç»è¿‡ 1 ä¹‹åå¾—å‡ºä¸‰ç§ç±»å‹çš„ä¿®é¥°ç¬¦ï¼Œå¤„ç†å…¶ä¸­çš„ ~nonKeyModifiers~

   å°†è¿™ç§ç±»å‹çš„ä¿®é¥°ç¬¦ä¸­çš„ ~right, middle~ è½¬æ¢æˆå¯¹åº”çš„ ~onContextmenu~ å’Œ
   ~onMouseup~ äº‹ä»¶

   å³ï¼š

   å¦‚æœæœ‰ ~right~ ç‚¹å‡»äº‹ä»¶ä¼šè§¦å‘ ~onContextmenu~ äº‹ä»¶ï¼Œå¼¹å‡ºå³é”®èœå•ï¼Ÿ

   å¦‚æœæœ‰ ~middle~ é¼ æ ‡ä¸­é—´æ»šè½®äº‹ä»¶ï¼Œä¼šè§¦å‘ ~onMouseup~ é¼ æ ‡å¼¹èµ·äº‹ä»¶

   æœ€åå°† ~nonKeyModifiers~ ç»“åˆ ~value~ åˆ›å»ºæˆå‡½æ•°è¡¨è¾¾å¼ã€‚

   #+begin_src js
   
const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const {code} = compile(
  `<div @click.right="testRight"
        @click.middle="testMiddle"
        @click.left="testLeft" />`)
console.log(`>>> right ä¿®é¥°ç¬¦è¢«å½“åš onContextmenu äº‹ä»¶å¤„ç†, middle -> onMouseup`)
console.log(code)
   #+end_src

   #+RESULTS:
   #+begin_example
   >>> right ä¿®é¥°ç¬¦è¢«å½“åš onContextmenu äº‹ä»¶å¤„ç†, middle -> onMouseup
   const _Vue = Vue

   return function render(_ctx, _cache) {
     with (_ctx) {
       const { withModifiers : _withModifiers, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

       return (_openBlock(), _createBlock("div", {
         onContextmenu: _withModifiers(testRight, ["right"]),
         onMouseup: _withModifiers(testMiddle, ["middle"]),
         onClick: _withModifiers(testLeft, ["left"])
       }, null, 40 /* PROPS, HYDRATE_EVENTS */, ["onContextmenu","onMouseup","onClick"]))
     }
   }
   undefined
   #+end_example

3. å¤„ç† ~keyModifiers~ ï¼Œå¦‚ï¼šé”®ç›˜äº‹ä»¶ä¿®é¥°ç¬¦ï¼Œç³»ç»Ÿä¿®é¥°ç¬¦ç­‰ç­‰

   æ¯”å¦‚ï¼šé”®ç›˜ ~ctrl-a~ ç»„åˆé”®
   
   #+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code } = compile(`
<div @keydown.stop.capture.ctrl.a="test" />`)
console.log(code)
   #+end_src

   #+RESULTS:
   #+begin_example
   const _Vue = Vue

   return function render(_ctx, _cache) {
     with (_ctx) {
       const { withModifiers : _withModifiers, withKeys : _withKeys, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

       return (_openBlock(), _createBlock("div", {
         onKeydownCapture: _withKeys(_withModifiers(test, ["stop","ctrl"]), ["a"])
       }, null, 40 /* PROPS, HYDRATE_EVENTS */, ["onKeydownCapture"]))
     }
   }
   undefined
   #+end_example

4. å¤„ç† ~eventOptionModifiers~ ç»“åˆ ~key~ ç”Ÿæˆå¯¹åº”çš„äº‹ä»¶åè¡¨è¾¾å¼

   äº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦åªæœ‰ä¸‰ä¸ªï¼š ~capture,passive,once~

   passive: [[https://segmentfault.com/a/1190000017247263][passiveçš„ä½œç”¨å’ŒåŸç†_ä¸ªäººæ–‡ç«  - SegmentFault æ€å¦]]

   [[/post/javascript-docs/#event-cap-bub][capture]]: [[https://blog.techbridge.cc/2017/07/15/javascript-event-propagation/][DOM çš„äº‹ä»¶å‚³éæ©Ÿåˆ¶ï¼šæ•ç²èˆ‡å†’æ³¡]]

   è§£æç»“æœï¼Œäº‹ä»¶é€‰é¡¹ä¿®é¥°ç¬¦è¢«åˆå¹¶åˆ°äº‹ä»¶åä¸­ï¼š
   
    #+begin_src js
    const {
        parse,
        compile
    } = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

    const { code } = compile(`<div @click.stop.capture.once="test" />`)
    console.log(code)
    #+end_src

    #+RESULTS:
    #+begin_example
    const _Vue = Vue

    return function render(_ctx, _cache) {
      with (_ctx) {
        const { withModifiers : _withModifiers, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

        return (_openBlock(), _createBlock("div", {
          onClickCaptureOnce: _withModifiers(test, ["stop"])
        }, null, 40 /* PROPS, HYDRATE_EVENTS */, ["onClickCaptureOnce"]))
      }
    }
    undefined
    #+end_example

    å¦‚ï¼šäº‹ä»¶å ~onClickCaptureOnce~

5. å¦‚æœäº‹ä»¶åä¸ºåŠ¨æ€æˆ–æ˜¯é”®ç›˜äº‹ä»¶ï¼Œå¾—ç”¨ ~_withKeys()~ åŒ…ä¸€å±‚


-----

æµ‹è¯•ï¼š
 
#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')
const log = console.log
const c = (tpl, title) => {
  const { code, ast } = compile(tpl, {
    onError: e => log(`é”™è¯¯æè¿°ï¼š${e.message}`)
  })

  log(`>>> ${title}`)
  log(code)
  log(ast.codegenNode.props.properties)
}

c(`<div @click.stop.prevent="test" />`, 'å¤šä¸ªä¿®é¥°ç¬¦')

#+end_src

#+RESULTS:
#+begin_example
>>> å¤šä¸ªä¿®é¥°ç¬¦
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { withModifiers : _withModifiers, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", {
      onClick: _withModifiers(test, ["stop","prevent"])
    }, null, 8 /* PROPS */, ["onClick"]))
  }
}
[
  {
    type: 16,
    loc: { source: '', start: [Object], end: [Object] },
    key: {
      type: 4,
      loc: [Object],
      content: 'onClick',
      isStatic: true,
      constType: 3
    },
    value: {
      type: 14,
      loc: [Object],
      callee: Symbol(vOnModifiersGuard),
      arguments: [Array]
    }
  }
]
undefined
#+end_example

#+begin_quote
~<f12>~ æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ›´å¤šæµ‹è¯•ç”¨ä¾‹ç»“æœã€‚
#+end_quote

#+begin_export html
<script>
l1(`v-on`)
c(`<div @click.stop.prevent="test"/>`, 'æ”¯æŒå¤šä¸ªä¿®é¥°ç¬¦')
c(`<div @click.stop="test" @keyup.enter="test" />`, 'å¤šä¸ªäº‹ä»¶')
c(`<div @click.stop.capture.once="test"/>`, 'å¤šä¸ªä¿®é¥°ç¬¦å’Œäº‹ä»¶é€‰é¡¹')
c(`<div @keydown.stop.capture.ctrl.a="test"/>`, 'é”®ç›˜äº‹ä»¶æˆ–åŠ¨æ€äº‹ä»¶ï¼Œåº”è¯¥ç”¨ keys guard åŒ…ä¸€å±‚(runtime-dom: withKeys())')
c(`<div @keyup.exact="test"/>`, `æ²¡æœ‰æŒ‰é”®ä¿®é¥°ç¬¦çš„æ—¶å€™ï¼Œä¸éœ€è¦ keys guard`)
c(`<div @keyup.left="test"/>`, 'é™æ€äº‹ä»¶å+left/right ä¿®é¥°ç¬¦ï¼Œéœ€è¦ keys guard')
c(`<div @[e].left="test"/>`, 'åŠ¨æ€äº‹ä»¶å+left/right ä¿®é¥°ç¬¦ï¼Œéœ€è¦ keys guard')
c(`<div @keyup.enter="test"/>`, 'should not wrap normal guard if there is only keys guard')
// è½¬æˆ onContextmenu äº‹ä»¶
c(`<div @click.right="test"/>`, 'should transform click.right')
// å¦‚æœæ˜¯ click.right è½¬æˆ onContextmenu
c(`<div @[event].right="test"/>`, 'åŠ¨æ€äº‹ä»¶å + right ä¿®é¥°ç¬¦')
// è½¬æˆ onMouseup
c(`<div @click.middle="test"/>`, 'é¼ æ ‡ä¸­é”®æŒ‰é”®äº‹ä»¶')
c(`<div @[event].middle="test"/>`, 'é¼ æ ‡ä¸­é”®åŠ¨æ€æŒ‰é”®äº‹ä»¶')
compile.options = { cacheHandlers: true }
const root = c(`<div @keyup.enter.capture="foo" />`, 'ç¼“å­˜ handler ä¿®é¥°ç¬¦')
log(root)
</script>
#+end_export

#+begin_quote
*å°ç»“* :

äº‹ä»¶ä¿®é¥°ç¬¦åˆ†ä¸ºä¸‰å¤§ç±»

1. äº‹ä»¶é€‰é¡¹ç±»å‹ä¿®é¥°ç¬¦(passive,capture,once)

   ä¼šå’Œäº‹ä»¶ååˆå¹¶ï¼š ~click.capture.once~ -> ~onClickCaptureOnce~
   
2. é”®ç›˜äº‹ä»¶(åŒ…æ‹¬é”®ç›˜æŒ‰é”® a-b-c-...)
3. å…¶ä»–ç±»å‹äº‹ä»¶ä¿®é¥°ç¬¦(å¦‚ï¼šstop,prevent,self, ctrl,shift,alt,meta,exact)


å…³äº ~right, middle~ ä¿®é¥°ç¬¦å¤„ç†æƒ…å†µ

1. right å¤„ç†æˆ ~onContextmenu~ äº‹ä»¶
2. middle å¤„ç†æˆ ~onMouseup~ äº‹ä»¶ 
3. right/middle æ˜¯åœ¨åŠ¨æ€äº‹ä»¶åä¸Šé¢ï¼Œä¼šæ£€æµ‹æ˜¯ä¸æ˜¯ onClick å¦‚æœæ˜¯è¿›è¡Œ 1/2 è½¬æ¢ï¼Œä¸
   æ˜¯æŒ‰ç…§åŸäº‹ä»¶åå¤„ç†ã€‚

   å¦‚ï¼š ~@[eventName].middle="test"~ -> ~eventName === 'onClick' ? 'onMouseup' :
   eventName~
#+end_quote

* e64a1b3 add v-show transform

[[https://github.com/gcclll/stb-vue-next/commit/e64a1b35823cb4ebcc96ad143d7dd8d45c05b185][feat(add): v-show transform Â· gcclll/stb-vue-next@e64a1b3]]

#+begin_src typescript
export const transformShow: DirectiveTransform = (dir, node, context) => {
  const { exp, loc } = dir
  if (!exp) {
    context.onError(
      createDOMCompilerError(DOMErrorCodes.X_V_SHOW_NO_EXPRESSION, loc)
    )
  }

  return {
    props: [],
    needRuntime: context.helper(V_SHOW)
  }
}
#+end_src

æµ‹è¯•ï¼š
#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code, ast } = compile(`<div v-show="test"/>`)
console.log(code)
console.log(`props: `, ast.codegenNode.props)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { vShow : _vShow, createVNode : _createVNode, withDirectives : _withDirectives, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return _withDirectives((_openBlock(), _createBlock("div", null, null, 512 /* NEED_PATCH */)), [
      [_vShow, test]
    ])
  }
}
props:  undefined
#+end_example

è¿™é‡Œè²Œä¼¼ä»€ä¹ˆéƒ½æ²¡å¹²ï¼Œé™¤äº†è¿”å›ä¸€ä¸ª ~needRuntime: context.helper(V_SHOW)~ ï¼Œéš¾é“
v-show å¿…é¡»åœ¨ runtime æ—¶æœŸå¤„ç†ï¼Ÿï¼Ÿï¼Ÿ
* 436db72 add transition component warn transform

[[https://github.com/gcclll/stb-vue-next/commit/436db72743d5ff677a4a505e9a4cb914613ffe2a][feat(add): transition component transform Â· gcclll/stb-vue-next@436db72]]

è¿™é‡Œåªæ˜¯åŠ äº†ä¸ªé”™è¯¯ç”¨æ³•å¤„ç†ï¼Œå¯¹äº ~<transition>~ ç»„ä»¶ä¸‹é¢åªèƒ½æœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹ã€‚
* TODO af56754 add stringifyStatic node ç¯å¢ƒé™æ€æå‡

[[https://github.com/gcclll/stb-vue-next/commit/af56754e25a96f161f28bbd5f78473cb81fbeee1][feat(add): node stringify static -> hoist Â· gcclll/stb-vue-next@af56754]]
* f0cbb25 add ignoreSideEffectTags transform

[[https://github.com/gcclll/stb-vue-next/commit/f0cbb25e4a47cf2b243156a408ddb4a327420110][feat(add): ignore side effect tags > script/style Â· gcclll/stb-vue-next@f0cbb25]]

è¿™ä¸ª transform ä½œç”¨æ˜¯æ£€æµ‹æ¨¡æ¿ä¸­æ˜¯ä¸æ˜¯å­˜åœ¨ ~<script>, <style>~ æ ‡ç­¾ã€‚

#+begin_src js

const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const c = (tpl, title) => {
  console.log(`>>> ${title}`)
  const { code } = compile(tpl, {
    onError: e => console.log(`> é”™è¯¯æè¿°ï¼š${e.message}`)
  })
  console.log(code)
}

c(`<script>console.log(1)</script>`, 'å¿½ç•¥ <script> æ ‡ç­¾')
c(`<style>h1 { color: red }</style>`, 'å¿½ç•¥ <style> æ ‡ç­¾')
#+end_src

#+RESULTS:
#+begin_example
>>> å¿½ç•¥ <script> æ ‡ç­¾
> é”™è¯¯æè¿°ï¼šTags with side effect (<script> and <style>) are ignored in client component templates.

return function render(_ctx, _cache) {
  with (_ctx) {
    return null
  }
}
>>> å¿½ç•¥ <style> æ ‡ç­¾
> é”™è¯¯æè¿°ï¼šTags with side effect (<script> and <style>) are ignored in client component templates.

return function render(_ctx, _cache) {
  with (_ctx) {
    return null
  }
}
undefined
#+end_example
* fd0f5ae add dom parserOptions and decode html

å¯¹ compiler-core çš„ ~ParserOptions~ çš„ä¸€ç§æ‰©å±•:

1. ~isNativeTag: tag => isHTMLTag(tag) || isSVGTag(tag)~

  /vue-next/packages/shared/src/domTagConfig.ts/

  ä¸­åˆ¶å®šäº†ä¸€äº›åŸç”Ÿçš„æ ‡ç­¾ã€‚

2. ~isPreTag~: ~pre~ æ ‡ç­¾

3. ~decodeEntities~ html å®ä½“è½¬æ¢

   åˆ†ä¸ºæµè§ˆå™¨ç¯å¢ƒå’ŒNDOEç¯å¢ƒå¤„ç†

   æµè§ˆå™¨ç¯å¢ƒå¤„ç†è¾ƒä¸ºç®€å•(è½¬æ ‡ç­¾å†…å®¹å–å‡ºå­—ç¬¦ä¸²ï¼Œåˆ©ç”¨æµè§ˆå™¨è‡ªèº«èƒ½åŠ›æ¥è½¬æ¢)ï¼š
   #+begin_src typescript

export function decodeHtmlBrowser(raw: string): string {
  ;(decoder || (decoder = document.createElement('div'))).innerHTML = raw
  return decoder.textContent as string
}

   #+end_src

   NODE ç¯å¢ƒç¨å¾®å¤æ‚ï¼Œä¸‹é¢åšäº›ç®€å•æµ‹è¯•å§ï¼š
   
   [[https://html.spec.whatwg.org/multipage/named-characters.html]]
   
   /vue-next/packages/compiler-dom/src/namedChars.json/

   ä¸Šé¢é“¾æ¥å’Œè·¯å¾„ä¸­åŒ…å«äº†æ‰€æœ‰å­—ç¬¦çš„ 16è¿›åˆ¶ - ç¬¦å· - åå­—å¯¹åº”è¡¨(json)ï¼Œä¸‹é¢éšä¾¿æ‰¾
   å‡ ä¸ªæ¥æµ‹è¯•ä¸‹-> åˆ†æå¦‚æ³¨é‡Š
   #+begin_src js

const {
  decodeHtml
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')
 
let rawText = 'a &#x20ac b &nbsp; e &FilledVerySmallSquare; d &Gg; f'
const res = decodeHtml(rawText)
// while å¾ªç¯é‡Œé¦–å…ˆæ˜¯åŒ¹é…æ­£åˆ™ï¼š/&(?:#x?)?/ -> &#x...åå…­è¿›åˆ¶æ•° æˆ– `&[name];`
// å½¢å¼çš„å­—ç¬¦ï¼Œname å–è‡ª namedChars.json æ–‡ä»¶çš„ key
// å¦‚æœéƒ½æ²¡æœ‰åŒ¹é…åˆ°ç›´æ¥é€€å‡ºå¾ªç¯ï¼Œ
// å³ decodeHtml ç›®çš„æ˜¯å°†16è¿›åˆ¶å’Œ named è¡¨ç¤ºçš„ç¬¦å·è½¬æ¢è¯­ä¹‰åŒ–çš„ç¬¦å·
// å¦‚ï¼š &#x20ac -> "euro;": "â‚¬" -> â‚¬ ç¬¦å·
// æˆ–è€… &nbsp; ç¬¦å·
// æˆ–è€…ä½¿ç”¨ namedChars.json ä¸­çš„åå­—æ¥ä½œä¸ºç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚ï¼š &FilledVerySmallSquare; -> â–ª, &Gg; ->  â‹™
console.log(res)
   #+end_src

   #+RESULTS:
   : a â‚¬ b Â  e â–ª d â‹™ f
   : undefined

4. ~isBuiltInComponent~, ä¸¤ä¸ªå†…ç½®ç»„ä»¶ï¼š ~Transition, TransitionGroup~

5. ~getNamespace~, æ›´è¯¦ç»†çš„å‘½åç©ºé—´æ£€æµ‹

6. ~getTextMode~, æ–‡æœ¬æ¨¡å¼æ£€æµ‹
   
   ~textarea, title~ æ ‡ç­¾è§†ä¸º ~TextModes.RCDATA~ ç±»å‹

   ~style,iframe,script,noscript~ æ ‡ç­¾è§†ä¸º ~TextModes.RAWTEXT~ ç±»å‹

   å…¶ä»–è§†ä¸º ~TextModes.DATA~ ç±»å‹
   

* ç”¨ä¾‹æµ‹è¯•(~<f12>~ æŸ¥çœ‹æ§åˆ¶å°)ï¼š

#+begin_export html
<script src="/js/vue/node.env.dom.test.js"></script>
#+end_export
* æ€»ç»“

#+begin_quote
è¿™ä¸€æ¨¡å—çš„å®Œæˆï¼Œé›¶é›¶æ•£æ•£æ—¶é—´å¤§æ¦‚èŠ±äº†ä¸åˆ°ä¸€å‘¨çš„æ—¶é—´ï¼Œä¹Ÿæ˜¯ç”±äºæœ‰ [[/vue/vue-mind-map-compiler-core-transform-generate/][compiler-core]] åŒ…
çš„å®ŒæˆåŠåˆ†æçš„åŸºç¡€ä¸Šï¼Œè¿›å±•æ‰ä¼šè¿™ä¹ˆé¡ºåˆ©ã€‚
#+end_quote

å¯¹äº compiler-dom è¿™ä¸€æ¨¡å—ä¸»è¦å†…å®¹ï¼Œå¿«é€Ÿé¢„è§ˆå¯ä»¥æŸ¥çœ‹ç¬¬ä¸€ç« èŠ‚çš„[[#init][åŠŸèƒ½é¢„è§ˆ]]ã€‚

è¿™é‡Œé‡ç‚¹å…³æ³¨çš„åœ°æ–¹ï¼Œæˆ‘è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

1. ~v-model~ å¯¹ ~<input>~ ç±»å‹æ£€æµ‹å’Œå¤„ç†
2. ~v-on~ äº‹ä»¶ä¿®é¥°ç¬¦çš„å¤„ç†ï¼Œæˆ‘æ„Ÿè§‰æ˜¯è¿™ä¸ªæ¨¡å—çš„ *é‡ä¸­ä¹‹é‡*
3. å¦å¤–å¯¹äº node ç¯å¢ƒçš„ html ç¬¦å·è¯­ä¹‰åŒ–çš„å¤„ç†ä¹Ÿå€¼å¾—åˆ†æ

