#+TITLE: Vue3 æºç å¤´è„‘é£æš´ä¹‹ 4 â˜compiler-dom - TODO
#+DATE: <2020-12-16 19:39:26>
#+TAGS[]: vue, vue3, compiler-dom
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent shrink

#+begin_export html
<link href="https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚
</font>
</kbd><br><br>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

@@html:<kbd>@@
*[[https://github.com/gcclll/stb-vue-next][stb-vue-next]] å®Œå…¨æ‹·è´äº [[https://github.com/vuejs/vue-next][vue-next]] ï¼Œä¸»è¦ç›®çš„ç”¨äºå­¦ä¹ ã€‚*
@@html:</kbd>@@

#+begin_quote
*å£°æ˜* ï¼švue-next compiler-dom æ¨¡å—
*è°ƒè¯•* ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å¯é€šè¿‡ ~<F12>~ æ§åˆ¶å°æŸ¥çœ‹

*æ›´æ–°æ—¥å¿—&Todos* ï¼š
1. [2020-12-16 19:40:21] åˆ›å»º
#+end_quote

#+begin_export html
<script src="/js/vue/compiler-dom.global.js"></script>
<script>
let i = 0, j = 0
const l1 = x => (j = 0, console.log(`%c >>> ${++i} ${x}`, 'background: #222; color: #bada55'))
const l2 = x => console.log(`%c > ${i}.${j++} ${x}`, 'background: #222; color: #bada55')
const log = (args) => console.log.apply(console, Array.isArray(args) ? args : [args])
log.blue = x => log([`%c ${x}`, `color: blue`])
log.red = x => log([`%c ${x}`, `color: red`])
log.gray = x => log([`%c ${x}`, `color: gray`])
const { compile: compile2, parse } = VueCompilerDOM
const compile = (tpl, title, logAst = false) => {
    l2(title)
    if (!tpl) return null
    const { code, ast } = compile2(tpl, {
        onError: (e) => console.warn(e.message),
        hoistStatic: true,
        ...( compile.options || {} )
    })

    log.gray(tpl)
    log([code])
    logAst && log(typeof logAst === 'function' ? logAst(ast) : ast)
    return ast
}
const c = (tpl, desc, fn) => compile(tpl, desc, fn || (ast => ast.codegenNode.props))
</script>
#+end_export

* 0062974 compiler-domæ¨¡å—åˆå§‹åŒ–

[[https://github.com/gcclll/stb-vue-next/commit/0062974d50531aa5e51f229968fd582d567a090c][feat(init): compiler-dom Â· gcclll/stb-vue-next@0062974]]

æ—¥å¸¸æ“ä½œå…ˆ copyï¼šå…ˆå°† /vue-next/packages/compiler-dom// ä¸‹é¢çš„å†…å®¹æ‹·è´è¿‡æ¥ï¼Œåˆ é™¤ src ç›®å½•ä¸‹çš„æ‰€æœ‰ä»£
ç ã€‚

äº†è§£ç›®å½•ç»“æ„ï¼š

#+begin_example
â•°â”€$ tree -C -I 'dist|__tests__'
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ api-extractor.json
â”œâ”€â”€ index.js
â”œâ”€â”€ package.json
â””â”€â”€ src
    â”œâ”€â”€ decodeHtml.ts
    â”œâ”€â”€ decodeHtmlBrowser.ts
    â”œâ”€â”€ errors.ts
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ namedChars.json
    â”œâ”€â”€ parserOptions.ts
    â”œâ”€â”€ runtimeHelpers.ts
    â””â”€â”€ transforms
        â”œâ”€â”€ ignoreSideEffectTags.ts
        â”œâ”€â”€ stringifyStatic.ts
        â”œâ”€â”€ transformStyle.ts
        â”œâ”€â”€ vHtml.ts
        â”œâ”€â”€ vModel.ts
        â”œâ”€â”€ vOn.ts
        â”œâ”€â”€ vShow.ts
        â”œâ”€â”€ vText.ts
        â””â”€â”€ warnTransitionChildren.ts

2 directories, 21 files
#+end_example
* 4fa13bf init parse + compile function

[[https://github.com/gcclll/stb-vue-next/commit/4fa13bfe57f414f158041122119096f3fb8a859d][feat(init): compiler-dom index.ts> compile + parse function Â· gcclll/stb-vue-next@4fa13bf]]

åˆå§‹åŒ–ç¼–è¯‘å’Œè§£æå‡½æ•°ï¼Œå¯¹åº”ç€ compile-core çš„ ~baseCompile~ å’Œ ~baseParse~ å‡½æ•°ã€‚

å³ï¼š compiler-dom æ˜¯é’ˆå¯¹ compiler-core çš„è¿›ä¸€æ­¥å°è£…å¤„ç†ï¼Œä¼ é€’ä¸€äº› ~transformXxx~
å‡½æ•°ï¼Œè‡³äºè¿™äº›å‡½æ•°åšäº†ä»€ä¹ˆå¤„ç†ï¼Œéœ€è¦ä¸‹é¢ä¸€æ­¥æ­¥æ¥æ­å¼€ã€‚

compile :
#+begin_src typescript
export function compile(
  template: string,
  options: CompilerOptions
): CodegenResult {
  return baseCompile(
    template,
    extend({}, parserOptions, {
      nodeTransforms: [],
      directiveTransforms: extend({}),
      // é™æ€æå‡ transform
      transformHoist: __BROWSER__ ? null : stringifyStatic
    })
  )
}
#+end_src

parse:
#+begin_src typescript
export function parse(template: string, options: ParserOptions = {}): RootNode {
  return baseParse(template, extend({}, parserOptions, options))
}
#+end_src

å…¶å®åˆ°è¿™é‡Œä¹Ÿæ˜¯åº”è¯¥å¯ä»¥æ‰§è¡Œçš„ï¼Œæ¥æµ‹è¯•ä¸‹ï¼š

#+begin_src js
const {
  parse,
  compile
} = require(process.env.PWD + '/../../static/js/vue/compiler-dom.global.js')

const { code, ast } = compile(`<div>{{ test }}</div>`)
console.log(code, '\n>>> AST: \n', ast)
#+end_src

#+RESULTS:
#+begin_example
const _Vue = Vue

return function render(_ctx, _cache) {
  with (_ctx) {
    const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

    return (_openBlock(), _createBlock("div", null, _toDisplayString(test), 1 /* TEXT */))
  }
}
>>> AST:
 {
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: [Object]
    }
  ],
  codegenNode: {
    type: 13,
    tag: '"div"',
    props: undefined,
    children: { type: 5, content: [Object], loc: [Object] },
    patchFlag: '1 /* TEXT */',
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    loc: { start: [Object], end: [Object], source: '<div>{{ test }}</div>' }
  },
}
#+end_example

æ¥ä¸‹æ¥æ‰æ˜¯è¿›å…¥æ­£é¢˜ â›³...ğŸš„ğŸš„ğŸš„
