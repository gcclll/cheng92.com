#+TITLE: Vue3 + Vite 项目实战 CBOSS 管理系统
#+DATE: <2021-02-22 18:02:56>
#+TAGS[]: vue3, vite
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent

#+begin_quote
vue 资源: [[https://github.com/vuejs/awesome-vue#frameworks][vuejs/awesome-vue: 🎉 A curated list of awesome things related to Vue.js]]
#+end_quote

* vite
** import-analysis 插件
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: plugin-import-analysis
:END:

_[[https://github.com/vitejs/vite/blob/main/packages/vite/src/node/plugins/importAnalysis.ts][vite/src/node/plugins/importAnalysis.ts]]: importAnalysisPlugin_

函数名： ~importAnalysisPlugin(config: ResolvedConfig): Plugin~

从函数注释可知，这个函数用来处理 ~import ./**/*.[js|css]~ 相对路径的资源或代码文
件的，对于绝对路径的(~node_modules~)中的将会被 ~@rollup-plugin/node-resolve~ 处
理。

并且对于 CSS imports 会在后面追加 ~.js~ 当做 js module 处理，如：

~import './style.css'~

会变成:

~import './style.css.js'~

这个函数回返回一个对象，包含以下成员：

| name                               | type     | function       |
|------------------------------------+----------+----------------|
| ~name~                             | String   | 该插件名称     |
| ~configureServer(_server)~         | Function | 配置 node 服务 |
| ~transform(source, importer, ssr)~ | Function | 解析，转换 URL |

重点都在 ~transform()~ 方法中，且该方法很长，需要点耐心。

主要处理逻辑有以下几点：

1. ~const prettyImporter = prettifyUrl(importer, root)~

   这个不影响主体功能，仅仅只是将 url 使用 ~chalk~ 加上了颜色，让输出更富有色彩。

2. ~imports = parseImports(source)[0]~

   这里用到 es-module-lexer 包的 parse 函数解析 es module 语法的代码，得到
   ~exports~ 和 ~imports~ 。

   [[https://github.com/guybedford/es-module-lexer][guybedford/es-module-lexer: Low-overhead lexer dedicated to ES module parsing
   for fast analysis]]

   比如：

   #+begin_src js
   const path = "/usr/local/lib/node_modules/es-module-lexer/dist/lexer.cjs";
   const { init, parse } = require(path);
   (async () => {
     await init;

     const code = `
import { a } from 'asdf'
export var p = 5
export function q() {}
`
     const [imports, exports] = parse(code);
     console.log('\n');
     // s -> start, e -> end,
     // ss -> statement start, se -> statement end
     console.log(imports[0]);
     console.log(exports);
   })();
   #+end_src

   #+RESULTS:
   : undefined
   :
   : { n: 'asdf', s: 20, e: 24, ss: 1, se: 25, d: -1 }
   : [ 'p', 'q' ]

   #+begin_quote
   [[https://github.com/guybedford/es-module-lexer/blob/master/src/lexer.c][es-module-lexer/lexer.c at master · guybedford/es-module-lexer]]

   c 结合 wasm 进行解析，牛掰，大佬啊！！！

   这里只要知道它用来解析出 imports 和 exports 就对了 🐶🐶🐶。
   #+end_quote

3. 几个重要变量

   #+begin_src typescript
   const importedUrls = new Set<string>();
   const acceptedUrls = new Set<{
     url: string;
     start: number;
     end: number;
   }>();
   // 转成绝对路径
   // 如最后的测试，这里转换的结果是：
   //
   const toAbsoluteUrl = (url: string) =>
     path.posix.resolve(path.posix.dirname(importerModule.url), url);
   #+end_src



test:
#+begin_src js
const path = require("path");
console.log(path.posix.dirname("../assets"));
#+end_src

#+RESULTS:
: ..
: undefined

* 问题列表

1. vite create-app 之后启动项目，在 import 的时候总提示文件不存在？

   #+begin_quote
   A.  修改 vite.config.js 增加配置项 optimizeDeps -> exclude -> ['jsuites']:

   #+end_quote

   #+begin_src typescript
   import { defineConfig } from "vite";
   import vue from "@vitejs/plugin-vue";

   // https://vitejs.dev/config/
   export default defineConfig({
     plugins: [vue()],
     optimizeDeps: {
       exclude: ["jsuites"],
     },
   });
   #+end_src

2. 可用的 vue3 ui 库？

   [[https://dev.to/beccabycott/vue-3-ui-component-library-for-2021-4nfa][Vue 3 UI component library for 2021 - DEV Community]]

   [[https://github.com/element-plus/element-plus][ElementUI]] ✅ > [[https://github.com/ionic-team/ionic-framework][Ionic 移动端]] ✅ > [[https://github.com/primefaces/primevue][Primevue]] ✅ > [[https://github.com/vuetifyjs/vuetify][Vuetify]] ❌ > [[https://github.com/quasarframework/quasar][Quasar]] ❌

3. ~import bgImg from '../assets/bg.jpg'~ 总是报错？

   #+begin_example
   9:21:21 PM [vite] Internal server error: Failed to resolve import "/@/assets/login_bg.jpg". Does the file exist?
   #+end_example

   见 [[#plugin-import-analysis][plugin-import-analysis]] 分析。
