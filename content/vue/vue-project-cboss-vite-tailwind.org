#+TITLE: Vue3 + Vite é¡¹ç›®å®æˆ˜ CBOSS ç®¡ç†ç³»ç»Ÿ
#+DATE: <2021-02-22 18:02:56>
#+TAGS[]: vue3, vite
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent

#+begin_quote
vue èµ„æº: [[https://github.com/vuejs/awesome-vue#frameworks][vuejs/awesome-vue: ğŸ‰ A curated list of awesome things related to Vue.js]]
#+end_quote

* vite
** import-analysis æ’ä»¶
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: plugin-import-analysis
:END:

_[[https://github.com/vitejs/vite/blob/main/packages/vite/src/node/plugins/importAnalysis.ts][vite/src/node/plugins/importAnalysis.ts]]: importAnalysisPlugin_

å‡½æ•°åï¼š ~importAnalysisPlugin(config: ResolvedConfig): Plugin~

ä»å‡½æ•°æ³¨é‡Šå¯çŸ¥ï¼Œè¿™ä¸ªå‡½æ•°ç”¨æ¥å¤„ç† ~import ./**/*.[js|css]~ ç›¸å¯¹è·¯å¾„çš„èµ„æºæˆ–ä»£ç æ–‡
ä»¶çš„ï¼Œå¯¹äºç»å¯¹è·¯å¾„çš„(~node_modules~)ä¸­çš„å°†ä¼šè¢« ~@rollup-plugin/node-resolve~ å¤„
ç†ã€‚

å¹¶ä¸”å¯¹äº CSS imports ä¼šåœ¨åé¢è¿½åŠ  ~.js~ å½“åš js module å¤„ç†ï¼Œå¦‚ï¼š

~import './style.css'~

ä¼šå˜æˆ:

~import './style.css.js'~

è¿™ä¸ªå‡½æ•°å›è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹æˆå‘˜ï¼š

| name                               | type     | function       |
|------------------------------------+----------+----------------|
| ~name~                             | String   | è¯¥æ’ä»¶åç§°     |
| ~configureServer(_server)~         | Function | é…ç½® node æœåŠ¡ |
| ~transform(source, importer, ssr)~ | Function | è§£æï¼Œè½¬æ¢ URL |

é‡ç‚¹éƒ½åœ¨ ~transform()~ æ–¹æ³•ä¸­ï¼Œä¸”è¯¥æ–¹æ³•å¾ˆé•¿ï¼Œéœ€è¦ç‚¹è€å¿ƒã€‚

ä¸»è¦å¤„ç†é€»è¾‘æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1. ~const prettyImporter = prettifyUrl(importer, root)~

   è¿™ä¸ªä¸å½±å“ä¸»ä½“åŠŸèƒ½ï¼Œä»…ä»…åªæ˜¯å°† url ä½¿ç”¨ ~chalk~ åŠ ä¸Šäº†é¢œè‰²ï¼Œè®©è¾“å‡ºæ›´å¯Œæœ‰è‰²å½©ã€‚

2. ~imports = parseImports(source)[0]~

   è¿™é‡Œç”¨åˆ° es-module-lexer åŒ…çš„ parse å‡½æ•°è§£æ es module è¯­æ³•çš„ä»£ç ï¼Œå¾—åˆ°
   ~exports~ å’Œ ~imports~ ã€‚

   [[https://github.com/guybedford/es-module-lexer][guybedford/es-module-lexer: Low-overhead lexer dedicated to ES module parsing
   for fast analysis]]

   æ¯”å¦‚ï¼š

   #+begin_src js
   const path = "/usr/local/lib/node_modules/es-module-lexer/dist/lexer.cjs";
   const { init, parse } = require(path);
   (async () => {
     await init;

     const code = `
import { a } from 'asdf'
export var p = 5
export function q() {}
`
     const [imports, exports] = parse(code);
     console.log('\n');
     // s -> start, e -> end,
     // ss -> statement start, se -> statement end
     console.log(imports[0]);
     console.log(exports);
   })();
   #+end_src

   #+RESULTS:
   : undefined
   :
   : { n: 'asdf', s: 20, e: 24, ss: 1, se: 25, d: -1 }
   : [ 'p', 'q' ]

   #+begin_quote
   [[https://github.com/guybedford/es-module-lexer/blob/master/src/lexer.c][es-module-lexer/lexer.c at master Â· guybedford/es-module-lexer]]

   c ç»“åˆ wasm è¿›è¡Œè§£æï¼Œç‰›æ°ï¼Œå¤§ä½¬å•Šï¼ï¼ï¼

   è¿™é‡Œåªè¦çŸ¥é“å®ƒç”¨æ¥è§£æå‡º imports å’Œ exports å°±å¯¹äº† ğŸ¶ğŸ¶ğŸ¶ã€‚
   #+end_quote

3. å‡ ä¸ªé‡è¦å˜é‡

   #+begin_src typescript
   const importedUrls = new Set<string>();
   const acceptedUrls = new Set<{
     url: string;
     start: number;
     end: number;
   }>();
   // è½¬æˆç»å¯¹è·¯å¾„
   // å¦‚æœ€åçš„æµ‹è¯•ï¼Œè¿™é‡Œè½¬æ¢çš„ç»“æœæ˜¯ï¼š
   //
   const toAbsoluteUrl = (url: string) =>
     path.posix.resolve(path.posix.dirname(importerModule.url), url);
   #+end_src



test:
#+begin_src js
const path = require("path");
console.log(path.posix.dirname("../assets"));
#+end_src

#+RESULTS:
: ..
: undefined

* é—®é¢˜åˆ—è¡¨

1. vite create-app ä¹‹åå¯åŠ¨é¡¹ç›®ï¼Œåœ¨ import çš„æ—¶å€™æ€»æç¤ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Ÿ

   #+begin_quote
   A.  ä¿®æ”¹ vite.config.js å¢åŠ é…ç½®é¡¹ optimizeDeps -> exclude -> ['jsuites']:

   #+end_quote

   #+begin_src typescript
   import { defineConfig } from "vite";
   import vue from "@vitejs/plugin-vue";

   // https://vitejs.dev/config/
   export default defineConfig({
     plugins: [vue()],
     optimizeDeps: {
       exclude: ["jsuites"],
     },
   });
   #+end_src

2. å¯ç”¨çš„ vue3 ui åº“ï¼Ÿ

   [[https://dev.to/beccabycott/vue-3-ui-component-library-for-2021-4nfa][Vue 3 UI component library for 2021 - DEV Community]]

   [[https://github.com/element-plus/element-plus][ElementUI]] âœ… > [[https://github.com/ionic-team/ionic-framework][Ionic ç§»åŠ¨ç«¯]] âœ… > [[https://github.com/primefaces/primevue][Primevue]] âœ… > [[https://github.com/vuetifyjs/vuetify][Vuetify]] âŒ > [[https://github.com/quasarframework/quasar][Quasar]] âŒ

3. ~import bgImg from '../assets/bg.jpg'~ æ€»æ˜¯æŠ¥é”™ï¼Ÿ

   #+begin_example
   9:21:21 PM [vite] Internal server error: Failed to resolve import "/@/assets/login_bg.jpg". Does the file exist?
   #+end_example

   è§ [[#plugin-import-analysis][plugin-import-analysis]] åˆ†æã€‚
