#+TITLE: Vue3 æºç çš„å¤´è„‘é£æš´(è„‘å›¾ä»“åº“)
#+DATE: <2020-08-28 16:35:34>
#+TAGS[]: vue, vue3, compiler-core, parser, compiler
#+CATEGORIES[]: vue
#+LANGUAGE: zh-cn
#+STARTUP: indent

#+begin_export html
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
<kbd>
<font color="blue" size="3" style="font-family: 'ZCOOL XiaoWei', serif;">
  è¯—å·ï¼šå…­é“åŒå ï¼Œé­”åŠ«ä¸‡åƒï¼Œå¼•æ¸¡å¦‚æ¥ã€‚ 
</font>
</kbd><br><br>
#+end_export

[[/img/bdx/yiyeshu-001.jpg]]

* ğŸŒ§ åº
:star: :star: ç”±äºå›¾ç‰‡æ˜¯ä½¿ç”¨ github åšçš„å›¾åºŠï¼Œæ²¡æœ‰ CDN åŠ é€Ÿï¼Œä¸”æœ‰äº›å›¾ç‰‡æ¯”è¾ƒå¤§(å¯èƒ½

:star: :star: å¿« 1M) åŠ è½½æŒºæ…¢çš„ï¼Œæ¯å¼ å›¾ç‰‡éƒ½æœ‰å¯¹åº”çš„ä¸ƒç‰›(ä½†ä¸ä¸€å®šæ˜¯æœ€æ–°çš„)é“¾æ¥ï¼Œå¯èƒ½ä¼šå¿«ä¸€ç‚¹ã€‚

:star: :star: å›¾ç‰‡å·²å…¨éƒ¨æ›´æ–°åˆ° ~https://www.cheng92.com/img/...~ ä¸‹

:smile: æ›´æ–°æ—¥å¿—
1. <2020-09-07 Mon>  +æ‰€æœ‰å›¾ç‰‡ä¿®æ”¹ä¸º github åœ°å€ï¼Œåç»­ä¿®æ”¹å›¾ç‰‡å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸
   éœ€è¦ä¸Šä¼ åˆ°ä¸ƒç‰›ã€‚+
   
2. <2020-09-10 Thu>  +å›¾åºŠåˆ‡æ¢åˆ° [[https://gitee.com/gcclll/mind-maps.git][ç äº‘ gitee]] è‡ªåŠ¨åŒæ­¥è‡ª [[https://github.com/gcclll/mind-maps.git][github]]ã€‚+

3. <2020-09-11 Fri>  æ›´æ–°å›¾ç‰‡åˆ°åšå®¢ç›®å½• ~/static/imgs/...~ ï¼Œæ–‡å†…è®¿é—®è·¯å¾„ï¼š
   ~/img/vue3/...~ ï¼Œå•ç‹¬è®¿é—®åŠ ä¸ŠåŸŸåå°±è¡Œï¼š ~https://www.cheng92.com/img/vue3/...~
   
4. <2020-09-28 Mon> æ‰€æœ‰è„‘å›¾ä¿®æ”¹ä¸º svg æ ¼å¼ï¼Œå»ºè®®é€šè¿‡æ–° tab æ‰“å¼€ï¼Œæœ‰äº›èŠ‚ç‚¹å¯èƒ½åŒ…å«é“¾
   æ¥ã€‚

* ğŸŒ© åŠŸèƒ½æ€§æ‹†åˆ†(parser-compiler-generate-...)
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg
:END: 

ä» [[#compiler-01][compiler-01]] å¼€å§‹éƒ½æ˜¯é’ˆå¯¹æŸä¸ªç¤ºä¾‹åšçš„åˆ†æï¼Œä½†æ˜¯éšæ—¶ç¤ºä¾‹çš„æ¨¡æ¿å¤æ‚åº¦å¢åŠ ï¼Œè„‘å›¾
çš„å¤§å°å°†è¶Šæ¥è¶Šå¤§ï¼Œä¸å ªé‡è´Ÿï¼Œé˜…è¯»å›é¡¾èµ·æ¥ä¹Ÿå¾ˆè´¹åŠ²ï¼Œåœ¨å®Œæˆäº† [[#compiler-01][compiler-01]] -
[[#compiler-05][compiler-05]] ä¹‹åå¯¹æ•´ä¸ªåˆ†æè¿‡ç¨‹ä¹Ÿæœ‰äº†å¤§æ¦‚çš„äº†è§£ï¼Œå¦èµ·è¿™ä¸€ç« èŠ‚çš„ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½å•çº¯
çš„é’ˆå¯¹æŸä¸€ç‰¹å®šåŠŸèƒ½ç»˜åˆ¶å¯¹åº”çš„æµç¨‹å›¾ï¼Œæ¯”å¦‚ï¼š

å±æ€§æ˜¯å¦‚ä½•è§£æçš„ï¼Œæœ€ååœ¨ render å‡½æ•°ä¸­åˆæ˜¯ä»€ä¹ˆï¼Ÿ

æ’å€¼ï¼Ÿ ~v-if, v-else, v-for~ ç­‰æŒ‡ä»¤ï¼Ÿ

åˆæ˜¯å¦‚ä½•è§£æçš„ï¼Œäº†è§£äº†è¿™äº›ä¹‹åå‰©ä¸‹çš„å°±æ˜¯å°†æ‰€æœ‰éœ€è¦çš„è¿‡ç¨‹æ‹¼å‡‘èµ·æ¥è€Œå·²ï¼Œåé¢ä¹Ÿä¼šçœ‹
æƒ…å†µå¢åŠ å‡ ä¸ªå¤æ‚æˆ–å…¨çš„æ¨¡æ¿è§£ææµç¨‹å›¾ã€‚

æ‰€ä»¥è¿™ä¸€ç« èŠ‚å°±å¾ˆæœ‰å¿…è¦äº†:dog::dog::dog::dog::dog: !!!

#+begin_quote
è¿™ä¸€ç« èŠ‚çš„æ‰€æœ‰è„‘å›¾ï¼Œç»˜åˆ¶åˆ†ä¸ºä»¥ä¸‹é˜¶æ®µï¼Œå¦‚æœæµç¨‹ç®€å•å¤šä¸ªé˜¶æ®µå¯èƒ½ä¼šåœ¨åŒä¸€å¼ è„‘å›¾ä¸Š
1. *parser* é˜¶æ®µå¾—åˆ°å®Œæ•´çš„ ast
2. *compiler* é˜¶æ®µè§£æ ast ç”ŸæˆèŠ‚ç‚¹ ~codegenNode~
3. *generate* é˜¶æ®µåˆ©ç”¨ ~codegenNode~ ç»„è£…æˆ render å‡½æ•°
4. å¾…ç»­......
#+end_quote
** çº¯æ ‡ç­¾ ~<div></div>~
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-01
:END: 

ç»“æœï¼š
#+begin_src js
  (function anonymous(
  ) {
    const _Vue = Vue

    return function render(_ctx, _cache) {
      with (_ctx) {
        const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock } = _Vue

        return (_openBlock(), _createBlock("div"))
      }
    }
  })
#+end_src

[[/img/vue3/compiler-core/pcg/pcg-01-pure-div.svg]]

1. parser é˜¶æ®µï¼Œ [[/vue/vue3-source-code-compiler-core-parse_ts/#parse-parseelement][parseElement]] -> [[/vue/vue3-source-code-compiler-core-parse_ts/#parse-parsetag][parseTag]]

   [[/img/vue3/compiler-core/pcg/pcg-01-1-parser-pure-div.svg]]
   
2. compiler é˜¶æ®µï¼Œ [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-transform][transform]] -> [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-traversenode][traverseNode]] -> [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-traversechildren][traverseChildren]] ï¼Œåªæœ‰ ~0,ROOT~
   å’Œ ~1,ELEMENT~ ä¸¤ä¸ªç±»å‹åˆ†æ”¯å¤„ç†ã€‚

   [[/img/vue3/compiler-core/pcg/pcg-01-2-compiler-pure-div.svg]]
3. codegen é˜¶æ®µï¼Œåªæœ‰ div çš„ block å¤„ç†(~_openBlock(), _createBlock("div")~)

   [[/img/vue3/compiler-core/pcg/pcg-01-3-codegen-pure-div.svg]]
** é™æ€å±æ€§ ~<div id="foo"></div>~
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-02
:END: 

1. *parser é˜¶æ®µ* ï¼š

   ä¸ [[#pcg-01][pcg-01]] ç›¸æ¯”è¾ƒï¼Œå¤šäº†å·¦è¾¹ [[/vue/vue3-source-code-compiler-core-parse_ts/#parse-parsetag][parseTag]] -> [[/vue/vue3-source-code-compiler-core-parse_ts/#parse-parseattributes][parseAttributes]] -> [[/vue/vue3-source-code-compiler-core-parse_ts/#parse-parseattribute][parseAttribute]] è§£æå±
   æ€§ ~id="foo"~ çš„å¤„ç†ã€‚
   
   [[/img/vue3/compiler-core/pcg/pcg-02-1-parser-div-with-id.svg]]
2. *compiler é˜¶æ®µï¼š*
   
   ä¸ [[#pcg-01][pcg-01]] ç›¸æ¯”è¾ƒï¼Œå¤šäº† [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-transformelement][transformElement]] ä¸­ props å±æ€§çš„å¤„ç†ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™
   props.length = 1 é‡Œé¢æœ‰ä¸€ä¸ª ~id="foo"~ å±æ€§ï¼Œéœ€è¦å»è°ƒç”¨ [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-buildprops][buildProps]] è§£æï¼Œæˆä¸‹é¢
   çš„è§£æ„:
   
    #+begin_src js
    {
      properties: [
        {
          key: { type:4, content: "id", ...}, // SIMPLE_EXPRESSION
          value: {type: 4, content: "foo", ...},
          type: 16 // JS_PROPERTY
        }
      ]
        type: 15, // JS_OBJECT_EXPRESSION
    }
  #+end_src
  
   [[/img/vue3/compiler-core/pcg/pcg-02-2-compiler-div-with-id.svg]]
3. *codegen é˜¶æ®µï¼š*

   åœ¨ [[/vue/vue3-source-code-compiler-core-compile_ts/#codegen-gennodelist][genNodeList([tag, props, children, ...], ctx)]] è§£æçš„æ—¶å€™ï¼Œè¿™é‡Œ props ä¸å†æ˜¯
   nullï¼Œå› æ­¤ä¼šè¿›å…¥ Props è§£æè¿‡ç¨‹ï¼š

   [[/vue/vue3-source-code-compiler-core-compile_ts/#codegen-gennode][genNode(props, ctx)]] -> *15,JS_OBJECT_EXPRESSION* -> [[/vue/vue3-source-code-compiler-core-compile_ts/#codegen-genobjectexpression][genObjectExpression(node,
   ctx)]] -> éå† *node.properties*  -> [[/vue/vue3-source-code-compiler-core-compile_ts/#codegen-genexpressionaspropertykey][genExpressionPropertyKey(key,ctx)]] ç”Ÿæˆå±æ€§
   å ~{ id: ~ -> ~genNode(value, ctx)~ ç”Ÿæˆå±æ€§å€¼ -> *4, SIMPLE_EXPRESSION* ->
   [[/vue/vue3-source-code-compiler-core-compile_ts/#codegen-genexpression][genExpression(value, ctx)]] ç”Ÿæˆå±æ€§å€¼ ~{ id: "foo"~
   
   [[/img/vue3/compiler-core/pcg/pcg-02-3-codegen-div-with-id.svg]]
** v-bind æŒ‡ä»¤ ~<div :class="bar.baz"></div>~
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-03
:END: 

ç»“æœé¢„è§ˆï¼š
#+begin_src js
  (function anonymous(
  ) {
    const _Vue = Vue

    return function render(_ctx, _cache) {
      with (_ctx) {
        const { createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

        return (_openBlock(), _createBlock("div", { class: bar.baz }, null, 2 /* CLASS */))
      }
    }
  })
#+end_src

1. *parser é˜¶æ®µï¼š*

   [[/img/vue3/compiler-core/pcg/pcg-03-1-parser-div-with-bind.svg]]
   
2. *compiler é˜¶æ®µï¼š*

   [[/img/vue3/compiler-core/pcg/pcg-03-2-compiler-div-with-bind.svg]]
   
3. *codegen é˜¶æ®µï¼š*

   [[/img/vue3/compiler-core/pcg/pcg-03-3-codegen-div-with-bind.svg]]
** æ’å€¼ ~<div>{{ world.burn() }}</div>~
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-04
:END: 

#+begin_src js
  (function anonymous(
  ) {
    const _Vue = Vue

    return function render(_ctx, _cache) {
      with (_ctx) {
        const { toDisplayString : _toDisplayString, createVNode : _createVNode, openBlock : _openBlock, createBlock : _createBlock } = _Vue

        return (_openBlock(), _createBlock("div", null, _toDisplayString(world.burn()), 1 /* TEXT */))
      }
    }
  })
#+end_src

1. *parser é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-04-1-parser-div-with-interpolation.svg]]
   
2. *compiler é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-04-2-compiler-div-with-interpolation.svg]]
   
3. *codegen é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-04-3-codegen-div-with-interpolation.svg]]
** v-if æŒ‡ä»¤ ~<div><div v-if="ok">yes</div></div>~
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-05
:END: 

vue.global:
#+begin_src js
  (function anonymous(
  ) {
    const _Vue = Vue
    const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue

    const _hoisted_1 = { key: 0 }

    return function render(_ctx, _cache) {
      with (_ctx) {
        const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, createCommentVNode: _createCommentVNode } = _Vue

        return (_openBlock(), _createBlock("div", null, [
          ok
            ? (_openBlock(), _createBlock("div", _hoisted_1, "yes"))
            : _createCommentVNode("v-if", true)
        ]))
      }
    }
  })
#+end_src

å·®å¼‚ç‚¹ï¼š

- å°‘äº†å…¨å±€ä½œç”¨åŸŸä¸‹çš„ ~_Vue~ è§£æ„
- key æ²¡æœ‰ hoisted
  
è„‘å›¾åˆ—è¡¨ï¼š 
1. *parser é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-05-1-parser-div-with-if.svg]]
2. *compiler é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-05-2-compiler-div-with-if.svg]]
3. *codegen é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-05-3-codegen-div-with-if.svg]]
*** æ‹“å±• 1ï¼šv-if-else æŒ‡ä»¤ 
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-05-01
:END: 

~<div><div v-if="ok">yes</div><div v-else>no</div></div>~

vue.global:
#+begin_src js
  (function anonymous(
  ) {
    const _Vue = Vue
    const { createVNode: _createVNode, createCommentVNode: _createCommentVNode } = _Vue

    const _hoisted_1 = { key: 0 }
    const _hoisted_2 = { key: 1 }

    return function render(_ctx, _cache) {
      with (_ctx) {
        const { createVNode: _createVNode, openBlock: _openBlock, createBlock: _createBlock, createCommentVNode: _createCommentVNode } = _Vue

        return (_openBlock(), _createBlock("div", null, [
          ok
            ? (_openBlock(), _createBlock("div", _hoisted_1, "yes"))
            : (_openBlock(), _createBlock("div", _hoisted_2, "no"))
        ]))
      }
    }
  })
#+end_src

ä¸ [[#pcg-05][pcg-05]] å·®å¼‚ï¼š

#+begin_src js
  ok
    ? (_openBlock(), _createBlock("div", _hoisted_1, "yes"))
    : _createCommentVNode("v-if", true) // è¿™é‡Œæ²¡æœ‰ elseif, else åˆ†æ”¯ä¼šåˆ›å»ºä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹
#+end_src

å’Œ

#+begin_src js
  ok
    ? (_openBlock(), _createBlock("div", _hoisted_1, "yes"))
    : (_openBlock(), _createBlock("div", _hoisted_2, "no")) // åˆ†æ”¯èŠ‚ç‚¹
#+end_src

é€ æˆè¿™å·®ä¸€ç‚¹æ˜¯åœ¨å“ªå¤„ç†çš„å‘¢ï¼Ÿï¼Ÿï¼Ÿ

v-if æŒ‡ä»¤çš„ codegen è¿‡ç¨‹æœ‰ä¸‰ä¸ªé‡è¦å› ç´ ï¼š
1. test ç”Ÿæˆæ¡ä»¶è¡¨è¾¾å¼
2. consequent ç”Ÿæˆæˆç«‹æ¡ä»¶(~ok=true~)è¡¨è¾¾å¼çš„
3. alternate ç”Ÿæˆå¤±è´¥æ¡ä»¶(~ok=false~)è¡¨è¾¾å¼çš„

å› æ­¤è¯¥æ‰©å±•é‡ç‚¹åœ¨ alternate å¤„ç† ğŸ›¬...

åœ¨ transform é˜¶æ®µé’ˆå¯¹ ~v-else~ çš„å¤„ç†é€»è¾‘ï¼š

#+begin_quote
traverseNode ä¸­çš„ exitFns æ”¶é›†é˜¶æ®µï¼Œè°ƒç”¨ transformIf å– transform å‡½æ•°è¿‡ç¨‹ä¸­ï¼Œæœ‰
ä»¥ä¸‹å‡ ä¸ªé‡è¦æ­¥éª¤ï¼š

1. éå†å½“å‰ ~v-else~ èŠ‚ç‚¹çš„æ‰€æœ‰å…„å¼ŸèŠ‚ç‚¹(~siblings=parent.children~)
2. æ‰¾åˆ°å½“å‰èŠ‚ç‚¹ node åœ¨ ~siblings~ ä¸­çš„ä½ç½® i
3. ~while i--~ ä¾æ¬¡å¾€å‰æ‰¾å…„å¼ŸèŠ‚ç‚¹(å¦‚æœæ˜¯ *COMMENT* èŠ‚ç‚¹ï¼Œåˆ é™¤ä¿å­˜å¾…æ¢å¤ï¼Œå¦‚æœæ˜¯
   *9,IF* èŠ‚ç‚¹å³æ‰¾åˆ°çš„ç›®æ ‡èŠ‚ç‚¹ sibling)
4. åˆ é™¤å½“å‰çš„ node åŒæ—¶è°ƒç”¨ [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-createifbranch][createIfBranch]] åˆ›å»º ~10,IF_BRANCH~ ç±»å‹çš„åˆ†æ”¯èŠ‚ç‚¹ç»“
   æ„ï¼Œåˆå¹¶åˆ° ~sibling.branches~ ä¸­
   
5. è°ƒç”¨ ~processCodegen~ å‡½æ•°å³ ~transformIf~ æ—¶å€™æ‰§è¡Œä¼šå¾—åˆ°ç”Ÿæˆ ~codegenNode~
   çš„é‚£ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå®ƒè·å– tranform å‡½æ•° ~exitFn~ ã€‚
6. æ‰‹åŠ¨æ‰§è¡Œ [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-traversenode][traverseNode(node, ...)]] è¿›è¡Œé€’å½’éå†è¯¥ v-else èŠ‚ç‚¹æ ‘(*å› ä¸ºåœ¨ 4 ä¸­èŠ‚ç‚¹
   è¢«åˆ é™¤äº†ï¼Œå› æ­¤ä¸»é€’å½’çº¿ä¸Šä¸ä¼šå‡ºç°è¿™ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ traverse*)
7. æœ€åæ‰§è¡Œ exitFn ç”Ÿæˆè¯¥ ~v-else~ èŠ‚ç‚¹æ ‘çš„ ~codegenNode~ ã€‚

   *æ³¨æ„ç‚¹* ï¼šè¿™ä¸€æ­¥ ~v-else~ æ›¿æ¢ alternate è¿‡ç¨‹ä¸­æœ‰ä¸ª while å¾ªç¯ç”¨æ¥é€’å½’æŸ¥æ‰¾é
   *19,JS_CONDITIONAL_EXPRESSION* ç±»å‹çš„èŠ‚ç‚¹çš„ alternate å†è¿›è¡Œæ›¿æ¢ï¼Œè¿™ä¹ˆåšçš„åŸ
   å› æ˜¯ v-if-else æŒ‡ä»¤çš„åœ¨ render å‡½æ•°ä¸­æ˜¯é€šè¿‡ä¸‰ç›®è¿ç®—ç¬¦(~?:~)å®ç°çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹
   ~:~ åé¢çš„æ˜¯ä¸€ä¸ª comment vnode ç±»å‹å ä½ç”¨ï¼Œå½“å®é™…æœ‰ else åˆ†æ”¯çš„æ—¶å€™ä¼šè¿›è¡Œæ›¿æ¢ï¼Œ
   æ­¤æ—¶æ›¿æ¢éœ€è¦è€ƒè™‘åˆ°è¡¨è¾¾å¼åµŒå¥—çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°æœ€åé‚£ä¸ª comment vnode ï¼Œè¯¦ç»†
   æ­¥éª¤ç›´æ¥çœ‹è„‘å›¾å§ã€‚

#+end_quote

1. *parser é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-05-01-1-parser-div-with-if-else.svg]]
   
2. *transform é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-05-01-2-compiler-div-with-if-else.svg]]
   
3. *codegen é˜¶æ®µ*

   [[/img/vue3/compiler-core/pcg/pcg-05-01-3-codegen-div-with-if-else.svg]]
*** æ‹“å±• 2ï¼šv-if-elseif-else æŒ‡ä»¤ 
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-05-02 
:END: 


1. *parser é˜¶æ®µ*

   ç›¸æ¯”è¾ƒ [[#pcg-05-01][æ‹“å±•1ï¼šv-if-else]] è¿™é‡Œåªæ˜¯å¤šäº†ä¸€ä¸ª v-else-if è¿™åœ¨ parser é˜¶æ®µæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œ
   ç›´æ¥å‚è€ƒæ‹“å±• 1 çš„è„‘å›¾ã€‚

   [[/img/vue3/compiler-core/pcg/pcg-05-02-1-parser-div-with-if-else.svg]]
   
2. *transform é˜¶æ®µ*
2. *codegen é˜¶æ®µ*
      
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: pcg-05-02
:END: 

* â˜€ å…³é”®åŠŸèƒ½
è¿™ä¸€ç« èŠ‚æ˜¯é’ˆå¯¹æ•´ä¸ª vue3 æºç è§£æ„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜æˆ–ä¸€äº›é‡è¦æˆ–å…³é”®çš„ä¸€äº›åŠŸèƒ½ï¼Œè¿›
è¡Œæå–è§£è¯»ã€‚
** DONE 1. buildProps(node, context) å¦‚ä½•æ„å»º props ?
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: key-01-build-props
:END: 

CLOSED: [2020-09-18 Fri 16:07]

- State "DONE"       from "TODO"       [2020-09-18 Fri 16:07]


props åœ¨ compile é˜¶æ®µæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæ˜¯å¦‚ä½•ä»([[#compiler-04][ç¤ºä¾‹04]]) 

[[http://qiniu.ii6g.com/img/20200918160246.png]]

å˜æˆä¸‹é¢è¿™æ ·çš„ï¼š

[[http://qiniu.ii6g.com/img/20200918160311.png]]

å®Œæ•´æµç¨‹ï¼š
[[/img/vue3/compiler-core/key/key-01-how-build-props.svg]]

** DONE 2. transformIf() æ˜¯å¦‚ä½•è¿”å› v-if æŒ‡ä»¤çš„ transform çš„ï¼Ÿ
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: key-02-transform-if
:END: 

å‚è€ƒ[[#compiler-05][ç”¨ä¾‹ 05]]

v-if æŒ‡ä»¤æ˜¯å¦‚ä½•è½¬æ¢çš„ï¼Ÿï¼Ÿï¼Ÿ

è¿™ä¸ªè½¬æ¢å‡½æ•°åˆæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿï¼Ÿï¼Ÿ

å¾—åˆ°è¿™ä¸ªè½¬æ¢å‡½æ•°è¿‡ç¨‹ä¸­åšäº†ä»€ä¹ˆ ï¼Ÿï¼Ÿï¼Ÿ

#+begin_quote
é€šè¿‡åœ¨ [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-traversenode][traverseNode]] ä¸­ï¼Œ switch node é˜¶æ®µä¹‹å‰ï¼Œæ”¶é›† transform å‡½æ•°åˆ° ~exitFns[]~
ä¸­çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°äº† v-if æŒ‡ä»¤çš„å…ƒç´ ï¼Œä¼šæ‰§è¡Œ ~transformIf~ ï¼Œè¿™ä¸ªæ—¶å€™ä¼šéå†è§£æ
~node.props~ æ‹¿åˆ°è¿™ä¸ª v-if æŒ‡ä»¤å±æ€§ï¼Œè°ƒç”¨ processIf å°†è¯¥èŠ‚ç‚¹è½¬æ¢æˆ 

#+begin_src js
  {
    branches: [branch],
    type: 9 // IF
  }
#+end_src

å¹¶ä¸”ç”¨è¿™ä¸ªæ–°ç”Ÿæˆçš„èŠ‚ç‚¹ç»“æ„å»æ›¿æ¢åŸæ¥çš„ div v-if èŠ‚ç‚¹ç»“æ„ã€‚

å³ï¼šåœ¨æ‹¿åˆ° transform if å‡½æ•°ä¹‹å‰ div v-if èŠ‚ç‚¹ç»“æ„å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œæˆä¸ºäº†

~type = 9~ çš„ç»“æ„ï¼Œæœ€ååŸæ¥çš„èŠ‚ç‚¹æˆä¸ºäº† branches çš„å…ƒç´ ã€‚

å¹¶ä¸”åŸèŠ‚ç‚¹çš„ props ä¼šè¢«æ¸…ç©º(é¿å…å›æº¯çš„æ—¶å€™é‡å¤å¤„ç†)ã€‚
#+end_quote

transformIf:

#+begin_src js
  const transformIf = createStructuralDirectiveTransform(
    /^(if|else|else-if)$/,
    (node, dir, context) => {
      return processIf(node, dir, context, (ifNode, branch, isRoot) => {
        // Exit callback. Complete the codegenNode when all children have been
        // transformed.
        return () => { // è¿™ä¸ªæ‰æ˜¯çœŸæ­£åœ¨å›æº¯è¿‡ç¨‹ä¸­è°ƒç”¨çš„ transform if å‡½æ•°
          if (isRoot) {
            ifNode.codegenNode = createCodegenNodeForBranch(branch, 0, context);
          } else {
            // attach this branch's codegen node to the v-if root.
            let parentCondition = ifNode.codegenNode;
            while (
              parentCondition.alternate.type ===
                19 /* JS_CONDITIONAL_EXPRESSION */
            ) {
              parentCondition = parentCondition.alternate;
            }
            parentCondition.alternate = createCodegenNodeForBranch(
              branch,
              ifNode.branches.length - 1,
              context
            );
          }
        };
      });
    }
  );
#+end_src

æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/key/key-02-transform-if.svg]]
** TODO 3. codegen å¦‚ä½•ç”Ÿæˆå±æ€§(_createBLock(tag, props, ...))ç¬¬äºŒä¸ªå‚æ•°ï¼Ÿ
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: key-03-how-gen-props
:END: 

å¦‚ï¼š
#+begin_src js
  // ...

  return (_openBlock(), _createBlock('div', {
    id: "foo",
    class: bar.baz
  }))
#+end_src

id å’Œ class æ˜¯å¦‚ä½•ç”Ÿæˆå¯¹è±¡çš„ã€‚

** DONE 4. transform é˜¶æ®µå¦‚ä½•å¯¹å±æ€§é™æ€æå‡ï¼Ÿ 
CLOSED: [2020-09-28 Mon 10:55]
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: key-04-how-hoist
:END: 

- State "DONE"       from "TODO"       [2020-09-28 Mon 10:55]
æ²¡æœ‰ hoist ä¹‹å‰ï¼š

#+begin_src js
  return (_openBlock(), _createBlock("div", null, [
    ok
      ? (_openBlock(), _createBlock("div", { key: 0 }, "yes"))
      : _createCommentVNode("v-if", true)
  ]))
#+end_src

æœ‰ hoist ä¹‹åï¼š
#+begin_src js
  (function anonymous(
  ) {
    const _Vue = Vue
    // ... çœç•¥

    // æå‡åˆ° render å‡½æ•°ä¹‹å
    const _hoisted_1 = { key: 0 }

    return function render(_ctx, _cache) {
      with (_ctx) {
        // ... çœç•¥
        return (_openBlock(), _createBlock("div", null, [
          ok
            ? (_openBlock(), _createBlock("div", _hoisted_1, "yes"))
            : _createCommentVNode("v-if", true)
        ]))
      }
    }
  })
#+end_src

[[/img/vue3/compiler-core/key/key-04-how-hoist-props.svg]]

*transform* é˜¶æ®µæ˜¯åœ¨ æ‰§è¡Œå®Œ [[vue/vue3-source-code-compiler-core-compile_ts/#transform-traversenode][traverseNode()]] ä¹‹åè°ƒç”¨ [[/vue/vue3-source-code-compiler-core-compile_ts/#transform-hoiststatic][hoistStatic(root,context)]] é€šè¿‡ walk() é€’å½’éå†
æ‰€æœ‰çš„å­©å­èŠ‚ç‚¹æ¥æ£€æµ‹æ»¡è¶³æ¡ä»¶çš„ hoist å±æ€§æˆ–èŠ‚ç‚¹ã€‚

#+begin_quote
å³ï¼šé™æ€æå‡åŠ¨ä½œå‘ç”Ÿåœ¨æ‰€æœ‰èŠ‚ç‚¹çš„ codegenNode è§£æå®Œæ¯•ä¹‹å(ä¸”æ»¡è¶³ï¼š
~options.hoistStatic = true~)ã€‚
#+end_quote

*codegen* é˜¶æ®µæ˜¯åœ¨ [[/vue/vue3-source-code-compiler-core-compile_ts/#codegen-genfunctionpreamble][genFunctionPreamable(ast, context)]] æ£€æµ‹ ast.hoists æ•°ç»„å°†éœ€è¦ç”¨
åˆ°çš„å‡½æ•°æå‡åˆ° render ä¹‹å¤–ï¼Œç„¶åè°ƒç”¨ [[/vue/vue3-source-code-compiler-core-compile_ts/#codegen-genhoists][genHoists(ast.hoists)]] ç”Ÿæˆéœ€è¦æå‡çš„å±æ€§ã€‚

æœ€åæ ¹æ®ï¼š

#+begin_src js
  node:
    content: "_hoisted_1"
    isConstant: true
    isStatic: false
    type: 4 // SIMPLE_EXPRESSION
#+end_src

æœ€åç”¨ ~_hoisted_1~ æ¥æ›¿ä»£ ~{ key: 0 }~ è¿™ä¸ªæƒŠå¤©å±æ€§ã€‚
** DONE 5. codegen å¦‚ä½•ç”Ÿæˆ if-elseif-else åˆ†æ”¯èŠ‚ç‚¹ ?
CLOSED: [2020-10-04 Sun 12:47]
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: key-05-gen-branch
:END: 

- State "DONE"       from "TODO"       [2020-10-04 Sun 12:47]
[[#key-02-transform-if][ç”Ÿæˆåˆ†æ”¯å…¥å£å‡½æ•°äº§ç”Ÿè¿‡ç¨‹]]ï¼š[[/vue/vue3-source-code-compiler-core-compile_ts/#transform-traversenode][traverseNode]] ä¸­æ”¶é›† ~exitFns~ è¿‡ç¨‹ä¸­æ‰§è¡Œ ~transformIf~
ç»è¿‡ä¸€äº›åˆ—æ“ä½œä¹‹åå¾—åˆ°ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨å½“å‰èŠ‚ç‚¹æ ‘é€’å½’ç»“æŸåè°ƒç”¨ï¼Œç”Ÿæˆ
~codegenNode~

è¿”å›çš„åˆ†æ”¯èŠ‚ç‚¹ codegenNode ç»“æ„ï¼š

#+begin_src js
  {
      "type":19,
      "test":{ // ok ? ... : ...
          "type":4,
          "content":"ok",
          "isStatic":false,
          "isConstant":false,
          "loc":{
              // ...
              "source":"ok"
          }
      },
      "consequent":{ // cond ? è¿™é‡Œçš„ä»£ç  : ...
          "type":13,
          "tag":""div"",
          "props":{
              "type":15,
              "loc":{ /* ... */ },
              "properties":[
                  {
                      "type":16,
                      "key":{
                          "type":4,
                          "isConstant":false,
                          "content":"key",
                          "isStatic":true
                      },
                      "value":{
                          "type":4,
                          "isConstant":false,
                          "content":"0",
                          "isStatic":false
                      }
                  }
              ]
          },
          "children":{
              "type":2,
              "content":"yes",
              "loc":{
                  "source":"yes"
              }
          },
          "isBlock":true,
          "isForBlock":false,
          "loc":{
              "source":"<div v-if="ok">yes</div>"
          }
      },
      "alternate":{ // cond ? ... : è¿™é‡Œçš„ä»£ç 
          "type":14,
          "loc":{
              "source":"",
          },
          "arguments":[
              ""v-if"",
              "true"
          ]
      },
      "newline":true,
  }
#+end_src

å¤„ç†æµç¨‹å›¾ï¼š

[[/img/vue3/compiler-core/key/key-05-how-gen-if-branches.svg]]

** TODO 6. transform é˜¶æ®µå¦‚ä½•è½¬æ¢ v-else-if æŒ‡ä»¤ï¼Ÿ
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: key-06-how-transform-v-else-if
:END: 

ç¤ºä¾‹ä»£ç ï¼š

#+begin_src html
  <div>
    <div v-if="ok">yes</div>
    <div v-else-if="nok">nok</div>
    <div v-else>no</div>
  </div>
#+end_src

* â˜ compiler-core: parser

vue3.0 çš„è§£æå™¨æ¨¡å—ï¼Œå°† html æ¨¡æ¿è§£ææˆ AST å¯¹è±¡ã€‚

** å¸¦æŒ‡ä»¤çš„æ ‡ç­¾è§£æå…¨è¿‡ç¨‹(~v-bind~)
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-with-directive
:END:

ä»£ç ï¼š ~baseParse(`<div v-bind:keyup.enter.prevent="ok"></div>`)~

1. parseChildren :arrow_right: while
2. parseElement :arrow_left: ~<div ....></div>~
3. parseTag :arrow_right: *node: div* :arrow_right: parseAttributes è§£æå±æ€§ :arrow_left: ~v-bind:keyup...></div>~
4. parseAttribute :arrow_right:
   1) å…ˆè§£æ ~="ok"~ å‡ºå€¼
   2) åè§£æ ~v-bind:keyup.enter.prevent~
5. æœ€åå¾—åˆ° ~props[0] -> { name: 'bind', arg: { content: 'keyup', ... }, exp:
   { content: 'ok', ... }, modifiers: ['enter', 'prevent' ]}~
   1) name: æŒ‡ä»¤çš„åç§°ï¼Œ ~v-bind, @~ éƒ½ä¼šè½¬æˆ *bind* åç§°
   2) arg: è¡¨ç¤ºæŒ‡ä»¤ç»‘å®šçš„å‚æ•°åç§°ï¼Œè¿™é‡Œå¯ä»¥æ˜¯åŠ¨æ€å˜é‡ï¼Œå¦‚ï¼š
      ~v-bind:[dynamicVarName]~ ï¼Œç”± ~arg.isConstant~ æ ‡è¯†ã€‚
   3) exp: è¡¨ç¤ºè¡¨è¾¾å¼çš„å€¼


æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/parser-test-tag-with-directive-v-bind.png]]

** æ ‡ç­¾è§£æ(~<div>hello world</div>~)
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-simple-div
:END:

ä»£ç ï¼š ~baseParse(`<div>hello world</div>`)~

1. parseChildren while å¼€å§‹è§£æ
2. é‡åˆ° ~<d~ æ»¡è¶³ ~/^[z-a]/i~ è¿›å…¥ parseElement è§£ææ ‡ç­¾
3. parseElement -> parseTag è§£æå‡ºåä¸º *div* çš„æ ‡ç­¾èŠ‚ç‚¹ï¼Œ ~content = `hello world</div>`~
4. parseElement -> parseChildren è§£æå‡º *hello world* æ–‡æœ¬èŠ‚ç‚¹ä½œä¸º div èŠ‚ç‚¹çš„
   children[0]ï¼Œ ~content = `</div>`~
5. è¿”å›åˆ° parseChildren è§£æ ~</div>~ å‘ç° ~ancestors~ æœ‰å†…å®¹ä¸”æ‰¾åˆ°äº†
   ~</div>~ åŒ¹é…çš„ ~<div>~ èŠ‚ç‚¹ï¼Œæœ€åå®ŒæˆåŒ¹é…ã€‚


æµç¨‹å›¾ï¼š

[[/img/vue3/compiler-core/parser-test-simple-tag-div.png]]

*** è‡ªé—­åˆæ ‡ç­¾(=<img/>=)çš„è§£æï¼Œä¹Ÿåœ¨ [[/vue/vue3-source-code-compiler-core/#parsetagcontext-type-parent][parseTag]] é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªé’ˆå¯¹è¿™ä¸ªçš„å¤„ç†ï¼š
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-self-closing
:END:

#+begin_src js

  // è§£æåˆ°è¿™é‡Œçš„æ—¶å€™ content åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š`/>xxx`
  isSelfClosing = startsWith(context.source, '/>')
  if (type === TagType.End && isSelfClosing) {
    // å¦‚æœè‡ªé—­åˆæ²¡æœ‰å¼€å§‹æ ‡ç­¾ï¼Œæ˜¯éæ³•çš„
    emitError(context, ErrorCodes.END_TAG_WITH_TRAILING_SOLIDUS)
  }

  // è¿™é‡Œåˆ¤æ–­å¦‚æœæ˜¯è‡ªé—­åˆçš„ï¼Œé‚£ä¹ˆè¯¥æ ‡ç­¾çš„è§£æå°±å·²ç»ç»“æŸäº†
  advanceBy(context, isSelfClosing ? 2 : 1)
#+end_src

*** ç©ºæ ‡ç­¾çš„å¤„ç†ï¼Œéœ€è¦åœ¨è°ƒç”¨è§£æå‡½æ•° [[/vue/vue3-source-code-compiler-core/#baseparsecontext-options][baseParse]] çš„æ—¶å€™æ˜ç¡®å‘ŠçŸ¥å®ƒå“ªäº›æ˜¯ç©ºæ ‡ç­¾(å¦‚ï¼š ~<img>~)ï¼š
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-void-tag
:END:

#+begin_src js
  const ast = baseParse('<img>after', {
    isVoidTag: (tag) => tag === 'img'
  })
#+end_src

~isVoidTag~ ä¼šåœ¨ [[/vue/vue3-source-code-compiler-core/#parseelementcontext-mode][parseElement]] çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œåœ¨è°ƒç”¨ [[/vue/vue3-source-code-compiler-core/#parsetagcontext-type-parent][parseTag]] è§£æå®Œ
*TagType.Start* ä¹‹åæ£€æµ‹ï¼Œå¦‚æœæ˜¯ç©ºæ ‡ç­¾ç±»å‹ï¼Œä¼šç›´æ¥é€€å‡ºè§£æå³å®Œæˆè¯¥æ ‡ç­¾çš„è§£æ
è¿‡ç¨‹(å› ä¸ºæ˜¯ç©ºæ ‡ç­¾ï¼Œæ‰€ä»¥åé¢çš„å†…å®¹å°±ä¸å†å±äºå®ƒäº†ï¼Œå¯ä»¥ç»“æŸäº†)ï¼š

#+begin_src js
  // è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†
  if (element.isSelfClosing || context.options.isVoidTag?.(element.tag)) {
    return element;
  }
#+end_src

*** æ¨¡æ¿æ ‡ç­¾çš„è§£æ(~<template></template>~)
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-template
:END:

è¿™ä¸ªè§£æå’Œæ™®é€šæ ‡ç­¾åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯åœ¨ parseTag é‡Œé¢è§£æçš„æ—¶å€™æ›´æ–°ä¸‹ç±»å‹å°±å¯ä»¥äº†ï¼Œå¾ˆ
ç®€å•çš„æ“ä½œï¼š

#+begin_src typescript
  function parseTag(
      context: ParserContext,
      type: TagType,
      parent: ElementNode | undefined
  ): ElementNode {

      // ...çœç•¥ï¼Œè¿™äº›éƒ½å¯ä»¥çœç•¥äº†ï¼Œå’Œæ™®é€šæ ‡ç­¾å¤„ç†ä¸€æ¨¡ä¸€æ ·

      let tagType = ElementTypes.ELEMENT
      const options = context.options
      if (!context.inVPre && !options.isCustomElement(tag)) {
          // ...çœç•¥ï¼Œvue å†…ç½®ç»„ä»¶ç±»å‹

          if (tag === 'slot') {
              tagType = ElementTypes.SLOT
          } else if (
              // æ‰€ä»¥è¿™é‡Œæ‰æ˜¯é‡ç‚¹ï¼Œä½œä¸ºæ¨¡æ¿æ ‡ç­¾å¿…é¡»æ»¡è¶³ä¸€å®šçš„æ¡ä»¶
              // 1. å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå±æ€§ï¼Œä¸”ç±»å‹æ˜¯æŒ‡ä»¤
              // 2. å¹¶ä¸”æ»¡è¶³ const isSpecialTemplateDirective = /*#__PURE__*/ makeMap(`if,else,else-if,for,slot`)
              // å³è¯¥æŒ‡ä»¤å¿…é¡»æ˜¯ if, else, else-if, for, slotï¼Œä¹Ÿå°±æ˜¯è¯´æ¨¡æ¿å¿…é¡»ç”¨ä½œå¾ªç¯æˆ–æ’æ§½æ—¶ä½¿ç”¨
              tag === 'template' &&
                  props.some(p => {
                      return (
                          p.type === NodeTypes.DIRECTIVE && isSpecialTemplateDirective(p.name)
                      )
                  })
          ) {
              tagType = ElementTypes.TEMPLATE
          }
      }

      return {
          type: NodeTypes.ELEMENT,
          ns,
          tag,
          tagType,
          props,
          isSelfClosing,
          children: [],
          loc: getSelection(context, start),
          codegenNode: undefined // to be created during transform phase
      }
  }
#+end_src

æ‰€ä»¥ä¸‹é¢è¿™ä¸¤ä¸ªç”¨ä¾‹å°±èƒ½å¾ˆå¥½çš„å¾—åˆ°è§£é‡Šäº†ï¼š

#+begin_src js
  test("template element with directives", () => {
    const ast = baseParse('<template v-if="ok"></template>');
    const element = ast.children[0];
    expect(element).toMatchObject({
      type: NodeTypes.ELEMENT,
      tagType: ElementTypes.TEMPLATE, // è¿™é‡Œæ˜¯æ¨¡æ¿ç±»å‹ï¼Œå› ä¸ºæœ‰ `v-if' æŒ‡ä»¤
    });
  }); // template element with directives

  test("template element without directives", () => {
    const ast = baseParse("<template></template>");
    const element = ast.children[0];
    expect(element).toMatchObject({
      type: NodeTypes.ELEMENT,
      tagType: ElementTypes.ELEMENT, // è€Œè¿™é‡Œä¾æ—§æ˜¯å…ƒç´ ç±»å‹ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•æŒ‡ä»¤
    });
  });

#+end_src
** è§£ææ— æ•ˆçš„ ~</div>~
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-invalid-div
:END:

ä»£ç ï¼š ~baseParse(`</div>`)~

ç»è¿‡çš„å‡½æ•°ï¼š

1. parseChildren è¿›å…¥è§£æ while
2. parseText è§£æå‡ºæœ‰æ•ˆæ–‡æœ¬
3. å›åˆ° parseChildren while å¾ªç¯è§£æ ~</div>~ æŠ¥é”™


æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/parser-test-invalid-end-tag.png]]

** æ’å€¼è§£æ ~some {{ foo + bar }} text~
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-interpolation
:END:

ä»£ç ï¼š ~baseParse(`some {{ foo + bar }} text`)~

1. parseChildren :arrow_right: while: ~some {{ foo + bar }} text~
2. parseText :arrow_right: node[0]: ~`some`~
3. ~{{ foo + bar }} text~  :arrow_right:  parseInterpolation  :arrow_right:
   node[1]: ~foor + bar~
4. ~` text`~ :arrow_right: parseText :arrow_right: node[2]: ~`text`~
5. nodes -> root.children

è§£æè¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š
1. æ’å€¼è§£æï¼Œé¦–å…ˆæ˜¯åŒ¹é… `{{` ç„¶åå»çš„ *}}* çš„ç´¢å¼•ï¼Œæœ€åé€šè¿‡ ~slice(startIdx,
   endIdx)~ å–åˆ°è¦è§£æçš„è¡¨è¾¾å¼ã€‚
2. ~`some`~ å’Œ  ~`text`~ ä¸ä¼šåˆå¹¶åˆ°ä¸€ä¸ª node ä¸­ï¼Œå› ä¸ºä¸æ˜¯ç›¸é‚»çš„ï¼Œè¯·æ³¨æ„åˆå¹¶æ–‡
   æœ¬ ndoe çš„å‰ææ¡ä»¶ï¼šå‰ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¿…é¡»æ˜¯æ–‡æœ¬èŠ‚ç‚¹ç±»å‹ã€‚

æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/parser-test-text-with-interpolation.png]]

** è§£æ ~simple text~
:PROPERTIES:
:COLUMNS:  %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: map-parse-simple-text
:END:

è§£æçº¯æ–‡æœ¬ï¼Œåªä¼šè¿›å…¥ while å¾ªç¯ä¸­çš„ !node æ£€æµ‹ç„¶åè¿›å…¥ ~parseText~ çº¯æ–‡æœ¬è§£
æï¼Œä¼šåŒ¹é… ~<, {{, ]]>~ ä½œä¸ºçº¯æ–‡æœ¬çš„ç»“æŸæ ‡å¿—ã€‚

å¾—åˆ°çº¯æ–‡æœ¬å†…å®¹åä¼ é€’ç»™ ~parseTextData~ æ›¿æ¢ ~/&(gt|lt|amp|apos|quot);/g~
html è¯­ä¹‰ç¬¦å·ä¹‹åè¿”å›ç»™ ~parseText:content~ ç»„ç»‡æ–‡æœ¬èŠ‚ç‚¹ç»“æ„è¿”å›ã€‚

é€€å‡º while å¾ªç¯ï¼Œå°† node å¡åˆ° ~root.children[]~ é‡Œé¢ï¼Œä½œä¸ºæ ¹èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹ã€‚

ä»£ç ï¼š ~baseParse(`simple text`)~

æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/parser-test-simple-text.png]]

* ğŸŒ™ compiler-core: compiler

vu3.0 ç¼–è¯‘å™¨æ¨¡å—ï¼Œå°† parser è§£æå¾—åˆ°çš„ AST å¯¹è±¡ç¼–è¯‘æˆå¯¹åº”çš„ render å‡½æ•°ã€‚

è¯¥æ¨¡å—ä¸»è¦å®ç°çš„ä¸‰å¤§å—ï¼Œå› ä¸ºè¿™ä¸‰ä¸ªå…³è”æ€§å¾ˆå¼ºï¼Œå› æ­¤æ”¾åˆ°ä¸€å—äº†ã€‚

1. compile.ts ç¼–è¯‘å™¨ä¸»æ¨¡å—
2. transform.ts å³ transforms/ ç›®å½•ï¼Œè¯­æ³•è½¬æ¢æ¨¡å—ï¼Œå…¥å£å‡½æ•°ï¼š transform()ï¼Œæ¯”å¦‚ï¼š
   v-if æŒ‡ä»¤ï¼Œå‡½æ•°ï¼Œå˜é‡ç­‰
3. codegen.ts å…¥å£å‡½æ•°ï¼š generate() ï¼Œç”Ÿæˆä»£ç å­—ç¬¦ä¸²ï¼Œç”¨æ¥è°ƒç”¨ ~new
   Function(code)~ ç”Ÿæˆ render å‡½æ•°ã€‚


æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/compiler.png]] 

** 01-simple text ç¼–è¯‘è¿‡ç¨‹
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: compiler-01
:END: 

ä»£ç ï¼š
#+begin_src js
  compile(`simple text`, {
    filename: `foo.vue`
  })
#+end_src

[[/vue/vue3-source-code-compiler-core-compile_ts/#test-text-01][01-simple-text æµ‹è¯•ç”¨ä¾‹åœ°å€]]

æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/compiler-test-simple-text.png]]

[[/vue/vue3-source-code-compiler-core-compile_ts/#test-cc-01][è¯¦ç»†è¿‡ç¨‹åˆ†æè¯·ç‚¹å‡»é“¾æ¥ã€‚]]

** 02-pure interpolation ç¼–è¯‘è¿‡ç¨‹
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: compiler-02
:END: 

ä»£ç ï¼š
#+begin_src js
  compile(`{{ world.burn() }}`, {
    filename: `foo.vue`,
  })
#+end_src

[[/vue/vue3-source-code-compiler-core-compile_ts/#test-02-worldburn][02-pure-interpolation æµ‹è¯•ç”¨ä¾‹åœ°å€]]

æµç¨‹å›¾ï¼š

[[/img/vue3/compiler-core/compiler-test-pure-interpolation.png]]

[[/vue/vue3-source-code-compiler-core-compile_ts/#test-cc-02][è¯¦ç»†è¿‡ç¨‹åˆ†æè¯·ç‚¹å‡»é“¾æ¥ã€‚]]
** 03-inerpolation in pure div 
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: compiler-03
:END: 

ä»£ç ï¼š
#+begin_src js
  compile(`<div>{{ world.burn() }}</div>`, {
    filename: `foo.vue`,
  })
#+end_src

[[/vue/vue3-source-code-compiler-core-compile_ts/#test-cc-03][ç”¨ä¾‹åœ°å€]]

æµç¨‹å›¾ï¼š

[[/img/vue3/compiler-core/compiler-test-interpolation-in-div.svg]]

[[/vue/vue3-source-code-compiler-core-compile_ts/#test-cc-03][è¯¦ç»†è¿‡ç¨‹åˆ†æè¯·ç‚¹å‡»é“¾æ¥ã€‚]]
** 04-interpolation in div with props
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: compiler-04
:END: 

ä»£ç ï¼š
#+begin_src js
  compile(`<div id="foo" :class="bar.baz">{{ world.burn() }}</div>`, {
    filename: `foo.vue`,
  })
#+end_src

[[/vue/vue3-source-code-compiler-core-compile_ts/#test-cc-04][ç”¨ä¾‹åœ°å€]]

æµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/compiler-test-interpolation-in-div-with-props.svg]]

** 05-interpolation, v-if, props
:PROPERTIES:
:COLUMNS: %CUSTOM_ID[(Custom Id)]
:CUSTOM_ID: compiler-05
:END:  

#+begin_src js
  code = `
  <div id="foo" :class="bar.baz">
  {{ world.burn() }}
  <div v-if="ok">yes</div>
  </div>`
#+end_src

å¦‚æœæ”¾åˆ°ä¸€å¼ å›¾é‡Œé¢ï¼Œå®åœ¨å¤ªç¹çäº†ï¼Œç®€åŒ–ï¼Œæ‹†åˆ†å¦‚ä¸‹ï¼š

[[/img/vue3/compiler-core/compiler-test-05-div-with-vif.svg]]

1. æ•´ä½“æµç¨‹åŠå¯¼è‡´ç»“æœ
2. parse ast æµç¨‹
3. transform ast æµç¨‹ï¼Œè¿™éƒ¨åˆ†ä¼šæ¯”è¾ƒç¹ç
4. codegen generate æµç¨‹

transform é˜¶æ®µæµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/lib/compiler-lib-04-transform.svg]]

generate é˜¶æ®µæµç¨‹å›¾ï¼š
[[/img/vue3/compiler-core/lib/compiler-lib-03-generate.svg]]

